{"pr_number": 8596, "pr_title": "KAFKA-9821: persist followup rebalance in assignment and consolidate rebalance triggering mechanisms", "pr_createdAt": "2020-05-01T01:33:14Z", "pr_url": "https://github.com/apache/kafka/pull/8596", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODc4ODAyMg==", "url": "https://github.com/apache/kafka/pull/8596#discussion_r418788022", "bodyText": "Minor detail, but we reserve the term \"probing rebalance\" for the KIP-441 type of rebalances, while now this is used to schedule any kind of followup rebalance", "author": "ableegoldman", "createdAt": "2020-05-02T00:24:15Z", "path": "streams/src/main/java/org/apache/kafka/streams/StreamsConfig.java", "diffHunk": "@@ -877,7 +877,7 @@\n         public static final String STREAMS_METADATA_STATE_FOR_PARTITION_ASSIGNOR = \"__streams.metadata.state.instance__\";\n         public static final String STREAMS_ADMIN_CLIENT = \"__streams.admin.client.instance__\";\n         public static final String ASSIGNMENT_ERROR_CODE = \"__assignment.error.code__\";\n-        public static final String NEXT_PROBING_REBALANCE_MS = \"__next.probing.rebalance.ms__\";\n+        public static final String NEXT_SCHEDULED_REBALANCE_MS = \"__next.probing.rebalance.ms__\";", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTcwNTQyNw==", "url": "https://github.com/apache/kafka/pull/8596#discussion_r419705427", "bodyText": "Did you want to change the config key as well? I think this should be ok, since it's only used to pass state from one object to another within the same instance, so there should be no compatibility concern.", "author": "vvcephei", "createdAt": "2020-05-04T20:24:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODc4ODAyMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTcxMTk5OQ==", "url": "https://github.com/apache/kafka/pull/8596#discussion_r419711999", "bodyText": "Are you asking if this change was intentional, or are you referring to a different config key? If the former, note that this internal config was only added a few PRs ago so there would be no compatibility concerns even if it wasn't confined to a single instance", "author": "ableegoldman", "createdAt": "2020-05-04T20:35:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODc4ODAyMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTcxODMxNA==", "url": "https://github.com/apache/kafka/pull/8596#discussion_r419718314", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    public static final String NEXT_SCHEDULED_REBALANCE_MS = \"__next.probing.rebalance.ms__\";\n          \n          \n            \n                    public static final String NEXT_SCHEDULED_REBALANCE_MS = \"__next.scheduled.rebalance.ms__\";\n          \n      \n    \n    \n  \n\nThat's what I meant (just remembered I can use the change recommendation thingy).", "author": "vvcephei", "createdAt": "2020-05-04T20:47:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODc4ODAyMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTcxODc4Ng==", "url": "https://github.com/apache/kafka/pull/8596#discussion_r419718786", "bodyText": "It's a very minor question, I only ask because you were trying to make everything consistent here.", "author": "vvcephei", "createdAt": "2020-05-04T20:48:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODc4ODAyMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTgyNzA4Ng==", "url": "https://github.com/apache/kafka/pull/8596#discussion_r419827086", "bodyText": "Oh, duh, I overlooked that. Guess I was just going for eventual consistency here", "author": "ableegoldman", "createdAt": "2020-05-05T02:01:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODc4ODAyMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODc5MTAwMA==", "url": "https://github.com/apache/kafka/pull/8596#discussion_r418791000", "bodyText": "We lose information here, but now log the reason for the scheduled rebalance in a (hopefully) more clear way during onAssignment", "author": "ableegoldman", "createdAt": "2020-05-02T00:32:42Z", "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamThread.java", "diffHunk": "@@ -556,14 +548,8 @@ void runLoop() {\n         while (isRunning() || taskManager.isRebalanceInProgress()) {\n             try {\n                 runOnce();\n-                if (assignmentErrorCode.get() == AssignorError.REBALANCE_NEEDED.code()) {\n-                    log.info(\"Detected that the assignor requested a rebalance. Rejoining the consumer group to \" +\n-                                 \"trigger a new rebalance.\");\n-                    assignmentErrorCode.set(AssignorError.NONE.code());\n-                    mainConsumer.enforceRebalance();\n-                } else if (nextProbingRebalanceMs.get() < time.milliseconds()) {\n-                    log.info(\"The probing rebalance interval has elapsed since the last rebalance, triggering a \" +\n-                                \"rebalance to probe for newly caught-up clients\");\n+                if (nextProbingRebalanceMs.get() < time.milliseconds()) {\n+                    log.info(\"Triggering the followup rebalance scheduled for {} ms.\", nextProbingRebalanceMs.get());", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODc5MjQzMw==", "url": "https://github.com/apache/kafka/pull/8596#discussion_r418792433", "bodyText": "Previously we were doing this logging at the client-level, meaning we could end up in the confusing situation of logging Stable rebalance.. for one client and Unstable rebalance... for another, all in the same rebalance. Now we only log the final result after all client assignments are encoded, and log which clients actually are scheduling said rebalance at the debug level.", "author": "ableegoldman", "createdAt": "2020-05-02T00:35:58Z", "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamsPartitionAssignor.java", "diffHunk": "@@ -907,6 +905,17 @@ private void populatePartitionsByHostMaps(final Map<HostInfo, Set<TopicPartition\n                 minSupportedMetadataVersion,\n                 false,\n                 encodeNextProbingRebalanceTime);\n+\n+            if (followupRebalanceScheduled) {\n+                rebalanceRequired = true;\n+                log.debug(\"Requested client {} to schedule a followup rebalance\", clientId);\n+            }\n+        }\n+\n+        if (rebalanceRequired) {", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODc5MzY0NA==", "url": "https://github.com/apache/kafka/pull/8596#discussion_r418793644", "bodyText": "This encodes an immediate followup rebalance for the consumer who would be receiving the revoked tasks. The consumer that is doing the revoking will also request a followup rebalance (in the client code) but due to KAFKA-9821 this cannot be relied upon when static membership is used.", "author": "ableegoldman", "createdAt": "2020-05-02T00:38:28Z", "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamsPartitionAssignor.java", "diffHunk": "@@ -1009,14 +1018,18 @@ private void addClientAssignments(final Map<String, Assignment> assignment,\n                 AssignorError.NONE.code()\n             );\n \n-            if (encodeNextRebalanceTime) {\n+            if (tasksRevoked) {\n+                // TODO: once KAFKA-9821 is resolved we can leave it to the client to trigger this rebalance\n+                log.debug(\"Requesting followup rebalance be scheduled immediately due to tasks changing ownership.\");\n+                info.setNextRebalanceTime(0L);", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODc5MzkxNw==", "url": "https://github.com/apache/kafka/pull/8596#discussion_r418793917", "bodyText": "This is now the only usage of the assignment error code", "author": "ableegoldman", "createdAt": "2020-05-02T00:38:58Z", "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamsPartitionAssignor.java", "diffHunk": "@@ -1338,7 +1346,7 @@ public void onAssignment(final Assignment assignment, final ConsumerGroupMetadat\n         final AssignmentInfo info = AssignmentInfo.decode(assignment.userData());\n         if (info.errCode() != AssignorError.NONE.code()) {\n             // set flag to shutdown streams app\n-            setAssignmentErrorCode(info.errCode());\n+            assignmentErrorCode.set(info.errCode());", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODc5NDg2Mg==", "url": "https://github.com/apache/kafka/pull/8596#discussion_r418794862", "bodyText": "Here we check for and log all the possible reasons for a followup rebalance to be scheduled on this consumer. It should be clear whether (and why) a rebalance is required by looking at the logs of either the group leader or the member(s) requesting the rebalance.", "author": "ableegoldman", "createdAt": "2020-05-02T00:41:07Z", "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamsPartitionAssignor.java", "diffHunk": "@@ -1423,22 +1434,44 @@ public void onAssignment(final Assignment assignment, final ConsumerGroupMetadat\n         taskManager.handleAssignment(activeTasks, info.standbyTasks());\n     }\n \n+    private void maybeScheduleFollowupRebalance(final long encodedNextScheduledRebalanceMs,", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": "306184cae59ca556d4e22ce8f46093c5f20eb27e", "url": "https://github.com/apache/kafka/commit/306184cae59ca556d4e22ce8f46093c5f20eb27e", "message": "consolidate rebalance triggering mechanism, workaround for KAFKA-9821", "committedDate": "2020-05-08T17:47:34Z", "type": "commit"}, {"oid": "615ed0a214c0921717644a6d566c8a177a713734", "url": "https://github.com/apache/kafka/commit/615ed0a214c0921717644a6d566c8a177a713734", "message": "consolidate followup rebalance reason log messages", "committedDate": "2020-05-08T17:47:36Z", "type": "commit"}, {"oid": "ae6c1c9c9b1259d4e6030415f090582de040e72b", "url": "https://github.com/apache/kafka/commit/ae6c1c9c9b1259d4e6030415f090582de040e72b", "message": "further improve logging", "committedDate": "2020-05-08T17:47:59Z", "type": "commit"}, {"oid": "eb206b884f5c7a7fb23446bf4eca71ac53e51004", "url": "https://github.com/apache/kafka/commit/eb206b884f5c7a7fb23446bf4eca71ac53e51004", "message": "bump stabilized log to info", "committedDate": "2020-05-08T17:48:18Z", "type": "commit"}, {"oid": "eb206b884f5c7a7fb23446bf4eca71ac53e51004", "url": "https://github.com/apache/kafka/commit/eb206b884f5c7a7fb23446bf4eca71ac53e51004", "message": "bump stabilized log to info", "committedDate": "2020-05-08T17:48:18Z", "type": "forcePushed"}, {"oid": "2ff153ddc26ea3ef13c8d41dce0dd21f078a24de", "url": "https://github.com/apache/kafka/commit/2ff153ddc26ea3ef13c8d41dce0dd21f078a24de", "message": "fix log message", "committedDate": "2020-05-08T21:02:53Z", "type": "commit"}, {"oid": "0966ea5d6cc1868e64ffdffaa157769f4873d34a", "url": "https://github.com/apache/kafka/commit/0966ea5d6cc1868e64ffdffaa157769f4873d34a", "message": "temporarily Ignore upgrade test", "committedDate": "2020-05-12T01:28:39Z", "type": "commit"}]}