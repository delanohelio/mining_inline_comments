{"pr_number": 9005, "pr_title": "KAFKA-10263: Do not assign standby for revoking stateless tasks", "pr_createdAt": "2020-07-10T00:36:58Z", "pr_url": "https://github.com/apache/kafka/pull/9005", "timeline": [{"oid": "ea374849fa3278cc3db3907896833e43459127df", "url": "https://github.com/apache/kafka/commit/ea374849fa3278cc3db3907896833e43459127df", "message": "first fix", "committedDate": "2020-07-10T00:32:54Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjU2MjQxNw==", "url": "https://github.com/apache/kafka/pull/9005#discussion_r452562417", "bodyText": "I found it was always true because we are comparing a list of tasks with a list of partitions ;)", "author": "guozhangwang", "createdAt": "2020-07-10T00:37:26Z", "path": "streams/src/test/java/org/apache/kafka/streams/processor/internals/StreamsPartitionAssignorTest.java", "diffHunk": "@@ -1402,9 +1404,13 @@ public void shouldTriggerImmediateRebalanceOnTasksRevoked() {\n         final Map<String, Assignment> assignment = partitionAssignor.assign(metadata, new GroupSubscription(subscriptions)).groupAssignment();\n \n         // Verify at least one partition was revoked\n-        assertThat(assignment.get(CONSUMER_1).partitions(), not(allTasks));\n+        assertThat(assignment.get(CONSUMER_1).partitions(), not(allPartitions));", "originalCommit": "ea374849fa3278cc3db3907896833e43459127df", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjU3MDA0NA==", "url": "https://github.com/apache/kafka/pull/9005#discussion_r452570044", "bodyText": "Whoops", "author": "ableegoldman", "createdAt": "2020-07-10T01:09:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjU2MjQxNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzAyNzk5Mg==", "url": "https://github.com/apache/kafka/pull/9005#discussion_r453027992", "bodyText": "Oh, boy...", "author": "vvcephei", "createdAt": "2020-07-10T19:04:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjU2MjQxNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjU2MjQ2OA==", "url": "https://github.com/apache/kafka/pull/9005#discussion_r452562468", "bodyText": "Verified that without the fix, this line will fail.", "author": "guozhangwang", "createdAt": "2020-07-10T00:37:40Z", "path": "streams/src/test/java/org/apache/kafka/streams/processor/internals/StreamsPartitionAssignorTest.java", "diffHunk": "@@ -1402,9 +1404,13 @@ public void shouldTriggerImmediateRebalanceOnTasksRevoked() {\n         final Map<String, Assignment> assignment = partitionAssignor.assign(metadata, new GroupSubscription(subscriptions)).groupAssignment();\n \n         // Verify at least one partition was revoked\n-        assertThat(assignment.get(CONSUMER_1).partitions(), not(allTasks));\n+        assertThat(assignment.get(CONSUMER_1).partitions(), not(allPartitions));\n         assertThat(assignment.get(CONSUMER_2).partitions(), equalTo(emptyList()));\n \n+        // Verify that stateless revoked tasks would not be assigned as standbys\n+        assertThat(AssignmentInfo.decode(assignment.get(CONSUMER_2).userData()).activeTasks(), equalTo(emptyList()));\n+        assertThat(AssignmentInfo.decode(assignment.get(CONSUMER_2).userData()).standbyTasks(), equalTo(emptyMap()));", "originalCommit": "ea374849fa3278cc3db3907896833e43459127df", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "c78d3b2474b13a3bc84b528b2e2d93ddc056328e", "url": "https://github.com/apache/kafka/commit/c78d3b2474b13a3bc84b528b2e2d93ddc056328e", "message": "Merge branch 'trunk' of https://github.com/apache/kafka into KXXX-fix-ha-partition-assignor", "committedDate": "2020-07-10T17:48:39Z", "type": "commit"}, {"oid": "de6fefa5d44ce1ebd9b2ae312ec1edd58f411779", "url": "https://github.com/apache/kafka/commit/de6fefa5d44ce1ebd9b2ae312ec1edd58f411779", "message": "fix checkstyle", "committedDate": "2020-07-10T18:14:49Z", "type": "commit"}]}