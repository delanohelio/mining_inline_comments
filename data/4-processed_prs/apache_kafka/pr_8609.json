{"pr_number": 8609, "pr_title": "KAFKA-9946; StopReplicaRequest deletePartition changes may cause premature topic deletion handling in controller", "pr_createdAt": "2020-05-04T09:15:51Z", "pr_url": "https://github.com/apache/kafka/pull/8609", "timeline": [{"oid": "e2797e2ef8e7de309e54c7712c054eaa41ff567a", "url": "https://github.com/apache/kafka/commit/e2797e2ef8e7de309e54c7712c054eaa41ff567a", "message": "KAFKA-9946; StopReplicaRequest deletePartition changes may cause premature topic deletion handling in controller", "committedDate": "2020-05-04T09:09:59Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTcyNTU5OQ==", "url": "https://github.com/apache/kafka/pull/8609#discussion_r419725599", "bodyText": "It seems like we could keep the response callback creation method in the previous PR if we passed in partitionStates to the callback builder, or alternately create a map of the partitions that you expect to be deleted. I think this would save the code duplication in creating nearly the same callback which I believe is being done to deal with the differences in the deletePartition schemas i.e. all partitions in request vs specific partitions.", "author": "lbradstreet", "createdAt": "2020-05-04T21:00:59Z", "path": "core/src/main/scala/kafka/controller/ControllerChannelManager.scala", "diffHunk": "@@ -590,7 +569,26 @@ abstract class AbstractControllerBrokerRequestBatch(config: KafkaConfig,\n \n           stateChangeLog.info(s\"Sending StopReplica request for ${partitionStates.size} \" +\n             s\"replicas to broker $brokerId\")\n-          sendStopReplicaRequest(brokerId, brokerEpoch, false, stopReplicaTopicState)\n+          val stopReplicaRequestBuilder = new StopReplicaRequest.Builder(\n+            stopReplicaRequestVersion, controllerId, controllerEpoch, brokerEpoch,\n+            false, stopReplicaTopicState.values.toBuffer.asJava)\n+\n+          sendRequest(brokerId, stopReplicaRequestBuilder, (r: AbstractResponse) => {\n+            val stopReplicaResponse = r.asInstanceOf[StopReplicaResponse]", "originalCommit": "e2797e2ef8e7de309e54c7712c054eaa41ff567a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTgwMzExOQ==", "url": "https://github.com/apache/kafka/pull/8609#discussion_r419803119", "bodyText": "I agree the duplication is a tad vexing. Perhaps we could pass a function TopicPartition -> Boolean to the callback which tells whether deletion was requested. For the old version, we would return true blindly.", "author": "hachikuji", "createdAt": "2020-05-05T00:23:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTcyNTU5OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTk0NjQ5MQ==", "url": "https://github.com/apache/kafka/pull/8609#discussion_r419946491", "bodyText": "I agree as well. Passing a function is a really good idea. I should have thought about it.", "author": "dajac", "createdAt": "2020-05-05T08:33:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTcyNTU5OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTgwMTY0MA==", "url": "https://github.com/apache/kafka/pull/8609#discussion_r419801640", "bodyText": "nit: could we align with the controllerContext?", "author": "hachikuji", "createdAt": "2020-05-05T00:18:05Z", "path": "core/src/main/scala/kafka/controller/ControllerChannelManager.scala", "diffHunk": "@@ -590,7 +569,26 @@ abstract class AbstractControllerBrokerRequestBatch(config: KafkaConfig,\n \n           stateChangeLog.info(s\"Sending StopReplica request for ${partitionStates.size} \" +\n             s\"replicas to broker $brokerId\")\n-          sendStopReplicaRequest(brokerId, brokerEpoch, false, stopReplicaTopicState)\n+          val stopReplicaRequestBuilder = new StopReplicaRequest.Builder(\n+            stopReplicaRequestVersion, controllerId, controllerEpoch, brokerEpoch,\n+            false, stopReplicaTopicState.values.toBuffer.asJava)\n+\n+          sendRequest(brokerId, stopReplicaRequestBuilder, (r: AbstractResponse) => {\n+            val stopReplicaResponse = r.asInstanceOf[StopReplicaResponse]\n+            val partitionErrorsForDeletingTopics = mutable.Map.empty[TopicPartition, Errors]\n+            stopReplicaResponse.partitionErrors.asScala.foreach { pe =>\n+              val tp = new TopicPartition(pe.topicName, pe.partitionIndex)\n+              // Verify that the topic deletion is in progress and\n+              // that the request deleted the replica\n+              if (controllerContext.isTopicDeletionInProgress(pe.topicName) &&\n+                partitionStates.get(tp).exists(_.deletePartition)) {", "originalCommit": "e2797e2ef8e7de309e54c7712c054eaa41ff567a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "272e333c8787f39ab625ad632db9d31b13a642d0", "url": "https://github.com/apache/kafka/commit/272e333c8787f39ab625ad632db9d31b13a642d0", "message": "address feedback", "committedDate": "2020-05-05T08:33:54Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDIzODg5MQ==", "url": "https://github.com/apache/kafka/pull/8609#discussion_r420238891", "bodyText": "nit: partitionErrorsForDeletingTopics seems a bit ambiguous and makes it sound like it only includes partitions for which StopReplicaRequest failed. Perhaps something like partitionToError is better?", "author": "dhruvilshah3", "createdAt": "2020-05-05T16:23:29Z", "path": "core/src/main/scala/kafka/controller/ControllerChannelManager.scala", "diffHunk": "@@ -550,6 +550,22 @@ abstract class AbstractControllerBrokerRequestBatch(config: KafkaConfig,\n       else if (config.interBrokerProtocolVersion >= KAFKA_2_2_IV0) 1\n       else 0\n \n+    def responseCallback(brokerId: Int, isPartitionDeleted: TopicPartition => Boolean)\n+                        (response: AbstractResponse): Unit = {\n+      val stopReplicaResponse = response.asInstanceOf[StopReplicaResponse]\n+      val partitionErrorsForDeletingTopics = mutable.Map.empty[TopicPartition, Errors]\n+      stopReplicaResponse.partitionErrors.asScala.foreach { pe =>\n+        val tp = new TopicPartition(pe.topicName, pe.partitionIndex)\n+        if (controllerContext.isTopicDeletionInProgress(pe.topicName) &&\n+            isPartitionDeleted(tp)) {\n+          partitionErrorsForDeletingTopics += tp -> Errors.forCode(pe.errorCode)", "originalCommit": "272e333c8787f39ab625ad632db9d31b13a642d0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDMxOTQ1OQ==", "url": "https://github.com/apache/kafka/pull/8609#discussion_r420319459", "bodyText": "I think the name seems ok. To me it means that the map includes the errors of all topic being deleted. It might be nice if it could reflect that this is only covering partitions which were also requested to be deleted in the StopReplica request, but that name probably becomes unwieldy.", "author": "hachikuji", "createdAt": "2020-05-05T18:28:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDIzODg5MQ=="}], "type": "inlineReview"}]}