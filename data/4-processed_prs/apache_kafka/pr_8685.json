{"pr_number": 8685, "pr_title": "KAFKA-10014 Always try to close all channels in Selector#close", "pr_createdAt": "2020-05-18T08:37:26Z", "pr_url": "https://github.com/apache/kafka/pull/8685", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjg1MDIzMg==", "url": "https://github.com/apache/kafka/pull/8685#discussion_r426850232", "bodyText": "Have we considered using Utils.closeAll instead of multiple closeQuietly?", "author": "ijuma", "createdAt": "2020-05-18T19:34:55Z", "path": "clients/src/main/java/org/apache/kafka/common/network/Selector.java", "diffHunk": "@@ -363,23 +363,14 @@ public void wakeup() {\n     @Override\n     public void close() {\n         List<String> connections = new ArrayList<>(channels.keySet());\n-        try {\n-            for (String id : connections)\n-                close(id);\n-        } finally {\n-            // If there is any exception thrown in close(id), we should still be able\n-            // to close the remaining objects, especially the sensors because keeping\n-            // the sensors may lead to failure to start up the ReplicaFetcherThread if\n-            // the old sensors with the same names has not yet been cleaned up.\n-            AtomicReference<Throwable> firstException = new AtomicReference<>();\n-            Utils.closeQuietly(nioSelector, \"nioSelector\", firstException);\n-            Utils.closeQuietly(sensors, \"sensors\", firstException);\n-            Utils.closeQuietly(channelBuilder, \"channelBuilder\", firstException);\n-            Throwable exception = firstException.get();\n-            if (exception instanceof RuntimeException && !(exception instanceof SecurityException)) {\n-                throw (RuntimeException) exception;\n-            }\n-\n+        AtomicReference<Throwable> firstException = new AtomicReference<>();", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzA5MTkzMg==", "url": "https://github.com/apache/kafka/pull/8685#discussion_r427091932", "bodyText": "Utils.closeAll handle only IOException and it throws exception instead of keeping exception. Hence, it is not suitable to this case.", "author": "chia7712", "createdAt": "2020-05-19T07:39:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjg1MDIzMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjQwMzM1NQ==", "url": "https://github.com/apache/kafka/pull/8685#discussion_r436403355", "bodyText": "Would it make sense to have a closeAllQuietly?", "author": "hachikuji", "createdAt": "2020-06-07T21:25:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjg1MDIzMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjQ0NTE0Ng==", "url": "https://github.com/apache/kafka/pull/8685#discussion_r436445146", "bodyText": "Would it make sense to have a closeAllQuietly?\n\ncopy that", "author": "chia7712", "createdAt": "2020-06-08T03:52:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjg1MDIzMg=="}], "type": "inlineReview"}, {"oid": "c6adcca95f03758089715c60e806a8090f5422d9", "url": "https://github.com/apache/kafka/commit/c6adcca95f03758089715c60e806a8090f5422d9", "message": "MINOR: avoid unnecessary list iteration in ApiVersion.lastVersion (#8708)\n\nWe unnecessarily iterate the versions list each time we lookup\r\nlastVersion, including in the hotpath Log.appendAsFollower.\r\nGiven that allVersions is a constant, this is unnecessary.\r\n\r\nReviewers: Chia-Ping Tsai <chia7712@gmail.com>, Ismael Juma <ismael@juma.me.uk>", "committedDate": "2020-05-26T04:51:14Z", "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": "665e7efd171a17ef783ec82bb87cde17b7deb5d7", "url": "https://github.com/apache/kafka/commit/665e7efd171a17ef783ec82bb87cde17b7deb5d7", "message": "KAFKA-10014 Always try to close all channels in Selector#close", "committedDate": "2020-06-08T03:52:40Z", "type": "commit"}, {"oid": "665e7efd171a17ef783ec82bb87cde17b7deb5d7", "url": "https://github.com/apache/kafka/commit/665e7efd171a17ef783ec82bb87cde17b7deb5d7", "message": "KAFKA-10014 Always try to close all channels in Selector#close", "committedDate": "2020-06-08T03:52:40Z", "type": "forcePushed"}]}