{"pr_number": 8111, "pr_title": "KAFKA-9206: throw a KafkaException when encountering CORRUPT_MESSAGE", "pr_createdAt": "2020-02-13T19:58:39Z", "pr_url": "https://github.com/apache/kafka/pull/8111", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTEzNDc2Nw==", "url": "https://github.com/apache/kafka/pull/8111#discussion_r379134767", "bodyText": "Why is this needed? Supposedly the slf4jlog4j dependency brings this too?", "author": "ijuma", "createdAt": "2020-02-13T21:42:22Z", "path": "build.gradle", "diffHunk": "@@ -998,6 +998,7 @@ project(':clients') {\n     testCompile libs.bcpkix\n     testCompile libs.junit\n     testCompile libs.mockitoCore\n+    testCompile libs.log4j", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTEzNTIwMA==", "url": "https://github.com/apache/kafka/pull/8111#discussion_r379135200", "bodyText": "I guess you're doing it because we refer to log4j at compile time now?", "author": "ijuma", "createdAt": "2020-02-13T21:43:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTEzNDc2Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTE0MjEwMg==", "url": "https://github.com/apache/kafka/pull/8111#discussion_r379142102", "bodyText": "yes, it's an import for LogCaptureAppender", "author": "agam", "createdAt": "2020-02-13T21:57:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTEzNDc2Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTIyNzcxMg==", "url": "https://github.com/apache/kafka/pull/8111#discussion_r379227712", "bodyText": "I think the main question here is whether we want to raise this error to the user. If we happen to see message corruption in the fetched data, we raise that to the user, so should this case be different?", "author": "hachikuji", "createdAt": "2020-02-14T02:49:15Z", "path": "clients/src/main/java/org/apache/kafka/clients/consumer/internals/Fetcher.java", "diffHunk": "@@ -1272,6 +1272,8 @@ private CompletedFetch initializeCompletedFetch(CompletedFetch nextCompletedFetc\n                 log.debug(\"Received unknown leader epoch error in fetch for partition {}\", tp);\n             } else if (error == Errors.UNKNOWN_SERVER_ERROR) {\n                 log.warn(\"Unknown error fetching data for topic-partition {}\", tp);\n+            } else if (error == Errors.CORRUPT_MESSAGE) {\n+                log.warn(\"Encountered corrupt message while fetching data for topic-partition {}\", tp);", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTYwMDE2NQ==", "url": "https://github.com/apache/kafka/pull/8111#discussion_r379600165", "bodyText": "Ack. As discussed, will (1) change this to correspond to the current behavior for corruption in fetched data, i.e. throwing a KafkaException that wraps around a CorruptRecordException, and (2) remove the log message expectation.", "author": "agam", "createdAt": "2020-02-14T19:15:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTIyNzcxMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTY4NTM3Ng==", "url": "https://github.com/apache/kafka/pull/8111#discussion_r379685376", "bodyText": "Correction: just a KafkaException (the wrapping around I referred to was the text of the CorruptRecordException, not the exception itself)", "author": "agam", "createdAt": "2020-02-14T23:15:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTIyNzcxMg=="}], "type": "inlineReview"}, {"oid": "efa1736c7340b8f81ff7c60ef05fd8ad33c4fd20", "url": "https://github.com/apache/kafka/commit/efa1736c7340b8f81ff7c60ef05fd8ad33c4fd20", "message": "KAFKA-9206: throw a KafkaException when encountering `CORRUPT_MESSAGE` after a fetch", "committedDate": "2020-02-14T21:35:48Z", "type": "commit"}, {"oid": "969295daf0b277c7c33092ca31953fdd233863e6", "url": "https://github.com/apache/kafka/commit/969295daf0b277c7c33092ca31953fdd233863e6", "message": "nit: formatting", "committedDate": "2020-02-14T21:53:06Z", "type": "commit"}, {"oid": "a58e1be8f9c09937fab1182af62450ea38310d10", "url": "https://github.com/apache/kafka/commit/a58e1be8f9c09937fab1182af62450ea38310d10", "message": "added test", "committedDate": "2020-02-14T21:53:30Z", "type": "commit"}, {"oid": "a58e1be8f9c09937fab1182af62450ea38310d10", "url": "https://github.com/apache/kafka/commit/a58e1be8f9c09937fab1182af62450ea38310d10", "message": "added test", "committedDate": "2020-02-14T21:53:30Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTY3MDA3NA==", "url": "https://github.com/apache/kafka/pull/8111#discussion_r379670074", "bodyText": "nit: just calling fetchedRecords() should work here, or is compiler not liking it and forcing the return value assignment?", "author": "soondenana", "createdAt": "2020-02-14T22:17:55Z", "path": "clients/src/test/java/org/apache/kafka/clients/consumer/internals/FetcherTest.java", "diffHunk": "@@ -3835,6 +3835,31 @@ public void testFetchCompletedBeforeHandlerAdded() {\n         assertEquals(1, fetcher.sendFetches());\n     }\n \n+    @Test\n+    public void testCorruptMessageError() {\n+        buildFetcher();\n+        assignFromUser(singleton(tp0));\n+        subscriptions.seek(tp0, 0);\n+\n+        assertEquals(1, fetcher.sendFetches());\n+        assertFalse(fetcher.hasCompletedFetches());\n+\n+        // Prepare a response with the CORRUPT_MESSAGE error.\n+        client.prepareResponse(fullFetchResponse(\n+                tp0,\n+                buildRecords(1L, 1, 1),\n+                Errors.CORRUPT_MESSAGE,\n+                100L, 0));\n+        consumerClient.poll(time.timer(0));\n+        assertTrue(fetcher.hasCompletedFetches());\n+\n+        // Trigger the exception.\n+        assertThrows(KafkaException.class, () -> {\n+            Map<TopicPartition, List<ConsumerRecord<byte[], byte[]>>> partitionRecords =\n+                    fetchedRecords();", "originalCommit": "a58e1be8f9c09937fab1182af62450ea38310d10", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTY4NDc4MQ==", "url": "https://github.com/apache/kafka/pull/8111#discussion_r379684781", "bodyText": "Agree, made the change to discard the return value.", "author": "agam", "createdAt": "2020-02-14T23:12:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTY3MDA3NA=="}], "type": "inlineReview"}, {"oid": "152323baa85ee0ab4396e2af7e1d7e25133cafec", "url": "https://github.com/apache/kafka/commit/152323baa85ee0ab4396e2af7e1d7e25133cafec", "message": "Review: throw away return value from fetchedRecords() in test", "committedDate": "2020-02-14T23:12:02Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTk0MzM0MA==", "url": "https://github.com/apache/kafka/pull/8111#discussion_r379943340", "bodyText": "While we're at it, could we add the fetch offset to the IllegalStateException message below and the UNKNOWN_SERVER_ERROR log message above?", "author": "hachikuji", "createdAt": "2020-02-16T23:28:22Z", "path": "clients/src/main/java/org/apache/kafka/clients/consumer/internals/Fetcher.java", "diffHunk": "@@ -1272,6 +1272,11 @@ private CompletedFetch initializeCompletedFetch(CompletedFetch nextCompletedFetc\n                 log.debug(\"Received unknown leader epoch error in fetch for partition {}\", tp);\n             } else if (error == Errors.UNKNOWN_SERVER_ERROR) {\n                 log.warn(\"Unknown error fetching data for topic-partition {}\", tp);\n+            } else if (error == Errors.CORRUPT_MESSAGE) {\n+                throw new KafkaException(\"Encountered corrupt message when fetching offset \"", "originalCommit": "152323baa85ee0ab4396e2af7e1d7e25133cafec", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDg3NjAyMQ==", "url": "https://github.com/apache/kafka/pull/8111#discussion_r380876021", "bodyText": "Done.", "author": "agam", "createdAt": "2020-02-18T19:08:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTk0MzM0MA=="}], "type": "inlineReview"}, {"oid": "d8afd7e73ead72d0f3c037f61b1164fe6ebefd3f", "url": "https://github.com/apache/kafka/commit/d8afd7e73ead72d0f3c037f61b1164fe6ebefd3f", "message": "Review: expanded log warnings to include fetch-offset", "committedDate": "2020-02-18T19:08:31Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTQyNDg5NA==", "url": "https://github.com/apache/kafka/pull/8111#discussion_r381424894", "bodyText": "nit: for log messages, can we use the {} placeholders?", "author": "hachikuji", "createdAt": "2020-02-19T17:22:11Z", "path": "clients/src/main/java/org/apache/kafka/clients/consumer/internals/Fetcher.java", "diffHunk": "@@ -1271,9 +1271,20 @@ private CompletedFetch initializeCompletedFetch(CompletedFetch nextCompletedFetc\n             } else if (error == Errors.UNKNOWN_LEADER_EPOCH) {\n                 log.debug(\"Received unknown leader epoch error in fetch for partition {}\", tp);\n             } else if (error == Errors.UNKNOWN_SERVER_ERROR) {\n-                log.warn(\"Unknown error fetching data for topic-partition {}\", tp);\n+                log.warn(\"Unknown error fetching data while fetching offset \"", "originalCommit": "d8afd7e73ead72d0f3c037f61b1164fe6ebefd3f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTQ0NDM2OA==", "url": "https://github.com/apache/kafka/pull/8111#discussion_r381444368", "bodyText": "Done", "author": "agam", "createdAt": "2020-02-19T17:56:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTQyNDg5NA=="}], "type": "inlineReview"}, {"oid": "8cd5c55a133a36591e4cd911d3298481a09e1dfc", "url": "https://github.com/apache/kafka/commit/8cd5c55a133a36591e4cd911d3298481a09e1dfc", "message": "Review: use \"{}\" in log warnings", "committedDate": "2020-02-19T17:45:22Z", "type": "commit"}, {"oid": "238eced39a01154d09718ec0b0536a3a468037ab", "url": "https://github.com/apache/kafka/commit/238eced39a01154d09718ec0b0536a3a468037ab", "message": "Review: add reference to the CORRUPT_MESSAGE error in docs for `FetchResponse`", "committedDate": "2020-02-20T19:57:29Z", "type": "commit"}]}