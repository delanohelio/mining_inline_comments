{"pr_number": 9112, "pr_title": "KAFKA-10312 Fix error code returned by getPartitionMetadata", "pr_createdAt": "2020-08-02T18:50:18Z", "pr_url": "https://github.com/apache/kafka/pull/9112", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODI3MDAyNw==", "url": "https://github.com/apache/kafka/pull/9112#discussion_r468270027", "bodyText": "nit: maybe it would be clearer if we passed brokerId as an argument? Then we could use broker 0 in the test case, for example, so that the UpdateMetadata request makes more sense.", "author": "hachikuji", "createdAt": "2020-08-11T01:12:34Z", "path": "core/src/test/scala/unit/kafka/server/MetadataCacheTest.scala", "diffHunk": "@@ -229,7 +205,7 @@ class MetadataCacheTest {\n                                                                        errorUnavailableListeners: Boolean): Unit = {\n     val topic = \"topic\"\n \n-    val cache = new MetadataCache(1)\n+    val cache = new MetadataCache(9)", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODM3Nzk5MQ==", "url": "https://github.com/apache/kafka/pull/9112#discussion_r468377991", "bodyText": "@hachikuji done", "author": "RamanVerma", "createdAt": "2020-08-11T07:23:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODI3MDAyNw=="}], "type": "inlineReview"}, {"oid": "b1f0b3653b978cecf17c5d1baa8aec63e8b078f5", "url": "https://github.com/apache/kafka/commit/b1f0b3653b978cecf17c5d1baa8aec63e8b078f5", "message": "KAFKA-10312 Fix error code returned by getPartitionMetadata\n\nMetadataCache#getPartitionMetadata returns an error when the topic's leader Id\nis present at MetadataCache but listener endpoint is not present for this leader.\nFor older version, LEADER_NOT_AVAILABLE is returned while LISTENER_NOT_FOUND is\nreturned for new metadata version.\n\ngetPartitionMetadata was looking up MetadataCache's host brokerId rather\nthan the topic's leader id while determining what error to return. This\ncould result in the call returning LISTENER_NOT_FOUND when it should\nhave returned LEADER_NOT_AVAILABLE. This commit corrects this behavior.\n\nUnit tests were already present to test out the error codes returned\nunder different situations but they were giving out a false positive.\nThe test was using same broker id for both the MetadataCache's host as\nwell as for the topic's leader. Error manifests when the MetadataCache's\nhost id is changed. Improved the test.\n\nThis commit also consolidated couple of related tests to reduce code\nduplication.", "committedDate": "2020-08-11T07:15:17Z", "type": "commit"}, {"oid": "cf6671f4afdd13f67bab8376b5ba93f549ebcb7a", "url": "https://github.com/apache/kafka/commit/cf6671f4afdd13f67bab8376b5ba93f549ebcb7a", "message": "Minor refactoring to introduce brokerId for metadata cache", "committedDate": "2020-08-11T07:15:17Z", "type": "commit"}, {"oid": "cf6671f4afdd13f67bab8376b5ba93f549ebcb7a", "url": "https://github.com/apache/kafka/commit/cf6671f4afdd13f67bab8376b5ba93f549ebcb7a", "message": "Minor refactoring to introduce brokerId for metadata cache", "committedDate": "2020-08-11T07:15:17Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODc2MTIxNQ==", "url": "https://github.com/apache/kafka/pull/9112#discussion_r468761215", "bodyText": "Would 0 work just as well? It would make the test more coherent if we used one of the ids included in the UpdateMetadata request.", "author": "hachikuji", "createdAt": "2020-08-11T17:54:36Z", "path": "core/src/test/scala/unit/kafka/server/MetadataCacheTest.scala", "diffHunk": "@@ -187,49 +191,24 @@ class MetadataCacheTest {\n       new UpdateMetadataBroker()\n         .setId(1)\n         .setEndpoints(broker1Endpoints.asJava))\n-    verifyTopicMetadataPartitionLeaderOrEndpointNotAvailable(brokers, sslListenerName,\n+    val metadataCacheBrokerId = 9", "originalCommit": "cf6671f4afdd13f67bab8376b5ba93f549ebcb7a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTY5ODAxNg==", "url": "https://github.com/apache/kafka/pull/9112#discussion_r469698016", "bodyText": "Done", "author": "RamanVerma", "createdAt": "2020-08-13T05:02:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODc2MTIxNQ=="}], "type": "inlineReview"}, {"oid": "795600f6097dda72e4c280edff7379ee769442fd", "url": "https://github.com/apache/kafka/commit/795600f6097dda72e4c280edff7379ee769442fd", "message": "Minor fix - Changed the metadataCache brokerId in tests", "committedDate": "2020-08-13T04:51:32Z", "type": "commit"}]}