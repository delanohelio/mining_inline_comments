{"pr_number": 8567, "pr_title": "KAFKA-9652: Fix throttle metric in RequestChannel and request log due to KIP-219", "pr_createdAt": "2020-04-27T23:28:41Z", "pr_url": "https://github.com/apache/kafka/pull/8567", "timeline": [{"oid": "7f2de95a37a775741a5617522fb5b2ed320bd491", "url": "https://github.com/apache/kafka/commit/7f2de95a37a775741a5617522fb5b2ed320bd491", "message": "Pass KafkaMetric to QuotaViolationException to simplify caller", "committedDate": "2020-04-27T23:06:35Z", "type": "commit"}, {"oid": "9fd91c6d0a400bc0e4c0d86c8aa85dc9359f5892", "url": "https://github.com/apache/kafka/commit/9fd91c6d0a400bc0e4c0d86c8aa85dc9359f5892", "message": "Inline Supplier in SocketServer", "committedDate": "2020-04-27T23:06:35Z", "type": "commit"}, {"oid": "ff901fa444a3d3004a04a682f723ca4755eee1be", "url": "https://github.com/apache/kafka/commit/ff901fa444a3d3004a04a682f723ca4755eee1be", "message": "Fix request log and request metrics throttle time tracking\n\nAlso remove reduce redundant `time.milliseconds` and `time.nanoseconds`\ncalls.", "committedDate": "2020-04-27T23:06:35Z", "type": "commit"}, {"oid": "90509856cb6cea75ff49354e34b54ba4941dd24e", "url": "https://github.com/apache/kafka/commit/90509856cb6cea75ff49354e34b54ba4941dd24e", "message": "Clean up ThrottledChannel and TimerTaskList\n\nUse monotonic clock", "committedDate": "2020-04-27T23:06:35Z", "type": "commit"}, {"oid": "399a267dd7afcb51bd1272f0b53e261525884cb4", "url": "https://github.com/apache/kafka/commit/399a267dd7afcb51bd1272f0b53e261525884cb4", "message": "Verify request channel throttle time metrics", "committedDate": "2020-04-27T23:06:35Z", "type": "commit"}, {"oid": "d2fa655b854b733a8ce9ee02c8649b51ef2bddd2", "url": "https://github.com/apache/kafka/commit/d2fa655b854b733a8ce9ee02c8649b51ef2bddd2", "message": "Clarify comment", "committedDate": "2020-04-27T23:33:02Z", "type": "commit"}, {"oid": "7386fd253601fe9d39cbaa6a8fee959b915b5f3f", "url": "https://github.com/apache/kafka/commit/7386fd253601fe9d39cbaa6a8fee959b915b5f3f", "message": "Record throttle time for non produce/fetch requests", "committedDate": "2020-04-28T15:30:03Z", "type": "commit"}, {"oid": "b986e605b6e2cf995319270231d58a954315e7b3", "url": "https://github.com/apache/kafka/commit/b986e605b6e2cf995319270231d58a954315e7b3", "message": "Test fixes", "committedDate": "2020-04-28T15:34:22Z", "type": "commit"}, {"oid": "a78e099b4fa8f47fb0839738c6930d65e25d38ec", "url": "https://github.com/apache/kafka/commit/a78e099b4fa8f47fb0839738c6930d65e25d38ec", "message": "Implement toString for ByteBufferSend and MultiRecordsSend", "committedDate": "2020-04-28T15:34:35Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzY0Nzg0MQ==", "url": "https://github.com/apache/kafka/pull/8567#discussion_r417647841", "bodyText": "I guess this is not intended?", "author": "junrao", "createdAt": "2020-04-29T22:23:28Z", "path": "core/src/main/scala/kafka/server/KafkaApis.scala", "diffHunk": "@@ -3012,17 +3010,24 @@ class KafkaApis(val requestChannel: RequestChannel,\n   private def sendResponseMaybeThrottle(request: RequestChannel.Request,\n                                         createResponse: Int => AbstractResponse,\n                                         onComplete: Option[Send => Unit] = None): Unit = {\n-    val throttleTimeMs = quotas.request.maybeRecordAndGetThrottleTimeMs(request)\n-    quotas.request.throttle(request, throttleTimeMs, sendResponse)\n+    val throttleTimeMs = maybeRecordAndGetThrottleTimeMs(request)\n+    quotas.request.throttle(request, throttleTimeMs, requestChannel.sendResponse)\n     sendResponse(request, Some(createResponse(throttleTimeMs)), onComplete)\n   }\n \n   private def sendErrorResponseMaybeThrottle(request: RequestChannel.Request, error: Throwable): Unit = {\n-    val throttleTimeMs = quotas.request.maybeRecordAndGetThrottleTimeMs(request)\n-    quotas.request.throttle(request, throttleTimeMs, sendResponse)\n+    val throttleTimeMs = maybeRecordAndGetThrottleTimeMs(request)\n+    quotas.request.throttle(request, throttleTimeMs, requestChannel.sendResponse)\n     sendErrorOrCloseConnection(request, error, throttleTimeMs)\n   }\n \n+  private def maybeRecordAndGetThrottleTimeMs(request: RequestChannel.Request): Int = {\n+    val throttleTimeMs = quotas.request.maybeRecordAndGetThrottleTimeMs(request, time.milliseconds())\n+    println(s\"api throttle ms $throttleTimeMs ${request.header} ${request.header.clientId}\")", "originalCommit": "a78e099b4fa8f47fb0839738c6930d65e25d38ec", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzY3MDk0Ng==", "url": "https://github.com/apache/kafka/pull/8567#discussion_r417670946", "bodyText": "Yes, sorry, forgot to remove.", "author": "ijuma", "createdAt": "2020-04-29T23:29:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzY0Nzg0MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzY2NTQ4NQ==", "url": "https://github.com/apache/kafka/pull/8567#discussion_r417665485", "bodyText": "Could this be private?", "author": "junrao", "createdAt": "2020-04-29T23:12:42Z", "path": "core/src/test/scala/integration/kafka/api/BaseQuotaTest.scala", "diffHunk": "@@ -235,14 +240,29 @@ abstract class QuotaTestClients(topic: String,\n     numConsumed\n   }\n \n-  def verifyProduceThrottle(expectThrottle: Boolean, verifyClientMetric: Boolean = true): Unit = {\n+  def verifyThrottleTimeRequestChannelMetric(apiKey: ApiKeys, metricNameSuffix: String,", "originalCommit": "a78e099b4fa8f47fb0839738c6930d65e25d38ec", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzY3NDgxOA==", "url": "https://github.com/apache/kafka/pull/8567#discussion_r417674818", "bodyText": "Yes. I also restricted access to a few other methods in this class where possible.", "author": "ijuma", "createdAt": "2020-04-29T23:41:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzY2NTQ4NQ=="}], "type": "inlineReview"}, {"oid": "0962513ea29e4d4c553fcab7aea67925689404bc", "url": "https://github.com/apache/kafka/commit/0962513ea29e4d4c553fcab7aea67925689404bc", "message": "Remove stray println", "committedDate": "2020-04-29T23:33:34Z", "type": "commit"}, {"oid": "a73ee746aea25adacfa12336c4566cda9fbb856b", "url": "https://github.com/apache/kafka/commit/a73ee746aea25adacfa12336c4566cda9fbb856b", "message": "Restrict access to various methods in `QuotaTestClients`", "committedDate": "2020-04-29T23:43:40Z", "type": "commit"}, {"oid": "a73ee746aea25adacfa12336c4566cda9fbb856b", "url": "https://github.com/apache/kafka/commit/a73ee746aea25adacfa12336c4566cda9fbb856b", "message": "Restrict access to various methods in `QuotaTestClients`", "committedDate": "2020-04-29T23:43:40Z", "type": "forcePushed"}]}