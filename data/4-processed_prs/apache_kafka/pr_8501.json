{"pr_number": 8501, "pr_title": "KAFKA-9881: Convert integration test to verify measurements from RocksDB to unit test", "pr_createdAt": "2020-04-16T13:52:33Z", "pr_url": "https://github.com/apache/kafka/pull/8501", "timeline": [{"oid": "37cc5ef592cbfc4b5e20c59c9d36420fc41b5ae0", "url": "https://github.com/apache/kafka/commit/37cc5ef592cbfc4b5e20c59c9d36420fc41b5ae0", "message": "KAFKA-9881: Convert integration test to verify measurements from RocksDB to unit test\n\nThe integration test RocksDBMetricsIntegrationTest takes pretty long to complete.\nMost of the runtime is spent in the two tests that verify whether the RocksDB\nmetrics get actual measurements from RocksDB. Those tests need to wait for the thread\nthat collects the measurements of the RocksDB metrics to trigger the first recordings\nof the metrics.\n\nThis PR adds a unit test that verifies whether the Kafka Streams metrics get the\nmeasurements from RocksDB and removes the two integration tests that verified it\nbefore. The verification of the creation and scheduling of the RocksDB metrics\nrecording trigger thread is already contained in KafkaStreamsTest and consequently\nit is not part of this PR.", "committedDate": "2020-04-16T13:50:37Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTg1ODU2Mg==", "url": "https://github.com/apache/kafka/pull/8501#discussion_r409858562", "bodyText": "Nice cleanup!", "author": "guozhangwang", "createdAt": "2020-04-16T21:27:15Z", "path": "streams/src/main/java/org/apache/kafka/streams/state/internals/RocksDBStore.java", "diffHunk": "@@ -190,13 +190,13 @@ void openDB(final ProcessorContext context) {\n \n         // Setup metrics before the database is opened, otherwise the metrics are not updated\n         // with the measurements from Rocks DB\n-        maybeSetUpMetricsRecorder(context, configs);\n+        maybeSetUpMetricsRecorder(configs);", "originalCommit": "37cc5ef592cbfc4b5e20c59c9d36420fc41b5ae0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTg2MDQ1OA==", "url": "https://github.com/apache/kafka/pull/8501#discussion_r409860458", "bodyText": "This is just for my own understanding: for line 144 / 172 above, what kind of simulated failure did we introduce? Seems like we just start and close the stream app while verifying metrics twice?", "author": "guozhangwang", "createdAt": "2020-04-16T21:31:27Z", "path": "streams/src/test/java/org/apache/kafka/streams/integration/RocksDBMetricsIntegrationTest.java", "diffHunk": "@@ -181,40 +181,6 @@ public void shouldExposeRocksDBMetricsForSegmentedStateStoreBeforeAndAfterFailur\n         );\n     }\n \n-    @Test", "originalCommit": "37cc5ef592cbfc4b5e20c59c9d36420fc41b5ae0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDA5NzIwMw==", "url": "https://github.com/apache/kafka/pull/8501#discussion_r410097203", "bodyText": "This tests mainly verifies this bug https://issues.apache.org/jira/browse/KAFKA-9355 but also generally whether the RocksDB metrics are exposed. The fix for the bug is hard to verify as a unit test because it involves a couple of components, e.g., Metered*Store, *Segments, and RocksDBStore.", "author": "cadonna", "createdAt": "2020-04-17T09:14:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTg2MDQ1OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDM3NDg4MQ==", "url": "https://github.com/apache/kafka/pull/8501#discussion_r410374881", "bodyText": "Got it, thanks!", "author": "guozhangwang", "createdAt": "2020-04-17T17:43:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTg2MDQ1OA=="}], "type": "inlineReview"}]}