{"pr_number": 9802, "pr_title": "KAFKA-10894; Ensure PartitionInfo replicas are not null in client quota callback", "pr_createdAt": "2020-12-30T22:44:30Z", "pr_url": "https://github.com/apache/kafka/pull/9802", "timeline": [{"oid": "81dd02bb015d75975ab6f27e78bf7e5eb0e6a224", "url": "https://github.com/apache/kafka/commit/81dd02bb015d75975ab6f27e78bf7e5eb0e6a224", "message": "KAFKA-10894; Ensure PartitionInfo replicas are not null in client quota callback", "committedDate": "2020-12-30T22:42:03Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDQwOTEwNw==", "url": "https://github.com/apache/kafka/pull/9802#discussion_r550409107", "bodyText": "How about using a helper method to create new Node(id, \"\", -1) ? It can be used by MetadataResponse also.", "author": "chia7712", "createdAt": "2020-12-31T06:35:27Z", "path": "core/src/main/scala/kafka/server/MetadataCache.scala", "diffHunk": "@@ -266,8 +266,16 @@ class MetadataCache(brokerId: Int) extends Logging {\n \n   def getClusterMetadata(clusterId: String, listenerName: ListenerName): Cluster = {\n     val snapshot = metadataSnapshot\n-    val nodes = snapshot.aliveNodes.map { case (id, nodes) => (id, nodes.get(listenerName).orNull) }\n-    def node(id: Integer): Node = nodes.get(id.toLong).orNull\n+    val nodes = snapshot.aliveNodes.flatMap { case (id, nodesByListener) =>\n+      nodesByListener.get(listenerName).map { node =>\n+        id -> node\n+      }\n+    }\n+\n+    def node(id: Integer): Node = {\n+      nodes.getOrElse(id.toLong, new Node(id, \"\", -1))", "originalCommit": "81dd02bb015d75975ab6f27e78bf7e5eb0e6a224", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTY0MTIzNQ==", "url": "https://github.com/apache/kafka/pull/9802#discussion_r551641235", "bodyText": "That's not a bad idea. I think Node is public, though we haven't always been strict about requiring KIPs for new methods. A couple options are to add a new constructor or a static factory. We could also add a utility somewhere, but that feels a little clumsy. Thoughts?", "author": "hachikuji", "createdAt": "2021-01-05T00:04:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDQwOTEwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTY4ODk0MA==", "url": "https://github.com/apache/kafka/pull/9802#discussion_r551688940", "bodyText": "I think Node is public, though we haven't always been strict about requiring KIPs for new methods. A couple options are to add a new constructor or a static factory. We could also add a utility somewhere, but that feels a little clumsy. Thoughts?\n\nYou are right.\nFor another, is this a kind of behavior change to ClientQuotaCallback (if custom ClientQuotaCallback does depend on the null value)? If so, how we keep the compatibility or should we offer a helper method to enable ClientQuotaCallback to validate the \"new Node(id, \"\", -1)\"?", "author": "chia7712", "createdAt": "2021-01-05T02:55:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDQwOTEwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjA4OTQxNQ==", "url": "https://github.com/apache/kafka/pull/9802#discussion_r552089415", "bodyText": "I think what we are implementing here is what is documented in PartitionInfo:\n    /**\n     * The complete set of replicas for this partition regardless of whether they are alive or up-to-date\n     */\n    public Node[] replicas() {\n        return replicas;\n    }\nEven the internal logic in PartitionInfo assumes non-null values in the array (I caught this issue because of an NPE in the toString). We probably can't 100% guarantee that all quota callbacks have appropriate isEmpty checks, but my guess is that usage of this plugin is rare in any case and reliance on the replica set is less likely than reliance on the leader. All in all, I think we're better fixing the bug.", "author": "hachikuji", "createdAt": "2021-01-05T17:43:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDQwOTEwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjE1NzkzMA==", "url": "https://github.com/apache/kafka/pull/9802#discussion_r552157930", "bodyText": "my guess is that usage of this plugin is rare in any case and reliance on the replica set is less likely than reliance on the leader. All in all, I think we're better fixing the bug.\n\nmake sense to me. Thanks for your explanation!", "author": "chia7712", "createdAt": "2021-01-05T19:51:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDQwOTEwNw=="}], "type": "inlineReview"}]}