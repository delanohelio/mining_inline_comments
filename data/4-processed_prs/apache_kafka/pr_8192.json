{"pr_number": 8192, "pr_title": "MINOR: add wait_for_assigned_partitions to console-consumer", "pr_createdAt": "2020-02-28T21:03:05Z", "pr_url": "https://github.com/apache/kafka/pull/8192", "timeline": [{"oid": "8d5e9e2fc53fe5ce40cd4df05c4713f3aa155aa9", "url": "https://github.com/apache/kafka/commit/8d5e9e2fc53fe5ce40cd4df05c4713f3aa155aa9", "message": "add wait_for_assigned_partitions in console consumer", "committedDate": "2020-02-28T21:21:39Z", "type": "commit"}, {"oid": "26588bf878e99d1a79afa9433e23103407385e2f", "url": "https://github.com/apache/kafka/commit/26588bf878e99d1a79afa9433e23103407385e2f", "message": "revert timeout", "committedDate": "2020-02-28T21:23:17Z", "type": "commit"}, {"oid": "26588bf878e99d1a79afa9433e23103407385e2f", "url": "https://github.com/apache/kafka/commit/26588bf878e99d1a79afa9433e23103407385e2f", "message": "revert timeout", "committedDate": "2020-02-28T21:23:17Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTkzNDk3Ng==", "url": "https://github.com/apache/kafka/pull/8192#discussion_r385934976", "bodyText": "this is not ideal but requires more refactoring to be able support multiple JmxTools running at once", "author": "brianbushree", "createdAt": "2020-02-28T21:40:08Z", "path": "tests/kafkatest/services/console_consumer.py", "diffHunk": "@@ -273,8 +276,25 @@ def _worker(self, idx, node):\n         with self.lock:\n             self.read_jmx_output(idx, node)\n \n+    def _wait_until_partitions_assigned(self, node, timeout_sec=60):\n+        if self.jmx_object_names is not None:\n+            raise Exception(\"'wait_until_partitions_assigned' is not supported while using 'jmx_object_names'/'jmx_attributes'\")", "originalCommit": "26588bf878e99d1a79afa9433e23103407385e2f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTk0MTEyNQ==", "url": "https://github.com/apache/kafka/pull/8192#discussion_r385941125", "bodyText": "Just to be safe would it make sense to keep this at 60? I'm not insisting, just asking it's fine to leave as is if you are comfortable with it.", "author": "bbejeck", "createdAt": "2020-02-28T21:56:42Z", "path": "tests/kafkatest/tests/core/throttling_test.py", "diffHunk": "@@ -53,7 +53,7 @@ def __init__(self, test_context):\n         # ensure that the consumer is fully started before the producer starts\n         # so that we don't miss any messages. This timeout ensures the sufficient\n         # condition.\n-        self.consumer_init_timeout_sec =  60\n+        self.consumer_init_timeout_sec =  20", "originalCommit": "26588bf878e99d1a79afa9433e23103407385e2f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTk4MjIyNw==", "url": "https://github.com/apache/kafka/pull/8192#discussion_r385982227", "bodyText": "reverted this", "author": "brianbushree", "createdAt": "2020-02-29T00:42:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTk0MTEyNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTk2NzI1NQ==", "url": "https://github.com/apache/kafka/pull/8192#discussion_r385967255", "bodyText": "we should be re-running read_jmx_output before checking this condition", "author": "brianbushree", "createdAt": "2020-02-28T23:25:54Z", "path": "tests/kafkatest/services/console_consumer.py", "diffHunk": "@@ -273,8 +276,25 @@ def _worker(self, idx, node):\n         with self.lock:\n             self.read_jmx_output(idx, node)\n \n+    def _wait_until_partitions_assigned(self, node, timeout_sec=60):\n+        if self.jmx_object_names is not None:\n+            raise Exception(\"'wait_until_partitions_assigned' is not supported while using 'jmx_object_names'/'jmx_attributes'\")\n+        jmx_tool = JmxTool(self.context, jmx_poll_ms=100)\n+        jmx_tool.jmx_object_names = [\"kafka.consumer:type=consumer-coordinator-metrics,client-id=%s\" % self.client_id]\n+        jmx_tool.jmx_attributes = [\"assigned-partitions\"]\n+        jmx_tool.assigned_partitions_jmx_attr = \"kafka.consumer:type=consumer-coordinator-metrics,client-id=%s:assigned-partitions\" % self.client_id\n+        jmx_tool.start_jmx_tool(self.idx(node), node)\n+        jmx_tool.read_jmx_output(self.idx(node), node)\n+        assigned_partitions_jmx_attr = \"kafka.consumer:type=consumer-coordinator-metrics,client-id=%s:assigned-partitions\" % self.client_id\n+        wait_until(lambda: assigned_partitions_jmx_attr in jmx_tool.maximum_jmx_value,", "originalCommit": "26588bf878e99d1a79afa9433e23103407385e2f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "7b35b94d56a498a968fee200aa068e493eac00bd", "url": "https://github.com/apache/kafka/commit/7b35b94d56a498a968fee200aa068e493eac00bd", "message": "read jmx values", "committedDate": "2020-02-28T23:37:53Z", "type": "commit"}, {"oid": "78b03eb5b9fb4fc4f19a58dd163cf31585d6ee97", "url": "https://github.com/apache/kafka/commit/78b03eb5b9fb4fc4f19a58dd163cf31585d6ee97", "message": "revert timeout change", "committedDate": "2020-02-29T00:41:05Z", "type": "commit"}]}