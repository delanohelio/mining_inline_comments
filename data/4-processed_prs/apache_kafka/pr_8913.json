{"pr_number": 8913, "pr_title": "KAFKA-10191 fix flaky StreamsOptimizedTest", "pr_createdAt": "2020-06-23T06:35:09Z", "pr_url": "https://github.com/apache/kafka/pull/8913", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDM2ODEyNw==", "url": "https://github.com/apache/kafka/pull/8913#discussion_r444368127", "bodyText": "Can we drop this comment? While it's definitely true, it's possible this might be caused by other reasons and I wouldn't want someone to jump the gun and reset their application unnecessarily.\nIf someone hits this, they'll probably open a file or send a question to the mailing list and then we can follow up with them to see if this might be the case", "author": "ableegoldman", "createdAt": "2020-06-23T16:51:55Z", "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/assignment/ClientState.java", "diffHunk": "@@ -303,7 +303,8 @@ public void computeTaskLags(final UUID uuid, final Map<TaskId, Long> allTaskEndO\n     public long lagFor(final TaskId task) {\n         final Long totalLag = taskLagTotals.get(task);\n         if (totalLag == null) {\n-            throw new IllegalStateException(\"Tried to lookup lag for unknown task \" + task);\n+            throw new IllegalStateException(\"Tried to lookup lag for unknown task: \" + task\n+                + \" (This exception may be caused by that you don't call KafkaStreams#cleanUp when topology optimization is enabled)\");", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDM3MzU1Ng==", "url": "https://github.com/apache/kafka/pull/8913#discussion_r444373556", "bodyText": "you are right. I will revert it.", "author": "chia7712", "createdAt": "2020-06-23T17:01:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDM2ODEyNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDM3MDk3Ng==", "url": "https://github.com/apache/kafka/pull/8913#discussion_r444370976", "bodyText": "I think we can just call cleanUp here without passing in a flag. We only need to do it the second time around, but it doesn't hurt to just call it every time and it keeps things simple (the system tests are already complicated enough \ud83d\ude42)", "author": "ableegoldman", "createdAt": "2020-06-23T16:56:44Z", "path": "streams/src/test/java/org/apache/kafka/streams/tests/StreamsOptimizedTest.java", "diffHunk": "@@ -130,6 +130,8 @@ public static void main(final String[] args) throws Exception {\n             }\n         });\n \n+        if (streamsProperties.containsKey(\"streams.cleanup\")\n+            && Boolean.parseBoolean(streamsProperties.getProperty(\"streams.cleanup\"))) streams.cleanUp();", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDM3NDAxMQ==", "url": "https://github.com/apache/kafka/pull/8913#discussion_r444374011", "bodyText": "Copy that. one line change for this PR :)", "author": "chia7712", "createdAt": "2020-06-23T17:01:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDM3MDk3Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDM4MzIxMQ==", "url": "https://github.com/apache/kafka/pull/8913#discussion_r444383211", "bodyText": "One liners are the best \ud83d\udc4d", "author": "ableegoldman", "createdAt": "2020-06-23T17:17:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDM3MDk3Ng=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzQ4ODY0MA==", "url": "https://github.com/apache/kafka/pull/8913#discussion_r447488640", "bodyText": "@ableegoldman Please take a look :)", "author": "chia7712", "createdAt": "2020-06-30T08:01:12Z", "path": "tests/kafkatest/services/streams.py", "diffHunk": "@@ -445,6 +449,40 @@ def __init__(self, test_context, kafka, configs):\n                                                         \"org.apache.kafka.streams.tests.StreamsStandByReplicaTest\",\n                                                         configs)\n \n+class StreamsResetter(StreamsTestBaseService):", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY5NzkwNg==", "url": "https://github.com/apache/kafka/pull/8913#discussion_r448697906", "bodyText": "super nit: we already print Done upon successful reset of the application (at the end of #maybeResetInputAndSeekToEndIntermediateTopicOffsets), can we just reuse that in the system test so we don't have to add any new print statements?", "author": "ableegoldman", "createdAt": "2020-07-02T01:26:10Z", "path": "core/src/main/scala/kafka/tools/StreamsResetter.java", "diffHunk": "@@ -168,7 +168,7 @@ public int run(final String[] args,\n             consumerConfig.putAll(properties);\n             exitCode = maybeResetInputAndSeekToEndIntermediateTopicOffsets(consumerConfig, dryRun);\n             maybeDeleteInternalTopics(adminClient, dryRun);\n-\n+            System.out.println(\"succeed to reset stream application: \" + groupId);", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODcxMTYyNQ==", "url": "https://github.com/apache/kafka/pull/8913#discussion_r448711625", "bodyText": "copy that", "author": "chia7712", "createdAt": "2020-07-02T02:20:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY5NzkwNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY5ODc2OA==", "url": "https://github.com/apache/kafka/pull/8913#discussion_r448698768", "bodyText": "If you look at the StreamsResetter logs, it prints No input or intermediate topics specified. Skipping seek. I think we need to also supply the input topic here -- it's named \"input.topic\"", "author": "ableegoldman", "createdAt": "2020-07-02T01:29:40Z", "path": "tests/kafkatest/services/streams.py", "diffHunk": "@@ -445,6 +449,40 @@ def __init__(self, test_context, kafka, configs):\n                                                         \"org.apache.kafka.streams.tests.StreamsStandByReplicaTest\",\n                                                         configs)\n \n+class StreamsResetter(StreamsTestBaseService):\n+    def __init__(self, test_context, kafka):\n+        super(StreamsResetter, self).__init__(test_context,\n+                                              kafka,\n+                                              \"kafka.tools.StreamsResetter\",\n+                                              \"\")\n+\n+    @property\n+    def expectedMessage(self):\n+        return 'succeed to reset stream application'\n+\n+    def start_cmd(self, node):\n+        args = self.args.copy()\n+        args['bootstrap.servers'] = self.kafka.bootstrap_servers()\n+        args['stdout'] = self.STDOUT_FILE\n+        args['stderr'] = self.STDERR_FILE\n+        args['pidfile'] = self.PID_FILE\n+        args['log4j'] = self.LOG4J_CONFIG_FILE\n+        args['kafka_run_class'] = self.path.script(\"kafka-run-class.sh\", node)\n+\n+        cmd = \"(export KAFKA_LOG4J_OPTS=\\\"-Dlog4j.configuration=file:%(log4j)s\\\"; \" \\\n+              \"%(kafka_run_class)s %(streams_class_name)s \" \\\n+              \"--bootstrap-servers %(bootstrap.servers)s \" \\\n+              \"--force \" \\\n+              \"--application-id StreamsOptimizedTest \" \\", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDQwODYzMg==", "url": "https://github.com/apache/kafka/pull/8913#discussion_r450408632", "bodyText": "long-term", "author": "abbccdda", "createdAt": "2020-07-06T18:35:19Z", "path": "tests/kafkatest/tests/streams/streams_optimized_test.py", "diffHunk": "@@ -90,6 +93,12 @@ def test_upgrade_optimized_topology(self):\n         self.kafka.stop()\n         self.zookeeper.stop()\n \n+    def reset_application(self):\n+        resetter = StreamsResetter(self.test_context, self.kafka)\n+        resetter.start()\n+        # resetter is not long-tern running but it would be better to check the pid by stopping it", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDQwOTA5Nw==", "url": "https://github.com/apache/kafka/pull/8913#discussion_r450409097", "bodyText": "Could we make the input topic configurable?", "author": "abbccdda", "createdAt": "2020-07-06T18:36:18Z", "path": "tests/kafkatest/services/streams.py", "diffHunk": "@@ -448,6 +452,41 @@ def __init__(self, test_context, kafka, configs):\n                                                         \"org.apache.kafka.streams.tests.StreamsStandByReplicaTest\",\n                                                         configs)\n \n+class StreamsResetter(StreamsTestBaseService):\n+    def __init__(self, test_context, kafka):\n+        super(StreamsResetter, self).__init__(test_context,\n+                                              kafka,\n+                                              \"kafka.tools.StreamsResetter\",\n+                                              \"\")\n+\n+    @property\n+    def expectedMessage(self):\n+        return 'Done.'\n+\n+    def start_cmd(self, node):\n+        args = self.args.copy()\n+        args['bootstrap.servers'] = self.kafka.bootstrap_servers()\n+        args['stdout'] = self.STDOUT_FILE\n+        args['stderr'] = self.STDERR_FILE\n+        args['pidfile'] = self.PID_FILE\n+        args['log4j'] = self.LOG4J_CONFIG_FILE\n+        args['kafka_run_class'] = self.path.script(\"kafka-run-class.sh\", node)\n+\n+        cmd = \"(export KAFKA_LOG4J_OPTS=\\\"-Dlog4j.configuration=file:%(log4j)s\\\"; \" \\\n+              \"%(kafka_run_class)s %(streams_class_name)s \" \\\n+              \"--bootstrap-servers %(bootstrap.servers)s \" \\\n+              \"--force \" \\\n+              \"--application-id StreamsOptimizedTest \" \\\n+              \"--input-topics input.topic \" \\", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "150dee8bed5f2e4cfcb7a9d03d658e2b809348c7", "url": "https://github.com/apache/kafka/commit/150dee8bed5f2e4cfcb7a9d03d658e2b809348c7", "message": "KAFKA-10191 fix flaky StreamsOptimizedTest - call KafkaStreams#cleanUp before starting the application up the second time", "committedDate": "2020-07-07T04:17:44Z", "type": "commit"}, {"oid": "6c72db85b6414f39f9404eeeba9dda47a403d084", "url": "https://github.com/apache/kafka/commit/6c72db85b6414f39f9404eeeba9dda47a403d084", "message": "KAFKA-10191 [1] remove meaningless code", "committedDate": "2020-07-07T04:17:44Z", "type": "commit"}, {"oid": "d80f6abfd2583b0031c068dbdc23948373eadaae", "url": "https://github.com/apache/kafka/commit/d80f6abfd2583b0031c068dbdc23948373eadaae", "message": "KAFKA-10191 [2] revert comment", "committedDate": "2020-07-07T04:17:44Z", "type": "commit"}, {"oid": "dbd49e301ac32ec67115aadb6a22e63c7288db28", "url": "https://github.com/apache/kafka/commit/dbd49e301ac32ec67115aadb6a22e63c7288db28", "message": "KAFKA-10191 [3] run the reset tool between stopping the original application and starting the new one", "committedDate": "2020-07-07T04:17:44Z", "type": "commit"}, {"oid": "03d51c6492993c29ad9844b1d811909f51ad0b73", "url": "https://github.com/apache/kafka/commit/03d51c6492993c29ad9844b1d811909f51ad0b73", "message": "KAFKA-10191 [4] remove useless code", "committedDate": "2020-07-07T04:17:44Z", "type": "commit"}, {"oid": "f1495f1c3a6f02f8b49b5ee2c9e22eeaff5ff79c", "url": "https://github.com/apache/kafka/commit/f1495f1c3a6f02f8b49b5ee2c9e22eeaff5ff79c", "message": "KAFKA-10191 [5] add more comment", "committedDate": "2020-07-07T04:17:44Z", "type": "commit"}, {"oid": "0731913c3b73ae7bae2ea4bb10f213423038f232", "url": "https://github.com/apache/kafka/commit/0731913c3b73ae7bae2ea4bb10f213423038f232", "message": "KAFKA-10191 [6] remove print statements and add input.topics", "committedDate": "2020-07-07T04:17:44Z", "type": "commit"}, {"oid": "3d3c1c179b16737eafaaa503ed2baaef635f1f17", "url": "https://github.com/apache/kafka/commit/3d3c1c179b16737eafaaa503ed2baaef635f1f17", "message": "KAFKA-10191 address comments", "committedDate": "2020-07-07T06:56:12Z", "type": "commit"}, {"oid": "3d3c1c179b16737eafaaa503ed2baaef635f1f17", "url": "https://github.com/apache/kafka/commit/3d3c1c179b16737eafaaa503ed2baaef635f1f17", "message": "KAFKA-10191 address comments", "committedDate": "2020-07-07T06:56:12Z", "type": "forcePushed"}, {"oid": "4268ab25b8a7241b391f8cbbecfc01e71a015a52", "url": "https://github.com/apache/kafka/commit/4268ab25b8a7241b391f8cbbecfc01e71a015a52", "message": "KAFKA-10191 correct topic", "committedDate": "2020-07-07T07:06:55Z", "type": "commit"}]}