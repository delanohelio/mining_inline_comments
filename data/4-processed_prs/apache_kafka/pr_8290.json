{"pr_number": 8290, "pr_title": "KAFKA-9677: Fix consumer fetch with small consume bandwidth quotas", "pr_createdAt": "2020-03-12T23:36:13Z", "pr_url": "https://github.com/apache/kafka/pull/8290", "timeline": [{"oid": "57ac32b5602d2a847b7705ac3dc7084973c620ce", "url": "https://github.com/apache/kafka/commit/57ac32b5602d2a847b7705ac3dc7084973c620ce", "message": "KAFKA-9677: Fix consumer fetch with small consume bandwidth quotas", "committedDate": "2020-03-12T23:31:22Z", "type": "commit"}, {"oid": "49a7fc93aeacd5a16dc825295c2ad65ba33edc9c", "url": "https://github.com/apache/kafka/commit/49a7fc93aeacd5a16dc825295c2ad65ba33edc9c", "message": "make sure we only cap request from consumer", "committedDate": "2020-03-13T02:26:26Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjI1NjE1Ng==", "url": "https://github.com/apache/kafka/pull/8290#discussion_r392256156", "bodyText": "Does this really need 10 minutes? One minute itself seems like a long time for the tests. Should we send larger messages to get the test to complete faster?", "author": "rajinisivaram", "createdAt": "2020-03-13T14:19:25Z", "path": "core/src/test/scala/integration/kafka/api/BaseQuotaTest.scala", "diffHunk": "@@ -194,19 +212,24 @@ abstract class QuotaTestClients(topic: String,\n   }\n \n   def consumeUntilThrottled(maxRecords: Int, waitForRequestCompletion: Boolean = true): Int = {\n+    val longTimeoutMs = TimeUnit.MINUTES.toMillis(10)\n+    val shortTimeoutMs = TimeUnit.MINUTES.toMillis(1)\n+\n     consumer.subscribe(Collections.singleton(topic))\n     var numConsumed = 0\n     var throttled = false\n+    val startMs = System.currentTimeMillis\n     do {\n       numConsumed += consumer.poll(Duration.ofMillis(100L)).count\n       val metric = throttleMetric(QuotaType.Fetch, consumerClientId)\n       throttled = metric != null && metricValue(metric) > 0\n-    }  while (numConsumed < maxRecords && !throttled)\n+    }  while (numConsumed < maxRecords && !throttled && System.currentTimeMillis < startMs + longTimeoutMs)", "originalCommit": "49a7fc93aeacd5a16dc825295c2ad65ba33edc9c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjU0MDIxMQ==", "url": "https://github.com/apache/kafka/pull/8290#discussion_r392540211", "bodyText": "I did such a long timeout because before there was no timeout, wanted to make sure it is enough. I verified that each test runs just 20-30 seconds max. I updated the code to use 1 minute for a timeout.", "author": "apovzner", "createdAt": "2020-03-14T00:46:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjI1NjE1Ng=="}], "type": "inlineReview"}, {"oid": "3594c411cd86e8faab44bfbd6a55fde411abe5d7", "url": "https://github.com/apache/kafka/commit/3594c411cd86e8faab44bfbd6a55fde411abe5d7", "message": "reduced timeout in test and fixed CustomQuotaCallbackTest", "committedDate": "2020-03-14T00:52:22Z", "type": "commit"}]}