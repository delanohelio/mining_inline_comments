{"pr_number": 8273, "pr_title": "MINOR: Fix generic types in StreamsBuilder and Topology", "pr_createdAt": "2020-03-11T03:21:01Z", "pr_url": "https://github.com/apache/kafka/pull/8273", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDcyNjk1OQ==", "url": "https://github.com/apache/kafka/pull/8273#discussion_r390726959", "bodyText": "Even if this this public API, it's not a \"change\" but a bug fix, because when we call internalStreamsBuilder.addGlobalStore() we cast to StoreBuilder<KeyValue> store in the old code already.\nTying the type for the store, Consumed and ProcessorSupplier is also a bug fix, because if the types don't match, something breaks at runtime.\nAt least I think so -- let me know if I miss something. Fixing a public API this way is tricky...", "author": "mjsax", "createdAt": "2020-03-11T03:25:05Z", "path": "streams/src/main/java/org/apache/kafka/streams/StreamsBuilder.java", "diffHunk": "@@ -484,22 +484,23 @@ public synchronized StreamsBuilder addStateStore(final StoreBuilder builder) {\n     /**\n      * @deprecated use {@link #addGlobalStore(StoreBuilder, String, Consumed, ProcessorSupplier)} instead\n      */\n-    @SuppressWarnings(\"unchecked\")\n     @Deprecated\n-    public synchronized StreamsBuilder addGlobalStore(final StoreBuilder storeBuilder,\n-                                                      final String topic,\n-                                                      final String sourceName,\n-                                                      final Consumed consumed,\n-                                                      final String processorName,\n-                                                      final ProcessorSupplier stateUpdateSupplier) {\n+    public synchronized <K, V>  StreamsBuilder addGlobalStore(final StoreBuilder<KeyValueStore<K, V>> storeBuilder,", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDc1NjM4MA==", "url": "https://github.com/apache/kafka/pull/8273#discussion_r390756380", "bodyText": "the super class StateStoreNode does NOT require the KeyValueStore type so is it necessary to add KeyValueStore type? Or a wildcard type is enough?", "author": "chia7712", "createdAt": "2020-03-11T05:45:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDcyNjk1OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTI5ODc3Nw==", "url": "https://github.com/apache/kafka/pull/8273#discussion_r391298777", "bodyText": "Do we assume the stores added as global are always kv-stores? I vaguely remember for non-global source KTable we have this restriction (KIP-300) but not clear if we have the same restriction for global stores.", "author": "guozhangwang", "createdAt": "2020-03-11T22:13:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDcyNjk1OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTMzMjY5NQ==", "url": "https://github.com/apache/kafka/pull/8273#discussion_r391332695", "bodyText": "My assumption was that InternalStreamsBuilder.addGlobalStore() that we call below applies this limitation (cf. https://github.com/apache/kafka/pull/8273/files#r391330086).\nSeems this assumption was wrong. Will remove the store type.", "author": "mjsax", "createdAt": "2020-03-11T23:49:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDcyNjk1OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDcyNjk5NQ==", "url": "https://github.com/apache/kafka/pull/8273#discussion_r390726995", "bodyText": "Ab above", "author": "mjsax", "createdAt": "2020-03-11T03:25:17Z", "path": "streams/src/main/java/org/apache/kafka/streams/StreamsBuilder.java", "diffHunk": "@@ -528,17 +529,18 @@ public synchronized StreamsBuilder addGlobalStore(final StoreBuilder storeBuilde\n      * @return itself\n      * @throws TopologyException if the processor of state is already registered\n      */\n-    @SuppressWarnings(\"unchecked\")\n-    public synchronized StreamsBuilder addGlobalStore(final StoreBuilder storeBuilder,\n-                                                      final String topic,\n-                                                      final Consumed consumed,\n-                                                      final ProcessorSupplier stateUpdateSupplier) {\n+    public synchronized <K, V> StreamsBuilder addGlobalStore(final StoreBuilder<KeyValueStore<K, V>> storeBuilder,", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTI5ODg5Nw==", "url": "https://github.com/apache/kafka/pull/8273#discussion_r391298897", "bodyText": "Ditto here.", "author": "guozhangwang", "createdAt": "2020-03-11T22:13:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDcyNjk5NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDcyNzEwNg==", "url": "https://github.com/apache/kafka/pull/8273#discussion_r390727106", "bodyText": "Same here", "author": "mjsax", "createdAt": "2020-03-11T03:25:42Z", "path": "streams/src/main/java/org/apache/kafka/streams/Topology.java", "diffHunk": "@@ -695,16 +696,23 @@ public synchronized Topology addStateStore(final StoreBuilder storeBuilder,\n      * @return itself\n      * @throws TopologyException if the processor of state is already registered\n      */\n-    @SuppressWarnings(\"unchecked\")\n-    public synchronized Topology addGlobalStore(final StoreBuilder storeBuilder,\n-                                                final String sourceName,\n-                                                final Deserializer keyDeserializer,\n-                                                final Deserializer valueDeserializer,\n-                                                final String topic,\n-                                                final String processorName,\n-                                                final ProcessorSupplier stateUpdateSupplier) {\n-        internalTopologyBuilder.addGlobalStore(storeBuilder, sourceName, null, keyDeserializer,\n-            valueDeserializer, topic, processorName, stateUpdateSupplier);\n+    public synchronized <K, V> Topology addGlobalStore(final StoreBuilder<KeyValueStore<K, V>> storeBuilder,", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDcyNzE1MA==", "url": "https://github.com/apache/kafka/pull/8273#discussion_r390727150", "bodyText": "And one more :)", "author": "mjsax", "createdAt": "2020-03-11T03:25:52Z", "path": "streams/src/main/java/org/apache/kafka/streams/Topology.java", "diffHunk": "@@ -732,17 +740,24 @@ public synchronized Topology addGlobalStore(final StoreBuilder storeBuilder,\n      * @return itself\n      * @throws TopologyException if the processor of state is already registered\n      */\n-    @SuppressWarnings(\"unchecked\")\n-    public synchronized Topology addGlobalStore(final StoreBuilder storeBuilder,\n-                                                final String sourceName,\n-                                                final TimestampExtractor timestampExtractor,\n-                                                final Deserializer keyDeserializer,\n-                                                final Deserializer valueDeserializer,\n-                                                final String topic,\n-                                                final String processorName,\n-                                                final ProcessorSupplier stateUpdateSupplier) {\n-        internalTopologyBuilder.addGlobalStore(storeBuilder, sourceName, timestampExtractor, keyDeserializer,\n-            valueDeserializer, topic, processorName, stateUpdateSupplier);\n+    public synchronized <K, V> Topology addGlobalStore(final StoreBuilder<KeyValueStore<K, V>> storeBuilder,", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDcyNzM0MQ==", "url": "https://github.com/apache/kafka/pull/8273#discussion_r390727341", "bodyText": "Not sure why we did Serde.class.cast here? Seem unnecessary to me?", "author": "mjsax", "createdAt": "2020-03-11T03:26:43Z", "path": "streams/src/main/java/org/apache/kafka/streams/kstream/SessionWindowedSerializer.java", "diffHunk": "@@ -50,7 +50,7 @@ public void configure(final Map<String, ?> configs, final boolean isKey) {\n             final String propertyName = isKey ? StreamsConfig.DEFAULT_WINDOWED_KEY_SERDE_INNER_CLASS : StreamsConfig.DEFAULT_WINDOWED_VALUE_SERDE_INNER_CLASS;\n             final String value = (String) configs.get(propertyName);\n             try {\n-                inner = Serde.class.cast(Utils.newInstance(value, Serde.class)).serializer();\n+                inner = (Utils.newInstance(value, Serde.class)).serializer();", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDcyNzkxNw==", "url": "https://github.com/apache/kafka/pull/8273#discussion_r390727917", "bodyText": "The change in the public API has this annoying side effect that the type of the lambda cannot inferred any longer (not sure why...) -- however, this might be reason enough to not change the public API as I did above.\nLet me know what you think (I though I just to the PR anyway to get a discussion going).", "author": "mjsax", "createdAt": "2020-03-11T03:29:26Z", "path": "streams/src/test/java/org/apache/kafka/streams/KafkaStreamsTest.java", "diffHunk": "@@ -848,7 +849,7 @@ public void statelessTopologyShouldNotCreateStateDirectory() throws Exception {\n         final String outputTopic = testName.getMethodName() + \"-output\";\n         final Topology topology = new Topology();\n         topology.addSource(\"source\", Serdes.String().deserializer(), Serdes.String().deserializer(), inputTopic)\n-                .addProcessor(\"process\", () -> new AbstractProcessor<String, String>() {\n+                .addProcessor(\"process\", (ProcessorSupplier<String, String>) () -> new AbstractProcessor<String, String>() {", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTg5MjQ5Mg==", "url": "https://github.com/apache/kafka/pull/8273#discussion_r391892492", "bodyText": "I think it was never inferred before, it was actually the type ProcessorSupplier<Object, Object> (just my theory).\nI think if old code will fail to compile, we should not change the public API. Note, the existing methods would be deprecated as part of implementing KIP-478 anyway, so maybe we should just leave the public APIs alone.", "author": "vvcephei", "createdAt": "2020-03-12T21:03:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDcyNzkxNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDcyODA5OQ==", "url": "https://github.com/apache/kafka/pull/8273#discussion_r390728099", "bodyText": "As I don't speak Scala, I am not sure if this change is correct -- it compiles so I was happy :)", "author": "mjsax", "createdAt": "2020-03-11T03:30:22Z", "path": "streams/streams-scala/src/main/scala/org/apache/kafka/streams/scala/StreamsBuilder.scala", "diffHunk": "@@ -176,10 +176,10 @@ class StreamsBuilder(inner: StreamsBuilderJ = new StreamsBuilderJ) {\n    *\n    * @see `org.apache.kafka.streams.StreamsBuilder#addGlobalStore`\n    */\n-  def addGlobalStore(storeBuilder: StoreBuilder[_ <: StateStore],\n-                     topic: String,\n-                     consumed: Consumed[_, _],\n-                     stateUpdateSupplier: ProcessorSupplier[_, _]): StreamsBuilderJ =\n+  def addGlobalStore[K, V](storeBuilder: StoreBuilder[KeyValueStore[K, V]],", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDc1NTEwMA==", "url": "https://github.com/apache/kafka/pull/8273#discussion_r390755100", "bodyText": "Could we replace raw type by wildcard type for StateStoreNode? After all, the raw type is strongly discouraged...", "author": "chia7712", "createdAt": "2020-03-11T05:39:21Z", "path": "streams/src/main/java/org/apache/kafka/streams/kstream/internals/graph/GlobalStoreNode.java", "diffHunk": "@@ -23,22 +23,22 @@\n import org.apache.kafka.streams.state.KeyValueStore;\n import org.apache.kafka.streams.state.StoreBuilder;\n \n-public class GlobalStoreNode extends StateStoreNode {\n+public class GlobalStoreNode<K, V> extends StateStoreNode {", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTMzMDcwMg==", "url": "https://github.com/apache/kafka/pull/8273#discussion_r391330702", "bodyText": "Not sure what you mean? The old code uses \"raw types\" and we just add proper generic typing to get type safety for GlobalStoreNode class.", "author": "mjsax", "createdAt": "2020-03-11T23:42:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDc1NTEwMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTQwMjA4Nw==", "url": "https://github.com/apache/kafka/pull/8273#discussion_r391402087", "bodyText": "The old code uses \"raw types\"\n\nStateStoreNode uses \"raw types\", right? Why not replacing it by wildcard as \"raw types\" is discouraged. Further, the generic type of StoreBuilder doesn't seem to be useful. For example, StoreBuilder#build is called by following code.\n        for (final StoreBuilder<?> storeBuilder : globalStateBuilders.values()) {\n            globalStateStores.put(storeBuilder.name(), storeBuilder.build());\n        }\n        public StateStore build() {\n            return builder.build();\n        }\nBoth of they don't take the generic type.\nAlso, StreamsBuilder doesn't even use the generic type of StoreBuilder. Not sure what purpose for generic type of StoreBuilder?", "author": "chia7712", "createdAt": "2020-03-12T05:00:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDc1NTEwMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTgxMTQyMw==", "url": "https://github.com/apache/kafka/pull/8273#discussion_r391811423", "bodyText": "Ack. We can improve this further.\nNote, this PR does not fix everything yet -- it's better to do it incrementally to keep PRs small -- I will include a fix for this comment in this PR though.", "author": "mjsax", "createdAt": "2020-03-12T18:25:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDc1NTEwMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTMwMDIzNw==", "url": "https://github.com/apache/kafka/pull/8273#discussion_r391300237", "bodyText": "Ditto here: are we always restricting to a kv-store.", "author": "guozhangwang", "createdAt": "2020-03-11T22:15:40Z", "path": "streams/src/main/java/org/apache/kafka/streams/kstream/internals/InternalStreamsBuilder.java", "diffHunk": "@@ -197,31 +197,33 @@ public String newStoreName(final String prefix) {\n         return prefix + String.format(KTableImpl.STATE_STORE_NAME + \"%010d\", index.getAndIncrement());\n     }\n \n-    public synchronized void addStateStore(final StoreBuilder builder) {\n+    public synchronized void addStateStore(final StoreBuilder<?> builder) {\n         addGraphNode(root, new StateStoreNode(builder));\n     }\n \n-    public synchronized void addGlobalStore(final StoreBuilder<KeyValueStore> storeBuilder,\n-                                            final String sourceName,\n-                                            final String topic,\n-                                            final ConsumedInternal consumed,\n-                                            final String processorName,\n-                                            final ProcessorSupplier stateUpdateSupplier) {\n-\n-        final StreamsGraphNode globalStoreNode = new GlobalStoreNode(storeBuilder,\n-                                                                     sourceName,\n-                                                                     topic,\n-                                                                     consumed,\n-                                                                     processorName,\n-                                                                     stateUpdateSupplier);\n+    public synchronized <K, V> void addGlobalStore(final StoreBuilder<KeyValueStore<K, V>> storeBuilder,\n+                                                   final String sourceName,\n+                                                   final String topic,\n+                                                   final ConsumedInternal<K, V> consumed,\n+                                                   final String processorName,\n+                                                   final ProcessorSupplier<K, V> stateUpdateSupplier) {\n+\n+        final StreamsGraphNode globalStoreNode = new GlobalStoreNode<>(\n+                storeBuilder,\n+                sourceName,\n+                topic,\n+                consumed,\n+                processorName,\n+                stateUpdateSupplier\n+        );\n \n         addGraphNode(root, globalStoreNode);\n     }\n \n-    public synchronized void addGlobalStore(final StoreBuilder<KeyValueStore> storeBuilder,\n-                                            final String topic,\n-                                            final ConsumedInternal consumed,\n-                                            final ProcessorSupplier stateUpdateSupplier) {\n+    public synchronized <K, V> void addGlobalStore(final StoreBuilder<KeyValueStore<K, V>> storeBuilder,", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTMzMDA4Ng==", "url": "https://github.com/apache/kafka/pull/8273#discussion_r391330086", "bodyText": "Not that the restriction is applied in the existing code already! (old L221 above). This old code was the reason why I started to add the type at other places, too.\nHowever, I just did a quick check and the specified type from above does actually not result in a class cast exception, ie, the compiler does not insert a cast and we can also have global WindowStores (for example). Hence, I am going to remove the store type to not break compatibility.", "author": "mjsax", "createdAt": "2020-03-11T23:40:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTMwMDIzNw=="}], "type": "inlineReview"}, {"oid": "bdd7547fa2dfb4097bda7b4e421b15c069b279b5", "url": "https://github.com/apache/kafka/commit/bdd7547fa2dfb4097bda7b4e421b15c069b279b5", "message": "MINOR: Fix generic types in StreamsBuilder and Topology", "committedDate": "2020-03-11T23:34:33Z", "type": "commit"}, {"oid": "0de9de646645f324d5d8ca5854f4bc9907e2216c", "url": "https://github.com/apache/kafka/commit/0de9de646645f324d5d8ca5854f4bc9907e2216c", "message": "Github comments", "committedDate": "2020-03-11T23:53:41Z", "type": "commit"}, {"oid": "0de9de646645f324d5d8ca5854f4bc9907e2216c", "url": "https://github.com/apache/kafka/commit/0de9de646645f324d5d8ca5854f4bc9907e2216c", "message": "Github comments", "committedDate": "2020-03-11T23:53:41Z", "type": "forcePushed"}, {"oid": "87daf52f7008796a76c90fb7cd14d6048c26d23b", "url": "https://github.com/apache/kafka/commit/87daf52f7008796a76c90fb7cd14d6048c26d23b", "message": "Github comments", "committedDate": "2020-03-12T22:40:58Z", "type": "commit"}, {"oid": "fe162c64ca6766f629a06f20600dd365af710ab4", "url": "https://github.com/apache/kafka/commit/fe162c64ca6766f629a06f20600dd365af710ab4", "message": "fx checkstyle and revert some public API changes", "committedDate": "2020-03-12T22:59:15Z", "type": "commit"}]}