{"pr_number": 8987, "pr_title": "KAFKA-10221: Backport fix for KAFKA-9603 to 2.5", "pr_createdAt": "2020-07-06T19:49:21Z", "pr_url": "https://github.com/apache/kafka/pull/8987", "timeline": [{"oid": "652250344fcb6d59bd291d4588e41a84d6087470", "url": "https://github.com/apache/kafka/commit/652250344fcb6d59bd291d4588e41a84d6087470", "message": "KAFKA-10221: Backport fix for KAFKA-9603 to 2.5\n\nKAFKA-9603 reports that the number of open files keeps increasing\nin RocksDB. The reason is that bulk loading is turned on but\nnever turned off in segmented state stores for standby tasks.\n\nThis bug was fixed in 2.6 by using code that is not present in 2.5.\n\nThis PR backports the fix to 2.5.", "committedDate": "2020-07-06T19:37:17Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDk2MTkxOQ==", "url": "https://github.com/apache/kafka/pull/8987#discussion_r450961919", "bodyText": "Woah, this is subtle. IIUC, the fix works by asserting that we should only enable bulk loading if the provided context is a ProcessorContextImpl, which is the kind of context that is only provided when adding the store to an active task.\nThis seems correct to me, and although it's very subtle, it also seems ok as a patch for an older codebase that won't need to be maintained much. But maybe we can have a comment, or an internal method for the check, like\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            if (!bulkLoadSegments.contains(segment) && context instanceof ProcessorContextImpl) {\n          \n          \n            \n                            if (!bulkLoadSegments.contains(segment) && isStoreForActiveTask(context)) {\n          \n      \n    \n    \n  \n\nso that it'll be more obvious what's going on here?", "author": "vvcephei", "createdAt": "2020-07-07T15:41:50Z", "path": "streams/src/main/java/org/apache/kafka/streams/state/internals/AbstractRocksDBSegmentedBytesStore.java", "diffHunk": "@@ -251,7 +252,7 @@ void restoreAllInternal(final Collection<KeyValue<byte[], byte[]>> records) {\n                 // This handles the case that state store is moved to a new client and does not\n                 // have the local RocksDB instance for the segment. In this case, toggleDBForBulkLoading\n                 // will only close the database and open it again with bulk loading enabled.\n-                if (!bulkLoadSegments.contains(segment)) {\n+                if (!bulkLoadSegments.contains(segment) && context instanceof ProcessorContextImpl) {", "originalCommit": "652250344fcb6d59bd291d4588e41a84d6087470", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDk4OTAxNg==", "url": "https://github.com/apache/kafka/pull/8987#discussion_r450989016", "bodyText": "Good point! Will do!", "author": "cadonna", "createdAt": "2020-07-07T16:22:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDk2MTkxOQ=="}], "type": "inlineReview"}, {"oid": "f4ae8ea190c2cddb65066bbbe3054f40fe7bcee7", "url": "https://github.com/apache/kafka/commit/f4ae8ea190c2cddb65066bbbe3054f40fe7bcee7", "message": "Make code more readable", "committedDate": "2020-07-07T19:55:12Z", "type": "commit"}]}