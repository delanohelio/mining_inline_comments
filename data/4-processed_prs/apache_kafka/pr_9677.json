{"pr_number": 9677, "pr_title": "KAFKA-10799 AlterIsr utilizes ReplicaManager ISR metrics", "pr_createdAt": "2020-12-02T19:40:28Z", "pr_url": "https://github.com/apache/kafka/pull/9677", "timeline": [{"oid": "04341871df8a1a050dea344676db8c696249128c", "url": "https://github.com/apache/kafka/commit/04341871df8a1a050dea344676db8c696249128c", "message": "Create small abstraction for marking ISR changes.\n\nThis allows us to update the ISR metrics in ReplicaManager without introducing it\nas a dependency to Partition.\n\nAlso, this change includes updating these metrics for ISR changes done through\nAlterIsr", "committedDate": "2020-12-02T19:05:34Z", "type": "commit"}, {"oid": "7d5e37926af224dce7f41b922da39ea82de365c2", "url": "https://github.com/apache/kafka/commit/7d5e37926af224dce7f41b922da39ea82de365c2", "message": "Add supporting test code", "committedDate": "2020-12-02T19:30:01Z", "type": "commit"}, {"oid": "f0851036daa7782ee00c30885707798fa3a4ba2d", "url": "https://github.com/apache/kafka/commit/f0851036daa7782ee00c30885707798fa3a4ba2d", "message": "fix exhaustive match", "committedDate": "2020-12-02T20:04:43Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDQ4MDg0Mg==", "url": "https://github.com/apache/kafka/pull/9677#discussion_r534480842", "bodyText": "Maybe we can move this out of ZkPartitionStateStore since we need the dependence on IsrChangeListener in Partition anyway.", "author": "hachikuji", "createdAt": "2020-12-02T21:05:37Z", "path": "core/src/main/scala/kafka/cluster/Partition.scala", "diffHunk": "@@ -53,7 +59,7 @@ trait PartitionStateStore {\n \n class ZkPartitionStateStore(topicPartition: TopicPartition,\n                             zkClient: KafkaZkClient,\n-                            replicaManager: ReplicaManager) extends PartitionStateStore {\n+                            isrChangeListener: IsrChangeListener) extends PartitionStateStore {", "originalCommit": "f0851036daa7782ee00c30885707798fa3a4ba2d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDQ4MDk5NA==", "url": "https://github.com/apache/kafka/pull/9677#discussion_r534480994", "bodyText": "Maybe IsrChangeMetrics?", "author": "hachikuji", "createdAt": "2020-12-02T21:05:53Z", "path": "core/src/main/scala/kafka/cluster/Partition.scala", "diffHunk": "@@ -45,6 +45,12 @@ import org.apache.kafka.common.{IsolationLevel, TopicPartition}\n import scala.collection.{Map, Seq}\n import scala.jdk.CollectionConverters._\n \n+trait IsrChangeListener {", "originalCommit": "f0851036daa7782ee00c30885707798fa3a4ba2d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "fdb23eb5d73b5928a5bbdc8fff7300ff27706199", "url": "https://github.com/apache/kafka/commit/fdb23eb5d73b5928a5bbdc8fff7300ff27706199", "message": "PR feedback", "committedDate": "2020-12-02T21:59:30Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDUxOTMzNQ==", "url": "https://github.com/apache/kafka/pull/9677#discussion_r534519335", "bodyText": "Hmm.. I had forgotten about this. The purpose of this call is so that we can propagate the ISR change to the controller, but we shouldn't need to do this down the AlterIsr path. This also makes your initial name IsrChangeListener a bit more accurate \ud83d\ude05 .", "author": "hachikuji", "createdAt": "2020-12-02T22:17:53Z", "path": "core/src/main/scala/kafka/cluster/Partition.scala", "diffHunk": "@@ -107,10 +106,24 @@ object Partition extends KafkaMetricsGroup {\n   def apply(topicPartition: TopicPartition,\n             time: Time,\n             replicaManager: ReplicaManager): Partition = {\n+\n+    val isrChangeMetrics = new IsrChangeMetrics {\n+      override def markExpand(): Unit = {\n+        replicaManager.recordIsrChange(topicPartition)", "originalCommit": "fdb23eb5d73b5928a5bbdc8fff7300ff27706199", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "160f8e0e3035c48a94bbac3fd9a44094678aecf3", "url": "https://github.com/apache/kafka/commit/160f8e0e3035c48a94bbac3fd9a44094678aecf3", "message": "Don't update the isrChangeSet when using AlterIsr", "committedDate": "2020-12-02T23:09:19Z", "type": "commit"}, {"oid": "8f44ebed0116e8dae95c331a0475db129d4e4c60", "url": "https://github.com/apache/kafka/commit/8f44ebed0116e8dae95c331a0475db129d4e4c60", "message": "Revert renaming", "committedDate": "2020-12-02T23:14:25Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDU0NzM4NQ==", "url": "https://github.com/apache/kafka/pull/9677#discussion_r534547385", "bodyText": "Note that I'm not including the markFailed call here. Think we should include it here? Or possibly introduce a new retry metric?", "author": "mumrah", "createdAt": "2020-12-02T23:15:55Z", "path": "core/src/main/scala/kafka/cluster/Partition.scala", "diffHunk": "@@ -1406,10 +1429,13 @@ class Partition(val topicPartition: TopicPartition,\n         case Left(error: Errors) => error match {\n           case Errors.UNKNOWN_TOPIC_OR_PARTITION =>\n             debug(s\"Controller failed to update ISR to $proposedIsrState since it doesn't know about this topic or partition. Giving up.\")\n+            isrChangeMetrics.markFailed()\n           case Errors.FENCED_LEADER_EPOCH =>\n             debug(s\"Controller failed to update ISR to $proposedIsrState since we sent an old leader epoch. Giving up.\")\n+            isrChangeMetrics.markFailed()\n           case Errors.INVALID_UPDATE_VERSION =>\n             debug(s\"Controller failed to update ISR to $proposedIsrState due to invalid zk version. Giving up.\")\n+            isrChangeMetrics.markFailed()\n           case _ =>\n             warn(s\"Controller failed to update ISR to $proposedIsrState due to unexpected $error. Retrying.\")\n             sendAlterIsrRequest(proposedIsrState)", "originalCommit": "fdb23eb5d73b5928a5bbdc8fff7300ff27706199", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDU3MTQzNA==", "url": "https://github.com/apache/kafka/pull/9677#discussion_r534571434", "bodyText": "Hmm, I think we should probably do it. If we hit some unexpected case which the broker can't get out of, we'd want the metric to show it.", "author": "hachikuji", "createdAt": "2020-12-03T00:18:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDU0NzM4NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTIxMDI3Mw==", "url": "https://github.com/apache/kafka/pull/9677#discussion_r535210273", "bodyText": "Sounds good", "author": "mumrah", "createdAt": "2020-12-03T13:05:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDU0NzM4NQ=="}], "type": "inlineReview"}, {"oid": "48ca2bb4844778ce4fc464612397a543303370d5", "url": "https://github.com/apache/kafka/commit/48ca2bb4844778ce4fc464612397a543303370d5", "message": "Mark the ISR failure meter on retries as well", "committedDate": "2020-12-03T13:04:14Z", "type": "commit"}, {"oid": "7cca3cc2ce607fa5a2e6ebb27e1903fd208fbc2a", "url": "https://github.com/apache/kafka/commit/7cca3cc2ce607fa5a2e6ebb27e1903fd208fbc2a", "message": "Should be IV2, not IV1", "committedDate": "2020-12-03T15:53:49Z", "type": "commit"}, {"oid": "07700bc5071a01490173c84f5fdc6f55a1c6e515", "url": "https://github.com/apache/kafka/commit/07700bc5071a01490173c84f5fdc6f55a1c6e515", "message": "unused import", "committedDate": "2020-12-03T17:06:58Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTQ1MjI1Mg==", "url": "https://github.com/apache/kafka/pull/9677#discussion_r535452252", "bodyText": "nit: now the block below is misaligned", "author": "hachikuji", "createdAt": "2020-12-03T17:51:10Z", "path": "core/src/main/scala/kafka/cluster/Partition.scala", "diffHunk": "@@ -1403,7 +1426,9 @@ class Partition(val topicPartition: TopicPartition,\n       }\n \n       result match {\n-        case Left(error: Errors) => error match {\n+        case Left(error: Errors) =>\n+          isrChangeListener.markFailed()\n+          error match {", "originalCommit": "07700bc5071a01490173c84f5fdc6f55a1c6e515", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "a1b14919f54e3848890b4421135659446e6e2bbb", "url": "https://github.com/apache/kafka/commit/a1b14919f54e3848890b4421135659446e6e2bbb", "message": "Fix indentation", "committedDate": "2020-12-03T18:00:28Z", "type": "commit"}, {"oid": "7b686bde9dc8ee56d4758aca578e65add96da8b5", "url": "https://github.com/apache/kafka/commit/7b686bde9dc8ee56d4758aca578e65add96da8b5", "message": "Indent paren", "committedDate": "2020-12-03T18:45:50Z", "type": "commit"}]}