{"pr_number": 9378, "pr_title": "MINOR: ACLs for secured cluster system tests", "pr_createdAt": "2020-10-06T00:58:47Z", "pr_url": "https://github.com/apache/kafka/pull/9378", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQyOTM3Nw==", "url": "https://github.com/apache/kafka/pull/9378#discussion_r500429377", "bodyText": "should we add a method to KafkaService or SecurityConfig that tells you which listener to use for tools? Using inter-broker here looks a bit odd, even though it becomes clear when you look at the other changes.", "author": "rajinisivaram", "createdAt": "2020-10-06T16:19:50Z", "path": "tests/kafkatest/services/kafka/kafka.py", "diffHunk": "@@ -451,7 +451,8 @@ def _kafka_topics_cmd(self, node, force_use_zk_connection):\n         set. If Admin client is not going to be used, don't set the environment variable.\n         \"\"\"\n         kafka_topic_script = self.path.script(\"kafka-topics.sh\", node)\n-        skip_security_settings = force_use_zk_connection or not self.all_nodes_topic_command_supports_bootstrap_server()\n+        skip_security_settings = force_use_zk_connection or not self.all_nodes_topic_command_supports_bootstrap_server() \\\n+                                 or self.interbroker_security_protocol == SecurityConfig.PLAINTEXT", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ2NTU0Nw==", "url": "https://github.com/apache/kafka/pull/9378#discussion_r500465547", "bodyText": "Yes, good point, I think it would be a helpful to consolidate the assumptions into one method (or a couple or a few, at most).  I'll see what I can do about refactoring those assumptions out and reusing the logic instead of having it sprinkled around so much as it is now.", "author": "rondagostino", "createdAt": "2020-10-06T17:16:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQyOTM3Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQzMTAyOA==", "url": "https://github.com/apache/kafka/pull/9378#discussion_r500431028", "bodyText": "Is this assuming that else section always means PLAINTEXT since there are no security configs here?", "author": "rajinisivaram", "createdAt": "2020-10-06T16:22:11Z", "path": "tests/kafkatest/services/kafka/kafka.py", "diffHunk": "@@ -983,7 +988,10 @@ def _topic_command_connect_setting(self, node, force_use_zk_connection):\n         bootstrap server, otherwise returns zookeeper connection string.\n         \"\"\"\n         if not force_use_zk_connection and self.all_nodes_topic_command_supports_bootstrap_server():\n-            connection_setting = \"--bootstrap-server %s\" % (self.bootstrap_servers(self.security_protocol))\n+            if self.interbroker_security_protocol == SecurityConfig.PLAINTEXT:\n+                connection_setting = \"--bootstrap-server %s\" % (self.bootstrap_servers(self.interbroker_security_protocol))\n+            else:\n+                connection_setting = \"--bootstrap-server %s\" % (self.bootstrap_servers(self.security_protocol))", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ2NDI1OA==", "url": "https://github.com/apache/kafka/pull/9378#discussion_r500464258", "bodyText": "This code is identifying the port to contact when we are using --bootstrap-server instead of --zookeeper, and we use the port associated with PLAINTEXT rather than SASL_{PLAINTEXT,SSL} or SSL if PLAINTEXT is in use.  The assumption is that if PLAINTEXT is in use it will be the inter-broker security protocol rather than (or in addition to) the client security protocol, which is the case.", "author": "rondagostino", "createdAt": "2020-10-06T17:14:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQzMTAyOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQzMjgzNg==", "url": "https://github.com/apache/kafka/pull/9378#discussion_r500432836", "bodyText": "we are adding more ACLs than we had before. Are they necessary - it is better to limit ACLs unless they are necessary for the tests.", "author": "rajinisivaram", "createdAt": "2020-10-06T16:24:54Z", "path": "tests/kafkatest/services/security/kafka_acls.py", "diffHunk": "@@ -93,11 +97,13 @@ def add_cluster_acl(self, kafka, principal, force_use_zk_connection=False):\n \n         force_use_zk_connection = force_use_zk_connection or not kafka.all_nodes_acl_command_supports_bootstrap_server()\n \n-        cmd = \"%(cmd_prefix)s --add --cluster --operation=ClusterAction --allow-principal=%(principal)s\" % {\n-            'cmd_prefix': self._acl_cmd_prefix(kafka, node, force_use_zk_connection),\n-            'principal': principal\n-        }\n-        kafka.run_cli_tool(node, cmd)\n+        for operation in ['ClusterAction', 'Alter', 'Create']:", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ2MDQ4Nw==", "url": "https://github.com/apache/kafka/pull/9378#discussion_r500460487", "bodyText": "Yes, Alter is needed to create user SCRAM credentials, and Create is needed to create topics.  When we start up a cluster we create the __consumer_offsets topic and a test_topic (typically).  If the test is using SCRAM we also create the SCRAM credentials at this point.  We now use --bootstrap-server instead of --zookeeper for these CLI operations, and without these ACLs a system test will not be able to perform these necessary actions if security is enabled.", "author": "rondagostino", "createdAt": "2020-10-06T17:08:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQzMjgzNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDk4MTcwMg==", "url": "https://github.com/apache/kafka/pull/9378#discussion_r500981702", "bodyText": "I guess the problem is we don't have a separate principal in tests that we can assign those to. Could we separate out Create and Alter into another method, so that tests can set them as necessary or would that impact every test? We expect brokers to have only ClusterAction, but our docs and generally everyone expects broker to have more permissions. This sort of makes our tests run with a combination of permissions that we never expect a principal to have - broker principal should have only ClusterAction, no one else should have ClusterAction. Separating out into two methods may be better even if we end up using the same principal in tests.", "author": "rajinisivaram", "createdAt": "2020-10-07T12:45:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQzMjgzNg=="}], "type": "inlineReview"}, {"oid": "d721c1211b4f7004a5021713932319587084b7ba", "url": "https://github.com/apache/kafka/commit/d721c1211b4f7004a5021713932319587084b7ba", "message": "MINOR: system test ACLs and PLAINTEXT for SCRAM", "committedDate": "2020-10-08T13:01:28Z", "type": "commit"}, {"oid": "ada90d368ad014856a3ee4fc6fefe88b2db5b138", "url": "https://github.com/apache/kafka/commit/ada90d368ad014856a3ee4fc6fefe88b2db5b138", "message": "refactor/consolidate based on review", "committedDate": "2020-10-08T13:01:29Z", "type": "commit"}, {"oid": "a43bc7eb7fa31a60fcfb1ac2e5915bf00d4828d8", "url": "https://github.com/apache/kafka/commit/a43bc7eb7fa31a60fcfb1ac2e5915bf00d4828d8", "message": "fix export error, port selection", "committedDate": "2020-10-08T13:01:30Z", "type": "commit"}, {"oid": "a43bc7eb7fa31a60fcfb1ac2e5915bf00d4828d8", "url": "https://github.com/apache/kafka/commit/a43bc7eb7fa31a60fcfb1ac2e5915bf00d4828d8", "message": "fix export error, port selection", "committedDate": "2020-10-08T13:01:30Z", "type": "forcePushed"}, {"oid": "8ca559f83424a93ce8ab9469b9427213983c2bb2", "url": "https://github.com/apache/kafka/commit/8ca559f83424a93ce8ab9469b9427213983c2bb2", "message": "Fix for non-SCRAM as inter-broker-mechanism", "committedDate": "2020-10-08T20:20:39Z", "type": "commit"}, {"oid": "a72d5986ddee5e147ee9cd164ed0d3cff67ee403", "url": "https://github.com/apache/kafka/commit/a72d5986ddee5e147ee9cd164ed0d3cff67ee403", "message": "fix ZooKeeperSecurityUpgradeTest", "committedDate": "2020-10-09T12:49:05Z", "type": "commit"}]}