{"pr_number": 943, "pr_title": "PLANNER-2164 InnerScoreDirector gets a <Score_> generic parameter", "pr_createdAt": "2020-09-23T11:53:22Z", "pr_url": "https://github.com/kiegroup/optaplanner/pull/943", "timeline": [{"oid": "84799e08d5f6b61bd5ef873466b47fa8de05ad50", "url": "https://github.com/kiegroup/optaplanner/commit/84799e08d5f6b61bd5ef873466b47fa8de05ad50", "message": "Adapt InnerScoreDirector", "committedDate": "2020-09-23T09:24:32Z", "type": "commit"}, {"oid": "8f09c3246a2dd3e59877e1ab5d31ad8eacc032c3", "url": "https://github.com/kiegroup/optaplanner/commit/8f09c3246a2dd3e59877e1ab5d31ad8eacc032c3", "message": "Initial implementation", "committedDate": "2020-09-23T11:51:52Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzUwMDEwNw==", "url": "https://github.com/kiegroup/optaplanner/pull/943#discussion_r493500107", "bodyText": "For some reason, this is not public API. Yet, this change will affect users.\n\nShould we make it public API?\nDo we want to make this change?\n\nMy answer to both is a clear \"yes\".", "author": "triceo", "createdAt": "2020-09-23T11:55:34Z", "path": "optaplanner-core/src/main/java/org/optaplanner/core/impl/score/director/incremental/IncrementalScoreCalculator.java", "diffHunk": "@@ -30,9 +30,10 @@\n  * Any implementation is naturally stateful.\n  *\n  * @param <Solution_> the solution type, the class with the {@link PlanningSolution} annotation\n+ * @param <Score_> the score type to go with the solution\n  * @see IncrementalScoreDirector\n  */\n-public interface IncrementalScoreCalculator<Solution_> {\n+public interface IncrementalScoreCalculator<Solution_, Score_ extends Score<Score_>> {", "originalCommit": "8f09c3246a2dd3e59877e1ab5d31ad8eacc032c3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDE3MjAzMg==", "url": "https://github.com/kiegroup/optaplanner/pull/943#discussion_r494172032", "bodyText": "The reason this isn't public API is because it uses ScoreDirector. EasyScoreCalculator does not.\nBut let's discuss because that might not be enough reason...", "author": "ge0ffrey", "createdAt": "2020-09-24T09:30:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzUwMDEwNw=="}], "type": "inlineReview"}, {"oid": "40b15244c89d19d5e7f48c10d04774adf7108939", "url": "https://github.com/kiegroup/optaplanner/commit/40b15244c89d19d5e7f48c10d04774adf7108939", "message": "Address some Sonar suggestions", "committedDate": "2020-09-23T12:37:09Z", "type": "commit"}, {"oid": "acd2c88e59cd614ccfada981d81b19648f9f193c", "url": "https://github.com/kiegroup/optaplanner/commit/acd2c88e59cd614ccfada981d81b19648f9f193c", "message": "Fix minor issues", "committedDate": "2020-09-23T12:43:42Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDE2NzAxNw==", "url": "https://github.com/kiegroup/optaplanner/pull/943#discussion_r494167017", "bodyText": "This doesn't seem right? Less generics?", "author": "ge0ffrey", "createdAt": "2020-09-24T09:22:01Z", "path": "optaplanner-core/src/main/java/org/optaplanner/core/impl/exhaustivesearch/decider/ExhaustiveSearchDecider.java", "diffHunk": "@@ -144,7 +144,7 @@ public void expandNode(ExhaustiveSearchStepScope<Solution_> stepScope) {\n     }\n \n     private void doMove(ExhaustiveSearchStepScope<Solution_> stepScope, ExhaustiveSearchNode moveNode) {\n-        InnerScoreDirector<Solution_> scoreDirector = stepScope.getScoreDirector();\n+        InnerScoreDirector scoreDirector = stepScope.getScoreDirector();", "originalCommit": "acd2c88e59cd614ccfada981d81b19648f9f193c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDE2NzI5MA==", "url": "https://github.com/kiegroup/optaplanner/pull/943#discussion_r494167290", "bodyText": "Less generics?", "author": "ge0ffrey", "createdAt": "2020-09-24T09:22:26Z", "path": "optaplanner-core/src/main/java/org/optaplanner/core/impl/heuristic/thread/MoveThreadRunner.java", "diffHunk": "@@ -46,7 +46,7 @@\n     private final boolean assertExpectedStepScore;\n     private final boolean assertShadowVariablesAreNotStaleAfterStep;\n \n-    private InnerScoreDirector<Solution_> scoreDirector = null;\n+    private InnerScoreDirector scoreDirector = null;", "originalCommit": "acd2c88e59cd614ccfada981d81b19648f9f193c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDE2NzQ5OQ==", "url": "https://github.com/kiegroup/optaplanner/pull/943#discussion_r494167499", "bodyText": "Less?", "author": "ge0ffrey", "createdAt": "2020-09-24T09:22:46Z", "path": "optaplanner-core/src/main/java/org/optaplanner/core/impl/localsearch/decider/LocalSearchDecider.java", "diffHunk": "@@ -128,9 +129,9 @@ public void decideNextStep(LocalSearchStepScope<Solution_> stepScope) {\n     }\n \n     protected void doMove(LocalSearchMoveScope<Solution_> moveScope) {\n-        InnerScoreDirector<Solution_> scoreDirector = moveScope.getScoreDirector();\n+        InnerScoreDirector scoreDirector = moveScope.getScoreDirector();", "originalCommit": "acd2c88e59cd614ccfada981d81b19648f9f193c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDE2NzY2OA==", "url": "https://github.com/kiegroup/optaplanner/pull/943#discussion_r494167668", "bodyText": "Less", "author": "ge0ffrey", "createdAt": "2020-09-24T09:23:03Z", "path": "optaplanner-core/src/main/java/org/optaplanner/core/impl/phase/scope/AbstractMoveScope.java", "diffHunk": "@@ -64,7 +64,7 @@ public int getStepIndex() {\n         return getStepScope().getStepIndex();\n     }\n \n-    public InnerScoreDirector<Solution_> getScoreDirector() {\n+    public InnerScoreDirector getScoreDirector() {", "originalCommit": "acd2c88e59cd614ccfada981d81b19648f9f193c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDE2Nzc3Ng==", "url": "https://github.com/kiegroup/optaplanner/pull/943#discussion_r494167776", "bodyText": "Less?", "author": "ge0ffrey", "createdAt": "2020-09-24T09:23:16Z", "path": "optaplanner-core/src/main/java/org/optaplanner/core/impl/phase/scope/AbstractPhaseScope.java", "diffHunk": "@@ -138,7 +138,7 @@ public long getPhaseScoreCalculationSpeed() {\n         return getPhaseScoreCalculationCount() * 1000L / (timeMillisSpent == 0L ? 1L : timeMillisSpent);\n     }\n \n-    public InnerScoreDirector<Solution_> getScoreDirector() {\n+    public InnerScoreDirector getScoreDirector() {", "originalCommit": "acd2c88e59cd614ccfada981d81b19648f9f193c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDE2ODA0Ng==", "url": "https://github.com/kiegroup/optaplanner/pull/943#discussion_r494168046", "bodyText": "Less?", "author": "ge0ffrey", "createdAt": "2020-09-24T09:23:43Z", "path": "optaplanner-core/src/main/java/org/optaplanner/core/impl/phase/scope/AbstractStepScope.java", "diffHunk": "@@ -72,7 +72,7 @@ public void setClonedSolution(Solution_ clonedSolution) {\n     // Calculated methods\n     // ************************************************************************\n \n-    public InnerScoreDirector<Solution_> getScoreDirector() {\n+    public InnerScoreDirector getScoreDirector() {", "originalCommit": "acd2c88e59cd614ccfada981d81b19648f9f193c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDE2OTQyNQ==", "url": "https://github.com/kiegroup/optaplanner/pull/943#discussion_r494169425", "bodyText": "As Score_ is a generic type, this should use Score_ instead of ?", "author": "ge0ffrey", "createdAt": "2020-09-24T09:25:49Z", "path": "optaplanner-core/src/main/java/org/optaplanner/core/impl/score/director/drools/DroolsScoreDirectorFactory.java", "diffHunk": "@@ -39,14 +39,16 @@\n  * Drools implementation of {@link ScoreDirectorFactory}.\n  *\n  * @param <Solution_> the solution type, the class with the {@link PlanningSolution} annotation\n+ * @param <Score_> the score type to go with the solution\n  * @see DroolsScoreDirector\n  * @see ScoreDirectorFactory\n  */\n-public class DroolsScoreDirectorFactory<Solution_> extends AbstractScoreDirectorFactory<Solution_> {\n+public class DroolsScoreDirectorFactory<Solution_, Score_ extends Score<Score_>>\n+        extends AbstractScoreDirectorFactory<Solution_, Score_> {\n \n     private final KieBase kieBase;\n \n-    protected Map<Rule, Function<Solution_, Score<?>>> ruleToConstraintWeightExtractorMap;\n+    protected Map<Rule, Function<Solution_, ?>> ruleToConstraintWeightExtractorMap;", "originalCommit": "acd2c88e59cd614ccfada981d81b19648f9f193c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDE2OTczMg==", "url": "https://github.com/kiegroup/optaplanner/pull/943#discussion_r494169732", "bodyText": "the cast shouldn't be needed, see if the map field uses Score_", "author": "ge0ffrey", "createdAt": "2020-09-24T09:26:16Z", "path": "optaplanner-core/src/main/java/org/optaplanner/core/impl/score/director/drools/DroolsScoreDirectorFactory.java", "diffHunk": "@@ -117,16 +119,16 @@ protected void createRuleToConstraintWeightExtractorMap(KieBase kieBase) {\n         }\n     }\n \n-    public Map<Rule, Function<Solution_, Score<?>>> getRuleToConstraintWeightExtractorMap() {\n-        return ruleToConstraintWeightExtractorMap;\n+    public Map<Rule, Function<Solution_, Score_>> getRuleToConstraintWeightExtractorMap() {\n+        return (Map) ruleToConstraintWeightExtractorMap;", "originalCommit": "acd2c88e59cd614ccfada981d81b19648f9f193c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDE3MDg3OA==", "url": "https://github.com/kiegroup/optaplanner/pull/943#discussion_r494170878", "bodyText": "Hold on. This is a significant change.\nI think the impact on EasyScoreCalculator and IncrementScoreCalculator should indeed be in sync, but I 'd rather decide on that separately from accepting the generic InnerScoreDirector.", "author": "ge0ffrey", "createdAt": "2020-09-24T09:28:12Z", "path": "optaplanner-core/src/main/java/org/optaplanner/core/impl/score/director/easy/EasyScoreCalculator.java", "diffHunk": "@@ -26,9 +26,10 @@\n  * An implementation must be stateless.\n  *\n  * @param <Solution_> the solution type, the class with the {@link PlanningSolution} annotation\n+ * @param <Score_> the score type to go with the solution\n  * @see EasyScoreDirector\n  */\n-public interface EasyScoreCalculator<Solution_> {\n+public interface EasyScoreCalculator<Solution_, Score_ extends Score<Score_>> {", "originalCommit": "acd2c88e59cd614ccfada981d81b19648f9f193c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDE3MTM2MA==", "url": "https://github.com/kiegroup/optaplanner/pull/943#discussion_r494171360", "bodyText": "+1 to remove this, but will need an upgradeREcipe line and a a deprecation in 7.x - just like Radovan did for the AbstractCustomerPhaseCommand", "author": "ge0ffrey", "createdAt": "2020-09-24T09:29:04Z", "path": "optaplanner-core/src/main/java/org/optaplanner/core/impl/score/director/incremental/AbstractIncrementalScoreCalculator.java", "diffHunk": "@@ -1,29 +0,0 @@\n-/*\n- * Copyright 2012 Red Hat, Inc. and/or its affiliates.\n- *\n- * Licensed under the Apache License, Version 2.0 (the \"License\");\n- * you may not use this file except in compliance with the License.\n- * You may obtain a copy of the License at\n- *\n- *      http://www.apache.org/licenses/LICENSE-2.0\n- *\n- * Unless required by applicable law or agreed to in writing, software\n- * distributed under the License is distributed on an \"AS IS\" BASIS,\n- * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n- * See the License for the specific language governing permissions and\n- * limitations under the License.\n- */\n-\n-package org.optaplanner.core.impl.score.director.incremental;\n-\n-import org.optaplanner.core.api.domain.solution.PlanningSolution;\n-\n-/**\n- * Abstract superclass for {@link IncrementalScoreCalculator}.\n- *\n- * @param <Solution_> the solution type, the class with the {@link PlanningSolution} annotation\n- * @see IncrementalScoreCalculator\n- */\n-public abstract class AbstractIncrementalScoreCalculator<Solution_> implements IncrementalScoreCalculator<Solution_> {", "originalCommit": "acd2c88e59cd614ccfada981d81b19648f9f193c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "ece700b9deb7b28f27528a47d26c7cfe32306876", "url": "https://github.com/kiegroup/optaplanner/commit/ece700b9deb7b28f27528a47d26c7cfe32306876", "message": "One less raw type", "committedDate": "2020-09-24T09:40:00Z", "type": "commit"}, {"oid": "16da5af93e87642a41c1f480ef125d617ea29df7", "url": "https://github.com/kiegroup/optaplanner/commit/16da5af93e87642a41c1f480ef125d617ea29df7", "message": "Address some code review comments", "committedDate": "2020-09-24T09:51:20Z", "type": "commit"}, {"oid": "b458a7e15b238f77f09c3cacb34b50a8377aa0a5", "url": "https://github.com/kiegroup/optaplanner/commit/b458a7e15b238f77f09c3cacb34b50a8377aa0a5", "message": "More code review comments", "committedDate": "2020-09-24T09:58:06Z", "type": "commit"}, {"oid": "ce4c4a769d1e0c8a88ecf34e2407f2eade7a759c", "url": "https://github.com/kiegroup/optaplanner/commit/ce4c4a769d1e0c8a88ecf34e2407f2eade7a759c", "message": "Even more generics", "committedDate": "2020-09-24T10:09:42Z", "type": "commit"}, {"oid": "18a3334131b71d93de3d0a6f5e4ff8fb0ed0bca4", "url": "https://github.com/kiegroup/optaplanner/commit/18a3334131b71d93de3d0a6f5e4ff8fb0ed0bca4", "message": "Remove misleading Javadoc", "committedDate": "2020-09-24T10:18:08Z", "type": "commit"}, {"oid": "c3cf1c58f2d0438cced1a6faae42a870ad9f01a2", "url": "https://github.com/kiegroup/optaplanner/commit/c3cf1c58f2d0438cced1a6faae42a870ad9f01a2", "message": "Final generification", "committedDate": "2020-09-24T13:41:46Z", "type": "commit"}, {"oid": "83e7f30c26d71d29892448c06c4cd8354d70ae40", "url": "https://github.com/kiegroup/optaplanner/commit/83e7f30c26d71d29892448c06c4cd8354d70ae40", "message": "Remove another Javadoc that won't be in the public API", "committedDate": "2020-09-24T14:06:29Z", "type": "commit"}]}