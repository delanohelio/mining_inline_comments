{"pr_number": 1058, "pr_title": "PLANNER-2269: Make CS-B Tuple a plain data carrier", "pr_createdAt": "2020-12-02T15:29:51Z", "pr_url": "https://github.com/kiegroup/optaplanner/pull/1058", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDI2MzQ2OQ==", "url": "https://github.com/kiegroup/optaplanner/pull/1058#discussion_r534263469", "bodyText": "This is not actually in use yet. The change to completely remove Node reference from Tuple seemed too invasive for this PR.", "author": "triceo", "createdAt": "2020-12-02T15:36:25Z", "path": "optaplanner-core/src/main/java/org/optaplanner/core/impl/score/stream/bavet/BavetConstraintSession.java", "diffHunk": "@@ -48,34 +56,80 @@\n     private final ScoreInliner<Score_> scoreInliner;\n \n     private final Map<Class<?>, BavetFromUniNode<Object>> declaredClassToNodeMap;\n-    private final int nodeOrderSize;\n+    private final int nodeIndexSize;\n     private final Map<String, BavetScoringNode> constraintIdToScoringNodeMap;\n \n     private final Map<Class<?>, List<BavetFromUniNode<Object>>> effectiveClassToNodeListMap;\n \n-    private final List<Queue<BavetAbstractTuple>> nodeOrderedQueueList;\n+    private final List<BavetAbstractNode> nodeIndexToNodeMap;\n+    private final List<Queue<BavetAbstractTuple>> nodeIndexToDirtyTupleQueueMap;\n     private final Map<Object, List<BavetFromUniTuple<Object>>> fromTupleListMap;\n \n     public BavetConstraintSession(boolean constraintMatchEnabled, ScoreDefinition<Score_> scoreDefinition,\n             Map<BavetConstraint<Solution_>, Score_> constraintToWeightMap) {\n         this.constraintMatchEnabled = constraintMatchEnabled;\n-        this.zeroScore = scoreDefinition.getZeroScore();\n-        this.scoreInliner = scoreDefinition.buildScoreInliner(constraintMatchEnabled);\n+        zeroScore = scoreDefinition.getZeroScore();\n+        scoreInliner = scoreDefinition.buildScoreInliner(constraintMatchEnabled);\n         declaredClassToNodeMap = new HashMap<>(50);\n         BavetNodeBuildPolicy<Solution_> buildPolicy = new BavetNodeBuildPolicy<>(this, constraintToWeightMap.size());\n         constraintToWeightMap.forEach((constraint, constraintWeight) -> {\n             constraint.createNodes(buildPolicy, declaredClassToNodeMap, constraintWeight);\n         });\n-        this.nodeOrderSize = buildPolicy.getNodeOrderMaximum() + 1;\n+        nodeIndexSize = buildPolicy.getNodeIndexMaximum() + 1;\n         constraintIdToScoringNodeMap = buildPolicy.getConstraintIdToScoringNodeMap();\n         effectiveClassToNodeListMap = new HashMap<>(declaredClassToNodeMap.size());\n-        nodeOrderedQueueList = new ArrayList<>(nodeOrderSize);\n-        for (int i = 0; i < nodeOrderSize; i++) {\n-            nodeOrderedQueueList.add(new ArrayDeque<>(1000));\n+        nodeIndexToNodeMap = new ArrayList<>(this.nodeIndexSize);", "originalCommit": "4a2e3fea9fecf2d18f8cf1d3fb48487476d6dbf3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDg2MzE3Mw==", "url": "https://github.com/kiegroup/optaplanner/pull/1058#discussion_r534863173", "bodyText": "Yes, thank you", "author": "ge0ffrey", "createdAt": "2020-12-03T08:02:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDI2MzQ2OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDI2NDAzMw==", "url": "https://github.com/kiegroup/optaplanner/pull/1058#discussion_r534264033", "bodyText": "Why is NEW not dirty?", "author": "triceo", "createdAt": "2020-12-02T15:36:59Z", "path": "optaplanner-core/src/main/java/org/optaplanner/core/impl/score/stream/bavet/common/BavetTupleState.java", "diffHunk": "@@ -17,20 +17,37 @@\n package org.optaplanner.core.impl.score.stream.bavet.common;\n \n public enum BavetTupleState {\n-    NEW,\n-    CREATING,\n-    UPDATING,\n-    OK,\n-    DYING,\n-    DEAD,\n-    ABORTING;\n+    NEW(false, true),", "originalCommit": "4a2e3fea9fecf2d18f8cf1d3fb48487476d6dbf3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDg2MjI2MQ==", "url": "https://github.com/kiegroup/optaplanner/pull/1058#discussion_r534862261", "bodyText": "I guess this can be nodeSize? (the number of nodes)", "author": "ge0ffrey", "createdAt": "2020-12-03T08:01:30Z", "path": "optaplanner-core/src/main/java/org/optaplanner/core/impl/score/stream/bavet/BavetConstraintSession.java", "diffHunk": "@@ -48,34 +56,80 @@\n     private final ScoreInliner<Score_> scoreInliner;\n \n     private final Map<Class<?>, BavetFromUniNode<Object>> declaredClassToNodeMap;\n-    private final int nodeOrderSize;\n+    private final int nodeIndexSize;", "originalCommit": "4a2e3fea9fecf2d18f8cf1d3fb48487476d6dbf3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "c7db0d66348af735b744809ede7940554796c2c0", "url": "https://github.com/kiegroup/optaplanner/commit/c7db0d66348af735b744809ede7940554796c2c0", "message": "Resolve problems after rebase", "committedDate": "2020-12-07T14:12:55Z", "type": "forcePushed"}, {"oid": "ce526deae716eb41e00647e98595941413781fb4", "url": "https://github.com/kiegroup/optaplanner/commit/ce526deae716eb41e00647e98595941413781fb4", "message": "Node order becomes node index", "committedDate": "2020-12-09T15:16:36Z", "type": "commit"}, {"oid": "392cbd4a418e8b011634f6ec6707326d8db73bb6", "url": "https://github.com/kiegroup/optaplanner/commit/392cbd4a418e8b011634f6ec6707326d8db73bb6", "message": "nodeIndexToDirtyTupleQueueMap", "committedDate": "2020-12-09T15:16:36Z", "type": "commit"}, {"oid": "ae730912f5c190e992ce6249d77b20b2075c7d54", "url": "https://github.com/kiegroup/optaplanner/commit/ae730912f5c190e992ce6249d77b20b2075c7d54", "message": "Refresh tuples externally", "committedDate": "2020-12-09T15:16:36Z", "type": "commit"}, {"oid": "2438cd8debb5de611060acf3aee4af0ce8e7c99b", "url": "https://github.com/kiegroup/optaplanner/commit/2438cd8debb5de611060acf3aee4af0ce8e7c99b", "message": "nodeIndexToNodeMap", "committedDate": "2020-12-09T15:16:37Z", "type": "commit"}, {"oid": "c791d2ccd95e874b05f6f614592cdffeec8af871", "url": "https://github.com/kiegroup/optaplanner/commit/c791d2ccd95e874b05f6f614592cdffeec8af871", "message": "Child tuples become the property of the tuple", "committedDate": "2020-12-09T15:16:37Z", "type": "commit"}, {"oid": "b01db5381a94ed0a4c8125dc556c775dbaa6233a", "url": "https://github.com/kiegroup/optaplanner/commit/b01db5381a94ed0a4c8125dc556c775dbaa6233a", "message": "BavetAbstractNode now has a refresh() method", "committedDate": "2020-12-09T15:16:38Z", "type": "commit"}, {"oid": "314a6560fd643f2af8063b35c700549ab69dacb0", "url": "https://github.com/kiegroup/optaplanner/commit/314a6560fd643f2af8063b35c700549ab69dacb0", "message": "Finally externalize tuple refresh", "committedDate": "2020-12-09T15:16:39Z", "type": "commit"}, {"oid": "1c1c04178c9c3e45d81d1304ed0a23baef35ec0c", "url": "https://github.com/kiegroup/optaplanner/commit/1c1c04178c9c3e45d81d1304ed0a23baef35ec0c", "message": "Optimize tuple state", "committedDate": "2020-12-09T15:16:39Z", "type": "commit"}, {"oid": "7d11bdd131cd7a3e9216d0669d271db3978703aa", "url": "https://github.com/kiegroup/optaplanner/commit/7d11bdd131cd7a3e9216d0669d271db3978703aa", "message": "Resolve problems after rebase", "committedDate": "2020-12-09T15:16:40Z", "type": "commit"}, {"oid": "7d11bdd131cd7a3e9216d0669d271db3978703aa", "url": "https://github.com/kiegroup/optaplanner/commit/7d11bdd131cd7a3e9216d0669d271db3978703aa", "message": "Resolve problems after rebase", "committedDate": "2020-12-09T15:16:40Z", "type": "forcePushed"}, {"oid": "8f0e8061a1d8dcd2a9437e2b251a99e5a95ca7bd", "url": "https://github.com/kiegroup/optaplanner/commit/8f0e8061a1d8dcd2a9437e2b251a99e5a95ca7bd", "message": "BavetNode need not be Comparable", "committedDate": "2020-12-09T15:20:24Z", "type": "commit"}, {"oid": "c62e4174f7d9b3a8b232583a0163d6a543922363", "url": "https://github.com/kiegroup/optaplanner/commit/c62e4174f7d9b3a8b232583a0163d6a543922363", "message": "Revert sizing change", "committedDate": "2020-12-09T21:09:02Z", "type": "commit"}, {"oid": "5a550fe1daf07046019d7377bebc4aa63662ba0c", "url": "https://github.com/kiegroup/optaplanner/commit/5a550fe1daf07046019d7377bebc4aa63662ba0c", "message": "List iteration is much faster", "committedDate": "2020-12-09T21:17:25Z", "type": "commit"}, {"oid": "651a3c2c03a1218f2cd4138edcccd363e9bb0f2d", "url": "https://github.com/kiegroup/optaplanner/commit/651a3c2c03a1218f2cd4138edcccd363e9bb0f2d", "message": "Fix formatting", "committedDate": "2020-12-09T21:18:34Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDE0NjAzNw==", "url": "https://github.com/kiegroup/optaplanner/pull/1058#discussion_r540146037", "bodyText": "Why doesn't getNode() return type BavetAbstractNode?", "author": "ge0ffrey", "createdAt": "2020-12-10T12:55:11Z", "path": "optaplanner-core/src/main/java/org/optaplanner/core/impl/score/stream/bavet/BavetConstraintSession.java", "diffHunk": "@@ -88,6 +89,23 @@ public BavetConstraintSession(boolean constraintMatchEnabled, ScoreDefinition<Sc\n         return nodeIndexedNodeMap;\n     }\n \n+    private static void refreshTuple(BavetAbstractTuple tuple) {\n+        ((BavetAbstractNode) tuple.getNode()).refresh(tuple);", "originalCommit": "651a3c2c03a1218f2cd4138edcccd363e9bb0f2d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDE0NjM4NA==", "url": "https://github.com/kiegroup/optaplanner/pull/1058#discussion_r540146384", "bodyText": "Let's a default case that throws an exception?", "author": "ge0ffrey", "createdAt": "2020-12-10T12:55:45Z", "path": "optaplanner-core/src/main/java/org/optaplanner/core/impl/score/stream/bavet/BavetConstraintSession.java", "diffHunk": "@@ -88,6 +89,23 @@ public BavetConstraintSession(boolean constraintMatchEnabled, ScoreDefinition<Sc\n         return nodeIndexedNodeMap;\n     }\n \n+    private static void refreshTuple(BavetAbstractTuple tuple) {\n+        ((BavetAbstractNode) tuple.getNode()).refresh(tuple);\n+        switch (tuple.getState()) {\n+            case CREATING:\n+            case UPDATING:\n+                tuple.setState(BavetTupleState.OK);\n+                return;\n+            case DYING:\n+            case ABORTING:\n+                tuple.setState(BavetTupleState.DEAD);\n+                return;\n+            case DEAD:\n+                throw new IllegalStateException(\n+                        \"The tuple (\" + tuple + \") is already in the dead state (\" + tuple.getState() + \").\");", "originalCommit": "651a3c2c03a1218f2cd4138edcccd363e9bb0f2d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDE0NjgzMg==", "url": "https://github.com/kiegroup/optaplanner/pull/1058#discussion_r540146832", "bodyText": "Also, this exception can start with \"Impossible state:\"\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                    \"The tuple (\" + tuple + \") is already in the dead state (\" + tuple.getState() + \").\");\n          \n          \n            \n                                    \"Impossible state: the tuple (\" + tuple + \") is already in the dead state (\" + tuple.getState() + \").\");", "author": "ge0ffrey", "createdAt": "2020-12-10T12:56:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDE0NjM4NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDE0NzczNQ==", "url": "https://github.com/kiegroup/optaplanner/pull/1058#discussion_r540147735", "bodyText": "Do we also want to print out the node toString in the exception message? Might be useful if someone ever sees it on production and asks us what could be the cause.\nOr even print out BavetNode.getDownstreamConstraintsString(), to know the constraint(s) that are involved", "author": "ge0ffrey", "createdAt": "2020-12-10T12:57:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDE0NjM4NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDE0OTM0Mg==", "url": "https://github.com/kiegroup/optaplanner/pull/1058#discussion_r540149342", "bodyText": "(important IMO)\nThe entire Bavet implementation is not public API. We don't need to wrap in unmodifiableList() etc, as that will only create perf loss and memory usage increase.", "author": "ge0ffrey", "createdAt": "2020-12-10T13:00:19Z", "path": "optaplanner-core/src/main/java/org/optaplanner/core/impl/score/stream/bavet/bi/BavetFilterBiNode.java", "diffHunk": "@@ -43,6 +45,11 @@ public void addChildNode(BavetAbstractBiNode<A, B> childNode) {\n         childNodeList.add(childNode);\n     }\n \n+    @Override\n+    public List<BavetAbstractBiNode<A, B>> getChildNodes() {\n+        return Collections.unmodifiableList(childNodeList);", "originalCommit": "651a3c2c03a1218f2cd4138edcccd363e9bb0f2d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDE1MDk4Ng==", "url": "https://github.com/kiegroup/optaplanner/pull/1058#discussion_r540150986", "bodyText": "For consistency sake, please call this method getChildNodeList().\nThe color of the curtains is pink, I know you hate it, but let's not mix colors of curtains - it's going to look ugly.", "author": "ge0ffrey", "createdAt": "2020-12-10T13:02:42Z", "path": "optaplanner-core/src/main/java/org/optaplanner/core/impl/score/stream/bavet/bi/BavetGroupBiNode.java", "diffHunk": "@@ -40,6 +42,11 @@ public void addChildNode(BavetAbstractBiNode<GroupKey_, Result_> childNode) {\n         childNodeList.add(childNode);\n     }\n \n+    @Override\n+    public List<BavetAbstractBiNode<GroupKey_, Result_>> getChildNodes() {", "originalCommit": "651a3c2c03a1218f2cd4138edcccd363e9bb0f2d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDE1MTEwOQ==", "url": "https://github.com/kiegroup/optaplanner/pull/1058#discussion_r540151109", "bodyText": "see above, no need for unmodifiableList", "author": "ge0ffrey", "createdAt": "2020-12-10T13:02:54Z", "path": "optaplanner-core/src/main/java/org/optaplanner/core/impl/score/stream/bavet/bi/BavetGroupBiNode.java", "diffHunk": "@@ -40,6 +42,11 @@ public void addChildNode(BavetAbstractBiNode<GroupKey_, Result_> childNode) {\n         childNodeList.add(childNode);\n     }\n \n+    @Override\n+    public List<BavetAbstractBiNode<GroupKey_, Result_>> getChildNodes() {\n+        return Collections.unmodifiableList(childNodeList);", "originalCommit": "651a3c2c03a1218f2cd4138edcccd363e9bb0f2d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDE1MjI0OQ==", "url": "https://github.com/kiegroup/optaplanner/pull/1058#discussion_r540152249", "bodyText": "This is intresting. The Set becomes a List (which is a good thing I think.)\nDid this bring a performance gain? If not, is it possible it was offset by the unmodifiable wrapping?\nProbably not, but OTH measuring is knowing... (and more work, yes ...) Wdyt?", "author": "ge0ffrey", "createdAt": "2020-12-10T13:04:53Z", "path": "optaplanner-core/src/main/java/org/optaplanner/core/impl/score/stream/bavet/bi/BavetJoinBridgeBiTuple.java", "diffHunk": "@@ -16,19 +16,14 @@\n \n package org.optaplanner.core.impl.score.stream.bavet.bi;\n \n-import java.util.LinkedHashSet;\n-import java.util.Set;\n-\n import org.optaplanner.core.impl.score.stream.bavet.common.BavetJoinBridgeTuple;\n-import org.optaplanner.core.impl.score.stream.bavet.common.BavetJoinTuple;\n \n public final class BavetJoinBridgeBiTuple<A, B> extends BavetAbstractBiTuple<A, B>\n         implements BavetJoinBridgeTuple {\n \n     protected final BavetAbstractBiTuple<A, B> parentTuple;\n     private final BavetJoinBridgeBiNode<A, B> node;\n \n-    protected Set<BavetJoinTuple> childTupleSet = new LinkedHashSet<>(); // TODO capacity", "originalCommit": "651a3c2c03a1218f2cd4138edcccd363e9bb0f2d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDI3MDk4Ng==", "url": "https://github.com/kiegroup/optaplanner/pull/1058#discussion_r540270986", "bodyText": "I'll re-benchmark once this is merged. But I don't really think this should result in such a big gain - it's just inside one particular tuple, not inside all of them.", "author": "triceo", "createdAt": "2020-12-10T15:39:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDE1MjI0OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDE1MzU4OQ==", "url": "https://github.com/kiegroup/optaplanner/pull/1058#discussion_r540153589", "bodyText": "see above: method name + unmodifiableList", "author": "ge0ffrey", "createdAt": "2020-12-10T13:07:03Z", "path": "optaplanner-core/src/main/java/org/optaplanner/core/impl/score/stream/bavet/tri/BavetJoinTriNode.java", "diffHunk": "@@ -49,6 +50,11 @@ public void addChildNode(BavetAbstractTriNode<A, B, C> childNode) {\n         childNodeList.add(childNode);\n     }\n \n+    @Override\n+    public List<BavetAbstractTriNode<A, B, C>> getChildNodes() {\n+        return Collections.unmodifiableList(childNodeList);", "originalCommit": "651a3c2c03a1218f2cd4138edcccd363e9bb0f2d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "e68114c9561a0d986bf0ef43751b0cf8c2a74271", "url": "https://github.com/kiegroup/optaplanner/commit/e68114c9561a0d986bf0ef43751b0cf8c2a74271", "message": "BavetAbstractTuple should return BavetAbstractNode", "committedDate": "2020-12-10T15:08:28Z", "type": "commit"}, {"oid": "2d27281d315d8dace7701d32b98d2eb8af6ee467", "url": "https://github.com/kiegroup/optaplanner/commit/2d27281d315d8dace7701d32b98d2eb8af6ee467", "message": "Child node lists", "committedDate": "2020-12-10T15:10:44Z", "type": "commit"}, {"oid": "b009f8f14a4279c74bacc4c26dac050f8eca27f6", "url": "https://github.com/kiegroup/optaplanner/commit/b009f8f14a4279c74bacc4c26dac050f8eca27f6", "message": "Formatting", "committedDate": "2020-12-10T15:31:50Z", "type": "commit"}, {"oid": "5b6fd5acbf7a6c6a6578f066e27f99d572a1f6ea", "url": "https://github.com/kiegroup/optaplanner/commit/5b6fd5acbf7a6c6a6578f066e27f99d572a1f6ea", "message": "Child node list again", "committedDate": "2020-12-10T15:37:52Z", "type": "commit"}]}