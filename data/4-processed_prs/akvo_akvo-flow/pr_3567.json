{"pr_number": 3567, "pr_title": "Fix webform validation conditions and refactor logic application contexts", "pr_createdAt": "2020-05-21T16:30:42Z", "pr_url": "https://github.com/akvo/akvo-flow/pull/3567", "timeline": [{"oid": "318597e1d14687178fdad4ea2d27f2b10a652e40", "url": "https://github.com/akvo/akvo-flow/commit/318597e1d14687178fdad4ea2d27f2b10a652e40", "message": "[#3562] Fix webform constraints\n\nAllow cascade types and don't allow monitoring surveys nor repeatable\nquestion groups", "committedDate": "2020-05-21T13:17:35Z", "type": "commit"}, {"oid": "60a2e81242230632671f8b47eb54eefec6a563d8", "url": "https://github.com/akvo/akvo-flow/commit/60a2e81242230632671f8b47eb54eefec6a563d8", "message": "[#3562] Move webform validation to publishing survey place\n\nInstead of having validation every time a question is changed or a\nquestionGroup is changed or a form is changed", "committedDate": "2020-05-21T16:05:57Z", "type": "commit"}, {"oid": "ed0ffc57cc551342a4c675aed85883bce9082ba3", "url": "https://github.com/akvo/akvo-flow/commit/ed0ffc57cc551342a4c675aed85883bce9082ba3", "message": "[#3526] Update webform only if enabled on publishing action", "committedDate": "2020-05-21T17:28:55Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODg1NDQ1Mw==", "url": "https://github.com/akvo/akvo-flow/pull/3567#discussion_r428854453", "bodyText": "Why do we need an explicit boolean primitive? .... using i.getRepeatable() does the trick", "author": "iperdomo", "createdAt": "2020-05-21T19:05:48Z", "path": "GAE/src/com/gallatinsystems/survey/domain/WebForm.java", "diffHunk": "@@ -25,17 +25,26 @@\n \n     public static Set<String> unsupportedQuestionTypes(){\n         Set<String> unsupportedTypes = new HashSet<String>();\n-        unsupportedTypes.add(Question.Type.CASCADE.toString());\n         unsupportedTypes.add(Question.Type.GEOSHAPE.toString());\n         unsupportedTypes.add(Question.Type.SIGNATURE.toString());\n         unsupportedTypes.add(Question.Type.CADDISFLY.toString());\n         return unsupportedTypes;\n     }\n \n-    public static boolean validWebForm(final List<Question> questions){\n-        \n-        List<Question> validQuestions = questions.stream().filter(i -> !unsupportedQuestionTypes().contains(i.getType().toString())).collect(Collectors.toList());\n+    public static boolean validQuestionGroups(final Survey survey){\n+        return survey.getQuestionGroupMap().values().stream().filter(i -> i.getRepeatable().booleanValue()).collect(Collectors.toList()).size() == 0;", "originalCommit": "ed0ffc57cc551342a4c675aed85883bce9082ba3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODg1NDY0OA==", "url": "https://github.com/akvo/akvo-flow/pull/3567#discussion_r428854648", "bodyText": "Idem, that extra .booleanValue() is not required, I think", "author": "iperdomo", "createdAt": "2020-05-21T19:06:13Z", "path": "GAE/src/com/gallatinsystems/survey/domain/WebForm.java", "diffHunk": "@@ -25,17 +25,26 @@\n \n     public static Set<String> unsupportedQuestionTypes(){\n         Set<String> unsupportedTypes = new HashSet<String>();\n-        unsupportedTypes.add(Question.Type.CASCADE.toString());\n         unsupportedTypes.add(Question.Type.GEOSHAPE.toString());\n         unsupportedTypes.add(Question.Type.SIGNATURE.toString());\n         unsupportedTypes.add(Question.Type.CADDISFLY.toString());\n         return unsupportedTypes;\n     }\n \n-    public static boolean validWebForm(final List<Question> questions){\n-        \n-        List<Question> validQuestions = questions.stream().filter(i -> !unsupportedQuestionTypes().contains(i.getType().toString())).collect(Collectors.toList());\n+    public static boolean validQuestionGroups(final Survey survey){\n+        return survey.getQuestionGroupMap().values().stream().filter(i -> i.getRepeatable().booleanValue()).collect(Collectors.toList()).size() == 0;\n+    }\n \n+    public static boolean validSurveyGroup(final SurveyGroup surveyGroup){\n+        return !surveyGroup.getMonitoringGroup().booleanValue();", "originalCommit": "ed0ffc57cc551342a4c675aed85883bce9082ba3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "4d34af2beea879c0d6cb592a0b9d79980b9d0a11", "url": "https://github.com/akvo/akvo-flow/commit/4d34af2beea879c0d6cb592a0b9d79980b9d0a11", "message": "[#3526] Use Boolean instead of boolean", "committedDate": "2020-05-22T07:48:54Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTEwOTY2Ng==", "url": "https://github.com/akvo/akvo-flow/pull/3567#discussion_r429109666", "bodyText": "So this one is a bit more subtle. It should be that webforms doesn't support monitoring forms. I.e. in a survey you have registration form and monitoring forms.  We should allow a registration form to be filled in.  Registration form id is === SurveyGroup.newLocaleSurveyId @marvinkome I guess this is already done on UI side?", "author": "muloem", "createdAt": "2020-05-22T08:20:46Z", "path": "GAE/src/com/gallatinsystems/survey/domain/WebForm.java", "diffHunk": "@@ -25,17 +25,26 @@\n \n     public static Set<String> unsupportedQuestionTypes(){\n         Set<String> unsupportedTypes = new HashSet<String>();\n-        unsupportedTypes.add(Question.Type.CASCADE.toString());\n         unsupportedTypes.add(Question.Type.GEOSHAPE.toString());\n         unsupportedTypes.add(Question.Type.SIGNATURE.toString());\n         unsupportedTypes.add(Question.Type.CADDISFLY.toString());\n         return unsupportedTypes;\n     }\n \n-    public static boolean validWebForm(final List<Question> questions){\n-        \n-        List<Question> validQuestions = questions.stream().filter(i -> !unsupportedQuestionTypes().contains(i.getType().toString())).collect(Collectors.toList());\n+    public static boolean validQuestionGroups(final Survey survey){\n+        return survey.getQuestionGroupMap().values().stream().filter(i -> i.getRepeatable()).collect(Collectors.toList()).size() == 0;\n+    }\n \n+    public static Boolean validSurveyGroup(final SurveyGroup surveyGroup){", "originalCommit": "4d34af2beea879c0d6cb592a0b9d79980b9d0a11", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTExMzYzNg==", "url": "https://github.com/akvo/akvo-flow/pull/3567#discussion_r429113636", "bodyText": "Yeah on the UI, monitoring surveys aren't supported", "author": "marvinkome", "createdAt": "2020-05-22T08:29:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTEwOTY2Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTExNDU4Mw==", "url": "https://github.com/akvo/akvo-flow/pull/3567#discussion_r429114583", "bodyText": "Monitoring surveys or monitoring forms?", "author": "muloem", "createdAt": "2020-05-22T08:30:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTEwOTY2Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTExNzU4OQ==", "url": "https://github.com/akvo/akvo-flow/pull/3567#discussion_r429117589", "bodyText": "\ud83d\udc40 monitoring survey groups", "author": "marvinkome", "createdAt": "2020-05-22T08:37:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTEwOTY2Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTExOTM2Ng==", "url": "https://github.com/akvo/akvo-flow/pull/3567#discussion_r429119366", "bodyText": "Should be the same... in a monitoring Survey(Group) you have two kinds of forms, registration and monitoring forms. Registration forms can be shared via webforms, monitoring forms cannot be shared. Registration form id is found by looking at the SurveyGroup.newLocaleSurveyId property", "author": "muloem", "createdAt": "2020-05-22T08:41:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTEwOTY2Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTE0MjU4OA==", "url": "https://github.com/akvo/akvo-flow/pull/3567#discussion_r429142588", "bodyText": "Let's always use { } in if conditions.", "author": "iperdomo", "createdAt": "2020-05-22T09:29:53Z", "path": "GAE/src/com/gallatinsystems/survey/domain/WebForm.java", "diffHunk": "@@ -25,17 +25,26 @@\n \n     public static Set<String> unsupportedQuestionTypes(){\n         Set<String> unsupportedTypes = new HashSet<String>();\n-        unsupportedTypes.add(Question.Type.CASCADE.toString());\n         unsupportedTypes.add(Question.Type.GEOSHAPE.toString());\n         unsupportedTypes.add(Question.Type.SIGNATURE.toString());\n         unsupportedTypes.add(Question.Type.CADDISFLY.toString());\n         return unsupportedTypes;\n     }\n \n-    public static boolean validWebForm(final List<Question> questions){\n-        \n-        List<Question> validQuestions = questions.stream().filter(i -> !unsupportedQuestionTypes().contains(i.getType().toString())).collect(Collectors.toList());\n+    public static boolean validQuestionGroups(final Survey survey){\n+        return survey.getQuestionGroupMap().values().stream().filter(i -> i.getRepeatable()).collect(Collectors.toList()).size() == 0;\n+    }\n \n+    public static Boolean validSurveyGroup(final SurveyGroup surveyGroup){\n+        return !surveyGroup.getMonitoringGroup();\n+    }\n+\n+    public static boolean validWebForm(final SurveyGroup surveyGroup, final Survey survey, final List<Question> questions){\n+        boolean validQuestionGroups = validQuestionGroups(survey);\n+        if (!validQuestionGroups) return false;", "originalCommit": "4d34af2beea879c0d6cb592a0b9d79980b9d0a11", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "29d10548622314c88794b2c0a8709ddba31d630e", "url": "https://github.com/akvo/akvo-flow/commit/29d10548622314c88794b2c0a8709ddba31d630e", "message": "[#3526] Adapt to PR review", "committedDate": "2020-05-22T09:32:09Z", "type": "commit"}, {"oid": "2cafdf33784247cb56131b389c4fee9e11d0a509", "url": "https://github.com/akvo/akvo-flow/commit/2cafdf33784247cb56131b389c4fee9e11d0a509", "message": "[#3562] Refactor", "committedDate": "2020-05-22T09:40:16Z", "type": "commit"}, {"oid": "2cafdf33784247cb56131b389c4fee9e11d0a509", "url": "https://github.com/akvo/akvo-flow/commit/2cafdf33784247cb56131b389c4fee9e11d0a509", "message": "[#3562] Refactor", "committedDate": "2020-05-22T09:40:16Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTE1MzQ3MQ==", "url": "https://github.com/akvo/akvo-flow/pull/3567#discussion_r429153471", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public static boolean validSurveyGroup(final Survey survey, final SurveyGroup surveyGroup) {\n          \n          \n            \n                public static boolean validForm(final Survey survey, final SurveyGroup surveyGroup) {", "author": "muloem", "createdAt": "2020-05-22T09:53:30Z", "path": "GAE/src/com/gallatinsystems/survey/domain/WebForm.java", "diffHunk": "@@ -23,19 +23,32 @@\n \n public class WebForm {\n \n-    public static Set<String> unsupportedQuestionTypes(){\n+    public static Set<String> unsupportedQuestionTypes() {\n         Set<String> unsupportedTypes = new HashSet<String>();\n-        unsupportedTypes.add(Question.Type.CASCADE.toString());\n         unsupportedTypes.add(Question.Type.GEOSHAPE.toString());\n         unsupportedTypes.add(Question.Type.SIGNATURE.toString());\n         unsupportedTypes.add(Question.Type.CADDISFLY.toString());\n         return unsupportedTypes;\n     }\n \n-    public static boolean validWebForm(final List<Question> questions){\n-        \n-        List<Question> validQuestions = questions.stream().filter(i -> !unsupportedQuestionTypes().contains(i.getType().toString())).collect(Collectors.toList());\n+    public static boolean validQuestionGroups(final Survey survey) {\n+        return survey.getQuestionGroupMap().values().stream().filter(i -> i.getRepeatable()).collect(Collectors.toList()).size() == 0;\n+    }\n \n+    public static boolean validSurveyGroup(final Survey survey, final SurveyGroup surveyGroup) {", "originalCommit": "2cafdf33784247cb56131b389c4fee9e11d0a509", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "ce7b6dd28a7a8781303777b9533e2b9c491512c5", "url": "https://github.com/akvo/akvo-flow/commit/ce7b6dd28a7a8781303777b9533e2b9c491512c5", "message": "Update GAE/src/com/gallatinsystems/survey/domain/WebForm.java\n\nCo-authored-by: Emmanuel Mulo <emmanuel@akvo.org>", "committedDate": "2020-05-22T10:27:54Z", "type": "commit"}, {"oid": "78f015b53941acf2db97edcdfa75c7ac578a2942", "url": "https://github.com/akvo/akvo-flow/commit/78f015b53941acf2db97edcdfa75c7ac578a2942", "message": "[#3562] Fix build", "committedDate": "2020-05-22T10:47:39Z", "type": "commit"}]}