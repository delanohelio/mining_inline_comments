{"pr_number": 3574, "pr_title": "Issue/3571 delivery metrics", "pr_createdAt": "2020-05-22T13:29:22Z", "pr_url": "https://github.com/akvo/akvo-flow/pull/3574", "timeline": [{"oid": "3755bda2f751d8d6b0d71528ddab738a70af2e79", "url": "https://github.com/akvo/akvo-flow/commit/3755bda2f751d8d6b0d71528ddab738a70af2e79", "message": "[#3571] Use \"flip-\" and \"promote-\" tags\n\nWe keep the same flow/logic as before but we are going to change the tag names to match their meaning with what we do in other projects.\n\n1. \"promote-\" tag will mean to deploy to dark production. It additionally will flip UAT1 to make it easy to access the new version, as right now to access a dark instance you need to guess a very big and per-version-specific url\n1. \"flip-\" tags will flip the traffic to the new version.\n\nMoving all the logic regarding which CI steps to run to Semaphore. The trade off is easier to understand what is CI running + no duplication vs no local testing + less portable scripts.", "committedDate": "2020-05-22T07:40:53Z", "type": "commit"}, {"oid": "763a4597a667ddc13a0b234ea68c4bac943cd2f2", "url": "https://github.com/akvo/akvo-flow/commit/763a4597a667ddc13a0b234ea68c4bac943cd2f2", "message": "[#3571] Temporarily comment out deploys to avoid havoc\n\nFor testing", "committedDate": "2020-05-22T08:14:01Z", "type": "commit"}, {"oid": "8f2d22eab078a301db73f8729d072c45076774fd", "url": "https://github.com/akvo/akvo-flow/commit/8f2d22eab078a301db73f8729d072c45076774fd", "message": "[#3571] Testing what happens if somebody click promote", "committedDate": "2020-05-22T08:40:33Z", "type": "commit"}, {"oid": "929a2a4e011d0d2c0f787338a70a5bad1f76d0af", "url": "https://github.com/akvo/akvo-flow/commit/929a2a4e011d0d2c0f787338a70a5bad1f76d0af", "message": "[#3571] Removing Travis file", "committedDate": "2020-05-22T08:42:15Z", "type": "commit"}, {"oid": "d4959b46afd2d3391468b76edc10b651ea3f6089", "url": "https://github.com/akvo/akvo-flow/commit/d4959b46afd2d3391468b76edc10b651ea3f6089", "message": "[#3571] Using git sha as version", "committedDate": "2020-05-22T10:51:32Z", "type": "commit"}, {"oid": "800e722ebbd34c8c749b677ceb20576e5383aaad", "url": "https://github.com/akvo/akvo-flow/commit/800e722ebbd34c8c749b677ceb20576e5383aaad", "message": "[#3571] Temporarily deploy this branch to dev2", "committedDate": "2020-05-22T10:53:20Z", "type": "commit"}, {"oid": "0e06dd5c324af4f0ef6740c0b4b76016445d20ca", "url": "https://github.com/akvo/akvo-flow/commit/0e06dd5c324af4f0ef6740c0b4b76016445d20ca", "message": "[#3571] Commenting out commands properly", "committedDate": "2020-05-22T11:00:17Z", "type": "commit"}, {"oid": "587fe186ffaa12516c6b9986e3e5390df2202230", "url": "https://github.com/akvo/akvo-flow/commit/587fe186ffaa12516c6b9986e3e5390df2202230", "message": "[#3571] Temporarily deploy promotions to dev1", "committedDate": "2020-05-22T11:12:38Z", "type": "commit"}, {"oid": "a80ee5794ed3d6edf74c8a9ade9c8c62541e8165", "url": "https://github.com/akvo/akvo-flow/commit/a80ee5794ed3d6edf74c8a9ade9c8c62541e8165", "message": "[#3261] Promotition scripts", "committedDate": "2020-05-22T11:13:22Z", "type": "commit"}, {"oid": "23050db2770455c7edce49ab7cc5f269b86c5c66", "url": "https://github.com/akvo/akvo-flow/commit/23050db2770455c7edce49ab7cc5f269b86c5c66", "message": "[#3571] Temporarily pretend dev1 is uat1 and dev2 is uat2", "committedDate": "2020-05-22T11:14:18Z", "type": "commit"}, {"oid": "35598d88fc57f4d24859aeb4a0f2d4f4800c99df", "url": "https://github.com/akvo/akvo-flow/commit/35598d88fc57f4d24859aeb4a0f2d4f4800c99df", "message": "[#3571] Temporarily pretend dev1 is uat1 and dev2 is uat2", "committedDate": "2020-05-22T11:21:25Z", "type": "commit"}, {"oid": "c70d1c634b914d3937951d3aa6c4b288a4efd49e", "url": "https://github.com/akvo/akvo-flow/commit/c70d1c634b914d3937951d3aa6c4b288a4efd49e", "message": "[#3571] Not mangling the version", "committedDate": "2020-05-22T11:29:29Z", "type": "commit"}, {"oid": "e08c1688267aa985f1061dd4eb3e1b4fbb3801c8", "url": "https://github.com/akvo/akvo-flow/commit/e08c1688267aa985f1061dd4eb3e1b4fbb3801c8", "message": "[#3571] Removing println", "committedDate": "2020-05-22T11:38:23Z", "type": "commit"}, {"oid": "33202ed12ecdc1cca1c4ced25c3afdc79fc0e833", "url": "https://github.com/akvo/akvo-flow/commit/33202ed12ecdc1cca1c4ced25c3afdc79fc0e833", "message": "[#3571] Flip script", "committedDate": "2020-05-22T12:48:37Z", "type": "commit"}, {"oid": "82be0302b272924f3f92efaa5cbbb1996ecafb52", "url": "https://github.com/akvo/akvo-flow/commit/82be0302b272924f3f92efaa5cbbb1996ecafb52", "message": "[#3571] Pretending dev3 is all other instances", "committedDate": "2020-05-22T12:48:56Z", "type": "commit"}, {"oid": "35c569f6a4718090b56b70dddfe9a137e781fae7", "url": "https://github.com/akvo/akvo-flow/commit/35c569f6a4718090b56b70dddfe9a137e781fae7", "message": "[#3571] Flip tag does not need to be annotated", "committedDate": "2020-05-22T13:17:34Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTM0ODEwNQ==", "url": "https://github.com/akvo/akvo-flow/pull/3574#discussion_r429348105", "bodyText": "Why CLUSTER ? In App Engine you work with projects", "author": "iperdomo", "createdAt": "2020-05-22T16:41:57Z", "path": "ci/flip-production-traffic.sh", "diffHunk": "@@ -0,0 +1,61 @@\n+#!/usr/bin/env bash\n+\n+set -u\n+\n+function log {\n+   echo \"$(date +\"%T\") - INFO - $*\"\n+}\n+\n+function read_version () {\n+    CLUSTER=$1", "originalCommit": "35c569f6a4718090b56b70dddfe9a137e781fae7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTc2OTYwOQ==", "url": "https://github.com/akvo/akvo-flow/pull/3574#discussion_r429769609", "bodyText": "Copy and paste legacy ...", "author": "dlebrero", "createdAt": "2020-05-25T07:17:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTM0ODEwNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTM1MjU1OQ==", "url": "https://github.com/akvo/akvo-flow/pull/3574#discussion_r429352559", "bodyText": "I've seen those pipe tricks elsewhere. If you want to continue working with text:\ngcloud app versions list --project=akvoflow-uat1 --hide-no-traffic --service=default | awk '/^default/ {print $2}'\nOr gcloud has --format=json for structured output\ngcloud app versions list --project=akvoflow-uat1 --hide-no-traffic --service=default --format=json | jq -M -r '.[].version.id'", "author": "iperdomo", "createdAt": "2020-05-22T16:48:47Z", "path": "ci/flip-production-traffic.sh", "diffHunk": "@@ -0,0 +1,61 @@\n+#!/usr/bin/env bash\n+\n+set -u\n+\n+function log {\n+   echo \"$(date +\"%T\") - INFO - $*\"\n+}\n+\n+function read_version () {\n+    CLUSTER=$1\n+    log \"Reading ${CLUSTER} version\"\n+    VERSION=$(gcloud app versions list --project=\"${CLUSTER}\" --hide-no-traffic --service=default | grep \"default\" | tr -s \" \" | cut -f 2  -d\\ )", "originalCommit": "35c569f6a4718090b56b70dddfe9a137e781fae7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTc3MjAwMg==", "url": "https://github.com/akvo/akvo-flow/pull/3574#discussion_r429772002", "bodyText": "opted for --format=\"value(VERSION.id)\"", "author": "dlebrero", "createdAt": "2020-05-25T07:23:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTM1MjU1OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTM1NTIyMQ==", "url": "https://github.com/akvo/akvo-flow/pull/3574#discussion_r429355221", "bodyText": "In promote-test-to-prod.sh line 72:\nif [ \"${FIX}\" != \"n\" ] || [ \"${FIX}\" != \"N\" ]; then\n                       ^-- SC2252: You probably wanted && here, otherwise it's always true.\n\nFor more information:\n  https://www.shellcheck.net/wiki/SC2252 -- You probably wanted && here, othe...", "author": "iperdomo", "createdAt": "2020-05-22T16:54:32Z", "path": "ci/promote-test-to-prod.sh", "diffHunk": "@@ -0,0 +1,85 @@\n+#!/usr/bin/env bash\n+\n+set -u\n+\n+function log {\n+   echo \"$(date +\"%T\") - INFO - $*\"\n+}\n+\n+GITHUB_PROJECT=akvo-flow\n+NOTIFICATION=${4:-slack}\n+\n+function read_version () {\n+    CLUSTER=$1\n+    log \"Reading ${CLUSTER} version\"\n+    VERSION=$(gcloud app versions list --project=\"${CLUSTER}\" --hide-no-traffic --service=default | grep \"default\" | tr -s \" \" | cut -f 2  -d\\ )\n+}\n+\n+if [[ -z \"$(gcloud config list --format='value(core.account)')\" ]]; then\n+  gcloud auth login\n+fi\n+\n+read_version \"akvoflow-dev2\"\n+TEST_LIVE_VERSION=$VERSION\n+\n+read_version \"akvoflow-dev1\"\n+PROD_DARK_VERSION=$VERSION\n+\n+read_version \"akvoflow-dev3\" # WHH instance\n+PROD_LIVE_VERSION=$VERSION\n+\n+log \"Deployed test version is $TEST_LIVE_VERSION\"\n+log \"Deployed prod dark version is $PROD_DARK_VERSION\"\n+log \"Diff between test and dark prod is https://github.com/akvo/${GITHUB_PROJECT}/compare/$PROD_DARK_VERSION..$TEST_LIVE_VERSION\"\n+\n+if [[ \"$PROD_DARK_VERSION\" = \"$PROD_LIVE_VERSION\" ]]; then\n+  log \"Deployed prod live version is same as prod dark version\"\n+else\n+  log \"Deployed prod live version is $PROD_LIVE_VERSION\"\n+  log \"Diff between test and live prod is https://github.com/akvo/${GITHUB_PROJECT}/compare/$PROD_LIVE_VERSION..$TEST_LIVE_VERSION\"\n+fi\n+\n+## Lets assume this git history:\n+# v1 (prod-live)\n+# v2\n+# v3 (prod-dark)\n+# v4\n+# v5 (test)\n+# When promoting a build, we want to report the new changes (v4, v5) that will show in dark.\n+# But lets say that we have the previous history and we do a flip in production. We have:\n+# v1 (prod-dark)\n+# v2\n+# v3 (prod-live)\n+# v4\n+# v5 (test)\n+# So in this case we really want to report the changes between test and prod-live (still v4, v5)\n+# In general terms, we want to see the diff between test and the last promotion.\n+# Instead of looking at git tags, we just check which of the prod envs is older\n+if git merge-base --is-ancestor \"$PROD_LIVE_VERSION\" \"$PROD_DARK_VERSION\"; then\n+  NEWEST_VERSION_IN_PROD=$PROD_DARK_VERSION\n+else\n+  NEWEST_VERSION_IN_PROD=$PROD_LIVE_VERSION\n+fi\n+log \"Commits to be deployed:\"\n+echo \"\"\n+\n+git log --oneline \"$NEWEST_VERSION_IN_PROD\"..\"$TEST_LIVE_VERSION\" | grep -v \"Merge pull request\" | grep -v \"Merge branch\"\n+\n+TAG_NAME=\"promote-$(TZ=UTC date +\"%Y%m%d-%H%M%S\")\"\n+\n+echo \"\"\n+read -r -e -p \"Does this deployment contain a hotfix, rollback or fix-forward for a previous deployment? [Y/n] \" FIX\n+if [ \"${FIX}\" != \"n\" ] || [ \"${FIX}\" != \"N\" ]; then", "originalCommit": "35c569f6a4718090b56b70dddfe9a137e781fae7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTc3MjkxOQ==", "url": "https://github.com/akvo/akvo-flow/pull/3574#discussion_r429772919", "bodyText": "I copy and pasted this error 3 times at least", "author": "dlebrero", "createdAt": "2020-05-25T07:25:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTM1NTIyMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTM1NTU5Nw==", "url": "https://github.com/akvo/akvo-flow/pull/3574#discussion_r429355597", "bodyText": "Why do we need a script to generate another script!? \ud83e\udd2f", "author": "iperdomo", "createdAt": "2020-05-22T16:55:17Z", "path": "ci/generate-slack-notification.sh", "diffHunk": "@@ -0,0 +1,36 @@\n+#!/usr/bin/env bash\n+\n+OLDER_GIT_VERSION=$1\n+NEWEST_GIT_VERSION=$2\n+MSG=$3\n+COLOR=$4\n+WRAP_SLACK=$5\n+GITHUB_PROJECT=$6\n+\n+cat << EOF > notify.team.sh", "originalCommit": "35c569f6a4718090b56b70dddfe9a137e781fae7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTc3NTEzMw==", "url": "https://github.com/akvo/akvo-flow/pull/3574#discussion_r429775133", "bodyText": "This is because as a confirmation for the promote or flip, we expect the developer to manually run some commands.", "author": "dlebrero", "createdAt": "2020-05-25T07:30:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTM1NTU5Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTM1NTgxMQ==", "url": "https://github.com/akvo/akvo-flow/pull/3574#discussion_r429355811", "bodyText": "Ideam. Projects no cluster.", "author": "iperdomo", "createdAt": "2020-05-22T16:55:44Z", "path": "ci/promote-test-to-prod.sh", "diffHunk": "@@ -0,0 +1,85 @@\n+#!/usr/bin/env bash\n+\n+set -u\n+\n+function log {\n+   echo \"$(date +\"%T\") - INFO - $*\"\n+}\n+\n+GITHUB_PROJECT=akvo-flow\n+NOTIFICATION=${4:-slack}\n+\n+function read_version () {\n+    CLUSTER=$1", "originalCommit": "35c569f6a4718090b56b70dddfe9a137e781fae7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTM1NjIyNw==", "url": "https://github.com/akvo/akvo-flow/pull/3574#discussion_r429356227", "bodyText": "Let's use CI_GIT_SHA or similar", "author": "iperdomo", "createdAt": "2020-05-22T16:56:40Z", "path": "ci/deploy.sh", "diffHunk": "@@ -2,36 +2,15 @@\n \n set -euo pipefail\n \n-CI_BRANCH=\"${SEMAPHORE_GIT_BRANCH:=}\"\n-CI_TAG=\"${SEMAPHORE_GIT_TAG_NAME:=}\"\n-CI_PULL_REQUEST=\"${SEMAPHORE_GIT_PR_NAME:=}\"\n-\n function log {\n    echo \"$(date +\"%T\") - INFO - $*\"\n }\n \n-if [[ \"${CI_BRANCH}\" != \"master\" ]] && [[ -z \"${CI_TAG}\" ]]; then\n-   exit 0\n-fi\n-\n-if [[ -n \"${CI_PULL_REQUEST}\" ]]; then\n-    exit 0\n-fi\n-\n-if [[ \"${CI_TAG:0:8}\" == \"promote-\" ]]; then\n-    echo \"Skipping deployment\"\n-    exit 0\n-fi\n-\n-develop_project_id=\"${DEVELOP_PROJECT_ID:=akvoflow-uat2}\"\n-release_project_id=\"${RELEASE_PROJECT_ID:=akvoflow-uat1}\"\n+develop_project_id=\"${DEVELOP_PROJECT_ID:=akvoflow-dev2}\"\n+FLOW_VERSION=${FLOW_VERSION:-${SEMAPHORE_GIT_SHA}}", "originalCommit": "35c569f6a4718090b56b70dddfe9a137e781fae7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "66c5c5e8ef7b49866ae3ad131b537b5d47169d0b", "url": "https://github.com/akvo/akvo-flow/commit/66c5c5e8ef7b49866ae3ad131b537b5d47169d0b", "message": "[#3571] Use PROJECT instead of CLUSTER", "committedDate": "2020-05-25T07:18:44Z", "type": "commit"}, {"oid": "ecda12d6da5bb6f8b0673795a06d8777c9d65d4e", "url": "https://github.com/akvo/akvo-flow/commit/ecda12d6da5bb6f8b0673795a06d8777c9d65d4e", "message": "[#3571] Replace bash magic with \"--format\"", "committedDate": "2020-05-25T07:22:48Z", "type": "commit"}, {"oid": "9a4b8f1a376a5a9527e2b836eca58d4c1c4f1bad", "url": "https://github.com/akvo/akvo-flow/commit/9a4b8f1a376a5a9527e2b836eca58d4c1c4f1bad", "message": "[#3571] Fix boolean logic", "committedDate": "2020-05-25T07:25:14Z", "type": "commit"}, {"oid": "54f54d7338ccae1e8eddc53337a252ab61d05d7b", "url": "https://github.com/akvo/akvo-flow/commit/54f54d7338ccae1e8eddc53337a252ab61d05d7b", "message": "[#3571] s/SEMAPHORE_GIT_SHA/CI_COMMIT", "committedDate": "2020-05-25T07:27:41Z", "type": "commit"}, {"oid": "5e107187104ea59514bfd3d1a79bb97307e4100c", "url": "https://github.com/akvo/akvo-flow/commit/5e107187104ea59514bfd3d1a79bb97307e4100c", "message": "[#3571] Use date+git_sha for Dashboard and Clojars version\n\nDate gives a monotonically increasing number. This is for the users.\n\ngit sha gives a point in git. This is for developers.", "committedDate": "2020-05-25T07:38:35Z", "type": "commit"}, {"oid": "90f56ba63182735028c92505e0af88005f5105dd", "url": "https://github.com/akvo/akvo-flow/commit/90f56ba63182735028c92505e0af88005f5105dd", "message": "[#3571] Testing Clojars deploy", "committedDate": "2020-05-25T07:44:00Z", "type": "commit"}, {"oid": "f23d547118c8757b8f8576f07504f485beb663cd", "url": "https://github.com/akvo/akvo-flow/commit/f23d547118c8757b8f8576f07504f485beb663cd", "message": "[#3571] Testing Clojars deploy", "committedDate": "2020-05-25T07:52:25Z", "type": "commit"}, {"oid": "0f4fab338b94f792b1ba4ea7ace4612b4f08b399", "url": "https://github.com/akvo/akvo-flow/commit/0f4fab338b94f792b1ba4ea7ace4612b4f08b399", "message": "[#3571] Use date+git_sha in Dashboard build", "committedDate": "2020-05-25T07:54:56Z", "type": "commit"}, {"oid": "987944bc60404f176db998925392065da8f313ae", "url": "https://github.com/akvo/akvo-flow/commit/987944bc60404f176db998925392065da8f313ae", "message": "[#3571] s/dev1/uat1, dev2->uat2 ...", "committedDate": "2020-05-25T09:15:24Z", "type": "commit"}, {"oid": "2fb8493fd5759067fcf3d62ae7a7cf36d2687489", "url": "https://github.com/akvo/akvo-flow/commit/2fb8493fd5759067fcf3d62ae7a7cf36d2687489", "message": "[#3571] Using master branch instead of this branch", "committedDate": "2020-05-25T09:16:40Z", "type": "commit"}, {"oid": "bac8517c55cc9dd889b3b2a7b651414fd328bbce", "url": "https://github.com/akvo/akvo-flow/commit/bac8517c55cc9dd889b3b2a7b651414fd328bbce", "message": "[#3571] Move scripts to dockerfiles repo", "committedDate": "2020-05-25T10:26:42Z", "type": "commit"}, {"oid": "fcef8309cc2fa7beb662356ae9fc86bcc8124adf", "url": "https://github.com/akvo/akvo-flow/commit/fcef8309cc2fa7beb662356ae9fc86bcc8124adf", "message": "[#3571] Lastest version of flip/deploy scripts", "committedDate": "2020-05-25T10:48:21Z", "type": "commit"}]}