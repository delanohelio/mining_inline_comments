{"pr_number": 2772, "pr_title": "Apply errorprone", "pr_createdAt": "2020-06-04T06:19:49Z", "pr_url": "https://github.com/line/armeria/pull/2772", "timeline": [{"oid": "b61a426538e6fbc6b8a99683e35d5bc7bed72e54", "url": "https://github.com/line/armeria/commit/b61a426538e6fbc6b8a99683e35d5bc7bed72e54", "message": "Fix compilation error suggested by errorprone\nFound some silly mistakes as well. :smile:", "committedDate": "2020-06-04T06:18:48Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTAxNjYyNQ==", "url": "https://github.com/line/armeria/pull/2772#discussion_r435016625", "bodyText": "I think we can remove this annotation rather than suppressing where it's used. \ud83e\udd14", "author": "minwoox", "createdAt": "2020-06-04T06:20:33Z", "path": "core/src/main/java/com/linecorp/armeria/common/stream/StreamWriter.java", "diffHunk": "@@ -96,7 +94,6 @@ default void write(Supplier<? extends T> o) {\n      * @throws IllegalArgumentException if the publication of the specified object has been rejected\n      * @see <a href=\"#reference-counted\">Life cycle of reference-counted objects</a>\n      */\n-    @CheckReturnValue", "originalCommit": "b61a426538e6fbc6b8a99683e35d5bc7bed72e54", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTAyNTU1OA==", "url": "https://github.com/line/armeria/pull/2772#discussion_r435025558", "bodyText": "/cc @anuraaga who suggested this annotation first. \ud83d\ude09", "author": "trustin", "createdAt": "2020-06-04T06:43:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTAxNjYyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTA0MjM0MA==", "url": "https://github.com/line/armeria/pull/2772#discussion_r435042340", "bodyText": "I think it's much easier to have a bug because of not checking this return value, in almost all cases the user should specially handle a closed stream right?\nFor example, here it looks like we should actually be skipping the rest of the callback if the stream is already closed\n\n  \n    \n      armeria/core/src/main/java/com/linecorp/armeria/server/healthcheck/HealthCheckService.java\n    \n    \n         Line 332\n      in\n      4f62fc0\n    \n    \n    \n    \n\n        \n          \n           res.tryWrite(ping);", "author": "anuraaga", "createdAt": "2020-06-04T07:19:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTAxNjYyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTA1NTU4OQ==", "url": "https://github.com/line/armeria/pull/2772#discussion_r435055589", "bodyText": "Ah, that makes sense. Let me fix that. \ud83d\ude04", "author": "minwoox", "createdAt": "2020-06-04T07:44:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTAxNjYyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTA5NTQwMg==", "url": "https://github.com/line/armeria/pull/2772#discussion_r435095402", "bodyText": "Found out that we can just call res.write(ping); there. \ud83d\ude06", "author": "minwoox", "createdAt": "2020-06-04T08:51:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTAxNjYyNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTAyNjE2MQ==", "url": "https://github.com/line/armeria/pull/2772#discussion_r435026161", "bodyText": "/cc @jrhee17 \ud83d\ude09", "author": "trustin", "createdAt": "2020-06-04T06:44:47Z", "path": "core/src/test/java/com/linecorp/armeria/client/proxy/ProxyClientIntegrationTest.java", "diffHunk": "@@ -369,7 +369,7 @@ void testProxyWithUserName() throws Exception {\n         final String username = \"username\";\n         DYNAMIC_HANDLER.setChannelReadCustomizer((ctx, msg) -> {\n             if (msg instanceof DefaultSocks4CommandRequest) {\n-                assertThat(username.equals(((DefaultSocks4CommandRequest) msg).userId()));\n+                assertThat(username).isEqualTo(((DefaultSocks4CommandRequest) msg).userId());", "originalCommit": "b61a426538e6fbc6b8a99683e35d5bc7bed72e54", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTA5ODQ0Mw==", "url": "https://github.com/line/armeria/pull/2772#discussion_r435098443", "bodyText": "\ud83d\ude48 \ud83d\ude49", "author": "jrhee17", "createdAt": "2020-06-04T08:56:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTAyNjE2MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTAyNjUwMw==", "url": "https://github.com/line/armeria/pull/2772#discussion_r435026503", "bodyText": "Isn't this cast redundant?", "author": "trustin", "createdAt": "2020-06-04T06:45:32Z", "path": "core/src/test/java/com/linecorp/armeria/server/TestConverters.java", "diffHunk": "@@ -38,7 +38,7 @@ public HttpResponse convertResponse(ServiceRequestContext ctx,\n                                             @Nullable Object result,\n                                             HttpHeaders trailers) throws Exception {\n             if (result instanceof Integer) {\n-                return httpResponse(HttpData.ofUtf8(String.format(\"Integer: %d\", result)));\n+                return httpResponse(HttpData.ofUtf8(String.format(\"Integer: %d\", (Integer) result)));", "originalCommit": "b61a426538e6fbc6b8a99683e35d5bc7bed72e54", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTAyNzUyNA==", "url": "https://github.com/line/armeria/pull/2772#discussion_r435027524", "bodyText": "Yeah, it's redundant but it seems that the Errorprone couldn't recognize and indicates this is an error. \ud83d\ude31", "author": "minwoox", "createdAt": "2020-06-04T06:47:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTAyNjUwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTAyNzk1Mg==", "url": "https://github.com/line/armeria/pull/2772#discussion_r435027952", "bodyText": "It thinks it's a String. \ud83d\ude31", "author": "minwoox", "createdAt": "2020-06-04T06:48:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTAyNjUwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTA0MzY4Mg==", "url": "https://github.com/line/armeria/pull/2772#discussion_r435043682", "bodyText": "In Java 14 maybe it doesn't complain? :) But yeah seems like a false positive but harmless workaround", "author": "anuraaga", "createdAt": "2020-06-04T07:21:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTAyNjUwMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTA0Mjk5OQ==", "url": "https://github.com/line/armeria/pull/2772#discussion_r435042999", "bodyText": "These fluent assertion checks are awesome", "author": "anuraaga", "createdAt": "2020-06-04T07:20:30Z", "path": "examples/server-sent-events/src/test/java/example/armeria/server/sse/MainTest.java", "diffHunk": "@@ -56,7 +56,7 @@ void testServerSentEvents() {\n                     .expectNext(HttpData.ofUtf8(\"data:2\\n\\n\"))\n                     .expectNext(HttpData.ofUtf8(\"data:3\\n\\n\"))\n                     .expectNext(HttpData.ofUtf8(\"data:4\\n\\n\"))\n-                    .assertNext(o -> assertThat(o.isEndOfStream()))\n+                    .assertNext(o -> assertThat(o.isEndOfStream()).isTrue())", "originalCommit": "b61a426538e6fbc6b8a99683e35d5bc7bed72e54", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "6506e13be6279b7ceec152fdf97e44a8def7e6a1", "url": "https://github.com/line/armeria/commit/6506e13be6279b7ceec152fdf97e44a8def7e6a1", "message": "Apply errorprone", "committedDate": "2020-06-04T08:45:59Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTEwMDQ1Nw==", "url": "https://github.com/line/armeria/pull/2772#discussion_r435100457", "bodyText": "Don't we need apply false?", "author": "ikhoon", "createdAt": "2020-06-04T09:00:07Z", "path": "build.gradle", "diffHunk": "@@ -5,6 +5,8 @@ plugins {\n     // If you want to change `org.jetbrains.kotlin.jvm` version, \n     // you also need to change `org.jetbrains.kotlin:kotlin-allopen` version in `dependencies.yml`.\n     id 'org.jetbrains.kotlin.jvm' version '1.3.72' apply false\n+\n+    id 'net.ltgt.errorprone' version '1.2.1'", "originalCommit": "6506e13be6279b7ceec152fdf97e44a8def7e6a1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTEyMzI5Mw==", "url": "https://github.com/line/armeria/pull/2772#discussion_r435123293", "bodyText": "Fixed. \ud83d\ude09", "author": "minwoox", "createdAt": "2020-06-04T09:37:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTEwMDQ1Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTEwNjE5Ng==", "url": "https://github.com/line/armeria/pull/2772#discussion_r435106196", "bodyText": "The default value of disableWarningsInGeneratedCode is false.\nHow about making it true for fewer noisy.", "author": "ikhoon", "createdAt": "2020-06-04T09:09:21Z", "path": "build.gradle", "diffHunk": "@@ -69,13 +71,18 @@ task checkJavaVersion {\n \n // Configure all Java projects\n configure(projectsWithFlags('java')) {\n+    apply plugin: 'net.ltgt.errorprone'\n+\n     // Common dependencies\n     dependencies {\n         // All projects currently require ':core' (except itself)\n         if (project != project(':core')) {\n             api project(':core')\n         }\n \n+        // Error Prone compiler\n+        errorprone 'com.google.errorprone:error_prone_core'", "originalCommit": "6506e13be6279b7ceec152fdf97e44a8def7e6a1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTExNDY2Mg==", "url": "https://github.com/line/armeria/pull/2772#discussion_r435114662", "bodyText": "I couldn't feel any differences with and without warning (It doesn't produce a lot). So I think we can just leave it as it is.", "author": "minwoox", "createdAt": "2020-06-04T09:23:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTEwNjE5Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTEyMTgyNw==", "url": "https://github.com/line/armeria/pull/2772#discussion_r435121827", "bodyText": "OK, SGTM", "author": "ikhoon", "createdAt": "2020-06-04T09:35:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTEwNjE5Ng=="}], "type": "inlineReview"}, {"oid": "20be9c0d250947dd06f31bece349b60dc4daa156", "url": "https://github.com/line/armeria/commit/20be9c0d250947dd06f31bece349b60dc4daa156", "message": "Address the comment by @ikhoon", "committedDate": "2020-06-04T09:37:18Z", "type": "commit"}, {"oid": "6b5745e34e0635ac876eec885c5893237817b4b0", "url": "https://github.com/line/armeria/commit/6b5745e34e0635ac876eec885c5893237817b4b0", "message": "Diable when noLint is specified", "committedDate": "2020-06-05T08:56:49Z", "type": "commit"}]}