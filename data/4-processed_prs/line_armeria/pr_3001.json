{"pr_number": 3001, "pr_title": "Upgrade gRPC-Kotlin to 0.1.5", "pr_createdAt": "2020-08-18T07:02:25Z", "pr_url": "https://github.com/line/armeria/pull/3001", "timeline": [{"oid": "5f2e8ff39275f9f880a5a7b70d0e7976b5aab8f6", "url": "https://github.com/line/armeria/commit/5f2e8ff39275f9f880a5a7b70d0e7976b5aab8f6", "message": "Upgrade gRPC-Kotlin to 0.1.5\n\nMotivation:\n\n`CoroutineContextServerInterceptor` is newly introduced in gRPC-Kotlin [0.1.5](https://github.com/grpc/grpc-kotlin/releases/tag/v0.1.5).\nArmeria gRPC server can inject the current `RequestContext` to Coroutine Context using it.\n\nThe issue that `inHalfClose` unexpectly calls `ServerCall.close()` seems resolved by https://github.com/grpc/grpc-kotlin/pull/157.\nI cannot reproduce it anymore.\n\nModifications:\n\n- Add `ArmeriaCoroutineContextInterceptor` that is working only for gRPC-Kotlin stub.\n- Remove `inHalfClose` flag in ArmeriaServerCall\n\nResults:\n\n- You can now get the current `RequestContext` from the Coroutine Context of gRPC-Kotlin by default.", "committedDate": "2020-08-18T07:01:05Z", "type": "commit"}, {"oid": "751bc8b04217a556e85e8117aec59e3c39a9e26f", "url": "https://github.com/line/armeria/commit/751bc8b04217a556e85e8117aec59e3c39a9e26f", "message": "Remove TODO", "committedDate": "2020-08-18T07:08:15Z", "type": "commit"}, {"oid": "2d36dff45059cd285caa0680d86cbf2ff2492d2f", "url": "https://github.com/line/armeria/commit/2d36dff45059cd285caa0680d86cbf2ff2492d2f", "message": "Address comments by @okue", "committedDate": "2020-08-18T09:26:29Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjA1MzIzMQ==", "url": "https://github.com/line/armeria/pull/3001#discussion_r472053231", "bodyText": "nit: We can make this as final\nprivate static final boolean USE_COROUTINE_CONTEXT_INTERCEPTOR;\n\nstatic {\n    boolean useCoroutineContextInterceptor = false;\n    try {\n        Class.forName(\"io.grpc.kotlin.CoroutineContextServerInterceptor\", false,\n                      GrpcServiceBuilder.class.getClassLoader());\n        useCoroutineContextInterceptor = true;\n    } catch (Throwable ignored) {\n    }\n    USE_COROUTINE_CONTEXT_INTERCEPTOR = useCoroutineContextInterceptor;\n}", "author": "minwoox", "createdAt": "2020-08-18T09:44:25Z", "path": "grpc/src/main/java/com/linecorp/armeria/server/grpc/GrpcServiceBuilder.java", "diffHunk": "@@ -67,6 +68,18 @@\n     private static final Set<SerializationFormat> DEFAULT_SUPPORTED_SERIALIZATION_FORMATS =\n             GrpcSerializationFormats.values();\n \n+    private static boolean useCoroutineContextInterceptor;", "originalCommit": "2d36dff45059cd285caa0680d86cbf2ff2492d2f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "d4d7378524e43a4b601152fa1f5b8c327d5c8e7b", "url": "https://github.com/line/armeria/commit/d4d7378524e43a4b601152fa1f5b8c327d5c8e7b", "message": "Checkstyle", "committedDate": "2020-08-18T10:01:08Z", "type": "commit"}, {"oid": "e02557cbeed4b65bfd55bcdbf9f56e198fc77dd5", "url": "https://github.com/line/armeria/commit/e02557cbeed4b65bfd55bcdbf9f56e198fc77dd5", "message": "Use final", "committedDate": "2020-08-18T10:03:20Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjI2MzMwMg==", "url": "https://github.com/line/armeria/pull/3001#discussion_r472263302", "bodyText": "How about logging whether coroutine context interceptor is available? e.g.\nlogger.debug(\"{}: {}\", className, useCoroutineContextInterceptor ? \"available\" : \"unavailable\");", "author": "trustin", "createdAt": "2020-08-18T14:58:35Z", "path": "grpc/src/main/java/com/linecorp/armeria/server/grpc/GrpcServiceBuilder.java", "diffHunk": "@@ -67,6 +68,20 @@\n     private static final Set<SerializationFormat> DEFAULT_SUPPORTED_SERIALIZATION_FORMATS =\n             GrpcSerializationFormats.values();\n \n+    private static final boolean USE_COROUTINE_CONTEXT_INTERCEPTOR;\n+\n+    static {\n+        boolean useCoroutineContextInterceptor;\n+        try {\n+            Class.forName(\"io.grpc.kotlin.CoroutineContextServerInterceptor\", false,\n+                          GrpcServiceBuilder.class.getClassLoader());\n+            useCoroutineContextInterceptor = true;\n+        } catch (Throwable ignored) {\n+            useCoroutineContextInterceptor = false;\n+        }\n+        USE_COROUTINE_CONTEXT_INTERCEPTOR = useCoroutineContextInterceptor;", "originalCommit": "e02557cbeed4b65bfd55bcdbf9f56e198fc77dd5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjU5MTM1NA==", "url": "https://github.com/line/armeria/pull/3001#discussion_r472591354", "bodyText": "Yeah. That's a good idea!", "author": "ikhoon", "createdAt": "2020-08-19T02:01:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjI2MzMwMg=="}], "type": "inlineReview"}, {"oid": "746fad287e5bbd62dbee8b2b3f83f278a83e49ea", "url": "https://github.com/line/armeria/commit/746fad287e5bbd62dbee8b2b3f83f278a83e49ea", "message": "Address comments by @trustin", "committedDate": "2020-08-19T02:04:49Z", "type": "commit"}]}