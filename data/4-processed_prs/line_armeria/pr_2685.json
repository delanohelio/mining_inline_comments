{"pr_number": 2685, "pr_title": "Fix a bug where `HttpStreamReader` calls deframer multiple times with\u2026", "pr_createdAt": "2020-05-02T07:42:42Z", "pr_url": "https://github.com/line/armeria/pull/2685", "timeline": [{"oid": "b96adcab20b63d775e8dc7b8920d08dfa30a29a0", "url": "https://github.com/line/armeria/commit/b96adcab20b63d775e8dc7b8920d08dfa30a29a0", "message": "Fix a bug where `HttpStreamReader` calls deframer multiple times with endOfStream.\n\nMotivation:\n\nIf `ArmeriaMessageDefarmer.deframe(HttpData, endOfStream)` is called with `endOfStream` more than once,\nit will throws `IlligalStateException`.\nThis happens intermittently due to a race condition like the following:\n\n1) `HttpStreamReader` received all data from publisher and added them to unprocessed of `deframer`.\n2) A gRPC client does not request next messages yet, so `deframer` still has unprocessedBytes and is not stalled.\n3) `HttpStreamReader` receives onCompleted signal and closes `deframer`.\n4) A gRPC client requests a message and the received message contains trailers, so `ArmeriaClientCall` tries to close deframer.\n\nModifications:\n\n- Add `isClosing()` method to `ArmeriaMessageDefarmer`, it returns whether or not `closeWhenComplete` is `true`\n- Do not close `deframer`, if `defarmer` is closing.\n\nResult:\ngRPC client can request unprocessed bytes even if `HttpStreamReader` was completed.", "committedDate": "2020-05-03T11:10:21Z", "type": "commit"}, {"oid": "b96adcab20b63d775e8dc7b8920d08dfa30a29a0", "url": "https://github.com/line/armeria/commit/b96adcab20b63d775e8dc7b8920d08dfa30a29a0", "message": "Fix a bug where `HttpStreamReader` calls deframer multiple times with endOfStream.\n\nMotivation:\n\nIf `ArmeriaMessageDefarmer.deframe(HttpData, endOfStream)` is called with `endOfStream` more than once,\nit will throws `IlligalStateException`.\nThis happens intermittently due to a race condition like the following:\n\n1) `HttpStreamReader` received all data from publisher and added them to unprocessed of `deframer`.\n2) A gRPC client does not request next messages yet, so `deframer` still has unprocessedBytes and is not stalled.\n3) `HttpStreamReader` receives onCompleted signal and closes `deframer`.\n4) A gRPC client requests a message and the received message contains trailers, so `ArmeriaClientCall` tries to close deframer.\n\nModifications:\n\n- Add `isClosing()` method to `ArmeriaMessageDefarmer`, it returns whether or not `closeWhenComplete` is `true`\n- Do not close `deframer`, if `defarmer` is closing.\n\nResult:\ngRPC client can request unprocessed bytes even if `HttpStreamReader` was completed.", "committedDate": "2020-05-03T11:10:21Z", "type": "forcePushed"}, {"oid": "b4e69db528762b06e9047b430a02eee902143967", "url": "https://github.com/line/armeria/commit/b4e69db528762b06e9047b430a02eee902143967", "message": "Fix test", "committedDate": "2020-05-04T03:46:22Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTI2OTY3NA==", "url": "https://github.com/line/armeria/pull/2685#discussion_r419269674", "bodyText": "Is this necessary?", "author": "minwoox", "createdAt": "2020-05-04T08:02:41Z", "path": "grpc-protocol/src/main/java/com/linecorp/armeria/common/grpc/protocol/ArmeriaMessageDeframer.java", "diffHunk": "@@ -317,6 +317,7 @@ public void close() {\n                 unprocessed.forEach(ByteBuf::release);\n             } finally {\n                 unprocessed = null;\n+                closeWhenComplete = false;", "originalCommit": "b4e69db528762b06e9047b430a02eee902143967", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTI5ODI4MQ==", "url": "https://github.com/line/armeria/pull/2685#discussion_r419298281", "bodyText": "Technically, we don't need it now. I added this line for integrity. It seems weird to me that both isClosed() and isClosing() return true. \ud83d\ude05", "author": "ikhoon", "createdAt": "2020-05-04T08:59:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTI2OTY3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTMwMzE0OA==", "url": "https://github.com/line/armeria/pull/2685#discussion_r419303148", "bodyText": "OK, SGTM.", "author": "minwoox", "createdAt": "2020-05-04T09:09:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTI2OTY3NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTI3MDI0NA==", "url": "https://github.com/line/armeria/pull/2685#discussion_r419270244", "bodyText": "Can we handle this without using BiFunction?", "author": "minwoox", "createdAt": "2020-05-04T08:03:57Z", "path": "grpc/src/main/java/com/linecorp/armeria/internal/common/grpc/HttpStreamReader.java", "diffHunk": "@@ -166,12 +166,12 @@ public void onNext(HttpObject obj) {\n \n     @Override\n     public void onError(Throwable cause) {\n-        // Handled by accept() below.\n+        // Handled by apply() below.", "originalCommit": "b4e69db528762b06e9047b430a02eee902143967", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTI5NDk1OQ==", "url": "https://github.com/line/armeria/pull/2685#discussion_r419294959", "bodyText": "I've tried, but some tests failed. \ud83d\ude05\nLet me fix this another PR.", "author": "ikhoon", "createdAt": "2020-05-04T08:52:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTI3MDI0NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDUyMTUyNg==", "url": "https://github.com/line/armeria/pull/2685#discussion_r420521526", "bodyText": "isClosing() in other API often implies that it will return true after it's closed. How about renaming it to something else? e.g. needsToCloseWhenComplete()?", "author": "trustin", "createdAt": "2020-05-06T03:05:27Z", "path": "grpc-protocol/src/main/java/com/linecorp/armeria/common/grpc/protocol/ArmeriaMessageDeframer.java", "diffHunk": "@@ -325,6 +326,13 @@ public void close() {\n         }\n     }\n \n+    /**\n+     * Indicates whether or not this deframer is closing.\n+     */\n+    public boolean isClosing() {", "originalCommit": "b4e69db528762b06e9047b430a02eee902143967", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDUyNDI1NA==", "url": "https://github.com/line/armeria/pull/2685#discussion_r420524254", "bodyText": "I think in that case we can just change it to return true even when closed. @ikhoon intentionally made the behavior this way but it isn't required #2685 (comment) Don't think we need to make the name of the method longer", "author": "anuraaga", "createdAt": "2020-05-06T03:18:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDUyMTUyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDUyNTE5Mw==", "url": "https://github.com/line/armeria/pull/2685#discussion_r420525193", "bodyText": "I didn't know that isClosing() returns true in our API. \ud83d\ude05\nLet me remove the line setting closeWhenComplete to false", "author": "ikhoon", "createdAt": "2020-05-06T03:23:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDUyMTUyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDU2MTQ0OA==", "url": "https://github.com/line/armeria/pull/2685#discussion_r420561448", "bodyText": "SGTM", "author": "trustin", "createdAt": "2020-05-06T06:01:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDUyMTUyNg=="}], "type": "inlineReview"}, {"oid": "24def9ad123e634115a2eed8097604f00badbff9", "url": "https://github.com/line/armeria/commit/24def9ad123e634115a2eed8097604f00badbff9", "message": "Make 'isClosing()' return true after closing", "committedDate": "2020-05-07T02:49:15Z", "type": "commit"}]}