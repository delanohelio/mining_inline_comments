{"pr_number": 2780, "pr_title": "Add `RequestLog.serviceName()`", "pr_createdAt": "2020-06-05T16:19:41Z", "pr_url": "https://github.com/line/armeria/pull/2780", "timeline": [{"oid": "abdd3051bcfeb1d6aa107b2ecb99a6c4fccb5fa6", "url": "https://github.com/line/armeria/commit/abdd3051bcfeb1d6aa107b2ecb99a6c4fccb5fa6", "message": "Add `RequestLog.serviceName()`\n\nMotivation:\n\nThis PR solves two problems.\n1) Provides a human readable `serviceName` and `fullName` of a request.\n   Sometimes users might want to trace or group a request by `serviceName` or `fullName`.\n2) There are inconsistency in `RequestLog.name()` that returns\n   `com.foo.bar.Service/method` for gRPC while `method` for Thrift.\n\nRelated: #2768\n\nModifications:\n\n- Add `RequestLog.serviceName()`\n  - Returns a service name for gRPC and Thrift.\n  - Returns an innermost class name for annotated service.\n  - Returns a path pattern for an `HttpService` if defaultServiceName is not specified.\n- Modify `RequestLog.name() to return a method name for gRPC, Thrift and annotated service.\n- Add `Request.fullName() that returns a concatentation of `serviceName` and `name` with `/`.\n- Add the setter of `defaultServiceName(...)` to `AbstractServiceBindingBuilder` and its subclasses.\n\nResult:\n\nYou can now get the service name and full name of a request through `RequestLog`.", "committedDate": "2020-06-05T16:17:52Z", "type": "commit"}, {"oid": "0668b77643de5057a2faaa3baf28a181c8481970", "url": "https://github.com/line/armeria/commit/0668b77643de5057a2faaa3baf28a181c8481970", "message": "Fix meter tag", "committedDate": "2020-06-05T16:52:37Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjMyNjI0Mw==", "url": "https://github.com/line/armeria/pull/2780#discussion_r436326243", "bodyText": "Shouldn't this only check name? serviceName shouldn't be required.", "author": "anuraaga", "createdAt": "2020-06-07T05:23:45Z", "path": "core/src/main/java/com/linecorp/armeria/common/logging/DefaultRequestLog.java", "diffHunk": "@@ -455,9 +460,10 @@ private void propagateRequestSideLog(RequestLogAccess child) {\n              .thenAccept(log -> serializationFormat(log.scheme().serializationFormat()));\n         child.whenAvailable(RequestLogProperty.NAME)\n              .thenAccept(log -> {\n+                 final String serviceName = log.serviceName();\n                  final String name = log.name();\n-                 if (name != null) {\n-                     name(name);\n+                 if (serviceName != null && name != null) {", "originalCommit": "0668b77643de5057a2faaa3baf28a181c8481970", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjUwMjIxNA==", "url": "https://github.com/line/armeria/pull/2780#discussion_r436502214", "bodyText": "Oops... Yes!", "author": "ikhoon", "createdAt": "2020-06-08T07:26:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjMyNjI0Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjMyNjU1NQ==", "url": "https://github.com/line/armeria/pull/2780#discussion_r436326555", "bodyText": "I notice serviceName is nullable in some places but not here which I guess is the most important. I think serviceName should not be required since not all requests model to having a service name, or users may not be interested (especially for a client, less so for server).", "author": "anuraaga", "createdAt": "2020-06-07T05:29:16Z", "path": "core/src/main/java/com/linecorp/armeria/common/logging/RequestLogBuilder.java", "diffHunk": "@@ -100,10 +101,15 @@ void session(@Nullable Channel channel, SessionProtocol sessionProtocol, @Nullab\n     void serializationFormat(SerializationFormat serializationFormat);\n \n     /**\n-     * Sets the human-readable name of the {@link Request}, such as RPC method name, annotated service method\n-     * name or HTTP method name. This property is often used as a meter tag or distributed trace's span name.\n+     * Sets the human-readable service name and method name of the {@link Request} such as:\n+     * <ul>\n+     *    <li>A service and method name for gRPC and Thrift</li>\n+     *    <li>An innermost class and method name for annotated service</li>\n+     *    <li>A path pattern and HTTP method name for {@link HttpService}</li>\n+     * </ul>\n+     * This property is often used as a meter tag or distributed trace's span name.\n      */\n-    void name(String name);\n+    void name(String serviceName, String name);", "originalCommit": "0668b77643de5057a2faaa3baf28a181c8481970", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjQ4MTk4Mw==", "url": "https://github.com/line/armeria/pull/2780#discussion_r436481983", "bodyText": "Agreed. Could they be separate properties with different availability flag? If no serviceName() is set, defaultServiceName could be set as a fallback.", "author": "trustin", "createdAt": "2020-06-08T06:34:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjMyNjU1NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjQ5ODU4Mw==", "url": "https://github.com/line/armeria/pull/2780#discussion_r436498583", "bodyText": "That was my considering point. Actually, I tried to avoid putting another tag like RequestLogProperty.SERVICE_NAME.\nI think adding serviceName() is also a good idea.\ud83d\udc4d", "author": "ikhoon", "createdAt": "2020-06-08T07:17:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjMyNjU1NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjUwOTE3OA==", "url": "https://github.com/line/armeria/pull/2780#discussion_r436509178", "bodyText": "Let me revive the original name(String name) and overload name(serviceName, name) for  a nullable serviceName.", "author": "ikhoon", "createdAt": "2020-06-08T07:41:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjMyNjU1NQ=="}], "type": "inlineReview"}, {"oid": "1e39ed8710051735cec25452fd714989b05db53a", "url": "https://github.com/line/armeria/commit/1e39ed8710051735cec25452fd714989b05db53a", "message": "Address comments by @anuraaga, @trustin + Fix broken tests", "committedDate": "2020-06-08T09:16:27Z", "type": "commit"}, {"oid": "db5f21ccf1b963273281497d34d6661dfa6117f8", "url": "https://github.com/line/armeria/commit/db5f21ccf1b963273281497d34d6661dfa6117f8", "message": "Fix broken test", "committedDate": "2020-06-08T10:39:21Z", "type": "commit"}, {"oid": "71e4aced178dc1effd4b1268601e4aea458799d6", "url": "https://github.com/line/armeria/commit/71e4aced178dc1effd4b1268601e4aea458799d6", "message": "Clean up", "committedDate": "2020-06-08T13:49:47Z", "type": "commit"}, {"oid": "2a48e9aa0a5d1b5b82ffe9755b9d2e1d3b96b137", "url": "https://github.com/line/armeria/commit/2a48e9aa0a5d1b5b82ffe9755b9d2e1d3b96b137", "message": "Use Class.getName()", "committedDate": "2020-06-09T03:26:28Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzE1NjY0MA==", "url": "https://github.com/line/armeria/pull/2780#discussion_r437156640", "bodyText": "Could these two lines be merged for aesthetics?", "author": "trustin", "createdAt": "2020-06-09T06:03:26Z", "path": "benchmarks/src/jmh/java/com/linecorp/armeria/server/RoutersBenchmark.java", "diffHunk": "@@ -43,13 +43,18 @@\n             RequestHeaders.of(HttpMethod.POST, \"/grpc.package.Service/Method1\");\n \n     static {\n+        final String defaultServiceName = null;\n+        final String defaultLogName = null;\n         SERVICES = ImmutableList.of(\n                 new ServiceConfig(Route.builder().exact(\"/grpc.package.Service/Method1\").build(),\n-                                  SERVICE, null, 0, 0, false, AccessLogWriter.disabled(), false),\n+                                  SERVICE, defaultServiceName, defaultLogName, 0, 0,\n+                                  false, AccessLogWriter.disabled(), false),\n                 new ServiceConfig(Route.builder().exact(\"/grpc.package.Service/Method2\").build(),\n-                                  SERVICE, null, 0, 0, false, AccessLogWriter.disabled(), false)\n+                                  SERVICE, defaultServiceName, defaultLogName, 0, 0,\n+                                  false, AccessLogWriter.disabled(), false)\n         );\n-        FALLBACK_SERVICE = new ServiceConfig(Route.ofCatchAll(), SERVICE, null, 0, 0, false,\n+        FALLBACK_SERVICE = new ServiceConfig(Route.ofCatchAll(), SERVICE, defaultServiceName, defaultLogName, 0,\n+                                             0, false,\n                                              AccessLogWriter.disabled(), false);", "originalCommit": "2a48e9aa0a5d1b5b82ffe9755b9d2e1d3b96b137", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzE1NjkyNQ==", "url": "https://github.com/line/armeria/pull/2780#discussion_r437156925", "bodyText": "if (name != null) {\n    if (serviceName != null) {\n        logBuilder.name(serviceName, name);\n    } else {\n        logBuilder.name(name);\n    }\n}", "author": "trustin", "createdAt": "2020-06-09T06:04:22Z", "path": "core/src/main/java/com/linecorp/armeria/client/retry/AbstractRetryingClient.java", "diffHunk": "@@ -304,8 +304,11 @@ protected static ClientRequestContext newDerivedContext(ClientRequestContext ctx\n         // serializationFormat is always not null, so this is fine.\n         logBuilder.serializationFormat(partial.serializationFormat());\n         if (parentLog.isAvailable(RequestLogProperty.NAME)) {\n+            final String serviceName = partial.serviceName();\n             final String name = partial.name();\n-            if (name != null) {\n+            if (serviceName != null && name != null) {\n+                logBuilder.name(serviceName, name);\n+            } else if (name != null) {\n                 logBuilder.name(name);\n             }", "originalCommit": "2a48e9aa0a5d1b5b82ffe9755b9d2e1d3b96b137", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzE1NzMxMw==", "url": "https://github.com/line/armeria/pull/2780#discussion_r437157313", "bodyText": "Ditto", "author": "trustin", "createdAt": "2020-06-09T06:05:22Z", "path": "core/src/main/java/com/linecorp/armeria/common/logging/DefaultRequestLog.java", "diffHunk": "@@ -455,8 +460,11 @@ private void propagateRequestSideLog(RequestLogAccess child) {\n              .thenAccept(log -> serializationFormat(log.scheme().serializationFormat()));\n         child.whenAvailable(RequestLogProperty.NAME)\n              .thenAccept(log -> {\n+                 final String serviceName = log.serviceName();\n                  final String name = log.name();\n-                 if (name != null) {\n+                 if (serviceName != null && name != null) {\n+                     name(serviceName, name);\n+                 } else if (name != null) {\n                      name(name);\n                  }", "originalCommit": "2a48e9aa0a5d1b5b82ffe9755b9d2e1d3b96b137", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzE1ODczMA==", "url": "https://github.com/line/armeria/pull/2780#discussion_r437158730", "bodyText": "Shouldn't this be out of if (name == null) block?\nWe need to distinguish between 'name-only' and 'serviceName-only' cases.", "author": "trustin", "createdAt": "2020-06-09T06:09:24Z", "path": "core/src/main/java/com/linecorp/armeria/common/logging/DefaultRequestLog.java", "diffHunk": "@@ -918,19 +959,40 @@ private void endRequest0(@Nullable Throwable requestCause, long requestEndTimeNa\n         }\n \n         if (name == null) {\n+            String newServiceName = null;\n             String newName = null;\n-            final RpcRequest rpcReq = ctx.rpcRequest();\n+            RpcRequest rpcReq = ctx.rpcRequest();\n+            if (rpcReq == null && requestContent instanceof RpcRequest) {\n+               rpcReq = (RpcRequest) requestContent;\n+            }\n+\n             if (rpcReq != null) {\n+                newServiceName = rpcReq.serviceType().getName();\n                 newName = rpcReq.method();\n-            } else if (requestContent instanceof RpcRequest) {\n-                newName = ((RpcRequest) requestContent).method();\n-            }\n+            } else if (ctx instanceof ServiceRequestContext) {\n+                final ServiceConfig config = ((ServiceRequestContext) ctx).config();\n+                newServiceName = config.defaultServiceName();\n+                if (newServiceName == null) {\n+                    newServiceName = config.route().meterTag();\n+                }\n \n-            if (newName == null && ctx instanceof ServiceRequestContext) {\n-                newName = ((ServiceRequestContext) ctx).config().defaultLogName();\n+                newName = config.defaultLogName();\n+                if (newName == null) {\n+                    newName = ctx.method().name();\n+                }\n             }\n \n+            serviceName = newServiceName;\n             name = newName;\n+            if (serviceName != null) {\n+                if (name != null) {\n+                    fullName = serviceName + '/' + name;\n+                } else {\n+                    fullName = serviceName;\n+                }\n+            } else {\n+                fullName = name;\n+            }", "originalCommit": "2a48e9aa0a5d1b5b82ffe9755b9d2e1d3b96b137", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzE1OTk5Nw==", "url": "https://github.com/line/armeria/pull/2780#discussion_r437159997", "bodyText": "Should we set the fallback serviceName and name for the client side as well? Then we could make the two properties non-null.", "author": "trustin", "createdAt": "2020-06-09T06:12:54Z", "path": "core/src/main/java/com/linecorp/armeria/common/logging/DefaultRequestLog.java", "diffHunk": "@@ -918,19 +959,40 @@ private void endRequest0(@Nullable Throwable requestCause, long requestEndTimeNa\n         }\n \n         if (name == null) {\n+            String newServiceName = null;\n             String newName = null;\n-            final RpcRequest rpcReq = ctx.rpcRequest();\n+            RpcRequest rpcReq = ctx.rpcRequest();\n+            if (rpcReq == null && requestContent instanceof RpcRequest) {\n+               rpcReq = (RpcRequest) requestContent;\n+            }\n+\n             if (rpcReq != null) {\n+                newServiceName = rpcReq.serviceType().getName();\n                 newName = rpcReq.method();\n-            } else if (requestContent instanceof RpcRequest) {\n-                newName = ((RpcRequest) requestContent).method();\n-            }\n+            } else if (ctx instanceof ServiceRequestContext) {\n+                final ServiceConfig config = ((ServiceRequestContext) ctx).config();\n+                newServiceName = config.defaultServiceName();\n+                if (newServiceName == null) {\n+                    newServiceName = config.route().meterTag();\n+                }\n \n-            if (newName == null && ctx instanceof ServiceRequestContext) {\n-                newName = ((ServiceRequestContext) ctx).config().defaultLogName();\n+                newName = config.defaultLogName();\n+                if (newName == null) {\n+                    newName = ctx.method().name();\n+                }", "originalCommit": "2a48e9aa0a5d1b5b82ffe9755b9d2e1d3b96b137", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzE2NDM4MA==", "url": "https://github.com/line/armeria/pull/2780#discussion_r437164380", "bodyText": "Should we set the fallback serviceName and name for the client side as well?\n\nYes. That was one of the considering points. Let me apply the names to client-side.", "author": "ikhoon", "createdAt": "2020-06-09T06:24:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzE1OTk5Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzE3NTM1Ng==", "url": "https://github.com/line/armeria/pull/2780#discussion_r437175356", "bodyText": "On second thought, there is inconsistency in serviceName:\n\nThe server-side requests use a path pattern for fallback serviceName. (eg. /users/:id)\nThe client-side could not get a path pattern except for Retrofit. Is it good to use a path as a fallback serviceName? (eg. /users/123) \ud83e\uddd0", "author": "ikhoon", "createdAt": "2020-06-09T06:51:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzE1OTk5Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzE5ODM0Mw==", "url": "https://github.com/line/armeria/pull/2780#discussion_r437198343", "bodyText": "How about this:\n\nAdd Service.unwrap() that always unwraps at least once, so that we can get the innermost service instance,\nand then use its class name as the fallback service name\nFor the client-side, how about falling back to authority? \ud83e\udd14", "author": "trustin", "createdAt": "2020-06-09T07:37:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzE1OTk5Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzE5OTUwNA==", "url": "https://github.com/line/armeria/pull/2780#discussion_r437199504", "bodyText": "On second thought, I guess it doesn't make much sense to provide the default service name on the client side except for Retrofit.", "author": "trustin", "createdAt": "2020-06-09T07:40:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzE1OTk5Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzIwMDczOQ==", "url": "https://github.com/line/armeria/pull/2780#discussion_r437200739", "bodyText": "The client-side could not get a path pattern except for Retrofit. Is it good to use a path as a fallback serviceName? (eg. /users/123) \ud83e\uddd0\n\nI don't think so. It will increase the number of tags too much. Sounds like serviceName() should stay nullable, while name() could become non-null. WDYT?", "author": "trustin", "createdAt": "2020-06-09T07:42:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzE1OTk5Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzg3OTExOQ==", "url": "https://github.com/line/armeria/pull/2780#discussion_r437879119", "bodyText": "Sounds like serviceName() should stay nullable, while name() could become non-null. WDYT?\n\nAgreed. It sounds good that serviceName() is nullable in clien-side.\n\nAdd Service.unwrap() that always unwraps at least once, so that we can get the innermost service instance.\n\nThat's a good idea. Let me try it.", "author": "ikhoon", "createdAt": "2020-06-10T06:04:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzE1OTk5Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzE2Mjk5OA==", "url": "https://github.com/line/armeria/pull/2780#discussion_r437162998", "bodyText": "Should we now default serviceTagName to \"service\"? Or do we already?", "author": "trustin", "createdAt": "2020-06-09T06:21:08Z", "path": "retrofit2/src/main/java/com/linecorp/armeria/client/retrofit2/RetrofitMeterIdPrefixFunction.java", "diffHunk": "@@ -107,7 +107,7 @@ private void buildTags(ImmutableList.Builder<Tag> tagListBuilder, RequestOnlyLog\n         if (invocation != null) {\n             if (serviceTagName != null) {\n                 final String service = firstNonNull(serviceName,\n-                                                    invocation.method().getDeclaringClass().getSimpleName());\n+                                                    invocation.method().getDeclaringClass().getName());", "originalCommit": "2a48e9aa0a5d1b5b82ffe9755b9d2e1d3b96b137", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzE2OTc0MQ==", "url": "https://github.com/line/armeria/pull/2780#discussion_r437169741", "bodyText": "We set serviceTagName to \"service\" conditionally.\n\nIf serviceName is null, serviceTagName could be nullable. (Users might not be interested in the service tag)\nIf serviceName is not null, the default name of serviceTagName is \"service\"\n\n\n  \n    \n      armeria/retrofit2/src/main/java/com/linecorp/armeria/client/retrofit2/RetrofitMeterIdPrefixFunction.java\n    \n    \n        Lines 80 to 84\n      in\n      2a48e9a\n    \n    \n    \n    \n\n        \n          \n                                     @Nullable String serviceName) { \n        \n\n        \n          \n           this.name = name; \n        \n\n        \n          \n           this.serviceName = serviceName; \n        \n\n        \n          \n           if (serviceName != null) { \n        \n\n        \n          \n               this.serviceTagName = firstNonNull(serviceTagName, \"service\");", "author": "ikhoon", "createdAt": "2020-06-09T06:38:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzE2Mjk5OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzE5NjQ2OQ==", "url": "https://github.com/line/armeria/pull/2780#discussion_r437196469", "bodyText": "IIRC it was due to backward compatibility. Perhaps it's time to always add service by default? /cc @kojilin @arhont375", "author": "trustin", "createdAt": "2020-06-09T07:34:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzE2Mjk5OA=="}], "type": "inlineReview"}, {"oid": "ffd133d7ba86901ab003ab0d592c693fd7a6a0bd", "url": "https://github.com/line/armeria/commit/ffd133d7ba86901ab003ab0d592c693fd7a6a0bd", "message": "Address comments by @trustin\n\n- Merge RetrofitClassAwareMeterIdPrefixFunction into RetrofitMeterIdPrefixFunction", "committedDate": "2020-06-09T10:01:55Z", "type": "commit"}, {"oid": "dce2678b64e2b5a088152be7101256058cdaa3b4", "url": "https://github.com/line/armeria/commit/dce2678b64e2b5a088152be7101256058cdaa3b4", "message": "Clean up", "committedDate": "2020-06-09T10:03:37Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzg4MTYwMA==", "url": "https://github.com/line/armeria/pull/2780#discussion_r437881600", "bodyText": "In retrospect, I thought the service tag could replace the route tag. However, a service can be bound to multiple paths. Do I need to revive the route tag?", "author": "ikhoon", "createdAt": "2020-06-10T06:12:16Z", "path": "core/src/main/java/com/linecorp/armeria/common/metric/MeterIdPrefixFunction.java", "diffHunk": "@@ -92,24 +92,22 @@ public MeterIdPrefix completeRequestPrefix(MeterRegistry registry, RequestLog lo\n             private void buildTags(ImmutableList.Builder<Tag> tagListBuilder, RequestOnlyLog log) {\n                 final RequestContext ctx = log.context();\n \n-                String methodName = log.name();\n-                if (methodName == null) {\n-                    final RequestHeaders requestHeaders = log.requestHeaders();\n-                    methodName = requestHeaders.method().name();\n-                }\n-\n                 if (ctx instanceof ServiceRequestContext) {\n                     final ServiceRequestContext sCtx = (ServiceRequestContext) ctx;\n                     tagListBuilder.add(Tag.of(Flags.useLegacyMeterNames() ? \"hostnamePattern\"\n                                                                           : \"hostname.pattern\",\n                                               sCtx.config().virtualHost().hostnamePattern()));\n                 }\n \n+                String methodName = log.name();\n+                if (methodName == null) {\n+                    final RequestHeaders requestHeaders = log.requestHeaders();\n+                    methodName = requestHeaders.method().name();\n+                }\n                 tagListBuilder.add(Tag.of(\"method\", methodName));\n-\n-                if (ctx instanceof ServiceRequestContext) {\n-                    final ServiceRequestContext sCtx = (ServiceRequestContext) ctx;\n-                    tagListBuilder.add(Tag.of(\"route\", sCtx.config().route().meterTag()));", "originalCommit": "dce2678b64e2b5a088152be7101256058cdaa3b4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTMxMTYyOA==", "url": "https://github.com/line/armeria/pull/2780#discussion_r441311628", "bodyText": "In that case, a user could specify an alternative defaultServiceName?", "author": "trustin", "createdAt": "2020-06-17T06:35:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzg4MTYwMA=="}], "type": "inlineReview"}, {"oid": "8d22dd7611a39f15e1e8940a8fbef542959ae28c", "url": "https://github.com/line/armeria/commit/8d22dd7611a39f15e1e8940a8fbef542959ae28c", "message": "Address comments by @trustin\n\n- Remove RetrofitMeterIdPrefixFunctionBuilder\n- Refine logName in AccessLog", "committedDate": "2020-06-10T12:45:45Z", "type": "commit"}, {"oid": "24b4ba795365f97282aef7b8d062ac25f08f89f7", "url": "https://github.com/line/armeria/commit/24b4ba795365f97282aef7b8d062ac25f08f89f7", "message": "Clean up", "committedDate": "2020-06-12T03:30:06Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTIxMzA5MQ==", "url": "https://github.com/line/armeria/pull/2780#discussion_r439213091", "bodyText": "Could just append to the previous conditions?\nif (rpcReq != null) {\n    newName = ...\n} else if (ctx instanceof ServiceRequestContext) {\n    newName = ...\n} else {\n    newName = ctx.method().name();\n}", "author": "minwoox", "createdAt": "2020-06-12T05:25:09Z", "path": "core/src/main/java/com/linecorp/armeria/common/logging/DefaultRequestLog.java", "diffHunk": "@@ -918,19 +961,36 @@ private void endRequest0(@Nullable Throwable requestCause, long requestEndTimeNa\n         }\n \n         if (name == null) {\n+            String newServiceName = null;\n             String newName = null;\n-            final RpcRequest rpcReq = ctx.rpcRequest();\n+            RpcRequest rpcReq = ctx.rpcRequest();\n+            if (rpcReq == null && requestContent instanceof RpcRequest) {\n+               rpcReq = (RpcRequest) requestContent;\n+            }\n+\n             if (rpcReq != null) {\n+                newServiceName = rpcReq.serviceType().getName();\n                 newName = rpcReq.method();\n-            } else if (requestContent instanceof RpcRequest) {\n-                newName = ((RpcRequest) requestContent).method();\n+            } else if (ctx instanceof ServiceRequestContext) {\n+                final ServiceConfig config = ((ServiceRequestContext) ctx).config();\n+                newServiceName = config.defaultServiceName();\n+                if (newServiceName == null) {\n+                    newServiceName = config.service().unwrap().getClass().getName();\n+                }\n+                newName = config.defaultLogName();\n             }\n \n-            if (newName == null && ctx instanceof ServiceRequestContext) {\n-                newName = ((ServiceRequestContext) ctx).config().defaultLogName();\n+            if (newName == null) {", "originalCommit": "24b4ba795365f97282aef7b8d062ac25f08f89f7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTQ4ODEzOQ==", "url": "https://github.com/line/armeria/pull/2780#discussion_r439488139", "bodyText": "I don't think so. Because this condition should apply to both service and client context.", "author": "ikhoon", "createdAt": "2020-06-12T15:27:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTIxMzA5MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTIxNDMzMw==", "url": "https://github.com/line/armeria/pull/2780#discussion_r439214333", "bodyText": "Is there any chance that the requestContent is set after endRequest is called?", "author": "minwoox", "createdAt": "2020-06-12T05:29:54Z", "path": "core/src/main/java/com/linecorp/armeria/common/logging/DefaultRequestLog.java", "diffHunk": "@@ -918,19 +961,36 @@ private void endRequest0(@Nullable Throwable requestCause, long requestEndTimeNa\n         }\n \n         if (name == null) {\n+            String newServiceName = null;\n             String newName = null;\n-            final RpcRequest rpcReq = ctx.rpcRequest();\n+            RpcRequest rpcReq = ctx.rpcRequest();\n+            if (rpcReq == null && requestContent instanceof RpcRequest) {", "originalCommit": "24b4ba795365f97282aef7b8d062ac25f08f89f7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTQ4OTg0Mg==", "url": "https://github.com/line/armeria/pull/2780#discussion_r439489842", "bodyText": "That's a good point! Let me check.", "author": "ikhoon", "createdAt": "2020-06-12T15:30:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTIxNDMzMw=="}], "type": "inlineReview"}, {"oid": "20787a1f3c9df8553ce3b1887b5af7c91bc0ad9d", "url": "https://github.com/line/armeria/commit/20787a1f3c9df8553ce3b1887b5af7c91bc0ad9d", "message": "Fix flaky test", "committedDate": "2020-06-12T15:23:13Z", "type": "commit"}, {"oid": "5b8677fe576fcb86cc4967d267b8b32fa922e28b", "url": "https://github.com/line/armeria/commit/5b8677fe576fcb86cc4967d267b8b32fa922e28b", "message": "Address comments by @minwoox / Lazily update name if requestContent is deferred", "committedDate": "2020-06-15T08:30:51Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDA1MjE1Nw==", "url": "https://github.com/line/armeria/pull/2780#discussion_r440052157", "bodyText": "Can't we just call setNamesIfAbsent() if name == null?", "author": "minwoox", "createdAt": "2020-06-15T09:37:48Z", "path": "core/src/main/java/com/linecorp/armeria/common/logging/DefaultRequestLog.java", "diffHunk": "@@ -783,13 +826,22 @@ public void requestContent(@Nullable Object requestContent, @Nullable Object raw\n             return;\n         }\n \n+        int requestCompletionFlags = RequestLogProperty.FLAGS_REQUEST_COMPLETE & ~deferredFlags;\n+        if (needToDeferName() && name == null) {\n+            requestCompletionFlags &= ~RequestLogProperty.NAME.flag();\n+        }\n+\n         this.requestContent = requestContent;\n         this.rawRequestContent = rawRequestContent;\n         updateFlags(RequestLogProperty.REQUEST_CONTENT);\n \n         if (requestContent instanceof RpcRequest && ctx.rpcRequest() == null) {\n             ctx.updateRpcRequest((RpcRequest) requestContent);\n         }\n+\n+        if (isAvailable(requestCompletionFlags)) {\n+            setNamesIfAbsent();", "originalCommit": "5b8677fe576fcb86cc4967d267b8b32fa922e28b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDg2NDQxNw==", "url": "https://github.com/line/armeria/pull/2780#discussion_r440864417", "bodyText": "setNamesIfAbsent() make NAME available. You cannot set names with logBuilder.name(...) even before REQUEST_COMPLETE.\nI intended to give a constant chance of setting names to users before REQUEST_COMPLETE.", "author": "ikhoon", "createdAt": "2020-06-16T13:48:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDA1MjE1Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDA1MjU4Ng==", "url": "https://github.com/line/armeria/pull/2780#discussion_r440052586", "bodyText": "How about checking name == null first because it's cheaper?", "author": "minwoox", "createdAt": "2020-06-15T09:38:30Z", "path": "core/src/main/java/com/linecorp/armeria/common/logging/DefaultRequestLog.java", "diffHunk": "@@ -890,6 +942,10 @@ private void endRequest0(@Nullable Throwable requestCause, long requestEndTimeNa\n         if (requestCause != null) {\n             flags = RequestLogProperty.FLAGS_REQUEST_COMPLETE;\n         } else {\n+            int deferredFlags = this.deferredFlags;\n+            if (needToDeferName() && name == null) {", "originalCommit": "5b8677fe576fcb86cc4967d267b8b32fa922e28b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDcxNzQ1OQ==", "url": "https://github.com/line/armeria/pull/2780#discussion_r440717459", "bodyText": "Should we build the full name lazily?", "author": "trustin", "createdAt": "2020-06-16T09:33:35Z", "path": "core/src/main/java/com/linecorp/armeria/common/logging/DefaultRequestLog.java", "diffHunk": "@@ -685,14 +702,40 @@ public String name() {\n     public void name(String name) {\n         requireNonNull(name, \"name\");\n         checkArgument(!name.isEmpty(), \"name is empty.\");\n+\n+        if (isAvailable(RequestLogProperty.NAME)) {\n+            return;\n+        }\n+\n+        this.name = name;\n+        fullName = name;\n+        updateFlags(RequestLogProperty.NAME);\n+    }\n+\n+    @Override\n+    public void name(String serviceName, String name) {\n+        requireNonNull(serviceName, \"serviceName\");\n+        checkArgument(!serviceName.isEmpty(), \"serviceName is empty.\");\n+        requireNonNull(name, \"name\");\n+        checkArgument(!name.isEmpty(), \"name is empty.\");\n+\n         if (isAvailable(RequestLogProperty.NAME)) {\n             return;\n         }\n \n+        this.serviceName = serviceName;\n         this.name = name;\n+        fullName = serviceName + '/' + name;", "originalCommit": "5b8677fe576fcb86cc4967d267b8b32fa922e28b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDg2Nzc3Nw==", "url": "https://github.com/line/armeria/pull/2780#discussion_r440867777", "bodyText": "Good suggestion! We don't use fullName internally and it is cheap. Don't need to be eager.", "author": "ikhoon", "createdAt": "2020-06-16T13:53:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDcxNzQ1OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDcxOTc3Ng==", "url": "https://github.com/line/armeria/pull/2780#discussion_r440719776", "bodyText": ", which is the concatenation of ... and ... using /", "author": "trustin", "createdAt": "2020-06-16T09:37:29Z", "path": "core/src/main/java/com/linecorp/armeria/common/logging/RequestOnlyLog.java", "diffHunk": "@@ -174,13 +174,29 @@ default long requestDurationNanos() {\n      */\n     Scheme scheme();\n \n+    /**\n+     * Returns the human-readable service name of the {@link Request}, such as RPC service name or\n+     * innermost class name of annotated service. This property is often used as a meter tag or distributed\n+     * trace's span name.\n+     */\n+    @Nullable\n+    String serviceName();\n+\n     /**\n      * Returns the human-readable simple name of the {@link Request}, such as RPC method name or annotated\n      * service method name. This property is often used as a meter tag or distributed trace's span name.\n      */\n     @Nullable\n     String name();\n \n+    /**\n+     * Returns the human-readable full name, which is the combination of {@link #serviceName()} and\n+     * {@link #name()} concatenated with {@code '/'}, of the {@link Request}.", "originalCommit": "5b8677fe576fcb86cc4967d267b8b32fa922e28b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDcyMDI2NQ==", "url": "https://github.com/line/armeria/pull/2780#discussion_r440720265", "bodyText": "How about just unwrapping once, so that the caller has more control?\nCould we describe what will be returned when this is the innermost?", "author": "trustin", "createdAt": "2020-06-16T09:38:13Z", "path": "core/src/main/java/com/linecorp/armeria/common/util/AbstractUnwrappable.java", "diffHunk": "@@ -47,6 +47,22 @@ protected AbstractUnwrappable(T delegate) {\n         return result != null ? result : delegate.as(type);\n     }\n \n+    /**\n+     * Unwraps this {@link AbstractUnwrappable} recursively and returns the innermost object being\n+     * decorated.\n+     */\n+    public Unwrappable unwrap() {", "originalCommit": "5b8677fe576fcb86cc4967d267b8b32fa922e28b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTI4NzMxMQ==", "url": "https://github.com/line/armeria/pull/2780#discussion_r441287311", "bodyText": "Pulled up this method to Unwrappable and delegate() method is deprecated.", "author": "ikhoon", "createdAt": "2020-06-17T05:23:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDcyMDI2NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDcyMTk4MQ==", "url": "https://github.com/line/armeria/pull/2780#discussion_r440721981", "bodyText": "Ditto", "author": "trustin", "createdAt": "2020-06-16T09:41:06Z", "path": "core/src/main/java/com/linecorp/armeria/server/Service.java", "diffHunk": "@@ -76,6 +76,20 @@ default void serviceAdded(ServiceConfig cfg) throws Exception {}\n         return Unwrappable.super.as(type);\n     }\n \n+    /**\n+     * Unwraps this {@link Service} recursively and returns the innermost object being\n+     * decorated. For example:\n+     * <pre>{@code\n+     * HttpService service1 = new MyService();\n+     * HttpService service2 = service1.decorate(LoggingService.newDecorator())\n+     *                                .decorate(AuthService.newDecorator());\n+     * assert service2.unwrap() == service1;\n+     * }</pre>\n+     */\n+    default Service<? extends Request, ? extends Response> unwrap() {\n+        return this;\n+    }", "originalCommit": "5b8677fe576fcb86cc4967d267b8b32fa922e28b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDcyNDAxOA==", "url": "https://github.com/line/armeria/pull/2780#discussion_r440724018", "bodyText": "Question: Should we mention that some service types such as annotated services and RPC services will set the serviceName/name property automatically even if a user doesn't set them?", "author": "trustin", "createdAt": "2020-06-16T09:44:31Z", "path": "core/src/main/java/com/linecorp/armeria/server/ServiceConfig.java", "diffHunk": "@@ -145,9 +150,20 @@ public HttpService service() {\n         return service;\n     }\n \n+    /**\n+     * Returns the default value of the {@link RequestLog#serviceName()} property which is used when\n+     * no service name was set via {@link RequestLogBuilder#name(String, String)}.\n+     * If {@code null}, the path pattern of the {@link #route()} will be used instead.\n+     */\n+    @Nullable\n+    public String defaultServiceName() {\n+        return defaultServiceName;\n+    }\n+\n     /**\n      * Returns the default value of the {@link RequestLog#name()} property which is used when no name was set\n-     * via {@link RequestLogBuilder#name(String)}. If {@code null}, HTTP method name will be used instead.\n+     * via {@link RequestLogBuilder#name(String, String)}. If {@code null}, HTTP method name will be used\n+     * instead.", "originalCommit": "5b8677fe576fcb86cc4967d267b8b32fa922e28b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDcyNTUxOA==", "url": "https://github.com/line/armeria/pull/2780#discussion_r440725518", "bodyText": "Should we also add req.serviceName?", "author": "trustin", "createdAt": "2020-06-16T09:47:03Z", "path": "logback/src/test/java/com/linecorp/armeria/common/logback/RequestContextExportingAppenderTest.java", "diffHunk": "@@ -291,6 +291,7 @@ void testServiceContextWithMinimalLogs() throws Exception {\n                            .containsEntry(\"client.ip\", \"9.10.11.12\")\n                            .containsEntry(\"req.direction\", \"INBOUND\")\n                            .containsEntry(\"req.authority\", \"server.com:8080\")\n+                           .containsEntry(\"req.name\", \"GET\")", "originalCommit": "5b8677fe576fcb86cc4967d267b8b32fa922e28b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTI5NDU4MQ==", "url": "https://github.com/line/armeria/pull/2780#discussion_r441294581", "bodyText": "Oops... definitely.", "author": "ikhoon", "createdAt": "2020-06-17T05:48:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDcyNTUxOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDcyNzA2Ng==", "url": "https://github.com/line/armeria/pull/2780#discussion_r440727066", "bodyText": "So, we're not using a simple name, right?", "author": "trustin", "createdAt": "2020-06-16T09:49:42Z", "path": "core/src/main/java/com/linecorp/armeria/common/logging/DefaultRequestLog.java", "diffHunk": "@@ -917,24 +973,53 @@ private void endRequest0(@Nullable Throwable requestCause, long requestEndTimeNa\n             }\n         }\n \n+        if (!needToDeferName()) {\n+            setNamesIfAbsent();\n+        }\n+        this.requestEndTimeNanos = requestEndTimeNanos;\n+        this.requestCause = requestCause;\n+        updateFlags(flags);\n+    }\n+\n+    private void setNamesIfAbsent() {\n         if (name == null) {\n+            String newServiceName = null;\n             String newName = null;\n-            final RpcRequest rpcReq = ctx.rpcRequest();\n+            RpcRequest rpcReq = ctx.rpcRequest();\n+            if (rpcReq == null && requestContent instanceof RpcRequest) {\n+                rpcReq = (RpcRequest) requestContent;\n+            }\n+\n             if (rpcReq != null) {\n+                newServiceName = rpcReq.serviceType().getName();\n                 newName = rpcReq.method();\n-            } else if (requestContent instanceof RpcRequest) {\n-                newName = ((RpcRequest) requestContent).method();\n+            } else if (ctx instanceof ServiceRequestContext) {\n+                final ServiceConfig config = ((ServiceRequestContext) ctx).config();\n+                newServiceName = config.defaultServiceName();\n+                if (newServiceName == null) {\n+                    newServiceName = config.service().unwrap().getClass().getName();", "originalCommit": "5b8677fe576fcb86cc4967d267b8b32fa922e28b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTI4ODc2OQ==", "url": "https://github.com/line/armeria/pull/2780#discussion_r441288769", "bodyText": "Yes, because the serviceName of gRPC is FQCN. Therefore I think we are using FQCN for serviceName except for access logs.", "author": "ikhoon", "createdAt": "2020-06-17T05:28:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDcyNzA2Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTMwNjg3OQ==", "url": "https://github.com/line/armeria/pull/2780#discussion_r441306879", "bodyText": "Cool. Thanks.", "author": "trustin", "createdAt": "2020-06-17T06:23:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDcyNzA2Ng=="}], "type": "inlineReview"}, {"oid": "bdb5d45b1182051e83146cfe427279fee5c5dfbd", "url": "https://github.com/line/armeria/commit/bdb5d45b1182051e83146cfe427279fee5c5dfbd", "message": "Address comments @trustin, @minwoox / Add unwrap() to Unwrappable", "committedDate": "2020-06-17T05:12:34Z", "type": "commit"}, {"oid": "9375e28ff7b67272434088ce93e5c88b14e2267f", "url": "https://github.com/line/armeria/commit/9375e28ff7b67272434088ce93e5c88b14e2267f", "message": "Add 'req.serviceName'", "committedDate": "2020-06-17T05:44:49Z", "type": "commit"}, {"oid": "6fca062194ac03af6c152cbbe85e2928b56d0717", "url": "https://github.com/line/armeria/commit/6fca062194ac03af6c152cbbe85e2928b56d0717", "message": "Update documentation and Fix broken test", "committedDate": "2020-06-17T07:20:05Z", "type": "commit"}, {"oid": "55fa074b918fb986dd05bb2a0d129b44b48e7ea9", "url": "https://github.com/line/armeria/commit/55fa074b918fb986dd05bb2a0d129b44b48e7ea9", "message": "Fix Javdoc", "committedDate": "2020-06-17T07:34:24Z", "type": "commit"}, {"oid": "a4a2bc8608b1e360c2192446c9fc2cb0feb0a2ff", "url": "https://github.com/line/armeria/commit/a4a2bc8608b1e360c2192446c9fc2cb0feb0a2ff", "message": "Clean up", "committedDate": "2020-06-17T07:49:58Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTQzMzc5MQ==", "url": "https://github.com/line/armeria/pull/2780#discussion_r441433791", "bodyText": "nit: service name?", "author": "minwoox", "createdAt": "2020-06-17T10:06:12Z", "path": "core/src/main/java/com/linecorp/armeria/common/logging/BuiltInProperty.java", "diffHunk": "@@ -167,10 +168,28 @@\n      */\n     REQ_METHOD(\"req.method\", log -> log.context().method().name()),\n     /**\n-     * {@code \"req.name\"} - the human-readable name of the request, such as RPC method name or annotated\n-     * service method name. This property is often used as a meter tag or distributed trace's span name.\n+     * {@code \"req.name\"} - the human-readable name of the request, such as:\n+     * <ul>\n+     *   <li>gRPC - A capitalized method name defined in {@code io.grpc.MethodDescriptor}\n+     *       (e.g, {@code GetItems})</li>\n+     *   <li>Thrift and annotated service - a method name (e.g, {@code getItems})</li>\n+     *   <li>{@link HttpService} - an HTTP method name</li>\n+     * </ul>\n+     * This property is often used as a meter tag or distributed trace's span name.\n      */\n     REQ_NAME(\"req.name\", log -> log.isAvailable(RequestLogProperty.NAME) ? log.name() : null),\n+    /**\n+     * {@code \"req.serviceName\"} - the human-readable name of the request, such as:", "originalCommit": "a4a2bc8608b1e360c2192446c9fc2cb0feb0a2ff", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTUwMTY0NQ==", "url": "https://github.com/line/armeria/pull/2780#discussion_r441501645", "bodyText": "... name of the service that served the request, ...", "author": "trustin", "createdAt": "2020-06-17T12:20:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTQzMzc5MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTQzNzcwNw==", "url": "https://github.com/line/armeria/pull/2780#discussion_r441437707", "bodyText": "revert?", "author": "minwoox", "createdAt": "2020-06-17T10:13:03Z", "path": "retrofit2/src/test/java/com/linecorp/armeria/client/retrofit2/RetrofitMeterIdPrefixFunctionTest.java", "diffHunk": "@@ -1,7 +1,7 @@\n /*\n  * Copyright 2019 LINE Corporation\n  *\n- * LINE Corporation licenses this file to you under the Apache License,\n+ * LINE Corporation licenses this file to you under the Apache License)", "originalCommit": "a4a2bc8608b1e360c2192446c9fc2cb0feb0a2ff", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "e3982e443cfae513c26caffb2393c27cbc5a0674", "url": "https://github.com/line/armeria/commit/e3982e443cfae513c26caffb2393c27cbc5a0674", "message": "Clean up Javadoc and remove dead code", "committedDate": "2020-06-17T15:34:49Z", "type": "commit"}, {"oid": "a034160ef26e2c0693b6d29108fd4c51aeee0ee4", "url": "https://github.com/line/armeria/commit/a034160ef26e2c0693b6d29108fd4c51aeee0ee4", "message": "Clean Javadoc 2", "committedDate": "2020-06-17T15:44:08Z", "type": "commit"}, {"oid": "9ca6c8137f23d0dea7c43ebed23db5984efff272", "url": "https://github.com/line/armeria/commit/9ca6c8137f23d0dea7c43ebed23db5984efff272", "message": "Merge branch 'master' into service-name", "committedDate": "2020-06-18T06:06:33Z", "type": "commit"}]}