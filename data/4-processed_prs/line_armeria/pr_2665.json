{"pr_number": 2665, "pr_title": "Make DNS resolver handle timeout correctly when querying AAAA & A\u2026", "pr_createdAt": "2020-04-15T15:43:17Z", "pr_url": "https://github.com/line/armeria/pull/2665", "timeline": [{"oid": "0eeffcdc8d537c03e998d4b7d8c1fada5fce5cc5", "url": "https://github.com/line/armeria/commit/0eeffcdc8d537c03e998d4b7d8c1fada5fce5cc5", "message": "Make DNS Resolver can handle timeout correctly when querying AAAA & A record at same time\n\nIf one of the dns query timeout when resolver send A/AAAA queries, resolver will have IllegalStateException internally and return DnsTimeoutException. Resolver should return correct one instead of return error.\n\nModifications:\n* Using tryFailure instead of cancel when timeout, and let callback decide the exception type.\n* Make result follow the preferred order", "committedDate": "2020-04-15T15:44:09Z", "type": "commit"}, {"oid": "0eeffcdc8d537c03e998d4b7d8c1fada5fce5cc5", "url": "https://github.com/line/armeria/commit/0eeffcdc8d537c03e998d4b7d8c1fada5fce5cc5", "message": "Make DNS Resolver can handle timeout correctly when querying AAAA & A record at same time\n\nIf one of the dns query timeout when resolver send A/AAAA queries, resolver will have IllegalStateException internally and return DnsTimeoutException. Resolver should return correct one instead of return error.\n\nModifications:\n* Using tryFailure instead of cancel when timeout, and let callback decide the exception type.\n* Make result follow the preferred order", "committedDate": "2020-04-15T15:44:09Z", "type": "forcePushed"}, {"oid": "35963f486fe4645d3d2931db9e2c13ca74e65131", "url": "https://github.com/line/armeria/commit/35963f486fe4645d3d2931db9e2c13ca74e65131", "message": "Using multiple dns server to enlarge netty timeout.", "committedDate": "2020-04-16T01:15:44Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTIyNzM0NQ==", "url": "https://github.com/line/armeria/pull/2665#discussion_r409227345", "bodyText": "We should cancel the promise to stop sending DNS queries internally. https://github.com/netty/netty/pull/10171/files#diff-6107a6de600a6f941beb29f082976653R357\nIs there any reason that DnsTimeoutException shouldn't be propagated to the caller?", "author": "minwoox", "createdAt": "2020-04-16T01:28:17Z", "path": "core/src/main/java/com/linecorp/armeria/internal/client/DefaultDnsNameResolver.java", "diffHunk": "@@ -140,9 +148,8 @@ private void configureTimeout(List<DnsQuestion> questions, String logPrefix,\n             final DnsTimeoutException exception = new DnsTimeoutException(\n                     '[' + logPrefix + \"] \" + questions + \" are timed out after \" +\n                     queryTimeoutMillis + \" milliseconds.\");\n-            result.setFailure(exception);\n             promises.forEach(promise -> {\n-                promise.cancel(true);", "originalCommit": "35963f486fe4645d3d2931db9e2c13ca74e65131", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTIzMzk5MA==", "url": "https://github.com/line/armeria/pull/2665#discussion_r409233990", "bodyText": "Thank you, didn't aware that PR^^.\nI change back to cancel, one reason I delete DnsTimeoutException in here is that it will trigger operationComplete with CancellationException.\nWhen we have A & AAAA queries, we may have A query success but AAAA query failed, it will call aggregatedPromise.setSuccess and throws IllegalStateException if we set DnsTimeoutException here. So I move the DnsTimeoutException to operationComplete.\nBut to follow prefer, it's good to treat it as successful when one of the queries succeed?", "author": "kojilin", "createdAt": "2020-04-16T01:52:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTIyNzM0NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTI1ODY2Mg==", "url": "https://github.com/line/armeria/pull/2665#discussion_r409258662", "bodyText": "Then how about just using try(Success|failure)? Becuase we can't be sure that the CancellationException is triggered by our side. (i.e. DnsNameResolver could cancel it internally)", "author": "minwoox", "createdAt": "2020-04-16T03:24:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTIyNzM0NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTI2MzE5NQ==", "url": "https://github.com/line/armeria/pull/2665#discussion_r409263195", "bodyText": "Curious you mean tryFailure instead of canceling? or make listener using  try(Success|failure)?", "author": "kojilin", "createdAt": "2020-04-16T03:43:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTIyNzM0NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTI2MzUyOA==", "url": "https://github.com/line/armeria/pull/2665#discussion_r409263528", "bodyText": "or make listener using try(Success|failure)?\n\nYes, that's what I meant. \ud83d\ude04", "author": "minwoox", "createdAt": "2020-04-16T03:44:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTIyNzM0NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTI2MzgyMA==", "url": "https://github.com/line/armeria/pull/2665#discussion_r409263820", "bodyText": "But then, we always return DnsTimeoutException even one of A/AAAA is succeed.\nMaybe ok, but it means we may need to encourage the user to enlarge the timeout mills to avoid the problem if the target host only has one of A/AAAA.\nLet me check if I can make it ^^;;", "author": "kojilin", "createdAt": "2020-04-16T03:45:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTIyNzM0NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTI2NTM3Nw==", "url": "https://github.com/line/armeria/pull/2665#discussion_r409265377", "bodyText": "Yes, as you said, if the query succeeded after the timeout, we are still going to get timeout, but I think it's ok. \ud83d\ude04", "author": "minwoox", "createdAt": "2020-04-16T03:52:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTIyNzM0NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTI3Mjc0OQ==", "url": "https://github.com/line/armeria/pull/2665#discussion_r409272749", "bodyText": "I mean one of the query succeeds before timeout, e.g. A is before timeout and AAAA is timeout.\nNow I change to check if all of the query promises are done or not.", "author": "kojilin", "createdAt": "2020-04-16T04:21:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTIyNzM0NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTM2Nzc3MQ==", "url": "https://github.com/line/armeria/pull/2665#discussion_r409367771", "bodyText": "I mean one of the query succeeds before timeout, e.g. A is before timeout and AAAA is timeout.\n\nAh, I completely missed that. Thanks!", "author": "minwoox", "createdAt": "2020-04-16T08:16:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTIyNzM0NQ=="}], "type": "inlineReview"}, {"oid": "def295079ba06926218c11b41c77c06f38b42f10", "url": "https://github.com/line/armeria/commit/def295079ba06926218c11b41c77c06f38b42f10", "message": "Using cancel mechanism to cancel dns query correctly.", "committedDate": "2020-04-16T01:50:10Z", "type": "commit"}, {"oid": "92cf4c82566360b8539fe3d81fb730ffe453c37c", "url": "https://github.com/line/armeria/commit/92cf4c82566360b8539fe3d81fb730ffe453c37c", "message": "nit", "committedDate": "2020-04-16T01:59:07Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTI1ODIzMg==", "url": "https://github.com/line/armeria/pull/2665#discussion_r409258232", "bodyText": "Thanks for this!", "author": "minwoox", "createdAt": "2020-04-16T03:23:22Z", "path": "core/src/main/java/com/linecorp/armeria/internal/client/DefaultDnsNameResolver.java", "diffHunk": "@@ -96,12 +89,22 @@ public void operationComplete(Future<List<DnsRecord>> future) throws Exception {\n \n                 if (--remaining == 0) {\n                     if (!records.isEmpty()) {\n+                        if (records.size() > 1) {\n+                            final List<DnsRecordType> preferredOrder =\n+                                    questions.stream().map(DnsRecord::type).collect(toImmutableList());\n+                            records.sort(Comparator.comparingInt(\n+                                    record -> preferredOrder.indexOf(record.type())));", "originalCommit": "92cf4c82566360b8539fe3d81fb730ffe453c37c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTI2MTc1NA==", "url": "https://github.com/line/armeria/pull/2665#discussion_r409261754", "bodyText": "I think we always have a fixed set of types, so since this is an internal class we could pass them to the constructor and only do this once. Can also use Ordering.explicit", "author": "anuraaga", "createdAt": "2020-04-16T03:37:34Z", "path": "core/src/main/java/com/linecorp/armeria/internal/client/DefaultDnsNameResolver.java", "diffHunk": "@@ -96,12 +89,22 @@ public void operationComplete(Future<List<DnsRecord>> future) throws Exception {\n \n                 if (--remaining == 0) {\n                     if (!records.isEmpty()) {\n+                        if (records.size() > 1) {\n+                            final List<DnsRecordType> preferredOrder =", "originalCommit": "92cf4c82566360b8539fe3d81fb730ffe453c37c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "539d487865180e5fba88fabc114c6b949064f9a4", "url": "https://github.com/line/armeria/commit/539d487865180e5fba88fabc114c6b949064f9a4", "message": "Follow the suggestion", "committedDate": "2020-04-16T04:18:12Z", "type": "commit"}, {"oid": "363bad0b1950dd565494f8c94e07ea90ece26580", "url": "https://github.com/line/armeria/commit/363bad0b1950dd565494f8c94e07ea90ece26580", "message": "Reduce explicit representation of Guava Ordering.", "committedDate": "2020-04-16T04:34:40Z", "type": "commit"}, {"oid": "4274a77ff280e9d99f0fedadf512f62eb6846708", "url": "https://github.com/line/armeria/commit/4274a77ff280e9d99f0fedadf512f62eb6846708", "message": "nit", "committedDate": "2020-04-16T04:48:36Z", "type": "commit"}]}