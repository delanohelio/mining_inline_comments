{"pr_number": 3171, "pr_title": "Add advanced-metrics docs to web site", "pr_createdAt": "2020-11-11T11:09:52Z", "pr_url": "https://github.com/line/armeria/pull/3171", "timeline": [{"oid": "dffb5063bf58eab091c5d6ac668d7dd0b71ef635", "url": "https://github.com/line/armeria/commit/dffb5063bf58eab091c5d6ac668d7dd0b71ef635", "message": "Add advanced-metrics docs to web site", "committedDate": "2020-11-11T11:09:30Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTc4MjM4OQ==", "url": "https://github.com/line/armeria/pull/3171#discussion_r521782389", "bodyText": "Global comment: Please break the line if the line length exceeds 112.", "author": "ikhoon", "createdAt": "2020-11-12T02:43:55Z", "path": "site/src/pages/docs/advanced-metrics.mdx", "diffHunk": "@@ -0,0 +1,73 @@\n+# Collecting metrics\n+\n+Armeria has built-in support for collecting metrics both on the server and client side. This page describes how to enable this.\n+\n+The metric data is collected using the [Micrometer](https://micrometer.io/) library. Please consult its documentation for information on how to expose the collected metrics to various monitoring systems (JMX, Prometheus, etc)", "originalCommit": "dffb5063bf58eab091c5d6ac668d7dd0b71ef635", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzk3MDc4Nw==", "url": "https://github.com/line/armeria/pull/3171#discussion_r523970787", "bodyText": "How about:\n... systems, such as [Prometheus](...), [Dropwizard Metrics](...) and [Datadog](...).", "author": "trustin", "createdAt": "2020-11-16T08:35:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTc4MjM4OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTc4MjY3Ng==", "url": "https://github.com/line/armeria/pull/3171#discussion_r521782676", "bodyText": "Could use <type://ServerBuilder.meterRegistry()> instead of meterRegistry()", "author": "ikhoon", "createdAt": "2020-11-12T02:44:50Z", "path": "site/src/pages/docs/advanced-metrics.mdx", "diffHunk": "@@ -0,0 +1,73 @@\n+# Collecting metrics\n+\n+Armeria has built-in support for collecting metrics both on the server and client side. This page describes how to enable this.\n+\n+The metric data is collected using the [Micrometer](https://micrometer.io/) library. Please consult its documentation for information on how to expose the collected metrics to various monitoring systems (JMX, Prometheus, etc)\n+\n+## Collecting server-side metrics (gRPC)\n+\n+```java\n+import com.linecorp.armeria.common.grpc.GrpcMeterIdPrefixFunction;\n+import com.linecorp.armeria.server.Server;\n+import com.linecorp.armeria.server.ServerBuilder;\n+import com.linecorp.armeria.server.grpc.GrpcService;\n+import com.linecorp.armeria.server.metric.MetricCollectingService;\n+\n+ServerBuilder serverBuilder = Server.builder()\n+        .http(new InetSocketAddress(address, port))\n+        .service(\n+                GrpcService.builder()\n+                        .addService(new MyHelloService())\n+                        .build()\n+        )\n+        .decorator(MetricCollectingService.newDecorator(\n+                GrpcMeterIdPrefixFunction.of(\"my.service\"))\n+        );\n+```\n+\n+In cases where more sophisticated filtering and/or mangling of the generated metrics are required, you can use the `meterRegistry()` method like this:", "originalCommit": "dffb5063bf58eab091c5d6ac668d7dd0b71ef635", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTc4Mjc5OA==", "url": "https://github.com/line/armeria/pull/3171#discussion_r521782798", "bodyText": "nit: Intent?\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            GrpcService.builder()\n          \n          \n            \n                                    .addService(new MyHelloService())\n          \n          \n            \n                                    .build()\n          \n          \n            \n                            GrpcService.builder()\n          \n          \n            \n                                       .addService(new MyHelloService())\n          \n          \n            \n                                       .build()", "author": "ikhoon", "createdAt": "2020-11-12T02:45:19Z", "path": "site/src/pages/docs/advanced-metrics.mdx", "diffHunk": "@@ -0,0 +1,73 @@\n+# Collecting metrics\n+\n+Armeria has built-in support for collecting metrics both on the server and client side. This page describes how to enable this.\n+\n+The metric data is collected using the [Micrometer](https://micrometer.io/) library. Please consult its documentation for information on how to expose the collected metrics to various monitoring systems (JMX, Prometheus, etc)\n+\n+## Collecting server-side metrics (gRPC)\n+\n+```java\n+import com.linecorp.armeria.common.grpc.GrpcMeterIdPrefixFunction;\n+import com.linecorp.armeria.server.Server;\n+import com.linecorp.armeria.server.ServerBuilder;\n+import com.linecorp.armeria.server.grpc.GrpcService;\n+import com.linecorp.armeria.server.metric.MetricCollectingService;\n+\n+ServerBuilder serverBuilder = Server.builder()\n+        .http(new InetSocketAddress(address, port))\n+        .service(\n+                GrpcService.builder()\n+                        .addService(new MyHelloService())\n+                        .build()", "originalCommit": "dffb5063bf58eab091c5d6ac668d7dd0b71ef635", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTc4MzE3NA==", "url": "https://github.com/line/armeria/pull/3171#discussion_r521783174", "bodyText": "How about this style for readability?\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            ServerBuilder serverBuilder = Server.builder()\n          \n          \n            \n                    .http(new InetSocketAddress(address, port))\n          \n          \n            \n                    .service(\n          \n          \n            \n            ServerBuilder serverBuilder = \n          \n          \n            \n                    Server.builder()\n          \n          \n            \n                          .http(new InetSocketAddress(address, port))\n          \n          \n            \n                          .service(", "author": "ikhoon", "createdAt": "2020-11-12T02:46:45Z", "path": "site/src/pages/docs/advanced-metrics.mdx", "diffHunk": "@@ -0,0 +1,73 @@\n+# Collecting metrics\n+\n+Armeria has built-in support for collecting metrics both on the server and client side. This page describes how to enable this.\n+\n+The metric data is collected using the [Micrometer](https://micrometer.io/) library. Please consult its documentation for information on how to expose the collected metrics to various monitoring systems (JMX, Prometheus, etc)\n+\n+## Collecting server-side metrics (gRPC)\n+\n+```java\n+import com.linecorp.armeria.common.grpc.GrpcMeterIdPrefixFunction;\n+import com.linecorp.armeria.server.Server;\n+import com.linecorp.armeria.server.ServerBuilder;\n+import com.linecorp.armeria.server.grpc.GrpcService;\n+import com.linecorp.armeria.server.metric.MetricCollectingService;\n+\n+ServerBuilder serverBuilder = Server.builder()\n+        .http(new InetSocketAddress(address, port))\n+        .service(", "originalCommit": "dffb5063bf58eab091c5d6ac668d7dd0b71ef635", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDkxOTU1OQ==", "url": "https://github.com/line/armeria/pull/3171#discussion_r524919559", "bodyText": "Can do. The main problem I have with the above is that I cannot auto-format the code (using IntelliJ) to it. Is there an .editorconfig or similar that can help me with that?", "author": "perlun", "createdAt": "2020-11-17T06:53:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTc4MzE3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTEyNzk5Ng==", "url": "https://github.com/line/armeria/pull/3171#discussion_r525127996", "bodyText": "Armeria does not have .editorconfig because\n\nFor Java, use checkstyle and a custom formatter\nFor Typescript, use eslintrc\n\nIntelliJ supports MDX plugin since 2020.2 version. However, the plugin cannot not format code block automatically.\nI think it needs a human touch at the monment. If you don't mind, I can help your code format instead of a machine before merging this PR. \ud83d\ude09", "author": "ikhoon", "createdAt": "2020-11-17T12:48:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTc4MzE3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTYzMTE2Mg==", "url": "https://github.com/line/armeria/pull/3171#discussion_r525631162", "bodyText": "Oh we have a plan to add it.\n#3164 (comment)", "author": "minwoox", "createdAt": "2020-11-18T01:15:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTc4MzE3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTg2NjI5Nw==", "url": "https://github.com/line/armeria/pull/3171#discussion_r525866297", "bodyText": "@ikhoon Yes, feel free to add a commit that fixes the code formatting, wouldn't mind.", "author": "perlun", "createdAt": "2020-11-18T07:32:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTc4MzE3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTk0Mjc2MA==", "url": "https://github.com/line/armeria/pull/3171#discussion_r525942760", "bodyText": "Sure, I will format the code of this documentation when other comments are addressed.", "author": "ikhoon", "createdAt": "2020-11-18T09:38:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTc4MzE3NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTc4MzQzOQ==", "url": "https://github.com/line/armeria/pull/3171#discussion_r521783439", "bodyText": "Coul use <type://ClientFactory>", "author": "ikhoon", "createdAt": "2020-11-12T02:47:47Z", "path": "site/src/pages/docs/advanced-metrics.mdx", "diffHunk": "@@ -0,0 +1,73 @@\n+# Collecting metrics\n+\n+Armeria has built-in support for collecting metrics both on the server and client side. This page describes how to enable this.\n+\n+The metric data is collected using the [Micrometer](https://micrometer.io/) library. Please consult its documentation for information on how to expose the collected metrics to various monitoring systems (JMX, Prometheus, etc)\n+\n+## Collecting server-side metrics (gRPC)\n+\n+```java\n+import com.linecorp.armeria.common.grpc.GrpcMeterIdPrefixFunction;\n+import com.linecorp.armeria.server.Server;\n+import com.linecorp.armeria.server.ServerBuilder;\n+import com.linecorp.armeria.server.grpc.GrpcService;\n+import com.linecorp.armeria.server.metric.MetricCollectingService;\n+\n+ServerBuilder serverBuilder = Server.builder()\n+        .http(new InetSocketAddress(address, port))\n+        .service(\n+                GrpcService.builder()\n+                        .addService(new MyHelloService())\n+                        .build()\n+        )\n+        .decorator(MetricCollectingService.newDecorator(\n+                GrpcMeterIdPrefixFunction.of(\"my.service\"))\n+        );\n+```\n+\n+In cases where more sophisticated filtering and/or mangling of the generated metrics are required, you can use the `meterRegistry()` method like this:\n+\n+```java\n+ServerBuilder serverBuilder = Server.builder()\n+        // ...\n+        .meterRegistry(myMeterRegistry);\n+```\n+\n+## Collecting client-side metrics (gRPC)\n+\n+This approach can used to collect metrics in a gRPC client:\n+\n+```java\n+import com.linecorp.armeria.client.ClientOptions;\n+import com.linecorp.armeria.client.Clients;\n+import com.linecorp.armeria.client.metric.MetricCollectingClient;\n+import com.linecorp.armeria.common.grpc.GrpcMeterIdPrefixFunction;\n+\n+return Clients.builder(grpcUrl)\n+        .options(\n+                ClientOptions.builder()\n+                        .decorator(\n+                                MetricCollectingClient.newDecorator(\n+                                        GrpcMeterIdPrefixFunction.of(\"my.client\")\n+                                )\n+                        )\n+                        .build()\n+        )\n+        .build(HelloServiceBlockingStub.class);\n+```\n+\n+Like with the server-side metrics described above, certain scenarios might require you to provide a custom meter registry. To accomplish this, override the `ClientFactory` in this way:", "originalCommit": "dffb5063bf58eab091c5d6ac668d7dd0b71ef635", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTc4NDI1Ng==", "url": "https://github.com/line/armeria/pull/3171#discussion_r521784256", "bodyText": "If you don't mind, could you also add an example of an HTTP service that uses MeterIdPrefixFunction?", "author": "ikhoon", "createdAt": "2020-11-12T02:50:44Z", "path": "site/src/pages/docs/advanced-metrics.mdx", "diffHunk": "@@ -0,0 +1,73 @@\n+# Collecting metrics\n+\n+Armeria has built-in support for collecting metrics both on the server and client side. This page describes how to enable this.\n+\n+The metric data is collected using the [Micrometer](https://micrometer.io/) library. Please consult its documentation for information on how to expose the collected metrics to various monitoring systems (JMX, Prometheus, etc)\n+\n+## Collecting server-side metrics (gRPC)", "originalCommit": "dffb5063bf58eab091c5d6ac668d7dd0b71ef635", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDkxOTc1NQ==", "url": "https://github.com/line/armeria/pull/3171#discussion_r524919755", "bodyText": "Yep, I could give that a try. \ud83d\udc4d", "author": "perlun", "createdAt": "2020-11-17T06:53:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTc4NDI1Ng=="}], "type": "inlineReview"}, {"oid": "30fe0a02188566706f72e7b8ae80b46b2190ca94", "url": "https://github.com/line/armeria/commit/30fe0a02188566706f72e7b8ae80b46b2190ca94", "message": "Add HTTP service and client example", "committedDate": "2020-11-25T09:37:59Z", "type": "commit"}, {"oid": "b30a23d7a5779ef1b85e4054f369c006b34a3fff", "url": "https://github.com/line/armeria/commit/b30a23d7a5779ef1b85e4054f369c006b34a3fff", "message": "Add filter and config section", "committedDate": "2020-11-25T10:41:29Z", "type": "commit"}, {"oid": "d10a8ad151f554d02cf1c8187394c6f61fdc20b6", "url": "https://github.com/line/armeria/commit/d10a8ad151f554d02cf1c8187394c6f61fdc20b6", "message": "clean up", "committedDate": "2020-11-25T12:36:43Z", "type": "forcePushed"}, {"oid": "a994871c5f1eb3967695e2d9d9cc40c416d56b9e", "url": "https://github.com/line/armeria/commit/a994871c5f1eb3967695e2d9d9cc40c416d56b9e", "message": "clean up", "committedDate": "2020-11-25T12:40:22Z", "type": "forcePushed"}, {"oid": "95c12039e0c8e678abf685580cf34352c2fd6f71", "url": "https://github.com/line/armeria/commit/95c12039e0c8e678abf685580cf34352c2fd6f71", "message": "clean up", "committedDate": "2020-11-25T12:45:51Z", "type": "commit"}, {"oid": "95c12039e0c8e678abf685580cf34352c2fd6f71", "url": "https://github.com/line/armeria/commit/95c12039e0c8e678abf685580cf34352c2fd6f71", "message": "clean up", "committedDate": "2020-11-25T12:45:51Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDgwNzU1Mg==", "url": "https://github.com/line/armeria/pull/3171#discussion_r530807552", "bodyText": "Inline PERCENTILES?", "author": "trustin", "createdAt": "2020-11-26T06:57:47Z", "path": "site/src/pages/docs/advanced-metrics.mdx", "diffHunk": "@@ -0,0 +1,158 @@\n+# Collecting metrics\n+\n+Armeria has built-in support for collecting metrics both on the server and client side.\n+This page describes how to enable this.\n+\n+<Tip>\n+\n+The metric data is collected using the [Micrometer](https://micrometer.io/) library.\n+Please consult its documentation for information on how to expose the collected metrics to\n+various monitoring systems such as [Prometheus](https://prometheus.io/), \n+[Dropwizard Metrics](https://metrics.dropwizard.io/4.1.2/) and [Datadog](https://www.datadoghq.com/).\n+\n+</Tip>\n+\n+## Collecting server-side metrics\n+\n+You can use <type://MetricCollectingService> with <type://MeterIdPrefixFunction> for collecting metrics\n+of your services.\n+\n+```java\n+import com.linecorp.armeria.common.MeterIdPrefixFunction;\n+import com.linecorp.armeria.server.Server;\n+import com.linecorp.armeria.server.ServerBuilder;\n+import com.linecorp.armeria.server.metric.MetricCollectingService;\n+\n+Server.builder()\n+      .http(new InetSocketAddress(address, port))\n+      .service(new MyHttpService())\n+      .decorator(MetricCollectingService.newDecorator(\n+              MeterIdPrefixFunction.ofDefault(\"http.service\")))\n+      .build();\n+```\n+\n+If you are interested in monitoring [gRPC status](https://grpc.github.io/grpc/core/md_doc_statuscodes.html)\n+for a gRPC service, you can use <type://GrpcMeterIdPrefixFunction> instead of <type://MeterIdPrefixFunction>.\n+\n+```java\n+import com.linecorp.armeria.common.grpc.GrpcMeterIdPrefixFunction;\n+import com.linecorp.armeria.server.grpc.GrpcService;\n+\n+Server.builder()\n+      .http(new InetSocketAddress(address, port))\n+      .service(GrpcService.builder()\n+                          .addService(new MyHelloService())\n+                          .build())\n+      .decorator(MetricCollectingService.newDecorator(\n+              GrpcMeterIdPrefixFunction.of(\"grpc.service\")))\n+      .build();\n+```\n+\n+In cases where more sophisticated filtering and/or mangling of the generated metrics are required,\n+you can use the <type://ServerBuilder#meterRegistry(MeterRegistry)> method like this:\n+\n+```java\n+Server.builder()\n+      // ...\n+      .meterRegistry(myMeterRegistry);\n+```\n+\n+## Collecting client-side metrics\n+\n+This approach can used to collect metrics in a <type://WebClient> and a gRPC client:\n+\n+```java\n+import com.linecorp.armeria.client.Clients;\n+import com.linecorp.armeria.client.WebClient;\n+import com.linecorp.armeria.client.metric.MetricCollectingClient;\n+\n+// Decorate a WebClient with MetricCollectingClient\n+WebClient.builder(httpUrl)\n+         .decorator(MetricCollectingClient.newDecorator(\n+                 MeterIdPrefixFunction.ofDefault(\"http.client\")))\n+         .build();\n+\n+// Decorate a gRPC client with MetricCollectingClient\n+Clients.builder(grpcUrl)\n+       .decorator(MetricCollectingClient.newDecorator(\n+               GrpcMeterIdPrefixFunction.of(\"grpc.client\")))\n+       .build(HelloServiceBlockingStub.class);\n+```\n+\n+Like with the server-side metrics described above, certain scenarios might require you to \n+provide a custom meter registry. To accomplish this, override the <type://ClientFactory> in this way:\n+\n+```java\n+import com.linecorp.armeria.client.ClientFactory;\n+import com.linecorp.armeria.client.Clients;\n+\n+ClientFactory clientFactory = \n+      ClientFactory.builder()\n+                   .meterRegistry(myMeterRegistry)\n+                   .build();\n+                   \n+// Set a cumster ClientFactory to a WebClient                   \n+WebClient.builder(httpUrl)\n+         .factory(clientFactory)\n+          // ...\n+         .build();\n+\n+// Set a cumster ClientFactory to a gRPC client\n+Clients.builder(grpcUrl)\n+       .factory(clientFactory)\n+        // ...\n+       .build(HelloServiceBlockingStub.class);\n+```\n+\n+## Changing the default distribution summary config\n+\n+A [distribution summary](https://micrometer.io/docs/concepts#_distribution_summaries) is used to track \n+the distribution of events. Armeria provides a sensible default\n+[DistributionStatisticConfig](https://javadoc.io/doc/io.micrometer/micrometer-core/latest/io/micrometer/core/instrument/distribution/DistributionStatisticConfig.html)\n+for measuring the following metrics:\n+- A length of the request content\n+- A length of the response content\n+- A duration of request\n+- A duration of response\n+\n+If you want to override the default config,\n+you can set your own `DistributionStatisticConfig` using <type://MoreMeters#setDistributionStatisticConfig(DistributionStatisticConfig)>.\n+\n+```java\n+import io.micrometer.core.instrument.distribution.DistributionStatisticConfig;\n+\n+DistributionStatisticConfig myDistStatCfg =\n+        DistributionStatisticConfig.builder()\n+                                  .percentilesHistogram(false)\n+                                  .sla()\n+                                  .percentiles(PERCENTILES)", "originalCommit": "95c12039e0c8e678abf685580cf34352c2fd6f71", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTM3MTUxMA==", "url": "https://github.com/line/armeria/pull/3171#discussion_r531371510", "bodyText": "Oops..", "author": "ikhoon", "createdAt": "2020-11-27T04:01:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDgwNzU1Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDgwNzg4OA==", "url": "https://github.com/line/armeria/pull/3171#discussion_r530807888", "bodyText": "How about using Metrics.globalRegistry?", "author": "trustin", "createdAt": "2020-11-26T06:58:40Z", "path": "site/src/pages/docs/advanced-metrics.mdx", "diffHunk": "@@ -0,0 +1,158 @@\n+# Collecting metrics\n+\n+Armeria has built-in support for collecting metrics both on the server and client side.\n+This page describes how to enable this.\n+\n+<Tip>\n+\n+The metric data is collected using the [Micrometer](https://micrometer.io/) library.\n+Please consult its documentation for information on how to expose the collected metrics to\n+various monitoring systems such as [Prometheus](https://prometheus.io/), \n+[Dropwizard Metrics](https://metrics.dropwizard.io/4.1.2/) and [Datadog](https://www.datadoghq.com/).\n+\n+</Tip>\n+\n+## Collecting server-side metrics\n+\n+You can use <type://MetricCollectingService> with <type://MeterIdPrefixFunction> for collecting metrics\n+of your services.\n+\n+```java\n+import com.linecorp.armeria.common.MeterIdPrefixFunction;\n+import com.linecorp.armeria.server.Server;\n+import com.linecorp.armeria.server.ServerBuilder;\n+import com.linecorp.armeria.server.metric.MetricCollectingService;\n+\n+Server.builder()\n+      .http(new InetSocketAddress(address, port))\n+      .service(new MyHttpService())\n+      .decorator(MetricCollectingService.newDecorator(\n+              MeterIdPrefixFunction.ofDefault(\"http.service\")))\n+      .build();\n+```\n+\n+If you are interested in monitoring [gRPC status](https://grpc.github.io/grpc/core/md_doc_statuscodes.html)\n+for a gRPC service, you can use <type://GrpcMeterIdPrefixFunction> instead of <type://MeterIdPrefixFunction>.\n+\n+```java\n+import com.linecorp.armeria.common.grpc.GrpcMeterIdPrefixFunction;\n+import com.linecorp.armeria.server.grpc.GrpcService;\n+\n+Server.builder()\n+      .http(new InetSocketAddress(address, port))\n+      .service(GrpcService.builder()\n+                          .addService(new MyHelloService())\n+                          .build())\n+      .decorator(MetricCollectingService.newDecorator(\n+              GrpcMeterIdPrefixFunction.of(\"grpc.service\")))\n+      .build();\n+```\n+\n+In cases where more sophisticated filtering and/or mangling of the generated metrics are required,\n+you can use the <type://ServerBuilder#meterRegistry(MeterRegistry)> method like this:\n+\n+```java\n+Server.builder()\n+      // ...\n+      .meterRegistry(myMeterRegistry);\n+```\n+\n+## Collecting client-side metrics\n+\n+This approach can used to collect metrics in a <type://WebClient> and a gRPC client:\n+\n+```java\n+import com.linecorp.armeria.client.Clients;\n+import com.linecorp.armeria.client.WebClient;\n+import com.linecorp.armeria.client.metric.MetricCollectingClient;\n+\n+// Decorate a WebClient with MetricCollectingClient\n+WebClient.builder(httpUrl)\n+         .decorator(MetricCollectingClient.newDecorator(\n+                 MeterIdPrefixFunction.ofDefault(\"http.client\")))\n+         .build();\n+\n+// Decorate a gRPC client with MetricCollectingClient\n+Clients.builder(grpcUrl)\n+       .decorator(MetricCollectingClient.newDecorator(\n+               GrpcMeterIdPrefixFunction.of(\"grpc.client\")))\n+       .build(HelloServiceBlockingStub.class);\n+```\n+\n+Like with the server-side metrics described above, certain scenarios might require you to \n+provide a custom meter registry. To accomplish this, override the <type://ClientFactory> in this way:\n+\n+```java\n+import com.linecorp.armeria.client.ClientFactory;\n+import com.linecorp.armeria.client.Clients;\n+\n+ClientFactory clientFactory = \n+      ClientFactory.builder()\n+                   .meterRegistry(myMeterRegistry)\n+                   .build();\n+                   \n+// Set a cumster ClientFactory to a WebClient                   \n+WebClient.builder(httpUrl)\n+         .factory(clientFactory)\n+          // ...\n+         .build();\n+\n+// Set a cumster ClientFactory to a gRPC client\n+Clients.builder(grpcUrl)\n+       .factory(clientFactory)\n+        // ...\n+       .build(HelloServiceBlockingStub.class);\n+```\n+\n+## Changing the default distribution summary config\n+\n+A [distribution summary](https://micrometer.io/docs/concepts#_distribution_summaries) is used to track \n+the distribution of events. Armeria provides a sensible default\n+[DistributionStatisticConfig](https://javadoc.io/doc/io.micrometer/micrometer-core/latest/io/micrometer/core/instrument/distribution/DistributionStatisticConfig.html)\n+for measuring the following metrics:\n+- A length of the request content\n+- A length of the response content\n+- A duration of request\n+- A duration of response\n+\n+If you want to override the default config,\n+you can set your own `DistributionStatisticConfig` using <type://MoreMeters#setDistributionStatisticConfig(DistributionStatisticConfig)>.\n+\n+```java\n+import io.micrometer.core.instrument.distribution.DistributionStatisticConfig;\n+\n+DistributionStatisticConfig myDistStatCfg =\n+        DistributionStatisticConfig.builder()\n+                                  .percentilesHistogram(false)\n+                                  .sla()\n+                                  .percentiles(PERCENTILES)\n+                                  .percentilePrecision(10)\n+                                  .minimumExpectedValue(1L)\n+                                  .maximumExpectedValue(Long.MAX_VALUE)\n+                                  .expiry(Duration.ofMinutes(10))\n+                                  .bufferLength(10)\n+                                  .build();\n+MoreMeters.setDistributionStatisticConfig(myDistStatCfg);\n+```\n+\n+## Excluding certain meters created by Armeria\n+\n+Micrometer's `MeterRegistry` can be configured with [meter filters](https://micrometer.io/docs/concepts#_meter_filters).\n+If you need to control the exported meters, you can apply sophisticated filters to the `MeterRegistry`.\n+\n+```java\n+import io.micrometer.core.instrument.simple.SimpleMeterRegistry;\n+\n+final MeterRegistry filteredMeterRegistry = new SimpleMeterRegistry();\n+filteredMeterRegistry", "originalCommit": "95c12039e0c8e678abf685580cf34352c2fd6f71", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDgwODA4MA==", "url": "https://github.com/line/armeria/pull/3171#discussion_r530808080", "bodyText": "Can remove this if we use globalRegistry in the example.", "author": "trustin", "createdAt": "2020-11-26T06:59:07Z", "path": "site/src/pages/docs/advanced-metrics.mdx", "diffHunk": "@@ -0,0 +1,158 @@\n+# Collecting metrics\n+\n+Armeria has built-in support for collecting metrics both on the server and client side.\n+This page describes how to enable this.\n+\n+<Tip>\n+\n+The metric data is collected using the [Micrometer](https://micrometer.io/) library.\n+Please consult its documentation for information on how to expose the collected metrics to\n+various monitoring systems such as [Prometheus](https://prometheus.io/), \n+[Dropwizard Metrics](https://metrics.dropwizard.io/4.1.2/) and [Datadog](https://www.datadoghq.com/).\n+\n+</Tip>\n+\n+## Collecting server-side metrics\n+\n+You can use <type://MetricCollectingService> with <type://MeterIdPrefixFunction> for collecting metrics\n+of your services.\n+\n+```java\n+import com.linecorp.armeria.common.MeterIdPrefixFunction;\n+import com.linecorp.armeria.server.Server;\n+import com.linecorp.armeria.server.ServerBuilder;\n+import com.linecorp.armeria.server.metric.MetricCollectingService;\n+\n+Server.builder()\n+      .http(new InetSocketAddress(address, port))\n+      .service(new MyHttpService())\n+      .decorator(MetricCollectingService.newDecorator(\n+              MeterIdPrefixFunction.ofDefault(\"http.service\")))\n+      .build();\n+```\n+\n+If you are interested in monitoring [gRPC status](https://grpc.github.io/grpc/core/md_doc_statuscodes.html)\n+for a gRPC service, you can use <type://GrpcMeterIdPrefixFunction> instead of <type://MeterIdPrefixFunction>.\n+\n+```java\n+import com.linecorp.armeria.common.grpc.GrpcMeterIdPrefixFunction;\n+import com.linecorp.armeria.server.grpc.GrpcService;\n+\n+Server.builder()\n+      .http(new InetSocketAddress(address, port))\n+      .service(GrpcService.builder()\n+                          .addService(new MyHelloService())\n+                          .build())\n+      .decorator(MetricCollectingService.newDecorator(\n+              GrpcMeterIdPrefixFunction.of(\"grpc.service\")))\n+      .build();\n+```\n+\n+In cases where more sophisticated filtering and/or mangling of the generated metrics are required,\n+you can use the <type://ServerBuilder#meterRegistry(MeterRegistry)> method like this:\n+\n+```java\n+Server.builder()\n+      // ...\n+      .meterRegistry(myMeterRegistry);\n+```\n+\n+## Collecting client-side metrics\n+\n+This approach can used to collect metrics in a <type://WebClient> and a gRPC client:\n+\n+```java\n+import com.linecorp.armeria.client.Clients;\n+import com.linecorp.armeria.client.WebClient;\n+import com.linecorp.armeria.client.metric.MetricCollectingClient;\n+\n+// Decorate a WebClient with MetricCollectingClient\n+WebClient.builder(httpUrl)\n+         .decorator(MetricCollectingClient.newDecorator(\n+                 MeterIdPrefixFunction.ofDefault(\"http.client\")))\n+         .build();\n+\n+// Decorate a gRPC client with MetricCollectingClient\n+Clients.builder(grpcUrl)\n+       .decorator(MetricCollectingClient.newDecorator(\n+               GrpcMeterIdPrefixFunction.of(\"grpc.client\")))\n+       .build(HelloServiceBlockingStub.class);\n+```\n+\n+Like with the server-side metrics described above, certain scenarios might require you to \n+provide a custom meter registry. To accomplish this, override the <type://ClientFactory> in this way:\n+\n+```java\n+import com.linecorp.armeria.client.ClientFactory;\n+import com.linecorp.armeria.client.Clients;\n+\n+ClientFactory clientFactory = \n+      ClientFactory.builder()\n+                   .meterRegistry(myMeterRegistry)\n+                   .build();\n+                   \n+// Set a cumster ClientFactory to a WebClient                   \n+WebClient.builder(httpUrl)\n+         .factory(clientFactory)\n+          // ...\n+         .build();\n+\n+// Set a cumster ClientFactory to a gRPC client\n+Clients.builder(grpcUrl)\n+       .factory(clientFactory)\n+        // ...\n+       .build(HelloServiceBlockingStub.class);\n+```\n+\n+## Changing the default distribution summary config\n+\n+A [distribution summary](https://micrometer.io/docs/concepts#_distribution_summaries) is used to track \n+the distribution of events. Armeria provides a sensible default\n+[DistributionStatisticConfig](https://javadoc.io/doc/io.micrometer/micrometer-core/latest/io/micrometer/core/instrument/distribution/DistributionStatisticConfig.html)\n+for measuring the following metrics:\n+- A length of the request content\n+- A length of the response content\n+- A duration of request\n+- A duration of response\n+\n+If you want to override the default config,\n+you can set your own `DistributionStatisticConfig` using <type://MoreMeters#setDistributionStatisticConfig(DistributionStatisticConfig)>.\n+\n+```java\n+import io.micrometer.core.instrument.distribution.DistributionStatisticConfig;\n+\n+DistributionStatisticConfig myDistStatCfg =\n+        DistributionStatisticConfig.builder()\n+                                  .percentilesHistogram(false)\n+                                  .sla()\n+                                  .percentiles(PERCENTILES)\n+                                  .percentilePrecision(10)\n+                                  .minimumExpectedValue(1L)\n+                                  .maximumExpectedValue(Long.MAX_VALUE)\n+                                  .expiry(Duration.ofMinutes(10))\n+                                  .bufferLength(10)\n+                                  .build();\n+MoreMeters.setDistributionStatisticConfig(myDistStatCfg);\n+```\n+\n+## Excluding certain meters created by Armeria\n+\n+Micrometer's `MeterRegistry` can be configured with [meter filters](https://micrometer.io/docs/concepts#_meter_filters).\n+If you need to control the exported meters, you can apply sophisticated filters to the `MeterRegistry`.\n+\n+```java\n+import io.micrometer.core.instrument.simple.SimpleMeterRegistry;\n+\n+final MeterRegistry filteredMeterRegistry = new SimpleMeterRegistry();\n+filteredMeterRegistry\n+        .config()\n+        .meterFilter(MeterFilter.deny(id -> \n+                id.getTag(\"service\").equals(\"MyHealthCheckService\")));\n+        .meterFilter(MeterFilter.denyNameStartsWith(\"jvm\"));\n+\n+Server.builder()\n+      // ...\n+      .meterRegistry(filteredMeterRegistry);", "originalCommit": "95c12039e0c8e678abf685580cf34352c2fd6f71", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDgwODI3Ng==", "url": "https://github.com/line/armeria/pull/3171#discussion_r530808276", "bodyText": "know -> learn\nthe request metrics -> request metrics ?", "author": "trustin", "createdAt": "2020-11-26T06:59:38Z", "path": "site/src/pages/docs/advanced-metrics.mdx", "diffHunk": "@@ -0,0 +1,158 @@\n+# Collecting metrics\n+\n+Armeria has built-in support for collecting metrics both on the server and client side.\n+This page describes how to enable this.\n+\n+<Tip>\n+\n+The metric data is collected using the [Micrometer](https://micrometer.io/) library.\n+Please consult its documentation for information on how to expose the collected metrics to\n+various monitoring systems such as [Prometheus](https://prometheus.io/), \n+[Dropwizard Metrics](https://metrics.dropwizard.io/4.1.2/) and [Datadog](https://www.datadoghq.com/).\n+\n+</Tip>\n+\n+## Collecting server-side metrics\n+\n+You can use <type://MetricCollectingService> with <type://MeterIdPrefixFunction> for collecting metrics\n+of your services.\n+\n+```java\n+import com.linecorp.armeria.common.MeterIdPrefixFunction;\n+import com.linecorp.armeria.server.Server;\n+import com.linecorp.armeria.server.ServerBuilder;\n+import com.linecorp.armeria.server.metric.MetricCollectingService;\n+\n+Server.builder()\n+      .http(new InetSocketAddress(address, port))\n+      .service(new MyHttpService())\n+      .decorator(MetricCollectingService.newDecorator(\n+              MeterIdPrefixFunction.ofDefault(\"http.service\")))\n+      .build();\n+```\n+\n+If you are interested in monitoring [gRPC status](https://grpc.github.io/grpc/core/md_doc_statuscodes.html)\n+for a gRPC service, you can use <type://GrpcMeterIdPrefixFunction> instead of <type://MeterIdPrefixFunction>.\n+\n+```java\n+import com.linecorp.armeria.common.grpc.GrpcMeterIdPrefixFunction;\n+import com.linecorp.armeria.server.grpc.GrpcService;\n+\n+Server.builder()\n+      .http(new InetSocketAddress(address, port))\n+      .service(GrpcService.builder()\n+                          .addService(new MyHelloService())\n+                          .build())\n+      .decorator(MetricCollectingService.newDecorator(\n+              GrpcMeterIdPrefixFunction.of(\"grpc.service\")))\n+      .build();\n+```\n+\n+In cases where more sophisticated filtering and/or mangling of the generated metrics are required,\n+you can use the <type://ServerBuilder#meterRegistry(MeterRegistry)> method like this:\n+\n+```java\n+Server.builder()\n+      // ...\n+      .meterRegistry(myMeterRegistry);\n+```\n+\n+## Collecting client-side metrics\n+\n+This approach can used to collect metrics in a <type://WebClient> and a gRPC client:\n+\n+```java\n+import com.linecorp.armeria.client.Clients;\n+import com.linecorp.armeria.client.WebClient;\n+import com.linecorp.armeria.client.metric.MetricCollectingClient;\n+\n+// Decorate a WebClient with MetricCollectingClient\n+WebClient.builder(httpUrl)\n+         .decorator(MetricCollectingClient.newDecorator(\n+                 MeterIdPrefixFunction.ofDefault(\"http.client\")))\n+         .build();\n+\n+// Decorate a gRPC client with MetricCollectingClient\n+Clients.builder(grpcUrl)\n+       .decorator(MetricCollectingClient.newDecorator(\n+               GrpcMeterIdPrefixFunction.of(\"grpc.client\")))\n+       .build(HelloServiceBlockingStub.class);\n+```\n+\n+Like with the server-side metrics described above, certain scenarios might require you to \n+provide a custom meter registry. To accomplish this, override the <type://ClientFactory> in this way:\n+\n+```java\n+import com.linecorp.armeria.client.ClientFactory;\n+import com.linecorp.armeria.client.Clients;\n+\n+ClientFactory clientFactory = \n+      ClientFactory.builder()\n+                   .meterRegistry(myMeterRegistry)\n+                   .build();\n+                   \n+// Set a cumster ClientFactory to a WebClient                   \n+WebClient.builder(httpUrl)\n+         .factory(clientFactory)\n+          // ...\n+         .build();\n+\n+// Set a cumster ClientFactory to a gRPC client\n+Clients.builder(grpcUrl)\n+       .factory(clientFactory)\n+        // ...\n+       .build(HelloServiceBlockingStub.class);\n+```\n+\n+## Changing the default distribution summary config\n+\n+A [distribution summary](https://micrometer.io/docs/concepts#_distribution_summaries) is used to track \n+the distribution of events. Armeria provides a sensible default\n+[DistributionStatisticConfig](https://javadoc.io/doc/io.micrometer/micrometer-core/latest/io/micrometer/core/instrument/distribution/DistributionStatisticConfig.html)\n+for measuring the following metrics:\n+- A length of the request content\n+- A length of the response content\n+- A duration of request\n+- A duration of response\n+\n+If you want to override the default config,\n+you can set your own `DistributionStatisticConfig` using <type://MoreMeters#setDistributionStatisticConfig(DistributionStatisticConfig)>.\n+\n+```java\n+import io.micrometer.core.instrument.distribution.DistributionStatisticConfig;\n+\n+DistributionStatisticConfig myDistStatCfg =\n+        DistributionStatisticConfig.builder()\n+                                  .percentilesHistogram(false)\n+                                  .sla()\n+                                  .percentiles(PERCENTILES)\n+                                  .percentilePrecision(10)\n+                                  .minimumExpectedValue(1L)\n+                                  .maximumExpectedValue(Long.MAX_VALUE)\n+                                  .expiry(Duration.ofMinutes(10))\n+                                  .bufferLength(10)\n+                                  .build();\n+MoreMeters.setDistributionStatisticConfig(myDistStatCfg);\n+```\n+\n+## Excluding certain meters created by Armeria\n+\n+Micrometer's `MeterRegistry` can be configured with [meter filters](https://micrometer.io/docs/concepts#_meter_filters).\n+If you need to control the exported meters, you can apply sophisticated filters to the `MeterRegistry`.\n+\n+```java\n+import io.micrometer.core.instrument.simple.SimpleMeterRegistry;\n+\n+final MeterRegistry filteredMeterRegistry = new SimpleMeterRegistry();\n+filteredMeterRegistry\n+        .config()\n+        .meterFilter(MeterFilter.deny(id -> \n+                id.getTag(\"service\").equals(\"MyHealthCheckService\")));\n+        .meterFilter(MeterFilter.denyNameStartsWith(\"jvm\"));\n+\n+Server.builder()\n+      // ...\n+      .meterRegistry(filteredMeterRegistry);\n+```\n+\n+Please refer to <type://MeterIdPrefixFunction> to know what kinds of tags are used for the request metrics.", "originalCommit": "95c12039e0c8e678abf685580cf34352c2fd6f71", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "169743a5431e2d25616fa2fb6b24bfb78fe1716d", "url": "https://github.com/line/armeria/commit/169743a5431e2d25616fa2fb6b24bfb78fe1716d", "message": "Address comments by @trustin", "committedDate": "2020-11-27T04:14:02Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTM5MDQwOA==", "url": "https://github.com/line/armeria/pull/3171#discussion_r531390408", "bodyText": "can be used ... for a?", "author": "minwoox", "createdAt": "2020-11-27T05:31:37Z", "path": "site/src/pages/docs/advanced-metrics.mdx", "diffHunk": "@@ -0,0 +1,153 @@\n+# Collecting metrics\n+\n+Armeria has built-in support for collecting metrics both on the server and client side.\n+This page describes how to enable this.\n+\n+<Tip>\n+\n+The metric data is collected using the [Micrometer](https://micrometer.io/) library.\n+Please consult its documentation for information on how to expose the collected metrics to\n+various monitoring systems such as [Prometheus](https://prometheus.io/), \n+[Dropwizard Metrics](https://metrics.dropwizard.io/4.1.2/) and [Datadog](https://www.datadoghq.com/).\n+\n+</Tip>\n+\n+## Collecting server-side metrics\n+\n+You can use <type://MetricCollectingService> with <type://MeterIdPrefixFunction> for collecting metrics\n+of your services.\n+\n+```java\n+import com.linecorp.armeria.common.MeterIdPrefixFunction;\n+import com.linecorp.armeria.server.Server;\n+import com.linecorp.armeria.server.ServerBuilder;\n+import com.linecorp.armeria.server.metric.MetricCollectingService;\n+\n+Server.builder()\n+      .http(new InetSocketAddress(address, port))\n+      .service(new MyHttpService())\n+      .decorator(MetricCollectingService.newDecorator(\n+              MeterIdPrefixFunction.ofDefault(\"http.service\")))\n+      .build();\n+```\n+\n+If you are interested in monitoring [gRPC status](https://grpc.github.io/grpc/core/md_doc_statuscodes.html)\n+for a gRPC service, you can use <type://GrpcMeterIdPrefixFunction> instead of <type://MeterIdPrefixFunction>.\n+\n+```java\n+import com.linecorp.armeria.common.grpc.GrpcMeterIdPrefixFunction;\n+import com.linecorp.armeria.server.grpc.GrpcService;\n+\n+Server.builder()\n+      .http(new InetSocketAddress(address, port))\n+      .service(GrpcService.builder()\n+                          .addService(new MyHelloService())\n+                          .build())\n+      .decorator(MetricCollectingService.newDecorator(\n+              GrpcMeterIdPrefixFunction.of(\"grpc.service\")))\n+      .build();\n+```\n+\n+In cases where more sophisticated filtering and/or mangling of the generated metrics are required,\n+you can use the <type://ServerBuilder#meterRegistry(MeterRegistry)> method like this:\n+\n+```java\n+Server.builder()\n+      // ...\n+      .meterRegistry(myMeterRegistry);\n+```\n+\n+## Collecting client-side metrics\n+\n+This approach can used to collect metrics in a <type://WebClient> and a gRPC client:", "originalCommit": "169743a5431e2d25616fa2fb6b24bfb78fe1716d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTM5MDY4Mw==", "url": "https://github.com/line/armeria/pull/3171#discussion_r531390683", "bodyText": "Could remove with?", "author": "minwoox", "createdAt": "2020-11-27T05:32:53Z", "path": "site/src/pages/docs/advanced-metrics.mdx", "diffHunk": "@@ -0,0 +1,153 @@\n+# Collecting metrics\n+\n+Armeria has built-in support for collecting metrics both on the server and client side.\n+This page describes how to enable this.\n+\n+<Tip>\n+\n+The metric data is collected using the [Micrometer](https://micrometer.io/) library.\n+Please consult its documentation for information on how to expose the collected metrics to\n+various monitoring systems such as [Prometheus](https://prometheus.io/), \n+[Dropwizard Metrics](https://metrics.dropwizard.io/4.1.2/) and [Datadog](https://www.datadoghq.com/).\n+\n+</Tip>\n+\n+## Collecting server-side metrics\n+\n+You can use <type://MetricCollectingService> with <type://MeterIdPrefixFunction> for collecting metrics\n+of your services.\n+\n+```java\n+import com.linecorp.armeria.common.MeterIdPrefixFunction;\n+import com.linecorp.armeria.server.Server;\n+import com.linecorp.armeria.server.ServerBuilder;\n+import com.linecorp.armeria.server.metric.MetricCollectingService;\n+\n+Server.builder()\n+      .http(new InetSocketAddress(address, port))\n+      .service(new MyHttpService())\n+      .decorator(MetricCollectingService.newDecorator(\n+              MeterIdPrefixFunction.ofDefault(\"http.service\")))\n+      .build();\n+```\n+\n+If you are interested in monitoring [gRPC status](https://grpc.github.io/grpc/core/md_doc_statuscodes.html)\n+for a gRPC service, you can use <type://GrpcMeterIdPrefixFunction> instead of <type://MeterIdPrefixFunction>.\n+\n+```java\n+import com.linecorp.armeria.common.grpc.GrpcMeterIdPrefixFunction;\n+import com.linecorp.armeria.server.grpc.GrpcService;\n+\n+Server.builder()\n+      .http(new InetSocketAddress(address, port))\n+      .service(GrpcService.builder()\n+                          .addService(new MyHelloService())\n+                          .build())\n+      .decorator(MetricCollectingService.newDecorator(\n+              GrpcMeterIdPrefixFunction.of(\"grpc.service\")))\n+      .build();\n+```\n+\n+In cases where more sophisticated filtering and/or mangling of the generated metrics are required,\n+you can use the <type://ServerBuilder#meterRegistry(MeterRegistry)> method like this:\n+\n+```java\n+Server.builder()\n+      // ...\n+      .meterRegistry(myMeterRegistry);\n+```\n+\n+## Collecting client-side metrics\n+\n+This approach can used to collect metrics in a <type://WebClient> and a gRPC client:\n+\n+```java\n+import com.linecorp.armeria.client.Clients;\n+import com.linecorp.armeria.client.WebClient;\n+import com.linecorp.armeria.client.metric.MetricCollectingClient;\n+\n+// Decorate a WebClient with MetricCollectingClient\n+WebClient.builder(httpUrl)\n+         .decorator(MetricCollectingClient.newDecorator(\n+                 MeterIdPrefixFunction.ofDefault(\"http.client\")))\n+         .build();\n+\n+// Decorate a gRPC client with MetricCollectingClient\n+Clients.builder(grpcUrl)\n+       .decorator(MetricCollectingClient.newDecorator(\n+               GrpcMeterIdPrefixFunction.of(\"grpc.client\")))\n+       .build(HelloServiceBlockingStub.class);\n+```\n+\n+Like with the server-side metrics described above, certain scenarios might require you to ", "originalCommit": "169743a5431e2d25616fa2fb6b24bfb78fe1716d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTM5MDk2Nw==", "url": "https://github.com/line/armeria/pull/3171#discussion_r531390967", "bodyText": "need one more space for indentation.", "author": "minwoox", "createdAt": "2020-11-27T05:34:15Z", "path": "site/src/pages/docs/advanced-metrics.mdx", "diffHunk": "@@ -0,0 +1,153 @@\n+# Collecting metrics\n+\n+Armeria has built-in support for collecting metrics both on the server and client side.\n+This page describes how to enable this.\n+\n+<Tip>\n+\n+The metric data is collected using the [Micrometer](https://micrometer.io/) library.\n+Please consult its documentation for information on how to expose the collected metrics to\n+various monitoring systems such as [Prometheus](https://prometheus.io/), \n+[Dropwizard Metrics](https://metrics.dropwizard.io/4.1.2/) and [Datadog](https://www.datadoghq.com/).\n+\n+</Tip>\n+\n+## Collecting server-side metrics\n+\n+You can use <type://MetricCollectingService> with <type://MeterIdPrefixFunction> for collecting metrics\n+of your services.\n+\n+```java\n+import com.linecorp.armeria.common.MeterIdPrefixFunction;\n+import com.linecorp.armeria.server.Server;\n+import com.linecorp.armeria.server.ServerBuilder;\n+import com.linecorp.armeria.server.metric.MetricCollectingService;\n+\n+Server.builder()\n+      .http(new InetSocketAddress(address, port))\n+      .service(new MyHttpService())\n+      .decorator(MetricCollectingService.newDecorator(\n+              MeterIdPrefixFunction.ofDefault(\"http.service\")))\n+      .build();\n+```\n+\n+If you are interested in monitoring [gRPC status](https://grpc.github.io/grpc/core/md_doc_statuscodes.html)\n+for a gRPC service, you can use <type://GrpcMeterIdPrefixFunction> instead of <type://MeterIdPrefixFunction>.\n+\n+```java\n+import com.linecorp.armeria.common.grpc.GrpcMeterIdPrefixFunction;\n+import com.linecorp.armeria.server.grpc.GrpcService;\n+\n+Server.builder()\n+      .http(new InetSocketAddress(address, port))\n+      .service(GrpcService.builder()\n+                          .addService(new MyHelloService())\n+                          .build())\n+      .decorator(MetricCollectingService.newDecorator(\n+              GrpcMeterIdPrefixFunction.of(\"grpc.service\")))\n+      .build();\n+```\n+\n+In cases where more sophisticated filtering and/or mangling of the generated metrics are required,\n+you can use the <type://ServerBuilder#meterRegistry(MeterRegistry)> method like this:\n+\n+```java\n+Server.builder()\n+      // ...\n+      .meterRegistry(myMeterRegistry);\n+```\n+\n+## Collecting client-side metrics\n+\n+This approach can used to collect metrics in a <type://WebClient> and a gRPC client:\n+\n+```java\n+import com.linecorp.armeria.client.Clients;\n+import com.linecorp.armeria.client.WebClient;\n+import com.linecorp.armeria.client.metric.MetricCollectingClient;\n+\n+// Decorate a WebClient with MetricCollectingClient\n+WebClient.builder(httpUrl)\n+         .decorator(MetricCollectingClient.newDecorator(\n+                 MeterIdPrefixFunction.ofDefault(\"http.client\")))\n+         .build();\n+\n+// Decorate a gRPC client with MetricCollectingClient\n+Clients.builder(grpcUrl)\n+       .decorator(MetricCollectingClient.newDecorator(\n+               GrpcMeterIdPrefixFunction.of(\"grpc.client\")))\n+       .build(HelloServiceBlockingStub.class);\n+```\n+\n+Like with the server-side metrics described above, certain scenarios might require you to \n+provide a custom meter registry. To accomplish this, override the <type://ClientFactory> in this way:\n+\n+```java\n+import com.linecorp.armeria.client.ClientFactory;\n+import com.linecorp.armeria.client.Clients;\n+\n+ClientFactory clientFactory = \n+      ClientFactory.builder()\n+                   .meterRegistry(myMeterRegistry)\n+                   .build();\n+                   \n+// Set a cumster ClientFactory to a WebClient                   \n+WebClient.builder(httpUrl)\n+         .factory(clientFactory)\n+          // ...\n+         .build();\n+\n+// Set a cumster ClientFactory to a gRPC client\n+Clients.builder(grpcUrl)\n+       .factory(clientFactory)\n+        // ...\n+       .build(HelloServiceBlockingStub.class);\n+```\n+\n+## Changing the default distribution summary config\n+\n+A [distribution summary](https://micrometer.io/docs/concepts#_distribution_summaries) is used to track \n+the distribution of events. Armeria provides a sensible default\n+[DistributionStatisticConfig](https://javadoc.io/doc/io.micrometer/micrometer-core/latest/io/micrometer/core/instrument/distribution/DistributionStatisticConfig.html)\n+for measuring the following metrics:\n+- A length of the request content\n+- A length of the response content\n+- A duration of request\n+- A duration of response\n+\n+If you want to override the default config,\n+you can set your own `DistributionStatisticConfig` using <type://MoreMeters#setDistributionStatisticConfig(DistributionStatisticConfig)>.\n+\n+```java\n+import io.micrometer.core.instrument.distribution.DistributionStatisticConfig;\n+\n+DistributionStatisticConfig myDistStatCfg =\n+        DistributionStatisticConfig.builder()\n+                                  .percentilesHistogram(false)", "originalCommit": "169743a5431e2d25616fa2fb6b24bfb78fe1716d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTY0NTgyOA==", "url": "https://github.com/line/armeria/pull/3171#discussion_r531645828", "bodyText": "\ud83d\ude31", "author": "ikhoon", "createdAt": "2020-11-27T14:54:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTM5MDk2Nw=="}], "type": "inlineReview"}, {"oid": "477417c7fcb38aba7f56b23a9825f585ee1a1986", "url": "https://github.com/line/armeria/commit/477417c7fcb38aba7f56b23a9825f585ee1a1986", "message": "Address comments by @minwoox", "committedDate": "2020-11-27T14:56:01Z", "type": "commit"}, {"oid": "7528ce2592e8db96e055cef82615ceef04a65d39", "url": "https://github.com/line/armeria/commit/7528ce2592e8db96e055cef82615ceef04a65d39", "message": "Add verb after can", "committedDate": "2020-11-27T15:10:44Z", "type": "commit"}]}