{"pr_number": 2361, "pr_title": "Add `Clients.builder()` / Deprecate methods with optional parameters", "pr_createdAt": "2020-01-02T08:15:44Z", "pr_url": "https://github.com/line/armeria/pull/2361", "timeline": [{"oid": "2eb5f55e4725e9aec5cc36561050800844116750", "url": "https://github.com/line/armeria/commit/2eb5f55e4725e9aec5cc36561050800844116750", "message": "Add `Clients.builder()` / Deprecate methods with optional parameters\n\nMotivation:\n\n- For consistency, a user should be able to create a `ClientBuilder` via\n  `builder()` factory methods.\n- The factory methods in `Clients` and `WebClient` are overly crowded.\n\nModifications:\n\n- Add `Clients.builder()` and deprecated their corresponding\n  `ClientBuilder` constructors.\n- Deprecate the factory methods that require optional parameters in\n  `Clients` and `WebClients`.\n\nResult:\n\n- Closes #1719\n- Less cognitive load (once we remove the deprecated ones)", "committedDate": "2020-01-02T08:11:36Z", "type": "commit"}, {"oid": "7ca16aa2f3a81214fd4fa7c19d1256c361d07af6", "url": "https://github.com/line/armeria/commit/7ca16aa2f3a81214fd4fa7c19d1256c361d07af6", "message": "Indentation", "committedDate": "2020-01-02T08:22:27Z", "type": "commit"}, {"oid": "cfb510a9a087541b6a84901306f0b826fe090d44", "url": "https://github.com/line/armeria/commit/cfb510a9a087541b6a84901306f0b826fe090d44", "message": "Checkstyle / Improved scheme normalization", "committedDate": "2020-01-02T08:47:37Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MjQwNTg4Mg==", "url": "https://github.com/line/armeria/pull/2361#discussion_r362405882", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 * Returns a new {@link WebClient} client that connects to the specified {@link Endpoint} with\n          \n          \n            \n                 * Returns a new {@link WebClient} that connects to the specified {@link Endpoint} with", "author": "ikhoon", "createdAt": "2020-01-02T09:09:44Z", "path": "core/src/main/java/com/linecorp/armeria/client/WebClient.java", "diffHunk": "@@ -36,168 +36,248 @@\n public interface WebClient extends ClientBuilderParams, Unwrappable {\n \n     /**\n-     * Creates a new web client without a base URI using the default {@link ClientFactory} and\n+     * Returns a {@link WebClient} without a base URI using the default {@link ClientFactory} and\n      * the default {@link ClientOptions}.\n      */\n     static WebClient of() {\n-        return builder().options(ClientOptions.of()).build();\n+        return DefaultWebClient.DEFAULT;\n     }\n \n     /**\n-     * Creates a new web client that connects to the specified {@code uri} using the default\n+     * Returns a new {@link WebClient} that connects to the specified {@code uri} using the default options.\n+     *\n+     * @param uri the URI of the server endpoint\n+     *\n+     * @throws IllegalArgumentException if the scheme of the specified {@code uri} is not an HTTP scheme\n+     */\n+    static WebClient of(String uri) {\n+        return builder(uri).build();\n+    }\n+\n+    /**\n+     * Returns a new {@link WebClient} that connects to the specified {@link URI} using the default options.\n+     *\n+     * @param uri the {@link URI} of the server endpoint\n+     *\n+     * @throws IllegalArgumentException if the scheme of the specified {@link URI} is not an HTTP scheme\n+     */\n+    static WebClient of(URI uri) {\n+        return builder(uri).build();\n+    }\n+\n+    /**\n+     * Returns a new {@link WebClient} client that connects to the specified {@link Endpoint} with", "originalCommit": "cfb510a9a087541b6a84901306f0b826fe090d44", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MjQwNjA5Nw==", "url": "https://github.com/line/armeria/pull/2361#discussion_r362406097", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 * Returns a new web client that connects to the specified {@code uri} using the default\n          \n          \n            \n                 * Returns a new {@link WebClient} that connects to the specified {@code uri} using the default", "author": "ikhoon", "createdAt": "2020-01-02T09:10:32Z", "path": "core/src/main/java/com/linecorp/armeria/client/WebClient.java", "diffHunk": "@@ -36,168 +36,248 @@\n public interface WebClient extends ClientBuilderParams, Unwrappable {\n \n     /**\n-     * Creates a new web client without a base URI using the default {@link ClientFactory} and\n+     * Returns a {@link WebClient} without a base URI using the default {@link ClientFactory} and\n      * the default {@link ClientOptions}.\n      */\n     static WebClient of() {\n-        return builder().options(ClientOptions.of()).build();\n+        return DefaultWebClient.DEFAULT;\n     }\n \n     /**\n-     * Creates a new web client that connects to the specified {@code uri} using the default\n+     * Returns a new {@link WebClient} that connects to the specified {@code uri} using the default options.\n+     *\n+     * @param uri the URI of the server endpoint\n+     *\n+     * @throws IllegalArgumentException if the scheme of the specified {@code uri} is not an HTTP scheme\n+     */\n+    static WebClient of(String uri) {\n+        return builder(uri).build();\n+    }\n+\n+    /**\n+     * Returns a new {@link WebClient} that connects to the specified {@link URI} using the default options.\n+     *\n+     * @param uri the {@link URI} of the server endpoint\n+     *\n+     * @throws IllegalArgumentException if the scheme of the specified {@link URI} is not an HTTP scheme\n+     */\n+    static WebClient of(URI uri) {\n+        return builder(uri).build();\n+    }\n+\n+    /**\n+     * Returns a new {@link WebClient} client that connects to the specified {@link Endpoint} with\n+     * the {@link SessionProtocol} using the default {@link ClientFactory} and the default\n+     * {@link ClientOptions}.\n+     *\n+     * @param protocol the {@link SessionProtocol} of the {@link Endpoint}\n+     * @param endpoint the server {@link Endpoint}\n+     */\n+    static WebClient of(SessionProtocol protocol, Endpoint endpoint) {\n+        return builder(protocol, endpoint).build();\n+    }\n+\n+    /**\n+     * Returns a new {@link WebClient} that connects to the specified {@code uri} using the default\n      * {@link ClientFactory}.\n      *\n      * @param uri the URI of the server endpoint\n      * @param options the {@link ClientOptionValue}s\n      *\n      * @throws IllegalArgumentException if the scheme of the specified {@code uri} is not an HTTP scheme\n+     *\n+     * @deprecated Use {@link #builder(String)} and {@link WebClientBuilder#option(ClientOptionValue)}.\n      */\n+    @Deprecated\n     static WebClient of(String uri, ClientOptionValue<?>... options) {\n-        return of(ClientFactory.ofDefault(), uri, options);\n+        return builder(uri).options(options).build();\n     }\n \n     /**\n-     * Creates a new web client that connects to the specified {@code uri} using the default\n+     * Returns a new web client that connects to the specified {@code uri} using the default", "originalCommit": "cfb510a9a087541b6a84901306f0b826fe090d44", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MjQwNjIxNA==", "url": "https://github.com/line/armeria/pull/2361#discussion_r362406214", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 * Returns a new web client that connects to the specified {@code uri} using an alternative\n          \n          \n            \n                 * Returns a new {@link WebClient} that connects to the specified {@code uri} using an alternative", "author": "ikhoon", "createdAt": "2020-01-02T09:11:00Z", "path": "core/src/main/java/com/linecorp/armeria/client/WebClient.java", "diffHunk": "@@ -36,168 +36,248 @@\n public interface WebClient extends ClientBuilderParams, Unwrappable {\n \n     /**\n-     * Creates a new web client without a base URI using the default {@link ClientFactory} and\n+     * Returns a {@link WebClient} without a base URI using the default {@link ClientFactory} and\n      * the default {@link ClientOptions}.\n      */\n     static WebClient of() {\n-        return builder().options(ClientOptions.of()).build();\n+        return DefaultWebClient.DEFAULT;\n     }\n \n     /**\n-     * Creates a new web client that connects to the specified {@code uri} using the default\n+     * Returns a new {@link WebClient} that connects to the specified {@code uri} using the default options.\n+     *\n+     * @param uri the URI of the server endpoint\n+     *\n+     * @throws IllegalArgumentException if the scheme of the specified {@code uri} is not an HTTP scheme\n+     */\n+    static WebClient of(String uri) {\n+        return builder(uri).build();\n+    }\n+\n+    /**\n+     * Returns a new {@link WebClient} that connects to the specified {@link URI} using the default options.\n+     *\n+     * @param uri the {@link URI} of the server endpoint\n+     *\n+     * @throws IllegalArgumentException if the scheme of the specified {@link URI} is not an HTTP scheme\n+     */\n+    static WebClient of(URI uri) {\n+        return builder(uri).build();\n+    }\n+\n+    /**\n+     * Returns a new {@link WebClient} client that connects to the specified {@link Endpoint} with\n+     * the {@link SessionProtocol} using the default {@link ClientFactory} and the default\n+     * {@link ClientOptions}.\n+     *\n+     * @param protocol the {@link SessionProtocol} of the {@link Endpoint}\n+     * @param endpoint the server {@link Endpoint}\n+     */\n+    static WebClient of(SessionProtocol protocol, Endpoint endpoint) {\n+        return builder(protocol, endpoint).build();\n+    }\n+\n+    /**\n+     * Returns a new {@link WebClient} that connects to the specified {@code uri} using the default\n      * {@link ClientFactory}.\n      *\n      * @param uri the URI of the server endpoint\n      * @param options the {@link ClientOptionValue}s\n      *\n      * @throws IllegalArgumentException if the scheme of the specified {@code uri} is not an HTTP scheme\n+     *\n+     * @deprecated Use {@link #builder(String)} and {@link WebClientBuilder#option(ClientOptionValue)}.\n      */\n+    @Deprecated\n     static WebClient of(String uri, ClientOptionValue<?>... options) {\n-        return of(ClientFactory.ofDefault(), uri, options);\n+        return builder(uri).options(options).build();\n     }\n \n     /**\n-     * Creates a new web client that connects to the specified {@code uri} using the default\n+     * Returns a new web client that connects to the specified {@code uri} using the default\n      * {@link ClientFactory}.\n      *\n      * @param uri the URI of the server endpoint\n      * @param options the {@link ClientOptions}\n      *\n      * @throws IllegalArgumentException if the scheme of the specified {@code uri} is not an HTTP scheme\n+     *\n+     * @deprecated Use {@link #builder(String)} and {@link WebClientBuilder#options(ClientOptions)}.\n      */\n+    @Deprecated\n     static WebClient of(String uri, ClientOptions options) {\n-        return of(ClientFactory.ofDefault(), uri, options);\n+        return builder(uri).options(options).build();\n     }\n \n     /**\n-     * Creates a new web client that connects to the specified {@code uri} using an alternative\n+     * Returns a new web client that connects to the specified {@code uri} using an alternative", "originalCommit": "cfb510a9a087541b6a84901306f0b826fe090d44", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MjQwNjU3Mg==", "url": "https://github.com/line/armeria/pull/2361#discussion_r362406572", "bodyText": "s/new web client/new {@link WebClient} \ud83d\ude00", "author": "ikhoon", "createdAt": "2020-01-02T09:12:20Z", "path": "core/src/main/java/com/linecorp/armeria/client/WebClient.java", "diffHunk": "@@ -36,168 +36,248 @@\n public interface WebClient extends ClientBuilderParams, Unwrappable {\n \n     /**\n-     * Creates a new web client without a base URI using the default {@link ClientFactory} and\n+     * Returns a {@link WebClient} without a base URI using the default {@link ClientFactory} and\n      * the default {@link ClientOptions}.\n      */\n     static WebClient of() {\n-        return builder().options(ClientOptions.of()).build();\n+        return DefaultWebClient.DEFAULT;\n     }\n \n     /**\n-     * Creates a new web client that connects to the specified {@code uri} using the default\n+     * Returns a new {@link WebClient} that connects to the specified {@code uri} using the default options.\n+     *\n+     * @param uri the URI of the server endpoint\n+     *\n+     * @throws IllegalArgumentException if the scheme of the specified {@code uri} is not an HTTP scheme\n+     */\n+    static WebClient of(String uri) {\n+        return builder(uri).build();\n+    }\n+\n+    /**\n+     * Returns a new {@link WebClient} that connects to the specified {@link URI} using the default options.\n+     *\n+     * @param uri the {@link URI} of the server endpoint\n+     *\n+     * @throws IllegalArgumentException if the scheme of the specified {@link URI} is not an HTTP scheme\n+     */\n+    static WebClient of(URI uri) {\n+        return builder(uri).build();\n+    }\n+\n+    /**\n+     * Returns a new {@link WebClient} client that connects to the specified {@link Endpoint} with\n+     * the {@link SessionProtocol} using the default {@link ClientFactory} and the default\n+     * {@link ClientOptions}.\n+     *\n+     * @param protocol the {@link SessionProtocol} of the {@link Endpoint}\n+     * @param endpoint the server {@link Endpoint}\n+     */\n+    static WebClient of(SessionProtocol protocol, Endpoint endpoint) {\n+        return builder(protocol, endpoint).build();\n+    }\n+\n+    /**\n+     * Returns a new {@link WebClient} that connects to the specified {@code uri} using the default\n      * {@link ClientFactory}.\n      *\n      * @param uri the URI of the server endpoint\n      * @param options the {@link ClientOptionValue}s\n      *\n      * @throws IllegalArgumentException if the scheme of the specified {@code uri} is not an HTTP scheme\n+     *\n+     * @deprecated Use {@link #builder(String)} and {@link WebClientBuilder#option(ClientOptionValue)}.\n      */\n+    @Deprecated\n     static WebClient of(String uri, ClientOptionValue<?>... options) {\n-        return of(ClientFactory.ofDefault(), uri, options);\n+        return builder(uri).options(options).build();\n     }\n \n     /**\n-     * Creates a new web client that connects to the specified {@code uri} using the default\n+     * Returns a new web client that connects to the specified {@code uri} using the default\n      * {@link ClientFactory}.\n      *\n      * @param uri the URI of the server endpoint\n      * @param options the {@link ClientOptions}\n      *\n      * @throws IllegalArgumentException if the scheme of the specified {@code uri} is not an HTTP scheme\n+     *\n+     * @deprecated Use {@link #builder(String)} and {@link WebClientBuilder#options(ClientOptions)}.\n      */\n+    @Deprecated\n     static WebClient of(String uri, ClientOptions options) {\n-        return of(ClientFactory.ofDefault(), uri, options);\n+        return builder(uri).options(options).build();\n     }\n \n     /**\n-     * Creates a new web client that connects to the specified {@code uri} using an alternative\n+     * Returns a new web client that connects to the specified {@code uri} using an alternative\n      * {@link ClientFactory}.\n      *\n      * @param factory an alternative {@link ClientFactory}\n      * @param uri the URI of the server endpoint\n      * @param options the {@link ClientOptionValue}s\n      *\n      * @throws IllegalArgumentException if the scheme of the specified {@code uri} is not an HTTP scheme\n+     *\n+     * @deprecated Use {@link #builder(String)}, {@link WebClientBuilder#factory(ClientFactory)}\n+     *             and {@link WebClientBuilder#options(ClientOptionValue[])}.\n      */\n+    @Deprecated\n     static WebClient of(ClientFactory factory, String uri, ClientOptionValue<?>... options) {\n         return builder(uri).factory(factory).options(options).build();\n     }\n \n     /**\n-     * Creates a new web client that connects to the specified {@code uri} using an alternative\n+     * Returns a new web client that connects to the specified {@code uri} using an alternative", "originalCommit": "cfb510a9a087541b6a84901306f0b826fe090d44", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "ac9b80f9c8ff15f6fd74bcf05118e2adf47041a2", "url": "https://github.com/line/armeria/commit/ac9b80f9c8ff15f6fd74bcf05118e2adf47041a2", "message": "Address the comments from @ikhoon", "committedDate": "2020-01-02T12:32:35Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MjY4NzQwNQ==", "url": "https://github.com/line/armeria/pull/2361#discussion_r362687405", "bodyText": "Clients?", "author": "minwoox", "createdAt": "2020-01-03T01:40:07Z", "path": "grpc-protocol/src/main/java/com/linecorp/armeria/common/grpc/protocol/UnaryGrpcClient.java", "diffHunk": "@@ -59,7 +59,7 @@\n      * Constructs a {@link UnaryGrpcClient} for the given {@link WebClient}.\n      */\n     // TODO(anuraaga): We would ideally use our standard client building pattern, i.e.,\n-    // new ClientBuilder(...).build(UnaryGrpcClient.class), but that requires mapping protocol schemes to media\n+    // Client.builder(...).build(UnaryGrpcClient.class), but that requires mapping protocol schemes to media", "originalCommit": "ac9b80f9c8ff15f6fd74bcf05118e2adf47041a2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MjY4ODM0OA==", "url": "https://github.com/line/armeria/pull/2361#discussion_r362688348", "bodyText": "Could you add a small example for this case please?", "author": "minwoox", "createdAt": "2020-01-03T01:48:37Z", "path": "core/src/main/java/com/linecorp/armeria/client/WebClientBuilder.java", "diffHunk": "@@ -77,8 +85,15 @@ static boolean isUndefinedUri(URI uri) {\n         if (isUndefinedUri(uri)) {\n             this.uri = uri;\n         } else {\n-            validateScheme(requireNonNull(uri, \"uri\").getScheme());\n-            this.uri = URI.create(SerializationFormat.NONE + \"+\" + uri);\n+            final String givenScheme = requireNonNull(uri, \"uri\").getScheme();\n+            final Scheme scheme = validateScheme(givenScheme);\n+            if (scheme.uriText().equals(givenScheme)) {\n+                this.uri = uri;\n+            } else {\n+                // Replace the user-specified scheme with the normalized one.\n+                this.uri = URI.create(scheme.uriText() +\n+                                      uri.toString().substring(givenScheme.length()));", "originalCommit": "ac9b80f9c8ff15f6fd74bcf05118e2adf47041a2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "1d4de0574f3b2da0db762120ce773e475f85def6", "url": "https://github.com/line/armeria/commit/1d4de0574f3b2da0db762120ce773e475f85def6", "message": "Address the comments from @minwoox", "committedDate": "2020-01-03T02:21:56Z", "type": "commit"}, {"oid": "07d0a92e66ae6162c37ead3f511c3371c6ecabde", "url": "https://github.com/line/armeria/commit/07d0a92e66ae6162c37ead3f511c3371c6ecabde", "message": "Clean-up", "committedDate": "2020-01-03T02:34:57Z", "type": "commit"}]}