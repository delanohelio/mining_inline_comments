{"pr_number": 2503, "pr_title": "Make `Throttling*Service` responses configurable", "pr_createdAt": "2020-02-17T18:15:56Z", "pr_url": "https://github.com/line/armeria/pull/2503", "timeline": [{"oid": "6da9d662948253850ef265160a903cb0ed7779ae", "url": "https://github.com/line/armeria/commit/6da9d662948253850ef265160a903cb0ed7779ae", "message": "A fix for issue #2482 (Throttling failure response status shall be configurable):\n- added AbstractThrottlingService.strategy() method to provide access to the strategy set to the throttling service.\n- added ThrottlingStrategy.failureStatus() method to provide status for throttled requests.\n- adjusted ThrottlingService and RpcThrottlingService to leverage ThrottlingStrategy.failureStatus().\n- adjusted various constructor methods to support failureStatus parameter.\n- modified unit tests to cover the failure status.", "committedDate": "2020-02-17T18:12:09Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDQ4NjU2MA==", "url": "https://github.com/line/armeria/pull/2503#discussion_r380486560", "bodyText": "Instead of adding just this knob to strategy, how about adding ThrottlingFailureHandler similar to our auth service?\nhttps://github.com/line/armeria/blob/master/core/src/main/java/com/linecorp/armeria/server/auth/AuthService.java#L75\nBy letting it return an arbitrary response, we get more flexibility (including implementing the x-ratelimit headers if we add a token throttler).", "author": "anuraaga", "createdAt": "2020-02-18T06:53:50Z", "path": "core/src/main/java/com/linecorp/armeria/server/throttling/ThrottlingStrategy.java", "diffHunk": "@@ -126,4 +152,11 @@ protected ThrottlingStrategy(@Nullable String name) {\n     public String name() {\n         return name;\n     }\n+\n+    /**\n+     * Returns the failure status to be used for the throttled requests.\n+     */\n+    protected HttpStatus failureStatus() {", "originalCommit": "6da9d662948253850ef265160a903cb0ed7779ae", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDU2NTEwMQ==", "url": "https://github.com/line/armeria/pull/2503#discussion_r380565101", "bodyText": "Ok, I can try that if all reviewers in agreement on that.\nI have one problem with this proposed design though - its inability to pass the context directly from an authorizer to a handler. I experienced that in several places, including AuthService and ThrottlingService. In either case I ended up using ServiceRequestContext. While in case of ThrottlingService it was ok (but not very pretty) since I could set various x-ratelimit headers using ctx.addAdditionalResponseHeader() at ThrottlingStrategy.accept(), which sort of defeated the purpose of the error handler. In case of OAuth2 implementation, it was even trickier - token validation can fail in a number of ways and the RFC instructs to properly inform the client by composing specific JSon error response. Therefore setting up the headers to the context inside the authorize() was not very useful. What I needed then was an ability to pass some custom set of artefacts from an authorizer to a handler, including error response code, oauth2 error code and some additional elements none of which were headers.\nIdeally, the interfaces like Authorizer.authorize() and ThrottlingStrategy.accept() should not be binary and should allow responding with some custom context.", "author": "max904-github", "createdAt": "2020-02-18T09:53:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDQ4NjU2MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDU3NjMzMQ==", "url": "https://github.com/line/armeria/pull/2503#discussion_r380576331", "bodyText": "Ah that's a good point. I think passing the context into the handler makes sense and we probably want to do so for auth service too. For here, I was expecting the interface for the handler to match the signature of onFailure exactly.\nI think to clarify your point, the authorizer itself does have context so should be fine. But the auth handlers indeed just get the request, but should get the context in addition or instead.", "author": "anuraaga", "createdAt": "2020-02-18T10:12:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDQ4NjU2MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDU4MzA5NQ==", "url": "https://github.com/line/armeria/pull/2503#discussion_r380583095", "bodyText": "Yes, I understand the idea of the handler. Could you recommend something on the context passing solution?", "author": "max904-github", "createdAt": "2020-02-18T10:25:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDQ4NjU2MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTMwNjc0MA==", "url": "https://github.com/line/armeria/pull/2503#discussion_r381306740", "bodyText": "I may be missing the concern so let me know - I was thinking if the signature of the handler takes a ServiceRequestContext and returns a HttpResponse, which is not what the auth service currently does, the context issue is solved since, using auth as an example, both the authorizer and handler have the context. So if here if both strategy has context (already does) and handler has it, it works. Let me know if this misses something.", "author": "anuraaga", "createdAt": "2020-02-19T13:59:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDQ4NjU2MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTM0MzA0Nw==", "url": "https://github.com/line/armeria/pull/2503#discussion_r381343047", "bodyText": "Assuming that there are two parties - the authorizer and the handler (consider auth example), where one party (the authorizer) makes decisions based on complex logic (token validation) and the other party (the handler) fulfills the decisions made.\nLet's say the authorizer validates the token, and as a result, needs to pass following elements to the handler: HTTP error response code, OAuth error code, some reference data on the token (e.g. token expiry date). The latter two will have to be put into JSON response body. How such context gets passed with the proposed design?", "author": "max904-github", "createdAt": "2020-02-19T14:54:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDQ4NjU2MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTgyNzYwNQ==", "url": "https://github.com/line/armeria/pull/2503#discussion_r381827605", "bodyText": "Via RequestContext.attr()? Not sure if it's nice, though.", "author": "trustin", "createdAt": "2020-02-20T07:40:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDQ4NjU2MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzE3MzMwMw==", "url": "https://github.com/line/armeria/pull/2503#discussion_r383173303", "bodyText": "Made a second commit - Implemented ThrottlingReject/AcceptHandler approach, similar to AuthService, as suggested by @anuraaga, to fully customize throttling response rejection/acceptance.\nIntroduced builders for ThrottlingService and ThrottlingRpcService.\nChanged default to TOO_MANY_REQUESTS only for HTTP. RPC still uses SERVICE_UNAVAILABLE.", "author": "max904-github", "createdAt": "2020-02-24T10:07:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDQ4NjU2MA=="}], "type": "inlineReview"}, {"oid": "11df63f285bbc90ce962c8e0ff1f4c055a9cbd3a", "url": "https://github.com/line/armeria/commit/11df63f285bbc90ce962c8e0ff1f4c055a9cbd3a", "message": "A fix for issue #2482 (Throttling failure response status shall be configurable):\n- implemented ThrottlingReject/AcceptHandler approach, similar to AuthService, to customize throttling response rejection/acceptance.\n- added service builders: AbstractThrottlingBuilder, ThrottlingServiceBuilder, ThrottlingRpcServiceBuilder.\n- added ThrottlingService.builder() and ThrottlingRpcService.builder().\n- set HttpStatus.SERVICE_UNAVAILABLE as default for RpcRequest.\n- set HttpStatus.TOO_MANY_REQUESTS as a default for HttpRequest.", "committedDate": "2020-02-24T09:57:01Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDkyODYyNw==", "url": "https://github.com/line/armeria/pull/2503#discussion_r384928627", "bodyText": "All protected methods in this class could be package-private and final.", "author": "trustin", "createdAt": "2020-02-27T06:05:29Z", "path": "core/src/main/java/com/linecorp/armeria/server/throttling/AbstractThrottlingServiceBuilder.java", "diffHunk": "@@ -0,0 +1,92 @@\n+/*\n+ * Copyright 2018 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.linecorp.armeria.server.throttling;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+import javax.annotation.Nullable;\n+\n+import com.linecorp.armeria.common.Request;\n+import com.linecorp.armeria.common.Response;\n+import com.linecorp.armeria.server.Service;\n+\n+/**\n+ * Builds a new {@link AbstractThrottlingService}.\n+ * @param <I> type of the request\n+ * @param <O> type of the response\n+ */\n+abstract class AbstractThrottlingServiceBuilder<I extends Request, O extends Response> {\n+\n+    @Nullable\n+    private ThrottlingStrategy<I> strategy;\n+    private ThrottlingAcceptHandler<I, O> acceptHandler;\n+    private ThrottlingRejectHandler<I, O> rejectHandler;\n+\n+    AbstractThrottlingServiceBuilder() {\n+        acceptHandler = requireNonNull(defaultAcceptHandler(), \"defaultAcceptHandler\");\n+        rejectHandler = requireNonNull(defaultRejectHandler(), \"defaultRejectHandler\");\n+    }\n+\n+    /**\n+     * Provides default request accept handler.\n+     */\n+    protected ThrottlingAcceptHandler<I, O> defaultAcceptHandler() {", "originalCommit": "11df63f285bbc90ce962c8e0ff1f4c055a9cbd3a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTc3MDU3MA==", "url": "https://github.com/line/armeria/pull/2503#discussion_r385770570", "bodyText": "Made all methods package private and made internal getters/setters final.", "author": "max904-github", "createdAt": "2020-02-28T15:47:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDkyODYyNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDkyODk5MA==", "url": "https://github.com/line/armeria/pull/2503#discussion_r384928990", "bodyText": "Could we require a strategy at construction time? e.g. ThrottlingRpcService.builder(strategy)...build()", "author": "trustin", "createdAt": "2020-02-27T06:06:43Z", "path": "core/src/main/java/com/linecorp/armeria/server/throttling/AbstractThrottlingServiceBuilder.java", "diffHunk": "@@ -0,0 +1,92 @@\n+/*\n+ * Copyright 2018 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.linecorp.armeria.server.throttling;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+import javax.annotation.Nullable;\n+\n+import com.linecorp.armeria.common.Request;\n+import com.linecorp.armeria.common.Response;\n+import com.linecorp.armeria.server.Service;\n+\n+/**\n+ * Builds a new {@link AbstractThrottlingService}.\n+ * @param <I> type of the request\n+ * @param <O> type of the response\n+ */\n+abstract class AbstractThrottlingServiceBuilder<I extends Request, O extends Response> {\n+\n+    @Nullable\n+    private ThrottlingStrategy<I> strategy;\n+    private ThrottlingAcceptHandler<I, O> acceptHandler;\n+    private ThrottlingRejectHandler<I, O> rejectHandler;\n+\n+    AbstractThrottlingServiceBuilder() {", "originalCommit": "11df63f285bbc90ce962c8e0ff1f4c055a9cbd3a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTc2NjYwNA==", "url": "https://github.com/line/armeria/pull/2503#discussion_r385766604", "bodyText": "Fixed", "author": "max904-github", "createdAt": "2020-02-28T15:41:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDkyODk5MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDkyOTAzOQ==", "url": "https://github.com/line/armeria/pull/2503#discussion_r384929039", "bodyText": "nit: 2020", "author": "trustin", "createdAt": "2020-02-27T06:07:00Z", "path": "core/src/main/java/com/linecorp/armeria/server/throttling/AbstractThrottlingServiceBuilder.java", "diffHunk": "@@ -0,0 +1,92 @@\n+/*\n+ * Copyright 2018 LINE Corporation", "originalCommit": "11df63f285bbc90ce962c8e0ff1f4c055a9cbd3a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTc2NjcwMw==", "url": "https://github.com/line/armeria/pull/2503#discussion_r385766703", "bodyText": "Updated", "author": "max904-github", "createdAt": "2020-02-28T15:41:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDkyOTAzOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDkyOTUwNQ==", "url": "https://github.com/line/armeria/pull/2503#discussion_r384929505", "bodyText": "Could be ThrottlingRejectHandler<? super RpcRequest, ? extends RpcResponse>", "author": "trustin", "createdAt": "2020-02-27T06:08:48Z", "path": "core/src/main/java/com/linecorp/armeria/server/throttling/ThrottlingRpcServiceBuilder.java", "diffHunk": "@@ -0,0 +1,92 @@\n+/*\n+ * Copyright 2018 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.linecorp.armeria.server.throttling;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+import java.util.function.Function;\n+\n+import com.linecorp.armeria.common.HttpStatus;\n+import com.linecorp.armeria.common.RpcRequest;\n+import com.linecorp.armeria.common.RpcResponse;\n+import com.linecorp.armeria.server.HttpStatusException;\n+import com.linecorp.armeria.server.RpcService;\n+import com.linecorp.armeria.server.Service;\n+\n+/**\n+ * Builds a new {@link ThrottlingRpcService}.\n+ */\n+public class ThrottlingRpcServiceBuilder extends AbstractThrottlingServiceBuilder<RpcRequest, RpcResponse> {\n+\n+    ThrottlingRpcServiceBuilder() {}\n+\n+    /**\n+     * Sets {@link ThrottlingStrategy}.\n+     */\n+    public ThrottlingRpcServiceBuilder strategy(ThrottlingStrategy<RpcRequest> strategy) {\n+        setStrategy(strategy);\n+        return this;\n+    }\n+\n+    /**\n+     * Sets {@link ThrottlingAcceptHandler}.\n+     */\n+    public ThrottlingRpcServiceBuilder onAcceptedRequest(\n+            ThrottlingAcceptHandler<RpcRequest, RpcResponse> acceptHandler) {\n+        setAcceptHandler(acceptHandler);\n+        return this;\n+    }\n+\n+    /**\n+     * Sets {@link ThrottlingRejectHandler}.\n+     */\n+    public ThrottlingRpcServiceBuilder onRejectedRequest(\n+            ThrottlingRejectHandler<RpcRequest, RpcResponse> rejectHandler) {", "originalCommit": "11df63f285bbc90ce962c8e0ff1f4c055a9cbd3a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTc1MDYyNw==", "url": "https://github.com/line/armeria/pull/2503#discussion_r385750627", "bodyText": "This is how it's done in AuthService, which I followed, as suggested earlier. This new suggestion conflicts with SimpleDecoratingService.", "author": "max904-github", "createdAt": "2020-02-28T15:15:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDkyOTUwNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDkyOTUzNw==", "url": "https://github.com/line/armeria/pull/2503#discussion_r384929537", "bodyText": "Could be ThrottlingAcceptHandler<? super RpcRequest, ? extends RpcResponse>", "author": "trustin", "createdAt": "2020-02-27T06:08:55Z", "path": "core/src/main/java/com/linecorp/armeria/server/throttling/ThrottlingRpcServiceBuilder.java", "diffHunk": "@@ -0,0 +1,92 @@\n+/*\n+ * Copyright 2018 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.linecorp.armeria.server.throttling;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+import java.util.function.Function;\n+\n+import com.linecorp.armeria.common.HttpStatus;\n+import com.linecorp.armeria.common.RpcRequest;\n+import com.linecorp.armeria.common.RpcResponse;\n+import com.linecorp.armeria.server.HttpStatusException;\n+import com.linecorp.armeria.server.RpcService;\n+import com.linecorp.armeria.server.Service;\n+\n+/**\n+ * Builds a new {@link ThrottlingRpcService}.\n+ */\n+public class ThrottlingRpcServiceBuilder extends AbstractThrottlingServiceBuilder<RpcRequest, RpcResponse> {\n+\n+    ThrottlingRpcServiceBuilder() {}\n+\n+    /**\n+     * Sets {@link ThrottlingStrategy}.\n+     */\n+    public ThrottlingRpcServiceBuilder strategy(ThrottlingStrategy<RpcRequest> strategy) {\n+        setStrategy(strategy);\n+        return this;\n+    }\n+\n+    /**\n+     * Sets {@link ThrottlingAcceptHandler}.\n+     */\n+    public ThrottlingRpcServiceBuilder onAcceptedRequest(\n+            ThrottlingAcceptHandler<RpcRequest, RpcResponse> acceptHandler) {", "originalCommit": "11df63f285bbc90ce962c8e0ff1f4c055a9cbd3a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTc1MDcxOQ==", "url": "https://github.com/line/armeria/pull/2503#discussion_r385750719", "bodyText": "This is how it's done in AuthService, which I followed, as suggested earlier. This new suggestion conflicts with SimpleDecoratingService.", "author": "max904-github", "createdAt": "2020-02-28T15:15:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDkyOTUzNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDkyOTYxOQ==", "url": "https://github.com/line/armeria/pull/2503#discussion_r384929619", "bodyText": "Could be ThrottlingAcceptHandler<? super I, ? extends O>", "author": "trustin", "createdAt": "2020-02-27T06:09:26Z", "path": "core/src/main/java/com/linecorp/armeria/server/throttling/AbstractThrottlingServiceBuilder.java", "diffHunk": "@@ -0,0 +1,92 @@\n+/*\n+ * Copyright 2018 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.linecorp.armeria.server.throttling;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+import javax.annotation.Nullable;\n+\n+import com.linecorp.armeria.common.Request;\n+import com.linecorp.armeria.common.Response;\n+import com.linecorp.armeria.server.Service;\n+\n+/**\n+ * Builds a new {@link AbstractThrottlingService}.\n+ * @param <I> type of the request\n+ * @param <O> type of the response\n+ */\n+abstract class AbstractThrottlingServiceBuilder<I extends Request, O extends Response> {\n+\n+    @Nullable\n+    private ThrottlingStrategy<I> strategy;\n+    private ThrottlingAcceptHandler<I, O> acceptHandler;\n+    private ThrottlingRejectHandler<I, O> rejectHandler;\n+\n+    AbstractThrottlingServiceBuilder() {\n+        acceptHandler = requireNonNull(defaultAcceptHandler(), \"defaultAcceptHandler\");\n+        rejectHandler = requireNonNull(defaultRejectHandler(), \"defaultRejectHandler\");\n+    }\n+\n+    /**\n+     * Provides default request accept handler.\n+     */\n+    protected ThrottlingAcceptHandler<I, O> defaultAcceptHandler() {\n+        return Service::serve;\n+    }\n+\n+    /**\n+     * Provides default request reject handler.\n+     */\n+    protected abstract ThrottlingRejectHandler<I, O> defaultRejectHandler();\n+\n+    /**\n+     * Sets {@link ThrottlingStrategy}.\n+     */\n+    protected void setStrategy(ThrottlingStrategy<I> strategy) {\n+        this.strategy = requireNonNull(strategy, \"strategy\");\n+    }\n+\n+    protected ThrottlingStrategy<I> getStrategy() {\n+        if (strategy == null) {\n+            throw new IllegalStateException(\"no \" + ThrottlingStrategy.class.getSimpleName() + \" was added.\");\n+        }\n+        return strategy;\n+    }\n+\n+    /**\n+     * Sets {@link ThrottlingAcceptHandler}.\n+     */\n+    protected void setAcceptHandler(\n+            ThrottlingAcceptHandler<I, O> acceptHandler) {", "originalCommit": "11df63f285bbc90ce962c8e0ff1f4c055a9cbd3a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTc1MDc5Nw==", "url": "https://github.com/line/armeria/pull/2503#discussion_r385750797", "bodyText": "This is how it's done in AuthService, which I followed, as suggested earlier. This new suggestion conflicts with SimpleDecoratingService.", "author": "max904-github", "createdAt": "2020-02-28T15:15:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDkyOTYxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTQ1Mzk3Nw==", "url": "https://github.com/line/armeria/pull/2503#discussion_r389453977", "bodyText": "Then, we should fix AuthService first. \ud83d\ude04\nI must be forgotten when I was doing #2323. But don't worry, after this is merged, I will work on it. Thanks!", "author": "minwoox", "createdAt": "2020-03-09T03:58:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDkyOTYxOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDkyOTY2Mw==", "url": "https://github.com/line/armeria/pull/2503#discussion_r384929663", "bodyText": "Could be ThrottlingRejectHandler<? super I, ? extends O>", "author": "trustin", "createdAt": "2020-02-27T06:09:34Z", "path": "core/src/main/java/com/linecorp/armeria/server/throttling/AbstractThrottlingServiceBuilder.java", "diffHunk": "@@ -0,0 +1,92 @@\n+/*\n+ * Copyright 2018 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.linecorp.armeria.server.throttling;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+import javax.annotation.Nullable;\n+\n+import com.linecorp.armeria.common.Request;\n+import com.linecorp.armeria.common.Response;\n+import com.linecorp.armeria.server.Service;\n+\n+/**\n+ * Builds a new {@link AbstractThrottlingService}.\n+ * @param <I> type of the request\n+ * @param <O> type of the response\n+ */\n+abstract class AbstractThrottlingServiceBuilder<I extends Request, O extends Response> {\n+\n+    @Nullable\n+    private ThrottlingStrategy<I> strategy;\n+    private ThrottlingAcceptHandler<I, O> acceptHandler;\n+    private ThrottlingRejectHandler<I, O> rejectHandler;\n+\n+    AbstractThrottlingServiceBuilder() {\n+        acceptHandler = requireNonNull(defaultAcceptHandler(), \"defaultAcceptHandler\");\n+        rejectHandler = requireNonNull(defaultRejectHandler(), \"defaultRejectHandler\");\n+    }\n+\n+    /**\n+     * Provides default request accept handler.\n+     */\n+    protected ThrottlingAcceptHandler<I, O> defaultAcceptHandler() {\n+        return Service::serve;\n+    }\n+\n+    /**\n+     * Provides default request reject handler.\n+     */\n+    protected abstract ThrottlingRejectHandler<I, O> defaultRejectHandler();\n+\n+    /**\n+     * Sets {@link ThrottlingStrategy}.\n+     */\n+    protected void setStrategy(ThrottlingStrategy<I> strategy) {\n+        this.strategy = requireNonNull(strategy, \"strategy\");\n+    }\n+\n+    protected ThrottlingStrategy<I> getStrategy() {\n+        if (strategy == null) {\n+            throw new IllegalStateException(\"no \" + ThrottlingStrategy.class.getSimpleName() + \" was added.\");\n+        }\n+        return strategy;\n+    }\n+\n+    /**\n+     * Sets {@link ThrottlingAcceptHandler}.\n+     */\n+    protected void setAcceptHandler(\n+            ThrottlingAcceptHandler<I, O> acceptHandler) {\n+        this.acceptHandler = requireNonNull(acceptHandler, \"acceptHandler\");\n+    }\n+\n+    protected ThrottlingAcceptHandler<I, O> getAcceptHandler() {\n+        return acceptHandler;\n+    }\n+\n+    /**\n+     * Sets {@link ThrottlingRejectHandler}.\n+     */\n+    protected void setRejectHandler(\n+            ThrottlingRejectHandler<I, O> rejectHandler) {", "originalCommit": "11df63f285bbc90ce962c8e0ff1f4c055a9cbd3a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTc1MDk2OQ==", "url": "https://github.com/line/armeria/pull/2503#discussion_r385750969", "bodyText": "This is how it's done in AuthService, which I followed, as suggested earlier. This new suggestion conflicts with SimpleDecoratingService.", "author": "max904-github", "createdAt": "2020-02-28T15:15:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDkyOTY2Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDkzMTEzMA==", "url": "https://github.com/line/armeria/pull/2503#discussion_r384931130", "bodyText": "Just wondering, any thoughts on\n\nRemoving accept handler (what can we expect other than just running the delegate?)\nRemove delegate from reject handler (what can we expect other than not running delegate?)\n\nI think it's fine to have them too but it does add some complexity which might not ever be needed.", "author": "anuraaga", "createdAt": "2020-02-27T06:15:39Z", "path": "core/src/main/java/com/linecorp/armeria/server/throttling/ThrottlingAcceptHandler.java", "diffHunk": "@@ -0,0 +1,46 @@\n+/*\n+ * Copyright 2018 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.linecorp.armeria.server.throttling;\n+\n+import com.linecorp.armeria.common.HttpRequest;\n+import com.linecorp.armeria.common.HttpResponse;\n+import com.linecorp.armeria.common.Request;\n+import com.linecorp.armeria.common.Response;\n+import com.linecorp.armeria.common.RpcRequest;\n+import com.linecorp.armeria.common.RpcResponse;\n+import com.linecorp.armeria.server.Service;\n+import com.linecorp.armeria.server.ServiceRequestContext;\n+\n+/**\n+ * A callback which is invoked to handle accepted (successful) requests indicated by {@link ThrottlingStrategy}.\n+ *\n+ * @param <I> the type of incoming {@link Request}. Must be {@link HttpRequest} or {@link RpcRequest}.\n+ * @param <O> the type of outgoing {@link Response}. Must be {@link HttpResponse} or {@link RpcResponse}.\n+ *\n+ * @see ThrottlingServiceBuilder#onAcceptedRequest(ThrottlingAcceptHandler)\n+ */\n+@FunctionalInterface\n+public interface ThrottlingAcceptHandler<I extends Request, O extends Response> {", "originalCommit": "11df63f285bbc90ce962c8e0ff1f4c055a9cbd3a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTUxMTU1Mw==", "url": "https://github.com/line/armeria/pull/2503#discussion_r385511553", "bodyText": "Remove delegate from reject handler (what can we expect other than not running delegate?)\n\nPerhaps delegating and then just counting?", "author": "trustin", "createdAt": "2020-02-28T05:17:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDkzMTEzMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTUxMjM0MQ==", "url": "https://github.com/line/armeria/pull/2503#discussion_r385512341", "bodyText": "I'd expect anything counting-related would be in the strategy. But not sure.", "author": "anuraaga", "createdAt": "2020-02-28T05:21:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDkzMTEzMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTc2NzQwMg==", "url": "https://github.com/line/armeria/pull/2503#discussion_r385767402", "bodyText": "Kept the way it is, similar to AuthService.", "author": "max904-github", "createdAt": "2020-02-28T15:42:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDkzMTEzMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjA4ODk0NQ==", "url": "https://github.com/line/armeria/pull/2503#discussion_r386088945", "bodyText": "Looking at AuthService was mainly for inspiration, and may be good to follow as is, or maybe can be tweaked to improve the API here it's all case-by-case. I think it may make sense to remove delegate from AuthService too after a second look, though that's another topic.\nHere, there is even more to worry about since the strategy will actually be counting and making throttling decisions. So an accept handler that doesn't call the delegate stands to mess up the strategy quite easily, as would a failure handler that does call it. Decoupling the execution of a service with the generation of an error response seems cleaner here unless there are other concerns.\nAnyways, the goal here is not to follow AuthService pattern word for word but to come up with a clean API for throttling.", "author": "anuraaga", "createdAt": "2020-03-01T08:47:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDkzMTEzMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjIzMjc2Mg==", "url": "https://github.com/line/armeria/pull/2503#discussion_r386232762", "bodyText": "I\u2019m slightly in favor of keeping the API as it is. A handle might want to insert some response header, schedule some task or increase a counter on accept/reject.", "author": "trustin", "createdAt": "2020-03-02T07:35:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDkzMTEzMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjIzODU4NA==", "url": "https://github.com/line/armeria/pull/2503#discussion_r386238584", "bodyText": "Pretty sure the strategy can do all of these too - but it's ok to keep it anyways. Let's make sure the javadoc is clear about the expected use of delegate, especially on failure where it will usually cause a problem.", "author": "anuraaga", "createdAt": "2020-03-02T07:54:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDkzMTEzMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDkzMTY1Ng==", "url": "https://github.com/line/armeria/pull/2503#discussion_r384931656", "bodyText": "Let's move lambdas to singleton constants", "author": "anuraaga", "createdAt": "2020-02-27T06:17:41Z", "path": "core/src/main/java/com/linecorp/armeria/server/throttling/ThrottlingServiceBuilder.java", "diffHunk": "@@ -0,0 +1,90 @@\n+/*\n+ * Copyright 2018 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.linecorp.armeria.server.throttling;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+import java.util.function.Function;\n+\n+import com.linecorp.armeria.common.HttpRequest;\n+import com.linecorp.armeria.common.HttpResponse;\n+import com.linecorp.armeria.common.HttpStatus;\n+import com.linecorp.armeria.server.HttpService;\n+import com.linecorp.armeria.server.Service;\n+\n+/**\n+ * Builds a new {@link ThrottlingService}.\n+ */\n+public class ThrottlingServiceBuilder extends AbstractThrottlingServiceBuilder<HttpRequest, HttpResponse> {\n+\n+    ThrottlingServiceBuilder() {}\n+\n+    /**\n+     * Sets {@link ThrottlingStrategy}.\n+     */\n+    public ThrottlingServiceBuilder strategy(ThrottlingStrategy<HttpRequest> strategy) {\n+        setStrategy(strategy);\n+        return this;\n+    }\n+\n+    /**\n+     * Sets {@link ThrottlingAcceptHandler}.\n+     */\n+    public ThrottlingServiceBuilder onAcceptedRequest(\n+            ThrottlingAcceptHandler<HttpRequest, HttpResponse> acceptHandler) {\n+        setAcceptHandler(acceptHandler);\n+        return this;\n+    }\n+\n+    /**\n+     * Sets {@link ThrottlingRejectHandler}.\n+     */\n+    public ThrottlingServiceBuilder onRejectedRequest(\n+            ThrottlingRejectHandler<HttpRequest, HttpResponse> rejectHandler) {\n+        setRejectHandler(rejectHandler);\n+        return this;\n+    }\n+\n+    /**\n+     * Provides default throttling reject behaviour for {@link HttpRequest}.\n+     * Returns an {@link HttpResponse} with {@link HttpStatus#TOO_MANY_REQUESTS}.\n+     */\n+    @Override\n+    protected ThrottlingRejectHandler<HttpRequest, HttpResponse> defaultRejectHandler() {\n+        return (delegate, ctx, req, cause) -> HttpResponse.of(HttpStatus.TOO_MANY_REQUESTS);", "originalCommit": "11df63f285bbc90ce962c8e0ff1f4c055a9cbd3a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTc2NzUxNg==", "url": "https://github.com/line/armeria/pull/2503#discussion_r385767516", "bodyText": "Moved", "author": "max904-github", "createdAt": "2020-02-28T15:42:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDkzMTY1Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDkzMTc1Ng==", "url": "https://github.com/line/armeria/pull/2503#discussion_r384931756", "bodyText": "Ditto", "author": "anuraaga", "createdAt": "2020-02-27T06:18:06Z", "path": "core/src/main/java/com/linecorp/armeria/server/throttling/ThrottlingRpcServiceBuilder.java", "diffHunk": "@@ -0,0 +1,92 @@\n+/*\n+ * Copyright 2018 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.linecorp.armeria.server.throttling;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+import java.util.function.Function;\n+\n+import com.linecorp.armeria.common.HttpStatus;\n+import com.linecorp.armeria.common.RpcRequest;\n+import com.linecorp.armeria.common.RpcResponse;\n+import com.linecorp.armeria.server.HttpStatusException;\n+import com.linecorp.armeria.server.RpcService;\n+import com.linecorp.armeria.server.Service;\n+\n+/**\n+ * Builds a new {@link ThrottlingRpcService}.\n+ */\n+public class ThrottlingRpcServiceBuilder extends AbstractThrottlingServiceBuilder<RpcRequest, RpcResponse> {\n+\n+    ThrottlingRpcServiceBuilder() {}\n+\n+    /**\n+     * Sets {@link ThrottlingStrategy}.\n+     */\n+    public ThrottlingRpcServiceBuilder strategy(ThrottlingStrategy<RpcRequest> strategy) {\n+        setStrategy(strategy);\n+        return this;\n+    }\n+\n+    /**\n+     * Sets {@link ThrottlingAcceptHandler}.\n+     */\n+    public ThrottlingRpcServiceBuilder onAcceptedRequest(\n+            ThrottlingAcceptHandler<RpcRequest, RpcResponse> acceptHandler) {\n+        setAcceptHandler(acceptHandler);\n+        return this;\n+    }\n+\n+    /**\n+     * Sets {@link ThrottlingRejectHandler}.\n+     */\n+    public ThrottlingRpcServiceBuilder onRejectedRequest(\n+            ThrottlingRejectHandler<RpcRequest, RpcResponse> rejectHandler) {\n+        setRejectHandler(rejectHandler);\n+        return this;\n+    }\n+\n+    /**\n+     * Provides default throttling reject behaviour for {@link RpcRequest}.\n+     * Responds with {@link HttpStatusException} with {@code 503 Service Unavailable}.\n+     */\n+    @Override\n+    protected ThrottlingRejectHandler<RpcRequest, RpcResponse> defaultRejectHandler() {\n+        return (delegate, ctx, req, cause) ->", "originalCommit": "11df63f285bbc90ce962c8e0ff1f4c055a9cbd3a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTc2NzY0MQ==", "url": "https://github.com/line/armeria/pull/2503#discussion_r385767641", "bodyText": "Moved", "author": "max904-github", "createdAt": "2020-02-28T15:42:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDkzMTc1Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDkzMjA5NA==", "url": "https://github.com/line/armeria/pull/2503#discussion_r384932094", "bodyText": "I think instead of having default*Handler methods we can initialize these to defaults instead of null. Doesn't hurt to add the accept handler to the constructor to be called with super in child builder.", "author": "anuraaga", "createdAt": "2020-02-27T06:19:25Z", "path": "core/src/main/java/com/linecorp/armeria/server/throttling/AbstractThrottlingServiceBuilder.java", "diffHunk": "@@ -0,0 +1,92 @@\n+/*\n+ * Copyright 2018 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.linecorp.armeria.server.throttling;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+import javax.annotation.Nullable;\n+\n+import com.linecorp.armeria.common.Request;\n+import com.linecorp.armeria.common.Response;\n+import com.linecorp.armeria.server.Service;\n+\n+/**\n+ * Builds a new {@link AbstractThrottlingService}.\n+ * @param <I> type of the request\n+ * @param <O> type of the response\n+ */\n+abstract class AbstractThrottlingServiceBuilder<I extends Request, O extends Response> {\n+\n+    @Nullable\n+    private ThrottlingStrategy<I> strategy;\n+    private ThrottlingAcceptHandler<I, O> acceptHandler;", "originalCommit": "11df63f285bbc90ce962c8e0ff1f4c055a9cbd3a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTc3MDk1Ng==", "url": "https://github.com/line/armeria/pull/2503#discussion_r385770956", "bodyText": "Kept the way it is", "author": "max904-github", "createdAt": "2020-02-28T15:48:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDkzMjA5NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjA4ODY2Nw==", "url": "https://github.com/line/armeria/pull/2503#discussion_r386088667", "bodyText": "Why?", "author": "anuraaga", "createdAt": "2020-03-01T08:43:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDkzMjA5NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjIzMzEyMQ==", "url": "https://github.com/line/armeria/pull/2503#discussion_r386233121", "bodyText": "Calling super with the default handlers sounds better to me.", "author": "trustin", "createdAt": "2020-03-02T07:36:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDkzMjA5NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjI4ODE5NA==", "url": "https://github.com/line/armeria/pull/2503#discussion_r386288194", "bodyText": "Why?\nBecause this is my design choice.\nDefaults are implementation specific and those aren't parameters (which they would become when passing them in the constructor). A descendant is capable of defining its own defaults, and in case of \"accept\" it's obligated to do so.\nLet me know if it violates any rules.", "author": "max904-github", "createdAt": "2020-03-02T09:47:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDkzMjA5NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjM3Nzk3Ng==", "url": "https://github.com/line/armeria/pull/2503#discussion_r386377976", "bodyText": "While there are some concepts defined as rules in our contributing guidelines, many are just principles and we use code review to share to contributors. In this case, we use methods as an indicator of our user API and prefer not to use methods for passing parameters to a base class (I'll have to disagree that default behavior isn't a \"parameter\"). These default handlers should be constants, and there isn't much value in having all subclasses manage the boilerplate to make them constants. Every project will have its own style and level of rigor and that's what we have code review for.", "author": "anuraaga", "createdAt": "2020-03-02T13:00:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDkzMjA5NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjUwNDI2NQ==", "url": "https://github.com/line/armeria/pull/2503#discussion_r386504265", "bodyText": "Defaults are defining the behavior of the each implementation - ThrottlingServiceBuilder and ThrottlingRpcServiceBuilder. Such behavior defined by the base class - AbstractThrottlingServiceBuilder. defaultRejectHandler() method is not part of the class hierarchy public API. And no one suggest/forces to create boilerplate anywhere.\nInheritance and this kind of non-public behavior enforcement used widely in Java programming, including Armeria. You can take com.linecorp.armeria.client.retry.AbstractBackoff hierarchy and its doNextDelayMillis() method.", "author": "max904-github", "createdAt": "2020-03-02T16:32:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDkzMjA5NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODk0MDc4NA==", "url": "https://github.com/line/armeria/pull/2503#discussion_r388940784", "bodyText": "Fixed", "author": "max904-github", "createdAt": "2020-03-06T14:42:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDkzMjA5NA=="}], "type": "inlineReview"}, {"oid": "18301d689d95667185e14c46f94ec3a78781b886", "url": "https://github.com/line/armeria/commit/18301d689d95667185e14c46f94ec3a78781b886", "message": "A fix for issue #2482 (Throttling failure response status shall be configurable):\n- changed to set strategy in the builder's constructor like the following ThrottlingRpcService.builder(strategy)...build().\n- made all methods package-private at AbstractThrottlingServiceBuilder.\n- moved lambdas to singleton constants at ThrottlingServiceBuilder, ThrottlingRpcServiceBuilder.\n- updated copyright date wherever applicable.\n- other minor refactoring.", "committedDate": "2020-02-28T15:58:16Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzQzMTQyMQ==", "url": "https://github.com/line/armeria/pull/2503#discussion_r387431421", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    this.responseConverter = requireNonNull(responseConverter);\n          \n          \n            \n                    this.acceptHandler = acceptHandler;\n          \n          \n            \n                    this.rejectHandler = rejectHandler;\n          \n          \n            \n                    this.responseConverter = requireNonNull(responseConverter, \"responseConverter\");\n          \n          \n            \n                    this.acceptHandler = requireNonNull(acceptHandler, \"acceptHandler\");\n          \n          \n            \n                    this.rejectHandler = requireNonNull(rejectHandler, \"rejectHandler);", "author": "ikhoon", "createdAt": "2020-03-04T03:29:40Z", "path": "core/src/main/java/com/linecorp/armeria/server/throttling/AbstractThrottlingService.java", "diffHunk": "@@ -38,41 +35,32 @@\n \n     private final ThrottlingStrategy<I> strategy;\n     private final Function<CompletionStage<? extends O>, O> responseConverter;\n+    private final ThrottlingAcceptHandler<I, O> acceptHandler;\n+    private final ThrottlingRejectHandler<I, O> rejectHandler;\n \n     /**\n      * Creates a new instance that decorates the specified {@link Service}.\n      */\n     protected AbstractThrottlingService(Service<I, O> delegate, ThrottlingStrategy<I> strategy,\n-                                        Function<CompletionStage<? extends O>, O> responseConverter) {\n+                                        Function<CompletionStage<? extends O>, O> responseConverter,\n+                                        ThrottlingAcceptHandler<I, O> acceptHandler,\n+                                        ThrottlingRejectHandler<I, O> rejectHandler) {\n         super(delegate);\n         this.strategy = requireNonNull(strategy, \"strategy\");\n         this.responseConverter = requireNonNull(responseConverter);\n+        this.acceptHandler = acceptHandler;\n+        this.rejectHandler = rejectHandler;", "originalCommit": "18301d689d95667185e14c46f94ec3a78781b886", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzg5NDkzMQ==", "url": "https://github.com/line/armeria/pull/2503#discussion_r387894931", "bodyText": "Fixed", "author": "max904-github", "createdAt": "2020-03-04T19:46:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzQzMTQyMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzQzNjUzOQ==", "url": "https://github.com/line/armeria/pull/2503#discussion_r387436539", "bodyText": "Remove @Nullable?\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                @Nullable\n          \n          \n            \n                private final ThrottlingStrategy<I> strategy;\n          \n          \n            \n                private final ThrottlingStrategy<I> strategy;", "author": "ikhoon", "createdAt": "2020-03-04T03:53:58Z", "path": "core/src/main/java/com/linecorp/armeria/server/throttling/AbstractThrottlingServiceBuilder.java", "diffHunk": "@@ -0,0 +1,86 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.linecorp.armeria.server.throttling;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+import javax.annotation.Nullable;\n+\n+import com.linecorp.armeria.common.Request;\n+import com.linecorp.armeria.common.Response;\n+import com.linecorp.armeria.server.Service;\n+\n+/**\n+ * Builds a new {@link AbstractThrottlingService}.\n+ * @param <I> type of the request\n+ * @param <O> type of the response\n+ */\n+abstract class AbstractThrottlingServiceBuilder<I extends Request, O extends Response> {\n+\n+    @Nullable\n+    private final ThrottlingStrategy<I> strategy;", "originalCommit": "18301d689d95667185e14c46f94ec3a78781b886", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzg5NTAxMQ==", "url": "https://github.com/line/armeria/pull/2503#discussion_r387895011", "bodyText": "Fixed", "author": "max904-github", "createdAt": "2020-03-04T19:46:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzQzNjUzOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzQzNjY4Ng==", "url": "https://github.com/line/armeria/pull/2503#discussion_r387436686", "bodyText": "I think we can remove this.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    if (strategy == null) {\n          \n          \n            \n                        throw new IllegalStateException(\"no \" + ThrottlingStrategy.class.getSimpleName() + \" was added.\");\n          \n          \n            \n                    }", "author": "ikhoon", "createdAt": "2020-03-04T03:54:45Z", "path": "core/src/main/java/com/linecorp/armeria/server/throttling/AbstractThrottlingServiceBuilder.java", "diffHunk": "@@ -0,0 +1,86 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.linecorp.armeria.server.throttling;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+import javax.annotation.Nullable;\n+\n+import com.linecorp.armeria.common.Request;\n+import com.linecorp.armeria.common.Response;\n+import com.linecorp.armeria.server.Service;\n+\n+/**\n+ * Builds a new {@link AbstractThrottlingService}.\n+ * @param <I> type of the request\n+ * @param <O> type of the response\n+ */\n+abstract class AbstractThrottlingServiceBuilder<I extends Request, O extends Response> {\n+\n+    @Nullable\n+    private final ThrottlingStrategy<I> strategy;\n+    private ThrottlingAcceptHandler<I, O> acceptHandler;\n+    private ThrottlingRejectHandler<I, O> rejectHandler;\n+\n+    AbstractThrottlingServiceBuilder(ThrottlingStrategy<I> strategy) {\n+        this.strategy = requireNonNull(strategy, \"strategy\");\n+        acceptHandler = requireNonNull(defaultAcceptHandler(), \"defaultAcceptHandler\");\n+        rejectHandler = requireNonNull(defaultRejectHandler(), \"defaultRejectHandler\");\n+    }\n+\n+    /**\n+     * Provides default request accept handler.\n+     */\n+    ThrottlingAcceptHandler<I, O> defaultAcceptHandler() {\n+        return Service::serve;\n+    }\n+\n+    /**\n+     * Provides default request reject handler.\n+     */\n+    abstract ThrottlingRejectHandler<I, O> defaultRejectHandler();\n+\n+    final ThrottlingStrategy<I> getStrategy() {\n+        if (strategy == null) {\n+            throw new IllegalStateException(\"no \" + ThrottlingStrategy.class.getSimpleName() + \" was added.\");\n+        }", "originalCommit": "18301d689d95667185e14c46f94ec3a78781b886", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzg5NTA4Nw==", "url": "https://github.com/line/armeria/pull/2503#discussion_r387895087", "bodyText": "Fixed", "author": "max904-github", "createdAt": "2020-03-04T19:47:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzQzNjY4Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzQzOTc2OA==", "url": "https://github.com/line/armeria/pull/2503#discussion_r387439768", "bodyText": "Why don't we add a test for a custom reject handler?", "author": "ikhoon", "createdAt": "2020-03-04T04:10:39Z", "path": "core/src/test/java/com/linecorp/armeria/server/throttling/ThrottlingServiceTest.java", "diffHunk": "@@ -46,8 +47,13 @@ protected HttpResponse doGet(ServiceRequestContext ctx, HttpRequest req)\n     public ServerRule serverRule = new ServerRule() {\n         @Override\n         protected void configure(ServerBuilder sb) throws Exception {\n-            sb.service(\"/http-never\", SERVICE.decorate(ThrottlingService.newDecorator(never())));\n             sb.service(\"/http-always\", SERVICE.decorate(ThrottlingService.newDecorator(always())));\n+            sb.service(\"/http-never\", SERVICE.decorate(ThrottlingService.newDecorator(never())));\n+            sb.service(\"/http-never-custom\", SERVICE.decorate(\n+                    ThrottlingService.newDecorator(ThrottlingStrategy.of((ctx, req) -> completedFuture(false)),", "originalCommit": "18301d689d95667185e14c46f94ec3a78781b886", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzg5NTcwNA==", "url": "https://github.com/line/armeria/pull/2503#discussion_r387895704", "bodyText": "Do you mean custom \"accept\" handler? If yes, I've added a new test for it.", "author": "max904-github", "createdAt": "2020-03-04T19:48:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzQzOTc2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODAzNjI1Nw==", "url": "https://github.com/line/armeria/pull/2503#discussion_r388036257", "bodyText": "Ah, Thanks!", "author": "ikhoon", "createdAt": "2020-03-05T01:46:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzQzOTc2OA=="}], "type": "inlineReview"}, {"oid": "5b8fcf10c2eda15338ab875702aef892f8e0d1b6", "url": "https://github.com/line/armeria/commit/5b8fcf10c2eda15338ab875702aef892f8e0d1b6", "message": "Incorporated review feedback by @ikhoon", "committedDate": "2020-03-04T19:46:07Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODMwNzEwNg==", "url": "https://github.com/line/armeria/pull/2503#discussion_r388307106", "bodyText": "nit: final\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            public class ThrottlingRpcServiceBuilder extends AbstractThrottlingServiceBuilder<RpcRequest, RpcResponse> {\n          \n          \n            \n            public final class ThrottlingRpcServiceBuilder\n          \n          \n            \n                    extends AbstractThrottlingServiceBuilder<RpcRequest, RpcResponse> {", "author": "trustin", "createdAt": "2020-03-05T13:55:31Z", "path": "core/src/main/java/com/linecorp/armeria/server/throttling/ThrottlingRpcServiceBuilder.java", "diffHunk": "@@ -0,0 +1,89 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.linecorp.armeria.server.throttling;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+import java.util.function.Function;\n+\n+import com.linecorp.armeria.common.HttpStatus;\n+import com.linecorp.armeria.common.RpcRequest;\n+import com.linecorp.armeria.common.RpcResponse;\n+import com.linecorp.armeria.server.HttpStatusException;\n+import com.linecorp.armeria.server.RpcService;\n+import com.linecorp.armeria.server.Service;\n+\n+/**\n+ * Builds a new {@link ThrottlingRpcService}.\n+ */\n+public class ThrottlingRpcServiceBuilder extends AbstractThrottlingServiceBuilder<RpcRequest, RpcResponse> {", "originalCommit": "5b8fcf10c2eda15338ab875702aef892f8e0d1b6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODgzMTk3Mw==", "url": "https://github.com/line/armeria/pull/2503#discussion_r388831973", "bodyText": "Fixed", "author": "max904-github", "createdAt": "2020-03-06T10:40:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODMwNzEwNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODMwNzUzMg==", "url": "https://github.com/line/armeria/pull/2503#discussion_r388307532", "bodyText": "nit: final\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            public class ThrottlingServiceBuilder extends AbstractThrottlingServiceBuilder<HttpRequest, HttpResponse> {\n          \n          \n            \n            public final class ThrottlingServiceBuilder\n          \n          \n            \n                    extends AbstractThrottlingServiceBuilder<HttpRequest, HttpResponse> {", "author": "trustin", "createdAt": "2020-03-05T13:56:06Z", "path": "core/src/main/java/com/linecorp/armeria/server/throttling/ThrottlingServiceBuilder.java", "diffHunk": "@@ -0,0 +1,87 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.linecorp.armeria.server.throttling;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+import java.util.function.Function;\n+\n+import com.linecorp.armeria.common.HttpRequest;\n+import com.linecorp.armeria.common.HttpResponse;\n+import com.linecorp.armeria.common.HttpStatus;\n+import com.linecorp.armeria.server.HttpService;\n+import com.linecorp.armeria.server.Service;\n+\n+/**\n+ * Builds a new {@link ThrottlingService}.\n+ */\n+public class ThrottlingServiceBuilder extends AbstractThrottlingServiceBuilder<HttpRequest, HttpResponse> {", "originalCommit": "5b8fcf10c2eda15338ab875702aef892f8e0d1b6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODgzMjAzMA==", "url": "https://github.com/line/armeria/pull/2503#discussion_r388832030", "bodyText": "Fixed", "author": "max904-github", "createdAt": "2020-03-06T10:40:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODMwNzUzMg=="}], "type": "inlineReview"}, {"oid": "82b411b24194be0941ce26672fb940cc5adedc1f", "url": "https://github.com/line/armeria/commit/82b411b24194be0941ce26672fb940cc5adedc1f", "message": "Incorporated review feedback by @trustin", "committedDate": "2020-03-06T10:32:11Z", "type": "commit"}, {"oid": "f8d0593927f03209275992af95c4b25c4ff5b566", "url": "https://github.com/line/armeria/commit/f8d0593927f03209275992af95c4b25c4ff5b566", "message": "Incorporated review feedback by @anuraaga", "committedDate": "2020-03-06T14:41:37Z", "type": "commit"}]}