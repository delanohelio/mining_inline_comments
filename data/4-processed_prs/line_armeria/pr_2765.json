{"pr_number": 2765, "pr_title": "Return HTTP/1.1 connection to the pool after request is complete", "pr_createdAt": "2020-06-03T04:19:33Z", "pr_url": "https://github.com/line/armeria/pull/2765", "timeline": [{"oid": "eac21cf2c0190d55cb19567517cabc3ffb0353f0", "url": "https://github.com/line/armeria/commit/eac21cf2c0190d55cb19567517cabc3ffb0353f0", "message": "Return HTTP/1.1 connection to the pool after request is compelete\nMotivation:\nWhen an HTTP/1.1 connection is reused, the connection should be returned to the pool after the request and response are complete.\n\nModification:\n- Return the HTTP/1.1 connection to the pool after request and response are complete if pipelining is not enabled.\n\nResult:\n- You no longer see `EncoderException` when reusing the HTTP/1.1 connections.", "committedDate": "2020-06-03T04:18:36Z", "type": "commit"}, {"oid": "c04931bff5c6a846433698c2bd13f45e7c5086fa", "url": "https://github.com/line/armeria/commit/c04931bff5c6a846433698c2bd13f45e7c5086fa", "message": "Fix checkstyle", "committedDate": "2020-06-03T04:26:53Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDMwNTI5Ng==", "url": "https://github.com/line/armeria/pull/2765#discussion_r434305296", "bodyText": "How about using CompletableFuture.allOf(...)?", "author": "ikhoon", "createdAt": "2020-06-03T04:47:36Z", "path": "core/src/main/java/com/linecorp/armeria/client/HttpSessionHandler.java", "diffHunk": "@@ -167,9 +167,11 @@ public void invoke(PooledChannel pooledChannel, ClientRequestContext ctx,\n         if (!protocol.isMultiplex()) {\n             // When HTTP/1.1 is used:\n             // If pipelining is enabled, return as soon as the request is fully sent.\n-            // If pipelining is disabled, return after the response is fully received.\n+            // If pipelining is disabled,\n+            // return after the response is fully received and the request is fully sent.\n             final CompletableFuture<Void> completionFuture =\n-                    useHttp1Pipelining ? req.whenComplete() : res.whenComplete();\n+                    useHttp1Pipelining ? req.whenComplete()\n+                                       : req.whenComplete().thenCombine(res.whenComplete(), (a, b) -> null);", "originalCommit": "c04931bff5c6a846433698c2bd13f45e7c5086fa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDMxNDEwNA==", "url": "https://github.com/line/armeria/pull/2765#discussion_r434314104", "bodyText": "Fixed. \ud83d\ude09", "author": "minwoox", "createdAt": "2020-06-03T05:21:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDMwNTI5Ng=="}], "type": "inlineReview"}, {"oid": "60747825b84ac33e0c42180ce95bc48e8471bc35", "url": "https://github.com/line/armeria/commit/60747825b84ac33e0c42180ce95bc48e8471bc35", "message": "Use allOf", "committedDate": "2020-06-03T05:21:33Z", "type": "commit"}]}