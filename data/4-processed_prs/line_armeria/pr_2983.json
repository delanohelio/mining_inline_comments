{"pr_number": 2983, "pr_title": "Support Kotlin suspending functions for annotated services", "pr_createdAt": "2020-08-09T17:59:03Z", "pr_url": "https://github.com/line/armeria/pull/2983", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzY2NzYwNg==", "url": "https://github.com/line/armeria/pull/2983#discussion_r467667606", "bodyText": "Hello, @okue.\nThis looks good and Kotlin users could use Armeria well with the Coroutine after this PR is merged.\nHowever, this will bring additional dependencies to the users who don't use Kotlin.\nSo, we have to make a dedicated module for this purpose.\nThen, if the dependency is in the class path, we can enable Coroutine support.\nThis is one of the approaches we do for checking the dependencies:\nhttps://github.com/line/armeria/blob/master/spring/boot2-autoconfigure/src/main/java/com/linecorp/armeria/internal/spring/ArmeriaConfigurationUtil.java#L127\nThis is an example to call a method using MethodHandles\nhttps://github.com/line/armeria/blob/master/spring/boot2-actuator-autoconfigure/src/main/java/com/linecorp/armeria/spring/actuate/WebOperationService.java#L96\nPlease note that the method handle is initialized only once, so that we don't do expensive operations every time we call invoke.", "author": "minwoox", "createdAt": "2020-08-10T02:53:50Z", "path": "core/src/main/java/com/linecorp/armeria/internal/server/annotation/AnnotatedService.java", "diffHunk": "@@ -300,7 +304,14 @@ private Object invoke(ServiceRequestContext ctx, HttpRequest req,\n         try (SafeCloseable ignored = ctx.push()) {\n             final ResolverContext resolverContext = new ResolverContext(ctx, req, aggregatedRequest);\n             final Object[] arguments = AnnotatedValueResolver.toArguments(resolvers, resolverContext);\n-            return method.invoke(object, arguments);\n+            if (CoroutineUtil.isSuspendingFunction(method)) {\n+                return CoroutineUtil.invokeSuspendingFunction(", "originalCommit": "a1b35b2839994c83ec99c8c8e9f927b3019390ad", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzY2OTk4Mg==", "url": "https://github.com/line/armeria/pull/2983#discussion_r467669982", "bodyText": "Thanks for a nice advice \ud83d\ude4f\nTests failed due to the problem you mentioned.", "author": "okue", "createdAt": "2020-08-10T03:07:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzY2NzYwNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzcwNDA2Mg==", "url": "https://github.com/line/armeria/pull/2983#discussion_r467704062", "bodyText": "What I meant was that making a separate module not a package so that we can put\nimplementation \"org.jetbrains.kotlinx:kotlinx-coroutines-jdk8\"\nimplementation \"org.jetbrains.kotlin:kotlin-reflect\"\n\nthese dependencies and the related code into that module so that core module does not depend on Kotlin. \ud83d\ude04\nWe might name the module as kotlin /cc @trustin, @ikhoon", "author": "minwoox", "createdAt": "2020-08-10T06:14:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzY2NzYwNg=="}], "type": "inlineReview"}, {"oid": "b007fae05d167bd8b58111d9fb4f04791876331e", "url": "https://github.com/line/armeria/commit/b007fae05d167bd8b58111d9fb4f04791876331e", "message": "Support kotlin coroutines for AnnotatedService", "committedDate": "2020-08-10T04:33:08Z", "type": "forcePushed"}, {"oid": "c8262197c805f150aafb07033e5e6920e0e63709", "url": "https://github.com/line/armeria/commit/c8262197c805f150aafb07033e5e6920e0e63709", "message": "Support kotlin coroutines for AnnotatedService", "committedDate": "2020-08-10T04:42:35Z", "type": "forcePushed"}, {"oid": "fac72b04c62496a2441b8210c751f49631c6d5c9", "url": "https://github.com/line/armeria/commit/fac72b04c62496a2441b8210c751f49631c6d5c9", "message": "Support kotlin coroutines for AnnotatedService", "committedDate": "2020-08-10T05:34:34Z", "type": "forcePushed"}, {"oid": "df0f86b5c2b59c9a238c3c69eb3eae37c29aeed1", "url": "https://github.com/line/armeria/commit/df0f86b5c2b59c9a238c3c69eb3eae37c29aeed1", "message": "Support kotlin coroutines for AnnotatedService", "committedDate": "2020-08-10T05:47:50Z", "type": "forcePushed"}, {"oid": "de44af21a7293efd6673324b7eb612584cac735a", "url": "https://github.com/line/armeria/commit/de44af21a7293efd6673324b7eb612584cac735a", "message": "Support kotlin coroutines for AnnotatedService", "committedDate": "2020-08-10T06:14:12Z", "type": "forcePushed"}, {"oid": "002e3f274b4d4eec65e8f54d51c61503be6e630a", "url": "https://github.com/line/armeria/commit/002e3f274b4d4eec65e8f54d51c61503be6e630a", "message": "Support kotlin coroutines for AnnotatedService", "committedDate": "2020-08-10T07:00:30Z", "type": "forcePushed"}, {"oid": "9bd3c0d84f61caba286386723bc4c1951dc7eb69", "url": "https://github.com/line/armeria/commit/9bd3c0d84f61caba286386723bc4c1951dc7eb69", "message": "Support kotlin coroutines for AnnotatedService", "committedDate": "2020-08-10T08:10:13Z", "type": "forcePushed"}, {"oid": "d7d956edbc52d5754bf499e95030a6c3984f1481", "url": "https://github.com/line/armeria/commit/d7d956edbc52d5754bf499e95030a6c3984f1481", "message": "Support kotlin coroutines for AnnotatedService", "committedDate": "2020-08-10T08:34:59Z", "type": "forcePushed"}, {"oid": "0e3a970b763e8935e0bb2dba8c8779264b84dbdf", "url": "https://github.com/line/armeria/commit/0e3a970b763e8935e0bb2dba8c8779264b84dbdf", "message": "Support kotlin coroutines for AnnotatedService", "committedDate": "2020-08-10T08:58:50Z", "type": "forcePushed"}, {"oid": "73111e817c557d5911e018cb37a8bd0ebfea0279", "url": "https://github.com/line/armeria/commit/73111e817c557d5911e018cb37a8bd0ebfea0279", "message": "Support kotlin coroutines for AnnotatedService", "committedDate": "2020-08-10T09:18:15Z", "type": "forcePushed"}, {"oid": "af49092239514fb84746c26738ab681c0ba158bf", "url": "https://github.com/line/armeria/commit/af49092239514fb84746c26738ab681c0ba158bf", "message": "Support kotlin coroutines for AnnotatedService", "committedDate": "2020-08-10T09:46:40Z", "type": "forcePushed"}, {"oid": "64e2f4a147f45bd178b8f4c33ef5a6198762c9e4", "url": "https://github.com/line/armeria/commit/64e2f4a147f45bd178b8f4c33ef5a6198762c9e4", "message": "Support kotlin coroutines for AnnotatedService", "committedDate": "2020-08-10T10:19:24Z", "type": "forcePushed"}, {"oid": "726e515421ba0a191a6da4f795a108b8acd82ee9", "url": "https://github.com/line/armeria/commit/726e515421ba0a191a6da4f795a108b8acd82ee9", "message": "Support kotlin coroutines for AnnotatedService", "committedDate": "2020-08-10T14:57:48Z", "type": "forcePushed"}, {"oid": "37b87aa8295260a25255f37ee3b084d4503df1c3", "url": "https://github.com/line/armeria/commit/37b87aa8295260a25255f37ee3b084d4503df1c3", "message": "Support kotlin coroutines for AnnotatedService", "committedDate": "2020-08-10T16:04:53Z", "type": "forcePushed"}, {"oid": "72af8215e42202830e1f8443bcd13f97b147f83d", "url": "https://github.com/line/armeria/commit/72af8215e42202830e1f8443bcd13f97b147f83d", "message": "Support kotlin coroutines for AnnotatedService", "committedDate": "2020-08-10T16:13:29Z", "type": "commit"}, {"oid": "72af8215e42202830e1f8443bcd13f97b147f83d", "url": "https://github.com/line/armeria/commit/72af8215e42202830e1f8443bcd13f97b147f83d", "message": "Support kotlin coroutines for AnnotatedService", "committedDate": "2020-08-10T16:13:29Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODMxNzUzMw==", "url": "https://github.com/line/armeria/pull/2983#discussion_r468317533", "bodyText": "nit:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private final Boolean isKotlinSuspendingMethod;\n          \n          \n            \n                private final boolean isKotlinSuspendingMethod;", "author": "ikhoon", "createdAt": "2020-08-11T04:20:41Z", "path": "core/src/main/java/com/linecorp/armeria/internal/server/annotation/AnnotatedService.java", "diffHunk": "@@ -97,6 +99,7 @@\n \n     private final Object object;\n     private final Method method;\n+    private final Boolean isKotlinSuspendingMethod;", "originalCommit": "72af8215e42202830e1f8443bcd13f97b147f83d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODMyMTM2MA==", "url": "https://github.com/line/armeria/pull/2983#discussion_r468321360", "bodyText": "nit: requireNonNull(provider, \"provider\")", "author": "ikhoon", "createdAt": "2020-08-11T04:36:55Z", "path": "core/src/main/java/com/linecorp/armeria/server/kotlin/CoroutineContextService.java", "diffHunk": "@@ -0,0 +1,70 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.server.kotlin;\n+\n+import java.util.function.Function;\n+\n+import com.linecorp.armeria.common.HttpRequest;\n+import com.linecorp.armeria.common.HttpResponse;\n+import com.linecorp.armeria.server.HttpService;\n+import com.linecorp.armeria.server.ServiceRequestContext;\n+import com.linecorp.armeria.server.SimpleDecoratingHttpService;\n+\n+/**\n+ * Decorates an {@link HttpService} to configure the coroutine context which is used as an initial context\n+ * of annotated services' suspending functions.\n+ *\n+ * <p>Example:\n+ * <pre>{@code\n+ * > serverBuilder\n+ * >     .annotatedService(object {\n+ * >         @Get(\"/users/{uid}\")\n+ * >         suspend fun foo(@Param(\"uid\") uid: String): HttpResponse {\n+ * >             ...\n+ * >         }\n+ * >     })\n+ * >     .decorator(CoroutineContextService.newDecorator { ctx ->\n+ * >         ctx.eventLoop().asCoroutineDispatcher() +\n+ * >             CoroutineName(ctx.config().defaultServiceName() ?: \"none\")\n+ * >     })\n+ * }\n+ * </pre>\n+ */\n+public class CoroutineContextService extends SimpleDecoratingHttpService {\n+\n+    /**\n+     * Returns a new {@link HttpService} decorator that injects into annotated services the coroutine context\n+     * provided by the specified {@code provider}.\n+     */\n+    public static Function<? super HttpService, CoroutineContextService> newDecorator(\n+            CoroutineContextProvider provider) {", "originalCommit": "72af8215e42202830e1f8443bcd13f97b147f83d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODMyMTk3OQ==", "url": "https://github.com/line/armeria/pull/2983#discussion_r468321979", "bodyText": "nit: requireNonNull", "author": "ikhoon", "createdAt": "2020-08-11T04:39:37Z", "path": "core/src/main/java/com/linecorp/armeria/server/kotlin/CoroutineContextUtil.java", "diffHunk": "@@ -0,0 +1,57 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.server.kotlin;\n+\n+import javax.annotation.Nullable;\n+\n+import com.linecorp.armeria.common.RequestContext;\n+import com.linecorp.armeria.internal.server.annotation.AnnotatedService;\n+\n+import io.netty.util.AttributeKey;\n+import kotlin.coroutines.CoroutineContext;\n+\n+/**\n+ * Configures a coroutine context for annotated services and Kotlin suspending functions.\n+ *\n+ * @see CoroutineContextService\n+ */\n+public final class CoroutineContextUtil {\n+\n+    /**\n+     * {@link AnnotatedService} uses a coroutine context associated with this attribute\n+     * when calling suspending functions.\n+     */\n+    public static final AttributeKey<CoroutineContext> COROUTINE_CONTEXT_KEY =\n+            AttributeKey.valueOf(CoroutineContextUtil.class, \"COROUTINE_CONTEXT_KEY\");\n+\n+    /**\n+     * Associates the given coroutine context with {@code COROUTINE_CONTEXT_KEY} attribute in the context.\n+     */\n+    public static void setCoroutineContext(RequestContext ctx, CoroutineContext coroutineContext) {", "originalCommit": "72af8215e42202830e1f8443bcd13f97b147f83d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODMyMzY1MA==", "url": "https://github.com/line/armeria/pull/2983#discussion_r468323650", "bodyText": "Add check for the returned value? such as\nrequiredNonNull(provider.provide(ctx), \"provider returned null\")", "author": "ikhoon", "createdAt": "2020-08-11T04:46:09Z", "path": "core/src/main/java/com/linecorp/armeria/server/kotlin/CoroutineContextService.java", "diffHunk": "@@ -0,0 +1,70 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.server.kotlin;\n+\n+import java.util.function.Function;\n+\n+import com.linecorp.armeria.common.HttpRequest;\n+import com.linecorp.armeria.common.HttpResponse;\n+import com.linecorp.armeria.server.HttpService;\n+import com.linecorp.armeria.server.ServiceRequestContext;\n+import com.linecorp.armeria.server.SimpleDecoratingHttpService;\n+\n+/**\n+ * Decorates an {@link HttpService} to configure the coroutine context which is used as an initial context\n+ * of annotated services' suspending functions.\n+ *\n+ * <p>Example:\n+ * <pre>{@code\n+ * > serverBuilder\n+ * >     .annotatedService(object {\n+ * >         @Get(\"/users/{uid}\")\n+ * >         suspend fun foo(@Param(\"uid\") uid: String): HttpResponse {\n+ * >             ...\n+ * >         }\n+ * >     })\n+ * >     .decorator(CoroutineContextService.newDecorator { ctx ->\n+ * >         ctx.eventLoop().asCoroutineDispatcher() +\n+ * >             CoroutineName(ctx.config().defaultServiceName() ?: \"none\")\n+ * >     })\n+ * }\n+ * </pre>\n+ */\n+public class CoroutineContextService extends SimpleDecoratingHttpService {\n+\n+    /**\n+     * Returns a new {@link HttpService} decorator that injects into annotated services the coroutine context\n+     * provided by the specified {@code provider}.\n+     */\n+    public static Function<? super HttpService, CoroutineContextService> newDecorator(\n+            CoroutineContextProvider provider) {\n+        return delegate -> new CoroutineContextService(delegate, provider);\n+    }\n+\n+    private final CoroutineContextProvider provider;\n+\n+    CoroutineContextService(HttpService delegate, CoroutineContextProvider provider) {\n+        super(delegate);\n+        this.provider = provider;\n+    }\n+\n+    @Override\n+    public HttpResponse serve(ServiceRequestContext ctx, HttpRequest req) throws Exception {\n+        CoroutineContextUtil.setCoroutineContext(ctx, provider.provide(ctx));", "originalCommit": "72af8215e42202830e1f8443bcd13f97b147f83d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODMyNDY1NQ==", "url": "https://github.com/line/armeria/pull/2983#discussion_r468324655", "bodyText": "ditto", "author": "ikhoon", "createdAt": "2020-08-11T04:50:13Z", "path": "core/src/main/java/com/linecorp/armeria/server/kotlin/CoroutineContextUtil.java", "diffHunk": "@@ -0,0 +1,57 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.server.kotlin;\n+\n+import javax.annotation.Nullable;\n+\n+import com.linecorp.armeria.common.RequestContext;\n+import com.linecorp.armeria.internal.server.annotation.AnnotatedService;\n+\n+import io.netty.util.AttributeKey;\n+import kotlin.coroutines.CoroutineContext;\n+\n+/**\n+ * Configures a coroutine context for annotated services and Kotlin suspending functions.\n+ *\n+ * @see CoroutineContextService\n+ */\n+public final class CoroutineContextUtil {\n+\n+    /**\n+     * {@link AnnotatedService} uses a coroutine context associated with this attribute\n+     * when calling suspending functions.\n+     */\n+    public static final AttributeKey<CoroutineContext> COROUTINE_CONTEXT_KEY =\n+            AttributeKey.valueOf(CoroutineContextUtil.class, \"COROUTINE_CONTEXT_KEY\");\n+\n+    /**\n+     * Associates the given coroutine context with {@code COROUTINE_CONTEXT_KEY} attribute in the context.\n+     */\n+    public static void setCoroutineContext(RequestContext ctx, CoroutineContext coroutineContext) {\n+        ctx.setAttr(COROUTINE_CONTEXT_KEY, coroutineContext);\n+    }\n+\n+    /**\n+     * Returns the coroutine context mapped to {@code COROUTINE_CONTEXT_KEY} in the context.\n+     */\n+    @Nullable\n+    public static CoroutineContext getCoroutineContext(RequestContext ctx) {", "originalCommit": "72af8215e42202830e1f8443bcd13f97b147f83d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "1c23b2965c59683ea51e2da9d52e7acec9f99481", "url": "https://github.com/line/armeria/commit/1c23b2965c59683ea51e2da9d52e7acec9f99481", "message": "address comments", "committedDate": "2020-08-11T12:09:32Z", "type": "commit"}, {"oid": "64f6d76cd5a9197ea3a3559947d82e60d9ace136", "url": "https://github.com/line/armeria/commit/64f6d76cd5a9197ea3a3559947d82e60d9ace136", "message": "Modify packages", "committedDate": "2020-08-11T12:59:42Z", "type": "commit"}, {"oid": "64f6d76cd5a9197ea3a3559947d82e60d9ace136", "url": "https://github.com/line/armeria/commit/64f6d76cd5a9197ea3a3559947d82e60d9ace136", "message": "Modify packages", "committedDate": "2020-08-11T12:59:42Z", "type": "forcePushed"}, {"oid": "864aa9958469c619f5a82887d84570dfef3aab73", "url": "https://github.com/line/armeria/commit/864aa9958469c619f5a82887d84570dfef3aab73", "message": "Separate kotlin dependencies from :core", "committedDate": "2020-08-11T17:00:32Z", "type": "commit"}, {"oid": "9204a243fa0a83e4736b023976cf613a43e1f5ca", "url": "https://github.com/line/armeria/commit/9204a243fa0a83e4736b023976cf613a43e1f5ca", "message": "Add ktlint", "committedDate": "2020-08-11T18:30:44Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODk4OTU4MQ==", "url": "https://github.com/line/armeria/pull/2983#discussion_r468989581", "bodyText": "Could be private?", "author": "trustin", "createdAt": "2020-08-12T03:52:55Z", "path": "kotlin/src/main/java/com/linecorp/armeria/common/kotlin/CoroutineContextUtil.java", "diffHunk": "@@ -0,0 +1,63 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.common.kotlin;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+import javax.annotation.Nullable;\n+\n+import com.linecorp.armeria.common.RequestContext;\n+import com.linecorp.armeria.internal.server.annotation.AnnotatedService;\n+import com.linecorp.armeria.server.kotlin.CoroutineContextService;\n+\n+import io.netty.util.AttributeKey;\n+import kotlin.coroutines.CoroutineContext;\n+\n+/**\n+ * Configures a coroutine context for annotated services and Kotlin suspending functions.\n+ *\n+ * @see CoroutineContextService\n+ */\n+public final class CoroutineContextUtil {\n+\n+    /**\n+     * {@link AnnotatedService} uses a coroutine context associated with this attribute\n+     * when calling suspending functions.\n+     */\n+    public static final AttributeKey<CoroutineContext> COROUTINE_CONTEXT_KEY =", "originalCommit": "9204a243fa0a83e4736b023976cf613a43e1f5ca", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODk4OTY5Mg==", "url": "https://github.com/line/armeria/pull/2983#discussion_r468989692", "bodyText": "How about CoroutineContexts unless there's a class with the same name in Kotlin?", "author": "trustin", "createdAt": "2020-08-12T03:53:25Z", "path": "kotlin/src/main/java/com/linecorp/armeria/common/kotlin/CoroutineContextUtil.java", "diffHunk": "@@ -0,0 +1,63 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.common.kotlin;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+import javax.annotation.Nullable;\n+\n+import com.linecorp.armeria.common.RequestContext;\n+import com.linecorp.armeria.internal.server.annotation.AnnotatedService;\n+import com.linecorp.armeria.server.kotlin.CoroutineContextService;\n+\n+import io.netty.util.AttributeKey;\n+import kotlin.coroutines.CoroutineContext;\n+\n+/**\n+ * Configures a coroutine context for annotated services and Kotlin suspending functions.\n+ *\n+ * @see CoroutineContextService\n+ */\n+public final class CoroutineContextUtil {", "originalCommit": "9204a243fa0a83e4736b023976cf613a43e1f5ca", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODk4OTkzOA==", "url": "https://github.com/line/armeria/pull/2983#discussion_r468989938", "bodyText": "Update Javadoc?", "author": "trustin", "createdAt": "2020-08-12T03:54:26Z", "path": "kotlin/src/main/java/com/linecorp/armeria/common/kotlin/package-info.java", "diffHunk": "@@ -0,0 +1,23 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+/**\n+ * Various classes used internally. Anything in this package can be changed or removed at any time.", "originalCommit": "9204a243fa0a83e4736b023976cf613a43e1f5ca", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODk5MDE2Mg==", "url": "https://github.com/line/armeria/pull/2983#discussion_r468990162", "bodyText": "Update Javadoc?", "author": "trustin", "createdAt": "2020-08-12T03:55:18Z", "path": "kotlin/src/main/java/com/linecorp/armeria/server/kotlin/package-info.java", "diffHunk": "@@ -0,0 +1,23 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+/**\n+ * Various classes used internally. Anything in this package can be changed or removed at any time.", "originalCommit": "9204a243fa0a83e4736b023976cf613a43e1f5ca", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODk5MDI4Mg==", "url": "https://github.com/line/armeria/pull/2983#discussion_r468990282", "bodyText": "'is not a'", "author": "trustin", "createdAt": "2020-08-12T03:55:43Z", "path": "kotlin/src/main/kotlin/com/linecorp/armeria/internal/common/kotlin/CoroutineUtil.kt", "diffHunk": "@@ -0,0 +1,49 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+@file:JvmName(\"CoroutineUtil\")\n+\n+package com.linecorp.armeria.internal.common.kotlin\n+\n+import com.linecorp.armeria.common.RequestContext\n+import com.linecorp.armeria.common.kotlin.CoroutineContextUtil\n+import kotlinx.coroutines.Dispatchers\n+import kotlinx.coroutines.GlobalScope\n+import kotlinx.coroutines.future.future\n+import java.lang.reflect.Method\n+import java.util.concurrent.CompletableFuture\n+import kotlin.coroutines.EmptyCoroutineContext\n+import kotlin.reflect.full.callSuspend\n+import kotlin.reflect.jvm.kotlinFunction\n+\n+/**\n+ * Invokes a suspending function and returns [CompletableFuture].\n+ */\n+fun callKotlinSuspendingMethod(\n+    method: Method,\n+    obj: Any,\n+    args: Array<Any>,\n+    ctx: RequestContext\n+): CompletableFuture<Any?> {\n+    val kFunction = checkNotNull(method.kotlinFunction) { \"method is not suspending function\" }", "originalCommit": "9204a243fa0a83e4736b023976cf613a43e1f5ca", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "6248200de40fd93423cac265aa3ba32670de20a8", "url": "https://github.com/line/armeria/commit/6248200de40fd93423cac265aa3ba32670de20a8", "message": "address a comment", "committedDate": "2020-08-12T08:08:05Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTIzNTQ3Mg==", "url": "https://github.com/line/armeria/pull/2983#discussion_r469235472", "bodyText": "Question: Is it possible to cache executorService.asCoroutineDispatcher()?", "author": "trustin", "createdAt": "2020-08-12T12:52:07Z", "path": "kotlin/src/main/kotlin/com/linecorp/armeria/internal/common/kotlin/CoroutineUtil.kt", "diffHunk": "@@ -36,11 +37,12 @@ fun callKotlinSuspendingMethod(\n     method: Method,\n     obj: Any,\n     args: Array<Any>,\n+    executorService: ExecutorService,\n     ctx: RequestContext\n ): CompletableFuture<Any?> {\n     val kFunction = checkNotNull(method.kotlinFunction) { \"method is not a suspending function\" }\n-    val coroutineContext = CoroutineContexts.getCoroutineContext(ctx)\n-    val newContext = Dispatchers.Unconfined + (coroutineContext ?: EmptyCoroutineContext)\n+    val coroutineContext = CoroutineContexts.getCoroutineContext(ctx) ?: EmptyCoroutineContext\n+    val newContext = executorService.asCoroutineDispatcher() + coroutineContext", "originalCommit": "967ca03e4790b2641dc83a5f11d30be1f4f56d6f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTYyODE3NQ==", "url": "https://github.com/line/armeria/pull/2983#discussion_r469628175", "bodyText": "Do you mean we should, for example,\n\nmake a constant of a coroutine dispatcher of armeria event loop (which is not context-aware)\nand ctx.push at the dispatched thread before executing controller methods", "author": "okue", "createdAt": "2020-08-13T00:43:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTIzNTQ3Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDY0NDQyNw==", "url": "https://github.com/line/armeria/pull/2983#discussion_r470644427", "bodyText": "Yes.", "author": "trustin", "createdAt": "2020-08-14T14:05:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTIzNTQ3Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDk0ODM2MQ==", "url": "https://github.com/line/armeria/pull/2983#discussion_r470948361", "bodyText": "For example...\nimport com.linecorp.armeria.common.CommonPools\nimport com.linecorp.armeria.common.RequestContext\nimport com.linecorp.armeria.common.kotlin.CoroutineContexts\nimport com.linecorp.armeria.common.util.SafeCloseable\nimport kotlinx.coroutines.GlobalScope\nimport kotlinx.coroutines.ThreadContextElement\nimport kotlinx.coroutines.asCoroutineDispatcher\nimport kotlinx.coroutines.future.future\nimport java.lang.reflect.Method\nimport java.util.concurrent.CompletableFuture\nimport kotlin.coroutines.AbstractCoroutineContextElement\nimport kotlin.coroutines.CoroutineContext\nimport kotlin.coroutines.EmptyCoroutineContext\nimport kotlin.reflect.full.callSuspend\nimport kotlin.reflect.jvm.kotlinFunction\n\nval armeriaDispatcher = CommonPools.workerGroup().asCoroutineDispatcher()\n\nclass ArmeriaRequestContext(\n    private val requestContext: RequestContext\n) : ThreadContextElement<SafeCloseable>, AbstractCoroutineContextElement(Key) {\n\n    companion object Key : CoroutineContext.Key<ArmeriaRequestContext>\n\n    override fun updateThreadContext(context: CoroutineContext): SafeCloseable {\n        return requestContext.push()\n    }\n\n    override fun restoreThreadContext(context: CoroutineContext, oldState: SafeCloseable) {\n        oldState.close()\n    }\n}\n\n/**\n * Invokes a suspending function and returns [CompletableFuture].\n */\nfun callKotlinSuspendingMethod(\n    method: Method,\n    obj: Any,\n    args: Array<Any>,\n    ctx: RequestContext\n): CompletableFuture<Any?> {\n    val kFunction = checkNotNull(method.kotlinFunction) { \"method is not a suspending function\" }\n    val coroutineContext = CoroutineContexts.get(ctx) ?: EmptyCoroutineContext\n    // if `coroutineContext` contains a coroutine dispatcher, executorService is not used.\n    val newContext = armeriaDispatcher + ArmeriaRequestContext(ctx) + coroutineContext\n    return GlobalScope.future(newContext) {\n        kFunction\n            .callSuspend(obj, *args)\n            .let { if (it == Unit) null else it }\n    }\n}", "author": "okue", "createdAt": "2020-08-15T07:13:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTIzNTQ3Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTk4NTg5Nw==", "url": "https://github.com/line/armeria/pull/2983#discussion_r471985897", "bodyText": "Is this addressed? What's the result? \ud83e\udd14", "author": "minwoox", "createdAt": "2020-08-18T07:53:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTIzNTQ3Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjAwNjMyNQ==", "url": "https://github.com/line/armeria/pull/2983#discussion_r472006325", "bodyText": "I don't apply this change yet.", "author": "okue", "createdAt": "2020-08-18T08:27:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTIzNTQ3Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjAwOTc1Nw==", "url": "https://github.com/line/armeria/pull/2983#discussion_r472009757", "bodyText": "Ah, I think we can make a separate PR for this if you want. \ud83d\ude04", "author": "minwoox", "createdAt": "2020-08-18T08:32:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTIzNTQ3Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjA2NjAwOA==", "url": "https://github.com/line/armeria/pull/2983#discussion_r472066008", "bodyText": "Thanks. I want to separate this change from this PR.", "author": "okue", "createdAt": "2020-08-18T10:07:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTIzNTQ3Mg=="}], "type": "inlineReview"}, {"oid": "18714e7a83471f26c0b6b6130b2772ae58bca930", "url": "https://github.com/line/armeria/commit/18714e7a83471f26c0b6b6130b2772ae58bca930", "message": "Use eventLoop as coroutine dispatcher", "committedDate": "2020-08-12T14:04:03Z", "type": "commit"}, {"oid": "18714e7a83471f26c0b6b6130b2772ae58bca930", "url": "https://github.com/line/armeria/commit/18714e7a83471f26c0b6b6130b2772ae58bca930", "message": "Use eventLoop as coroutine dispatcher", "committedDate": "2020-08-12T14:04:03Z", "type": "forcePushed"}, {"oid": "c29d1edfcf6dd931eebe36495142a0ead249664a", "url": "https://github.com/line/armeria/commit/c29d1edfcf6dd931eebe36495142a0ead249664a", "message": "Add example annotated-http-service-kotlin", "committedDate": "2020-08-13T01:36:03Z", "type": "commit"}, {"oid": "c29d1edfcf6dd931eebe36495142a0ead249664a", "url": "https://github.com/line/armeria/commit/c29d1edfcf6dd931eebe36495142a0ead249664a", "message": "Add example annotated-http-service-kotlin", "committedDate": "2020-08-13T01:36:03Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDY0MzM4Mg==", "url": "https://github.com/line/armeria/pull/2983#discussion_r470643382", "bodyText": "Out of curiosity: Does ServiceRequestContext.current() work?", "author": "trustin", "createdAt": "2020-08-14T14:03:46Z", "path": "examples/annotated-http-service-kotlin/src/main/kotlin/example/armeria/server/annotated/kotlin/ContextAwareService.kt", "diffHunk": "@@ -0,0 +1,57 @@\n+package example.armeria.server.annotated.kotlin\n+\n+import com.linecorp.armeria.common.RequestContext\n+import com.linecorp.armeria.server.ServiceRequestContext\n+import com.linecorp.armeria.server.annotation.Get\n+import com.linecorp.armeria.server.annotation.Param\n+import com.linecorp.armeria.server.annotation.ProducesJson\n+import kotlinx.coroutines.asCoroutineDispatcher\n+import kotlinx.coroutines.withContext\n+import org.slf4j.LoggerFactory\n+import java.util.concurrent.Executors\n+\n+class ContextAwareService {\n+\n+    @Get(\"/foo\")\n+    @ProducesJson\n+    suspend fun foo(@Param(\"name\") name: String, @Param(\"id\") id: Int): FooResponse {\n+        log.info(\"Hello $name\")\n+        // Make sure that current thread is request context aware\n+        RequestContext.current<ServiceRequestContext>()", "originalCommit": "c29d1edfcf6dd931eebe36495142a0ead249664a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDg1MDk1Nw==", "url": "https://github.com/line/armeria/pull/2983#discussion_r470850957", "bodyText": "Yes.", "author": "okue", "createdAt": "2020-08-14T20:29:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDY0MzM4Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDkzOTQ1Mw==", "url": "https://github.com/line/armeria/pull/2983#discussion_r470939453", "bodyText": "Then how about using ServiceRequestContext.current() for brevity?", "author": "trustin", "createdAt": "2020-08-15T05:11:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDY0MzM4Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDk0ODQzOQ==", "url": "https://github.com/line/armeria/pull/2983#discussion_r470948439", "bodyText": "OK :)", "author": "okue", "createdAt": "2020-08-15T07:14:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDY0MzM4Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDY0Mzc5Mg==", "url": "https://github.com/line/armeria/pull/2983#discussion_r470643792", "bodyText": "Would it be better naming these methods as get() and set()?", "author": "trustin", "createdAt": "2020-08-14T14:04:33Z", "path": "kotlin/src/main/java/com/linecorp/armeria/common/kotlin/CoroutineContexts.java", "diffHunk": "@@ -0,0 +1,63 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.common.kotlin;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+import javax.annotation.Nullable;\n+\n+import com.linecorp.armeria.common.RequestContext;\n+import com.linecorp.armeria.internal.server.annotation.AnnotatedService;\n+import com.linecorp.armeria.server.kotlin.CoroutineContextService;\n+\n+import io.netty.util.AttributeKey;\n+import kotlin.coroutines.CoroutineContext;\n+\n+/**\n+ * Configures a coroutine context for annotated services and Kotlin suspending functions.\n+ *\n+ * @see CoroutineContextService\n+ */\n+public final class CoroutineContexts {\n+\n+    /**\n+     * {@link AnnotatedService} uses a coroutine context associated with this attribute\n+     * when calling suspending functions.\n+     */\n+    private static final AttributeKey<CoroutineContext> COROUTINE_CONTEXT_KEY =\n+            AttributeKey.valueOf(CoroutineContexts.class, \"COROUTINE_CONTEXT_KEY\");\n+\n+    /**\n+     * Associates the given coroutine context with {@code COROUTINE_CONTEXT_KEY} attribute in the context.\n+     */\n+    public static void setCoroutineContext(RequestContext ctx, CoroutineContext coroutineContext) {\n+        requireNonNull(ctx, \"ctx\");\n+        requireNonNull(coroutineContext, \"coroutineContext\");\n+        ctx.setAttr(COROUTINE_CONTEXT_KEY, coroutineContext);\n+    }\n+\n+    /**\n+     * Returns the coroutine context mapped to {@code COROUTINE_CONTEXT_KEY} in the context.\n+     */\n+    @Nullable\n+    public static CoroutineContext getCoroutineContext(RequestContext ctx) {\n+        requireNonNull(ctx, \"ctx\");\n+        return ctx.attr(COROUTINE_CONTEXT_KEY);\n+    }", "originalCommit": "c29d1edfcf6dd931eebe36495142a0ead249664a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDY0NDE0Nw==", "url": "https://github.com/line/armeria/pull/2983#discussion_r470644147", "bodyText": "Could you add final to all classes if possible?", "author": "trustin", "createdAt": "2020-08-14T14:05:05Z", "path": "kotlin/src/main/java/com/linecorp/armeria/server/kotlin/CoroutineContextService.java", "diffHunk": "@@ -0,0 +1,75 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.server.kotlin;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+import java.util.function.Function;\n+\n+import com.linecorp.armeria.common.HttpRequest;\n+import com.linecorp.armeria.common.HttpResponse;\n+import com.linecorp.armeria.common.kotlin.CoroutineContextProvider;\n+import com.linecorp.armeria.common.kotlin.CoroutineContexts;\n+import com.linecorp.armeria.server.HttpService;\n+import com.linecorp.armeria.server.ServiceRequestContext;\n+import com.linecorp.armeria.server.SimpleDecoratingHttpService;\n+\n+/**\n+ * Decorates an {@link HttpService} to configure the coroutine context which is used as an initial context\n+ * of annotated services' suspending functions.\n+ *\n+ * <p>Example:\n+ * <pre>{@code\n+ * > serverBuilder\n+ * >     .annotatedService(object {\n+ * >         @Get(\"/users/{uid}\")\n+ * >         suspend fun foo(@Param(\"uid\") uid: String): HttpResponse {\n+ * >             ...\n+ * >         }\n+ * >     })\n+ * >     .decorator(CoroutineContextService.newDecorator { ctx ->\n+ * >         ctx.eventLoop().asCoroutineDispatcher() +\n+ * >             CoroutineName(ctx.config().defaultServiceName() ?: \"none\")\n+ * >     })\n+ * }\n+ * </pre>\n+ */\n+public class CoroutineContextService extends SimpleDecoratingHttpService {", "originalCommit": "c29d1edfcf6dd931eebe36495142a0ead249664a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "11c6e3bbea332061f0f6afcf07dbcd826c235644", "url": "https://github.com/line/armeria/commit/11c6e3bbea332061f0f6afcf07dbcd826c235644", "message": "address a comment", "committedDate": "2020-08-14T20:31:18Z", "type": "commit"}, {"oid": "2ae6f69eacb467d64cb7cdcfa05689a2c9a87ddb", "url": "https://github.com/line/armeria/commit/2ae6f69eacb467d64cb7cdcfa05689a2c9a87ddb", "message": "address a comment", "committedDate": "2020-08-15T07:21:27Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDk1MDI4NA==", "url": "https://github.com/line/armeria/pull/2983#discussion_r470950284", "bodyText": "Does a user need to do this? Can't Armeria make sure the function is run with a request context dispatcher?", "author": "anuraaga", "createdAt": "2020-08-15T07:39:11Z", "path": "examples/annotated-http-service-kotlin/src/main/kotlin/example/armeria/server/annotated/kotlin/ContextAwareService.kt", "diffHunk": "@@ -0,0 +1,56 @@\n+package example.armeria.server.annotated.kotlin\n+\n+import com.linecorp.armeria.server.ServiceRequestContext\n+import com.linecorp.armeria.server.annotation.Get\n+import com.linecorp.armeria.server.annotation.Param\n+import com.linecorp.armeria.server.annotation.ProducesJson\n+import kotlinx.coroutines.asCoroutineDispatcher\n+import kotlinx.coroutines.withContext\n+import org.slf4j.LoggerFactory\n+import java.util.concurrent.Executors\n+\n+class ContextAwareService {\n+\n+    @Get(\"/foo\")\n+    @ProducesJson\n+    suspend fun foo(@Param(\"name\") name: String, @Param(\"id\") id: Int): FooResponse {\n+        log.info(\"Hello $name\")\n+        // Make sure that current thread is request context aware\n+        ServiceRequestContext.current()\n+\n+        // Propagate armeria request context\n+        withContext(ArmeriaRequestContext()) {", "originalCommit": "2ae6f69eacb467d64cb7cdcfa05689a2c9a87ddb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDk1MTg0Mg==", "url": "https://github.com/line/armeria/pull/2983#discussion_r470951842", "bodyText": "In this example, BusinessLogic.blockingTask is designed to executed in myDispatcher to limit the number of parallel executions.\nAs we cannot dispatch to a request context dispatcher, then I pass a request context as ThreadContextElement.\nPossibly this is a rare case..", "author": "okue", "createdAt": "2020-08-15T07:59:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDk1MDI4NA=="}], "type": "inlineReview"}, {"oid": "ab52890d185c02d12a776094e179d8590f989cee", "url": "https://github.com/line/armeria/commit/ab52890d185c02d12a776094e179d8590f989cee", "message": "add tests for KotlinUtil", "committedDate": "2020-08-18T06:57:25Z", "type": "commit"}, {"oid": "ab52890d185c02d12a776094e179d8590f989cee", "url": "https://github.com/line/armeria/commit/ab52890d185c02d12a776094e179d8590f989cee", "message": "add tests for KotlinUtil", "committedDate": "2020-08-18T06:57:25Z", "type": "forcePushed"}, {"oid": "e763ac806a07851726b219b3bad4393f63fe9244", "url": "https://github.com/line/armeria/commit/e763ac806a07851726b219b3bad4393f63fe9244", "message": "update comment of CoroutineContextService.java", "committedDate": "2020-08-18T16:16:09Z", "type": "commit"}, {"oid": "ae5427ae8c66a39fcb5193c59aaa2863c7306d09", "url": "https://github.com/line/armeria/commit/ae5427ae8c66a39fcb5193c59aaa2863c7306d09", "message": "update KotlinUtil.java", "committedDate": "2020-08-18T16:56:25Z", "type": "commit"}, {"oid": "1f0af0868c6ac8aae005f27fbfe030960d235be5", "url": "https://github.com/line/armeria/commit/1f0af0868c6ac8aae005f27fbfe030960d235be5", "message": "add comment to annotated-http-service-kotlin", "committedDate": "2020-08-18T16:56:55Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjY1NDQwOA==", "url": "https://github.com/line/armeria/pull/2983#discussion_r472654408", "bodyText": "Could introduce a local variable for parameters.get(0)? Then it can be used at https://github.com/line/armeria/pull/2983/files#diff-f13d04b42f9611da57e897603ce21ff8R220", "author": "ikhoon", "createdAt": "2020-08-19T03:51:13Z", "path": "core/src/main/java/com/linecorp/armeria/internal/server/annotation/AnnotatedValueResolver.java", "diffHunk": "@@ -208,23 +211,23 @@ static AnnotatedValueResolver ofBeanField(Field field, Set<String> pathParams,\n             // @Param\n             // void setter(@Header String name) { ... }\n             //\n-            if (isAnnotationPresent(parameters[0])) {\n+            if (isAnnotationPresent(parameters.get(0))) {", "originalCommit": "1f0af0868c6ac8aae005f27fbfe030960d235be5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjY1NzkxNA==", "url": "https://github.com/line/armeria/pull/2983#discussion_r472657914", "bodyText": "How about introducing a local variable for the size of parameters and reuse it here and later.", "author": "ikhoon", "createdAt": "2020-08-19T03:56:54Z", "path": "core/src/main/java/com/linecorp/armeria/internal/server/annotation/AnnotatedValueResolver.java", "diffHunk": "@@ -174,8 +174,11 @@ static AnnotatedValueResolver ofBeanField(Field field, Set<String> pathParams,\n                                                    List<RequestObjectResolver> objectResolvers,\n                                                    boolean implicitRequestObjectAnnotation,\n                                                    boolean isServiceMethod) {\n-        final Parameter[] parameters = constructorOrMethod.getParameters();\n-        if (parameters.length == 0) {\n+        final ImmutableList<Parameter> parameters =\n+                Arrays.stream(constructorOrMethod.getParameters())\n+                      .filter(it -> !KotlinUtil.isContinuation(it.getType()))\n+                      .collect(toImmutableList());\n+        if (parameters.isEmpty()) {", "originalCommit": "1f0af0868c6ac8aae005f27fbfe030960d235be5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjY2MzIyMw==", "url": "https://github.com/line/armeria/pull/2983#discussion_r472663223", "bodyText": "nit: Check IS_KOTLIN_REFLECTION_PRESENT first because it looks cheaper. \ud83d\ude09", "author": "ikhoon", "createdAt": "2020-08-19T04:05:42Z", "path": "core/src/main/java/com/linecorp/armeria/internal/server/annotation/KotlinUtil.java", "diffHunk": "@@ -0,0 +1,172 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.internal.server.annotation;\n+\n+import java.lang.annotation.Annotation;\n+import java.lang.invoke.MethodHandle;\n+import java.lang.invoke.MethodHandles;\n+import java.lang.invoke.MethodType;\n+import java.lang.reflect.Method;\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.ExecutorService;\n+\n+import javax.annotation.Nullable;\n+\n+import com.google.common.collect.ImmutableList;\n+\n+import com.linecorp.armeria.common.RequestContext;\n+\n+@SuppressWarnings(\"unchecked\")\n+final class KotlinUtil {\n+\n+    private static final boolean IS_KOTLIN_REFLECTION_PRESENT;\n+\n+    @Nullable\n+    private static final Class<? extends Annotation> METADATA_CLASS;\n+\n+    @Nullable\n+    private static final MethodHandle CALL_KOTLIN_SUSPENDING_METHOD;\n+\n+    @Nullable\n+    private static final Method IS_SUSPENDING_FUNCTION;\n+\n+    @Nullable\n+    private static final Method IS_CONTINUATION;\n+\n+    @Nullable\n+    private static final Method IS_RETURN_TYPE_UNIT;\n+\n+    static {\n+        MethodHandle callKotlinSuspendingMethod = null;\n+        try {\n+            final Class<?> coroutineUtilClass =\n+                    getClass(\"com.linecorp.armeria.internal.common.kotlin.CoroutineUtil\");\n+\n+            callKotlinSuspendingMethod = MethodHandles.lookup().findStatic(\n+                    coroutineUtilClass, \"callKotlinSuspendingMethod\",\n+                    MethodType.methodType(\n+                            CompletableFuture.class,\n+                            ImmutableList.of(Method.class, Object.class,\n+                                             Object[].class, ExecutorService.class,\n+                                             RequestContext.class))\n+            );\n+        } catch (ClassNotFoundException | NoSuchMethodException | IllegalAccessException e) {\n+            // ignore\n+        } finally {\n+            CALL_KOTLIN_SUSPENDING_METHOD = callKotlinSuspendingMethod;\n+        }\n+\n+        Method isContinuation = null;\n+        Method isSuspendingFunction = null;\n+        Method isReturnTypeUnit = null;\n+        try {\n+            final Class<?> kotlinUtilClass =\n+                    getClass(\"com.linecorp.armeria.internal.common.kotlin.KotlinUtil\");\n+\n+            isContinuation = kotlinUtilClass.getMethod(\"isContinuation\", Class.class);\n+            isSuspendingFunction = kotlinUtilClass.getMethod(\"isSuspendingFunction\", Method.class);\n+            isReturnTypeUnit = kotlinUtilClass.getMethod(\"isReturnTypeUnit\", Method.class);\n+        } catch (ClassNotFoundException | NoSuchMethodException e) {\n+            // ignore\n+        } finally {\n+            IS_CONTINUATION = isContinuation;\n+            IS_SUSPENDING_FUNCTION = isSuspendingFunction;\n+            IS_RETURN_TYPE_UNIT = isReturnTypeUnit;\n+        }\n+\n+        boolean isKotlinReflectionPresent = false;\n+        try {\n+            getClass(\"kotlin.reflect.full.KClasses\");\n+            isKotlinReflectionPresent = true;\n+        } catch (ClassNotFoundException e) {\n+            // ignore\n+        } finally {\n+            IS_KOTLIN_REFLECTION_PRESENT = isKotlinReflectionPresent;\n+        }\n+\n+        Class<? extends Annotation> metadataClass = null;\n+        try {\n+            metadataClass = (Class<? extends Annotation>) getClass(\"kotlin.Metadata\");\n+        } catch (ClassNotFoundException e) {\n+            // ignore\n+        } finally {\n+            METADATA_CLASS = metadataClass;\n+        }\n+    }\n+\n+    /**\n+     * Returns a method which invokes Kotlin suspending functions.\n+     */\n+    @Nullable\n+    static MethodHandle getCallKotlinSuspendingMethod() {\n+        return CALL_KOTLIN_SUSPENDING_METHOD;\n+    }\n+\n+    /**\n+     * Returns true if a method is written in Kotlin.\n+     */\n+    static boolean isKotlinMethod(Method method) {\n+        return METADATA_CLASS != null &&\n+               method.getDeclaringClass().getAnnotation(METADATA_CLASS) != null;\n+    }\n+\n+    /**\n+     * Returns true if a method is a suspending function.\n+     */\n+    static boolean isSuspendingFunction(Method method) {\n+        try {\n+            return isKotlinMethod(method) &&\n+                   IS_KOTLIN_REFLECTION_PRESENT &&", "originalCommit": "1f0af0868c6ac8aae005f27fbfe030960d235be5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjY2NDM5Mw==", "url": "https://github.com/line/armeria/pull/2983#discussion_r472664393", "bodyText": "Is it possible to return boolean? The returned value of IS_CONTINUATION is casted to boolean.", "author": "ikhoon", "createdAt": "2020-08-19T04:07:41Z", "path": "core/src/main/java/com/linecorp/armeria/internal/server/annotation/KotlinUtil.java", "diffHunk": "@@ -0,0 +1,172 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.internal.server.annotation;\n+\n+import java.lang.annotation.Annotation;\n+import java.lang.invoke.MethodHandle;\n+import java.lang.invoke.MethodHandles;\n+import java.lang.invoke.MethodType;\n+import java.lang.reflect.Method;\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.ExecutorService;\n+\n+import javax.annotation.Nullable;\n+\n+import com.google.common.collect.ImmutableList;\n+\n+import com.linecorp.armeria.common.RequestContext;\n+\n+@SuppressWarnings(\"unchecked\")\n+final class KotlinUtil {\n+\n+    private static final boolean IS_KOTLIN_REFLECTION_PRESENT;\n+\n+    @Nullable\n+    private static final Class<? extends Annotation> METADATA_CLASS;\n+\n+    @Nullable\n+    private static final MethodHandle CALL_KOTLIN_SUSPENDING_METHOD;\n+\n+    @Nullable\n+    private static final Method IS_SUSPENDING_FUNCTION;\n+\n+    @Nullable\n+    private static final Method IS_CONTINUATION;\n+\n+    @Nullable\n+    private static final Method IS_RETURN_TYPE_UNIT;\n+\n+    static {\n+        MethodHandle callKotlinSuspendingMethod = null;\n+        try {\n+            final Class<?> coroutineUtilClass =\n+                    getClass(\"com.linecorp.armeria.internal.common.kotlin.CoroutineUtil\");\n+\n+            callKotlinSuspendingMethod = MethodHandles.lookup().findStatic(\n+                    coroutineUtilClass, \"callKotlinSuspendingMethod\",\n+                    MethodType.methodType(\n+                            CompletableFuture.class,\n+                            ImmutableList.of(Method.class, Object.class,\n+                                             Object[].class, ExecutorService.class,\n+                                             RequestContext.class))\n+            );\n+        } catch (ClassNotFoundException | NoSuchMethodException | IllegalAccessException e) {\n+            // ignore\n+        } finally {\n+            CALL_KOTLIN_SUSPENDING_METHOD = callKotlinSuspendingMethod;\n+        }\n+\n+        Method isContinuation = null;\n+        Method isSuspendingFunction = null;\n+        Method isReturnTypeUnit = null;\n+        try {\n+            final Class<?> kotlinUtilClass =\n+                    getClass(\"com.linecorp.armeria.internal.common.kotlin.KotlinUtil\");\n+\n+            isContinuation = kotlinUtilClass.getMethod(\"isContinuation\", Class.class);\n+            isSuspendingFunction = kotlinUtilClass.getMethod(\"isSuspendingFunction\", Method.class);\n+            isReturnTypeUnit = kotlinUtilClass.getMethod(\"isReturnTypeUnit\", Method.class);\n+        } catch (ClassNotFoundException | NoSuchMethodException e) {\n+            // ignore\n+        } finally {\n+            IS_CONTINUATION = isContinuation;\n+            IS_SUSPENDING_FUNCTION = isSuspendingFunction;\n+            IS_RETURN_TYPE_UNIT = isReturnTypeUnit;\n+        }\n+\n+        boolean isKotlinReflectionPresent = false;\n+        try {\n+            getClass(\"kotlin.reflect.full.KClasses\");\n+            isKotlinReflectionPresent = true;\n+        } catch (ClassNotFoundException e) {\n+            // ignore\n+        } finally {\n+            IS_KOTLIN_REFLECTION_PRESENT = isKotlinReflectionPresent;\n+        }\n+\n+        Class<? extends Annotation> metadataClass = null;\n+        try {\n+            metadataClass = (Class<? extends Annotation>) getClass(\"kotlin.Metadata\");\n+        } catch (ClassNotFoundException e) {\n+            // ignore\n+        } finally {\n+            METADATA_CLASS = metadataClass;\n+        }\n+    }\n+\n+    /**\n+     * Returns a method which invokes Kotlin suspending functions.\n+     */\n+    @Nullable\n+    static MethodHandle getCallKotlinSuspendingMethod() {\n+        return CALL_KOTLIN_SUSPENDING_METHOD;\n+    }\n+\n+    /**\n+     * Returns true if a method is written in Kotlin.\n+     */\n+    static boolean isKotlinMethod(Method method) {\n+        return METADATA_CLASS != null &&\n+               method.getDeclaringClass().getAnnotation(METADATA_CLASS) != null;\n+    }\n+\n+    /**\n+     * Returns true if a method is a suspending function.\n+     */\n+    static boolean isSuspendingFunction(Method method) {\n+        try {\n+            return isKotlinMethod(method) &&\n+                   IS_KOTLIN_REFLECTION_PRESENT &&\n+                   IS_SUSPENDING_FUNCTION != null &&\n+                   (Boolean) IS_SUSPENDING_FUNCTION.invoke(null, method);", "originalCommit": "1f0af0868c6ac8aae005f27fbfe030960d235be5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjY2NTAyMg==", "url": "https://github.com/line/armeria/pull/2983#discussion_r472665022", "bodyText": "nit: Merge two lines?\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private KotlinUtil() {\n          \n          \n            \n                }\n          \n          \n            \n                private KotlinUtil() {}", "author": "ikhoon", "createdAt": "2020-08-19T04:08:42Z", "path": "core/src/main/java/com/linecorp/armeria/internal/server/annotation/KotlinUtil.java", "diffHunk": "@@ -0,0 +1,172 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.internal.server.annotation;\n+\n+import java.lang.annotation.Annotation;\n+import java.lang.invoke.MethodHandle;\n+import java.lang.invoke.MethodHandles;\n+import java.lang.invoke.MethodType;\n+import java.lang.reflect.Method;\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.ExecutorService;\n+\n+import javax.annotation.Nullable;\n+\n+import com.google.common.collect.ImmutableList;\n+\n+import com.linecorp.armeria.common.RequestContext;\n+\n+@SuppressWarnings(\"unchecked\")\n+final class KotlinUtil {\n+\n+    private static final boolean IS_KOTLIN_REFLECTION_PRESENT;\n+\n+    @Nullable\n+    private static final Class<? extends Annotation> METADATA_CLASS;\n+\n+    @Nullable\n+    private static final MethodHandle CALL_KOTLIN_SUSPENDING_METHOD;\n+\n+    @Nullable\n+    private static final Method IS_SUSPENDING_FUNCTION;\n+\n+    @Nullable\n+    private static final Method IS_CONTINUATION;\n+\n+    @Nullable\n+    private static final Method IS_RETURN_TYPE_UNIT;\n+\n+    static {\n+        MethodHandle callKotlinSuspendingMethod = null;\n+        try {\n+            final Class<?> coroutineUtilClass =\n+                    getClass(\"com.linecorp.armeria.internal.common.kotlin.CoroutineUtil\");\n+\n+            callKotlinSuspendingMethod = MethodHandles.lookup().findStatic(\n+                    coroutineUtilClass, \"callKotlinSuspendingMethod\",\n+                    MethodType.methodType(\n+                            CompletableFuture.class,\n+                            ImmutableList.of(Method.class, Object.class,\n+                                             Object[].class, ExecutorService.class,\n+                                             RequestContext.class))\n+            );\n+        } catch (ClassNotFoundException | NoSuchMethodException | IllegalAccessException e) {\n+            // ignore\n+        } finally {\n+            CALL_KOTLIN_SUSPENDING_METHOD = callKotlinSuspendingMethod;\n+        }\n+\n+        Method isContinuation = null;\n+        Method isSuspendingFunction = null;\n+        Method isReturnTypeUnit = null;\n+        try {\n+            final Class<?> kotlinUtilClass =\n+                    getClass(\"com.linecorp.armeria.internal.common.kotlin.KotlinUtil\");\n+\n+            isContinuation = kotlinUtilClass.getMethod(\"isContinuation\", Class.class);\n+            isSuspendingFunction = kotlinUtilClass.getMethod(\"isSuspendingFunction\", Method.class);\n+            isReturnTypeUnit = kotlinUtilClass.getMethod(\"isReturnTypeUnit\", Method.class);\n+        } catch (ClassNotFoundException | NoSuchMethodException e) {\n+            // ignore\n+        } finally {\n+            IS_CONTINUATION = isContinuation;\n+            IS_SUSPENDING_FUNCTION = isSuspendingFunction;\n+            IS_RETURN_TYPE_UNIT = isReturnTypeUnit;\n+        }\n+\n+        boolean isKotlinReflectionPresent = false;\n+        try {\n+            getClass(\"kotlin.reflect.full.KClasses\");\n+            isKotlinReflectionPresent = true;\n+        } catch (ClassNotFoundException e) {\n+            // ignore\n+        } finally {\n+            IS_KOTLIN_REFLECTION_PRESENT = isKotlinReflectionPresent;\n+        }\n+\n+        Class<? extends Annotation> metadataClass = null;\n+        try {\n+            metadataClass = (Class<? extends Annotation>) getClass(\"kotlin.Metadata\");\n+        } catch (ClassNotFoundException e) {\n+            // ignore\n+        } finally {\n+            METADATA_CLASS = metadataClass;\n+        }\n+    }\n+\n+    /**\n+     * Returns a method which invokes Kotlin suspending functions.\n+     */\n+    @Nullable\n+    static MethodHandle getCallKotlinSuspendingMethod() {\n+        return CALL_KOTLIN_SUSPENDING_METHOD;\n+    }\n+\n+    /**\n+     * Returns true if a method is written in Kotlin.\n+     */\n+    static boolean isKotlinMethod(Method method) {\n+        return METADATA_CLASS != null &&\n+               method.getDeclaringClass().getAnnotation(METADATA_CLASS) != null;\n+    }\n+\n+    /**\n+     * Returns true if a method is a suspending function.\n+     */\n+    static boolean isSuspendingFunction(Method method) {\n+        try {\n+            return isKotlinMethod(method) &&\n+                   IS_KOTLIN_REFLECTION_PRESENT &&\n+                   IS_SUSPENDING_FUNCTION != null &&\n+                   (Boolean) IS_SUSPENDING_FUNCTION.invoke(null, method);\n+        } catch (Exception e) {\n+            return false;\n+        }\n+    }\n+\n+    /**\n+     * Returns true if a class is kotlin.coroutines.Continuation.\n+     */\n+    static boolean isContinuation(Class<?> type) {\n+        try {\n+            return IS_CONTINUATION != null &&\n+                   (boolean) IS_CONTINUATION.invoke(null, type);\n+        } catch (Exception e) {\n+            return false;\n+        }\n+    }\n+\n+    /**\n+     * Returns true if a method is suspending function and it returns kotlin.Unit.\n+     */\n+    static boolean isSuspendingAndReturnTypeUnit(Method method) {\n+        try {\n+            return isSuspendingFunction(method) &&\n+                   IS_RETURN_TYPE_UNIT != null &&\n+                   (boolean) IS_RETURN_TYPE_UNIT.invoke(null, method);\n+        } catch (Exception e) {\n+            return false;\n+        }\n+    }\n+\n+    private static Class<?> getClass(String name) throws ClassNotFoundException {\n+        return Class.forName(name, true, KotlinUtil.class.getClassLoader());\n+    }\n+\n+    private KotlinUtil() {\n+    }", "originalCommit": "1f0af0868c6ac8aae005f27fbfe030960d235be5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjY2NTI1OQ==", "url": "https://github.com/line/armeria/pull/2983#discussion_r472665259", "bodyText": "Cruft?", "author": "ikhoon", "createdAt": "2020-08-19T04:09:05Z", "path": "core/src/test/java/com/linecorp/armeria/internal/server/annotation/KotlinUtilTest.java", "diffHunk": "@@ -0,0 +1,60 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.internal.server.annotation;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+\n+import java.lang.reflect.Method;\n+\n+import org.junit.jupiter.api.Test;\n+\n+/**\n+ * Without kotlin dependencies, all functions return false or null safely.\n+ */\n+class KotlinUtilTest {\n+\n+    @Test\n+    void getCallKotlinSuspendingMethod() {\n+        assertThat(KotlinUtil.getCallKotlinSuspendingMethod()).isNull();\n+    }\n+\n+    @Test\n+    void isContinuation() {\n+        assertThat(KotlinUtil.isContinuation(String.class)).isFalse();\n+    }\n+\n+    @Test\n+    void isKotlinMethod() throws NoSuchMethodException {\n+        final Method testMethod = KotlinUtilTest.class.getDeclaredMethod(\"testMethod\");\n+        assertThat(KotlinUtil.isKotlinMethod(testMethod)).isFalse();\n+    }\n+\n+    @Test\n+    void isSuspendingFunction() throws NoSuchMethodException {\n+        final Method testMethod = KotlinUtilTest.class.getDeclaredMethod(\"testMethod\");\n+        assertThat(KotlinUtil.isSuspendingFunction(testMethod)).isFalse();\n+    }\n+\n+    @Test\n+    void isSuspendingAndReturnTypeUnit() throws NoSuchMethodException {\n+        final Method testMethod = KotlinUtilTest.class.getDeclaredMethod(\"testMethod\");\n+        assertThat(KotlinUtil.isSuspendingAndReturnTypeUnit(testMethod)).isFalse();\n+    }\n+\n+    void testMethod() {\n+    }", "originalCommit": "1f0af0868c6ac8aae005f27fbfe030960d235be5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjY5ODc1Mg==", "url": "https://github.com/line/armeria/pull/2983#discussion_r472698752", "bodyText": "This function is used for testing KotlinUtil methods.\nTo make the intention clear, replace it with\n    private static class DummyService {\n        void testMethod() {\n        }\n    }", "author": "okue", "createdAt": "2020-08-19T05:03:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjY2NTI1OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjgyNTcxNQ==", "url": "https://github.com/line/armeria/pull/2983#discussion_r472825715", "bodyText": "Oops... I missed that. \ud83d\ude31\nBy the way the new version looks good.", "author": "ikhoon", "createdAt": "2020-08-19T07:53:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjY2NTI1OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjY2NjUyMw==", "url": "https://github.com/line/armeria/pull/2983#discussion_r472666523", "bodyText": "Could be simplified?\nreturn requestContext?.push()", "author": "ikhoon", "createdAt": "2020-08-19T04:10:58Z", "path": "examples/annotated-http-service-kotlin/src/main/kotlin/example/armeria/server/annotated/kotlin/ArmeriaRequestContext.kt", "diffHunk": "@@ -0,0 +1,26 @@\n+package example.armeria.server.annotated.kotlin\n+\n+import com.linecorp.armeria.common.util.SafeCloseable\n+import com.linecorp.armeria.server.ServiceRequestContext\n+import kotlinx.coroutines.ThreadContextElement\n+import kotlin.coroutines.AbstractCoroutineContextElement\n+import kotlin.coroutines.CoroutineContext\n+\n+/**\n+ * Propagates [ServiceRequestContext] over coroutines.\n+ */\n+class ArmeriaRequestContext(\n+    private val requestContext: ServiceRequestContext? = ServiceRequestContext.currentOrNull()\n+) : ThreadContextElement<SafeCloseable?>, AbstractCoroutineContextElement(Key) {\n+\n+    companion object Key : CoroutineContext.Key<ArmeriaRequestContext>\n+\n+    override fun updateThreadContext(context: CoroutineContext): SafeCloseable? {\n+        if (requestContext == null) return null\n+        return requestContext.push()", "originalCommit": "1f0af0868c6ac8aae005f27fbfe030960d235be5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjY3MDUyNg==", "url": "https://github.com/line/armeria/pull/2983#discussion_r472670526", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            public class KotlinUtilWithKotlinDependenciesTest {\n          \n          \n            \n            class KotlinUtilWithKotlinDependenciesTest {", "author": "ikhoon", "createdAt": "2020-08-19T04:17:20Z", "path": "kotlin/src/test/java/com/linecorp/armeria/internal/server/annotation/KotlinUtilWithKotlinDependenciesTest.java", "diffHunk": "@@ -0,0 +1,105 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.internal.server.annotation;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+\n+import java.lang.invoke.MethodHandle;\n+import java.lang.reflect.Method;\n+import java.util.concurrent.CompletableFuture;\n+\n+import org.junit.jupiter.api.Test;\n+\n+import com.linecorp.armeria.common.HttpMethod;\n+import com.linecorp.armeria.common.HttpRequest;\n+import com.linecorp.armeria.common.RequestContext;\n+import com.linecorp.armeria.server.ExampleService;\n+import com.linecorp.armeria.server.ServiceRequestContext;\n+\n+import kotlin.coroutines.Continuation;\n+\n+public class KotlinUtilWithKotlinDependenciesTest {", "originalCommit": "1f0af0868c6ac8aae005f27fbfe030960d235be5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjY3MDYxNQ==", "url": "https://github.com/line/armeria/pull/2983#discussion_r472670615", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public KotlinUtilWithKotlinDependenciesTest() throws NoSuchMethodException {\n          \n          \n            \n                KotlinUtilWithKotlinDependenciesTest() throws NoSuchMethodException {", "author": "ikhoon", "createdAt": "2020-08-19T04:17:30Z", "path": "kotlin/src/test/java/com/linecorp/armeria/internal/server/annotation/KotlinUtilWithKotlinDependenciesTest.java", "diffHunk": "@@ -0,0 +1,105 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.internal.server.annotation;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+\n+import java.lang.invoke.MethodHandle;\n+import java.lang.reflect.Method;\n+import java.util.concurrent.CompletableFuture;\n+\n+import org.junit.jupiter.api.Test;\n+\n+import com.linecorp.armeria.common.HttpMethod;\n+import com.linecorp.armeria.common.HttpRequest;\n+import com.linecorp.armeria.common.RequestContext;\n+import com.linecorp.armeria.server.ExampleService;\n+import com.linecorp.armeria.server.ServiceRequestContext;\n+\n+import kotlin.coroutines.Continuation;\n+\n+public class KotlinUtilWithKotlinDependenciesTest {\n+    final ExampleService exampleService;\n+    final Method normal;\n+    final Method suspendingUnit;\n+    final Method suspendingInt;\n+\n+    public KotlinUtilWithKotlinDependenciesTest() throws NoSuchMethodException {", "originalCommit": "1f0af0868c6ac8aae005f27fbfe030960d235be5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjY3MDkxMQ==", "url": "https://github.com/line/armeria/pull/2983#discussion_r472670911", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    assertThat(res.get()).isEqualTo(null);\n          \n          \n            \n                    assertThat(res.get()).isNull();", "author": "ikhoon", "createdAt": "2020-08-19T04:17:59Z", "path": "kotlin/src/test/java/com/linecorp/armeria/internal/server/annotation/KotlinUtilWithKotlinDependenciesTest.java", "diffHunk": "@@ -0,0 +1,105 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.internal.server.annotation;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+\n+import java.lang.invoke.MethodHandle;\n+import java.lang.reflect.Method;\n+import java.util.concurrent.CompletableFuture;\n+\n+import org.junit.jupiter.api.Test;\n+\n+import com.linecorp.armeria.common.HttpMethod;\n+import com.linecorp.armeria.common.HttpRequest;\n+import com.linecorp.armeria.common.RequestContext;\n+import com.linecorp.armeria.server.ExampleService;\n+import com.linecorp.armeria.server.ServiceRequestContext;\n+\n+import kotlin.coroutines.Continuation;\n+\n+public class KotlinUtilWithKotlinDependenciesTest {\n+    final ExampleService exampleService;\n+    final Method normal;\n+    final Method suspendingUnit;\n+    final Method suspendingInt;\n+\n+    public KotlinUtilWithKotlinDependenciesTest() throws NoSuchMethodException {\n+        exampleService = new ExampleService();\n+        normal = ExampleService.class.getDeclaredMethod(\"normal\");\n+        suspendingUnit = ExampleService.class.getDeclaredMethod(\"suspendingUnit\", Continuation.class);\n+        suspendingInt = ExampleService.class.getDeclaredMethod(\"suspendingInt\", Continuation.class);\n+    }\n+\n+    @Test\n+    void getCallKotlinSuspendingMethod() {\n+        assertThat(KotlinUtil.getCallKotlinSuspendingMethod()).isNotNull();\n+    }\n+\n+    @Test\n+    void invokeSuspendingInt() throws Throwable {\n+        final MethodHandle callSuspendingMethod = KotlinUtil.getCallKotlinSuspendingMethod();\n+\n+        final RequestContext ctx = getRequestContext();\n+        final CompletableFuture<?> res =\n+                (CompletableFuture<?>) callSuspendingMethod.invoke(suspendingInt, exampleService,\n+                                                                   new Object[0], ctx.eventLoop(), ctx);\n+        assertThat(res.get()).isEqualTo(1);\n+    }\n+\n+    @Test\n+    void invokeSuspendingUnit() throws Throwable {\n+        final MethodHandle callSuspendingMethod = KotlinUtil.getCallKotlinSuspendingMethod();\n+\n+        final RequestContext ctx = getRequestContext();\n+        final CompletableFuture<?> res =\n+                (CompletableFuture<?>) callSuspendingMethod.invoke(suspendingUnit, exampleService,\n+                                                                   new Object[0], ctx.eventLoop(), ctx);\n+        assertThat(res.get()).isEqualTo(null);", "originalCommit": "1f0af0868c6ac8aae005f27fbfe030960d235be5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjY3MTA4Ng==", "url": "https://github.com/line/armeria/pull/2983#discussion_r472671086", "bodyText": "Could be static?", "author": "ikhoon", "createdAt": "2020-08-19T04:18:16Z", "path": "kotlin/src/test/java/com/linecorp/armeria/internal/server/annotation/KotlinUtilWithKotlinDependenciesTest.java", "diffHunk": "@@ -0,0 +1,105 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.internal.server.annotation;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+\n+import java.lang.invoke.MethodHandle;\n+import java.lang.reflect.Method;\n+import java.util.concurrent.CompletableFuture;\n+\n+import org.junit.jupiter.api.Test;\n+\n+import com.linecorp.armeria.common.HttpMethod;\n+import com.linecorp.armeria.common.HttpRequest;\n+import com.linecorp.armeria.common.RequestContext;\n+import com.linecorp.armeria.server.ExampleService;\n+import com.linecorp.armeria.server.ServiceRequestContext;\n+\n+import kotlin.coroutines.Continuation;\n+\n+public class KotlinUtilWithKotlinDependenciesTest {\n+    final ExampleService exampleService;\n+    final Method normal;\n+    final Method suspendingUnit;\n+    final Method suspendingInt;\n+\n+    public KotlinUtilWithKotlinDependenciesTest() throws NoSuchMethodException {\n+        exampleService = new ExampleService();\n+        normal = ExampleService.class.getDeclaredMethod(\"normal\");\n+        suspendingUnit = ExampleService.class.getDeclaredMethod(\"suspendingUnit\", Continuation.class);\n+        suspendingInt = ExampleService.class.getDeclaredMethod(\"suspendingInt\", Continuation.class);\n+    }\n+\n+    @Test\n+    void getCallKotlinSuspendingMethod() {\n+        assertThat(KotlinUtil.getCallKotlinSuspendingMethod()).isNotNull();\n+    }\n+\n+    @Test\n+    void invokeSuspendingInt() throws Throwable {\n+        final MethodHandle callSuspendingMethod = KotlinUtil.getCallKotlinSuspendingMethod();\n+\n+        final RequestContext ctx = getRequestContext();\n+        final CompletableFuture<?> res =\n+                (CompletableFuture<?>) callSuspendingMethod.invoke(suspendingInt, exampleService,\n+                                                                   new Object[0], ctx.eventLoop(), ctx);\n+        assertThat(res.get()).isEqualTo(1);\n+    }\n+\n+    @Test\n+    void invokeSuspendingUnit() throws Throwable {\n+        final MethodHandle callSuspendingMethod = KotlinUtil.getCallKotlinSuspendingMethod();\n+\n+        final RequestContext ctx = getRequestContext();\n+        final CompletableFuture<?> res =\n+                (CompletableFuture<?>) callSuspendingMethod.invoke(suspendingUnit, exampleService,\n+                                                                   new Object[0], ctx.eventLoop(), ctx);\n+        assertThat(res.get()).isEqualTo(null);\n+    }\n+\n+    @Test\n+    void isContinuation() {\n+        assertThat(KotlinUtil.isContinuation(String.class)).isFalse();\n+        assertThat(KotlinUtil.isContinuation(Continuation.class)).isTrue();\n+    }\n+\n+    @Test\n+    void isKotlinMethod() {\n+        assertThat(KotlinUtil.isKotlinMethod(normal)).isTrue();\n+        assertThat(KotlinUtil.isKotlinMethod(suspendingInt)).isTrue();\n+        assertThat(KotlinUtil.isKotlinMethod(suspendingUnit)).isTrue();\n+    }\n+\n+    @Test\n+    void isSuspendingFunction() {\n+        assertThat(KotlinUtil.isSuspendingFunction(normal)).isFalse();\n+        assertThat(KotlinUtil.isSuspendingFunction(suspendingInt)).isTrue();\n+        assertThat(KotlinUtil.isSuspendingFunction(suspendingUnit)).isTrue();\n+    }\n+\n+    @Test\n+    void isSuspendingAndReturnTypeUnit() {\n+        assertThat(KotlinUtil.isSuspendingAndReturnTypeUnit(normal)).isFalse();\n+        assertThat(KotlinUtil.isSuspendingAndReturnTypeUnit(suspendingInt)).isFalse();\n+        assertThat(KotlinUtil.isSuspendingAndReturnTypeUnit(suspendingUnit)).isTrue();\n+    }\n+\n+    private RequestContext getRequestContext() {", "originalCommit": "1f0af0868c6ac8aae005f27fbfe030960d235be5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "a6772bff524122753a82d4208794ce0c55247284", "url": "https://github.com/line/armeria/commit/a6772bff524122753a82d4208794ce0c55247284", "message": "address a comment", "committedDate": "2020-08-19T05:15:04Z", "type": "commit"}]}