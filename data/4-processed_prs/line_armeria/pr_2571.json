{"pr_number": 2571, "pr_title": "Revamp `RequestContext.set{Request,Response}Timeout()`", "pr_createdAt": "2020-03-11T10:26:36Z", "pr_url": "https://github.com/line/armeria/pull/2571", "timeline": [{"oid": "35b647817efde26fdc185c12fdc43f2be66bde7c", "url": "https://github.com/line/armeria/commit/35b647817efde26fdc185c12fdc43f2be66bde7c", "message": "Revamp `set{Request,Response}Timeout()` in RequestContext implementations.\n\nMotivation:\n\nWe were introduced the new timeout API in Armeria 0.98.0 and `set*Timeout{Millis}` has been deprecated.\nHowever, we got some internal inquiries about how to replace the setTimeout{Millis}.\nIt is hard to implement with the existing API.\nOn the other hand, some of the users are confused about the new timeout API.\nSee #2343 for detail discussion.\nI think we need to clean and revamp the timeout API before 1.0\n\nModifications:\n\n- Undeprecate `set*Timeout{Millis}`\n- Deprecate `set*TimeoutAt{Millis}` without a replacement\n- Deprecate `set*TimeoutAfter{Millis}` in favor of `setTimeout{Millis}(TimeoutMode.FROM_NOW, ...)\n- Deprecate `extend*Timeout{Millis}` in favor of `setTimeout{Millis}(TimeoutMode.EXTEND, ...)\n- Add TimeoutMode enum\n- Migrate deprecated API\n- Use default method to deduplicate code\n\nResult:\n\n- `set*Timeout{Millis}` is revived.\n- You can now schedule a timeout with `TimeoutMode`.", "committedDate": "2020-03-11T09:49:32Z", "type": "commit"}, {"oid": "783d9c98b36d7f80b86903589c73a604f8dc4f1a", "url": "https://github.com/line/armeria/commit/783d9c98b36d7f80b86903589c73a604f8dc4f1a", "message": "Change timeout tolerance to 100", "committedDate": "2020-03-12T03:30:23Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTQxMDY4Nw==", "url": "https://github.com/line/armeria/pull/2571#discussion_r391410687", "bodyText": "Any thoughts on my comment here?\n#2535 (comment)\nIt prevents having adjective (from) and verb (extend) in the same enum which looks weird.", "author": "anuraaga", "createdAt": "2020-03-12T05:39:26Z", "path": "core/src/main/java/com/linecorp/armeria/common/util/TimeoutMode.java", "diffHunk": "@@ -0,0 +1,37 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.common.util;\n+\n+import com.linecorp.armeria.common.Request;\n+\n+/**\n+ * The timeout mode.\n+ */\n+public enum TimeoutMode {", "originalCommit": "783d9c98b36d7f80b86903589c73a604f8dc4f1a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTQzMTgwNg==", "url": "https://github.com/line/armeria/pull/2571#discussion_r391431806", "bodyText": "That's a good suggestion. \ud83d\udc4d I know that our previous discussion does not reach a decision.\nI'm still very open to this enum.\nThe word meaning of NOW and CURRENT are similar. So I hesitated to use CURRENT a little bit.\nHow about adding two kinds of API.(I'm not sure this is better.)\npublic TimeoutMode {\n    NOW, START\n}\n// Schedules timeout from specific timeout mode\nvoid setTimeout(TimeoutMode, Duration)\n// Extends the previous scheduled timeout\nvoid setTimeoutAfter(Duration)", "author": "ikhoon", "createdAt": "2020-03-12T07:00:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTQxMDY4Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTU1MDU2MA==", "url": "https://github.com/line/armeria/pull/2571#discussion_r391550560", "bodyText": "How about FROM_OLD_TIMEOUT or FROM_PREV_TIMEOUT instead of EXTEND then? Or we could make the two verbs, like SET_FROM_NOW and SET_FROM_START. I think the latter sounds better.", "author": "trustin", "createdAt": "2020-03-12T11:12:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTQxMDY4Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjAxODA0Mw==", "url": "https://github.com/line/armeria/pull/2571#discussion_r392018043", "bodyText": "Making all verbs with e.g. SET_* sounds good.", "author": "anuraaga", "createdAt": "2020-03-13T03:50:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTQxMDY4Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjAyMDkyMQ==", "url": "https://github.com/line/armeria/pull/2571#discussion_r392020921", "bodyText": "SET_* is explicit, but we already have set verb in the method name.\nctx.setTimeout(TimeoutMode.SET_FROM_NOW, Duration.ofSeconds(1))\nMaybe we could remove set from the method names?\nctx.timeout(TimeoutMode.SET_FROM_NOW, Duration.ofSeconds(1));\nctx.timeout(TimeoutMode.SET_FROM_START, Duration.ofSeconds(1));\nctx.timeout(TimeoutMode.EXTEND, Duration.ofSeconds(1));\n\n// a shortcut for TimeoutMode.SET_FROM_NOW\nctx.setTimeout(Duration.ofSeconds(1));", "author": "ikhoon", "createdAt": "2020-03-13T04:05:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTQxMDY4Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjA0MTAxNQ==", "url": "https://github.com/line/armeria/pull/2571#discussion_r392041015", "bodyText": "Removing set from method names SGTM", "author": "anuraaga", "createdAt": "2020-03-13T05:49:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTQxMDY4Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTU0ODI3NQ==", "url": "https://github.com/line/armeria/pull/2571#discussion_r391548275", "bodyText": "Perhaps the sensible default would be TimeoutMode.FROM_NOW?", "author": "trustin", "createdAt": "2020-03-12T11:07:30Z", "path": "core/src/main/java/com/linecorp/armeria/client/ClientRequestContext.java", "diffHunk": "@@ -444,17 +485,57 @@ ClientRequestContext newDerivedContext(RequestId id, @Nullable HttpRequest req,\n      * @param responseTimeoutMillis the amount of time allowed in milliseconds from\n      *                              the beginning of the response\n      *\n-     * @deprecated Use {@link #extendResponseTimeoutMillis(long)}, {@link #setResponseTimeoutAfterMillis(long)},\n-     *             {@link #setResponseTimeoutAtMillis(long)} or {@link #clearResponseTimeout()}\n      */\n-    @Deprecated\n-    void setResponseTimeoutMillis(long responseTimeoutMillis);\n+    default void setResponseTimeoutMillis(long responseTimeoutMillis) {\n+        setResponseTimeoutMillis(TimeoutMode.FROM_START, responseTimeoutMillis);", "originalCommit": "783d9c98b36d7f80b86903589c73a604f8dc4f1a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTU1MzU1Mw==", "url": "https://github.com/line/armeria/pull/2571#discussion_r391553553", "bodyText": "Oops... thanks for pointing it out!\ud83d\ude4f", "author": "ikhoon", "createdAt": "2020-03-12T11:18:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTU0ODI3NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTU1MDc0Nw==", "url": "https://github.com/line/armeria/pull/2571#discussion_r391550747", "bodyText": "Could use switch-case", "author": "trustin", "createdAt": "2020-03-12T11:12:28Z", "path": "core/src/main/java/com/linecorp/armeria/internal/common/TimeoutScheduler.java", "diffHunk": "@@ -61,6 +66,16 @@ public void clearTimeout() {\n         }\n     }\n \n+    public void setTimeoutMillis(TimeoutMode mode, long timeoutMillis) {\n+        if (mode == FROM_NOW) {\n+            setTimeoutAfterMillis(timeoutMillis);\n+        } else if (mode == FROM_START) {\n+            setTimeoutMillis(timeoutMillis);\n+        } else if (mode == EXTEND) {\n+            extendTimeoutMillis(timeoutMillis);\n+        }", "originalCommit": "783d9c98b36d7f80b86903589c73a604f8dc4f1a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "6de3a0c8f26fadcefdd8e9b583b59c201a604964", "url": "https://github.com/line/armeria/commit/6de3a0c8f26fadcefdd8e9b583b59c201a604964", "message": "Address comment by @trustin", "committedDate": "2020-03-12T11:46:36Z", "type": "commit"}, {"oid": "a2608fe1388912d923d1dbea754266c71de90b9e", "url": "https://github.com/line/armeria/commit/a2608fe1388912d923d1dbea754266c71de90b9e", "message": "Address comments by @trustin / use switch case", "committedDate": "2020-03-13T04:11:25Z", "type": "commit"}, {"oid": "83a4fdae315c0ba93609f6d17539a0dd5881d744", "url": "https://github.com/line/armeria/commit/83a4fdae315c0ba93609f6d17539a0dd5881d744", "message": "Merge branch 'master' into revamp-settimeout", "committedDate": "2020-03-13T04:13:04Z", "type": "commit"}, {"oid": "b5f2c5ae807424d5c0e67fbbc4e6e3269fc5fab8", "url": "https://github.com/line/armeria/commit/b5f2c5ae807424d5c0e67fbbc4e6e3269fc5fab8", "message": "Change enum name and fix test", "committedDate": "2020-03-13T06:42:38Z", "type": "commit"}, {"oid": "162a58bed6d1fb4ed6c37290ef736e102a31cd01", "url": "https://github.com/line/armeria/commit/162a58bed6d1fb4ed6c37290ef736e102a31cd01", "message": "Merge branch 'master' into revamp-settimeout", "committedDate": "2020-03-17T06:22:51Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDA1NTkwOQ==", "url": "https://github.com/line/armeria/pull/2571#discussion_r394055909", "bodyText": "this could be private", "author": "minwoox", "createdAt": "2020-03-18T01:16:05Z", "path": "core/src/main/java/com/linecorp/armeria/internal/common/TimeoutScheduler.java", "diffHunk": "@@ -61,6 +63,20 @@ public void clearTimeout() {\n         }\n     }\n \n+    public void setTimeoutMillis(TimeoutMode mode, long timeoutMillis) {\n+        switch (mode) {\n+            case SET_FROM_NOW:\n+                setTimeoutAfterMillis(timeoutMillis);\n+                break;\n+            case SET_FROM_START:\n+                setTimeoutMillis(timeoutMillis);\n+                break;\n+            case EXTEND:\n+                extendTimeoutMillis(timeoutMillis);\n+                break;\n+        }\n+    }\n+\n     public void setTimeoutMillis(long timeoutMillis) {", "originalCommit": "162a58bed6d1fb4ed6c37290ef736e102a31cd01", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDA1NjE3NA==", "url": "https://github.com/line/armeria/pull/2571#discussion_r394056174", "bodyText": "nit: null check", "author": "minwoox", "createdAt": "2020-03-18T01:17:22Z", "path": "core/src/main/java/com/linecorp/armeria/client/DefaultClientRequestContext.java", "diffHunk": "@@ -439,45 +439,16 @@ public void clearResponseTimeout() {\n     }\n \n     @Override\n-    public void setResponseTimeoutMillis(long responseTimeoutMillis) {\n-        timeoutScheduler.setTimeoutMillis(responseTimeoutMillis);\n-    }\n-\n-    @Override\n-    public void setResponseTimeout(Duration responseTimeout) {\n-        setResponseTimeoutMillis(requireNonNull(responseTimeout, \"responseTimeout\").toMillis());\n-    }\n-\n-    @Override\n-    public void extendResponseTimeoutMillis(long adjustmentMillis) {\n-        timeoutScheduler.extendTimeoutMillis(adjustmentMillis);\n-    }\n-\n-    @Override\n-    public void extendResponseTimeout(Duration adjustment) {\n-        extendResponseTimeoutMillis(requireNonNull(adjustment, \"adjustment\").toMillis());\n-    }\n-\n-    @Override\n-    public void setResponseTimeoutAfterMillis(long responseTimeoutMillis) {\n-        timeoutScheduler.setTimeoutAfterMillis(responseTimeoutMillis);\n-    }\n-\n-    @Override\n-    public void setResponseTimeoutAfter(Duration responseTimeout) {\n-        setResponseTimeoutAfterMillis(requireNonNull(responseTimeout, \"responseTimeout\").toMillis());\n+    public void setResponseTimeoutMillis(TimeoutMode mode, long responseTimeoutMillis) {\n+        timeoutScheduler.setTimeoutMillis(mode, responseTimeoutMillis);", "originalCommit": "162a58bed6d1fb4ed6c37290ef736e102a31cd01", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "49899e477ca53c92d67aff802de81e4ab9234a93", "url": "https://github.com/line/armeria/commit/49899e477ca53c92d67aff802de81e4ab9234a93", "message": "Update DefaultClientRequestContext.java", "committedDate": "2020-03-18T01:45:49Z", "type": "commit"}, {"oid": "99a27b485db91d767681dc8e70720f7998c598b3", "url": "https://github.com/line/armeria/commit/99a27b485db91d767681dc8e70720f7998c598b3", "message": "Update TimeoutScheduler.java", "committedDate": "2020-03-18T01:46:31Z", "type": "commit"}]}