{"pr_number": 2516, "pr_title": "Exclude default options when merging two `Client*Options`", "pr_createdAt": "2020-02-19T15:27:02Z", "pr_url": "https://github.com/line/armeria/pull/2516", "timeline": [{"oid": "531fd73722e417a5b98d77e28d35e7a8ab9c37a0", "url": "https://github.com/line/armeria/commit/531fd73722e417a5b98d77e28d35e7a8ab9c37a0", "message": "Exclude default options when merging two `Client*Options`\n\nMotivation:\nAfter Armeria 0.98.0, `WebClientBuilder` and `ClientBuilder` can set `ClientOptions` and `ClientFactory` easily.\n```java\nWebClient.builder()\n         .fatory(factory) // Set custom factory\n         .options(options) // The custom factory gets overridden by ClientFactory.ofDefault()\n         .build();\nClients.builder(uri)\n       .factory(factory)\n       .options(options)\n       .build();\n```\nUnfortunately, the `factory` set to client get overridden by `ClientOption.FACTORY` of `options`\neven though a user did not specifity the factory in `ClientOption`.\nBecuase the `ClientOption` has `ClientOption.FACTORY` by default.\nIt confuses users who use the client builders.\n\nModification:\n* Do not set `DEFAULT` options when building `Client*Options`\n* Add `Client*Options.OPTIONS` for accessing all options\n* Add `valueMap` to `Client*Options` for getting own options.\n* `Client*Options.get*` has priority in order of own, parent and `DEFAULT`\n* Breaking\n  * `asMap()` in `ClientOptions` and `ClientFactoryOptions` has been\n    removed without replacement.\n  * `ClientOption.DEFAULT` has been removed in favor of `ClientOption.of()`\n\nResult:\nThe default client factory in `ClientOptions` doesn't override the `ClientFactory` you specify.\nFixes: #2493", "committedDate": "2020-02-19T15:38:15Z", "type": "commit"}, {"oid": "531fd73722e417a5b98d77e28d35e7a8ab9c37a0", "url": "https://github.com/line/armeria/commit/531fd73722e417a5b98d77e28d35e7a8ab9c37a0", "message": "Exclude default options when merging two `Client*Options`\n\nMotivation:\nAfter Armeria 0.98.0, `WebClientBuilder` and `ClientBuilder` can set `ClientOptions` and `ClientFactory` easily.\n```java\nWebClient.builder()\n         .fatory(factory) // Set custom factory\n         .options(options) // The custom factory gets overridden by ClientFactory.ofDefault()\n         .build();\nClients.builder(uri)\n       .factory(factory)\n       .options(options)\n       .build();\n```\nUnfortunately, the `factory` set to client get overridden by `ClientOption.FACTORY` of `options`\neven though a user did not specifity the factory in `ClientOption`.\nBecuase the `ClientOption` has `ClientOption.FACTORY` by default.\nIt confuses users who use the client builders.\n\nModification:\n* Do not set `DEFAULT` options when building `Client*Options`\n* Add `Client*Options.OPTIONS` for accessing all options\n* Add `valueMap` to `Client*Options` for getting own options.\n* `Client*Options.get*` has priority in order of own, parent and `DEFAULT`\n* Breaking\n  * `asMap()` in `ClientOptions` and `ClientFactoryOptions` has been\n    removed without replacement.\n  * `ClientOption.DEFAULT` has been removed in favor of `ClientOption.of()`\n\nResult:\nThe default client factory in `ClientOptions` doesn't override the `ClientFactory` you specify.\nFixes: #2493", "committedDate": "2020-02-19T15:38:15Z", "type": "forcePushed"}, {"oid": "a5e66b188150e96e82c9872f417746f2b26f5da4", "url": "https://github.com/line/armeria/commit/a5e66b188150e96e82c9872f417746f2b26f5da4", "message": "Revert blank line", "committedDate": "2020-02-19T15:48:37Z", "type": "commit"}, {"oid": "72ab3739f86ee8c375256661d979908da80c18d8", "url": "https://github.com/line/armeria/commit/72ab3739f86ee8c375256661d979908da80c18d8", "message": "Remove Client*Option.OPTIONS", "committedDate": "2020-02-19T16:21:49Z", "type": "commit"}, {"oid": "ba7fcef6f48ca768ba3d5092b6bc6455a525634e", "url": "https://github.com/line/armeria/commit/ba7fcef6f48ca768ba3d5092b6bc6455a525634e", "message": "Change ImmutableSet.copyOf to Collections.unmodifiableSet", "committedDate": "2020-02-20T05:50:22Z", "type": "commit"}, {"oid": "a1dbb8d3401f14ba12c48f0e397dd437c3320ac9", "url": "https://github.com/line/armeria/commit/a1dbb8d3401f14ba12c48f0e397dd437c3320ac9", "message": "Revert EMTPY to of()", "committedDate": "2020-02-20T05:54:58Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTc4NzkyMw==", "url": "https://github.com/line/armeria/pull/2516#discussion_r381787923", "bodyText": "This is not very efficient because we have to do a lookup for each option. How about making AbstractOptions implement Iterable<AbstractOptionValue>?\npublic abstract class AbstractOptions<T extends AbstractOptionValue<?, ?>>\n        implements Iterable<T>", "author": "trustin", "createdAt": "2020-02-20T06:05:55Z", "path": "core/src/main/java/com/linecorp/armeria/client/AbstractClientOptionsBuilder.java", "diffHunk": "@@ -60,7 +60,12 @@ protected AbstractClientOptionsBuilder(ClientOptions options) {\n      */\n     public AbstractClientOptionsBuilder options(ClientOptions options) {\n         requireNonNull(options, \"options\");\n-        options.asMap().values().forEach(this::option);\n+        for (ClientOption<Object> option : options.options()) {\n+            final Object value = options.getOrNull(option, false);", "originalCommit": "a1dbb8d3401f14ba12c48f0e397dd437c3320ac9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTg3MjM4Ng==", "url": "https://github.com/line/armeria/pull/2516#discussion_r381872386", "bodyText": "That sounds good. \ud83d\udc4d", "author": "ikhoon", "createdAt": "2020-02-20T09:18:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTc4NzkyMw=="}], "type": "inlineReview"}, {"oid": "656b71970498869723d41a05742cc416a6144cd9", "url": "https://github.com/line/armeria/commit/656b71970498869723d41a05742cc416a6144cd9", "message": "Remove valueMap and releted code in subclases of `AbstractOptions`", "committedDate": "2020-02-20T07:26:57Z", "type": "commit"}, {"oid": "21c4072289cdf8038c68f6f827254e403c3c70cb", "url": "https://github.com/line/armeria/commit/21c4072289cdf8038c68f6f827254e403c3c70cb", "message": "Address comments by @trustin / Remove `options()` and implements `Iterable`", "committedDate": "2020-02-20T09:13:33Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjAzOTc1MA==", "url": "https://github.com/line/armeria/pull/2516#discussion_r382039750", "bodyText": "Returns an empty singleton {@link ClientFactoryOptions}.", "author": "trustin", "createdAt": "2020-02-20T14:39:32Z", "path": "core/src/main/java/com/linecorp/armeria/client/ClientFactoryOptions.java", "diffHunk": "@@ -99,13 +99,16 @@\n             ClientFactoryOption.METER_REGISTRY.newValue(Metrics.globalRegistry)\n     };\n \n-    private static final ClientFactoryOptions DEFAULT = new ClientFactoryOptions(DEFAULT_OPTIONS);\n+    @VisibleForTesting\n+    static final ClientFactoryOptions DEFAULT = new ClientFactoryOptions(DEFAULT_OPTIONS);\n+\n+    private static final ClientFactoryOptions EMPTY = new ClientFactoryOptions();\n \n     /**\n      * The default {@link ClientFactoryOptions}.", "originalCommit": "21c4072289cdf8038c68f6f827254e403c3c70cb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjA0MzEzMA==", "url": "https://github.com/line/armeria/pull/2516#discussion_r382043130", "bodyText": "Could we make sure first and second have the same type parameter?\nMissing Javadoc", "author": "trustin", "createdAt": "2020-02-20T14:44:23Z", "path": "core/src/main/java/com/linecorp/armeria/common/util/AbstractOptions.java", "diffHunk": "@@ -19,31 +19,60 @@\n \n import java.util.Arrays;\n import java.util.Collection;\n-import java.util.Collections;\n import java.util.IdentityHashMap;\n+import java.util.Iterator;\n import java.util.Map;\n import java.util.NoSuchElementException;\n \n import javax.annotation.Nullable;\n \n+import com.google.common.collect.Iterators;\n+\n /**\n  * A set of configuration options and their respective values.\n  *\n  * @see AbstractOption\n  * @see AbstractOptionValue\n  */\n-public abstract class AbstractOptions {\n+public abstract class AbstractOptions<T extends AbstractOptionValue<?, ?>> implements Iterable<T> {\n+\n+    protected static <V> V get(AbstractOptions<?> first, AbstractOptions<?> second, AbstractOption<V> option) {", "originalCommit": "21c4072289cdf8038c68f6f827254e403c3c70cb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjA0NDE4NQ==", "url": "https://github.com/line/armeria/pull/2516#discussion_r382044185", "bodyText": "Not necessarily part of this PR, but how about rewriting this method with MoreObjects.toStringHelper?", "author": "trustin", "createdAt": "2020-02-20T14:46:05Z", "path": "core/src/main/java/com/linecorp/armeria/common/util/AbstractOptions.java", "diffHunk": "@@ -188,37 +201,14 @@ protected AbstractOptions(AbstractOptions baseOptions, AbstractOptions additiona\n         return optionValue != null ? optionValue.value() : null;\n     }\n \n-    /**\n-     * Returns the value of the specified {@code option}.\n-     *\n-     * @param <O> the type of the option\n-     * @param <V> the type of the value\n-     * @return the value of the specified {@code option}. {@code defaultValue} if there's no such option.\n-     */\n-    protected final <O extends AbstractOption<V>, V> V getOrElse0(O option, V defaultValue) {\n-        requireNonNull(defaultValue, \"defaultValue\");\n-        final V value = getOrNull0(option);\n-        if (value != null) {\n-            return value;\n-        } else {\n-            return defaultValue;\n-        }\n-    }\n-\n-    /**\n-     * Returns the {@link Map} whose key is {@link AbstractOption} and value is {@link AbstractOptionValue}.\n-     *\n-     * @param <K> the type of the options\n-     * @param <V> the type of the option values\n-     */\n-    @SuppressWarnings(\"unchecked\")\n-    protected final <K extends AbstractOption<?>, V extends AbstractOptionValue<K, ?>> Map<K, V> asMap0() {\n-        return Collections.unmodifiableMap((Map<? extends K, ? extends V>) valueMap);\n+    @Override\n+    public Iterator<T> iterator() {\n+        return Iterators.unmodifiableIterator(valueMap.values().iterator());\n     }\n \n     @Override\n     public String toString() {\n-        return toString(asMap0().values());\n+        return toString(valueMap.values());\n     }\n \n     static String toString(Collection<?> values) {", "originalCommit": "21c4072289cdf8038c68f6f827254e403c3c70cb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjA0NTU3Mg==", "url": "https://github.com/line/armeria/pull/2516#discussion_r382045572", "bodyText": "Could use: https://joel-costigliola.github.io/assertj/core/api/org/assertj/core/api/AbstractIterableAssert.html#isEmpty() ?", "author": "trustin", "createdAt": "2020-02-20T14:48:04Z", "path": "core/src/test/java/com/linecorp/armeria/client/ClientFactoryOptionsTest.java", "diffHunk": "@@ -0,0 +1,133 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.client;\n+\n+import static com.google.common.collect.ImmutableSet.toImmutableSet;\n+import static com.linecorp.armeria.client.ClientFactoryOption.ADDRESS_RESOLVER_GROUP_FACTORY;\n+import static com.linecorp.armeria.client.ClientFactoryOption.CHANNEL_OPTIONS;\n+import static com.linecorp.armeria.client.ClientFactoryOption.CONNECTION_POOL_LISTENER;\n+import static com.linecorp.armeria.client.ClientFactoryOption.EVENT_LOOP_SCHEDULER_FACTORY;\n+import static com.linecorp.armeria.client.ClientFactoryOption.HTTP1_MAX_CHUNK_SIZE;\n+import static com.linecorp.armeria.client.ClientFactoryOption.HTTP1_MAX_HEADER_SIZE;\n+import static com.linecorp.armeria.client.ClientFactoryOption.HTTP1_MAX_INITIAL_LINE_LENGTH;\n+import static com.linecorp.armeria.client.ClientFactoryOption.HTTP2_INITIAL_CONNECTION_WINDOW_SIZE;\n+import static com.linecorp.armeria.client.ClientFactoryOption.HTTP2_INITIAL_STREAM_WINDOW_SIZE;\n+import static com.linecorp.armeria.client.ClientFactoryOption.HTTP2_MAX_FRAME_SIZE;\n+import static com.linecorp.armeria.client.ClientFactoryOption.HTTP2_MAX_HEADER_LIST_SIZE;\n+import static com.linecorp.armeria.client.ClientFactoryOption.IDLE_TIMEOUT_MILLIS;\n+import static com.linecorp.armeria.client.ClientFactoryOption.METER_REGISTRY;\n+import static com.linecorp.armeria.client.ClientFactoryOption.SHUTDOWN_WORKER_GROUP_ON_CLOSE;\n+import static com.linecorp.armeria.client.ClientFactoryOption.USE_HTTP1_PIPELINING;\n+import static com.linecorp.armeria.client.ClientFactoryOption.USE_HTTP2_PREFACE;\n+import static com.linecorp.armeria.client.ClientFactoryOption.WORKER_GROUP;\n+import static com.linecorp.armeria.client.ClientOptionsTest.getAllPublicStaticFinal;\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.junit.jupiter.params.provider.Arguments.arguments;\n+\n+import java.net.InetSocketAddress;\n+import java.util.Set;\n+import java.util.concurrent.TimeUnit;\n+import java.util.function.Function;\n+import java.util.stream.Stream;\n+\n+import org.junit.jupiter.api.AfterAll;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.extension.ExtensionContext;\n+import org.junit.jupiter.params.ParameterizedTest;\n+import org.junit.jupiter.params.provider.Arguments;\n+import org.junit.jupiter.params.provider.ArgumentsProvider;\n+import org.junit.jupiter.params.provider.ArgumentsSource;\n+\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.collect.ImmutableMap;\n+import com.google.common.collect.Iterables;\n+import com.google.common.collect.Streams;\n+import com.google.common.util.concurrent.MoreExecutors;\n+\n+import com.linecorp.armeria.common.util.AbstractOptionValue;\n+import com.linecorp.armeria.common.util.EventLoopGroups;\n+\n+import io.micrometer.core.instrument.Metrics;\n+import io.netty.channel.EventLoopGroup;\n+import io.netty.resolver.AddressResolverGroup;\n+\n+class ClientFactoryOptionsTest {\n+\n+    static EventLoopGroup executors;\n+\n+    @BeforeAll\n+    static void setUp() {\n+        executors = EventLoopGroups.newEventLoopGroup(1);\n+    }\n+\n+    @AfterAll\n+    static void tearDown() {\n+        assertThat(MoreExecutors.shutdownAndAwaitTermination(executors, 10, TimeUnit.SECONDS)).isTrue();\n+    }\n+\n+    @Test\n+    void allDefaultOptionsArePresent() throws Exception {\n+        @SuppressWarnings(\"rawtypes\")\n+        final Set<ClientFactoryOption> options = getAllPublicStaticFinal(ClientFactoryOption.class);\n+        final Set<ClientFactoryOption<?>> defaults = Streams.stream(ClientFactoryOptions.DEFAULT)\n+                                                            .map(AbstractOptionValue::option)\n+                                                            .collect(toImmutableSet());\n+\n+        assertThat(defaults).isEqualTo(options);\n+        assertThat(Iterables.size(ClientFactoryOptions.of())).isZero();", "originalCommit": "21c4072289cdf8038c68f6f827254e403c3c70cb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjA1NDYxNA==", "url": "https://github.com/line/armeria/pull/2516#discussion_r382054614", "bodyText": "Oh, Nice tip!", "author": "ikhoon", "createdAt": "2020-02-20T15:01:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjA0NTU3Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjA0NjY1Nw==", "url": "https://github.com/line/armeria/pull/2516#discussion_r382046657", "bodyText": "Indentation", "author": "trustin", "createdAt": "2020-02-20T14:49:42Z", "path": "core/src/test/java/com/linecorp/armeria/client/WebClientBuilderTest.java", "diffHunk": "@@ -0,0 +1,87 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.client;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+\n+import org.junit.jupiter.api.Test;\n+\n+class WebClientBuilderTest {\n+\n+    @Test\n+    void keepCustomFactory() {\n+        final ClientFactory factory = ClientFactory.builder()\n+                                                   .option(ClientFactoryOption.HTTP1_MAX_CHUNK_SIZE, 100)\n+                                                   .build();\n+        final ClientOptions options = ClientOptions.of(ClientOption.RESPONSE_TIMEOUT_MILLIS.newValue(200L));\n+        final WebClient webClient = WebClient.builder(\"http://foo\")\n+                                             .factory(factory)\n+                                             .options(options)\n+                                             .build();\n+\n+        final ClientOptions clientOptions = webClient.options();\n+        assertThat(clientOptions.get(ClientOption.RESPONSE_TIMEOUT_MILLIS)).isEqualTo(200);\n+        final ClientFactory clientFactory = clientOptions.factory();\n+        assertThat(clientFactory.options().get(ClientFactoryOption.HTTP1_MAX_CHUNK_SIZE)).isEqualTo(100);\n+    }\n+\n+    @Test\n+    void keepLastFactory_by_options() {\n+        final ClientFactory optionClientFactory = ClientFactory.builder()\n+                                                    .option(ClientFactoryOption.HTTP1_MAX_CHUNK_SIZE, 200)\n+                                                    .build();", "originalCommit": "21c4072289cdf8038c68f6f827254e403c3c70cb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjA0Njk2NQ==", "url": "https://github.com/line/armeria/pull/2516#discussion_r382046965", "bodyText": "Indentation", "author": "trustin", "createdAt": "2020-02-20T14:50:10Z", "path": "core/src/test/java/com/linecorp/armeria/client/WebClientBuilderTest.java", "diffHunk": "@@ -0,0 +1,87 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.client;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+\n+import org.junit.jupiter.api.Test;\n+\n+class WebClientBuilderTest {\n+\n+    @Test\n+    void keepCustomFactory() {\n+        final ClientFactory factory = ClientFactory.builder()\n+                                                   .option(ClientFactoryOption.HTTP1_MAX_CHUNK_SIZE, 100)\n+                                                   .build();\n+        final ClientOptions options = ClientOptions.of(ClientOption.RESPONSE_TIMEOUT_MILLIS.newValue(200L));\n+        final WebClient webClient = WebClient.builder(\"http://foo\")\n+                                             .factory(factory)\n+                                             .options(options)\n+                                             .build();\n+\n+        final ClientOptions clientOptions = webClient.options();\n+        assertThat(clientOptions.get(ClientOption.RESPONSE_TIMEOUT_MILLIS)).isEqualTo(200);\n+        final ClientFactory clientFactory = clientOptions.factory();\n+        assertThat(clientFactory.options().get(ClientFactoryOption.HTTP1_MAX_CHUNK_SIZE)).isEqualTo(100);\n+    }\n+\n+    @Test\n+    void keepLastFactory_by_options() {\n+        final ClientFactory optionClientFactory = ClientFactory.builder()\n+                                                    .option(ClientFactoryOption.HTTP1_MAX_CHUNK_SIZE, 200)\n+                                                    .build();\n+        final ClientOptions options = ClientOptions.of(ClientOption.RESPONSE_TIMEOUT_MILLIS.newValue(200L),\n+                                                       ClientOption.FACTORY.newValue(optionClientFactory));\n+\n+        final ClientFactory factory = ClientFactory.builder()\n+                                                    .option(ClientFactoryOption.HTTP1_MAX_CHUNK_SIZE, 100)\n+                                                    .build();", "originalCommit": "21c4072289cdf8038c68f6f827254e403c3c70cb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjA0NzA4Nw==", "url": "https://github.com/line/armeria/pull/2516#discussion_r382047087", "bodyText": "Indentation", "author": "trustin", "createdAt": "2020-02-20T14:50:22Z", "path": "core/src/test/java/com/linecorp/armeria/client/WebClientBuilderTest.java", "diffHunk": "@@ -0,0 +1,87 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.client;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+\n+import org.junit.jupiter.api.Test;\n+\n+class WebClientBuilderTest {\n+\n+    @Test\n+    void keepCustomFactory() {\n+        final ClientFactory factory = ClientFactory.builder()\n+                                                   .option(ClientFactoryOption.HTTP1_MAX_CHUNK_SIZE, 100)\n+                                                   .build();\n+        final ClientOptions options = ClientOptions.of(ClientOption.RESPONSE_TIMEOUT_MILLIS.newValue(200L));\n+        final WebClient webClient = WebClient.builder(\"http://foo\")\n+                                             .factory(factory)\n+                                             .options(options)\n+                                             .build();\n+\n+        final ClientOptions clientOptions = webClient.options();\n+        assertThat(clientOptions.get(ClientOption.RESPONSE_TIMEOUT_MILLIS)).isEqualTo(200);\n+        final ClientFactory clientFactory = clientOptions.factory();\n+        assertThat(clientFactory.options().get(ClientFactoryOption.HTTP1_MAX_CHUNK_SIZE)).isEqualTo(100);\n+    }\n+\n+    @Test\n+    void keepLastFactory_by_options() {\n+        final ClientFactory optionClientFactory = ClientFactory.builder()\n+                                                    .option(ClientFactoryOption.HTTP1_MAX_CHUNK_SIZE, 200)\n+                                                    .build();\n+        final ClientOptions options = ClientOptions.of(ClientOption.RESPONSE_TIMEOUT_MILLIS.newValue(200L),\n+                                                       ClientOption.FACTORY.newValue(optionClientFactory));\n+\n+        final ClientFactory factory = ClientFactory.builder()\n+                                                    .option(ClientFactoryOption.HTTP1_MAX_CHUNK_SIZE, 100)\n+                                                    .build();\n+\n+        final WebClient webClient = WebClient.builder(\"http://foo\")\n+                                             .factory(factory)\n+                                             .options(options)\n+                                             .build();\n+\n+        final ClientOptions clientOptions = webClient.options();\n+        assertThat(clientOptions.get(ClientOption.RESPONSE_TIMEOUT_MILLIS)).isEqualTo(200);\n+        final ClientFactory clientFactory = clientOptions.factory();\n+        assertThat(clientFactory.options().get(ClientFactoryOption.HTTP1_MAX_CHUNK_SIZE)).isEqualTo(200);\n+    }\n+\n+    @Test\n+    void keepLastFactory_by_factory() {\n+        final ClientFactory optionClientFactory = ClientFactory.builder()\n+                                                    .option(ClientFactoryOption.HTTP1_MAX_CHUNK_SIZE, 200)\n+                                                    .build();", "originalCommit": "21c4072289cdf8038c68f6f827254e403c3c70cb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjA0NzE1NQ==", "url": "https://github.com/line/armeria/pull/2516#discussion_r382047155", "bodyText": "Indentation", "author": "trustin", "createdAt": "2020-02-20T14:50:28Z", "path": "core/src/test/java/com/linecorp/armeria/client/WebClientBuilderTest.java", "diffHunk": "@@ -0,0 +1,87 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.client;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+\n+import org.junit.jupiter.api.Test;\n+\n+class WebClientBuilderTest {\n+\n+    @Test\n+    void keepCustomFactory() {\n+        final ClientFactory factory = ClientFactory.builder()\n+                                                   .option(ClientFactoryOption.HTTP1_MAX_CHUNK_SIZE, 100)\n+                                                   .build();\n+        final ClientOptions options = ClientOptions.of(ClientOption.RESPONSE_TIMEOUT_MILLIS.newValue(200L));\n+        final WebClient webClient = WebClient.builder(\"http://foo\")\n+                                             .factory(factory)\n+                                             .options(options)\n+                                             .build();\n+\n+        final ClientOptions clientOptions = webClient.options();\n+        assertThat(clientOptions.get(ClientOption.RESPONSE_TIMEOUT_MILLIS)).isEqualTo(200);\n+        final ClientFactory clientFactory = clientOptions.factory();\n+        assertThat(clientFactory.options().get(ClientFactoryOption.HTTP1_MAX_CHUNK_SIZE)).isEqualTo(100);\n+    }\n+\n+    @Test\n+    void keepLastFactory_by_options() {\n+        final ClientFactory optionClientFactory = ClientFactory.builder()\n+                                                    .option(ClientFactoryOption.HTTP1_MAX_CHUNK_SIZE, 200)\n+                                                    .build();\n+        final ClientOptions options = ClientOptions.of(ClientOption.RESPONSE_TIMEOUT_MILLIS.newValue(200L),\n+                                                       ClientOption.FACTORY.newValue(optionClientFactory));\n+\n+        final ClientFactory factory = ClientFactory.builder()\n+                                                    .option(ClientFactoryOption.HTTP1_MAX_CHUNK_SIZE, 100)\n+                                                    .build();\n+\n+        final WebClient webClient = WebClient.builder(\"http://foo\")\n+                                             .factory(factory)\n+                                             .options(options)\n+                                             .build();\n+\n+        final ClientOptions clientOptions = webClient.options();\n+        assertThat(clientOptions.get(ClientOption.RESPONSE_TIMEOUT_MILLIS)).isEqualTo(200);\n+        final ClientFactory clientFactory = clientOptions.factory();\n+        assertThat(clientFactory.options().get(ClientFactoryOption.HTTP1_MAX_CHUNK_SIZE)).isEqualTo(200);\n+    }\n+\n+    @Test\n+    void keepLastFactory_by_factory() {\n+        final ClientFactory optionClientFactory = ClientFactory.builder()\n+                                                    .option(ClientFactoryOption.HTTP1_MAX_CHUNK_SIZE, 200)\n+                                                    .build();\n+        final ClientOptions options = ClientOptions.of(ClientOption.RESPONSE_TIMEOUT_MILLIS.newValue(200L),\n+                                                       ClientOption.FACTORY.newValue(optionClientFactory));\n+\n+        final ClientFactory factory = ClientFactory.builder()\n+                                                    .option(ClientFactoryOption.HTTP1_MAX_CHUNK_SIZE, 100)\n+                                                    .build();", "originalCommit": "21c4072289cdf8038c68f6f827254e403c3c70cb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjA0ODE1Nw==", "url": "https://github.com/line/armeria/pull/2516#discussion_r382048157", "bodyText": "Unused?", "author": "trustin", "createdAt": "2020-02-20T14:51:55Z", "path": "core/src/main/java/com/linecorp/armeria/client/ClientFactoryOptions.java", "diffHunk": "@@ -223,7 +226,16 @@ private ClientFactoryOptions(ClientFactoryOptions baseOptions,\n      */\n     @Nullable\n     public <T> T getOrNull(ClientFactoryOption<T> option) {\n-        return getOrNull0(option);\n+        return getOrNull(this, DEFAULT, option);\n+    }\n+\n+    @Nullable\n+    <T> T getOrNull(ClientFactoryOption<T> option, boolean includeDefault) {", "originalCommit": "21c4072289cdf8038c68f6f827254e403c3c70cb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjA1MjQ1Nw==", "url": "https://github.com/line/armeria/pull/2516#discussion_r382052457", "bodyText": "Oops..", "author": "ikhoon", "createdAt": "2020-02-20T14:58:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjA0ODE1Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjA0ODMwMg==", "url": "https://github.com/line/armeria/pull/2516#discussion_r382048302", "bodyText": "Unused?", "author": "trustin", "createdAt": "2020-02-20T14:52:09Z", "path": "core/src/main/java/com/linecorp/armeria/client/ClientOptions.java", "diffHunk": "@@ -262,7 +254,16 @@ private ClientOptions(ClientOptions baseOptions, ClientOptions additionalOptions\n      */\n     @Nullable\n     public <T> T getOrNull(ClientOption<T> option) {\n-        return getOrNull0(option);\n+        return getOrNull(this, DEFAULT, option);\n+    }\n+\n+    @Nullable\n+    <T> T getOrNull(ClientOption<T> option, boolean includeDefault) {", "originalCommit": "21c4072289cdf8038c68f6f827254e403c3c70cb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "2f5003f01301aff804a3fd526fb652c46c2d3ca8", "url": "https://github.com/line/armeria/commit/2f5003f01301aff804a3fd526fb652c46c2d3ca8", "message": "Address comments by @trustin\n\n- Add missing Javadoc\n- Remove unused code\n- Fix indent\n- Add additional type parameter for get(first, second...)", "committedDate": "2020-02-20T15:42:02Z", "type": "commit"}, {"oid": "59056cf802ea74456fb3f11a85512dc70889bed7", "url": "https://github.com/line/armeria/commit/59056cf802ea74456fb3f11a85512dc70889bed7", "message": "Clean up Javadoc", "committedDate": "2020-02-20T15:56:40Z", "type": "commit"}, {"oid": "9a312690ab9523740bc79aba61e4a83633208001", "url": "https://github.com/line/armeria/commit/9a312690ab9523740bc79aba61e4a83633208001", "message": "Clean up Javadoc", "committedDate": "2020-02-21T02:00:45Z", "type": "commit"}, {"oid": "32e885e12f3648fda2b6046956562d59cf7d5bad", "url": "https://github.com/line/armeria/commit/32e885e12f3648fda2b6046956562d59cf7d5bad", "message": "Revive 'AbstractOptions.asMap()'", "committedDate": "2020-02-21T05:42:51Z", "type": "commit"}, {"oid": "adf958d1406318f2fd79936242f8b9e6d134d09e", "url": "https://github.com/line/armeria/commit/adf958d1406318f2fd79936242f8b9e6d134d09e", "message": "Fix return type of 'asMap()'", "committedDate": "2020-02-21T06:33:34Z", "type": "commit"}, {"oid": "4e2fc1e0af4fb2bb5b9623e16ed9b2b4833575e5", "url": "https://github.com/line/armeria/commit/4e2fc1e0af4fb2bb5b9623e16ed9b2b4833575e5", "message": "Update ClientFactoryOptionsTest.java", "committedDate": "2020-02-21T07:54:03Z", "type": "commit"}, {"oid": "f9a9b09c29df7ae703884221bc50a58c343be413", "url": "https://github.com/line/armeria/commit/f9a9b09c29df7ae703884221bc50a58c343be413", "message": "Update ClientOptionsTest.java", "committedDate": "2020-02-21T07:54:28Z", "type": "commit"}]}