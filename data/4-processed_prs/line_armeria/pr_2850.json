{"pr_number": 2850, "pr_title": "Return the Host header value from `RequestHeaders.authority()` if `:a\u2026", "pr_createdAt": "2020-06-29T07:47:55Z", "pr_url": "https://github.com/line/armeria/pull/2850", "timeline": [{"oid": "54b436dd914dbe8293e26abe9c8ef02ffc17c9d7", "url": "https://github.com/line/armeria/commit/54b436dd914dbe8293e26abe9c8ef02ffc17c9d7", "message": "Return the Host header value from `RequestHeaders.authority()` if `:authority` is null\nMotivation:\nCurrently, we translate `Host` header to `:authority` header when the protocol of a ruquest is HTTP/1.1.\nHowever, it's not an expected behavior and a user still wants to get the `Host` header.\nhttps://tools.ietf.org/html/rfc7540#section-8.1.3\n\nSo we should not translate header but just use the `Host` header value from `RequestHeaders.authority()`\nwhen `:authority` header value is null in order to provide a unified getter for the authority.\n\nModifications:\n- Return the `Host` header value from `RequestHeaders.authority()` when `:authority` header value is null.\n- Add `Host` header if HTTP/1.1 headers does not have.\n\nResult:\n- Close #2846\n- You can now get `Host` header from Armeria server if the request is made using HTTP/1.1", "committedDate": "2020-06-29T07:46:35Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjgzNDk5OA==", "url": "https://github.com/line/armeria/pull/2850#discussion_r446834998", "bodyText": "Could just call .remove() without .contains()", "author": "trustin", "createdAt": "2020-06-29T07:48:57Z", "path": "core/src/main/java/com/linecorp/armeria/client/DefaultClientRequestContext.java", "diffHunk": "@@ -269,9 +271,12 @@ private void autoFillSchemeAndAuthority() {\n         final RequestHeaders headers = req.headers();\n         final String authority = endpoint != null ? endpoint.authority() : \"UNKNOWN\";\n         if (headers.scheme() == null || !authority.equals(headers.authority())) {\n-            unsafeUpdateRequest(req.withHeaders(headers.toBuilder()\n-                                                       .authority(authority)\n-                                                       .scheme(sessionProtocol())));\n+            final RequestHeadersBuilder headersBuilder =\n+                    headers.toBuilder().authority(authority).scheme(sessionProtocol());\n+            if (headersBuilder.contains(HttpHeaderNames.HOST)) {\n+                headersBuilder.remove(HttpHeaderNames.HOST);\n+            }", "originalCommit": "54b436dd914dbe8293e26abe9c8ef02ffc17c9d7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjgzODExOQ==", "url": "https://github.com/line/armeria/pull/2850#discussion_r446838119", "bodyText": "Thanks fixed. \ud83d\ude09", "author": "minwoox", "createdAt": "2020-06-29T07:54:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjgzNDk5OA=="}], "type": "inlineReview"}, {"oid": "32f4ea6ac70396e04e8cdbb365aaf2445f39366b", "url": "https://github.com/line/armeria/commit/32f4ea6ac70396e04e8cdbb365aaf2445f39366b", "message": "Address the comment by @trustin", "committedDate": "2020-06-29T07:53:54Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njg0NDkyMQ==", "url": "https://github.com/line/armeria/pull/2850#discussion_r446844921", "bodyText": "TODO(minwoox)?", "author": "trustin", "createdAt": "2020-06-29T08:06:54Z", "path": "core/src/main/java/com/linecorp/armeria/internal/common/ArmeriaHttpUtil.java", "diffHunk": "@@ -676,6 +672,18 @@ public static void toArmeria(io.netty.handler.codec.http.HttpHeaders inHeaders,\n         }\n     }\n \n+    // Use Netty's validation logic once https://github.com/netty/netty/pull/10380 is merged.", "originalCommit": "32f4ea6ac70396e04e8cdbb365aaf2445f39366b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njg2MDcyNQ==", "url": "https://github.com/line/armeria/pull/2850#discussion_r446860725", "bodyText": "Fixed. \ud83d\ude09", "author": "minwoox", "createdAt": "2020-06-29T08:34:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njg0NDkyMQ=="}], "type": "inlineReview"}, {"oid": "7650fa95fbcca3bd646c9e61d9fd8e138a3f64ce", "url": "https://github.com/line/armeria/commit/7650fa95fbcca3bd646c9e61d9fd8e138a3f64ce", "message": "Add TODO", "committedDate": "2020-06-29T08:34:34Z", "type": "commit"}, {"oid": "dc46938b5957153c72335b4790dc7454f26ab37f", "url": "https://github.com/line/armeria/commit/dc46938b5957153c72335b4790dc7454f26ab37f", "message": "Merge branch 'master' into fix_authority", "committedDate": "2020-06-29T13:46:20Z", "type": "commit"}]}