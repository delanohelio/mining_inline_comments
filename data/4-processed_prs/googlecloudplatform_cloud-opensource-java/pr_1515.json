{"pr_number": 1515, "pr_title": "Gradle plugin release script with net.researchgate.release plugin", "pr_createdAt": "2020-07-06T18:04:21Z", "pr_url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/pull/1515", "timeline": [{"oid": "4d007bdd195657728dc467b9211bb1a70543638b", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/commit/4d007bdd195657728dc467b9211bb1a70543638b", "message": "prepare_release for the Gradle plugin", "committedDate": "2020-06-30T18:51:09Z", "type": "commit"}, {"oid": "7cb9f6f2500535bfedaaa3f11fd50cc329429f6a", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/commit/7cb9f6f2500535bfedaaa3f11fd50cc329429f6a", "message": "Applying to master", "committedDate": "2020-06-30T19:18:08Z", "type": "commit"}, {"oid": "a0d4a6733ef007c0b00c42c4365116515f599458", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/commit/a0d4a6733ef007c0b00c42c4365116515f599458", "message": "release script", "committedDate": "2020-06-30T19:24:12Z", "type": "commit"}, {"oid": "50ac0c906a49d3aa2b7a7a3341ca771351d3b09f", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/commit/50ac0c906a49d3aa2b7a7a3341ca771351d3b09f", "message": "release plugin with version", "committedDate": "2020-06-30T19:26:28Z", "type": "commit"}, {"oid": "c20848d146c458a630a8d9e238f874a4cacd513e", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/commit/c20848d146c458a630a8d9e238f874a4cacd513e", "message": "branch format", "committedDate": "2020-06-30T19:28:37Z", "type": "commit"}, {"oid": "5547174a70feb5a759b6f35ce1312b77df061e63", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/commit/5547174a70feb5a759b6f35ce1312b77df061e63", "message": "unversioned files", "committedDate": "2020-06-30T19:29:55Z", "type": "commit"}, {"oid": "ffdcb0d48d7d305c56f6b2ca092229b3ac107f22", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/commit/ffdcb0d48d7d305c56f6b2ca092229b3ac107f22", "message": "publish plugin not just for SNAPSHOT", "committedDate": "2020-07-06T14:35:01Z", "type": "commit"}, {"oid": "a691b922eafb09013f96b144a95bed568460ee89", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/commit/a691b922eafb09013f96b144a95bed568460ee89", "message": "Next snapshot for Gradle", "committedDate": "2020-07-06T14:48:44Z", "type": "commit"}, {"oid": "44c22f2896c92295ee3402f00b24001de4fe5471", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/commit/44c22f2896c92295ee3402f00b24001de4fe5471", "message": "gradle build when releasing", "committedDate": "2020-07-06T15:07:24Z", "type": "commit"}, {"oid": "aeccb9dddd0e07312349f243057aede1a45c4048", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/commit/aeccb9dddd0e07312349f243057aede1a45c4048", "message": "Adjust error output the same as jibt", "committedDate": "2020-07-06T17:38:14Z", "type": "commit"}, {"oid": "341ce52b84e8cf73fe3cf82711bfb54f0f4c3d0a", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/commit/341ce52b84e8cf73fe3cf82711bfb54f0f4c3d0a", "message": "Split build and publish for troubleshooting", "committedDate": "2020-07-06T17:39:01Z", "type": "commit"}, {"oid": "5cf1a7f4b8cecda26d73ae2ae7bc73edca681f92", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/commit/5cf1a7f4b8cecda26d73ae2ae7bc73edca681f92", "message": "publishToMavenLocal to avoid the error", "committedDate": "2020-07-06T17:44:42Z", "type": "commit"}, {"oid": "4bc5fe13bad64b2cf0df33aad3502ddf94d6e577", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/commit/4bc5fe13bad64b2cf0df33aad3502ddf94d6e577", "message": "Plugin ID com.google.cloud.tools.linkagechecker", "committedDate": "2020-07-06T17:54:57Z", "type": "commit"}, {"oid": "4fb52771699d47144332c5af589b203cc8236e27", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/commit/4fb52771699d47144332c5af589b203cc8236e27", "message": "Reverting debugging", "committedDate": "2020-07-06T18:09:59Z", "type": "commit"}, {"oid": "d12e7814b3e41bbde707c2bc5ed1e636fe5f7fbb", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/commit/d12e7814b3e41bbde707c2bc5ed1e636fe5f7fbb", "message": "Release does not publish local", "committedDate": "2020-07-06T18:11:03Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDM5MzE0Mw==", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/pull/1515#discussion_r450393143", "bodyText": "Jib also uses this plugin https://github.com/GoogleContainerTools/jib/blob/master/jib-gradle-plugin/build.gradle#L3", "author": "suztomo", "createdAt": "2020-07-06T18:04:54Z", "path": "gradle-plugin/build.gradle", "diffHunk": "@@ -18,6 +18,8 @@ plugins {\n   id 'com.gradle.plugin-publish' version \"0.12.0\"\n   id 'groovy'\n   id 'java-gradle-plugin'\n+  id 'maven-publish'\n+  id 'net.researchgate.release' version '2.8.1'", "originalCommit": "4bc5fe13bad64b2cf0df33aad3502ddf94d6e577", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDM5MzkxMw==", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/pull/1515#discussion_r450393913", "bodyText": "The plugin tags the version \"vX.Y.Z-gradle\"", "author": "suztomo", "createdAt": "2020-07-06T18:06:12Z", "path": "gradle-plugin/build.gradle", "diffHunk": "@@ -74,3 +65,12 @@ pluginBundle {\n   description = 'A plugin to detect Java diamond dependency conflicts'\n   tags = ['google', 'java', 'dependency','verification']\n }\n+\n+release {\n+  tagTemplate = 'v$version-gradle'", "originalCommit": "4bc5fe13bad64b2cf0df33aad3502ddf94d6e577", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDM5NDcxMw==", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/pull/1515#discussion_r450394713", "bodyText": "For \"bom\" and \"dependencies\", this script uses \"mvn versions\" to set version.\nFor \"gradle\", this script uses net.researchgate.release plugin.", "author": "suztomo", "createdAt": "2020-07-06T18:07:33Z", "path": "scripts/prepare_release.sh", "diffHunk": "@@ -65,27 +65,33 @@ git pull\n git checkout -b ${VERSION}-${SUFFIX}\n \n \n-if [[ \"${SUFFIX}\" = \"bom\" ]]; then\n-  cd boms/cloud-oss-bom\n-fi\n-\n-# Updates the pom.xml with the version to release.\n-mvn versions:set versions:commit -DnewVersion=${VERSION} -DgenerateBackupPoms=false\n-\n-# Tags a new commit for this release.\n-git commit -am \"preparing release ${VERSION}-${SUFFIX}\"\n-git tag v${VERSION}-${SUFFIX}\n-\n # Updates the pom.xml with the next snapshot version.\n # For example, when releasing 1.5.7, the next snapshot version would be 1.5.8-SNAPSHOT.\n NEXT_SNAPSHOT=${NEXT_VERSION}\n if [[ \"${NEXT_SNAPSHOT}\" != *-SNAPSHOT ]]; then\n   NEXT_SNAPSHOT=${NEXT_SNAPSHOT}-SNAPSHOT\n fi\n-mvn versions:set versions:commit -DnewVersion=${NEXT_SNAPSHOT} -DgenerateBackupPoms=false\n \n-# Commits this next snapshot version.\n-git commit -am \"${NEXT_SNAPSHOT}\"\n+if [[ \"${SUFFIX}\" = \"bom\" ]]; then\n+  cd boms/cloud-oss-bom\n+fi\n+\n+if [[ \"${SUFFIX}\" = \"gradle\" ]]; then\n+  cd gradle-plugin\n+  # Changes the version for release and creates the commits/tags.\n+  echo | ./gradlew release -Prelease.releaseVersion=${VERSION} \\\n+      -Prelease.newVersion=${NEXT_SNAPSHOT}\n+else\n+  # Updates the pom.xml with the version to release.\n+  mvn versions:set versions:commit -DnewVersion=${VERSION} -DgenerateBackupPoms=false\n+  # Tags a new commit for this release.\n+  git commit -am \"preparing release ${VERSION}-${SUFFIX}\"\n+  git tag v${VERSION}-${SUFFIX}\n+  mvn versions:set versions:commit -DnewVersion=${NEXT_SNAPSHOT} -DgenerateBackupPoms=false\n+\n+  # Commits this next snapshot version.\n+  git commit -am \"${NEXT_SNAPSHOT}\"\n+fi", "originalCommit": "4bc5fe13bad64b2cf0df33aad3502ddf94d6e577", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDM5ODE5Mg==", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/pull/1515#discussion_r450398192", "bodyText": "These \"mvn versions:set\" and \"git commit\" are moving to 10 lines below.", "author": "suztomo", "createdAt": "2020-07-06T18:14:39Z", "path": "scripts/prepare_release.sh", "diffHunk": "@@ -65,27 +65,33 @@ git pull\n git checkout -b ${VERSION}-${SUFFIX}\n \n \n-if [[ \"${SUFFIX}\" = \"bom\" ]]; then\n-  cd boms/cloud-oss-bom\n-fi\n-\n-# Updates the pom.xml with the version to release.\n-mvn versions:set versions:commit -DnewVersion=${VERSION} -DgenerateBackupPoms=false\n-\n-# Tags a new commit for this release.\n-git commit -am \"preparing release ${VERSION}-${SUFFIX}\"\n-git tag v${VERSION}-${SUFFIX}\n-\n # Updates the pom.xml with the next snapshot version.\n # For example, when releasing 1.5.7, the next snapshot version would be 1.5.8-SNAPSHOT.\n NEXT_SNAPSHOT=${NEXT_VERSION}\n if [[ \"${NEXT_SNAPSHOT}\" != *-SNAPSHOT ]]; then\n   NEXT_SNAPSHOT=${NEXT_SNAPSHOT}-SNAPSHOT\n fi\n-mvn versions:set versions:commit -DnewVersion=${NEXT_SNAPSHOT} -DgenerateBackupPoms=false\n \n-# Commits this next snapshot version.\n-git commit -am \"${NEXT_SNAPSHOT}\"", "originalCommit": "d12e7814b3e41bbde707c2bc5ed1e636fe5f7fbb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "885c30541631466a4b719873af96c15126547a59", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/commit/885c30541631466a4b719873af96c15126547a59", "message": "Comment", "committedDate": "2020-07-06T18:18:08Z", "type": "commit"}, {"oid": "ea764daa12072aa4872aac669b7c83abe12ff9d0", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/commit/ea764daa12072aa4872aac669b7c83abe12ff9d0", "message": "Not using BOM", "committedDate": "2020-07-06T18:25:58Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDQwNTUwMw==", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/pull/1515#discussion_r450405503", "bodyText": "The official \"publish\" plugin does not seem to support BOM (platform) when it generates pom.xml :(\nHardcoding the version from https://search.maven.org/artifact/com.google.cloud.tools/dependencies-parent/1.4.3/pom for now. #1516 to followup.", "author": "suztomo", "createdAt": "2020-07-06T18:29:05Z", "path": "gradle-plugin/build.gradle", "diffHunk": "@@ -27,10 +28,9 @@ group = 'com.google.cloud.tools'\n sourceCompatibility = 1.8\n \n dependencies {\n-  implementation platform('com.google.cloud.tools:dependencies-parent:1.4.3')\n   implementation 'com.google.cloud.tools:dependencies:1.4.3'\n-  implementation 'com.google.guava:guava'\n-  implementation 'org.apache.maven.resolver:maven-resolver-api'\n+  implementation 'com.google.guava:guava:29.0-jre'\n+  implementation 'org.apache.maven.resolver:maven-resolver-api:1.4.2'", "originalCommit": "ea764daa12072aa4872aac669b7c83abe12ff9d0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}