{"pr_number": 1521, "pr_title": "Enable building classpath without optional dependencies", "pr_createdAt": "2020-07-08T15:20:10Z", "pr_url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/pull/1521", "timeline": [{"oid": "e73cac0d23a682865d3ad88a570e6786099af7e1", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/commit/e73cac0d23a682865d3ad88a570e6786099af7e1", "message": "some optimizations", "committedDate": "2020-07-08T15:18:08Z", "type": "commit"}, {"oid": "28fb6bc6ca4fd51efb6e699a7ba9bc6ea9e55237", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/commit/28fb6bc6ca4fd51efb6e699a7ba9bc6ea9e55237", "message": "reproduce OutOfMemoryError", "committedDate": "2020-07-08T15:22:43Z", "type": "commit"}, {"oid": "fbecbdfcfaf6d811816f4e409954615e67608c39", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/commit/fbecbdfcfaf6d811816f4e409954615e67608c39", "message": "use smaller artifact", "committedDate": "2020-07-08T17:13:23Z", "type": "commit"}, {"oid": "b58e184dac1671280745f5929074211ab28c2b5d", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/commit/b58e184dac1671280745f5929074211ab28c2b5d", "message": "catalog", "committedDate": "2020-07-08T17:15:02Z", "type": "commit"}, {"oid": "2e41c924faac59a6f4d18dc6f581524d62f7798b", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/commit/2e41c924faac59a6f4d18dc6f581524d62f7798b", "message": "copyright", "committedDate": "2020-07-08T17:15:23Z", "type": "commit"}, {"oid": "2aa3643c9ecbed849496885ee5f993c9c7a9c4c7", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/commit/2aa3643c9ecbed849496885ee5f993c9c7a9c4c7", "message": "Merge branch 'memorytest' into opt2", "committedDate": "2020-07-08T17:17:12Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTcxNjk2OQ==", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/pull/1521#discussion_r451716969", "bodyText": "Good to know intern().", "author": "suztomo", "createdAt": "2020-07-08T17:39:59Z", "path": "dependencies/src/main/java/com/google/cloud/tools/opensource/dependencies/Artifacts.java", "diffHunk": "@@ -31,11 +31,12 @@ private Artifacts() {\n    * packaging are not included.\n    */\n   public static String toCoordinates(Artifact artifact) {\n-    return artifact.getGroupId() + \":\" + artifact.getArtifactId() + \":\" + artifact.getVersion();\n+    return (artifact.getGroupId() + \":\" + artifact.getArtifactId() + \":\" + artifact.getVersion())\n+        .intern();", "originalCommit": "e73cac0d23a682865d3ad88a570e6786099af7e1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "dc7238f1146e456c863c2a36e59f54dd03312317", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/commit/dc7238f1146e456c863c2a36e59f54dd03312317", "message": "try not interning", "committedDate": "2020-07-09T13:59:43Z", "type": "commit"}, {"oid": "3a96608da0c669e4abac413d2db270b2d7509940", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/commit/3a96608da0c669e4abac413d2db270b2d7509940", "message": "enable building classpaths without optional dependencies", "committedDate": "2020-07-09T15:08:11Z", "type": "commit"}, {"oid": "cdcd3cd00b131acc50e18296e7441a027f9dca41", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/commit/cdcd3cd00b131acc50e18296e7441a027f9dca41", "message": "revert unhelpful optimization", "committedDate": "2020-07-09T15:10:41Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjM2Njg3Mw==", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/pull/1521#discussion_r452366873", "bodyText": "remove this comment", "author": "suztomo", "createdAt": "2020-07-09T17:09:38Z", "path": "dependencies/src/main/java/com/google/cloud/tools/opensource/classpath/ClassPathBuilder.java", "diffHunk": "@@ -54,15 +54,22 @@ public ClassPathBuilder(DependencyGraphBuilder dependencyGraphBuilder) {\n    * closest\" strategy follows Maven's dependency mediation.\n    *\n    * @param artifacts the first artifacts that appear in the classpath, in order\n+   * @param full if true all optional dependencies and their transitive dependencies are\n+   *     included. If false, optional dependencies are not included.\n    */\n-  public ClassPathResult resolve(List<Artifact> artifacts) {\n-\n+  public ClassPathResult resolve(List<Artifact> artifacts, boolean full) {\n     LinkedListMultimap<ClassPathEntry, DependencyPath> multimap = LinkedListMultimap.create();\n     if (artifacts.isEmpty()) {\n       return new ClassPathResult(multimap, ImmutableList.of());\n     }\n     // dependencyGraph holds multiple versions for one artifact key (groupId:artifactId)\n-    DependencyGraph result = dependencyGraphBuilder.buildFullDependencyGraph(artifacts);\n+    //DependencyGraph result = dependencyGraphBuilder.buildFullDependencyGraph(artifacts);", "originalCommit": "cdcd3cd00b131acc50e18296e7441a027f9dca41", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjM4NzU4Nw==", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/pull/1521#discussion_r452387587", "bodyText": "done", "author": "elharo", "createdAt": "2020-07-09T17:46:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjM2Njg3Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjM2OTA3OA==", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/pull/1521#discussion_r452369078", "bodyText": "Do you still need this test?", "author": "suztomo", "createdAt": "2020-07-09T17:13:22Z", "path": "dependencies/src/test/java/com/google/cloud/tools/opensource/classpath/MemoryUsageTest.java", "diffHunk": "@@ -0,0 +1,77 @@\n+/*\n+ * Copyright 2020 Google LLC.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.google.cloud.tools.opensource.classpath;\n+\n+import static org.junit.Assert.assertNotNull;\n+import static org.junit.Assert.fail;\n+\n+import com.google.common.collect.ImmutableList;\n+import org.eclipse.aether.artifact.Artifact;\n+import org.eclipse.aether.artifact.DefaultArtifact;\n+import org.junit.Before;\n+import org.junit.Test;\n+\n+public class MemoryUsageTest {", "originalCommit": "cdcd3cd00b131acc50e18296e7441a027f9dca41", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjM4ODQ5OQ==", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/pull/1521#discussion_r452388499", "bodyText": "I'm not sure. What do you think? I think we need something like this, though perhaps I should cut pieces of it, or move it to a manual test. Then again, it would be nice to notice if we do something that increases the size past what Java can handle.", "author": "elharo", "createdAt": "2020-07-09T17:48:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjM2OTA3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjQ0MjUxOQ==", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/pull/1521#discussion_r452442519", "bodyText": "I think we need just one test in ClassPathBuilder to ensure that ClassPathBuildet can resolve the class path of the hcatalog artifact.\nI don\u2019t think we need assertions on JVM heap size or the debug output.", "author": "suztomo", "createdAt": "2020-07-09T19:30:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjM2OTA3OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjM2OTQ5Mw==", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/pull/1521#discussion_r452369493", "bodyText": "The check complains about this function.\n[ERROR] /Volumes/BuildData/tmpfs/src/github/cloud-opensource-java/dependencies/src/test/java/com/google/cloud/tools/opensource/classpath/MemoryUsageTest.java:[57,14] error: [JUnit4TestNotRun] This looks like a test method but is not run; please add @Test and @Ignore, or, if this is a helper method, reduce its visibility.\n    (see https://errorprone.info/bugpattern/JUnit4TestNotRun)\n  Did you mean '@Test public void testBeamZetaSqlOutOfMemoryError() {' or '@Test @Ignore public void testBeamZetaSqlOutOfMemoryError() {' or 'private void testBeamZetaSqlOutOfMemoryError() {'?", "author": "suztomo", "createdAt": "2020-07-09T17:14:07Z", "path": "dependencies/src/test/java/com/google/cloud/tools/opensource/classpath/MemoryUsageTest.java", "diffHunk": "@@ -0,0 +1,77 @@\n+/*\n+ * Copyright 2020 Google LLC.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.google.cloud.tools.opensource.classpath;\n+\n+import static org.junit.Assert.assertNotNull;\n+import static org.junit.Assert.fail;\n+\n+import com.google.common.collect.ImmutableList;\n+import org.eclipse.aether.artifact.Artifact;\n+import org.eclipse.aether.artifact.DefaultArtifact;\n+import org.junit.Before;\n+import org.junit.Test;\n+\n+public class MemoryUsageTest {\n+  private ClassPathBuilder classPathBuilder = new ClassPathBuilder();\n+  \n+  @Before\n+  public void setUp() {\n+    System.gc();\n+  }\n+  \n+  @Test\n+  public void testBeamCatalogOutOfMemoryError() {\n+    long before = Runtime.getRuntime().totalMemory() - Runtime.getRuntime().freeMemory();\n+    String coords = \"org.apache.beam:beam-sdks-java-io-hcatalog:2.19.0\";\n+    \n+    Artifact catalog = new DefaultArtifact(coords);\n+    try {\n+      ClassPathResult result = classPathBuilder.resolve(ImmutableList.of(catalog), false);\n+      long after = Runtime.getRuntime().totalMemory() - Runtime.getRuntime().freeMemory();\n+      double mb = (after - before) / (1024.0 * 1024.0);\n+      System.err.println(\"Memory used: \" + mb + \"MB\");      \n+      \n+      assertNotNull(result);\n+    } catch (OutOfMemoryError failure) {\n+      failure.printStackTrace();\n+      fail(\"Ran out of memory\");\n+    } finally {\n+      System.gc();      \n+    }\n+  }\n+  \n+  public void testBeamZetaSqlOutOfMemoryError() {    ", "originalCommit": "cdcd3cd00b131acc50e18296e7441a027f9dca41", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjM4ODU2MA==", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/pull/1521#discussion_r452388560", "bodyText": "fixed", "author": "elharo", "createdAt": "2020-07-09T17:48:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjM2OTQ5Mw=="}], "type": "inlineReview"}, {"oid": "bb24d2bb2a9f6a395aab88669238ad91d356676b", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/commit/bb24d2bb2a9f6a395aab88669238ad91d356676b", "message": "add @Test", "committedDate": "2020-07-09T17:25:40Z", "type": "commit"}, {"oid": "bf27e44c065b3a3a4f18fc0e79ede83c4d271bbc", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/commit/bf27e44c065b3a3a4f18fc0e79ede83c4d271bbc", "message": "remove commented code", "committedDate": "2020-07-09T17:48:41Z", "type": "commit"}, {"oid": "69d43998f638005939aa45561d37d2aa9091caf5", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/commit/69d43998f638005939aa45561d37d2aa9091caf5", "message": "one test", "committedDate": "2020-07-09T20:49:55Z", "type": "commit"}, {"oid": "48721154154d9e34e6cb4591a55f74c286bb1871", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/commit/48721154154d9e34e6cb4591a55f74c286bb1871", "message": "unstick cla", "committedDate": "2020-07-10T17:38:32Z", "type": "commit"}]}