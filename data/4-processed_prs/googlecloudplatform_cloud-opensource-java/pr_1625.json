{"pr_number": 1625, "pr_title": "Java8IncompatibleReferenceCheck", "pr_createdAt": "2020-08-27T21:15:23Z", "pr_url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/pull/1625", "timeline": [{"oid": "6f59f365ffe8e1cfa84e026e600fa5b21ee2e5c1", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/commit/6f59f365ffe8e1cfa84e026e600fa5b21ee2e5c1", "message": "BadJdkReferenceChecker", "committedDate": "2020-08-27T21:13:28Z", "type": "commit"}, {"oid": "74d9a77b62cbe3c1c8916ea334ce3d9c3363648a", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/commit/74d9a77b62cbe3c1c8916ea334ce3d9c3363648a", "message": "Setting up profile to execute BadJdkReferenceChecker", "committedDate": "2020-08-27T21:54:00Z", "type": "commit"}, {"oid": "5032e8705e7b8f09211ebc73a43410ddd80f4896", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/commit/5032e8705e7b8f09211ebc73a43410ddd80f4896", "message": "exit value", "committedDate": "2020-08-27T22:04:26Z", "type": "commit"}, {"oid": "78ab0c090c2d3628c7232a6f30d3ac44f923a3fb", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/commit/78ab0c090c2d3628c7232a6f30d3ac44f923a3fb", "message": "message", "committedDate": "2020-08-27T22:13:01Z", "type": "commit"}, {"oid": "45849dba1af894dc206bcd1c3f71dddc8fe603b4", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/commit/45849dba1af894dc206bcd1c3f71dddc8fe603b4", "message": "Appengine problems as xml file", "committedDate": "2020-08-28T18:05:09Z", "type": "commit"}, {"oid": "9d07c0ab9f23084e5c99411a6bcbd27afd37ab9c", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/commit/9d07c0ab9f23084e5c99411a6bcbd27afd37ab9c", "message": "Merge branch 'master' into bad_jdk_references_check", "committedDate": "2020-09-01T17:24:08Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTMxNzIwOQ==", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/pull/1625#discussion_r481317209", "bodyText": "we need a better name for this. What's a \"bad JDK\"?", "author": "elharo", "createdAt": "2020-09-01T17:36:00Z", "path": "dependencies/src/main/java/com/google/cloud/tools/opensource/dependencies/BadJdkReferenceChecker.java", "diffHunk": "@@ -0,0 +1,125 @@\n+/*\n+ * Copyright 2020 Google LLC.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.google.cloud.tools.opensource.dependencies;\n+\n+import static com.google.common.collect.ImmutableSet.toImmutableSet;\n+\n+import com.google.cloud.tools.opensource.classpath.ClassFile;\n+import com.google.cloud.tools.opensource.classpath.ClassPathBuilder;\n+import com.google.cloud.tools.opensource.classpath.ClassPathEntry;\n+import com.google.cloud.tools.opensource.classpath.ClassPathResult;\n+import com.google.cloud.tools.opensource.classpath.LinkageChecker;\n+import com.google.cloud.tools.opensource.classpath.LinkageProblem;\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.collect.ImmutableSet;\n+import com.google.common.collect.ImmutableSetMultimap;\n+import java.io.IOException;\n+import java.net.URI;\n+import java.net.URISyntaxException;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.util.logging.Logger;\n+import org.eclipse.aether.artifact.Artifact;\n+\n+public class BadJdkReferenceChecker {", "originalCommit": "9d07c0ab9f23084e5c99411a6bcbd27afd37ab9c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjM3MTg1MQ==", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/pull/1625#discussion_r482371851", "bodyText": "Updated to Java8IncompatibleReferenceCheck.", "author": "suztomo", "createdAt": "2020-09-02T19:53:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTMxNzIwOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTMxNzQ1MA==", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/pull/1625#discussion_r481317450", "bodyText": "per google style do not use \"Please\" in UI messages", "author": "elharo", "createdAt": "2020-09-01T17:36:26Z", "path": "dependencies/src/main/java/com/google/cloud/tools/opensource/dependencies/BadJdkReferenceChecker.java", "diffHunk": "@@ -0,0 +1,125 @@\n+/*\n+ * Copyright 2020 Google LLC.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.google.cloud.tools.opensource.dependencies;\n+\n+import static com.google.common.collect.ImmutableSet.toImmutableSet;\n+\n+import com.google.cloud.tools.opensource.classpath.ClassFile;\n+import com.google.cloud.tools.opensource.classpath.ClassPathBuilder;\n+import com.google.cloud.tools.opensource.classpath.ClassPathEntry;\n+import com.google.cloud.tools.opensource.classpath.ClassPathResult;\n+import com.google.cloud.tools.opensource.classpath.LinkageChecker;\n+import com.google.cloud.tools.opensource.classpath.LinkageProblem;\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.collect.ImmutableSet;\n+import com.google.common.collect.ImmutableSetMultimap;\n+import java.io.IOException;\n+import java.net.URI;\n+import java.net.URISyntaxException;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.util.logging.Logger;\n+import org.eclipse.aether.artifact.Artifact;\n+\n+public class BadJdkReferenceChecker {\n+\n+  private static final Logger logger = Logger.getLogger(BadJdkReferenceChecker.class.getName());\n+\n+  public static void main(String[] arguments)\n+      throws MavenRepositoryException, IOException, URISyntaxException {\n+\n+    if (arguments.length != 1) {\n+      System.err.println(\"Please specify a path to the BOM file\");", "originalCommit": "9d07c0ab9f23084e5c99411a6bcbd27afd37ab9c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjM3MTY4MA==", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/pull/1625#discussion_r482371680", "bodyText": "Removed.", "author": "suztomo", "createdAt": "2020-09-02T19:53:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTMxNzQ1MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTMxNzc3OQ==", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/pull/1625#discussion_r481317779", "bodyText": "does --> do", "author": "elharo", "createdAt": "2020-09-01T17:37:04Z", "path": "dependencies/src/main/java/com/google/cloud/tools/opensource/dependencies/BadJdkReferenceChecker.java", "diffHunk": "@@ -0,0 +1,125 @@\n+/*\n+ * Copyright 2020 Google LLC.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.google.cloud.tools.opensource.dependencies;\n+\n+import static com.google.common.collect.ImmutableSet.toImmutableSet;\n+\n+import com.google.cloud.tools.opensource.classpath.ClassFile;\n+import com.google.cloud.tools.opensource.classpath.ClassPathBuilder;\n+import com.google.cloud.tools.opensource.classpath.ClassPathEntry;\n+import com.google.cloud.tools.opensource.classpath.ClassPathResult;\n+import com.google.cloud.tools.opensource.classpath.LinkageChecker;\n+import com.google.cloud.tools.opensource.classpath.LinkageProblem;\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.collect.ImmutableSet;\n+import com.google.common.collect.ImmutableSetMultimap;\n+import java.io.IOException;\n+import java.net.URI;\n+import java.net.URISyntaxException;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.util.logging.Logger;\n+import org.eclipse.aether.artifact.Artifact;\n+\n+public class BadJdkReferenceChecker {\n+\n+  private static final Logger logger = Logger.getLogger(BadJdkReferenceChecker.class.getName());\n+\n+  public static void main(String[] arguments)\n+      throws MavenRepositoryException, IOException, URISyntaxException {\n+\n+    if (arguments.length != 1) {\n+      System.err.println(\"Please specify a path to the BOM file\");\n+      System.exit(1);\n+    }\n+\n+    URI exclusionFileUri =\n+        BadJdkReferenceChecker.class\n+            .getClassLoader()\n+            .getResource(\"bad-jdk-reference-check-exclusion.xml\")\n+            .toURI();\n+    Path exclusionFile = Paths.get(exclusionFileUri).toAbsolutePath();\n+\n+    String bomFileName = arguments[0];\n+\n+    Path bomFile = Paths.get(bomFileName);\n+    Bom bom = Bom.readBom(bomFile);\n+\n+    ImmutableList<Artifact> managedDependencies = bom.getManagedDependencies();\n+\n+    int count = 1;\n+\n+    ImmutableSetMultimap.Builder<Artifact, Artifact> badDependencies =\n+        ImmutableSetMultimap.builder();\n+    for (Artifact managedDependency : managedDependencies) {\n+      logger.info(\n+          \"Checking \"\n+              + managedDependency\n+              + \" (\"\n+              + (count++)\n+              + \"/\"\n+              + managedDependencies.size()\n+              + \")\");\n+\n+      ClassPathBuilder classPathBuilder = new ClassPathBuilder();\n+      ClassPathResult result = classPathBuilder.resolve(ImmutableList.of(managedDependency), false);\n+\n+      LinkageChecker linkageChecker =\n+          LinkageChecker.create(result.getClassPath(), result.getClassPath(), exclusionFile);\n+\n+      ImmutableSet<LinkageProblem> linkageProblems = linkageChecker.findLinkageProblems();\n+\n+      ImmutableSet<LinkageProblem> badJdkReferences =\n+          linkageProblems.stream()\n+              .filter(problem -> problem.getSymbol().getClassBinaryName().startsWith(\"java.\"))\n+              .collect(toImmutableSet());\n+\n+      if (!badJdkReferences.isEmpty()) {\n+        badJdkReferences.stream()\n+            .map(LinkageProblem::getSourceClass)\n+            .map(ClassFile::getClassPathEntry)\n+            .map(ClassPathEntry::getArtifact)\n+            .forEach(artifact -> badDependencies.put(managedDependency, artifact));\n+\n+        logger.severe(LinkageProblem.formatLinkageProblems(badJdkReferences));\n+      }\n+    }\n+\n+    ImmutableSetMultimap<Artifact, Artifact> bomMemberToBadDependencies = badDependencies.build();\n+\n+    if (bomMemberToBadDependencies.isEmpty()) {\n+      logger.info(\"No problematic artifacts\");\n+      return;\n+    }\n+\n+    StringBuilder message = new StringBuilder();\n+    message.append(\n+        \"The following artifacts contain bad references to classes in 'java' package,\"\n+            + \" which does not work for Java 8\\n\");", "originalCommit": "9d07c0ab9f23084e5c99411a6bcbd27afd37ab9c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjM3MjIwOQ==", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/pull/1625#discussion_r482372209", "bodyText": "Fixed.", "author": "suztomo", "createdAt": "2020-09-02T19:53:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTMxNzc3OQ=="}], "type": "inlineReview"}, {"oid": "66789ae3169c745496dc850294dc5216ff64cad1", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/commit/66789ae3169c745496dc850294dc5216ff64cad1", "message": "Merge branch 'master' into bad_jdk_references_check", "committedDate": "2020-09-01T19:14:12Z", "type": "commit"}, {"oid": "5172cfe94decebb77a077f7c1efd4e47cb63b715", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/commit/5172cfe94decebb77a077f7c1efd4e47cb63b715", "message": "Applied review.", "committedDate": "2020-09-02T19:53:54Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjM3NjQ4Mg==", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/pull/1625#discussion_r482376482", "bodyText": "JavaDoc would help clarify this.", "author": "elharo", "createdAt": "2020-09-02T19:56:34Z", "path": "dependencies/src/main/java/com/google/cloud/tools/opensource/dependencies/Java8IncompatibleReferenceCheck.java", "diffHunk": "@@ -35,20 +35,20 @@\n import java.util.logging.Logger;\n import org.eclipse.aether.artifact.Artifact;\n \n-public class BadJdkReferenceChecker {\n+public class Java8IncompatibleReferenceCheck {", "originalCommit": "5172cfe94decebb77a077f7c1efd4e47cb63b715", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjUwNjgyMg==", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/pull/1625#discussion_r482506822", "bodyText": "Added Javadoc. I'll prepare another document (wiki) to explain how to use this tool.", "author": "suztomo", "createdAt": "2020-09-02T21:48:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjM3NjQ4Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjM3ODY2Mw==", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/pull/1625#discussion_r482378663", "bodyText": "delete \"bad\"\nperhaps \"classes in 'java' package\" --> classes in the core library\nwhich do not work for --> which are not present in", "author": "elharo", "createdAt": "2020-09-02T19:58:09Z", "path": "dependencies/src/main/java/com/google/cloud/tools/opensource/dependencies/Java8IncompatibleReferenceCheck.java", "diffHunk": "@@ -109,7 +109,7 @@ public static void main(String[] arguments)\n     StringBuilder message = new StringBuilder();\n     message.append(\n         \"The following artifacts contain bad references to classes in 'java' package,\"", "originalCommit": "5172cfe94decebb77a077f7c1efd4e47cb63b715", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjQ5MjcxNA==", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/pull/1625#discussion_r482492714", "bodyText": "Updated.", "author": "suztomo", "createdAt": "2020-09-02T21:31:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjM3ODY2Mw=="}], "type": "inlineReview"}, {"oid": "f2f99a4855a2e93feb2a055ffe91fbe462bce552", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/commit/f2f99a4855a2e93feb2a055ffe91fbe462bce552", "message": "Applied review", "committedDate": "2020-09-02T21:47:04Z", "type": "commit"}, {"oid": "129d0e69074f3a0fca388feee21f8d313c34e57b", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/commit/129d0e69074f3a0fca388feee21f8d313c34e57b", "message": "format", "committedDate": "2020-09-02T21:52:45Z", "type": "commit"}, {"oid": "5d778a567222ddc02a56e92ea2b6da43c91d662e", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/commit/5d778a567222ddc02a56e92ea2b6da43c91d662e", "message": "format", "committedDate": "2020-09-02T21:58:50Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzAwNDMyMA==", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/pull/1625#discussion_r483004320", "bodyText": "dependency graph of each of the artifacts above", "author": "elharo", "createdAt": "2020-09-03T14:05:30Z", "path": "dependencies/src/main/java/com/google/cloud/tools/opensource/dependencies/Java8IncompatibleReferenceCheck.java", "diffHunk": "@@ -0,0 +1,145 @@\n+/*\n+ * Copyright 2020 Google LLC.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.google.cloud.tools.opensource.dependencies;\n+\n+import static com.google.common.collect.ImmutableSet.toImmutableSet;\n+\n+import com.google.cloud.tools.opensource.classpath.ClassFile;\n+import com.google.cloud.tools.opensource.classpath.ClassPathBuilder;\n+import com.google.cloud.tools.opensource.classpath.ClassPathEntry;\n+import com.google.cloud.tools.opensource.classpath.ClassPathResult;\n+import com.google.cloud.tools.opensource.classpath.LinkageChecker;\n+import com.google.cloud.tools.opensource.classpath.LinkageProblem;\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.collect.ImmutableSet;\n+import com.google.common.collect.ImmutableSetMultimap;\n+import java.io.IOException;\n+import java.net.URI;\n+import java.net.URISyntaxException;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.util.logging.Logger;\n+import org.eclipse.aether.artifact.Artifact;\n+\n+/**\n+ * A tool to find Java 8-incompatible references in the class files in a BOM. It checks the class\n+ * files in the following artifacts:\n+ *\n+ * <ul>\n+ *   <li>The artifacts in the {@code dependencyManagement} section of the BOM\n+ *   <li>The artifacts in the dependency graph for each of the artifact above", "originalCommit": "5d778a567222ddc02a56e92ea2b6da43c91d662e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzAyNzI5MQ==", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/pull/1625#discussion_r483027291", "bodyText": "Fixed.", "author": "suztomo", "createdAt": "2020-09-03T14:35:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzAwNDMyMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzAwNDU0NA==", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/pull/1625#discussion_r483004544", "bodyText": "no comma after library", "author": "elharo", "createdAt": "2020-09-03T14:05:47Z", "path": "dependencies/src/main/java/com/google/cloud/tools/opensource/dependencies/Java8IncompatibleReferenceCheck.java", "diffHunk": "@@ -0,0 +1,145 @@\n+/*\n+ * Copyright 2020 Google LLC.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.google.cloud.tools.opensource.dependencies;\n+\n+import static com.google.common.collect.ImmutableSet.toImmutableSet;\n+\n+import com.google.cloud.tools.opensource.classpath.ClassFile;\n+import com.google.cloud.tools.opensource.classpath.ClassPathBuilder;\n+import com.google.cloud.tools.opensource.classpath.ClassPathEntry;\n+import com.google.cloud.tools.opensource.classpath.ClassPathResult;\n+import com.google.cloud.tools.opensource.classpath.LinkageChecker;\n+import com.google.cloud.tools.opensource.classpath.LinkageProblem;\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.collect.ImmutableSet;\n+import com.google.common.collect.ImmutableSetMultimap;\n+import java.io.IOException;\n+import java.net.URI;\n+import java.net.URISyntaxException;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.util.logging.Logger;\n+import org.eclipse.aether.artifact.Artifact;\n+\n+/**\n+ * A tool to find Java 8-incompatible references in the class files in a BOM. It checks the class\n+ * files in the following artifacts:\n+ *\n+ * <ul>\n+ *   <li>The artifacts in the {@code dependencyManagement} section of the BOM\n+ *   <li>The artifacts in the dependency graph for each of the artifact above\n+ *   <li>The latest version of the artifacts in the dependency graphs\n+ * </ul>\n+ *\n+ * <p>If it finds references to classes in the core library, which are not present in Java 8, it", "originalCommit": "5d778a567222ddc02a56e92ea2b6da43c91d662e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzAyODYzMQ==", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/pull/1625#discussion_r483028631", "bodyText": "Fixed.", "author": "suztomo", "createdAt": "2020-09-03T14:36:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzAwNDU0NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzAwNTg0OQ==", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/pull/1625#discussion_r483005849", "bodyText": "I'm surprised this works since it's a resource in a jar, not a file. Could we skip both URIs and paths here and get a stream from the resource instead?", "author": "elharo", "createdAt": "2020-09-03T14:07:39Z", "path": "dependencies/src/main/java/com/google/cloud/tools/opensource/dependencies/Java8IncompatibleReferenceCheck.java", "diffHunk": "@@ -0,0 +1,145 @@\n+/*\n+ * Copyright 2020 Google LLC.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.google.cloud.tools.opensource.dependencies;\n+\n+import static com.google.common.collect.ImmutableSet.toImmutableSet;\n+\n+import com.google.cloud.tools.opensource.classpath.ClassFile;\n+import com.google.cloud.tools.opensource.classpath.ClassPathBuilder;\n+import com.google.cloud.tools.opensource.classpath.ClassPathEntry;\n+import com.google.cloud.tools.opensource.classpath.ClassPathResult;\n+import com.google.cloud.tools.opensource.classpath.LinkageChecker;\n+import com.google.cloud.tools.opensource.classpath.LinkageProblem;\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.collect.ImmutableSet;\n+import com.google.common.collect.ImmutableSetMultimap;\n+import java.io.IOException;\n+import java.net.URI;\n+import java.net.URISyntaxException;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.util.logging.Logger;\n+import org.eclipse.aether.artifact.Artifact;\n+\n+/**\n+ * A tool to find Java 8-incompatible references in the class files in a BOM. It checks the class\n+ * files in the following artifacts:\n+ *\n+ * <ul>\n+ *   <li>The artifacts in the {@code dependencyManagement} section of the BOM\n+ *   <li>The artifacts in the dependency graph for each of the artifact above\n+ *   <li>The latest version of the artifacts in the dependency graphs\n+ * </ul>\n+ *\n+ * <p>If it finds references to classes in the core library, which are not present in Java 8, it\n+ * exits with status code 1; otherwise it exits with status code 0.\n+ *\n+ * @see <a\n+ *     href=\"https://github.com/GoogleCloudPlatform/cloud-opensource-java/wiki/Java-8-incompatible-references-of-java.nio.Buffer-classes-generated-by-Java-9--compilers\"\n+ *     >Java 8 incompatible references of java.nio.Buffer classes generated by Java 9 compilers</a>\n+ */\n+public class Java8IncompatibleReferenceCheck {\n+\n+  private static final Logger logger =\n+      Logger.getLogger(Java8IncompatibleReferenceCheck.class.getName());\n+\n+  public static void main(String[] arguments)\n+      throws MavenRepositoryException, IOException, URISyntaxException {\n+\n+    if (arguments.length != 1) {\n+      System.err.println(\"Specify a path to the BOM file\");\n+      System.exit(1);\n+    }\n+\n+    URI exclusionFileUri =\n+        Java8IncompatibleReferenceCheck.class\n+            .getClassLoader()\n+            .getResource(\"java8-incompatible-reference-check-exclusion.xml\")\n+            .toURI();\n+    Path exclusionFile = Paths.get(exclusionFileUri).toAbsolutePath();", "originalCommit": "5d778a567222ddc02a56e92ea2b6da43c91d662e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzAzMjY5NA==", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/pull/1625#discussion_r483032694", "bodyText": "This works because it reads the XML file from target directory. With maven-exec-plugin (used by java8-incompatible-reference-check.sh), the value (toString) of exclusionFile is Users/suztomo/cloud-opensource-java/dependencies/target/classes/java8-incompatible-reference-check-exclusion.xml, not from a JAR file.\nLinkageChecker.create() takes Path for an exclusion file.", "author": "suztomo", "createdAt": "2020-09-03T14:42:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzAwNTg0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzA2OTAyNQ==", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/pull/1625#discussion_r483069025", "bodyText": "I'll trust you that it works, but this still looks very brittle to me. Can we add a method to LinkageChecker that takes an InputStream to avoid this.", "author": "elharo", "createdAt": "2020-09-03T15:31:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzAwNTg0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzEwODEwMw==", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/pull/1625#discussion_r483108103", "bodyText": "I tried adding another factory method for LinkageChecker to take URL (not InputStream, because ExcludedErrors already takes URL) but the change is unexpectedly large 01b6dc4\nI will just use Path for the exclusion xml as second parameter, without URL or InputStream.", "author": "suztomo", "createdAt": "2020-09-03T16:30:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzAwNTg0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzEzODI5OA==", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/pull/1625#discussion_r483138298", "bodyText": "Now the exclusion file is passed as the second parameter. No need to deal with URL.", "author": "suztomo", "createdAt": "2020-09-03T17:21:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzAwNTg0OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzAwNzg3NQ==", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/pull/1625#discussion_r483007875", "bodyText": "This is what would contain the return type change?", "author": "elharo", "createdAt": "2020-09-03T14:10:29Z", "path": "dependencies/src/main/java/com/google/cloud/tools/opensource/dependencies/Java8IncompatibleReferenceCheck.java", "diffHunk": "@@ -0,0 +1,145 @@\n+/*\n+ * Copyright 2020 Google LLC.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.google.cloud.tools.opensource.dependencies;\n+\n+import static com.google.common.collect.ImmutableSet.toImmutableSet;\n+\n+import com.google.cloud.tools.opensource.classpath.ClassFile;\n+import com.google.cloud.tools.opensource.classpath.ClassPathBuilder;\n+import com.google.cloud.tools.opensource.classpath.ClassPathEntry;\n+import com.google.cloud.tools.opensource.classpath.ClassPathResult;\n+import com.google.cloud.tools.opensource.classpath.LinkageChecker;\n+import com.google.cloud.tools.opensource.classpath.LinkageProblem;\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.collect.ImmutableSet;\n+import com.google.common.collect.ImmutableSetMultimap;\n+import java.io.IOException;\n+import java.net.URI;\n+import java.net.URISyntaxException;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.util.logging.Logger;\n+import org.eclipse.aether.artifact.Artifact;\n+\n+/**\n+ * A tool to find Java 8-incompatible references in the class files in a BOM. It checks the class\n+ * files in the following artifacts:\n+ *\n+ * <ul>\n+ *   <li>The artifacts in the {@code dependencyManagement} section of the BOM\n+ *   <li>The artifacts in the dependency graph for each of the artifact above\n+ *   <li>The latest version of the artifacts in the dependency graphs\n+ * </ul>\n+ *\n+ * <p>If it finds references to classes in the core library, which are not present in Java 8, it\n+ * exits with status code 1; otherwise it exits with status code 0.\n+ *\n+ * @see <a\n+ *     href=\"https://github.com/GoogleCloudPlatform/cloud-opensource-java/wiki/Java-8-incompatible-references-of-java.nio.Buffer-classes-generated-by-Java-9--compilers\"\n+ *     >Java 8 incompatible references of java.nio.Buffer classes generated by Java 9 compilers</a>\n+ */\n+public class Java8IncompatibleReferenceCheck {\n+\n+  private static final Logger logger =\n+      Logger.getLogger(Java8IncompatibleReferenceCheck.class.getName());\n+\n+  public static void main(String[] arguments)\n+      throws MavenRepositoryException, IOException, URISyntaxException {\n+\n+    if (arguments.length != 1) {\n+      System.err.println(\"Specify a path to the BOM file\");\n+      System.exit(1);\n+    }\n+\n+    URI exclusionFileUri =\n+        Java8IncompatibleReferenceCheck.class\n+            .getClassLoader()\n+            .getResource(\"java8-incompatible-reference-check-exclusion.xml\")\n+            .toURI();\n+    Path exclusionFile = Paths.get(exclusionFileUri).toAbsolutePath();\n+\n+    String bomFileName = arguments[0];\n+\n+    Path bomFile = Paths.get(bomFileName);\n+    Bom bom = Bom.readBom(bomFile);\n+\n+    ImmutableList<Artifact> managedDependencies = bom.getManagedDependencies();\n+\n+    int count = 1;\n+\n+    // The BOM member to problematic dependencies\n+    ImmutableSetMultimap.Builder<Artifact, Artifact> problematicDependencies =\n+        ImmutableSetMultimap.builder();\n+    for (Artifact managedDependency : managedDependencies) {\n+      logger.info(\n+          \"Checking \"\n+              + managedDependency\n+              + \" (\"\n+              + (count++)\n+              + \"/\"\n+              + managedDependencies.size()\n+              + \")\");\n+\n+      ClassPathBuilder classPathBuilder = new ClassPathBuilder();\n+      ClassPathResult result = classPathBuilder.resolve(ImmutableList.of(managedDependency), false);\n+\n+      LinkageChecker linkageChecker =\n+          LinkageChecker.create(result.getClassPath(), result.getClassPath(), exclusionFile);\n+\n+      ImmutableSet<LinkageProblem> linkageProblems = linkageChecker.findLinkageProblems();\n+\n+      ImmutableSet<LinkageProblem> invalidJdkReferences =\n+          linkageProblems.stream()\n+              .filter(problem -> problem.getSymbol().getClassBinaryName().startsWith(\"java.\"))\n+              .collect(toImmutableSet());\n+\n+      if (!invalidJdkReferences.isEmpty()) {\n+        invalidJdkReferences.stream()", "originalCommit": "5d778a567222ddc02a56e92ea2b6da43c91d662e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzA0MDI0NA==", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/pull/1625#discussion_r483040244", "bodyText": "Yes. Renamed this to invalidReferencesToJavaCoreLibrary.", "author": "suztomo", "createdAt": "2020-09-03T14:52:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzAwNzg3NQ=="}], "type": "inlineReview"}, {"oid": "514cc0f5e7850841cd0c5dde25002fe98f98c143", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/commit/514cc0f5e7850841cd0c5dde25002fe98f98c143", "message": "Applied review", "committedDate": "2020-09-03T14:52:19Z", "type": "commit"}, {"oid": "01b6dc4023dec3417224af53fdc530d96c0f63e7", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/commit/01b6dc4023dec3417224af53fdc530d96c0f63e7", "message": "LinkageChecker to take exclusion file URL", "committedDate": "2020-09-03T16:24:40Z", "type": "commit"}, {"oid": "980f98eb405a1bd4015641c9d095f9ee675a8dca", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/commit/980f98eb405a1bd4015641c9d095f9ee675a8dca", "message": "Merge branch 'bad_jdk_references_check' of https://github.com/GoogleCloudPlatform/cloud-opensource-java into bad_jdk_references_check", "committedDate": "2020-09-03T16:27:11Z", "type": "commit"}, {"oid": "da2d0b9b3d7b148f2f7d7c5f1ddf5880e7638215", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/commit/da2d0b9b3d7b148f2f7d7c5f1ddf5880e7638215", "message": "Exclusion file to be arguments specified in pom.xml", "committedDate": "2020-09-03T17:05:24Z", "type": "commit"}, {"oid": "e75533a2c456142d611fd4a5ae2a6a3e9e472259", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/commit/e75533a2c456142d611fd4a5ae2a6a3e9e472259", "message": "Merge remote-tracking branch 'origin/master' into bad_jdk_references_check", "committedDate": "2020-09-03T17:05:58Z", "type": "commit"}, {"oid": "904e4bf58871c795cb10eae1b70dae60727386ff", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/commit/904e4bf58871c795cb10eae1b70dae60727386ff", "message": "Reverted unnecessary change", "committedDate": "2020-09-03T17:20:39Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzEzNjc3MQ==", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/pull/1625#discussion_r483136771", "bodyText": "Now the exclusion file is passed to the program as the second argument.", "author": "suztomo", "createdAt": "2020-09-03T17:19:09Z", "path": "dependencies/pom.xml", "diffHunk": "@@ -120,4 +120,26 @@\n       <scope>test</scope>\n     </dependency>\n   </dependencies>\n+\n+  <profiles>\n+    <profile>\n+      <id>java8-incompatible-reference-check</id>\n+      <build>\n+        <plugins>\n+          <plugin>\n+            <groupId>org.codehaus.mojo</groupId>\n+            <artifactId>exec-maven-plugin</artifactId>\n+            <configuration>\n+              <skip>false</skip>\n+              <mainClass>com.google.cloud.tools.opensource.dependencies.Java8IncompatibleReferenceCheck</mainClass>\n+              <arguments>\n+                <argument>../boms/cloud-oss-bom/pom.xml</argument>\n+                <argument>src/main/resources/java8-incompatible-reference-check-exclusion.xml</argument>", "originalCommit": "e75533a2c456142d611fd4a5ae2a6a3e9e472259", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}