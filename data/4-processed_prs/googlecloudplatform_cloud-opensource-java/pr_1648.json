{"pr_number": 1648, "pr_title": "separate concerns", "pr_createdAt": "2020-09-11T22:08:05Z", "pr_url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/pull/1648", "timeline": [{"oid": "a4a44d94d7668b4428540eb954776009fd1f0433", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/commit/a4a44d94d7668b4428540eb954776009fd1f0433", "message": "separate concerns", "committedDate": "2020-09-11T22:07:21Z", "type": "commit"}, {"oid": "52061ab5e8159a3687d44cf3ddc5afef7c210635", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/commit/52061ab5e8159a3687d44cf3ddc5afef7c210635", "message": "exclusion file is overwritten", "committedDate": "2020-09-11T22:11:37Z", "type": "commit"}, {"oid": "5e2901584d8e797abed9f82a73c2f2c27a1b7b87", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/commit/5e2901584d8e797abed9f82a73c2f2c27a1b7b87", "message": "wip", "committedDate": "2020-09-11T22:57:04Z", "type": "commit"}, {"oid": "8cee41ef41f94c2ea16d2fac585d93cf605e8122", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/commit/8cee41ef41f94c2ea16d2fac585d93cf605e8122", "message": "remove duplicate code", "committedDate": "2020-09-11T23:06:34Z", "type": "commit"}, {"oid": "ef3285616a77ae9c366d2c06425c5335376f31d3", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/commit/ef3285616a77ae9c366d2c06425c5335376f31d3", "message": "wip", "committedDate": "2020-09-12T13:05:45Z", "type": "commit"}, {"oid": "8ee9c3ed279164cf9e17e0a1f162673121dba0bd", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/commit/8ee9c3ed279164cf9e17e0a1f162673121dba0bd", "message": "unify I/O", "committedDate": "2020-09-12T13:52:04Z", "type": "commit"}, {"oid": "28c38987df6b801e8ea5fe209dad28f2595fd412", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/commit/28c38987df6b801e8ea5fe209dad28f2595fd412", "message": "unify I/O", "committedDate": "2020-09-12T14:05:23Z", "type": "commit"}, {"oid": "7b10ffa99c036906e13a51dad854c0f5568ed704", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/commit/7b10ffa99c036906e13a51dad854c0f5568ed704", "message": "wip", "committedDate": "2020-09-12T14:15:32Z", "type": "commit"}, {"oid": "a88612a145265c3e84008f2ca719beb72795f365", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/commit/a88612a145265c3e84008f2ca719beb72795f365", "message": "use instance methods", "committedDate": "2020-09-12T14:29:43Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzkxNDc2Mg==", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/pull/1648#discussion_r487914762", "bodyText": "It's unused. I see Problem.writeExclusionFile takes care of this.", "author": "suztomo", "createdAt": "2020-09-14T13:31:32Z", "path": "dependencies/src/main/java/com/google/cloud/tools/opensource/classpath/LinkageCheckerMain.java", "diffHunk": "@@ -150,16 +187,14 @@ public static void main(String[] arguments)\n               .collect(toImmutableSet());\n     }\n \n-    // TODO this should be a separate method; not part of findLinkageProblems\n-    Path outputExclusionFile = linkageCheckerArguments.getOutputExclusionFile();\n-    if (outputExclusionFile != null) {\n-      ExclusionFiles.write(outputExclusionFile, linkageProblems);\n-      System.out.println(\"Wrote the linkage errors as exclusion file: \" + outputExclusionFile);\n-      \n-      // TODO why do we return an empty set here?\n-      return ImmutableSet.of();\n-    }\n-\n     return linkageProblems;\n   }\n+  \n+  private static void writeExclusionFile(Path outputExclusionFile,", "originalCommit": "a88612a145265c3e84008f2ca719beb72795f365", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODA1MjUxNw==", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/pull/1648#discussion_r488052517", "bodyText": "removed", "author": "elharo", "createdAt": "2020-09-14T16:08:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzkxNDc2Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzkxODA0MQ==", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/pull/1648#discussion_r487918041", "bodyText": "\"All output happens here\"? The input happens at checkJarFiles and checkArtifacts.", "author": "suztomo", "createdAt": "2020-09-14T13:34:37Z", "path": "dependencies/src/main/java/com/google/cloud/tools/opensource/classpath/LinkageCheckerMain.java", "diffHunk": "@@ -60,25 +60,73 @@ public static void main(String[] arguments)\n         // If JAR files are specified, it's empty.\n         ImmutableList<Artifact> artifacts = linkageCheckerArguments.getArtifacts();\n \n-        ImmutableSet<LinkageProblem> linkageProblems =\n+        Problems problems =\n             artifacts.isEmpty()\n                 ? checkJarFiles(linkageCheckerArguments)\n                 : checkArtifacts(linkageCheckerArguments);\n-        if (!linkageProblems.isEmpty()) {\n-          System.out.println(\n-              \"For the details of the linkage errors, see \"\n-                  + \"https://github.com/GoogleCloudPlatform/cloud-opensource-java/wiki/Linkage-Checker-Messages\");\n-          // Throwing an exception is more test-friendly compared with System.exit(1). The latter\n-          // abruptly stops test execution.\n-          throw new LinkageCheckResultException(linkageProblems.size());\n+\n+        Path outputExclusionFile = linkageCheckerArguments.getOutputExclusionFile();\n+        // All I/O happens here", "originalCommit": "a88612a145265c3e84008f2ca719beb72795f365", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODA1MjIzOQ==", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/pull/1648#discussion_r488052239", "bodyText": "removed", "author": "elharo", "createdAt": "2020-09-14T16:08:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzkxODA0MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzkyMjQ0Mg==", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/pull/1648#discussion_r487922442", "bodyText": "This check looks good. I feel the similarity with curl -o <filename>. If we chose to write the output to the file, it does not print the information on console.", "author": "suztomo", "createdAt": "2020-09-14T13:38:47Z", "path": "dependencies/src/main/java/com/google/cloud/tools/opensource/classpath/LinkageCheckerMain.java", "diffHunk": "@@ -60,25 +60,73 @@ public static void main(String[] arguments)\n         // If JAR files are specified, it's empty.\n         ImmutableList<Artifact> artifacts = linkageCheckerArguments.getArtifacts();\n \n-        ImmutableSet<LinkageProblem> linkageProblems =\n+        Problems problems =\n             artifacts.isEmpty()\n                 ? checkJarFiles(linkageCheckerArguments)\n                 : checkArtifacts(linkageCheckerArguments);\n-        if (!linkageProblems.isEmpty()) {\n-          System.out.println(\n-              \"For the details of the linkage errors, see \"\n-                  + \"https://github.com/GoogleCloudPlatform/cloud-opensource-java/wiki/Linkage-Checker-Messages\");\n-          // Throwing an exception is more test-friendly compared with System.exit(1). The latter\n-          // abruptly stops test execution.\n-          throw new LinkageCheckResultException(linkageProblems.size());\n+\n+        Path outputExclusionFile = linkageCheckerArguments.getOutputExclusionFile();\n+        // All I/O happens here\n+        if (!problems.linkageProblems.isEmpty()) {\n+          // TODO really uncertain about this check. Whether to write an exclusion file is\n+          // a separate issue from whether to print the linkage problems.\n+          if (outputExclusionFile == null) {", "originalCommit": "a88612a145265c3e84008f2ca719beb72795f365", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzkyNDQ3NA==", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/pull/1648#discussion_r487924474", "bodyText": "I like this abstraction of getting the result regardless of the output.", "author": "suztomo", "createdAt": "2020-09-14T13:40:43Z", "path": "dependencies/src/main/java/com/google/cloud/tools/opensource/classpath/LinkageCheckerMain.java", "diffHunk": "@@ -60,25 +60,73 @@ public static void main(String[] arguments)\n         // If JAR files are specified, it's empty.\n         ImmutableList<Artifact> artifacts = linkageCheckerArguments.getArtifacts();\n \n-        ImmutableSet<LinkageProblem> linkageProblems =\n+        Problems problems =\n             artifacts.isEmpty()\n                 ? checkJarFiles(linkageCheckerArguments)\n                 : checkArtifacts(linkageCheckerArguments);\n-        if (!linkageProblems.isEmpty()) {\n-          System.out.println(\n-              \"For the details of the linkage errors, see \"\n-                  + \"https://github.com/GoogleCloudPlatform/cloud-opensource-java/wiki/Linkage-Checker-Messages\");\n-          // Throwing an exception is more test-friendly compared with System.exit(1). The latter\n-          // abruptly stops test execution.\n-          throw new LinkageCheckResultException(linkageProblems.size());\n+\n+        Path outputExclusionFile = linkageCheckerArguments.getOutputExclusionFile();\n+        // All I/O happens here\n+        if (!problems.linkageProblems.isEmpty()) {\n+          // TODO really uncertain about this check. Whether to write an exclusion file is\n+          // a separate issue from whether to print the linkage problems.\n+          if (outputExclusionFile == null) {\n+            problems.print();\n+            // Throwing an exception is more test-friendly than System.exit(1). The latter\n+            // abruptly stops test execution.\n+            throw new LinkageCheckResultException(problems.linkageProblems.size());\n+          } else {\n+            problems.writeExclusionFile(outputExclusionFile);\n+          }\n         }\n       }\n     } catch (ParseException ex) {\n       System.err.println(ex.getMessage());\n     }\n   }\n+  \n+  // output from a check\n+  private static final class Problems { \n+    \n+    private final ImmutableList<ArtifactProblem> artifactProblems;\n+    private final ImmutableSet<LinkageProblem> linkageProblems;\n+    private final ClassPathResult classPathResult;\n+\n+    private Problems(\n+        ImmutableSet<LinkageProblem> linkageProblems,\n+        ImmutableList<ArtifactProblem> artifactProblems,\n+        ClassPathResult classPathResult) {\n+      this.artifactProblems = artifactProblems;\n+      this.linkageProblems = linkageProblems;\n+      this.classPathResult = classPathResult;\n+    }\n \n-  private static ImmutableSet<LinkageProblem> checkJarFiles(\n+    private Problems(ImmutableSet<LinkageProblem> linkageProblems) {\n+      this.linkageProblems = linkageProblems;\n+      this.artifactProblems = ImmutableList.of();\n+      this.classPathResult = null;\n+    }\n+    \n+    void print() {\n+      System.out.println(LinkageProblem.formatLinkageProblems(\n+          linkageProblems, classPathResult));\n+      if (!artifactProblems.isEmpty()) {\n+        System.out.println(\"\\n\");\n+        System.out.println(ArtifactProblem.formatProblems(artifactProblems));\n+      }\n+      System.out.println(\n+          \"For the details of the linkage errors, see \"\n+              + \"https://github.com/GoogleCloudPlatform/cloud-opensource-java/wiki/Linkage-Checker-Messages\");\n+    }\n+    \n+    void writeExclusionFile(Path path) throws IOException, XMLStreamException, TransformerException {\n+      ExclusionFiles.write(path, linkageProblems);\n+      System.out.println(\"Wrote the linkage errors as exclusion file: \" + path);\n+    }", "originalCommit": "a88612a145265c3e84008f2ca719beb72795f365", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "e61b7bd56d06aa86681c0f5a502029724887324b", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/commit/e61b7bd56d06aa86681c0f5a502029724887324b", "message": "remove unused code", "committedDate": "2020-09-14T16:08:47Z", "type": "commit"}]}