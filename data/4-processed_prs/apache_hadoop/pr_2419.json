{"pr_number": 2419, "pr_title": "HDFS-15654. TestBPOfferService#testMissBlocksWhenReregister fails intermittently", "pr_createdAt": "2020-10-28T04:11:04Z", "pr_url": "https://github.com/apache/hadoop/pull/2419", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzUzODc0Nw==", "url": "https://github.com/apache/hadoop/pull/2419#discussion_r513538747", "bodyText": "Remove this extra line added.", "author": "goiri", "createdAt": "2020-10-28T15:28:46Z", "path": "hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/hdfs/server/datanode/TestBPOfferService.java", "diffHunk": "@@ -280,26 +282,24 @@ public void testBasicFunctionality() throws Exception {\n    */\n   @Test\n   public void testMissBlocksWhenReregister() throws Exception {\n+", "originalCommit": "470cbc7df24a637de9bcdd226ecab1f65addde8b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzU3NTI3Mw==", "url": "https://github.com/apache/hadoop/pull/2419#discussion_r513575273", "bodyText": "You might want to put the previous log message in the fail().", "author": "goiri", "createdAt": "2020-10-28T16:13:23Z", "path": "hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/hdfs/server/datanode/TestBPOfferService.java", "diffHunk": "@@ -318,45 +317,41 @@ public void blockUtilSendFullBlockReport() {\n             count.addAndGet(1);\n             Thread.sleep(1);\n           } catch (Exception e) {\n-            e.printStackTrace();\n+            LOG.error(\"error addNewBlockThread\", e);\n           }\n         }\n       });\n       addNewBlockThread.start();\n \n       // Make sure that generate blocks for DataNode and IBR not empty now.\n-      GenericTestUtils.waitFor(() -> {\n-        if(count.get() > 0) {\n-          return true;\n-        }\n-        return false;\n-      }, 100, 1000);\n+      GenericTestUtils.waitFor(() -> count.get() > 0, 100, 1000);\n \n       // Trigger re-register using DataNode Command.\n       datanodeCommands[0] = new DatanodeCommand[]{RegisterCommand.REGISTER};\n-      bpos.triggerHeartbeatForTests();\n \n+      bpos.triggerHeartbeatForTests();\n+      addNewBlockThread.join();\n+      addNewBlockThread = null;\n+      // Verify FBR/IBR count is equal to generate number.\n       try {\n-        GenericTestUtils.waitFor(() -> {\n-          if(fullBlockReportCount == totalTestBlocks ||\n-              incrBlockReportCount == totalTestBlocks) {\n-            return true;\n-          }\n-          return false;\n-        }, 1000, 15000);\n-      } catch (Exception e) {}\n+        GenericTestUtils.waitFor(() ->\n+            (fullBlockReportCount == totalTestBlocks ||\n+                incrBlockReportCount == totalTestBlocks), 1000, 15000);\n+      } catch (Exception e) {\n+        LOG.error(\"Timed out wait for IBR counts FBRCount = {},\"\n+                + \" IBRCount = {}; expected = {}\",\n+            fullBlockReportCount, incrBlockReportCount, totalTestBlocks);\n+        Assert.fail();", "originalCommit": "d05e70d9b7b22a46c298201b6885ccb28816607a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzU3Nzc1Nw==", "url": "https://github.com/apache/hadoop/pull/2419#discussion_r513577757", "bodyText": "And do the static import of fail() as the other assertEquals() and so on.", "author": "goiri", "createdAt": "2020-10-28T16:16:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzU3NTI3Mw=="}], "type": "inlineReview"}, {"oid": "651ade391610d987ca4b90d9afbb2729f66d8354", "url": "https://github.com/apache/hadoop/commit/651ade391610d987ca4b90d9afbb2729f66d8354", "message": "HDFS-15654. TestBPOfferService#testMissBlocksWhenReregister fails intermittently", "committedDate": "2020-10-28T22:58:32Z", "type": "commit"}, {"oid": "910c6bc5cb5e2ed6e2bd8bad4516ccb130401bc7", "url": "https://github.com/apache/hadoop/commit/910c6bc5cb5e2ed6e2bd8bad4516ccb130401bc7", "message": "HDFS-15654. remove extra empty line.", "committedDate": "2020-10-28T22:58:32Z", "type": "commit"}, {"oid": "f22a94a848d6d2de68029534446461604b734547", "url": "https://github.com/apache/hadoop/commit/f22a94a848d6d2de68029534446461604b734547", "message": "HDFS-15654. fix imports", "committedDate": "2020-10-28T22:58:32Z", "type": "commit"}, {"oid": "f22a94a848d6d2de68029534446461604b734547", "url": "https://github.com/apache/hadoop/commit/f22a94a848d6d2de68029534446461604b734547", "message": "HDFS-15654. fix imports", "committedDate": "2020-10-28T22:58:32Z", "type": "forcePushed"}]}