{"pr_number": 2342, "pr_title": "HADOOP-17288. Use shaded guava from thirdparty.", "pr_createdAt": "2020-09-27T17:07:51Z", "pr_url": "https://github.com/apache/hadoop/pull/2342", "timeline": [{"oid": "f1a960bb37127377c52bb7ecc8b25363e140f49f", "url": "https://github.com/apache/hadoop/commit/f1a960bb37127377c52bb7ecc8b25363e140f49f", "message": "HADOOP-17288. Use shaded guava from thirdparty.", "committedDate": "2020-09-28T15:09:16Z", "type": "forcePushed"}, {"oid": "e9721616eb6d6a5784c9f3e0027d235bf02cc8cd", "url": "https://github.com/apache/hadoop/commit/e9721616eb6d6a5784c9f3e0027d235bf02cc8cd", "message": "Change Guava to 11.", "committedDate": "2020-10-02T04:30:03Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDExNjM2MQ==", "url": "https://github.com/apache/hadoop/pull/2342#discussion_r500116361", "bodyText": "Instead of replacing guava references along with protobuf references, create a separate replacer-execution in hadoop-project/pom.xml and enable by default for all projects.\n            <execution>\n              <id>replace-guava</id>\n              <phase>process-sources</phase>\n              <goals>\n                <goal>replace</goal>\n              </goals>\n              <configuration>\n                <skip>false</skip><!--This will run for all modules-->\n                <basedir>${basedir}</basedir>\n                <includes>\n                  <include>src/main/java/**/*.java</include>\n                  <include>src/test/java/**/*.java</include>\n                </includes>\n                <replacements>\n                  <replacement>\n                    <token>([^\\.])com.google.common</token>\n                    <value>$1${hadoop-thirdparty-shaded-guava-prefix}</value>\n                  </replacement>\n                </replacements>\n              </configuration>\n            </execution>\n\n\n\nExclude guava-replacement in hadoop-yarn-csi module. yarn-csi seems to have separate classpath, and it explicitly uses guava-20. This will not affect any downstreams.\n\n\nReplaces all dependencies on guava to hadoop-shaded-guava (except yarn-csi)\n\n\nIn hadoop-common/pom.xml, Keep both guava (11.0.2) and hadoop-shaded-guava as dependencies. Of course code should use shaded version of guava. version 11.0.2 is used in curator libs during runtime.", "author": "vinayakumarb", "createdAt": "2020-10-06T08:58:32Z", "path": "hadoop-common-project/hadoop-auth/pom.xml", "diffHunk": "@@ -234,6 +235,24 @@\n           <excludeFilterFile>${basedir}/dev-support/findbugsExcludeFile.xml</excludeFilterFile>\n         </configuration>\n       </plugin>\n+      <plugin>\n+        <groupId>com.google.code.maven-replacer-plugin</groupId>\n+        <artifactId>replacer</artifactId>\n+        <executions>\n+          <execution>\n+            <id>replace-sources</id>\n+            <configuration>\n+              <skip>false</skip>\n+            </configuration>\n+          </execution>\n+          <execution>\n+            <id>replace-test-sources</id>\n+            <configuration>\n+              <skip>false</skip>\n+            </configuration>\n+          </execution>\n+        </executions>\n+      </plugin>", "originalCommit": "e9721616eb6d6a5784c9f3e0027d235bf02cc8cd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTIxNjUzOA==", "url": "https://github.com/apache/hadoop/pull/2342#discussion_r501216538", "bodyText": "A few questions so I can better understand the suggested approach:\nSo source would continue to refer to unshaded guava? (unshaded guava 11?)\nRather than rewrite once as this PR does, we'd rewrite on every build? How long does the rewrite take?\nhadoop-yarn-csi is bound to guava-20? Why is that? The grpc used? Interested in how a guava 20 in classpath won't mess up downstreamers who want to use something newer (or older).\nFor 4., hopefully we can (later) add an enforcer so non-shaded references get flagged at build time. Rather than have hadoop depend on something it doesn't use, hopefully we can work on fixing the curator dependency to fix its pom?\nThanks @vinayakumarb", "author": "saintstack", "createdAt": "2020-10-07T18:17:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDExNjM2MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTIyOTExOQ==", "url": "https://github.com/apache/hadoop/pull/2342#discussion_r501229119", "bodyText": "A few questions so I can better understand the suggested approach:\nSo source would continue to refer to unshaded guava? (unshaded guava 11?)\nHadoop source uses shaded guava itself from hadoop-thirdparty.\nRather than rewrite once as this PR does, we'd rewrite on every build? How long does the rewrite take?\n\nThis replacer is basically to make the Job easy for this PR.  Since we commit the replaced code itself, further replaces wont happen on same file. It will help to catch further references to unshaded guava. Rewrite doesnot take much time, it finishes in fraction of second.\n\nhadoop-yarn-csi is bound to guava-20? Why is that? The grpc used? Interested in how a guava 20 in classpath won't mess up downstreamers who want to use something newer (or older).\n\nyes, yarn-csi uses grpc. And grpc refers to guava-20 and it uses protobuf 3.x even before protobuf was upgraded for entire hadoop. It keeps separate directory (share/hadoop/yarn/csi/lib) for its dependencies and existing scripts doesnt add this directory into classpath of other processes.\n\nFor 4., hopefully we can (later) add an enforcer so non-shaded references get flagged at build time. Rather than have hadoop depend on something it doesn't use, hopefully we can work on fixing the curator dependency to fix its pom?\n\nyes, If we could add this enforcer, may be we need not find and replace unshaded usage of guava on every build.\nFor curator, curator community is not ready to shade 3 classes of guava as they are part of their API. These classes seems to be pretty stable across versions. So curator does work with guava-11 in classpath.\nIf we want to fix this and completely remove hadoop's dependency on guava, we may need to shade curator as well in hadoop-thirdparty and use that in hadoop.\nWe are fortunate enough that, these dependencies are not part of any exposed APIs.\n\nThanks @vinayakumarb\n\nThanks @saintstack", "author": "vinayakumarb", "createdAt": "2020-10-07T18:36:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDExNjM2MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTI0NDA1Ng==", "url": "https://github.com/apache/hadoop/pull/2342#discussion_r501244056", "bodyText": "Thanx @vinayakumarb and @saintstack\nSince the discussion is going on here, I thought to get everything here only.\nRegarding guava revert to 11, I think, as you mentioned that would be incompatible, and downstream would be excluding them only, when adding hadoop-jars as dependency. So, In the present state there won't be any problem with the version, since the hadoop jars aren't using it, and for the other dependencies they are not getting affected by this version, as tests passed both with 27 and 11. So, I think we can keep guava version as is and let downstream exclude while including hadoop-jars(most projects already do that) and run happily with there own guava versions.\nSince reverting back would be problem for those, who don't have there own guava and rely on hadoop to provide guava, there code might break.\nSo, I think we can keep the reversal separate from shading and if the community is OK with going back, we will revert back in a separate jira", "author": "ayushtkn", "createdAt": "2020-10-07T19:02:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDExNjM2MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTI2MDgwMA==", "url": "https://github.com/apache/hadoop/pull/2342#discussion_r501260800", "bodyText": "@vinayakumarb\n\nSince we commit the replaced code itself...\n\nGood.\nOk on the isolation of grpc and dependencis (Can later try shading grpc later if a problem)\nThanks for update on curator (shading curator would be a pain. It does shading itself IIRC). Hive also has guava 11 in its API apparently.\n\nWe are fortunate enough that, these dependencies are not part of any exposed APIs.\nAmen\n\n@ayushtkn\n\nSo, I think we can keep guava version as is ...\n\nAt 27? (Or at 11). Sorry, had trouble grokking here.\n\nSince reverting back would be problem for those, who don't have there own guava and rely on hadoop to provide guava, there code might break.\n\nI think this would be ok -- i.e. breakage -- especially in a new minor version, 3.4.0. The fix is easy enough for the downstream, just add guava dependency.\n\n\nSo, I think we can keep the reversal separate from shading and if the community is OK with going back, we will revert back in a separate jira\nSounds good.", "author": "saintstack", "createdAt": "2020-10-07T19:33:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDExNjM2MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODI0NjM5OA==", "url": "https://github.com/apache/hadoop/pull/2342#discussion_r508246398", "bodyText": "@ayushtkn et al.\nI recently did similar work as this PR on top of the 3.3.0 release, using the exact same approach with the replacer plugin and renaming the guava namespace to the Hadoop thirdparty shaded version throughout the whole codebase. The short term goal was to solve the Hive incompatibility issue with Spark. The change worked, the Hive unit tests within the Spark codebase largely pass, no more linkage error.  However, a guava dependency still needed to be declared in the Hadoop pom.xml to overcome an enforcerer error about conflicting Guava versions that show up as transitive dependencies.\nHope this is helpful information. If there is interest in the community, I make a PR or otherwise make that available for testing?", "author": "bolerio", "createdAt": "2020-10-20T06:44:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDExNjM2MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODI1NTQwMw==", "url": "https://github.com/apache/hadoop/pull/2342#discussion_r508255403", "bodyText": "It's already there in the hadoop parent pom -\nhttps://github.com/apache/hadoop/blob/trunk/hadoop-project/pom.xml#L693\nI think you are getting conflicting dependencies, while building your project? you need to add guava in your parent pom.\nAnyway you can try excluding guava as well while adding the hadoop dependency?", "author": "ayushtkn", "createdAt": "2020-10-20T07:03:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDExNjM2MQ=="}], "type": "inlineReview"}, {"oid": "1d7fe1849e63c5dd8c38e30ac40bfe2e3ec615c6", "url": "https://github.com/apache/hadoop/commit/1d7fe1849e63c5dd8c38e30ac40bfe2e3ec615c6", "message": "HADOOP-17288. Use shaded guava from thirdparty.", "committedDate": "2020-10-08T03:36:36Z", "type": "forcePushed"}, {"oid": "0d9ff8469d54458e8152aefaedfdd723b786810c", "url": "https://github.com/apache/hadoop/commit/0d9ff8469d54458e8152aefaedfdd723b786810c", "message": "HADOOP-17288. Use shaded guava from thirdparty.", "committedDate": "2020-10-10T09:58:56Z", "type": "forcePushed"}, {"oid": "2b584f58965e7ba035101bf5c31ee0675e6a1516", "url": "https://github.com/apache/hadoop/commit/2b584f58965e7ba035101bf5c31ee0675e6a1516", "message": "HADOOP-17288. Use shaded guava from thirdparty.", "committedDate": "2020-10-11T14:13:51Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzQxMzc3NQ==", "url": "https://github.com/apache/hadoop/pull/2342#discussion_r503413775", "bodyText": "This change intentional? How does it relate?", "author": "saintstack", "createdAt": "2020-10-12T16:42:15Z", "path": "Jenkinsfile", "diffHunk": "@@ -23,7 +23,7 @@ pipeline {\n \n     options {\n         buildDiscarder(logRotator(numToKeepStr: '5'))\n-        timeout (time: 20, unit: 'HOURS')\n+        timeout (time: 30, unit: 'HOURS')", "originalCommit": "2b584f58965e7ba035101bf5c31ee0675e6a1516", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzk2NTUyMg==", "url": "https://github.com/apache/hadoop/pull/2342#discussion_r503965522", "bodyText": "Yes, this is intentional since the changes are in the parent pom, the tests all of all the modules are executed, the build was getting timeout in 20 hours, so have temporarily increased. Will revert this before pushing", "author": "ayushtkn", "createdAt": "2020-10-13T13:46:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzQxMzc3NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzQxNDIyOQ==", "url": "https://github.com/apache/hadoop/pull/2342#discussion_r503414229", "bodyText": "nit: no need of the compile scope since it default?", "author": "saintstack", "createdAt": "2020-10-12T16:43:15Z", "path": "hadoop-common-project/hadoop-common/pom.xml", "diffHunk": "@@ -49,6 +49,12 @@\n       <artifactId>hadoop-annotations</artifactId>\n       <scope>compile</scope>\n     </dependency>\n+    <dependency>\n+      <groupId>org.apache.hadoop.thirdparty</groupId>\n+      <artifactId>hadoop-shaded-guava</artifactId>\n+      <scope>compile</scope>", "originalCommit": "2b584f58965e7ba035101bf5c31ee0675e6a1516", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzk2ODAzNQ==", "url": "https://github.com/apache/hadoop/pull/2342#discussion_r503968035", "bodyText": "Thanx, Will update in next iteration. If no further comments. :-)", "author": "ayushtkn", "createdAt": "2020-10-13T13:49:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzQxNDIyOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzQxNDUwMg==", "url": "https://github.com/apache/hadoop/pull/2342#discussion_r503414502", "bodyText": "Helpful comment.", "author": "saintstack", "createdAt": "2020-10-12T16:43:45Z", "path": "hadoop-common-project/hadoop-common/pom.xml", "diffHunk": "@@ -49,6 +49,12 @@\n       <artifactId>hadoop-annotations</artifactId>\n       <scope>compile</scope>\n     </dependency>\n+    <dependency>\n+      <groupId>org.apache.hadoop.thirdparty</groupId>\n+      <artifactId>hadoop-shaded-guava</artifactId>\n+      <scope>compile</scope>\n+    </dependency>\n+    <!--Guava is required during runtime for curator-->", "originalCommit": "2b584f58965e7ba035101bf5c31ee0675e6a1516", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzQyMzkyMA==", "url": "https://github.com/apache/hadoop/pull/2342#discussion_r503423920", "bodyText": "This intentional?", "author": "saintstack", "createdAt": "2020-10-12T17:01:58Z", "path": "hadoop-project/pom.xml", "diffHunk": "@@ -2198,7 +2227,7 @@\n             <configuration>\n               <rules>\n                 <DependencyConvergence>\n-                  <uniqueVersions>true</uniqueVersions>\n+                  <uniqueVersions>false</uniqueVersions>", "originalCommit": "2b584f58965e7ba035101bf5c31ee0675e6a1516", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzk2Njg3MQ==", "url": "https://github.com/apache/hadoop/pull/2342#discussion_r503966871", "bodyText": "Yes, Since the thirdparty version being used is a snapshot version. If we don't disable it the build fails due to different timestamp with the snapshot version at jenkins(though it doesn't bother me at local). Once the thirdaparty version is released. Will get this back to true while updating the version", "author": "ayushtkn", "createdAt": "2020-10-13T13:48:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzQyMzkyMA=="}], "type": "inlineReview"}, {"oid": "3f0c38cc7cfcb112ed6950eebd0bd93ed7f1192e", "url": "https://github.com/apache/hadoop/commit/3f0c38cc7cfcb112ed6950eebd0bd93ed7f1192e", "message": "HADOOP-17288. Use shaded guava from thirdparty.", "committedDate": "2020-10-17T05:59:44Z", "type": "commit"}, {"oid": "3f0c38cc7cfcb112ed6950eebd0bd93ed7f1192e", "url": "https://github.com/apache/hadoop/commit/3f0c38cc7cfcb112ed6950eebd0bd93ed7f1192e", "message": "HADOOP-17288. Use shaded guava from thirdparty.", "committedDate": "2020-10-17T05:59:44Z", "type": "forcePushed"}]}