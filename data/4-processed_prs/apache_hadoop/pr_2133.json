{"pr_number": 2133, "pr_title": "HADOOP-17122: Preserving Directory Attributes in DistCp with Atomic Copy", "pr_createdAt": "2020-07-11T05:10:27Z", "pr_url": "https://github.com/apache/hadoop/pull/2133", "timeline": [{"oid": "10d0fab726c80e32287c2b9018247a2469d73154", "url": "https://github.com/apache/hadoop/commit/10d0fab726c80e32287c2b9018247a2469d73154", "message": "HADOOP-17122: Preserving Directory Attributes in DistCp with Atomic Copy", "committedDate": "2020-07-11T17:33:01Z", "type": "commit"}, {"oid": "10d0fab726c80e32287c2b9018247a2469d73154", "url": "https://github.com/apache/hadoop/commit/10d0fab726c80e32287c2b9018247a2469d73154", "message": "HADOOP-17122: Preserving Directory Attributes in DistCp with Atomic Copy", "committedDate": "2020-07-11T17:33:01Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDExNDcwNQ==", "url": "https://github.com/apache/hadoop/pull/2133#discussion_r464114705", "bodyText": "this wil be the HDFS minicluster, right?", "author": "steveloughran", "createdAt": "2020-08-02T19:29:57Z", "path": "hadoop-tools/hadoop-distcp/src/test/java/org/apache/hadoop/tools/mapred/TestCopyCommitter.java", "diffHunk": "@@ -177,6 +177,44 @@ public void testPreserveStatus() throws IOException {\n       conf.unset(DistCpConstants.CONF_LABEL_PRESERVE_STATUS);\n     }\n \n+  }\n+  @Test\n+  public void testPreserveStatusWithAtomicCommit() throws IOException {\n+    TaskAttemptContext taskAttemptContext = getTaskAttemptContext(config);\n+    JobContext jobContext = new JobContextImpl(taskAttemptContext.getConfiguration(),\n+                            taskAttemptContext.getTaskAttemptID().getJobID());\n+    Configuration conf = jobContext.getConfiguration();\n+    String sourceBase;\n+    String workBase;\n+    String targetBase;\n+    FileSystem fs = null;\n+    try {\n+      OutputCommitter committer = new CopyCommitter(null, taskAttemptContext);\n+      fs = FileSystem.get(conf);", "originalCommit": "10d0fab726c80e32287c2b9018247a2469d73154", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDE0NzAwOA==", "url": "https://github.com/apache/hadoop/pull/2133#discussion_r464147008", "bodyText": "Yeah, we have registered a HDFS minicluster.", "author": "swamirishi", "createdAt": "2020-08-03T00:56:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDExNDcwNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDI4ODU5NQ==", "url": "https://github.com/apache/hadoop/pull/2133#discussion_r464288595", "bodyText": "Why we changed the path here ?? Assuming this test is for non-atomic, values of CONF_LABEL_TARGET_FINAL_PATH and CONF_LABEL_TARGET_WORK_PATH will be same.", "author": "mukund-thakur", "createdAt": "2020-08-03T09:08:50Z", "path": "hadoop-tools/hadoop-distcp/src/test/java/org/apache/hadoop/tools/mapred/TestCopyCommitter.java", "diffHunk": "@@ -160,10 +160,10 @@ public void testPreserveStatus() throws IOException {\n       context.setTargetPathExists(false);\n \n       CopyListing listing = new GlobbedCopyListing(conf, CREDENTIALS);\n-      Path listingFile = new Path(\"/tmp1/\" + String.valueOf(rand.nextLong()));\n+      Path listingFile = new Path(\"/tmp1/\" + rand.nextLong());\n       listing.buildListing(listingFile, context);\n \n-      conf.set(DistCpConstants.CONF_LABEL_TARGET_WORK_PATH, targetBase);\n+      conf.set(DistCpConstants.CONF_LABEL_TARGET_FINAL_PATH, targetBase);", "originalCommit": "10d0fab726c80e32287c2b9018247a2469d73154", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDMyOTUyNQ==", "url": "https://github.com/apache/hadoop/pull/2133#discussion_r464329525", "bodyText": "This test case is not the case of Atomic Copy or non Atomic Copy. You are right about that, the value of final Path & work path would be same in case of non atomic copy . But as you see above we are setting the environment for testing the preserve status functionality & not doing a copy. It solely depends on the configuration value of the final Path & not the work path. This is the bug I raised & fixed the test case pertaining to this along with it.", "author": "swamirishi", "createdAt": "2020-08-03T10:29:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDI4ODU5NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDM4Njg4OQ==", "url": "https://github.com/apache/hadoop/pull/2133#discussion_r464386889", "bodyText": "Thanks got it. Code was wrong as well as the testcase was wrong. Thanks for fixing.", "author": "mukund-thakur", "createdAt": "2020-08-03T12:40:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDI4ODU5NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDM4ODIxMw==", "url": "https://github.com/apache/hadoop/pull/2133#discussion_r464388213", "bodyText": "@mukund-thakur  Can this code be merged? Or is there anything I have to do from my end.", "author": "swamirishi", "createdAt": "2020-08-03T12:43:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDI4ODU5NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzkzNjA4Mg==", "url": "https://github.com/apache/hadoop/pull/2133#discussion_r467936082", "bodyText": "add newline", "author": "steveloughran", "createdAt": "2020-08-10T14:18:36Z", "path": "hadoop-tools/hadoop-distcp/src/test/java/org/apache/hadoop/tools/mapred/TestCopyCommitter.java", "diffHunk": "@@ -177,6 +177,44 @@ public void testPreserveStatus() throws IOException {\n       conf.unset(DistCpConstants.CONF_LABEL_PRESERVE_STATUS);\n     }\n \n+  }\n+  @Test", "originalCommit": "10d0fab726c80e32287c2b9018247a2469d73154", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODAzNTAxNg==", "url": "https://github.com/apache/hadoop/pull/2133#discussion_r468035016", "bodyText": "Done", "author": "swamirishi", "createdAt": "2020-08-10T16:37:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzkzNjA4Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzkzNjY1NA==", "url": "https://github.com/apache/hadoop/pull/2133#discussion_r467936654", "bodyText": "do the same on lines 168 and 206", "author": "steveloughran", "createdAt": "2020-08-10T14:19:32Z", "path": "hadoop-tools/hadoop-distcp/src/test/java/org/apache/hadoop/tools/mapred/TestCopyCommitter.java", "diffHunk": "@@ -160,10 +160,10 @@ public void testPreserveStatus() throws IOException {\n       context.setTargetPathExists(false);\n \n       CopyListing listing = new GlobbedCopyListing(conf, CREDENTIALS);\n-      Path listingFile = new Path(\"/tmp1/\" + String.valueOf(rand.nextLong()));\n+      Path listingFile = new Path(\"/tmp1/\" + rand.nextLong());", "originalCommit": "10d0fab726c80e32287c2b9018247a2469d73154", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODAzNDE5Ng==", "url": "https://github.com/apache/hadoop/pull/2133#discussion_r468034196", "bodyText": "Done", "author": "swamirishi", "createdAt": "2020-08-10T16:36:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzkzNjY1NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzkzODQ1Mg==", "url": "https://github.com/apache/hadoop/pull/2133#discussion_r467938452", "bodyText": "you can do a static import for these constants if it keeps the code cleaner", "author": "steveloughran", "createdAt": "2020-08-10T14:22:08Z", "path": "hadoop-tools/hadoop-distcp/src/test/java/org/apache/hadoop/tools/mapred/TestCopyCommitter.java", "diffHunk": "@@ -177,6 +177,44 @@ public void testPreserveStatus() throws IOException {\n       conf.unset(DistCpConstants.CONF_LABEL_PRESERVE_STATUS);\n     }\n \n+  }\n+  @Test\n+  public void testPreserveStatusWithAtomicCommit() throws IOException {\n+    TaskAttemptContext taskAttemptContext = getTaskAttemptContext(config);\n+    JobContext jobContext = new JobContextImpl(taskAttemptContext.getConfiguration(),\n+                            taskAttemptContext.getTaskAttemptID().getJobID());\n+    Configuration conf = jobContext.getConfiguration();\n+    String sourceBase;\n+    String workBase;\n+    String targetBase;\n+    FileSystem fs = null;\n+    try {\n+      OutputCommitter committer = new CopyCommitter(null, taskAttemptContext);\n+      fs = FileSystem.get(conf);\n+      FsPermission sourcePerm = new FsPermission((short) 511);\n+      FsPermission initialPerm = new FsPermission((short) 448);\n+      sourceBase = TestDistCpUtils.createTestSetup(fs, sourcePerm);\n+      workBase = TestDistCpUtils.createTestSetup(fs, initialPerm);\n+      targetBase = \"/tmp1/\" + String.valueOf(rand.nextLong());\n+      final DistCpOptions options = new DistCpOptions.Builder(\n+              Collections.singletonList(new Path(sourceBase)), new Path(\"/out\"))\n+              .preserve(FileAttribute.PERMISSION).build();\n+      options.appendToConf(conf);\n+      final DistCpContext context = new DistCpContext(options);\n+      context.setTargetPathExists(false);\n+      CopyListing listing = new GlobbedCopyListing(conf, CREDENTIALS);\n+      Path listingFile = new Path(\"/tmp1/\" + String.valueOf(rand.nextLong()));\n+      listing.buildListing(listingFile, context);\n+      conf.set(DistCpConstants.CONF_LABEL_TARGET_FINAL_PATH, targetBase);", "originalCommit": "10d0fab726c80e32287c2b9018247a2469d73154", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODAzNjAxNQ==", "url": "https://github.com/apache/hadoop/pull/2133#discussion_r468036015", "bodyText": "Done", "author": "swamirishi", "createdAt": "2020-08-10T16:39:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzkzODQ1Mg=="}], "type": "inlineReview"}, {"oid": "1dc17b5db47c1cb43511756f58c3a20174f2fe46", "url": "https://github.com/apache/hadoop/commit/1dc17b5db47c1cb43511756f58c3a20174f2fe46", "message": " HADOOP-17122: Addressing Review Comments for Preserving Directory Attributes", "committedDate": "2020-08-10T16:35:24Z", "type": "forcePushed"}, {"oid": "166ec387af72ca70b612154d1fc1e47a65647cad", "url": "https://github.com/apache/hadoop/commit/166ec387af72ca70b612154d1fc1e47a65647cad", "message": " HADOOP-17122: Addressing Review Comments for Preserving Directory Attributes", "committedDate": "2020-08-11T05:04:55Z", "type": "commit"}, {"oid": "166ec387af72ca70b612154d1fc1e47a65647cad", "url": "https://github.com/apache/hadoop/commit/166ec387af72ca70b612154d1fc1e47a65647cad", "message": " HADOOP-17122: Addressing Review Comments for Preserving Directory Attributes", "committedDate": "2020-08-11T05:04:55Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTI0NDE2Nw==", "url": "https://github.com/apache/hadoop/pull/2133#discussion_r469244167", "bodyText": "nit: restore the line ending", "author": "steveloughran", "createdAt": "2020-08-12T13:06:00Z", "path": "hadoop-tools/hadoop-distcp/src/test/java/org/apache/hadoop/tools/mapred/TestCopyCommitter.java", "diffHunk": "@@ -650,4 +653,4 @@ public RecordReader createRecordReader(InputSplit split,\n       return null;\n     }\n   }\n-}\n+}", "originalCommit": "166ec387af72ca70b612154d1fc1e47a65647cad", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "f97e6f79a943aa76c174300df698af96793a176f", "url": "https://github.com/apache/hadoop/commit/f97e6f79a943aa76c174300df698af96793a176f", "message": " HADOOP-17122: Restoring new line at the end", "committedDate": "2020-08-13T06:11:52Z", "type": "commit"}, {"oid": "c4ad2f73de56136b31b739d55f918e20cc15abca", "url": "https://github.com/apache/hadoop/commit/c4ad2f73de56136b31b739d55f918e20cc15abca", "message": " HADOOP-17122: Removing Whitespace from Added New line", "committedDate": "2020-08-13T06:18:48Z", "type": "commit"}, {"oid": "eeff2e61d2838cdfd2322126964a298c6b74bda2", "url": "https://github.com/apache/hadoop/commit/eeff2e61d2838cdfd2322126964a298c6b74bda2", "message": "HADOOP-17122: Correcting Whitespace checks", "committedDate": "2020-08-19T09:00:30Z", "type": "commit"}, {"oid": "987a9aa1a1a039096803c3eea5a2dae8778442b3", "url": "https://github.com/apache/hadoop/commit/987a9aa1a1a039096803c3eea5a2dae8778442b3", "message": "HADOOP-17122: Correcting Whitespace checks", "committedDate": "2020-08-19T09:02:24Z", "type": "commit"}]}