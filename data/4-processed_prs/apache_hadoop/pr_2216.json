{"pr_number": 2216, "pr_title": "HADOOP-17194. Adding Context class for AbfsClient in ABFS", "pr_createdAt": "2020-08-11T12:42:10Z", "pr_url": "https://github.com/apache/hadoop/pull/2216", "timeline": [{"oid": "4bafb6af593683476bbfdfdabf503caa5d35838e", "url": "https://github.com/apache/hadoop/commit/4bafb6af593683476bbfdfdabf503caa5d35838e", "message": "HADOOP-17194. Adding Context class for AbfsClient to pass AbfsConfigurations to limit number of parameters", "committedDate": "2020-08-11T12:37:19Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTA3OTcxMQ==", "url": "https://github.com/apache/hadoop/pull/2216#discussion_r475079711", "bodyText": "Mixiing the builder with the implementation is a bit, well, cheating, isn't it? More importantly -it stops the context being immutable. Could you split into a builder and acutal context?", "author": "steveloughran", "createdAt": "2020-08-22T11:11:43Z", "path": "hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/services/AbfsClientContext.java", "diffHunk": "@@ -0,0 +1,68 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hadoop.fs.azurebfs.services;\n+\n+/**\n+ * Class to hold extra configurations for AbfsClient and further classes\n+ * inside AbfsClient.\n+ */\n+public class AbfsClientContext {", "originalCommit": "4bafb6af593683476bbfdfdabf503caa5d35838e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTMxNzk2Ng==", "url": "https://github.com/apache/hadoop/pull/2216#discussion_r475317966", "bodyText": "So, just to be clear.\n\nA separate builder class that would have the build method and also the with options(withAbfsCounters(), withAbfsPerfTracker(), etc), right? So, move the with options from the context class to the builder class.\nAlso, the context class would now have a parameterized constructor which I would call in the build() method to return the context instance.\nThe validations are for future usages, right? Since for options, I am adding I already have validation in the class that uses them( for eg: if(abfsCounter !=null) {} is checked in the AbfsClient class).", "author": "mehakmeet", "createdAt": "2020-08-24T03:06:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTA3OTcxMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzQyODM5NQ==", "url": "https://github.com/apache/hadoop/pull/2216#discussion_r477428395", "bodyText": "ok, don't worry about validation. What you have done is great -all that is left is to make the AbfsClientContext package private so forcing everything to go through the builder", "author": "steveloughran", "createdAt": "2020-08-26T16:23:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTA3OTcxMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTA3OTc4Mw==", "url": "https://github.com/apache/hadoop/pull/2216#discussion_r475079783", "bodyText": "this (once moved to the separate builder) could be a place to validate things for not being null", "author": "steveloughran", "createdAt": "2020-08-22T11:12:43Z", "path": "hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/services/AbfsClientContext.java", "diffHunk": "@@ -0,0 +1,68 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hadoop.fs.azurebfs.services;\n+\n+/**\n+ * Class to hold extra configurations for AbfsClient and further classes\n+ * inside AbfsClient.\n+ */\n+public class AbfsClientContext {\n+\n+  private ExponentialRetryPolicy exponentialRetryPolicy;\n+  private AbfsPerfTracker abfsPerfTracker;\n+  private AbfsCounters abfsCounters;\n+\n+  public AbfsClientContext withExponentialRetryPolicy(\n+      final ExponentialRetryPolicy exponentialRetryPolicy) {\n+    this.exponentialRetryPolicy = exponentialRetryPolicy;\n+    return this;\n+  }\n+\n+  public AbfsClientContext withAbfsPerfTracker(\n+      final AbfsPerfTracker abfsPerfTracker) {\n+    this.abfsPerfTracker = abfsPerfTracker;\n+    return this;\n+  }\n+\n+  public AbfsClientContext withAbfsCounters(final AbfsCounters abfsCounters) {\n+    this.abfsCounters = abfsCounters;\n+    return this;\n+  }\n+\n+  /**\n+   * Build the context and get the instance with the properties selected.\n+   *\n+   * @return an instance of AbfsClientContext.\n+   */\n+  public AbfsClientContext build() {\n+    return this;", "originalCommit": "4bafb6af593683476bbfdfdabf503caa5d35838e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTA3OTk4NA==", "url": "https://github.com/apache/hadoop/pull/2216#discussion_r475079984", "bodyText": "I was going to suggest making this a generai RetryPolicy rather than the explicit exponential one -but I see this isn't the normal hadoop-common retry policy, just one unique to abfs. So moot. If we find that retry policy is too inflexible, then it would be time to revisit that decision.", "author": "steveloughran", "createdAt": "2020-08-22T11:15:16Z", "path": "hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/services/AbfsClientContext.java", "diffHunk": "@@ -0,0 +1,68 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hadoop.fs.azurebfs.services;\n+\n+/**\n+ * Class to hold extra configurations for AbfsClient and further classes\n+ * inside AbfsClient.\n+ */\n+public class AbfsClientContext {\n+\n+  private ExponentialRetryPolicy exponentialRetryPolicy;", "originalCommit": "4bafb6af593683476bbfdfdabf503caa5d35838e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTA4MDExMg==", "url": "https://github.com/apache/hadoop/pull/2216#discussion_r475080112", "bodyText": "let's add some javadocs. In particularly highlighting this is is a one-off operation", "author": "steveloughran", "createdAt": "2020-08-22T11:17:07Z", "path": "hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/AzureBlobFileSystemStore.java", "diffHunk": "@@ -1214,7 +1217,7 @@ public boolean isAtomicRenameKey(String key) {\n   }\n \n   private void initializeClient(URI uri, String fileSystemName,\n-      String accountName, boolean isSecure, AbfsCounters abfsCounters)\n+      String accountName, boolean isSecure)", "originalCommit": "4bafb6af593683476bbfdfdabf503caa5d35838e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "13f9ceebb40c63fb98fd988a9c3263bdc45b0863", "url": "https://github.com/apache/hadoop/commit/13f9ceebb40c63fb98fd988a9c3263bdc45b0863", "message": "HADOOP-17194. Splitting the builder and context class.", "committedDate": "2020-08-24T12:01:42Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzQyNzY4OA==", "url": "https://github.com/apache/hadoop/pull/2216#discussion_r477427688", "bodyText": "you can make this package private now, as nobody should be creating directly", "author": "steveloughran", "createdAt": "2020-08-26T16:22:47Z", "path": "hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/services/AbfsClientContext.java", "diffHunk": "@@ -24,34 +24,17 @@\n  */\n public class AbfsClientContext {\n \n-  private ExponentialRetryPolicy exponentialRetryPolicy;\n-  private AbfsPerfTracker abfsPerfTracker;\n-  private AbfsCounters abfsCounters;\n-\n-  public AbfsClientContext withExponentialRetryPolicy(\n-      final ExponentialRetryPolicy exponentialRetryPolicy) {\n+  private final ExponentialRetryPolicy exponentialRetryPolicy;\n+  private final AbfsPerfTracker abfsPerfTracker;\n+  private final AbfsCounters abfsCounters;\n+\n+  public AbfsClientContext(", "originalCommit": "13f9ceebb40c63fb98fd988a9c3263bdc45b0863", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "07bf092a072bdb8c327173d54b983727adba361e", "url": "https://github.com/apache/hadoop/commit/07bf092a072bdb8c327173d54b983727adba361e", "message": "HADOOP-17194. making AbfsClientContext constructor package private", "committedDate": "2020-08-27T01:47:39Z", "type": "commit"}]}