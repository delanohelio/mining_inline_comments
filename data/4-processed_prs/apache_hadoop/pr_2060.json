{"pr_number": 2060, "pr_title": "HADOOP-17032. Fix getContentSummary in ViewFileSystem to handle multiple children mountpoints pointing to different filesystems", "pr_createdAt": "2020-06-07T03:00:26Z", "pr_url": "https://github.com/apache/hadoop/pull/2060", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzUwMjQ4Ng==", "url": "https://github.com/apache/hadoop/pull/2060#discussion_r443502486", "bodyText": "The logics here are introduced for InternalDirOfViewFs,\nI feel rather than touching the normal API, you can implement getContentSummary() in InternalDirOfViewFs and have your logic there, That is how all API's which have specific logic for Internal Links are handling. Lets keep the design that way only.\nThe only thing that you would need there is fsState which isn't there as of now, that you can pass through the constructor, In HDFS-15427, it is being passed, so you can utilize that fsState and independently implement it in InternalDirOfViewFs", "author": "ayushtkn", "createdAt": "2020-06-22T11:49:22Z", "path": "hadoop-common-project/hadoop-common/src/main/java/org/apache/hadoop/fs/viewfs/ViewFileSystem.java", "diffHunk": "@@ -850,9 +850,27 @@ public FsServerDefaults getServerDefaults(Path f) throws IOException {\n \n   @Override\n   public ContentSummary getContentSummary(Path f) throws IOException {\n+    return getContentSummaryInternal(f);\n+  }\n+\n+  private ContentSummary getContentSummaryInternal(Path f) throws IOException {\n     InodeTree.ResolveResult<FileSystem> res =\n-      fsState.resolve(getUriPath(f), true);\n-    return res.targetFileSystem.getContentSummary(res.remainingPath);\n+        fsState.resolve(getUriPath(f), true);\n+    if (!res.isInternalDir()) {", "originalCommit": "d1bac1a53a5923e05a25dc0902a1b053fc265575", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzE1NDkwOQ==", "url": "https://github.com/apache/hadoop/pull/2060#discussion_r447154909", "bodyText": "@ayushtkn Thanks for the suggestion. I have moved the logic to InternalDirOfViewFs", "author": "abhishekdas99", "createdAt": "2020-06-29T18:03:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzUwMjQ4Ng=="}], "type": "inlineReview"}, {"oid": "d89b1b6574cdccbc7d05b93c7788d4b4c5974da6", "url": "https://github.com/apache/hadoop/commit/d89b1b6574cdccbc7d05b93c7788d4b4c5974da6", "message": "HADOOP-17032. Fix getContentSummary in ViewFileSystem to handle multiple children mountpoints pointing to different filesystems", "committedDate": "2020-06-29T10:11:20Z", "type": "forcePushed"}, {"oid": "ff235a3a03d0cdf94bef164d4acdecdb963a0ae2", "url": "https://github.com/apache/hadoop/commit/ff235a3a03d0cdf94bef164d4acdecdb963a0ae2", "message": "HADOOP-17032. Fix getContentSummary in ViewFileSystem to handle multiple children mountpoints pointing to different filesystems", "committedDate": "2020-06-29T18:01:13Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzk5MDg2Mg==", "url": "https://github.com/apache/hadoop/pull/2060#discussion_r447990862", "bodyText": "Will doing just this not work?\n      outputStream.write(expected.getBytes());", "author": "ayushtkn", "createdAt": "2020-06-30T21:30:38Z", "path": "hadoop-common-project/hadoop-common/src/test/java/org/apache/hadoop/fs/viewfs/ViewFileSystemBaseTest.java", "diffHunk": "@@ -1369,4 +1381,61 @@ public void testDeleteOnExit() throws Exception {\n     viewFs.close();\n     assertFalse(fsTarget.exists(realTestPath));\n   }\n+\n+  @Test\n+  public void testGetContentSummary() throws IOException {\n+    ContentSummary summaryBefore =\n+        fsView.getContentSummary(new Path(\"/internalDir\"));\n+    String expected = \"GET CONTENT SUMMARY\";\n+    Path filePath =\n+        new Path(\"/internalDir/internalDir2/linkToDir3\", \"foo\");\n+\n+    try (FSDataOutputStream outputStream = fsView.create(filePath)) {\n+      try (OutputStreamWriter writer =\n+          new OutputStreamWriter(outputStream, StandardCharsets.UTF_8)) {\n+        try (BufferedWriter buffer = new BufferedWriter(writer)) {\n+          buffer.write(expected);\n+        }", "originalCommit": "ff235a3a03d0cdf94bef164d4acdecdb963a0ae2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODAxMTgyNQ==", "url": "https://github.com/apache/hadoop/pull/2060#discussion_r448011825", "bodyText": "Changed", "author": "abhishekdas99", "createdAt": "2020-06-30T22:21:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzk5MDg2Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzk5MTkxOQ==", "url": "https://github.com/apache/hadoop/pull/2060#discussion_r447991919", "bodyText": "nit: There is already a static import -\nimport static org.junit.Assert.*;\n\nno need to have Assert.\nSimilarly for the below test aswell", "author": "ayushtkn", "createdAt": "2020-06-30T21:32:55Z", "path": "hadoop-common-project/hadoop-common/src/test/java/org/apache/hadoop/fs/viewfs/ViewFileSystemBaseTest.java", "diffHunk": "@@ -1369,4 +1381,61 @@ public void testDeleteOnExit() throws Exception {\n     viewFs.close();\n     assertFalse(fsTarget.exists(realTestPath));\n   }\n+\n+  @Test\n+  public void testGetContentSummary() throws IOException {\n+    ContentSummary summaryBefore =\n+        fsView.getContentSummary(new Path(\"/internalDir\"));\n+    String expected = \"GET CONTENT SUMMARY\";\n+    Path filePath =\n+        new Path(\"/internalDir/internalDir2/linkToDir3\", \"foo\");\n+\n+    try (FSDataOutputStream outputStream = fsView.create(filePath)) {\n+      try (OutputStreamWriter writer =\n+          new OutputStreamWriter(outputStream, StandardCharsets.UTF_8)) {\n+        try (BufferedWriter buffer = new BufferedWriter(writer)) {\n+          buffer.write(expected);\n+        }\n+      }\n+    }\n+\n+    Path newDirPath = new Path(\"/internalDir/linkToDir2\", \"bar\");\n+    fsView.mkdirs(newDirPath);\n+\n+    ContentSummary summaryAfter =\n+        fsView.getContentSummary(new Path(\"/internalDir\"));\n+    Assert.assertEquals(\"The file count didn't match\",\n+        summaryBefore.getFileCount() + 1,\n+        summaryAfter.getFileCount());\n+    Assert.assertEquals(\"The size didn't match\",\n+        summaryBefore.getLength() + expected.length(),\n+        summaryAfter.getLength());\n+    Assert.assertEquals(\"The directory count didn't match\",", "originalCommit": "ff235a3a03d0cdf94bef164d4acdecdb963a0ae2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODAxMTc2Ng==", "url": "https://github.com/apache/hadoop/pull/2060#discussion_r448011766", "bodyText": "Removed Assert.", "author": "abhishekdas99", "createdAt": "2020-06-30T22:20:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzk5MTkxOQ=="}], "type": "inlineReview"}, {"oid": "f61e59223b96a5f4d50dbccbbafec6f4a32d974a", "url": "https://github.com/apache/hadoop/commit/f61e59223b96a5f4d50dbccbbafec6f4a32d974a", "message": "HADOOP-17032. Fix getContentSummary in ViewFileSystem to handle multiple children mountpoints pointing to different filesystems", "committedDate": "2020-06-30T22:19:30Z", "type": "forcePushed"}, {"oid": "b53083cad32fd346e0fe39162514b4eb40a07a2e", "url": "https://github.com/apache/hadoop/commit/b53083cad32fd346e0fe39162514b4eb40a07a2e", "message": "HADOOP-17032. Fix getContentSummary in ViewFileSystem to handle multiple children mountpoints pointing to different filesystems", "committedDate": "2020-07-01T01:02:16Z", "type": "commit"}, {"oid": "b53083cad32fd346e0fe39162514b4eb40a07a2e", "url": "https://github.com/apache/hadoop/commit/b53083cad32fd346e0fe39162514b4eb40a07a2e", "message": "HADOOP-17032. Fix getContentSummary in ViewFileSystem to handle multiple children mountpoints pointing to different filesystems", "committedDate": "2020-07-01T01:02:16Z", "type": "forcePushed"}]}