{"pr_number": 1977, "pr_title": "HADOOP-17010. Add queue capacity support for FairCallQueue", "pr_createdAt": "2020-04-24T23:55:25Z", "pr_url": "https://github.com/apache/hadoop/pull/1977", "timeline": [{"oid": "28f94e468f3751bccac770474ccf70d987217ea7", "url": "https://github.com/apache/hadoop/commit/28f94e468f3751bccac770474ccf70d987217ea7", "message": "Add queue capacity support for FairCallQueue", "committedDate": "2020-04-24T23:53:54Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjAwMTIxNw==", "url": "https://github.com/apache/hadoop/pull/1977#discussion_r416001217", "bodyText": "what if user passes in negative numbers as weights? should we add a safe guard against that?", "author": "sunchao", "createdAt": "2020-04-27T17:20:36Z", "path": "hadoop-common-project/hadoop-common/src/main/java/org/apache/hadoop/ipc/FairCallQueue.java", "diffHunk": "@@ -101,11 +111,18 @@ public FairCallQueue(int priorityLevels, int capacity, String ns,\n \n     this.queues = new ArrayList<BlockingQueue<E>>(numQueues);\n     this.overflowedCalls = new ArrayList<AtomicLong>(numQueues);\n-    int queueCapacity = capacity / numQueues;\n-    int capacityForFirstQueue = queueCapacity + (capacity % numQueues);\n+    int totalWeights = 0;\n+    for (int i = 0; i < capacityWeights.length; i++) {", "originalCommit": "28f94e468f3751bccac770474ccf70d987217ea7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjAwMTQzNQ==", "url": "https://github.com/apache/hadoop/pull/1977#discussion_r416001435", "bodyText": "maybe make it explicit only positive numbers are allowed?", "author": "sunchao", "createdAt": "2020-04-27T17:20:57Z", "path": "hadoop-common-project/hadoop-common/src/site/markdown/FairCallQueue.md", "diffHunk": "@@ -126,6 +126,7 @@ omitted.\n |:---- |:---- |:---- |:--- |\n | backoff.enable | General | Whether or not to enable client backoff when a queue is full. | false |\n | callqueue.impl | General | The fully qualified name of a class to use as the implementation of a call queue. Use `org.apache.hadoop.ipc.FairCallQueue` for the Fair Call Queue. | `java.util.concurrent.LinkedBlockingQueue` (FIFO queue) |\n+| callqueue.capacity.weights | General | The capacity allocation weights among all subqueues. A int array whose length is equal to the `scheduler.priority.levels` is expected where each int is the relative weight out of total capacity. i.e. if a queue with capacity weight `w`, its queue capacity is `capacity * w/sum(weights)` |", "originalCommit": "28f94e468f3751bccac770474ccf70d987217ea7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjAwMTY1OQ==", "url": "https://github.com/apache/hadoop/pull/1977#discussion_r416001659", "bodyText": "nit: add a blank line between this and the first parameter line.", "author": "sunchao", "createdAt": "2020-04-27T17:21:14Z", "path": "hadoop-common-project/hadoop-common/src/main/java/org/apache/hadoop/ipc/CallQueueManager.java", "diffHunk": "@@ -343,6 +347,36 @@ private static int parseNumLevels(String ns, Configuration conf) {\n     return retval;\n   }\n \n+  /**\n+   * Read the weights of capacity in callqueue and pass the value to\n+   * callqueue constructions.\n+   */\n+  private static int[] parseCapacityWeights(\n+      int priorityLevels, String ns, Configuration conf) {\n+    int[] weights = conf.getInts(ns + \".\" +\n+      CommonConfigurationKeys.IPC_CALLQUEUE_CAPACITY_WEIGHTS_KEY);\n+    if (weights.length == 0) {\n+      weights = getDefaultQueueCapacityWeights(priorityLevels);\n+    } else if (weights.length != priorityLevels) {\n+      throw new IllegalArgumentException(\n+          CommonConfigurationKeys.IPC_CALLQUEUE_CAPACITY_WEIGHTS_KEY + \" must \"\n+              + \"specify \" + priorityLevels + \" capacity weights: one for each \"\n+              + \"priority level\");\n+    }\n+    return weights;\n+  }\n+\n+  /**\n+   * By default, queue capacity is the same for all priority levels.", "originalCommit": "28f94e468f3751bccac770474ccf70d987217ea7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "eefb949ba2f2164cff25d5bdf410485eb0862aa7", "url": "https://github.com/apache/hadoop/commit/eefb949ba2f2164cff25d5bdf410485eb0862aa7", "message": "Add positive weight limit", "committedDate": "2020-04-27T20:51:36Z", "type": "commit"}]}