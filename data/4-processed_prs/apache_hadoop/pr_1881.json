{"pr_number": 1881, "pr_title": "HADOOP-16910 Adding file system counters in ABFS", "pr_createdAt": "2020-03-06T07:54:36Z", "pr_url": "https://github.com/apache/hadoop/pull/1881", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODg1NDc0Mg==", "url": "https://github.com/apache/hadoop/pull/1881#discussion_r388854742", "bodyText": "nit: topmost import block", "author": "steveloughran", "createdAt": "2020-03-06T11:34:25Z", "path": "hadoop-tools/hadoop-azure/src/test/java/org/apache/hadoop/fs/azurebfs/AbstractAbfsTestWithTimeout.java", "diffHunk": "@@ -17,12 +17,19 @@\n  */\n package org.apache.hadoop.fs.azurebfs;\n \n+import org.apache.hadoop.fs.FSDataInputStream;\n+import org.apache.hadoop.fs.Path;\n import org.junit.Assert;\n import org.junit.Before;\n import org.junit.BeforeClass;\n import org.junit.Rule;\n import org.junit.rules.TestName;\n import org.junit.rules.Timeout;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.io.IOException;", "originalCommit": "bba6f319bc157593ac9b89c37d9b874c6c3b0f3f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODg1NDg3Ng==", "url": "https://github.com/apache/hadoop/pull/1881#discussion_r388854876", "bodyText": "nit: should be in its own block after the non org-apache-hadoop imports", "author": "steveloughran", "createdAt": "2020-03-06T11:34:44Z", "path": "hadoop-tools/hadoop-azure/src/test/java/org/apache/hadoop/fs/azurebfs/AbstractAbfsTestWithTimeout.java", "diffHunk": "@@ -17,12 +17,19 @@\n  */\n package org.apache.hadoop.fs.azurebfs;\n \n+import org.apache.hadoop.fs.FSDataInputStream;", "originalCommit": "bba6f319bc157593ac9b89c37d9b874c6c3b0f3f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODg1NTAzMQ==", "url": "https://github.com/apache/hadoop/pull/1881#discussion_r388855031", "bodyText": "nit: add a trailing . to keep javadoc happy", "author": "steveloughran", "createdAt": "2020-03-06T11:35:09Z", "path": "hadoop-tools/hadoop-azure/src/test/java/org/apache/hadoop/fs/azurebfs/AbstractAbfsTestWithTimeout.java", "diffHunk": "@@ -67,4 +77,42 @@ public void nameThread() {\n   protected int getTestTimeoutMillis() {\n     return TEST_TIMEOUT;\n   }\n+\n+  /**\n+   * Describe a test in the logs.\n+   *\n+   * @param text text to print\n+   * @param args arguments to format in the printing\n+   */\n+  protected void describe(String text, Object... args) {\n+    LOG.info(\"\\n\\n{}: {}\\n\",\n+        methodName.getMethodName(),\n+        String.format(text, args));\n+  }\n+\n+  /**\n+   * Validate Contents written on a file in Abfs", "originalCommit": "bba6f319bc157593ac9b89c37d9b874c6c3b0f3f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODg1NTQ5OA==", "url": "https://github.com/apache/hadoop/pull/1881#discussion_r388855498", "bodyText": "nit: trailing .", "author": "steveloughran", "createdAt": "2020-03-06T11:36:14Z", "path": "hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/services/AbfsInputStream.java", "diffHunk": "@@ -252,6 +255,13 @@ int readRemote(long position, byte[] b, int offset, int length) throws IOExcepti\n     return (int) bytesRead;\n   }\n \n+  /**\n+   * Increment Read Operations", "originalCommit": "bba6f319bc157593ac9b89c37d9b874c6c3b0f3f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODg1NjEzMw==", "url": "https://github.com/apache/hadoop/pull/1881#discussion_r388856133", "bodyText": "read() always moves the stream forward, so you don't need these seek/seekPos++; they can only slow things down", "author": "steveloughran", "createdAt": "2020-03-06T11:37:53Z", "path": "hadoop-tools/hadoop-azure/src/test/java/org/apache/hadoop/fs/azurebfs/AbstractAbfsTestWithTimeout.java", "diffHunk": "@@ -67,4 +77,42 @@ public void nameThread() {\n   protected int getTestTimeoutMillis() {\n     return TEST_TIMEOUT;\n   }\n+\n+  /**\n+   * Describe a test in the logs.\n+   *\n+   * @param text text to print\n+   * @param args arguments to format in the printing\n+   */\n+  protected void describe(String text, Object... args) {\n+    LOG.info(\"\\n\\n{}: {}\\n\",\n+        methodName.getMethodName(),\n+        String.format(text, args));\n+  }\n+\n+  /**\n+   * Validate Contents written on a file in Abfs\n+   *\n+   * @param fs AzureBlobFileSystem\n+   * @param path Path of the file\n+   * @param originalByteArray original byte array\n+   * @return\n+   * @throws IOException\n+   */\n+  protected boolean validateContent(AzureBlobFileSystem fs, Path path,\n+      byte[] originalByteArray)\n+      throws IOException {\n+    FSDataInputStream in = fs.open(path);\n+    byte[] contentByteArray = new byte[originalByteArray.length];\n+    int seekPos = 0;\n+    while (in.read() != -1) {", "originalCommit": "bba6f319bc157593ac9b89c37d9b874c6c3b0f3f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODk0MDkxMw==", "url": "https://github.com/apache/hadoop/pull/1881#discussion_r388940913", "bodyText": "I will still need seekPos for indexing of contentByteArray..\nseek() is however an extra method call, I can compare byte by byte with originalByteArray ?\nSomething like this ,maybe ?\nwhile (valueOfContentAtPos != -1 && pos < lenOfOriginalByteArray) {\n      if (originalByteArray[pos] != valueOfContentAtPos)\n        return false;\n      valueOfContentAtPos = (byte) in.read();\n      pos++;\n    }\n    if (valueOfContentAtPos != -1)\n      return false;\n    return true;", "author": "mehakmeet", "createdAt": "2020-03-06T14:42:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODg1NjEzMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTYxMjE1NQ==", "url": "https://github.com/apache/hadoop/pull/1881#discussion_r389612155", "bodyText": "Yes this will be a better approach as it will take less time and space. Also as Steve suggested you don't need seek() here as read() maintains its own pointer. Also seek() is a very slow operation.", "author": "mukund-thakur", "createdAt": "2020-03-09T11:51:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODg1NjEzMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODg1NjYwNA==", "url": "https://github.com/apache/hadoop/pull/1881#discussion_r388856604", "bodyText": "add a test for writes here too", "author": "steveloughran", "createdAt": "2020-03-06T11:39:06Z", "path": "hadoop-tools/hadoop-azure/src/test/java/org/apache/hadoop/fs/azurebfs/ITestAbfsInputStream.java", "diffHunk": "@@ -0,0 +1,81 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ * <p>\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ * <p>\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hadoop.fs.azurebfs;\n+\n+import org.junit.Assert;\n+import org.junit.Test;\n+\n+import org.apache.hadoop.fs.FSDataOutputStream;\n+import org.apache.hadoop.fs.FSDataInputStream;\n+import org.apache.hadoop.fs.FileSystem;\n+import org.apache.hadoop.fs.Path;\n+import org.apache.hadoop.fs.azurebfs.services.AbfsInputStream;\n+\n+/**\n+ * Test Abfs Input Stream.\n+ */\n+\n+public class ITestAbfsInputStream extends AbstractAbfsIntegrationTest {\n+  public ITestAbfsInputStream() throws Exception {\n+  }\n+\n+  /***\n+   * {@link AbfsInputStream#incrementReadOps()}\n+   *\n+   * @throws Exception\n+   */\n+  @Test\n+  public void testAbfsInputStreamReadOps() throws Exception {\n+    describe(\"Test to see correct population of Read operations in Abfs\");\n+\n+    final AzureBlobFileSystem fs = getFileSystem();\n+    Path smallFile = new Path(\"testOneReadCall\");\n+    Path largeFile = new Path(\"testLargeReadCalls\");\n+    FileSystem.Statistics statistics = fs.getFsStatistics();\n+    String testReadOps = \"test this\";\n+    statistics.reset();\n+\n+    //Test for zero read operation\n+    Assert.assertEquals(0, statistics.getReadOps());\n+\n+    FSDataOutputStream outForOneCall = fs.create(smallFile);\n+    statistics.reset();\n+    outForOneCall.write(testReadOps.getBytes());", "originalCommit": "bba6f319bc157593ac9b89c37d9b874c6c3b0f3f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODg1NzA3Nw==", "url": "https://github.com/apache/hadoop/pull/1881#discussion_r388857077", "bodyText": "does this really create large reads? it's still only small amounts of data", "author": "steveloughran", "createdAt": "2020-03-06T11:40:18Z", "path": "hadoop-tools/hadoop-azure/src/test/java/org/apache/hadoop/fs/azurebfs/ITestAbfsInputStream.java", "diffHunk": "@@ -0,0 +1,81 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ * <p>\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ * <p>\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hadoop.fs.azurebfs;\n+\n+import org.junit.Assert;\n+import org.junit.Test;\n+\n+import org.apache.hadoop.fs.FSDataOutputStream;\n+import org.apache.hadoop.fs.FSDataInputStream;\n+import org.apache.hadoop.fs.FileSystem;\n+import org.apache.hadoop.fs.Path;\n+import org.apache.hadoop.fs.azurebfs.services.AbfsInputStream;\n+\n+/**\n+ * Test Abfs Input Stream.\n+ */\n+\n+public class ITestAbfsInputStream extends AbstractAbfsIntegrationTest {\n+  public ITestAbfsInputStream() throws Exception {\n+  }\n+\n+  /***\n+   * {@link AbfsInputStream#incrementReadOps()}\n+   *\n+   * @throws Exception\n+   */\n+  @Test\n+  public void testAbfsInputStreamReadOps() throws Exception {\n+    describe(\"Test to see correct population of Read operations in Abfs\");\n+\n+    final AzureBlobFileSystem fs = getFileSystem();\n+    Path smallFile = new Path(\"testOneReadCall\");\n+    Path largeFile = new Path(\"testLargeReadCalls\");\n+    FileSystem.Statistics statistics = fs.getFsStatistics();\n+    String testReadOps = \"test this\";\n+    statistics.reset();\n+\n+    //Test for zero read operation\n+    Assert.assertEquals(0, statistics.getReadOps());\n+\n+    FSDataOutputStream outForOneCall = fs.create(smallFile);\n+    statistics.reset();\n+    outForOneCall.write(testReadOps.getBytes());\n+    FSDataInputStream inForOneCall = fs.open(smallFile);\n+    inForOneCall.read(testReadOps.getBytes(), 0, testReadOps.getBytes().length);\n+\n+    //Test for one read operation\n+    Assert.assertEquals(1, statistics.getReadOps());\n+\n+    FSDataOutputStream outForLargeCalls = fs.create(largeFile);", "originalCommit": "bba6f319bc157593ac9b89c37d9b874c6c3b0f3f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTM3MDA4OQ==", "url": "https://github.com/apache/hadoop/pull/1881#discussion_r389370089", "bodyText": "meant to show Large number of operations rather than large read I think. I'll change the name for better understanding. still 1000 ops does seem small. I'll increase to 10^6 read and write ops then ?", "author": "mehakmeet", "createdAt": "2020-03-08T13:34:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODg1NzA3Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODg1ODY3OQ==", "url": "https://github.com/apache/hadoop/pull/1881#discussion_r388858679", "bodyText": "nit, add a space after the comma", "author": "steveloughran", "createdAt": "2020-03-06T11:44:20Z", "path": "hadoop-tools/hadoop-azure/src/test/java/org/apache/hadoop/fs/azurebfs/ITestAzureBlobFileSystemOauth.java", "diffHunk": "@@ -143,7 +143,7 @@ public void testBlobDataReader() throws Exception {\n \n     // TEST WRITE FILE\n     try {\n-      abfsStore.openFileForWrite(EXISTED_FILE_PATH, true);\n+      abfsStore.openFileForWrite(EXISTED_FILE_PATH, fs.getFsStatistics(),true);", "originalCommit": "bba6f319bc157593ac9b89c37d9b874c6c3b0f3f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTYxNjA0Mg==", "url": "https://github.com/apache/hadoop/pull/1881#discussion_r389616042", "bodyText": "@mehakmeet  You can check the checkstyle errors produced by Apache Yetus run and fix those before actual code review. https://builds.apache.org/job/hadoop-multibranch/job/PR-1881/1/artifact/out/diff-checkstyle-hadoop-tools_hadoop-azure.txt", "author": "mukund-thakur", "createdAt": "2020-03-09T11:59:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODg1ODY3OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODg1ODc2Mg==", "url": "https://github.com/apache/hadoop/pull/1881#discussion_r388858762", "bodyText": "This is a good test.\nIf you call it ITestAbfsStreamStatistics you can test the writes as well as the reads -and you should test those writes already in the test suite.. If you put the write ops test there, into a single test suite, backporting is easier -less conflict.\nFor the assertions, I'd like every assert to have some meaningful string,\nassertEquals(\"read ops\", 1000, statistics.getReadOps)\nImagine \"what would you want in the error text if this failed on a jenkins run\"?", "author": "steveloughran", "createdAt": "2020-03-06T11:44:35Z", "path": "hadoop-tools/hadoop-azure/src/test/java/org/apache/hadoop/fs/azurebfs/ITestAbfsInputStream.java", "diffHunk": "@@ -0,0 +1,81 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ * <p>\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ * <p>\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hadoop.fs.azurebfs;\n+\n+import org.junit.Assert;\n+import org.junit.Test;\n+\n+import org.apache.hadoop.fs.FSDataOutputStream;\n+import org.apache.hadoop.fs.FSDataInputStream;\n+import org.apache.hadoop.fs.FileSystem;\n+import org.apache.hadoop.fs.Path;\n+import org.apache.hadoop.fs.azurebfs.services.AbfsInputStream;\n+\n+/**\n+ * Test Abfs Input Stream.\n+ */\n+\n+public class ITestAbfsInputStream extends AbstractAbfsIntegrationTest {", "originalCommit": "bba6f319bc157593ac9b89c37d9b874c6c3b0f3f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTM2NDU2Ng==", "url": "https://github.com/apache/hadoop/pull/1881#discussion_r389364566", "bodyText": "So, I guess 1 test method would be enough to check both read and write operations in all 3 conditions.", "author": "mehakmeet", "createdAt": "2020-03-08T12:28:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODg1ODc2Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODg1ODk0OA==", "url": "https://github.com/apache/hadoop/pull/1881#discussion_r388858948", "bodyText": "nit: this line is long enough its time to split", "author": "steveloughran", "createdAt": "2020-03-06T11:45:05Z", "path": "hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/AzureBlobFileSystemStore.java", "diffHunk": "@@ -392,7 +392,7 @@ public void deleteFilesystem() throws AzureBlobFileSystemException {\n     }\n   }\n \n-  public OutputStream createFile(final Path path, final boolean overwrite, final FsPermission permission,\n+  public OutputStream createFile(final Path path, final FileSystem.Statistics statistics, final boolean overwrite, final FsPermission permission,", "originalCommit": "bba6f319bc157593ac9b89c37d9b874c6c3b0f3f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODg1OTY1MQ==", "url": "https://github.com/apache/hadoop/pull/1881#discussion_r388859651", "bodyText": "move into the same tests as the reads for ease of backports", "author": "steveloughran", "createdAt": "2020-03-06T11:46:54Z", "path": "hadoop-tools/hadoop-azure/src/test/java/org/apache/hadoop/fs/azurebfs/ITestAzureBlobFileSystemCreate.java", "diffHunk": "@@ -59,6 +62,59 @@ public void testEnsureFileCreatedImmediately() throws Exception {\n     assertIsFile(fs, TEST_FILE_PATH);\n   }\n \n+  /**\n+   * {@link AbfsOutputStream#incrementWriteOps()}\n+   *\n+   * @throws Exception\n+   */\n+  @Test\n+  public void testWriteOpsMetric() throws Exception {", "originalCommit": "bba6f319bc157593ac9b89c37d9b874c6c3b0f3f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTM2NTQ3Mw==", "url": "https://github.com/apache/hadoop/pull/1881#discussion_r389365473", "bodyText": "I'll remove this test and add write operations and validating tests in testAbfsInputStreamReadOps(change it's name to testAbfsStreamOps) ?", "author": "mehakmeet", "createdAt": "2020-03-08T12:39:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODg1OTY1MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTYxNDYxNg==", "url": "https://github.com/apache/hadoop/pull/1881#discussion_r389614616", "bodyText": "All assert calls should have meaningful message as suggested by Steve. This is important for debugging test failures easily. You can check the examples in PR I sent you.\nSorry I missed this in internal review. :)", "author": "mukund-thakur", "createdAt": "2020-03-09T11:56:48Z", "path": "hadoop-tools/hadoop-azure/src/test/java/org/apache/hadoop/fs/azurebfs/ITestAzureBlobFileSystemCreate.java", "diffHunk": "@@ -59,6 +62,59 @@ public void testEnsureFileCreatedImmediately() throws Exception {\n     assertIsFile(fs, TEST_FILE_PATH);\n   }\n \n+  /**\n+   * {@link AbfsOutputStream#incrementWriteOps()}\n+   *\n+   * @throws Exception\n+   */\n+  @Test\n+  public void testWriteOpsMetric() throws Exception {\n+    describe(\"Test to see correct population of write operations in Abfs\");\n+    final AzureBlobFileSystem fs = getFileSystem();\n+    Path smallFile = new Path(\"testOneCall\");\n+    Path largeFile = new Path(\"testLargeCalls\");\n+    String testWriteOps = \"test\";\n+    FileSystem.Statistics statistics = fs.getFsStatistics();\n+    statistics.reset();\n+\n+    //Test for zero write operation\n+    Assert.assertEquals(0, statistics.getWriteOps());\n+\n+    FSDataOutputStream outForOneCall = fs.create(smallFile);\n+    statistics.reset();\n+    //Writing \"test\" 1 time\n+    outForOneCall\n+        .write(testWriteOps.getBytes(), 0, testWriteOps.getBytes().length);\n+\n+    //Test for one write operation\n+    Assert.assertEquals(1, statistics.getWriteOps());", "originalCommit": "bba6f319bc157593ac9b89c37d9b874c6c3b0f3f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDQ5NDI1NQ==", "url": "https://github.com/apache/hadoop/pull/1881#discussion_r390494255", "bodyText": "Noted.", "author": "mehakmeet", "createdAt": "2020-03-10T17:40:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTYxNDYxNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDQ5MzkzNg==", "url": "https://github.com/apache/hadoop/pull/1881#discussion_r390493936", "bodyText": "Will be using StringBuilder here and use append() istead of += for String concatenation.", "author": "mehakmeet", "createdAt": "2020-03-10T17:39:52Z", "path": "hadoop-tools/hadoop-azure/src/test/java/org/apache/hadoop/fs/azurebfs/ITestAzureBlobFileSystemCreate.java", "diffHunk": "@@ -59,6 +62,59 @@ public void testEnsureFileCreatedImmediately() throws Exception {\n     assertIsFile(fs, TEST_FILE_PATH);\n   }\n \n+  /**\n+   * {@link AbfsOutputStream#incrementWriteOps()}\n+   *\n+   * @throws Exception\n+   */\n+  @Test\n+  public void testWriteOpsMetric() throws Exception {\n+    describe(\"Test to see correct population of write operations in Abfs\");\n+    final AzureBlobFileSystem fs = getFileSystem();\n+    Path smallFile = new Path(\"testOneCall\");\n+    Path largeFile = new Path(\"testLargeCalls\");\n+    String testWriteOps = \"test\";\n+    FileSystem.Statistics statistics = fs.getFsStatistics();\n+    statistics.reset();\n+\n+    //Test for zero write operation\n+    Assert.assertEquals(0, statistics.getWriteOps());\n+\n+    FSDataOutputStream outForOneCall = fs.create(smallFile);\n+    statistics.reset();\n+    //Writing \"test\" 1 time\n+    outForOneCall\n+        .write(testWriteOps.getBytes(), 0, testWriteOps.getBytes().length);\n+\n+    //Test for one write operation\n+    Assert.assertEquals(1, statistics.getWriteOps());\n+\n+    outForOneCall.close();\n+    //validating Content of file\n+    Assert.assertEquals(true, validateContent(fs, smallFile,\n+        testWriteOps.getBytes()));\n+\n+    String largeFileValidationString = \"\";\n+    FSDataOutputStream outForLargeCalls = fs.create(largeFile);\n+    statistics.reset();\n+    //Writing \"test\" 1000 times\n+    for (int i = 0; i < 1000; i++) {\n+      outForLargeCalls.write(testWriteOps.getBytes(), 0,\n+          testWriteOps.getBytes().length);\n+\n+      //Creating Validation string of \"test\" 1000 times\n+      largeFileValidationString += testWriteOps;", "originalCommit": "bba6f319bc157593ac9b89c37d9b874c6c3b0f3f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTYwMjMwNg==", "url": "https://github.com/apache/hadoop/pull/1881#discussion_r391602306", "bodyText": "Change to \"Mismatch in read operation count.\"", "author": "mukund-thakur", "createdAt": "2020-03-12T12:58:09Z", "path": "hadoop-tools/hadoop-azure/src/test/java/org/apache/hadoop/fs/azurebfs/ITestAbfsStreamStatistics.java", "diffHunk": "@@ -0,0 +1,109 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ * <p>\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ * <p>\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hadoop.fs.azurebfs;\n+\n+import org.junit.Assert;\n+import org.junit.Test;\n+\n+import org.apache.hadoop.fs.FSDataOutputStream;\n+import org.apache.hadoop.fs.FSDataInputStream;\n+import org.apache.hadoop.fs.FileSystem;\n+import org.apache.hadoop.fs.Path;\n+import org.apache.hadoop.fs.azurebfs.services.AbfsInputStream;\n+\n+/**\n+ * Test Abfs Stream.\n+ */\n+\n+public class ITestAbfsStreamStatistics extends AbstractAbfsIntegrationTest {\n+  public ITestAbfsStreamStatistics() throws Exception {\n+  }\n+\n+  /***\n+   * {@link AbfsInputStream#incrementReadOps()}.\n+   *\n+   * @throws Exception\n+   */\n+  @Test\n+  public void testAbfsStreamOps() throws Exception {\n+    describe(\"Test to see correct population of read and write operations in \"\n+        + \"Abfs\");\n+\n+    final AzureBlobFileSystem fs = getFileSystem();\n+    Path smallOperaionsFile = new Path(\"testOneReadWriteOps\");\n+    Path largeOperationsFile = new Path(\"testLargeReadWriteOps\");\n+    FileSystem.Statistics statistics = fs.getFsStatistics();\n+    String testReadWriteOps = \"test this\";\n+    statistics.reset();\n+\n+    //Test for zero read and write operation\n+    Assert.assertEquals(\"Zero read operations\", 0, statistics.getReadOps());\n+    Assert.assertEquals(\"Zero write operations\", 0, statistics.getWriteOps());\n+\n+    FSDataOutputStream outForOneOperation = fs.create(smallOperaionsFile);\n+    statistics.reset();\n+    outForOneOperation.write(testReadWriteOps.getBytes());\n+    FSDataInputStream inForOneCall = fs.open(smallOperaionsFile);\n+    inForOneCall.read(testReadWriteOps.getBytes(), 0,\n+        testReadWriteOps.getBytes().length);\n+\n+    //Test for one read and write operation\n+    Assert.assertEquals(\"one read operation is performed\", 1,", "originalCommit": "e3fff8808f25b1424814d55a26d1ac731811882d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTYwMjU5NA==", "url": "https://github.com/apache/hadoop/pull/1881#discussion_r391602594", "bodyText": "Same here.", "author": "mukund-thakur", "createdAt": "2020-03-12T12:58:40Z", "path": "hadoop-tools/hadoop-azure/src/test/java/org/apache/hadoop/fs/azurebfs/ITestAbfsStreamStatistics.java", "diffHunk": "@@ -0,0 +1,109 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ * <p>\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ * <p>\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hadoop.fs.azurebfs;\n+\n+import org.junit.Assert;\n+import org.junit.Test;\n+\n+import org.apache.hadoop.fs.FSDataOutputStream;\n+import org.apache.hadoop.fs.FSDataInputStream;\n+import org.apache.hadoop.fs.FileSystem;\n+import org.apache.hadoop.fs.Path;\n+import org.apache.hadoop.fs.azurebfs.services.AbfsInputStream;\n+\n+/**\n+ * Test Abfs Stream.\n+ */\n+\n+public class ITestAbfsStreamStatistics extends AbstractAbfsIntegrationTest {\n+  public ITestAbfsStreamStatistics() throws Exception {\n+  }\n+\n+  /***\n+   * {@link AbfsInputStream#incrementReadOps()}.\n+   *\n+   * @throws Exception\n+   */\n+  @Test\n+  public void testAbfsStreamOps() throws Exception {\n+    describe(\"Test to see correct population of read and write operations in \"\n+        + \"Abfs\");\n+\n+    final AzureBlobFileSystem fs = getFileSystem();\n+    Path smallOperaionsFile = new Path(\"testOneReadWriteOps\");\n+    Path largeOperationsFile = new Path(\"testLargeReadWriteOps\");\n+    FileSystem.Statistics statistics = fs.getFsStatistics();\n+    String testReadWriteOps = \"test this\";\n+    statistics.reset();\n+\n+    //Test for zero read and write operation\n+    Assert.assertEquals(\"Zero read operations\", 0, statistics.getReadOps());\n+    Assert.assertEquals(\"Zero write operations\", 0, statistics.getWriteOps());\n+\n+    FSDataOutputStream outForOneOperation = fs.create(smallOperaionsFile);\n+    statistics.reset();\n+    outForOneOperation.write(testReadWriteOps.getBytes());\n+    FSDataInputStream inForOneCall = fs.open(smallOperaionsFile);\n+    inForOneCall.read(testReadWriteOps.getBytes(), 0,\n+        testReadWriteOps.getBytes().length);\n+\n+    //Test for one read and write operation\n+    Assert.assertEquals(\"one read operation is performed\", 1,\n+        statistics.getReadOps());\n+    Assert.assertEquals(\"one write operation is performed\", 1,\n+        statistics.getWriteOps());\n+\n+    outForOneOperation.close();\n+    //validating Content of file\n+    Assert.assertEquals(\"one operation Content validation\", true,\n+        validateContent(fs, smallOperaionsFile,\n+            testReadWriteOps.getBytes()));\n+\n+    FSDataOutputStream outForLargeOperations = fs.create(largeOperationsFile);\n+    statistics.reset();\n+\n+    StringBuilder largeOperationsValidationString = new StringBuilder();\n+    for (int i = 0; i < 1000000; i++) {\n+      outForLargeOperations.write(testReadWriteOps.getBytes());\n+\n+      //Creating the String for content Validation\n+      largeOperationsValidationString.append(testReadWriteOps);\n+    }\n+\n+    FSDataInputStream inForLargeCalls = fs.open(largeOperationsFile);\n+\n+    for (int i = 0; i < 1000000; i++)\n+      inForLargeCalls\n+          .read(testReadWriteOps.getBytes(), 0,\n+              testReadWriteOps.getBytes().length);\n+\n+    //Test for one million read and write operations\n+    Assert.assertEquals(\"Large read operations\", 1000000,", "originalCommit": "e3fff8808f25b1424814d55a26d1ac731811882d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTYxMzAzOQ==", "url": "https://github.com/apache/hadoop/pull/1881#discussion_r391613039", "bodyText": "Will both 1 op error and 1000 ops error have same message ?", "author": "mehakmeet", "createdAt": "2020-03-12T13:17:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTYwMjU5NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTYxMzkzMg==", "url": "https://github.com/apache/hadoop/pull/1881#discussion_r391613932", "bodyText": "yes.", "author": "mukund-thakur", "createdAt": "2020-03-12T13:19:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTYwMjU5NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTYwMjc3MA==", "url": "https://github.com/apache/hadoop/pull/1881#discussion_r391602770", "bodyText": "Mismatch in file content.", "author": "mukund-thakur", "createdAt": "2020-03-12T12:58:58Z", "path": "hadoop-tools/hadoop-azure/src/test/java/org/apache/hadoop/fs/azurebfs/ITestAbfsStreamStatistics.java", "diffHunk": "@@ -0,0 +1,109 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ * <p>\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ * <p>\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hadoop.fs.azurebfs;\n+\n+import org.junit.Assert;\n+import org.junit.Test;\n+\n+import org.apache.hadoop.fs.FSDataOutputStream;\n+import org.apache.hadoop.fs.FSDataInputStream;\n+import org.apache.hadoop.fs.FileSystem;\n+import org.apache.hadoop.fs.Path;\n+import org.apache.hadoop.fs.azurebfs.services.AbfsInputStream;\n+\n+/**\n+ * Test Abfs Stream.\n+ */\n+\n+public class ITestAbfsStreamStatistics extends AbstractAbfsIntegrationTest {\n+  public ITestAbfsStreamStatistics() throws Exception {\n+  }\n+\n+  /***\n+   * {@link AbfsInputStream#incrementReadOps()}.\n+   *\n+   * @throws Exception\n+   */\n+  @Test\n+  public void testAbfsStreamOps() throws Exception {\n+    describe(\"Test to see correct population of read and write operations in \"\n+        + \"Abfs\");\n+\n+    final AzureBlobFileSystem fs = getFileSystem();\n+    Path smallOperaionsFile = new Path(\"testOneReadWriteOps\");\n+    Path largeOperationsFile = new Path(\"testLargeReadWriteOps\");\n+    FileSystem.Statistics statistics = fs.getFsStatistics();\n+    String testReadWriteOps = \"test this\";\n+    statistics.reset();\n+\n+    //Test for zero read and write operation\n+    Assert.assertEquals(\"Zero read operations\", 0, statistics.getReadOps());\n+    Assert.assertEquals(\"Zero write operations\", 0, statistics.getWriteOps());\n+\n+    FSDataOutputStream outForOneOperation = fs.create(smallOperaionsFile);\n+    statistics.reset();\n+    outForOneOperation.write(testReadWriteOps.getBytes());\n+    FSDataInputStream inForOneCall = fs.open(smallOperaionsFile);\n+    inForOneCall.read(testReadWriteOps.getBytes(), 0,\n+        testReadWriteOps.getBytes().length);\n+\n+    //Test for one read and write operation\n+    Assert.assertEquals(\"one read operation is performed\", 1,\n+        statistics.getReadOps());\n+    Assert.assertEquals(\"one write operation is performed\", 1,\n+        statistics.getWriteOps());\n+\n+    outForOneOperation.close();\n+    //validating Content of file\n+    Assert.assertEquals(\"one operation Content validation\", true,", "originalCommit": "e3fff8808f25b1424814d55a26d1ac731811882d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTc4NjA3Nw==", "url": "https://github.com/apache/hadoop/pull/1881#discussion_r391786077", "bodyText": "just saw this typo. will fix it in the next commit.", "author": "mehakmeet", "createdAt": "2020-03-12T17:40:28Z", "path": "hadoop-tools/hadoop-azure/src/test/java/org/apache/hadoop/fs/azurebfs/ITestAbfsStreamStatistics.java", "diffHunk": "@@ -0,0 +1,111 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ * <p>\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ * <p>\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hadoop.fs.azurebfs;\n+\n+import org.junit.Assert;\n+import org.junit.Test;\n+\n+import org.apache.hadoop.fs.FSDataOutputStream;\n+import org.apache.hadoop.fs.FSDataInputStream;\n+import org.apache.hadoop.fs.FileSystem;\n+import org.apache.hadoop.fs.Path;\n+import org.apache.hadoop.fs.azurebfs.services.AbfsInputStream;\n+\n+/**\n+ * Test Abfs Stream.\n+ */\n+\n+public class ITestAbfsStreamStatistics extends AbstractAbfsIntegrationTest {\n+  public ITestAbfsStreamStatistics() throws Exception {\n+  }\n+\n+  /***\n+   * {@link AbfsInputStream#incrementReadOps()}.\n+   *\n+   * @throws Exception\n+   */\n+  @Test\n+  public void testAbfsStreamOps() throws Exception {\n+    describe(\"Test to see correct population of read and write operations in \"\n+        + \"Abfs\");\n+\n+    final AzureBlobFileSystem fs = getFileSystem();\n+    Path smallOperaionsFile = new Path(\"testOneReadWriteOps\");", "originalCommit": "839c43d540d4a1eadd83e4c45e31621dcda70524", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTc4NjY0OQ==", "url": "https://github.com/apache/hadoop/pull/1881#discussion_r391786649", "bodyText": "this comment needs to change", "author": "mehakmeet", "createdAt": "2020-03-12T17:41:17Z", "path": "hadoop-tools/hadoop-azure/src/test/java/org/apache/hadoop/fs/azurebfs/ITestAbfsStreamStatistics.java", "diffHunk": "@@ -0,0 +1,111 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ * <p>\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ * <p>\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hadoop.fs.azurebfs;\n+\n+import org.junit.Assert;\n+import org.junit.Test;\n+\n+import org.apache.hadoop.fs.FSDataOutputStream;\n+import org.apache.hadoop.fs.FSDataInputStream;\n+import org.apache.hadoop.fs.FileSystem;\n+import org.apache.hadoop.fs.Path;\n+import org.apache.hadoop.fs.azurebfs.services.AbfsInputStream;\n+\n+/**\n+ * Test Abfs Stream.\n+ */\n+\n+public class ITestAbfsStreamStatistics extends AbstractAbfsIntegrationTest {\n+  public ITestAbfsStreamStatistics() throws Exception {\n+  }\n+\n+  /***\n+   * {@link AbfsInputStream#incrementReadOps()}.\n+   *\n+   * @throws Exception\n+   */\n+  @Test\n+  public void testAbfsStreamOps() throws Exception {\n+    describe(\"Test to see correct population of read and write operations in \"\n+        + \"Abfs\");\n+\n+    final AzureBlobFileSystem fs = getFileSystem();\n+    Path smallOperaionsFile = new Path(\"testOneReadWriteOps\");\n+    Path largeOperationsFile = new Path(\"testLargeReadWriteOps\");\n+    FileSystem.Statistics statistics = fs.getFsStatistics();\n+    String testReadWriteOps = \"test this\";\n+    statistics.reset();\n+\n+    //Test for zero read and write operation\n+    Assert.assertEquals(\"Mismatch in read operations\", 0,\n+        statistics.getReadOps());\n+    Assert.assertEquals(\"Mismatch in write operations\", 0,\n+        statistics.getWriteOps());\n+\n+    FSDataOutputStream outForOneOperation = fs.create(smallOperaionsFile);\n+    statistics.reset();\n+    outForOneOperation.write(testReadWriteOps.getBytes());\n+    FSDataInputStream inForOneCall = fs.open(smallOperaionsFile);\n+    inForOneCall.read(testReadWriteOps.getBytes(), 0,\n+        testReadWriteOps.getBytes().length);\n+\n+    //Test for one read and write operation\n+    Assert.assertEquals(\"Mismatch in read operations\", 1,\n+        statistics.getReadOps());\n+    Assert.assertEquals(\"Mismatch in write operations\", 1,\n+        statistics.getWriteOps());\n+\n+    outForOneOperation.close();\n+    //Validating if Content is being written in the smallFile\n+    Assert.assertEquals(\"Mismatch in content validation\", true,\n+        validateContent(fs, smallOperaionsFile,\n+            testReadWriteOps.getBytes()));\n+\n+    FSDataOutputStream outForLargeOperations = fs.create(largeOperationsFile);\n+    statistics.reset();\n+\n+    StringBuilder largeOperationsValidationString = new StringBuilder();\n+    for (int i = 0; i < 1000000; i++) {\n+      outForLargeOperations.write(testReadWriteOps.getBytes());\n+\n+      //Creating the String for content Validation\n+      largeOperationsValidationString.append(testReadWriteOps);\n+    }\n+\n+    FSDataInputStream inForLargeCalls = fs.open(largeOperationsFile);\n+\n+    for (int i = 0; i < 1000000; i++)\n+      inForLargeCalls\n+          .read(testReadWriteOps.getBytes(), 0,\n+              testReadWriteOps.getBytes().length);\n+\n+    //Test for one million read and write operations\n+    Assert.assertEquals(\"Mismatch in read operations\", 1000000,\n+        statistics.getReadOps());\n+    Assert.assertEquals(\"Mismatch in write operations\", 1000000,\n+        statistics.getWriteOps());\n+\n+    outForLargeOperations.close();\n+    //Validating if actually \"test\" is being written million times in largeOperationsFile", "originalCommit": "839c43d540d4a1eadd83e4c45e31621dcda70524", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mjk1NjY5Mw==", "url": "https://github.com/apache/hadoop/pull/1881#discussion_r392956693", "bodyText": "nit: Say what you return", "author": "steveloughran", "createdAt": "2020-03-16T11:40:31Z", "path": "hadoop-tools/hadoop-azure/src/test/java/org/apache/hadoop/fs/azurebfs/AbstractAbfsTestWithTimeout.java", "diffHunk": "@@ -67,4 +77,46 @@ public void nameThread() {\n   protected int getTestTimeoutMillis() {\n     return TEST_TIMEOUT;\n   }\n+\n+  /**\n+   * Describe a test in the logs.\n+   *\n+   * @param text text to print\n+   * @param args arguments to format in the printing\n+   */\n+  protected void describe(String text, Object... args) {\n+    LOG.info(\"\\n\\n{}: {}\\n\",\n+        methodName.getMethodName(),\n+        String.format(text, args));\n+  }\n+\n+  /**\n+   * Validate Contents written on a file in Abfs.\n+   *\n+   * @param fs                AzureBlobFileSystem\n+   * @param path              Path of the file\n+   * @param originalByteArray original byte array\n+   * @return", "originalCommit": "89d73dddd337a340904b8e7a7bd9743fb3cff97e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mjk1NzAzMQ==", "url": "https://github.com/apache/hadoop/pull/1881#discussion_r392957031", "bodyText": "just makes @code", "author": "steveloughran", "createdAt": "2020-03-16T11:41:10Z", "path": "hadoop-tools/hadoop-azure/src/test/java/org/apache/hadoop/fs/azurebfs/ITestAbfsStreamStatistics.java", "diffHunk": "@@ -0,0 +1,111 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ * <p>\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ * <p>\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hadoop.fs.azurebfs;\n+\n+import org.junit.Assert;\n+import org.junit.Test;\n+\n+import org.apache.hadoop.fs.FSDataOutputStream;\n+import org.apache.hadoop.fs.FSDataInputStream;\n+import org.apache.hadoop.fs.FileSystem;\n+import org.apache.hadoop.fs.Path;\n+import org.apache.hadoop.fs.azurebfs.services.AbfsInputStream;\n+\n+/**\n+ * Test Abfs Stream.\n+ */\n+\n+public class ITestAbfsStreamStatistics extends AbstractAbfsIntegrationTest {\n+  public ITestAbfsStreamStatistics() throws Exception {\n+  }\n+\n+  /***\n+   * {@link AbfsInputStream#incrementReadOps()}.", "originalCommit": "89d73dddd337a340904b8e7a7bd9743fb3cff97e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mjk1NzcxNg==", "url": "https://github.com/apache/hadoop/pull/1881#discussion_r392957716", "bodyText": "factor into assertReadWriteOps(operation, stats, read, write)", "author": "steveloughran", "createdAt": "2020-03-16T11:42:38Z", "path": "hadoop-tools/hadoop-azure/src/test/java/org/apache/hadoop/fs/azurebfs/ITestAbfsStreamStatistics.java", "diffHunk": "@@ -0,0 +1,111 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ * <p>\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ * <p>\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hadoop.fs.azurebfs;\n+\n+import org.junit.Assert;\n+import org.junit.Test;\n+\n+import org.apache.hadoop.fs.FSDataOutputStream;\n+import org.apache.hadoop.fs.FSDataInputStream;\n+import org.apache.hadoop.fs.FileSystem;\n+import org.apache.hadoop.fs.Path;\n+import org.apache.hadoop.fs.azurebfs.services.AbfsInputStream;\n+\n+/**\n+ * Test Abfs Stream.\n+ */\n+\n+public class ITestAbfsStreamStatistics extends AbstractAbfsIntegrationTest {\n+  public ITestAbfsStreamStatistics() throws Exception {\n+  }\n+\n+  /***\n+   * {@link AbfsInputStream#incrementReadOps()}.\n+   *\n+   * @throws Exception\n+   */\n+  @Test\n+  public void testAbfsStreamOps() throws Exception {\n+    describe(\"Test to see correct population of read and write operations in \"\n+        + \"Abfs\");\n+\n+    final AzureBlobFileSystem fs = getFileSystem();\n+    Path smallOperationsFile = new Path(\"testOneReadWriteOps\");\n+    Path largeOperationsFile = new Path(\"testLargeReadWriteOps\");\n+    FileSystem.Statistics statistics = fs.getFsStatistics();\n+    String testReadWriteOps = \"test this\";\n+    statistics.reset();\n+\n+    //Test for zero read and write operation\n+    Assert.assertEquals(\"Mismatch in read operations\", 0,\n+        statistics.getReadOps());\n+    Assert.assertEquals(\"Mismatch in write operations\", 0,\n+        statistics.getWriteOps());\n+\n+    FSDataOutputStream outForOneOperation = fs.create(smallOperationsFile);\n+    statistics.reset();\n+    outForOneOperation.write(testReadWriteOps.getBytes());\n+    FSDataInputStream inForOneCall = fs.open(smallOperationsFile);\n+    inForOneCall.read(testReadWriteOps.getBytes(), 0,\n+        testReadWriteOps.getBytes().length);\n+\n+    //Test for one read and write operation", "originalCommit": "89d73dddd337a340904b8e7a7bd9743fb3cff97e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzIxNDE4OA==", "url": "https://github.com/apache/hadoop/pull/1881#discussion_r393214188", "bodyText": "what would be the use of \"operation\" parameter be here ? Is this for Assert message? If yes, wouldn't assert message of both Read and Write Ops be same?", "author": "mehakmeet", "createdAt": "2020-03-16T18:02:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mjk1NzcxNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mjk1ODAyMQ==", "url": "https://github.com/apache/hadoop/pull/1881#discussion_r392958021", "bodyText": "close in a try/finally", "author": "steveloughran", "createdAt": "2020-03-16T11:43:18Z", "path": "hadoop-tools/hadoop-azure/src/test/java/org/apache/hadoop/fs/azurebfs/ITestAbfsStreamStatistics.java", "diffHunk": "@@ -0,0 +1,111 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ * <p>\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ * <p>\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hadoop.fs.azurebfs;\n+\n+import org.junit.Assert;\n+import org.junit.Test;\n+\n+import org.apache.hadoop.fs.FSDataOutputStream;\n+import org.apache.hadoop.fs.FSDataInputStream;\n+import org.apache.hadoop.fs.FileSystem;\n+import org.apache.hadoop.fs.Path;\n+import org.apache.hadoop.fs.azurebfs.services.AbfsInputStream;\n+\n+/**\n+ * Test Abfs Stream.\n+ */\n+\n+public class ITestAbfsStreamStatistics extends AbstractAbfsIntegrationTest {\n+  public ITestAbfsStreamStatistics() throws Exception {\n+  }\n+\n+  /***\n+   * {@link AbfsInputStream#incrementReadOps()}.\n+   *\n+   * @throws Exception\n+   */\n+  @Test\n+  public void testAbfsStreamOps() throws Exception {\n+    describe(\"Test to see correct population of read and write operations in \"\n+        + \"Abfs\");\n+\n+    final AzureBlobFileSystem fs = getFileSystem();\n+    Path smallOperationsFile = new Path(\"testOneReadWriteOps\");\n+    Path largeOperationsFile = new Path(\"testLargeReadWriteOps\");\n+    FileSystem.Statistics statistics = fs.getFsStatistics();\n+    String testReadWriteOps = \"test this\";\n+    statistics.reset();\n+\n+    //Test for zero read and write operation\n+    Assert.assertEquals(\"Mismatch in read operations\", 0,\n+        statistics.getReadOps());\n+    Assert.assertEquals(\"Mismatch in write operations\", 0,\n+        statistics.getWriteOps());\n+\n+    FSDataOutputStream outForOneOperation = fs.create(smallOperationsFile);", "originalCommit": "89d73dddd337a340904b8e7a7bd9743fb3cff97e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mjk1ODQ4Mg==", "url": "https://github.com/apache/hadoop/pull/1881#discussion_r392958482", "bodyText": "skip if statistics == null", "author": "steveloughran", "createdAt": "2020-03-16T11:44:10Z", "path": "hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/services/AbfsInputStream.java", "diffHunk": "@@ -252,6 +255,13 @@ int readRemote(long position, byte[] b, int offset, int length) throws IOExcepti\n     return (int) bytesRead;\n   }\n \n+  /**\n+   * Increment Read Operations.\n+   */\n+  public void incrementReadOps() {\n+    statistics.incrementReadOps(1);", "originalCommit": "89d73dddd337a340904b8e7a7bd9743fb3cff97e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mjk1ODU4Mg==", "url": "https://github.com/apache/hadoop/pull/1881#discussion_r392958582", "bodyText": "skip if statistics == null\nmake private", "author": "steveloughran", "createdAt": "2020-03-16T11:44:22Z", "path": "hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/services/AbfsOutputStream.java", "diffHunk": "@@ -181,6 +185,14 @@ public synchronized void write(final byte[] data, final int off, final int lengt\n \n       writableBytes = bufferSize - bufferIndex;\n     }\n+    incrementWriteOps();\n+  }\n+\n+  /**\n+   * Increment Write Operations.\n+   */\n+  public void incrementWriteOps() {\n+    statistics.incrementWriteOps(1);", "originalCommit": "89d73dddd337a340904b8e7a7bd9743fb3cff97e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mjk2MzQ1Mw==", "url": "https://github.com/apache/hadoop/pull/1881#discussion_r392963453", "bodyText": "nit: ordering", "author": "steveloughran", "createdAt": "2020-03-16T11:53:53Z", "path": "hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/services/AbfsOutputStream.java", "diffHunk": "@@ -36,6 +36,7 @@\n import com.google.common.annotations.VisibleForTesting;\n import com.google.common.base.Preconditions;\n \n+import org.apache.hadoop.fs.FileSystem.Statistics;", "originalCommit": "89d73dddd337a340904b8e7a7bd9743fb3cff97e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzE4NDk3OQ==", "url": "https://github.com/apache/hadoop/pull/1881#discussion_r393184979", "bodyText": "I thought ordering was right?\njava\nnon org.apache\norg.apache\nstatic", "author": "mehakmeet", "createdAt": "2020-03-16T17:14:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mjk2MzQ1Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mjk2NDQ0OA==", "url": "https://github.com/apache/hadoop/pull/1881#discussion_r392964448", "bodyText": "minor: nit: ordering", "author": "steveloughran", "createdAt": "2020-03-16T11:55:59Z", "path": "hadoop-tools/hadoop-azure/src/test/java/org/apache/hadoop/fs/azurebfs/ITestAbfsStreamStatistics.java", "diffHunk": "@@ -0,0 +1,111 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ * <p>\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ * <p>\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hadoop.fs.azurebfs;\n+\n+import org.junit.Assert;\n+import org.junit.Test;\n+\n+import org.apache.hadoop.fs.FSDataOutputStream;\n+import org.apache.hadoop.fs.FSDataInputStream;\n+import org.apache.hadoop.fs.FileSystem;", "originalCommit": "89d73dddd337a340904b8e7a7bd9743fb3cff97e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDEyMTI5MQ==", "url": "https://github.com/apache/hadoop/pull/1881#discussion_r394121291", "bodyText": "This is wrong. How can you compare the expected value with both read and write value? What if read and write values are different?\nassertReadWriteOps(operation, expected, actual) is what we discussed right?", "author": "mukund-thakur", "createdAt": "2020-03-18T05:59:33Z", "path": "hadoop-tools/hadoop-azure/src/test/java/org/apache/hadoop/fs/azurebfs/ITestAbfsStreamStatistics.java", "diffHunk": "@@ -46,66 +46,89 @@ public void testAbfsStreamOps() throws Exception {\n         + \"Abfs\");\n \n     final AzureBlobFileSystem fs = getFileSystem();\n-    Path smallOperaionsFile = new Path(\"testOneReadWriteOps\");\n+    Path smallOperationsFile = new Path(\"testOneReadWriteOps\");\n     Path largeOperationsFile = new Path(\"testLargeReadWriteOps\");\n     FileSystem.Statistics statistics = fs.getFsStatistics();\n     String testReadWriteOps = \"test this\";\n     statistics.reset();\n \n     //Test for zero read and write operation\n-    Assert.assertEquals(\"Mismatch in read operations\", 0,\n-        statistics.getReadOps());\n-    Assert.assertEquals(\"Mismatch in write operations\", 0,\n-        statistics.getWriteOps());\n-\n-    FSDataOutputStream outForOneOperation = fs.create(smallOperaionsFile);\n-    statistics.reset();\n-    outForOneOperation.write(testReadWriteOps.getBytes());\n-    FSDataInputStream inForOneCall = fs.open(smallOperaionsFile);\n-    inForOneCall.read(testReadWriteOps.getBytes(), 0,\n-        testReadWriteOps.getBytes().length);\n-\n-    //Test for one read and write operation\n-    Assert.assertEquals(\"Mismatch in read operations\", 1,\n-        statistics.getReadOps());\n-    Assert.assertEquals(\"Mismatch in write operations\", 1,\n-        statistics.getWriteOps());\n-\n-    outForOneOperation.close();\n-    //Validating if Content is being written in the smallFile\n-    Assert.assertEquals(\"Mismatch in content validation\", true,\n-        validateContent(fs, smallOperaionsFile,\n+    assertReadWriteOps(0, statistics);\n+\n+    FSDataOutputStream outForOneOperation = null;\n+    FSDataInputStream inForOneOperation = null;\n+    try {\n+      outForOneOperation = fs.create(smallOperationsFile);\n+      statistics.reset();\n+      outForOneOperation.write(testReadWriteOps.getBytes());\n+      inForOneOperation = fs.open(smallOperationsFile);\n+      inForOneOperation.read(testReadWriteOps.getBytes(), 0,\n+          testReadWriteOps.getBytes().length);\n+\n+      //Test for one read and write operation\n+      assertReadWriteOps(1, statistics);\n+    } finally {\n+      if (inForOneOperation != null) {\n+        inForOneOperation.close();\n+      }\n+      if (outForOneOperation != null) {\n+        outForOneOperation.close();\n+      }\n+    }\n+    //Validating if content is being written in the smallOperationsFile\n+    Assert.assertTrue(\"Mismatch in content validation\",\n+        validateContent(fs, smallOperationsFile,\n             testReadWriteOps.getBytes()));\n \n-    FSDataOutputStream outForLargeOperations = fs.create(largeOperationsFile);\n-    statistics.reset();\n-\n+    FSDataOutputStream outForLargeOperations = null;\n+    FSDataInputStream inForLargeOperations = null;\n     StringBuilder largeOperationsValidationString = new StringBuilder();\n-    for (int i = 0; i < 1000000; i++) {\n-      outForLargeOperations.write(testReadWriteOps.getBytes());\n-\n-      //Creating the String for content Validation\n-      largeOperationsValidationString.append(testReadWriteOps);\n+    try {\n+      outForLargeOperations = fs.create(largeOperationsFile);\n+      statistics.reset();\n+      int largeValue = 1000000;\n+      for (int i = 0; i < largeValue; i++) {\n+        outForLargeOperations.write(testReadWriteOps.getBytes());\n+\n+        //Creating the String for content Validation\n+        largeOperationsValidationString.append(testReadWriteOps);\n+      }\n+\n+      inForLargeOperations = fs.open(largeOperationsFile);\n+      for (int i = 0; i < largeValue; i++)\n+        inForLargeOperations\n+            .read(testReadWriteOps.getBytes(), 0,\n+                testReadWriteOps.getBytes().length);\n+\n+      //Test for one million read and write operations\n+      assertReadWriteOps(largeValue, statistics);\n+    } finally {\n+      if (inForLargeOperations != null) {\n+        inForLargeOperations.close();\n+      }\n+      if (outForLargeOperations != null) {\n+        outForLargeOperations.close();\n+      }\n     }\n \n-    FSDataInputStream inForLargeCalls = fs.open(largeOperationsFile);\n+    //Validating if content is being written in largeOperationsFile\n+    Assert.assertTrue(\"Mismatch in content validation\",\n+        validateContent(fs, largeOperationsFile,\n+            largeOperationsValidationString.toString().getBytes()));\n \n-    for (int i = 0; i < 1000000; i++)\n-      inForLargeCalls\n-          .read(testReadWriteOps.getBytes(), 0,\n-              testReadWriteOps.getBytes().length);\n+  }\n \n-    //Test for one million read and write operations\n-    Assert.assertEquals(\"Mismatch in read operations\", 1000000,\n+  /**\n+   * Method for Read and Write Ops Assertion.\n+   *\n+   * @param expectedReadWriteOps Expected Value\n+   * @param statistics           fs stats to get Actual Values\n+   */\n+  private void assertReadWriteOps(long expectedReadWriteOps,", "originalCommit": "9c782035581160d066d0d3d5a78072a653c34309", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDEyMjAxMg==", "url": "https://github.com/apache/hadoop/pull/1881#discussion_r394122012", "bodyText": "remove", "author": "mukund-thakur", "createdAt": "2020-03-18T06:02:03Z", "path": "hadoop-tools/hadoop-azure/src/test/java/org/apache/hadoop/fs/azurebfs/AbstractAbfsTestWithTimeout.java", "diffHunk": "@@ -6,9 +6,9 @@\n  * to you under the Apache License, Version 2.0 (the\n  * \"License\"); you may not use this file except in compliance\n  * with the License.  You may obtain a copy of the License at\n- *\n- *     http://www.apache.org/licenses/LICENSE-2.0\n- *\n+ * <p>", "originalCommit": "9c782035581160d066d0d3d5a78072a653c34309", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDI3MTYyNw==", "url": "https://github.com/apache/hadoop/pull/1881#discussion_r394271627", "bodyText": "needs to be closed. you can use try (FSDataInputStream ...) { } to manage this automatically", "author": "steveloughran", "createdAt": "2020-03-18T11:16:45Z", "path": "hadoop-tools/hadoop-azure/src/test/java/org/apache/hadoop/fs/azurebfs/AbstractAbfsTestWithTimeout.java", "diffHunk": "@@ -67,4 +77,46 @@ public void nameThread() {\n   protected int getTestTimeoutMillis() {\n     return TEST_TIMEOUT;\n   }\n+\n+  /**\n+   * Describe a test in the logs.\n+   *\n+   * @param text text to print\n+   * @param args arguments to format in the printing\n+   */\n+  protected void describe(String text, Object... args) {\n+    LOG.info(\"\\n\\n{}: {}\\n\",\n+        methodName.getMethodName(),\n+        String.format(text, args));\n+  }\n+\n+  /**\n+   * Validate Contents written on a file in Abfs.\n+   *\n+   * @param fs                AzureBlobFileSystem\n+   * @param path              Path of the file\n+   * @param originalByteArray original byte array\n+   * @return\n+   * @throws IOException\n+   */\n+  protected boolean validateContent(AzureBlobFileSystem fs, Path path,\n+      byte[] originalByteArray)\n+      throws IOException {\n+    FSDataInputStream in = fs.open(path);", "originalCommit": "89d73dddd337a340904b8e7a7bd9743fb3cff97e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDI3MzE5OA==", "url": "https://github.com/apache/hadoop/pull/1881#discussion_r394273198", "bodyText": "IOUtils.cleanupWithLogger(LOG, inForLargeOperations, outForLargeOperations)\n\nthat does close on all non-null arguments, catches failures so they don't get in the way of whatever was thrown earlier. We use this throughout the hadoop codebase to clean up robustly, so get used to it", "author": "steveloughran", "createdAt": "2020-03-18T11:19:47Z", "path": "hadoop-tools/hadoop-azure/src/test/java/org/apache/hadoop/fs/azurebfs/ITestAbfsStreamStatistics.java", "diffHunk": "@@ -0,0 +1,147 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hadoop.fs.azurebfs;\n+\n+import org.junit.Assert;\n+import org.junit.Test;\n+\n+import org.apache.hadoop.fs.FSDataOutputStream;\n+import org.apache.hadoop.fs.FSDataInputStream;\n+import org.apache.hadoop.fs.FileSystem;\n+import org.apache.hadoop.fs.Path;\n+\n+/**\n+ * Test Abfs Stream.\n+ */\n+\n+public class ITestAbfsStreamStatistics extends AbstractAbfsIntegrationTest {\n+  public ITestAbfsStreamStatistics() throws Exception {\n+  }\n+\n+  /***\n+   * Testing {@code incrementReadOps()} in class {@code AbfsInputStream} and\n+   * {@code incrementWriteOps()} in class {@code AbfsOutputStream}.\n+   *\n+   * @throws Exception\n+   */\n+  @Test\n+  public void testAbfsStreamOps() throws Exception {\n+    describe(\"Test to see correct population of read and write operations in \"\n+        + \"Abfs\");\n+\n+    final AzureBlobFileSystem fs = getFileSystem();\n+    Path smallOperationsFile = new Path(\"testOneReadWriteOps\");\n+    Path largeOperationsFile = new Path(\"testLargeReadWriteOps\");\n+    FileSystem.Statistics statistics = fs.getFsStatistics();\n+    String testReadWriteOps = \"test this\";\n+    statistics.reset();\n+\n+    //Test for zero write operation\n+    assertReadWriteOps(\"write\", 0, statistics.getWriteOps());\n+\n+    //Test for zero read operation\n+    assertReadWriteOps(\"read\", 0, statistics.getReadOps());\n+\n+    FSDataOutputStream outForOneOperation = null;\n+    FSDataInputStream inForOneOperation = null;\n+    try {\n+      outForOneOperation = fs.create(smallOperationsFile);\n+      statistics.reset();\n+      outForOneOperation.write(testReadWriteOps.getBytes());\n+\n+      //Test for a single write operation\n+      assertReadWriteOps(\"write\", 1, statistics.getWriteOps());\n+\n+      inForOneOperation = fs.open(smallOperationsFile);\n+      inForOneOperation.read(testReadWriteOps.getBytes(), 0,\n+          testReadWriteOps.getBytes().length);\n+\n+      //Test for a single read operation\n+      assertReadWriteOps(\"read\", 1, statistics.getReadOps());\n+\n+    } finally {\n+      if (inForOneOperation != null) {\n+        inForOneOperation.close();\n+      }\n+      if (outForOneOperation != null) {\n+        outForOneOperation.close();\n+      }\n+    }\n+\n+    //Validating if content is being written in the smallOperationsFile\n+    Assert.assertTrue(\"Mismatch in content validation\",\n+        validateContent(fs, smallOperationsFile,\n+            testReadWriteOps.getBytes()));\n+\n+    FSDataOutputStream outForLargeOperations = null;\n+    FSDataInputStream inForLargeOperations = null;\n+    StringBuilder largeOperationsValidationString = new StringBuilder();\n+    try {\n+      outForLargeOperations = fs.create(largeOperationsFile);\n+      statistics.reset();\n+      int largeValue = 1000000;\n+      for (int i = 0; i < largeValue; i++) {\n+        outForLargeOperations.write(testReadWriteOps.getBytes());\n+\n+        //Creating the String for content Validation\n+        largeOperationsValidationString.append(testReadWriteOps);\n+      }\n+\n+      //Test for 1000000 write operations\n+      assertReadWriteOps(\"write\", largeValue, statistics.getWriteOps());\n+\n+      inForLargeOperations = fs.open(largeOperationsFile);\n+      for (int i = 0; i < largeValue; i++)\n+        inForLargeOperations\n+            .read(testReadWriteOps.getBytes(), 0,\n+                testReadWriteOps.getBytes().length);\n+\n+      //Test for 1000000 read operations\n+      assertReadWriteOps(\"read\", largeValue, statistics.getReadOps());\n+\n+    } finally {\n+      if (inForLargeOperations != null) {", "originalCommit": "83a23b5054b6910b33541bf52f7a1a8113bab16a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDI3Mzc2MQ==", "url": "https://github.com/apache/hadoop/pull/1881#discussion_r394273761", "bodyText": "add a .close() at the end so if something went wrong and the file was opened, we close the stream", "author": "steveloughran", "createdAt": "2020-03-18T11:20:54Z", "path": "hadoop-tools/hadoop-azure/src/test/java/org/apache/hadoop/fs/azurebfs/ITestAzureBlobFileSystemOauth.java", "diffHunk": "@@ -143,7 +143,7 @@ public void testBlobDataReader() throws Exception {\n \n     // TEST WRITE FILE\n     try {\n-      abfsStore.openFileForWrite(EXISTED_FILE_PATH, true);\n+      abfsStore.openFileForWrite(EXISTED_FILE_PATH, fs.getFsStatistics(), true);", "originalCommit": "83a23b5054b6910b33541bf52f7a1a8113bab16a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTc0MDg0NQ==", "url": "https://github.com/apache/hadoop/pull/1881#discussion_r395740845", "bodyText": "you are going to need to create a logger in this test case and pass it down i'm afraid", "author": "steveloughran", "createdAt": "2020-03-20T16:09:56Z", "path": "hadoop-tools/hadoop-azure/src/test/java/org/apache/hadoop/fs/azurebfs/ITestAbfsStreamStatistics.java", "diffHunk": "@@ -76,12 +79,8 @@ public void testAbfsStreamOps() throws Exception {\n       assertReadWriteOps(\"read\", 1, statistics.getReadOps());\n \n     } finally {\n-      if (inForOneOperation != null) {\n-        inForOneOperation.close();\n-      }\n-      if (outForOneOperation != null) {\n-        outForOneOperation.close();\n-      }\n+      IOUtils.cleanupWithLogger(null, inForOneOperation,", "originalCommit": "d3233d1030112a7dc84e18d00dcdab6690453b91", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjIyODgxNQ==", "url": "https://github.com/apache/hadoop/pull/1881#discussion_r396228815", "bodyText": "Is this logging required ? @steveloughran", "author": "mukund-thakur", "createdAt": "2020-03-23T06:07:46Z", "path": "hadoop-tools/hadoop-azure/src/test/java/org/apache/hadoop/fs/azurebfs/ITestAbfsStreamStatistics.java", "diffHunk": "@@ -101,6 +115,8 @@ public void testAbfsStreamOps() throws Exception {\n         //Creating the String for content Validation\n         largeOperationsValidationString.append(testReadWriteOps);\n       }\n+      LOG.info(\"Number of bytes of Large data written: {}\",", "originalCommit": "a607839150cc8576f0ffe3708a8271094ca12e39", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjIzMDQxNA==", "url": "https://github.com/apache/hadoop/pull/1881#discussion_r396230414", "bodyText": "Use IOUtils.cleanupWithLogger() here as well. Or you can just say this code is old.", "author": "mukund-thakur", "createdAt": "2020-03-23T06:14:26Z", "path": "hadoop-tools/hadoop-azure/src/test/java/org/apache/hadoop/fs/azurebfs/ITestAzureBlobFileSystemOauth.java", "diffHunk": "@@ -146,6 +146,8 @@ public void testBlobDataReader() throws Exception {\n       abfsStore.openFileForWrite(EXISTED_FILE_PATH, fs.getFsStatistics(), true);\n     } catch (AbfsRestOperationException e) {\n       assertEquals(AzureServiceErrorCode.AUTHORIZATION_PERMISSION_MISS_MATCH, e.getErrorCode());\n+    } finally {\n+      abfsStore.close();", "originalCommit": "a607839150cc8576f0ffe3708a8271094ca12e39", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjI0MTA2MQ==", "url": "https://github.com/apache/hadoop/pull/1881#discussion_r396241061", "bodyText": ".close() does this already.", "author": "mehakmeet", "createdAt": "2020-03-23T06:54:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjIzMDQxNA=="}], "type": "inlineReview"}, {"oid": "afba6cc18b82c7d6fc68169b32c165fa46123ed8", "url": "https://github.com/apache/hadoop/commit/afba6cc18b82c7d6fc68169b32c165fa46123ed8", "message": "Logging, closing, modifying", "committedDate": "2020-03-23T06:51:35Z", "type": "forcePushed"}, {"oid": "bfb4afab8d49bbc9730691ae3ca5cde5d8b5963d", "url": "https://github.com/apache/hadoop/commit/bfb4afab8d49bbc9730691ae3ca5cde5d8b5963d", "message": "CDPD-8485 Adding file system counters\n\n- Write_ops\n- Read_ops\n- Bytes_written (already updated)\n- Bytes_Read (already updated)\n\nChange-Id: I77349fdd158babd66df665713201fa9c8606f191", "committedDate": "2020-03-23T08:15:25Z", "type": "commit"}, {"oid": "ff01bcf889eccb566e069386065769a77a96b01e", "url": "https://github.com/apache/hadoop/commit/ff01bcf889eccb566e069386065769a77a96b01e", "message": "Fixing Review Comments", "committedDate": "2020-03-23T08:15:25Z", "type": "commit"}, {"oid": "3e59ca51ef546aa303a7c50d092cffaa17ff664d", "url": "https://github.com/apache/hadoop/commit/3e59ca51ef546aa303a7c50d092cffaa17ff664d", "message": "Meaningful assert messages", "committedDate": "2020-03-23T08:15:25Z", "type": "commit"}, {"oid": "ecc4c80fda62d497a4ff4df8de1515d30a255652", "url": "https://github.com/apache/hadoop/commit/ecc4c80fda62d497a4ff4df8de1515d30a255652", "message": "minor nits in test", "committedDate": "2020-03-23T08:15:25Z", "type": "commit"}, {"oid": "536d1e11cc1d01084d510380774d045e717cee09", "url": "https://github.com/apache/hadoop/commit/536d1e11cc1d01084d510380774d045e717cee09", "message": "minor nits in test", "committedDate": "2020-03-23T08:15:25Z", "type": "commit"}, {"oid": "0e33beaf5d7c3fb9524c2c4ad8c8343d62351a72", "url": "https://github.com/apache/hadoop/commit/0e33beaf5d7c3fb9524c2c4ad8c8343d62351a72", "message": "Fixing review comments", "committedDate": "2020-03-23T08:15:25Z", "type": "commit"}, {"oid": "72f7181f03ba835ac16cace1d096c857f3967ab4", "url": "https://github.com/apache/hadoop/commit/72f7181f03ba835ac16cace1d096c857f3967ab4", "message": "closing streams", "committedDate": "2020-03-23T08:15:25Z", "type": "commit"}, {"oid": "6b28cf2a041adae52f38dc080616566506a52120", "url": "https://github.com/apache/hadoop/commit/6b28cf2a041adae52f38dc080616566506a52120", "message": "Logging, closing, modifying", "committedDate": "2020-03-23T08:15:25Z", "type": "commit"}, {"oid": "6b28cf2a041adae52f38dc080616566506a52120", "url": "https://github.com/apache/hadoop/commit/6b28cf2a041adae52f38dc080616566506a52120", "message": "Logging, closing, modifying", "committedDate": "2020-03-23T08:15:25Z", "type": "forcePushed"}, {"oid": "cf4b7d459c9df3fb04aef5624496d53deb533d3d", "url": "https://github.com/apache/hadoop/commit/cf4b7d459c9df3fb04aef5624496d53deb533d3d", "message": "cleanup", "committedDate": "2020-03-23T11:40:10Z", "type": "commit"}]}