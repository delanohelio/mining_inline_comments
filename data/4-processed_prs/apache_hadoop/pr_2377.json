{"pr_number": 2377, "pr_title": "HDFS-15624. fix the function of setting quota by storage type", "pr_createdAt": "2020-10-10T07:34:46Z", "pr_url": "https://github.com/apache/hadoop/pull/2377", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDY2MDkzNg==", "url": "https://github.com/apache/hadoop/pull/2377#discussion_r510660936", "bodyText": "Since there is no release after this feature is committed, No need to increase layout version twice for same feature.\nUsually one version increase is sufficient per release. But for clarity separate feature can be added.\nIn this case feature is only one. NVDIMM SUPPORT.", "author": "vinayakumarb", "createdAt": "2020-10-23T06:25:55Z", "path": "hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/namenode/NameNodeLayoutVersion.java", "diffHunk": "@@ -89,7 +89,11 @@ public static boolean supports(final LayoutFeature f, final int lv) {\n     APPEND_NEW_BLOCK(-62, -61, \"Support appending to new block\"),\n     QUOTA_BY_STORAGE_TYPE(-63, -61, \"Support quota for specific storage types\"),\n     ERASURE_CODING(-64, -61, \"Support erasure coding\"),\n-    EXPANDED_STRING_TABLE(-65, -61, \"Support expanded string table in fsimage\");\n+    EXPANDED_STRING_TABLE(-65, -61, \"Support expanded string table in fsimage\"),\n+    BLOCK_STORAGE_POLICY_INCLUDING_ALL_NVDIMM(-66, -66, \"Support block \" +\n+        \"Storage policy including ALL_NVDIMM\"),\n+    QUOTA_BY_STORAGE_TYPE_INCLUDING_NVDIMM(-67, -66, \"Support quota for \" +\n+        \"specific storage types including NVDIMM\");", "originalCommit": "cb3bac5f4be587ed44588df0f8c4d7af65935dc1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDY2MjIyOQ==", "url": "https://github.com/apache/hadoop/pull/2377#discussion_r510662229", "bodyText": "Because of addition of new STORAGE TYPE,\nduring upgrade\ncalls from old clients, who doesnt have this storagetype, will experience failure.\nEspecially getQuotaUsage() call will experience failure. May be need to analyze more to avoid failures during upgrade.\nEven though upgrade is finalized, old clients should continue to work.", "author": "vinayakumarb", "createdAt": "2020-10-23T06:29:28Z", "path": "hadoop-common-project/hadoop-common/src/main/java/org/apache/hadoop/fs/StorageType.java", "diffHunk": "@@ -33,13 +33,12 @@\n @InterfaceAudience.Public\n @InterfaceStability.Unstable\n public enum StorageType {\n-  // sorted by the speed of the storage types, from fast to slow\n   RAM_DISK(true, true),\n-  NVDIMM(false, true),\n   SSD(false, false),\n   DISK(false, false),\n   ARCHIVE(false, false),\n-  PROVIDED(false, false);\n+  PROVIDED(false, false),\n+  NVDIMM(false, true);\n ", "originalCommit": "cb3bac5f4be587ed44588df0f8c4d7af65935dc1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzIxMDU1Nw==", "url": "https://github.com/apache/hadoop/pull/2377#discussion_r513210557", "bodyText": "We add check for setQuota() in FSNamesystem.java, I think it's ok, right?", "author": "huangtianhua", "createdAt": "2020-10-28T06:40:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDY2MjIyOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzI1NTIzNg==", "url": "https://github.com/apache/hadoop/pull/2377#discussion_r513255236", "bodyText": "setQuota() check will only block during rollingupgrade. But once its finalized, still old clients experience failure.\nAnyway thats the current problem, even before this feature. Can be handled in a separate Jira.\nMore details about failure: 2.10.1 client asking quota usage from 3.3.0 namenode.\n$ bin/hdfs dfs -fs hdfs://namenode:8020/ -count -q -t -h /\ncount: Message missing required fields: usage.typeQuotaInfos.typeQuotaInfo[3].type\n\nAbove issue is coming, because 2.10.1 client doent know about PROVIDED StorageType.\nSimilar problem will occur for NVDIMM also from previous version clients.", "author": "vinayakumarb", "createdAt": "2020-10-28T08:23:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDY2MjIyOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDAzNjk2Nw==", "url": "https://github.com/apache/hadoop/pull/2377#discussion_r514036967", "bodyText": "I am not sure but will getStoragePolicies also land up in something similar issue? Due to unavailability of storage type? The quota stuff shall be there for PROVIDED also but in case this backward incompatibility is there with Storage Policy too, Then we need to find out some way.\n@vinayakumarb do you have pointers or suggestions on this, how to tackle this?", "author": "ayushtkn", "createdAt": "2020-10-29T07:00:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDY2MjIyOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDQwMTk4Nw==", "url": "https://github.com/apache/hadoop/pull/2377#discussion_r514401987", "bodyText": "I have verified the getStoragePolicies() with older clients.\nOlder clients will get the storage policy but, unknown storage types will be ignored.\nSo in this case, ALLNVDIMM storage policy shows empty StorageTypes for older clients.\nMay be need to show DEFAULT StorageType instead of ignoring the unknown StorageTypes. This also can be fixed in a separate Jira. Right now, existing clients wont be broken on getStoragePolicies() call with this change.\nSo nothing special required for that in this PR.", "author": "vinayakumarb", "createdAt": "2020-10-29T16:35:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDY2MjIyOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDY3OTU1MQ==", "url": "https://github.com/apache/hadoop/pull/2377#discussion_r514679551", "bodyText": "Thanks for clarification and testing.", "author": "huangtianhua", "createdAt": "2020-10-30T01:43:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDY2MjIyOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzE0MzEzMA==", "url": "https://github.com/apache/hadoop/pull/2377#discussion_r513143130", "bodyText": "Is there any reason to change the minCompatLV  to -66?", "author": "vinayakumarb", "createdAt": "2020-10-28T02:31:54Z", "path": "hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/namenode/NameNodeLayoutVersion.java", "diffHunk": "@@ -89,7 +89,8 @@ public static boolean supports(final LayoutFeature f, final int lv) {\n     APPEND_NEW_BLOCK(-62, -61, \"Support appending to new block\"),\n     QUOTA_BY_STORAGE_TYPE(-63, -61, \"Support quota for specific storage types\"),\n     ERASURE_CODING(-64, -61, \"Support erasure coding\"),\n-    EXPANDED_STRING_TABLE(-65, -61, \"Support expanded string table in fsimage\");\n+    EXPANDED_STRING_TABLE(-65, -61, \"Support expanded string table in fsimage\"),\n+    NVDIMM_SUPPORT(-66, -66, \"Support NVDIMM storage type\");", "originalCommit": "d5b5d0b1905ad9a1eb13d2fddf4b1657e3f9500e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzIwOTg5OA==", "url": "https://github.com/apache/hadoop/pull/2377#discussion_r513209898", "bodyText": "As the comment above said:\nIf the feature cannot satisfy compatibility with any prior version, then set its minimum compatible lqyout version to itself to indicate that downgrade is impossible.\nOr maybe we missed something?", "author": "huangtianhua", "createdAt": "2020-10-28T06:38:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzE0MzEzMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDAzMzM2NA==", "url": "https://github.com/apache/hadoop/pull/2377#discussion_r514033364", "bodyText": "Not very aware, but yes, if I am decoding the comment correct, This should be 66 both.", "author": "ayushtkn", "createdAt": "2020-10-29T06:53:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzE0MzEzMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDQwMzU1OA==", "url": "https://github.com/apache/hadoop/pull/2377#discussion_r514403558", "bodyText": "keep it -61 for minCompatLV itself.\nMore details here", "author": "vinayakumarb", "createdAt": "2020-10-29T16:37:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzE0MzEzMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDY4MDc1OQ==", "url": "https://github.com/apache/hadoop/pull/2377#discussion_r514680759", "bodyText": "I will change the miniCompatLV to -61, thanks for your clarification.", "author": "huangtianhua", "createdAt": "2020-10-30T01:44:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzE0MzEzMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDAzMjQwNg==", "url": "https://github.com/apache/hadoop/pull/2377#discussion_r514032406", "bodyText": "This check should be done in case of setStoragePolicy also, if the storage policy is ALLNVDIMM", "author": "ayushtkn", "createdAt": "2020-10-29T06:51:39Z", "path": "hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/namenode/FSNamesystem.java", "diffHunk": "@@ -3569,6 +3569,9 @@ void setQuota(String src, long nsQuota, long ssQuota, StorageType type)\n     if (type != null) {\n       requireEffectiveLayoutVersionForFeature(Feature.QUOTA_BY_STORAGE_TYPE);\n     }\n+    if (type == StorageType.NVDIMM) {\n+      requireEffectiveLayoutVersionForFeature(Feature.NVDIMM_SUPPORT);", "originalCommit": "d5b5d0b1905ad9a1eb13d2fddf4b1657e3f9500e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzAzOTcxMw==", "url": "https://github.com/apache/hadoop/pull/2377#discussion_r533039713", "bodyText": "Done. Please see code above. Thanks.", "author": "huangtianhua", "createdAt": "2020-12-01T02:53:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDAzMjQwNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzA0MDM4NQ==", "url": "https://github.com/apache/hadoop/pull/2377#discussion_r533040385", "bodyText": "Done", "author": "huangtianhua", "createdAt": "2020-12-01T02:55:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDAzMjQwNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzE0MzM4Mw==", "url": "https://github.com/apache/hadoop/pull/2377#discussion_r513143383", "bodyText": "Similar check you need to add when user tries to use NVDIMM based storage policy..", "author": "vinayakumarb", "createdAt": "2020-10-28T02:32:55Z", "path": "hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/namenode/FSNamesystem.java", "diffHunk": "@@ -3569,6 +3569,9 @@ void setQuota(String src, long nsQuota, long ssQuota, StorageType type)\n     if (type != null) {\n       requireEffectiveLayoutVersionForFeature(Feature.QUOTA_BY_STORAGE_TYPE);\n     }\n+    if (type == StorageType.NVDIMM) {\n+      requireEffectiveLayoutVersionForFeature(Feature.NVDIMM_SUPPORT);\n+    }", "originalCommit": "d5b5d0b1905ad9a1eb13d2fddf4b1657e3f9500e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzAzOTczOA==", "url": "https://github.com/apache/hadoop/pull/2377#discussion_r533039738", "bodyText": "Done. Please see code above. Thanks.", "author": "huangtianhua", "createdAt": "2020-12-01T02:53:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzE0MzM4Mw=="}], "type": "inlineReview"}, {"oid": "2321ba5fa2f7e7c4c5d8b6603a8677a4a94d0e22", "url": "https://github.com/apache/hadoop/commit/2321ba5fa2f7e7c4c5d8b6603a8677a4a94d0e22", "message": "HDFS-15624 Fix NVDIMM storage issues\n\nThis changes:\n1. puts NVDIMM to the end of storage type enum\n   to make sure compatibility.\n2. adds check for setQuota() and setStoragePolicy()\n   to make sure the software layout version is\n   satisfied.", "committedDate": "2020-10-30T06:35:47Z", "type": "forcePushed"}, {"oid": "4d53da6ac3244adc819fd445ce17e413cc7aa2ce", "url": "https://github.com/apache/hadoop/commit/4d53da6ac3244adc819fd445ce17e413cc7aa2ce", "message": "HDFS-15624 Fix NVDIMM storage issues\n\nThis changes:\n1. puts NVDIMM to the end of storage type enum\n   to make sure compatibility.\n2. adds check for setQuota() and setStoragePolicy()\n   to make sure the software layout version is\n   satisfied.", "committedDate": "2020-10-31T01:32:37Z", "type": "forcePushed"}, {"oid": "27c1ef5f423a06150ae6b4c32cd0f73ae18c75de", "url": "https://github.com/apache/hadoop/commit/27c1ef5f423a06150ae6b4c32cd0f73ae18c75de", "message": "HDFS-15624 Fix NVDIMM storage issues\n\nThis changes:\n1. puts NVDIMM to the end of storage type enum\n   to make sure compatibility.\n2. adds check for setQuota() and setStoragePolicy()\n   to make sure the software layout version is\n   satisfied.", "committedDate": "2020-11-02T01:43:11Z", "type": "forcePushed"}, {"oid": "5d676ee57aaef7d676f51ce5f17a47dfa5f98fd4", "url": "https://github.com/apache/hadoop/commit/5d676ee57aaef7d676f51ce5f17a47dfa5f98fd4", "message": "HDFS-15624 Fix NVDIMM storage issues\n\nThis changes:\n1. puts NVDIMM to the end of storage type enum\n   to make sure compatibility.\n2. adds check for setQuota() and setStoragePolicy()\n   to make sure the software layout version is\n   satisfied.", "committedDate": "2020-11-03T01:25:43Z", "type": "forcePushed"}, {"oid": "7736e7d952d77e522390584412f067233c1d5771", "url": "https://github.com/apache/hadoop/commit/7736e7d952d77e522390584412f067233c1d5771", "message": "fix the function of setting quota by storage type", "committedDate": "2020-11-04T01:37:29Z", "type": "commit"}, {"oid": "3e62104c56b3e2a6fb121dd6257f1c674977b123", "url": "https://github.com/apache/hadoop/commit/3e62104c56b3e2a6fb121dd6257f1c674977b123", "message": "fix the function of setting quota by storage type", "committedDate": "2020-11-04T01:37:29Z", "type": "commit"}, {"oid": "0a731cd0ae808df6ace08e9a76bf6321539e7d0d", "url": "https://github.com/apache/hadoop/commit/0a731cd0ae808df6ace08e9a76bf6321539e7d0d", "message": "fix the function of setting quota by storage type", "committedDate": "2020-11-04T01:37:29Z", "type": "commit"}, {"oid": "fcc143dc4f72cff6d2598111f6214764e63254fb", "url": "https://github.com/apache/hadoop/commit/fcc143dc4f72cff6d2598111f6214764e63254fb", "message": "handle Namenode's layout version while upfrade or downgrade", "committedDate": "2020-11-04T01:37:29Z", "type": "commit"}, {"oid": "113f0de08a1d44978910052c57da32481a03e03d", "url": "https://github.com/apache/hadoop/commit/113f0de08a1d44978910052c57da32481a03e03d", "message": "handle Namenode's layout version while upfrade or downgrade", "committedDate": "2020-11-04T01:37:29Z", "type": "commit"}, {"oid": "2d3bb85c4b0455c58f4b4e24402d93b2e2d4389d", "url": "https://github.com/apache/hadoop/commit/2d3bb85c4b0455c58f4b4e24402d93b2e2d4389d", "message": "modify the ancestorLV of new features", "committedDate": "2020-11-04T01:37:29Z", "type": "commit"}, {"oid": "edfeec0b830b3af53a3f53a82f2c5dbbeddfe19c", "url": "https://github.com/apache/hadoop/commit/edfeec0b830b3af53a3f53a82f2c5dbbeddfe19c", "message": "just fix the bug of SetQuotaByStorageTypeOp", "committedDate": "2020-11-04T01:37:30Z", "type": "commit"}, {"oid": "d7db1b979e16756d5e40e30e0e50d929ead40496", "url": "https://github.com/apache/hadoop/commit/d7db1b979e16756d5e40e30e0e50d929ead40496", "message": "just fix the bug of SetQuotaByStorageTypeOp", "committedDate": "2020-11-04T01:37:30Z", "type": "commit"}, {"oid": "c65741abffdbc531d4be4c8c0bc25662bebba4fe", "url": "https://github.com/apache/hadoop/commit/c65741abffdbc531d4be4c8c0bc25662bebba4fe", "message": "just fix the bug of SetQuotaByStorageTypeOp", "committedDate": "2020-11-04T01:37:30Z", "type": "commit"}, {"oid": "5a99d1bfc82b6677c3a0b90285aee112d3985a62", "url": "https://github.com/apache/hadoop/commit/5a99d1bfc82b6677c3a0b90285aee112d3985a62", "message": "just fix the bug of SetQuotaByStorageTypeOp", "committedDate": "2020-11-04T01:37:30Z", "type": "commit"}, {"oid": "175f33e934ee8f83c989e3c1bf2ccb0f4024319d", "url": "https://github.com/apache/hadoop/commit/175f33e934ee8f83c989e3c1bf2ccb0f4024319d", "message": "test", "committedDate": "2020-11-04T01:37:30Z", "type": "commit"}, {"oid": "2ca24078e176e344951120abe5ec2d5956f26ec3", "url": "https://github.com/apache/hadoop/commit/2ca24078e176e344951120abe5ec2d5956f26ec3", "message": "add new feature again", "committedDate": "2020-11-04T01:37:30Z", "type": "commit"}, {"oid": "847b8f76164cabc2630f28bd1f9b7a60c655fc5f", "url": "https://github.com/apache/hadoop/commit/847b8f76164cabc2630f28bd1f9b7a60c655fc5f", "message": "fix BLOCK_STORAGE_POLICY errors of support in FSEditLogOp", "committedDate": "2020-11-04T01:37:30Z", "type": "commit"}, {"oid": "769a7c185bd633660ff9d525b7539cb20a18cad4", "url": "https://github.com/apache/hadoop/commit/769a7c185bd633660ff9d525b7539cb20a18cad4", "message": "delete extra whitespace", "committedDate": "2020-11-04T01:37:30Z", "type": "commit"}, {"oid": "92af855f4d4939e0486a6cf7aa03eb063232b9df", "url": "https://github.com/apache/hadoop/commit/92af855f4d4939e0486a6cf7aa03eb063232b9df", "message": "Adjust the Namenode's layout version and add new function judgment to the setQuota of the FDNamesystem class", "committedDate": "2020-11-04T01:37:30Z", "type": "commit"}, {"oid": "6ba960538e32dfe2eb28085a6769adcc552005bc", "url": "https://github.com/apache/hadoop/commit/6ba960538e32dfe2eb28085a6769adcc552005bc", "message": "Adjust the Namenode's layout version and add new function judgment to the setQuota of the FDNamesystem class", "committedDate": "2020-11-04T01:37:30Z", "type": "commit"}, {"oid": "e3eadaa8a78858d2abbc2c13e92613d4948c1366", "url": "https://github.com/apache/hadoop/commit/e3eadaa8a78858d2abbc2c13e92613d4948c1366", "message": "Adjust the Namenode's layout version and add new function judgment to the setQuota of the FDNamesystem class", "committedDate": "2020-11-04T01:37:30Z", "type": "commit"}, {"oid": "a88eb6c8131233546d6e0cdd6615ecd8b23fffaf", "url": "https://github.com/apache/hadoop/commit/a88eb6c8131233546d6e0cdd6615ecd8b23fffaf", "message": "Adjust the Namenode's layout version and add new function judgment to the setQuota of the FDNamesystem class", "committedDate": "2020-11-04T01:37:30Z", "type": "commit"}, {"oid": "56bcbbdabc89e4814447525e605b19e39c2cb854", "url": "https://github.com/apache/hadoop/commit/56bcbbdabc89e4814447525e605b19e39c2cb854", "message": "HDFS-15624 Fix NVDIMM storage issues\n\nThis changes:\n1. puts NVDIMM to the end of storage type enum\n   to make sure compatibility.\n2. adds check for setQuota() and setStoragePolicy()\n   to make sure the software layout version is\n   satisfied.", "committedDate": "2020-11-04T01:37:30Z", "type": "commit"}, {"oid": "56bcbbdabc89e4814447525e605b19e39c2cb854", "url": "https://github.com/apache/hadoop/commit/56bcbbdabc89e4814447525e605b19e39c2cb854", "message": "HDFS-15624 Fix NVDIMM storage issues\n\nThis changes:\n1. puts NVDIMM to the end of storage type enum\n   to make sure compatibility.\n2. adds check for setQuota() and setStoragePolicy()\n   to make sure the software layout version is\n   satisfied.", "committedDate": "2020-11-04T01:37:30Z", "type": "forcePushed"}, {"oid": "15f0386bb80ce5013578e1e441cf99682b9a0cb5", "url": "https://github.com/apache/hadoop/commit/15f0386bb80ce5013578e1e441cf99682b9a0cb5", "message": "Merge branch 'trunk' into HDFS-15624", "committedDate": "2020-12-08T02:59:28Z", "type": "commit"}]}