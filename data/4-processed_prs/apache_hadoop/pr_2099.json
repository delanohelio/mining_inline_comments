{"pr_number": 2099, "pr_title": "HADOOP-17089: WASB: Update azure-storage-java SDK", "pr_createdAt": "2020-06-24T18:46:45Z", "pr_url": "https://github.com/apache/hadoop/pull/2099", "timeline": [{"oid": "1d45647620ecc0d3994239beb4f3b6597d58bbdd", "url": "https://github.com/apache/hadoop/commit/1d45647620ecc0d3994239beb4f3b6597d58bbdd", "message": "HADOOP-17089: WASB: Update azure-storage-java SDK\nContributed by Thomas Marquardt\n\nDETAILS: WASB depends on the Azure Storage Java SDK. There is a concurrency\nbug in the Azure Storage Java SDK that can cause the results of a list blobs\noperation to appear empty. This causes the Filesystem listStatus and similar\nAPIs to return empty results. This has been seen in Spark work loads when jobs\nuse more than one executor core.\n\nSee Azure/azure-storage-java#546 for details on the bug in the Azure Storage SDK.\n\nTESTS: A new test was added to validate the fix. All tests are passing:\n\nwasb:\nmvn -T 1C -Dparallel-tests=wasb -Dscale -DtestsThreadCount=8 clean verify\nTests run: 248, Failures: 0, Errors: 0, Skipped: 11\nTests run: 651, Failures: 0, Errors: 0, Skipped: 65\n\nabfs:\nmvn -T 1C -Dparallel-tests=abfs -Dscale -DtestsThreadCount=8 clean verify\nTests run: 64, Failures: 0, Errors: 0, Skipped: 0\nTests run: 437, Failures: 0, Errors: 0, Skipped: 33\nTests run: 206, Failures: 0, Errors: 0, Skipped: 24", "committedDate": "2020-06-24T23:20:39Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTI2NjU2Nw==", "url": "https://github.com/apache/hadoop/pull/2099#discussion_r445266567", "bodyText": "Yetus complains here:\nassertEquals(\"The list should always contain 1 file.\",1, fileCount);:62: ',' is not followed by whitespace. [WhitespaceAfter]", "author": "DadanielZ", "createdAt": "2020-06-25T02:00:27Z", "path": "hadoop-tools/hadoop-azure/src/test/java/org/apache/hadoop/fs/azure/ITestNativeAzureFileSystemConcurrencyLive.java", "diffHunk": "@@ -130,15 +131,55 @@ public void testConcurrentDeleteFile() throws Exception {\n     }\n   }\n \n+  /**\n+   * Validate the bug fix for HADOOP-17089.  Please note that we were never\n+   * able to reproduce this except during a Spark job that ran for multiple days\n+   * and in a hacked-up azure-storage SDK that added sleep before and after\n+   * the call to factory.setNamespaceAware(true) as shown in the description of\n+   * https://github.com/Azure/azure-storage-java/pull/546.\n+   */\n+  @Test(timeout = TEST_EXECUTION_TIMEOUT)\n+  public void testConcurrentList() throws Exception {\n+    final Path testDir = new Path(\"/tmp/data-loss/11230174258112/_temporary/0/_temporary/attempt_20200624190514_0006_m_0\");\n+    final Path testFile = new Path(testDir, \"part-00004-15ea87b1-312c-4fdf-1820-95afb3dfc1c3-a010.snappy.parquet\");\n+    fs.create(testFile).close();\n+    List<ListTask> tasks = new ArrayList<>(THREAD_COUNT);\n+\n+    for (int i = 0; i < THREAD_COUNT; i++) {\n+      tasks.add(new ListTask(fs, testDir));\n+    }\n+\n+    ExecutorService es = null;\n+    try {\n+      es = Executors.newFixedThreadPool(THREAD_COUNT);\n+\n+      List<Future<Integer>> futures = es.invokeAll(tasks);\n+\n+      for (Future<Integer> future : futures) {\n+        Assert.assertTrue(future.isDone());\n+\n+        // we are using Callable<V>, so if an exception\n+        // occurred during the operation, it will be thrown\n+        // when we call get\n+        long fileCount = future.get();\n+        assertEquals(\"The list should always contain 1 file.\",1, fileCount);", "originalCommit": "1d45647620ecc0d3994239beb4f3b6597d58bbdd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTI3NDgwOA==", "url": "https://github.com/apache/hadoop/pull/2099#discussion_r445274808", "bodyText": "Thanks for the review Da.  Fixed!", "author": "ThomasMarquardt", "createdAt": "2020-06-25T02:34:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTI2NjU2Nw=="}], "type": "inlineReview"}, {"oid": "4b5b54c73f2fd9146237087a59453e2b5d70f9ed", "url": "https://github.com/apache/hadoop/commit/4b5b54c73f2fd9146237087a59453e2b5d70f9ed", "message": "HADOOP-17089: WASB: Update azure-storage-java SDK\nContributed by Thomas Marquardt\n\nDETAILS: WASB depends on the Azure Storage Java SDK. There is a concurrency\nbug in the Azure Storage Java SDK that can cause the results of a list blobs\noperation to appear empty. This causes the Filesystem listStatus and similar\nAPIs to return empty results. This has been seen in Spark work loads when jobs\nuse more than one executor core.\n\nSee Azure/azure-storage-java#546 for details on the bug in the Azure Storage SDK.\n\nTESTS: A new test was added to validate the fix. All tests are passing:\n\nwasb:\nmvn -T 1C -Dparallel-tests=wasb -Dscale -DtestsThreadCount=8 clean verify\nTests run: 248, Failures: 0, Errors: 0, Skipped: 11\nTests run: 651, Failures: 0, Errors: 0, Skipped: 65\n\nabfs:\nmvn -T 1C -Dparallel-tests=abfs -Dscale -DtestsThreadCount=8 clean verify\nTests run: 64, Failures: 0, Errors: 0, Skipped: 0\nTests run: 437, Failures: 0, Errors: 0, Skipped: 33\nTests run: 206, Failures: 0, Errors: 0, Skipped: 24", "committedDate": "2020-06-25T02:32:42Z", "type": "commit"}, {"oid": "4b5b54c73f2fd9146237087a59453e2b5d70f9ed", "url": "https://github.com/apache/hadoop/commit/4b5b54c73f2fd9146237087a59453e2b5d70f9ed", "message": "HADOOP-17089: WASB: Update azure-storage-java SDK\nContributed by Thomas Marquardt\n\nDETAILS: WASB depends on the Azure Storage Java SDK. There is a concurrency\nbug in the Azure Storage Java SDK that can cause the results of a list blobs\noperation to appear empty. This causes the Filesystem listStatus and similar\nAPIs to return empty results. This has been seen in Spark work loads when jobs\nuse more than one executor core.\n\nSee Azure/azure-storage-java#546 for details on the bug in the Azure Storage SDK.\n\nTESTS: A new test was added to validate the fix. All tests are passing:\n\nwasb:\nmvn -T 1C -Dparallel-tests=wasb -Dscale -DtestsThreadCount=8 clean verify\nTests run: 248, Failures: 0, Errors: 0, Skipped: 11\nTests run: 651, Failures: 0, Errors: 0, Skipped: 65\n\nabfs:\nmvn -T 1C -Dparallel-tests=abfs -Dscale -DtestsThreadCount=8 clean verify\nTests run: 64, Failures: 0, Errors: 0, Skipped: 0\nTests run: 437, Failures: 0, Errors: 0, Skipped: 33\nTests run: 206, Failures: 0, Errors: 0, Skipped: 24", "committedDate": "2020-06-25T02:32:42Z", "type": "forcePushed"}]}