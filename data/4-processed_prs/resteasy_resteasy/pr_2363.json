{"pr_number": 2363, "pr_title": "[RESTEASY-2548] add new provider with higher priority than JaxrsFormP\u2026", "pr_createdAt": "2020-04-21T22:10:10Z", "pr_url": "https://github.com/resteasy/resteasy/pull/2363", "timeline": [{"oid": "c730a10f121cafa7e9200871c1ce4d63e59ca7e3", "url": "https://github.com/resteasy/resteasy/commit/c730a10f121cafa7e9200871c1ce4d63e59ca7e3", "message": "[RESTEASY-2548] add new provider with higher priority than JaxrsFormProvider\n\nadding test", "committedDate": "2020-04-22T14:32:12Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDQzNzM3Mw==", "url": "https://github.com/resteasy/resteasy/pull/2363#discussion_r414437373", "bodyText": "Do we really need to create a new instance of FormUrlEncodedProvider for each invocation?", "author": "asoldano", "createdAt": "2020-04-24T09:36:43Z", "path": "resteasy-core/src/main/java/org/jboss/resteasy/plugins/providers/JaxrsServerFormUrlEncodedProvider.java", "diffHunk": "@@ -0,0 +1,97 @@\n+package org.jboss.resteasy.plugins.providers;\n+\n+import org.jboss.resteasy.resteasy_jaxrs.i18n.LogMessages;\n+import org.jboss.resteasy.spi.AsyncMessageBodyWriter;\n+import org.jboss.resteasy.spi.AsyncOutputStream;\n+import org.jboss.resteasy.spi.HttpRequest;\n+import org.jboss.resteasy.spi.util.FindAnnotation;\n+\n+import javax.annotation.Priority;\n+import javax.ws.rs.Consumes;\n+import javax.ws.rs.Encoded;\n+import javax.ws.rs.Priorities;\n+import javax.ws.rs.Produces;\n+import javax.ws.rs.WebApplicationException;\n+import javax.ws.rs.core.Context;\n+import javax.ws.rs.core.Form;\n+import javax.ws.rs.core.MediaType;\n+import javax.ws.rs.core.MultivaluedMap;\n+import javax.ws.rs.ext.MessageBodyReader;\n+import javax.ws.rs.ext.Provider;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.OutputStream;\n+import java.lang.annotation.Annotation;\n+import java.lang.reflect.Type;\n+import java.util.concurrent.CompletionStage;\n+\n+@Priority(Priorities.AUTHORIZATION)\n+@Provider\n+@Produces(\"application/x-www-form-urlencoded\")\n+@Consumes(\"application/x-www-form-urlencoded\")\n+public class JaxrsServerFormUrlEncodedProvider  implements MessageBodyReader<Form>, AsyncMessageBodyWriter<Form>\n+{\n+    protected boolean useContainerParams;\n+\n+    public JaxrsServerFormUrlEncodedProvider(final boolean useContainerParams)\n+    {\n+        this.useContainerParams = useContainerParams;\n+    }\n+\n+    @Override\n+    public boolean isReadable(Class<?> type, Type genericType, Annotation[] annotations, MediaType mediaType)\n+    {\n+        return (useContainerParams && Form.class.isAssignableFrom(type));\n+    }\n+\n+    @Context\n+    HttpRequest request;\n+\n+    @Override\n+    public Form readFrom(Class<Form> type, Type genericType, Annotation[] annotations, MediaType mediaType, MultivaluedMap<String, String> httpHeaders, InputStream entityStream) throws IOException, WebApplicationException\n+    {\n+        LogMessages.LOGGER.debugf(\"Provider : %s,  Method : readFrom\", getClass().getName());\n+        @SuppressWarnings(value = \"unchecked\")\n+        MultivaluedMap<String, String> map = null;\n+        if (useContainerParams) {\n+            boolean encoded = FindAnnotation.findAnnotation(annotations, Encoded.class) != null;\n+            if (encoded) {\n+                map = request.getFormParameters();\n+            } else {\n+                map = request.getDecodedFormParameters();\n+            }\n+        } else {\n+            map = new FormUrlEncodedProvider().readFrom(null, null,\n+                    annotations, mediaType, httpHeaders, entityStream);\n+        }\n+        return new Form(map);\n+    }\n+\n+    @Override\n+    public boolean isWriteable(Class<?> type, Type genericType, Annotation[] annotations, MediaType mediaType)\n+    {\n+        return Form.class.isAssignableFrom(type);\n+    }\n+\n+    @Override\n+    public long getSize(Form form, Class<?> type, Type genericType, Annotation[] annotations, MediaType mediaType)\n+    {\n+        return -1;\n+    }\n+\n+    @Override\n+    public void writeTo(Form form, Class<?> type, Type genericType, Annotation[] annotations, MediaType mediaType, MultivaluedMap<String, Object> httpHeaders, OutputStream entityStream) throws IOException, WebApplicationException\n+    {\n+        LogMessages.LOGGER.debugf(\"Provider : %s,  Method : writeTo\", getClass().getName());\n+        new FormUrlEncodedProvider().writeTo(form.asMap(), null, null, annotations, mediaType, httpHeaders, entityStream);", "originalCommit": "c730a10f121cafa7e9200871c1ce4d63e59ca7e3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDQzNzUyNQ==", "url": "https://github.com/resteasy/resteasy/pull/2363#discussion_r414437525", "bodyText": "Same as above", "author": "asoldano", "createdAt": "2020-04-24T09:36:55Z", "path": "resteasy-core/src/main/java/org/jboss/resteasy/plugins/providers/JaxrsServerFormUrlEncodedProvider.java", "diffHunk": "@@ -0,0 +1,97 @@\n+package org.jboss.resteasy.plugins.providers;\n+\n+import org.jboss.resteasy.resteasy_jaxrs.i18n.LogMessages;\n+import org.jboss.resteasy.spi.AsyncMessageBodyWriter;\n+import org.jboss.resteasy.spi.AsyncOutputStream;\n+import org.jboss.resteasy.spi.HttpRequest;\n+import org.jboss.resteasy.spi.util.FindAnnotation;\n+\n+import javax.annotation.Priority;\n+import javax.ws.rs.Consumes;\n+import javax.ws.rs.Encoded;\n+import javax.ws.rs.Priorities;\n+import javax.ws.rs.Produces;\n+import javax.ws.rs.WebApplicationException;\n+import javax.ws.rs.core.Context;\n+import javax.ws.rs.core.Form;\n+import javax.ws.rs.core.MediaType;\n+import javax.ws.rs.core.MultivaluedMap;\n+import javax.ws.rs.ext.MessageBodyReader;\n+import javax.ws.rs.ext.Provider;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.OutputStream;\n+import java.lang.annotation.Annotation;\n+import java.lang.reflect.Type;\n+import java.util.concurrent.CompletionStage;\n+\n+@Priority(Priorities.AUTHORIZATION)\n+@Provider\n+@Produces(\"application/x-www-form-urlencoded\")\n+@Consumes(\"application/x-www-form-urlencoded\")\n+public class JaxrsServerFormUrlEncodedProvider  implements MessageBodyReader<Form>, AsyncMessageBodyWriter<Form>\n+{\n+    protected boolean useContainerParams;\n+\n+    public JaxrsServerFormUrlEncodedProvider(final boolean useContainerParams)\n+    {\n+        this.useContainerParams = useContainerParams;\n+    }\n+\n+    @Override\n+    public boolean isReadable(Class<?> type, Type genericType, Annotation[] annotations, MediaType mediaType)\n+    {\n+        return (useContainerParams && Form.class.isAssignableFrom(type));\n+    }\n+\n+    @Context\n+    HttpRequest request;\n+\n+    @Override\n+    public Form readFrom(Class<Form> type, Type genericType, Annotation[] annotations, MediaType mediaType, MultivaluedMap<String, String> httpHeaders, InputStream entityStream) throws IOException, WebApplicationException\n+    {\n+        LogMessages.LOGGER.debugf(\"Provider : %s,  Method : readFrom\", getClass().getName());\n+        @SuppressWarnings(value = \"unchecked\")\n+        MultivaluedMap<String, String> map = null;\n+        if (useContainerParams) {\n+            boolean encoded = FindAnnotation.findAnnotation(annotations, Encoded.class) != null;\n+            if (encoded) {\n+                map = request.getFormParameters();\n+            } else {\n+                map = request.getDecodedFormParameters();\n+            }\n+        } else {\n+            map = new FormUrlEncodedProvider().readFrom(null, null,\n+                    annotations, mediaType, httpHeaders, entityStream);\n+        }\n+        return new Form(map);\n+    }\n+\n+    @Override\n+    public boolean isWriteable(Class<?> type, Type genericType, Annotation[] annotations, MediaType mediaType)\n+    {\n+        return Form.class.isAssignableFrom(type);\n+    }\n+\n+    @Override\n+    public long getSize(Form form, Class<?> type, Type genericType, Annotation[] annotations, MediaType mediaType)\n+    {\n+        return -1;\n+    }\n+\n+    @Override\n+    public void writeTo(Form form, Class<?> type, Type genericType, Annotation[] annotations, MediaType mediaType, MultivaluedMap<String, Object> httpHeaders, OutputStream entityStream) throws IOException, WebApplicationException\n+    {\n+        LogMessages.LOGGER.debugf(\"Provider : %s,  Method : writeTo\", getClass().getName());\n+        new FormUrlEncodedProvider().writeTo(form.asMap(), null, null, annotations, mediaType, httpHeaders, entityStream);\n+    }\n+\n+    @Override\n+    public CompletionStage<Void> asyncWriteTo(Form form, Class<?> type, Type genericType, Annotation[] annotations,\n+                                              MediaType mediaType, MultivaluedMap<String, Object> httpHeaders,\n+                                              AsyncOutputStream entityStream)\n+    {\n+        LogMessages.LOGGER.debugf(\"Provider : %s,  Method : writeTo\", getClass().getName());\n+        return new FormUrlEncodedProvider().asyncWriteTo(form.asMap(), null, null, annotations, mediaType, httpHeaders, entityStream);", "originalCommit": "c730a10f121cafa7e9200871c1ce4d63e59ca7e3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDQzODE1OQ==", "url": "https://github.com/resteasy/resteasy/pull/2363#discussion_r414438159", "bodyText": "Do we really need to create a new instance of FormUrlEncodedProvider for each invocation?", "author": "asoldano", "createdAt": "2020-04-24T09:37:56Z", "path": "resteasy-core/src/main/java/org/jboss/resteasy/plugins/providers/JaxrsServerFormUrlEncodedProvider.java", "diffHunk": "@@ -0,0 +1,97 @@\n+package org.jboss.resteasy.plugins.providers;\n+\n+import org.jboss.resteasy.resteasy_jaxrs.i18n.LogMessages;\n+import org.jboss.resteasy.spi.AsyncMessageBodyWriter;\n+import org.jboss.resteasy.spi.AsyncOutputStream;\n+import org.jboss.resteasy.spi.HttpRequest;\n+import org.jboss.resteasy.spi.util.FindAnnotation;\n+\n+import javax.annotation.Priority;\n+import javax.ws.rs.Consumes;\n+import javax.ws.rs.Encoded;\n+import javax.ws.rs.Priorities;\n+import javax.ws.rs.Produces;\n+import javax.ws.rs.WebApplicationException;\n+import javax.ws.rs.core.Context;\n+import javax.ws.rs.core.Form;\n+import javax.ws.rs.core.MediaType;\n+import javax.ws.rs.core.MultivaluedMap;\n+import javax.ws.rs.ext.MessageBodyReader;\n+import javax.ws.rs.ext.Provider;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.OutputStream;\n+import java.lang.annotation.Annotation;\n+import java.lang.reflect.Type;\n+import java.util.concurrent.CompletionStage;\n+\n+@Priority(Priorities.AUTHORIZATION)\n+@Provider\n+@Produces(\"application/x-www-form-urlencoded\")\n+@Consumes(\"application/x-www-form-urlencoded\")\n+public class JaxrsServerFormUrlEncodedProvider  implements MessageBodyReader<Form>, AsyncMessageBodyWriter<Form>\n+{\n+    protected boolean useContainerParams;\n+\n+    public JaxrsServerFormUrlEncodedProvider(final boolean useContainerParams)\n+    {\n+        this.useContainerParams = useContainerParams;\n+    }\n+\n+    @Override\n+    public boolean isReadable(Class<?> type, Type genericType, Annotation[] annotations, MediaType mediaType)\n+    {\n+        return (useContainerParams && Form.class.isAssignableFrom(type));\n+    }\n+\n+    @Context\n+    HttpRequest request;\n+\n+    @Override\n+    public Form readFrom(Class<Form> type, Type genericType, Annotation[] annotations, MediaType mediaType, MultivaluedMap<String, String> httpHeaders, InputStream entityStream) throws IOException, WebApplicationException\n+    {\n+        LogMessages.LOGGER.debugf(\"Provider : %s,  Method : readFrom\", getClass().getName());\n+        @SuppressWarnings(value = \"unchecked\")\n+        MultivaluedMap<String, String> map = null;\n+        if (useContainerParams) {\n+            boolean encoded = FindAnnotation.findAnnotation(annotations, Encoded.class) != null;\n+            if (encoded) {\n+                map = request.getFormParameters();\n+            } else {\n+                map = request.getDecodedFormParameters();\n+            }\n+        } else {\n+            map = new FormUrlEncodedProvider().readFrom(null, null,\n+                    annotations, mediaType, httpHeaders, entityStream);", "originalCommit": "c730a10f121cafa7e9200871c1ce4d63e59ca7e3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "fd6c76663cf9fb271bb6e133d85a7990a81f3556", "url": "https://github.com/resteasy/resteasy/commit/fd6c76663cf9fb271bb6e133d85a7990a81f3556", "message": "[RESTEASY-2548] add new provider with higher priority than JaxrsFormProvider\n\nadding test", "committedDate": "2020-04-28T15:28:33Z", "type": "commit"}, {"oid": "fd6c76663cf9fb271bb6e133d85a7990a81f3556", "url": "https://github.com/resteasy/resteasy/commit/fd6c76663cf9fb271bb6e133d85a7990a81f3556", "message": "[RESTEASY-2548] add new provider with higher priority than JaxrsFormProvider\n\nadding test", "committedDate": "2020-04-28T15:28:33Z", "type": "forcePushed"}]}