{"pr_number": 2361, "pr_title": "[RESTEASY-2017]:Fix SSE doesn't work with inherited annotations", "pr_createdAt": "2020-04-21T12:58:00Z", "pr_url": "https://github.com/resteasy/resteasy/pull/2361", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDQyOTI0Nw==", "url": "https://github.com/resteasy/resteasy/pull/2361#discussion_r414429247", "bodyText": "Shouldn't the client (and the event source) be closed before leaving the test?", "author": "asoldano", "createdAt": "2020-04-24T09:24:02Z", "path": "testsuite/integration-tests/src/test/java/org/jboss/resteasy/test/providers/sse/SseAPITest.java", "diffHunk": "@@ -0,0 +1,69 @@\n+package org.jboss.resteasy.test.providers.sse;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.concurrent.CountDownLatch;\n+import java.util.concurrent.TimeUnit;\n+\n+import javax.ws.rs.client.Client;\n+import javax.ws.rs.client.ClientBuilder;\n+import javax.ws.rs.client.WebTarget;\n+import javax.ws.rs.sse.SseEventSource;\n+\n+import org.jboss.arquillian.container.test.api.Deployment;\n+import org.jboss.arquillian.container.test.api.RunAsClient;\n+import org.jboss.arquillian.junit.Arquillian;\n+import org.jboss.resteasy.utils.PermissionUtil;\n+import org.jboss.resteasy.utils.PortProviderUtil;\n+import org.jboss.resteasy.utils.TestUtil;\n+import org.jboss.shrinkwrap.api.Archive;\n+import org.jboss.shrinkwrap.api.asset.EmptyAsset;\n+import org.jboss.shrinkwrap.api.spec.WebArchive;\n+import org.junit.Assert;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+\n+@RunWith(Arquillian.class)\n+@RunAsClient\n+public class SseAPITest {\n+    @Deployment\n+    public static Archive<?> deploy() {\n+        WebArchive war = TestUtil.prepareArchive(SseAPITest.class.getSimpleName());\n+        war.addAsManifestResource(EmptyAsset.INSTANCE, \"beans.xml\");\n+        war.addAsManifestResource(PermissionUtil.createPermissionsXmlAsset(new RuntimePermission(\"modifyThread\")),\n+                \"permissions.xml\");\n+        return TestUtil.finishContainerPrepare(war, null, SseAPIImpl.class, SseAPI.class);\n+    }\n+\n+    private String generateURL(String path) {\n+        return PortProviderUtil.generateURL(path, SseAPITest.class.getSimpleName());\n+    }\n+\n+    // test for RESTEASY-2017:SSE doesn't work with inherited annotations\n+    @Test\n+    public void testAnnotaitonInherited() throws Exception {\n+        final List<String> results = new ArrayList<String>();\n+        Client client = ClientBuilder.newBuilder().build();\n+        WebTarget target = client.target(generateURL(\"/apitest/events\"));\n+        SseEventSource msgEventSource = SseEventSource.target(target).build();\n+\n+        try (SseEventSource eventSource = msgEventSource) {\n+            CountDownLatch countDownLatch = new CountDownLatch(1);\n+            eventSource.register(event -> {\n+                countDownLatch.countDown();\n+                results.add(event.readData(String.class));\n+            }, e -> {\n+                throw new RuntimeException(e);\n+            });\n+            eventSource.open();\n+            WebTarget sendTarget = client.target(generateURL(\"/apitest/send\"));\n+            sendTarget.request().get();\n+            boolean result = countDownLatch.await(30, TimeUnit.SECONDS);\n+            Assert.assertTrue(\"Waiting for event to be delivered has timed out.\", result);\n+        }\n+        Assert.assertEquals(\"One event message was expected.\", 1, results.size());\n+        Assert.assertTrue(\"Expected event contains:AnnotationInheritedEvent, but is:\" + results.get(0),\n+                results.get(0).contains(\"AnnotationInheritedEvent\"));\n+    }", "originalCommit": "f6ff5ee23b16a3ce2792973e0fc30f169dc36a2d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTQzOTgwMQ==", "url": "https://github.com/resteasy/resteasy/pull/2361#discussion_r415439801", "bodyText": "Fixed", "author": "jimma", "createdAt": "2020-04-27T00:35:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDQyOTI0Nw=="}], "type": "inlineReview"}, {"oid": "3ab306fd0c755bf541ffdf328de8b808a823a086", "url": "https://github.com/resteasy/resteasy/commit/3ab306fd0c755bf541ffdf328de8b808a823a086", "message": "RESTEASY-2017]:Fix SSE doesn't work with inherited annotations", "committedDate": "2020-04-26T13:17:10Z", "type": "forcePushed"}, {"oid": "8de691f916238f6e9d1a2c9372ed41c294ebf1d4", "url": "https://github.com/resteasy/resteasy/commit/8de691f916238f6e9d1a2c9372ed41c294ebf1d4", "message": "RESTEASY-2017]:Fix SSE doesn't work with inherited annotations", "committedDate": "2020-04-28T03:04:48Z", "type": "forcePushed"}, {"oid": "5160d6a610642f2a60d98b32947589e346786612", "url": "https://github.com/resteasy/resteasy/commit/5160d6a610642f2a60d98b32947589e346786612", "message": "[RESTEASY-2017]:Fix SSE doesn't work with inherited annotations", "committedDate": "2020-04-28T08:17:15Z", "type": "forcePushed"}, {"oid": "962ec63e6bdf1cfb7f37d57b56efced2c5be7356", "url": "https://github.com/resteasy/resteasy/commit/962ec63e6bdf1cfb7f37d57b56efced2c5be7356", "message": "[RESTEASY-2017]:Fix SSE doesn't work with inherited annotations", "committedDate": "2020-04-28T12:05:36Z", "type": "forcePushed"}, {"oid": "7b4f4c43c12b91ebdb76317afbb32f2d983d1977", "url": "https://github.com/resteasy/resteasy/commit/7b4f4c43c12b91ebdb76317afbb32f2d983d1977", "message": "[RESTEASY-2017]:Fix SSE doesn't work with inherited annotations", "committedDate": "2020-05-12T12:13:45Z", "type": "forcePushed"}, {"oid": "1f51064450974442425aac50b4b2875615072bfd", "url": "https://github.com/resteasy/resteasy/commit/1f51064450974442425aac50b4b2875615072bfd", "message": "[RESTEASY-2017]:Fix SSE doesn't work with inherited annotations", "committedDate": "2020-05-12T12:33:52Z", "type": "commit"}, {"oid": "1f51064450974442425aac50b4b2875615072bfd", "url": "https://github.com/resteasy/resteasy/commit/1f51064450974442425aac50b4b2875615072bfd", "message": "[RESTEASY-2017]:Fix SSE doesn't work with inherited annotations", "committedDate": "2020-05-12T12:33:52Z", "type": "forcePushed"}]}