{"pr_number": 2582, "pr_title": "Add test for https://github.com/resteasy/Resteasy/pull/2578", "pr_createdAt": "2020-10-26T08:56:05Z", "pr_url": "https://github.com/resteasy/resteasy/pull/2582", "timeline": [{"oid": "3be33baeb41f065c38b02fdab57a3f4a08621e45", "url": "https://github.com/resteasy/resteasy/commit/3be33baeb41f065c38b02fdab57a3f4a08621e45", "message": "Dependency-free implementation of the SSE Publisher", "committedDate": "2020-10-22T15:06:21Z", "type": "commit"}, {"oid": "3d1c950100a39d8e0db959010853a594ae066c6c", "url": "https://github.com/resteasy/resteasy/commit/3d1c950100a39d8e0db959010853a594ae066c6c", "message": "Add sse publisher test", "committedDate": "2020-10-23T11:50:55Z", "type": "commit"}, {"oid": "d0b6049a4a9fbb8fd00dcad646c4c3a1acd99a4a", "url": "https://github.com/resteasy/resteasy/commit/d0b6049a4a9fbb8fd00dcad646c4c3a1acd99a4a", "message": "Add executor to SSEPublisher;Refactor test", "committedDate": "2020-10-26T08:33:04Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTgyMzA3NQ==", "url": "https://github.com/resteasy/resteasy/pull/2582#discussion_r511823075", "bodyText": "Shouldn't we remove this commented line?", "author": "cescoffier", "createdAt": "2020-10-26T09:30:51Z", "path": "resteasy-client-microprofile-base/src/main/java/org/jboss/resteasy/microprofile/client/RestClientBuilderImpl.java", "diffHunk": "@@ -20,6 +20,8 @@\n import org.jboss.resteasy.microprofile.client.header.ClientHeadersRequestFilter;\n import org.jboss.resteasy.microprofile.client.impl.MpClient;\n import org.jboss.resteasy.microprofile.client.impl.MpClientBuilderImpl;\n+import org.jboss.resteasy.microprofile.client.publisher.MpPublisherMessageBodyReader;\n+//import org.jboss.resteasy.microprofile.client.publisher.MpPublisherMessageBodyReader;", "originalCommit": "d0b6049a4a9fbb8fd00dcad646c4c3a1acd99a4a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTg0MTEyOQ==", "url": "https://github.com/resteasy/resteasy/pull/2582#discussion_r511841129", "bodyText": "Thanks. Fixed.", "author": "jimma", "createdAt": "2020-10-26T10:00:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTgyMzA3NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTgyNDAxNw==", "url": "https://github.com/resteasy/resteasy/pull/2582#discussion_r511824017", "bodyText": "should it handle rejection?", "author": "cescoffier", "createdAt": "2020-10-26T09:32:14Z", "path": "resteasy-client-microprofile-base/src/main/java/org/jboss/resteasy/microprofile/client/publisher/SSEPublisher.java", "diffHunk": "@@ -0,0 +1,290 @@\n+package org.jboss.resteasy.microprofile.client.publisher;\n+\n+import org.jboss.logging.Logger;\n+import org.jboss.resteasy.core.ResteasyContext;\n+import org.jboss.resteasy.plugins.providers.sse.SseEventInputImpl;\n+import org.reactivestreams.Publisher;\n+import org.reactivestreams.Subscriber;\n+import org.reactivestreams.Subscription;\n+\n+import javax.ws.rs.ext.Providers;\n+import javax.ws.rs.sse.InboundSseEvent;\n+\n+import java.lang.reflect.ParameterizedType;\n+import java.lang.reflect.Type;\n+import java.util.Map;\n+import java.util.Queue;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.atomic.AtomicInteger;\n+import java.util.concurrent.atomic.AtomicLong;\n+import java.util.concurrent.atomic.AtomicReference;\n+\n+/**\n+ * Publisher implementation emitting server-sent-event downstream.\n+ *\n+ * @param <T> the type of event.\n+ */\n+@SuppressWarnings(\"ReactiveStreamsPublisherImplementation\")\n+public class SSEPublisher<T> implements Publisher<T> {\n+\n+    private static final Runnable CLEARED = () -> {\n+        // sentinel indicating we are done.\n+    };\n+\n+    private final SseEventInputImpl input;\n+    private final Type genericType;\n+    private final Providers providers;\n+    private final ExecutorService executor;\n+\n+    private static final Logger LOGGER = Logger.getLogger(SSEPublisher.class);\n+\n+    public SSEPublisher(final Type genericType, final Providers providers, final SseEventInputImpl input, final ExecutorService es) {\n+        this.genericType = genericType;\n+        this.input = input;\n+        this.providers = providers;\n+        this.executor = es;\n+    }\n+\n+    @Override\n+    public void subscribe(final Subscriber<? super T> downstream) {\n+        SSEProcessor<? super T> processor = new SSEProcessor<>(downstream,\n+                Integer.getInteger(\"resteasy.microprofile.sseclient.buffersize\", 512));\n+        downstream.onSubscribe(processor);\n+        pump(processor, input);\n+    }\n+\n+    /**\n+     * Reads the server-sent event from the {@code input} and pass them to the processor.\n+     * The processor handles the downstream requests and buffer/drop items according to them.\n+     *\n+     * @param processor the stream\n+     * @param input     the SSE input\n+     */\n+    @SuppressWarnings({ \"rawtypes\", \"unchecked\" })\n+    private void pump(final SSEProcessor processor, final SseEventInputImpl input) {\n+        Map<Class<?>, Object> contextDataMap = ResteasyContext.getContextDataMap();\n+        executor.execute(() -> {", "originalCommit": "d0b6049a4a9fbb8fd00dcad646c4c3a1acd99a4a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTg0MTE5Mg==", "url": "https://github.com/resteasy/resteasy/pull/2582#discussion_r511841192", "bodyText": "Do you mean handle executor injection ?", "author": "jimma", "createdAt": "2020-10-26T10:00:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTgyNDAxNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTg1NzY5Mw==", "url": "https://github.com/resteasy/resteasy/pull/2582#discussion_r511857693", "bodyText": "if the executor is stopped (for whatever reason), you cannot submit another task. You will receive a RejectedExecutionException. What should we do in this case? Log and return a failed publisher? Log and return a Publisher just emitting the completion signal?", "author": "cescoffier", "createdAt": "2020-10-26T10:28:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTgyNDAxNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjAyNzA0Mw==", "url": "https://github.com/resteasy/resteasy/pull/2582#discussion_r512027043", "bodyText": "@cescoffier Thanks for pointing out this issue.  I modified to this to create a new thread to run this if there is RejectedExecutionException thrown.", "author": "jimma", "createdAt": "2020-10-26T14:58:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTgyNDAxNw=="}], "type": "inlineReview"}, {"oid": "7db7d440f8d0ed9ae0855134edbe1236b48f2be9", "url": "https://github.com/resteasy/resteasy/commit/7db7d440f8d0ed9ae0855134edbe1236b48f2be9", "message": "Minor change : clean up", "committedDate": "2020-10-26T09:52:28Z", "type": "commit"}, {"oid": "ee2dd61705623ae6f1ed448a82fe67ebe2c6a0d2", "url": "https://github.com/resteasy/resteasy/commit/ee2dd61705623ae6f1ed448a82fe67ebe2c6a0d2", "message": "Handle RejectedExecutionException", "committedDate": "2020-10-26T14:54:11Z", "type": "commit"}]}