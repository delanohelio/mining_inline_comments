{"pr_number": 115, "pr_title": "feat: add new sample - Tables: Relax column query append", "pr_createdAt": "2020-01-17T16:48:28Z", "pr_url": "https://github.com/googleapis/java-bigquery/pull/115", "timeline": [{"oid": "c0af159ef5d888b954c9626b371387e59ac19acb", "url": "https://github.com/googleapis/java-bigquery/commit/c0af159ef5d888b954c9626b371387e59ac19acb", "message": "feat: add new sample - Tables: Relax column query append", "committedDate": "2020-01-17T16:48:02Z", "type": "commit"}, {"oid": "4ff1f36e7a152edf949cd4b729b03349558558b2", "url": "https://github.com/googleapis/java-bigquery/commit/4ff1f36e7a152edf949cd4b729b03349558558b2", "message": "nit", "committedDate": "2020-01-17T17:01:00Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODE4MzY2MQ==", "url": "https://github.com/googleapis/java-bigquery/pull/115#discussion_r368183661", "bodyText": "This should be an arg that you pass in (or more preferably formatted from existing arguments)- all the //TODO's should be in the top function so they are easy to find.\nCan you do something like: String tableRef = String.format(\"%s.%s.%s\", projectId, datasetId, tableName)?", "author": "kurtisvg", "createdAt": "2020-01-18T00:03:17Z", "path": "samples/src/main/java/com/example/bigquery/RelaxTableQuery.java", "diffHunk": "@@ -0,0 +1,99 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.example.bigquery;\n+\n+// [START bigquery_relax_column_query_append]\n+import com.google.cloud.bigquery.BigQuery;\n+import com.google.cloud.bigquery.BigQueryException;\n+import com.google.cloud.bigquery.BigQueryOptions;\n+import com.google.cloud.bigquery.Job;\n+import com.google.cloud.bigquery.JobId;\n+import com.google.cloud.bigquery.JobInfo;\n+import com.google.cloud.bigquery.JobInfo.SchemaUpdateOption;\n+import com.google.cloud.bigquery.JobInfo.WriteDisposition;\n+import com.google.cloud.bigquery.QueryJobConfiguration;\n+import com.google.cloud.bigquery.TableId;\n+import com.google.cloud.bigquery.TableResult;\n+import com.google.common.collect.ImmutableList;\n+import java.util.UUID;\n+\n+public class RelaxTableQuery {\n+\n+  public static void runRelaxTableQuery() {\n+    // TODO(developer): Replace these variables before running the sample.\n+    String datasetName = \"MY_DATASET_NAME\";\n+    String tableName = \"MY_TABLE_NAME\";\n+    relaxTableQuery(datasetName, tableName);\n+  }\n+\n+  public static void relaxTableQuery(String datasetName, String tableName) {\n+    try {\n+      // Initialize client that will be used to send requests. This client only needs to be created\n+      // once, and can be reused for multiple requests.\n+      BigQuery bigquery = BigQueryOptions.getDefaultInstance().getService();\n+\n+      TableId tableId = TableId.of(datasetName, tableName);\n+      String query =\n+          \"SELECT \"\n+              + \"word \"\n+              // TODO(developer): Replace projectId.dataset.tableName with yours", "originalCommit": "4ff1f36e7a152edf949cd4b729b03349558558b2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "1797825105c9e7db0fd9d479e6956bfae04d83a7", "url": "https://github.com/googleapis/java-bigquery/commit/1797825105c9e7db0fd9d479e6956bfae04d83a7", "message": "update based on comments", "committedDate": "2020-01-21T18:17:53Z", "type": "commit"}, {"oid": "c49b78b50527918dcdb64fbf11feb5d0af91a7e7", "url": "https://github.com/googleapis/java-bigquery/commit/c49b78b50527918dcdb64fbf11feb5d0af91a7e7", "message": "update exception handling", "committedDate": "2020-01-22T16:50:45Z", "type": "commit"}, {"oid": "a1393e4b3244a3c5db9e6a361909ae6368e6be48", "url": "https://github.com/googleapis/java-bigquery/commit/a1393e4b3244a3c5db9e6a361909ae6368e6be48", "message": "refactor", "committedDate": "2020-01-23T17:18:30Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDI4NzA1Ng==", "url": "https://github.com/googleapis/java-bigquery/pull/115#discussion_r370287056", "bodyText": "@kurtisvg, do we have a convention for input fields like:\n\"MY_PROJECT_ID\" is all caps because it is some field they have to already have\nWhere\n\"my_dataset_name\" is lower case to show this is a user provided field?", "author": "nnegrey", "createdAt": "2020-01-23T18:37:01Z", "path": "samples/src/main/java/com/example/bigquery/RelaxTableQuery.java", "diffHunk": "@@ -0,0 +1,99 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.example.bigquery;\n+\n+// [START bigquery_relax_column_query_append]\n+import com.google.cloud.bigquery.BigQuery;\n+import com.google.cloud.bigquery.BigQueryException;\n+import com.google.cloud.bigquery.BigQueryOptions;\n+import com.google.cloud.bigquery.Job;\n+import com.google.cloud.bigquery.JobId;\n+import com.google.cloud.bigquery.JobInfo;\n+import com.google.cloud.bigquery.JobInfo.SchemaUpdateOption;\n+import com.google.cloud.bigquery.JobInfo.WriteDisposition;\n+import com.google.cloud.bigquery.QueryJobConfiguration;\n+import com.google.cloud.bigquery.TableId;\n+import com.google.cloud.bigquery.TableResult;\n+import com.google.common.collect.ImmutableList;\n+import java.util.UUID;\n+\n+public class RelaxTableQuery {\n+\n+  public static void runRelaxTableQuery() throws Exception {\n+    // TODO(developer): Replace these variables before running the sample.\n+    String projectId = \"MY_PROJECT_ID\";\n+    String datasetName = \"MY_DATASET_NAME\";", "originalCommit": "a1393e4b3244a3c5db9e6a361909ae6368e6be48", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDI5ODQzNA==", "url": "https://github.com/googleapis/java-bigquery/pull/115#discussion_r370298434", "bodyText": "I think they're both fields to be provided by user - MY_PROJECT_ID is already set only for testing. If they just run the sample, they will still need to provide the projectId.", "author": "stephaniewang526", "createdAt": "2020-01-23T19:01:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDI4NzA1Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDMwMTMzOA==", "url": "https://github.com/googleapis/java-bigquery/pull/115#discussion_r370301338", "bodyText": "We don't have a convention AFIAK - I prefer \"ALL-CAPS-WITH-HYPENS\" but it's not really a significant difference", "author": "kurtisvg", "createdAt": "2020-01-23T19:07:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDI4NzA1Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDI4NzgxNw==", "url": "https://github.com/googleapis/java-bigquery/pull/115#discussion_r370287817", "bodyText": "nit: might be worth adding the rest:\n// Initialize client that will be used to send requests. This client only needs to be created\n// once, and can be reused for multiple requests. After completing all of your requests, call\n// the \"close\" method on the client to safely clean up any remaining background resources.", "author": "nnegrey", "createdAt": "2020-01-23T18:38:36Z", "path": "samples/src/main/java/com/example/bigquery/RelaxTableQuery.java", "diffHunk": "@@ -0,0 +1,99 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.example.bigquery;\n+\n+// [START bigquery_relax_column_query_append]\n+import com.google.cloud.bigquery.BigQuery;\n+import com.google.cloud.bigquery.BigQueryException;\n+import com.google.cloud.bigquery.BigQueryOptions;\n+import com.google.cloud.bigquery.Job;\n+import com.google.cloud.bigquery.JobId;\n+import com.google.cloud.bigquery.JobInfo;\n+import com.google.cloud.bigquery.JobInfo.SchemaUpdateOption;\n+import com.google.cloud.bigquery.JobInfo.WriteDisposition;\n+import com.google.cloud.bigquery.QueryJobConfiguration;\n+import com.google.cloud.bigquery.TableId;\n+import com.google.cloud.bigquery.TableResult;\n+import com.google.common.collect.ImmutableList;\n+import java.util.UUID;\n+\n+public class RelaxTableQuery {\n+\n+  public static void runRelaxTableQuery() throws Exception {\n+    // TODO(developer): Replace these variables before running the sample.\n+    String projectId = \"MY_PROJECT_ID\";\n+    String datasetName = \"MY_DATASET_NAME\";\n+    String tableName = \"MY_TABLE_NAME\";\n+    relaxTableQuery(projectId, datasetName, tableName);\n+  }\n+\n+  public static void relaxTableQuery(String projectId, String datasetName, String tableName)\n+      throws Exception {\n+    try {\n+      // Initialize client that will be used to send requests. This client only needs to be created\n+      // once, and can be reused for multiple requests.", "originalCommit": "a1393e4b3244a3c5db9e6a361909ae6368e6be48", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDI5ODc1MA==", "url": "https://github.com/googleapis/java-bigquery/pull/115#discussion_r370298750", "bodyText": "Unfortunately, BigQuery is Apiary generated and does not have a close method I/the user could call.", "author": "stephaniewang526", "createdAt": "2020-01-23T19:01:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDI4NzgxNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDI4ODc5OQ==", "url": "https://github.com/googleapis/java-bigquery/pull/115#discussion_r370288799", "bodyText": "Do BigQuery samples usually not use the java `try-with-resources?\nLike:\ntry (BigQuery bigquery = BigQueryOptions.getDefaultInstance().getService()) {\n...\n\nhttps://docs.oracle.com/javase/7/docs/technotes/guides/language/try-with-resources.html", "author": "nnegrey", "createdAt": "2020-01-23T18:40:46Z", "path": "samples/src/main/java/com/example/bigquery/RelaxTableQuery.java", "diffHunk": "@@ -0,0 +1,99 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.example.bigquery;\n+\n+// [START bigquery_relax_column_query_append]\n+import com.google.cloud.bigquery.BigQuery;\n+import com.google.cloud.bigquery.BigQueryException;\n+import com.google.cloud.bigquery.BigQueryOptions;\n+import com.google.cloud.bigquery.Job;\n+import com.google.cloud.bigquery.JobId;\n+import com.google.cloud.bigquery.JobInfo;\n+import com.google.cloud.bigquery.JobInfo.SchemaUpdateOption;\n+import com.google.cloud.bigquery.JobInfo.WriteDisposition;\n+import com.google.cloud.bigquery.QueryJobConfiguration;\n+import com.google.cloud.bigquery.TableId;\n+import com.google.cloud.bigquery.TableResult;\n+import com.google.common.collect.ImmutableList;\n+import java.util.UUID;\n+\n+public class RelaxTableQuery {\n+\n+  public static void runRelaxTableQuery() throws Exception {\n+    // TODO(developer): Replace these variables before running the sample.\n+    String projectId = \"MY_PROJECT_ID\";\n+    String datasetName = \"MY_DATASET_NAME\";\n+    String tableName = \"MY_TABLE_NAME\";\n+    relaxTableQuery(projectId, datasetName, tableName);\n+  }\n+\n+  public static void relaxTableQuery(String projectId, String datasetName, String tableName)\n+      throws Exception {\n+    try {", "originalCommit": "a1393e4b3244a3c5db9e6a361909ae6368e6be48", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDMwMjI0Ng==", "url": "https://github.com/googleapis/java-bigquery/pull/115#discussion_r370302246", "bodyText": "That's right -- BQ client is not Autocloseable and cannot be changed into one since there's no close() method we can call to clean up resource. The Apiary client generator would have to change... something I discussed with Les and will put on hold for now.", "author": "stephaniewang526", "createdAt": "2020-01-23T19:09:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDI4ODc5OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDMwNDM5Nw==", "url": "https://github.com/googleapis/java-bigquery/pull/115#discussion_r370304397", "bodyText": "The BQ client is hand written and has a few quirks - one is the client isn't autoclosable.", "author": "kurtisvg", "createdAt": "2020-01-23T19:13:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDI4ODc5OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDI4OTg4Nw==", "url": "https://github.com/googleapis/java-bigquery/pull/115#discussion_r370289887", "bodyText": "Would you want to use a StringBuilder here?", "author": "nnegrey", "createdAt": "2020-01-23T18:43:04Z", "path": "samples/src/main/java/com/example/bigquery/RelaxTableQuery.java", "diffHunk": "@@ -0,0 +1,99 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.example.bigquery;\n+\n+// [START bigquery_relax_column_query_append]\n+import com.google.cloud.bigquery.BigQuery;\n+import com.google.cloud.bigquery.BigQueryException;\n+import com.google.cloud.bigquery.BigQueryOptions;\n+import com.google.cloud.bigquery.Job;\n+import com.google.cloud.bigquery.JobId;\n+import com.google.cloud.bigquery.JobInfo;\n+import com.google.cloud.bigquery.JobInfo.SchemaUpdateOption;\n+import com.google.cloud.bigquery.JobInfo.WriteDisposition;\n+import com.google.cloud.bigquery.QueryJobConfiguration;\n+import com.google.cloud.bigquery.TableId;\n+import com.google.cloud.bigquery.TableResult;\n+import com.google.common.collect.ImmutableList;\n+import java.util.UUID;\n+\n+public class RelaxTableQuery {\n+\n+  public static void runRelaxTableQuery() throws Exception {\n+    // TODO(developer): Replace these variables before running the sample.\n+    String projectId = \"MY_PROJECT_ID\";\n+    String datasetName = \"MY_DATASET_NAME\";\n+    String tableName = \"MY_TABLE_NAME\";\n+    relaxTableQuery(projectId, datasetName, tableName);\n+  }\n+\n+  public static void relaxTableQuery(String projectId, String datasetName, String tableName)\n+      throws Exception {\n+    try {\n+      // Initialize client that will be used to send requests. This client only needs to be created\n+      // once, and can be reused for multiple requests.\n+      BigQuery bigquery = BigQueryOptions.getDefaultInstance().getService();\n+\n+      TableId tableId = TableId.of(datasetName, tableName);\n+\n+      String sourceTable = \"`\" + projectId + \".\" + datasetName + \".\" + tableName + \"`\";\n+      String query =\n+          \"SELECT \" + \"word\\n\" + \"FROM \" + sourceTable + \"\\n\" + \"WHERE word like '%is%' \";", "originalCommit": "a1393e4b3244a3c5db9e6a361909ae6368e6be48", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDMwMDcyMA==", "url": "https://github.com/googleapis/java-bigquery/pull/115#discussion_r370300720", "bodyText": "Java will actually optimize concats like this - you only need to use StringBuilder if you are appending iteratively", "author": "kurtisvg", "createdAt": "2020-01-23T19:06:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDI4OTg4Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDI5MDkyNg==", "url": "https://github.com/googleapis/java-bigquery/pull/115#discussion_r370290926", "bodyText": "Do the error for BigQuery follow the same as this page?\nhttps://cloud.google.com/apis/design/errors\nIf so, might be worth linking to that page unless the errors themselves are descriptive.", "author": "nnegrey", "createdAt": "2020-01-23T18:45:16Z", "path": "samples/src/main/java/com/example/bigquery/RelaxTableQuery.java", "diffHunk": "@@ -0,0 +1,99 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.example.bigquery;\n+\n+// [START bigquery_relax_column_query_append]\n+import com.google.cloud.bigquery.BigQuery;\n+import com.google.cloud.bigquery.BigQueryException;\n+import com.google.cloud.bigquery.BigQueryOptions;\n+import com.google.cloud.bigquery.Job;\n+import com.google.cloud.bigquery.JobId;\n+import com.google.cloud.bigquery.JobInfo;\n+import com.google.cloud.bigquery.JobInfo.SchemaUpdateOption;\n+import com.google.cloud.bigquery.JobInfo.WriteDisposition;\n+import com.google.cloud.bigquery.QueryJobConfiguration;\n+import com.google.cloud.bigquery.TableId;\n+import com.google.cloud.bigquery.TableResult;\n+import com.google.common.collect.ImmutableList;\n+import java.util.UUID;\n+\n+public class RelaxTableQuery {\n+\n+  public static void runRelaxTableQuery() throws Exception {\n+    // TODO(developer): Replace these variables before running the sample.\n+    String projectId = \"MY_PROJECT_ID\";\n+    String datasetName = \"MY_DATASET_NAME\";\n+    String tableName = \"MY_TABLE_NAME\";\n+    relaxTableQuery(projectId, datasetName, tableName);\n+  }\n+\n+  public static void relaxTableQuery(String projectId, String datasetName, String tableName)\n+      throws Exception {\n+    try {\n+      // Initialize client that will be used to send requests. This client only needs to be created\n+      // once, and can be reused for multiple requests.\n+      BigQuery bigquery = BigQueryOptions.getDefaultInstance().getService();\n+\n+      TableId tableId = TableId.of(datasetName, tableName);\n+\n+      String sourceTable = \"`\" + projectId + \".\" + datasetName + \".\" + tableName + \"`\";\n+      String query =\n+          \"SELECT \" + \"word\\n\" + \"FROM \" + sourceTable + \"\\n\" + \"WHERE word like '%is%' \";\n+\n+      QueryJobConfiguration queryConfig =\n+          QueryJobConfiguration.newBuilder(query)\n+              // Use standard SQL syntax for queries.\n+              // See: https://cloud.google.com/bigquery/sql-reference/\n+              .setUseLegacySql(false)\n+              .setSchemaUpdateOptions(ImmutableList.of(SchemaUpdateOption.ALLOW_FIELD_RELAXATION))\n+              .setWriteDisposition(WriteDisposition.WRITE_APPEND)\n+              .setDestinationTable(tableId)\n+              .build();\n+\n+      // Create a job ID so that we can safely retry.\n+      JobId jobId = JobId.of(UUID.randomUUID().toString());\n+      Job queryJob = bigquery.create(JobInfo.newBuilder(queryConfig).setJobId(jobId).build());\n+\n+      queryJob = queryJob.waitFor();\n+\n+      // Check for errors", "originalCommit": "a1393e4b3244a3c5db9e6a361909ae6368e6be48", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDMwMDYwOA==", "url": "https://github.com/googleapis/java-bigquery/pull/115#discussion_r370300608", "bodyText": "The errors for Jobs don't have error codes. I think they're decently descriptive.", "author": "stephaniewang526", "createdAt": "2020-01-23T19:05:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDI5MDkyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDMwNTE3Mg==", "url": "https://github.com/googleapis/java-bigquery/pull/115#discussion_r370305172", "bodyText": "Another BQ client quirk - it doesn't return errors in the best way. This was a compromised we reached.", "author": "kurtisvg", "createdAt": "2020-01-23T19:15:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDI5MDkyNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDI5MjY1NQ==", "url": "https://github.com/googleapis/java-bigquery/pull/115#discussion_r370292655", "bodyText": "@kurtisvg, is this fine or is there a preference for traditional for loops?\nLike:\nfor (Row row in results.iterateAll()) { ...", "author": "nnegrey", "createdAt": "2020-01-23T18:48:44Z", "path": "samples/src/main/java/com/example/bigquery/RelaxTableQuery.java", "diffHunk": "@@ -0,0 +1,99 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.example.bigquery;\n+\n+// [START bigquery_relax_column_query_append]\n+import com.google.cloud.bigquery.BigQuery;\n+import com.google.cloud.bigquery.BigQueryException;\n+import com.google.cloud.bigquery.BigQueryOptions;\n+import com.google.cloud.bigquery.Job;\n+import com.google.cloud.bigquery.JobId;\n+import com.google.cloud.bigquery.JobInfo;\n+import com.google.cloud.bigquery.JobInfo.SchemaUpdateOption;\n+import com.google.cloud.bigquery.JobInfo.WriteDisposition;\n+import com.google.cloud.bigquery.QueryJobConfiguration;\n+import com.google.cloud.bigquery.TableId;\n+import com.google.cloud.bigquery.TableResult;\n+import com.google.common.collect.ImmutableList;\n+import java.util.UUID;\n+\n+public class RelaxTableQuery {\n+\n+  public static void runRelaxTableQuery() throws Exception {\n+    // TODO(developer): Replace these variables before running the sample.\n+    String projectId = \"MY_PROJECT_ID\";\n+    String datasetName = \"MY_DATASET_NAME\";\n+    String tableName = \"MY_TABLE_NAME\";\n+    relaxTableQuery(projectId, datasetName, tableName);\n+  }\n+\n+  public static void relaxTableQuery(String projectId, String datasetName, String tableName)\n+      throws Exception {\n+    try {\n+      // Initialize client that will be used to send requests. This client only needs to be created\n+      // once, and can be reused for multiple requests.\n+      BigQuery bigquery = BigQueryOptions.getDefaultInstance().getService();\n+\n+      TableId tableId = TableId.of(datasetName, tableName);\n+\n+      String sourceTable = \"`\" + projectId + \".\" + datasetName + \".\" + tableName + \"`\";\n+      String query =\n+          \"SELECT \" + \"word\\n\" + \"FROM \" + sourceTable + \"\\n\" + \"WHERE word like '%is%' \";\n+\n+      QueryJobConfiguration queryConfig =\n+          QueryJobConfiguration.newBuilder(query)\n+              // Use standard SQL syntax for queries.\n+              // See: https://cloud.google.com/bigquery/sql-reference/\n+              .setUseLegacySql(false)\n+              .setSchemaUpdateOptions(ImmutableList.of(SchemaUpdateOption.ALLOW_FIELD_RELAXATION))\n+              .setWriteDisposition(WriteDisposition.WRITE_APPEND)\n+              .setDestinationTable(tableId)\n+              .build();\n+\n+      // Create a job ID so that we can safely retry.\n+      JobId jobId = JobId.of(UUID.randomUUID().toString());\n+      Job queryJob = bigquery.create(JobInfo.newBuilder(queryConfig).setJobId(jobId).build());\n+\n+      queryJob = queryJob.waitFor();\n+\n+      // Check for errors\n+      if (queryJob == null) {\n+        throw new Exception(\"Job no longer exists\");\n+      } else if (queryJob.getStatus().getError() != null) {\n+        // You can also look at queryJob.getStatus().getExecutionErrors() for all\n+        // errors, not just the latest one.\n+        throw new Exception(queryJob.getStatus().getError().toString());\n+      }\n+\n+      // Get the results.\n+      TableResult results = queryJob.getQueryResults();\n+\n+      // Print all pages of the results.\n+      results\n+          .iterateAll()\n+          .forEach(\n+              rows -> {\n+                rows.forEach(row -> System.out.println(\"row: \" + row.toString()));\n+              });", "originalCommit": "a1393e4b3244a3c5db9e6a361909ae6368e6be48", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDI5OTM5NQ==", "url": "https://github.com/googleapis/java-bigquery/pull/115#discussion_r370299395", "bodyText": "forEach is preffered over traditional for-loops because it allows for lambdas (it's backwards in the sample guide atm)", "author": "kurtisvg", "createdAt": "2020-01-23T19:03:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDI5MjY1NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDI5MzA3NA==", "url": "https://github.com/googleapis/java-bigquery/pull/115#discussion_r370293074", "bodyText": "nit: might be worth putting a comment on what it means to relax a table query.", "author": "nnegrey", "createdAt": "2020-01-23T18:49:42Z", "path": "samples/src/main/java/com/example/bigquery/RelaxTableQuery.java", "diffHunk": "@@ -0,0 +1,99 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.example.bigquery;\n+\n+// [START bigquery_relax_column_query_append]\n+import com.google.cloud.bigquery.BigQuery;\n+import com.google.cloud.bigquery.BigQueryException;\n+import com.google.cloud.bigquery.BigQueryOptions;\n+import com.google.cloud.bigquery.Job;\n+import com.google.cloud.bigquery.JobId;\n+import com.google.cloud.bigquery.JobInfo;\n+import com.google.cloud.bigquery.JobInfo.SchemaUpdateOption;\n+import com.google.cloud.bigquery.JobInfo.WriteDisposition;\n+import com.google.cloud.bigquery.QueryJobConfiguration;\n+import com.google.cloud.bigquery.TableId;\n+import com.google.cloud.bigquery.TableResult;\n+import com.google.common.collect.ImmutableList;\n+import java.util.UUID;\n+\n+public class RelaxTableQuery {\n+\n+  public static void runRelaxTableQuery() throws Exception {\n+    // TODO(developer): Replace these variables before running the sample.\n+    String projectId = \"MY_PROJECT_ID\";\n+    String datasetName = \"MY_DATASET_NAME\";\n+    String tableName = \"MY_TABLE_NAME\";\n+    relaxTableQuery(projectId, datasetName, tableName);\n+  }\n+\n+  public static void relaxTableQuery(String projectId, String datasetName, String tableName)", "originalCommit": "a1393e4b3244a3c5db9e6a361909ae6368e6be48", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDMwNjQzMg==", "url": "https://github.com/googleapis/java-bigquery/pull/115#discussion_r370306432", "bodyText": "will do", "author": "stephaniewang526", "createdAt": "2020-01-23T19:18:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDI5MzA3NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDI5Mzk2Mg==", "url": "https://github.com/googleapis/java-bigquery/pull/115#discussion_r370293962", "bodyText": "nit: should this be in tearDown?", "author": "nnegrey", "createdAt": "2020-01-23T18:51:31Z", "path": "samples/src/test/java/com/example/bigquery/RelaxTableQueryIT.java", "diffHunk": "@@ -0,0 +1,88 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.example.bigquery;\n+\n+import static com.google.common.truth.Truth.assertThat;\n+import static junit.framework.TestCase.assertNotNull;\n+\n+import com.google.cloud.bigquery.Field;\n+import com.google.cloud.bigquery.LegacySQLTypeName;\n+import com.google.cloud.bigquery.Schema;\n+import java.io.ByteArrayOutputStream;\n+import java.io.PrintStream;\n+import org.junit.After;\n+import org.junit.Before;\n+import org.junit.BeforeClass;\n+import org.junit.Test;\n+\n+public class RelaxTableQueryIT {\n+  private ByteArrayOutputStream bout;\n+  private PrintStream out;\n+\n+  private static final String BIGQUERY_PROJECT_ID = System.getenv(\"BIGQUERY_PROJECT_ID\");\n+  private static final String BIGQUERY_DATASET_NAME = System.getenv(\"BIGQUERY_DATASET_NAME\");\n+\n+  private static void requireEnvVar(String varName) {\n+    assertNotNull(\n+        \"Environment variable \" + varName + \" is required to perform these tests.\",\n+        System.getenv(varName));\n+  }\n+\n+  @BeforeClass\n+  public static void checkRequirements() {\n+    requireEnvVar(\"BIGQUERY_PROJECT_ID\");\n+    requireEnvVar(\"BIGQUERY_DATASET_NAME\");\n+  }\n+\n+  @Before\n+  public void setUp() throws Exception {\n+    bout = new ByteArrayOutputStream();\n+    out = new PrintStream(bout);\n+    System.setOut(out);\n+  }\n+\n+  @After\n+  public void tearDown() {\n+    System.setOut(null);\n+  }\n+\n+  @Test\n+  public void testRelaxTableQuery() throws Exception {\n+    String tableName = \"RELAX_TABLE_QUERY_TEST\";\n+    Schema originalSchema =\n+        Schema.of(\n+            Field.newBuilder(\"word\", LegacySQLTypeName.STRING).setMode(Field.Mode.REQUIRED).build(),\n+            Field.newBuilder(\"word_count\", LegacySQLTypeName.STRING)\n+                .setMode(Field.Mode.REQUIRED)\n+                .build(),\n+            Field.newBuilder(\"corpus\", LegacySQLTypeName.STRING)\n+                .setMode(Field.Mode.REQUIRED)\n+                .build(),\n+            Field.newBuilder(\"corpus_date\", LegacySQLTypeName.STRING)\n+                .setMode(Field.Mode.REQUIRED)\n+                .build());\n+\n+    CreateTable.createTable(BIGQUERY_DATASET_NAME, tableName, originalSchema);\n+\n+    RelaxTableQuery.relaxTableQuery(BIGQUERY_PROJECT_ID, BIGQUERY_DATASET_NAME, tableName);\n+    assertThat(bout.toString())\n+        .contains(\"Successfully relaxed all columns in destination table during query job\");\n+\n+    // Clean up\n+    DeleteTable.deleteTable(BIGQUERY_DATASET_NAME, tableName);", "originalCommit": "a1393e4b3244a3c5db9e6a361909ae6368e6be48", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDMwMTQ5OA==", "url": "https://github.com/googleapis/java-bigquery/pull/115#discussion_r370301498", "bodyText": "I don't seem to be able to pass in tableName in tearDown() @kurtisvg thoughts?", "author": "stephaniewang526", "createdAt": "2020-01-23T19:07:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDI5Mzk2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDMwMzgwOQ==", "url": "https://github.com/googleapis/java-bigquery/pull/115#discussion_r370303809", "bodyText": "It's probably a good practice because it will ensure the tearDown occurs if the test fails. You should also use a UUID, so that multiple test runs don't step on each other.\nYou can accomplish this be having tableName be a class field, and using setUp to create it and tearDown to destroy it.", "author": "kurtisvg", "createdAt": "2020-01-23T19:12:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDI5Mzk2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDMwMzkyMw==", "url": "https://github.com/googleapis/java-bigquery/pull/115#discussion_r370303923", "bodyText": "It's probably a good practice because it will ensure the tearDown occurs if the test fails. You should also use a UUID, so that multiple test runs don't step on each other.\nYou can accomplish this be having tableName be a class field, and using setUp to create it and tearDown to destroy it.", "author": "kurtisvg", "createdAt": "2020-01-23T19:12:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDI5Mzk2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDMwODYzMw==", "url": "https://github.com/googleapis/java-bigquery/pull/115#discussion_r370308633", "bodyText": "Will do", "author": "stephaniewang526", "createdAt": "2020-01-23T19:22:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDI5Mzk2Mg=="}], "type": "inlineReview"}, {"oid": "3d35c13d828c1c4b7d396b78df8bc5f37742ef1c", "url": "https://github.com/googleapis/java-bigquery/commit/3d35c13d828c1c4b7d396b78df8bc5f37742ef1c", "message": "update base on comments", "committedDate": "2020-01-23T19:26:16Z", "type": "commit"}, {"oid": "d5c035ecb4a9bce4c64b7cbc8ce405edd7d45fce", "url": "https://github.com/googleapis/java-bigquery/commit/d5c035ecb4a9bce4c64b7cbc8ce405edd7d45fce", "message": "code refactoring", "committedDate": "2020-01-23T19:52:02Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDMzOTE1OA==", "url": "https://github.com/googleapis/java-bigquery/pull/115#discussion_r370339158", "bodyText": "I'm guessing table name has a limit, to get more randomization would it be better to do:\ntableName = \"TEST_\" + UUID.randomUUID().toString().replace('-', '').substring(0, 23);", "author": "nnegrey", "createdAt": "2020-01-23T20:31:01Z", "path": "samples/src/test/java/com/example/bigquery/RelaxTableQueryIT.java", "diffHunk": "@@ -0,0 +1,88 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.example.bigquery;\n+\n+import static com.google.common.truth.Truth.assertThat;\n+import static junit.framework.TestCase.assertNotNull;\n+\n+import com.google.cloud.bigquery.Field;\n+import com.google.cloud.bigquery.LegacySQLTypeName;\n+import com.google.cloud.bigquery.Schema;\n+import java.io.ByteArrayOutputStream;\n+import java.io.PrintStream;\n+import java.util.UUID;\n+import org.junit.After;\n+import org.junit.Before;\n+import org.junit.BeforeClass;\n+import org.junit.Test;\n+\n+public class RelaxTableQueryIT {\n+  private ByteArrayOutputStream bout;\n+  private PrintStream out;\n+  private String tableName;\n+  private Schema originalSchema;\n+\n+  private static final String BIGQUERY_PROJECT_ID = System.getenv(\"BIGQUERY_PROJECT_ID\");\n+  private static final String BIGQUERY_DATASET_NAME = System.getenv(\"BIGQUERY_DATASET_NAME\");\n+\n+  private static void requireEnvVar(String varName) {\n+    assertNotNull(\n+        \"Environment variable \" + varName + \" is required to perform these tests.\",\n+        System.getenv(varName));\n+  }\n+\n+  @BeforeClass\n+  public static void checkRequirements() {\n+    requireEnvVar(\"BIGQUERY_PROJECT_ID\");\n+    requireEnvVar(\"BIGQUERY_DATASET_NAME\");\n+  }\n+\n+  @Before\n+  public void setUp() throws Exception {\n+    bout = new ByteArrayOutputStream();\n+    out = new PrintStream(bout);\n+    tableName =\n+        \"RELAX_TABLE_QUERY_TEST\" + UUID.randomUUID().toString().substring(0, 5).replace('-', '_');", "originalCommit": "d5c035ecb4a9bce4c64b7cbc8ce405edd7d45fce", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "0c13ae926fc8793621d15fa52da5037c01d1aa4a", "url": "https://github.com/googleapis/java-bigquery/commit/0c13ae926fc8793621d15fa52da5037c01d1aa4a", "message": "fix build errors", "committedDate": "2020-01-23T20:41:09Z", "type": "commit"}, {"oid": "b022684f2ad77ecb5db81a0371f72fe7926911d2", "url": "https://github.com/googleapis/java-bigquery/commit/b022684f2ad77ecb5db81a0371f72fe7926911d2", "message": "add debugging statements", "committedDate": "2020-01-23T21:36:18Z", "type": "commit"}, {"oid": "7d9118990f10af553733c209fd0855c898c91065", "url": "https://github.com/googleapis/java-bigquery/commit/7d9118990f10af553733c209fd0855c898c91065", "message": "remove unused exception", "committedDate": "2020-01-23T21:43:54Z", "type": "commit"}, {"oid": "a2e647be17458c35428129115b4718f7c42966b2", "url": "https://github.com/googleapis/java-bigquery/commit/a2e647be17458c35428129115b4718f7c42966b2", "message": "debug", "committedDate": "2020-01-24T21:31:24Z", "type": "commit"}, {"oid": "7f2b8015470215516f3a7945fadecdc1596b982c", "url": "https://github.com/googleapis/java-bigquery/commit/7f2b8015470215516f3a7945fadecdc1596b982c", "message": "debug", "committedDate": "2020-01-24T21:46:42Z", "type": "commit"}, {"oid": "3ddd8c2a842c63abc1441964134fe67b5b0fcc4b", "url": "https://github.com/googleapis/java-bigquery/commit/3ddd8c2a842c63abc1441964134fe67b5b0fcc4b", "message": "debug", "committedDate": "2020-01-24T22:03:55Z", "type": "commit"}, {"oid": "bc2cb8e44a497a669a55c7bbde07709ebd6aad53", "url": "https://github.com/googleapis/java-bigquery/commit/bc2cb8e44a497a669a55c7bbde07709ebd6aad53", "message": "debug", "committedDate": "2020-01-24T22:14:37Z", "type": "commit"}, {"oid": "8b3b93a4cb2d0fc103462a696dc08781085136f0", "url": "https://github.com/googleapis/java-bigquery/commit/8b3b93a4cb2d0fc103462a696dc08781085136f0", "message": "debug", "committedDate": "2020-01-24T22:24:31Z", "type": "commit"}, {"oid": "0a871f84d626f6bbefe9f6a2d741a7742a681527", "url": "https://github.com/googleapis/java-bigquery/commit/0a871f84d626f6bbefe9f6a2d741a7742a681527", "message": "debug", "committedDate": "2020-01-24T22:34:45Z", "type": "commit"}, {"oid": "e753f4055eccdc2e59e3d1f2ee256421454d2619", "url": "https://github.com/googleapis/java-bigquery/commit/e753f4055eccdc2e59e3d1f2ee256421454d2619", "message": "revert back to cleaning up in method due to unkown nullpointer exception if using setup() or teardown()", "committedDate": "2020-01-26T19:56:55Z", "type": "commit"}, {"oid": "a042d3ada632603a9135ac77de9a8f77d4e6528e", "url": "https://github.com/googleapis/java-bigquery/commit/a042d3ada632603a9135ac77de9a8f77d4e6528e", "message": "Merge remote-tracking branch 'origin/relax-table-query' into relax-table-query\n\n# Conflicts:\n#\tsamples/src/test/java/com/example/bigquery/RelaxTableQueryIT.java", "committedDate": "2020-01-26T19:58:35Z", "type": "commit"}, {"oid": "126cd0ea3fcb4127f32b662a42834d0e55f3ee9d", "url": "https://github.com/googleapis/java-bigquery/commit/126cd0ea3fcb4127f32b662a42834d0e55f3ee9d", "message": "update base on comments", "committedDate": "2020-01-27T18:47:22Z", "type": "commit"}]}