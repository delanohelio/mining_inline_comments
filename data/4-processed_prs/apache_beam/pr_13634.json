{"pr_number": 13634, "pr_title": "[BEAM-11532] Fix edge case in merge where left_on and right_on contain equivalent column names", "pr_createdAt": "2020-12-30T00:00:03Z", "pr_url": "https://github.com/apache/beam/pull/13634", "timeline": [{"oid": "852480efdaa1b0eabd8f5035581fc04a37fddefc", "url": "https://github.com/apache/beam/commit/852480efdaa1b0eabd8f5035581fc04a37fddefc", "message": "Fix merge with same name column", "committedDate": "2020-12-29T23:31:12Z", "type": "commit"}, {"oid": "28926bdb4fa7f47a3e6b48f0a91b6f2312e04a5e", "url": "https://github.com/apache/beam/commit/28926bdb4fa7f47a3e6b48f0a91b6f2312e04a5e", "message": "Fix error when merging with implicit on", "committedDate": "2020-12-29T23:35:12Z", "type": "commit"}, {"oid": "1c318c11f5d51ae5dc5ff12920be96ac41ba3970", "url": "https://github.com/apache/beam/commit/1c318c11f5d51ae5dc5ff12920be96ac41ba3970", "message": "Remove unnecessary py3 check", "committedDate": "2020-12-29T23:35:27Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDI3MzcwNw==", "url": "https://github.com/apache/beam/pull/13634#discussion_r550273707", "bodyText": "Thanks for the cleanup \ud83d\udc4d", "author": "ibzib", "createdAt": "2020-12-30T17:41:52Z", "path": "sdks/python/apache_beam/dataframe/frames_test.py", "diffHunk": "@@ -124,7 +124,6 @@ def test_groupby(self):\n \n     self._run_test(lambda df: df.groupby(['second', 'A']).sum(), df)\n \n-  @unittest.skipIf(sys.version_info <= (3, ), 'differing signature')", "originalCommit": "1c318c11f5d51ae5dc5ff12920be96ac41ba3970", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDI3NzIxMg==", "url": "https://github.com/apache/beam/pull/13634#discussion_r550277212", "bodyText": "Can we split test_merge_same_key into separate test methods for each invocation of _run_test?", "author": "ibzib", "createdAt": "2020-12-30T17:53:49Z", "path": "sdks/python/apache_beam/dataframe/frames_test.py", "diffHunk": "@@ -152,6 +151,45 @@ def test_merge(self):\n           df1,\n           df2)\n \n+  def test_merge_same_key(self):\n+    df1 = pd.DataFrame({\n+        'key': ['foo', 'bar', 'baz', 'foo'], 'value': [1, 2, 3, 5]\n+    })\n+    df2 = pd.DataFrame({\n+        'key': ['foo', 'bar', 'baz', 'foo'], 'value': [5, 6, 7, 8]\n+    })\n+    with beam.dataframe.allow_non_parallel_operations():\n+      self._run_test(\n+          lambda df1,\n+          df2: df1.merge(df2, on='key').rename(index=lambda x: '*').sort_values(\n+              ['value_x', 'value_y']),\n+          df1,\n+          df2)\n+      self._run_test(\n+          lambda df1,\n+          df2: df1.merge(df2, on='key', suffixes=('_left', '_right')).rename(\n+              index=lambda x: '*').sort_values(['value_left', 'value_right']),\n+          df1,\n+          df2)\n+\n+    df1 = pd.DataFrame({'a': ['foo', 'bar'], 'b': [1, 2]})\n+    df2 = pd.DataFrame({'a': ['foo', 'baz'], 'c': [3, 4]})\n+\n+    with beam.dataframe.allow_non_parallel_operations():\n+      self._run_test(\n+          lambda df1,\n+          df2: df1.merge(df2, how='left', on='a').rename(index=lambda x: '*').\n+          sort_values(['b', 'c']),\n+          df1,\n+          df2)\n+      # Test without specifying 'on'", "originalCommit": "1c318c11f5d51ae5dc5ff12920be96ac41ba3970", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDI5ODU5Mg==", "url": "https://github.com/apache/beam/pull/13634#discussion_r550298592", "bodyText": "Done", "author": "TheNeuralBit", "createdAt": "2020-12-30T19:11:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDI3NzIxMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDI3ODEzMg==", "url": "https://github.com/apache/beam/pull/13634#discussion_r550278132", "bodyText": "Nit: Why two newlines, shouldn't it just be one?", "author": "ibzib", "createdAt": "2020-12-30T17:56:59Z", "path": "sdks/python/apache_beam/dataframe/frames.py", "diffHunk": "@@ -1218,15 +1219,32 @@ def merge(\n     merged = frame_base.DeferredFrame.wrap(\n         expressions.ComputedExpression(\n             'merge',\n-            lambda left, right: left.merge(\n-                right, left_index=True, right_index=True, **kwargs),\n+            lambda left, right: left.merge(right,\n+                                           left_index=True,\n+                                           right_index=True,\n+                                           suffixes=suffixes,\n+                                           **kwargs),\n             [indexed_left._expr, indexed_right._expr],\n             preserves_partition_by=partitionings.Singleton(),\n             requires_partition_by=partitionings.Index()))\n \n     if left_index or right_index:\n       return merged\n     else:\n+      common_cols = set(left_on).intersection(right_on)\n+      if len(common_cols):\n+        # When merging on the same column name from both dfs, merged will have\n+        # two duplicate columns, one with lsuffix and one with rsuffix.\n+        # Normally pandas de-dupes these into a single column with no suffix.\n+        # This replicates that logic by dropping the _right_ dupe, and removing\n+        # the suffix from the _left_ dupe.\n+        lsuffix, rsuffix = suffixes\n+        merged = merged.drop(\n+            columns=[f'{col}{rsuffix}' for col in common_cols])\n+        merged = merged.rename(\n+            columns={f'{col}{lsuffix}': col for col in common_cols})\n+", "originalCommit": "1c318c11f5d51ae5dc5ff12920be96ac41ba3970", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDI5ODYwOA==", "url": "https://github.com/apache/beam/pull/13634#discussion_r550298608", "bodyText": "Done", "author": "TheNeuralBit", "createdAt": "2020-12-30T19:11:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDI3ODEzMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDI4MjAxMg==", "url": "https://github.com/apache/beam/pull/13634#discussion_r550282012", "bodyText": "What if {col}{rsuffix} or {col}{lsuffix} already exists in the input?", "author": "ibzib", "createdAt": "2020-12-30T18:11:31Z", "path": "sdks/python/apache_beam/dataframe/frames.py", "diffHunk": "@@ -1218,15 +1219,32 @@ def merge(\n     merged = frame_base.DeferredFrame.wrap(\n         expressions.ComputedExpression(\n             'merge',\n-            lambda left, right: left.merge(\n-                right, left_index=True, right_index=True, **kwargs),\n+            lambda left, right: left.merge(right,\n+                                           left_index=True,\n+                                           right_index=True,\n+                                           suffixes=suffixes,\n+                                           **kwargs),\n             [indexed_left._expr, indexed_right._expr],\n             preserves_partition_by=partitionings.Singleton(),\n             requires_partition_by=partitionings.Index()))\n \n     if left_index or right_index:\n       return merged\n     else:\n+      common_cols = set(left_on).intersection(right_on)\n+      if len(common_cols):\n+        # When merging on the same column name from both dfs, merged will have\n+        # two duplicate columns, one with lsuffix and one with rsuffix.\n+        # Normally pandas de-dupes these into a single column with no suffix.\n+        # This replicates that logic by dropping the _right_ dupe, and removing\n+        # the suffix from the _left_ dupe.\n+        lsuffix, rsuffix = suffixes\n+        merged = merged.drop(", "originalCommit": "1c318c11f5d51ae5dc5ff12920be96ac41ba3970", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDI4NDEwNQ==", "url": "https://github.com/apache/beam/pull/13634#discussion_r550284105", "bodyText": "In that case I think it would have been renamed to {col}{rsuffix}{rsuffix} - this is a good edge case to think about though. I'll look at adding some more test cases.", "author": "TheNeuralBit", "createdAt": "2020-12-30T18:19:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDI4MjAxMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDI5MzM3Nw==", "url": "https://github.com/apache/beam/pull/13634#discussion_r550293377", "bodyText": "Ah nevermind you're right, pandas keeps {col}{rsuffix}. hmm", "author": "TheNeuralBit", "createdAt": "2020-12-30T18:52:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDI4MjAxMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDI5ODk4Ng==", "url": "https://github.com/apache/beam/pull/13634#discussion_r550298986", "bodyText": "Thanks for catching this. I updated the logic to drop the duplicate column(s) from the right df proactively", "author": "TheNeuralBit", "createdAt": "2020-12-30T19:12:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDI4MjAxMg=="}], "type": "inlineReview"}, {"oid": "281501546af1ee45c84c355b435557fbbe745feb", "url": "https://github.com/apache/beam/commit/281501546af1ee45c84c355b435557fbbe745feb", "message": "Drop column prior to merge", "committedDate": "2020-12-30T19:10:50Z", "type": "commit"}]}