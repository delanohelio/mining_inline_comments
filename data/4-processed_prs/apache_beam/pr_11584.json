{"pr_number": 11584, "pr_title": "[BEAM-9136]support isRelease tag for docker build command & update release guide", "pr_createdAt": "2020-04-30T20:41:22Z", "pr_url": "https://github.com/apache/beam/pull/11584", "timeline": [{"oid": "54754a11dc28abd5f4cfd05cbc7c47461a1e6d4d", "url": "https://github.com/apache/beam/commit/54754a11dc28abd5f4cfd05cbc7c47461a1e6d4d", "message": "support isRelease tag for docker build command & update release guide", "committedDate": "2020-04-30T20:42:21Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODI3ODkxNA==", "url": "https://github.com/apache/beam/pull/11584#discussion_r418278914", "bodyText": "Currently, the isRelease tag needs to be passed with commands. Ideally, this tag should be set by checking branch name.\nDetecting isRelease for docker image build is not that helpful for now, but could be used when we support auto setting isRelease tag.", "author": "Hannah-Jiang", "createdAt": "2020-04-30T20:46:19Z", "path": "sdks/python/container/py2/build.gradle", "diffHunk": "@@ -66,7 +66,8 @@ docker {\n                   project.rootProject[\"docker-tag\"] : project.sdk_version)\n   files \"../Dockerfile\", \"./build\"\n   buildArgs(['py_version': \"2.7\",\n-             'pull_licenses': project.rootProject.hasProperty([\"docker-pull-licenses\"])])\n+             'pull_licenses': project.rootProject.hasProperty([\"docker-pull-licenses\"]) ||\n+                     project.rootProject.hasProperty([\"isRelease\"])])", "originalCommit": "54754a11dc28abd5f4cfd05cbc7c47461a1e6d4d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODM0MDYzMw==", "url": "https://github.com/apache/beam/pull/11584#discussion_r418340633", "bodyText": "I see, thanks. I did not know that we need to set isRelease manually.", "author": "tvalentyn", "createdAt": "2020-04-30T23:14:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODI3ODkxNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODc2NjI2NA==", "url": "https://github.com/apache/beam/pull/11584#discussion_r418766264", "bodyText": "@ibzib , this part should be verified BEFORE pushing Python images. I'm not sure when this PR can be merged because of website issues, so explicitly pinging you here.", "author": "Hannah-Jiang", "createdAt": "2020-05-01T22:37:44Z", "path": "website/src/contribute/release-guide.md", "diffHunk": "@@ -688,8 +688,20 @@ Verify that files are [present](https://dist.apache.org/repos/dist/dev/beam).\n * Build Python images and push to DockerHub.\n \n ```\n-./gradlew :sdks:python:container:buildAll -Pdocker-tag=${RELEASE}_rc{RC_NUM}\n+./gradlew :sdks:python:container:buildAll -Pdocker-pull-licenses -Pdocker-tag=${RELEASE}_rc{RC_NUM}\n+```\n+\n+Verify that third party licenses are included by logging in to the images. For Python SDK images, there should be around 80 ~ 100 dependencies. \n+Please note that dependencies for the SDKs with different Python versions vary. \n+Need to verify all Python images by replacing `${ver}` in the following command to `python2.7, python3.5, python3.6, python3.7`.", "originalCommit": "54754a11dc28abd5f4cfd05cbc7c47461a1e6d4d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODc2NzU0Nw==", "url": "https://github.com/apache/beam/pull/11584#discussion_r418767547", "bodyText": "Ack, thanks for the heads up", "author": "ibzib", "createdAt": "2020-05-01T22:42:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODc2NjI2NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODc2Njc5NQ==", "url": "https://github.com/apache/beam/pull/11584#discussion_r418766795", "bodyText": "@ibzib , this part changed slightly. Please note the change from dockerPush to docker at L714.\nAfter creating the Java image, we should verify it BEFORE pushing to DockerHub. I'm not sure when this PR can be merged because of website issues, so explicitly pinging you here.", "author": "Hannah-Jiang", "createdAt": "2020-05-01T22:39:37Z", "path": "website/src/contribute/release-guide.md", "diffHunk": "@@ -699,7 +711,18 @@ done\n * Build Java images and push to DockerHub.\n \n ```\n-./gradlew :sdks:java:container:dockerPush -Pdocker-pull-licenses -Pdocker-tag=${RELEASE}_rc{RC_NUM}\n+./gradlew :sdks:java:container:docker -Pdocker-pull-licenses -Pdocker-tag=${RELEASE}_rc{RC_NUM}\n+```\n+\n+Verify that third party licenses are included by logging in to the images. For Java SDK images, there should be around 1400 dependencies. \n+```\n+docker run -it --entrypoint=/bin/bash apache/beam_java_sdk:${RELEASE}_rc{RC_NUM}\n+ls -al /opt/apache/beam/third_party_licenses/ | wc -l\n+```\n+\n+After verifying the third party licenses are included correctly, push the images to DockerHub.\n+```", "originalCommit": "54754a11dc28abd5f4cfd05cbc7c47461a1e6d4d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "b75515e96a3c3f3c11b3c107cd7fda86204092f2", "url": "https://github.com/apache/beam/commit/b75515e96a3c3f3c11b3c107cd7fda86204092f2", "message": "support isRelease tag for docker build command & update release guide", "committedDate": "2020-05-15T05:09:35Z", "type": "commit"}, {"oid": "b75515e96a3c3f3c11b3c107cd7fda86204092f2", "url": "https://github.com/apache/beam/commit/b75515e96a3c3f3c11b3c107cd7fda86204092f2", "message": "support isRelease tag for docker build command & update release guide", "committedDate": "2020-05-15T05:09:35Z", "type": "forcePushed"}]}