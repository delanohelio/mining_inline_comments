{"pr_number": 12542, "pr_title": "[BEAM-10674] Add Python CoGBK load test for streaming on Dataflow", "pr_createdAt": "2020-08-12T08:48:05Z", "pr_url": "https://github.com/apache/beam/pull/12542", "timeline": [{"oid": "2ca23d2e3de20bc159b82054526387fc8f932fc3", "url": "https://github.com/apache/beam/commit/2ca23d2e3de20bc159b82054526387fc8f932fc3", "message": "[BEAM-10674] Python CoGBK: Remove unnecessary step. Adjust parameters to Java version of the test", "committedDate": "2020-08-11T15:23:53Z", "type": "commit"}, {"oid": "0d8566e21ca8f443aad16256b10ba91d72206bc7", "url": "https://github.com/apache/beam/commit/0d8566e21ca8f443aad16256b10ba91d72206bc7", "message": "[BEAM-10674] Python CoGBK: Add streaming job", "committedDate": "2020-08-12T11:38:48Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTk4MTk2NQ==", "url": "https://github.com/apache/beam/pull/12542#discussion_r469981965", "bodyText": "I think we should agree on the common name of this param. In combine I put jobType (mainly because Java test has jobType), but there is a possibility to change it since combine isn't merged yet.", "author": "kkucharc", "createdAt": "2020-08-13T14:13:20Z", "path": ".test-infra/jenkins/job_LoadTests_coGBK_Python.groovy", "diffHunk": "@@ -25,7 +25,7 @@ import InfluxDBCredentialsHelper\n \n def now = new Date().format(\"MMddHHmmss\", TimeZone.getTimeZone('UTC'))\n \n-def loadTestConfigurations = { datasetName ->\n+def loadTestConfigurations = { mode, datasetName ->", "originalCommit": "0d8566e21ca8f443aad16256b10ba91d72206bc7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTU1OTczOA==", "url": "https://github.com/apache/beam/pull/12542#discussion_r471559738", "bodyText": "After an offline discussion, we decided to stay with mode in this context.", "author": "kamilwu", "createdAt": "2020-08-17T15:30:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTk4MTk2NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTk4MzA2NA==", "url": "https://github.com/apache/beam/pull/12542#discussion_r469983064", "bodyText": "Now you can also ass now as ${now} :D", "author": "kkucharc", "createdAt": "2020-08-13T14:14:10Z", "path": ".test-infra/jenkins/job_LoadTests_coGBK_Python.groovy", "diffHunk": "@@ -34,12 +34,12 @@ def loadTestConfigurations = { datasetName ->\n       pipelineOptions: [\n         project              : 'apache-beam-testing',\n         region               : 'us-central1',\n-        job_name             : 'load-tests-python-dataflow-batch-cogbk-1-' + now,\n+        job_name             : \"load-tests-python-dataflow-${mode}-cogbk-1-\" + now,", "originalCommit": "0d8566e21ca8f443aad16256b10ba91d72206bc7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjAxMzUzMA==", "url": "https://github.com/apache/beam/pull/12542#discussion_r472013530", "bodyText": "Done \ud83d\udc4c", "author": "kamilwu", "createdAt": "2020-08-18T08:39:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTk4MzA2NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTk4NTM4OQ==", "url": "https://github.com/apache/beam/pull/12542#discussion_r469985389", "bodyText": "Why this type of machine?", "author": "kkucharc", "createdAt": "2020-08-13T14:16:56Z", "path": ".test-infra/jenkins/job_LoadTests_coGBK_Python.groovy", "diffHunk": "@@ -147,25 +147,30 @@ def loadTestConfigurations = { datasetName ->\n         autoscaling_algorithm: 'NONE'\n       ]\n     ],\n-  ].each { test -> test.pipelineOptions.putAll(additionalPipelineArgs) }\n+  ]\n+  .each { test -> test.pipelineOptions.putAll(additionalPipelineArgs) }\n+  .each { test -> (mode) != 'streaming' ?: addStreamingOptions(test) }\n }\n \n-def batchLoadTestJob = { scope, triggeringContext ->\n-  scope.description('Runs Python CoGBK load tests on Dataflow runner in batch mode')\n-  commonJobProperties.setTopLevelMainJobProperties(scope, 'master', 240)\n+def addStreamingOptions(test) {\n+  // Use highmem workers to prevent out of memory issues.\n+  test.pipelineOptions << [streaming: null,\n+    worker_machine_type: 'n1-highmem-4'", "originalCommit": "0d8566e21ca8f443aad16256b10ba91d72206bc7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTU1NzQwNw==", "url": "https://github.com/apache/beam/pull/12542#discussion_r471557407", "bodyText": "My pipelines kept crushing because of OutOfMemory exceptions. So I followed the advice given in this article: https://cloud.google.com/community/tutorials/dataflow-debug-oom-conditions\nOther solution was to, according to the article, use fewer number of threads per worker. But I couldn't have found a pipeline option responsible for that in Python SDK (it exists in Java SDK, though).", "author": "kamilwu", "createdAt": "2020-08-17T15:27:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTk4NTM4OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mzk4MzUzOA==", "url": "https://github.com/apache/beam/pull/12542#discussion_r473983538", "bodyText": "I see. Maybe it's worth to create an issue in jira with this bug? I am not sure it should be infra issue or maybe python if we need this option. How is it called in Java SDK?", "author": "kkucharc", "createdAt": "2020-08-20T13:39:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTk4NTM4OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mzk4NTQ2Mg==", "url": "https://github.com/apache/beam/pull/12542#discussion_r473985462", "bodyText": "I wonder only what would happen if this worker won't be available when cron job starts? Or it will be permanently shut down.", "author": "kkucharc", "createdAt": "2020-08-20T13:40:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTk4NTM4OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDAxNTYzMQ==", "url": "https://github.com/apache/beam/pull/12542#discussion_r474015631", "bodyText": "How is it called in Java SDK?\n\nIt's --numberOfWorkerHarnessThreads. Some time ago, its equivalent in Python SDK was --experimental worker_threads=[n], but the option was removed. I'll open a discussion on dev@ to find out if it is something the community should take care of.", "author": "kamilwu", "createdAt": "2020-08-20T14:14:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTk4NTM4OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDAxODQ4OA==", "url": "https://github.com/apache/beam/pull/12542#discussion_r474018488", "bodyText": "I wonder only what would happen if this worker won't be available when cron job starts?\n\nWorkers are still managed by Dataflow. That option (--worker_machine_type) is just a hint about what machines should Dataflow use", "author": "kamilwu", "createdAt": "2020-08-20T14:18:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTk4NTM4OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDA0MTgxMg==", "url": "https://github.com/apache/beam/pull/12542#discussion_r474041812", "bodyText": "Thanks a lot Kamil :)", "author": "kkucharc", "createdAt": "2020-08-20T14:49:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTk4NTM4OQ=="}], "type": "inlineReview"}, {"oid": "efd8a5dd18510ea38aad0bbd03a3769f3877d31d", "url": "https://github.com/apache/beam/commit/efd8a5dd18510ea38aad0bbd03a3769f3877d31d", "message": "[BEAM-10674] Python CoGBK: Add streaming job", "committedDate": "2020-08-18T08:37:21Z", "type": "commit"}, {"oid": "efd8a5dd18510ea38aad0bbd03a3769f3877d31d", "url": "https://github.com/apache/beam/commit/efd8a5dd18510ea38aad0bbd03a3769f3877d31d", "message": "[BEAM-10674] Python CoGBK: Add streaming job", "committedDate": "2020-08-18T08:37:21Z", "type": "forcePushed"}]}