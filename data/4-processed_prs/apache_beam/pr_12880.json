{"pr_number": 12880, "pr_title": "[BEAM-10933] Adjust GBK type before creating the pipeline proto", "pr_createdAt": "2020-09-19T19:04:59Z", "pr_url": "https://github.com/apache/beam/pull/12880", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjE4MTAxNQ==", "url": "https://github.com/apache/beam/pull/12880#discussion_r492181015", "bodyText": "@CraigChambersG I was under the impression that this wasn't true and that Dataflow v2 handled this.", "author": "lukecwik", "createdAt": "2020-09-21T16:10:17Z", "path": "sdks/python/apache_beam/runners/dataflow/dataflow_runner.py", "diffHunk": "@@ -430,6 +430,15 @@ def _check_for_unsupported_fnapi_features(self, pipeline_proto):\n                 components.coders[windowing_strategy.window_coder_id].spec.urn,\n                 windowing_strategy.window_fn.urn))\n \n+  def _adjust_types_for_dataflow(self, pipeline):\n+    # Dataflow runner requires a KV type for GBK inputs, hence we enforce that\n+    # here.\n+    pipeline.visit(self.group_by_key_input_visitor())\n+\n+    # Dataflow runner requires output type of the Flatten to be the same as the", "originalCommit": "23e6c0d74e364cf479721ea1d1bfacb9fcab1a53", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjM1MTYwMw==", "url": "https://github.com/apache/beam/pull/12880#discussion_r492351603", "bodyText": "Why do the type encodings not survive the round trip (pipeline -> proto -> pipeline)?", "author": "lukecwik", "createdAt": "2020-09-21T21:17:58Z", "path": "sdks/python/apache_beam/runners/dataflow/dataflow_runner.py", "diffHunk": "@@ -488,12 +497,15 @@ def run_pipeline(self, pipeline, options):\n       # Cross language transform require using a pipeline object constructed\n       # from the full pipeline proto to make sure that expanded version of\n       # external transforms are reflected in the Pipeline job graph.\n+      # TODO(chamikara): remove following pipeline and pipeline proto recreation\n+      # after portable job submission path is fully in place.\n       from apache_beam import Pipeline\n       pipeline = Pipeline.from_runner_api(\n           self.proto_pipeline,\n           pipeline.runner,\n           options,\n           allow_proto_holders=True)\n+      self._adjust_types_for_dataflow(pipeline)", "originalCommit": "dfdda4e66a30834a203d70b78a7633e5c355e1fb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjM4MDc2Mw==", "url": "https://github.com/apache/beam/pull/12880#discussion_r492380763", "bodyText": "Verified that types are preserved in the pipeline->proto->pipeline roundtrip and removed this.", "author": "chamikaramj", "createdAt": "2020-09-21T22:26:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjM1MTYwMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjM1Mzc3NA==", "url": "https://github.com/apache/beam/pull/12880#discussion_r492353774", "bodyText": "_adjust_pipeline_for_dataflow_v2?", "author": "lukecwik", "createdAt": "2020-09-21T21:22:39Z", "path": "sdks/python/apache_beam/runners/dataflow/dataflow_runner.py", "diffHunk": "@@ -430,6 +430,11 @@ def _check_for_unsupported_fnapi_features(self, pipeline_proto):\n                 components.coders[windowing_strategy.window_coder_id].spec.urn,\n                 windowing_strategy.window_fn.urn))\n \n+  def _adjust_types_for_dataflow(self, pipeline):", "originalCommit": "dfdda4e66a30834a203d70b78a7633e5c355e1fb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjM4MDQzOQ==", "url": "https://github.com/apache/beam/pull/12880#discussion_r492380439", "bodyText": "Done.", "author": "chamikaramj", "createdAt": "2020-09-21T22:25:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjM1Mzc3NA=="}], "type": "inlineReview"}, {"oid": "83a4d4161b9544f029d2bf143d8cecddca7239f3", "url": "https://github.com/apache/beam/commit/83a4d4161b9544f029d2bf143d8cecddca7239f3", "message": "Performs Dataflow specific pipeline updates before creating the pipeine proto", "committedDate": "2020-09-22T00:56:22Z", "type": "commit"}, {"oid": "83a4d4161b9544f029d2bf143d8cecddca7239f3", "url": "https://github.com/apache/beam/commit/83a4d4161b9544f029d2bf143d8cecddca7239f3", "message": "Performs Dataflow specific pipeline updates before creating the pipeine proto", "committedDate": "2020-09-22T00:56:22Z", "type": "forcePushed"}]}