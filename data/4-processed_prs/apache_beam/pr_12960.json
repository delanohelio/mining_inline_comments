{"pr_number": 12960, "pr_title": "[BEAM-9804] Allow user configuration of BigQuery temporary dataset", "pr_createdAt": "2020-09-29T02:17:20Z", "pr_url": "https://github.com/apache/beam/pull/12960", "timeline": [{"oid": "bbe413bebf3bff4d7697f2df95ffdaf421148d62", "url": "https://github.com/apache/beam/commit/bbe413bebf3bff4d7697f2df95ffdaf421148d62", "message": "[BEAM-9804] Allow user configuration of BigQuery temporary dataset\n\nAllow ReadFromBigQuery to use a user pre-configured dataset for the temporary dataset.\nUsing a DatasetReference will also allow for cross project temporary dataset configuration.", "committedDate": "2020-09-29T02:31:59Z", "type": "forcePushed"}, {"oid": "9a14567a6b29bc8f1f60f3d727a8847e516ac00a", "url": "https://github.com/apache/beam/commit/9a14567a6b29bc8f1f60f3d727a8847e516ac00a", "message": "[BEAM-9804] Allow user configuration of BigQuery temporary dataset\n\nAllow ReadFromBigQuery to use a user pre-configured dataset for the temporary dataset.\nUsing a DatasetReference will also allow for cross project temporary dataset configuration.", "committedDate": "2020-10-01T00:58:51Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDIwOTQ2MA==", "url": "https://github.com/apache/beam/pull/12960#discussion_r504209460", "bodyText": "The BigQueryReader is only used in the Dataflow native BigQuerySource - I don't think this is compatible, so we should probably revert changes to it.\nLet's focus on temp_dataset for _CustomBigQuerySource.", "author": "pabloem", "createdAt": "2020-10-13T19:39:38Z", "path": "sdks/python/apache_beam/io/gcp/bigquery_tools.py", "diffHunk": "@@ -1096,7 +1114,8 @@ def __init__(\n       test_bigquery_client=None,\n       use_legacy_sql=True,\n       flatten_results=True,\n-      kms_key=None):\n+      kms_key=None,\n+      temp_dataset=None):", "originalCommit": "71c3ea69535268d1e37a8b97decefbf1a0e466ab", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzEwNzQyOQ==", "url": "https://github.com/apache/beam/pull/12960#discussion_r513107429", "bodyText": "reverted changes to BigQueryReader", "author": "frankzhao", "createdAt": "2020-10-28T00:21:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDIwOTQ2MA=="}], "type": "inlineReview"}, {"oid": "f3b4c5d97c0b6bb259d8d62e86eae2e140dc023d", "url": "https://github.com/apache/beam/commit/f3b4c5d97c0b6bb259d8d62e86eae2e140dc023d", "message": "Revert changes to BigQueryReader", "committedDate": "2020-10-27T10:29:44Z", "type": "forcePushed"}, {"oid": "5d25ada09e50267d0988379ab304c25765b363ef", "url": "https://github.com/apache/beam/commit/5d25ada09e50267d0988379ab304c25765b363ef", "message": "Revert changes to BigQueryReader", "committedDate": "2020-10-27T11:15:44Z", "type": "forcePushed"}, {"oid": "07445956fb6b6bf83bbd2028ce6714d5cfeba053", "url": "https://github.com/apache/beam/commit/07445956fb6b6bf83bbd2028ce6714d5cfeba053", "message": "Revert changes to BigQueryReader", "committedDate": "2020-10-27T23:39:35Z", "type": "forcePushed"}, {"oid": "be45d63d6bc32ee0ca38f45b1b5764cf746b1c74", "url": "https://github.com/apache/beam/commit/be45d63d6bc32ee0ca38f45b1b5764cf746b1c74", "message": "Fix project_id when cleaning up temporary dataset", "committedDate": "2020-10-28T12:19:36Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDUxNjYxNw==", "url": "https://github.com/apache/beam/pull/12960#discussion_r514516617", "bodyText": "in beam, we usually break lines using parentheses, kind of like this:\ndataset_id = (\n    dataset_reference.datasetId if dataset_reference else temp_table.datasetId)", "author": "pabloem", "createdAt": "2020-10-29T19:36:59Z", "path": "sdks/python/apache_beam/io/gcp/bigquery_tools.py", "diffHunk": "@@ -731,16 +744,19 @@ def create_temporary_dataset(self, project_id, location):\n   @retry.with_exponential_backoff(\n       num_retries=MAX_RETRIES,\n       retry_filter=retry.retry_on_server_errors_and_timeout_filter)\n-  def clean_up_temporary_dataset(self, project_id):\n+  def clean_up_temporary_dataset(self, project_id, dataset_reference=None):\n+    if dataset_reference:\n+      project_id = dataset_reference.projectId\n     temp_table = self._get_temp_table(project_id)\n+    dataset_id = dataset_reference.datasetId if dataset_reference \\", "originalCommit": "be45d63d6bc32ee0ca38f45b1b5764cf746b1c74", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDUxODkzNg==", "url": "https://github.com/apache/beam/pull/12960#discussion_r514518936", "bodyText": "how about we add a get_temporary_dataset function to BigqueryWrapper, and we can define a self.temp_dataset = self.temp_dataset or bq.get_temporary_dataset() (this logic would need to run in the split, and `- and once we've done that, we can just pass the dataset name around to every call? That way we will treat the user-defined dataset and the automatic dataset the same way?", "author": "pabloem", "createdAt": "2020-10-29T19:41:22Z", "path": "sdks/python/apache_beam/io/gcp/bigquery.py", "diffHunk": "@@ -712,6 +713,7 @@ def __init__(\n     self.bq_io_metadata = None  # Populate in setup, as it may make an RPC\n     self.bigquery_job_labels = bigquery_job_labels or {}\n     self.use_json_exports = use_json_exports\n+    self.temp_dataset = temp_dataset", "originalCommit": "be45d63d6bc32ee0ca38f45b1b5764cf746b1c74", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDUyMDU4NA==", "url": "https://github.com/apache/beam/pull/12960#discussion_r514520584", "bodyText": "let me know what you think about this implementation @frankzhao\nI understand changing it may be troublesome, but doing this would simplify the logic quite a bit", "author": "pabloem", "createdAt": "2020-10-29T19:44:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDUxODkzNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDU4OTg1OQ==", "url": "https://github.com/apache/beam/pull/12960#discussion_r514589859", "bodyText": "I agree, let me take look at it", "author": "frankzhao", "createdAt": "2020-10-29T21:53:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDUxODkzNg=="}], "type": "inlineReview"}, {"oid": "6980d936a2100e447e1421a84c3e8c58c3f47b7d", "url": "https://github.com/apache/beam/commit/6980d936a2100e447e1421a84c3e8c58c3f47b7d", "message": "Refactor to pass dataset through BigQueryWrapper", "committedDate": "2020-11-10T05:04:00Z", "type": "forcePushed"}, {"oid": "85830ab244f9c93acc76f91287337b17c6e74d61", "url": "https://github.com/apache/beam/commit/85830ab244f9c93acc76f91287337b17c6e74d61", "message": "Refactor to pass dataset through BigQueryWrapper", "committedDate": "2020-11-10T05:11:57Z", "type": "forcePushed"}, {"oid": "ba6b32bea97b6f7bf1ceb704174ca30dd9f1ba18", "url": "https://github.com/apache/beam/commit/ba6b32bea97b6f7bf1ceb704174ca30dd9f1ba18", "message": "Refactor to pass dataset through BigQueryWrapper", "committedDate": "2020-11-10T05:58:33Z", "type": "forcePushed"}, {"oid": "bffe7bdf6758acbeeb5441d314c4eed8851f7295", "url": "https://github.com/apache/beam/commit/bffe7bdf6758acbeeb5441d314c4eed8851f7295", "message": "Refactor to pass dataset through BigQueryWrapper", "committedDate": "2020-11-10T06:33:03Z", "type": "forcePushed"}, {"oid": "6cdedaafeef5335fd0cc06367302581a86da4173", "url": "https://github.com/apache/beam/commit/6cdedaafeef5335fd0cc06367302581a86da4173", "message": "Refactor to pass dataset through BigQueryWrapper", "committedDate": "2020-11-10T10:19:00Z", "type": "forcePushed"}, {"oid": "50bd1260475191321af56182787435a9c617066f", "url": "https://github.com/apache/beam/commit/50bd1260475191321af56182787435a9c617066f", "message": "[BEAM-9804] Allow user configuration of BigQuery temporary dataset\n\nAllow ReadFromBigQuery to use a user pre-configured dataset for the temporary dataset.\nUsing a DatasetReference will also allow for cross project temporary dataset configuration.", "committedDate": "2020-11-10T11:07:52Z", "type": "commit"}, {"oid": "50bd1260475191321af56182787435a9c617066f", "url": "https://github.com/apache/beam/commit/50bd1260475191321af56182787435a9c617066f", "message": "[BEAM-9804] Allow user configuration of BigQuery temporary dataset\n\nAllow ReadFromBigQuery to use a user pre-configured dataset for the temporary dataset.\nUsing a DatasetReference will also allow for cross project temporary dataset configuration.", "committedDate": "2020-11-10T11:07:52Z", "type": "forcePushed"}]}