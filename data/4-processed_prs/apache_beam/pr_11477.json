{"pr_number": 11477, "pr_title": "[BEAM-9650] Add PeriodicSequence generator.", "pr_createdAt": "2020-04-21T10:51:20Z", "pr_url": "https://github.com/apache/beam/pull/11477", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDgwOTM4Mw==", "url": "https://github.com/apache/beam/pull/11477#discussion_r414809383", "bodyText": "Does the element type need to be a list? What about defining a type for it like:\nclass SequenceDefinition {\n  Instant first;\n  Instant last;\n  Duration interval;\n  ...\n}", "author": "TheNeuralBit", "createdAt": "2020-04-24T19:23:26Z", "path": "sdks/java/core/src/main/java/org/apache/beam/sdk/transforms/PeriodicSequence.java", "diffHunk": "@@ -0,0 +1,180 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.beam.sdk.transforms;\n+\n+import static org.apache.beam.vendor.guava.v26_0_jre.com.google.common.base.Preconditions.checkArgument;\n+import static org.apache.beam.vendor.guava.v26_0_jre.com.google.common.base.Preconditions.checkNotNull;\n+import static org.apache.beam.vendor.guava.v26_0_jre.com.google.common.base.Preconditions.checkState;\n+\n+import java.util.List;\n+import javax.annotation.Nullable;\n+import org.apache.beam.sdk.annotations.Experimental;\n+import org.apache.beam.sdk.io.range.OffsetRange;\n+import org.apache.beam.sdk.transforms.splittabledofn.RestrictionTracker;\n+import org.apache.beam.sdk.transforms.splittabledofn.Sizes;\n+import org.apache.beam.sdk.transforms.splittabledofn.SplitResult;\n+import org.apache.beam.sdk.values.PCollection;\n+import org.apache.beam.vendor.guava.v26_0_jre.com.google.common.base.MoreObjects;\n+import org.joda.time.Duration;\n+import org.joda.time.Instant;\n+\n+/**\n+ * A {@link PTransform} which generates a sequence of timestamped elements at given interval in\n+ * runtime.\n+ *\n+ * <p>Receives a PCollection<List<Long>> where each element triggers the generation of sequence and\n+ * has following elements: 0: first element timestamp 1: last element timestamp 2: interval", "originalCommit": "da8f2f3731bd43df95d0ee27f680b68a4aa0c24f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDgyMjIxNA==", "url": "https://github.com/apache/beam/pull/11477#discussion_r414822214", "bodyText": "This should be clear that past and future are determined by the system clock on the worker machine (can we just call that \"processing time\"?)", "author": "TheNeuralBit", "createdAt": "2020-04-24T19:47:25Z", "path": "sdks/java/core/src/main/java/org/apache/beam/sdk/transforms/PeriodicSequence.java", "diffHunk": "@@ -0,0 +1,180 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.beam.sdk.transforms;\n+\n+import static org.apache.beam.vendor.guava.v26_0_jre.com.google.common.base.Preconditions.checkArgument;\n+import static org.apache.beam.vendor.guava.v26_0_jre.com.google.common.base.Preconditions.checkNotNull;\n+import static org.apache.beam.vendor.guava.v26_0_jre.com.google.common.base.Preconditions.checkState;\n+\n+import java.util.List;\n+import javax.annotation.Nullable;\n+import org.apache.beam.sdk.annotations.Experimental;\n+import org.apache.beam.sdk.io.range.OffsetRange;\n+import org.apache.beam.sdk.transforms.splittabledofn.RestrictionTracker;\n+import org.apache.beam.sdk.transforms.splittabledofn.Sizes;\n+import org.apache.beam.sdk.transforms.splittabledofn.SplitResult;\n+import org.apache.beam.sdk.values.PCollection;\n+import org.apache.beam.vendor.guava.v26_0_jre.com.google.common.base.MoreObjects;\n+import org.joda.time.Duration;\n+import org.joda.time.Instant;\n+\n+/**\n+ * A {@link PTransform} which generates a sequence of timestamped elements at given interval in\n+ * runtime.\n+ *\n+ * <p>Receives a PCollection<List<Long>> where each element triggers the generation of sequence and\n+ * has following elements: 0: first element timestamp 1: last element timestamp 2: interval\n+ *\n+ * <p>All elements that have timestamp in the past will be output right away. Elements that have\n+ * timestamp in the future will be delayed.", "originalCommit": "da8f2f3731bd43df95d0ee27f680b68a4aa0c24f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDgzMTkzNQ==", "url": "https://github.com/apache/beam/pull/11477#discussion_r414831935", "bodyText": "It would be good to add a test to verify PeriodicImpulse delays elements with timestamps in the future. One way could be to just set a startTime far in the future and verify nothing is output after some delay. But then the delay would have to be long enough to make sure the pipeline actually started for every runner, which isn't ideal.", "author": "TheNeuralBit", "createdAt": "2020-04-24T20:05:46Z", "path": "sdks/java/core/src/test/java/org/apache/beam/sdk/transforms/PeriodicImpulseTest.java", "diffHunk": "@@ -0,0 +1,79 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.beam.sdk.transforms;\n+\n+import java.util.ArrayList;\n+import org.apache.beam.sdk.testing.NeedsRunner;\n+import org.apache.beam.sdk.testing.PAssert;\n+import org.apache.beam.sdk.testing.TestPipeline;\n+import org.apache.beam.sdk.testing.UsesImpulse;\n+import org.apache.beam.sdk.testing.UsesStatefulParDo;\n+import org.apache.beam.sdk.values.KV;\n+import org.apache.beam.sdk.values.PCollection;\n+import org.joda.time.Duration;\n+import org.joda.time.Instant;\n+import org.junit.Rule;\n+import org.junit.Test;\n+import org.junit.experimental.categories.Category;\n+import org.junit.runner.RunWith;\n+import org.junit.runners.JUnit4;\n+\n+/** Tests for PeriodicImpulse. */\n+@RunWith(JUnit4.class)\n+public class PeriodicImpulseTest {\n+  @Rule public transient TestPipeline p = TestPipeline.create();\n+\n+  public static class ExtractTsDoFn<InputT> extends DoFn<InputT, KV<InputT, Instant>> {\n+    @ProcessElement\n+    public void processElement(DoFn<InputT, KV<InputT, Instant>>.ProcessContext c)\n+        throws Exception {\n+      c.output(KV.of(c.element(), c.timestamp()));\n+    }\n+  }\n+\n+  @Test\n+  @Category({\n+    NeedsRunner.class,\n+    UsesImpulse.class,\n+    UsesStatefulParDo.class,\n+  })\n+  public void testOutputsProperElements() {\n+    Instant instant = Instant.now();\n+\n+    Instant startTime = instant.minus(Duration.standardHours(100));\n+    long duration = 500;\n+    Duration interval = Duration.millis(250);\n+    long intervalMillis = interval.getMillis();\n+    Instant stopTime = startTime.plus(duration);\n+\n+    PCollection<KV<Instant, Instant>> result =\n+        p.apply(PeriodicImpulse.create().startAt(startTime).stopAt(stopTime).withInterval(interval))\n+            .apply(ParDo.of(new ExtractTsDoFn<>()));\n+\n+    ArrayList<KV<Instant, Instant>> expectedResults =\n+        new ArrayList<>((int) (duration / intervalMillis + 1));\n+    for (long i = 0; i <= duration; i += intervalMillis) {\n+      Instant el = startTime.plus(i);\n+      expectedResults.add(KV.of(el, el));\n+    }\n+\n+    PAssert.that(result).containsInAnyOrder(expectedResults);\n+\n+    p.run().waitUntilFinish();\n+  }", "originalCommit": "da8f2f3731bd43df95d0ee27f680b68a4aa0c24f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDg1NTQ2Mg==", "url": "https://github.com/apache/beam/pull/11477#discussion_r414855462", "bodyText": "This is a valid comment. The problem is that to generate reliable test, we need to mock time on many layers. I didn't find a reliable way to do this. This test is a balance that tests most of functionality. Delaying elements to the future will make tests unreasonably long and will most likely be unreliable.", "author": "Ardagan", "createdAt": "2020-04-24T20:51:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDgzMTkzNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDgzMjY4OQ==", "url": "https://github.com/apache/beam/pull/11477#discussion_r414832689", "bodyText": "It would be a lot easier to verify many different situations if there were some way to mock the clock, but that's pretty challenging when the clock might be on a remote worker. Have we solved that problem anywhere else?", "author": "TheNeuralBit", "createdAt": "2020-04-24T20:07:04Z", "path": "sdks/java/core/src/test/java/org/apache/beam/sdk/transforms/PeriodicImpulseTest.java", "diffHunk": "@@ -0,0 +1,79 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.beam.sdk.transforms;\n+\n+import java.util.ArrayList;\n+import org.apache.beam.sdk.testing.NeedsRunner;\n+import org.apache.beam.sdk.testing.PAssert;\n+import org.apache.beam.sdk.testing.TestPipeline;\n+import org.apache.beam.sdk.testing.UsesImpulse;\n+import org.apache.beam.sdk.testing.UsesStatefulParDo;\n+import org.apache.beam.sdk.values.KV;\n+import org.apache.beam.sdk.values.PCollection;\n+import org.joda.time.Duration;\n+import org.joda.time.Instant;\n+import org.junit.Rule;\n+import org.junit.Test;\n+import org.junit.experimental.categories.Category;\n+import org.junit.runner.RunWith;\n+import org.junit.runners.JUnit4;\n+\n+/** Tests for PeriodicImpulse. */\n+@RunWith(JUnit4.class)\n+public class PeriodicImpulseTest {\n+  @Rule public transient TestPipeline p = TestPipeline.create();\n+\n+  public static class ExtractTsDoFn<InputT> extends DoFn<InputT, KV<InputT, Instant>> {\n+    @ProcessElement\n+    public void processElement(DoFn<InputT, KV<InputT, Instant>>.ProcessContext c)\n+        throws Exception {\n+      c.output(KV.of(c.element(), c.timestamp()));\n+    }\n+  }\n+\n+  @Test\n+  @Category({\n+    NeedsRunner.class,\n+    UsesImpulse.class,\n+    UsesStatefulParDo.class,\n+  })\n+  public void testOutputsProperElements() {\n+    Instant instant = Instant.now();", "originalCommit": "da8f2f3731bd43df95d0ee27f680b68a4aa0c24f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDg1MTA2MQ==", "url": "https://github.com/apache/beam/pull/11477#discussion_r414851061", "bodyText": "On the DirectRunner at least you could use DateTimeUtils#setCurrentMillisFixed", "author": "TheNeuralBit", "createdAt": "2020-04-24T20:42:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDgzMjY4OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDg1NDY5MA==", "url": "https://github.com/apache/beam/pull/11477#discussion_r414854690", "bodyText": "I was looking to do this. Mostly looking towards TestStream, but the issue is that there's no way to get runner time within process method and I have to rely on now() to figure out how many elements I can output.\nCurrent test is a balance that still verifies functionality, but doesn't make test run too long.", "author": "Ardagan", "createdAt": "2020-04-24T20:49:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDgzMjY4OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDgzNDU5Ng==", "url": "https://github.com/apache/beam/pull/11477#discussion_r414834596", "bodyText": "I'm not sure I understand what this means, could you clarify? It looks like maybe it's re-stating the previous paragraph in a different way?", "author": "TheNeuralBit", "createdAt": "2020-04-24T20:10:54Z", "path": "sdks/java/core/src/main/java/org/apache/beam/sdk/transforms/PeriodicSequence.java", "diffHunk": "@@ -0,0 +1,180 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.beam.sdk.transforms;\n+\n+import static org.apache.beam.vendor.guava.v26_0_jre.com.google.common.base.Preconditions.checkArgument;\n+import static org.apache.beam.vendor.guava.v26_0_jre.com.google.common.base.Preconditions.checkNotNull;\n+import static org.apache.beam.vendor.guava.v26_0_jre.com.google.common.base.Preconditions.checkState;\n+\n+import java.util.List;\n+import javax.annotation.Nullable;\n+import org.apache.beam.sdk.annotations.Experimental;\n+import org.apache.beam.sdk.io.range.OffsetRange;\n+import org.apache.beam.sdk.transforms.splittabledofn.RestrictionTracker;\n+import org.apache.beam.sdk.transforms.splittabledofn.Sizes;\n+import org.apache.beam.sdk.transforms.splittabledofn.SplitResult;\n+import org.apache.beam.sdk.values.PCollection;\n+import org.apache.beam.vendor.guava.v26_0_jre.com.google.common.base.MoreObjects;\n+import org.joda.time.Duration;\n+import org.joda.time.Instant;\n+\n+/**\n+ * A {@link PTransform} which generates a sequence of timestamped elements at given interval in\n+ * runtime.\n+ *\n+ * <p>Receives a PCollection<List<Long>> where each element triggers the generation of sequence and\n+ * has following elements: 0: first element timestamp 1: last element timestamp 2: interval\n+ *\n+ * <p>All elements that have timestamp in the past will be output right away. Elements that have\n+ * timestamp in the future will be delayed.\n+ *\n+ * <p>Transform will not output elements prior to target timestamp. Transform can output elements at\n+ * any time after target timestamp.", "originalCommit": "da8f2f3731bd43df95d0ee27f680b68a4aa0c24f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDgzNTk1Mw==", "url": "https://github.com/apache/beam/pull/11477#discussion_r414835953", "bodyText": "Does this need to be public? If so, should it have a test as well?", "author": "TheNeuralBit", "createdAt": "2020-04-24T20:13:32Z", "path": "sdks/java/core/src/main/java/org/apache/beam/sdk/transforms/PeriodicSequence.java", "diffHunk": "@@ -0,0 +1,180 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.beam.sdk.transforms;\n+\n+import static org.apache.beam.vendor.guava.v26_0_jre.com.google.common.base.Preconditions.checkArgument;\n+import static org.apache.beam.vendor.guava.v26_0_jre.com.google.common.base.Preconditions.checkNotNull;\n+import static org.apache.beam.vendor.guava.v26_0_jre.com.google.common.base.Preconditions.checkState;\n+\n+import java.util.List;\n+import javax.annotation.Nullable;\n+import org.apache.beam.sdk.annotations.Experimental;\n+import org.apache.beam.sdk.io.range.OffsetRange;\n+import org.apache.beam.sdk.transforms.splittabledofn.RestrictionTracker;\n+import org.apache.beam.sdk.transforms.splittabledofn.Sizes;\n+import org.apache.beam.sdk.transforms.splittabledofn.SplitResult;\n+import org.apache.beam.sdk.values.PCollection;\n+import org.apache.beam.vendor.guava.v26_0_jre.com.google.common.base.MoreObjects;\n+import org.joda.time.Duration;\n+import org.joda.time.Instant;\n+\n+/**\n+ * A {@link PTransform} which generates a sequence of timestamped elements at given interval in\n+ * runtime.\n+ *\n+ * <p>Receives a PCollection<List<Long>> where each element triggers the generation of sequence and\n+ * has following elements: 0: first element timestamp 1: last element timestamp 2: interval\n+ *\n+ * <p>All elements that have timestamp in the past will be output right away. Elements that have\n+ * timestamp in the future will be delayed.\n+ *\n+ * <p>Transform will not output elements prior to target timestamp. Transform can output elements at\n+ * any time after target timestamp.\n+ */\n+@Experimental(Experimental.Kind.SPLITTABLE_DO_FN)\n+public class PeriodicSequence extends PTransform<PCollection<List<Long>>, PCollection<Instant>> {", "originalCommit": "da8f2f3731bd43df95d0ee27f680b68a4aa0c24f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "b0a9e911f6bcf1979ee134f6e4f9ff7b16557cc1", "url": "https://github.com/apache/beam/commit/b0a9e911f6bcf1979ee134f6e4f9ff7b16557cc1", "message": "Add PeriodicSequence generator.\nAdd java snippet for slowly updating side inputs.", "committedDate": "2020-04-28T16:22:27Z", "type": "commit"}, {"oid": "d6482c289b1fa9284915722b60ab402c1cd43db3", "url": "https://github.com/apache/beam/commit/d6482c289b1fa9284915722b60ab402c1cd43db3", "message": "Spotless", "committedDate": "2020-04-28T16:22:27Z", "type": "commit"}, {"oid": "2682865ed629ffc267153dc20f5fcd065528fb78", "url": "https://github.com/apache/beam/commit/2682865ed629ffc267153dc20f5fcd065528fb78", "message": "address comments", "committedDate": "2020-04-28T16:35:49Z", "type": "commit"}, {"oid": "2682865ed629ffc267153dc20f5fcd065528fb78", "url": "https://github.com/apache/beam/commit/2682865ed629ffc267153dc20f5fcd065528fb78", "message": "address comments", "committedDate": "2020-04-28T16:35:49Z", "type": "forcePushed"}, {"oid": "78eec989987c74d5418c35b5743b2d2665f4c1fa", "url": "https://github.com/apache/beam/commit/78eec989987c74d5418c35b5743b2d2665f4c1fa", "message": "spotless", "committedDate": "2020-04-28T16:53:10Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzY1NjY3Nw==", "url": "https://github.com/apache/beam/pull/11477#discussion_r417656677", "bodyText": "Can you add a comment here that the reason you put the Instant into a KV is so you can verify the timestamp? It took me a while to realize that.\n(Also if we don't already have some general purpose way to verify timestamps in PCollections maybe we should?)", "author": "TheNeuralBit", "createdAt": "2020-04-29T22:46:51Z", "path": "sdks/java/core/src/test/java/org/apache/beam/sdk/transforms/PeriodicSequenceTest.java", "diffHunk": "@@ -0,0 +1,82 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.beam.sdk.transforms;\n+\n+import java.util.ArrayList;\n+import org.apache.beam.sdk.testing.NeedsRunner;\n+import org.apache.beam.sdk.testing.PAssert;\n+import org.apache.beam.sdk.testing.TestPipeline;\n+import org.apache.beam.sdk.testing.UsesImpulse;\n+import org.apache.beam.sdk.testing.UsesStatefulParDo;\n+import org.apache.beam.sdk.values.KV;\n+import org.apache.beam.sdk.values.PCollection;\n+import org.joda.time.Duration;\n+import org.joda.time.Instant;\n+import org.junit.Rule;\n+import org.junit.Test;\n+import org.junit.experimental.categories.Category;\n+import org.junit.runner.RunWith;\n+import org.junit.runners.JUnit4;\n+\n+/** Tests for PeriodicSequence. */\n+@RunWith(JUnit4.class)\n+public class PeriodicSequenceTest {\n+  @Rule public transient TestPipeline p = TestPipeline.create();\n+\n+  public static class ExtractTsDoFn<InputT> extends DoFn<InputT, KV<InputT, Instant>> {\n+    @ProcessElement\n+    public void processElement(DoFn<InputT, KV<InputT, Instant>>.ProcessContext c)\n+        throws Exception {\n+      c.output(KV.of(c.element(), c.timestamp()));\n+    }\n+  }\n+\n+  @Test\n+  @Category({\n+    NeedsRunner.class,\n+    UsesImpulse.class,\n+    UsesStatefulParDo.class,\n+  })\n+  public void testOutputsProperElements() {\n+    Instant instant = Instant.now();\n+\n+    Instant startTime = instant.minus(Duration.standardHours(100));\n+    long duration = 500;\n+    Duration interval = Duration.millis(250);\n+    long intervalMillis = interval.getMillis();\n+    Instant stopTime = startTime.plus(duration);\n+\n+    PCollection<KV<Instant, Instant>> result =\n+        p.apply(\n+                Create.<PeriodicSequence.SequenceDefinition>of(\n+                    new PeriodicSequence.SequenceDefinition(startTime, stopTime, interval)))\n+            .apply(PeriodicSequence.create())\n+            .apply(ParDo.of(new ExtractTsDoFn<>()));", "originalCommit": "2682865ed629ffc267153dc20f5fcd065528fb78", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzY2MjY0Nw==", "url": "https://github.com/apache/beam/pull/11477#discussion_r417662647", "bodyText": "nit: Consider using AutoValue (and AutoValueSchemaProvider if you use schemas) so you don't have to implement these. Up to you though.", "author": "TheNeuralBit", "createdAt": "2020-04-29T23:04:17Z", "path": "sdks/java/core/src/main/java/org/apache/beam/sdk/transforms/PeriodicSequence.java", "diffHunk": "@@ -21,33 +21,69 @@\n import static org.apache.beam.vendor.guava.v26_0_jre.com.google.common.base.Preconditions.checkNotNull;\n import static org.apache.beam.vendor.guava.v26_0_jre.com.google.common.base.Preconditions.checkState;\n \n-import java.util.List;\n+import java.util.Objects;\n import javax.annotation.Nullable;\n import org.apache.beam.sdk.annotations.Experimental;\n import org.apache.beam.sdk.io.range.OffsetRange;\n+import org.apache.beam.sdk.schemas.JavaFieldSchema;\n+import org.apache.beam.sdk.schemas.annotations.DefaultSchema;\n import org.apache.beam.sdk.transforms.splittabledofn.RestrictionTracker;\n-import org.apache.beam.sdk.transforms.splittabledofn.Sizes;\n import org.apache.beam.sdk.transforms.splittabledofn.SplitResult;\n import org.apache.beam.sdk.values.PCollection;\n import org.apache.beam.vendor.guava.v26_0_jre.com.google.common.base.MoreObjects;\n import org.joda.time.Duration;\n import org.joda.time.Instant;\n \n /**\n- * A {@link PTransform} which generates a sequence of timestamped elements at given interval in\n- * runtime.\n+ * A {@link PTransform} which generates a sequence of timestamped elements at given runtime\n+ * interval.\n  *\n- * <p>Receives a PCollection<List<Long>> where each element triggers the generation of sequence and\n- * has following elements: 0: first element timestamp 1: last element timestamp 2: interval\n+ * <p>Transform will not output elements prior to target time. Transform can output elements at any\n+ * time after target time.\n  *\n- * <p>All elements that have timestamp in the past will be output right away. Elements that have\n- * timestamp in the future will be delayed.\n- *\n- * <p>Transform will not output elements prior to target timestamp. Transform can output elements at\n- * any time after target timestamp.\n+ * <p>Multiple elements can be output at given moment if their timestamp is earlier than current\n+ * time.\n  */\n @Experimental(Experimental.Kind.SPLITTABLE_DO_FN)\n-public class PeriodicSequence extends PTransform<PCollection<List<Long>>, PCollection<Instant>> {\n+public class PeriodicSequence\n+    extends PTransform<PCollection<PeriodicSequence.SequenceDefinition>, PCollection<Instant>> {\n+\n+  @DefaultSchema(JavaFieldSchema.class)\n+  public static class SequenceDefinition {\n+    public Instant first;\n+    public Instant last;\n+    public Long durationMilliSec;\n+\n+    public SequenceDefinition() {}\n+\n+    public SequenceDefinition(Instant first, Instant last, Duration duration) {\n+      this.first = first;\n+      this.last = last;\n+      this.durationMilliSec = duration.getMillis();\n+    }\n+\n+    @Override\n+    public boolean equals(Object obj) {\n+      if (this == obj) {\n+        return true;\n+      }\n+\n+      if (obj == null || obj.getClass() != this.getClass()) {\n+        return false;\n+      }\n+\n+      SequenceDefinition src = (SequenceDefinition) obj;\n+      return src.first.equals(this.first)\n+          && src.last.equals(this.last)\n+          && src.durationMilliSec.equals(this.durationMilliSec);\n+    }\n+\n+    @Override\n+    public int hashCode() {\n+      int result = Objects.hash(first, last, durationMilliSec);\n+      return result;\n+    }", "originalCommit": "2682865ed629ffc267153dc20f5fcd065528fb78", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODY3MzY3NA==", "url": "https://github.com/apache/beam/pull/11477#discussion_r418673674", "bodyText": "I tried to use it, but didn't manage to get AutoValue work. It failed to properly detect constructor for generated class. I tried to debug it, but it would be better to handle in separate PR.", "author": "Ardagan", "createdAt": "2020-05-01T18:28:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzY2MjY0Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzY2NjA1Mw==", "url": "https://github.com/apache/beam/pull/11477#discussion_r417666053", "bodyText": "We really should have support for Duration in beam schemas... filed BEAM-9859 for this.\nIn the meantime, couldn't you just use @DefaultCoder(SerializableCoder.class) so you could store this as a Duration?", "author": "TheNeuralBit", "createdAt": "2020-04-29T23:14:20Z", "path": "sdks/java/core/src/main/java/org/apache/beam/sdk/transforms/PeriodicSequence.java", "diffHunk": "@@ -21,33 +21,69 @@\n import static org.apache.beam.vendor.guava.v26_0_jre.com.google.common.base.Preconditions.checkNotNull;\n import static org.apache.beam.vendor.guava.v26_0_jre.com.google.common.base.Preconditions.checkState;\n \n-import java.util.List;\n+import java.util.Objects;\n import javax.annotation.Nullable;\n import org.apache.beam.sdk.annotations.Experimental;\n import org.apache.beam.sdk.io.range.OffsetRange;\n+import org.apache.beam.sdk.schemas.JavaFieldSchema;\n+import org.apache.beam.sdk.schemas.annotations.DefaultSchema;\n import org.apache.beam.sdk.transforms.splittabledofn.RestrictionTracker;\n-import org.apache.beam.sdk.transforms.splittabledofn.Sizes;\n import org.apache.beam.sdk.transforms.splittabledofn.SplitResult;\n import org.apache.beam.sdk.values.PCollection;\n import org.apache.beam.vendor.guava.v26_0_jre.com.google.common.base.MoreObjects;\n import org.joda.time.Duration;\n import org.joda.time.Instant;\n \n /**\n- * A {@link PTransform} which generates a sequence of timestamped elements at given interval in\n- * runtime.\n+ * A {@link PTransform} which generates a sequence of timestamped elements at given runtime\n+ * interval.\n  *\n- * <p>Receives a PCollection<List<Long>> where each element triggers the generation of sequence and\n- * has following elements: 0: first element timestamp 1: last element timestamp 2: interval\n+ * <p>Transform will not output elements prior to target time. Transform can output elements at any\n+ * time after target time.\n  *\n- * <p>All elements that have timestamp in the past will be output right away. Elements that have\n- * timestamp in the future will be delayed.\n- *\n- * <p>Transform will not output elements prior to target timestamp. Transform can output elements at\n- * any time after target timestamp.\n+ * <p>Multiple elements can be output at given moment if their timestamp is earlier than current\n+ * time.\n  */\n @Experimental(Experimental.Kind.SPLITTABLE_DO_FN)\n-public class PeriodicSequence extends PTransform<PCollection<List<Long>>, PCollection<Instant>> {\n+public class PeriodicSequence\n+    extends PTransform<PCollection<PeriodicSequence.SequenceDefinition>, PCollection<Instant>> {\n+\n+  @DefaultSchema(JavaFieldSchema.class)\n+  public static class SequenceDefinition {\n+    public Instant first;\n+    public Instant last;\n+    public Long durationMilliSec;", "originalCommit": "2682865ed629ffc267153dc20f5fcd065528fb78", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzY2OTQwMA==", "url": "https://github.com/apache/beam/pull/11477#discussion_r417669400", "bodyText": "Can you add a note that this is according to the clock on the worker node?", "author": "TheNeuralBit", "createdAt": "2020-04-29T23:24:43Z", "path": "sdks/java/core/src/main/java/org/apache/beam/sdk/transforms/PeriodicSequence.java", "diffHunk": "@@ -0,0 +1,212 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.beam.sdk.transforms;\n+\n+import static org.apache.beam.vendor.guava.v26_0_jre.com.google.common.base.Preconditions.checkArgument;\n+import static org.apache.beam.vendor.guava.v26_0_jre.com.google.common.base.Preconditions.checkNotNull;\n+import static org.apache.beam.vendor.guava.v26_0_jre.com.google.common.base.Preconditions.checkState;\n+\n+import java.util.Objects;\n+import javax.annotation.Nullable;\n+import org.apache.beam.sdk.annotations.Experimental;\n+import org.apache.beam.sdk.io.range.OffsetRange;\n+import org.apache.beam.sdk.schemas.JavaFieldSchema;\n+import org.apache.beam.sdk.schemas.annotations.DefaultSchema;\n+import org.apache.beam.sdk.transforms.splittabledofn.RestrictionTracker;\n+import org.apache.beam.sdk.transforms.splittabledofn.SplitResult;\n+import org.apache.beam.sdk.values.PCollection;\n+import org.apache.beam.vendor.guava.v26_0_jre.com.google.common.base.MoreObjects;\n+import org.joda.time.Duration;\n+import org.joda.time.Instant;\n+\n+/**\n+ * A {@link PTransform} which generates a sequence of timestamped elements at given runtime\n+ * interval.\n+ *\n+ * <p>Transform will not output elements prior to target time. Transform can output elements at any\n+ * time after target time.", "originalCommit": "78eec989987c74d5418c35b5743b2d2665f4c1fa", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "869c7fb0c93735cbd28c117379e10ab0d045e49d", "url": "https://github.com/apache/beam/commit/869c7fb0c93735cbd28c117379e10ab0d045e49d", "message": "address comments", "committedDate": "2020-05-01T18:25:12Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODcyNDM1MQ==", "url": "https://github.com/apache/beam/pull/11477#discussion_r418724351", "bodyText": "Sorry just noticed this. Can you replace it with a log statement?", "author": "TheNeuralBit", "createdAt": "2020-05-01T20:30:04Z", "path": "examples/java/src/main/java/org/apache/beam/examples/snippets/Snippets.java", "diffHunk": "@@ -785,4 +787,73 @@ public static void main(String[] args) {\n \n     }\n   }\n+\n+  public static class PeriodicallyUpdatingSideInputs {\n+\n+    public static PCollection<Long> main(\n+        Pipeline p,\n+        Instant startAt,\n+        Instant stopAt,\n+        Duration interval1,\n+        Duration interval2,\n+        String fileToRead) {\n+      // [START PeriodicallyUpdatingSideInputs]\n+      PCollectionView<List<Long>> sideInput =\n+          p.apply(\n+                  \"SIImpulse\",\n+                  PeriodicImpulse.create()\n+                      .startAt(startAt)\n+                      .stopAt(stopAt)\n+                      .withInterval(interval1)\n+                      .applyWindowing())\n+              .apply(\n+                  \"FileToRead\",\n+                  ParDo.of(\n+                      new DoFn<Instant, String>() {\n+                        @DoFn.ProcessElement\n+                        public void process(@Element Instant notUsed, OutputReceiver<String> o) {\n+                          o.output(fileToRead);\n+                        }\n+                      }))\n+              .apply(FileIO.matchAll())\n+              .apply(FileIO.readMatches())\n+              .apply(TextIO.readFiles())\n+              .apply(\n+                  ParDo.of(\n+                      new DoFn<String, String>() {\n+                        @ProcessElement\n+                        public void process(@Element String src, OutputReceiver<String> o) {\n+                          System.out.println(src);", "originalCommit": "869c7fb0c93735cbd28c117379e10ab0d045e49d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "97a2edc4d8d4a5912e640d3bb0548dcb9dd1d3b0", "url": "https://github.com/apache/beam/commit/97a2edc4d8d4a5912e640d3bb0548dcb9dd1d3b0", "message": "remove println", "committedDate": "2020-05-01T20:58:54Z", "type": "commit"}]}