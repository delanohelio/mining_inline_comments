{"pr_number": 12499, "pr_title": "[BEAM-10602] Fix load test metrics in Grafana dashboard", "pr_createdAt": "2020-08-07T16:47:22Z", "pr_url": "https://github.com/apache/beam/pull/12499", "timeline": [{"oid": "b58cba3f44c9963189de7977eaf69a4891adc6ad", "url": "https://github.com/apache/beam/commit/b58cba3f44c9963189de7977eaf69a4891adc6ad", "message": "Revert \"Merge pull request #12408: [BEAM-10602] Display Python streaming metrics in Grafana dashboard\"\n\nThis reverts commit cdc24753054d3aa23805511879ec712f952e2a92, reversing\nchanges made to 835805dfc9beaa7b3aecc690dd49c2ae04f14f98.\n\nRevert \"Merge pull request #12451: [BEAM-10602] Use python_streaming_pardo_5 table for latency results\"\n\nThis reverts commit 2f47b824507b3a1486ed6cdc8fb4ea6639c924ca, reversing\nchanges made to d971ba13b8ed31de3413558f701d752cbf202d47.", "committedDate": "2020-08-07T16:41:20Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzE3NDcxNw==", "url": "https://github.com/apache/beam/pull/12499#discussion_r467174717", "bodyText": "nit: add a newline?", "author": "amaliujia", "createdAt": "2020-08-07T17:29:48Z", "path": ".test-infra/metrics/grafana/dashboards/perftests_metrics/ParDo_Load_Tests.json", "diffHunk": "@@ -619,5 +855,5 @@\n   \"variables\": {\n     \"list\": []\n   },\n-  \"version\": 2\n+  \"version\": 8\n }", "originalCommit": "8c4125492d6b32e9ee7fac4eb15211e1b1d00821", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzE4NDc3Mg==", "url": "https://github.com/apache/beam/pull/12499#discussion_r467184772", "bodyText": "This file is auto-generated but I could add a newline :)", "author": "mxm", "createdAt": "2020-08-07T17:50:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzE3NDcxNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzE4MjA3MA==", "url": "https://github.com/apache/beam/pull/12499#discussion_r467182070", "bodyText": "For my own understanding, could you elaborate on this?", "author": "tysonjh", "createdAt": "2020-08-07T17:45:07Z", "path": ".test-infra/jenkins/job_LoadTests_ParDo_Flink_Python.groovy", "diffHunk": "@@ -161,12 +164,13 @@ def streamingScenarios = { datasetName ->\n       test           : 'apache_beam.testing.load_tests.pardo_test',\n       runner         : CommonTestProperties.Runner.PORTABLE,\n       pipelineOptions: [\n-        job_name             : 'load-tests-python-flink-streaming-pardo-5-' + now,\n+        job_name             : 'load-tests-python-flink-streaming-pardo-1-' + now,\n         project              : 'apache-beam-testing',\n         publish_to_big_query : true,\n         metrics_dataset      : datasetName,\n+        // Keep the old name to not break the legacy dashboard", "originalCommit": "8c4125492d6b32e9ee7fac4eb15211e1b1d00821", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Nzk0NDkxNA==", "url": "https://github.com/apache/beam/pull/12499#discussion_r467944914", "bodyText": "This is such that the old dashboard continues to work: https://apache-beam-testing.appspot.com/explore?dashboard=5751884853805056\nIt's been a bit of a frustrating experience trying to migrate what we have there..", "author": "mxm", "createdAt": "2020-08-10T14:30:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzE4MjA3MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzkwNzMwMQ==", "url": "https://github.com/apache/beam/pull/12499#discussion_r467907301", "bodyText": "I have mixed feelings about it. This test is not load-tests-python-flink-batch-pardo-1 but on streaming. There are more differences between them: batch-pardo-1 uses 10 iterations, this test uses 5 iterations. 0 counters in batch-pardo-1 vs. 3 counters right here. Because of that, I think we should stay with the previous job_name: load-tests-python-flink-streaming-pardo-5.\nThe general idea behind load tests is that we run the same configuration on different runners, in different SDKs and in different mode (batch or streaming). Grafana dashboards for load tests were designed with that convention in mind. If you choose java and streaming from the list, Grafana will pull data from these measurements: java_streaming_pardo_1, java_streaming_pardo_2 and so. Your streaming tests are a bit problematic, because they are not being run on Dataflow and batch. Also, they have no Java counterpart.\nThat being said, I think about two solutions:\n\nAdd more charts. We would end up with a total of six charts. The fifth and the sixth chart would be empty in most cases (for Java and for batch).\nCreate a separate, more specific version of dashboard just for these two tests (streaming-pardo-5 and streaming-pardo-6). Leave \"ParDo Load Tests\" dashboard intact.\n\n@mxm What do you think?", "author": "kamilwu", "createdAt": "2020-08-10T13:35:12Z", "path": ".test-infra/jenkins/job_LoadTests_ParDo_Flink_Python.groovy", "diffHunk": "@@ -161,12 +164,13 @@ def streamingScenarios = { datasetName ->\n       test           : 'apache_beam.testing.load_tests.pardo_test',\n       runner         : CommonTestProperties.Runner.PORTABLE,\n       pipelineOptions: [\n-        job_name             : 'load-tests-python-flink-streaming-pardo-5-' + now,\n+        job_name             : 'load-tests-python-flink-streaming-pardo-1-' + now,", "originalCommit": "8c4125492d6b32e9ee7fac4eb15211e1b1d00821", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Nzk0MzYyMg==", "url": "https://github.com/apache/beam/pull/12499#discussion_r467943622", "bodyText": "Note, this is just the job name. More important is the table we are writing to further down. Unfortunately, the Grafana setup forces me to do that. I would rather not change this but the Grafana setup is very inflexible and in this regard a regression from the old framework we used: https://apache-beam-testing.appspot.com/explore?dashboard=5751884853805056\n\nYour streaming tests are a bit problematic, because they are not being run on Dataflow and batch.\n\nI don't fully understand your point to be honest, in order for the dropdown menus to work properly, i.e. choosing SDK and the mode (batch/streaming), this change is required because the table name is composed of $sdk_$mode_. The test parameters looked identical to me for Dataflow/Flink. If the iterations don't match, we can adjust that. The input is already the same.\nAdding more charts would be another option. We have to remove the streaming dropdown and just add one chart per streaming and batch run. I think that is the best option. It gives us a bit more flexibility.", "author": "mxm", "createdAt": "2020-08-10T14:29:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzkwNzMwMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Nzk0ODQzMA==", "url": "https://github.com/apache/beam/pull/12499#discussion_r467948430", "bodyText": "@kamilwu If you agree, I'd remove the streaming/batch dropdown and just add a new chart for the streaming mode. I suppose that is a better migration path because there are no other streaming load tests at the moment.", "author": "mxm", "createdAt": "2020-08-10T14:36:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzkwNzMwMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Nzk3MDUzNw==", "url": "https://github.com/apache/beam/pull/12499#discussion_r467970537", "bodyText": "there are no other streaming load tests at the moment.\n\nNot quite. At the moment, we have streaming load tests for Java (Dataflow only). Apart from that, I'm investigating running other Python load tests (ParDo 1, 2, 3 and 4) in streaming mode too.", "author": "kamilwu", "createdAt": "2020-08-10T15:07:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzkwNzMwMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Nzk3NTEzNw==", "url": "https://github.com/apache/beam/pull/12499#discussion_r467975137", "bodyText": "@kkucharc is actually working on streaming load tests for Python on Dataflow and she's already prepared a PR: #12435. We would like to show metrics from these new tests too.", "author": "kamilwu", "createdAt": "2020-08-10T15:13:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzkwNzMwMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Nzk3NjY4MA==", "url": "https://github.com/apache/beam/pull/12499#discussion_r467976680", "bodyText": "Good to hear. Still, there is no streaming data in the dashboards yet :)\nSo do you agree to add new dashboards panels for the streaming tests and removing the selector for batch/streaming?", "author": "mxm", "createdAt": "2020-08-10T15:16:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzkwNzMwMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Nzk4MTAxMg==", "url": "https://github.com/apache/beam/pull/12499#discussion_r467981012", "bodyText": "If the iterations don't match, we can adjust that. The input is already the same.\n\n@mxm Do you think it is possible to adjust those parameters so that pardo-5 can become pardo-1 and pardo-6 can become pardo-2, pardo-3 or pardo-4? The main advantage of this solution is that we wouldn't have to modify dashboards at all. The old version would just work.", "author": "kamilwu", "createdAt": "2020-08-10T15:22:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzkwNzMwMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Nzk4NTQ2OA==", "url": "https://github.com/apache/beam/pull/12499#discussion_r467985468", "bodyText": "If not, then I'm fine with adding new charts (I suppose you'd meant \"chart\", \"dashboard\" is a different kind of thing) and removing the selector for batch/streaming.", "author": "kamilwu", "createdAt": "2020-08-10T15:29:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzkwNzMwMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Nzk5NzMyMg==", "url": "https://github.com/apache/beam/pull/12499#discussion_r467997322", "bodyText": "@mxm Do you think it is possible to adjust those parameters so that pardo-5 can become pardo-1 and pardo-6 can become pardo-2, pardo-3 or pardo-4? The main advantage of this solution is that we wouldn't have to modify dashboards at all. The old version would just work.\n\nThat was the original idea in this PR which you I understood you didn't like. pardo_5 became pardo_1. As for pardo_6, that's not possible because it measures the checkpoint duration and should be a separate panel.\n\nIf not, then I'm fine with adding new charts (I suppose you'd meant \"chart\", \"dashboard\" is a different kind of thing) and removing the selector for batch/streaming.\n\nYes, I meant panel, corrected above.", "author": "mxm", "createdAt": "2020-08-10T15:39:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzkwNzMwMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODAxMTA5Mg==", "url": "https://github.com/apache/beam/pull/12499#discussion_r468011092", "bodyText": "As for pardo_6, that's not possible because it measures the checkpoint duration and should be a separate panel.\n\nI see. Then, let's do the opposite way (adding new charts and removing the selector). Thank you.", "author": "kamilwu", "createdAt": "2020-08-10T15:58:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzkwNzMwMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTIxMjg2OA==", "url": "https://github.com/apache/beam/pull/12499#discussion_r469212868", "bodyText": "I went the other route you suggested and adjusted the parameters for the load tests. Adding more panels seemed like a good idea but it also adds significant noise to the dashboard.", "author": "mxm", "createdAt": "2020-08-12T12:15:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzkwNzMwMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTIxMzI5MA==", "url": "https://github.com/apache/beam/pull/12499#discussion_r469213290", "bodyText": "As for the latency / checkpoint duration. I think they are good panels to have which are applicable to many runners. I'd like to keep them where they are so we can follow the performance regression guidelines in the release guide.", "author": "mxm", "createdAt": "2020-08-12T12:16:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzkwNzMwMQ=="}], "type": "inlineReview"}, {"oid": "026a972a67188f544b95368547ac01ba8c083326", "url": "https://github.com/apache/beam/commit/026a972a67188f544b95368547ac01ba8c083326", "message": "[BEAM-10602] Add latency/checkpoint duration as separate panels in ParDo Load Test\n\nThe Flink streaming tests were reported in a separate table and made avaible\nthrough this dashboard: https://apache-beam-testing.appspot.com/explore?dashboard=5751884853805056\n\nTurns out, this is not optimal for the new Grafana-based dashboard. We have to\nchange the table name because the query capability of InfluxDb is very limited.\n\nThis way the results will be shown together with the other Runners' load test results.", "committedDate": "2020-08-12T12:13:36Z", "type": "commit"}, {"oid": "026a972a67188f544b95368547ac01ba8c083326", "url": "https://github.com/apache/beam/commit/026a972a67188f544b95368547ac01ba8c083326", "message": "[BEAM-10602] Add latency/checkpoint duration as separate panels in ParDo Load Test\n\nThe Flink streaming tests were reported in a separate table and made avaible\nthrough this dashboard: https://apache-beam-testing.appspot.com/explore?dashboard=5751884853805056\n\nTurns out, this is not optimal for the new Grafana-based dashboard. We have to\nchange the table name because the query capability of InfluxDb is very limited.\n\nThis way the results will be shown together with the other Runners' load test results.", "committedDate": "2020-08-12T12:13:36Z", "type": "forcePushed"}]}