{"pr_number": 13298, "pr_title": "[BEAM-11033] Identify Dataflow metrics for portable job path based on step name.", "pr_createdAt": "2020-11-11T03:07:21Z", "pr_url": "https://github.com/apache/beam/pull/13298", "timeline": [{"oid": "5930823cff706e34a19b543dd755123abb51c207", "url": "https://github.com/apache/beam/commit/5930823cff706e34a19b543dd755123abb51c207", "message": "Identify Dataflow metrics for portable job path based on step name.", "committedDate": "2020-11-11T02:58:09Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTEwODExNw==", "url": "https://github.com/apache/beam/pull/13298#discussion_r521108117", "bodyText": "Is this also valid for non-portable job submission paths? (just to make sure we don't break backwards-compatibility when users specify runner_v2, but not portable job submission).", "author": "ananvay", "createdAt": "2020-11-11T04:40:48Z", "path": "sdks/python/apache_beam/runners/dataflow/dataflow_metrics.py", "diffHunk": "@@ -101,18 +101,13 @@ def _translate_step_name(self, internal_name):\n           'Could not translate the internal step name %r since job graph is '\n           'not available.' % internal_name)\n     user_step_name = None\n-    # pylint: disable=wrong-import-order, wrong-import-position\n-    from apache_beam.runners.dataflow.internal import apiclient\n-    if apiclient._use_unified_worker_portable_job(self._job_graph.options):\n+    if (self._job_graph and internal_name\n+        in self._job_graph.proto_pipeline.components.transforms.keys()):\n       # Dataflow Runner v2 with portable job submission uses proto transform map\n       # IDs for step names. Also PTransform.unique_name maps to user step names.\n       # Hence we lookup user step names based on the proto.\n-      proto_pipeline = self._job_graph.proto_pipeline\n-      for transform_id in proto_pipeline.components.transforms.keys():\n-        if internal_name == transform_id:\n-          user_step_name = proto_pipeline.components.transforms[\n-              transform_id].unique_name\n-          break\n+      user_step_name = self._job_graph.proto_pipeline.components.transforms[", "originalCommit": "5930823cff706e34a19b543dd755123abb51c207", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTEyODM1Mw==", "url": "https://github.com/apache/beam/pull/13298#discussion_r521128353", "bodyText": "Yeah, we'll only enter this block if service chooses to use portable submission and use transform IDs as step names.", "author": "chamikaramj", "createdAt": "2020-11-11T05:53:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTEwODExNw=="}], "type": "inlineReview"}, {"oid": "d41791209cde9d306e05bab31fb09e957e12986b", "url": "https://github.com/apache/beam/commit/d41791209cde9d306e05bab31fb09e957e12986b", "message": "Fixes yapf", "committedDate": "2020-11-11T05:52:24Z", "type": "commit"}]}