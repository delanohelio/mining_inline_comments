{"pr_number": 10994, "pr_title": "[BEAM-8335] TeststreamService integration with DirectRunner", "pr_createdAt": "2020-02-27T21:19:42Z", "pr_url": "https://github.com/apache/beam/pull/10994", "timeline": [{"oid": "86d73967a6238b14304f8299bc3786910eb27b11", "url": "https://github.com/apache/beam/commit/86d73967a6238b14304f8299bc3786910eb27b11", "message": "BEAM[8335] TestStreamService integration with DirectRunner\n\nChange-Id: If797691dffdbbde225f49019f20f9ac05de7c154", "committedDate": "2020-02-28T19:35:12Z", "type": "forcePushed"}, {"oid": "0b9904106811518d369c3f58879a33671b518539", "url": "https://github.com/apache/beam/commit/0b9904106811518d369c3f58879a33671b518539", "message": "BEAM[8335] TestStreamService integration with DirectRunner\n\nChange-Id: If797691dffdbbde225f49019f20f9ac05de7c154", "committedDate": "2020-03-03T19:18:42Z", "type": "forcePushed"}, {"oid": "171d28284c18470adba62fe47742eba4f994d500", "url": "https://github.com/apache/beam/commit/171d28284c18470adba62fe47742eba4f994d500", "message": "BEAM[8335] TestStreamService integration with DirectRunner\n\nChange-Id: I83c7c9221e118d49a9005707650803c28630fe2a", "committedDate": "2020-03-04T19:10:59Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk3MzkxMg==", "url": "https://github.com/apache/beam/pull/10994#discussion_r387973912", "bodyText": "This should be events += instead of events =", "author": "rohdesamuel", "createdAt": "2020-03-04T22:30:35Z", "path": "sdks/python/apache_beam/runners/direct/transform_evaluator.py", "diffHunk": "@@ -527,9 +548,21 @@ def process_element(self, element):\n       for event in self.test_stream._set_up(self.test_stream.output_tags):\n         events.append(event)\n \n-    events += [e for e in self.test_stream.events(self.current_index)]\n+    # Index into the global state of all the different TestStream event streams.\n+    # Retrieve this TestStream's event stream and read from it.\n+    try:\n+      events = [next(self.test_stream_events[self.event_index])]", "originalCommit": "171d28284c18470adba62fe47742eba4f994d500", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk5MjY2Mw==", "url": "https://github.com/apache/beam/pull/10994#discussion_r387992663", "bodyText": "Done", "author": "rohdesamuel", "createdAt": "2020-03-04T23:19:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk3MzkxMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk2NjY1NA==", "url": "https://github.com/apache/beam/pull/10994#discussion_r387966654", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                reader = self._reader.read_multiple([['full', key]\n          \n          \n            \n                reader = self._reader.read_multiple([('full', key)", "author": "pabloem", "createdAt": "2020-03-04T22:13:46Z", "path": "sdks/python/apache_beam/testing/test_stream_service.py", "diffHunk": "@@ -52,5 +56,9 @@ def stop(self):\n   def Events(self, request, context):\n     \"\"\"Streams back all of the events from the streaming cache.\"\"\"\n \n-    for e in self._events:\n+    # TODO(srohde): Once we get rid of the CacheManager, get rid of this 'full'\n+    # label.\n+    reader = self._reader.read_multiple([['full', key]", "originalCommit": "171d28284c18470adba62fe47742eba4f994d500", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk3OTI0NQ==", "url": "https://github.com/apache/beam/pull/10994#discussion_r387979245", "bodyText": "s/key/tag/ ?", "author": "pabloem", "createdAt": "2020-03-04T22:43:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk2NjY1NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk5MjcxNw==", "url": "https://github.com/apache/beam/pull/10994#discussion_r387992717", "bodyText": "Done", "author": "rohdesamuel", "createdAt": "2020-03-04T23:19:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk2NjY1NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk2NzgyMQ==", "url": "https://github.com/apache/beam/pull/10994#discussion_r387967821", "bodyText": "please document inputs", "author": "pabloem", "createdAt": "2020-03-04T22:16:24Z", "path": "sdks/python/apache_beam/testing/test_stream.py", "diffHunk": "@@ -236,14 +235,19 @@ class TestStream(PTransform):\n \n   \"\"\"\n   def __init__(\n-      self, coder=coders.FastPrimitivesCoder(), events=None, output_tags=None):\n+      self,\n+      coder=coders.FastPrimitivesCoder(),\n+      events=None,\n+      output_tags=None,\n+      endpoint=None):", "originalCommit": "171d28284c18470adba62fe47742eba4f994d500", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk5Mjc1NQ==", "url": "https://github.com/apache/beam/pull/10994#discussion_r387992755", "bodyText": "Done", "author": "rohdesamuel", "createdAt": "2020-03-04T23:19:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk2NzgyMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk3NjkzNg==", "url": "https://github.com/apache/beam/pull/10994#discussion_r387976936", "bodyText": "Let's add an assert to make sure that this is only called when we have in-memory events vs rpc events (also in the method below).", "author": "pabloem", "createdAt": "2020-03-04T22:37:57Z", "path": "sdks/python/apache_beam/runners/direct/test_stream_impl.py", "diffHunk": "@@ -226,17 +237,53 @@ def expand(self, pcoll):\n   def _infer_output_coder(self, input_type=None, input_coder=None):\n     return self.coder\n \n-  def _events_from_script(self, index):\n-    yield self._events[index]\n-\n-  def events(self, index):\n-    return self._events_from_script(index)\n-\n-  def begin(self):\n-    return 0\n-\n-  def end(self, index):\n-    return index >= len(self._events)\n+  @staticmethod\n+  def events_from_script(events):\n+    \"\"\"Yields the in-memory events.\n+    \"\"\"\n+    return itertools.chain(events)", "originalCommit": "171d28284c18470adba62fe47742eba4f994d500", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk5MzA4NA==", "url": "https://github.com/apache/beam/pull/10994#discussion_r387993084", "bodyText": "I added an assert in the TestStream constructor so that this shouldn't happen at pipeline run-time but construction time.", "author": "rohdesamuel", "createdAt": "2020-03-04T23:20:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk3NjkzNg=="}], "type": "inlineReview"}, {"oid": "7e1c49cc815a438175b9bab2bd50a6d5ca87c9dc", "url": "https://github.com/apache/beam/commit/7e1c49cc815a438175b9bab2bd50a6d5ca87c9dc", "message": "BEAM[8335] TestStreamService integration with DirectRunner\n\nChange-Id: I83c7c9221e118d49a9005707650803c28630fe2a", "committedDate": "2020-03-04T23:18:48Z", "type": "forcePushed"}, {"oid": "0faa09c4582e868fe6e9f14279a3e17677111dd5", "url": "https://github.com/apache/beam/commit/0faa09c4582e868fe6e9f14279a3e17677111dd5", "message": "BEAM[8335] TestStreamService integration with DirectRunner\n\nChange-Id: I83c7c9221e118d49a9005707650803c28630fe2a", "committedDate": "2020-03-05T17:48:39Z", "type": "forcePushed"}, {"oid": "85eb3cf33125bbb091d30745187d711be84941e3", "url": "https://github.com/apache/beam/commit/85eb3cf33125bbb091d30745187d711be84941e3", "message": "BEAM[8335] TestStreamService integration with DirectRunner\n\nChange-Id: I83c7c9221e118d49a9005707650803c28630fe2a", "committedDate": "2020-03-05T20:17:10Z", "type": "forcePushed"}, {"oid": "db24481c47f8549fb8b4dff1cd84a1834b6d19eb", "url": "https://github.com/apache/beam/commit/db24481c47f8549fb8b4dff1cd84a1834b6d19eb", "message": "BEAM[8335] TestStreamService integration with DirectRunner\n\nChange-Id: I83c7c9221e118d49a9005707650803c28630fe2a", "committedDate": "2020-03-07T00:13:58Z", "type": "forcePushed"}, {"oid": "34bdf4f07a54705e47817c4a6c94d4a1ef291b98", "url": "https://github.com/apache/beam/commit/34bdf4f07a54705e47817c4a6c94d4a1ef291b98", "message": "BEAM[8335] TestStreamService integration with DirectRunner\n\nChange-Id: I83c7c9221e118d49a9005707650803c28630fe2a", "committedDate": "2020-03-07T00:33:54Z", "type": "forcePushed"}, {"oid": "b7e5f454a74e89c033465ba12c3b0f26bca786fd", "url": "https://github.com/apache/beam/commit/b7e5f454a74e89c033465ba12c3b0f26bca786fd", "message": "BEAM[8335] TestStreamService integration with DirectRunner\n\nChange-Id: I83c7c9221e118d49a9005707650803c28630fe2a", "committedDate": "2020-03-09T20:57:40Z", "type": "commit"}, {"oid": "b7e5f454a74e89c033465ba12c3b0f26bca786fd", "url": "https://github.com/apache/beam/commit/b7e5f454a74e89c033465ba12c3b0f26bca786fd", "message": "BEAM[8335] TestStreamService integration with DirectRunner\n\nChange-Id: I83c7c9221e118d49a9005707650803c28630fe2a", "committedDate": "2020-03-09T20:57:40Z", "type": "forcePushed"}]}