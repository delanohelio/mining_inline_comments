{"pr_number": 11514, "pr_title": "[BEAM-9488] Ensure we pass through PCollection ids instead of attempting to fix them up.", "pr_createdAt": "2020-04-23T23:26:51Z", "pr_url": "https://github.com/apache/beam/pull/11514", "timeline": [{"oid": "96cc611da4e17213e6458b11112e9c7343ba2509", "url": "https://github.com/apache/beam/commit/96cc611da4e17213e6458b11112e9c7343ba2509", "message": "[BEAM-9488] Ensure we pass through PCollection ids instead of attempting to fix them up.", "committedDate": "2020-04-23T23:28:58Z", "type": "commit"}, {"oid": "96cc611da4e17213e6458b11112e9c7343ba2509", "url": "https://github.com/apache/beam/commit/96cc611da4e17213e6458b11112e9c7343ba2509", "message": "[BEAM-9488] Ensure we pass through PCollection ids instead of attempting to fix them up.", "committedDate": "2020-04-23T23:28:58Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDE5MzQ4NA==", "url": "https://github.com/apache/beam/pull/11514#discussion_r414193484", "bodyText": "I believe the id order aligns with the receiver order since transform_consumers built above iterates the outputs map in the same order and this gets plumbed down through to Operation.", "author": "lukecwik", "createdAt": "2020-04-23T23:36:50Z", "path": "sdks/python/apache_beam/runners/worker/bundle_processor.py", "diffHunk": "@@ -1035,59 +1035,12 @@ def monitoring_infos(self):\n     # Construct a new dict first to remove duplicates.\n     all_monitoring_infos_dict = {}\n     for transform_id, op in self.ops.items():\n-      for mi in op.monitoring_infos(transform_id).values():\n-        fixed_mi = self._fix_output_tags_monitoring_info(transform_id, mi)\n-        all_monitoring_infos_dict[monitoring_infos.to_key(fixed_mi)] = fixed_mi\n-\n-    infos_list = list(all_monitoring_infos_dict.values())\n-\n-    def inject_pcollection(monitoring_info):\n-      \"\"\"\n-      If provided metric is element count metric:\n-      Finds relevant transform output info in current process_bundle_descriptor\n-      and adds tag with PCOLLECTION_LABEL and pcollection_id into monitoring\n-      info.\n-      \"\"\"\n-      if monitoring_info.urn in URNS_NEEDING_PCOLLECTIONS:\n-        if not monitoring_infos.PTRANSFORM_LABEL in monitoring_info.labels:\n-          return\n-        ptransform_label = monitoring_info.labels[\n-            monitoring_infos.PTRANSFORM_LABEL]\n-        if not monitoring_infos.TAG_LABEL in monitoring_info.labels:\n-          return\n-        tag_label = monitoring_info.labels[monitoring_infos.TAG_LABEL]\n-\n-        if not ptransform_label in self.process_bundle_descriptor.transforms:\n-          return\n-        if not tag_label in self.process_bundle_descriptor.transforms[\n-            ptransform_label].outputs:\n-          return\n-\n-        pcollection_name = (\n-            self.process_bundle_descriptor.transforms[ptransform_label].\n-            outputs[tag_label])\n-\n-        monitoring_info.labels[\n-            monitoring_infos.PCOLLECTION_LABEL] = pcollection_name\n-\n-        # Cleaning up labels that are not in specification.\n-        monitoring_info.labels.pop(monitoring_infos.PTRANSFORM_LABEL)\n-        monitoring_info.labels.pop(monitoring_infos.TAG_LABEL)\n-\n-    for mi in infos_list:\n-      inject_pcollection(mi)\n-\n-    return infos_list\n+      pcollection_ids = self.process_bundle_descriptor.transforms[", "originalCommit": "96cc611da4e17213e6458b11112e9c7343ba2509", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDIwNjU1Mw==", "url": "https://github.com/apache/beam/pull/11514#discussion_r414206553", "bodyText": "In practice this might be OK (dicts have undefined, but I think when modified deterministic, iteration order), but seems rather brittle to me. Could we instead passed the tag -> pcollection_id mapping here?", "author": "robertwb", "createdAt": "2020-04-24T00:12:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDE5MzQ4NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDIwNDM3NQ==", "url": "https://github.com/apache/beam/pull/11514#discussion_r414204375", "bodyText": "This will change if you use a mapping, but zip would be the idiom to use here.", "author": "robertwb", "createdAt": "2020-04-24T00:06:37Z", "path": "sdks/python/apache_beam/runners/worker/operations.py", "diffHunk": "@@ -337,43 +337,48 @@ def add_receiver(self, operation, output_index=0):\n     \"\"\"Adds a receiver operation for the specified output.\"\"\"\n     self.consumers[output_index].append(operation)\n \n-  def monitoring_infos(self, transform_id):\n-    # type: (str) -> Dict[FrozenSet, metrics_pb2.MonitoringInfo]\n+  def monitoring_infos(self, transform_id, pcollection_ids):\n+    # type: (str, list(str)) -> Dict[FrozenSet, metrics_pb2.MonitoringInfo]\n \n     \"\"\"Returns the list of MonitoringInfos collected by this operation.\"\"\"\n     all_monitoring_infos = self.execution_time_monitoring_infos(transform_id)\n     all_monitoring_infos.update(\n-        self.pcollection_count_monitoring_infos(transform_id))\n+        self.pcollection_count_monitoring_infos(pcollection_ids))\n     all_monitoring_infos.update(self.user_monitoring_infos(transform_id))\n     return all_monitoring_infos\n \n-  def pcollection_count_monitoring_infos(self, transform_id):\n+  def pcollection_count_monitoring_infos(self, pcollection_ids):\n     \"\"\"Returns the element count MonitoringInfo collected by this operation.\"\"\"\n-    if len(self.receivers) == 1:\n-      # If there is exactly one output, we can unambiguously\n-      # fix its name later, which we do.\n-      # TODO(robertwb): Plumb the actual name here.\n+    if len(self.receivers) != len(pcollection_ids):\n+      raise RuntimeError(\n+          'Unexpected number of receivers for number of pcollections %s %s' %\n+          (self.receivers, pcollection_ids))\n+\n+    all_monitoring_infos = {}\n+    for i in range(len(self.receivers)):", "originalCommit": "96cc611da4e17213e6458b11112e9c7343ba2509", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDg1NjA5NA==", "url": "https://github.com/apache/beam/pull/11514#discussion_r414856094", "bodyText": "+1 using zip", "author": "HuangLED", "createdAt": "2020-04-24T20:52:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDIwNDM3NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDIwODY0Mg==", "url": "https://github.com/apache/beam/pull/11514#discussion_r414208642", "bodyText": "This would be a bug, right?", "author": "robertwb", "createdAt": "2020-04-24T00:18:38Z", "path": "sdks/python/apache_beam/runners/worker/bundle_processor.py", "diffHunk": "@@ -1035,59 +1035,12 @@ def monitoring_infos(self):\n     # Construct a new dict first to remove duplicates.\n     all_monitoring_infos_dict = {}\n     for transform_id, op in self.ops.items():\n-      for mi in op.monitoring_infos(transform_id).values():\n-        fixed_mi = self._fix_output_tags_monitoring_info(transform_id, mi)\n-        all_monitoring_infos_dict[monitoring_infos.to_key(fixed_mi)] = fixed_mi\n-\n-    infos_list = list(all_monitoring_infos_dict.values())\n-\n-    def inject_pcollection(monitoring_info):\n-      \"\"\"\n-      If provided metric is element count metric:\n-      Finds relevant transform output info in current process_bundle_descriptor\n-      and adds tag with PCOLLECTION_LABEL and pcollection_id into monitoring\n-      info.\n-      \"\"\"\n-      if monitoring_info.urn in URNS_NEEDING_PCOLLECTIONS:\n-        if not monitoring_infos.PTRANSFORM_LABEL in monitoring_info.labels:\n-          return\n-        ptransform_label = monitoring_info.labels[\n-            monitoring_infos.PTRANSFORM_LABEL]\n-        if not monitoring_infos.TAG_LABEL in monitoring_info.labels:\n-          return\n-        tag_label = monitoring_info.labels[monitoring_infos.TAG_LABEL]\n-\n-        if not ptransform_label in self.process_bundle_descriptor.transforms:\n-          return", "originalCommit": "96cc611da4e17213e6458b11112e9c7343ba2509", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDI2NTE4Ng==", "url": "https://github.com/apache/beam/pull/11514#discussion_r414265186", "bodyText": "yeah", "author": "lukecwik", "createdAt": "2020-04-24T03:28:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDIwODY0Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDIwODk2MA==", "url": "https://github.com/apache/beam/pull/11514#discussion_r414208960", "bodyText": "Likewise this.", "author": "robertwb", "createdAt": "2020-04-24T00:19:33Z", "path": "sdks/python/apache_beam/runners/worker/bundle_processor.py", "diffHunk": "@@ -1035,59 +1035,12 @@ def monitoring_infos(self):\n     # Construct a new dict first to remove duplicates.\n     all_monitoring_infos_dict = {}\n     for transform_id, op in self.ops.items():\n-      for mi in op.monitoring_infos(transform_id).values():\n-        fixed_mi = self._fix_output_tags_monitoring_info(transform_id, mi)\n-        all_monitoring_infos_dict[monitoring_infos.to_key(fixed_mi)] = fixed_mi\n-\n-    infos_list = list(all_monitoring_infos_dict.values())\n-\n-    def inject_pcollection(monitoring_info):\n-      \"\"\"\n-      If provided metric is element count metric:\n-      Finds relevant transform output info in current process_bundle_descriptor\n-      and adds tag with PCOLLECTION_LABEL and pcollection_id into monitoring\n-      info.\n-      \"\"\"\n-      if monitoring_info.urn in URNS_NEEDING_PCOLLECTIONS:\n-        if not monitoring_infos.PTRANSFORM_LABEL in monitoring_info.labels:\n-          return\n-        ptransform_label = monitoring_info.labels[\n-            monitoring_infos.PTRANSFORM_LABEL]\n-        if not monitoring_infos.TAG_LABEL in monitoring_info.labels:\n-          return\n-        tag_label = monitoring_info.labels[monitoring_infos.TAG_LABEL]\n-\n-        if not ptransform_label in self.process_bundle_descriptor.transforms:\n-          return\n-        if not tag_label in self.process_bundle_descriptor.transforms[\n-            ptransform_label].outputs:", "originalCommit": "96cc611da4e17213e6458b11112e9c7343ba2509", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDIwOTUzOQ==", "url": "https://github.com/apache/beam/pull/11514#discussion_r414209539", "bodyText": "Actually, this can happen, and might be what's happening here. There is no PCollection for this tag, but the user outputted a value to this tag. It would make sense to record this output even if we didn't use it. This is another downside of attaching these counters to PCollections themselves rather than to PTransform outputs.", "author": "robertwb", "createdAt": "2020-04-24T00:21:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDIwODk2MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDI2NTEyMQ==", "url": "https://github.com/apache/beam/pull/11514#discussion_r414265121", "bodyText": "unknown outputs should probably be reported another way", "author": "lukecwik", "createdAt": "2020-04-24T03:28:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDIwODk2MA=="}], "type": "inlineReview"}, {"oid": "808b4b9984c294da65852c104ee8a5cb23c0a691", "url": "https://github.com/apache/beam/commit/808b4b9984c294da65852c104ee8a5cb23c0a691", "message": "fixup! Convert to list since values() isn't subscriptable", "committedDate": "2020-04-24T03:31:01Z", "type": "commit"}, {"oid": "04c6334dd00b881b223dd5c0196c7c3bcd530233", "url": "https://github.com/apache/beam/commit/04c6334dd00b881b223dd5c0196c7c3bcd530233", "message": "fixup! Use zip", "committedDate": "2020-04-24T21:01:36Z", "type": "commit"}, {"oid": "051c094e307d049210d7db025758f3c7efbc9ae7", "url": "https://github.com/apache/beam/commit/051c094e307d049210d7db025758f3c7efbc9ae7", "message": "fixup! Migrate to use tag -> pcollection id", "committedDate": "2020-04-24T21:43:35Z", "type": "commit"}, {"oid": "4c03658498142beebeb950bb9464ecad2cea11a5", "url": "https://github.com/apache/beam/commit/4c03658498142beebeb950bb9464ecad2cea11a5", "message": "fixup! lint", "committedDate": "2020-04-24T22:47:25Z", "type": "commit"}, {"oid": "1297a0b76162771c409f040af6ea48f680be3586", "url": "https://github.com/apache/beam/commit/1297a0b76162771c409f040af6ea48f680be3586", "message": "fixup! Fix comparison", "committedDate": "2020-04-24T23:24:06Z", "type": "commit"}]}