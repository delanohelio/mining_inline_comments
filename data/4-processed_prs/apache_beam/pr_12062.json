{"pr_number": 12062, "pr_title": "[BEAM-10305] Let InMemoryBagUserStateFactory only use a single cache token", "pr_createdAt": "2020-06-23T08:40:43Z", "pr_url": "https://github.com/apache/beam/pull/12062", "timeline": [{"oid": "18e5df392987e073ff9a2158f3791d6e0e718ee3", "url": "https://github.com/apache/beam/commit/18e5df392987e073ff9a2158f3791d6e0e718ee3", "message": "[BEAM-10305] Let InMemoryBagUserStateFactory only use a single cache token\n\nWhen the state cache is enabled in the Python SDK, the batch mode of the Flink\nRunner currently only allows a single user state cell because a new cache token\nis generated for each state cell; the caching code in the Python SDK Harness\nonly supports one cache token per user state handler.\n\nTheoretically multiple cache tokens would work but would just be adding to the\npayload. We should make sure to just send a single cache token in batch\nmode (which is already the case in streaming)", "committedDate": "2020-06-23T09:09:38Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDMyNTcwMg==", "url": "https://github.com/apache/beam/pull/12062#discussion_r444325702", "bodyText": "You should update the comment related to error handling to make sure that users discard the factory every time they want a new cache token.", "author": "lukecwik", "createdAt": "2020-06-23T15:46:43Z", "path": "runners/java-fn-execution/src/main/java/org/apache/beam/runners/fnexecution/state/InMemoryBagUserStateFactory.java", "diffHunk": "@@ -41,9 +41,12 @@\n public class InMemoryBagUserStateFactory<K, V, W extends BoundedWindow>", "originalCommit": "18e5df392987e073ff9a2158f3791d6e0e718ee3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDc3NDkwOA==", "url": "https://github.com/apache/beam/pull/12062#discussion_r444774908", "bodyText": "Sure, good idea to clarify that.", "author": "mxm", "createdAt": "2020-06-24T09:45:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDMyNTcwMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTA3NDY3OQ==", "url": "https://github.com/apache/beam/pull/12062#discussion_r445074679", "bodyText": "I think we'll want to move the cache token generation up higher to the ByteStringStateRequestHandlerToBagUserStateHandlerFactoryAdapter or the factory has to own the cache token or we add a method which is a supplier to the StateRequestHandlers#forBagUserState. The comment added for this class should be moved appropriately.", "author": "lukecwik", "createdAt": "2020-06-24T18:01:32Z", "path": "runners/java-fn-execution/src/main/java/org/apache/beam/runners/fnexecution/state/InMemoryBagUserStateFactory.java", "diffHunk": "@@ -37,13 +37,19 @@\n /**\n  * Holds user state in memory. Only one key is active at a time due to the GroupReduceFunction being\n  * called once per key. Needs to be reset via {@code resetForNewKey()} before processing a new key.\n+ *\n+ * <p>In case of any failures, this factory must be discarded. Otherwise, the contained state cache\n+ * token would be reused which would corrupt the state cache.\n  */\n public class InMemoryBagUserStateFactory<K, V, W extends BoundedWindow>\n     implements StateRequestHandlers.BagUserStateHandlerFactory<K, V, W> {\n \n+  private final ByteString cacheToken;\n+\n   private List<InMemorySingleKeyBagState> handlers;\n \n   public InMemoryBagUserStateFactory() {\n+    cacheToken = ByteString.copyFrom(UUID.randomUUID().toString().getBytes(Charsets.UTF_8));", "originalCommit": "9847976462b8540d398a8296a6b6e8a347e3d8fa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTA4MDUzMQ==", "url": "https://github.com/apache/beam/pull/12062#discussion_r445080531", "bodyText": "Could you add a reason for moving this up the stack? State handlers should implement their own cache token handling.", "author": "mxm", "createdAt": "2020-06-24T18:12:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTA3NDY3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTA4MzI2NA==", "url": "https://github.com/apache/beam/pull/12062#discussion_r445083264", "bodyText": "I'll have another look later.", "author": "mxm", "createdAt": "2020-06-24T18:17:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTA3NDY3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTA4MzMzMw==", "url": "https://github.com/apache/beam/pull/12062#discussion_r445083333", "bodyText": "ByteStringStateRequestHandlerToBagUserStateHandlerFactoryAdapter#getCacheTokens is going to add N copies of the cache token to the ProcessBundleRequest\nFor user state, it makes sense to have a caching handler that does the delegation to other handlers. This caching handler is the one that should be responsible for supplying the single cache token.", "author": "lukecwik", "createdAt": "2020-06-24T18:17:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTA3NDY3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTEzMTkwNA==", "url": "https://github.com/apache/beam/pull/12062#discussion_r445131904", "bodyText": "I see, makes sense. Let me update the PR.", "author": "mxm", "createdAt": "2020-06-24T19:48:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTA3NDY3OQ=="}], "type": "inlineReview"}, {"oid": "be7b5f2221e003adc99ab911b2413e9b75764141", "url": "https://github.com/apache/beam/commit/be7b5f2221e003adc99ab911b2413e9b75764141", "message": "[BEAM-10305] Let InMemoryBagUserStateFactory only use a single cache token\n\nWhen the state cache is enabled in the Python SDK, the batch mode of the Flink\nRunner currently only allows a single user state cell because a new cache token\nis generated for each state cell; the caching code in the Python SDK Harness\nonly supports one cache token per user state handler.\n\nTheoretically multiple cache tokens would work but would just be adding to the\npayload. We should make sure to just send a single cache token in batch\nmode (which is already the case in streaming)", "committedDate": "2020-06-24T20:12:10Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTE0NzY1Mg==", "url": "https://github.com/apache/beam/pull/12062#discussion_r445147652", "bodyText": "Looks like this should be using the StateRequestHandler instead, will update.", "author": "mxm", "createdAt": "2020-06-24T20:19:09Z", "path": "runners/java-fn-execution/src/test/java/org/apache/beam/runners/fnexecution/state/StateRequestHandlersTest.java", "diffHunk": "@@ -59,4 +68,46 @@ public void testDelegatingStateHandlerThrowsWhenNotFound() throws Exception {\n     StateRequestHandlers.delegateBasedUponType(new EnumMap<>(StateKey.TypeCase.class))\n         .handle(StateRequest.getDefaultInstance());\n   }\n+\n+  @Test\n+  public void testUserStateCacheTokenGeneration() {\n+    ProcessBundleDescriptors.ExecutableProcessBundleDescriptor processBundleDescriptor =\n+        Mockito.mock(ProcessBundleDescriptors.ExecutableProcessBundleDescriptor.class);\n+    InMemoryBagUserStateFactory inMemoryBagUserStateFactory = new InMemoryBagUserStateFactory<>();\n+    StateRequestHandler stateRequestHandler =\n+        StateRequestHandlers.forBagUserStateHandlerFactory(\n+            processBundleDescriptor, inMemoryBagUserStateFactory);\n+\n+    Iterable<BeamFnApi.ProcessBundleRequest.CacheToken> cacheTokens =\n+        stateRequestHandler.getCacheTokens();\n+    assertThat(Iterables.size(cacheTokens), is(1));\n+\n+    BeamFnApi.ProcessBundleRequest.CacheToken cacheToken = Iterables.getOnlyElement(cacheTokens);\n+    assertThat(\n+        cacheToken.getUserState(),\n+        is(BeamFnApi.ProcessBundleRequest.CacheToken.UserState.getDefaultInstance()));\n+    assertThat(cacheToken.getToken(), is(notNullValue()));\n+\n+    inMemoryBagUserStateFactory.forUserState(", "originalCommit": "be7b5f2221e003adc99ab911b2413e9b75764141", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "8ae80434c3a7eb70c1112d0377a2df34e5627438", "url": "https://github.com/apache/beam/commit/8ae80434c3a7eb70c1112d0377a2df34e5627438", "message": "[BEAM-10305] Let StateRequestHandler for user state only use a single cache token\n\nWhen the state cache is enabled in the Python SDK, the batch mode of the Flink\nRunner currently only allows a single user state cell because a new cache token\nis generated for each state cell; the caching code in the Python SDK Harness\nonly supports one cache token per user state handler.\n\nTheoretically multiple cache tokens would work but would just be adding to the\npayload. We should make sure to just send a single cache token in batch\nmode (which is already the case in streaming)", "committedDate": "2020-06-25T08:47:25Z", "type": "forcePushed"}, {"oid": "6817c19636d0ff82947f3526bb68c78a1af6f862", "url": "https://github.com/apache/beam/commit/6817c19636d0ff82947f3526bb68c78a1af6f862", "message": "[BEAM-10305] Let StateRequestHandler for user state only use a single cache token\n\nWhen the state cache is enabled in the Python SDK, the batch mode of the Flink\nRunner currently only allows a single user state cell because a new cache token\nis generated for each state cell; the caching code in the Python SDK Harness\nonly supports one cache token per user state handler.\n\nTheoretically multiple cache tokens would work but would just be adding to the\npayload. We should make sure to just send a single cache token in batch\nmode (which is already the case in streaming)", "committedDate": "2020-06-25T09:19:53Z", "type": "forcePushed"}, {"oid": "5d65ed6d44b41165126ba7533057200ed8abbebb", "url": "https://github.com/apache/beam/commit/5d65ed6d44b41165126ba7533057200ed8abbebb", "message": "[BEAM-10305] Let StateRequestHandler for user state only use a single cache token\n\nWhen the state cache is enabled in the Python SDK, the batch mode of the Flink\nRunner currently only allows a single user state cell because a new cache token\nis generated for each state cell; the caching code in the Python SDK Harness\nonly supports one cache token per user state handler.\n\nTheoretically multiple cache tokens would work but would just be adding to the\npayload. We should make sure to just send a single cache token in batch\nmode (which is already the case in streaming)", "committedDate": "2020-06-25T09:24:11Z", "type": "commit"}, {"oid": "5d65ed6d44b41165126ba7533057200ed8abbebb", "url": "https://github.com/apache/beam/commit/5d65ed6d44b41165126ba7533057200ed8abbebb", "message": "[BEAM-10305] Let StateRequestHandler for user state only use a single cache token\n\nWhen the state cache is enabled in the Python SDK, the batch mode of the Flink\nRunner currently only allows a single user state cell because a new cache token\nis generated for each state cell; the caching code in the Python SDK Harness\nonly supports one cache token per user state handler.\n\nTheoretically multiple cache tokens would work but would just be adding to the\npayload. We should make sure to just send a single cache token in batch\nmode (which is already the case in streaming)", "committedDate": "2020-06-25T09:24:11Z", "type": "forcePushed"}]}