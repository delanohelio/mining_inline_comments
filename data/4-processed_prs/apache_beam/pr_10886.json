{"pr_number": 10886, "pr_title": "[BEAM-8019] Updates DataflowRunner to support multiple SDK environments.", "pr_createdAt": "2020-02-18T17:42:54Z", "pr_url": "https://github.com/apache/beam/pull/10886", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDg4MjAwMg==", "url": "https://github.com/apache/beam/pull/10886#discussion_r380882002", "bodyText": "How about making dict() default value in function definition, instead of _sdk_image_overrides?", "author": "aaltay", "createdAt": "2020-02-18T19:20:15Z", "path": "sdks/python/apache_beam/runners/dataflow/internal/apiclient.py", "diffHunk": "@@ -153,6 +158,9 @@ def __init__(self, packages, options, environment_version, pipeline_url):\n     # User agent information.\n     self.proto.userAgent = dataflow.Environment.UserAgentValue()\n     self.local = 'localhost' in self.google_cloud_options.dataflow_endpoint\n+    self._proto_pipeline = proto_pipeline\n+    self._sdk_image_overrides = (", "originalCommit": "97b8b32fc9092f4f1cd2d63a0ddfb8ab6c6c322c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDk4MDA2NA==", "url": "https://github.com/apache/beam/pull/10886#discussion_r380980064", "bodyText": "Seems like that results in a lint error (Dangerous default value dict() (builtins.dict) as argument).", "author": "chamikaramj", "createdAt": "2020-02-18T22:43:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDg4MjAwMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDk5Mjk0NA==", "url": "https://github.com/apache/beam/pull/10886#discussion_r380992944", "bodyText": "OK. We can leave it as is.", "author": "aaltay", "createdAt": "2020-02-18T23:17:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDg4MjAwMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTAwMzkzOA==", "url": "https://github.com/apache/beam/pull/10886#discussion_r381003938", "bodyText": "One can also write _sdk_image_overrides or dict().", "author": "robertwb", "createdAt": "2020-02-18T23:51:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDg4MjAwMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTYwODUyMQ==", "url": "https://github.com/apache/beam/pull/10886#discussion_r381608521", "bodyText": "Done.", "author": "chamikaramj", "createdAt": "2020-02-19T23:32:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDg4MjAwMg=="}], "type": "inlineReview"}, {"oid": "b816038681673adc0275b29e44dda6478a34683e", "url": "https://github.com/apache/beam/commit/b816038681673adc0275b29e44dda6478a34683e", "message": "Updates DataflowRunner to support multiple SDK environments.\n\nUpdates DataflowRunner to set sdk_harness_container_images property.\nAdds a pipeline option so that users can override SDK harness container images.\nAlso did an update to create a secure local gRPC channel for expansion service instead of an insecure one.", "committedDate": "2020-02-18T22:42:47Z", "type": "forcePushed"}, {"oid": "1a7e45e1d12c6016a2968ccf99e39dd4d17c18bb", "url": "https://github.com/apache/beam/commit/1a7e45e1d12c6016a2968ccf99e39dd4d17c18bb", "message": "Updates DataflowRunner to support multiple SDK environments.\n\nUpdates DataflowRunner to set sdk_harness_container_images property.\nAdds a pipeline option so that users can override SDK harness container images.\nAlso did an update to create a secure local gRPC channel for expansion service instead of an insecure one.", "committedDate": "2020-02-18T23:35:11Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTAwMzYxOA==", "url": "https://github.com/apache/beam/pull/10886#discussion_r381003618", "bodyText": "When, if ever, do we expect the user to provide a reasonable value for this flag?", "author": "robertwb", "createdAt": "2020-02-18T23:50:36Z", "path": "sdks/python/apache_beam/options/pipeline_options.py", "diffHunk": "@@ -748,6 +748,17 @@ def _add_argparse_args(cls, parser):\n             'worker harness. Default is the container for the version of the '\n             'SDK. Note: currently, only approved Google Cloud Dataflow '\n             'container images may be used here.'))\n+    parser.add_argument(\n+        '--sdk_harness_container_image_overrides',", "originalCommit": "1a7e45e1d12c6016a2968ccf99e39dd4d17c18bb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTYwNzkxMA==", "url": "https://github.com/apache/beam/pull/10886#discussion_r381607910", "bodyText": "Currently this has to be provided for cross-language transforms to work (for Dataflow) since the container URL that we get from Beam does not work for Dataflow. I hope to introduce logic to derive Java container URL from Python in a follow up PR.\nAfter this this will be primary for testing or for users to override the container (similar to worker_harness_container_image option today).", "author": "chamikaramj", "createdAt": "2020-02-19T23:31:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTAwMzYxOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTAwNDY3OA==", "url": "https://github.com/apache/beam/pull/10886#discussion_r381004678", "bodyText": "for pattern, override in sdk_overrides.items()", "author": "robertwb", "createdAt": "2020-02-18T23:53:57Z", "path": "sdks/python/apache_beam/runners/dataflow/internal/apiclient.py", "diffHunk": "@@ -576,10 +655,25 @@ def create_job(self, job):\n         'A template was just created at location %s', template_location)\n     return None\n \n+  def _apply_sdk_environment_overrides(self, proto_pipeline):\n+    # Update environments based on user provided overrides\n+    sdk_overrides = self._sdk_image_overrides\n+    if sdk_overrides:\n+      for environment in proto_pipeline.components.environments.values():\n+        docker_payload = proto_utils.parse_Bytes(\n+            environment.payload, beam_runner_api_pb2.DockerPayload)\n+        for pattern in sdk_overrides:", "originalCommit": "1a7e45e1d12c6016a2968ccf99e39dd4d17c18bb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTYxMTI4MA==", "url": "https://github.com/apache/beam/pull/10886#discussion_r381611280", "bodyText": "Done.", "author": "chamikaramj", "createdAt": "2020-02-19T23:41:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTAwNDY3OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTAwNDkzOQ==", "url": "https://github.com/apache/beam/pull/10886#discussion_r381004939", "bodyText": "I would have expected to use re.sub(pattern, override, docker_payload.container_image).", "author": "robertwb", "createdAt": "2020-02-18T23:54:48Z", "path": "sdks/python/apache_beam/runners/dataflow/internal/apiclient.py", "diffHunk": "@@ -576,10 +655,25 @@ def create_job(self, job):\n         'A template was just created at location %s', template_location)\n     return None\n \n+  def _apply_sdk_environment_overrides(self, proto_pipeline):\n+    # Update environments based on user provided overrides\n+    sdk_overrides = self._sdk_image_overrides\n+    if sdk_overrides:\n+      for environment in proto_pipeline.components.environments.values():\n+        docker_payload = proto_utils.parse_Bytes(\n+            environment.payload, beam_runner_api_pb2.DockerPayload)\n+        for pattern in sdk_overrides:\n+          override = sdk_overrides[pattern]\n+          if re.match(pattern, docker_payload.container_image):\n+            new_payload = beam_runner_api_pb2.DockerPayload(\n+                container_image=override)", "originalCommit": "1a7e45e1d12c6016a2968ccf99e39dd4d17c18bb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTYxOTYyMg==", "url": "https://github.com/apache/beam/pull/10886#discussion_r381619622", "bodyText": "Done.", "author": "chamikaramj", "createdAt": "2020-02-20T00:08:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTAwNDkzOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTAwNTIzNA==", "url": "https://github.com/apache/beam/pull/10886#discussion_r381005234", "bodyText": "Would it be safer to copy the proto and update the field, in case other fields get added in the future?", "author": "robertwb", "createdAt": "2020-02-18T23:55:45Z", "path": "sdks/python/apache_beam/runners/dataflow/internal/apiclient.py", "diffHunk": "@@ -576,10 +655,25 @@ def create_job(self, job):\n         'A template was just created at location %s', template_location)\n     return None\n \n+  def _apply_sdk_environment_overrides(self, proto_pipeline):\n+    # Update environments based on user provided overrides\n+    sdk_overrides = self._sdk_image_overrides\n+    if sdk_overrides:\n+      for environment in proto_pipeline.components.environments.values():\n+        docker_payload = proto_utils.parse_Bytes(\n+            environment.payload, beam_runner_api_pb2.DockerPayload)\n+        for pattern in sdk_overrides:\n+          override = sdk_overrides[pattern]\n+          if re.match(pattern, docker_payload.container_image):\n+            new_payload = beam_runner_api_pb2.DockerPayload(", "originalCommit": "1a7e45e1d12c6016a2968ccf99e39dd4d17c18bb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTYxNTY3Mw==", "url": "https://github.com/apache/beam/pull/10886#discussion_r381615673", "bodyText": "Done.", "author": "chamikaramj", "createdAt": "2020-02-19T23:55:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTAwNTIzNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTAwNjE0NQ==", "url": "https://github.com/apache/beam/pull/10886#discussion_r381006145", "bodyText": "This comment seems out of date...", "author": "robertwb", "createdAt": "2020-02-18T23:58:44Z", "path": "sdks/python/apache_beam/runners/dataflow/internal/apiclient.py", "diffHunk": "@@ -133,12 +136,19 @@ def get_output(self, tag=None):\n \n class Environment(object):\n   \"\"\"Wrapper for a dataflow Environment protobuf.\"\"\"", "originalCommit": "1a7e45e1d12c6016a2968ccf99e39dd4d17c18bb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTAwNjk5Mw==", "url": "https://github.com/apache/beam/pull/10886#discussion_r381006993", "bodyText": "Any reason to not just return self._pipeline_proto.environments.values()? Do we expect unused environments to be there for any reason?", "author": "robertwb", "createdAt": "2020-02-19T00:01:40Z", "path": "sdks/python/apache_beam/runners/dataflow/internal/apiclient.py", "diffHunk": "@@ -301,6 +351,22 @@ def __init__(self, packages, options, environment_version, pipeline_url):\n           dataflow.Environment.SdkPipelineOptionsValue.AdditionalProperty(\n               key='display_data', value=to_json_value(items)))\n \n+  def _get_environments_from_tranforms(self):", "originalCommit": "1a7e45e1d12c6016a2968ccf99e39dd4d17c18bb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTYwOTQ0MQ==", "url": "https://github.com/apache/beam/pull/10886#discussion_r381609441", "bodyText": "I thought about this and I think it's safer to collect the exact set of environments that we need to execute the pipeline instead of depending on all the environments available in the proto. There's nothing that prevents an external transform (or anywhere else that we update the proto) from including additional environments that are not needed to execute the pipeline.\nFor example, default environment set by Java SDK does not work without replacing the container image (we happen to use the same environment_id for the replacement but could have been otherwise).", "author": "chamikaramj", "createdAt": "2020-02-19T23:35:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTAwNjk5Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTAwODEwNQ==", "url": "https://github.com/apache/beam/pull/10886#discussion_r381008105", "bodyText": "Nit: I'd move this up into the previous loop. Or I'd write this as a list comprehension, e.g.\nenvironment_ids = set(\n    transform.environment_id\n    for transform in self._proto_pipeline.components.transforms.values()\n    if transform.environment_id)\nreturn [self._proto_pipeline.components.environments[id] for id in environment_ids]", "author": "robertwb", "createdAt": "2020-02-19T00:05:42Z", "path": "sdks/python/apache_beam/runners/dataflow/internal/apiclient.py", "diffHunk": "@@ -301,6 +351,22 @@ def __init__(self, packages, options, environment_version, pipeline_url):\n           dataflow.Environment.SdkPipelineOptionsValue.AdditionalProperty(\n               key='display_data', value=to_json_value(items)))\n \n+  def _get_environments_from_tranforms(self):\n+    if not self._proto_pipeline:\n+      return []\n+    environment_ids = []\n+    for transform in self._proto_pipeline.components.transforms.values():\n+      if transform.environment_id not in environment_ids:\n+        environment_ids.append(transform.environment_id)\n+    environments = []\n+    for environment_id in environment_ids:\n+      if not environment_id:", "originalCommit": "1a7e45e1d12c6016a2968ccf99e39dd4d17c18bb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTYxMDUxMg==", "url": "https://github.com/apache/beam/pull/10886#discussion_r381610512", "bodyText": "Done.", "author": "chamikaramj", "createdAt": "2020-02-19T23:39:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTAwODEwNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTAwODY4MQ==", "url": "https://github.com/apache/beam/pull/10886#discussion_r381008681", "bodyText": "Again, one can write\noverrides_dict = dict(override_str.split(',', 1) for override_str in sdk_overrides)", "author": "robertwb", "createdAt": "2020-02-19T00:07:46Z", "path": "sdks/python/apache_beam/runners/dataflow/internal/apiclient.py", "diffHunk": "@@ -478,6 +544,19 @@ def __init__(self, options):\n         get_credentials=(not self.google_cloud_options.no_auth),\n         http=http_client,\n         response_encoding=get_response_encoding())\n+    self._sdk_image_overrides = self._get_sdk_image_overrides(options)\n+\n+  def _get_sdk_image_overrides(self, pipeline_options):\n+    worker_options = pipeline_options.view_as(WorkerOptions)\n+    sdk_overrides = worker_options.sdk_harness_container_image_overrides\n+    overrides_dict = dict()", "originalCommit": "1a7e45e1d12c6016a2968ccf99e39dd4d17c18bb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTYxMDk5OA==", "url": "https://github.com/apache/beam/pull/10886#discussion_r381610998", "bodyText": "Done.", "author": "chamikaramj", "createdAt": "2020-02-19T23:40:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTAwODY4MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTAxNTczMw==", "url": "https://github.com/apache/beam/pull/10886#discussion_r381015733", "bodyText": "Can None be an optional argument rather than passing it everywhere here?", "author": "robertwb", "createdAt": "2020-02-19T00:33:37Z", "path": "sdks/python/apache_beam/runners/dataflow/internal/apiclient_test.py", "diffHunk": "@@ -329,7 +402,7 @@ def test_harness_override_default_in_released_sdks(self):\n     env = apiclient.Environment([], #packages\n                                 pipeline_options,\n                                 '2.0.0', #any environment version\n-                                FAKE_PIPELINE_URL)\n+                                FAKE_PIPELINE_URL, None, None)", "originalCommit": "1a7e45e1d12c6016a2968ccf99e39dd4d17c18bb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTYyNjc3OQ==", "url": "https://github.com/apache/beam/pull/10886#discussion_r381626779", "bodyText": "Done.", "author": "chamikaramj", "createdAt": "2020-02-20T00:33:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTAxNTczMw=="}], "type": "inlineReview"}, {"oid": "54b66bb0e7668e800f96abcba715b7225e8fc87c", "url": "https://github.com/apache/beam/commit/54b66bb0e7668e800f96abcba715b7225e8fc87c", "message": "Updates DataflowRunner to support multiple SDK environments.\n\nUpdates DataflowRunner to set sdk_harness_container_images property.\nAdds a pipeline option so that users can override SDK harness container images.\nAlso did an update to create a secure local gRPC channel for expansion service instead of an insecure one.", "committedDate": "2020-02-19T02:59:27Z", "type": "forcePushed"}, {"oid": "a25d11c4855bff8c7c4593490ffe874205162c83", "url": "https://github.com/apache/beam/commit/a25d11c4855bff8c7c4593490ffe874205162c83", "message": "Updates DataflowRunner to support multiple SDK environments.\n\nUpdates DataflowRunner to set sdk_harness_container_images property.\nAdds a pipeline option so that users can override SDK harness container images.\nAlso did an update to create a secure local gRPC channel for expansion service instead of an insecure one.", "committedDate": "2020-02-20T00:48:26Z", "type": "forcePushed"}, {"oid": "e1cd30566b10d7733980dfdd64805b2c1c34e039", "url": "https://github.com/apache/beam/commit/e1cd30566b10d7733980dfdd64805b2c1c34e039", "message": "Updates DataflowRunner to support multiple SDK environments.\n\nUpdates DataflowRunner to set sdk_harness_container_images property.\nAdds a pipeline option so that users can override SDK harness container images.\nAlso did an update to create a secure local gRPC channel for expansion service instead of an insecure one.", "committedDate": "2020-02-20T01:03:22Z", "type": "forcePushed"}, {"oid": "eb99948d341c78d8001919fb884d33a6e8d2ce3f", "url": "https://github.com/apache/beam/commit/eb99948d341c78d8001919fb884d33a6e8d2ce3f", "message": "Updates DataflowRunner to support multiple SDK environments.\n\nUpdates DataflowRunner to set sdk_harness_container_images property.\nAdds a pipeline option so that users can override SDK harness container images.\nAlso did an update to create a secure local gRPC channel for expansion service instead of an insecure one.", "committedDate": "2020-02-20T01:42:54Z", "type": "forcePushed"}, {"oid": "e854cad3ceb6aa65854917098b096e577be5e74c", "url": "https://github.com/apache/beam/commit/e854cad3ceb6aa65854917098b096e577be5e74c", "message": "Updates DataflowRunner to support multiple SDK environments.\n\nUpdates DataflowRunner to set sdk_harness_container_images property.\nAdds a pipeline option so that users can override SDK harness container images.\nAlso did an update to create a secure local gRPC channel for expansion service instead of an insecure one.", "committedDate": "2020-02-20T02:18:02Z", "type": "forcePushed"}, {"oid": "c55d637bd1206c1e42ee194acebacbcbc5f0567e", "url": "https://github.com/apache/beam/commit/c55d637bd1206c1e42ee194acebacbcbc5f0567e", "message": "Updates DataflowRunner to support multiple SDK environments.\n\nUpdates DataflowRunner to set sdk_harness_container_images property.\nAdds a pipeline option so that users can override SDK harness container images.\nAlso did an update to create a secure local gRPC channel for expansion service instead of an insecure one.", "committedDate": "2020-02-20T18:50:10Z", "type": "forcePushed"}, {"oid": "c00a0dd1b6dc2b0cfcd80eeb65de862dcec70f75", "url": "https://github.com/apache/beam/commit/c00a0dd1b6dc2b0cfcd80eeb65de862dcec70f75", "message": "Updates DataflowRunner to support multiple SDK environments.\n\nUpdates DataflowRunner to set sdk_harness_container_images property.\nAdds a pipeline option so that users can override SDK harness container images.\nAlso did an update to create a secure local gRPC channel for expansion service instead of an insecure one.", "committedDate": "2020-02-20T21:42:30Z", "type": "commit"}, {"oid": "c00a0dd1b6dc2b0cfcd80eeb65de862dcec70f75", "url": "https://github.com/apache/beam/commit/c00a0dd1b6dc2b0cfcd80eeb65de862dcec70f75", "message": "Updates DataflowRunner to support multiple SDK environments.\n\nUpdates DataflowRunner to set sdk_harness_container_images property.\nAdds a pipeline option so that users can override SDK harness container images.\nAlso did an update to create a secure local gRPC channel for expansion service instead of an insecure one.", "committedDate": "2020-02-20T21:42:30Z", "type": "forcePushed"}]}