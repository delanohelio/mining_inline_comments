{"pr_number": 13399, "pr_title": "[BEAM-11312] Log cloud build url and enable kaniko cache in sdk_container_builder", "pr_createdAt": "2020-11-20T22:31:14Z", "pr_url": "https://github.com/apache/beam/pull/13399", "timeline": [{"oid": "9ec00e43ad9ae8989ad0a6a1f25862ada7808be3", "url": "https://github.com/apache/beam/commit/9ec00e43ad9ae8989ad0a6a1f25862ada7808be3", "message": "[BEAM-11312] Log cloud build url and enable kaniko cache in sdk_container_builder", "committedDate": "2020-11-20T22:30:21Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjk5MzYzNw==", "url": "https://github.com/apache/beam/pull/13399#discussion_r532993637", "bodyText": "I'm curious - why list_builds vs get_build using the operation build ID here?", "author": "emilymye", "createdAt": "2020-12-01T00:30:38Z", "path": "sdks/python/apache_beam/runners/portability/sdk_container_builder.py", "diffHunk": "@@ -236,10 +235,21 @@ def invoke_docker_build_and_push(self, container_image_name):\n     build.timeout = Duration().FromSeconds(seconds=1800)\n \n     now = time.time()\n-    _LOGGER.info('Building sdk container, this may take a few minutes...')\n+    _LOGGER.info(\n+        'Building sdk container with google cloud build, this may '\n+        'take a few minutes...')\n     operation = client.create_build(project_id=project_id, build=build)\n     # if build fails exception will be raised and stops the job submission.\n-    result = operation.result()\n+    try:\n+      result = operation.result()\n+    except Exception as e:\n+      build_lists = client.list_builds(", "originalCommit": "9ec00e43ad9ae8989ad0a6a1f25862ada7808be3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjk5NTA2NQ==", "url": "https://github.com/apache/beam/pull/13399#discussion_r532995065", "bodyText": "get_build requires a build id that is not returned from calling client.create_build(), this may be a usability issue from the python client but I didn't find any thing simpler", "author": "y1chi", "createdAt": "2020-12-01T00:35:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjk5MzYzNw=="}], "type": "inlineReview"}, {"oid": "cda6ddaacd9257e6695e30d8635992ed211a6b89", "url": "https://github.com/apache/beam/commit/cda6ddaacd9257e6695e30d8635992ed211a6b89", "message": "Log url before build finishes", "committedDate": "2020-12-04T18:03:12Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjM0MzQ0Ng==", "url": "https://github.com/apache/beam/pull/13399#discussion_r536343446", "bodyText": "Consider filing a feature request for the owner of this library.", "author": "tvalentyn", "createdAt": "2020-12-04T19:53:06Z", "path": "sdks/python/apache_beam/runners/portability/sdk_container_builder.py", "diffHunk": "@@ -235,24 +235,26 @@ def invoke_docker_build_and_push(self, container_image_name):\n     build.timeout = Duration().FromSeconds(seconds=1800)\n \n     now = time.time()\n-    _LOGGER.info(\n-        'Building sdk container with google cloud build, this may '\n-        'take a few minutes...')\n     operation = client.create_build(project_id=project_id, build=build)\n-    # if build fails exception will be raised and stops the job submission.\n-    try:\n-      result = operation.result()\n-    except Exception as e:\n-      build_lists = client.list_builds(\n-          project_id=project_id,\n-          filter=\"source.storage_source.bucket=\\\"%s\\\" AND source\"\n-          \".storage_source.object=\\\"%s\\\"\" % (gcs_bucket, gcs_object))\n-      for build in build_lists:\n-        _LOGGER.error(\"Build failed, check log at %s\" % build.log_url)\n-      raise e\n     _LOGGER.info(\n-        \"Python SDK container pre-build finished in %.2f seconds, \"\n-        \"check build log at %s\" % (time.time() - now, result.log_url))\n+      'Building sdk container with google cloud build, this may '\n+      'take a few minutes...')\n+    # TODO: we shouldn't need to query build log url with list_builds if log", "originalCommit": "cda6ddaacd9257e6695e30d8635992ed211a6b89", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjM0NTQwMA==", "url": "https://github.com/apache/beam/pull/13399#discussion_r536345400", "bodyText": "nit: s/google cloud build/Google Cloud Build here and below.", "author": "tvalentyn", "createdAt": "2020-12-04T19:56:52Z", "path": "sdks/python/apache_beam/runners/portability/sdk_container_builder.py", "diffHunk": "@@ -235,24 +235,26 @@ def invoke_docker_build_and_push(self, container_image_name):\n     build.timeout = Duration().FromSeconds(seconds=1800)\n \n     now = time.time()\n-    _LOGGER.info(\n-        'Building sdk container with google cloud build, this may '\n-        'take a few minutes...')\n     operation = client.create_build(project_id=project_id, build=build)\n-    # if build fails exception will be raised and stops the job submission.\n-    try:\n-      result = operation.result()\n-    except Exception as e:\n-      build_lists = client.list_builds(\n-          project_id=project_id,\n-          filter=\"source.storage_source.bucket=\\\"%s\\\" AND source\"\n-          \".storage_source.object=\\\"%s\\\"\" % (gcs_bucket, gcs_object))\n-      for build in build_lists:\n-        _LOGGER.error(\"Build failed, check log at %s\" % build.log_url)\n-      raise e\n     _LOGGER.info(\n-        \"Python SDK container pre-build finished in %.2f seconds, \"\n-        \"check build log at %s\" % (time.time() - now, result.log_url))\n+      'Building sdk container with google cloud build, this may '", "originalCommit": "cda6ddaacd9257e6695e30d8635992ed211a6b89", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "538f49382505a554725ec65b754b5641235880fc", "url": "https://github.com/apache/beam/commit/538f49382505a554725ec65b754b5641235880fc", "message": "Fix format.", "committedDate": "2020-12-04T20:29:36Z", "type": "commit"}]}