{"pr_number": 12756, "pr_title": "[BEAM-10824] [BEAM-7654] Change hash function in ApproximateUniqueCombineFn", "pr_createdAt": "2020-09-02T02:20:54Z", "pr_url": "https://github.com/apache/beam/pull/12756", "timeline": [{"oid": "5d77f3c085ad17f99b7573efb9173fd505c030d4", "url": "https://github.com/apache/beam/commit/5d77f3c085ad17f99b7573efb9173fd505c030d4", "message": "[BEAM-10824] Change hash function in ApproximateUniqueCombineFn\n\nRemove comments from test.\n\nfix lint error\n\ninclude unit test for nondeterministic coder\n\nlint and spelling errors\n\nyapf files\n\nChanged hash function and added unit tests.\n\nminor changes\n\nyapf\n\nsquash commits", "committedDate": "2020-09-02T06:44:14Z", "type": "commit"}, {"oid": "32f6319fb2c7dc9be112b4c866cb02aee79e545d", "url": "https://github.com/apache/beam/commit/32f6319fb2c7dc9be112b4c866cb02aee79e545d", "message": "test coverage", "committedDate": "2020-09-02T17:07:26Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjI2MTI4Ng==", "url": "https://github.com/apache/beam/pull/12756#discussion_r482261286", "bodyText": "nit: you could call this: test_approximate_unique_combine_fn_adds_values_correctly instead of adding a comment.", "author": "tvalentyn", "createdAt": "2020-09-02T17:58:39Z", "path": "sdks/python/apache_beam/transforms/stats_test.py", "diffHunk": "@@ -496,6 +483,51 @@ def test_approximate_unique_globally_by_error_with_skewed_data(self):\n           equal_to([True]),\n           label='assert:globally_by_error_with_skewed_data')\n \n+  def test_approximate_unique_combine_fn_by_nondeterministic_coder(self):\n+    # test if the combiner throws an error with a nondeterministic coder.\n+    sample_size = 30\n+    coder = coders.Base64PickleCoder()\n+\n+    with self.assertRaises(ValueError) as e:\n+      _ = ApproximateUniqueCombineFn(sample_size, coder)\n+\n+    self.assertRegex(\n+        e.exception.args[0],\n+        'The key coder \"Base64PickleCoder\" '\n+        'for ApproximateUniqueCombineFn is not deterministic.')\n+\n+  def test_approximate_unique_combine_fn_add_values(self):", "originalCommit": "32f6319fb2c7dc9be112b4c866cb02aee79e545d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjI2NjcwNQ==", "url": "https://github.com/apache/beam/pull/12756#discussion_r482266705", "bodyText": "done.", "author": "monicadsong", "createdAt": "2020-09-02T18:07:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjI2MTI4Ng=="}], "type": "inlineReview"}, {"oid": "a017d6b8ca0457994ce05be9309d7acbfdf8212c", "url": "https://github.com/apache/beam/commit/a017d6b8ca0457994ce05be9309d7acbfdf8212c", "message": "rename tests", "committedDate": "2020-09-02T18:06:15Z", "type": "commit"}, {"oid": "70c1b75cb59a745bd8b927f1bac19a114a4e0632", "url": "https://github.com/apache/beam/commit/70c1b75cb59a745bd8b927f1bac19a114a4e0632", "message": "add unit test for wrong coder\n\nadd unit test for wrong coder\n\nincrease code coverage", "committedDate": "2020-09-03T03:25:07Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzExMzAwNg==", "url": "https://github.com/apache/beam/pull/12756#discussion_r483113006", "bodyText": "I think we need to update the initialization of self._min_hash.\n@Hannah-Jiang do you by chance remember what was the logic behind setting\n  _HASH_SPACE_SIZE = 2.0 * sys.maxsize\nself._min_hash = sys.maxsize ?\nShouldn't we initialize self._min_hash with self._HASH_SPACE_SIZE?", "author": "tvalentyn", "createdAt": "2020-09-03T16:37:51Z", "path": "sdks/python/apache_beam/transforms/stats.py", "diffHunk": "@@ -192,7 +193,7 @@ def get_estimate(self):\n     if len(self._sample_heap) < self._sample_size:\n       return len(self._sample_heap)\n     else:\n-      sample_space_size = sys.maxsize - 1.0 * self._min_hash\n+      sample_space_size = self._HASH_SPACE_SIZE - 1.0 * self._min_hash", "originalCommit": "70c1b75cb59a745bd8b927f1bac19a114a4e0632", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzE1ODA2NQ==", "url": "https://github.com/apache/beam/pull/12756#discussion_r483158065", "bodyText": "Ah, that was because python's  hash() can return negative values. So yes, I think we need to set self._min_hash = 2**64 given that now all hash values are positive.", "author": "tvalentyn", "createdAt": "2020-09-03T17:57:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzExMzAwNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzE1OTI2Mg==", "url": "https://github.com/apache/beam/pull/12756#discussion_r483159262", "bodyText": "Valentyn-- you're right, forgot to update self._HASH_SPACE_SIZE. I think originally pythons hash() can return negative value, so the total hash space ranges from (- sys.maxsize,  sys.maxsize).", "author": "monicadsong", "createdAt": "2020-09-03T18:00:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzExMzAwNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzIxNTYzMg==", "url": "https://github.com/apache/beam/pull/12756#discussion_r483215632", "bodyText": "Modified it to 2^63 - 1 (which is also equivalent to sys.maxsize... which is why my tests were passing.)", "author": "monicadsong", "createdAt": "2020-09-03T19:47:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzExMzAwNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzE2NzMwOA==", "url": "https://github.com/apache/beam/pull/12756#discussion_r483167308", "bodyText": "naming suggestion:\ntest_approximate_unique_combine_fn_requires_compatible_coder", "author": "tvalentyn", "createdAt": "2020-09-03T18:15:10Z", "path": "sdks/python/apache_beam/transforms/stats_test.py", "diffHunk": "@@ -496,6 +483,62 @@ def test_approximate_unique_globally_by_error_with_skewed_data(self):\n           equal_to([True]),\n           label='assert:globally_by_error_with_skewed_data')\n \n+  def test_approximate_unique_combine_fn_by_nondeterministic_coder(self):\n+    # test if the combiner throws an error with a nondeterministic coder.\n+    sample_size = 30\n+    coder = coders.Base64PickleCoder()\n+\n+    with self.assertRaises(ValueError) as e:\n+      _ = ApproximateUniqueCombineFn(sample_size, coder)\n+\n+    self.assertRegex(\n+        e.exception.args[0],\n+        'The key coder \"Base64PickleCoder\" '\n+        'for ApproximateUniqueCombineFn is not deterministic.')\n+\n+  def test_approximate_unique_combine_fn_by_wrong_coder(self):", "originalCommit": "70c1b75cb59a745bd8b927f1bac19a114a4e0632", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzIxNTE5Ng==", "url": "https://github.com/apache/beam/pull/12756#discussion_r483215196", "bodyText": "done.", "author": "monicadsong", "createdAt": "2020-09-03T19:46:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzE2NzMwOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzE2ODA5MQ==", "url": "https://github.com/apache/beam/pull/12756#discussion_r483168091", "bodyText": "naming suggestion:\ntest_approximate_unique_combine_fn_requires_deterministic_coder", "author": "tvalentyn", "createdAt": "2020-09-03T18:16:34Z", "path": "sdks/python/apache_beam/transforms/stats_test.py", "diffHunk": "@@ -496,6 +483,62 @@ def test_approximate_unique_globally_by_error_with_skewed_data(self):\n           equal_to([True]),\n           label='assert:globally_by_error_with_skewed_data')\n \n+  def test_approximate_unique_combine_fn_by_nondeterministic_coder(self):", "originalCommit": "70c1b75cb59a745bd8b927f1bac19a114a4e0632", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzIxNTMwNA==", "url": "https://github.com/apache/beam/pull/12756#discussion_r483215304", "bodyText": "done.", "author": "monicadsong", "createdAt": "2020-09-03T19:46:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzE2ODA5MQ=="}], "type": "inlineReview"}, {"oid": "3ee3de100f240631b46ac2ff0a8a9a856ca12db6", "url": "https://github.com/apache/beam/commit/3ee3de100f240631b46ac2ff0a8a9a856ca12db6", "message": "fix test names and min hash size, add deprecation warning\n\nadding deprecation warning\n\nmore testing", "committedDate": "2020-09-04T01:42:43Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzM3NDg4Nw==", "url": "https://github.com/apache/beam/pull/12756#discussion_r483374887", "bodyText": "A fixed dataset was used because random dataset cannot always pass the test even with retries and introduces flakiness. Does it always pass now?", "author": "Hannah-Jiang", "createdAt": "2020-09-04T04:11:46Z", "path": "sdks/python/apache_beam/transforms/stats_test.py", "diffHunk": "@@ -160,57 +159,13 @@ def test_get_sample_size_from_est_error(self):\n     assert beam.ApproximateUnique._get_sample_size_from_est_error(0.05) == 1600\n     assert beam.ApproximateUnique._get_sample_size_from_est_error(0.01) == 40000\n \n-  @unittest.skip(\n-      'Skip it because hash function is not good enough. '\n-      'TODO: BEAM-7654')\n   def test_approximate_unique_global_by_sample_size(self):\n     # test if estimation error with a given sample size is not greater than\n     # expected max error.\n     sample_size = 16\n     max_err = 2 / math.sqrt(sample_size)\n-    test_input = [\n-        4,\n-        34,\n-        29,\n-        46,\n-        80,\n-        66,\n-        51,\n-        81,\n-        31,\n-        9,\n-        26,\n-        36,\n-        10,\n-        41,\n-        90,\n-        35,\n-        33,\n-        19,\n-        88,\n-        86,\n-        28,\n-        93,\n-        38,\n-        76,\n-        15,\n-        87,\n-        12,\n-        39,\n-        84,\n-        13,\n-        32,\n-        49,\n-        65,\n-        100,\n-        16,\n-        27,\n-        23,\n-        30,\n-        96,\n-        54\n-    ]\n-\n+    test_input = list(range(100))", "originalCommit": "3ee3de100f240631b46ac2ff0a8a9a856ca12db6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzM4NDk0Mw==", "url": "https://github.com/apache/beam/pull/12756#discussion_r483384943", "bodyText": "yes, all tests pass in a single run, always", "author": "monicadsong", "createdAt": "2020-09-04T04:52:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzM3NDg4Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzM4NTUxMA==", "url": "https://github.com/apache/beam/pull/12756#discussion_r483385510", "bodyText": "but I will add a seed to account for randomness in the shuffling of the test data.", "author": "monicadsong", "createdAt": "2020-09-04T04:54:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzM3NDg4Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzQ1Mjk3NQ==", "url": "https://github.com/apache/beam/pull/12756#discussion_r483452975", "bodyText": "It\u2019s better to run at least 100 times to test flakiness. I\u2019d recommend to run 1000 times.", "author": "Hannah-Jiang", "createdAt": "2020-09-04T07:57:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzM3NDg4Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDY4MTM4Nw==", "url": "https://github.com/apache/beam/pull/12756#discussion_r484681387", "bodyText": "hmm not sure I understand... i believe that adding a random seed should eliminate all randomness in the generation and shuffling of the test data, such that every test run uses the same data?", "author": "monicadsong", "createdAt": "2020-09-08T06:34:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzM3NDg4Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTAyNTUyOA==", "url": "https://github.com/apache/beam/pull/12756#discussion_r485025528", "bodyText": "Ah, I miss understood your above comment. Adding the seed looks good to me.", "author": "Hannah-Jiang", "createdAt": "2020-09-08T15:51:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzM3NDg4Nw=="}], "type": "inlineReview"}, {"oid": "7d347512a54a3f07ccb5c2f9a591dfb5ba116d2c", "url": "https://github.com/apache/beam/commit/7d347512a54a3f07ccb5c2f9a591dfb5ba116d2c", "message": "add option for murmurhash since md5 has slow performance, add random seed to test case\n\nsetup", "committedDate": "2020-09-08T06:38:50Z", "type": "commit"}, {"oid": "3256299ab3379336aebb8e76fd6cde59b1f703ca", "url": "https://github.com/apache/beam/commit/3256299ab3379336aebb8e76fd6cde59b1f703ca", "message": "add license\n\nfix license", "committedDate": "2020-09-08T16:10:45Z", "type": "commit"}, {"oid": "a83c0db039aa4784a0cca3cd8fff9ad7eac17327", "url": "https://github.com/apache/beam/commit/a83c0db039aa4784a0cca3cd8fff9ad7eac17327", "message": "fix failed assertion", "committedDate": "2020-09-08T17:39:34Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTIxODg2Mg==", "url": "https://github.com/apache/beam/pull/12756#discussion_r485218862", "bodyText": "Couldn't find murmurhash. Install mmh3 for a faster implementation of ApproximateUnique.", "author": "tvalentyn", "createdAt": "2020-09-08T21:58:14Z", "path": "sdks/python/apache_beam/transforms/stats.py", "diffHunk": "@@ -46,6 +57,35 @@\n V = typing.TypeVar('V')\n \n \n+def _default_hash_fn(value):\n+  \"\"\"Hash value using either murmurhash or md5 based on installation.\"\"\"\n+  if not _default_hash_fn.fn:\n+    try:\n+      import mmh3  # pylint: disable=import-error\n+\n+      def _mmh3_hash(value):\n+        # mmh3.hash64 returns 2 64-bit unsigned integers\n+        return mmh3.hash64(value, seed=0, signed=False)[0]\n+\n+      _default_hash_fn.fn = _mmh3_hash\n+    except ImportError:\n+      logging.warning(\n+          'Couldn\\'t find murmurhash so the implementation of '\n+          'ApproximateUnique is not as fast as it could be.')", "originalCommit": "a83c0db039aa4784a0cca3cd8fff9ad7eac17327", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTIyMzk4Ng==", "url": "https://github.com/apache/beam/pull/12756#discussion_r485223986", "bodyText": "Can we parameterize the test to exercise both md5/mmh3 codepaths. We could force md5 by a patch for test purposes if mmh3 is installed.", "author": "tvalentyn", "createdAt": "2020-09-08T22:11:55Z", "path": "sdks/python/apache_beam/transforms/stats_test.py", "diffHunk": "@@ -41,13 +40,15 @@\n from apache_beam.transforms.display import DisplayData\n from apache_beam.transforms.display_test import DisplayDataItemMatcher\n from apache_beam.transforms.stats import ApproximateQuantilesCombineFn\n+from apache_beam.transforms.stats import ApproximateUniqueCombineFn\n \n \n class ApproximateUniqueTest(unittest.TestCase):\n-  \"\"\"Unit tests for ApproximateUnique.Globally and ApproximateUnique.PerKey.\n-  Hash() with Python3 is nondeterministic, so Approximation algorithm generates\n-  different result each time and sometimes error rate is out of range, so add\n-  retries for all tests who actually running approximation algorithm.\"\"\"\n+  \"\"\"Unit tests for ApproximateUnique.Globally, ApproximateUnique.PerKey,\n+  and ApproximateUniqueCombineFn.", "originalCommit": "a83c0db039aa4784a0cca3cd8fff9ad7eac17327", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTI3NjMyNw==", "url": "https://github.com/apache/beam/pull/12756#discussion_r485276327", "bodyText": "Here is a background of mmh3 in case it helps for decision making. I used mmh3 at first but decided to use default hash function. mmh3 has better prediction performance, but it introduces much more complexity for dataflow import, and users should use HLL if they really care about the accuracy. In addition, the default hash function improved for Py3 and the performance diff was not big enough to use mmh3 and introduce the complexity. This is the reason mmh3 was not used, and it is just for reference.\nI think it\u2019s better to mention that HLL is supported by Beam.", "author": "Hannah-Jiang", "createdAt": "2020-09-09T01:02:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTIyMzk4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTg1NTA5MA==", "url": "https://github.com/apache/beam/pull/12756#discussion_r485855090", "bodyText": "We can still do Dataflow import with a new dependency, AFAIK we noticed that Google internal-only tests for Beam on Windows were failing, so we thought that adding mmh3 would be a concern for all Beam Windows users. I no longer see  failures in Windows precommit tests running on the PR.", "author": "tvalentyn", "createdAt": "2020-09-09T19:19:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTIyMzk4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTg1ODc3MQ==", "url": "https://github.com/apache/beam/pull/12756#discussion_r485858771", "bodyText": "I agree with Hannah. HLL would be the right solution and given that py3 has a better hash function adding this dependency could be avoided.\nWhat is the specific issue we are addressing by this change?", "author": "aaltay", "createdAt": "2020-09-09T19:25:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTIyMzk4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTg2MDM4Mw==", "url": "https://github.com/apache/beam/pull/12756#discussion_r485860383", "bodyText": "hash is non deterministic, so if the computation is distributed over different machines, the estimates are overly inaccurate", "author": "monicadsong", "createdAt": "2020-09-09T19:28:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTIyMzk4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTg2MjU2OQ==", "url": "https://github.com/apache/beam/pull/12756#discussion_r485862569", "bodyText": "py3 hash is non-deterministic, see BEAM-10824 and internal issue b/166646014 which has a bit more details.\nWe should not be using py3 hash function, and I support this change. Current change supports both md5 and mmh3, but we have a remanining question whether mmh3 should be a default dep (better performance than md5, but extra dependency), or optional (default to md5, give a warning recommendation to install mmh3, similar to snappy).\nHLL is not available for Beam Python yet, is it?", "author": "tvalentyn", "createdAt": "2020-09-09T19:31:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTIyMzk4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTg3MDI3OA==", "url": "https://github.com/apache/beam/pull/12756#discussion_r485870278", "bodyText": "I did not know about py3 hash being non deterministic. That is strange.\nIn that case I agree with this change. Let's make it optional so that the getting started experience does not change and any actual execution environment could install it as needed. (i.e. add it here : https://github.com/apache/beam/blob/master/sdks/python/container/base_image_requirements.txt in this PR.)", "author": "aaltay", "createdAt": "2020-09-09T19:40:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTIyMzk4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTg3NTQ5MQ==", "url": "https://github.com/apache/beam/pull/12756#discussion_r485875491", "bodyText": "sounds good thanks! more info on py3 hash here: https://stackoverflow.com/questions/27522626/hash-function-in-python-3-3-returns-different-results-between-sessions", "author": "monicadsong", "createdAt": "2020-09-09T19:46:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTIyMzk4Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTg1MzI2MA==", "url": "https://github.com/apache/beam/pull/12756#discussion_r485853260", "bodyText": "(I thought I already added this comment here but for some reason I don't see it...)\nLet's make the upper bound more flexible mmh3>=2.5.1,<3.0, or remove the obligatory dependency on mmh3 as we do for snappy.  @aaltay do you have a preference on this?\nFor the record, Windows tests on the PR are passing. AFAIK, previously we didn't add a dep on mmh3 we observed installation errors on Google internal Windows test.", "author": "tvalentyn", "createdAt": "2020-09-09T19:16:12Z", "path": "sdks/python/setup.py", "diffHunk": "@@ -165,6 +165,7 @@ def get_version():\n     'requests>=2.24.0,<3.0.0',\n     'typing>=3.7.0,<3.8.0; python_full_version < \"3.5.3\"',\n     'typing-extensions>=3.7.0,<3.8.0',\n+    'mmh3>=2.5.1,<2.5.2',", "originalCommit": "a83c0db039aa4784a0cca3cd8fff9ad7eac17327", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTg2MDU1NA==", "url": "https://github.com/apache/beam/pull/12756#discussion_r485860554", "bodyText": "It is better to avoid adding a new dependency if possible especially a one with platform specific differences. If we need to add it, it is better to make it optional similar to snappy.", "author": "aaltay", "createdAt": "2020-09-09T19:28:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTg1MzI2MA=="}], "type": "inlineReview"}, {"oid": "cc30e8a7cbb12e3894c880acd749904dc5e56764", "url": "https://github.com/apache/beam/commit/cc30e8a7cbb12e3894c880acd749904dc5e56764", "message": "clean up test, make mmh3 optkonal\n\nyapf", "committedDate": "2020-09-09T23:30:25Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTk3Njk4Nw==", "url": "https://github.com/apache/beam/pull/12756#discussion_r485976987", "bodyText": "For this file, you can pick a specific version instead of a range.", "author": "aaltay", "createdAt": "2020-09-09T23:31:02Z", "path": "sdks/python/container/base_image_requirements.txt", "diffHunk": "@@ -57,6 +57,7 @@ google-cloud-datastore==1.7.4\n cython==0.29.13\n guppy==0.1.11;python_version<=\"2.7\"\n guppy3==3.0.9;python_version>=\"3.5\"\n+mmh3>=2.5.1,<3.0", "originalCommit": "25bc7b40446679ec57133bcde9a2f1f4eed9ad81", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTk4Mjc4NQ==", "url": "https://github.com/apache/beam/pull/12756#discussion_r485982785", "bodyText": "Is this line a left-over?", "author": "tvalentyn", "createdAt": "2020-09-09T23:50:56Z", "path": "sdks/python/apache_beam/transforms/stats_test.py", "diffHunk": "@@ -41,355 +41,88 @@\n from apache_beam.transforms.display import DisplayData\n from apache_beam.transforms.display_test import DisplayDataItemMatcher\n from apache_beam.transforms.stats import ApproximateQuantilesCombineFn\n+from apache_beam.transforms.stats import ApproximateUniqueCombineFn\n \n+try:\n+  import mmh3\n+  mmh3_options = [(mmh3, ), (None, )]\n+except ImportError:\n+  mmh3_options = [(None, )]\n \n-class ApproximateUniqueTest(unittest.TestCase):\n-  \"\"\"Unit tests for ApproximateUnique.Globally and ApproximateUnique.PerKey.\n-  Hash() with Python3 is nondeterministic, so Approximation algorithm generates\n-  different result each time and sometimes error rate is out of range, so add\n-  retries for all tests who actually running approximation algorithm.\"\"\"\n-  def test_approximate_unique_global_by_invalid_size(self):\n-    # test if the transformation throws an error as expected with an invalid\n-    # small input size (< 16).\n-    sample_size = 10\n-    test_input = [random.randint(0, 1000) for _ in range(100)]\n-\n-    with self.assertRaises(ValueError) as e:\n-      with TestPipeline() as pipeline:\n-        _ = (\n-            pipeline\n-            | 'create' >> beam.Create(test_input)\n-            |\n-            'get_estimate' >> beam.ApproximateUnique.Globally(size=sample_size))\n-\n-    expected_msg = beam.ApproximateUnique._INPUT_SIZE_ERR_MSG % (sample_size)\n-\n-    assert e.exception.args[0] == expected_msg\n-\n-  def test_approximate_unique_global_by_invalid_type_size(self):\n-    # test if the transformation throws an error as expected with an invalid\n-    # type of input size (not int).\n-    sample_size = 100.0\n-    test_input = [random.randint(0, 1000) for _ in range(100)]\n-\n-    with self.assertRaises(ValueError) as e:\n-      with TestPipeline() as pipeline:\n-        _ = (\n-            pipeline\n-            | 'create' >> beam.Create(test_input)\n-            |\n-            'get_estimate' >> beam.ApproximateUnique.Globally(size=sample_size))\n-\n-    expected_msg = beam.ApproximateUnique._INPUT_SIZE_ERR_MSG % (sample_size)\n-\n-    assert e.exception.args[0] == expected_msg\n-\n-  def test_approximate_unique_global_by_invalid_small_error(self):\n-    # test if the transformation throws an error as expected with an invalid\n-    # small input error (< 0.01).\n-    est_err = 0.0\n-    test_input = [random.randint(0, 1000) for _ in range(100)]\n-\n-    with self.assertRaises(ValueError) as e:\n-      with TestPipeline() as pipeline:\n-        _ = (\n-            pipeline\n-            | 'create' >> beam.Create(test_input)\n-            | 'get_estimate' >> beam.ApproximateUnique.Globally(error=est_err))\n-\n-    expected_msg = beam.ApproximateUnique._INPUT_ERROR_ERR_MSG % (est_err)\n-\n-    assert e.exception.args[0] == expected_msg\n-\n-  def test_approximate_unique_global_by_invalid_big_error(self):\n-    # test if the transformation throws an error as expected with an invalid\n-    # big input error (> 0.50).\n-    est_err = 0.6\n-    test_input = [random.randint(0, 1000) for _ in range(100)]\n-\n-    with self.assertRaises(ValueError) as e:\n-      with TestPipeline() as pipeline:\n-        _ = (\n-            pipeline\n-            | 'create' >> beam.Create(test_input)\n-            | 'get_estimate' >> beam.ApproximateUnique.Globally(error=est_err))\n-\n-    expected_msg = beam.ApproximateUnique._INPUT_ERROR_ERR_MSG % (est_err)\n-\n-    assert e.exception.args[0] == expected_msg\n-\n-  def test_approximate_unique_global_by_invalid_no_input(self):\n-    # test if the transformation throws an error as expected with no input.\n-    test_input = [random.randint(0, 1000) for _ in range(100)]\n-\n-    with self.assertRaises(ValueError) as e:\n-      with TestPipeline() as pipeline:\n-        _ = (\n-            pipeline\n-            | 'create' >> beam.Create(test_input)\n-            | 'get_estimate' >> beam.ApproximateUnique.Globally())\n-\n-    expected_msg = beam.ApproximateUnique._NO_VALUE_ERR_MSG\n-    assert e.exception.args[0] == expected_msg\n-\n-  def test_approximate_unique_global_by_invalid_both_input(self):\n-    # test if the transformation throws an error as expected with multi input.\n-    test_input = [random.randint(0, 1000) for _ in range(100)]\n-    est_err = 0.2\n-    sample_size = 30\n-\n-    with self.assertRaises(ValueError) as e:\n-      with TestPipeline() as pipeline:\n-        _ = (\n-            pipeline\n-            | 'create' >> beam.Create(test_input)\n-            | 'get_estimate' >> beam.ApproximateUnique.Globally(\n-                size=sample_size, error=est_err))\n-\n-    expected_msg = beam.ApproximateUnique._MULTI_VALUE_ERR_MSG % (\n-        sample_size, est_err)\n-\n-    assert e.exception.args[0] == expected_msg\n-\n-  def test_get_sample_size_from_est_error(self):\n-    # test if get correct sample size from input error.\n-    assert beam.ApproximateUnique._get_sample_size_from_est_error(0.5) == 16\n-    assert beam.ApproximateUnique._get_sample_size_from_est_error(0.4) == 25\n-    assert beam.ApproximateUnique._get_sample_size_from_est_error(0.2) == 100\n-    assert beam.ApproximateUnique._get_sample_size_from_est_error(0.1) == 400\n-    assert beam.ApproximateUnique._get_sample_size_from_est_error(0.05) == 1600\n-    assert beam.ApproximateUnique._get_sample_size_from_est_error(0.01) == 40000\n-\n-  @unittest.skip(\n-      'Skip it because hash function is not good enough. '\n-      'TODO: BEAM-7654')\n-  def test_approximate_unique_global_by_sample_size(self):\n-    # test if estimation error with a given sample size is not greater than\n-    # expected max error.\n-    sample_size = 16\n-    max_err = 2 / math.sqrt(sample_size)\n-    test_input = [\n-        4,\n-        34,\n-        29,\n-        46,\n-        80,\n-        66,\n-        51,\n-        81,\n-        31,\n-        9,\n-        26,\n-        36,\n-        10,\n-        41,\n-        90,\n-        35,\n-        33,\n-        19,\n-        88,\n-        86,\n-        28,\n-        93,\n-        38,\n-        76,\n-        15,\n-        87,\n-        12,\n-        39,\n-        84,\n-        13,\n-        32,\n-        49,\n-        65,\n-        100,\n-        16,\n-        27,\n-        23,\n-        30,\n-        96,\n-        54\n-    ]\n-\n-    actual_count = len(set(test_input))\n-\n-    with TestPipeline() as pipeline:\n-      result = (\n-          pipeline\n-          | 'create' >> beam.Create(test_input)\n-          | 'get_estimate' >> beam.ApproximateUnique.Globally(size=sample_size)\n-          | 'compare' >> beam.FlatMap(\n-              lambda x: [abs(x - actual_count) * 1.0 / actual_count <= max_err])\n-      )\n-\n-      assert_that(result, equal_to([True]), label='assert:global_by_size')\n-\n-  @retry(reraise=True, stop=stop_after_attempt(5))\n-  def test_approximate_unique_global_by_sample_size_with_duplicates(self):\n-    # test if estimation error with a given sample size is not greater than\n-    # expected max error with duplicated input.\n-    sample_size = 30\n-    max_err = 2 / math.sqrt(sample_size)\n-    test_input = [10] * 50 + [20] * 50\n-    actual_count = len(set(test_input))\n-\n-    with TestPipeline() as pipeline:\n-      result = (\n-          pipeline\n-          | 'create' >> beam.Create(test_input)\n-          | 'get_estimate' >> beam.ApproximateUnique.Globally(size=sample_size)\n-          | 'compare' >> beam.FlatMap(\n-              lambda x: [abs(x - actual_count) * 1.0 / actual_count <= max_err])\n-      )\n-\n-      assert_that(\n-          result,\n-          equal_to([True]),\n-          label='assert:global_by_size_with_duplicates')\n-\n-  @retry(reraise=True, stop=stop_after_attempt(5))\n-  def test_approximate_unique_global_by_sample_size_with_small_population(self):\n-    # test if estimation is exactly same to actual value when sample size is\n-    # not smaller than population size (sample size > 100% of population).\n-    sample_size = 31\n-    test_input = [\n-        144,\n-        160,\n-        229,\n-        923,\n-        390,\n-        756,\n-        674,\n-        769,\n-        145,\n-        888,\n-        809,\n-        159,\n-        222,\n-        101,\n-        943,\n-        901,\n-        876,\n-        194,\n-        232,\n-        631,\n-        221,\n-        829,\n-        965,\n-        729,\n-        35,\n-        33,\n-        115,\n-        894,\n-        827,\n-        364\n-    ]\n-    actual_count = len(set(test_input))\n \n-    with TestPipeline() as pipeline:\n-      result = (\n-          pipeline\n-          | 'create' >> beam.Create(test_input)\n-          | 'get_estimate' >> beam.ApproximateUnique.Globally(size=sample_size))\n-\n-      assert_that(\n-          result,\n-          equal_to([actual_count]),\n-          label='assert:global_by_sample_size_with_small_population')\n-\n-  @unittest.skip(\n-      'Skip because hash function is not good enough. '\n-      'TODO: BEAM-7654')\n-  def test_approximate_unique_global_by_error(self):\n-    # test if estimation error from input error is not greater than input error.\n-    est_err = 0.3\n-    test_input = [\n-        291,\n-        371,\n-        271,\n-        126,\n-        762,\n-        391,\n-        222,\n-        565,\n-        428,\n-        786,\n-        801,\n-        867,\n-        337,\n-        690,\n-        261,\n-        436,\n-        311,\n-        568,\n-        946,\n-        722,\n-        973,\n-        386,\n-        506,\n-        546,\n-        991,\n-        450,\n-        226,\n-        889,\n-        514,\n-        693\n-    ]\n+@parameterized_class(('sys.modules[\\'mmh3\\']', ), mmh3_options)\n+class ApproximateUniqueTest(unittest.TestCase):\n+  \"\"\"Unit tests for ApproximateUnique.Globally, ApproximateUnique.PerKey,\n+  and ApproximateUniqueCombineFn.\n+  \"\"\"\n+  random.seed(0)\n+  sys.modules['mmh3'] = None", "originalCommit": "cc30e8a7cbb12e3894c880acd749904dc5e56764", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjA3NjM2Ng==", "url": "https://github.com/apache/beam/pull/12756#discussion_r486076366", "bodyText": "that was deliberate, but it bothered me as well. done.", "author": "monicadsong", "createdAt": "2020-09-10T05:36:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTk4Mjc4NQ=="}], "type": "inlineReview"}, {"oid": "ea1231a514bf05716f2565ba35de79586d69ccce", "url": "https://github.com/apache/beam/commit/ea1231a514bf05716f2565ba35de79586d69ccce", "message": "fix base image reqirements, remove mmh3 license", "committedDate": "2020-09-09T23:51:26Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTk4Mzg2MA==", "url": "https://github.com/apache/beam/pull/12756#discussion_r485983860", "bodyText": "so pip-licences tool is able to automatically fetch the license for mmh3? If so, great! If not, we will need this line, since we will ship mmh3 in our containers.", "author": "tvalentyn", "createdAt": "2020-09-09T23:54:57Z", "path": "sdks/python/container/license_scripts/dep_urls_py.yaml", "diffHunk": "@@ -77,8 +77,6 @@ pip_dependencies:\n     license: \"https://raw.githubusercontent.com/mtth/hdfs/master/LICENSE\"\n   httplib2:\n     license: \"https://raw.githubusercontent.com/httplib2/httplib2/master/LICENSE\"\n-  mmh3:\n-    license: \"https://raw.githubusercontent.com/hajimes/mmh3/master/LICENSE\"", "originalCommit": "ea1231a514bf05716f2565ba35de79586d69ccce", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTk4NTU4MA==", "url": "https://github.com/apache/beam/pull/12756#discussion_r485985580", "bodyText": "hmm probably not-- will add it back in", "author": "monicadsong", "createdAt": "2020-09-10T00:00:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTk4Mzg2MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTk4NDA3Nw==", "url": "https://github.com/apache/beam/pull/12756#discussion_r485984077", "bodyText": "Actually should we keep this since it will be in the container?", "author": "aaltay", "createdAt": "2020-09-09T23:55:40Z", "path": "sdks/python/container/license_scripts/dep_urls_py.yaml", "diffHunk": "@@ -77,8 +77,6 @@ pip_dependencies:\n     license: \"https://raw.githubusercontent.com/mtth/hdfs/master/LICENSE\"\n   httplib2:\n     license: \"https://raw.githubusercontent.com/httplib2/httplib2/master/LICENSE\"\n-  mmh3:", "originalCommit": "ea1231a514bf05716f2565ba35de79586d69ccce", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTk4NTQyNg==", "url": "https://github.com/apache/beam/pull/12756#discussion_r485985426", "bodyText": "oh whoops, will add that back in", "author": "monicadsong", "createdAt": "2020-09-10T00:00:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTk4NDA3Nw=="}], "type": "inlineReview"}, {"oid": "dadcf86db7f4a5d6f4941c4c44361b6fac25486c", "url": "https://github.com/apache/beam/commit/dadcf86db7f4a5d6f4941c4c44361b6fac25486c", "message": "add set up, add license again\n\nlint\n\nlint\n\nremove test comment", "committedDate": "2020-09-11T00:11:23Z", "type": "commit"}]}