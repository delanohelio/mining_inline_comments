{"pr_number": 13187, "pr_title": "Updated shared.py comments", "pr_createdAt": "2020-10-24T01:05:33Z", "pr_url": "https://github.com/apache/beam/pull/13187", "timeline": [{"oid": "4fcd77139ff53482db0253aeeb56eac154f8cf02", "url": "https://github.com/apache/beam/commit/4fcd77139ff53482db0253aeeb56eac154f8cf02", "message": "Updated shared.py comments", "committedDate": "2020-10-24T01:05:20Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTY5MDA3Ng==", "url": "https://github.com/apache/beam/pull/13187#discussion_r511690076", "bodyText": "Be good to have a note why setup is best place to do the init.", "author": "rezarokni", "createdAt": "2020-10-26T02:24:19Z", "path": "sdks/python/apache_beam/utils/shared.py", "diffHunk": "@@ -26,22 +26,30 @@\n \n To share a very large list across all threads of each worker in a DoFn::\n \n-  class GetNthStringFn(beam.DoFn):\n-    def __init__(self, shared_handle):\n-      self._shared_handle = shared_handle\n-\n-    def process(self, element):\n-      def initialize_list():\n-        # Build the giant initial list.\n-        return [str(i) for i in range(1000000)]\n-\n-      giant_list = self._shared_handle.acquire(initialize_list)\n-      yield giant_list[element]\n-\n-  p = beam.Pipeline()\n-  shared_handle = shared.Shared()\n-  (p | beam.Create([2, 4, 6, 8])\n-     | beam.ParDo(GetNthStringFn(shared_handle)))\n+# Several built-in types such as list and dict do not directly support weak\n+# references but can add support through subclassing:\n+# https://docs.python.org/3/library/weakref.html\n+class WeakRefList(list):\n+\tpass\n+\n+class GetNthStringFn(beam.DoFn):\n+  def __init__(self, shared_handle):\n+    self._shared_handle = shared_handle\n+\n+  def setup(self):", "originalCommit": "4fcd77139ff53482db0253aeeb56eac154f8cf02", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzExMzkyNg==", "url": "https://github.com/apache/beam/pull/13187#discussion_r513113926", "bodyText": "done", "author": "aaltay", "createdAt": "2020-10-28T00:43:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTY5MDA3Ng=="}], "type": "inlineReview"}, {"oid": "bd1febc064346d2f765d4758ff2e84f972b1c0f7", "url": "https://github.com/apache/beam/commit/bd1febc064346d2f765d4758ff2e84f972b1c0f7", "message": "Add a comment to to setup function", "committedDate": "2020-10-28T00:43:25Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzgyMzMxOA==", "url": "https://github.com/apache/beam/pull/13187#discussion_r513823318", "bodyText": "Consider following wording for line 29 to prepare the reader for why weak references are discussed:\nShared is a helper class for managing a single instance of an object shared by multiple threads within the same process. Instances of Shared are serializable objects that can be shared by all threads of each worker process. A Shared object encapsulates a weak reference to a singleton instance of the shared resource. The singleton is lazily initialized by calls to Shared.acquire().", "author": "tvalentyn", "createdAt": "2020-10-28T23:34:49Z", "path": "sdks/python/apache_beam/utils/shared.py", "diffHunk": "@@ -26,22 +26,31 @@\n \n To share a very large list across all threads of each worker in a DoFn::\n \n-  class GetNthStringFn(beam.DoFn):\n-    def __init__(self, shared_handle):\n-      self._shared_handle = shared_handle\n-\n-    def process(self, element):\n-      def initialize_list():\n-        # Build the giant initial list.\n-        return [str(i) for i in range(1000000)]\n-\n-      giant_list = self._shared_handle.acquire(initialize_list)\n-      yield giant_list[element]\n-\n-  p = beam.Pipeline()\n-  shared_handle = shared.Shared()\n-  (p | beam.Create([2, 4, 6, 8])\n-     | beam.ParDo(GetNthStringFn(shared_handle)))\n+# Several built-in types such as list and dict do not directly support weak", "originalCommit": "bd1febc064346d2f765d4758ff2e84f972b1c0f7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "200bbc1a16bc08100db7ba0d6f3c3f5944868d8b", "url": "https://github.com/apache/beam/commit/200bbc1a16bc08100db7ba0d6f3c3f5944868d8b", "message": "update comments", "committedDate": "2020-11-12T01:51:36Z", "type": "commit"}, {"oid": "aa3ece7c00f55f32516f6425fea0d2b65862b4a8", "url": "https://github.com/apache/beam/commit/aa3ece7c00f55f32516f6425fea0d2b65862b4a8", "message": "fix - indent example", "committedDate": "2020-11-20T01:53:49Z", "type": "commit"}, {"oid": "7a5912057a0a1ba00e27c6ce3b0860ee45940828", "url": "https://github.com/apache/beam/commit/7a5912057a0a1ba00e27c6ce3b0860ee45940828", "message": "fix - lint", "committedDate": "2020-11-20T21:28:45Z", "type": "commit"}]}