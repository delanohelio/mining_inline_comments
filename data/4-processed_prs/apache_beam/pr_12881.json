{"pr_number": 12881, "pr_title": "[BEAM-7746] Get mypy passing on runners.worker", "pr_createdAt": "2020-09-19T23:00:14Z", "pr_url": "https://github.com/apache/beam/pull/12881", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTU5MDQ0MQ==", "url": "https://github.com/apache/beam/pull/12881#discussion_r491590441", "bodyText": "This needed to be renamed because the variable was reused below for a different type", "author": "chadrik", "createdAt": "2020-09-19T23:02:13Z", "path": "sdks/python/apache_beam/runners/worker/bundle_processor.py", "diffHunk": "@@ -920,7 +928,7 @@ def reset(self):\n   def process_bundle(self, instruction_id):\n     # type: (str) -> Tuple[List[beam_fn_api_pb2.DelayedBundleApplication], bool]\n \n-    expected_inputs = []\n+    expected_input_ops = []", "originalCommit": "5b393dbaefaea775bba8f998a679d79bb683777c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTU5MjE3MA==", "url": "https://github.com/apache/beam/pull/12881#discussion_r491592170", "bodyText": "It's more accurate to say Any here, since the method doesn't care.  The argument can't be Optional or the method it would be incompatible with its super type.\nI checked all uses of input_elements and I did not see any case where it was called with only one arg.", "author": "chadrik", "createdAt": "2020-09-19T23:05:50Z", "path": "sdks/python/apache_beam/runners/worker/data_plane.py", "diffHunk": "@@ -303,9 +334,10 @@ def inverse(self):\n \n   def input_elements(self,\n       instruction_id,  # type: str\n-      unused_expected_inputs=None,   # type: Collection[str]\n+      unused_expected_inputs,   # type: Any", "originalCommit": "5b393dbaefaea775bba8f998a679d79bb683777c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTU5MzQ1Ng==", "url": "https://github.com/apache/beam/pull/12881#discussion_r491593456", "bodyText": "This shouldn't change the behavior of the code, it merely indicates to the type system that we expect BoundedSource, since SourceBase is not sufficient here (we need default_output_coder())", "author": "chadrik", "createdAt": "2020-09-19T23:08:35Z", "path": "sdks/python/apache_beam/runners/worker/bundle_processor.py", "diffHunk": "@@ -1344,7 +1356,8 @@ def create_deprecated_read(\n     consumers  # type: Dict[str, List[operations.Operation]]\n ):\n   # type: (...) -> operations.ReadOperation\n-  source = iobase.SourceBase.from_runner_api(parameter.source, factory.context)\n+  source = iobase.BoundedSource.from_runner_api(", "originalCommit": "5b393dbaefaea775bba8f998a679d79bb683777c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTU5MzgzNQ==", "url": "https://github.com/apache/beam/pull/12881#discussion_r491593835", "bodyText": "this was just wrong. there is no common.SplitResultType", "author": "chadrik", "createdAt": "2020-09-19T23:09:20Z", "path": "sdks/python/apache_beam/runners/worker/bundle_processor.py", "diffHunk": "@@ -1125,15 +1134,15 @@ def shutdown(self):\n class ExecutionContext(object):\n   def __init__(self):\n     self.delayed_applications = [\n-    ]  # type: List[Tuple[operations.DoOperation, common.SplitResultType]]\n+    ]  # type: List[Tuple[operations.DoOperation, common.SplitResultResidual]]", "originalCommit": "5b393dbaefaea775bba8f998a679d79bb683777c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTU5NTA5MQ==", "url": "https://github.com/apache/beam/pull/12881#discussion_r491595091", "bodyText": "userstate.RuntimeState does not have the necessary commit() method, and there is no common base class for these 4 types that has all of the necessary methods.  When dealing with a reasonably limited number of possibilities with unclear parentage, a Union is a good solution.", "author": "chadrik", "createdAt": "2020-09-19T23:11:59Z", "path": "sdks/python/apache_beam/runners/worker/bundle_processor.py", "diffHunk": "@@ -705,10 +713,11 @@ def __init__(self,\n     self._key_coder = key_coder\n     self._window_coder = window_coder\n     # A mapping of {timer_family_id: TimerInfo}\n-    self._timers_info = {}\n-    self._all_states = {}  # type: Dict[tuple, userstate.RuntimeState]\n+    self._timers_info = {}  # type: Dict[str, TimerInfo]\n+    self._all_states = {}  # type: Dict[tuple, FnApiUserRuntimeStateTypes]", "originalCommit": "5b393dbaefaea775bba8f998a679d79bb683777c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTU5NTI3Nw==", "url": "https://github.com/apache/beam/pull/12881#discussion_r491595277", "bodyText": "as far as I can tell, this was just wrong", "author": "chadrik", "createdAt": "2020-09-19T23:12:28Z", "path": "sdks/python/apache_beam/coders/coder_impl.py", "diffHunk": "@@ -725,7 +726,7 @@ def __init__(self, key_coder_impl, window_coder_impl):\n     self._tag_coder_impl = StrUtf8Coder().get_impl()\n \n   def encode_to_stream(self, value, out, nested):\n-    # type: (dict, create_OutputStream, bool) -> None\n+    # type: (userstate.Timer, create_OutputStream, bool) -> None", "originalCommit": "5b393dbaefaea775bba8f998a679d79bb683777c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQ2NjgxOQ==", "url": "https://github.com/apache/beam/pull/12881#discussion_r492466819", "bodyText": "I think it used to be correct back when timers were being implemented. This code changed a couple of months ago too.", "author": "robertwb", "createdAt": "2020-09-22T04:22:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTU5NTI3Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTU5NjcxNg==", "url": "https://github.com/apache/beam/pull/12881#discussion_r491596716", "bodyText": "Instead of passing around a DoOperation I switched this to a OpInputInfo because the latter is all that we need, and doing so lets us avoid having to assert that it is not None everywhere that it's used.", "author": "chadrik", "createdAt": "2020-09-19T23:15:17Z", "path": "sdks/python/apache_beam/runners/worker/bundle_processor.py", "diffHunk": "@@ -1070,23 +1078,24 @@ def delayed_bundle_application(self,\n     return beam_fn_api_pb2.DelayedBundleApplication(\n         requested_time_delay=proto_deferred_watermark,\n         application=self.construct_bundle_application(\n-            op, current_watermark, element_and_restriction))\n+            op.input_info, current_watermark, element_and_restriction))\n \n   def bundle_application(self,\n                          op,  # type: operations.DoOperation\n                          primary  # type: SplitResultPrimary\n                         ):\n     # type: (...) -> beam_fn_api_pb2.BundleApplication\n-    return self.construct_bundle_application(op, None, primary.primary_value)\n+    assert op.input_info is not None\n+    return self.construct_bundle_application(\n+        op.input_info, None, primary.primary_value)\n \n   def construct_bundle_application(self,\n-                                   op,  # type: operations.DoOperation\n+                                   op_input_info,  # type: operations.OpInputInfo", "originalCommit": "5b393dbaefaea775bba8f998a679d79bb683777c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQ2Nzc5Ng==", "url": "https://github.com/apache/beam/pull/12881#discussion_r492467796", "bodyText": "Sounds good to me.", "author": "robertwb", "createdAt": "2020-09-22T04:27:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTU5NjcxNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTU5NzUwNA==", "url": "https://github.com/apache/beam/pull/12881#discussion_r491597504", "bodyText": "This change indicates that we should return an instance of the class that this is called from, though it provides no runtime guarantees of this.", "author": "chadrik", "createdAt": "2020-09-19T23:17:02Z", "path": "sdks/python/apache_beam/utils/urns.py", "diffHunk": "@@ -177,7 +178,7 @@ def to_runner_api(self, context):\n \n   @classmethod\n   def from_runner_api(cls, fn_proto, context):\n-    # type: (beam_runner_api_pb2.FunctionSpec, PipelineContext) -> Any\n+    # type: (Type[RunnerApiFnT], beam_runner_api_pb2.FunctionSpec, PipelineContext) -> RunnerApiFnT", "originalCommit": "5b393dbaefaea775bba8f998a679d79bb683777c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTU5Nzc2Nw==", "url": "https://github.com/apache/beam/pull/12881#discussion_r491597767", "bodyText": "Now you can see mypy color output from tox!  Let me know if you want me to do this in another PR.", "author": "chadrik", "createdAt": "2020-09-19T23:17:34Z", "path": "sdks/python/tox.ini", "diffHunk": "@@ -27,6 +27,8 @@ select = E3\n \n # Shared environment options.\n [testenv]\n+# allow apps that support color to use it.\n+passenv=TERM", "originalCommit": "5b393dbaefaea775bba8f998a679d79bb683777c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTU5ODQ5Nw==", "url": "https://github.com/apache/beam/pull/12881#discussion_r491598497", "bodyText": "This can in fact contain items which are Tuple[str, str].  see:\n        data_channels[self.timer_data_channel].extend(\n            list(self.timers_info.keys()))", "author": "chadrik", "createdAt": "2020-09-19T23:19:08Z", "path": "sdks/python/apache_beam/runners/worker/bundle_processor.py", "diffHunk": "@@ -947,11 +955,11 @@ def process_bundle(self, instruction_id):\n       # (transform_id, timer_family_id).\n       data_channels = collections.defaultdict(\n           list\n-      )  # type: DefaultDict[data_plane.GrpcClientDataChannel, List[str]]\n+      )  # type: DefaultDict[data_plane.GrpcClientDataChannel, List[Union[str, Tuple[str, str]]]]", "originalCommit": "5b393dbaefaea775bba8f998a679d79bb683777c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQ2NzY2Mg==", "url": "https://github.com/apache/beam/pull/12881#discussion_r492467662", "bodyText": "Yep, this changed a couple of months ago. It'll be good to finally have these type annotations checked.", "author": "robertwb", "createdAt": "2020-09-22T04:26:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTU5ODQ5Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTU5OTM0NQ==", "url": "https://github.com/apache/beam/pull/12881#discussion_r491599345", "bodyText": "we just call len(expected_inputs), so we just need to know this implements __len__", "author": "chadrik", "createdAt": "2020-09-19T23:20:48Z", "path": "sdks/python/apache_beam/runners/worker/data_plane.py", "diffHunk": "@@ -218,7 +249,7 @@ class DataChannel(with_metaclass(abc.ABCMeta, object)):  # type: ignore[misc]\n   @abc.abstractmethod\n   def input_elements(self,\n                      instruction_id,  # type: str\n-                     expected_inputs,  # type: Collection[str]\n+                     expected_inputs,  # type: Sized", "originalCommit": "5b393dbaefaea775bba8f998a679d79bb683777c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQ2OTM0OA==", "url": "https://github.com/apache/beam/pull/12881#discussion_r492469348", "bodyText": "Don't we call __contains__ as well? I'd rather keep it more fully typed.", "author": "robertwb", "createdAt": "2020-09-22T04:35:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTU5OTM0NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQ5ODg1Ng==", "url": "https://github.com/apache/beam/pull/12881#discussion_r492498856", "bodyText": "we only call __len__, but I'm happy to leave it as a collection.  updated.", "author": "chadrik", "createdAt": "2020-09-22T06:28:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTU5OTM0NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTYwMDAxMQ==", "url": "https://github.com/apache/beam/pull/12881#discussion_r491600011", "bodyText": "ClosableOutputStream seems to not actually be used anywhere any more, because ClosableOutputStream.create() returns SizeBasedBufferingClosableOutputStream.  ClosableOutputStream does not implement the necessary maybe_flush method that's required everywhere we were referring to ClosableOutputStream", "author": "chadrik", "createdAt": "2020-09-19T23:22:11Z", "path": "sdks/python/apache_beam/runners/worker/data_plane.py", "diffHunk": "@@ -243,7 +274,7 @@ def output_stream(\n       instruction_id,  # type: str\n       transform_id  # type: str\n   ):\n-    # type: (...) -> ClosableOutputStream\n+    # type: (...) -> SizeBasedBufferingClosableOutputStream", "originalCommit": "5b393dbaefaea775bba8f998a679d79bb683777c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQ2NzE4Ng==", "url": "https://github.com/apache/beam/pull/12881#discussion_r492467186", "bodyText": "We're also thinking about adding a time-based one.\nLet's add a no-op maybe_flush method to the baseclass and keep ClosableOutputStream everywhere.", "author": "robertwb", "createdAt": "2020-09-22T04:24:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTYwMDAxMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQ5Njk1NA==", "url": "https://github.com/apache/beam/pull/12881#discussion_r492496954", "bodyText": "fixed.", "author": "chadrik", "createdAt": "2020-09-22T06:23:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTYwMDAxMQ=="}], "type": "inlineReview"}, {"oid": "d91e77690d15df749255d5801e72c71d206ede1d", "url": "https://github.com/apache/beam/commit/d91e77690d15df749255d5801e72c71d206ede1d", "message": "[BEAM-7746] Get mypy passing on runners.worker", "committedDate": "2020-09-19T23:25:41Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTYwMjk2OA==", "url": "https://github.com/apache/beam/pull/12881#discussion_r491602968", "bodyText": "see this stackoverflow post for an explanation of why I chose this design for a type-safe sentinel.", "author": "chadrik", "createdAt": "2020-09-19T23:28:13Z", "path": "sdks/python/apache_beam/utils/sentinel.py", "diffHunk": "@@ -0,0 +1,30 @@\n+#\n+# Licensed to the Apache Software Foundation (ASF) under one or more\n+# contributor license agreements.  See the NOTICE file distributed with\n+# this work for additional information regarding copyright ownership.\n+# The ASF licenses this file to You under the Apache License, Version 2.0\n+# (the \"License\"); you may not use this file except in compliance with\n+# the License.  You may obtain a copy of the License at\n+#\n+#    http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+#\n+\n+# pytype: skip-file\n+\n+from __future__ import absolute_import\n+\n+import enum\n+\n+\n+class Sentinel(enum.Enum):\n+  \"\"\"\n+  A type-safe sentinel class\n+  \"\"\"\n+\n+  sentinel = object()", "originalCommit": "d91e77690d15df749255d5801e72c71d206ede1d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "b3897827e7d1241f9e2006dc83d7ff905fac66a4", "url": "https://github.com/apache/beam/commit/b3897827e7d1241f9e2006dc83d7ff905fac66a4", "message": "[BEAM-7746] Get mypy passing on runners.worker", "committedDate": "2020-09-20T18:55:56Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTcyMjc1Nw==", "url": "https://github.com/apache/beam/pull/12881#discussion_r491722757", "bodyText": "Removed this annotation because it's invalid:   you can't add annotations to an attribute of another class (non-self attribute).  I've noticed there's definitely a need for a typed version of threading.local.", "author": "chadrik", "createdAt": "2020-09-20T19:02:10Z", "path": "sdks/python/apache_beam/runners/worker/statecache.py", "diffHunk": "@@ -44,15 +48,17 @@ class Metrics(object):\n   PREFIX = \"beam:metric:statecache:\"\n \n   def __init__(self):\n+    # type: () -> None\n     self._context = threading.local()\n \n   def initialize(self):\n+    # type: () -> None\n+\n     \"\"\"Needs to be called once per thread to initialize the local metrics cache.\n     \"\"\"\n     if hasattr(self._context, 'metrics'):\n       return  # Already initialized\n-    self._context.metrics = collections.defaultdict(\n-        int)  # type: DefaultDict[Hashable, int]", "originalCommit": "b3897827e7d1241f9e2006dc83d7ff905fac66a4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTcyMjkzNg==", "url": "https://github.com/apache/beam/pull/12881#discussion_r491722936", "bodyText": "we have to cast here because log_entries was initialized as a List[Union[..., Sentinel]], and just above this line we checked for the sentinel and popped it out, but mypy can't track that.", "author": "chadrik", "createdAt": "2020-09-20T19:04:24Z", "path": "sdks/python/apache_beam/runners/worker/log_handler.py", "diffHunk": "@@ -156,9 +174,11 @@ def _write_log_entries(self):\n         done = True\n         log_entries.pop()\n       if log_entries:\n-        yield beam_fn_api_pb2.LogEntry.List(log_entries=log_entries)\n+        yield beam_fn_api_pb2.LogEntry.List(\n+            log_entries=cast(List[beam_fn_api_pb2.LogEntry], log_entries))", "originalCommit": "b3897827e7d1241f9e2006dc83d7ff905fac66a4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTcyMzM0Ng==", "url": "https://github.com/apache/beam/pull/12881#discussion_r491723346", "bodyText": "Making this a NamedTuple added a bit of sanity, and should be completely safe.", "author": "chadrik", "createdAt": "2020-09-20T19:08:51Z", "path": "sdks/python/apache_beam/runners/worker/bundle_processor.py", "diffHunk": "@@ -1619,7 +1633,7 @@ def _create_pardo_operation(\n       consumers,\n       output_tags)\n   if pardo_proto and pardo_proto.restriction_coder_id:\n-    result.input_info = (\n+    result.input_info = operations.OpInputInfo(", "originalCommit": "b3897827e7d1241f9e2006dc83d7ff905fac66a4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTczNTY1OQ==", "url": "https://github.com/apache/beam/pull/12881#discussion_r491735659", "bodyText": "changing this to a function lets us add annotations which silences a mypy error.  mypy can now detect the key/value types of KeyedDefaultDict", "author": "chadrik", "createdAt": "2020-09-20T21:18:24Z", "path": "sdks/python/apache_beam/runners/worker/sdk_worker.py", "diffHunk": "@@ -174,11 +191,14 @@ def __init__(self,\n     self._state_handler_factory = GrpcStateHandlerFactory(\n         self._state_cache, credentials)\n     self._profiler_factory = profiler_factory\n-    self._fns = KeyedDefaultDict(\n-        lambda id: self._control_stub.GetProcessBundleDescriptor(\n-            beam_fn_api_pb2.GetProcessBundleDescriptorRequest(\n-                process_bundle_descriptor_id=id))\n-    )  # type: Mapping[str, beam_fn_api_pb2.ProcessBundleDescriptor]\n+\n+    def default_factory(id):\n+      # type: (str) -> beam_fn_api_pb2.ProcessBundleDescriptor\n+      return self._control_stub.GetProcessBundleDescriptor(\n+          beam_fn_api_pb2.GetProcessBundleDescriptorRequest(\n+              process_bundle_descriptor_id=id))\n+\n+    self._fns = KeyedDefaultDict(default_factory)", "originalCommit": "b3897827e7d1241f9e2006dc83d7ff905fac66a4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTczNTc0Ng==", "url": "https://github.com/apache/beam/pull/12881#discussion_r491735746", "bodyText": "this attribute eventually gets set to the value of time.time() which is a float.", "author": "chadrik", "createdAt": "2020-09-20T21:19:23Z", "path": "sdks/python/apache_beam/runners/worker/sdk_worker.py", "diffHunk": "@@ -464,16 +496,17 @@ class SdkWorker(object):\n \n   def __init__(self,\n                bundle_processor_cache,  # type: BundleProcessorCache\n-               state_cache_metrics_fn=list,\n+               state_cache_metrics_fn=list,  # type: Callable[[], Iterable[metrics_pb2.MonitoringInfo]]\n                profiler_factory=None,  # type: Optional[Callable[..., Profile]]\n-               log_lull_timeout_ns=None,\n+               log_lull_timeout_ns=None,  # type: Optional[int]\n               ):\n+    # type: (...) -> None\n     self.bundle_processor_cache = bundle_processor_cache\n     self.state_cache_metrics_fn = state_cache_metrics_fn\n     self.profiler_factory = profiler_factory\n     self.log_lull_timeout_ns = (\n         log_lull_timeout_ns or DEFAULT_LOG_LULL_TIMEOUT_NS)\n-    self._last_full_thread_dump_secs = 0\n+    self._last_full_thread_dump_secs = 0.0", "originalCommit": "b3897827e7d1241f9e2006dc83d7ff905fac66a4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQ2Njk0OA==", "url": "https://github.com/apache/beam/pull/12881#discussion_r492466948", "bodyText": "Is this not str or Optional[str]?", "author": "robertwb", "createdAt": "2020-09-22T04:23:30Z", "path": "sdks/python/apache_beam/runners/worker/bundle_processor.py", "diffHunk": "@@ -119,10 +125,10 @@ class RunnerIOOperation(operations.Operation):\n \n   def __init__(self,\n                name_context,  # type: Union[str, common.NameContext]\n-               step_name,\n+               step_name,  # type: Any", "originalCommit": "b3897827e7d1241f9e2006dc83d7ff905fac66a4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQ5NTc3MQ==", "url": "https://github.com/apache/beam/pull/12881#discussion_r492495771", "bodyText": "It looks like this argument isn't used at all any more.\nThe inheritance tree looks like this:\n\noperations.Operation: does not accept a step_name argument\n\nRunnerIOOperation: calls super. does nothing with step_name\n\nDataOutputOperation: does not override __init__\nDataInputOperation:  calls super. does nothing with step_name", "author": "chadrik", "createdAt": "2020-09-22T06:20:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQ2Njk0OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQ2ODUxMw==", "url": "https://github.com/apache/beam/pull/12881#discussion_r492468513", "bodyText": "Why the double Optional (here and elsewhere below)?", "author": "robertwb", "createdAt": "2020-09-22T04:31:01Z", "path": "sdks/python/apache_beam/runners/worker/data_plane.py", "diffHunk": "@@ -81,7 +85,11 @@\n \n class ClosableOutputStream(OutputStream):\n   \"\"\"A Outputstream for use with CoderImpls that has a close() method.\"\"\"\n-  def __init__(self, close_callback=None):\n+  def __init__(\n+      self,\n+      close_callback=None  # type: Optional[Optional[Callable[[bytes], None]]]", "originalCommit": "b3897827e7d1241f9e2006dc83d7ff905fac66a4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQ5Mzc1MQ==", "url": "https://github.com/apache/beam/pull/12881#discussion_r492493751", "bodyText": "mistake.  fixed.", "author": "chadrik", "createdAt": "2020-09-22T06:14:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQ2ODUxMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQ2OTY2NA==", "url": "https://github.com/apache/beam/pull/12881#discussion_r492469664", "bodyText": "I wonder if we should call this encoded_timer[s]?", "author": "robertwb", "createdAt": "2020-09-22T04:36:34Z", "path": "sdks/python/apache_beam/runners/worker/data_plane.py", "diffHunk": "@@ -331,6 +369,7 @@ def add_to_inverse_output(timer):\n                 is_last=False))\n \n     def close_stream(timer):\n+      # type: (bytes) -> None", "originalCommit": "b3897827e7d1241f9e2006dc83d7ff905fac66a4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "f252b9cbf5259f15665b260702d4ee7d61006937", "url": "https://github.com/apache/beam/commit/f252b9cbf5259f15665b260702d4ee7d61006937", "message": "[BEAM-7746] Get mypy passing on runners.worker", "committedDate": "2020-09-22T06:32:05Z", "type": "forcePushed"}, {"oid": "e1483c9c74198b6503ee282bcd27b595b4579f35", "url": "https://github.com/apache/beam/commit/e1483c9c74198b6503ee282bcd27b595b4579f35", "message": "fixes and notes", "committedDate": "2020-09-25T00:41:08Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDY4NzQ0Nw==", "url": "https://github.com/apache/beam/pull/12881#discussion_r494687447", "bodyText": "Note this change and the FIXME.  I'm not sure what to do about this.\nI got complaints that InstructionResponse(process_bundle_progress=...) was receiving the wrong type.  I'm not sure whether this is the right resolution.\nAlso, ProcessBundleProgressMetadataResponse(monitoring_info=...)is also receiving the wrong type.  It's supposed to be a mapping not a list.  Should I change SHORT_ID_CACHE.getInfos to return a dictionary?\nDo you know if this code is being hit?  If so, any theories on how it's working?", "author": "chadrik", "createdAt": "2020-09-25T00:50:44Z", "path": "sdks/python/apache_beam/runners/worker/sdk_worker.py", "diffHunk": "@@ -622,10 +659,12 @@ def process_bundle_progress_metadata_request(self,\n                                                request,  # type: beam_fn_api_pb2.ProcessBundleProgressMetadataRequest\n                                                instruction_id  # type: str\n                                               ):\n+    # type: (...) -> beam_fn_api_pb2.InstructionResponse\n     return beam_fn_api_pb2.InstructionResponse(\n         instruction_id=instruction_id,\n-        process_bundle_progress=beam_fn_api_pb2.\n+        process_bundle_progress_metadata=beam_fn_api_pb2.\n         ProcessBundleProgressMetadataResponse(\n+            # FIXME: incompatible type \"List[MonitoringInfo]\"; expected \"Optional[Mapping[str, Any]]\"\n             monitoring_info=SHORT_ID_CACHE.getInfos(\n                 request.monitoring_info_id)))", "originalCommit": "e1483c9c74198b6503ee282bcd27b595b4579f35", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODU0NTIyNw==", "url": "https://github.com/apache/beam/pull/12881#discussion_r498545227", "bodyText": "This code is not being used currently and it should be a mapping.\nYes, please update getInfos to return that mapping.", "author": "lukecwik", "createdAt": "2020-10-01T22:35:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDY4NzQ0Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDY4ODgyNw==", "url": "https://github.com/apache/beam/pull/12881#discussion_r494688827", "bodyText": "BundleProcessor.ops is OrderedDict[str, operations.Operation].  Should it be OrderedDict[str, operations.DoOperation]?  Or do the transform ids in BundleProcessor.timers_info all point to DoOperations?", "author": "chadrik", "createdAt": "2020-09-25T00:56:23Z", "path": "sdks/python/apache_beam/runners/worker/bundle_processor.py", "diffHunk": "@@ -966,6 +976,7 @@ def process_bundle(self, instruction_id):\n         output_stream = self.timer_data_channel.output_timer_stream(\n             instruction_id, transform_id, timer_family_id)\n         timer_info.output_stream = output_stream\n+        # FIXME: how do we know that self.ops[transform_id] is a DoOperation?\n         self.ops[transform_id].add_timer_info(timer_family_id, timer_info)", "originalCommit": "e1483c9c74198b6503ee282bcd27b595b4579f35", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "64a14e8ccf171d6a961fed1467f96140d2fb71dd", "url": "https://github.com/apache/beam/commit/64a14e8ccf171d6a961fed1467f96140d2fb71dd", "message": "[BEAM-7746] Get mypy passing on runners.worker", "committedDate": "2020-10-02T03:01:13Z", "type": "forcePushed"}, {"oid": "f6dd36bcd52f85e67579738017e5e43ba8fe4900", "url": "https://github.com/apache/beam/commit/f6dd36bcd52f85e67579738017e5e43ba8fe4900", "message": "[BEAM-7746] Get mypy passing on runners.worker", "committedDate": "2020-10-02T16:14:47Z", "type": "forcePushed"}, {"oid": "e3965888db6221998748e50f792815034eeefa07", "url": "https://github.com/apache/beam/commit/e3965888db6221998748e50f792815034eeefa07", "message": "[BEAM-7746] Get mypy passing on runners.worker", "committedDate": "2020-10-02T21:26:29Z", "type": "forcePushed"}, {"oid": "7812f92465dd23d286aae3b34471564f7191763c", "url": "https://github.com/apache/beam/commit/7812f92465dd23d286aae3b34471564f7191763c", "message": "tox: allow apps that support color to use it.", "committedDate": "2020-10-05T19:36:32Z", "type": "commit"}, {"oid": "c0c7c6805cb13653d04addfabf9167aba487f87a", "url": "https://github.com/apache/beam/commit/c0c7c6805cb13653d04addfabf9167aba487f87a", "message": "[BEAM-7746] Fix typing in beam.utils", "committedDate": "2020-10-05T19:36:32Z", "type": "commit"}, {"oid": "7385641e0b8b932dbe7ed8730a342b171657fb4c", "url": "https://github.com/apache/beam/commit/7385641e0b8b932dbe7ed8730a342b171657fb4c", "message": "[BEAM-7746] Get mypy passing on runners.worker", "committedDate": "2020-10-05T19:43:20Z", "type": "commit"}, {"oid": "7385641e0b8b932dbe7ed8730a342b171657fb4c", "url": "https://github.com/apache/beam/commit/7385641e0b8b932dbe7ed8730a342b171657fb4c", "message": "[BEAM-7746] Get mypy passing on runners.worker", "committedDate": "2020-10-05T19:43:20Z", "type": "forcePushed"}]}