{"pr_number": 13503, "pr_title": "[BEAM-11415] In-progress Go ValidatesRunner framework.", "pr_createdAt": "2020-12-08T05:28:54Z", "pr_url": "https://github.com/apache/beam/pull/13503", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTAzMDQyNw==", "url": "https://github.com/apache/beam/pull/13503#discussion_r539030427", "bodyText": "For now, could we use flinkXlangValidatesRunner which at least covers what is in particularly new coverage about this set up. This comment driven by seeing too many vestigial \"new\" implementations that don't get fully migrated.\nTangent, it's generally preferable to rename older implementations to \"old\" than new ones to \"new\" when possible.\nFeel free to disregard if you've already gotten far enough in the consolidation in later commits.", "author": "lostluck", "createdAt": "2020-12-09T05:56:19Z", "path": "sdks/go/test/build.gradle", "diffHunk": "@@ -50,6 +50,25 @@ golang {\n   }\n }\n \n+// A temporary build rule using the newer, under-construction ValidatesRunner\n+// framework rather than the existing one in the integration directory.\n+// TODO(BEAM-11415): Merge this into existing ValidatesRunner gradle rules.\n+task flinkNewValidatesRunner {", "originalCommit": "c39910d82aaa4eff675cdf9c68b0c76b57dd7baa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTc0ODc0OA==", "url": "https://github.com/apache/beam/pull/13503#discussion_r539748748", "bodyText": "I'm alright with that, done.", "author": "youngoli", "createdAt": "2020-12-10T00:22:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTAzMDQyNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTAzMzQwMg==", "url": "https://github.com/apache/beam/pull/13503#discussion_r539033402", "bodyText": "Deduplicate w/the socket script higher up please.", "author": "lostluck", "createdAt": "2020-12-09T06:03:50Z", "path": "sdks/go/test/run_validatesrunner_tests.sh", "diffHunk": "@@ -0,0 +1,174 @@\n+#!/bin/bash\n+#\n+#    Licensed to the Apache Software Foundation (ASF) under one or more\n+#    contributor license agreements.  See the NOTICE file distributed with\n+#    this work for additional information regarding copyright ownership.\n+#    The ASF licenses this file to You under the Apache License, Version 2.0\n+#    (the \"License\"); you may not use this file except in compliance with\n+#    the License.  You may obtain a copy of the License at\n+#\n+#       http://www.apache.org/licenses/LICENSE-2.0\n+#\n+#    Unless required by applicable law or agreed to in writing, software\n+#    distributed under the License is distributed on an \"AS IS\" BASIS,\n+#    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+#    See the License for the specific language governing permissions and\n+#    limitations under the License.\n+\n+# This script executes ValidatesRunner tests including launching any additional\n+# services needed, such as job services or expansion services. The following\n+# runners are supported, and selected via a flag:\n+#\n+# --runner {portable|direct|flink} (default: portable)\n+#  Select which runner to execute tests on. This flag also determines which\n+#  services to start up and which tests may be skipped.\n+#    direct   - Go SDK Direct Runner\n+#    portable - (default) Python Portable Runner (aka. Reference Runner or FnAPI Runner)\n+#    flink    - Java Flink Runner (local mode)\n+#    spark    - Java Spark Runner (local mode)\n+#\n+# --flink_job_server_jar -> Filepath to jar, used if runner is Flink.\n+# --spark_job_server_jar -> Filepath to jar, used if runner is Spark.\n+# --endpoint -> Replaces jar filepath with existing job server endpoint.\n+#\n+# --expansion_service_jar -> Filepath to jar for expansion service.\n+# --expansion_addr -> Replaces jar filepath with existing expansion service endpoint.\n+#\n+# Execute from the root of the repository. This script requires that necessary\n+# services can be built from the repository.\n+\n+set -e\n+set -v\n+\n+RUNNER=portable\n+\n+exit_background_processes () {\n+  if [[ -n \"$JOBSERVER_PID\" ]]; then\n+    kill -s SIGKILL $JOBSERVER_PID\n+  fi\n+  if [[ -n \"$EXPANSION_PID\" ]]; then\n+    kill -s SIGKILL $EXPANSION_PID\n+  fi\n+}\n+trap exit_background_processes SIGINT SIGTERM EXIT\n+\n+while [[ $# -gt 0 ]]\n+do\n+key=\"$1\"\n+case $key in\n+    --runner)\n+        RUNNER=\"$2\"\n+        shift # past argument\n+        shift # past value\n+        ;;\n+    --flink_job_server_jar)\n+        FLINK_JOB_SERVER_JAR=\"$2\"\n+        shift # past argument\n+        shift # past value\n+        ;;\n+    --spark_job_server_jar)\n+        SPARK_JOB_SERVER_JAR=\"$2\"\n+        shift # past argument\n+        shift # past value\n+        ;;\n+    --endpoint)\n+        ENDPOINT=\"$2\"\n+        shift # past argument\n+        shift # past value\n+        ;;\n+    --expansion_service_jar)\n+        EXPANSION_SERVICE_JAR=\"$2\"\n+        shift # past argument\n+        shift # past value\n+        ;;\n+    --expansion_addr)\n+        EXPANSION_ADDR=\"$2\"\n+        shift # past argument\n+        shift # past value\n+        ;;\n+    *)    # unknown option\n+        echo \"Unknown option: $1\"\n+        exit 1\n+        ;;\n+esac\n+done\n+\n+# Go to the root of the repository\n+cd $(git rev-parse --show-toplevel)\n+\n+# Verify in the root of the repository\n+test -d sdks/go/test\n+\n+# Set up environment based on runner.\n+ARGS=--runner=$RUNNER\n+if [[ \"$RUNNER\" == \"flink\" || \"$RUNNER\" == \"spark\" || \"$RUNNER\" == \"portable\" ]]; then\n+  if [[ -z \"$ENDPOINT\" ]]; then\n+    # Hacky python script to find a free port. Note there is a small chance the chosen port could\n+    # get taken before being claimed by the job server.\n+    SOCKET_SCRIPT=\"\n+import socket\n+s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)\n+s.bind(('localhost', 0))\n+print(s.getsockname()[1])\n+s.close()\n+    \"\n+    JOB_PORT=$(python -c \"$SOCKET_SCRIPT\")\n+    ENDPOINT=\"localhost:$JOB_PORT\"\n+    echo \"No endpoint specified; starting a new $RUNNER job server on $ENDPOINT\"\n+    if [[ \"$RUNNER\" == \"flink\" ]]; then\n+      java \\\n+          -jar $FLINK_JOB_SERVER_JAR \\\n+          --flink-master [local] \\\n+          --job-port $JOB_PORT \\\n+          --expansion-port 0 \\\n+          --artifact-port 0 &\n+    elif [[ \"$RUNNER\" == \"spark\" ]]; then\n+      java \\\n+          -jar $SPARK_JOB_SERVER_JAR \\\n+          --spark-master-url local \\\n+          --job-port $JOB_PORT \\\n+          --expansion-port 0 \\\n+          --artifact-port 0 &\n+    elif [[ \"$RUNNER\" == \"portable\" ]]; then\n+      python \\\n+          -m apache_beam.runners.portability.local_job_service_main \\\n+          --port $JOB_PORT &\n+    else\n+      echo \"Unknown runner: $RUNNER\"\n+      exit 1;\n+    fi\n+    JOBSERVER_PID=$!\n+  fi\n+\n+  if [[ -z \"$EXPANSION_ADDR\" ]]; then\n+    SOCKET_SCRIPT=\"\n+import socket\n+s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)\n+s.bind(('localhost', 0))\n+print(s.getsockname()[1])\n+s.close()\n+    \"", "originalCommit": "c39910d82aaa4eff675cdf9c68b0c76b57dd7baa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTc0ODgwOA==", "url": "https://github.com/apache/beam/pull/13503#discussion_r539748808", "bodyText": "Done.", "author": "youngoli", "createdAt": "2020-12-10T00:22:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTAzMzQwMg=="}], "type": "inlineReview"}, {"oid": "e8a9c7be322fe247b0163b6f08d30ac2807a708a", "url": "https://github.com/apache/beam/commit/e8a9c7be322fe247b0163b6f08d30ac2807a708a", "message": "[BEAM-11415] In-progress Go ValidatesRunner framework.\n\nThis commit includes everything I've worked on in the Go ValidatesRunner framework so far, for initial review.\n\nThis creates a new subdirectory, test/validatesrunner, that is intended to just contain a bunch of tests that run and validate lightweight pipelines. It also contains a script that handles starting job servers and expansion services, similar to run_integration_tests.sh, and one initially tested gradle build rule for running it with Flink. Running with the direct runner also works fine, with the command \"go test validatesrunner/... --runner=direct\". Currently, the script has only been confirmed to work with Flink and the direct runner, but it should theoretically work with the Portable runner and Spark as well, once appropriate gradle build rules are figured out.\n\nMost of the contents here are likely to be transient, chances are this will be merged to be an update to the existing integration directory rather than a whole new directory, and will just replace the existing driver approach to the tests. However, this is still valuable to commit as a starting point to the work.", "committedDate": "2020-12-10T00:21:28Z", "type": "commit"}, {"oid": "e8a9c7be322fe247b0163b6f08d30ac2807a708a", "url": "https://github.com/apache/beam/commit/e8a9c7be322fe247b0163b6f08d30ac2807a708a", "message": "[BEAM-11415] In-progress Go ValidatesRunner framework.\n\nThis commit includes everything I've worked on in the Go ValidatesRunner framework so far, for initial review.\n\nThis creates a new subdirectory, test/validatesrunner, that is intended to just contain a bunch of tests that run and validate lightweight pipelines. It also contains a script that handles starting job servers and expansion services, similar to run_integration_tests.sh, and one initially tested gradle build rule for running it with Flink. Running with the direct runner also works fine, with the command \"go test validatesrunner/... --runner=direct\". Currently, the script has only been confirmed to work with Flink and the direct runner, but it should theoretically work with the Portable runner and Spark as well, once appropriate gradle build rules are figured out.\n\nMost of the contents here are likely to be transient, chances are this will be merged to be an update to the existing integration directory rather than a whole new directory, and will just replace the existing driver approach to the tests. However, this is still valuable to commit as a starting point to the work.", "committedDate": "2020-12-10T00:21:28Z", "type": "forcePushed"}]}