{"pr_number": 10629, "pr_title": "[BEAM-9130] Migrate HDFS IT to use tox env.", "pr_createdAt": "2020-01-17T16:42:19Z", "pr_url": "https://github.com/apache/beam/pull/10629", "timeline": [{"oid": "f7cb0c0bbd084c3c7d8a7c5e6bfebcc6c85a7cd8", "url": "https://github.com/apache/beam/commit/f7cb0c0bbd084c3c7d8a7c5e6bfebcc6c85a7cd8", "message": "Migrate HDFS IT to use tox env.", "committedDate": "2020-01-17T16:38:50Z", "type": "commit"}, {"oid": "86a29197f9285bdbd10cbeecd3166d90e1c17a61", "url": "https://github.com/apache/beam/commit/86a29197f9285bdbd10cbeecd3166d90e1c17a61", "message": "Fix for py2", "committedDate": "2020-01-17T17:18:13Z", "type": "commit"}, {"oid": "86a29197f9285bdbd10cbeecd3166d90e1c17a61", "url": "https://github.com/apache/beam/commit/86a29197f9285bdbd10cbeecd3166d90e1c17a61", "message": "Fix for py2", "committedDate": "2020-01-17T17:18:13Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODA1MTcxMQ==", "url": "https://github.com/apache/beam/pull/10629#discussion_r368051711", "bodyText": "so our goal is to install grpcio-tools (and therefore protobuf, one of its deps) into the same python environment where sdist is run, before the tests run.  This is easier said than done.\nInstalling build-requirements.txt here in the dockerfile affects the environment where tox is installed and runs, but i'm not sure if it affects the environments where tox runs sdist, especially if tox is trying to create a temp env to run sdist (which I know it does when it's operating in pep517 mode).\nAdding build-requirements.txt to the deps in tox.ini I think only affects the environment where the tests run, but not where tox runs sdist.\ngen_protos.py also does its own attempt to install build-requirements.txt if it detects grpcio-tools is not installed, but it does it in a weird way with a target install directory, which I think might not be reliable for the google .pth file that makes protobufs importable in python2 (see earlier discussion about site dirs).\nSo, I've got 2 ideas left for how to hack this together without going full pep517:\n\nrun python setup.py sdist here in dockerland, after installing build-requirements, and pass the sdist to tox.  That should guarantee that sdist is run in an env where protobuf is properly installed where the google .pth file will work, since we're installing it into the site-packages of the python interpreter running here, and not some temp dir.\nchange the logic in gen_protos where it installs build-requirements to also ensure that the directory it installs into is added as a site dir, by calling site.addsitedir() on that directory from the environment where we want to be able to import google.protobuf.", "author": "chadrik", "createdAt": "2020-01-17T17:29:39Z", "path": "sdks/python/apache_beam/io/hdfs_integration_test/Dockerfile", "diffHunk": "@@ -24,22 +24,13 @@ FROM $BASE_IMAGE\n \n WORKDIR /app\n ENV HDFSCLI_CONFIG /app/sdks/python/apache_beam/io/hdfs_integration_test/hdfscli.cfg\n-RUN pip install --no-cache-dir holdup gsutil\n-RUN gsutil cp gs://dataflow-samples/shakespeare/kinglear.txt .\n \n-# Install Beam and dependencies.\n-ADD sdks/python /app/sdks/python\n-ADD model /app/model\n-RUN cd sdks/python && \\\n-    python setup.py sdist && \\\n-    pip install --no-cache-dir $(ls dist/apache-beam-*.tar.gz | tail -n1)[gcp]\n+# Add Beam SDK sources.\n+COPY sdks/python /app/sdks/python\n+COPY model /app/model\n+\n+# This step should look like setupVirtualenv minus virtualenv creation.\n+RUN pip install --no-cache-dir tox==3.11.1 -r sdks/python/build-requirements.txt", "originalCommit": "86a29197f9285bdbd10cbeecd3166d90e1c17a61", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODA1MzQ0MA==", "url": "https://github.com/apache/beam/pull/10629#discussion_r368053440", "bodyText": "Ah, I wrote my comment on the previous version of this.  Glad to see that adding the build-requirements here worked.  Like I said I wasn't sure if that would affect how tox runs sdist, since when I was testing with pyproject.toml, it did not, because it was using an isolated build environment.", "author": "chadrik", "createdAt": "2020-01-17T17:34:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODA1MTcxMQ=="}], "type": "inlineReview"}]}