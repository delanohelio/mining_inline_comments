{"pr_number": 11532, "pr_title": "[BEAM-9822] Disable grouping when streaming", "pr_createdAt": "2020-04-27T08:14:18Z", "pr_url": "https://github.com/apache/beam/pull/11532", "timeline": [{"oid": "8b56f4419cdd4f8982f097e6558cd905e09af11e", "url": "https://github.com/apache/beam/commit/8b56f4419cdd4f8982f097e6558cd905e09af11e", "message": "Disable grouping by default when streaming.\n\nGrouping adds significant latency and memory use, and when streaming\nthis causes both OOMs and high pipeline latencies.", "committedDate": "2020-04-27T11:04:50Z", "type": "forcePushed"}, {"oid": "865a11bea55f0c5e8dee77c544ab5215607147a3", "url": "https://github.com/apache/beam/commit/865a11bea55f0c5e8dee77c544ab5215607147a3", "message": "Disable grouping by default when streaming.\n\nGrouping adds significant latency and memory use, and when streaming\nthis causes both OOMs and high pipeline latencies.", "committedDate": "2020-04-27T11:13:22Z", "type": "forcePushed"}, {"oid": "573bfb936940dea91709cdc656c36f41a4715866", "url": "https://github.com/apache/beam/commit/573bfb936940dea91709cdc656c36f41a4715866", "message": "Disable grouping by default when streaming.\n\nGrouping adds significant latency and memory use, and when streaming\nthis causes both OOMs and high pipeline latencies.", "committedDate": "2020-05-01T11:21:53Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODcxMTcyOQ==", "url": "https://github.com/apache/beam/pull/11532#discussion_r418711729", "bodyText": "I was wondering if this condition needs to be based on the input passed to this stage or based on some parameter from the user?", "author": "allenpradeep", "createdAt": "2020-05-01T19:58:38Z", "path": "sdks/java/io/google-cloud-platform/src/main/java/org/apache/beam/sdk/io/gcp/spanner/SpannerIO.java", "diffHunk": "@@ -1066,7 +1079,12 @@ public SpannerWriteResult expand(PCollection<MutationGroup> input) {\n                               spec.getBatchSizeBytes(),\n                               spec.getMaxNumMutations(),\n                               spec.getMaxNumRows(),\n-                              spec.getGroupingFactor(),\n+                              // Do not group on streaming unless explicitly set.\n+                              spec.getGroupingFactor()\n+                                  .orElse(\n+                                      input.isBounded() == IsBounded.BOUNDED", "originalCommit": "573bfb936940dea91709cdc656c36f41a4715866", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjkyOTgxNw==", "url": "https://github.com/apache/beam/pull/11532#discussion_r426929817", "bodyText": "it's kinda both!\nIf the source is unbounded (streaming) -  and the groupingFactor has not been specified by the user, then default to no grouping.", "author": "nielm", "createdAt": "2020-05-18T22:38:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODcxMTcyOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzQyMTU0OA==", "url": "https://github.com/apache/beam/pull/11532#discussion_r427421548", "bodyText": "Is there any chance that someone using SpannerIO in a streaming pipeline is relying on the default grouping factor being 1000? I'm concerned this backwards-incompatible change could break them. Would it be sufficient to just give users the option to disable batching by setting the grouping factor to 1?", "author": "TheNeuralBit", "createdAt": "2020-05-19T16:06:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODcxMTcyOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzQ4NTA4MQ==", "url": "https://github.com/apache/beam/pull/11532#discussion_r427485081", "bodyText": "They already can set groupingFactorb to 1 if they want...\nBreaking backward compatibility: unlikely.\nThe default of 1000 causes OOMs when using streaming, with wide windows, and high throughput... When this happens, it is not always obvious that grouping is the issue...\nWith smaller windows/less throughput, it is much less likely that a group will be filled, (groups are bounded by bundles, which are bounded by windows)., So it is unlikely that anyone ever got to fill the group with 1000 batches.", "author": "nielm", "createdAt": "2020-05-19T17:44:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODcxMTcyOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzU2NjA4MA==", "url": "https://github.com/apache/beam/pull/11532#discussion_r427566080", "bodyText": "They already can set groupingFactorb to 1 if they want...\n\nHa yeah sorry that was unclear. At the time I thought that groupingFactor = 1 enabled the optimization in #11529, so I was wondering if this was really necessary since users could just enable them by setting grouping factor manually. But I see now that grouping is separate from batching. And its disabling batching that enables your other PR.", "author": "TheNeuralBit", "createdAt": "2020-05-19T20:02:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODcxMTcyOQ=="}], "type": "inlineReview"}, {"oid": "cecb959cacadb6748dec50c20ff9282ee82b1347", "url": "https://github.com/apache/beam/commit/cecb959cacadb6748dec50c20ff9282ee82b1347", "message": "Disable grouping by default when streaming.\n\nGrouping adds significant latency and memory use, and when streaming\nthis causes both OOMs and high pipeline latencies.", "committedDate": "2020-05-03T10:13:40Z", "type": "forcePushed"}, {"oid": "9e56c0815ff6f7e56efe1b86089ede5f2b9ef3da", "url": "https://github.com/apache/beam/commit/9e56c0815ff6f7e56efe1b86089ede5f2b9ef3da", "message": "Disable grouping by default when streaming.\n\nGrouping adds significant latency and memory use, and when streaming\nthis causes both OOMs and high pipeline latencies.", "committedDate": "2020-05-18T22:41:00Z", "type": "forcePushed"}, {"oid": "3cc214bf9df6e57d70ee327cb8df3766a0861a0f", "url": "https://github.com/apache/beam/commit/3cc214bf9df6e57d70ee327cb8df3766a0861a0f", "message": "Disable grouping by default when streaming.\n\nGrouping adds significant latency and memory use, and when streaming\nthis causes both OOMs and high pipeline latencies.", "committedDate": "2020-05-18T23:42:34Z", "type": "forcePushed"}, {"oid": "d64df6a95fb818a8eadfad9d3f2fbd4ceac32660", "url": "https://github.com/apache/beam/commit/d64df6a95fb818a8eadfad9d3f2fbd4ceac32660", "message": "Disable grouping by default when streaming.\n\nGrouping adds significant latency and memory use, and when streaming\nthis causes both OOMs and high pipeline latencies.", "committedDate": "2020-05-19T11:06:54Z", "type": "commit"}, {"oid": "d64df6a95fb818a8eadfad9d3f2fbd4ceac32660", "url": "https://github.com/apache/beam/commit/d64df6a95fb818a8eadfad9d3f2fbd4ceac32660", "message": "Disable grouping by default when streaming.\n\nGrouping adds significant latency and memory use, and when streaming\nthis causes both OOMs and high pipeline latencies.", "committedDate": "2020-05-19T11:06:54Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzQwODM2OA==", "url": "https://github.com/apache/beam/pull/11532#discussion_r427408368", "bodyText": "It would be nice if this were another constant. We could have DEFAULT_GROUPING_FACTOR_BOUNDED and DEFAULT_GROUPING_FACTOR_UNBOUNDED. It doesn't need to be done here, could be in a follow-up PR.", "author": "TheNeuralBit", "createdAt": "2020-05-19T15:48:27Z", "path": "sdks/java/io/google-cloud-platform/src/main/java/org/apache/beam/sdk/io/gcp/spanner/SpannerIO.java", "diffHunk": "@@ -1059,7 +1071,12 @@ public SpannerWriteResult expand(PCollection<MutationGroup> input) {\n                               spec.getBatchSizeBytes(),\n                               spec.getMaxNumMutations(),\n                               spec.getMaxNumRows(),\n-                              spec.getGroupingFactor(),\n+                              // Do not group on streaming unless explicitly set.\n+                              spec.getGroupingFactor()\n+                                  .orElse(\n+                                      input.isBounded() == IsBounded.BOUNDED\n+                                          ? DEFAULT_GROUPING_FACTOR\n+                                          : 1),", "originalCommit": "d64df6a95fb818a8eadfad9d3f2fbd4ceac32660", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzQ4NTkzMw==", "url": "https://github.com/apache/beam/pull/11532#discussion_r427485933", "bodyText": "Will do in a separate pr", "author": "nielm", "createdAt": "2020-05-19T17:45:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzQwODM2OA=="}], "type": "inlineReview"}]}