{"pr_number": 12257, "pr_title": "[BEAM-2762] Generate Python coverage reports during pre-commit", "pr_createdAt": "2020-07-14T22:37:23Z", "pr_url": "https://github.com/apache/beam/pull/12257", "timeline": [{"oid": "0c4a318dccee27e2447bdd0c89c2b3e4eea7e5de", "url": "https://github.com/apache/beam/commit/0c4a318dccee27e2447bdd0c89c2b3e4eea7e5de", "message": "Add pytest-cov dependency to the test dependencies", "committedDate": "2020-07-13T23:12:58Z", "type": "commit"}, {"oid": "7e9d684698adbe2654fb59a734553c4f1682c356", "url": "https://github.com/apache/beam/commit/7e9d684698adbe2654fb59a734553c4f1682c356", "message": "Adds call to coverage / codecov integration", "committedDate": "2020-07-14T02:44:38Z", "type": "commit"}, {"oid": "e6bf020e789b20e44e7a27d159915c938b9f9bfa", "url": "https://github.com/apache/beam/commit/e6bf020e789b20e44e7a27d159915c938b9f9bfa", "message": "Move codecov to deps", "committedDate": "2020-07-15T01:34:56Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDczODQxNw==", "url": "https://github.com/apache/beam/pull/12257#discussion_r454738417", "bodyText": "Alternatively, this could be a dependency just for py38-cloud. That would make more sense since no other Tox environment requires coverage. Should I move it?", "author": "saavannanavati", "createdAt": "2020-07-15T01:35:44Z", "path": "sdks/python/setup.py", "diffHunk": "@@ -193,6 +193,8 @@ def get_version():\n     'requests_mock>=1.7,<2.0',\n     'tenacity>=5.0.2,<6.0',\n     'pytest>=4.4.0,<5.0',\n+    # More recent versions of pytest-cov do not support pytest 4.4.0\n+    'pytest-cov==2.9.0',", "originalCommit": "7e9d684698adbe2654fb59a734553c4f1682c356", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "6715c6933e102acaea2aabd4c46e2f80a6331ba8", "url": "https://github.com/apache/beam/commit/6715c6933e102acaea2aabd4c46e2f80a6331ba8", "message": "Move pytest-cov to py38-cloud env", "committedDate": "2020-07-16T21:59:08Z", "type": "commit"}, {"oid": "6e7f5b10f9af60715dadf13643eca8b72b567d4c", "url": "https://github.com/apache/beam/commit/6e7f5b10f9af60715dadf13643eca8b72b567d4c", "message": "Add py38-cloud-coverage env", "committedDate": "2020-07-21T05:59:03Z", "type": "commit"}, {"oid": "bf350e21c47b45f7027fe9b4b699d6e37c5421c1", "url": "https://github.com/apache/beam/commit/bf350e21c47b45f7027fe9b4b699d6e37c5421c1", "message": "Remove unused cover env, and add py38-cloud-coverage to envlist", "committedDate": "2020-07-21T06:02:23Z", "type": "commit"}, {"oid": "5aef112d0d5c8d5eab333d0ca9f199c7a090cc74", "url": "https://github.com/apache/beam/commit/5aef112d0d5c8d5eab333d0ca9f199c7a090cc74", "message": "Add task to gradle", "committedDate": "2020-07-21T19:03:33Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTYyNjA0OA==", "url": "https://github.com/apache/beam/pull/12257#discussion_r459626048", "bodyText": "No need to run testPy38Cloud", "author": "udim", "createdAt": "2020-07-23T17:53:07Z", "path": "sdks/python/test-suites/tox/py38/build.gradle", "diffHunk": "@@ -29,7 +29,10 @@ pythonVersion = '3.8'\n toxTask \"formatter\", \"py3-yapf-check\"\n check.dependsOn formatter\n \n+toxTask \"testPy38CloudCoverage\", \"py38-cloudcoverage\"\n+test.dependsOn \"testPy38CloudCoverage\"\n+\n apply from: \"../common.gradle\"\n \n // TODO(BEAM-8954): Remove this once tox uses isolated builds.\n-testPy38Cython.mustRunAfter testPython38, testPy38Cloud\n+testPy38Cython.mustRunAfter testPython38, testPy38Cloud, testPy38CloudCoverage", "originalCommit": "5aef112d0d5c8d5eab333d0ca9f199c7a090cc74", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "195adf249b9ebffcb17041b40c64156a45ccdf41", "url": "https://github.com/apache/beam/commit/195adf249b9ebffcb17041b40c64156a45ccdf41", "message": "Only runs testPy38CloudCoverage", "committedDate": "2020-07-27T20:02:40Z", "type": "commit"}, {"oid": "266128775420063d5f4ae84914f0b5e1f4510c58", "url": "https://github.com/apache/beam/commit/266128775420063d5f4ae84914f0b5e1f4510c58", "message": "Add dependsOn to gradle", "committedDate": "2020-07-28T23:42:55Z", "type": "commit"}, {"oid": "04e4e8220ca59930c261b02a5998e9671198fe92", "url": "https://github.com/apache/beam/commit/04e4e8220ca59930c261b02a5998e9671198fe92", "message": "Move to py38 gradle", "committedDate": "2020-07-28T23:52:49Z", "type": "commit"}, {"oid": "76ab2bf0fabb73359fd50c8050e8bf0de5f696cc", "url": "https://github.com/apache/beam/commit/76ab2bf0fabb73359fd50c8050e8bf0de5f696cc", "message": "Fix Gradle error", "committedDate": "2020-08-04T18:57:39Z", "type": "commit"}, {"oid": "7cb61b95b449aff1f17befb425ffba00601cae2f", "url": "https://github.com/apache/beam/commit/7cb61b95b449aff1f17befb425ffba00601cae2f", "message": "Fix syntax error", "committedDate": "2020-08-04T19:38:15Z", "type": "commit"}, {"oid": "d59f02bfd10ce96442569570aaff329ed3c4561a", "url": "https://github.com/apache/beam/commit/d59f02bfd10ce96442569570aaff329ed3c4561a", "message": "Move task definition to common", "committedDate": "2020-08-04T23:53:09Z", "type": "commit"}, {"oid": "daff0ae3179f44775920b3701c3dc720fa9a6c98", "url": "https://github.com/apache/beam/commit/daff0ae3179f44775920b3701c3dc720fa9a6c98", "message": "Change suffix", "committedDate": "2020-08-05T06:25:42Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjYwODgzMA==", "url": "https://github.com/apache/beam/pull/12257#discussion_r466608830", "bodyText": "Cool!", "author": "udim", "createdAt": "2020-08-06T18:33:57Z", "path": "sdks/python/test-suites/tox/common.gradle", "diffHunk": "@@ -27,6 +27,13 @@ test.dependsOn \"testPy${pythonVersionSuffix}Cloud\"\n toxTask \"testPy${pythonVersionSuffix}Cython\", \"py${pythonVersionSuffix}-cython\"\n test.dependsOn \"testPy${pythonVersionSuffix}Cython\"\n \n+toxTask \"testPy38CloudCoverage\", \"py38-cloudcoverage\"\n+test.dependsOn \"testPy38CloudCoverage\"\n+\n project.task(\"preCommitPy${pythonVersionSuffix}\") {\n-      dependsOn = [\"testPy${pythonVersionSuffix}Cloud\", \"testPy${pythonVersionSuffix}Cython\"]\n+      if (pythonVersionSuffix.equals('38')) {", "originalCommit": "daff0ae3179f44775920b3701c3dc720fa9a6c98", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjYxMjcxNQ==", "url": "https://github.com/apache/beam/pull/12257#discussion_r466612715", "bodyText": "I think you meant testPy38CloudCoverage", "author": "udim", "createdAt": "2020-08-06T18:41:20Z", "path": "sdks/python/test-suites/tox/py38/build.gradle", "diffHunk": "@@ -32,4 +32,4 @@ check.dependsOn formatter\n apply from: \"../common.gradle\"\n \n // TODO(BEAM-8954): Remove this once tox uses isolated builds.\n-testPy38Cython.mustRunAfter testPython38, testPy38Cloud\n+testPy38Cython.mustRunAfter testPython38, python38CloudCoverage", "originalCommit": "daff0ae3179f44775920b3701c3dc720fa9a6c98", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjYxNDA2OA==", "url": "https://github.com/apache/beam/pull/12257#discussion_r466614068", "bodyText": "Thanks! Fixed", "author": "saavannanavati", "createdAt": "2020-08-06T18:43:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjYxMjcxNQ=="}], "type": "inlineReview"}, {"oid": "5bf65bf8b3387ba47adac8c079fb29c30afe9bd0", "url": "https://github.com/apache/beam/commit/5bf65bf8b3387ba47adac8c079fb29c30afe9bd0", "message": "Fix naming bug", "committedDate": "2020-08-06T18:43:48Z", "type": "commit"}, {"oid": "14d0f87ea9ea38feec1aef63c21efb153873cfa1", "url": "https://github.com/apache/beam/commit/14d0f87ea9ea38feec1aef63c21efb153873cfa1", "message": "Add comment to trigger tests", "committedDate": "2020-08-10T20:19:18Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODk0MzM2OA==", "url": "https://github.com/apache/beam/pull/12257#discussion_r468943368", "bodyText": "CODECOV_TOKEN is the default value, so no need to specify.", "author": "udim", "createdAt": "2020-08-12T00:50:34Z", "path": "sdks/python/tox.ini", "diffHunk": "@@ -172,6 +172,17 @@ extras = test,gcp,interactive,aws\n commands =\n   {toxinidir}/scripts/run_pytest.sh {envname} \"{posargs}\"\n \n+[testenv:py38-cloudcoverage]\n+# More recent versions of pytest-cov do not support pytest 4.4.0\n+deps =\n+  codecov\n+  pytest-cov==2.9.0\n+passenv = GIT_* BUILD_* ghprb* CHANGE_ID BRANCH_NAME JENKINS_* CODECOV_*\n+extras = test,gcp,interactive,aws\n+commands =\n+  {toxinidir}/scripts/run_pytest.sh {envname} \"{posargs}\" --cov=apache_beam\n+  codecov -t CODECOV_TOKEN", "originalCommit": "14d0f87ea9ea38feec1aef63c21efb153873cfa1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODk0Njc0NA==", "url": "https://github.com/apache/beam/pull/12257#discussion_r468946744", "bodyText": "What I mean is that by default it will look at the CODECOV_TOKEN environment variable. The current value being passed is not a UUID.", "author": "udim", "createdAt": "2020-08-12T01:03:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODk0MzM2OA=="}], "type": "inlineReview"}, {"oid": "b249b2c94a03b783dd5513c71b835747e3f785a7", "url": "https://github.com/apache/beam/commit/b249b2c94a03b783dd5513c71b835747e3f785a7", "message": "Use environmental variable for the Codecov token", "committedDate": "2020-08-12T06:34:05Z", "type": "commit"}]}