{"pr_number": 13421, "pr_title": "[BEAM-9602] Add timer family support for python SDK", "pr_createdAt": "2020-11-25T00:09:18Z", "pr_url": "https://github.com/apache/beam/pull/13421", "timeline": [{"oid": "38be5d53da2b3a0165815e004f53da78dd617bbe", "url": "https://github.com/apache/beam/commit/38be5d53da2b3a0165815e004f53da78dd617bbe", "message": "Fix lint", "committedDate": "2020-11-25T02:25:46Z", "type": "forcePushed"}, {"oid": "31bab49570ff4cf3bc43e8d2080f6fb3dc8b12d6", "url": "https://github.com/apache/beam/commit/31bab49570ff4cf3bc43e8d2080f6fb3dc8b12d6", "message": "Fix lint", "committedDate": "2020-11-25T03:41:59Z", "type": "forcePushed"}, {"oid": "f2b40401b47c9f265f73eab6549912905c2026b3", "url": "https://github.com/apache/beam/commit/f2b40401b47c9f265f73eab6549912905c2026b3", "message": "Add MethodWrapper attribute in common.pxd", "committedDate": "2020-11-30T23:37:55Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzc4MzY4Nw==", "url": "https://github.com/apache/beam/pull/13421#discussion_r533783687", "bodyText": "Unnecessary comma?", "author": "boyuanzz", "createdAt": "2020-12-01T23:09:34Z", "path": "sdks/python/apache_beam/runners/worker/bundle_processor.py", "diffHunk": "@@ -643,15 +643,16 @@ def commit(self):\n \n class OutputTimer(userstate.BaseTimer):\n   def __init__(self,\n+               dynamic_timer_tag,  # type: str\n                key,\n-               window,  # type: windowed_value.BoundedWindow\n+               window,  # type: BoundedWindow\n                timestamp,  # type: timestamp.Timestamp\n                paneinfo,  # type: windowed_value.PaneInfo\n                time_domain, # type: str\n                timer_family_id,  # type: str\n                timer_coder_impl,  # type: coder_impl.TimerCoderImpl\n-               output_stream  # type: data_plane.ClosableOutputStream\n-              ):\n+               output_stream,  # type: data_plane.ClosableOutputStream", "originalCommit": "f2b40401b47c9f265f73eab6549912905c2026b3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTQ3NjkxNQ==", "url": "https://github.com/apache/beam/pull/13421#discussion_r535476915", "bodyText": "removed.", "author": "y1chi", "createdAt": "2020-12-03T18:23:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzc4MzY4Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzc5NjMxMQ==", "url": "https://github.com/apache/beam/pull/13421#discussion_r533796311", "bodyText": "You may want to remove the TODO there.", "author": "boyuanzz", "createdAt": "2020-12-01T23:41:17Z", "path": "sdks/python/apache_beam/transforms/userstate.py", "diffHunk": "@@ -188,15 +190,14 @@ def to_runner_api(self, context, key_coder, window_coder):\n class TimerFamilySpec(object):", "originalCommit": "f2b40401b47c9f265f73eab6549912905c2026b3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTQ3NzAyNQ==", "url": "https://github.com/apache/beam/pull/13421#discussion_r535477025", "bodyText": "done.", "author": "y1chi", "createdAt": "2020-12-03T18:23:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzc5NjMxMQ=="}], "type": "inlineReview"}, {"oid": "77a40e58c57ba4130a5661adad86ff37ca981563", "url": "https://github.com/apache/beam/commit/77a40e58c57ba4130a5661adad86ff37ca981563", "message": "Skip timer family test in flink_runner_test", "committedDate": "2020-12-03T20:55:17Z", "type": "forcePushed"}, {"oid": "efb071bd3c6b362843e094b81310ba08534864ba", "url": "https://github.com/apache/beam/commit/efb071bd3c6b362843e094b81310ba08534864ba", "message": "Remove TimerFamilySpec and reuse TimerSpec for dynamic timer", "committedDate": "2020-12-08T19:49:40Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzk0MTgwMA==", "url": "https://github.com/apache/beam/pull/13421#discussion_r537941800", "bodyText": "Would it be better to have separated functions like get_timer(), get_timer_family instead of using a boolean", "author": "boyuanzz", "createdAt": "2020-12-08T00:36:30Z", "path": "sdks/python/apache_beam/runners/direct/direct_userstate.py", "diffHunk": "@@ -225,14 +225,28 @@ def __init__(self, step_context, dofn, key_coder):\n \n     self.cached_states = {}\n     self.cached_timers = {}\n-\n-  def get_timer(self, timer_spec, key, window, timestamp, pane):\n+    self.cached_timer_families = {}\n+\n+  def get_timer(\n+      self,\n+      timer_spec: userstate.TimerSpec,\n+      key,\n+      window,\n+      timestamp,\n+      pane,\n+      is_timer_family=False", "originalCommit": "597da5d0a3c070755340c0179118b140635f0be6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODgyMTE0Mg==", "url": "https://github.com/apache/beam/pull/13421#discussion_r538821142", "bodyText": "I thought about that but it seemed too much code duplication.", "author": "y1chi", "createdAt": "2020-12-08T21:29:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzk0MTgwMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODgyNjQ5OQ==", "url": "https://github.com/apache/beam/pull/13421#discussion_r538826499", "bodyText": "I don't think it will result in too much code duplication: basically splitting your if branch into 2 functions and create one util function for creating cached_key.\nI'm leaning to better readability over saving code duplication.", "author": "boyuanzz", "createdAt": "2020-12-08T21:38:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzk0MTgwMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODgxNjUzMw==", "url": "https://github.com/apache/beam/pull/13421#discussion_r538816533", "bodyText": "If one DoFn defines one TimerSpec and uses it in both TimerParam and TimerFamilyParam, we will have collisions on this spec, right?  And in this case, there is no way to register one callback for timer TimerSpec and one callback for timer family TimerSpec` since we are using maps in in implemetation.\nI'm leaning to keep TimerFamilySpec and use TimerParam for both TimerSpec and TimerFamilySpec, where the prefix field will help us reduce the collision.", "author": "boyuanzz", "createdAt": "2020-12-08T21:21:53Z", "path": "sdks/python/apache_beam/transforms/userstate.py", "diffHunk": "@@ -184,29 +186,6 @@ def to_runner_api(self, context, key_coder, window_coder):\n             coders._TimerCoder(key_coder, window_coder)))\n \n \n-# TODO(BEAM-9602): Provide support for dynamic timer.\n-class TimerFamilySpec(object):", "originalCommit": "efb071bd3c6b362843e094b81310ba08534864ba", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODgyMjk1NQ==", "url": "https://github.com/apache/beam/pull/13421#discussion_r538822955", "bodyText": "Theoretically it should not supported to use same TimerSpec for different DoFnParam so I'm less worried about collision, if it is not apparent to user we can also add validation checks.", "author": "y1chi", "createdAt": "2020-12-08T21:32:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODgxNjUzMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODgyOTIzMg==", "url": "https://github.com/apache/beam/pull/13421#discussion_r538829232", "bodyText": "I'm curious why do you choose TimerSpec -> TimerParam/TimerFamilyParam approach over TimerSpec/TimerFamilySpec -> TimerParam? Overall the API user is using TimerSpec to register on_timer callback, right?", "author": "boyuanzz", "createdAt": "2020-12-08T21:43:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODgxNjUzMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODg0NDk3NQ==", "url": "https://github.com/apache/beam/pull/13421#discussion_r538844975", "bodyText": "My main consideration is that the DoFnParam here implies the API, e.g. if using a_timer=DoFn.TimerParam(timer_spec) it translate to the old timer, if using a_timer=DoFn.TimerFamilyParam(timer_spec) it translates to a dynamic timer with which user can call .get('tag').set(), as for the timer spec it's main purpose is just to specify the name and time domain, eventually they are all mapped to https://github.com/apache/beam/blob/master/model/pipeline/src/main/proto/beam_runner_api.proto#L542, since we only have one model for the timer spec in beam runner api, I think there's also some advantages to just using one kind of timer spec in sdk.", "author": "y1chi", "createdAt": "2020-12-08T22:09:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODgxNjUzMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODg5MzAxMg==", "url": "https://github.com/apache/beam/pull/13421#discussion_r538893012", "bodyText": "Thanks for the explanation! It sounds more like an API decision since implementation details are mostly the same.\nMy preference is:\n    class TimerDoFn(beam.DoFn):\n      timer_spec = userstate.TimerSpec('timer', userstate.TimeDomain.WATERMARK)\n      timer_family_spec = userstate.TimerFamilySpec('timer', userstate.TimeDomain.WATERMARK)\n      def process(self,\n                  element,\n                  timer=beam.DoFn.TimerParam(timer_spec),\n                  timer_map=beam.DoFn.TimerParam(timer_family_spec)):\n\n      @userstate.on_timer(timer_spec)\n      def process_timer(\n          self,\n          ts=beam.DoFn.TimestampParam,\n          timer=beam.DoFn.TimerParam(timer_spec)):\n\n      @userstate.on_timer(timer_family_spec)\n      def process_timer_map(\n          self,\n          ts=beam.DoFn.TimestampParam,\n          dynamic_tag=DoFn.DynamicTagParam,\n          timer_map=beam.DoFn.TimerParam(timer_family_spec)):\nAnd you are proposing the API like:\n    class TimerDoFn(beam.DoFn):\n      timer_spec = userstate.TimerSpec('timer', userstate.TimeDomain.WATERMARK)\n      timer_family_spec = userstate.TimerSpec('timer', userstate.TimeDomain.WATERMARK)\n      def process(self,\n                  element,\n                  timer=beam.DoFn.TimerParam(timer_spec),\n                  timer_map=beam.DoFn.TimerFamilyParam(timer_family_spec)):\n\n      @userstate.on_timer(timer_spec)\n      def process_timer(\n          self,\n          ts=beam.DoFn.TimestampParam,\n          timer=beam.DoFn.TimerParam(timer_spec)):\n\n      @userstate.on_timer(timer_family_spec)\n      def process_timer(\n          self,\n          ts=beam.DoFn.TimestampParam,\n          timer=beam.DoFn.TimerFamilyParam(timer_family_spec)):\nAnd within your preferred API, the suer is not allowed to use the same name for both specs unless you want to additional logic around timer param to add prefix or just throw validation errors.\nDo you think it's a good idea to ask options on dev list?", "author": "boyuanzz", "createdAt": "2020-12-08T23:41:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODgxNjUzMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTU3NDA3MQ==", "url": "https://github.com/apache/beam/pull/13421#discussion_r539574071", "bodyText": "Sounds good, I'll start a thread on dev list.", "author": "y1chi", "createdAt": "2020-12-09T19:11:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODgxNjUzMw=="}], "type": "inlineReview"}, {"oid": "78cbb5d63242bc41a6649a0bda6e5c636f1e0d99", "url": "https://github.com/apache/beam/commit/78cbb5d63242bc41a6649a0bda6e5c636f1e0d99", "message": "Split userstate get_timer() and get_timer_family()", "committedDate": "2020-12-08T22:57:19Z", "type": "forcePushed"}, {"oid": "b04c76293dd05936c6f08ff8876a36ffaf71a48c", "url": "https://github.com/apache/beam/commit/b04c76293dd05936c6f08ff8876a36ffaf71a48c", "message": "Use common RuntimeTimer but extend api for allowing dynamic_timer_tag", "committedDate": "2020-12-10T19:54:21Z", "type": "forcePushed"}, {"oid": "f4c6368a4ceb0192a291a5c4173b1464403a49c8", "url": "https://github.com/apache/beam/commit/f4c6368a4ceb0192a291a5c4173b1464403a49c8", "message": "Use common RuntimeTimer but extend api for allowing dynamic_timer_tag", "committedDate": "2020-12-10T20:22:49Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDU4NzU5Mw==", "url": "https://github.com/apache/beam/pull/13421#discussion_r540587593", "bodyText": "Can we also test:\ndynamic_timer.set(timestamp)\ndynamic_timer.set(timestamp, dynamic_timer_tag='')\nhere, where the later one should override the first one?", "author": "boyuanzz", "createdAt": "2020-12-10T23:54:33Z", "path": "sdks/python/apache_beam/runners/portability/fn_api_runner/fn_runner_test.py", "diffHunk": "@@ -493,6 +493,30 @@ def is_buffered_correctly(actual):\n \n       assert_that(actual, is_buffered_correctly)\n \n+  def test_pardo_dynamic_timer(self):\n+    class DynamicTimerDoFn(beam.DoFn):\n+      dynamic_timer_spec = userstate.TimerSpec(\n+          'dynamic_timer', userstate.TimeDomain.WATERMARK)\n+\n+      def process(\n+          self, element,\n+          dynamic_timer=beam.DoFn.TimerParam(dynamic_timer_spec)):\n+        dynamic_timer.set(element[1], dynamic_timer_tag=element[0])", "originalCommit": "f4c6368a4ceb0192a291a5c4173b1464403a49c8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTEyMTY5NA==", "url": "https://github.com/apache/beam/pull/13421#discussion_r541121694", "bodyText": "Done.", "author": "y1chi", "createdAt": "2020-12-11T17:49:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDU4NzU5Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDU5ODgzNQ==", "url": "https://github.com/apache/beam/pull/13421#discussion_r540598835", "bodyText": "Remove this?", "author": "boyuanzz", "createdAt": "2020-12-11T00:23:11Z", "path": "sdks/python/scripts/generate_pydoc.sh", "diffHunk": "@@ -188,6 +188,7 @@ ignore_identifiers = [\n   # DoFn param inner classes, due to a Sphinx misparsing of inner classes\n   '_StateDoFnParam',\n   '_TimerDoFnParam',\n+  '_TimerFamilyDoFnParam',", "originalCommit": "f4c6368a4ceb0192a291a5c4173b1464403a49c8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTEyMTczMA==", "url": "https://github.com/apache/beam/pull/13421#discussion_r541121730", "bodyText": "Done.", "author": "y1chi", "createdAt": "2020-12-11T17:50:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDU5ODgzNQ=="}], "type": "inlineReview"}, {"oid": "a679babf88e6014abbd64aac5890d7bcdd8dca8e", "url": "https://github.com/apache/beam/commit/a679babf88e6014abbd64aac5890d7bcdd8dca8e", "message": "[BEAM-9602] Add timer family support for python SDK", "committedDate": "2020-12-11T01:20:56Z", "type": "commit"}, {"oid": "a679babf88e6014abbd64aac5890d7bcdd8dca8e", "url": "https://github.com/apache/beam/commit/a679babf88e6014abbd64aac5890d7bcdd8dca8e", "message": "[BEAM-9602] Add timer family support for python SDK", "committedDate": "2020-12-11T01:20:56Z", "type": "forcePushed"}]}