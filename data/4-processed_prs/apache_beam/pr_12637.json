{"pr_number": 12637, "pr_title": "[BEAM-10768] Sleep in time-based flush test to ensure correct ordering.", "pr_createdAt": "2020-08-19T21:49:26Z", "pr_url": "https://github.com/apache/beam/pull/12637", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDE3ODIzMw==", "url": "https://github.com/apache/beam/pull/12637#discussion_r474178233", "bodyText": "I don't think this change updates the test to test the correct expectations since we should be testing that multiple messages are received in order over the channel.\nI believe send doesn't have the correct semantics since we want to have a persistent stream for the life of this test and to control when it gets closed after sending for a specific instruction,transform pair is done.", "author": "lukecwik", "createdAt": "2020-08-20T18:11:11Z", "path": "sdks/python/apache_beam/runners/worker/data_plane_test.py", "diffHunk": "@@ -99,35 +100,33 @@ def send(instruction_id, transform_id, data):\n \n     # Single write.\n     send('0', transform_1, b'abc')\n-    self.assertEqual(\n+    hc.assert_that(", "originalCommit": "98dffcf4ded012d765b606ab5d9a90861583f19e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDE3OTEzMQ==", "url": "https://github.com/apache/beam/pull/12637#discussion_r474179131", "bodyText": "Also, we may want to have a sleep in the time based test to force a flush sometimes between messages (which likely means we should test with more messages).", "author": "lukecwik", "createdAt": "2020-08-20T18:12:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDE3ODIzMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzE2NTY2NA==", "url": "https://github.com/apache/beam/pull/12637#discussion_r487165664", "bodyText": "So is the correct fix to create stream outside of send and re-use it? Or do we need a stream per assertion?", "author": "TheNeuralBit", "createdAt": "2020-09-11T16:46:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDE3ODIzMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzE5MDIzNQ==", "url": "https://github.com/apache/beam/pull/12637#discussion_r487190235", "bodyText": "Yes, the stream should be created outside of send so that its lifetime can be explicitly managed in the test based upon what the test is trying to do.", "author": "lukecwik", "createdAt": "2020-09-11T17:34:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDE3ODIzMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTIwMzMxOA==", "url": "https://github.com/apache/beam/pull/12637#discussion_r491203318", "bodyText": "I implemented some of your suggestions Luke. PTAL", "author": "ibzib", "createdAt": "2020-09-18T21:42:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDE3ODIzMw=="}], "type": "inlineReview"}, {"oid": "97d548ef23a89c892f3809a7ff9473704179b8ce", "url": "https://github.com/apache/beam/commit/97d548ef23a89c892f3809a7ff9473704179b8ce", "message": "[BEAM-10768] Sleep in time-based flush test to ensure correct ordering.", "committedDate": "2020-09-18T21:40:13Z", "type": "commit"}, {"oid": "97d548ef23a89c892f3809a7ff9473704179b8ce", "url": "https://github.com/apache/beam/commit/97d548ef23a89c892f3809a7ff9473704179b8ce", "message": "[BEAM-10768] Sleep in time-based flush test to ensure correct ordering.", "committedDate": "2020-09-18T21:40:13Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjM1OTYxOQ==", "url": "https://github.com/apache/beam/pull/12637#discussion_r492359619", "bodyText": "Why do we need to wait for the flush, shouldn't the earlier stream21.write(b'def') provide the correct ordering?", "author": "lukecwik", "createdAt": "2020-09-21T21:35:20Z", "path": "sdks/python/apache_beam/runners/worker/data_plane_test.py", "diffHunk": "@@ -108,16 +106,28 @@ def send(instruction_id, transform_id, data):\n         ])\n \n     # Multiple interleaved writes to multiple instructions.\n-    send('1', transform_1, b'abc')\n-    send('2', transform_1, b'def')\n+    stream11 = from_channel.output_stream('1', transform_1)\n+    stream11.write(b'abc')\n+    stream21 = from_channel.output_stream('2', transform_1)\n+    stream21.write(b'def')\n+    if not time_based_flush:\n+      stream11.close()\n     self.assertEqual(\n         list(\n             itertools.islice(to_channel.input_elements('1', [transform_1]), 1)),\n         [\n             beam_fn_api_pb2.Elements.Data(\n                 instruction_id='1', transform_id=transform_1, data=b'abc')\n         ])\n-    send('2', transform_2, b'ghi')\n+    if time_based_flush:", "originalCommit": "97d548ef23a89c892f3809a7ff9473704179b8ce", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjM4Njc3OA==", "url": "https://github.com/apache/beam/pull/12637#discussion_r492386778", "bodyText": "Write does not provide ordering guarantees in this case.\nElements are stored in a queue before being sent, to enable batching. Elements aren't added to that queue until the flush callback is invoked. Because the flush callback is invoked periodically starting from when a stream is constructed, there is no guarantee that one stream's callback is called before the other.", "author": "ibzib", "createdAt": "2020-09-21T22:42:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjM1OTYxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjgyODA3OQ==", "url": "https://github.com/apache/beam/pull/12637#discussion_r492828079", "bodyText": "Please add details as comment.", "author": "lukecwik", "createdAt": "2020-09-22T15:25:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjM1OTYxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjgzMjE4NA==", "url": "https://github.com/apache/beam/pull/12637#discussion_r492832184", "bodyText": "I would have expected that from_channel.output_stream would share the same queue of elements across distinct transforms when dealing with the same instruction id instead of multiple different queues with separate flushing characteristics.", "author": "lukecwik", "createdAt": "2020-09-22T15:30:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjM1OTYxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzAwMjAxNA==", "url": "https://github.com/apache/beam/pull/12637#discussion_r493002014", "bodyText": "Please add details as comment.\n\nDone.", "author": "ibzib", "createdAt": "2020-09-22T20:06:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjM1OTYxOQ=="}], "type": "inlineReview"}, {"oid": "a4ea68ced3deb4a6e5ae745dedf8ac65740f79ab", "url": "https://github.com/apache/beam/commit/a4ea68ced3deb4a6e5ae745dedf8ac65740f79ab", "message": "Add comment explaining flush callbacks.", "committedDate": "2020-09-22T20:01:23Z", "type": "commit"}]}