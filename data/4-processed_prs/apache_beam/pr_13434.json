{"pr_number": 13434, "pr_title": "[BEAM-11357] Add annotations to PTransforms and enable them in Go SDK", "pr_createdAt": "2020-11-26T20:14:03Z", "pr_url": "https://github.com/apache/beam/pull/13434", "timeline": [{"oid": "e2d775f4d59aa2d8baf55bfde61e0491165215ce", "url": "https://github.com/apache/beam/commit/e2d775f4d59aa2d8baf55bfde61e0491165215ce", "message": "Add annotation to PTransforms and enable them in Go SDK", "committedDate": "2020-11-25T17:25:29Z", "type": "commit"}, {"oid": "118c52953790210aa8d319654f373f9aba9c7f3b", "url": "https://github.com/apache/beam/commit/118c52953790210aa8d319654f373f9aba9c7f3b", "message": "[BEAM-11357] Add annotations to PTransforms and enable them in Go SDK", "committedDate": "2020-11-26T20:07:35Z", "type": "commit"}, {"oid": "79e7182b154385312282cec6aa8eb1375f914396", "url": "https://github.com/apache/beam/commit/79e7182b154385312282cec6aa8eb1375f914396", "message": "Merge branch 'annotations' of https://github.com/miracvbasaran/beam into annotations", "committedDate": "2020-11-26T20:11:13Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTY0NTEwMA==", "url": "https://github.com/apache/beam/pull/13434#discussion_r535645100", "bodyText": "As discussed on the list, we specifically don't want to use these for resource preferences.", "author": "robertwb", "createdAt": "2020-12-03T21:33:10Z", "path": "model/pipeline/src/main/proto/beam_runner_api.proto", "diffHunk": "@@ -188,6 +188,13 @@ message PTransform {\n   // Transforms that are required to be implemented by a runner must omit this.\n   // All other transforms are required to specify this.\n   string environment_id = 7;\n+\n+  // (Optional) A map from URNs designating a type of annotation, to the\n+  // annotation in binary format. For example, an annotation could indicate\n+  // that this PTransform has specific resource preferences.", "originalCommit": "79e7182b154385312282cec6aa8eb1375f914396", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjMyMTIzMg==", "url": "https://github.com/apache/beam/pull/13434#discussion_r536321232", "bodyText": "I think we should add \"Therefore annotations MUST NOT be used for metadata that can affect correct execution of the transform.\" to to be unambiguous about the intent around this rule. It's easier to relax restrictions than to tighten them up later.", "author": "lostluck", "createdAt": "2020-12-04T19:14:00Z", "path": "model/pipeline/src/main/proto/beam_runner_api.proto", "diffHunk": "@@ -188,6 +188,13 @@ message PTransform {\n   // Transforms that are required to be implemented by a runner must omit this.\n   // All other transforms are required to specify this.\n   string environment_id = 7;\n+\n+  // (Optional) A map from URNs designating a type of annotation, to the\n+  // annotation in binary format. For example, an annotation could indicate\n+  // that this PTransform has specific resource preferences.\n+  //\n+  // A runner MAY ignore types of annotations it doesn't understand.", "originalCommit": "79e7182b154385312282cec6aa8eb1375f914396", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "3e9bf8649e53f7598540c7e42ed5335bb9ded366", "url": "https://github.com/apache/beam/commit/3e9bf8649e53f7598540c7e42ed5335bb9ded366", "message": "Resolve PTransform documentation comments.", "committedDate": "2020-12-30T16:42:08Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTI5ODcyMQ==", "url": "https://github.com/apache/beam/pull/13434#discussion_r555298721", "bodyText": "Indirect is a package function, not a method on Value. You'll need to change this up with\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t\taf := val.Indirect().FieldByName(\"Annotations\")\n          \n          \n            \n            \t\taf := reflect.Indirect(val).FieldByName(\"Annotations\")\n          \n      \n    \n    \n  \n\nhttps://golang.org/pkg/reflect/#Indirect", "author": "lostluck", "createdAt": "2021-01-11T19:51:23Z", "path": "sdks/go/pkg/beam/core/graph/fn.go", "diffHunk": "@@ -104,6 +106,14 @@ func NewFn(fn interface{}) (*Fn, error) {\n \n \tcase reflect.Struct:\n \t\tmethods := make(map[string]*funcx.Fn)\n+\t\tannotations := make(map[string][]byte)\n+\t\taf := val.Indirect().FieldByName(\"Annotations\")", "originalCommit": "3e9bf8649e53f7598540c7e42ed5335bb9ded366", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "4ee7784356e42c76cde55b075e3e19ed2464e238", "url": "https://github.com/apache/beam/commit/4ee7784356e42c76cde55b075e3e19ed2464e238", "message": "Add unit test and resolve reflect.Indirect bug.", "committedDate": "2021-01-13T13:05:33Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NjcwNDI3NA==", "url": "https://github.com/apache/beam/pull/13434#discussion_r556704274", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \treturn f.methods[finishBundleName]f\n          \n          \n            \n            \treturn f.methods[finishBundleName]", "author": "lostluck", "createdAt": "2021-01-13T17:31:46Z", "path": "sdks/go/pkg/beam/core/graph/fn.go", "diffHunk": "@@ -232,7 +242,7 @@ func (f *DoFn) ProcessElementFn() *funcx.Fn {\n \n // FinishBundleFn returns the \"FinishBundle\" function, if present.\n func (f *DoFn) FinishBundleFn() *funcx.Fn {\n-\treturn f.methods[finishBundleName]\n+\treturn f.methods[finishBundleName]f", "originalCommit": "4ee7784356e42c76cde55b075e3e19ed2464e238", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "0af4813a368097e1ac659b08accebdaf1e8d12e8", "url": "https://github.com/apache/beam/commit/0af4813a368097e1ac659b08accebdaf1e8d12e8", "message": "remove spurious f", "committedDate": "2021-01-13T17:31:59Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NjcxMTMwNg==", "url": "https://github.com/apache/beam/pull/13434#discussion_r556711306", "bodyText": "Consider using an Impulse instead, which simplifies the pipe to just the 2 transforms. The element would then be input _ []byte since impulse is traditionally ignored.)\nHowever, I'm not going to worry about it at this juncture, since it would not meaningfully shrink the PR.", "author": "lostluck", "createdAt": "2021-01-13T17:42:38Z", "path": "sdks/go/pkg/beam/pardo_test.go", "diffHunk": "@@ -61,3 +71,65 @@ func TestFormatParDoError(t *testing.T) {\n \t\tt.Errorf(\"formatParDoError(testFunction,2,1) = %v, want = %v\", got, want)\n \t}\n }\n+\n+func TestAnnotations(t *testing.T) {\n+\tm := make(map[string][]byte)\n+\tm[\"privacy_property\"] = []byte(\"differential_privacy\")\n+\tdoFn := &AnnotationsFn{Annotations: m}\n+\n+\tp := NewPipeline()\n+\ts := p.Root()\n+\n+\tvalues := [2]int{0, 1}\n+\tcol := CreateList(s, values)", "originalCommit": "0af4813a368097e1ac659b08accebdaf1e8d12e8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "edef65c5839eb3235f2d6a6311330f4b1169fdde", "url": "https://github.com/apache/beam/commit/edef65c5839eb3235f2d6a6311330f4b1169fdde", "message": "Add annotation method to graph.DoFn", "committedDate": "2021-01-13T18:32:15Z", "type": "commit"}, {"oid": "486bf6bbe5f7ddc4c0eb9740515dfa6b87454589", "url": "https://github.com/apache/beam/commit/486bf6bbe5f7ddc4c0eb9740515dfa6b87454589", "message": "Regen Go Protos", "committedDate": "2021-01-13T18:32:25Z", "type": "commit"}]}