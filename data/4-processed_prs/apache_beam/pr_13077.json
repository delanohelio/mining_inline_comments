{"pr_number": 13077, "pr_title": "[BEAM-9561] Dataframe test infrastructure improvements.", "pr_createdAt": "2020-10-12T22:40:23Z", "pr_url": "https://github.com/apache/beam/pull/13077", "timeline": [{"oid": "5e76e66621e72878da43840af79f4bccba20b95a", "url": "https://github.com/apache/beam/commit/5e76e66621e72878da43840af79f4bccba20b95a", "message": "Unset variables from failed assignments.\n\nThis avoids surprising failures when previous values are used due\nto earlier (and sometimes expected) failures.", "committedDate": "2020-10-12T22:38:31Z", "type": "commit"}, {"oid": "30b003d424b2c395ea7a7d2383e2fa40aaadff74", "url": "https://github.com/apache/beam/commit/30b003d424b2c395ea7a7d2383e2fa40aaadff74", "message": "Track line numbers in test parsing.", "committedDate": "2020-10-12T22:47:45Z", "type": "commit"}, {"oid": "392213ada8ee455d8523bc5de64cd6c164fc7e23", "url": "https://github.com/apache/beam/commit/392213ada8ee455d8523bc5de64cd6c164fc7e23", "message": "Better parsing of multi-line examples.\n\nConsider a closing bracket with the same indentation to be\na continuation of the previous example, not a new example.\n\nWe could do full bracket-matching, but that might be overkill.", "committedDate": "2020-10-12T22:47:45Z", "type": "commit"}, {"oid": "bd1a2a949d1e38a2d32de7216e8a45e2376c5252", "url": "https://github.com/apache/beam/commit/bd1a2a949d1e38a2d32de7216e8a45e2376c5252", "message": "Strip ipython prompts.", "committedDate": "2020-10-12T22:47:45Z", "type": "commit"}, {"oid": "bd1a2a949d1e38a2d32de7216e8a45e2376c5252", "url": "https://github.com/apache/beam/commit/bd1a2a949d1e38a2d32de7216e8a45e2376c5252", "message": "Strip ipython prompts.", "committedDate": "2020-10-12T22:47:45Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjE5MTEzOA==", "url": "https://github.com/apache/beam/pull/13077#discussion_r512191138", "bodyText": "This regex lacks a whitespace after the colon. Not sure if it matters.", "author": "tysonjh", "createdAt": "2020-10-26T18:46:57Z", "path": "sdks/python/apache_beam/dataframe/doctests.py", "diffHunk": "@@ -502,31 +512,33 @@ def is_example_line(line):\n   IMPORT_PANDAS = 'import pandas as pd'\n \n   example_srcs = []\n-  lines = iter(\n-      [line.rstrip()\n-       for line in rst.split('\\n') if is_example_line(line)] + ['END'])\n+  lines = iter([(lineno, line.rstrip()) for lineno,\n+                line in enumerate(rst.split('\\n')) if is_example_line(line)] +\n+               [(None, 'END')])\n \n   # https://ipython.readthedocs.io/en/stable/sphinxext.html\n-  line = next(lines)\n+  lineno, line = next(lines)\n   while True:\n     if line == 'END':\n       break\n     if line.startswith('.. ipython::'):\n-      line = next(lines)\n+      lineno, line = next(lines)\n       indent = get_indent(line)\n       example = []\n-      example_srcs.append(example)\n+      example_srcs.append((lineno, example))\n       while get_indent(line) >= indent:\n         if '@verbatim' in line or ':verbatim:' in line or '@savefig' in line:\n           example_srcs.pop()\n           break\n+        line = re.sub(r'In \\[\\d+\\]: ', '', line)\n+        line = re.sub(r'\\.\\.\\.+:', '', line)", "originalCommit": "bd1a2a949d1e38a2d32de7216e8a45e2376c5252", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjkyNzk0Mg==", "url": "https://github.com/apache/beam/pull/13077#discussion_r512927942", "bodyText": "This is correct, there may not be whitespace following this colon in all cases (but if there is, it's fine to include it as part of the indentation). This is different than the initial prompt.", "author": "robertwb", "createdAt": "2020-10-27T18:20:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjE5MTEzOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjkzMzM5Mg==", "url": "https://github.com/apache/beam/pull/13077#discussion_r512933392", "bodyText": "Ack.", "author": "tysonjh", "createdAt": "2020-10-27T18:29:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjE5MTEzOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjIxNDEyNA==", "url": "https://github.com/apache/beam/pull/13077#discussion_r512214124", "bodyText": "Why did this change? There still seem to be only 5 ipython statements in the RST_IPYTHON rst.", "author": "tysonjh", "createdAt": "2020-10-26T19:27:33Z", "path": "sdks/python/apache_beam/dataframe/doctests_test.py", "diffHunk": "@@ -212,13 +228,21 @@ def test_not_implemented_followed_by_name_error(self):\n     self.assertEqual(result.attempted, 6)\n     self.assertEqual(result.failed, 1)  # Only the very last one.\n \n+  def test_failed_assignment(self):\n+    result = doctests.teststring(\n+        FAILED_ASSIGNMENT,\n+        optionflags=doctest.ELLIPSIS,\n+        not_implemented_ok=True)\n+    self.assertNotEqual(result.attempted, 0)\n+    self.assertEqual(result.failed, 0)\n+\n   def test_rst_ipython(self):\n     try:\n       import IPython\n     except ImportError:\n       raise unittest.SkipTest('IPython not available')\n     result = doctests.test_rst_ipython(RST_IPYTHON, 'test_rst_ipython')\n-    self.assertEqual(result.attempted, 5)\n+    self.assertEqual(result.attempted, 8)", "originalCommit": "bd1a2a949d1e38a2d32de7216e8a45e2376c5252", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjkyOTI0Mw==", "url": "https://github.com/apache/beam/pull/13077#discussion_r512929243", "bodyText": "I added\nfoo(\n    4\n)\n\nplus the re-definition of foo and another invocation foo(5).", "author": "robertwb", "createdAt": "2020-10-27T18:22:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjIxNDEyNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjkzMzc1MQ==", "url": "https://github.com/apache/beam/pull/13077#discussion_r512933751", "bodyText": "OK, thanks. I misunderstood how counting worked here.", "author": "tysonjh", "createdAt": "2020-10-27T18:30:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjIxNDEyNA=="}], "type": "inlineReview"}]}