{"pr_number": 12137, "pr_title": "[BEAM-10392] Attempt to fix/enable detection of rabbitmq:test stuckness.", "pr_createdAt": "2020-06-30T20:20:37Z", "pr_url": "https://github.com/apache/beam/pull/12137", "timeline": [{"oid": "8b871f4ae0fbb6bddddbd4bc2d8791d748c0d3cb", "url": "https://github.com/apache/beam/commit/8b871f4ae0fbb6bddddbd4bc2d8791d748c0d3cb", "message": "[BEAM-10392] Attempt to fix/enable detection of rabbitmq:test stuckness.\n\n* Ensure that the Consumer uses a thread safe object to pass the messages through (Consumer is invoked on a separate thread as per https://rabbitmq.github.io/rabbitmq-java-client/api/current/com/rabbitmq/client/Consumer.html)\n* Add a timeout for the entire test class so we can get a stack trace to narrow down where we are seeing stuckness", "committedDate": "2020-06-30T20:20:28Z", "type": "commit"}, {"oid": "8b871f4ae0fbb6bddddbd4bc2d8791d748c0d3cb", "url": "https://github.com/apache/beam/commit/8b871f4ae0fbb6bddddbd4bc2d8791d748c0d3cb", "message": "[BEAM-10392] Attempt to fix/enable detection of rabbitmq:test stuckness.\n\n* Ensure that the Consumer uses a thread safe object to pass the messages through (Consumer is invoked on a separate thread as per https://rabbitmq.github.io/rabbitmq-java-client/api/current/com/rabbitmq/client/Consumer.html)\n* Add a timeout for the entire test class so we can get a stack trace to narrow down where we are seeing stuckness", "committedDate": "2020-06-30T20:20:28Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODE0Mzg1Ng==", "url": "https://github.com/apache/beam/pull/12137#discussion_r448143856", "bodyText": "nit: I doubt this matters because you only add elements to the received list. but might be safer style to use the same reference instead of calling getReceived() 3 times. Which ensures the exact same snapshot. Up to you if you want to change it.", "author": "ajamato", "createdAt": "2020-07-01T06:32:45Z", "path": "sdks/java/io/rabbitmq/src/test/java/org/apache/beam/sdk/io/rabbitmq/RabbitMqIOTest.java", "diffHunk": "@@ -396,18 +394,18 @@ public void testWriteQueue() throws Exception {\n       connection = connectionFactory.newConnection();\n       channel = connection.createChannel();\n       channel.queueDeclare(\"TEST\", true, false, false, null);\n-      Consumer consumer = new RabbitMqTestUtils.TestConsumer(channel, received);\n+      RabbitMqTestUtils.TestConsumer consumer = new RabbitMqTestUtils.TestConsumer(channel);\n       channel.basicConsume(\"TEST\", true, consumer);\n \n       p.run();\n \n-      while (received.size() < maxNumRecords) {\n+      while (consumer.getReceived().size() < maxNumRecords) {\n         Thread.sleep(500);\n       }\n \n-      assertEquals(maxNumRecords, received.size());\n+      assertEquals(maxNumRecords, consumer.getReceived().size());", "originalCommit": "8b871f4ae0fbb6bddddbd4bc2d8791d748c0d3cb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}