{"pr_number": 11556, "pr_title": "[BEAM-9841] Support finite wait on PortableRunner's PipelineResult", "pr_createdAt": "2020-04-28T14:17:12Z", "pr_url": "https://github.com/apache/beam/pull/11556", "timeline": [{"oid": "87bdc8f4487da21d29736d84760ebf1074f7b0f0", "url": "https://github.com/apache/beam/commit/87bdc8f4487da21d29736d84760ebf1074f7b0f0", "message": "[BEAM-9841] Support finite wait on PortableRunner's PipelineResult\n\nOther runners in the Python SDK support waiting for a finite amount of time on\nthe PipelineResult, and so should PortableRunner.\n\nWe blocked the pipeline before for local executions. Instead, we can handle the\nshutdown via a shutdown hook. This will allow us to use the feature even in\nlocal execution mode.", "committedDate": "2020-04-28T14:34:04Z", "type": "forcePushed"}, {"oid": "74b9e613fa93f23384f7fd3d7037dd3e3734cfac", "url": "https://github.com/apache/beam/commit/74b9e613fa93f23384f7fd3d7037dd3e3734cfac", "message": "[BEAM-9841] Support finite wait on PortableRunner's PipelineResult\n\nOther runners in the Python SDK support waiting for a finite amount of time on\nthe PipelineResult, and so should PortableRunner.\n\nWe blocked the pipeline before for local executions. Instead, we can handle the\nshutdown via a shutdown hook. This will allow us to use the feature even in\nlocal execution mode.", "committedDate": "2020-04-28T15:23:43Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjk3NDkwOA==", "url": "https://github.com/apache/beam/pull/11556#discussion_r416974908", "bodyText": "We prefer the use of Python's with syntax instead of calling wait_until_finish explicitly.", "author": "ibzib", "createdAt": "2020-04-28T23:02:26Z", "path": "sdks/python/apache_beam/runners/portability/portable_runner.py", "diffHunk": "@@ -433,13 +435,12 @@ def run_pipeline(self, pipeline, options):\n         state_stream,\n         cleanup_callbacks)\n     if cleanup_callbacks:\n-      # We wait here to ensure that we run the cleanup callbacks.\n+      # Register an exit handler to ensure cleanup on exit.\n+      atexit.register(functools.partial(result._cleanup, on_exit=True))\n       _LOGGER.info(\n-          'Waiting until the pipeline has finished because the '\n-          'environment \"%s\" has started a component necessary for the '\n-          'execution.',\n+          'Environment \"%s\" has started a component necessary for the '\n+          'execution. Be sure to call wait_until_finish()',", "originalCommit": "74b9e613fa93f23384f7fd3d7037dd3e3734cfac", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjk3NjQzNw==", "url": "https://github.com/apache/beam/pull/11556#discussion_r416976437", "bodyText": "A comment explaining the units for duration (milliseconds?) and that duration=None actually means \"wait forever\" would be helpful. (I find this naming somewhat counter-intuitive, but it's too late to change now.)", "author": "ibzib", "createdAt": "2020-04-28T23:06:28Z", "path": "sdks/python/apache_beam/runners/portability/portable_runner.py", "diffHunk": "@@ -535,7 +537,7 @@ def _last_error_message(self):\n     else:\n       return 'unknown error'\n \n-  def wait_until_finish(self):\n+  def wait_until_finish(self, duration=None):", "originalCommit": "74b9e613fa93f23384f7fd3d7037dd3e3734cfac", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODk0NzU3Mw==", "url": "https://github.com/apache/beam/pull/11556#discussion_r418947573", "bodyText": "Agree that the parameter name/default is not optimally chosen. Added a docstring.", "author": "mxm", "createdAt": "2020-05-02T11:34:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjk3NjQzNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjk3NjcyMw==", "url": "https://github.com/apache/beam/pull/11556#discussion_r416976723", "bodyText": "Please give t and t2 descriptive variable names.", "author": "ibzib", "createdAt": "2020-04-28T23:07:15Z", "path": "sdks/python/apache_beam/runners/portability/portable_runner.py", "diffHunk": "@@ -557,23 +559,47 @@ def read_messages():\n     t.daemon = True\n     t.start()\n \n+    if duration:\n+      t2 = threading.Thread(", "originalCommit": "74b9e613fa93f23384f7fd3d7037dd3e3734cfac", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjk3NzgwNw==", "url": "https://github.com/apache/beam/pull/11556#discussion_r416977807", "bodyText": "with (see above comment)", "author": "ibzib", "createdAt": "2020-04-28T23:10:09Z", "path": "sdks/python/apache_beam/runners/portability/portable_runner.py", "diffHunk": "@@ -557,23 +559,47 @@ def read_messages():\n     t.daemon = True\n     t.start()\n \n+    if duration:\n+      t2 = threading.Thread(\n+          target=functools.partial(self._observe, t),\n+          name='wait_until_finish_state_observer')\n+      t2.daemon = True\n+      t2.start()\n+      start_time = time.time()\n+      duration_secs = duration / 1000\n+      while time.time() - start_time < duration_secs and t2.is_alive():\n+        time.sleep(1)\n+    else:\n+      self._observe(t)\n+\n+    if self._runtime_exception:\n+      raise self._runtime_exception\n+\n+    return self._state\n+\n+  def _observe(self, message_thread):\n     try:\n       for state_response in self._state_stream:\n         self._state = self._runner_api_state_to_pipeline_state(\n             state_response.state)\n         if state_response.state in TERMINAL_STATES:\n           # Wait for any last messages.\n-          t.join(10)\n+          message_thread.join(10)\n           break\n       if self._state != runner.PipelineState.DONE:\n-        raise RuntimeError(\n+        self._runtime_exception = RuntimeError(\n             'Pipeline %s failed in state %s: %s' %\n             (self._job_id, self._state, self._last_error_message()))\n-      return self._state\n+    except Exception as e:\n+      self._runtime_exception = e\n     finally:\n       self._cleanup()\n \n-  def _cleanup(self):\n+  def _cleanup(self, on_exit=False):\n+    if on_exit and self._cleanup_callbacks:\n+      _LOGGER.info(\n+          'Running cleanup on exit. If your local pipeline should continue '\n+          'running, be sure to call pipeline.run().wait_until_finish().')", "originalCommit": "74b9e613fa93f23384f7fd3d7037dd3e3734cfac", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "b00011d47793922a12c3d6c10067154b28e9eab4", "url": "https://github.com/apache/beam/commit/b00011d47793922a12c3d6c10067154b28e9eab4", "message": "[BEAM-9841] Support finite wait on PortableRunner's PipelineResult\n\nOther runners in the Python SDK support waiting for a finite amount of time on\nthe PipelineResult, and so should PortableRunner.\n\nWe blocked the pipeline before for local executions. Instead, we can handle the\nshutdown via a shutdown hook. This will allow us to use the feature even in\nlocal execution mode.", "committedDate": "2020-05-02T11:32:45Z", "type": "commit"}, {"oid": "b00011d47793922a12c3d6c10067154b28e9eab4", "url": "https://github.com/apache/beam/commit/b00011d47793922a12c3d6c10067154b28e9eab4", "message": "[BEAM-9841] Support finite wait on PortableRunner's PipelineResult\n\nOther runners in the Python SDK support waiting for a finite amount of time on\nthe PipelineResult, and so should PortableRunner.\n\nWe blocked the pipeline before for local executions. Instead, we can handle the\nshutdown via a shutdown hook. This will allow us to use the feature even in\nlocal execution mode.", "committedDate": "2020-05-02T11:32:45Z", "type": "forcePushed"}]}