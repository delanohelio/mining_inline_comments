{"pr_number": 12707, "pr_title": "Identify pair-with-none DoFn in CombineGlobally with a named URN.", "pr_createdAt": "2020-08-27T22:19:24Z", "pr_url": "https://github.com/apache/beam/pull/12707", "timeline": [{"oid": "86ec430b7fca5cf3e0aa1077be7bcf3f592cc3f5", "url": "https://github.com/apache/beam/commit/86ec430b7fca5cf3e0aa1077be7bcf3f592cc3f5", "message": "Identify pair-with-none DoFn in CombineGlobally with a named URN.\n\nUnfortunately, this is a bit messy as the Fn's defnition is split across\nboth the ParDo and DoFn instance, and we must maintain backwards compatibility\nwith the legacy runner.  For now only stateless functions are supported,\nbut this mechanism can be extended for arbitrary DoFns.", "committedDate": "2020-08-27T22:16:37Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTQyODkzNA==", "url": "https://github.com/apache/beam/pull/12707#discussion_r479428934", "bodyText": "optional: should this be named serialized_fn or serialized_dofn_data to match the naming in bundle_processor.py?", "author": "yifanmai", "createdAt": "2020-08-28T17:03:05Z", "path": "sdks/python/apache_beam/transforms/core.py", "diffHunk": "@@ -1493,6 +1488,72 @@ def expand(self, pcoll):\n         pcoll.pipeline, self._do_transform, self._tags, self._main_tag)\n \n \n+class DoFnInfo(object):\n+  \"\"\"This class represents the state in the ParDoPayload's function spec,\n+  which is the actual DoFn together with some data required for invoking it.\n+  \"\"\"\n+  @staticmethod\n+  def register_stateless_dofn(urn):\n+    def wrapper(cls):\n+      StatelessDoFnInfo.REGISTERED_DOFNS[urn] = cls\n+      cls._stateless_dofn_urn = urn\n+      return cls\n+\n+    return wrapper\n+\n+  @classmethod\n+  def create(cls, fn, args, kwargs):\n+    if hasattr(fn, '_stateless_dofn_urn'):\n+      assert not args and not kwargs\n+      return StatelessDoFnInfo(fn._stateless_dofn_urn)\n+    else:\n+      return PickledDoFnInfo(cls._pickled_do_fn_info(fn, args, kwargs))\n+\n+  @staticmethod\n+  def from_runner_api(spec, unused_context):\n+    if spec.urn == python_urns.PICKLED_DOFN_INFO:\n+      return PickledDoFnInfo(spec.payload)\n+    elif spec.urn in StatelessDoFnInfo.REGISTERED_DOFNS:\n+      return StatelessDoFnInfo(spec.urn)\n+    else:\n+      raise ValueError('Unexpected DoFn type: %s' % spec.urn)\n+\n+  @staticmethod\n+  def _pickled_do_fn_info(fn, args, kwargs):\n+    # This can be cleaned up once all runners move to portability.\n+    return pickler.dumps((fn, args, kwargs, None, None))\n+\n+  def serialized_data(self):", "originalCommit": "86ec430b7fca5cf3e0aa1077be7bcf3f592cc3f5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTQ2Njk1Mw==", "url": "https://github.com/apache/beam/pull/12707#discussion_r481466953", "bodyText": "Yeah, I'll rename this.", "author": "robertwb", "createdAt": "2020-09-01T22:27:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTQyODkzNA=="}], "type": "inlineReview"}, {"oid": "00fe11cb226f3a54c5feacae3436a7a74de314d3", "url": "https://github.com/apache/beam/commit/00fe11cb226f3a54c5feacae3436a7a74de314d3", "message": "Merge branch 'master' into pair-with-none-urn", "committedDate": "2020-09-01T22:30:35Z", "type": "commit"}, {"oid": "669ef25827ebce79b74c6f8f44b6523727681b99", "url": "https://github.com/apache/beam/commit/669ef25827ebce79b74c6f8f44b6523727681b99", "message": "fix reverse translation", "committedDate": "2020-09-01T22:40:21Z", "type": "commit"}, {"oid": "59edd8f44e43dea73810ad7ad8e977c1136bc7dd", "url": "https://github.com/apache/beam/commit/59edd8f44e43dea73810ad7ad8e977c1136bc7dd", "message": "rename", "committedDate": "2020-09-01T22:51:54Z", "type": "commit"}, {"oid": "4d7edca25cf351ca86aa22dcd18e98e3e6e62ad7", "url": "https://github.com/apache/beam/commit/4d7edca25cf351ca86aa22dcd18e98e3e6e62ad7", "message": "lint", "committedDate": "2020-09-01T22:53:23Z", "type": "commit"}, {"oid": "6f832d99193ac641cf7a62408421e3407874c5df", "url": "https://github.com/apache/beam/commit/6f832d99193ac641cf7a62408421e3407874c5df", "message": "fix sensitive test", "committedDate": "2020-09-03T16:01:43Z", "type": "commit"}]}