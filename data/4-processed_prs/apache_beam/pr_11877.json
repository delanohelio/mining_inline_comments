{"pr_number": 11877, "pr_title": "[BEAM-10184] Build python wheels on GitHub Actions for Linux/MacOS", "pr_createdAt": "2020-06-01T14:17:37Z", "pr_url": "https://github.com/apache/beam/pull/11877", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzQ2MTUxMQ==", "url": "https://github.com/apache/beam/pull/11877#discussion_r433461511", "bodyText": "Should we pin the version of python here?", "author": "epicfaace", "createdAt": "2020-06-01T20:08:18Z", "path": ".github/workflows/build_wheels.yml", "diffHunk": "@@ -0,0 +1,91 @@\n+on: [push]\n+name: Build python wheels\n+\n+\n+jobs:\n+\n+  build_source:\n+    runs-on: ubuntu-18.04\n+    steps:\n+      - name: Checkout code\n+        uses: actions/checkout@v2\n+      - name: Install python\n+        uses: actions/setup-python@v1", "originalCommit": "4c564874666d4b1fb691a3b557d506b11b8d86d5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzc1OTE4MA==", "url": "https://github.com/apache/beam/pull/11877#discussion_r433759180", "bodyText": "Yes, we should :) thanks for pointing it out, I missed it.\nGitHub Actions documentations says here:\n\nWe recommend using setup-python to configure the version of Python used in your workflows because it helps make your dependencies explicit.", "author": "TobKed", "createdAt": "2020-06-02T09:55:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzQ2MTUxMQ=="}], "type": "inlineReview"}, {"oid": "557209a3e876d489d52d05c85c3a89a5aba48ed5", "url": "https://github.com/apache/beam/commit/557209a3e876d489d52d05c85c3a89a5aba48ed5", "message": "Build python wheels on GItHub actions for Linux and MacOS", "committedDate": "2020-06-03T13:28:33Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDcyMTA5OQ==", "url": "https://github.com/apache/beam/pull/11877#discussion_r434721099", "bodyText": "@tvalentyn - is py3.8 ready to be added here?", "author": "aaltay", "createdAt": "2020-06-03T17:02:56Z", "path": ".github/workflows/build_wheels.yml", "diffHunk": "@@ -0,0 +1,141 @@\n+name: Build python wheels\n+\n+on:\n+  push:\n+    branches:\n+      - master\n+      - release-*\n+    tags:\n+      - v*\n+\n+jobs:\n+\n+  build_source:\n+    runs-on: ubuntu-18.04\n+    steps:\n+      - name: Checkout code\n+        uses: actions/checkout@v2\n+      - name: Install python\n+        uses: actions/setup-python@v2\n+        with:\n+          python-version: 3.7\n+      - name: Get build dependencies\n+        working-directory: ./sdks/python\n+        run: python3 -m pip install cython && python3 -m pip install -r build-requirements.txt\n+      - name: Install wheels\n+        run: python3 -m pip install wheel\n+      - name: Buld source\n+        working-directory: ./sdks/python\n+        run: python3 setup.py sdist --formats=gztar,zip\n+      - name: Unzip source\n+        working-directory: ./sdks/python\n+        run: unzip dist/$(ls dist | grep .zip | head -n 1)\n+      - name: Rename source directory\n+        working-directory: ./sdks/python\n+        run: mv $(ls | grep apache-beam) apache-beam-source\n+      - name: Upload source\n+        uses: actions/upload-artifact@v2\n+        with:\n+          name: source\n+          path: sdks/python/apache-beam-source\n+      - name: Upload compressed sources\n+        uses: actions/upload-artifact@v2\n+        with:\n+          name: source_gztar_zip\n+          path: sdks/python/dist\n+\n+  prepare_gcs:\n+    name: Prepare GCS\n+    needs: build_source\n+    runs-on: ubuntu-18.04\n+    steps:\n+      - name: Authenticate on GCP\n+        uses: GoogleCloudPlatform/github-actions/setup-gcloud@master\n+        with:\n+          service_account_email: ${{ secrets.CCP_SA_EMAIL }}\n+          service_account_key: ${{ secrets.CCP_SA_KEY }}\n+      - name: Remove existing files on GCS bucket\n+        run: gsutil rm -r \"gs://${{ secrets.CCP_BUCKET }}/${GITHUB_REF##*/}/\" || true\n+\n+  upload_source_to_gcs:\n+    name: Upload source to GCS bucket\n+    needs: prepare_gcs\n+    runs-on: ubuntu-18.04\n+    steps:\n+      - name: Download wheels\n+        uses: actions/download-artifact@v2\n+        with:\n+          name: source_gztar_zip\n+          path: source/\n+      - name: Authenticate on GCP\n+        uses: GoogleCloudPlatform/github-actions/setup-gcloud@master\n+        with:\n+          service_account_email: ${{ secrets.CCP_SA_EMAIL }}\n+          service_account_key: ${{ secrets.CCP_SA_KEY }}\n+      - name: Copy sources to GCS bucket\n+        run: gsutil cp -r -a public-read source/* gs://${{ secrets.CCP_BUCKET }}/${GITHUB_REF##*/}/\n+      - name: List sources on GCS bucket\n+        run: |\n+          gsutil ls \"gs://${{ secrets.CCP_BUCKET }}/${GITHUB_REF##*/}/*.tar.gz\"\n+          gsutil ls \"gs://${{ secrets.CCP_BUCKET }}/${GITHUB_REF##*/}/*.zip\"\n+\n+  build_wheels:\n+    name: Build wheels on ${{ matrix.os }}\n+    needs: prepare_gcs\n+    runs-on: ${{ matrix.os }}\n+    strategy:\n+      matrix:\n+        os : [ubuntu-18.04, macos-10.15]\n+    steps:\n+    - name: Download source\n+      uses: actions/download-artifact@v2\n+      with:\n+        name: source\n+        path: apache-beam-source\n+    - name: Install Python\n+      uses: actions/setup-python@v2\n+      with:\n+        python-version: 3.7\n+    - name: Install packages on Mac\n+      if: startsWith(matrix.os, 'macos')\n+      run: |\n+        brew update\n+        brew install pkg-config\n+    - name: Install cibuildwheel\n+      run: pip install cibuildwheel==1.4.2\n+    - name: Build wheel\n+      working-directory: apache-beam-source\n+      env:\n+        CIBW_BUILD: cp27-* cp35-* cp36-* cp37-*", "originalCommit": "c9282b21d37ab619cb647b509c791f9d0cfeed69", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDc3OTY4MQ==", "url": "https://github.com/apache/beam/pull/11877#discussion_r434779681", "bodyText": "Yes, let's add py3.8. Thanks.", "author": "tvalentyn", "createdAt": "2020-06-03T18:45:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDcyMTA5OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQwNDIwMg==", "url": "https://github.com/apache/beam/pull/11877#discussion_r435404202", "bodyText": "Sure, I will add it \ud83d\udc4d", "author": "TobKed", "createdAt": "2020-06-04T16:50:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDcyMTA5OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDcyMTc1Nw==", "url": "https://github.com/apache/beam/pull/11877#discussion_r434721757", "bodyText": "I am not familiar with github ci. This is a question for my learning. Does each build step (job?) work in a different os environment?", "author": "aaltay", "createdAt": "2020-06-03T17:04:03Z", "path": ".github/workflows/build_wheels.yml", "diffHunk": "@@ -0,0 +1,141 @@\n+name: Build python wheels\n+\n+on:\n+  push:\n+    branches:\n+      - master\n+      - release-*\n+    tags:\n+      - v*\n+\n+jobs:\n+\n+  build_source:\n+    runs-on: ubuntu-18.04", "originalCommit": "c9282b21d37ab619cb647b509c791f9d0cfeed69", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTE5MDQ0OQ==", "url": "https://github.com/apache/beam/pull/11877#discussion_r435190449", "bodyText": "You can specify the runner type for each job in a workflow. Each job in a workflow executes in a fresh instance of the virtual machine. All steps in the job execute in the same instance of the virtual machine, allowing the actions in that job to share information using the filesystem.\n\nsource: https://help.github.com/en/actions/reference/virtual-environments-for-github-hosted-runners", "author": "TobKed", "createdAt": "2020-06-04T11:42:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDcyMTc1Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDcyMjc3MA==", "url": "https://github.com/apache/beam/pull/11877#discussion_r434722770", "bodyText": "Should we use ubuntu-20.04 instead?\n(Apparently this is now supported: actions/virtual-environments#228)", "author": "aaltay", "createdAt": "2020-06-03T17:05:53Z", "path": ".github/workflows/build_wheels.yml", "diffHunk": "@@ -0,0 +1,141 @@\n+name: Build python wheels\n+\n+on:\n+  push:\n+    branches:\n+      - master\n+      - release-*\n+    tags:\n+      - v*\n+\n+jobs:\n+\n+  build_source:\n+    runs-on: ubuntu-18.04", "originalCommit": "c9282b21d37ab619cb647b509c791f9d0cfeed69", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTE5Mjk3MA==", "url": "https://github.com/apache/beam/pull/11877#discussion_r435192970", "bodyText": "I found information in the documentation (source) which says:\n\nNote: The Ubuntu 20.04 virtual environment is currently provided as a preview only. The ubuntu-latest YAML workflow label still uses the Ubuntu 18.04 virtual environment.\n\nIn this case using ubuntu-latest label may be a good idea. WDYT?", "author": "TobKed", "createdAt": "2020-06-04T11:48:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDcyMjc3MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDcyNDE1Nw==", "url": "https://github.com/apache/beam/pull/11877#discussion_r434724157", "bodyText": "What does this do? Is it re-compressing the source folder. I wonder if we can use the sdist output as it?\n(Ideally the resulting GCS output look something close enoguh to a release output, e.g. https://dist.apache.org/repos/dist/release/beam/2.21.0/python/ )", "author": "aaltay", "createdAt": "2020-06-03T17:08:18Z", "path": ".github/workflows/build_wheels.yml", "diffHunk": "@@ -0,0 +1,141 @@\n+name: Build python wheels\n+\n+on:\n+  push:\n+    branches:\n+      - master\n+      - release-*\n+    tags:\n+      - v*\n+\n+jobs:\n+\n+  build_source:\n+    runs-on: ubuntu-18.04\n+    steps:\n+      - name: Checkout code\n+        uses: actions/checkout@v2\n+      - name: Install python\n+        uses: actions/setup-python@v2\n+        with:\n+          python-version: 3.7\n+      - name: Get build dependencies\n+        working-directory: ./sdks/python\n+        run: python3 -m pip install cython && python3 -m pip install -r build-requirements.txt\n+      - name: Install wheels\n+        run: python3 -m pip install wheel\n+      - name: Buld source\n+        working-directory: ./sdks/python\n+        run: python3 setup.py sdist --formats=gztar,zip\n+      - name: Unzip source\n+        working-directory: ./sdks/python\n+        run: unzip dist/$(ls dist | grep .zip | head -n 1)\n+      - name: Rename source directory\n+        working-directory: ./sdks/python\n+        run: mv $(ls | grep apache-beam) apache-beam-source\n+      - name: Upload source\n+        uses: actions/upload-artifact@v2\n+        with:\n+          name: source\n+          path: sdks/python/apache-beam-source\n+      - name: Upload compressed sources\n+        uses: actions/upload-artifact@v2\n+        with:\n+          name: source_gztar_zip", "originalCommit": "c9282b21d37ab619cb647b509c791f9d0cfeed69", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTIwMzA5Mg==", "url": "https://github.com/apache/beam/pull/11877#discussion_r435203092", "bodyText": "It is uploading sdist output (zip,tag.gz) files as artifacts where they are picked up by upload_source_to_gcs jobs. An additional advantage of the artifacts is fact that they can be downloaded from GitHub Actions workflow web view as well.\nExample of  GCS output for build_source -> upload_source_to_gcs jobs:\ngs://**/apache-beam-2.23.0.dev0.tar.gz\ngs://**/apache-beam-2.23.0.dev0.zip\n\nhere you can check GitHub Action which ran on my fork.\nWheel files (*.whl) are processed accordingly by build_wheels -> upload_wheels_to_gcs jobs.\nExample of GCS output at the end of the workflow:\ngs://**/apache-beam-2.23.0.dev0.tar.gz\ngs://**/apache-beam-2.23.0.dev0.zip\ngs://**/apache_beam-2.23.0.dev0-cp27-cp27m-macosx_10_9_x86_64.whl\ngs://**/apache_beam-2.23.0.dev0-cp27-cp27m-manylinux1_i686.whl\ngs://**/apache_beam-2.23.0.dev0-cp27-cp27m-manylinux1_x86_64.whl\ngs://**/apache_beam-2.23.0.dev0-cp27-cp27m-manylinux2010_i686.whl\ngs://**/apache_beam-2.23.0.dev0-cp27-cp27m-manylinux2010_x86_64.whl\ngs://**/apache_beam-2.23.0.dev0-cp27-cp27mu-manylinux1_i686.whl\ngs://**/apache_beam-2.23.0.dev0-cp27-cp27mu-manylinux1_x86_64.whl\ngs://**/apache_beam-2.23.0.dev0-cp27-cp27mu-manylinux2010_i686.whl\ngs://**/apache_beam-2.23.0.dev0-cp27-cp27mu-manylinux2010_x86_64.whl\ngs://**/apache_beam-2.23.0.dev0-cp35-cp35m-macosx_10_9_x86_64.whl\ngs://**/apache_beam-2.23.0.dev0-cp35-cp35m-manylinux1_i686.whl\ngs://**/apache_beam-2.23.0.dev0-cp35-cp35m-manylinux1_x86_64.whl\ngs://**/apache_beam-2.23.0.dev0-cp35-cp35m-manylinux2010_i686.whl\ngs://**/apache_beam-2.23.0.dev0-cp35-cp35m-manylinux2010_x86_64.whl\ngs://**/apache_beam-2.23.0.dev0-cp36-cp36m-macosx_10_9_x86_64.whl\ngs://**/apache_beam-2.23.0.dev0-cp36-cp36m-manylinux1_i686.whl\ngs://**/apache_beam-2.23.0.dev0-cp36-cp36m-manylinux1_x86_64.whl\ngs://**/apache_beam-2.23.0.dev0-cp36-cp36m-manylinux2010_i686.whl\ngs://**/apache_beam-2.23.0.dev0-cp36-cp36m-manylinux2010_x86_64.whl\ngs://**/apache_beam-2.23.0.dev0-cp37-cp37m-macosx_10_9_x86_64.whl\ngs://**/apache_beam-2.23.0.dev0-cp37-cp37m-manylinux1_i686.whl\ngs://**/apache_beam-2.23.0.dev0-cp37-cp37m-manylinux1_x86_64.whl\ngs://**/apache_beam-2.23.0.dev0-cp37-cp37m-manylinux2010_i686.whl\ngs://**/apache_beam-2.23.0.dev0-cp37-cp37m-manylinux2010_x86_64.whl", "author": "TobKed", "createdAt": "2020-06-04T12:08:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDcyNDE1Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTYzMDgyMw==", "url": "https://github.com/apache/beam/pull/11877#discussion_r435630823", "bodyText": "Very nice.\n2 follow up questions:\n\nCan we add a very last stage that can run: gsutil ls \"gs://*/$GITHUB_REF##//\" -> so that we can get the whole output of the gcs folder all at once.\n\n(btw, do we have a mechanism to clean up these gcs locations?)\n\nWhat is the difference between \"Build python wheels / Build wheels on ...\" job executing \"Upload wheels\" step and \"Upload wheels to GCS bucket ...\" job?", "author": "aaltay", "createdAt": "2020-06-05T00:40:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDcyNDE1Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjA2NzYzOA==", "url": "https://github.com/apache/beam/pull/11877#discussion_r436067638", "bodyText": "Currently two steps: List sources on GCS bucket and Copy wheels to GCS bucket are listing files of specific types. Instead of this two separate steps I could create job which will list all files in specific gcs folder. I think it would be much cleaner and explicit. Did I understand correctly your idea?\n\nAbout cleaning up these GCS locations I consider two options:\n\nsetting lifecycle management on the bucket which will delete files older than some arbitrary age, e.g. 365 days. I think advantage of this is that will be maintenance free.\ncreating another scheduled workflow on github actions which will delete gcs folders if corresponding branch does not exist anymore. Could be scheduled to run e.g. once pre week.\n\nWhich option has more sense for you?\n\n\"Upload\" steps perform file upload as artifacts so they could be passed between jobs and being available for download for 90 days (if not deleted earlier). These artifacts are picked up later by \"Upload to GCS\" jobs. What do you think about renaming these steps e.g.: \"Upload wheels\" -> \"Upload wheels as artifacts\" ?", "author": "TobKed", "createdAt": "2020-06-05T17:39:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDcyNDE1Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjU5NDk4OQ==", "url": "https://github.com/apache/beam/pull/11877#discussion_r442594989", "bodyText": "Sorry, I missed this earlier.\n\nI think it would be much cleaner and explicit. Did I understand correctly your idea?\nYes. Your understanding is correct. This sounds good to me.\n\n\nClean up:\nBoth options are good. Can we do both?\n\n\nWhat do you think about renaming these steps e.g.: \"Upload wheels\" -> \"Upload wheels as artifacts\" ?\nSounds good.", "author": "aaltay", "createdAt": "2020-06-19T02:15:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDcyNDE1Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzUwNjQ2Mw==", "url": "https://github.com/apache/beam/pull/11877#discussion_r443506463", "bodyText": "I think it would be much cleaner and explicit. Did I understand correctly your idea?\nYes. Your understanding is correct. This sounds good to me.\n\nI renamed steps. Please take a look is there no mistakes.\n\nClean up:\nBoth options are good. Can we do both?\n\nSure. We can do both.\nRelated to versioning and lifecycle management: I added information in the PR description.\nFor periodic cleaning tasks I created separate dependent draft PR: #12049", "author": "TobKed", "createdAt": "2020-06-22T11:57:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDcyNDE1Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDcyNzcwNQ==", "url": "https://github.com/apache/beam/pull/11877#discussion_r434727705", "bodyText": "Are we planning to add windows here or to another file?", "author": "aaltay", "createdAt": "2020-06-03T17:14:42Z", "path": ".github/workflows/build_wheels.yml", "diffHunk": "@@ -0,0 +1,141 @@\n+name: Build python wheels\n+\n+on:\n+  push:\n+    branches:\n+      - master\n+      - release-*\n+    tags:\n+      - v*\n+\n+jobs:\n+\n+  build_source:\n+    runs-on: ubuntu-18.04\n+    steps:\n+      - name: Checkout code\n+        uses: actions/checkout@v2\n+      - name: Install python\n+        uses: actions/setup-python@v2\n+        with:\n+          python-version: 3.7\n+      - name: Get build dependencies\n+        working-directory: ./sdks/python\n+        run: python3 -m pip install cython && python3 -m pip install -r build-requirements.txt\n+      - name: Install wheels\n+        run: python3 -m pip install wheel\n+      - name: Buld source\n+        working-directory: ./sdks/python\n+        run: python3 setup.py sdist --formats=gztar,zip\n+      - name: Unzip source\n+        working-directory: ./sdks/python\n+        run: unzip dist/$(ls dist | grep .zip | head -n 1)\n+      - name: Rename source directory\n+        working-directory: ./sdks/python\n+        run: mv $(ls | grep apache-beam) apache-beam-source\n+      - name: Upload source\n+        uses: actions/upload-artifact@v2\n+        with:\n+          name: source\n+          path: sdks/python/apache-beam-source\n+      - name: Upload compressed sources\n+        uses: actions/upload-artifact@v2\n+        with:\n+          name: source_gztar_zip\n+          path: sdks/python/dist\n+\n+  prepare_gcs:\n+    name: Prepare GCS\n+    needs: build_source\n+    runs-on: ubuntu-18.04\n+    steps:\n+      - name: Authenticate on GCP\n+        uses: GoogleCloudPlatform/github-actions/setup-gcloud@master\n+        with:\n+          service_account_email: ${{ secrets.CCP_SA_EMAIL }}\n+          service_account_key: ${{ secrets.CCP_SA_KEY }}\n+      - name: Remove existing files on GCS bucket\n+        run: gsutil rm -r \"gs://${{ secrets.CCP_BUCKET }}/${GITHUB_REF##*/}/\" || true\n+\n+  upload_source_to_gcs:\n+    name: Upload source to GCS bucket\n+    needs: prepare_gcs\n+    runs-on: ubuntu-18.04\n+    steps:\n+      - name: Download wheels\n+        uses: actions/download-artifact@v2\n+        with:\n+          name: source_gztar_zip\n+          path: source/\n+      - name: Authenticate on GCP\n+        uses: GoogleCloudPlatform/github-actions/setup-gcloud@master\n+        with:\n+          service_account_email: ${{ secrets.CCP_SA_EMAIL }}\n+          service_account_key: ${{ secrets.CCP_SA_KEY }}\n+      - name: Copy sources to GCS bucket\n+        run: gsutil cp -r -a public-read source/* gs://${{ secrets.CCP_BUCKET }}/${GITHUB_REF##*/}/\n+      - name: List sources on GCS bucket\n+        run: |\n+          gsutil ls \"gs://${{ secrets.CCP_BUCKET }}/${GITHUB_REF##*/}/*.tar.gz\"\n+          gsutil ls \"gs://${{ secrets.CCP_BUCKET }}/${GITHUB_REF##*/}/*.zip\"\n+\n+  build_wheels:\n+    name: Build wheels on ${{ matrix.os }}\n+    needs: prepare_gcs\n+    runs-on: ${{ matrix.os }}\n+    strategy:\n+      matrix:\n+        os : [ubuntu-18.04, macos-10.15]", "originalCommit": "c9282b21d37ab619cb647b509c791f9d0cfeed69", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTIxMjM5MA==", "url": "https://github.com/apache/beam/pull/11877#discussion_r435212390", "bodyText": "Since some unix specific c libraries are not present on windows (unistd.h, get_clocktime) I will work on it in separate branch/PR. I think there will be no need to create seperate file for windows", "author": "TobKed", "createdAt": "2020-06-04T12:25:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDcyNzcwNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTYzMTE0MQ==", "url": "https://github.com/apache/beam/pull/11877#discussion_r435631141", "bodyText": "Perfect. (just to clarify my understanding: we will have a single github ci config, this is correct, right?)", "author": "aaltay", "createdAt": "2020-06-05T00:41:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDcyNzcwNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjA2ODIzOA==", "url": "https://github.com/apache/beam/pull/11877#discussion_r436068238", "bodyText": "Hopefully yes \ud83d\ude04", "author": "TobKed", "createdAt": "2020-06-05T17:41:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDcyNzcwNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTA5NTI3MQ==", "url": "https://github.com/apache/beam/pull/11877#discussion_r435095271", "bodyText": "typo", "author": "kamilwu", "createdAt": "2020-06-04T08:51:37Z", "path": ".github/workflows/build_wheels.yml", "diffHunk": "@@ -0,0 +1,141 @@\n+name: Build python wheels\n+\n+on:\n+  push:\n+    branches:\n+      - master\n+      - release-*\n+    tags:\n+      - v*\n+\n+jobs:\n+\n+  build_source:\n+    runs-on: ubuntu-18.04\n+    steps:\n+      - name: Checkout code\n+        uses: actions/checkout@v2\n+      - name: Install python\n+        uses: actions/setup-python@v2\n+        with:\n+          python-version: 3.7\n+      - name: Get build dependencies\n+        working-directory: ./sdks/python\n+        run: python3 -m pip install cython && python3 -m pip install -r build-requirements.txt\n+      - name: Install wheels\n+        run: python3 -m pip install wheel\n+      - name: Buld source", "originalCommit": "c9282b21d37ab619cb647b509c791f9d0cfeed69", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjA2ODQxMA==", "url": "https://github.com/apache/beam/pull/11877#discussion_r436068410", "bodyText": "Thanks!. Fixed", "author": "TobKed", "createdAt": "2020-06-05T17:41:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTA5NTI3MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTA5OTYwNw==", "url": "https://github.com/apache/beam/pull/11877#discussion_r435099607", "bodyText": "Do we need higher verbosity normally?", "author": "kamilwu", "createdAt": "2020-06-04T08:58:43Z", "path": ".github/workflows/build_wheels.yml", "diffHunk": "@@ -0,0 +1,141 @@\n+name: Build python wheels\n+\n+on:\n+  push:\n+    branches:\n+      - master\n+      - release-*\n+    tags:\n+      - v*\n+\n+jobs:\n+\n+  build_source:\n+    runs-on: ubuntu-18.04\n+    steps:\n+      - name: Checkout code\n+        uses: actions/checkout@v2\n+      - name: Install python\n+        uses: actions/setup-python@v2\n+        with:\n+          python-version: 3.7\n+      - name: Get build dependencies\n+        working-directory: ./sdks/python\n+        run: python3 -m pip install cython && python3 -m pip install -r build-requirements.txt\n+      - name: Install wheels\n+        run: python3 -m pip install wheel\n+      - name: Buld source\n+        working-directory: ./sdks/python\n+        run: python3 setup.py sdist --formats=gztar,zip\n+      - name: Unzip source\n+        working-directory: ./sdks/python\n+        run: unzip dist/$(ls dist | grep .zip | head -n 1)\n+      - name: Rename source directory\n+        working-directory: ./sdks/python\n+        run: mv $(ls | grep apache-beam) apache-beam-source\n+      - name: Upload source\n+        uses: actions/upload-artifact@v2\n+        with:\n+          name: source\n+          path: sdks/python/apache-beam-source\n+      - name: Upload compressed sources\n+        uses: actions/upload-artifact@v2\n+        with:\n+          name: source_gztar_zip\n+          path: sdks/python/dist\n+\n+  prepare_gcs:\n+    name: Prepare GCS\n+    needs: build_source\n+    runs-on: ubuntu-18.04\n+    steps:\n+      - name: Authenticate on GCP\n+        uses: GoogleCloudPlatform/github-actions/setup-gcloud@master\n+        with:\n+          service_account_email: ${{ secrets.CCP_SA_EMAIL }}\n+          service_account_key: ${{ secrets.CCP_SA_KEY }}\n+      - name: Remove existing files on GCS bucket\n+        run: gsutil rm -r \"gs://${{ secrets.CCP_BUCKET }}/${GITHUB_REF##*/}/\" || true\n+\n+  upload_source_to_gcs:\n+    name: Upload source to GCS bucket\n+    needs: prepare_gcs\n+    runs-on: ubuntu-18.04\n+    steps:\n+      - name: Download wheels\n+        uses: actions/download-artifact@v2\n+        with:\n+          name: source_gztar_zip\n+          path: source/\n+      - name: Authenticate on GCP\n+        uses: GoogleCloudPlatform/github-actions/setup-gcloud@master\n+        with:\n+          service_account_email: ${{ secrets.CCP_SA_EMAIL }}\n+          service_account_key: ${{ secrets.CCP_SA_KEY }}\n+      - name: Copy sources to GCS bucket\n+        run: gsutil cp -r -a public-read source/* gs://${{ secrets.CCP_BUCKET }}/${GITHUB_REF##*/}/\n+      - name: List sources on GCS bucket\n+        run: |\n+          gsutil ls \"gs://${{ secrets.CCP_BUCKET }}/${GITHUB_REF##*/}/*.tar.gz\"\n+          gsutil ls \"gs://${{ secrets.CCP_BUCKET }}/${GITHUB_REF##*/}/*.zip\"\n+\n+  build_wheels:\n+    name: Build wheels on ${{ matrix.os }}\n+    needs: prepare_gcs\n+    runs-on: ${{ matrix.os }}\n+    strategy:\n+      matrix:\n+        os : [ubuntu-18.04, macos-10.15]\n+    steps:\n+    - name: Download source\n+      uses: actions/download-artifact@v2\n+      with:\n+        name: source\n+        path: apache-beam-source\n+    - name: Install Python\n+      uses: actions/setup-python@v2\n+      with:\n+        python-version: 3.7\n+    - name: Install packages on Mac\n+      if: startsWith(matrix.os, 'macos')\n+      run: |\n+        brew update\n+        brew install pkg-config\n+    - name: Install cibuildwheel\n+      run: pip install cibuildwheel==1.4.2\n+    - name: Build wheel\n+      working-directory: apache-beam-source\n+      env:\n+        CIBW_BUILD: cp27-* cp35-* cp36-* cp37-*\n+        CIBW_BUILD_VERBOSITY: 3", "originalCommit": "c9282b21d37ab619cb647b509c791f9d0cfeed69", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQwMzg1Ng==", "url": "https://github.com/apache/beam/pull/11877#discussion_r435403856", "bodyText": "Good point, we don't need it I think. I will remove this line so the default verbosity will be used.", "author": "TobKed", "createdAt": "2020-06-04T16:50:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTA5OTYwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjA2ODYwNA==", "url": "https://github.com/apache/beam/pull/11877#discussion_r436068604", "bodyText": "Fixed.", "author": "TobKed", "createdAt": "2020-06-05T17:41:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTA5OTYwNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTEwNzcxNQ==", "url": "https://github.com/apache/beam/pull/11877#discussion_r435107715", "bodyText": "I think we don't need cython at this point, since it's installed and used in build_wheels job. Most probably the same applies to wheels.", "author": "kamilwu", "createdAt": "2020-06-04T09:11:55Z", "path": ".github/workflows/build_wheels.yml", "diffHunk": "@@ -0,0 +1,141 @@\n+name: Build python wheels\n+\n+on:\n+  push:\n+    branches:\n+      - master\n+      - release-*\n+    tags:\n+      - v*\n+\n+jobs:\n+\n+  build_source:\n+    runs-on: ubuntu-18.04\n+    steps:\n+      - name: Checkout code\n+        uses: actions/checkout@v2\n+      - name: Install python\n+        uses: actions/setup-python@v2\n+        with:\n+          python-version: 3.7\n+      - name: Get build dependencies\n+        working-directory: ./sdks/python\n+        run: python3 -m pip install cython && python3 -m pip install -r build-requirements.txt", "originalCommit": "c9282b21d37ab619cb647b509c791f9d0cfeed69", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQwNzk5Mw==", "url": "https://github.com/apache/beam/pull/11877#discussion_r435407993", "bodyText": "Good point \ud83d\udc4d\nI've tested and for build_source job only python3 -m pip install -r build-requirements.txt is required, then python -m pip install cython is executed in build_wheels.", "author": "TobKed", "createdAt": "2020-06-04T16:56:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTEwNzcxNQ=="}], "type": "inlineReview"}, {"oid": "32cdf7a8e0834817ee439ded282529834c20c561", "url": "https://github.com/apache/beam/commit/32cdf7a8e0834817ee439ded282529834c20c561", "message": "Upload files to GCS only for pushes to relese and release candidate branches", "committedDate": "2020-06-08T23:00:39Z", "type": "forcePushed"}, {"oid": "f53ac909c692fd9d5205cb759877bfee4c7ceac3", "url": "https://github.com/apache/beam/commit/f53ac909c692fd9d5205cb759877bfee4c7ceac3", "message": "Build python wheels on GItHub actions for Linux and MacOS", "committedDate": "2020-06-16T09:03:06Z", "type": "commit"}, {"oid": "025f6d8e68432a2b1cd5913cd5d65ec18833bd74", "url": "https://github.com/apache/beam/commit/025f6d8e68432a2b1cd5913cd5d65ec18833bd74", "message": "Add licence header", "committedDate": "2020-06-16T09:03:06Z", "type": "commit"}, {"oid": "b80ee1f06ad7e3bde24d2062d75141c2fbe07fb9", "url": "https://github.com/apache/beam/commit/b80ee1f06ad7e3bde24d2062d75141c2fbe07fb9", "message": "Set environments labels to the 'latest'", "committedDate": "2020-06-16T09:03:06Z", "type": "commit"}, {"oid": "5b38e8f22851aff0164dd0004ae5a855ee73cee2", "url": "https://github.com/apache/beam/commit/5b38e8f22851aff0164dd0004ae5a855ee73cee2", "message": "Fix typos", "committedDate": "2020-06-16T09:03:06Z", "type": "commit"}, {"oid": "3e86ab61d47e208b1768d8eef999f72eaffdf5ea", "url": "https://github.com/apache/beam/commit/3e86ab61d47e208b1768d8eef999f72eaffdf5ea", "message": "Use default verbosity for cibuildwheel", "committedDate": "2020-06-16T09:03:06Z", "type": "commit"}, {"oid": "17370b9dbeeda822b2522604d52f09fe596faa8b", "url": "https://github.com/apache/beam/commit/17370b9dbeeda822b2522604d52f09fe596faa8b", "message": "Add Python 3.8 version for wheels", "committedDate": "2020-06-16T09:03:06Z", "type": "commit"}, {"oid": "730ccf39de81ddbd3d2f91cf3df02f67df4295c7", "url": "https://github.com/apache/beam/commit/730ccf39de81ddbd3d2f91cf3df02f67df4295c7", "message": "Simplify steps", "committedDate": "2020-06-16T09:03:06Z", "type": "commit"}, {"oid": "8c9e6dd6aabd30b768cae575aa1e00767b836d88", "url": "https://github.com/apache/beam/commit/8c9e6dd6aabd30b768cae575aa1e00767b836d88", "message": "Refactor trigger events", "committedDate": "2020-06-16T09:03:07Z", "type": "commit"}, {"oid": "cefa392096b7e3929dc81215fa0c3dc9c58ce944", "url": "https://github.com/apache/beam/commit/cefa392096b7e3929dc81215fa0c3dc9c58ce944", "message": "List files uploaded to GCS in seperate job", "committedDate": "2020-06-16T09:03:07Z", "type": "commit"}, {"oid": "91c5b22a186a8d458cf510128583d28d7291589e", "url": "https://github.com/apache/beam/commit/91c5b22a186a8d458cf510128583d28d7291589e", "message": "Update step naming", "committedDate": "2020-06-16T09:03:07Z", "type": "commit"}, {"oid": "dc9eac2fcb67ee6f0da455a6c12f74f6e72cb610", "url": "https://github.com/apache/beam/commit/dc9eac2fcb67ee6f0da455a6c12f74f6e72cb610", "message": "Add nightly master build with automatic tagging", "committedDate": "2020-06-16T09:03:07Z", "type": "commit"}, {"oid": "877a082868bd60e97ea14b7350f2b7ed48b50e59", "url": "https://github.com/apache/beam/commit/877a082868bd60e97ea14b7350f2b7ed48b50e59", "message": "Cancel running builds on second push to PR\n\nBased on Apache Airflow cancel workflow\nhttps://github.com/apache/airflow/blob/master/.github/workflows/cancel.yml", "committedDate": "2020-06-16T09:03:07Z", "type": "commit"}, {"oid": "e57eecf6e3100ad81531e40216dc3492d909ff1b", "url": "https://github.com/apache/beam/commit/e57eecf6e3100ad81531e40216dc3492d909ff1b", "message": "Upload files to GCS only for pushes to relese and release candidate branches", "committedDate": "2020-06-16T09:03:07Z", "type": "commit"}, {"oid": "40c5934b48aff6de0def63dbb4314271f52a31bb", "url": "https://github.com/apache/beam/commit/40c5934b48aff6de0def63dbb4314271f52a31bb", "message": "Add pattern to match release candidate branch", "committedDate": "2020-06-16T09:03:07Z", "type": "commit"}, {"oid": "dc0cde5c8622edfef2176c30d8571587b8f1fb18", "url": "https://github.com/apache/beam/commit/dc0cde5c8622edfef2176c30d8571587b8f1fb18", "message": "Add paths filter for pull requests", "committedDate": "2020-06-16T09:03:07Z", "type": "commit"}, {"oid": "349f6f0022e86f07a9b4e2a136d8b6fca100ec2a", "url": "https://github.com/apache/beam/commit/349f6f0022e86f07a9b4e2a136d8b6fca100ec2a", "message": "fixup! Add paths filter for pull requests", "committedDate": "2020-06-16T09:03:07Z", "type": "commit"}, {"oid": "f675d003780f9ec162c30921ed8c3d5eb966ddb3", "url": "https://github.com/apache/beam/commit/f675d003780f9ec162c30921ed8c3d5eb966ddb3", "message": "fixup! Cancel running builds on second push to PR", "committedDate": "2020-06-16T09:03:07Z", "type": "commit"}, {"oid": "f675d003780f9ec162c30921ed8c3d5eb966ddb3", "url": "https://github.com/apache/beam/commit/f675d003780f9ec162c30921ed8c3d5eb966ddb3", "message": "fixup! Cancel running builds on second push to PR", "committedDate": "2020-06-16T09:03:07Z", "type": "forcePushed"}, {"oid": "9772965ef5fb60546b224022c3ecc7fa3a727634", "url": "https://github.com/apache/beam/commit/9772965ef5fb60546b224022c3ecc7fa3a727634", "message": "Fix trigering patterns", "committedDate": "2020-06-18T16:34:32Z", "type": "commit"}, {"oid": "2323b009507680798737fed815ea962ae40aabef", "url": "https://github.com/apache/beam/commit/2323b009507680798737fed815ea962ae40aabef", "message": "Upload additional files with information about buld", "committedDate": "2020-06-19T13:05:39Z", "type": "commit"}, {"oid": "6237068ac587f284cd6636e4a412dab0b07a4bac", "url": "https://github.com/apache/beam/commit/6237068ac587f284cd6636e4a412dab0b07a4bac", "message": "Hange GCS path for uploading artifacts to prevent overwriting during rerun\n\nPreviously every build on given branch would ovewrite files:\n\tgs://bucket-name/branch-name/  # first build\n\tgs://bucket-name/branch-name/  # rerun worklow\n\tgs://bucket-name/branch-name/  # new commit\n\nNow they will be differentiated:\n\tgs://bucket-name/branch-name/8121a1...-140818789/  # first build\n\tgs://bucket-name/branch-name/8121a1...-140818789/  # rerun worklow, new files versions\n\tgs://bucket-name/branch-name/2323b0...-140818794/  # new commit\n\nWersions of reruns files could be checked with objects versioning\n  (if enabled on the bucket)\n\nIt will allow better builds tracking: e.g. night-builds", "committedDate": "2020-06-19T13:53:41Z", "type": "commit"}, {"oid": "6237068ac587f284cd6636e4a412dab0b07a4bac", "url": "https://github.com/apache/beam/commit/6237068ac587f284cd6636e4a412dab0b07a4bac", "message": "Hange GCS path for uploading artifacts to prevent overwriting during rerun\n\nPreviously every build on given branch would ovewrite files:\n\tgs://bucket-name/branch-name/  # first build\n\tgs://bucket-name/branch-name/  # rerun worklow\n\tgs://bucket-name/branch-name/  # new commit\n\nNow they will be differentiated:\n\tgs://bucket-name/branch-name/8121a1...-140818789/  # first build\n\tgs://bucket-name/branch-name/8121a1...-140818789/  # rerun worklow, new files versions\n\tgs://bucket-name/branch-name/2323b0...-140818794/  # new commit\n\nWersions of reruns files could be checked with objects versioning\n  (if enabled on the bucket)\n\nIt will allow better builds tracking: e.g. night-builds", "committedDate": "2020-06-19T13:53:41Z", "type": "forcePushed"}, {"oid": "992ee80003573d1a9e3b536ddc9bc41f30e5d08b", "url": "https://github.com/apache/beam/commit/992ee80003573d1a9e3b536ddc9bc41f30e5d08b", "message": "Put bucket name directly into the workflow", "committedDate": "2020-06-25T06:47:32Z", "type": "commit"}]}