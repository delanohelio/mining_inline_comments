{"pr_number": 12050, "pr_title": "[BEAM-10292] DefaultFilenamePolicy.ParamsCoder is not able to decode directory on the local file system", "pr_createdAt": "2020-06-22T13:46:47Z", "pr_url": "https://github.com/apache/beam/pull/12050", "timeline": [{"oid": "738499818a779110f761dc549f0d7543717904b9", "url": "https://github.com/apache/beam/commit/738499818a779110f761dc549f0d7543717904b9", "message": "[BEAM-10292] DefaultFilenamePolicy.ParamsCoder preserves information if Params.baseFilename is file/directory (backward compatible)", "committedDate": "2020-06-23T05:53:51Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDc2MjExMQ==", "url": "https://github.com/apache/beam/pull/12050#discussion_r444762111", "bodyText": "Would it be possible to add test case for bw compatible code path?", "author": "dmvk", "createdAt": "2020-06-24T09:22:32Z", "path": "sdks/java/core/src/main/java/org/apache/beam/sdk/io/DefaultFilenamePolicy.java", "diffHunk": "@@ -182,19 +184,26 @@ public void encode(Params value, OutputStream outStream) throws IOException {\n       if (value == null) {\n         throw new CoderException(\"cannot encode a null value\");\n       }\n-      stringCoder.encode(value.baseFilename.get().toString(), outStream);\n-      stringCoder.encode(value.shardTemplate, outStream);\n-      stringCoder.encode(value.suffix, outStream);\n+      STRING_CODER.encode(value.baseFilename.get().toString(), outStream);\n+      STRING_CODER.encode(value.shardTemplate, outStream);\n+      STRING_CODER.encode(value.suffix, outStream);\n+      BOOLEAN_CODER.encode(value.baseFilename.get().isDirectory(), outStream);\n     }\n \n     @Override\n     public Params decode(InputStream inStream) throws IOException {\n-      ResourceId prefix =\n-          FileBasedSink.convertToFileResourceIfPossible(stringCoder.decode(inStream));\n-      String shardTemplate = stringCoder.decode(inStream);\n-      String suffix = stringCoder.decode(inStream);\n+      String prefix = STRING_CODER.decode(inStream);\n+      String shardTemplate = STRING_CODER.decode(inStream);\n+      String suffix = STRING_CODER.decode(inStream);\n+      ResourceId baseFilename;\n+      if (inStream.available() > 0) {\n+        baseFilename = FileSystems.matchNewResource(prefix, BOOLEAN_CODER.decode(inStream));\n+      } else {\n+        // fallback for ensure backward compatibility\n+        baseFilename = FileBasedSink.convertToFileResourceIfPossible(prefix);", "originalCommit": "738499818a779110f761dc549f0d7543717904b9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDgzODQ2Nw==", "url": "https://github.com/apache/beam/pull/12050#discussion_r444838467", "bodyText": "ok, I added the requested test for bw compatibility\nbtw you can see the buggy behavior there (lost information whether baseFilename is file/directory)", "author": "davidak09", "createdAt": "2020-06-24T11:51:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDc2MjExMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTA2MjMzMQ==", "url": "https://github.com/apache/beam/pull/12050#discussion_r445062331", "bodyText": "convertToFileResourceIfPossible attempts to match a file and if that fails attempts to match a directory.\nIs the issue that the underlying filesystem erroneously says something is a file when really it is a directory?", "author": "lukecwik", "createdAt": "2020-06-24T17:39:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDc2MjExMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTQ4NTM3OA==", "url": "https://github.com/apache/beam/pull/12050#discussion_r445485378", "bodyText": "Exactly, that's the issue, for example LocalFileSystem matches path /tmp/dirA/ as file..\nHow about something like this?\npublic static class ParamsCoder extends AtomicCoder<Params> {\n    private static final ParamsCoder INSTANCE = new ParamsCoder();\n    private static final Coder<String> STRING_CODER = StringUtf8Coder.of();\n\n    public static ParamsCoder of() {\n      return INSTANCE;\n    }\n\n    @Override\n    public void encode(Params value, OutputStream outStream) throws IOException {\n      if (value == null) {\n        throw new CoderException(\"cannot encode a null value\");\n      }\n      ResourceId baseFilename = value.getBaseFilename().get();\n      String baseFilenameString =\n          (baseFilename.isDirectory() && !baseFilename.toString().endsWith(\"/\"))\n              ? baseFilename.toString() + \"/\"\n              : baseFilename.toString();\n      STRING_CODER.encode(baseFilenameString, outStream);\n      STRING_CODER.encode(value.getShardTemplate(), outStream);\n      STRING_CODER.encode(value.getSuffix(), outStream);\n    }\n\n    @Override\n    public Params decode(InputStream inStream) throws IOException {\n      String baseFilenameString = STRING_CODER.decode(inStream);\n      ResourceId prefix =\n          FileSystems.matchNewResource(baseFilenameString, baseFilenameString.endsWith(\"/\"));\n      String shardTemplate = STRING_CODER.decode(inStream);\n      String suffix = STRING_CODER.decode(inStream);\n      return new Params()\n          .withBaseFilename(prefix)\n          .withShardTemplate(shardTemplate)\n          .withSuffix(suffix);\n    }\n  }\nBut I'm not sure how to handle the suffix (/) to ensure compatibility among (file) systems", "author": "davidak09", "createdAt": "2020-06-25T11:19:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDc2MjExMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTY5NjI1MQ==", "url": "https://github.com/apache/beam/pull/12050#discussion_r445696251", "bodyText": "I think that there are a couple of options here:\n\nTake the breaking change to the coder because it is a fix, make sure it is documented in the release notes\nTry to fix the underlying filesystem to do a better job of file/dir matching\nDeprecate this filename policy, create a new one (DefaultFilenamePolicy2) and tell people to use it in new code.\n\nI'm for 1 but would ask for consensus on the mailing list.\nAlso, any / hacking will make things worse since different file systems use different path separator characters (e.g linux vs windows)", "author": "lukecwik", "createdAt": "2020-06-25T16:45:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDc2MjExMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDMzMTc2OA==", "url": "https://github.com/apache/beam/pull/12050#discussion_r464331768", "bodyText": "OK, I agree with the first solution - taking the breaking change. I will ask on the mailing list.\nBTW I did workaround in my project where I use only files (not directories) as Params base filenames and then everything works fine. That means I no longer needs this fix but it still seems to me like a bug which is worth fixing.\n(P.S.: The suffix wouldn't have to be the path separator (/) but e.g. sometotallyrandomstring123  - but it's very ugly...)", "author": "davidak09", "createdAt": "2020-08-03T10:34:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDc2MjExMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDg0OTYwMA==", "url": "https://github.com/apache/beam/pull/12050#discussion_r464849600", "bodyText": "https://lists.apache.org/thread.html/r1d844830648b88948d38d0c28d106dd7fe2ed92af4a170e2679f8c2f%40%3Cdev.beam.apache.org%3E", "author": "davidak09", "createdAt": "2020-08-04T07:19:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDc2MjExMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODUzODk5Mw==", "url": "https://github.com/apache/beam/pull/12050#discussion_r468538993", "bodyText": "Hi @lukecwik, finally after the discussion in the mailing list I chose the second proposed option and fixed the underlying filesystem. Turns out that only LocalFileSystem is broken, on the other hand e.g. HDFS and S3 look fine and already have this kind of check.\nI still think that the proper solution should be to use the ResourceIdCoder instead of StringUtf8Coder but I understand the consequences.", "author": "davidak09", "createdAt": "2020-08-11T12:23:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDc2MjExMQ=="}], "type": "inlineReview"}, {"oid": "3f4aa11aaa898f5af75d2d8c2ed21c571015c704", "url": "https://github.com/apache/beam/commit/3f4aa11aaa898f5af75d2d8c2ed21c571015c704", "message": "[BEAM-10292] DefaultFilenamePolicy.ParamsCoder uses ResourceIdCoder", "committedDate": "2020-08-03T11:22:38Z", "type": "forcePushed"}, {"oid": "7b440f2ce57c049fbca04d7320cc74af6431b43c", "url": "https://github.com/apache/beam/commit/7b440f2ce57c049fbca04d7320cc74af6431b43c", "message": "[BEAM-10292] DefaultFilenamePolicy.ParamsCoder uses ResourceIdCoder", "committedDate": "2020-08-03T11:26:58Z", "type": "forcePushed"}, {"oid": "1cdb8f4169acbc3f2cb3a4767dd1e1d2a7bd53e3", "url": "https://github.com/apache/beam/commit/1cdb8f4169acbc3f2cb3a4767dd1e1d2a7bd53e3", "message": "[BEAM-10292] LocalFileSystem.matchNewResource method throws IllegalArgumentException when the first 'singleResourceSpec' parameter ends with filesystem separator and the second provided parameter indicates that it isn't directory.\nFixed due to DefaultFilenamePolicy.ParamsCoder was not able to decode directory on the local file system because it calls FileBasedSink.convertToFileResourceIfPossible method which internally calls FileSystem.matchNewResource method.\nOther file systems (HDFS, S3) already have this kind of check.", "committedDate": "2020-08-11T12:07:40Z", "type": "commit"}, {"oid": "1cdb8f4169acbc3f2cb3a4767dd1e1d2a7bd53e3", "url": "https://github.com/apache/beam/commit/1cdb8f4169acbc3f2cb3a4767dd1e1d2a7bd53e3", "message": "[BEAM-10292] LocalFileSystem.matchNewResource method throws IllegalArgumentException when the first 'singleResourceSpec' parameter ends with filesystem separator and the second provided parameter indicates that it isn't directory.\nFixed due to DefaultFilenamePolicy.ParamsCoder was not able to decode directory on the local file system because it calls FileBasedSink.convertToFileResourceIfPossible method which internally calls FileSystem.matchNewResource method.\nOther file systems (HDFS, S3) already have this kind of check.", "committedDate": "2020-08-11T12:07:40Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzE4Njg1NQ==", "url": "https://github.com/apache/beam/pull/12050#discussion_r473186855", "bodyText": "Use CoderUtils.clone", "author": "lukecwik", "createdAt": "2020-08-19T17:01:53Z", "path": "sdks/java/core/src/test/java/org/apache/beam/sdk/io/DefaultFilenamePolicyTest.java", "diffHunk": "@@ -48,6 +51,26 @@ private static String constructName(\n     return constructed.toString();\n   }\n \n+  private static DefaultFilenamePolicy.Params encodeDecodeParams(", "originalCommit": "1cdb8f4169acbc3f2cb3a4767dd1e1d2a7bd53e3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzY1MDQ0Mw==", "url": "https://github.com/apache/beam/pull/12050#discussion_r473650443", "bodyText": "thanks for the advice \ud83d\udc4d", "author": "davidak09", "createdAt": "2020-08-20T06:34:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzE4Njg1NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzE5MTQ0NQ==", "url": "https://github.com/apache/beam/pull/12050#discussion_r473191445", "bodyText": "Do you want to add the file separator if it doesn't exist if isDirectory == true. This will help make it less error prone for users. Similar to GcsFileSystem.", "author": "lukecwik", "createdAt": "2020-08-19T17:06:59Z", "path": "sdks/java/core/src/main/java/org/apache/beam/sdk/io/LocalFileSystem.java", "diffHunk": "@@ -202,6 +202,10 @@ protected void delete(Collection<LocalResourceId> resourceIds) throws IOExceptio\n \n   @Override\n   protected LocalResourceId matchNewResource(String singleResourceSpec, boolean isDirectory) {\n+    if (singleResourceSpec.endsWith(File.separator) && !isDirectory) {", "originalCommit": "1cdb8f4169acbc3f2cb3a4767dd1e1d2a7bd53e3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzY1MDY4OQ==", "url": "https://github.com/apache/beam/pull/12050#discussion_r473650689", "bodyText": "sounds good, I added it", "author": "davidak09", "createdAt": "2020-08-20T06:35:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzE5MTQ0NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzE5OTUyMA==", "url": "https://github.com/apache/beam/pull/12050#discussion_r473199520", "bodyText": "What if the character is escaped and being used in the name component of the path string?", "author": "lukecwik", "createdAt": "2020-08-19T17:20:39Z", "path": "sdks/java/core/src/main/java/org/apache/beam/sdk/io/LocalFileSystem.java", "diffHunk": "@@ -202,6 +202,10 @@ protected void delete(Collection<LocalResourceId> resourceIds) throws IOExceptio\n \n   @Override\n   protected LocalResourceId matchNewResource(String singleResourceSpec, boolean isDirectory) {\n+    if (singleResourceSpec.endsWith(File.separator) && !isDirectory) {", "originalCommit": "1cdb8f4169acbc3f2cb3a4767dd1e1d2a7bd53e3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzY1MjY2Ng==", "url": "https://github.com/apache/beam/pull/12050#discussion_r473652666", "bodyText": "Is it even possible? For example according to https://stackoverflow.com/questions/9847288/is-it-possible-to-use-in-a-filename it's not. Or do you mean something different?", "author": "davidak09", "createdAt": "2020-08-20T06:37:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzE5OTUyMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDEzNjc1Ng==", "url": "https://github.com/apache/beam/pull/12050#discussion_r474136756", "bodyText": "Your right, it seems as though Linux doesn't allow /, Mac OS X doesn't allow :, Windows doesn't allow \\.", "author": "lukecwik", "createdAt": "2020-08-20T16:55:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzE5OTUyMA=="}], "type": "inlineReview"}, {"oid": "a20b6138f00ad15b643b8ebfd37fdb8b2493a3f6", "url": "https://github.com/apache/beam/commit/a20b6138f00ad15b643b8ebfd37fdb8b2493a3f6", "message": "[BEAM-10292] changes after review\n- adding file separator if it doesn't exist if isDirectory == true in LocalFileSystem.matchNewResource\n- dropped isDirectory field in LocalResourceId\n- using CoderUtils.clone method in DefaultFilenamePolicyTest.testParamsCoder test", "committedDate": "2020-08-20T06:33:14Z", "type": "commit"}]}