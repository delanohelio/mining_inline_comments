{"pr_number": 12705, "pr_title": "[BEAM-10720] Finish implementing StringMethods (cat, repeat)", "pr_createdAt": "2020-08-27T21:07:46Z", "pr_url": "https://github.com/apache/beam/pull/12705", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODY5NzM0Nw==", "url": "https://github.com/apache/beam/pull/12705#discussion_r478697347", "bodyText": "I've marked this PR WIP because this test does not pass. It yields the following error, that I'm not sure how to diagnose. @robertwb can you provide any insight here?\napache_beam/runners/common.py:806: in _invoke_process_per_window                                                                                                                                                                        \n    [si[global_window] for si in self.side_inputs]))                                                                                                                                                                                    \napache_beam/runners/common.py:806: in <listcomp>                                                                                                                                                                                        \n    [si[global_window] for si in self.side_inputs]))                                                                                                                                                                                    \napache_beam/runners/worker/bundle_processor.py:422: in __getitem__                                                                                                                                                                      \n    self._cache[target_window] = self._side_input_data.view_fn(raw_view)                                                                                                                                                                \napache_beam/pvalue.py:395: in <lambda>                                                                                                                                                                                                  \n    lambda iterable: from_runtime_iterable(iterable, view_options))                                                                                                                                                                     \n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _                                                                                                             \n                                                                                                                                                                                                                                        \nit = <apache_beam.runners.worker.bundle_processor._StateBackedIterable object at 0x7f3b0e5cf310>                                                                                                                                        \noptions = {'coder': WindowedValueCoder[FastPrimitivesCoder], 'window_mapping_fn': <function _global_window_mapping_fn at 0x7f3b1b31b710>}\n                                                                                                                                                                                                                                        \n    @staticmethod                                                                                                   \n    def _from_runtime_iterable(it, options):                                                                                                                                                                                            \n      head = list(itertools.islice(it, 2))                                                                                                                                                                                              \n      if not head:                                                                                                  \n        return options.get('default', EmptySideInput())                                                             \n      elif len(head) == 1:                                                                                          \n        return head[0]                                                                                                                                                                                                                  \n      raise ValueError(                                                                                                                                                                                                                 \n          'PCollection of size %d with more than one element accessed as a '                                                                                                                                                            \n          'singleton view. First two elements encountered are \"%s\", \"%s\".' %                                                                                                                                                            \n>         (len(head), str(head[0]), str(head[1])))                                                                                                                                                                                      \nE     ValueError: PCollection of size 2 with more than one element accessed as a singleton view. First two elements encountered are \"<pandas.core.strings.StringMethods object at 0x7f3b0e32ec90>\", \"<pandas.core.strings.StringMethods \nobject at 0x7f3b0e3d7510>\". [while running 'DataframeTransform/Eval/[ComputedExpression[cat_Series_139891620772240]]:139891619912080/FlatMap(evaluate)/FlatMap(evaluate)']", "author": "TheNeuralBit", "createdAt": "2020-08-27T21:10:01Z", "path": "sdks/python/apache_beam/dataframe/transforms_test.py", "diffHunk": "@@ -266,6 +266,17 @@ def check(actual):\n           lambda x: {'res': 3 * x}, proxy)\n       assert_that(res['res'], equal_to_series(three_series), 'CheckDictOut')\n \n+  def test_cat(self):\n+    # verify that cat works with a List[Series] sicne this is missing from doctests\n+    df = pd.DataFrame({\n+        'one': ['A', 'B', 'C'],\n+        'two': ['BB', 'CC', 'A'],\n+        'three': ['CCC', 'AA', 'B'],\n+    })\n+    self.run_scenario(df, lambda df: df.two.str.cat([df.three], join='outer'))\n+    self.run_scenario(\n+        df, lambda df: df.one.str.cat([df.two, df.three], join='outer'))\n+", "originalCommit": "d59320c9974a18001aee2ce054604585ed3da308", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODU3NzM2OQ==", "url": "https://github.com/apache/beam/pull/12705#discussion_r498577369", "bodyText": "I think this is because we're trying to partition the StringMethods object itself and send it across the stage/shuffle boundary, and that code only expects dataframes and series to be partition-able (expecting everything else to be a single-object scalar.\nOne route would be to add StringMethods to the list of things that are partitionable, but that feels a bit odd and won't work well with a columnar backend representation (e.g. how would we represent s.str[:] as an Arrow batch?) Better would be for these expressions to take the underlying series as an argument, and invoke str on it themselves as part of the function to be applied. This may take some refactoring of the elementwise operations. (It may be OK, as all the others get \"fused away\", similarly for DateTime, but we should probably add a check that we don't try to partition anything but frames).", "author": "robertwb", "createdAt": "2020-10-02T00:51:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODY5NzM0Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTkyNjQzNA==", "url": "https://github.com/apache/beam/pull/12705#discussion_r501926434", "bodyText": "Thank you!\nIn order to avoid refactoring the elementwise methods I made DeferredStringMethods store two expressions, one that accesses Series.str, and one for the underlying Series. This seems to get things passing, but I'm not 100% sure this is safe. I'll look at extending elementwise_method for this use-case instead.", "author": "TheNeuralBit", "createdAt": "2020-10-08T18:25:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODY5NzM0Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzU2NzI0NA==", "url": "https://github.com/apache/beam/pull/12705#discussion_r503567244", "bodyText": "Done", "author": "TheNeuralBit", "createdAt": "2020-10-12T22:35:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODY5NzM0Nw=="}], "type": "inlineReview"}, {"oid": "80af5ea8f076def996e1e98735ca1e08654e4642", "url": "https://github.com/apache/beam/commit/80af5ea8f076def996e1e98735ca1e08654e4642", "message": "Implement repeat, cat", "committedDate": "2020-09-01T17:12:57Z", "type": "forcePushed"}, {"oid": "550af5eb290ca8350105725bd97aa58760fe24c1", "url": "https://github.com/apache/beam/commit/550af5eb290ca8350105725bd97aa58760fe24c1", "message": "Implement repeat, cat", "committedDate": "2020-09-15T19:06:24Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODU3MTE2OQ==", "url": "https://github.com/apache/beam/pull/12705#discussion_r498571169", "bodyText": "Use ()'s rather than backslashes for continuations.", "author": "robertwb", "createdAt": "2020-10-02T00:19:16Z", "path": "sdks/python/apache_beam/dataframe/frames.py", "diffHunk": "@@ -905,7 +905,48 @@ def checked_callable_index(df):\n             preserves_partition_by=partitionings.Singleton()))\n \n class _DeferredStringMethods(frame_base.DeferredBase):\n-  pass\n+  @frame_base.args_to_kwargs(pd.core.strings.StringMethods)\n+  @frame_base.populate_defaults(pd.core.strings.StringMethods)\n+  def cat(self, others, join, **kwargs):\n+    if others is None:\n+      # Concatenate series into a single String\n+      requires = partitionings.Singleton()\n+      func = lambda df: df.cat(join=join, **kwargs)\n+      args = [self._expr]\n+\n+    elif isinstance(others, frame_base.DeferredBase) or \\", "originalCommit": "550af5eb290ca8350105725bd97aa58760fe24c1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTkyNTQxMA==", "url": "https://github.com/apache/beam/pull/12705#discussion_r501925410", "bodyText": "Done", "author": "TheNeuralBit", "createdAt": "2020-10-08T18:23:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODU3MTE2OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODU3MjQ2Mw==", "url": "https://github.com/apache/beam/pull/12705#discussion_r498572463", "bodyText": "since", "author": "robertwb", "createdAt": "2020-10-02T00:25:38Z", "path": "sdks/python/apache_beam/dataframe/transforms_test.py", "diffHunk": "@@ -266,6 +266,18 @@ def check(actual):\n           lambda x: {'res': 3 * x}, proxy)\n       assert_that(res['res'], equal_to_series(three_series), 'CheckDictOut')\n \n+  def test_cat(self):\n+    # verify that cat works with a List[Series] sicne this is", "originalCommit": "550af5eb290ca8350105725bd97aa58760fe24c1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTkyNTM0NQ==", "url": "https://github.com/apache/beam/pull/12705#discussion_r501925345", "bodyText": "Done", "author": "TheNeuralBit", "createdAt": "2020-10-08T18:23:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODU3MjQ2Mw=="}], "type": "inlineReview"}, {"oid": "4fec7bbd5a3a1cbb146e48fdc784c9e363ea425a", "url": "https://github.com/apache/beam/commit/4fec7bbd5a3a1cbb146e48fdc784c9e363ea425a", "message": "Implement repeat, cat", "committedDate": "2020-10-08T18:09:00Z", "type": "commit"}, {"oid": "fd6ed9a0c041711f45dcee0977c3a43e19b0498a", "url": "https://github.com/apache/beam/commit/fd6ed9a0c041711f45dcee0977c3a43e19b0498a", "message": "More discerning repeat, fix cat bug", "committedDate": "2020-10-08T18:17:44Z", "type": "commit"}, {"oid": "fd6ed9a0c041711f45dcee0977c3a43e19b0498a", "url": "https://github.com/apache/beam/commit/fd6ed9a0c041711f45dcee0977c3a43e19b0498a", "message": "More discerning repeat, fix cat bug", "committedDate": "2020-10-08T18:17:44Z", "type": "forcePushed"}, {"oid": "399dc871e00071e47b1db3d8479ccf530dfa37cc", "url": "https://github.com/apache/beam/commit/399dc871e00071e47b1db3d8479ccf530dfa37cc", "message": "Remove str_expr shim", "committedDate": "2020-10-12T22:32:23Z", "type": "commit"}, {"oid": "0af19cfc46dc0935d0c829a87c6784db6f70039b", "url": "https://github.com/apache/beam/commit/0af19cfc46dc0935d0c829a87c6784db6f70039b", "message": "fix py3.6", "committedDate": "2020-10-12T23:26:42Z", "type": "commit"}, {"oid": "e71efdf5df010792cb974f8900e020597ed5ac21", "url": "https://github.com/apache/beam/commit/e71efdf5df010792cb974f8900e020597ed5ac21", "message": "lint", "committedDate": "2020-10-13T20:30:58Z", "type": "commit"}, {"oid": "0c34b0b687cc0492ae5a169ae7c69bc80e7b1110", "url": "https://github.com/apache/beam/commit/0c34b0b687cc0492ae5a169ae7c69bc80e7b1110", "message": "yapf", "committedDate": "2020-10-13T21:35:10Z", "type": "commit"}]}