{"pr_number": 10764, "pr_title": "[BEAM-9146] Integrate GCP Video Intelligence functionality for Python SDK", "pr_createdAt": "2020-02-04T14:19:19Z", "pr_url": "https://github.com/apache/beam/pull/10764", "timeline": [{"oid": "6ab5013a3e3e703a2734fab60fbfc6ed61c0a9de", "url": "https://github.com/apache/beam/commit/6ab5013a3e3e703a2734fab60fbfc6ed61c0a9de", "message": "[BEAM-9146] PTransform that integrates Video Intelligence functionality", "committedDate": "2020-02-04T14:06:00Z", "type": "commit"}, {"oid": "0e54a6423bb5b220a6d3e1d7bc7e937af2541033", "url": "https://github.com/apache/beam/commit/0e54a6423bb5b220a6d3e1d7bc7e937af2541033", "message": "Removed unused imports", "committedDate": "2020-02-04T14:14:55Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTE4NjMyNA==", "url": "https://github.com/apache/beam/pull/10764#discussion_r375186324", "bodyText": "I think we should also accept other parameters, not only features.\nA must have is video_context, because sometimes it provides additional feature-specific parameters. Others are location_id and possibly metadata. Take a look at the interface of annotate_video()", "author": "kamilwu", "createdAt": "2020-02-05T10:53:05Z", "path": "sdks/python/apache_beam/io/gcp/ai/video_intelligence.py", "diffHunk": "@@ -0,0 +1,75 @@\n+#\n+# Licensed to the Apache Software Foundation (ASF) under one or more\n+# contributor license agreements.  See the NOTICE file distributed with\n+# this work for additional information regarding copyright ownership.\n+# The ASF licenses this file to You under the Apache License, Version 2.0\n+# (the \"License\"); you may not use this file except in compliance with\n+# the License.  You may obtain a copy of the License at\n+#\n+#    http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+#\n+\"\"\"\n+A connector for sending API requests to the GCP Video Intelligence API.\n+\"\"\"\n+from __future__ import absolute_import\n+\n+from typing import Union\n+\n+from apache_beam import typehints\n+from apache_beam.io.gcp.ai import helper\n+from apache_beam.metrics import Metrics\n+from apache_beam.transforms import DoFn, ParDo, PTransform\n+\n+\n+class AnnotateVideo(PTransform):\n+  \"\"\"A ``PTransform`` for annotating video using the GCP Video Intelligence API\n+  ref: https://cloud.google.com/video-intelligence/docs\n+  \"\"\"\n+\n+  def __init__(self, features):", "originalCommit": "0e54a6423bb5b220a6d3e1d7bc7e937af2541033", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTIxNzM5Nw==", "url": "https://github.com/apache/beam/pull/10764#discussion_r375217397", "bodyText": "Good idea, thanks! I'll have a look after we've finished the discussion with @aaltay about the usefulness of this PR.", "author": "EDjur", "createdAt": "2020-02-05T12:05:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTE4NjMyNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTIxOTg3Ng==", "url": "https://github.com/apache/beam/pull/10764#discussion_r375219876", "bodyText": "In Python 2 str and bytes are the same. Since Beam still supports Python 2.7, this code must be compatible with both Python 2 and 3.\nConsider using future.utils module which provides some methods that can help you to check type of an element.", "author": "kamilwu", "createdAt": "2020-02-05T12:11:35Z", "path": "sdks/python/apache_beam/io/gcp/ai/video_intelligence.py", "diffHunk": "@@ -0,0 +1,75 @@\n+#\n+# Licensed to the Apache Software Foundation (ASF) under one or more\n+# contributor license agreements.  See the NOTICE file distributed with\n+# this work for additional information regarding copyright ownership.\n+# The ASF licenses this file to You under the Apache License, Version 2.0\n+# (the \"License\"); you may not use this file except in compliance with\n+# the License.  You may obtain a copy of the License at\n+#\n+#    http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+#\n+\"\"\"\n+A connector for sending API requests to the GCP Video Intelligence API.\n+\"\"\"\n+from __future__ import absolute_import\n+\n+from typing import Union\n+\n+from apache_beam import typehints\n+from apache_beam.io.gcp.ai import helper\n+from apache_beam.metrics import Metrics\n+from apache_beam.transforms import DoFn, ParDo, PTransform\n+\n+\n+class AnnotateVideo(PTransform):\n+  \"\"\"A ``PTransform`` for annotating video using the GCP Video Intelligence API\n+  ref: https://cloud.google.com/video-intelligence/docs\n+  \"\"\"\n+\n+  def __init__(self, features):\n+    \"\"\"\n+      Args:\n+        features: (List[``videointelligence.enums.Feature``])\n+          the Video Intelligence API features to detect\n+    \"\"\"\n+    super(AnnotateVideo).__init__()\n+    self.features = features\n+\n+  def expand(self, pvalue):\n+    return pvalue | ParDo(self._VideoAnnotateFn(features=self.features))\n+\n+  @typehints.with_input_types(Union[str, bytes])\n+  class _VideoAnnotateFn(DoFn):\n+    \"\"\" A ``DoFn`` that sends every element to the GCP Video Intelligence API\n+      and returns a PCollection of\n+    ``google.cloud.videointelligence_v1.types.AnnotateVideoResponse``.\n+     \"\"\"\n+\n+    def __init__(self, features):\n+      super(AnnotateVideo._VideoAnnotateFn, self).__init__()\n+      self._client = None\n+      self.features = features\n+      self.counter = Metrics.counter(self.__class__, \"API Calls\")\n+\n+    def start_bundle(self):\n+      self._client = helper.get_videointelligence_client()\n+\n+    def process(self, element, *args, **kwargs):\n+      if isinstance(element, str):  # Is element an URI to a GCS bucket", "originalCommit": "0e54a6423bb5b220a6d3e1d7bc7e937af2541033", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "86aeff86aaa37f538ffcafa92fff78b4647c5c6a", "url": "https://github.com/apache/beam/commit/86aeff86aaa37f538ffcafa92fff78b4647c5c6a", "message": "byte and string comparison now supporting py23. Added extra args to annotate_video. Added requirement in setup.py", "committedDate": "2020-02-06T13:55:29Z", "type": "commit"}, {"oid": "d2d3fc4ba18bd551f8a2156c675cba6545e39d7a", "url": "https://github.com/apache/beam/commit/d2d3fc4ba18bd551f8a2156c675cba6545e39d7a", "message": "Folder restructuring", "committedDate": "2020-02-06T13:57:04Z", "type": "commit"}, {"oid": "c1abf00aff393c3e72e8837bc23e45c865ed0520", "url": "https://github.com/apache/beam/commit/c1abf00aff393c3e72e8837bc23e45c865ed0520", "message": "Yapf formatting", "committedDate": "2020-02-06T14:30:25Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTk4MTAxNQ==", "url": "https://github.com/apache/beam/pull/10764#discussion_r375981015", "bodyText": "Would it make sense to make 120 configurable?", "author": "aaltay", "createdAt": "2020-02-06T17:36:56Z", "path": "sdks/python/apache_beam/ml/gcp/video_intelligence.py", "diffHunk": "@@ -0,0 +1,107 @@\n+#\n+# Licensed to the Apache Software Foundation (ASF) under one or more\n+# contributor license agreements.  See the NOTICE file distributed with\n+# this work for additional information regarding copyright ownership.\n+# The ASF licenses this file to You under the Apache License, Version 2.0\n+# (the \"License\"); you may not use this file except in compliance with\n+# the License.  You may obtain a copy of the License at\n+#\n+#    http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+#\n+\n+\"\"\"\n+A connector for sending API requests to the GCP Video Intelligence API.\n+\"\"\"\n+from __future__ import absolute_import\n+\n+from future.utils import binary_type, text_type\n+from typing import Union\n+\n+from apache_beam import typehints\n+from apache_beam.ml.gcp import video_intelligence_helper as helper\n+from apache_beam.metrics import Metrics\n+from apache_beam.transforms import DoFn, ParDo, PTransform\n+\n+__all__ = ['AnnotateVideo']\n+\n+\n+class AnnotateVideo(PTransform):\n+  \"\"\"A ``PTransform`` for annotating video using the GCP Video Intelligence API\n+  ref: https://cloud.google.com/video-intelligence/docs\n+  \"\"\"\n+  def __init__(\n+      self, features, video_context=None, location_id=None, metadata=None):\n+    \"\"\"\n+      Args:\n+        features: (List[``videointelligence_v1.enums.Feature``]) Required.\n+          the Video Intelligence API features to detect\n+        video_context: (dict, ``videointelligence_v1.types.VideoContext``)\n+          Optional.\n+          Additional video context and/or feature-specific parameters.\n+        location_id: (str) Optional.\n+          Cloud region where annotation should take place.\n+          If no region is specified, a region will be determined\n+          based on video file location.\n+        metadata: (Sequence[Tuple[str, str]]) Optional.\n+          Additional metadata that is provided to the method.\n+    \"\"\"\n+    super(AnnotateVideo, self).__init__()\n+    self.features = features\n+    self.video_context = video_context\n+    self.location_id = location_id\n+    self.metadata = metadata\n+\n+  def expand(self, pvalue):\n+    return pvalue | ParDo(\n+        self._VideoAnnotateFn(\n+            features=self.features,\n+            video_context=self.video_context,\n+            location_id=self.location_id,\n+            metadata=self.metadata))\n+\n+  @typehints.with_input_types(Union[text_type, binary_type])\n+  class _VideoAnnotateFn(DoFn):\n+    \"\"\" A ``DoFn`` that sends every element to the GCP Video Intelligence API\n+      and returns a PCollection of\n+    ``google.cloud.videointelligence_v1.types.AnnotateVideoResponse``.\n+     \"\"\"\n+    def __init__(self, features, video_context, location_id, metadata):\n+      super(AnnotateVideo._VideoAnnotateFn, self).__init__()\n+      self._client = None\n+      self.features = features\n+      self.video_context = video_context\n+      self.location_id = location_id\n+      self.metadata = metadata\n+      self.counter = Metrics.counter(self.__class__, \"API Calls\")\n+\n+    def start_bundle(self):\n+      self._client = helper.get_videointelligence_client()\n+\n+    def process(self, element, *args, **kwargs):\n+      if isinstance(element, text_type):  # Is element an URI to a GCS bucket\n+        response = self._client.annotate_video(\n+            input_uri=element,\n+            features=self.features,\n+            video_context=self.video_context,\n+            location_id=self.location_id,\n+            metadata=self.metadata)\n+      elif isinstance(element, binary_type):  # Is element raw bytes\n+        response = self._client.annotate_video(\n+            input_content=element,\n+            features=self.features,\n+            video_context=self.video_context,\n+            location_id=self.location_id,\n+            metadata=self.metadata)\n+      else:\n+        raise TypeError(\n+            \"{}: input element needs to be either {} or {}\"\n+            \" got {} instead\".format(\n+                self.__class__.__name__, text_type, binary_type, type(element)))\n+      self.counter.inc()\n+      yield response.result(timeout=120)", "originalCommit": "c1abf00aff393c3e72e8837bc23e45c865ed0520", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjAwMDIzMg==", "url": "https://github.com/apache/beam/pull/10764#discussion_r376000232", "bodyText": "Possibly. I haven't used the API enough to say for sure, but we could make it configurable.", "author": "EDjur", "createdAt": "2020-02-06T18:15:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTk4MTAxNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjAwODc5NA==", "url": "https://github.com/apache/beam/pull/10764#discussion_r376008794", "bodyText": "I think we can make it a default argument to transform with the same default. It would be up to the users to change if they need to.", "author": "aaltay", "createdAt": "2020-02-06T18:33:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTk4MTAxNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTk4MjA5NQ==", "url": "https://github.com/apache/beam/pull/10764#discussion_r375982095", "bodyText": "DoFn does not return a PCollection. Maybe we can update this to something like\nA DoFn that sends each input element to the GCP Video Intelligence API service and outputs an element with the return result of the API.", "author": "aaltay", "createdAt": "2020-02-06T17:39:06Z", "path": "sdks/python/apache_beam/ml/gcp/video_intelligence.py", "diffHunk": "@@ -0,0 +1,107 @@\n+#\n+# Licensed to the Apache Software Foundation (ASF) under one or more\n+# contributor license agreements.  See the NOTICE file distributed with\n+# this work for additional information regarding copyright ownership.\n+# The ASF licenses this file to You under the Apache License, Version 2.0\n+# (the \"License\"); you may not use this file except in compliance with\n+# the License.  You may obtain a copy of the License at\n+#\n+#    http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+#\n+\n+\"\"\"\n+A connector for sending API requests to the GCP Video Intelligence API.\n+\"\"\"\n+from __future__ import absolute_import\n+\n+from future.utils import binary_type, text_type\n+from typing import Union\n+\n+from apache_beam import typehints\n+from apache_beam.ml.gcp import video_intelligence_helper as helper\n+from apache_beam.metrics import Metrics\n+from apache_beam.transforms import DoFn, ParDo, PTransform\n+\n+__all__ = ['AnnotateVideo']\n+\n+\n+class AnnotateVideo(PTransform):\n+  \"\"\"A ``PTransform`` for annotating video using the GCP Video Intelligence API\n+  ref: https://cloud.google.com/video-intelligence/docs\n+  \"\"\"\n+  def __init__(\n+      self, features, video_context=None, location_id=None, metadata=None):\n+    \"\"\"\n+      Args:\n+        features: (List[``videointelligence_v1.enums.Feature``]) Required.\n+          the Video Intelligence API features to detect\n+        video_context: (dict, ``videointelligence_v1.types.VideoContext``)\n+          Optional.\n+          Additional video context and/or feature-specific parameters.\n+        location_id: (str) Optional.\n+          Cloud region where annotation should take place.\n+          If no region is specified, a region will be determined\n+          based on video file location.\n+        metadata: (Sequence[Tuple[str, str]]) Optional.\n+          Additional metadata that is provided to the method.\n+    \"\"\"\n+    super(AnnotateVideo, self).__init__()\n+    self.features = features\n+    self.video_context = video_context\n+    self.location_id = location_id\n+    self.metadata = metadata\n+\n+  def expand(self, pvalue):\n+    return pvalue | ParDo(\n+        self._VideoAnnotateFn(\n+            features=self.features,\n+            video_context=self.video_context,\n+            location_id=self.location_id,\n+            metadata=self.metadata))\n+\n+  @typehints.with_input_types(Union[text_type, binary_type])\n+  class _VideoAnnotateFn(DoFn):\n+    \"\"\" A ``DoFn`` that sends every element to the GCP Video Intelligence API", "originalCommit": "c1abf00aff393c3e72e8837bc23e45c865ed0520", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjAwMDM0Mw==", "url": "https://github.com/apache/beam/pull/10764#discussion_r376000343", "bodyText": "Gotcha, thanks!", "author": "EDjur", "createdAt": "2020-02-06T18:15:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTk4MjA5NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTk4Mjk3Mg==", "url": "https://github.com/apache/beam/pull/10764#discussion_r375982972", "bodyText": "Should we guard this similar to other optional dependencies (example: https://github.com/apache/beam/blob/master/sdks/python/apache_beam/io/gcp/gcsio.py#L53)", "author": "aaltay", "createdAt": "2020-02-06T17:40:53Z", "path": "sdks/python/apache_beam/ml/gcp/video_intelligence_helper.py", "diffHunk": "@@ -0,0 +1,36 @@\n+#\n+# Licensed to the Apache Software Foundation (ASF) under one or more\n+# contributor license agreements.  See the NOTICE file distributed with\n+# this work for additional information regarding copyright ownership.\n+# The ASF licenses this file to You under the Apache License, Version 2.0\n+# (the \"License\"); you may not use this file except in compliance with\n+# the License.  You may obtain a copy of the License at\n+#\n+#    http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+#\n+\n+\"\"\"\n+Cloud Video Intelligence client\n+\n+For internal use only; no backwards-compatibility guarantees.\n+\"\"\"\n+\n+# pytype: skip-file\n+\n+from __future__ import absolute_import\n+\n+from cachetools.func import ttl_cache\n+from google.cloud import videointelligence", "originalCommit": "c1abf00aff393c3e72e8837bc23e45c865ed0520", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTk4MzY4Mw==", "url": "https://github.com/apache/beam/pull/10764#discussion_r375983683", "bodyText": "Are we expecting to use this for other APIs as well?", "author": "aaltay", "createdAt": "2020-02-06T17:42:15Z", "path": "sdks/python/apache_beam/ml/gcp/video_intelligence_helper.py", "diffHunk": "@@ -0,0 +1,36 @@\n+#\n+# Licensed to the Apache Software Foundation (ASF) under one or more\n+# contributor license agreements.  See the NOTICE file distributed with\n+# this work for additional information regarding copyright ownership.\n+# The ASF licenses this file to You under the Apache License, Version 2.0\n+# (the \"License\"); you may not use this file except in compliance with\n+# the License.  You may obtain a copy of the License at\n+#\n+#    http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+#\n+\n+\"\"\"\n+Cloud Video Intelligence client\n+\n+For internal use only; no backwards-compatibility guarantees.\n+\"\"\"\n+\n+# pytype: skip-file\n+\n+from __future__ import absolute_import\n+\n+from cachetools.func import ttl_cache\n+from google.cloud import videointelligence\n+\n+\n+@ttl_cache(maxsize=128, ttl=3600)\n+def get_videointelligence_client():", "originalCommit": "c1abf00aff393c3e72e8837bc23e45c865ed0520", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjAwMDgzMg==", "url": "https://github.com/apache/beam/pull/10764#discussion_r376000832", "bodyText": "I don't think so no, so it would make sense to merge this code into the main videointelligence file.", "author": "EDjur", "createdAt": "2020-02-06T18:16:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTk4MzY4Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTk5Nzk1OQ==", "url": "https://github.com/apache/beam/pull/10764#discussion_r375997959", "bodyText": "Does the API have support for batching? If yes, it might be a good feature to support.", "author": "aaltay", "createdAt": "2020-02-06T18:10:57Z", "path": "sdks/python/apache_beam/ml/gcp/video_intelligence.py", "diffHunk": "@@ -0,0 +1,107 @@\n+#\n+# Licensed to the Apache Software Foundation (ASF) under one or more\n+# contributor license agreements.  See the NOTICE file distributed with\n+# this work for additional information regarding copyright ownership.\n+# The ASF licenses this file to You under the Apache License, Version 2.0\n+# (the \"License\"); you may not use this file except in compliance with\n+# the License.  You may obtain a copy of the License at\n+#\n+#    http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+#\n+\n+\"\"\"\n+A connector for sending API requests to the GCP Video Intelligence API.\n+\"\"\"\n+from __future__ import absolute_import\n+\n+from future.utils import binary_type, text_type\n+from typing import Union\n+\n+from apache_beam import typehints\n+from apache_beam.ml.gcp import video_intelligence_helper as helper\n+from apache_beam.metrics import Metrics\n+from apache_beam.transforms import DoFn, ParDo, PTransform\n+\n+__all__ = ['AnnotateVideo']\n+\n+\n+class AnnotateVideo(PTransform):\n+  \"\"\"A ``PTransform`` for annotating video using the GCP Video Intelligence API\n+  ref: https://cloud.google.com/video-intelligence/docs\n+  \"\"\"\n+  def __init__(\n+      self, features, video_context=None, location_id=None, metadata=None):\n+    \"\"\"\n+      Args:\n+        features: (List[``videointelligence_v1.enums.Feature``]) Required.\n+          the Video Intelligence API features to detect\n+        video_context: (dict, ``videointelligence_v1.types.VideoContext``)\n+          Optional.\n+          Additional video context and/or feature-specific parameters.\n+        location_id: (str) Optional.\n+          Cloud region where annotation should take place.\n+          If no region is specified, a region will be determined\n+          based on video file location.\n+        metadata: (Sequence[Tuple[str, str]]) Optional.\n+          Additional metadata that is provided to the method.\n+    \"\"\"\n+    super(AnnotateVideo, self).__init__()\n+    self.features = features\n+    self.video_context = video_context\n+    self.location_id = location_id\n+    self.metadata = metadata\n+\n+  def expand(self, pvalue):\n+    return pvalue | ParDo(\n+        self._VideoAnnotateFn(\n+            features=self.features,\n+            video_context=self.video_context,\n+            location_id=self.location_id,\n+            metadata=self.metadata))\n+\n+  @typehints.with_input_types(Union[text_type, binary_type])\n+  class _VideoAnnotateFn(DoFn):\n+    \"\"\" A ``DoFn`` that sends every element to the GCP Video Intelligence API\n+      and returns a PCollection of\n+    ``google.cloud.videointelligence_v1.types.AnnotateVideoResponse``.\n+     \"\"\"\n+    def __init__(self, features, video_context, location_id, metadata):\n+      super(AnnotateVideo._VideoAnnotateFn, self).__init__()\n+      self._client = None\n+      self.features = features\n+      self.video_context = video_context\n+      self.location_id = location_id\n+      self.metadata = metadata\n+      self.counter = Metrics.counter(self.__class__, \"API Calls\")\n+\n+    def start_bundle(self):\n+      self._client = helper.get_videointelligence_client()\n+\n+    def process(self, element, *args, **kwargs):\n+      if isinstance(element, text_type):  # Is element an URI to a GCS bucket", "originalCommit": "c1abf00aff393c3e72e8837bc23e45c865ed0520", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjAwNDE5MA==", "url": "https://github.com/apache/beam/pull/10764#discussion_r376004190", "bodyText": "As far as I can tell, it does not support batching https://cloud.google.com/video-intelligence/docs/reference/rest/v1/videos/annotate. But I may be wrong.", "author": "EDjur", "createdAt": "2020-02-06T18:23:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTk5Nzk1OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjAwNzk3NA==", "url": "https://github.com/apache/beam/pull/10764#discussion_r376007974", "bodyText": "Sounds good. Thank you for checking.", "author": "aaltay", "createdAt": "2020-02-06T18:31:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTk5Nzk1OQ=="}], "type": "inlineReview"}, {"oid": "bfe848a4ac0d31ca83058cb197cae6a816ab9b6b", "url": "https://github.com/apache/beam/commit/bfe848a4ac0d31ca83058cb197cae6a816ab9b6b", "message": "Merged helper into main file. Added timeout default arg. Doc fixes.", "committedDate": "2020-02-06T18:53:02Z", "type": "commit"}, {"oid": "ebb701c6202ac1ac0b3d5d5992e78807bd868b2e", "url": "https://github.com/apache/beam/commit/ebb701c6202ac1ac0b3d5d5992e78807bd868b2e", "message": "Optimise imports", "committedDate": "2020-02-06T18:56:52Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjAyOTY3NA==", "url": "https://github.com/apache/beam/pull/10764#discussion_r376029674", "bodyText": "We can default the timeout to 120 here. If you think that is a reasonable default.", "author": "aaltay", "createdAt": "2020-02-06T19:15:12Z", "path": "sdks/python/apache_beam/ml/gcp/video_intelligence.py", "diffHunk": "@@ -0,0 +1,131 @@\n+#\n+# Licensed to the Apache Software Foundation (ASF) under one or more\n+# contributor license agreements.  See the NOTICE file distributed with\n+# this work for additional information regarding copyright ownership.\n+# The ASF licenses this file to You under the Apache License, Version 2.0\n+# (the \"License\"); you may not use this file except in compliance with\n+# the License.  You may obtain a copy of the License at\n+#\n+#    http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+#\n+\n+\"\"\"\n+A connector for sending API requests to the GCP Video Intelligence API.\n+\"\"\"\n+from __future__ import absolute_import\n+\n+from cachetools.func import ttl_cache\n+from future.utils import binary_type, text_type\n+from typing import Union\n+\n+from apache_beam import typehints\n+from apache_beam.metrics import Metrics\n+from apache_beam.transforms import DoFn, ParDo, PTransform\n+\n+try:\n+  from google.cloud import videointelligence\n+except ImportError:\n+  raise ImportError(\n+      'Google Cloud Video Intelligence not supported for this execution environment '\n+      '(could not import google.cloud.videointelligence).')\n+\n+__all__ = ['AnnotateVideo']\n+\n+\n+@ttl_cache(maxsize=128, ttl=3600)\n+def get_videointelligence_client():\n+  \"\"\"Returns a Cloud Video Intelligence client.\"\"\"\n+  _client = videointelligence.VideoIntelligenceServiceClient()\n+  return _client\n+\n+\n+class AnnotateVideo(PTransform):\n+  \"\"\"A ``PTransform`` for annotating video using the GCP Video Intelligence API\n+  ref: https://cloud.google.com/video-intelligence/docs\n+  \"\"\"\n+  def __init__(\n+      self,\n+      features,\n+      video_context=None,\n+      location_id=None,\n+      metadata=None,\n+      timeout=120):\n+    \"\"\"\n+      Args:\n+        features: (List[``videointelligence_v1.enums.Feature``]) Required.\n+          the Video Intelligence API features to detect\n+        video_context: (dict, ``videointelligence_v1.types.VideoContext``)\n+          Optional.\n+          Additional video context and/or feature-specific parameters.\n+        location_id: (str) Optional.\n+          Cloud region where annotation should take place.\n+          If no region is specified, a region will be determined\n+          based on video file location.\n+        metadata: (Sequence[Tuple[str, str]]) Optional.\n+          Additional metadata that is provided to the method.\n+        timeout: (int) Optional.\n+          The time in seconds to wait for the response from the Video Intelligence API\n+    \"\"\"\n+    super(AnnotateVideo, self).__init__()\n+    self.features = features\n+    self.video_context = video_context\n+    self.location_id = location_id\n+    self.metadata = metadata\n+    self.timeout = timeout\n+\n+  def expand(self, pvalue):\n+    return pvalue | ParDo(\n+        self._VideoAnnotateFn(\n+            features=self.features,\n+            video_context=self.video_context,\n+            location_id=self.location_id,\n+            metadata=self.metadata,\n+            timeout=self.timeout))\n+\n+  @typehints.with_input_types(Union[text_type, binary_type])\n+  class _VideoAnnotateFn(DoFn):\n+    \"\"\" A DoFn that sends each input element to the GCP Video Intelligence API\n+        service and outputs an element with the return result of the API\n+        (``google.cloud.videointelligence_v1.types.AnnotateVideoResponse``).\n+     \"\"\"\n+    def __init__(self, features, video_context, location_id, metadata, timeout):", "originalCommit": "ebb701c6202ac1ac0b3d5d5992e78807bd868b2e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "50e5be0ac80fccaa499732ce68e147370b303d3e", "url": "https://github.com/apache/beam/commit/50e5be0ac80fccaa499732ce68e147370b303d3e", "message": "Rename to make more consistent with the rest of BEAM", "committedDate": "2020-02-10T08:17:15Z", "type": "commit"}, {"oid": "a3d596188e1d4548d5f8f9c464bcccf5137e8a33", "url": "https://github.com/apache/beam/commit/a3d596188e1d4548d5f8f9c464bcccf5137e8a33", "message": "Docstring 'video_intelligence' -> 'videointelligenceml'", "committedDate": "2020-02-10T08:20:45Z", "type": "commit"}, {"oid": "73e14a6bee706c330e5365acd90cf053e2cd6509", "url": "https://github.com/apache/beam/commit/73e14a6bee706c330e5365acd90cf053e2cd6509", "message": "yapf formatting", "committedDate": "2020-02-11T08:14:44Z", "type": "commit"}, {"oid": "c1f8944275afb1072ac0946d739f9a2d58ee48db", "url": "https://github.com/apache/beam/commit/c1f8944275afb1072ac0946d739f9a2d58ee48db", "message": "Merge branch 'master' into BEAM-9146/gcp-video-intelligence", "committedDate": "2020-02-11T19:20:45Z", "type": "commit"}, {"oid": "7450cea79c4ef4bd5ef3196c096039681b227472", "url": "https://github.com/apache/beam/commit/7450cea79c4ef4bd5ef3196c096039681b227472", "message": "Added new feature note in changes.md", "committedDate": "2020-02-11T19:24:54Z", "type": "commit"}, {"oid": "2723b7193f25deca7f7f1677f173f7b5e489022d", "url": "https://github.com/apache/beam/commit/2723b7193f25deca7f7f1677f173f7b5e489022d", "message": "Lint fixes", "committedDate": "2020-02-12T21:14:01Z", "type": "commit"}, {"oid": "69509dd181dc83f8555af5390b34df29b5b561ac", "url": "https://github.com/apache/beam/commit/69509dd181dc83f8555af5390b34df29b5b561ac", "message": "Merge branch 'master' into BEAM-9146/gcp-video-intelligence", "committedDate": "2020-02-12T21:21:22Z", "type": "commit"}, {"oid": "4a3b8dbf5c5d0c021bbe9b7d12bf42ed4c30bf88", "url": "https://github.com/apache/beam/commit/4a3b8dbf5c5d0c021bbe9b7d12bf42ed4c30bf88", "message": "Disabled correct pylint metric", "committedDate": "2020-02-12T21:34:20Z", "type": "commit"}, {"oid": "03135c515d3ddb810ddc5883e22b19f2115708f3", "url": "https://github.com/apache/beam/commit/03135c515d3ddb810ddc5883e22b19f2115708f3", "message": "Re-ordered imports", "committedDate": "2020-02-13T08:10:30Z", "type": "commit"}, {"oid": "ababbf6c48d843f63bb3e32e8299c55eae75d9d4", "url": "https://github.com/apache/beam/commit/ababbf6c48d843f63bb3e32e8299c55eae75d9d4", "message": "Re-ordered imports", "committedDate": "2020-02-13T10:06:53Z", "type": "commit"}, {"oid": "6818f354db5dd943daa981b8b7041ce7dfd5fd8f", "url": "https://github.com/apache/beam/commit/6818f354db5dd943daa981b8b7041ce7dfd5fd8f", "message": "Added call to unittest.main() in tests", "committedDate": "2020-02-13T10:56:31Z", "type": "commit"}, {"oid": "4c9a150575c29f67a8126929605d059adba3d470", "url": "https://github.com/apache/beam/commit/4c9a150575c29f67a8126929605d059adba3d470", "message": "Split into 2 PTransforms -> 1. Video context as side input. 2. Video context as part of element tuple", "committedDate": "2020-02-18T13:23:52Z", "type": "commit"}, {"oid": "86356f74183f23e9f3b9abc3ba6825f26cc4ad65", "url": "https://github.com/apache/beam/commit/86356f74183f23e9f3b9abc3ba6825f26cc4ad65", "message": "Merge branch 'master' into BEAM-9146/gcp-video-intelligence", "committedDate": "2020-02-18T13:24:29Z", "type": "commit"}, {"oid": "702e3d7732ad37c1bd3a693be86f6ae3b8d81b75", "url": "https://github.com/apache/beam/commit/702e3d7732ad37c1bd3a693be86f6ae3b8d81b75", "message": "Added AnnotateVideoWithContext to CHANGES.md", "committedDate": "2020-02-18T13:29:21Z", "type": "commit"}, {"oid": "63e7044f314a06c1dbc505886f657a4c5cf0e381", "url": "https://github.com/apache/beam/commit/63e7044f314a06c1dbc505886f657a4c5cf0e381", "message": "Merge branch 'master' into BEAM-9146/gcp-video-intelligence", "committedDate": "2020-02-18T16:41:33Z", "type": "commit"}, {"oid": "4c3af025815a5468c0e76e9127f460f1e5d4fea1", "url": "https://github.com/apache/beam/commit/4c3af025815a5468c0e76e9127f460f1e5d4fea1", "message": "Add final new line.", "committedDate": "2020-02-18T19:28:14Z", "type": "commit"}, {"oid": "26a19b0c951fe4e0f54a595f028006105e50f12f", "url": "https://github.com/apache/beam/commit/26a19b0c951fe4e0f54a595f028006105e50f12f", "message": "Fixed pycommon:docs issue", "committedDate": "2020-02-19T11:22:38Z", "type": "commit"}]}