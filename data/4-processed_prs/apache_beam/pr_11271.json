{"pr_number": 11271, "pr_title": "[BEAM-9624] Adds Convert to Accumulators operator for use in combiner lifting for streaming pipelines", "pr_createdAt": "2020-03-30T23:47:00Z", "pr_url": "https://github.com/apache/beam/pull/11271", "timeline": [{"oid": "3e155c705599da7b4c84966ed8cff678725e7576", "url": "https://github.com/apache/beam/commit/3e155c705599da7b4c84966ed8cff678725e7576", "message": "Adds convert_to_accumulators URN and associated implementations for Go/Java/Python SDKs.", "committedDate": "2020-03-30T20:35:07Z", "type": "commit"}, {"oid": "5cf8f0ae0baafa5e461cb801951f39d4c79699c0", "url": "https://github.com/apache/beam/commit/5cf8f0ae0baafa5e461cb801951f39d4c79699c0", "message": "Fixes copy-paste error in proto comments.", "committedDate": "2020-03-30T20:47:19Z", "type": "commit"}, {"oid": "5ed8dc9840488888130b48b18f38648497163366", "url": "https://github.com/apache/beam/commit/5ed8dc9840488888130b48b18f38648497163366", "message": "Fixes spelling error in comment.", "committedDate": "2020-03-30T21:06:45Z", "type": "commit"}, {"oid": "77b84cf8bfb940b014ea73b7247d0ba4ddd3507f", "url": "https://github.com/apache/beam/commit/77b84cf8bfb940b014ea73b7247d0ba4ddd3507f", "message": "Add test for Java ConvertToAccumulators.", "committedDate": "2020-03-30T21:49:55Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDYwOTA4NA==", "url": "https://github.com/apache/beam/pull/11271#discussion_r400609084", "bodyText": "Please add to the checkState in the static initialization block to make sure this value doesn't deviate from the string constant here.\nNote, we do it this way so the Java compiler can treat the value as a string constant.", "author": "lukecwik", "createdAt": "2020-03-31T02:41:21Z", "path": "runners/core-construction-java/src/main/java/org/apache/beam/runners/core/construction/PTransformTranslation.java", "diffHunk": "@@ -101,6 +101,8 @@\n       \"beam:transform:combine_per_key_merge_accumulators:v1\";\n   public static final String COMBINE_PER_KEY_EXTRACT_OUTPUTS_TRANSFORM_URN =\n       \"beam:transform:combine_per_key_extract_outputs:v1\";\n+  public static final String COMBINE_PER_KEY_CONVERT_TO_ACCUMULATORS_TRANSFORM_URN =", "originalCommit": "77b84cf8bfb940b014ea73b7247d0ba4ddd3507f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTI4ODI0MA==", "url": "https://github.com/apache/beam/pull/11271#discussion_r401288240", "bodyText": "Done!", "author": "acrites", "createdAt": "2020-04-01T00:21:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDYwOTA4NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDYxMDYyOA==", "url": "https://github.com/apache/beam/pull/11271#discussion_r400610628", "bodyText": "Please add a test like Combine/LiftedCombine: \n  \n    \n      beam/sdks/go/pkg/beam/core/runtime/exec/combine_test.go\n    \n    \n         Line 84\n      in\n      c8e200b\n    \n    \n    \n    \n\n        \n          \n           func TestLiftedCombine(t *testing.T) {", "author": "lukecwik", "createdAt": "2020-03-31T02:47:37Z", "path": "sdks/go/pkg/beam/core/runtime/exec/combine.go", "diffHunk": "@@ -499,3 +499,30 @@ func (n *ExtractOutput) ProcessElement(ctx context.Context, value *FullValue, va\n \t}\n \treturn n.Out.ProcessElement(n.Combine.ctx, &FullValue{Windows: value.Windows, Elm: value.Elm, Elm2: out, Timestamp: value.Timestamp})\n }\n+\n+// ConvertToAccumulators is an executor for converting an input value to an accumulator value.\n+type ConvertToAccumulators struct {\n+\t*Combine\n+}\n+\n+func (n *ConvertToAccumulators) String() string {", "originalCommit": "77b84cf8bfb940b014ea73b7247d0ba4ddd3507f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTI4ODU4Ng==", "url": "https://github.com/apache/beam/pull/11271#discussion_r401288586", "bodyText": "Talked with Robert and we came up with TestConvertToAccumulators.", "author": "acrites", "createdAt": "2020-04-01T00:22:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDYxMDYyOA=="}], "type": "inlineReview"}, {"oid": "f6cacc102dc7b4a32c9c11ce73af8069680ea970", "url": "https://github.com/apache/beam/commit/f6cacc102dc7b4a32c9c11ce73af8069680ea970", "message": "Adds a test for go and extra checking in java translation.", "committedDate": "2020-04-01T00:20:28Z", "type": "commit"}, {"oid": "d650fe4b0fdccc5213dceda5677dfa04f38814aa", "url": "https://github.com/apache/beam/commit/d650fe4b0fdccc5213dceda5677dfa04f38814aa", "message": "Merge remote-tracking branch 'upstream/master' into convert-to-accumulators", "committedDate": "2020-04-01T00:39:23Z", "type": "commit"}, {"oid": "fb9e9f14d6df0639afb77deb57e5c992ac4e9b19", "url": "https://github.com/apache/beam/commit/fb9e9f14d6df0639afb77deb57e5c992ac4e9b19", "message": "Changes number of parameters to createRunnerForPTransform since signature changed.", "committedDate": "2020-04-01T00:43:01Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTMxODA0NA==", "url": "https://github.com/apache/beam/pull/11271#discussion_r401318044", "bodyText": "This will validate that you get the right output but doesn't actually ensure that convertToAccumulators didn't do any combining.\nIt might be worthwhile to just test the convertToAccumulators step without any of the other steps alongside it.", "author": "lukecwik", "createdAt": "2020-04-01T02:17:30Z", "path": "sdks/go/pkg/beam/core/runtime/exec/combine_test.go", "diffHunk": "@@ -113,6 +113,40 @@ func TestLiftedCombine(t *testing.T) {\n \n }\n \n+// TestConvertToaccumulators verifies that if we just do ConvertToAccumulators instead\n+// of LiftedCombine before the GBK we still get the right answer.\n+func TestConvertToAccumulators(t *testing.T) {\n+\twithCoder := func(t *testing.T, suffix string, key interface{}, keyCoder *coder.Coder) {\n+\t\tfor _, test := range tests {\n+\t\t\tt.Run(fnName(test.Fn)+\"_\"+suffix, func(t *testing.T) {\n+\t\t\t\tedge := getCombineEdge(t, test.Fn, reflectx.Int, test.AccumCoder)\n+\n+\t\t\t\tout := &CaptureNode{UID: 1}\n+\t\t\t\textract := &ExtractOutput{Combine: &Combine{UID: 2, Fn: edge.CombineFn, Out: out}}\n+\t\t\t\tmerge := &MergeAccumulators{Combine: &Combine{UID: 3, Fn: edge.CombineFn, Out: extract}}\n+\t\t\t\tgbk := &simpleGBK{UID: 4, KeyCoder: keyCoder, Out: merge}\n+\t\t\t\tconvertToAccumulators := &ConvertToAccumulators{Combine: &Combine{UID: 5, Fn: edge.CombineFn, Out: gbk}}", "originalCommit": "f6cacc102dc7b4a32c9c11ce73af8069680ea970", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTgyNTE4NA==", "url": "https://github.com/apache/beam/pull/11271#discussion_r401825184", "bodyText": "Good point. Updated the test.", "author": "acrites", "createdAt": "2020-04-01T18:33:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTMxODA0NA=="}], "type": "inlineReview"}, {"oid": "a3cf7514eddf23da6ffe7d4a0e45807a11d3f1ec", "url": "https://github.com/apache/beam/commit/a3cf7514eddf23da6ffe7d4a0e45807a11d3f1ec", "message": "Changes ConvertToAccumulator test to only test the ConverToAccumulators phase.", "committedDate": "2020-04-01T18:30:59Z", "type": "commit"}]}