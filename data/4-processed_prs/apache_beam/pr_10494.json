{"pr_number": 10494, "pr_title": "typehint fixes to DoOutputsTuple", "pr_createdAt": "2020-01-03T01:30:02Z", "pr_url": "https://github.com/apache/beam/pull/10494", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDU2NTY3NA==", "url": "https://github.com/apache/beam/pull/10494#discussion_r364565674", "bodyText": "This doesn't seem safe to me. We should not be promoting the type from PValue to a PCollection unless we can actually guarantee that it will always be a PCollection here.  As far as I can tell, it may actually be PValue, but correct me if I'm wrong.\nHere's how I came to that conclusion.\nThe code where AppliedPTransform.outputs is assigned values seems to indicate it should be a mapping of PValue:\n  def add_output(self,\n                 output,  # type: Union[pvalue.DoOutputsTuple, pvalue.PValue]\n                 tag=None  # type: Union[str, int, None]\n                ):\n    # type: (...) -> None\n    if isinstance(output, pvalue.DoOutputsTuple):\n      self.add_output(output[output._main_tag])\n    elif isinstance(output, pvalue.PValue):\n      # TODO(BEAM-1833): Require tags when calling this method.\n      if tag is None and None in self.outputs:\n        tag = len(self.outputs)\n      assert tag not in self.outputs\n      self.outputs[tag] = output\n    elif isinstance(output, dict):\n      for output_tag, out in output.items():\n        self.add_output(out, tag=output_tag)\n    else:\n      raise TypeError(\"Unexpected output type: %s\" % output)\nAs a result, I have typed AppliedPTransform.outputs as Dict[Union[str, int, None], pvalue.PValue].  If it's the case that AppliedPTransform.outputs only holds PCollections then we should enforce that in the isinstance check above (and elsewhere) and in the typing for AppliedPTransform.\n\nAlso note that the trailing # type: PCollection used here has no effect in mypy, and in fact it generates an error.  In mypy, you can only use this the first time that a variable is defined (e.g. for pcoll that's line 300 above this), and you can only use it to broaden a type (as I did originally, going from PCollection to PValue).   Narrowing the type is basically disregarding/overriding the inspected type, so that requires using typing.cast().\nThis is why I'm really wary of supporting pytype.", "author": "chadrik", "createdAt": "2020-01-09T05:35:02Z", "path": "sdks/python/apache_beam/pvalue.py", "diffHunk": "@@ -308,7 +308,7 @@ def __getitem__(self, tag):\n         self.producer.add_output(pcoll, tag)\n     else:\n       # Main output is output of inner ParDo.\n-      pcoll = self.producer.parts[0].outputs[None]\n+      pcoll = self.producer.parts[0].outputs[None]  # type: PCollection", "originalCommit": "2d4fb15414124a10cc7d03e818c2cdb7938ed768", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDU2NzQ5OA==", "url": "https://github.com/apache/beam/pull/10494#discussion_r364567498", "bodyText": "If everyone is in agreement that AppliedPTransform.outputs can only hold PCollections then the typing for AppliedPTransform should be fixed.  Doing it this way -- simply overriding the type -- is a superficial fix that leaves the door open for this problem to happen elsewhere in the code where AppliedPTransform is used  (and as I mentioned, it doesn't actually work for mypy).", "author": "chadrik", "createdAt": "2020-01-09T05:45:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDU2NTY3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTA0MDQ5OQ==", "url": "https://github.com/apache/beam/pull/10494#discussion_r365040499", "bodyText": "IIUC, DoOutputsTuple could only follow a ParDo and its outputs should be PCollection's. However this contract is not really captured in the code. You are right that AppliedPTransform.outputs could have types of PValue, but this should not be the case for DoOutputsTuple.", "author": "aaltay", "createdAt": "2020-01-10T01:42:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDU2NTY3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTA0OTExNA==", "url": "https://github.com/apache/beam/pull/10494#discussion_r365049114", "bodyText": "understood.  If we're confident about that contract I think the proper way to solve this would be something like this:\n      pval = self.producer.parts[0].outputs[None]\n      assert isinstance(pval, PCollection), \"DoOutputsTuple should follow a ParDo\"\n      pcoll = pval\nIf you want to be a bit more formal you could raise a TypeError or the like.\nThat will naturally narrow the type of pcoll.  The reason for the temporary variable pval is that you cannot assign of type PValue to a variable already defined as PCollection (above in the if tag is not None block).", "author": "chadrik", "createdAt": "2020-01-10T02:27:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDU2NTY3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTQ3NDIyOA==", "url": "https://github.com/apache/beam/pull/10494#discussion_r365474228", "bodyText": "The types here are correct, self._pcolls should be a map to PCollections. This PR looks like an improvement to me. Would you be OK with this going in (with the assertion to do the type restriction)?\n(FWIW, it'd be nice to clean up the whole DoOutputsTuple thing, and how inputs and outputs are represented in general, but that's another issue.)", "author": "robertwb", "createdAt": "2020-01-10T23:51:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDU2NTY3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTQ4MzQzOQ==", "url": "https://github.com/apache/beam/pull/10494#discussion_r365483439", "bodyText": "yep, looks good to me.", "author": "chadrik", "createdAt": "2020-01-11T00:49:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDU2NTY3NA=="}], "type": "inlineReview"}, {"oid": "31a65e490f04a779a4cbc8cb1113a05c6beba8b3", "url": "https://github.com/apache/beam/commit/31a65e490f04a779a4cbc8cb1113a05c6beba8b3", "message": "typehint fixes", "committedDate": "2020-01-22T20:00:35Z", "type": "commit"}, {"oid": "e855036b9d5c9ffffad6b39ec283245b2f85f819", "url": "https://github.com/apache/beam/commit/e855036b9d5c9ffffad6b39ec283245b2f85f819", "message": "typehint fixes", "committedDate": "2020-01-22T20:00:36Z", "type": "commit"}, {"oid": "a8b99fbedad66a2cd2b4b1476844d530b8a3614a", "url": "https://github.com/apache/beam/commit/a8b99fbedad66a2cd2b4b1476844d530b8a3614a", "message": "Revert Optional changes.", "committedDate": "2020-01-22T20:00:36Z", "type": "commit"}, {"oid": "017064100dd7a01fe4f259fe20f8ab1a419eb545", "url": "https://github.com/apache/beam/commit/017064100dd7a01fe4f259fe20f8ab1a419eb545", "message": "Assert that DoOutputsTuple is used with PCollection types", "committedDate": "2020-01-22T20:00:36Z", "type": "commit"}, {"oid": "017064100dd7a01fe4f259fe20f8ab1a419eb545", "url": "https://github.com/apache/beam/commit/017064100dd7a01fe4f259fe20f8ab1a419eb545", "message": "Assert that DoOutputsTuple is used with PCollection types", "committedDate": "2020-01-22T20:00:36Z", "type": "forcePushed"}, {"oid": "4b85dac37cb1ff432df4c9952a36f729a81a3a84", "url": "https://github.com/apache/beam/commit/4b85dac37cb1ff432df4c9952a36f729a81a3a84", "message": "lint", "committedDate": "2020-01-22T21:19:47Z", "type": "commit"}]}