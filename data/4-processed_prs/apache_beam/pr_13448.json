{"pr_number": 13448, "pr_title": "[BEAM-9187] Address flake in loadBalancesBundles", "pr_createdAt": "2020-12-01T01:56:30Z", "pr_url": "https://github.com/apache/beam/pull/13448", "timeline": [{"oid": "3292bd0bb915322a3413476fa57323a46aec1905", "url": "https://github.com/apache/beam/commit/3292bd0bb915322a3413476fa57323a46aec1905", "message": "address flake in loadBalancesBundles", "committedDate": "2020-12-01T01:52:03Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzAyNDk3Nw==", "url": "https://github.com/apache/beam/pull/13448#discussion_r533024977", "bodyText": "nit: You can drop this, Future will catch exceptions, wrap them in a ExecutionException and throw them out of get.", "author": "apilloud", "createdAt": "2020-12-01T02:05:57Z", "path": "runners/java-fn-execution/src/test/java/org/apache/beam/runners/fnexecution/control/DefaultJobBundleFactoryTest.java", "diffHunk": "@@ -459,27 +461,28 @@ public void loadBalancesBundles() throws Exception {\n       verify(envFactory, Mockito.times(2)).createEnvironment(eq(environment), any());\n \n       long tms = System.currentTimeMillis();\n-      AtomicBoolean closed = new AtomicBoolean();\n-      // close to free up environment for another bundle\n-      TimerTask closeBundleTask =\n-          new TimerTask() {\n-            @Override\n-            public void run() {\n-              try {\n-                b2.close();\n-                closed.set(true);\n-              } catch (Exception e) {\n-                throw new RuntimeException(e);\n-              }\n-            }\n-          };\n-      new Timer().schedule(closeBundleTask, 100);\n-\n+      ScheduledExecutorService executor = Executors.newSingleThreadScheduledExecutor();\n+      ScheduledFuture<Optional<Exception>> closingFuture =\n+          executor.schedule(\n+              () -> {\n+                try {\n+                  b2.close();\n+                  return Optional.empty();\n+                } catch (Exception e) {", "originalCommit": "3292bd0bb915322a3413476fa57323a46aec1905", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzA0ODMwNA==", "url": "https://github.com/apache/beam/pull/13448#discussion_r533048304", "bodyText": "Hm could it be that Future only does that for unchecked exceptions? I had tried just making this executor.schedule(b2::close, ..) but it produces a compile error:\nincompatible thrown types Exception in method reference", "author": "TheNeuralBit", "createdAt": "2020-12-01T03:23:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzAyNDk3Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzYwNjY0Mg==", "url": "https://github.com/apache/beam/pull/13448#discussion_r533606642", "bodyText": "Yes only unchecked exceptions. It is odd to me that the Java AutoCloseable interface defines it as throwing Exception, but it does.", "author": "apilloud", "createdAt": "2020-12-01T17:50:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzAyNDk3Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzAyNjg2Nw==", "url": "https://github.com/apache/beam/pull/13448#discussion_r533026867", "bodyText": "nit: Small delays lead to flakes, for example if the system is busy and doesn't get back to the forked thread. Does having a small timeout add any value here? Could you just block?", "author": "apilloud", "createdAt": "2020-12-01T02:11:58Z", "path": "runners/java-fn-execution/src/test/java/org/apache/beam/runners/fnexecution/control/DefaultJobBundleFactoryTest.java", "diffHunk": "@@ -459,27 +461,28 @@ public void loadBalancesBundles() throws Exception {\n       verify(envFactory, Mockito.times(2)).createEnvironment(eq(environment), any());\n \n       long tms = System.currentTimeMillis();\n-      AtomicBoolean closed = new AtomicBoolean();\n-      // close to free up environment for another bundle\n-      TimerTask closeBundleTask =\n-          new TimerTask() {\n-            @Override\n-            public void run() {\n-              try {\n-                b2.close();\n-                closed.set(true);\n-              } catch (Exception e) {\n-                throw new RuntimeException(e);\n-              }\n-            }\n-          };\n-      new Timer().schedule(closeBundleTask, 100);\n-\n+      ScheduledExecutorService executor = Executors.newSingleThreadScheduledExecutor();\n+      ScheduledFuture<Optional<Exception>> closingFuture =\n+          executor.schedule(\n+              () -> {\n+                try {\n+                  b2.close();\n+                  return Optional.empty();\n+                } catch (Exception e) {\n+                  return Optional.of(e);\n+                }\n+              },\n+              100,\n+              TimeUnit.MILLISECONDS);\n+\n+      // This call should block until closingFuture has finished closing b2\n       RemoteBundle b3 = sbf.getBundle(orf, srh, BundleProgressHandler.ignored());\n \n-      // ensure we waited for close\n+      // ensure the previous call waited for close\n       Assert.assertThat(System.currentTimeMillis() - tms, greaterThanOrEqualTo(100L));\n-      Assert.assertThat(closed.get(), is(true));\n+      // This assertion includes a small delay to give the forked thread a chance to finish if it's\n+      // been blocked\n+      Assert.assertThat(closingFuture.get(1, TimeUnit.MILLISECONDS), equalTo(Optional.empty()));", "originalCommit": "3292bd0bb915322a3413476fa57323a46aec1905", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzA0OTU3NA==", "url": "https://github.com/apache/beam/pull/13448#discussion_r533049574", "bodyText": "Yeah agree a small delay isn't ideal.. my concern with blocking indefinitely is that it could return much later and the test would still pass which wouldn't be correct. It should be done.\nMaybe I'm just splitting hairs, the prior assertion on System time is pretty strong so we could just do without this one.", "author": "TheNeuralBit", "createdAt": "2020-12-01T03:28:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzAyNjg2Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzYzMzg5Ng==", "url": "https://github.com/apache/beam/pull/13448#discussion_r533633896", "bodyText": "That does seem like a good reason to want a timeout.\nHere are some possible ways to tighten things down further:\n\nSet tms in the thread just before calling close(), then check getBundle returns after that time. (This guards against the system is running slow and the thread scheduling after significantly more than 100ms.)\nMake the delay of 100 ms random. (This with 1 guards against a Thread.sleep(100L) implementation of getBundle.)", "author": "apilloud", "createdAt": "2020-12-01T18:34:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzAyNjg2Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDM0NTY5Mg==", "url": "https://github.com/apache/beam/pull/13448#discussion_r550345692", "bodyText": "Ok I did similar to your (1), but rather than setting tms I just set an AtomicBoolean prior to calling close, and verify it is set right after getBundle returns.", "author": "TheNeuralBit", "createdAt": "2020-12-30T22:33:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzAyNjg2Nw=="}], "type": "inlineReview"}, {"oid": "d9b381a38815587b7b78a9d017695ac163eb45a1", "url": "https://github.com/apache/beam/commit/d9b381a38815587b7b78a9d017695ac163eb45a1", "message": "Merge remote-tracking branch 'origin/master' into beam-9187", "committedDate": "2020-12-30T21:48:00Z", "type": "commit"}, {"oid": "137eb09d3abcf455753decdf280f8881c2781c9e", "url": "https://github.com/apache/beam/commit/137eb09d3abcf455753decdf280f8881c2781c9e", "message": "Check for close with AtomicBoolean", "committedDate": "2020-12-30T22:24:26Z", "type": "commit"}]}