{"pr_number": 11210, "pr_title": "[BEAM-8949] SpannerIO integration tests", "pr_createdAt": "2020-03-24T23:19:44Z", "pr_url": "https://github.com/apache/beam/pull/11210", "timeline": [{"oid": "84124235306bf5e7cc72c25da25377dcb965b1b6", "url": "https://github.com/apache/beam/commit/84124235306bf5e7cc72c25da25377dcb965b1b6", "message": "wip: added spannerio read integration tests", "committedDate": "2020-03-24T23:17:18Z", "type": "commit"}, {"oid": "bd04e4f6c3d5d94fa00a5d1d56f23cf37eef50c8", "url": "https://github.com/apache/beam/commit/bd04e4f6c3d5d94fa00a5d1d56f23cf37eef50c8", "message": "Merge branch 'master' into BEAM-8949_spannerio_read_ittest", "committedDate": "2020-03-25T14:41:21Z", "type": "commit"}, {"oid": "ef67e3b518a5eaf77c68919ae4bba0b704a45eed", "url": "https://github.com/apache/beam/commit/ef67e3b518a5eaf77c68919ae4bba0b704a45eed", "message": "Merge branch 'master' into BEAM-8949_spannerio_read_ittest", "committedDate": "2020-04-13T15:29:48Z", "type": "commit"}, {"oid": "7b552d1992d9729667b459b30f2ebf205d4ac9cc", "url": "https://github.com/apache/beam/commit/7b552d1992d9729667b459b30f2ebf205d4ac9cc", "message": "adds spanner io write it tests", "committedDate": "2020-04-13T15:41:29Z", "type": "commit"}, {"oid": "0349c2fe868aef31a04e0089b5a585ea9c8f6be5", "url": "https://github.com/apache/beam/commit/0349c2fe868aef31a04e0089b5a585ea9c8f6be5", "message": "fix formatter", "committedDate": "2020-04-13T16:13:52Z", "type": "commit"}, {"oid": "28492c5f63cede1e03b265af851475807813ca15", "url": "https://github.com/apache/beam/commit/28492c5f63cede1e03b265af851475807813ca15", "message": "fix batch pipeline and it test", "committedDate": "2020-04-20T14:49:32Z", "type": "commit"}, {"oid": "eb0fb1cb50c23d45c657a804fa8e82e52e9bc488", "url": "https://github.com/apache/beam/commit/eb0fb1cb50c23d45c657a804fa8e82e52e9bc488", "message": "Merge branch 'master' into BEAM-8949_spannerio_read_ittest", "committedDate": "2020-04-20T14:51:01Z", "type": "commit"}, {"oid": "21b2bd90201bf6eb59a472cdae103a05b08f934f", "url": "https://github.com/apache/beam/commit/21b2bd90201bf6eb59a472cdae103a05b08f934f", "message": "fix test db name", "committedDate": "2020-04-20T15:24:39Z", "type": "commit"}, {"oid": "b94b6a10c051f5147f7881fed24a265e192b1082", "url": "https://github.com/apache/beam/commit/b94b6a10c051f5147f7881fed24a265e192b1082", "message": "Merge branch 'master' into BEAM-8949_spannerio_read_ittest", "committedDate": "2020-04-20T18:18:12Z", "type": "commit"}, {"oid": "324b2c54ad356407a2520ab363e6088d57c3669e", "url": "https://github.com/apache/beam/commit/324b2c54ad356407a2520ab363e6088d57c3669e", "message": "fix linting issues", "committedDate": "2020-04-20T19:05:19Z", "type": "commit"}, {"oid": "05e6468955c42061f6b8ad2646bbd3f84a488f37", "url": "https://github.com/apache/beam/commit/05e6468955c42061f6b8ad2646bbd3f84a488f37", "message": "fix failed batch test cases and updates changes.md", "committedDate": "2020-04-21T07:27:14Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDAxNjY0NA==", "url": "https://github.com/apache/beam/pull/11210#discussion_r414016644", "bodyText": "I've updated the batch process to support the dataflow runner. The process is almost the same as the previous commit but now I've added the ToList() combine transform before passing the mutation groups from to the _BatchFn to create batches.", "author": "mszb", "createdAt": "2020-04-23T18:12:48Z", "path": "sdks/python/apache_beam/io/gcp/experimental/spannerio.py", "diffHunk": "@@ -1008,31 +1007,30 @@ def _reset_count(self):\n     self._cells = 0\n \n   def process(self, element):\n-    mg_info = element.info\n+    for elem in element:", "originalCommit": "05e6468955c42061f6b8ad2646bbd3f84a488f37", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTk1ODc0Mg==", "url": "https://github.com/apache/beam/pull/11210#discussion_r421958742", "bodyText": "Can you clarify ? Why would Dataflow need the elements to be combined to a list ? All runners should be able to operate on a PCollection of mutation groups.", "author": "chamikaramj", "createdAt": "2020-05-08T06:11:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDAxNjY0NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjEwMTgwNQ==", "url": "https://github.com/apache/beam/pull/11210#discussion_r422101805", "bodyText": "There was no issue in processing mutation group, the issue was with the batch size. According to the Beam execution model, \u2018The division of the collection into bundles is arbitrary and selected by the runner.\u2019 Which causes finish_bundle to be called multiple times rather than on the complete collection unit which causes the improper number of batches in the dataflow runner. That's the reason I've added the ToList transform to make a single collection and generate the batches properly.", "author": "mszb", "createdAt": "2020-05-08T11:55:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDAxNjY0NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjE4MDY5Mw==", "url": "https://github.com/apache/beam/pull/11210#discussion_r422180693", "bodyText": "\"Which causes finish_bundle to be called multiple times\" do you mean that finish_bundle will be called once per bundle ?\nThis is the expected behavior and users will observe this behavior as well. Implementation should work for arbitrary bundle sizes without users having to group PCollection elements together.", "author": "chamikaramj", "createdAt": "2020-05-08T14:37:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDAxNjY0NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjI4MDY3MQ==", "url": "https://github.com/apache/beam/pull/11210#discussion_r422280671", "bodyText": "Make sense, in that case, we don't need to alter the connector code anymore, it was working as expected. Thanks, @chamikaramj for the feedback as it is always helpful.\nI'll remove the changes from the spanner io connector and update the IT test code for the assertion.", "author": "mszb", "createdAt": "2020-05-08T17:48:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDAxNjY0NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjI4MjcwNg==", "url": "https://github.com/apache/beam/pull/11210#discussion_r422282706", "bodyText": "Thanks. Lemme know when this is ready for another look. Also lets trigger the IT with new changes to make sure it passes.", "author": "chamikaramj", "createdAt": "2020-05-08T17:52:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDAxNjY0NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjU2NzU4Nw==", "url": "https://github.com/apache/beam/pull/11210#discussion_r422567587", "bodyText": "Done!", "author": "mszb", "createdAt": "2020-05-10T01:10:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDAxNjY0NA=="}], "type": "inlineReview"}, {"oid": "72cc863fbc112f8fdce342bfc240146541c8cca7", "url": "https://github.com/apache/beam/commit/72cc863fbc112f8fdce342bfc240146541c8cca7", "message": "Merge branch 'master' into BEAM-8949_spannerio_read_ittest", "committedDate": "2020-04-28T10:39:57Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTk1ODMyOQ==", "url": "https://github.com/apache/beam/pull/11210#discussion_r421958329", "bodyText": "Why do we need to perform this combining to run the test ?", "author": "chamikaramj", "createdAt": "2020-05-08T06:09:56Z", "path": "sdks/python/apache_beam/io/gcp/experimental/spannerio_test.py", "diffHunk": "@@ -499,6 +499,7 @@ def test_batch_byte_size(\n       # and each bach should contains 25 mutations.\n       res = (\n           p | beam.Create(mutation_group)\n+          | 'combine to list' >> beam.combiners.ToList()", "originalCommit": "72cc863fbc112f8fdce342bfc240146541c8cca7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjEwNDEzNg==", "url": "https://github.com/apache/beam/pull/11210#discussion_r422104136", "bodyText": "Yes, the _BatchFn requires a single iterable of collection and loop through them to make the batches. Just replicating the same pipeline for the batching in the _WriteGroup transform.", "author": "mszb", "createdAt": "2020-05-08T12:01:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTk1ODMyOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjE4MTQ2Nw==", "url": "https://github.com/apache/beam/pull/11210#discussion_r422181467", "bodyText": "Do users have to do this as well ? Seems like we are missing something in the implementation. How does Java implementation operate ?", "author": "chamikaramj", "createdAt": "2020-05-08T14:39:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTk1ODMyOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjI4MDYxNA==", "url": "https://github.com/apache/beam/pull/11210#discussion_r422280614", "bodyText": "The user does not have to add ToList transform in the production pipeline. I only added this to test the batch process.\nThe previous implementation of batching (without ToList transform) was as per the java implementation but without the sorting of the transactions by table and primary key (this is also documented as a feature to be added later).", "author": "mszb", "createdAt": "2020-05-08T17:48:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTk1ODMyOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjU2NzU2Ng==", "url": "https://github.com/apache/beam/pull/11210#discussion_r422567566", "bodyText": "Done!", "author": "mszb", "createdAt": "2020-05-10T01:09:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTk1ODMyOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTk1ODQ2Ng==", "url": "https://github.com/apache/beam/pull/11210#discussion_r421958466", "bodyText": "This seems like a change to the implementation not part of the integration test. Probably should be a separate PR with a JIRA.", "author": "chamikaramj", "createdAt": "2020-05-08T06:10:23Z", "path": "sdks/python/apache_beam/io/gcp/experimental/spannerio.py", "diffHunk": "@@ -1008,31 +1007,30 @@ def _reset_count(self):\n     self._cells = 0\n \n   def process(self, element):\n-    mg_info = element.info\n+    for elem in element:\n+      mg_info = elem.info\n+      if mg_info['byte_size'] + self._size_in_bytes > \\", "originalCommit": "72cc863fbc112f8fdce342bfc240146541c8cca7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjEyNjQ4OQ==", "url": "https://github.com/apache/beam/pull/11210#discussion_r422126489", "bodyText": "Sure. Should I create a new Jira ticket and (1) add ticket number in this PR for reference OR (2) create a new PR for this change, and once it gets merge then I rebase this PR and request review?\nI think the first approach required less time to close the tickets! What you suggest?", "author": "mszb", "createdAt": "2020-05-08T12:55:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTk1ODQ2Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjE4MjYzMw==", "url": "https://github.com/apache/beam/pull/11210#discussion_r422182633", "bodyText": "I think (2) is better but we should fix the Spanner connector implementation to work for arbitrary bundle sizes than reducing the bundle to a single element for the test.", "author": "chamikaramj", "createdAt": "2020-05-08T14:41:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTk1ODQ2Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjU2NzQ3NA==", "url": "https://github.com/apache/beam/pull/11210#discussion_r422567474", "bodyText": "Since i've reverted the changes from the connector, there is no need to create new tickets. Resolving this conversation! - Thanks!", "author": "mszb", "createdAt": "2020-05-10T01:08:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTk1ODQ2Ng=="}], "type": "inlineReview"}, {"oid": "c4d538c1d08bc80866d15605f929a5cbbeb96de3", "url": "https://github.com/apache/beam/commit/c4d538c1d08bc80866d15605f929a5cbbeb96de3", "message": "revert changes from spanner io python connector and update IT test validation code.", "committedDate": "2020-05-10T01:03:08Z", "type": "commit"}, {"oid": "9dc8b7460b1c34df877b3936bd4e83a1bed25166", "url": "https://github.com/apache/beam/commit/9dc8b7460b1c34df877b3936bd4e83a1bed25166", "message": "Merge branch 'master' into BEAM-8949_spannerio_read_ittest", "committedDate": "2020-05-10T01:04:47Z", "type": "commit"}, {"oid": "3b44c16f2948fecead31f53e6e86d678779339ef", "url": "https://github.com/apache/beam/commit/3b44c16f2948fecead31f53e6e86d678779339ef", "message": "merge master into branch", "committedDate": "2020-05-14T11:44:14Z", "type": "commit"}, {"oid": "a21badeea96a3678088b95b86077621d4d369f9e", "url": "https://github.com/apache/beam/commit/a21badeea96a3678088b95b86077621d4d369f9e", "message": "adds spanner it tests in the py common gradle build file", "committedDate": "2020-05-14T11:47:27Z", "type": "commit"}]}