{"pr_number": 11567, "pr_title": "[BEAM-8132] Report Python metrics to InfluxDB", "pr_createdAt": "2020-04-29T10:44:04Z", "pr_url": "https://github.com/apache/beam/pull/11567", "timeline": [{"oid": "159a3606e8121eb87804504c5640c279fd16fc8a", "url": "https://github.com/apache/beam/commit/159a3606e8121eb87804504c5640c279fd16fc8a", "message": "[BEAM-8132] Report Python metrics to InfluxDB", "committedDate": "2020-04-29T10:54:31Z", "type": "forcePushed"}, {"oid": "52c2553b7547fb095b22951fc0be9811f6013938", "url": "https://github.com/apache/beam/commit/52c2553b7547fb095b22951fc0be9811f6013938", "message": "[BEAM-8132] Report Python metrics to InfluxDB", "committedDate": "2020-05-08T10:44:10Z", "type": "commit"}, {"oid": "52c2553b7547fb095b22951fc0be9811f6013938", "url": "https://github.com/apache/beam/commit/52c2553b7547fb095b22951fc0be9811f6013938", "message": "[BEAM-8132] Report Python metrics to InfluxDB", "committedDate": "2020-05-08T10:44:10Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjEyNDEyNA==", "url": "https://github.com/apache/beam/pull/11567#discussion_r422124124", "bodyText": "I am not sure if I correctly understand what measurement means. Is it name for metric such as runtime or name of place where metric will be stored as \"table\" or \"column\"?", "author": "kkucharc", "createdAt": "2020-05-08T12:49:59Z", "path": "sdks/python/apache_beam/testing/load_tests/load_test.py", "diffHunk": "@@ -45,6 +47,19 @@ def _add_argparse_args(cls, parser):\n         '--metrics_table',\n         help='A BigQuery table where metrics should be '\n         'written.')\n+    parser.add_argument(\n+        '--influx_measurement',\n+        help='An InfluxDB measurement where metrics should be published to. If '", "originalCommit": "52c2553b7547fb095b22951fc0be9811f6013938", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjE1OTU5NA==", "url": "https://github.com/apache/beam/pull/11567#discussion_r422159594", "bodyText": "It's a name of place where metric will be stored. It's like \"table\" in other databases.", "author": "kamilwu", "createdAt": "2020-05-08T14:00:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjEyNDEyNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzAwOTc4Ng==", "url": "https://github.com/apache/beam/pull/11567#discussion_r423009786", "bodyText": "Maybe it would be good to explain that in help for people who aren't familiar with influx? (like myself :D)", "author": "kkucharc", "createdAt": "2020-05-11T12:40:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjEyNDEyNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzA2Nzg2NQ==", "url": "https://github.com/apache/beam/pull/11567#discussion_r423067865", "bodyText": "I'll try to explain that briefly. I don't want to rewrite whole InfluxDB documentation in this place.", "author": "kamilwu", "createdAt": "2020-05-11T14:10:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjEyNDEyNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzUxMTc4MQ==", "url": "https://github.com/apache/beam/pull/11567#discussion_r423511781", "bodyText": "Sure, I think it can be something like An InfluxDB measurement (destination field)..., WDYT? Can we call it destination field?", "author": "kkucharc", "createdAt": "2020-05-12T07:14:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjEyNDEyNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzU5Nzc5Mw==", "url": "https://github.com/apache/beam/pull/11567#discussion_r423597793", "bodyText": "Not sure if field is an appropriate term for a collection of data.\nWhat do you think about this? This is a version from the latest commit, I'm not sure if you saw it.\nhelp='An InfluxDB measurement where metrics should be published to. '\n        'Measurement can be thought of as a SQL table. If empty, reporting to '\n        'InfluxDB will be disabled.')", "author": "kamilwu", "createdAt": "2020-05-12T09:34:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjEyNDEyNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzY4NjE1Mg==", "url": "https://github.com/apache/beam/pull/11567#discussion_r423686152", "bodyText": "Looks great! Thanks a lot :)", "author": "kkucharc", "createdAt": "2020-05-12T12:17:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjEyNDEyNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjEyNTA0OA==", "url": "https://github.com/apache/beam/pull/11567#discussion_r422125048", "bodyText": "Is it something we could enable to provide via PipelineOptions as well?", "author": "kkucharc", "createdAt": "2020-05-08T12:52:05Z", "path": "sdks/python/apache_beam/testing/load_tests/load_test.py", "diffHunk": "@@ -67,22 +82,30 @@ def _str_to_boolean(value):\n \n \n class LoadTest(object):\n+  \"\"\"Base class for all integration and performance tests which export\n+  metrics to external databases: BigQuery or/and InfluxDB.\n+\n+  Refer to :class:`~apache_beam.testing.load_tests.LoadTestOptions` for more\n+  information on the required pipeline options.\n+\n+  If using InfluxDB with Basic HTTP authentication enabled, provide the\n+  following environment options: `INFLUXDB_USER` and `INFLUXDB_USER_PASSWORD`.", "originalCommit": "52c2553b7547fb095b22951fc0be9811f6013938", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjE2MzUzMw==", "url": "https://github.com/apache/beam/pull/11567#discussion_r422163533", "bodyText": "If we did, we could put vulnerable data (like password) at risk by exposing them in logs. Apart from that, I think the only way of using Jenkins credentials are environment variables", "author": "kamilwu", "createdAt": "2020-05-08T14:07:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjEyNTA0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzUxMDc4MA==", "url": "https://github.com/apache/beam/pull/11567#discussion_r423510780", "bodyText": "I see, makes sense.", "author": "kkucharc", "createdAt": "2020-05-12T07:12:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjEyNTA0OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjEyNzk0NA==", "url": "https://github.com/apache/beam/pull/11567#discussion_r422127944", "bodyText": "Maybe we should remove this if since we have now two targets where we publish metrics?", "author": "kkucharc", "createdAt": "2020-05-08T12:58:21Z", "path": "sdks/python/apache_beam/testing/load_tests/load_test.py", "diffHunk": "@@ -67,22 +82,30 @@ def _str_to_boolean(value):\n \n \n class LoadTest(object):\n+  \"\"\"Base class for all integration and performance tests which export\n+  metrics to external databases: BigQuery or/and InfluxDB.\n+\n+  Refer to :class:`~apache_beam.testing.load_tests.LoadTestOptions` for more\n+  information on the required pipeline options.\n+\n+  If using InfluxDB with Basic HTTP authentication enabled, provide the\n+  following environment options: `INFLUXDB_USER` and `INFLUXDB_USER_PASSWORD`.\n+  \"\"\"\n   def __init__(self):\n     # Be sure to set blocking to false for timeout_ms to work properly\n     self.pipeline = TestPipeline(is_integration_test=True, blocking=False)\n     assert not self.pipeline.blocking\n \n-    load_test_options = self.pipeline.get_pipeline_options().view_as(\n-        LoadTestOptions)\n-    self.timeout_ms = load_test_options.timeout_ms\n-    self.input_options = load_test_options.input_options\n-    self.metrics_namespace = load_test_options.metrics_table or 'default'\n-    publish_to_bq = load_test_options.publish_to_big_query\n+    options = self.pipeline.get_pipeline_options().view_as(LoadTestOptions)\n+    self.timeout_ms = options.timeout_ms\n+    self.input_options = options.input_options\n+    self.metrics_namespace = options.metrics_table or 'default'\n+    publish_to_bq = options.publish_to_big_query\n     if publish_to_bq is None:", "originalCommit": "52c2553b7547fb095b22951fc0be9811f6013938", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjE2Nzg1NQ==", "url": "https://github.com/apache/beam/pull/11567#discussion_r422167855", "bodyText": "Our goal is to keep sending metrics to BigQuery for some time. think it'd good to keep the interface intact until we eventually abandon bq.", "author": "kamilwu", "createdAt": "2020-05-08T14:15:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjEyNzk0NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzAxMDAyNQ==", "url": "https://github.com/apache/beam/pull/11567#discussion_r423010025", "bodyText": "Sure, then ok. Less changes.", "author": "kkucharc", "createdAt": "2020-05-11T12:40:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjEyNzk0NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjEyODc5OQ==", "url": "https://github.com/apache/beam/pull/11567#discussion_r422128799", "bodyText": "Do you think it would be good to have consistent parameter naming for influx and bq? Or we plan to abandon bq in future?", "author": "kkucharc", "createdAt": "2020-05-08T13:00:25Z", "path": "sdks/python/apache_beam/testing/load_tests/load_test_metrics_utils.py", "diffHunk": "@@ -167,14 +175,15 @@ class MetricsReader(object):\n   A :class:`MetricsReader` retrieves metrics from pipeline result,\n   prepares it for publishers and setup publishers.\n   \"\"\"\n-  publishers = []  # type: List[ConsoleMetricsPublisher]\n+  publishers = []  # type: List[Any]\n \n   def __init__(\n       self,\n       project_name=None,\n       bq_table=None,\n       bq_dataset=None,\n       publish_to_bq=False,", "originalCommit": "52c2553b7547fb095b22951fc0be9811f6013938", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjE3NDE4Nw==", "url": "https://github.com/apache/beam/pull/11567#discussion_r422174187", "bodyText": "It's likely, but there's no decision yet. What influx parameters do you think can be improved?", "author": "kamilwu", "createdAt": "2020-05-08T14:26:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjEyODc5OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzAxMjQ2NA==", "url": "https://github.com/apache/beam/pull/11567#discussion_r423012464", "bodyText": "Well, I can see that inconsitent is publish_to_bq vs influxdb_options, but if we plan to have only influxdb_options then it's ok. Possibility I see here is to have something more generic like metrics_options or metrics_storage_options. Then if changes like this will happen in the future, there will be less to change.\nThe other possibility is changing it in a way it will be changed in Java SDK as well.", "author": "kkucharc", "createdAt": "2020-05-11T12:45:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjEyODc5OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzA4MDE3Ng==", "url": "https://github.com/apache/beam/pull/11567#discussion_r423080176", "bodyText": "Let's postpone any changes until we decide what to do about BQ. If we decide to keep BQ, we'll think about improving parameter naming so that InfluxDB and BQ parameters could coexist well enough (the same applies to Java SDK). WDYT?", "author": "kamilwu", "createdAt": "2020-05-11T14:27:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjEyODc5OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzUxMDIyMQ==", "url": "https://github.com/apache/beam/pull/11567#discussion_r423510221", "bodyText": "Sounds good \ud83d\udc4d", "author": "kkucharc", "createdAt": "2020-05-12T07:11:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjEyODc5OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjEyOTU5Ng==", "url": "https://github.com/apache/beam/pull/11567#discussion_r422129596", "bodyText": "Why do we need this default value here? Isn't it provided from pipeline options default value?", "author": "kkucharc", "createdAt": "2020-05-08T13:02:04Z", "path": "sdks/python/apache_beam/testing/load_tests/load_test_metrics_utils.py", "diffHunk": "@@ -404,6 +419,77 @@ def save(self, results):\n     return self._client.insert_rows(self._bq_table, results)\n \n \n+class InfluxDBMetricsPublisherOptions(object):\n+  def __init__(\n+      self,\n+      measurement,  # type: str\n+      db_name,  # type: str\n+      hostname='http://localhost:8086',  # type: str", "originalCommit": "52c2553b7547fb095b22951fc0be9811f6013938", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjE3MjMyMg==", "url": "https://github.com/apache/beam/pull/11567#discussion_r422172322", "bodyText": "There are some minor chances that someone would use InfluxDBPublisher in their code without casting pipeline options to LoadTestOptions (view_as(...)). But beside that, there's no particular reason", "author": "kamilwu", "createdAt": "2020-05-08T14:23:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjEyOTU5Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzAxNDI1MA==", "url": "https://github.com/apache/beam/pull/11567#discussion_r423014250", "bodyText": "Then maybe we should have param without default value? I can imagine case when someone doesn't know why metrics tries to be saved to this host without checking this code deeper?", "author": "kkucharc", "createdAt": "2020-05-11T12:48:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjEyOTU5Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzA0MTgyOA==", "url": "https://github.com/apache/beam/pull/11567#discussion_r423041828", "bodyText": "Ok then. I will remove the default value.", "author": "kamilwu", "createdAt": "2020-05-11T13:33:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjEyOTU5Ng=="}], "type": "inlineReview"}, {"oid": "c8b28181913a592aafd5b3fff6714abc498723b6", "url": "https://github.com/apache/beam/commit/c8b28181913a592aafd5b3fff6714abc498723b6", "message": "fix: addressing comments", "committedDate": "2020-05-11T14:28:34Z", "type": "commit"}]}