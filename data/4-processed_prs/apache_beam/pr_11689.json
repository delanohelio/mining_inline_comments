{"pr_number": 11689, "pr_title": "[BEAM-9945] Ensure that the read index represents the number of fully processed elements including at the end of the channel or after splitting.", "pr_createdAt": "2020-05-13T03:19:32Z", "pr_url": "https://github.com/apache/beam/pull/11689", "timeline": [{"oid": "d2f001ed5582c5fe87886799f7c1b00abf58a79d", "url": "https://github.com/apache/beam/commit/d2f001ed5582c5fe87886799f7c1b00abf58a79d", "message": "fixup! Fix issue where we weren't resetting the read index/stopping position in BeamFnDataReadRunner\n\nI created a bug to handle an unlikely race condition where the read index being reported could be from the last bundle.", "committedDate": "2020-05-13T05:54:51Z", "type": "forcePushed"}, {"oid": "760a4cdf271341152103e6230418f0426be01d3f", "url": "https://github.com/apache/beam/commit/760a4cdf271341152103e6230418f0426be01d3f", "message": "[BEAM-9945] Ensure that the read index represents the number of fully processed elements including at the end of the channel or after splitting.", "committedDate": "2020-05-13T13:33:01Z", "type": "commit"}, {"oid": "760a4cdf271341152103e6230418f0426be01d3f", "url": "https://github.com/apache/beam/commit/760a4cdf271341152103e6230418f0426be01d3f", "message": "[BEAM-9945] Ensure that the read index represents the number of fully processed elements including at the end of the channel or after splitting.", "committedDate": "2020-05-13T13:33:01Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDYwMDgzNg==", "url": "https://github.com/apache/beam/pull/11689#discussion_r424600836", "bodyText": "Should we also check start == true here like trySplit?", "author": "boyuanzz", "createdAt": "2020-05-13T17:14:30Z", "path": "sdks/java/harness/src/main/java/org/apache/beam/fn/harness/BeamFnDataReadRunner.java", "diffHunk": "@@ -165,6 +166,8 @@\n \n     addProgressRequestCallback.accept(\n         () -> {\n+          // TODO(BEAM-9979): Fix race condition where reused BeamFnDataReadRunner reports", "originalCommit": "760a4cdf271341152103e6230418f0426be01d3f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDYwMTM0Mw==", "url": "https://github.com/apache/beam/pull/11689#discussion_r424601343", "bodyText": "No since we need to report the final read index when the bundle is finished.", "author": "lukecwik", "createdAt": "2020-05-13T17:15:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDYwMDgzNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDYwNDEyOQ==", "url": "https://github.com/apache/beam/pull/11689#discussion_r424604129", "bodyText": "Is it important to get final index from progress(or how can a runner know it's the final progress)? We will still get it from ProcessBundleResponse when a bundle is finished.", "author": "boyuanzz", "createdAt": "2020-05-13T17:19:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDYwMDgzNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDYyMTA5Nw==", "url": "https://github.com/apache/beam/pull/11689#discussion_r424621097", "bodyText": "Yes it is important since Dataflow uses it for the element sanity check. The call order when the bundle finishes is to invoke all the finish functions on the operators and then invoke progress request callback. The output of this progress request callback is used on both the ProcessBundleProgressResponses and ProcessBundleResponses.", "author": "lukecwik", "createdAt": "2020-05-13T17:48:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDYwMDgzNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDU5OTIwNw==", "url": "https://github.com/apache/beam/pull/11689#discussion_r424599207", "bodyText": "It doesn't seem like the index should be incremented here.", "author": "robertwb", "createdAt": "2020-05-13T17:11:47Z", "path": "sdks/python/apache_beam/runners/worker/bundle_processor.py", "diffHunk": "@@ -317,6 +321,7 @@ def is_valid_split_point(index):\n   def finish(self):\n     # type: () -> None\n     with self.splitting_lock:\n+      self.index += 1", "originalCommit": "760a4cdf271341152103e6230418f0426be01d3f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDYxNDkyMA==", "url": "https://github.com/apache/beam/pull/11689#discussion_r424614920", "bodyText": "We want the final count to represent the number of fully processed elements so when we process 0 elements in the bundle we should end with 0 and not -1. Similarly when we process 1 element in the bundle the final index should be 1 and not 0.", "author": "lukecwik", "createdAt": "2020-05-13T17:37:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDU5OTIwNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDYwMDE2OQ==", "url": "https://github.com/apache/beam/pull/11689#discussion_r424600169", "bodyText": "Operators have a reset method that could be used here.", "author": "robertwb", "createdAt": "2020-05-13T17:13:18Z", "path": "sdks/python/apache_beam/runners/worker/bundle_processor.py", "diffHunk": "@@ -219,6 +219,10 @@ def process_encoded(self, encoded_windowed_values):\n \n   def monitoring_infos(self, transform_id, tag_to_pcollection_id):\n     # type: (str, Dict[str, str]) -> Dict[FrozenSet, metrics_pb2.MonitoringInfo]\n+\n+    # TODO(BEAM-9979): Fix race condition where reused DataInputOperation", "originalCommit": "760a4cdf271341152103e6230418f0426be01d3f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDYxNDM0Nw==", "url": "https://github.com/apache/beam/pull/11689#discussion_r424614347", "bodyText": "Fixed in Python. Java SDK harness doesn't have something like this plumbed through to its operators.", "author": "lukecwik", "createdAt": "2020-05-13T17:36:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDYwMDE2OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDYwMDkzNw==", "url": "https://github.com/apache/beam/pull/11689#discussion_r424600937", "bodyText": "I don't think this should be incremented here.", "author": "robertwb", "createdAt": "2020-05-13T17:14:41Z", "path": "sdks/java/harness/src/main/java/org/apache/beam/fn/harness/BeamFnDataReadRunner.java", "diffHunk": "@@ -293,5 +305,9 @@ public void blockTillReadFinishes() throws Exception {\n         processBundleInstructionIdSupplier.get(),\n         pTransformId);\n     readFuture.awaitCompletion();\n+    synchronized (splittingLock) {\n+      started = false;\n+      index += 1;", "originalCommit": "760a4cdf271341152103e6230418f0426be01d3f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDYxMDMwNQ==", "url": "https://github.com/apache/beam/pull/11689#discussion_r424610305", "bodyText": "Nevermind, I see now.", "author": "robertwb", "createdAt": "2020-05-13T17:30:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDYwMDkzNw=="}], "type": "inlineReview"}, {"oid": "a3a30219e648315b4100c28229c8bbcf311de233", "url": "https://github.com/apache/beam/commit/a3a30219e648315b4100c28229c8bbcf311de233", "message": "fixup! Fix checkstyle issue", "committedDate": "2020-05-13T17:17:43Z", "type": "commit"}, {"oid": "0db341fd22485609188cdc64085fbf141d6f64c8", "url": "https://github.com/apache/beam/commit/0db341fd22485609188cdc64085fbf141d6f64c8", "message": "fixup! use reset method in bundle_processor.py to avoid race condition on metrics", "committedDate": "2020-05-13T17:38:32Z", "type": "commit"}]}