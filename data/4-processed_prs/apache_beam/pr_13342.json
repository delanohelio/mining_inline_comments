{"pr_number": 13342, "pr_title": "[BEAM-11260][BEAM-11261] Remove inappropriate assumptions about repo from linkage check script", "pr_createdAt": "2020-11-13T21:53:19Z", "pr_url": "https://github.com/apache/beam/pull/13342", "timeline": [{"oid": "d98a15ab4b63c53a8c34c9969b244fe5e439864e", "url": "https://github.com/apache/beam/commit/d98a15ab4b63c53a8c34c9969b244fe5e439864e", "message": "Remove inappropriate assumptions about repo from linkage check script", "committedDate": "2020-11-13T21:26:45Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzI1MjUwMA==", "url": "https://github.com/apache/beam/pull/13342#discussion_r523252500", "bodyText": "I noticed that we loop over this. But the gradle property uses a comma-separated list of artifacts. Is this just a mistake or is the idea to have a bunch of separate lists that are checked separately?", "author": "kennknowles", "createdAt": "2020-11-13T21:54:37Z", "path": "sdks/java/build-tools/beam-linkage-check.sh", "diffHunk": "@@ -36,46 +36,60 @@ set -o pipefail\n set -e\n \n # These default artifacts are common causes of linkage errors.\n-ARTIFACTS=\"beam-sdks-java-core\n-  beam-sdks-java-io-google-cloud-platform\n-  beam-runners-google-cloud-dataflow-java\n-  beam-sdks-java-io-hadoop-format\"\n-\n-if [ ! -z \"$1\" ]; then\n-  ARTIFACTS=$1\n+DEFAULT_ARTIFACT_LISTS=\" \\", "originalCommit": "d98a15ab4b63c53a8c34c9969b244fe5e439864e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDM1OTc1OA==", "url": "https://github.com/apache/beam/pull/13342#discussion_r524359758", "bodyText": "Comman-separated list: Linkage Checker analyzes a dependency graph generated from the list of artifact, as if a project depends on the list of artifacts. For example, running Linkage Checker for \"io.grpc:grpc-context:1.23.0,com.google.guava:guava:28.0-jre\", checks a dependency graph of a pseudo project that depends on the two artifacts.\nSpace-separated list: different invocation of Linkage Checker.\nI will improve documentation / comments regarding this.", "author": "suztomo", "createdAt": "2020-11-16T15:37:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzI1MjUwMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDU5NjgzMg==", "url": "https://github.com/apache/beam/pull/13342#discussion_r524596832", "bodyText": "Yes, I understand what the comma-separated list and space-separated list do. I just don't understand why we use both. I trust that there is a good reason, but I do not know it. Like if you had two subsets of artifacts that are not expected to work together?\nI would expect that we do want to run all the GCP modules together with the core SDK and, separately, run all the hadoop modules together with the core SDK, etc. Or maybe we just run them all together.\nSo my proposal would be to drop the space-separated and only keep the comma-separated logic. But like I said, I trust there is a reason. So I am just making this proposal so you can tell me why it does not work.", "author": "kennknowles", "createdAt": "2020-11-16T21:21:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzI1MjUwMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTQ2NTc2OA==", "url": "https://github.com/apache/beam/pull/13342#discussion_r525465768", "bodyText": "I just don't understand why we use both.\n\nIn general, running Linkage Check with multiple artifact may hide linkage errors that exist in dependencies of the one of the individual artifacts. (This is the reason to use space-separated list.)\nOn the other hand, running Linkage Checker with multiple artifacts is quicker than running Linkage Checker for individual artifacts one by one.", "author": "suztomo", "createdAt": "2020-11-17T20:00:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzI1MjUwMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjE5MTU5Nw==", "url": "https://github.com/apache/beam/pull/13342#discussion_r526191597", "bodyText": "Approving this PR. I see this PR is not dropping the space-separated list.", "author": "suztomo", "createdAt": "2020-11-18T15:46:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzI1MjUwMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzI2Mjc4Ng==", "url": "https://github.com/apache/beam/pull/13342#discussion_r523262786", "bodyText": "This is so it can be run from a different branch than either of the changes. For example I used this to test this branch. More generally, this is helpful to test any changes to the script. We can run them against known other refs with changes.", "author": "kennknowles", "createdAt": "2020-11-13T22:18:18Z", "path": "sdks/java/build-tools/beam-linkage-check.sh", "diffHunk": "@@ -36,46 +36,60 @@ set -o pipefail\n set -e\n \n # These default artifacts are common causes of linkage errors.\n-ARTIFACTS=\"beam-sdks-java-core\n-  beam-sdks-java-io-google-cloud-platform\n-  beam-runners-google-cloud-dataflow-java\n-  beam-sdks-java-io-hadoop-format\"\n-\n-if [ ! -z \"$1\" ]; then\n-  ARTIFACTS=$1\n+DEFAULT_ARTIFACT_LISTS=\" \\\n+  beam-sdks-java-core \\\n+  beam-sdks-java-io-google-cloud-platform \\\n+  beam-runners-google-cloud-dataflow-java \\\n+  beam-sdks-java-io-hadoop-format \\\n+\"\n+\n+BASELINE_REF=$1\n+PROPOSED_REF=$2\n+ARTIFACT_LISTS=$3\n+\n+if [ -z \"$ARTIFACT_LISTS\" ]; then\n+  ARTIFACT_LISTS=$DEFAULT_ARTIFACT_LISTS\n fi\n \n-BRANCH_NAME=$(git symbolic-ref --short HEAD)\n+if [ -z \"$BASELINE_REF\" ] || [ -z \"$PROPOSED_REF\" ] || [ -z \"$ARTIFACT_LISTS\" ] ; then\n+  echo \"Usage: $0 <baseline ref> <proposed ref> [artifact lists]\"\n+  exit 1\n+fi\n \n if [ ! -d buildSrc ]; then\n-  echo \"Please run this script in the Beam project root:\"\n-  echo \"  /bin/bash sdks/java/build-tools/beam-linkage-check.sh\"\n-  exit 1\n+  echo \"Directory 'buildSrc' not found. Please run this script from the root directory of a clone of the Beam git repo.\"\n fi\n \n-if [ \"$BRANCH_NAME\" = \"master\" ]; then\n-  echo \"Please run this script on a branch other than master\"\n+if [ \"$BASELINE_REF\" = \"$PROPOSED_REF\" ]; then\n+  echo \"Baseline and proposed refs are identical; cannot compare their linkage errors!\"\n   exit 1\n fi\n \n-OUTPUT_DIR=build/linkagecheck\n-mkdir -p $OUTPUT_DIR\n-\n if [ ! -z \"$(git diff)\" ]; then\n   echo \"Uncommited change detected. Please commit changes and ensure 'git diff' is empty.\"\n   exit 1\n fi\n \n+STARTING_REF=$(git rev-parse --abbrev-ref HEAD)", "originalCommit": "d98a15ab4b63c53a8c34c9969b244fe5e439864e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzI2MjkwNQ==", "url": "https://github.com/apache/beam/pull/13342#discussion_r523262905", "bodyText": "I guess these should actually get rev-parse to check that they are different hashes.", "author": "kennknowles", "createdAt": "2020-11-13T22:18:37Z", "path": "sdks/java/build-tools/beam-linkage-check.sh", "diffHunk": "@@ -36,46 +36,60 @@ set -o pipefail\n set -e\n \n # These default artifacts are common causes of linkage errors.\n-ARTIFACTS=\"beam-sdks-java-core\n-  beam-sdks-java-io-google-cloud-platform\n-  beam-runners-google-cloud-dataflow-java\n-  beam-sdks-java-io-hadoop-format\"\n-\n-if [ ! -z \"$1\" ]; then\n-  ARTIFACTS=$1\n+DEFAULT_ARTIFACT_LISTS=\" \\\n+  beam-sdks-java-core \\\n+  beam-sdks-java-io-google-cloud-platform \\\n+  beam-runners-google-cloud-dataflow-java \\\n+  beam-sdks-java-io-hadoop-format \\\n+\"\n+\n+BASELINE_REF=$1\n+PROPOSED_REF=$2\n+ARTIFACT_LISTS=$3\n+\n+if [ -z \"$ARTIFACT_LISTS\" ]; then\n+  ARTIFACT_LISTS=$DEFAULT_ARTIFACT_LISTS\n fi\n \n-BRANCH_NAME=$(git symbolic-ref --short HEAD)\n+if [ -z \"$BASELINE_REF\" ] || [ -z \"$PROPOSED_REF\" ] || [ -z \"$ARTIFACT_LISTS\" ] ; then\n+  echo \"Usage: $0 <baseline ref> <proposed ref> [artifact lists]\"\n+  exit 1\n+fi\n \n if [ ! -d buildSrc ]; then\n-  echo \"Please run this script in the Beam project root:\"\n-  echo \"  /bin/bash sdks/java/build-tools/beam-linkage-check.sh\"\n-  exit 1\n+  echo \"Directory 'buildSrc' not found. Please run this script from the root directory of a clone of the Beam git repo.\"\n fi\n \n-if [ \"$BRANCH_NAME\" = \"master\" ]; then\n-  echo \"Please run this script on a branch other than master\"\n+if [ \"$BASELINE_REF\" = \"$PROPOSED_REF\" ]; then", "originalCommit": "d98a15ab4b63c53a8c34c9969b244fe5e439864e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzI2MzQ4Mg==", "url": "https://github.com/apache/beam/pull/13342#discussion_r523263482", "bodyText": "We could also possibly do a smarter check using git status or ./gradlew model", "author": "kennknowles", "createdAt": "2020-11-13T22:20:16Z", "path": "sdks/java/build-tools/beam-linkage-check.sh", "diffHunk": "@@ -36,46 +36,60 @@ set -o pipefail\n set -e\n \n # These default artifacts are common causes of linkage errors.\n-ARTIFACTS=\"beam-sdks-java-core\n-  beam-sdks-java-io-google-cloud-platform\n-  beam-runners-google-cloud-dataflow-java\n-  beam-sdks-java-io-hadoop-format\"\n-\n-if [ ! -z \"$1\" ]; then\n-  ARTIFACTS=$1\n+DEFAULT_ARTIFACT_LISTS=\" \\\n+  beam-sdks-java-core \\\n+  beam-sdks-java-io-google-cloud-platform \\\n+  beam-runners-google-cloud-dataflow-java \\\n+  beam-sdks-java-io-hadoop-format \\\n+\"\n+\n+BASELINE_REF=$1\n+PROPOSED_REF=$2\n+ARTIFACT_LISTS=$3\n+\n+if [ -z \"$ARTIFACT_LISTS\" ]; then\n+  ARTIFACT_LISTS=$DEFAULT_ARTIFACT_LISTS\n fi\n \n-BRANCH_NAME=$(git symbolic-ref --short HEAD)\n+if [ -z \"$BASELINE_REF\" ] || [ -z \"$PROPOSED_REF\" ] || [ -z \"$ARTIFACT_LISTS\" ] ; then\n+  echo \"Usage: $0 <baseline ref> <proposed ref> [artifact lists]\"\n+  exit 1\n+fi\n \n if [ ! -d buildSrc ]; then\n-  echo \"Please run this script in the Beam project root:\"\n-  echo \"  /bin/bash sdks/java/build-tools/beam-linkage-check.sh\"\n-  exit 1\n+  echo \"Directory 'buildSrc' not found. Please run this script from the root directory of a clone of the Beam git repo.\"", "originalCommit": "d98a15ab4b63c53a8c34c9969b244fe5e439864e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzI2MzY1NA==", "url": "https://github.com/apache/beam/pull/13342#discussion_r523263654", "bodyText": "Have a space-separated list of comma-separated lists seems weird. I kept it, but maybe we can simplify?", "author": "kennknowles", "createdAt": "2020-11-13T22:20:48Z", "path": "sdks/java/build-tools/beam-linkage-check.sh", "diffHunk": "@@ -36,46 +36,60 @@ set -o pipefail\n set -e\n \n # These default artifacts are common causes of linkage errors.\n-ARTIFACTS=\"beam-sdks-java-core\n-  beam-sdks-java-io-google-cloud-platform\n-  beam-runners-google-cloud-dataflow-java\n-  beam-sdks-java-io-hadoop-format\"\n-\n-if [ ! -z \"$1\" ]; then\n-  ARTIFACTS=$1\n+DEFAULT_ARTIFACT_LISTS=\" \\\n+  beam-sdks-java-core \\\n+  beam-sdks-java-io-google-cloud-platform \\\n+  beam-runners-google-cloud-dataflow-java \\\n+  beam-sdks-java-io-hadoop-format \\\n+\"\n+\n+BASELINE_REF=$1\n+PROPOSED_REF=$2\n+ARTIFACT_LISTS=$3\n+\n+if [ -z \"$ARTIFACT_LISTS\" ]; then\n+  ARTIFACT_LISTS=$DEFAULT_ARTIFACT_LISTS\n fi\n \n-BRANCH_NAME=$(git symbolic-ref --short HEAD)\n+if [ -z \"$BASELINE_REF\" ] || [ -z \"$PROPOSED_REF\" ] || [ -z \"$ARTIFACT_LISTS\" ] ; then\n+  echo \"Usage: $0 <baseline ref> <proposed ref> [artifact lists]\"\n+  exit 1\n+fi\n \n if [ ! -d buildSrc ]; then\n-  echo \"Please run this script in the Beam project root:\"\n-  echo \"  /bin/bash sdks/java/build-tools/beam-linkage-check.sh\"\n-  exit 1\n+  echo \"Directory 'buildSrc' not found. Please run this script from the root directory of a clone of the Beam git repo.\"\n fi\n \n-if [ \"$BRANCH_NAME\" = \"master\" ]; then\n-  echo \"Please run this script on a branch other than master\"\n+if [ \"$BASELINE_REF\" = \"$PROPOSED_REF\" ]; then\n+  echo \"Baseline and proposed refs are identical; cannot compare their linkage errors!\"\n   exit 1\n fi\n \n-OUTPUT_DIR=build/linkagecheck\n-mkdir -p $OUTPUT_DIR\n-\n if [ ! -z \"$(git diff)\" ]; then\n   echo \"Uncommited change detected. Please commit changes and ensure 'git diff' is empty.\"\n   exit 1\n fi\n \n+STARTING_REF=$(git rev-parse --abbrev-ref HEAD)\n+function cleanup() {\n+  git checkout $STARTING_REF\n+}\n+trap cleanup EXIT\n+\n+echo \"Comparing linkage of artifact lists $ARTIFACT_LISTS using baseline $BASELINE_REF and proposal $PROPOSED_REF\"\n+\n+OUTPUT_DIR=build/linkagecheck\n+mkdir -p $OUTPUT_DIR\n+\n ACCUMULATED_RESULT=0\n \n function runLinkageCheck () {\n-  COMMIT=$1\n-  BRANCH=$2\n-  MODE=$3 # \"baseline\" or \"validate\"\n-  for ARTIFACT in $ARTIFACTS; do\n-    echo \"`date`:\" \"Running linkage check (${MODE}) for ${ARTIFACT} in ${BRANCH}\"\n+  MODE=$1 # \"baseline\" or \"validate\"\n \n-    BASELINE_FILE=${OUTPUT_DIR}/baseline-${ARTIFACT}.xml\n+  for ARTIFACT_LIST in $ARTIFACT_LISTS; do", "originalCommit": "d98a15ab4b63c53a8c34c9969b244fe5e439864e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzI2NDI2Ng==", "url": "https://github.com/apache/beam/pull/13342#discussion_r523264266", "bodyText": "The only nontrivial shared code between runLinkageCheck baseline and runLinkageCheck validate is the loop over the artifact lists. So if we didn't need the loop, we may as well just inline the functions.", "author": "kennknowles", "createdAt": "2020-11-13T22:22:41Z", "path": "sdks/java/build-tools/beam-linkage-check.sh", "diffHunk": "@@ -88,29 +102,25 @@ function runLinkageCheck () {\n     fi\n \n     set +e\n-    ./gradlew -Ppublishing -PjavaLinkageArtifactIds=$ARTIFACT ${BASELINE_OPTION} :checkJavaLinkage\n+    set -x\n+    ./gradlew -Ppublishing -PskipCheckerFramework -PjavaLinkageArtifactIds=$ARTIFACT_LIST ${BASELINE_OPTION} :checkJavaLinkage\n     RESULT=$?\n     set -e\n+    set +x\n     if [ \"$MODE\" = \"validate\" ]; then\n       echo \"`date`:\" \"Done: ${RESULT}\"\n       ACCUMULATED_RESULT=$((ACCUMULATED_RESULT | RESULT))\n     fi\n   done\n }\n \n+echo \"Establishing baseline linkage for $(git rev-parse --abbrev-ref $BASELINE_REF)\"\n+git -c advice.detachedHead=false checkout $BASELINE_REF\n+runLinkageCheck baseline", "originalCommit": "d98a15ab4b63c53a8c34c9969b244fe5e439864e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzI2NDU5MQ==", "url": "https://github.com/apache/beam/pull/13342#discussion_r523264591", "bodyText": "This would be cleaner if the checkLinkage task just put something in build/reports/linkageChecker and this script copied it out to a temp dir for the purpose of comparison.", "author": "kennknowles", "createdAt": "2020-11-13T22:23:38Z", "path": "sdks/java/build-tools/beam-linkage-check.sh", "diffHunk": "@@ -36,46 +36,60 @@ set -o pipefail\n set -e\n \n # These default artifacts are common causes of linkage errors.\n-ARTIFACTS=\"beam-sdks-java-core\n-  beam-sdks-java-io-google-cloud-platform\n-  beam-runners-google-cloud-dataflow-java\n-  beam-sdks-java-io-hadoop-format\"\n-\n-if [ ! -z \"$1\" ]; then\n-  ARTIFACTS=$1\n+DEFAULT_ARTIFACT_LISTS=\" \\\n+  beam-sdks-java-core \\\n+  beam-sdks-java-io-google-cloud-platform \\\n+  beam-runners-google-cloud-dataflow-java \\\n+  beam-sdks-java-io-hadoop-format \\\n+\"\n+\n+BASELINE_REF=$1\n+PROPOSED_REF=$2\n+ARTIFACT_LISTS=$3\n+\n+if [ -z \"$ARTIFACT_LISTS\" ]; then\n+  ARTIFACT_LISTS=$DEFAULT_ARTIFACT_LISTS\n fi\n \n-BRANCH_NAME=$(git symbolic-ref --short HEAD)\n+if [ -z \"$BASELINE_REF\" ] || [ -z \"$PROPOSED_REF\" ] || [ -z \"$ARTIFACT_LISTS\" ] ; then\n+  echo \"Usage: $0 <baseline ref> <proposed ref> [artifact lists]\"\n+  exit 1\n+fi\n \n if [ ! -d buildSrc ]; then\n-  echo \"Please run this script in the Beam project root:\"\n-  echo \"  /bin/bash sdks/java/build-tools/beam-linkage-check.sh\"\n-  exit 1\n+  echo \"Directory 'buildSrc' not found. Please run this script from the root directory of a clone of the Beam git repo.\"\n fi\n \n-if [ \"$BRANCH_NAME\" = \"master\" ]; then\n-  echo \"Please run this script on a branch other than master\"\n+if [ \"$BASELINE_REF\" = \"$PROPOSED_REF\" ]; then\n+  echo \"Baseline and proposed refs are identical; cannot compare their linkage errors!\"\n   exit 1\n fi\n \n-OUTPUT_DIR=build/linkagecheck\n-mkdir -p $OUTPUT_DIR\n-\n if [ ! -z \"$(git diff)\" ]; then\n   echo \"Uncommited change detected. Please commit changes and ensure 'git diff' is empty.\"\n   exit 1\n fi\n \n+STARTING_REF=$(git rev-parse --abbrev-ref HEAD)\n+function cleanup() {\n+  git checkout $STARTING_REF\n+}\n+trap cleanup EXIT\n+\n+echo \"Comparing linkage of artifact lists $ARTIFACT_LISTS using baseline $BASELINE_REF and proposal $PROPOSED_REF\"\n+\n+OUTPUT_DIR=build/linkagecheck\n+mkdir -p $OUTPUT_DIR\n+\n ACCUMULATED_RESULT=0\n \n function runLinkageCheck () {\n-  COMMIT=$1\n-  BRANCH=$2\n-  MODE=$3 # \"baseline\" or \"validate\"\n-  for ARTIFACT in $ARTIFACTS; do\n-    echo \"`date`:\" \"Running linkage check (${MODE}) for ${ARTIFACT} in ${BRANCH}\"\n+  MODE=$1 # \"baseline\" or \"validate\"\n \n-    BASELINE_FILE=${OUTPUT_DIR}/baseline-${ARTIFACT}.xml\n+  for ARTIFACT_LIST in $ARTIFACT_LISTS; do\n+    echo \"`date`:\" \"Running linkage check (${MODE}) for ${ARTIFACT_LISTS}\"\n+\n+    BASELINE_FILE=${OUTPUT_DIR}/baseline-${ARTIFACT_LIST}.xml", "originalCommit": "d98a15ab4b63c53a8c34c9969b244fe5e439864e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDM3MzQwOA==", "url": "https://github.com/apache/beam/pull/13342#discussion_r524373408", "bodyText": "Would you elaborate on the benefit of using a temp dir, rather than the build/linkagecheck directory?\nCurrent:\n\ncheckJavaLinkage with baseline mode writes the baseline XML to build/linkagecheck.\ncheckJavaLinkage with validate mode reads the baseline XML to filter existing errors.", "author": "suztomo", "createdAt": "2020-11-16T15:54:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzI2NDU5MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDU5MzE4MQ==", "url": "https://github.com/apache/beam/pull/13342#discussion_r524593181", "bodyText": "It is a stylistic \"nit\" really. My expectation of gradle commands is that they operate on the current source tree. There are exceptions, sure. But my thinking was:\n\n:checkJavaLinkage always writes to build/linkagecheck and the report is the linkage report for the current state of the worktree.\nbeam-linkage-check.sh operates at level above that. It produces the above file for two separate states of the source tree and compares them.\n\nIt is not that important. Just recording my thoughts so we can discuss the script a bit.", "author": "kennknowles", "createdAt": "2020-11-16T21:18:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzI2NDU5MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTIzNzE3NQ==", "url": "https://github.com/apache/beam/pull/13342#discussion_r525237175", "bodyText": "Thank you for explanation. The setup came from my preference of handling XML files in Java rather than in shell scripts. (The operation is simple. Linkage Checker is just calculating the difference of two Sets.)", "author": "suztomo", "createdAt": "2020-11-17T15:18:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzI2NDU5MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDM2MTUwOQ==", "url": "https://github.com/apache/beam/pull/13342#discussion_r524361509", "bodyText": "Nice enhancement.", "author": "suztomo", "createdAt": "2020-11-16T15:39:53Z", "path": "sdks/java/build-tools/beam-linkage-check.sh", "diffHunk": "@@ -36,46 +36,60 @@ set -o pipefail\n set -e\n \n # These default artifacts are common causes of linkage errors.\n-ARTIFACTS=\"beam-sdks-java-core\n-  beam-sdks-java-io-google-cloud-platform\n-  beam-runners-google-cloud-dataflow-java\n-  beam-sdks-java-io-hadoop-format\"\n-\n-if [ ! -z \"$1\" ]; then\n-  ARTIFACTS=$1\n+DEFAULT_ARTIFACT_LISTS=\" \\\n+  beam-sdks-java-core \\\n+  beam-sdks-java-io-google-cloud-platform \\\n+  beam-runners-google-cloud-dataflow-java \\\n+  beam-sdks-java-io-hadoop-format \\\n+\"\n+\n+BASELINE_REF=$1\n+PROPOSED_REF=$2\n+ARTIFACT_LISTS=$3\n+\n+if [ -z \"$ARTIFACT_LISTS\" ]; then\n+  ARTIFACT_LISTS=$DEFAULT_ARTIFACT_LISTS\n fi\n \n-BRANCH_NAME=$(git symbolic-ref --short HEAD)\n+if [ -z \"$BASELINE_REF\" ] || [ -z \"$PROPOSED_REF\" ] || [ -z \"$ARTIFACT_LISTS\" ] ; then\n+  echo \"Usage: $0 <baseline ref> <proposed ref> [artifact lists]\"\n+  exit 1\n+fi\n \n if [ ! -d buildSrc ]; then\n-  echo \"Please run this script in the Beam project root:\"\n-  echo \"  /bin/bash sdks/java/build-tools/beam-linkage-check.sh\"\n-  exit 1\n+  echo \"Directory 'buildSrc' not found. Please run this script from the root directory of a clone of the Beam git repo.\"\n fi\n \n-if [ \"$BRANCH_NAME\" = \"master\" ]; then\n-  echo \"Please run this script on a branch other than master\"\n+if [ \"$BASELINE_REF\" = \"$PROPOSED_REF\" ]; then", "originalCommit": "d98a15ab4b63c53a8c34c9969b244fe5e439864e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDM2MTgwMA==", "url": "https://github.com/apache/beam/pull/13342#discussion_r524361800", "bodyText": "Nice!", "author": "suztomo", "createdAt": "2020-11-16T15:40:12Z", "path": "sdks/java/build-tools/beam-linkage-check.sh", "diffHunk": "@@ -36,46 +36,60 @@ set -o pipefail\n set -e\n \n # These default artifacts are common causes of linkage errors.\n-ARTIFACTS=\"beam-sdks-java-core\n-  beam-sdks-java-io-google-cloud-platform\n-  beam-runners-google-cloud-dataflow-java\n-  beam-sdks-java-io-hadoop-format\"\n-\n-if [ ! -z \"$1\" ]; then\n-  ARTIFACTS=$1\n+DEFAULT_ARTIFACT_LISTS=\" \\\n+  beam-sdks-java-core \\\n+  beam-sdks-java-io-google-cloud-platform \\\n+  beam-runners-google-cloud-dataflow-java \\\n+  beam-sdks-java-io-hadoop-format \\\n+\"\n+\n+BASELINE_REF=$1\n+PROPOSED_REF=$2\n+ARTIFACT_LISTS=$3\n+\n+if [ -z \"$ARTIFACT_LISTS\" ]; then\n+  ARTIFACT_LISTS=$DEFAULT_ARTIFACT_LISTS\n fi\n \n-BRANCH_NAME=$(git symbolic-ref --short HEAD)\n+if [ -z \"$BASELINE_REF\" ] || [ -z \"$PROPOSED_REF\" ] || [ -z \"$ARTIFACT_LISTS\" ] ; then\n+  echo \"Usage: $0 <baseline ref> <proposed ref> [artifact lists]\"\n+  exit 1\n+fi\n \n if [ ! -d buildSrc ]; then\n-  echo \"Please run this script in the Beam project root:\"\n-  echo \"  /bin/bash sdks/java/build-tools/beam-linkage-check.sh\"\n-  exit 1\n+  echo \"Directory 'buildSrc' not found. Please run this script from the root directory of a clone of the Beam git repo.\"\n fi\n \n-if [ \"$BRANCH_NAME\" = \"master\" ]; then\n-  echo \"Please run this script on a branch other than master\"\n+if [ \"$BASELINE_REF\" = \"$PROPOSED_REF\" ]; then\n+  echo \"Baseline and proposed refs are identical; cannot compare their linkage errors!\"\n   exit 1\n fi\n \n-OUTPUT_DIR=build/linkagecheck\n-mkdir -p $OUTPUT_DIR\n-\n if [ ! -z \"$(git diff)\" ]; then\n   echo \"Uncommited change detected. Please commit changes and ensure 'git diff' is empty.\"\n   exit 1\n fi\n \n+STARTING_REF=$(git rev-parse --abbrev-ref HEAD)\n+function cleanup() {\n+  git checkout $STARTING_REF\n+}\n+trap cleanup EXIT", "originalCommit": "d98a15ab4b63c53a8c34c9969b244fe5e439864e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}