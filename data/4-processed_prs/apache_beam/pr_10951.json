{"pr_number": 10951, "pr_title": "[BEAM-8575] Modified the test to work for different runners.", "pr_createdAt": "2020-02-24T20:02:41Z", "pr_url": "https://github.com/apache/beam/pull/10951", "timeline": [{"oid": "62fbdef64ebd1285745ff454cf9a4fc56959aea8", "url": "https://github.com/apache/beam/commit/62fbdef64ebd1285745ff454cf9a4fc56959aea8", "message": "[BEAM-8575] Modified the test to work for different runners.", "committedDate": "2020-02-24T19:51:25Z", "type": "commit"}, {"oid": "cc7befd00243d902acbff65066bdbb37ca27c07c", "url": "https://github.com/apache/beam/commit/cc7befd00243d902acbff65066bdbb37ca27c07c", "message": "Fixed lint errors.", "committedDate": "2020-02-24T21:44:01Z", "type": "commit"}, {"oid": "faaed37dd4aee6e3d9d4c52c9cbf099dc7338dda", "url": "https://github.com/apache/beam/commit/faaed37dd4aee6e3d9d4c52c9cbf099dc7338dda", "message": "Fixed format error.", "committedDate": "2020-02-26T00:43:44Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDc4OTMwNA==", "url": "https://github.com/apache/beam/pull/10951#discussion_r384789304", "bodyText": "We still want to ensure there is at least one 15 firing. (If we're being pedantic, a single on-time firing, plus a number of late firings) The second argument to assert_that can be any predicate taking the set of actual elements.", "author": "robertwb", "createdAt": "2020-02-26T21:52:42Z", "path": "sdks/python/apache_beam/transforms/combiners_test.py", "diffHunk": "@@ -482,9 +485,13 @@ def test_combining_with_accumulation_mode_and_fanout(self):\n               trigger=AfterWatermark(early=AfterAll(AfterCount(1))))\n           | beam.CombineGlobally(sum).without_defaults().with_fanout(2))\n \n-      # The frings for DISCARDING mode is [1, 2, 3, 4, 5, 0, 0].\n-      firings = [1, 3, 6, 10, 15, 15, 15]\n-      assert_that(result, equal_to(firings))\n+      # Partition the result into early_firings and _.\n+      # In ACCUMULATING mode, the early_frings is [1, 3, 6, 10], other\n+      # firings are [15, 15, ...]. Different runners have different number\n+      # of 15s.\n+      early_firings, _ = result | beam.Partition(is_early_firing, 2)\n+      exepected_early_firings = [1, 3, 6, 10]\n+      assert_that(early_firings, equal_to(exepected_early_firings))", "originalCommit": "faaed37dd4aee6e3d9d4c52c9cbf099dc7338dda", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDc4OTM5Ng==", "url": "https://github.com/apache/beam/pull/10951#discussion_r384789396", "bodyText": "Wouldn't it be better to filter on the pane info itself?", "author": "robertwb", "createdAt": "2020-02-26T21:52:55Z", "path": "sdks/python/apache_beam/transforms/combiners_test.py", "diffHunk": "@@ -470,6 +470,9 @@ def test_combining_with_accumulation_mode_and_fanout(self):\n       ts.add_elements([i])\n     ts.advance_watermark_to_infinity()\n \n+    def is_early_firing(element, num_partitions):\n+      return 0 if element < 15 else 1", "originalCommit": "faaed37dd4aee6e3d9d4c52c9cbf099dc7338dda", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDg0NTUwMQ==", "url": "https://github.com/apache/beam/pull/10951#discussion_r384845501", "bodyText": "PaneInfo is not supported yet in Python.\nhttps://issues.apache.org/jira/browse/BEAM-3759", "author": "bumblebee-coming", "createdAt": "2020-02-27T00:18:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDc4OTM5Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDg0ODAzMw==", "url": "https://github.com/apache/beam/pull/10951#discussion_r384848033", "bodyText": "This was fixed last year. Looks like the bug was never closed.", "author": "robertwb", "createdAt": "2020-02-27T00:26:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDc4OTM5Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTk2Mjg2Ng==", "url": "https://github.com/apache/beam/pull/10951#discussion_r385962866", "bodyText": "I tried to do this, but it doesn't work. Can't get the timing by calling pane.timing().\nAttributeError: '_DoFnParam' object has no attribute 'timing'\ndef partition_firings(element, num_partitions, pane=beam.DoFn.PaneInfoParam):\nif pane.timing() == windowed_value.PaneInfoTiming.EARLY:\nreturn 0\nelif pane.timing() == windowed_value.PaneInfoTiming.ON_TIME:\nreturn 1\nelse:\nreturn 2", "author": "bumblebee-coming", "createdAt": "2020-02-28T23:08:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDc4OTM5Ng=="}], "type": "inlineReview"}, {"oid": "637fb55156d0a963faa938e59a38a6b41c2211d9", "url": "https://github.com/apache/beam/commit/637fb55156d0a963faa938e59a38a6b41c2211d9", "message": "Created a new matcher.", "committedDate": "2020-02-28T22:03:57Z", "type": "commit"}, {"oid": "cef317273cbc926604a6d1cc999e201386d72bdf", "url": "https://github.com/apache/beam/commit/cef317273cbc926604a6d1cc999e201386d72bdf", "message": "Deleted the new matcher and used a new partition function.", "committedDate": "2020-03-03T02:05:21Z", "type": "commit"}, {"oid": "26eb2fbc31e483a08e3507e5a538ced5da7148c9", "url": "https://github.com/apache/beam/commit/26eb2fbc31e483a08e3507e5a538ced5da7148c9", "message": "Formatted.", "committedDate": "2020-03-03T17:40:12Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzIxMDU3Mw==", "url": "https://github.com/apache/beam/pull/10951#discussion_r387210573", "bodyText": "Rather than do a partition, I would write something like\ndef has_expected_values(actual):\n  ordered = sorted(actual)\n  # Early firings.\n  hamcrest.assert_that(ordered[:4], hamcrest.contains(1, 3, 6, 10))\n  # Different runners have different number of 15s, but there should be at least one 15.\n  hamcrest.assert_that(set(ordered[4:]), hamcrest.contains(15))\nassert_that(result, has_expected_values)", "author": "robertwb", "createdAt": "2020-03-03T18:28:43Z", "path": "sdks/python/apache_beam/transforms/combiners_test.py", "diffHunk": "@@ -482,9 +492,20 @@ def test_combining_with_accumulation_mode_and_fanout(self):\n               trigger=AfterWatermark(early=AfterAll(AfterCount(1))))\n           | beam.CombineGlobally(sum).without_defaults().with_fanout(2))\n \n-      # The frings for DISCARDING mode is [1, 2, 3, 4, 5, 0, 0].\n-      firings = [1, 3, 6, 10, 15, 15, 15]\n-      assert_that(result, equal_to(firings))\n+      # Partition the result into early_firings and _.\n+      # In ACCUMULATING mode, the early_frings is [1, 3, 6, 10],\n+      # other_firings is [15, 15, ...]. Different runners have different\n+      # number of 15s, but there should be at least one 15.\n+      smaller_than_fifteen, fifteen, greater_than_fifteen = (", "originalCommit": "26eb2fbc31e483a08e3507e5a538ced5da7148c9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "e3439342a08f223d07b21177e6123823d4cdfeaf", "url": "https://github.com/apache/beam/commit/e3439342a08f223d07b21177e6123823d4cdfeaf", "message": "Use a custom matcher.", "committedDate": "2020-03-03T19:29:03Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzI0OTI1Mg==", "url": "https://github.com/apache/beam/pull/10951#discussion_r387249252", "bodyText": "only_contains allows for duplicates, which you don't want here. Use contains instead. (You could use it below, and drop the set in set(ordered[4:]).)", "author": "robertwb", "createdAt": "2020-03-03T19:39:19Z", "path": "sdks/python/apache_beam/transforms/combiners_test.py", "diffHunk": "@@ -482,9 +482,17 @@ def test_combining_with_accumulation_mode_and_fanout(self):\n               trigger=AfterWatermark(early=AfterAll(AfterCount(1))))\n           | beam.CombineGlobally(sum).without_defaults().with_fanout(2))\n \n-      # The frings for DISCARDING mode is [1, 2, 3, 4, 5, 0, 0].\n-      firings = [1, 3, 6, 10, 15, 15, 15]\n-      assert_that(result, equal_to(firings))\n+      def has_expected_values(actual):\n+        from hamcrest.core import assert_that as hamcrest_assert\n+        from hamcrest.library.collection import only_contains\n+        ordered = sorted(actual)\n+        # Early firings.\n+        hamcrest_assert(ordered[:4], only_contains(1, 3, 6, 10))", "originalCommit": "e3439342a08f223d07b21177e6123823d4cdfeaf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzI4ODU2MQ==", "url": "https://github.com/apache/beam/pull/10951#discussion_r387288561", "bodyText": "Done. Thank you! I forgot that contains here means exactly match the entire sequence.", "author": "bumblebee-coming", "createdAt": "2020-03-03T20:56:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzI0OTI1Mg=="}], "type": "inlineReview"}, {"oid": "22a8c2cf6efc87981b8e2a13ebeb7b8f327ff43a", "url": "https://github.com/apache/beam/commit/22a8c2cf6efc87981b8e2a13ebeb7b8f327ff43a", "message": "Replaced only_contains with contains.", "committedDate": "2020-03-03T20:53:00Z", "type": "commit"}]}