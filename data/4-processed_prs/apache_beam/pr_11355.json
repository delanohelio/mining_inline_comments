{"pr_number": 11355, "pr_title": "[BEAM-9727] Automatically set required experiment flags for dataflow runner v2.", "pr_createdAt": "2020-04-08T22:35:17Z", "pr_url": "https://github.com/apache/beam/pull/11355", "timeline": [{"oid": "194373d147dfdeb5cc871590d7769a2b6c933df2", "url": "https://github.com/apache/beam/commit/194373d147dfdeb5cc871590d7769a2b6c933df2", "message": "[BEAM-9727] Automatically set required experiment flags for dataflow runner v2.", "committedDate": "2020-04-08T23:44:20Z", "type": "forcePushed"}, {"oid": "0ece19a3cfe0697aa7a5d2ba02487cf91d9245d6", "url": "https://github.com/apache/beam/commit/0ece19a3cfe0697aa7a5d2ba02487cf91d9245d6", "message": "[BEAM-9727] Automatically set required experiment flags for dataflow runner v2.", "committedDate": "2020-04-08T23:46:32Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTg3OTk2Mw==", "url": "https://github.com/apache/beam/pull/11355#discussion_r405879963", "bodyText": "Debug options have has convenience method for lookup and adding experiments. We can use those instead of raw list.", "author": "angoenka", "createdAt": "2020-04-08T23:54:18Z", "path": "sdks/python/apache_beam/runners/dataflow/dataflow_runner.py", "diffHunk": "@@ -566,6 +572,17 @@ def run_pipeline(self, pipeline, options):\n     result.metric_results = self._metrics\n     return result\n \n+  def _maybe_add_unified_worker_missing_options(self, options):\n+    # set default beam_fn_api and use_unified_worker experiment if\n+    # 'use_runner_v2' experiment flag exists, no-op otherwise.\n+    experiments = options.view_as(DebugOptions).experiments or []", "originalCommit": "0ece19a3cfe0697aa7a5d2ba02487cf91d9245d6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTg4MDA4MA==", "url": "https://github.com/apache/beam/pull/11355#discussion_r405880080", "bodyText": "@pabloem Do we need to add BQ option here as well?", "author": "angoenka", "createdAt": "2020-04-08T23:54:44Z", "path": "sdks/python/apache_beam/runners/dataflow/dataflow_runner.py", "diffHunk": "@@ -566,6 +572,17 @@ def run_pipeline(self, pipeline, options):\n     result.metric_results = self._metrics\n     return result\n \n+  def _maybe_add_unified_worker_missing_options(self, options):\n+    # set default beam_fn_api and use_unified_worker experiment if\n+    # 'use_runner_v2' experiment flag exists, no-op otherwise.\n+    experiments = options.view_as(DebugOptions).experiments or []\n+    if 'use_runner_v2' in experiments:\n+      if not 'beam_fn_api' in experiments:", "originalCommit": "0ece19a3cfe0697aa7a5d2ba02487cf91d9245d6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjQwODU2OQ==", "url": "https://github.com/apache/beam/pull/11355#discussion_r406408569", "bodyText": "I think it makes sense to add it. 'use_beam_bq_sink'.", "author": "pabloem", "createdAt": "2020-04-09T18:50:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTg4MDA4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjQwOTIxNA==", "url": "https://github.com/apache/beam/pull/11355#discussion_r406409214", "bodyText": "can we do it for batch bq source as well? I don't think the UW can support the native BQ source...", "author": "ananvay", "createdAt": "2020-04-09T18:52:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTg4MDA4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjQyMzIyMw==", "url": "https://github.com/apache/beam/pull/11355#discussion_r406423223", "bodyText": "The switch for BQ source is a little trickier. I am working on a follow up PR for that.", "author": "pabloem", "createdAt": "2020-04-09T19:19:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTg4MDA4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjQzMDkyMw==", "url": "https://github.com/apache/beam/pull/11355#discussion_r406430923", "bodyText": "okay, let's do it at least for the bq_sink then, as Pablo commented earlier.", "author": "ananvay", "createdAt": "2020-04-09T19:34:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTg4MDA4MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTg4MDYwMg==", "url": "https://github.com/apache/beam/pull/11355#discussion_r405880602", "bodyText": "We have a method apiclient.use_unified_worker. We can use that instead of checking it explicitly.\nAlso, we can simplify/remove that method if we sanitize the options here.", "author": "angoenka", "createdAt": "2020-04-08T23:56:30Z", "path": "sdks/python/apache_beam/runners/dataflow/dataflow_runner.py", "diffHunk": "@@ -566,6 +572,17 @@ def run_pipeline(self, pipeline, options):\n     result.metric_results = self._metrics\n     return result\n \n+  def _maybe_add_unified_worker_missing_options(self, options):\n+    # set default beam_fn_api and use_unified_worker experiment if\n+    # 'use_runner_v2' experiment flag exists, no-op otherwise.\n+    experiments = options.view_as(DebugOptions).experiments or []\n+    if 'use_runner_v2' in experiments:", "originalCommit": "0ece19a3cfe0697aa7a5d2ba02487cf91d9245d6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "1608cfa90d4e167a4433c08f02c41f7d964350ab", "url": "https://github.com/apache/beam/commit/1608cfa90d4e167a4433c08f02c41f7d964350ab", "message": "[BEAM-9727] Automatically set required experiment flags for dataflow runner v2.", "committedDate": "2020-04-09T18:48:05Z", "type": "forcePushed"}, {"oid": "bd2302d034defb56019715f3f7b64a94e95e7add", "url": "https://github.com/apache/beam/commit/bd2302d034defb56019715f3f7b64a94e95e7add", "message": "[BEAM-9727] Automatically set required experiment flags for dataflow runner v2.", "committedDate": "2020-04-09T18:51:19Z", "type": "commit"}, {"oid": "bd2302d034defb56019715f3f7b64a94e95e7add", "url": "https://github.com/apache/beam/commit/bd2302d034defb56019715f3f7b64a94e95e7add", "message": "[BEAM-9727] Automatically set required experiment flags for dataflow runner v2.", "committedDate": "2020-04-09T18:51:19Z", "type": "forcePushed"}, {"oid": "23538f3f7654ff875352d5e5588015b139a8d162", "url": "https://github.com/apache/beam/commit/23538f3f7654ff875352d5e5588015b139a8d162", "message": "Minor doc fix", "committedDate": "2020-04-09T18:54:58Z", "type": "commit"}, {"oid": "d40ae9a097f5beb3a01d8ab3df7bf602b1b5bcd4", "url": "https://github.com/apache/beam/commit/d40ae9a097f5beb3a01d8ab3df7bf602b1b5bcd4", "message": "Add bq sink experiment.", "committedDate": "2020-04-09T20:09:23Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjQ1NTg2Mg==", "url": "https://github.com/apache/beam/pull/11355#discussion_r406455862", "bodyText": "formatting issue", "author": "lukecwik", "createdAt": "2020-04-09T20:23:24Z", "path": "sdks/python/apache_beam/runners/dataflow/internal/apiclient.py", "diffHunk": "@@ -1014,16 +1014,13 @@ def _use_fnapi(pipeline_options):\n \n \n def _use_unified_worker(pipeline_options):\n-  if not _use_fnapi(pipeline_options):\n-    return False\n   debug_options = pipeline_options.view_as(DebugOptions)\n   use_unified_worker_flag = 'use_unified_worker'\n+  use_runner_v2_flag = 'use_runner_v2'\n \n-  if debug_options.lookup_experiment(use_unified_worker_flag):\n-    return debug_options.lookup_experiment(use_unified_worker_flag)\n-\n-  if debug_options.lookup_experiment('use_runner_v2'):\n-    debug_options.add_experiment(use_unified_worker_flag)\n+  if (debug_options.lookup_experiment(use_runner_v2_flag) and not\n+  debug_options.lookup_experiment(use_unified_worker_flag)):", "originalCommit": "d40ae9a097f5beb3a01d8ab3df7bf602b1b5bcd4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "23ff8428187c8551742f717849a3d00119f914f4", "url": "https://github.com/apache/beam/commit/23ff8428187c8551742f717849a3d00119f914f4", "message": "Fix lint", "committedDate": "2020-04-09T20:29:10Z", "type": "commit"}, {"oid": "f427b5f36e2afba1819a97198ca175711b1bf077", "url": "https://github.com/apache/beam/commit/f427b5f36e2afba1819a97198ca175711b1bf077", "message": "fix test", "committedDate": "2020-04-09T23:29:56Z", "type": "commit"}]}