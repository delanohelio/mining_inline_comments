{"pr_number": 10627, "pr_title": "[BEAM-2535] Support outputTimestamp and watermark holds in processing timers.", "pr_createdAt": "2020-01-17T14:31:16Z", "pr_url": "https://github.com/apache/beam/pull/10627", "timeline": [{"oid": "de6d3ab01ecc05647ffcae9d09530feb955c6300", "url": "https://github.com/apache/beam/commit/de6d3ab01ecc05647ffcae9d09530feb955c6300", "message": "Adding outputTimestamp for processing Timers", "committedDate": "2020-01-17T14:29:05Z", "type": "commit"}, {"oid": "695db95297c55326e5585693178765eff57e520b", "url": "https://github.com/apache/beam/commit/695db95297c55326e5585693178765eff57e520b", "message": "Calculating outputTimestamp with outputTimestampOffset", "committedDate": "2020-01-17T20:02:42Z", "type": "commit"}, {"oid": "41cbfb5e50d172d980f34fda66d3981f7d308dd5", "url": "https://github.com/apache/beam/commit/41cbfb5e50d172d980f34fda66d3981f7d308dd5", "message": "Correcting calculation of outputtimestamp", "committedDate": "2020-01-17T20:44:33Z", "type": "commit"}, {"oid": "00dceb3d8a15831a9c074b93f797b388456dfc49", "url": "https://github.com/apache/beam/commit/00dceb3d8a15831a9c074b93f797b388456dfc49", "message": "Updating test case", "committedDate": "2020-01-21T12:30:25Z", "type": "commit"}, {"oid": "e41d3912f47bfd23de1be9b8930ace22729582bf", "url": "https://github.com/apache/beam/commit/e41d3912f47bfd23de1be9b8930ace22729582bf", "message": "Updating Input and Output Watermarks for processing timers", "committedDate": "2020-01-23T16:50:56Z", "type": "commit"}, {"oid": "a0b2e2ee3f3282149cf0906828620d41d0a88f9b", "url": "https://github.com/apache/beam/commit/a0b2e2ee3f3282149cf0906828620d41d0a88f9b", "message": "Adding outputTimestamp category in test", "committedDate": "2020-01-23T17:06:39Z", "type": "commit"}, {"oid": "a33f137f7caa8ed45c80d94f439972fd5e7bb9f7", "url": "https://github.com/apache/beam/commit/a33f137f7caa8ed45c80d94f439972fd5e7bb9f7", "message": "Merge branch 'master' into feature/processing-time", "committedDate": "2020-01-24T08:03:50Z", "type": "commit"}, {"oid": "87906d1370a2215292c9f1aacb5973942f322eee", "url": "https://github.com/apache/beam/commit/87906d1370a2215292c9f1aacb5973942f322eee", "message": "Add missing imports", "committedDate": "2020-01-24T10:34:39Z", "type": "commit"}, {"oid": "17f401ed216cb55e42630baa13a2af230e9ba12c", "url": "https://github.com/apache/beam/commit/17f401ed216cb55e42630baa13a2af230e9ba12c", "message": "Updating firedTime for processingTimers", "committedDate": "2020-01-27T13:04:26Z", "type": "commit"}, {"oid": "ef4407f489d076b19078eb4526f4e37098ceb30b", "url": "https://github.com/apache/beam/commit/ef4407f489d076b19078eb4526f4e37098ceb30b", "message": "Updating OnTimer, Removed equal checks in test cases", "committedDate": "2020-01-28T11:09:50Z", "type": "commit"}, {"oid": "aa1a9386b4e9a0c7ce321f732f2c16677a9e773e", "url": "https://github.com/apache/beam/commit/aa1a9386b4e9a0c7ce321f732f2c16677a9e773e", "message": "Merge branch 'master' into feature/processing-time", "committedDate": "2020-01-28T11:11:24Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjYwOTA2MA==", "url": "https://github.com/apache/beam/pull/10627#discussion_r372609060", "bodyText": "I'm not sure that we need withOutputTimestampOffset - I think withOutputTimestamp is sufficient.", "author": "reuvenlax", "createdAt": "2020-01-29T20:18:35Z", "path": "runners/core-java/src/main/java/org/apache/beam/runners/core/SimpleDoFnRunner.java", "diffHunk": "@@ -1074,6 +1075,12 @@ public Timer withOutputTimestamp(Instant outputTimestamp) {\n       return this;\n     }\n \n+    @Override\n+    public Timer withOutputTimestampOffset(Duration outputTimestampOffset) {\n+      this.outputTimestampOffset = outputTimestampOffset;\n+      return this;\n+    }", "originalCommit": "aa1a9386b4e9a0c7ce321f732f2c16677a9e773e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzEwMDcyNg==", "url": "https://github.com/apache/beam/pull/10627#discussion_r373100726", "bodyText": "@reuvenlax  done", "author": "rehmanmuradali", "createdAt": "2020-01-30T17:53:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjYwOTA2MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjYxMDczMQ==", "url": "https://github.com/apache/beam/pull/10627#discussion_r372610731", "bodyText": "I think that we should verify that the output timestamp is > the timestamp of the input message (if in processElement) or the output timestamp of the firing timer (if in processTimer). The < check remains correct - even for processing-time timers.", "author": "reuvenlax", "createdAt": "2020-01-29T20:22:23Z", "path": "runners/core-java/src/main/java/org/apache/beam/runners/core/SimpleDoFnRunner.java", "diffHunk": "@@ -1092,15 +1099,19 @@ private void verifyAbsoluteTimeDomain() {\n      * </ul>\n      */\n     private void setAndVerifyOutputTimestamp() {\n-      // Output timestamp is currently not supported in processing time timers.\n-      if (outputTimestamp != null && !TimeDomain.EVENT_TIME.equals(spec.getTimeDomain())) {\n-        throw new IllegalStateException(\"Cannot set outputTimestamp in processing time domain.\");\n-      }\n+\n       // Output timestamp is set to the delivery time if not initialized by an user.\n-      if (outputTimestamp == null) {\n+      if (outputTimestamp == null && TimeDomain.EVENT_TIME.equals(spec.getTimeDomain())) {\n         outputTimestamp = target;\n       }\n \n+      if (TimeDomain.PROCESSING_TIME.equals(spec.getTimeDomain())) {\n+        outputTimestamp =\n+            outputTimestampOffset.equals(Duration.ZERO)\n+                ? target\n+                : target.minus(offset.minus(outputTimestampOffset));\n+      }\n+\n       if (TimeDomain.EVENT_TIME.equals(spec.getTimeDomain())) {", "originalCommit": "aa1a9386b4e9a0c7ce321f732f2c16677a9e773e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzEwMDY4MQ==", "url": "https://github.com/apache/beam/pull/10627#discussion_r373100681", "bodyText": "@reuvenlax , does that mean we need to compare output timestamp with timerInternal.currentInputWatermarkTime()? I think it will fail our previous test case of output timestamp with event timer as we have set output timestamp as 5 while having a timestamp of input element as 9.", "author": "rehmanmuradali", "createdAt": "2020-01-30T17:53:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjYxMDczMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzExMzM2MQ==", "url": "https://github.com/apache/beam/pull/10627#discussion_r373113361", "bodyText": "@reuvenlax  done", "author": "rehmanmuradali", "createdAt": "2020-01-30T18:19:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjYxMDczMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjYxMTA1OQ==", "url": "https://github.com/apache/beam/pull/10627#discussion_r372611059", "bodyText": "I think that if the timer is processing time, then then default outputTimestamp should be that of the input element (or the output time of the firing timer if in processTimer).", "author": "reuvenlax", "createdAt": "2020-01-29T20:23:11Z", "path": "runners/core-java/src/main/java/org/apache/beam/runners/core/SimpleDoFnRunner.java", "diffHunk": "@@ -1092,15 +1099,19 @@ private void verifyAbsoluteTimeDomain() {\n      * </ul>\n      */\n     private void setAndVerifyOutputTimestamp() {\n-      // Output timestamp is currently not supported in processing time timers.\n-      if (outputTimestamp != null && !TimeDomain.EVENT_TIME.equals(spec.getTimeDomain())) {\n-        throw new IllegalStateException(\"Cannot set outputTimestamp in processing time domain.\");\n-      }\n+\n       // Output timestamp is set to the delivery time if not initialized by an user.\n-      if (outputTimestamp == null) {\n+      if (outputTimestamp == null && TimeDomain.EVENT_TIME.equals(spec.getTimeDomain())) {\n         outputTimestamp = target;\n       }", "originalCommit": "aa1a9386b4e9a0c7ce321f732f2c16677a9e773e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzExMzQ0Nw==", "url": "https://github.com/apache/beam/pull/10627#discussion_r373113447", "bodyText": "@reuvenlax  done", "author": "rehmanmuradali", "createdAt": "2020-01-30T18:20:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjYxMTA1OQ=="}], "type": "inlineReview"}, {"oid": "e27d620e4a3b91ddec8823be22a42a9f8c98fbba", "url": "https://github.com/apache/beam/commit/e27d620e4a3b91ddec8823be22a42a9f8c98fbba", "message": "Removing outputTimestamp Offset", "committedDate": "2020-01-30T14:29:23Z", "type": "commit"}, {"oid": "1d1ee2202255475d121b0880ee345d41848162c9", "url": "https://github.com/apache/beam/commit/1d1ee2202255475d121b0880ee345d41848162c9", "message": "Adding validation of output timestamp", "committedDate": "2020-01-30T18:17:16Z", "type": "commit"}, {"oid": "cac7b674ce8afafa920112e81d049e843a049b02", "url": "https://github.com/apache/beam/commit/cac7b674ce8afafa920112e81d049e843a049b02", "message": "Adding validation of output timestamp with respect to input element and firing timer", "committedDate": "2020-01-30T19:41:36Z", "type": "commit"}, {"oid": "54e897759e7a07a92116a027e38f15db08d5f08d", "url": "https://github.com/apache/beam/commit/54e897759e7a07a92116a027e38f15db08d5f08d", "message": "Minor fixes", "committedDate": "2020-01-30T19:45:54Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzE3MDE4Nw==", "url": "https://github.com/apache/beam/pull/10627#discussion_r373170187", "bodyText": "I think this should be timestamp(), not fireTimestamp().", "author": "reuvenlax", "createdAt": "2020-01-30T20:13:42Z", "path": "runners/core-java/src/main/java/org/apache/beam/runners/core/SimpleDoFnRunner.java", "diffHunk": "@@ -930,7 +935,7 @@ public Timer timer(String timerId) {\n       try {\n         TimerSpec spec = (TimerSpec) signature.timerDeclarations().get(timerId).field().get(fn);\n         return new TimerInternalsTimer(\n-            window, getNamespace(), timerId, spec, stepContext.timerInternals());\n+            window, getNamespace(), timerId, spec, fireTimestamp(), stepContext.timerInternals());", "originalCommit": "54e897759e7a07a92116a027e38f15db08d5f08d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzU1MzY2OA==", "url": "https://github.com/apache/beam/pull/10627#discussion_r373553668", "bodyText": "@reuvenlax  done", "author": "rehmanmuradali", "createdAt": "2020-01-31T16:00:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzE3MDE4Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzE3MDMxNg==", "url": "https://github.com/apache/beam/pull/10627#discussion_r373170316", "bodyText": "ditto - this should be timestamp() not fireTimestamp()", "author": "reuvenlax", "createdAt": "2020-01-30T20:13:57Z", "path": "runners/core-java/src/main/java/org/apache/beam/runners/core/SimpleDoFnRunner.java", "diffHunk": "@@ -942,7 +947,12 @@ public TimerMap timerFamily(String timerFamilyId) {\n         TimerSpec spec =\n             (TimerSpec) signature.timerFamilyDeclarations().get(timerFamilyId).field().get(fn);\n         return new TimerInternalsTimerMap(\n-            timerFamilyId, window(), getNamespace(), spec, stepContext.timerInternals());\n+            timerFamilyId,\n+            window(),\n+            getNamespace(),\n+            spec,\n+            fireTimestamp(),", "originalCommit": "54e897759e7a07a92116a027e38f15db08d5f08d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzU1MzcyOA==", "url": "https://github.com/apache/beam/pull/10627#discussion_r373553728", "bodyText": "done", "author": "rehmanmuradali", "createdAt": "2020-01-31T16:00:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzE3MDMxNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzE3MTA3Ng==", "url": "https://github.com/apache/beam/pull/10627#discussion_r373171076", "bodyText": "check outputTimestamp is in the window for processing-timer as well.", "author": "reuvenlax", "createdAt": "2020-01-30T20:15:39Z", "path": "runners/core-java/src/main/java/org/apache/beam/runners/core/SimpleDoFnRunner.java", "diffHunk": "@@ -1092,14 +1107,25 @@ private void verifyAbsoluteTimeDomain() {\n      * </ul>\n      */\n     private void setAndVerifyOutputTimestamp() {\n-      // Output timestamp is currently not supported in processing time timers.\n-      if (outputTimestamp != null && !TimeDomain.EVENT_TIME.equals(spec.getTimeDomain())) {\n-        throw new IllegalStateException(\"Cannot set outputTimestamp in processing time domain.\");\n-      }\n+\n       // Output timestamp is set to the delivery time if not initialized by an user.\n-      if (outputTimestamp == null) {\n+      if (outputTimestamp == null && TimeDomain.EVENT_TIME.equals(spec.getTimeDomain())) {\n         outputTimestamp = target;\n       }\n+      // For processing timers\n+      if (outputTimestamp == null) {\n+        // For processing timers output timestamp will be:\n+        // 1) timestamp of input element\n+        // OR\n+        // 2) output timestamp of firing timer.\n+        outputTimestamp = elementInputTimestamp;\n+      }\n+\n+      checkArgument(\n+          !outputTimestamp.isBefore(elementInputTimestamp),\n+          \"output timestamp %s should be after input message timestamp or output timestamp of firing timers %s\",\n+          outputTimestamp,\n+          elementInputTimestamp);\n \n       if (TimeDomain.EVENT_TIME.equals(spec.getTimeDomain())) {", "originalCommit": "54e897759e7a07a92116a027e38f15db08d5f08d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzU1NDA0Mw==", "url": "https://github.com/apache/beam/pull/10627#discussion_r373554043", "bodyText": "@reuvenlax done", "author": "rehmanmuradali", "createdAt": "2020-01-31T16:00:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzE3MTA3Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzE3MjAwMQ==", "url": "https://github.com/apache/beam/pull/10627#discussion_r373172001", "bodyText": "I think you want the second DoFn to set an event-time timer. That way you can test that the watermark hold in the first DoFn prevents firing of the second DoFn's timer, which it will only do if the second DoFn's timer is even time.", "author": "reuvenlax", "createdAt": "2020-01-30T20:17:46Z", "path": "sdks/java/core/src/test/java/org/apache/beam/sdk/transforms/ParDoTest.java", "diffHunk": "@@ -3806,6 +3807,90 @@ public void onTimer(\n       pipeline.run();\n     }\n \n+    @Test\n+    @Category({\n+      ValidatesRunner.class,\n+      UsesStatefulParDo.class,\n+      UsesTimersInParDo.class,\n+      UsesTestStreamWithProcessingTime.class,\n+      UsesTestStreamWithOutputTimestamp.class\n+    })\n+    public void testOutputTimestampWithProcessingTime() {\n+      final String timerId = \"foo\";\n+      DoFn<KV<String, Integer>, KV<String, Integer>> fn1 =\n+          new DoFn<KV<String, Integer>, KV<String, Integer>>() {\n+\n+            @TimerId(timerId)\n+            private final TimerSpec timer = TimerSpecs.timer(TimeDomain.PROCESSING_TIME);\n+\n+            @ProcessElement\n+            public void processElement(\n+                @TimerId(timerId) Timer timer,\n+                @Timestamp Instant timestamp,\n+                OutputReceiver<KV<String, Integer>> o) {\n+              timer\n+                  .withOutputTimestamp(timestamp.plus(Duration.standardSeconds(5)))\n+                  .offset(Duration.standardSeconds(10))\n+                  .setRelative();\n+              // Output a message. This will cause the next DoFn to set a timer as well.\n+              o.output(KV.of(\"foo\", 100));\n+            }\n+\n+            @OnTimer(timerId)\n+            public void onTimer(OnTimerContext c, BoundedWindow w) {}\n+          };\n+\n+      DoFn<KV<String, Integer>, Integer> fn2 =\n+          new DoFn<KV<String, Integer>, Integer>() {\n+\n+            @TimerId(timerId)\n+            private final TimerSpec timer = TimerSpecs.timer(TimeDomain.PROCESSING_TIME);", "originalCommit": "54e897759e7a07a92116a027e38f15db08d5f08d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzU1NDYyMA==", "url": "https://github.com/apache/beam/pull/10627#discussion_r373554620", "bodyText": "@reuvenlax  updated", "author": "rehmanmuradali", "createdAt": "2020-01-31T16:02:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzE3MjAwMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzE3NDgyOQ==", "url": "https://github.com/apache/beam/pull/10627#discussion_r373174829", "bodyText": "I don't think this is right. We want to fire timers based on firing time, not based on the hold.", "author": "reuvenlax", "createdAt": "2020-01-30T20:24:18Z", "path": "runners/direct-java/src/main/java/org/apache/beam/runners/direct/WatermarkManager.java", "diffHunk": "@@ -676,7 +676,9 @@ private synchronized void updateTimers(TimerUpdate update) {\n       Map<StructuralKey<?>, List<TimerData>> firedTimers;\n       switch (domain) {\n         case PROCESSING_TIME:\n-          firedTimers = extractFiredTimers(firingTime, processingTimers);\n+          firedTimers =\n+              extractFiredTimers(\n+                  INSTANT_ORDERING.min(firingTime, earliestHold.get()), processingTimers);", "originalCommit": "54e897759e7a07a92116a027e38f15db08d5f08d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzU1NDg4Nw==", "url": "https://github.com/apache/beam/pull/10627#discussion_r373554887", "bodyText": "done", "author": "rehmanmuradali", "createdAt": "2020-01-31T16:02:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzE3NDgyOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzE3NTI0NA==", "url": "https://github.com/apache/beam/pull/10627#discussion_r373175244", "bodyText": "I wonder if this is sufficient. The NavigableSet is ordered by timer firing time, not by outputTimestamp. This means that the logic to just look at the first timer (which was correct before we had holds) is probably no longer enough. we probably need to iterate over the set (or we need to have a second data structure to hold the watermark holds and take the minimum of that data structure).", "author": "reuvenlax", "createdAt": "2020-01-30T20:25:14Z", "path": "runners/direct-java/src/main/java/org/apache/beam/runners/direct/WatermarkManager.java", "diffHunk": "@@ -597,16 +597,16 @@ public synchronized Instant getEarliestTimerTimestamp() {\n       Instant earliest = THE_END_OF_TIME.get();\n       for (NavigableSet<TimerData> timers : processingTimers.values()) {\n         if (!timers.isEmpty()) {\n-          earliest = INSTANT_ORDERING.min(timers.first().getTimestamp(), earliest);", "originalCommit": "54e897759e7a07a92116a027e38f15db08d5f08d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzU1NTQ4Ng==", "url": "https://github.com/apache/beam/pull/10627#discussion_r373555486", "bodyText": "@reuvenlax  added a new function to calculate the earliest outputTimestamp from NavigableSet.", "author": "rehmanmuradali", "createdAt": "2020-01-31T16:03:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzE3NTI0NA=="}], "type": "inlineReview"}, {"oid": "311a38d623b72c70202641ee9c0454ec1d3306a0", "url": "https://github.com/apache/beam/commit/311a38d623b72c70202641ee9c0454ec1d3306a0", "message": "Input Element timestamp fix, processing timer after window validation, firing time fix, test case updates", "committedDate": "2020-01-31T09:21:13Z", "type": "commit"}, {"oid": "b7cd4a5a805f13a8e81c38db7aa6dc14fd55bfbb", "url": "https://github.com/apache/beam/commit/b7cd4a5a805f13a8e81c38db7aa6dc14fd55bfbb", "message": "Get earliest outputTimestamp", "committedDate": "2020-01-31T12:32:19Z", "type": "commit"}, {"oid": "4c6b602e16407bc099673555bc72a45692d2b1ad", "url": "https://github.com/apache/beam/commit/4c6b602e16407bc099673555bc72a45692d2b1ad", "message": "Adding outputtimestamp validation", "committedDate": "2020-01-31T12:47:41Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzgxMDc2NA==", "url": "https://github.com/apache/beam/pull/10627#discussion_r373810764", "bodyText": "are we missing an else clause here?", "author": "reuvenlax", "createdAt": "2020-02-02T00:38:48Z", "path": "runners/core-java/src/main/java/org/apache/beam/runners/core/SimpleDoFnRunner.java", "diffHunk": "@@ -1092,24 +1107,39 @@ private void verifyAbsoluteTimeDomain() {\n      * </ul>\n      */\n     private void setAndVerifyOutputTimestamp() {\n-      // Output timestamp is currently not supported in processing time timers.\n-      if (outputTimestamp != null && !TimeDomain.EVENT_TIME.equals(spec.getTimeDomain())) {\n-        throw new IllegalStateException(\"Cannot set outputTimestamp in processing time domain.\");\n-      }\n+\n       // Output timestamp is set to the delivery time if not initialized by an user.\n-      if (outputTimestamp == null) {\n+      if (outputTimestamp == null && TimeDomain.EVENT_TIME.equals(spec.getTimeDomain())) {\n         outputTimestamp = target;\n       }\n-\n-      if (TimeDomain.EVENT_TIME.equals(spec.getTimeDomain())) {\n-        Instant windowExpiry = window.maxTimestamp().plus(allowedLateness);\n-        checkArgument(\n-            !target.isAfter(windowExpiry),\n-            \"Attempted to set event time timer that outputs for %s but that is\"\n-                + \" after the expiration of window %s\",\n-            target,\n-            windowExpiry);\n+      // For processing timers\n+      if (outputTimestamp == null) {", "originalCommit": "4c6b602e16407bc099673555bc72a45692d2b1ad", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzgyNjA5OQ==", "url": "https://github.com/apache/beam/pull/10627#discussion_r373826099", "bodyText": "@reuvenlax  we only set outputTimestamp here. I think If that is already set before then we don't need anything. I think else clause is not required here.", "author": "rehmanmuradali", "createdAt": "2020-02-02T07:43:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzgxMDc2NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzgxMjIyMA==", "url": "https://github.com/apache/beam/pull/10627#discussion_r373812220", "bodyText": "final", "author": "reuvenlax", "createdAt": "2020-02-02T01:21:00Z", "path": "runners/core-java/src/main/java/org/apache/beam/runners/core/SimpleDoFnRunner.java", "diffHunk": "@@ -987,6 +997,7 @@ public void outputWithTimestamp(OutputT output, Instant timestamp) {\n     private final TimerSpec spec;\n     private Instant target;\n     private Instant outputTimestamp;\n+    private Instant elementInputTimestamp;", "originalCommit": "4c6b602e16407bc099673555bc72a45692d2b1ad", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzgyNTk2Nw==", "url": "https://github.com/apache/beam/pull/10627#discussion_r373825967", "bodyText": "@reuvenlax  done", "author": "rehmanmuradali", "createdAt": "2020-02-02T07:41:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzgxMjIyMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzgxNjU2Ng==", "url": "https://github.com/apache/beam/pull/10627#discussion_r373816566", "bodyText": "check this before setting outputTimestamp above (and only if outputTimestamp != null)", "author": "reuvenlax", "createdAt": "2020-02-02T03:33:29Z", "path": "runners/core-java/src/main/java/org/apache/beam/runners/core/SimpleDoFnRunner.java", "diffHunk": "@@ -1092,24 +1107,39 @@ private void verifyAbsoluteTimeDomain() {\n      * </ul>\n      */\n     private void setAndVerifyOutputTimestamp() {\n-      // Output timestamp is currently not supported in processing time timers.\n-      if (outputTimestamp != null && !TimeDomain.EVENT_TIME.equals(spec.getTimeDomain())) {\n-        throw new IllegalStateException(\"Cannot set outputTimestamp in processing time domain.\");\n-      }\n+\n       // Output timestamp is set to the delivery time if not initialized by an user.\n-      if (outputTimestamp == null) {\n+      if (outputTimestamp == null && TimeDomain.EVENT_TIME.equals(spec.getTimeDomain())) {\n         outputTimestamp = target;\n       }\n-\n-      if (TimeDomain.EVENT_TIME.equals(spec.getTimeDomain())) {\n-        Instant windowExpiry = window.maxTimestamp().plus(allowedLateness);\n-        checkArgument(\n-            !target.isAfter(windowExpiry),\n-            \"Attempted to set event time timer that outputs for %s but that is\"\n-                + \" after the expiration of window %s\",\n-            target,\n-            windowExpiry);\n+      // For processing timers\n+      if (outputTimestamp == null) {\n+        // For processing timers output timestamp will be:\n+        // 1) timestamp of input element\n+        // OR\n+        // 2) output timestamp of firing timer.\n+        outputTimestamp = elementInputTimestamp;\n       }\n+\n+      checkArgument(\n+          !outputTimestamp.isBefore(elementInputTimestamp),\n+          \"output timestamp %s should be after input message timestamp or output timestamp of firing timers %s\",\n+          outputTimestamp,\n+          elementInputTimestamp);", "originalCommit": "4c6b602e16407bc099673555bc72a45692d2b1ad", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzgyNTk5MQ==", "url": "https://github.com/apache/beam/pull/10627#discussion_r373825991", "bodyText": "@reuvenlax  done", "author": "rehmanmuradali", "createdAt": "2020-02-02T07:41:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzgxNjU2Ng=="}], "type": "inlineReview"}, {"oid": "d085688642c806814a6b0bec4169cf629944957b", "url": "https://github.com/apache/beam/commit/d085688642c806814a6b0bec4169cf629944957b", "message": "Output Timestamp validation fix", "committedDate": "2020-02-02T07:38:11Z", "type": "commit"}, {"oid": "c45ecc6a72bc3dd7803e9651b1b8adb097ee29cb", "url": "https://github.com/apache/beam/commit/c45ecc6a72bc3dd7803e9651b1b8adb097ee29cb", "message": "Merge branch 'master' into feature/processing-time", "committedDate": "2020-02-02T07:39:04Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTU0NjAyNg==", "url": "https://github.com/apache/beam/pull/10627#discussion_r375546026", "bodyText": "just use timer.set, not timer.offset", "author": "reuvenlax", "createdAt": "2020-02-05T22:33:40Z", "path": "sdks/java/core/src/test/java/org/apache/beam/sdk/transforms/ParDoTest.java", "diffHunk": "@@ -3806,6 +3812,90 @@ public void onTimer(\n       pipeline.run();\n     }\n \n+    @Test\n+    @Category({\n+      ValidatesRunner.class,\n+      UsesStatefulParDo.class,\n+      UsesTimersInParDo.class,\n+      UsesTestStreamWithProcessingTime.class,\n+      UsesTestStreamWithOutputTimestamp.class\n+    })\n+    public void testOutputTimestampWithProcessingTime() {\n+      final String timerId = \"foo\";\n+      DoFn<KV<String, Integer>, KV<String, Integer>> fn1 =\n+          new DoFn<KV<String, Integer>, KV<String, Integer>>() {\n+\n+            @TimerId(timerId)\n+            private final TimerSpec timer = TimerSpecs.timer(TimeDomain.PROCESSING_TIME);\n+\n+            @ProcessElement\n+            public void processElement(\n+                @TimerId(timerId) Timer timer,\n+                @Timestamp Instant timestamp,\n+                OutputReceiver<KV<String, Integer>> o) {\n+              timer\n+                  .withOutputTimestamp(timestamp.plus(Duration.standardSeconds(5)))\n+                  .offset(Duration.standardSeconds(10))\n+                  .setRelative();\n+              // Output a message. This will cause the next DoFn to set a timer as well.\n+              o.output(KV.of(\"foo\", 100));\n+            }\n+\n+            @OnTimer(timerId)\n+            public void onTimer(OnTimerContext c, BoundedWindow w) {}\n+          };\n+\n+      DoFn<KV<String, Integer>, Integer> fn2 =\n+          new DoFn<KV<String, Integer>, Integer>() {\n+\n+            @TimerId(timerId)\n+            private final TimerSpec timer = TimerSpecs.timer(TimeDomain.EVENT_TIME);\n+\n+            @StateId(\"timerFired\")\n+            final StateSpec<ValueState<Boolean>> timerFiredState = StateSpecs.value();\n+\n+            @ProcessElement\n+            public void processElement(\n+                @TimerId(timerId) Timer timer,\n+                @StateId(\"timerFired\") ValueState<Boolean> timerFiredState) {\n+              Boolean timerFired = timerFiredState.read();\n+              assertTrue(timerFired == null || !timerFired);\n+              // Set a timer to 8. This is earlier than the previous DoFn's timer, but after the\n+              // previous\n+              // DoFn timer's watermark hold. This timer should not fire until the previous timer\n+              // fires and removes\n+              // the watermark hold.\n+              timer.offset(Duration.standardSeconds(8)).setRelative();", "originalCommit": "c45ecc6a72bc3dd7803e9651b1b8adb097ee29cb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjA2ODY1OA==", "url": "https://github.com/apache/beam/pull/10627#discussion_r376068658", "bodyText": "@reuvenlax  done", "author": "rehmanmuradali", "createdAt": "2020-02-06T20:37:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTU0NjAyNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTU0ODgzMA==", "url": "https://github.com/apache/beam/pull/10627#discussion_r375548830", "bodyText": "I think you might have to advance processing time to at least 11.\nYou also need to advance the watermark to at least 10 to allow the timer to fire. Right now this isn't testing anything, because the input watermark is preventing the timer from firing.", "author": "reuvenlax", "createdAt": "2020-02-05T22:40:49Z", "path": "sdks/java/core/src/test/java/org/apache/beam/sdk/transforms/ParDoTest.java", "diffHunk": "@@ -3806,6 +3812,90 @@ public void onTimer(\n       pipeline.run();\n     }\n \n+    @Test\n+    @Category({\n+      ValidatesRunner.class,\n+      UsesStatefulParDo.class,\n+      UsesTimersInParDo.class,\n+      UsesTestStreamWithProcessingTime.class,\n+      UsesTestStreamWithOutputTimestamp.class\n+    })\n+    public void testOutputTimestampWithProcessingTime() {\n+      final String timerId = \"foo\";\n+      DoFn<KV<String, Integer>, KV<String, Integer>> fn1 =\n+          new DoFn<KV<String, Integer>, KV<String, Integer>>() {\n+\n+            @TimerId(timerId)\n+            private final TimerSpec timer = TimerSpecs.timer(TimeDomain.PROCESSING_TIME);\n+\n+            @ProcessElement\n+            public void processElement(\n+                @TimerId(timerId) Timer timer,\n+                @Timestamp Instant timestamp,\n+                OutputReceiver<KV<String, Integer>> o) {\n+              timer\n+                  .withOutputTimestamp(timestamp.plus(Duration.standardSeconds(5)))\n+                  .offset(Duration.standardSeconds(10))\n+                  .setRelative();\n+              // Output a message. This will cause the next DoFn to set a timer as well.\n+              o.output(KV.of(\"foo\", 100));\n+            }\n+\n+            @OnTimer(timerId)\n+            public void onTimer(OnTimerContext c, BoundedWindow w) {}\n+          };\n+\n+      DoFn<KV<String, Integer>, Integer> fn2 =\n+          new DoFn<KV<String, Integer>, Integer>() {\n+\n+            @TimerId(timerId)\n+            private final TimerSpec timer = TimerSpecs.timer(TimeDomain.EVENT_TIME);\n+\n+            @StateId(\"timerFired\")\n+            final StateSpec<ValueState<Boolean>> timerFiredState = StateSpecs.value();\n+\n+            @ProcessElement\n+            public void processElement(\n+                @TimerId(timerId) Timer timer,\n+                @StateId(\"timerFired\") ValueState<Boolean> timerFiredState) {\n+              Boolean timerFired = timerFiredState.read();\n+              assertTrue(timerFired == null || !timerFired);\n+              // Set a timer to 8. This is earlier than the previous DoFn's timer, but after the\n+              // previous\n+              // DoFn timer's watermark hold. This timer should not fire until the previous timer\n+              // fires and removes\n+              // the watermark hold.\n+              timer.offset(Duration.standardSeconds(8)).setRelative();\n+            }\n+\n+            @OnTimer(timerId)\n+            public void onTimer(\n+                @StateId(\"timerFired\") ValueState<Boolean> timerFiredState,\n+                OutputReceiver<Integer> o) {\n+              timerFiredState.write(true);\n+              o.output(100);\n+            }\n+          };\n+\n+      TestStream<KV<String, Integer>> stream =\n+          TestStream.create(KvCoder.of(StringUtf8Coder.of(), VarIntCoder.of()))\n+              .advanceProcessingTime(Duration.standardSeconds(1))\n+              // Cause fn2 to set a timer.\n+              .addElements(KV.of(\"key\", 1))\n+              // Normally this would case fn2's timer to expire, but it shouldn't here because of\n+              // the output timestamp.\n+              .advanceProcessingTime(Duration.standardSeconds(9))", "originalCommit": "c45ecc6a72bc3dd7803e9651b1b8adb097ee29cb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjA3MDQzNg==", "url": "https://github.com/apache/beam/pull/10627#discussion_r376070436", "bodyText": "@reuvenlax, I think if we advance processing time to 11, it will fire fn1's timer as we have set delivery time offset as 10. If we advance processing time by  9 and watermark by 11 then it will test the functionality?", "author": "rehmanmuradali", "createdAt": "2020-02-06T20:41:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTU0ODgzMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjE1MzU5NA==", "url": "https://github.com/apache/beam/pull/10627#discussion_r376153594", "bodyText": "yes, but you need to advance the watermark before calling addElements.", "author": "reuvenlax", "createdAt": "2020-02-07T00:14:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTU0ODgzMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjIzODkwOQ==", "url": "https://github.com/apache/beam/pull/10627#discussion_r376238909", "bodyText": "@reuvenlax done", "author": "rehmanmuradali", "createdAt": "2020-02-07T06:57:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTU0ODgzMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTU0OTYzMA==", "url": "https://github.com/apache/beam/pull/10627#discussion_r375549630", "bodyText": "What about the other getEarliestTimerTimestamp function? Does that need to be updated?", "author": "reuvenlax", "createdAt": "2020-02-05T22:42:52Z", "path": "runners/direct-java/src/main/java/org/apache/beam/runners/direct/WatermarkManager.java", "diffHunk": "@@ -597,20 +597,29 @@ public synchronized Instant getEarliestTimerTimestamp() {\n       Instant earliest = THE_END_OF_TIME.get();\n       for (NavigableSet<TimerData> timers : processingTimers.values()) {", "originalCommit": "c45ecc6a72bc3dd7803e9651b1b8adb097ee29cb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjA2ODQzNw==", "url": "https://github.com/apache/beam/pull/10627#discussion_r376068437", "bodyText": "@reuvenlax  done", "author": "rehmanmuradali", "createdAt": "2020-02-06T20:37:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTU0OTYzMA=="}], "type": "inlineReview"}, {"oid": "63f3a71e4d3d549f8c72d113097ca01a2113998c", "url": "https://github.com/apache/beam/commit/63f3a71e4d3d549f8c72d113097ca01a2113998c", "message": "Test case fix, getMinimumOutputTimestamp fix", "committedDate": "2020-02-06T20:36:08Z", "type": "commit"}]}