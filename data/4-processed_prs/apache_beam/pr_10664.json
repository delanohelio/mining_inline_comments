{"pr_number": 10664, "pr_title": "[BEAM-9172] Add missing parameter to Nexmark CI execution for Flink runner", "pr_createdAt": "2020-01-22T20:41:16Z", "pr_url": "https://github.com/apache/beam/pull/10664", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTgxMTAyNA==", "url": "https://github.com/apache/beam/pull/10664#discussion_r369811024", "bodyText": "Does this affect the runner used or just the table name? I'm asking because I believe the runner used is TestFlinkRunner (while the existing table is uses the former runner name).\n@mxm", "author": "udim", "createdAt": "2020-01-22T21:23:55Z", "path": ".test-infra/jenkins/job_PostCommit_Java_Nexmark_Flink.groovy", "diffHunk": "@@ -43,6 +43,7 @@ NoPhraseTriggeringPostCommitBuilder.postCommitJob('beam_PostCommit_Java_Nexmark_\n       switches('-Pnexmark.runner=\":runners:flink:1.9\"' +\n               ' -Pnexmark.args=\"' +\n               [NexmarkBigqueryProperties.nexmarkBigQueryArgs,\n+               '--runner=FlinkRunner',", "originalCommit": "3c8c9f23ea8d6fd05b6bbe248c76f2a876fb35bf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTgxMTg0OQ==", "url": "https://github.com/apache/beam/pull/10664#discussion_r369811849", "bodyText": "It affects both actually and no, TestFlinkRunner should not be used for Nexmark since this is not a 'Test' but a real 'execution'", "author": "iemejia", "createdAt": "2020-01-22T21:25:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTgxMTAyNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDAxOTY2Nw==", "url": "https://github.com/apache/beam/pull/10664#discussion_r370019667", "bodyText": "TestFlinkRunner is used to set the FlinkRunner's shutdownSourcesOnFinalWatermark pipeline option. In the regular FlinkRunner, streaming pipelines never shuts down which causes the tests to block here. When sources shut down checkpointing stops working in Flink, that's why we never shut down in production systems. See also https://jira.apache.org/jira/browse/FLINK-2491", "author": "mxm", "createdAt": "2020-01-23T09:49:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTgxMTAyNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDAyMjMwOQ==", "url": "https://github.com/apache/beam/pull/10664#discussion_r370022309", "bodyText": "You can use --shutdownSourcesOnFinalWatermark here.", "author": "mxm", "createdAt": "2020-01-23T09:54:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTgxMTAyNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDAzMTA1OA==", "url": "https://github.com/apache/beam/pull/10664#discussion_r370031058", "bodyText": "Adding the above pipeline option will unblock streaming.", "author": "mxm", "createdAt": "2020-01-23T10:11:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTgxMTAyNA=="}], "type": "inlineReview"}, {"oid": "eb1774743cfbf3a2818e6ac0a766c876094d69b6", "url": "https://github.com/apache/beam/commit/eb1774743cfbf3a2818e6ac0a766c876094d69b6", "message": "[BEAM-9172] Add missing parameter to Nexmark CI execution for Flink runner", "committedDate": "2020-01-22T21:36:28Z", "type": "forcePushed"}, {"oid": "a58271057ee511f40622fb1f520b77a3d017cbfa", "url": "https://github.com/apache/beam/commit/a58271057ee511f40622fb1f520b77a3d017cbfa", "message": "[BEAM-9172] Add missing parameter to Nexmark CI execution for Flink runner", "committedDate": "2020-01-23T10:22:30Z", "type": "forcePushed"}, {"oid": "8cfca6b1fc02dc03f3c4f1e76a9b951ea4fb2159", "url": "https://github.com/apache/beam/commit/8cfca6b1fc02dc03f3c4f1e76a9b951ea4fb2159", "message": "[BEAM-9172] Add missing parameter to Nexmark CI execution for Flink runner", "committedDate": "2020-01-23T15:36:49Z", "type": "commit"}, {"oid": "8cfca6b1fc02dc03f3c4f1e76a9b951ea4fb2159", "url": "https://github.com/apache/beam/commit/8cfca6b1fc02dc03f3c4f1e76a9b951ea4fb2159", "message": "[BEAM-9172] Add missing parameter to Nexmark CI execution for Flink runner", "committedDate": "2020-01-23T15:36:49Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDI1NzIwNQ==", "url": "https://github.com/apache/beam/pull/10664#discussion_r370257205", "bodyText": "It looks like we still want to use TestFlinkRunner here because it auto-sets the --shutdownSourcesOnFinalWatermark flag.", "author": "mxm", "createdAt": "2020-01-23T17:32:59Z", "path": ".test-infra/jenkins/job_PostCommit_Java_Nexmark_Flink.groovy", "diffHunk": "@@ -43,6 +43,8 @@ NoPhraseTriggeringPostCommitBuilder.postCommitJob('beam_PostCommit_Java_Nexmark_\n       switches('-Pnexmark.runner=\":runners:flink:1.9\"' +\n               ' -Pnexmark.args=\"' +\n               [NexmarkBigqueryProperties.nexmarkBigQueryArgs,\n+              '--runner=FlinkRunner',\n+              '--shutdownSourcesOnFinalWatermark=true',", "originalCommit": "8cfca6b1fc02dc03f3c4f1e76a9b951ea4fb2159", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDM0ODc2NQ==", "url": "https://github.com/apache/beam/pull/10664#discussion_r370348765", "bodyText": "No, if we use TestFlinkRunner the results will be saved in the table with the corrupted data (that has the results of the runs with the DirectRunner results). If we use FlinkRunner we will get the data in the same table with the historical data previous to 2019/01 so we can continue comparing performance history even with the big gap.", "author": "iemejia", "createdAt": "2020-01-23T20:54:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDI1NzIwNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDI1NzQ4Mw==", "url": "https://github.com/apache/beam/pull/10664#discussion_r370257483", "bodyText": "This string broke the result reporting because it wrote to the wrong BigQuery table?", "author": "mxm", "createdAt": "2020-01-23T17:33:36Z", "path": ".test-infra/jenkins/CommonTestProperties.groovy", "diffHunk": "@@ -29,7 +29,7 @@ class CommonTestProperties {\n         DATAFLOW(\"DataflowRunner\"),\n         SPARK(\"SparkRunner\"),\n         SPARK_STRUCTURED_STREAMING(\"SparkStructuredStreamingRunner\"),\n-        FLINK(\"TestFlinkRunner\"),\n+        FLINK(\"FlinkRunner\"),", "originalCommit": "8cfca6b1fc02dc03f3c4f1e76a9b951ea4fb2159", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDI2MDQ2OA==", "url": "https://github.com/apache/beam/pull/10664#discussion_r370260468", "bodyText": "Together with setting --runner=TestFlinkRunner, this should suffice to make it work again.", "author": "mxm", "createdAt": "2020-01-23T17:40:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDI1NzQ4Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDM0OTI0MQ==", "url": "https://github.com/apache/beam/pull/10664#discussion_r370349241", "bodyText": "Yes exactly this wrote to a different table than the historic one. Also having the non Test version will make it uniform with all the other runners + having the parallelism not limited to 1 which gave the impression of worse performance.", "author": "iemejia", "createdAt": "2020-01-23T20:55:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDI1NzQ4Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDI2MDA5Ng==", "url": "https://github.com/apache/beam/pull/10664#discussion_r370260096", "bodyText": "This can also be removed if we use TestFlinkRunner.", "author": "mxm", "createdAt": "2020-01-23T17:39:12Z", "path": ".test-infra/jenkins/job_PostCommit_Java_Nexmark_Flink.groovy", "diffHunk": "@@ -107,8 +115,9 @@ PhraseTriggeringPostCommitBuilder.postCommitJob('beam_PostCommit_Java_Nexmark_Fl\n   commonJobProperties.setTopLevelMainJobProperties(delegate, 'master', 240)\n \n   def final JOB_SPECIFIC_OPTIONS = [\n-          'suite'        : 'SMOKE',\n-          'streamTimeout': 60,\n+          'suite' : 'SMOKE',\n+          'streamTimeout' : 60,\n+          'shutdownSourcesOnFinalWatermark' : true,", "originalCommit": "8cfca6b1fc02dc03f3c4f1e76a9b951ea4fb2159", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDM0OTg4Nw==", "url": "https://github.com/apache/beam/pull/10664#discussion_r370349887", "bodyText": "Same arguments as above. Considering the pros cons I think we have way more extra work letting things back to TestFlinkRunner, also we were supposed to remove this testrunner things no? Please remember that Nexmark is not a UT or a IT, it is a 'user application' so it should be using the real runner.", "author": "iemejia", "createdAt": "2020-01-23T20:56:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDI2MDA5Ng=="}], "type": "inlineReview"}]}