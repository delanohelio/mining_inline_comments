{"pr_number": 13393, "pr_title": "[BEAM-10593] Add Jenkins job for creating regular snapshots of the Beam SDK Harness Container Images", "pr_createdAt": "2020-11-20T10:34:04Z", "pr_url": "https://github.com/apache/beam/pull/13393", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzYwMTY5Ng==", "url": "https://github.com/apache/beam/pull/13393#discussion_r527601696", "bodyText": "Our current plan is to use the associated commit with the latest snapshot for Beam imports -  we'd rather not keep them nightly, but perhaps every hour is excessive?", "author": "emilymye", "createdAt": "2020-11-20T10:35:37Z", "path": ".test-infra/jenkins/job_Publish_SDK_Image_Snapshots.groovy", "diffHunk": "@@ -0,0 +1,52 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+import CommonJobProperties as commonJobProperties\n+\n+// This job publishes regular snapshots of the SDK harness containers for\n+// testing purposes. It builds and pushes the SDK container to the\n+// specified GCR repo, tagged at the current Git commit.\n+job('beam_Publish_Beam_SDK_Snapshots') {\n+  description('Builds SDK harness images snapshots regularly for testing purposes.')\n+\n+  // Set common parameters.\n+  commonJobProperties.setTopLevelMainJobProperties(delegate)\n+\n+  // // Runs once per hour.\n+  commonJobProperties.setAutoJob(delegate, '0 * * * *')", "originalCommit": "c33d3dbdbb42086488784a47bfb9d17fb43f91e0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzk5MjUxNQ==", "url": "https://github.com/apache/beam/pull/13393#discussion_r527992515", "bodyText": "How long does it take to run?\nMaybe start with\nH H/4 * * *\nTo run every 4 hours at a deterministic (hash) minute/hour?", "author": "alanmyrvold", "createdAt": "2020-11-20T21:57:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzYwMTY5Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzk5Nzc4Mg==", "url": "https://github.com/apache/beam/pull/13393#discussion_r527997782", "bodyText": "We could also have more frequent runs at the times when more commits are typically landing, and less frequent otherwise, can also reconsider if this becomes inconvenient. Also, would a committer be able to trigger a run manually?", "author": "tvalentyn", "createdAt": "2020-11-20T22:09:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzYwMTY5Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODAyMjQyMw==", "url": "https://github.com/apache/beam/pull/13393#discussion_r528022423", "bodyText": "probably <20 minutes (based on Publish_Docker_Snapshots - py38 is the longest usually)\nI think we'll just start with H H/4 * * *", "author": "emilymye", "createdAt": "2020-11-20T23:25:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzYwMTY5Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzYwMTk5NQ==", "url": "https://github.com/apache/beam/pull/13393#discussion_r527601995", "bodyText": "If there is a better place to pull this in, please let me know!", "author": "emilymye", "createdAt": "2020-11-20T10:35:57Z", "path": ".test-infra/jenkins/job_Publish_SDK_Image_Snapshots.groovy", "diffHunk": "@@ -0,0 +1,52 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+import CommonJobProperties as commonJobProperties\n+\n+// This job publishes regular snapshots of the SDK harness containers for\n+// testing purposes. It builds and pushes the SDK container to the\n+// specified GCR repo, tagged at the current Git commit.\n+job('beam_Publish_Beam_SDK_Snapshots') {\n+  description('Builds SDK harness images snapshots regularly for testing purposes.')\n+\n+  // Set common parameters.\n+  commonJobProperties.setTopLevelMainJobProperties(delegate)\n+\n+  // // Runs once per hour.\n+  commonJobProperties.setAutoJob(delegate, '0 * * * *')\n+\n+  // Use jenkins env var interpolation - leave in single quotes\n+  def imageRepo = 'gcr.io/apache-beam-testing/beam-sdk'\n+  def imageTag = '${GIT_COMMIT}'", "originalCommit": "c33d3dbdbb42086488784a47bfb9d17fb43f91e0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzYwMzI1MQ==", "url": "https://github.com/apache/beam/pull/13393#discussion_r527603251", "bodyText": "I also wonder if we should error if not running against master - it would make sense to at least tag it differently or place non-master in a different repository folder so a PR-created snapshot can't replace a valid master snapshot as a latest tag.", "author": "emilymye", "createdAt": "2020-11-20T10:38:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzYwMTk5NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzk4NjY0Mg==", "url": "https://github.com/apache/beam/pull/13393#discussion_r527986642", "bodyText": "if this job is triggered on schedule, will it actually be run against non-master? or we talk about somebody trying to run the job manually against non-master?", "author": "tvalentyn", "createdAt": "2020-11-20T21:42:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzYwMTk5NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODAyMDYzMg==", "url": "https://github.com/apache/beam/pull/13393#discussion_r528020632", "bodyText": "the second - basically to guard against test snapshots getting put into the same repo. Our plan is to tie the import to a given snapshot commit, so whoever is doing the import will want to choose a commit at which a snapshot exists.", "author": "emilymye", "createdAt": "2020-11-20T23:19:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzYwMTk5NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTA3NzQxNQ==", "url": "https://github.com/apache/beam/pull/13393#discussion_r529077415", "bodyText": "I think there is no concern with on-demand runs since we tag on git commit. If we will need to build these container images for handling non-master imports, we can include branch name in the imageRepo or use the release/rc tags instead of commit tags.", "author": "tvalentyn", "createdAt": "2020-11-24T00:09:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzYwMTk5NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzk5MDMzOA==", "url": "https://github.com/apache/beam/pull/13393#discussion_r527990338", "bodyText": "let's not hardcode the specific python versions to have less places to change, when we have a new python version to add. Btw, similar concern may soon apply to Java as well.\nConsider adding an entry to:\nhttps://github.com/apache/beam/blob/85b30233910efc1daf93afc76ea03d7eef2d6257/.test-infra/jenkins/PythonTestProperties.groovy\nand populate gradle tasks based on the configuration, similar to  \n  \n    \n      beam/.test-infra/jenkins/job_PostCommit_CrossLanguageValidatesRunner_Dataflow.groovy\n    \n    \n         Line 43\n      in\n      31fd516\n    \n    \n    \n    \n\n        \n          \n           CROSS_LANGUAGE_VALIDATES_RUNNER_DATAFLOW_USING_JAVA_PYTHON_VERSIONS.each { pythonVersion -> \n        \n    \n  \n\n\nWe could also choose better name for PythonTestProperties down the road.", "author": "tvalentyn", "createdAt": "2020-11-20T21:52:09Z", "path": ".test-infra/jenkins/job_Publish_SDK_Image_Snapshots.groovy", "diffHunk": "@@ -0,0 +1,52 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+import CommonJobProperties as commonJobProperties\n+\n+// This job publishes regular snapshots of the SDK harness containers for\n+// testing purposes. It builds and pushes the SDK container to the\n+// specified GCR repo, tagged at the current Git commit.\n+job('beam_Publish_Beam_SDK_Snapshots') {\n+  description('Builds SDK harness images snapshots regularly for testing purposes.')\n+\n+  // Set common parameters.\n+  commonJobProperties.setTopLevelMainJobProperties(delegate)\n+\n+  // // Runs once per hour.\n+  commonJobProperties.setAutoJob(delegate, '0 * * * *')\n+\n+  // Use jenkins env var interpolation - leave in single quotes\n+  def imageRepo = 'gcr.io/apache-beam-testing/beam-sdk'\n+  def imageTag = '${GIT_COMMIT}'\n+\n+  steps {\n+    shell(\"echo 'Pushing SDK snapshots to ${imageRepo} at tag: ${imageTag}\")\n+    gradle {\n+      rootBuildScriptDir(commonJobProperties.checkoutDir)\n+      commonJobProperties.setGradleSwitches(delegate)\n+      tasks(':sdks:go:container:dockerPush')\n+      tasks(':sdks:python:container:java8:dockerPush')\n+      tasks(':sdks:python:container:java11:dockerPush')\n+      tasks(':sdks:python:container:py36:dockerPush')", "originalCommit": "c33d3dbdbb42086488784a47bfb9d17fb43f91e0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "0819f742357cd2d730a5c8155c722d27e3ae7f08", "url": "https://github.com/apache/beam/commit/0819f742357cd2d730a5c8155c722d27e3ae7f08", "message": "add Jenkins auto-job for creating regular snapshots of the Beam SDKs", "committedDate": "2020-11-20T22:50:57Z", "type": "commit"}, {"oid": "b1bd3d7bd0a5e3394ba1cad7b4a3e3115631f804", "url": "https://github.com/apache/beam/commit/b1bd3d7bd0a5e3394ba1cad7b4a3e3115631f804", "message": "change crontab and add java/python common properties for generated containers", "committedDate": "2020-11-20T22:50:57Z", "type": "commit"}, {"oid": "b1bd3d7bd0a5e3394ba1cad7b4a3e3115631f804", "url": "https://github.com/apache/beam/commit/b1bd3d7bd0a5e3394ba1cad7b4a3e3115631f804", "message": "change crontab and add java/python common properties for generated containers", "committedDate": "2020-11-20T22:50:57Z", "type": "forcePushed"}, {"oid": "55355e6afbd65e9cf9b46f5c91f91a30ca196fcb", "url": "https://github.com/apache/beam/commit/55355e6afbd65e9cf9b46f5c91f91a30ca196fcb", "message": "set job to every 4 hours", "committedDate": "2020-11-20T23:26:08Z", "type": "commit"}, {"oid": "0f866f77d718a4a0a29f5302afa0bafc682f14fc", "url": "https://github.com/apache/beam/commit/0f866f77d718a4a0a29f5302afa0bafc682f14fc", "message": "missing single quote", "committedDate": "2020-11-20T23:27:49Z", "type": "commit"}, {"oid": "baf397c055488c8eeb4653e770081acac747b6e1", "url": "https://github.com/apache/beam/commit/baf397c055488c8eeb4653e770081acac747b6e1", "message": "fixes", "committedDate": "2020-11-21T00:38:54Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTA3MzY3OQ==", "url": "https://github.com/apache/beam/pull/13393#discussion_r529073679", "bodyText": "Run once every 4 hours?", "author": "tvalentyn", "createdAt": "2020-11-23T23:58:19Z", "path": ".test-infra/jenkins/job_Publish_Docker_Snapshots.groovy", "diffHunk": "@@ -33,15 +34,15 @@ job('beam_Publish_Docker_Snapshots') {\n       )\n \n   // Runs once per day.", "originalCommit": "baf397c055488c8eeb4653e770081acac747b6e1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTA4MTc4OQ==", "url": "https://github.com/apache/beam/pull/13393#discussion_r529081789", "bodyText": "Whoops, I actually changed the wrong file - will change", "author": "emilymye", "createdAt": "2020-11-24T00:22:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTA3MzY3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTA4MjczMg==", "url": "https://github.com/apache/beam/pull/13393#discussion_r529082732", "bodyText": "yeah, I was just going to ask if it was intentional :)", "author": "tvalentyn", "createdAt": "2020-11-24T00:25:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTA3MzY3OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTA3NDQxOA==", "url": "https://github.com/apache/beam/pull/13393#discussion_r529074418", "bodyText": "Leftover?", "author": "tvalentyn", "createdAt": "2020-11-24T00:00:27Z", "path": ".test-infra/jenkins/job_Publish_SDK_Image_Snapshots.groovy", "diffHunk": "@@ -0,0 +1,58 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+import CommonJobProperties as commonJobProperties\n+import static JavaTestProperties.SUPPORTED_CONTAINER_TASKS as SUPPORTED_JAVA_CONTAINER_TASKS\n+import static PythonTestProperties.SUPPORTED_CONTAINER_TASKS as SUPPORTED_PYTHON_CONTAINER_TASKS\n+\n+// This job publishes regular snapshots of the SDK harness containers for\n+// testing purposes. It builds and pushes the SDK container to the\n+// specified GCR repo, tagged at the current Git commit.\n+job('beam_Publish_Beam_SDK_Snapshots') {\n+  description('Builds SDK harness images snapshots regularly for testing purposes.')\n+\n+  // Set common parameters.\n+  commonJobProperties.setTopLevelMainJobProperties(delegate)\n+\n+  // Runs once per hour during MTV time (9-16 UTC-8 --> 17-23,0-1UTC)\n+  commonJobProperties.setAutoJob(delegate, 'H 0-2,17-23 * * *')\n+\n+  // Use jenkins env var interpolation - leave in single quotes\n+  def imageRepo = 'gcr.io/apache-beam-testing/beam-sdk'\n+  def imageTag = '${GIT_COMMIT}'\n+\n+  steps {\n+    shell(\"echo 'Pushing SDK snapshots to ${imageRepo} at tag: ${imageTag}'\")\n+    gradle {\n+      rootBuildScriptDir(commonJobProperties.checkoutDir)\n+      commonJobProperties.setGradleSwitches(delegate)\n+      tasks(':sdks:go:container:dockerPush')\n+      SUPPORTED_JAVA_CONTAINER_TASKS.each { taskVer ->\n+        tasks(\":sdks:java:container:${taskVer}:dockerPush\")\n+      }\n+      SUPPORTED_PYTHON_CONTAINER_TASKS.each { taskVer ->\n+        tasks(\":sdks:python:container:${taskVer}:dockerPush\")\n+      }\n+      tasks(':sdks:python:container:py36:dockerPush')\n+      tasks(':sdks:python:container:py37:dockerPush')\n+      tasks(':sdks:python:container:py38:dockerPush')", "originalCommit": "baf397c055488c8eeb4653e770081acac747b6e1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "0fb5d59379c9360176567487e85b8278a6712eb6", "url": "https://github.com/apache/beam/commit/0fb5d59379c9360176567487e85b8278a6712eb6", "message": "fix cron change to wrong file", "committedDate": "2020-11-24T00:24:43Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTEzNTQ4Mw==", "url": "https://github.com/apache/beam/pull/13393#discussion_r529135483", "bodyText": "@lazylynx FYI we could make use of the ALL_SUPPORTED_VERSIONS instead of this constant after your upcoming change (#13382).", "author": "tvalentyn", "createdAt": "2020-11-24T02:08:13Z", "path": ".test-infra/jenkins/PythonTestProperties.groovy", "diffHunk": "@@ -17,6 +17,7 @@\n  */\n \n class PythonTestProperties {\n+  final static List<String> SUPPORTED_CONTAINER_TASKS = ['py36', 'py37', 'py38']", "originalCommit": "0fb5d59379c9360176567487e85b8278a6712eb6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}