{"pr_number": 13474, "pr_title": "[BEAM-10475] Add typehints for ShardedKeyCoder", "pr_createdAt": "2020-12-03T17:48:25Z", "pr_url": "https://github.com/apache/beam/pull/13474", "timeline": [{"oid": "2148300884e49bdb58c521a1b24ea56a8c4ac700", "url": "https://github.com/apache/beam/commit/2148300884e49bdb58c521a1b24ea56a8c4ac700", "message": "Add typehints for ShardedKeyCoder", "committedDate": "2020-12-03T17:42:34Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTQ3MDI1Mw==", "url": "https://github.com/apache/beam/pull/13474#discussion_r535470253", "bodyText": "To verify: this type constraint is for Beam internal use only and users are not expected specify it?", "author": "udim", "createdAt": "2020-12-03T18:16:05Z", "path": "sdks/python/apache_beam/typehints/sharded_key_type.py", "diffHunk": "@@ -0,0 +1,69 @@\n+#\n+# Licensed to the Apache Software Foundation (ASF) under one or more\n+# contributor license agreements.  See the NOTICE file distributed with\n+# this work for additional information regarding copyright ownership.\n+# The ASF licenses this file to You under the Apache License, Version 2.0\n+# (the \"License\"); you may not use this file except in compliance with\n+# the License.  You may obtain a copy of the License at\n+#\n+#    http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+#\n+\n+# pytype: skip-file\n+\n+from __future__ import absolute_import\n+\n+from apache_beam.coders import typecoders\n+from apache_beam.coders.coders import ShardedKeyCoder\n+from apache_beam.typehints import typehints\n+from apache_beam.utils.sharded_key import ShardedKey\n+\n+\n+class ShardedKeyTypeConstraint(typehints.TypeConstraint):", "originalCommit": "2148300884e49bdb58c521a1b24ea56a8c4ac700", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTcwNTY4Mw==", "url": "https://github.com/apache/beam/pull/13474#discussion_r535705683", "bodyText": "Users or dev may use it for specifying the output type of a transform to provide type hints.", "author": "nehsyc", "createdAt": "2020-12-03T22:53:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTQ3MDI1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjQwNzkzNg==", "url": "https://github.com/apache/beam/pull/13474#discussion_r536407936", "bodyText": "If you do want to allow something like a ShardedKey type hint annotation in code, add it here:\n\n  \n    \n      beam/sdks/python/apache_beam/typehints/typehints.py\n    \n    \n         Line 1117\n      in\n      edc087e\n    \n    \n    \n    \n\n        \n          \n           Any = AnyTypeConstraint() \n        \n    \n  \n\n\n(doesn't have to be in this PR)", "author": "udim", "createdAt": "2020-12-04T21:58:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTQ3MDI1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjQyMTE0MA==", "url": "https://github.com/apache/beam/pull/13474#discussion_r536421140", "bodyText": "I see. Thanks for pointing it out. I will change that in a follow-up PR.", "author": "nehsyc", "createdAt": "2020-12-04T22:28:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTQ3MDI1Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTUxMzgyMQ==", "url": "https://github.com/apache/beam/pull/13474#discussion_r535513821", "bodyText": "Why isn't this import at the top of the file?", "author": "udim", "createdAt": "2020-12-03T19:20:12Z", "path": "sdks/python/apache_beam/coders/coders.py", "diffHunk": "@@ -1485,6 +1486,21 @@ def as_cloud_object(self, coders_context=None):\n         ],\n     }\n \n+  def to_type_hint(self):\n+    from apache_beam.typehints import sharded_key_type", "originalCommit": "2148300884e49bdb58c521a1b24ea56a8c4ac700", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTcwNTcwNA==", "url": "https://github.com/apache/beam/pull/13474#discussion_r535705704", "bodyText": "To avoid circular import.", "author": "nehsyc", "createdAt": "2020-12-03T22:53:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTUxMzgyMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTUyNjAxMg==", "url": "https://github.com/apache/beam/pull/13474#discussion_r535526012", "bodyText": "The 2 exceptions raised here should have test coverage.", "author": "udim", "createdAt": "2020-12-03T19:33:37Z", "path": "sdks/python/apache_beam/typehints/sharded_key_type.py", "diffHunk": "@@ -0,0 +1,69 @@\n+#\n+# Licensed to the Apache Software Foundation (ASF) under one or more\n+# contributor license agreements.  See the NOTICE file distributed with\n+# this work for additional information regarding copyright ownership.\n+# The ASF licenses this file to You under the Apache License, Version 2.0\n+# (the \"License\"); you may not use this file except in compliance with\n+# the License.  You may obtain a copy of the License at\n+#\n+#    http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+#\n+\n+# pytype: skip-file\n+\n+from __future__ import absolute_import\n+\n+from apache_beam.coders import typecoders\n+from apache_beam.coders.coders import ShardedKeyCoder\n+from apache_beam.typehints import typehints\n+from apache_beam.utils.sharded_key import ShardedKey\n+\n+\n+class ShardedKeyTypeConstraint(typehints.TypeConstraint):\n+  def __init__(self, key_type):\n+    self.key_type = typehints.normalize(key_type)\n+\n+  def _inner_types(self):\n+    yield self.key_type\n+\n+  def _consistent_with_check_(self, sub):\n+    return (\n+        isinstance(sub, self.__class__) and\n+        typehints.is_consistent_with(sub.key_type, self.key_type))\n+\n+  def type_check(self, instance):", "originalCommit": "2148300884e49bdb58c521a1b24ea56a8c4ac700", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTcwNjAyNw==", "url": "https://github.com/apache/beam/pull/13474#discussion_r535706027", "bodyText": "Done. Added test coverage and some minor fixes in the latest commit.", "author": "nehsyc", "createdAt": "2020-12-03T22:54:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTUyNjAxMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTUzMDc2Mw==", "url": "https://github.com/apache/beam/pull/13474#discussion_r535530763", "bodyText": "This branch should have test coverage.", "author": "udim", "createdAt": "2020-12-03T19:38:48Z", "path": "sdks/python/apache_beam/coders/coders.py", "diffHunk": "@@ -1485,6 +1486,21 @@ def as_cloud_object(self, coders_context=None):\n         ],\n     }\n \n+  def to_type_hint(self):\n+    from apache_beam.typehints import sharded_key_type\n+    return sharded_key_type.ShardedKeyTypeConstraint(\n+        self._key_coder.to_type_hint())\n+\n+  @staticmethod\n+  def from_type_hint(typehint, registry):\n+    from apache_beam.typehints import sharded_key_type\n+    if isinstance(typehint, sharded_key_type.ShardedKeyTypeConstraint):\n+      return ShardedKeyCoder(registry.get_coder(typehint.key_type))\n+    else:\n+      raise ValueError((", "originalCommit": "2148300884e49bdb58c521a1b24ea56a8c4ac700", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTcwNjEwMA==", "url": "https://github.com/apache/beam/pull/13474#discussion_r535706100", "bodyText": "Done.", "author": "nehsyc", "createdAt": "2020-12-03T22:54:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTUzMDc2Mw=="}], "type": "inlineReview"}, {"oid": "6cc9e10db9f57ae55059510f9faaa117d2da32a4", "url": "https://github.com/apache/beam/commit/6cc9e10db9f57ae55059510f9faaa117d2da32a4", "message": "Add test coverage for ShardedKeyTypeConstraint", "committedDate": "2020-12-04T18:17:35Z", "type": "commit"}, {"oid": "6cc9e10db9f57ae55059510f9faaa117d2da32a4", "url": "https://github.com/apache/beam/commit/6cc9e10db9f57ae55059510f9faaa117d2da32a4", "message": "Add test coverage for ShardedKeyTypeConstraint", "committedDate": "2020-12-04T18:17:35Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjQxMDYzMA==", "url": "https://github.com/apache/beam/pull/13474#discussion_r536410630", "bodyText": "Note: self.assertRaisesRegex can also check exception messages.", "author": "udim", "createdAt": "2020-12-04T22:04:43Z", "path": "sdks/python/apache_beam/typehints/sharded_key_type_test.py", "diffHunk": "@@ -0,0 +1,80 @@\n+#\n+# Licensed to the Apache Software Foundation (ASF) under one or more\n+# contributor license agreements.  See the NOTICE file distributed with\n+# this work for additional information regarding copyright ownership.\n+# The ASF licenses this file to You under the Apache License, Version 2.0\n+# (the \"License\"); you may not use this file except in compliance with\n+# the License.  You may obtain a copy of the License at\n+#\n+#    http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+#\n+\n+\"\"\"Unit tests for the ShardedKeyTypeConstraint.\"\"\"\n+\n+# pytype: skip-file\n+\n+from __future__ import absolute_import\n+\n+from apache_beam.typehints import Tuple\n+from apache_beam.typehints import typehints\n+from apache_beam.typehints.sharded_key_type import ShardedKeyTypeConstraint\n+from apache_beam.typehints.typehints_test import TypeHintTestCase\n+from apache_beam.utils.sharded_key import ShardedKey\n+\n+\n+class ShardedKeyTypeConstraintTest(TypeHintTestCase):\n+  def test_compatibility(self):\n+    constraint1 = ShardedKeyTypeConstraint(int)\n+    constraint2 = ShardedKeyTypeConstraint(str)\n+\n+    self.assertCompatible(constraint1, constraint1)\n+    self.assertCompatible(constraint2, constraint2)\n+    self.assertNotCompatible(constraint1, constraint2)\n+\n+  def test_repr(self):\n+    constraint = ShardedKeyTypeConstraint(int)\n+    self.assertEqual('ShardedKey(int)', repr(constraint))\n+\n+  def test_type_check_not_sharded_key(self):\n+    constraint = ShardedKeyTypeConstraint(int)\n+    obj = 5\n+    with self.assertRaises(TypeError) as e:", "originalCommit": "6cc9e10db9f57ae55059510f9faaa117d2da32a4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjQyMTE3Mg==", "url": "https://github.com/apache/beam/pull/13474#discussion_r536421172", "bodyText": "Good to know!", "author": "nehsyc", "createdAt": "2020-12-04T22:28:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjQxMDYzMA=="}], "type": "inlineReview"}]}