{"pr_number": 10566, "pr_title": "[BEAM-6008] Propagate errors during pipeline execution in Java's PortableRunner", "pr_createdAt": "2020-01-13T15:59:41Z", "pr_url": "https://github.com/apache/beam/pull/10566", "timeline": [{"oid": "1db2e3976fb2a5c15c77e55928e19c003db3b387", "url": "https://github.com/apache/beam/commit/1db2e3976fb2a5c15c77e55928e19c003db3b387", "message": "[BEAM-6008] Propagate errors during pipeline execution in Java's PortableRunner\n\nThe error reporting for Java test cases currently yields:\n\n```\njava.lang.AssertionError: Pipeline did not succeed.\nExpected: is <DONE>\n     but: was <FAILED>\n```\n\nNot particularly helpful. This improves the situation by retrieving the error\nmessages from the job service.", "committedDate": "2020-01-13T15:57:11Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTkyODc0MA==", "url": "https://github.com/apache/beam/pull/10566#discussion_r365928740", "bodyText": "I've added this to make it consistent with the state updates, which we also save. However, this may be too memory intense, I'm seeing that the test time increased here: https://builds.apache.org/job/beam_PreCommit_Python2_PVR_Flink_Commit/2320/\nNeed to check if this is due to this change. If so, we could subscribe to the messages before running the pipeline which would remove the need to save the messages.", "author": "mxm", "createdAt": "2020-01-13T17:25:27Z", "path": "runners/java-fn-execution/src/main/java/org/apache/beam/runners/fnexecution/jobsubmission/JobInvocation.java", "diffHunk": "@@ -243,6 +249,7 @@ private synchronized void setState(JobState.Enum state) {\n   }\n \n   private synchronized void sendMessage(JobMessage message) {\n+    messageHistory.add(message);", "originalCommit": "1db2e3976fb2a5c15c77e55928e19c003db3b387", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjAyNDkzMg==", "url": "https://github.com/apache/beam/pull/10566#discussion_r366024932", "bodyText": "yeah, I'd be wary of storing all of that.  There should be a way to cap the number of historical messages a user cares about.   We could choose a sensible default for now and come back and expose it as an option later if anyone cares to do so.", "author": "chadrik", "createdAt": "2020-01-13T20:59:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTkyODc0MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjAzNzMyMg==", "url": "https://github.com/apache/beam/pull/10566#discussion_r366037322", "bodyText": "Right now, it looks like sendMessage is only being called by onFailure:\n\n  \n    \n      beam/runners/java-fn-execution/src/main/java/org/apache/beam/runners/fnexecution/jobsubmission/JobInvocation.java\n    \n    \n        Lines 141 to 150\n      in\n      1db2e39\n    \n    \n    \n    \n\n        \n          \n           sendMessage( \n        \n\n        \n          \n               JobMessage.newBuilder() \n        \n\n        \n          \n                   .setMessageText(getStackTraceAsString(throwable)) \n        \n\n        \n          \n                   .setImportance(JobMessage.MessageImportance.JOB_MESSAGE_DEBUG) \n        \n\n        \n          \n                   .build()); \n        \n\n        \n          \n           sendMessage( \n        \n\n        \n          \n               JobMessage.newBuilder() \n        \n\n        \n          \n                   .setMessageText(getRootCause(throwable).toString()) \n        \n\n        \n          \n                   .setImportance(JobMessage.MessageImportance.JOB_MESSAGE_ERROR) \n        \n\n        \n          \n                   .build()); \n        \n    \n  \n\n\nMeaning there should be only 2 messages per pipeline failure. Unless there's something I'm missing?", "author": "ibzib", "createdAt": "2020-01-13T21:27:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTkyODc0MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjEyMDU1Mw==", "url": "https://github.com/apache/beam/pull/10566#discussion_r366120553", "bodyText": "Good point.  I can confirm that is the behavior that I have seen.", "author": "chadrik", "createdAt": "2020-01-14T01:59:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTkyODc0MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjIxNjM2NQ==", "url": "https://github.com/apache/beam/pull/10566#discussion_r366216365", "bodyText": "yeah, I'd be wary of storing all of that.\n\nWe have the same problem for the state updates which are smaller but also can arrive at a higher frequency. How about (1) limiting the number of past invocations? We would keep all the state updates / messages per invocation. (2) An alternative could be to just store the error-related messages. (3) A third option would be to subscribe to the message stream early before pipeline execution starts.\nI'm leaning towards (1) because that would still allow the retrieval of past state updates that I think was a requirement for you @chadrik.\n\nMeaning there should be only 2 messages per pipeline failure. Unless there's something I'm missing?\n\nThat's right. However, the messages also contain the state updates which we already save. So there is some room for optimization the storage.\nWill follow-up regarding the build time but it looks like it almost doubled which we should definitely take serious.", "author": "mxm", "createdAt": "2020-01-14T08:59:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTkyODc0MA=="}], "type": "inlineReview"}]}