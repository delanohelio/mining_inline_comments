{"pr_number": 10654, "pr_title": "[BEAM-9167] Reduce Go SDK metric overhead", "pr_createdAt": "2020-01-22T01:44:18Z", "pr_url": "https://github.com/apache/beam/pull/10654", "timeline": [{"oid": "5a5c4cf12c13b3773111823de894945a4a909e95", "url": "https://github.com/apache/beam/commit/5a5c4cf12c13b3773111823de894945a4a909e95", "message": "[BEAM-9167] Reduce Go SDK metric overhead", "committedDate": "2020-01-22T01:22:00Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTc2OTQ4MQ==", "url": "https://github.com/apache/beam/pull/10654#discussion_r369769481", "bodyText": "Nit: Is part of the comment missing, or was this just a typo of a comma instead of a period?", "author": "youngoli", "createdAt": "2020-01-22T19:51:45Z", "path": "sdks/go/pkg/beam/core/metrics/metrics.go", "diffHunk": "@@ -64,22 +67,57 @@ import (\n // using metrics requires the PTransform have a context.Context\n // argument.\n \n+// perBundle is a struct that retains per transform countersets.\n+// TODO(lostluck): Migrate the exec package to use these to extract\n+// metric data for export to runner, rather than the global store.\n+type perBundle struct {\n+\tmu  sync.Mutex\n+\tcss []*ptCounterSet\n+}\n+\n+type nameHash uint64\n+\n+// ptCounterSet is the internal tracking struct for a single ptransform\n+// in a single bundle for all counter types.\n+type ptCounterSet struct {\n+\t// We store the user path access to the cells in metric type segregated\n+\t// maps. At present, caching the name hash,", "originalCommit": "5a5c4cf12c13b3773111823de894945a4a909e95", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTg3NzU2OQ==", "url": "https://github.com/apache/beam/pull/10654#discussion_r369877569", "bodyText": "Thanks! This is a sentence fragment. I'll fix it in the next PR which needs to update this code a bit anyway.", "author": "lostluck", "createdAt": "2020-01-23T00:25:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTc2OTQ4MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTg3ODgzNw==", "url": "https://github.com/apache/beam/pull/10654#discussion_r369878837", "bodyText": "sgtm", "author": "youngoli", "createdAt": "2020-01-23T00:30:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTc2OTQ4MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTgxNjYwOA==", "url": "https://github.com/apache/beam/pull/10654#discussion_r369816608", "bodyText": "and lifts the values for metrics keys for value for faster lookups.\n\nThis is hard for me to parse. Is there a typo in there?", "author": "youngoli", "createdAt": "2020-01-22T21:36:06Z", "path": "sdks/go/pkg/beam/core/metrics/metrics.go", "diffHunk": "@@ -64,22 +67,57 @@ import (\n // using metrics requires the PTransform have a context.Context\n // argument.\n \n+// perBundle is a struct that retains per transform countersets.\n+// TODO(lostluck): Migrate the exec package to use these to extract\n+// metric data for export to runner, rather than the global store.\n+type perBundle struct {\n+\tmu  sync.Mutex\n+\tcss []*ptCounterSet\n+}\n+\n+type nameHash uint64\n+\n+// ptCounterSet is the internal tracking struct for a single ptransform\n+// in a single bundle for all counter types.\n+type ptCounterSet struct {\n+\t// We store the user path access to the cells in metric type segregated\n+\t// maps. At present, caching the name hash,\n+\tcounters      map[nameHash]*counter\n+\tdistributions map[nameHash]*distribution\n+\tgauges        map[nameHash]*gauge\n+}\n+\n type ctxKey string\n \n-const bundleKey ctxKey = \"beam:bundle\"\n-const ptransformKey ctxKey = \"beam:ptransform\"\n+const (\n+\tbundleKey     ctxKey = \"beam:bundle\"\n+\tptransformKey ctxKey = \"beam:ptransform\"\n+\tcounterSetKey ctxKey = \"beam:counterset\"\n+)\n \n // beamCtx is a caching context for IDs necessary to place metric updates.\n-//  Allocating contexts and searching for PTransformIDs for every element\n+// Allocating contexts and searching for PTransformIDs for every element\n // is expensive, so we avoid it if possible.\n type beamCtx struct {\n \tcontext.Context\n \tbundleID, ptransformID string\n+\tbs                     *perBundle\n+\tcs                     *ptCounterSet\n }\n \n-// Value lifts the beam contLift the keys value for faster lookups when not available.\n+// Value implements context.Value for beamCtx, and lifts the\n+// values for metrics keys for value for faster lookups.", "originalCommit": "5a5c4cf12c13b3773111823de894945a4a909e95", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTg3ODEyMw==", "url": "https://github.com/apache/beam/pull/10654#discussion_r369878123", "bodyText": "That last \"for value\" is definitely out of place.\nIn the next PR, I'll replace it with the following:\nValue implements the context.Value interface method for beamCtx. The implementation lifts the\nstored values for metrics keys to the top level beamCtx for faster lookups.", "author": "lostluck", "createdAt": "2020-01-23T00:27:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTgxNjYwOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTg3ODc4NA==", "url": "https://github.com/apache/beam/pull/10654#discussion_r369878784", "bodyText": "That works really well, sounds good", "author": "youngoli", "createdAt": "2020-01-23T00:30:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTgxNjYwOA=="}], "type": "inlineReview"}]}