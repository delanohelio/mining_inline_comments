{"pr_number": 11020, "pr_title": "[BEAM-7926] Update Data Visualization", "pr_createdAt": "2020-03-03T00:05:03Z", "pr_url": "https://github.com/apache/beam/pull/11020", "timeline": [{"oid": "4c0d28f273f23031abc968f7ca3472440b0d325f", "url": "https://github.com/apache/beam/commit/4c0d28f273f23031abc968f7ca3472440b0d325f", "message": "[BEAM-7926] Update Data Visualization\n\n1. Added include_window_info and visualize_data as **kwargs passed into\n   `show`.\n2. Updated javascripts to make the data visualization smooth and\n   resilient to DOM changes. Now datatable is loaded dynamically without\n   flickering nor changing of user's page/search state; javascripts also\n   work when refreshing the browser.\n3. Resolved the jQuery+Datatable loading issue by forcing chained\n   loading. Any customized javascripts relying on jQuery should only use\n   `window.jquery341`. Always carry out a check for `window.jquery341`.\n   Run javascripts in the last onload of the jQuery loading chain if\n   `window.jquery341` is not available.\n4. All HTML imports are chained at onload of webcomponents (if HTML import\n   is not supported) or plainly imported (if HTML import supported) in a\n   single place in document.head. This makes HTML import resilient to\n   DOM changes caused by normal notebook usages.\n5. Updated some logging statements.\n6. Added `show_graph` API to render DAG of a pipeline. `pipeline.run`\n   does not render DAG now.\n\nChange-Id: Id2ca548860fb2d30e1557a35e7b14d2e61b5f1a4", "committedDate": "2020-03-03T00:18:48Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzI1Mjg0NA==", "url": "https://github.com/apache/beam/pull/11020#discussion_r387252844", "bodyText": "Why this one does not have the catch statement?", "author": "aaltay", "createdAt": "2020-03-03T19:46:10Z", "path": "sdks/python/apache_beam/runners/interactive/display/pcoll_visualization.py", "diffHunk": "@@ -52,42 +56,89 @@\n except ImportError:\n   _pcoll_visualization_ready = False\n \n+_LOGGER = logging.getLogger(__name__)\n+\n # 1-d types that need additional normalization to be compatible with DataFrame.\n _one_dimension_types = (int, float, str, bool, list, tuple)\n \n+_CSS = \"\"\"\n+            <style>\n+            .p-Widget.jp-OutputPrompt.jp-OutputArea-prompt:empty {{\n+              padding: 0;\n+              border: 0;\n+            }}\n+            .p-Widget.jp-RenderedJavaScript.jp-mod-trusted.jp-OutputArea-output:empty {{\n+              padding: 0;\n+              border: 0;\n+            }}\n+            </style>\"\"\"\n _DIVE_SCRIPT_TEMPLATE = \"\"\"\n-            document.querySelector(\"#{display_id}\").data = {jsonstr};\"\"\"\n-_DIVE_HTML_TEMPLATE = \"\"\"\n+            try {{\n+              document.querySelector(\"#{display_id}\").data = {jsonstr};\n+            }} catch (e) {{\n+              console.log(\"#{display_id} is not rendered yet.\");\n+            }}\"\"\"\n+_DIVE_HTML_TEMPLATE = _CSS + \"\"\"\n             <script src=\"https://cdnjs.cloudflare.com/ajax/libs/webcomponentsjs/1.3.3/webcomponents-lite.js\"></script>\n             <link rel=\"import\" href=\"https://raw.githubusercontent.com/PAIR-code/facets/1.0.0/facets-dist/facets-jupyter.html\">\n             <facets-dive sprite-image-width=\"{sprite_size}\" sprite-image-height=\"{sprite_size}\" id=\"{display_id}\" height=\"600\"></facets-dive>\n             <script>\n               document.querySelector(\"#{display_id}\").data = {jsonstr};\n             </script>\"\"\"\n _OVERVIEW_SCRIPT_TEMPLATE = \"\"\"\n-              document.querySelector(\"#{display_id}\").protoInput = \"{protostr}\";\n-              \"\"\"\n-_OVERVIEW_HTML_TEMPLATE = \"\"\"\n+              try {{\n+                document.querySelector(\"#{display_id}\").protoInput = \"{protostr}\";\n+              }} catch (e) {{\n+                console.log(\"#{display_id} is not rendered yet.\");\n+              }}\"\"\"\n+_OVERVIEW_HTML_TEMPLATE = _CSS + \"\"\"\n             <script src=\"https://cdnjs.cloudflare.com/ajax/libs/webcomponentsjs/1.3.3/webcomponents-lite.js\"></script>\n             <link rel=\"import\" href=\"https://raw.githubusercontent.com/PAIR-code/facets/1.0.0/facets-dist/facets-jupyter.html\">\n             <facets-overview id=\"{display_id}\"></facets-overview>\n             <script>\n               document.querySelector(\"#{display_id}\").protoInput = \"{protostr}\";", "originalCommit": "4c0d28f273f23031abc968f7ca3472440b0d325f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzI2ODk4NA==", "url": "https://github.com/apache/beam/pull/11020#discussion_r387268984", "bodyText": "This is kernel (server) side rendering, the HTML is not in DOM yet, so the element must be there when the HTML gets rendered in browser.", "author": "KevinGG", "createdAt": "2020-03-03T20:16:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzI1Mjg0NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzM1NzU3NQ==", "url": "https://github.com/apache/beam/pull/11020#discussion_r387357575", "bodyText": "Maybe I do not understand. The script in the script tag is it executed on the server side?", "author": "aaltay", "createdAt": "2020-03-03T23:31:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzI1Mjg0NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzQxNDg5OA==", "url": "https://github.com/apache/beam/pull/11020#discussion_r387414898", "bodyText": "Sorry, let me put it in an example.\nThe HTML+JS template is formatted into an HTML obj and gets displayed into the frontend. Inside this little piece of HTML, the document.querySelector(\"#{display_id}\") will always return such queried element because the element is created within the HTML itself.\nThen this little piece of HTML is embedded in the notebook's DOM. It resides in the output area of a cell in the notebook.\nIf the user \"clears all outputs\" from the notebook, the HTML is deleted from the DOM.\nNow, document.querySelector(\"#{display_id}\") will return undefined.\nThe user will see Javascript error being populated in the output area that just got cleared.\nThe output continuously increases at the show interval (1 second) until the visualization is done.", "author": "KevinGG", "createdAt": "2020-03-04T02:25:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzI1Mjg0NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzI1Mjk0MA==", "url": "https://github.com/apache/beam/pull/11020#discussion_r387252940", "bodyText": "Could we wait for document onLoad?", "author": "aaltay", "createdAt": "2020-03-03T19:46:22Z", "path": "sdks/python/apache_beam/runners/interactive/display/pcoll_visualization.py", "diffHunk": "@@ -52,42 +56,89 @@\n except ImportError:\n   _pcoll_visualization_ready = False\n \n+_LOGGER = logging.getLogger(__name__)\n+\n # 1-d types that need additional normalization to be compatible with DataFrame.\n _one_dimension_types = (int, float, str, bool, list, tuple)\n \n+_CSS = \"\"\"\n+            <style>\n+            .p-Widget.jp-OutputPrompt.jp-OutputArea-prompt:empty {{\n+              padding: 0;\n+              border: 0;\n+            }}\n+            .p-Widget.jp-RenderedJavaScript.jp-mod-trusted.jp-OutputArea-output:empty {{\n+              padding: 0;\n+              border: 0;\n+            }}\n+            </style>\"\"\"\n _DIVE_SCRIPT_TEMPLATE = \"\"\"\n-            document.querySelector(\"#{display_id}\").data = {jsonstr};\"\"\"\n-_DIVE_HTML_TEMPLATE = \"\"\"\n+            try {{\n+              document.querySelector(\"#{display_id}\").data = {jsonstr};\n+            }} catch (e) {{\n+              console.log(\"#{display_id} is not rendered yet.\");\n+            }}\"\"\"\n+_DIVE_HTML_TEMPLATE = _CSS + \"\"\"\n             <script src=\"https://cdnjs.cloudflare.com/ajax/libs/webcomponentsjs/1.3.3/webcomponents-lite.js\"></script>\n             <link rel=\"import\" href=\"https://raw.githubusercontent.com/PAIR-code/facets/1.0.0/facets-dist/facets-jupyter.html\">\n             <facets-dive sprite-image-width=\"{sprite_size}\" sprite-image-height=\"{sprite_size}\" id=\"{display_id}\" height=\"600\"></facets-dive>\n             <script>\n               document.querySelector(\"#{display_id}\").data = {jsonstr};\n             </script>\"\"\"\n _OVERVIEW_SCRIPT_TEMPLATE = \"\"\"\n-              document.querySelector(\"#{display_id}\").protoInput = \"{protostr}\";\n-              \"\"\"\n-_OVERVIEW_HTML_TEMPLATE = \"\"\"\n+              try {{\n+                document.querySelector(\"#{display_id}\").protoInput = \"{protostr}\";\n+              }} catch (e) {{\n+                console.log(\"#{display_id} is not rendered yet.\");", "originalCommit": "4c0d28f273f23031abc968f7ca3472440b0d325f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzI2NzQxMA==", "url": "https://github.com/apache/beam/pull/11020#discussion_r387267410", "bodyText": "Facets widgets doesn't depend on the jQuery we setup.\nThe JS also doesn't depend on the webcomponent (it's for HTML import).\nSo there is no need to wait for onload of anything.\nThe DOM changes when the output area containing the widgets being updated gets deleted by the user in the notebook and some JS exceptions could be thrown out.\nThis is to avoid display_javascript polluting the output area of notebooks in this scenario.", "author": "KevinGG", "createdAt": "2020-03-03T20:13:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzI1Mjk0MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzM1OTM3NA==", "url": "https://github.com/apache/beam/pull/11020#discussion_r387359374", "bodyText": "If this try fails, what happens?\nIs the console.log statement valuable in this case?", "author": "aaltay", "createdAt": "2020-03-03T23:36:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzI1Mjk0MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzQxNTk0MQ==", "url": "https://github.com/apache/beam/pull/11020#discussion_r387415941", "bodyText": "If this fails, it means the initially displayed widgets have been cleared from the DOM or the initial display hasn't completed yet (maybe because of some racing conditions). NOOP should be the right way to handle it because it either means the user has cleared the output or the script has no target to execute on.\nThe error is supposed to be logged in the console. However, if not caught, it also gets displayed in notebook output areas. By doing this, we kept the log and also avoid the output area pollution.", "author": "KevinGG", "createdAt": "2020-03-04T02:29:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzI1Mjk0MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzgyODc5Nw==", "url": "https://github.com/apache/beam/pull/11020#discussion_r387828797", "bodyText": "The error is supposed to be logged in the console. However, if not caught, it also gets displayed in notebook output areas. By doing this, we kept the log and also avoid the output area pollution.\nThis make sense. Do you even need it in the console log? After catching, we could choose to not log it. Is it useful to log?", "author": "aaltay", "createdAt": "2020-03-04T17:44:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzI1Mjk0MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzg1NzI1OA==", "url": "https://github.com/apache/beam/pull/11020#discussion_r387857258", "bodyText": "I think it's most useful only when we do debugging because end users of notebooks wouldn't open a developer tool.\nI'll remove the logging, but keep the catch clause.", "author": "KevinGG", "createdAt": "2020-03-04T18:37:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzI1Mjk0MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzI1Mzg5Mg==", "url": "https://github.com/apache/beam/pull/11020#discussion_r387253892", "bodyText": "You can probably drop these comments. They are pretty obvious form variable names and use up to this point.", "author": "aaltay", "createdAt": "2020-03-03T19:48:10Z", "path": "sdks/python/apache_beam/runners/interactive/display/pcoll_visualization.py", "diffHunk": "@@ -181,6 +247,12 @@ def __init__(self, pcoll):\n     self._overview_display_id = 'facets_overview_{}_{}'.format(\n         self._cache_key, id(self))\n     self._df_display_id = 'df_{}_{}'.format(self._cache_key, id(self))\n+    # Whether the visualization should include window info.", "originalCommit": "4c0d28f273f23031abc968f7ca3472440b0d325f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzI2OTQ5Mg==", "url": "https://github.com/apache/beam/pull/11020#discussion_r387269492", "bodyText": "Got it, removing these comments.", "author": "KevinGG", "createdAt": "2020-03-03T20:17:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzI1Mzg5Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzI1NDY2OQ==", "url": "https://github.com/apache/beam/pull/11020#discussion_r387254669", "bodyText": "Why are we copying data?", "author": "aaltay", "createdAt": "2020-03-03T19:49:32Z", "path": "sdks/python/apache_beam/runners/interactive/display/pcoll_visualization.py", "diffHunk": "@@ -215,20 +287,32 @@ def display_facets(self, updating_pv=None):\n     # Ensures that dive, overview and table render the same data because the\n     # materialized PCollection data might being updated continuously.\n     data = self._to_dataframe()\n+    # String-ify the dictionaries for display because elements of type dict\n+    # cannot be ordered.\n+    data = data.applymap(lambda x: str(x) if isinstance(x, dict) else x)\n     if updating_pv:\n-      self._display_dive(data, updating_pv._dive_display_id)\n-      self._display_overview(data, updating_pv._overview_display_id)\n-      self._display_dataframe(data, updating_pv._df_display_id)\n+      # Only updates when data is not empty. Otherwise, consider it a bad\n+      # iteration and noop since there is nothing to be updated.\n+      if data.empty:\n+        _LOGGER.debug('Skip a visualization update due to empty data.')\n+      else:\n+        self._display_dataframe(data.copy(deep=True), updating_pv)\n+        if self._display_facets:\n+          self._display_dive(data.copy(deep=True), updating_pv)", "originalCommit": "4c0d28f273f23031abc968f7ca3472440b0d325f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzI3Njk5NQ==", "url": "https://github.com/apache/beam/pull/11020#discussion_r387276995", "bodyText": "Because we make different changes (such as formatting and dropping some columns) to the dataframe before displaying it in these 3 widgets.\nFor example, window info needs to be formatted for facets-dive and datatable while getting dropped in facets-overview.\nIf they share the same instance, the 3 widgets will be altering the same dataframe object in arbitrary order, get arbitrary mixed output or run into all kinds of mapping errors.", "author": "KevinGG", "createdAt": "2020-03-03T20:33:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzI1NDY2OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzI1NTcxNw==", "url": "https://github.com/apache/beam/pull/11020#discussion_r387255717", "bodyText": "What is happening in here in the next few lines?", "author": "aaltay", "createdAt": "2020-03-03T19:51:19Z", "path": "sdks/python/apache_beam/runners/interactive/display/pcoll_visualization.py", "diffHunk": "@@ -238,31 +322,57 @@ def _display_dive(self, data, update=None):\n       display(HTML(html))\n \n   def _display_overview(self, data, update=None):\n+    if (not data.empty and self._include_window_info and\n+        all(column in data.columns\n+            for column in ('event_time', 'windows', 'pane_info'))):\n+      data = data.drop(['event_time', 'windows', 'pane_info'], axis=1)\n+\n     gfsg = GenericFeatureStatisticsGenerator()\n     proto = gfsg.ProtoFromDataFrames([{'name': 'data', 'table': data}])\n     protostr = base64.b64encode(proto.SerializeToString()).decode('utf-8')\n     if update:\n       script = _OVERVIEW_SCRIPT_TEMPLATE.format(\n-          display_id=update, protostr=protostr)\n+          display_id=update._overview_display_id, protostr=protostr)\n       display_javascript(Javascript(script))\n     else:\n       html = _OVERVIEW_HTML_TEMPLATE.format(\n           display_id=self._overview_display_id, protostr=protostr)\n       display(HTML(html))\n \n   def _display_dataframe(self, data, update=None):\n-    if update:\n-      table_id = 'table_{}'.format(update)\n-      html = _DATAFRAME_PAGINATION_TEMPLATE.format(\n-          dataframe_html=data.to_html(notebook=True, table_id=table_id),\n-          table_id=table_id)\n-      update_display(HTML(html), display_id=update)\n+    table_id = 'table_{}'.format(\n+        update._df_display_id if update else self._df_display_id)\n+    columns = [{\n+        'title': ''\n+    }] + [{\n+        'title': str(column)\n+    } for column in data.columns]\n+    format_window_info_in_dataframe(data)\n+    rows = data.applymap(lambda x: str(x)).to_dict('split')['data']", "originalCommit": "4c0d28f273f23031abc968f7ca3472440b0d325f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzI4MTk5OA==", "url": "https://github.com/apache/beam/pull/11020#discussion_r387281998", "bodyText": "First, we get all the string data from the split orient of dataframe.to_dict.\nNow the rows is a list of rows of values.\nEach row looks like [column_1_val, column_2_val, ...]\nThen we are going to add datatable column index for the values in each row.\nThe index starts from 1 because we are also going to add a column 0 later., so we have {k+1: v}.\nEach row now becomes {1: column_1_val, 2: column_2_val, ...}\nThen we add column 0 (row[0] = k) of the datatable with values of int based index (which will be the default order column just as the original dataframe).\nEach row now becomes {1: column_1_val, 2: column_2_val, ..., 0: int_index_in_dataframe}\nThen the list of above rows get supplied as string in the Javascript to load the data into the table.", "author": "KevinGG", "createdAt": "2020-03-03T20:43:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzI1NTcxNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzM1OTU4NQ==", "url": "https://github.com/apache/beam/pull/11020#discussion_r387359585", "bodyText": "Could you explain that in a comment there?", "author": "aaltay", "createdAt": "2020-03-03T23:37:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzI1NTcxNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzQxOTU3Mg==", "url": "https://github.com/apache/beam/pull/11020#discussion_r387419572", "bodyText": "Added the comments.", "author": "KevinGG", "createdAt": "2020-03-04T02:42:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzI1NTcxNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzI1NjYwNA==", "url": "https://github.com/apache/beam/pull/11020#discussion_r387256604", "bodyText": "is it possible to use strftime?\nhttps://docs.python.org/3/library/datetime.html#strftime-and-strptime-format-codes", "author": "aaltay", "createdAt": "2020-03-03T19:53:03Z", "path": "sdks/python/apache_beam/runners/interactive/display/pcoll_visualization.py", "diffHunk": "@@ -291,3 +402,81 @@ def _to_dataframe(self):\n \n   def _is_one_dimension_type(self, val):\n     return type(val) in _one_dimension_types\n+\n+\n+def format_window_info_in_dataframe(data):\n+  if 'event_time' in data.columns:\n+    data['event_time'] = data['event_time'].apply(event_time_formatter)\n+  if 'windows' in data.columns:\n+    data['windows'] = data['windows'].apply(windows_formatter)\n+  if 'pane_info' in data.columns:\n+    data['pane_info'] = data['pane_info'].apply(pane_info_formatter)\n+\n+\n+def event_time_formatter(event_time_us):\n+  options = ie.current_env().options\n+  to_tz = options.display_timezone\n+  try:\n+    return (\n+        datetime.datetime.utcfromtimestamp(event_time_us / 1000000).replace(\n+            tzinfo=tz.tzutc()).astimezone(to_tz).strftime(\n+                options.display_timestamp_format))\n+  except ValueError:\n+    if event_time_us < 0:\n+      return 'Min Timestamp'\n+    return 'Max Timestamp'\n+\n+\n+def windows_formatter(windows):\n+  result = []\n+  for w in windows:\n+    if isinstance(w, GlobalWindow):\n+      result.append(str(w))\n+    elif isinstance(w, IntervalWindow):\n+      # First get the duration in terms of hours, minutes, seconds, and\n+      # micros.\n+      duration = w.end.micros - w.start.micros\n+      duration_secs = duration // 1000000\n+      hours, remainder = divmod(duration_secs, 3600)\n+      minutes, seconds = divmod(remainder, 60)\n+      micros = (duration - duration_secs * 1000000) % 1000000\n+\n+      # Construct the duration string. Try and write the string in such a", "originalCommit": "4c0d28f273f23031abc968f7ca3472440b0d325f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzMyMDc1MQ==", "url": "https://github.com/apache/beam/pull/11020#discussion_r387320751", "bodyText": "This is trying to format a duration potentially with precision at micros, not exactly a datetime.  It's more like pretty print a timedelta. So the strftime function is not applicable.", "author": "KevinGG", "createdAt": "2020-03-03T22:02:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzI1NjYwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzM1OTczMw==", "url": "https://github.com/apache/beam/pull/11020#discussion_r387359733", "bodyText": "Is there any other standard function that will do this?", "author": "aaltay", "createdAt": "2020-03-03T23:37:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzI1NjYwNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzI1Nzc4Mw==", "url": "https://github.com/apache/beam/pull/11020#discussion_r387257783", "bodyText": "Where is the default defined?\nIf defined somewhere else, let's not repeat these in comments. It will require sync both places going forward.", "author": "aaltay", "createdAt": "2020-03-03T19:55:19Z", "path": "sdks/python/apache_beam/runners/interactive/interactive_beam.py", "diffHunk": "@@ -86,10 +85,57 @@ def capture_duration(self, value):\n       # The next PCollection evaluation will capture fresh data from sources,\n       # and the data captured will be replayed until another eviction.\n     \"\"\"\n+    assert value.total_seconds() > 0, 'Duration must be a positive value.'\n     self.capture_control._capture_duration = value\n \n   # TODO(BEAM-8335): add capture_size options when they are supported.\n \n+  @property\n+  def display_timestamp_format(self):\n+    \"\"\"The format in which timestamps are displayed.\n+\n+    Default is '%Y-%m-%d %H:%M:%S.%f%z', e.g. 2020-02-01 15:05:06.000015-08:00.", "originalCommit": "4c0d28f273f23031abc968f7ca3472440b0d325f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzI4NTEzMQ==", "url": "https://github.com/apache/beam/pull/11020#discussion_r387285131", "bodyText": "docstrings in this module are for notebook users. So keeping them here allows Shift+Tab in notebooks to invoke the docstrings pop up. They function as in-notebook user guide.\nThe default is defined in the interactive_options module where we hide the implementation details that are not exposed APIs.", "author": "KevinGG", "createdAt": "2020-03-03T20:49:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzI1Nzc4Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzM1OTk0MA==", "url": "https://github.com/apache/beam/pull/11020#discussion_r387359940", "bodyText": "How do we plan to keep the defaults in sync between here and interactive_options?", "author": "aaltay", "createdAt": "2020-03-03T23:38:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzI1Nzc4Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzI1ODUzNg==", "url": "https://github.com/apache/beam/pull/11020#discussion_r387258536", "bodyText": "import at top?", "author": "aaltay", "createdAt": "2020-03-03T19:56:40Z", "path": "sdks/python/apache_beam/runners/interactive/interactive_beam.py", "diffHunk": "@@ -211,20 +280,27 @@ def show(*pcolls):\n         watched_pcollections.add(val)\n   for pcoll in pcolls:\n     if pcoll not in watched_pcollections:\n-      watch({re.sub(r'[\\[\\]\\(\\)]', '_', str(pcoll)): pcoll})\n+      watch({'anonymous_pcollection_{}'.format(id(pcoll)): pcoll})\n \n+  import warnings", "originalCommit": "4c0d28f273f23031abc968f7ca3472440b0d325f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzMzNDQwMg==", "url": "https://github.com/apache/beam/pull/11020#discussion_r387334402", "bodyText": "Done.", "author": "KevinGG", "createdAt": "2020-03-03T22:31:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzI1ODUzNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzI1ODkwMw==", "url": "https://github.com/apache/beam/pull/11020#discussion_r387258903", "bodyText": "This will filter out all deprecation warnings. Not a good outcome, if we would like user to see deprecation warnings.", "author": "aaltay", "createdAt": "2020-03-03T19:57:16Z", "path": "sdks/python/apache_beam/runners/interactive/interactive_beam.py", "diffHunk": "@@ -211,20 +280,27 @@ def show(*pcolls):\n         watched_pcollections.add(val)\n   for pcoll in pcolls:\n     if pcoll not in watched_pcollections:\n-      watch({re.sub(r'[\\[\\]\\(\\)]', '_', str(pcoll)): pcoll})\n+      watch({'anonymous_pcollection_{}'.format(id(pcoll)): pcoll})\n \n+  import warnings\n+  warnings.filterwarnings('ignore', category=DeprecationWarning)", "originalCommit": "4c0d28f273f23031abc968f7ca3472440b0d325f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzM0MjU1MQ==", "url": "https://github.com/apache/beam/pull/11020#discussion_r387342551", "bodyText": "Change the filtering to catch a specific message and only takes effect when is_in_ipython when the user invokes show for the first time.", "author": "KevinGG", "createdAt": "2020-03-03T22:50:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzI1ODkwMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzI1OTMwMw==", "url": "https://github.com/apache/beam/pull/11020#discussion_r387259303", "bodyText": "what is jquery341 ?", "author": "aaltay", "createdAt": "2020-03-03T19:58:03Z", "path": "sdks/python/apache_beam/runners/interactive/interactive_environment.py", "diffHunk": "@@ -43,6 +43,55 @@\n \n _LOGGER = logging.getLogger(__name__)\n \n+# By `format(customized_script=xxx)`, the given `customized_script` is\n+# guaranteed to be executed within access to a jquery with datatable plugin\n+# configured which is useful so that any `customized_script` is resilient to\n+# browser refresh. Inside `customized_script`, use `$` as jQuery.\n+_JQUERY_WITH_DATATABLE_TEMPLATE = \"\"\"\n+        if (typeof window.jquery341 == 'undefined') {{", "originalCommit": "4c0d28f273f23031abc968f7ca3472440b0d325f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzI5MjE3Nw==", "url": "https://github.com/apache/beam/pull/11020#discussion_r387292177", "bodyText": "It's an arbitrary name we give to the jQuery v3.4.1 we imported. It's like a namesapce. Note the magic happens in window.jquery341 = jQuery.noConflict(true);.\nThe problem here is that:\n\nA frontend can connect to the kernel at any time: code executed by kernel in the past does not have any effect to new frontends.\nMultiple frontends can connect to the same kernel: each frontend has its own state (browser: HTML and JS), the rendered HTML+JS cannot assume the existence of any global variable, function definition or libraries.\n\nThis ensures no matter how many jQuery gets imported at any time, the interactive notebook always checks and uses the single jQuery configured by interactive modules with Datatable plugin initialized.\nAnd the function($) signature ensures that any customized script executed will use $ as the singleton instance  window.jquery341. This ensures that code reading $ as jQuery will always work.\nThe advantage of doing this isolation is:\n\nThe JS imported by interactive modules to any frontend does not alter their existing states. Everything in the notebook still works as it was no matter what libraries and global vars have been used.\nHTML with JS rendered by interactive modules will have determined behavior because it always uses the same libraries.\nWhether/when a frontend is connected to the kernel doesn't matter now. The visualization HTML contains everything it needs to setup and/or execute scripts.\nArbitrary DOM changes doesn't matter now. Even if the user screws the notebook's HTML, the data visualization broadcast from kernels will always be rendered correctly.", "author": "KevinGG", "createdAt": "2020-03-03T21:03:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzI1OTMwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzM2MDQ5Mg==", "url": "https://github.com/apache/beam/pull/11020#discussion_r387360492", "bodyText": "jquery341 is probably not a good name. What would happen if we upgrade to a different jquery version? Maybe it would be better to call it jquery_singleton or something like that?", "author": "aaltay", "createdAt": "2020-03-03T23:40:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzI1OTMwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzQyMDcxOQ==", "url": "https://github.com/apache/beam/pull/11020#discussion_r387420719", "bodyText": "I've changed it to interactive_beam_jquery.", "author": "KevinGG", "createdAt": "2020-03-04T02:47:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzI1OTMwMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzI1OTc1Mg==", "url": "https://github.com/apache/beam/pull/11020#discussion_r387259752", "bodyText": "what does this do?", "author": "aaltay", "createdAt": "2020-03-03T19:58:50Z", "path": "sdks/python/apache_beam/runners/interactive/interactive_environment.py", "diffHunk": "@@ -43,6 +43,55 @@\n \n _LOGGER = logging.getLogger(__name__)\n \n+# By `format(customized_script=xxx)`, the given `customized_script` is\n+# guaranteed to be executed within access to a jquery with datatable plugin\n+# configured which is useful so that any `customized_script` is resilient to\n+# browser refresh. Inside `customized_script`, use `$` as jQuery.\n+_JQUERY_WITH_DATATABLE_TEMPLATE = \"\"\"\n+        if (typeof window.jquery341 == 'undefined') {{\n+          var jqueryScript = document.createElement('script');\n+          jqueryScript.src = 'https://code.jquery.com/jquery-3.4.1.slim.min.js';\n+          jqueryScript.type = 'text/javascript';\n+          jqueryScript.onload = function() {{\n+            var datatableScript = document.createElement('script');\n+            datatableScript.src = 'https://cdn.datatables.net/1.10.20/js/jquery.dataTables.min.js';\n+            datatableScript.type = 'text/javascript';\n+            datatableScript.onload = function() {{\n+              window.jquery341 = jQuery.noConflict(true);\n+              window.jquery341(document).ready(function($){{\n+                {customized_script}\n+              }});\n+            }}\n+            document.head.appendChild(datatableScript);\n+          }};\n+          document.head.appendChild(jqueryScript);\n+        }} else {{\n+          window.jquery341(document).ready(function($){{\n+            {customized_script}\n+          }});\n+        }}\"\"\"\n+\n+_HTML_IMPORT_TEMPLATE = \"\"\"", "originalCommit": "4c0d28f273f23031abc968f7ca3472440b0d325f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzMxNTU4OQ==", "url": "https://github.com/apache/beam/pull/11020#discussion_r387315589", "bodyText": "This uses something called HTML import where static HTML will be imported and embedded into current HTML.\nHere the HTML we desire is facets-jupyter.html.\nThis feature is not supported by chrome anymore, thus requires the webcomponents JS lib.\nSimilar to the jQuery template, we check if HTML import is supported by the browser, if so, import HTMLs else setup webcomponents and chain the HTML import to the end of onload.\nNote, we import HTMLs in the head for several reasons:\n\nIn a notebook, DOM changes all the time. Keeping imported HTMLs in head makes sure all dependency HTMLs available all the time.\nHTML import only happens once per page load. There is no way to recover an imported HTML if you delete it from DOM unless you refresh the page.", "author": "KevinGG", "createdAt": "2020-03-03T21:51:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzI1OTc1Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzM2MDcwNA==", "url": "https://github.com/apache/beam/pull/11020#discussion_r387360704", "bodyText": "could you add comments related to this?\nWhy is it no longer supported by chrome?", "author": "aaltay", "createdAt": "2020-03-03T23:40:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzI1OTc1Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzQyMjkxNw==", "url": "https://github.com/apache/beam/pull/11020#discussion_r387422917", "bodyText": "Added comments.\nhttps://developer.mozilla.org/en-US/docs/Web/Web_Components/HTML_Imports explains it.", "author": "KevinGG", "createdAt": "2020-03-04T02:52:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzI1OTc1Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzgzMTUyOQ==", "url": "https://github.com/apache/beam/pull/11020#discussion_r387831529", "bodyText": "Strange. So we rely on a polyfill. Seems fine for now.", "author": "aaltay", "createdAt": "2020-03-04T17:49:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzI1OTc1Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzI2MDM4MA==", "url": "https://github.com/apache/beam/pull/11020#discussion_r387260380", "bodyText": "Are we using timezone from pytz or tz from dateutil?", "author": "aaltay", "createdAt": "2020-03-03T20:00:00Z", "path": "sdks/python/apache_beam/runners/interactive/options/interactive_options.py", "diffHunk": "@@ -24,6 +24,8 @@\n \n from __future__ import absolute_import\n \n+from dateutil import tz", "originalCommit": "4c0d28f273f23031abc968f7ca3472440b0d325f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzMzMDcxNA==", "url": "https://github.com/apache/beam/pull/11020#discussion_r387330714", "bodyText": "The user can use both. Here internally we use dateutil.tz get the local timezone info.\nExternally, the user can use pytz.timezone or dateutil.tz.gettz because the to_tz just needs to be a subclass of datetime.tzinfo.\nAdded the comments in the exposed API.", "author": "KevinGG", "createdAt": "2020-03-03T22:22:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzI2MDM4MA=="}], "type": "inlineReview"}, {"oid": "00fefef9f4e988225a38bd6b78797bec8c8c74a6", "url": "https://github.com/apache/beam/commit/00fefef9f4e988225a38bd6b78797bec8c8c74a6", "message": "[BEAM-7926] Update Data Visualization\n\n1. Added include_window_info and visualize_data as **kwargs passed into\n   `show`.\n2. Updated javascripts to make the data visualization smooth and\n   resilient to DOM changes. Now datatable is loaded dynamically without\n   flickering nor changing of user's page/search state; javascripts also\n   work when refreshing the browser.\n3. Resolved the jQuery+Datatable loading issue by forcing chained\n   loading. Any customized javascripts relying on jQuery should only use\n   `window.jquery341`. Always carry out a check for `window.jquery341`.\n   Run javascripts in the last onload of the jQuery loading chain if\n   `window.jquery341` is not available.\n4. All HTML imports are chained at onload of webcomponents (if HTML import\n   is not supported) or plainly imported (if HTML import supported) in a\n   single place in document.head. This makes HTML import resilient to\n   DOM changes caused by normal notebook usages.\n5. Updated some logging statements.\n6. Added `show_graph` API to render DAG of a pipeline. `pipeline.run`\n   does not render DAG now.\n\nChange-Id: Id2ca548860fb2d30e1557a35e7b14d2e61b5f1a4", "committedDate": "2020-03-06T19:32:49Z", "type": "commit"}, {"oid": "4edaf72f94554f97e88b5c52f52b6a98aee12687", "url": "https://github.com/apache/beam/commit/4edaf72f94554f97e88b5c52f52b6a98aee12687", "message": "Fix based on comments\n\nChange-Id: I04c744d880b57bb3f577cda15700050444b93c06", "committedDate": "2020-03-06T19:32:55Z", "type": "commit"}, {"oid": "0516fe05b558e4f552f18fbc0ca1e258be86c8e8", "url": "https://github.com/apache/beam/commit/0516fe05b558e4f552f18fbc0ca1e258be86c8e8", "message": "Added comments and renamed jquery instance\n\nChange-Id: Iec0c6bb4990e373bcef3fe9f4670249b24f604cb", "committedDate": "2020-03-06T19:32:55Z", "type": "commit"}, {"oid": "44cc0208897bdc9f2ec2d287d5eac77a2a919cf5", "url": "https://github.com/apache/beam/commit/44cc0208897bdc9f2ec2d287d5eac77a2a919cf5", "message": "Removed JS console logging and added some minor fixes.\n\nChange-Id: I55ffd3c992c2627c12ada0de2e13b4cad32a7241", "committedDate": "2020-03-06T19:32:55Z", "type": "commit"}, {"oid": "f9b2ae9fa2dd59391dbe499e3644b02f58b6bf8e", "url": "https://github.com/apache/beam/commit/f9b2ae9fa2dd59391dbe499e3644b02f58b6bf8e", "message": "fix lint and tests\n\nChange-Id: Ib381a7081ae1100011d63715e1fefd4d9419bf3d", "committedDate": "2020-03-06T19:32:55Z", "type": "commit"}, {"oid": "a1f967eed16982ba7e339d87ed0b6b4b30d9c0a5", "url": "https://github.com/apache/beam/commit/a1f967eed16982ba7e339d87ed0b6b4b30d9c0a5", "message": "fix isort import orderings\n\nChange-Id: I7d04645aa65b6f79368c54c1e62c8c806b68e7a0", "committedDate": "2020-03-06T19:32:56Z", "type": "commit"}, {"oid": "a1f967eed16982ba7e339d87ed0b6b4b30d9c0a5", "url": "https://github.com/apache/beam/commit/a1f967eed16982ba7e339d87ed0b6b4b30d9c0a5", "message": "fix isort import orderings\n\nChange-Id: I7d04645aa65b6f79368c54c1e62c8c806b68e7a0", "committedDate": "2020-03-06T19:32:56Z", "type": "forcePushed"}]}