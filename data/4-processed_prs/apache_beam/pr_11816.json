{"pr_number": 11816, "pr_title": "[BEAM-5863] Jenkins job to deploy Beam Metrics infrastructure automatically upon code changes", "pr_createdAt": "2020-05-26T13:29:54Z", "pr_url": "https://github.com/apache/beam/pull/11816", "timeline": [{"oid": "5e2607c2302c57e0cae98b363e42468621ef42f0", "url": "https://github.com/apache/beam/commit/5e2607c2302c57e0cae98b363e42468621ef42f0", "message": "[BEAM-5863] Jenkins job to deploy Beam Metrics infrastructure automatically upon code changes", "committedDate": "2020-05-26T13:25:53Z", "type": "forcePushed"}, {"oid": "801a89ae962948a9353ff88edaf28cd4ca9aa64c", "url": "https://github.com/apache/beam/commit/801a89ae962948a9353ff88edaf28cd4ca9aa64c", "message": "[BEAM-5863] Jenkins job to deploy Beam Metrics infrastructure automatically upon code changes", "committedDate": "2020-05-26T13:38:03Z", "type": "forcePushed"}, {"oid": "cfd4d75e72586760e6926ea525f1e9e3d4035912", "url": "https://github.com/apache/beam/commit/cfd4d75e72586760e6926ea525f1e9e3d4035912", "message": "[BEAM-5863] Jenkins job to deploy Beam Metrics infrastructure automatically upon code changes", "committedDate": "2020-05-26T13:40:04Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDQ0NDE4Mw==", "url": "https://github.com/apache/beam/pull/11816#discussion_r430444183", "bodyText": "This code is unused, I decided it's a good occasion to remove it", "author": "kamilwu", "createdAt": "2020-05-26T14:12:58Z", "path": ".test-infra/jenkins/CommonJobProperties.groovy", "diffHunk": "@@ -268,23 +268,6 @@ class CommonJobProperties {\n     return mapToArgString(joinedArgs)\n   }\n \n-  static def setupKubernetes(def context, def namespace, def kubeconfigLocation) {", "originalCommit": "cfd4d75e72586760e6926ea525f1e9e3d4035912", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDYzMDQ5Mw==", "url": "https://github.com/apache/beam/pull/11816#discussion_r430630493", "bodyText": "will latest overwrite container image version? If not, we should add cleanup script for old versions.", "author": "Ardagan", "createdAt": "2020-05-26T18:45:57Z", "path": ".test-infra/metrics/build_and_publish_containers.sh", "diffHunk": "@@ -36,8 +33,8 @@ fi\n \n echo\n echo ===========Start==========\n-CONTAINER_VERSION_NAME=$1\n-DO_PUSH=$2\n+DO_PUSH=$1\n+CONTAINER_VERSION_NAME=${2:-latest}", "originalCommit": "cfd4d75e72586760e6926ea525f1e9e3d4035912", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTc4MzAwMw==", "url": "https://github.com/apache/beam/pull/11816#discussion_r431783003", "bodyText": "It won't.\nWe have a script that removes all images older than 24 hours from Jenkins workers: \n  \n    \n      beam/.test-infra/jenkins/job_Inventory.groovy\n    \n    \n         Line 69\n      in\n      a13ef24\n    \n    \n    \n    \n\n        \n          \n           shell('docker system prune --all --filter until=24h --force') \n        \n    \n  \n\n\nBut, as far as I know, we don't have a similar cleanup task for images that were pushed to Container Registry (gcr)", "author": "kamilwu", "createdAt": "2020-05-28T12:01:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDYzMDQ5Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTgxODMxNw==", "url": "https://github.com/apache/beam/pull/11816#discussion_r431818317", "bodyText": "One possible solution would be to create a cron job that would remove untagged images on Container Registry (very similar to this one: https://github.com/apache/beam/blob/master/.test-infra/jenkins/job_CancelStaleDataflowJobs.groovy). WDYT?", "author": "kamilwu", "createdAt": "2020-05-28T13:04:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDYzMDQ5Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTgxODg0NA==", "url": "https://github.com/apache/beam/pull/11816#discussion_r431818844", "bodyText": "Could be done in a separate PR.", "author": "kamilwu", "createdAt": "2020-05-28T13:05:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDYzMDQ5Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzY5Mjk0MA==", "url": "https://github.com/apache/beam/pull/11816#discussion_r433692940", "bodyText": "@Ardagan", "author": "kamilwu", "createdAt": "2020-06-02T08:03:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDYzMDQ5Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDA2MjAxMQ==", "url": "https://github.com/apache/beam/pull/11816#discussion_r434062011", "bodyText": "Since we already have a script, it should be fine.", "author": "Ardagan", "createdAt": "2020-06-02T17:49:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDYzMDQ5Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDYzMTE4NQ==", "url": "https://github.com/apache/beam/pull/11816#discussion_r430631185", "bodyText": "Is there a reason to detect timee vs automatic job trigger by commit to master with relevant folder?", "author": "Ardagan", "createdAt": "2020-05-26T18:47:12Z", "path": ".test-infra/metrics/build.gradle", "diffHunk": "@@ -50,9 +51,49 @@ dockerCompose {\n \n dockerCompose.isRequiredBy(testMetricsStack)\n \n-task preCommit { dependsOn testMetricsStack }\n+task validateConfiguration(type: Exec) {\n+  commandLine 'sh', '-c', 'kubectl apply --dry-run=true -Rf kubernetes'\n+}\n+\n+task preCommit {\n+  dependsOn validateConfiguration\n+  dependsOn testMetricsStack\n+}\n+\n+task buildAndPublishContainers(type: Exec) {\n+  commandLine './build_and_publish_containers.sh', 'true'\n+}\n+\n+// Applies new configuration to all resources labeled with `app=beammetrics`\n+// and forces Kubernetes to re-pull images.\n+task applyConfiguration() {\n+  doLast {\n+    assert grgit : 'Cannot use outside of git repository'\n+\n+    def git = grgit.open()\n+    def commitedChanges = git.log(paths: ['.test-infra/metrics']).findAll {\n+      it.dateTime > ZonedDateTime.now().minusHours(6)", "originalCommit": "cfd4d75e72586760e6926ea525f1e9e3d4035912", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTIxOTg4OA==", "url": "https://github.com/apache/beam/pull/11816#discussion_r431219888", "bodyText": "To be honest, I don't know if this is possible. We're using ghprb plugin to integrate Github with Jenkins, and comments from this issue (jenkinsci/ghprb-plugin#651) claim this feature (triggering on merging to master) is outside the scope of the plugin. That's why I decided to create a cron job (Website_Publish is based on a cron job too).\nDo you want me to continue searching for a trigger-on-merge solution?", "author": "kamilwu", "createdAt": "2020-05-27T15:14:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDYzMTE4NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTI2Nzg5Mw==", "url": "https://github.com/apache/beam/pull/11816#discussion_r431267893", "bodyText": "Postcommit job builder already triggers on commit but it also triggers periodically. It actually makes sense to attempt deployment periodically in case trigger fails. Lets keep it as is.", "author": "Ardagan", "createdAt": "2020-05-27T16:13:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDYzMTE4NQ=="}], "type": "inlineReview"}, {"oid": "2ecfe45f3919ab8238d94c30f2d4cffba476000b", "url": "https://github.com/apache/beam/commit/2ecfe45f3919ab8238d94c30f2d4cffba476000b", "message": "[BEAM-5863] Gradle tasks for deploying Beam Metrics infrastructure", "committedDate": "2020-06-03T09:03:31Z", "type": "commit"}, {"oid": "fac08ea41a303c3b379efd8fda198e302aa87bed", "url": "https://github.com/apache/beam/commit/fac08ea41a303c3b379efd8fda198e302aa87bed", "message": "[BEAM-5863] New dockerfiles that produce smaller output images", "committedDate": "2020-06-03T09:03:31Z", "type": "commit"}, {"oid": "0e324d2f7a8a521ca4e9d114c818a00e21920627", "url": "https://github.com/apache/beam/commit/0e324d2f7a8a521ca4e9d114c818a00e21920627", "message": "[BEAM-5863] Jenkins job to deploy Beam Metrics infrastructure automatically upon code changes", "committedDate": "2020-06-03T09:05:28Z", "type": "commit"}, {"oid": "0e324d2f7a8a521ca4e9d114c818a00e21920627", "url": "https://github.com/apache/beam/commit/0e324d2f7a8a521ca4e9d114c818a00e21920627", "message": "[BEAM-5863] Jenkins job to deploy Beam Metrics infrastructure automatically upon code changes", "committedDate": "2020-06-03T09:05:28Z", "type": "forcePushed"}]}