{"pr_number": 12009, "pr_title": "[BEAM-10258] Support type hint annotations on PTransform's expand()", "pr_createdAt": "2020-06-15T04:50:43Z", "pr_url": "https://github.com/apache/beam/pull/12009", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTAwNTY0MQ==", "url": "https://github.com/apache/beam/pull/12009#discussion_r441005641", "bodyText": "Please stay consistent with existing code: one import per line.", "author": "udim", "createdAt": "2020-06-16T17:01:34Z", "path": "sdks/python/apache_beam/transforms/ptransform.py", "diffHunk": "@@ -72,7 +72,7 @@ class and wrapper class that allows lambda functions to be used as\n from apache_beam.transforms.display import HasDisplayData\n from apache_beam.typehints import native_type_compatibility\n from apache_beam.typehints import typehints\n-from apache_beam.typehints.decorators import TypeCheckError\n+from apache_beam.typehints.decorators import TypeCheckError, IOTypeHints, get_type_hints", "originalCommit": "80461081778450e887db6ea97a127f1db34c751e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTAwOTAyMQ==", "url": "https://github.com/apache/beam/pull/12009#discussion_r441009021", "bodyText": "I would really prefer it if all type constraint classes were in the same module (typehints).", "author": "udim", "createdAt": "2020-06-16T17:07:25Z", "path": "sdks/python/apache_beam/pvalue.py", "diffHunk": "@@ -158,6 +159,20 @@ def __ne__(self, other):\n   def __hash__(self):\n     return hash((self.tag, self.producer))\n \n+  class PCollectionTypeConstraint(SequenceTypeConstraint):", "originalCommit": "80461081778450e887db6ea97a127f1db34c751e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTg1MTUxNQ==", "url": "https://github.com/apache/beam/pull/12009#discussion_r441851515", "bodyText": "Moved it back to the typehints module\nBoth files import from each other causing a circular import error so the current (hacky) workaround is to put the import inside of PCollectionTypeConstraint's class_getitem function, which works. There are no performance drawbacks to this approach but it's not consistent with the existing styling so I will look for a better solution.", "author": "saavannanavati", "createdAt": "2020-06-17T21:44:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTAwOTAyMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDU0MTIxOQ==", "url": "https://github.com/apache/beam/pull/12009#discussion_r444541219", "bodyText": "This PR uses the built-in Generic[T] instead of a new TypeConstraint so this is no longer relevant.", "author": "saavannanavati", "createdAt": "2020-06-23T22:22:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTAwOTAyMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTAxMzgxOQ==", "url": "https://github.com/apache/beam/pull/12009#discussion_r441013819", "bodyText": "This should stay Generic[T], as it provides the same [] functionality but is understood by tools like mypy and is familiar to Python users.", "author": "udim", "createdAt": "2020-06-16T17:15:50Z", "path": "sdks/python/apache_beam/pvalue.py", "diffHunk": "@@ -141,7 +142,7 @@ def __or__(self, ptransform):\n     return self.pipeline.apply(ptransform, self)\n \n \n-class PCollection(PValue, Generic[T]):\n+class PCollection(PValue, CompositeTypeHint):", "originalCommit": "80461081778450e887db6ea97a127f1db34c751e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTg0Nzk2Nw==", "url": "https://github.com/apache/beam/pull/12009#discussion_r441847967", "bodyText": "Switched it back", "author": "saavannanavati", "createdAt": "2020-06-17T21:35:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTAxMzgxOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTAxNTAzOQ==", "url": "https://github.com/apache/beam/pull/12009#discussion_r441015039", "bodyText": "Are these whitespace changes coming from yapf? This particularly seems to have moved the comment to the line above it.", "author": "udim", "createdAt": "2020-06-16T17:17:53Z", "path": "sdks/python/apache_beam/pvalue.py", "diffHunk": "@@ -425,8 +441,7 @@ def _from_runtime_iterable(it, options):\n \n   def _view_options(self):\n     return {\n-        'data': self._data,\n-        # For non-fn-api runners.\n+        'data': self._data,  # For non-fn-api runners.", "originalCommit": "80461081778450e887db6ea97a127f1db34c751e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTg1Mjc4Mw==", "url": "https://github.com/apache/beam/pull/12009#discussion_r441852783", "bodyText": "Yeah, yapf did that. I'm not sure why. When I run \"yapf -ir .\" from the root python directory, a lot of files are re-formatted. Is this unexpected behavior? If it's not, I can create an PR with just yapf changes to the entire apache_beam module. Thoughts?", "author": "saavannanavati", "createdAt": "2020-06-17T21:47:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTAxNTAzOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzA2OTU3Ng==", "url": "https://github.com/apache/beam/pull/12009#discussion_r443069576", "bodyText": "That is unexpected, yes.\nTry running tox -e py3-yapf. Perhaps the yapf you have installed is a newer version than tox's (0.29.0).", "author": "udim", "createdAt": "2020-06-19T22:47:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTAxNTAzOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDU0MTY5MQ==", "url": "https://github.com/apache/beam/pull/12009#discussion_r444541691", "bodyText": "Some of the YAPF changes are fixed but a few whitespace changes remain that I'll look into soon.", "author": "saavannanavati", "createdAt": "2020-06-23T22:23:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTAxNTAzOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzA3MzAwMA==", "url": "https://github.com/apache/beam/pull/12009#discussion_r443073000", "bodyText": "I believe this method is unnecessary, since Generic[T] implements something similar. You can can inspect a PCollection to get its arguments.\nFor example:\n>>> import typing\n>>> T = typing.TypeVar('T')\n>>> class A(typing.Generic[T]):\n...   pass\n... \n>>> A[int].__args__\n(<class 'int'>,)", "author": "udim", "createdAt": "2020-06-19T23:04:14Z", "path": "sdks/python/apache_beam/pvalue.py", "diffHunk": "@@ -158,6 +158,10 @@ def __ne__(self, other):\n   def __hash__(self):\n     return hash((self.tag, self.producer))\n \n+  def __class_getitem__(cls, type_param):", "originalCommit": "b890ed5a625cfc6c777ee4ef8daef6e1bc05f04e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzgwODIwMA==", "url": "https://github.com/apache/beam/pull/12009#discussion_r443808200", "bodyText": "Thanks, fixed.", "author": "saavannanavati", "createdAt": "2020-06-22T20:30:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzA3MzAwMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTI0NjI1MA==", "url": "https://github.com/apache/beam/pull/12009#discussion_r445246250", "bodyText": "Did you mean to leave this test here? It looks like a copy of the one in AnnotationsTest.", "author": "udim", "createdAt": "2020-06-25T00:40:34Z", "path": "sdks/python/apache_beam/typehints/typed_pipeline_test_py3.py", "diffHunk": "@@ -40,6 +40,14 @@ def process(self, element: int) -> typehints.Tuple[str]:\n     with self.assertRaisesRegex(typehints.TypeCheckError,\n                                 r'requires.*int.*got.*str'):\n       _ = ['a', 'b', 'c'] | beam.ParDo(MyDoFn())\n+  def test_pardo_dofn(self):", "originalCommit": "dd1e38e353d3bf4f7c924be47734d331671e72f1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTI2ODY1Mg==", "url": "https://github.com/apache/beam/pull/12009#discussion_r445268652", "bodyText": "Or perhaps this was also a git merge result", "author": "udim", "createdAt": "2020-06-25T02:09:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTI0NjI1MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTg2NjE1MA==", "url": "https://github.com/apache/beam/pull/12009#discussion_r445866150", "bodyText": "That was an accident, thanks", "author": "saavannanavati", "createdAt": "2020-06-25T22:09:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTI0NjI1MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTI0NzUxMQ==", "url": "https://github.com/apache/beam/pull/12009#discussion_r445247511", "bodyText": "There is no need to assert that no exceptions are raised. The test will already fail if exceptions are raised.\nIf I need to be explicit I usually put a comment above the line that shouldn't fail.", "author": "udim", "createdAt": "2020-06-25T00:45:26Z", "path": "sdks/python/apache_beam/typehints/typed_pipeline_test_py3.py", "diffHunk": "@@ -257,6 +265,65 @@ def fn2(element: int) -> int:\n     result = [1, 2, 3] | beam.FlatMap(fn) | beam.Map(fn2)\n     self.assertCountEqual([4, 6], result)\n \n+  def test_typed_ptransform_with_no_error(self):\n+    class StrToInt(beam.PTransform):\n+      def expand(self, pcoll: beam.pvalue.PCollection[str]) -> beam.pvalue.PCollection[int]:\n+        return pcoll | beam.Map(lambda x: int(x))\n+\n+    class IntToStr(beam.PTransform):\n+      def expand(self, pcoll: beam.pvalue.PCollection[int]) -> beam.pvalue.PCollection[str]:\n+        return pcoll | beam.Map(lambda x: str(x))\n+\n+    try:\n+      _ = ['1', '2', '3'] | StrToInt() | IntToStr()\n+    except Exception:\n+      self.fail('An unexpected error was raised during a pipeline with correct typehints.')", "originalCommit": "dd1e38e353d3bf4f7c924be47734d331671e72f1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTI0ODUxNA==", "url": "https://github.com/apache/beam/pull/12009#discussion_r445248514", "bodyText": "Please use with self.assertRaisesRegex(..) above instead of separately checking the exception text.", "author": "udim", "createdAt": "2020-06-25T00:49:37Z", "path": "sdks/python/apache_beam/typehints/typed_pipeline_test_py3.py", "diffHunk": "@@ -257,6 +265,65 @@ def fn2(element: int) -> int:\n     result = [1, 2, 3] | beam.FlatMap(fn) | beam.Map(fn2)\n     self.assertCountEqual([4, 6], result)\n \n+  def test_typed_ptransform_with_no_error(self):\n+    class StrToInt(beam.PTransform):\n+      def expand(self, pcoll: beam.pvalue.PCollection[str]) -> beam.pvalue.PCollection[int]:\n+        return pcoll | beam.Map(lambda x: int(x))\n+\n+    class IntToStr(beam.PTransform):\n+      def expand(self, pcoll: beam.pvalue.PCollection[int]) -> beam.pvalue.PCollection[str]:\n+        return pcoll | beam.Map(lambda x: str(x))\n+\n+    try:\n+      _ = ['1', '2', '3'] | StrToInt() | IntToStr()\n+    except Exception:\n+      self.fail('An unexpected error was raised during a pipeline with correct typehints.')\n+\n+  def test_typed_ptransform_with_bad_typehints(self):\n+    class StrToInt(beam.PTransform):\n+      def expand(self, pcoll: beam.pvalue.PCollection[str]) -> beam.pvalue.PCollection[int]:\n+        return pcoll | beam.Map(lambda x: int(x))\n+\n+    class IntToStr(beam.PTransform):\n+      def expand(self, pcoll: beam.pvalue.PCollection[str]) -> beam.pvalue.PCollection[str]:\n+        return pcoll | beam.Map(lambda x: str(x))\n+\n+    with self.assertRaises(typehints.TypeCheckError) as error:\n+      # raises error because of mismatched typehints between StrToInt and IntToStr\n+      _ = ['1', '2', '3'] | StrToInt() | IntToStr()\n+\n+    self.assertTrue(\"Input type hint violation at IntToStr: expected <class 'str'>, got <class 'int'>\" in str(error.exception))\n+\n+  def test_typed_ptransform_with_bad_input(self):\n+    class StrToInt(beam.PTransform):\n+      def expand(self, pcoll: beam.pvalue.PCollection[str]) -> beam.pvalue.PCollection[int]:\n+        return pcoll | beam.Map(lambda x: int(x))\n+\n+    class IntToStr(beam.PTransform):\n+      def expand(self, pcoll: beam.pvalue.PCollection[int]) -> beam.pvalue.PCollection[str]:\n+        return pcoll | beam.Map(lambda x: str(x))\n+\n+    with self.assertRaises(typehints.TypeCheckError) as error:\n+      # Feed integers to a PTransform that expects strings\n+      _ = [1, 2, 3] | StrToInt() | IntToStr()\n+\n+    self.assertTrue(\"Input type hint violation at StrToInt: expected <class 'str'>, got <class 'int'>\" in str(error.exception))", "originalCommit": "dd1e38e353d3bf4f7c924be47734d331671e72f1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTI2Mzg0OA==", "url": "https://github.com/apache/beam/pull/12009#discussion_r445263848", "bodyText": "This is valid. The type hint should convert to Any.\nQuoting from https://docs.python.org/3/library/typing.html:\n\nUsing a generic class without specifying type parameters assumes Any for each position.", "author": "udim", "createdAt": "2020-06-25T01:49:49Z", "path": "sdks/python/apache_beam/typehints/typehints_test_py3.py", "diffHunk": "@@ -46,11 +51,61 @@ class MyDoFn(DoFn):\n       def process(self, element: int) -> Iterable[str]:\n         pass\n \n-    print(MyDoFn().get_type_hints())\n     th = MyDoFn().get_type_hints()\n     self.assertEqual(th.input_types, ((int, ), {}))\n     self.assertEqual(th.output_types, ((str, ), {}))\n \n \n+class TestPTransformAnnotations(unittest.TestCase):\n+  def test_pep484_annotations(self):\n+    class MyPTransform(PTransform):\n+      def expand(self, pcoll: PCollection[int]) -> PCollection[str]:\n+        return pcoll | Map(lambda num: str(num))\n+\n+    th = MyPTransform().get_type_hints()\n+    self.assertEqual(th.input_types, ((int, ), {}))\n+    self.assertEqual(th.output_types, ((str, ), {}))\n+\n+  def test_annotations_without_pcollection_wrapper(self):\n+    class MyPTransform(PTransform):\n+      def expand(self, pcoll: int) -> str:\n+        return pcoll | Map(lambda num: str(num))\n+\n+    with self.assertRaises(TypeCheckError) as error:\n+      _th = MyPTransform().get_type_hints()\n+\n+    self.assertEqual(str(error.exception), 'An input typehint to a PTransform must be a single (or nested) type '\n+                                           'wrapped by a PCollection.')\n+\n+  def test_annotations_without_internal_type(self):\n+    class MyPTransform(PTransform):\n+      def expand(self, pcoll: PCollection) -> PCollection:", "originalCommit": "dd1e38e353d3bf4f7c924be47734d331671e72f1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjM2ODY2Mw==", "url": "https://github.com/apache/beam/pull/12009#discussion_r446368663", "bodyText": "Thanks, fixed.", "author": "saavannanavati", "createdAt": "2020-06-26T19:23:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTI2Mzg0OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTI2NzEzOA==", "url": "https://github.com/apache/beam/pull/12009#discussion_r445267138", "bodyText": "Please handle cases where self.input_types is None or the number of arguments is not 1.", "author": "udim", "createdAt": "2020-06-25T02:02:44Z", "path": "sdks/python/apache_beam/typehints/decorators.py", "diffHunk": "@@ -378,6 +378,43 @@ def has_simple_output_type(self):\n         self.output_types and len(self.output_types[0]) == 1 and\n         not self.output_types[1])\n \n+  def strip_pcoll_input(self):\n+    # type: () -> IOTypeHints\n+\n+    input_type = self.input_types[0][0]", "originalCommit": "dd1e38e353d3bf4f7c924be47734d331671e72f1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTI2NzI3MQ==", "url": "https://github.com/apache/beam/pull/12009#discussion_r445267271", "bodyText": "As a general rule, don't catch all exceptions but only the ones you expect to be raised.", "author": "udim", "createdAt": "2020-06-25T02:03:21Z", "path": "sdks/python/apache_beam/typehints/decorators.py", "diffHunk": "@@ -378,6 +378,43 @@ def has_simple_output_type(self):\n         self.output_types and len(self.output_types[0]) == 1 and\n         not self.output_types[1])\n \n+  def strip_pcoll_input(self):\n+    # type: () -> IOTypeHints\n+\n+    input_type = self.input_types[0][0]\n+    if isinstance(input_type, typehints.AnyTypeConstraint):\n+      return self\n+\n+    try:\n+      input_type = input_type.__args__[0]\n+    except:", "originalCommit": "dd1e38e353d3bf4f7c924be47734d331671e72f1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTI2ODA2MQ==", "url": "https://github.com/apache/beam/pull/12009#discussion_r445268061", "bodyText": "Bad merge?", "author": "udim", "createdAt": "2020-06-25T02:06:43Z", "path": "sdks/python/apache_beam/transforms/ptransform.py", "diffHunk": "@@ -616,24 +627,14 @@ def register_urn(\n     # type: (...) -> Callable[[Union[type, Callable[[beam_runner_api_pb2.PTransform, T, PipelineContext], Any]]], Callable[[T, PipelineContext], Any]]\n     pass\n \n-  @classmethod\n-  @overload\n-  def register_urn(\n-      cls,\n-      urn,  # type: str\n-      parameter_type,  # type: None\n-  ):\n-    # type: (...) -> Callable[[Union[type, Callable[[beam_runner_api_pb2.PTransform, bytes, PipelineContext], Any]]], Callable[[bytes, PipelineContext], Any]]\n-    pass\n-\n   @classmethod\n   @overload\n   def register_urn(cls,\n                    urn,  # type: str\n                    parameter_type,  # type: Type[T]\n                    constructor  # type: Callable[[beam_runner_api_pb2.PTransform, T, PipelineContext], Any]\n                   ):\n-    # type: (...) -> None\n+    # type: (...) -> Callable[[Union[type, Callable[[beam_runner_api_pb2.PTransform, bytes, PipelineContext], Any]]], Callable[[bytes, PipelineContext], Any]]", "originalCommit": "dd1e38e353d3bf4f7c924be47734d331671e72f1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTI2ODI2MQ==", "url": "https://github.com/apache/beam/pull/12009#discussion_r445268261", "bodyText": "You can chain the 2 function calls.", "author": "udim", "createdAt": "2020-06-25T02:07:29Z", "path": "sdks/python/apache_beam/transforms/ptransform.py", "diffHunk": "@@ -364,6 +366,15 @@ def default_label(self):\n     # type: () -> str\n     return self.__class__.__name__\n \n+  def default_type_hints(self):\n+    fn_type_hints = IOTypeHints.from_callable(self.expand)\n+    if fn_type_hints is not None:\n+      fn_type_hints = fn_type_hints.strip_pcoll_input()\n+      fn_type_hints = fn_type_hints.strip_pcoll_output()", "originalCommit": "dd1e38e353d3bf4f7c924be47734d331671e72f1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTI2OTEwMA==", "url": "https://github.com/apache/beam/pull/12009#discussion_r445269100", "bodyText": "Also test when the output typehint is unsupported.", "author": "udim", "createdAt": "2020-06-25T02:10:53Z", "path": "sdks/python/apache_beam/typehints/typehints_test_py3.py", "diffHunk": "@@ -46,11 +51,61 @@ class MyDoFn(DoFn):\n       def process(self, element: int) -> Iterable[str]:\n         pass\n \n-    print(MyDoFn().get_type_hints())\n     th = MyDoFn().get_type_hints()\n     self.assertEqual(th.input_types, ((int, ), {}))\n     self.assertEqual(th.output_types, ((str, ), {}))\n \n \n+class TestPTransformAnnotations(unittest.TestCase):\n+  def test_pep484_annotations(self):\n+    class MyPTransform(PTransform):\n+      def expand(self, pcoll: PCollection[int]) -> PCollection[str]:\n+        return pcoll | Map(lambda num: str(num))\n+\n+    th = MyPTransform().get_type_hints()\n+    self.assertEqual(th.input_types, ((int, ), {}))\n+    self.assertEqual(th.output_types, ((str, ), {}))\n+\n+  def test_annotations_without_pcollection_wrapper(self):\n+    class MyPTransform(PTransform):\n+      def expand(self, pcoll: int) -> str:\n+        return pcoll | Map(lambda num: str(num))\n+\n+    with self.assertRaises(TypeCheckError) as error:\n+      _th = MyPTransform().get_type_hints()\n+\n+    self.assertEqual(str(error.exception), 'An input typehint to a PTransform must be a single (or nested) type '", "originalCommit": "dd1e38e353d3bf4f7c924be47734d331671e72f1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTI3MzIyNA==", "url": "https://github.com/apache/beam/pull/12009#discussion_r445273224", "bodyText": "Also verify that input_type is a PCollection or PBegin.\nPCollection or PDone for output type", "author": "udim", "createdAt": "2020-06-25T02:28:10Z", "path": "sdks/python/apache_beam/typehints/decorators.py", "diffHunk": "@@ -378,6 +378,43 @@ def has_simple_output_type(self):\n         self.output_types and len(self.output_types[0]) == 1 and\n         not self.output_types[1])\n \n+  def strip_pcoll_input(self):\n+    # type: () -> IOTypeHints\n+\n+    input_type = self.input_types[0][0]\n+    if isinstance(input_type, typehints.AnyTypeConstraint):", "originalCommit": "dd1e38e353d3bf4f7c924be47734d331671e72f1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "5ba396ba9f0389f708e3f71ff62289a0de3a25d1", "url": "https://github.com/apache/beam/commit/5ba396ba9f0389f708e3f71ff62289a0de3a25d1", "message": "Support PDone, PBegin, and better handling of error cases", "committedDate": "2020-06-25T22:04:34Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTg3MTc4MA==", "url": "https://github.com/apache/beam/pull/12009#discussion_r445871780", "bodyText": "Any idea why this test is failing? It says the strings don't match in stdout but they appear to match.", "author": "saavannanavati", "createdAt": "2020-06-25T22:24:05Z", "path": "sdks/python/apache_beam/typehints/typehints_test_py3.py", "diffHunk": "@@ -46,11 +51,59 @@ class MyDoFn(DoFn):\n       def process(self, element: int) -> Iterable[str]:\n         pass\n \n-    print(MyDoFn().get_type_hints())\n     th = MyDoFn().get_type_hints()\n     self.assertEqual(th.input_types, ((int, ), {}))\n     self.assertEqual(th.output_types, ((str, ), {}))\n \n \n+class TestPTransformAnnotations(unittest.TestCase):\n+  def test_pep484_annotations(self):\n+    class MyPTransform(PTransform):\n+      def expand(self, pcoll: PCollection[int]) -> PCollection[str]:\n+        return pcoll | Map(lambda num: str(num))\n+\n+    th = MyPTransform().get_type_hints()\n+    self.assertEqual(th.input_types, ((int, ), {}))\n+    self.assertEqual(th.output_types, ((str, ), {}))\n+\n+  def test_annotations_without_pcollection_wrapper(self):\n+    class MyPTransform(PTransform):\n+      def expand(self, pcoll: int) -> str:\n+        return pcoll | Map(lambda num: str(num))\n+\n+    error_str = 'An input typehint to a PTransform must be a single (or nested) type wrapped by a PCollection or PBegin. '\n+\n+    with self.assertRaisesRegex(TypeCheckError, error_str):", "originalCommit": "e3baf2aaf40475c0747f6eb4273f5d6f9153a6d3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTk0MjMxOQ==", "url": "https://github.com/apache/beam/pull/12009#discussion_r445942319", "bodyText": "Probably because there are unescaped regex control characters in that string: ().", "author": "udim", "createdAt": "2020-06-26T02:57:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTg3MTc4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjM1NTEwOA==", "url": "https://github.com/apache/beam/pull/12009#discussion_r446355108", "bodyText": "Thanks, that fixed it", "author": "saavannanavati", "createdAt": "2020-06-26T18:52:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTg3MTc4MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTg3NzA1MA==", "url": "https://github.com/apache/beam/pull/12009#discussion_r445877050", "bodyText": "Now that I think about it this can be a simple try/catch IndexError instead of manually checking for None", "author": "saavannanavati", "createdAt": "2020-06-25T22:39:43Z", "path": "sdks/python/apache_beam/typehints/decorators.py", "diffHunk": "@@ -378,6 +379,61 @@ def has_simple_output_type(self):\n         self.output_types and len(self.output_types[0]) == 1 and\n         not self.output_types[1])\n \n+  def strip_pcoll_input(self):\n+    # type: () -> IOTypeHints\n+\n+    error_str = 'An input typehint to a PTransform must be a single (or nested) type wrapped by a PCollection or ' \\\n+                'PBegin. '\n+\n+    if any(element is None for element in [self.input_types, self.input_types[0], self.input_types[0][0]]):", "originalCommit": "e3baf2aaf40475c0747f6eb4273f5d6f9153a6d3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTk0MTA2NQ==", "url": "https://github.com/apache/beam/pull/12009#discussion_r445941065", "bodyText": "This line will raise an exception when self.input_types is None, compared to:\nif self.input_types is None or len(self.input_types[0]) != 1:\nIt doesn't take advantage of short-circuit evaluation.\nself.input_types = None is a valid value. It means nothing was set. (We should get rid of that and always have ((), {}) as the input/output_types value if there are no type hints, but I haven't had the chance to do that.)\nSame goes for having zero type hints: it's valid and there's nothing to do.\nMight be useful to reuse: self._has_input_types, self.has_simple_output_type.", "author": "udim", "createdAt": "2020-06-26T02:51:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTg3NzA1MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjM1OTI4OA==", "url": "https://github.com/apache/beam/pull/12009#discussion_r446359288", "bodyText": "I thought they were equivalent because any() supports short-circuiting.\nThanks, just pushed a fix that replaces the messy check with those helper functions. Also just to clarify, in those situations, the typehint is valid so we can just return self right?", "author": "saavannanavati", "createdAt": "2020-06-26T19:02:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTg3NzA1MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTIzMDg2MQ==", "url": "https://github.com/apache/beam/pull/12009#discussion_r451230861", "bodyText": "It does support short-circuiting, but the list [self.input_types, self.input_types[0], self.input_types[0][0]] is first completely evaluated.", "author": "udim", "createdAt": "2020-07-08T01:28:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTg3NzA1MA=="}], "type": "inlineReview"}, {"oid": "9de4a722a21182601d2d9a2c032f02d010e83ff2", "url": "https://github.com/apache/beam/commit/9de4a722a21182601d2d9a2c032f02d010e83ff2", "message": "Refactors strip_pcoll_input() and strip_pcoll_output() to a shared function", "committedDate": "2020-06-26T18:55:29Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTIyNzQ5Mw==", "url": "https://github.com/apache/beam/pull/12009#discussion_r451227493", "bodyText": "@robertwb are PBegin and PDone part of the public API?", "author": "udim", "createdAt": "2020-07-08T01:14:51Z", "path": "website/www/site/content/en/documentation/sdks/python-type-safety.md", "diffHunk": "@@ -90,6 +91,15 @@ The following code declares an `int` input and a `str` output type hint on the `\n {{< code_sample \"sdks/python/apache_beam/examples/snippets/snippets_test_py3.py\" type_hints_map_annotations >}}\n {{< /highlight >}}\n \n+The following code demonstrates how to use annotations on `PTransform` subclasses. \n+A valid annotation is a `PCollection`, `PBegin`, or `PDone` that wraps an internal (nested) type. ", "originalCommit": "b3dbe65f13b6a9894f1b7bf7dab49c08502e200f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDcxMzUyNA==", "url": "https://github.com/apache/beam/pull/12009#discussion_r454713524", "bodyText": "Good question. Responded on the list.", "author": "robertwb", "createdAt": "2020-07-15T00:04:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTIyNzQ5Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTIxMzY4Mw==", "url": "https://github.com/apache/beam/pull/12009#discussion_r455213683", "bodyText": "The dev list discussion seems to have a consensus:\n\nMake PBegin public (add to __all__ list)\nDeprecate PDone return type in favor of None. We still need to be backwards compatible, but update this PR to support the None return type for expand.\n\nAdditional documentation will be tracked in https://issues.apache.org/jira/browse/BEAM-10495", "author": "udim", "createdAt": "2020-07-15T17:26:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTIyNzQ5Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTIzMDU3NA==", "url": "https://github.com/apache/beam/pull/12009#discussion_r455230574", "bodyText": "Sounds good.\nShould we update documentation here and here to note the existence of PBegin?", "author": "saavannanavati", "createdAt": "2020-07-15T17:46:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTIyNzQ5Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTM0MjMzMg==", "url": "https://github.com/apache/beam/pull/12009#discussion_r455342332", "bodyText": "I would like to split the programming guide update into a separate PR, since it will include examples from multiple languages and possibly some more discussion. This will be tracked in BEAM-10495, and you can take it on if you wish.\nThe python-type-safety update in this PR already mentions PBegin. Did you want to add more details?", "author": "udim", "createdAt": "2020-07-15T21:03:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTIyNzQ5Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjEwOTk2MQ==", "url": "https://github.com/apache/beam/pull/12009#discussion_r456109961", "bodyText": "Sounds good\n\nThe python-type-safety update in this PR already mentions PBegin. Did you want to add more details?\n\nIt also mentions PDone, do we want to remove that?\n\nI would like to split the programming guide update into a separate PR, since it will include examples from multiple languages and possibly some more discussion. This will be tracked in BEAM-10495, and you can take it on if you wish.\n\nI'll focus on benchmarking the runtime type checking system for now but if time permits afterwards, sure", "author": "saavannanavati", "createdAt": "2020-07-16T22:18:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTIyNzQ5Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTE4MDAwOA==", "url": "https://github.com/apache/beam/pull/12009#discussion_r459180008", "bodyText": "Please also accept None wherever PDone is accepted, so as to not break existing pipelines.", "author": "udim", "createdAt": "2020-07-23T02:09:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTIyNzQ5Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTIyODA0MA==", "url": "https://github.com/apache/beam/pull/12009#discussion_r451228040", "bodyText": "PBegin and Done do not contain elements like a PCollection. I think of them as placeholders for transforms that don't have inputs or outputs, respectively.", "author": "udim", "createdAt": "2020-07-08T01:17:08Z", "path": "sdks/python/apache_beam/pvalue.py", "diffHunk": "@@ -222,7 +222,7 @@ class _InvalidUnpickledPCollection(object):\n   pass\n \n \n-class PBegin(PValue):\n+class PBegin(PValue, Generic[T]):", "originalCommit": "b3dbe65f13b6a9894f1b7bf7dab49c08502e200f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTczMDI1OQ==", "url": "https://github.com/apache/beam/pull/12009#discussion_r451730259", "bodyText": "Oh ok makes sense", "author": "saavannanavati", "createdAt": "2020-07-08T18:02:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTIyODA0MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTIzMzE5Mw==", "url": "https://github.com/apache/beam/pull/12009#discussion_r451233193", "bodyText": "Are string representations necessary here? We typically don't compare by string.\nYou can also write if not isinstance(my_type, valid_classes).", "author": "udim", "createdAt": "2020-07-08T01:37:15Z", "path": "sdks/python/apache_beam/typehints/decorators.py", "diffHunk": "@@ -378,6 +378,56 @@ def has_simple_output_type(self):\n         self.output_types and len(self.output_types[0]) == 1 and\n         not self.output_types[1])\n \n+  def strip_pcoll(self):\n+    return self.strip_pcoll_helper(self.input_types,\n+                                   self._has_input_types,\n+                                   {'input_types': None},\n+                                   ['apache_beam.pvalue.PBegin'],\n+                                   'An input typehint to a PTransform must be'\n+                                   ' a single (or nested) type wrapped by '\n+                                   'a PCollection or PBegin. ',\n+                                   'strip_pcoll_input()').\\\n+                strip_pcoll_helper(self.output_types,\n+                                   self.has_simple_output_type,\n+                                   {'output_types': None},\n+                                   ['apache_beam.pvalue.PDone'],\n+                                   'An output typehint to a PTransform must be'\n+                                   ' a single (or nested) type wrapped by '\n+                                   'a PCollection or PDone. ',\n+                                   'strip_pcoll_output()')\n+\n+  def strip_pcoll_helper(\n+      self,\n+      my_type,            # type: any\n+      has_my_type,        # type: Callable[[], bool]\n+      kwarg_dict,         # type: Dict[str, any]\n+      my_valid_classes,   # type: List[str]\n+      error_str,          # type: str\n+      source_str          # type: str\n+      ):\n+    # type: (...) -> IOTypeHints\n+\n+    if not has_my_type() or len(my_type[0]) != 1:\n+      return self\n+\n+    my_type = my_type[0][0]\n+\n+    if isinstance(my_type, typehints.AnyTypeConstraint):\n+      return self\n+\n+    valid_classes = ['apache_beam.pvalue.PCollection'] + my_valid_classes\n+\n+    if not any(valid_class in str(my_type) for valid_class in valid_classes):", "originalCommit": "b3dbe65f13b6a9894f1b7bf7dab49c08502e200f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTczMzcwNg==", "url": "https://github.com/apache/beam/pull/12009#discussion_r451733706", "bodyText": "I tried using isinstance initially but it doesn't work well with generic types\nAnother option is to use __origin__ but I don't know if that's fully backwards compatible\nStrings are a wacky solution though.. do you have any other ideas?", "author": "saavannanavati", "createdAt": "2020-07-08T18:08:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTIzMzE5Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzkzODQxNQ==", "url": "https://github.com/apache/beam/pull/12009#discussion_r453938415", "bodyText": "TBD: Try using __origin__ instead for subscripted types and non-subscripted types", "author": "saavannanavati", "createdAt": "2020-07-13T21:17:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTIzMzE5Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTIzNDY1Nw==", "url": "https://github.com/apache/beam/pull/12009#discussion_r451234657", "bodyText": "The next(iter(kwarg_dict)) call hard to read. Since there is only one item in the dict, you could pass the key instead and create the dictionary below.", "author": "udim", "createdAt": "2020-07-08T01:42:55Z", "path": "sdks/python/apache_beam/typehints/decorators.py", "diffHunk": "@@ -378,6 +378,56 @@ def has_simple_output_type(self):\n         self.output_types and len(self.output_types[0]) == 1 and\n         not self.output_types[1])\n \n+  def strip_pcoll(self):\n+    return self.strip_pcoll_helper(self.input_types,\n+                                   self._has_input_types,\n+                                   {'input_types': None},\n+                                   ['apache_beam.pvalue.PBegin'],\n+                                   'An input typehint to a PTransform must be'\n+                                   ' a single (or nested) type wrapped by '\n+                                   'a PCollection or PBegin. ',\n+                                   'strip_pcoll_input()').\\\n+                strip_pcoll_helper(self.output_types,\n+                                   self.has_simple_output_type,\n+                                   {'output_types': None},\n+                                   ['apache_beam.pvalue.PDone'],\n+                                   'An output typehint to a PTransform must be'\n+                                   ' a single (or nested) type wrapped by '\n+                                   'a PCollection or PDone. ',\n+                                   'strip_pcoll_output()')\n+\n+  def strip_pcoll_helper(\n+      self,\n+      my_type,            # type: any\n+      has_my_type,        # type: Callable[[], bool]\n+      kwarg_dict,         # type: Dict[str, any]\n+      my_valid_classes,   # type: List[str]\n+      error_str,          # type: str\n+      source_str          # type: str\n+      ):\n+    # type: (...) -> IOTypeHints\n+\n+    if not has_my_type() or len(my_type[0]) != 1:\n+      return self\n+\n+    my_type = my_type[0][0]\n+\n+    if isinstance(my_type, typehints.AnyTypeConstraint):\n+      return self\n+\n+    valid_classes = ['apache_beam.pvalue.PCollection'] + my_valid_classes\n+\n+    if not any(valid_class in str(my_type) for valid_class in valid_classes):\n+      raise TypeCheckError(error_str)\n+\n+    if not hasattr(my_type, '__args__'):  # e.g. PCollection\n+      kwarg_dict[next(iter(kwarg_dict))] = ((typehints.Any, ), {})", "originalCommit": "b3dbe65f13b6a9894f1b7bf7dab49c08502e200f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTI0MDEwNg==", "url": "https://github.com/apache/beam/pull/12009#discussion_r451240106", "bodyText": "I think this line was not updated to use IntToStr.", "author": "udim", "createdAt": "2020-07-08T02:04:07Z", "path": "sdks/python/apache_beam/examples/snippets/snippets_test_py3.py", "diffHunk": "@@ -96,6 +96,18 @@ def my_fn(element: int) -> str:\n       ids = numbers | 'to_id' >> beam.Map(my_fn)\n       # [END type_hints_map_annotations]\n \n+    # Example using an annotated PTransform.\n+    with self.assertRaises(typehints.TypeCheckError):\n+      # [START type_hints_ptransforms]\n+      from apache_beam.pvalue import PCollection\n+\n+      class IntToStr(beam.PTransform):\n+        def expand(pcoll: PCollection[int]) -> PCollection[str]:\n+          return pcoll | beam.Map(lambda elem: str(elem))\n+\n+      ids = numbers | 'convert to str' >> beam.Map(my_fn)", "originalCommit": "06e451941b5c4ed2c42fdef72227598578b532f3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "ec772c17c5592963f4ddbb592084aaf316e55a11", "url": "https://github.com/apache/beam/commit/ec772c17c5592963f4ddbb592084aaf316e55a11", "message": "Use classes instead of strings during typecheck, and add tests", "committedDate": "2020-07-16T22:08:58Z", "type": "forcePushed"}, {"oid": "3a1572c38b2122834302024e9cedcea1f660d243", "url": "https://github.com/apache/beam/commit/3a1572c38b2122834302024e9cedcea1f660d243", "message": "Add back accidentally removed test", "committedDate": "2020-07-21T19:10:14Z", "type": "forcePushed"}, {"oid": "047a0a088aaf1ffcb3078584c3e3ce086be01f18", "url": "https://github.com/apache/beam/commit/047a0a088aaf1ffcb3078584c3e3ce086be01f18", "message": "[BEAM-10258] Support type hint annotations on PTransform's expand()", "committedDate": "2020-07-21T23:35:58Z", "type": "commit"}, {"oid": "0826bb3ed72f54330a50fb09222071dd79d8dfb5", "url": "https://github.com/apache/beam/commit/0826bb3ed72f54330a50fb09222071dd79d8dfb5", "message": "Fixup: apply YAPF", "committedDate": "2020-07-21T23:35:58Z", "type": "commit"}, {"oid": "27983088c5b0ccb351089b7e4c69161e7aae79e8", "url": "https://github.com/apache/beam/commit/27983088c5b0ccb351089b7e4c69161e7aae79e8", "message": "Moving PCollectionTypeConstraint to typehints.py", "committedDate": "2020-07-21T23:35:58Z", "type": "commit"}, {"oid": "34233493c482cf7c7155ab844da1006b5faf7357", "url": "https://github.com/apache/beam/commit/34233493c482cf7c7155ab844da1006b5faf7357", "message": "Uses Generic[T] instead of PCollectionTypeConstraint", "committedDate": "2020-07-21T23:35:58Z", "type": "commit"}, {"oid": "54d587bcee6ad620383cccff641252d8208839aa", "url": "https://github.com/apache/beam/commit/54d587bcee6ad620383cccff641252d8208839aa", "message": "Fixup: apply YAPF", "committedDate": "2020-07-21T23:35:58Z", "type": "commit"}, {"oid": "e35eb3b19997431608f4cd915e0e11ec6046eee7", "url": "https://github.com/apache/beam/commit/e35eb3b19997431608f4cd915e0e11ec6046eee7", "message": "Remove unused imports", "committedDate": "2020-07-21T23:35:58Z", "type": "commit"}, {"oid": "f2db8a3af3b95809f812c593720f95bdbefe678c", "url": "https://github.com/apache/beam/commit/f2db8a3af3b95809f812c593720f95bdbefe678c", "message": "Force user to wrap typehints in PCollections", "committedDate": "2020-07-21T23:35:58Z", "type": "commit"}, {"oid": "96a2aab52ca110273df5b469ecfc0b46a33bfb90", "url": "https://github.com/apache/beam/commit/96a2aab52ca110273df5b469ecfc0b46a33bfb90", "message": "Add unit tests for various usages of typehints on PTransforms", "committedDate": "2020-07-21T23:35:58Z", "type": "commit"}, {"oid": "35dd79e74ef37a398269e5e87c74b9317354da0a", "url": "https://github.com/apache/beam/commit/35dd79e74ef37a398269e5e87c74b9317354da0a", "message": "Add tests that use typehints on real pipelines", "committedDate": "2020-07-21T23:35:58Z", "type": "commit"}, {"oid": "9a67cc60e6da0bc8b5176da87c2b2e90e00fb12b", "url": "https://github.com/apache/beam/commit/9a67cc60e6da0bc8b5176da87c2b2e90e00fb12b", "message": "Fixup: apply YAPF", "committedDate": "2020-07-21T23:35:58Z", "type": "commit"}, {"oid": "59c51343f3d3c40ec023080b6420a0a6d1575830", "url": "https://github.com/apache/beam/commit/59c51343f3d3c40ec023080b6420a0a6d1575830", "message": "Fix bad merge", "committedDate": "2020-07-21T23:35:58Z", "type": "commit"}, {"oid": "a3a511450b028fbea183c887e6ea26e95b0386e4", "url": "https://github.com/apache/beam/commit/a3a511450b028fbea183c887e6ea26e95b0386e4", "message": "Support PDone, PBegin, and better handling of error cases", "committedDate": "2020-07-21T23:35:58Z", "type": "commit"}, {"oid": "90a93357e46977b8fffe44ea99a68d21c8302c5b", "url": "https://github.com/apache/beam/commit/90a93357e46977b8fffe44ea99a68d21c8302c5b", "message": "Fix test syntax", "committedDate": "2020-07-21T23:35:58Z", "type": "commit"}, {"oid": "1143587996ef6b0cba81aca651d4a5e7f92e84c9", "url": "https://github.com/apache/beam/commit/1143587996ef6b0cba81aca651d4a5e7f92e84c9", "message": "Refactors strip_pcoll_input() and strip_pcoll_output() to a shared function", "committedDate": "2020-07-21T23:35:58Z", "type": "commit"}, {"oid": "eafcdd1d35fdb8808f93032a9e4cc0f0c3d8ec85", "url": "https://github.com/apache/beam/commit/eafcdd1d35fdb8808f93032a9e4cc0f0c3d8ec85", "message": "Add unit tests", "committedDate": "2020-07-21T23:35:58Z", "type": "commit"}, {"oid": "913197f0921bc100cf03e70d200cdfbe862f2f7b", "url": "https://github.com/apache/beam/commit/913197f0921bc100cf03e70d200cdfbe862f2f7b", "message": "Add more tests", "committedDate": "2020-07-21T23:35:58Z", "type": "commit"}, {"oid": "8196c151b346dc42717845a73a35530176d38062", "url": "https://github.com/apache/beam/commit/8196c151b346dc42717845a73a35530176d38062", "message": "Add website documentation", "committedDate": "2020-07-21T23:35:58Z", "type": "commit"}, {"oid": "3532abfbd871b290246b9cfa0bd3b4ed6ca771eb", "url": "https://github.com/apache/beam/commit/3532abfbd871b290246b9cfa0bd3b4ed6ca771eb", "message": "Fix linting issues", "committedDate": "2020-07-21T23:35:58Z", "type": "commit"}, {"oid": "63c443369a1b557e28188021cfddf568866a0334", "url": "https://github.com/apache/beam/commit/63c443369a1b557e28188021cfddf568866a0334", "message": "Fix linting issue by using multi-line function annotations", "committedDate": "2020-07-21T23:35:58Z", "type": "commit"}, {"oid": "3535ee0a1aa11ac3a27a064622de688a27373cbf", "url": "https://github.com/apache/beam/commit/3535ee0a1aa11ac3a27a064622de688a27373cbf", "message": "Fix more lint errors", "committedDate": "2020-07-21T23:35:58Z", "type": "commit"}, {"oid": "33d0e2b63b6660d43613a234187eb16a6c23ec76", "url": "https://github.com/apache/beam/commit/33d0e2b63b6660d43613a234187eb16a6c23ec76", "message": "Fix import order, and other changes for PR", "committedDate": "2020-07-21T23:35:58Z", "type": "commit"}, {"oid": "689c792581095284529c7829870fcbdcee328266", "url": "https://github.com/apache/beam/commit/689c792581095284529c7829870fcbdcee328266", "message": "Fix ungrouped-imports error", "committedDate": "2020-07-21T23:35:58Z", "type": "commit"}, {"oid": "9fb01eb1d4ace0e5b9dfc4773536169a24cdde34", "url": "https://github.com/apache/beam/commit/9fb01eb1d4ace0e5b9dfc4773536169a24cdde34", "message": "Alphabetically order the imports", "committedDate": "2020-07-21T23:35:58Z", "type": "commit"}, {"oid": "437c83b1b240598a214d08f46a645e1eeab89c99", "url": "https://github.com/apache/beam/commit/437c83b1b240598a214d08f46a645e1eeab89c99", "message": "Fixup: apply YAPF", "committedDate": "2020-07-21T23:35:58Z", "type": "commit"}, {"oid": "54fd032c0fbf680ce54a6d2018bfbed1ad68e576", "url": "https://github.com/apache/beam/commit/54fd032c0fbf680ce54a6d2018bfbed1ad68e576", "message": "Fixes a bug where a type can have an empty __args__ attribute", "committedDate": "2020-07-21T23:35:58Z", "type": "commit"}, {"oid": "725ba0848ed478bcf3f987841b7a45fe699393ec", "url": "https://github.com/apache/beam/commit/725ba0848ed478bcf3f987841b7a45fe699393ec", "message": "Fix bug in website snippet code", "committedDate": "2020-07-21T23:35:58Z", "type": "commit"}, {"oid": "e5ecd01aa54ecf45c226bb556d7448b821a259df", "url": "https://github.com/apache/beam/commit/e5ecd01aa54ecf45c226bb556d7448b821a259df", "message": "Fixup: apply YAPF", "committedDate": "2020-07-21T23:35:58Z", "type": "commit"}, {"oid": "9469a5d771f0f2053f2022575fade9914e525ece", "url": "https://github.com/apache/beam/commit/9469a5d771f0f2053f2022575fade9914e525ece", "message": "Fixup: apply YAPF", "committedDate": "2020-07-21T23:35:58Z", "type": "commit"}, {"oid": "4cd080160f2bae20772cb071a42bb0cf72a6bfe6", "url": "https://github.com/apache/beam/commit/4cd080160f2bae20772cb071a42bb0cf72a6bfe6", "message": "Fix NoneType error", "committedDate": "2020-07-21T23:35:58Z", "type": "commit"}, {"oid": "42454da466e5bb13719071d23e5c6d1b533a29e6", "url": "https://github.com/apache/beam/commit/42454da466e5bb13719071d23e5c6d1b533a29e6", "message": "Fix NoneType error part 2", "committedDate": "2020-07-21T23:35:58Z", "type": "commit"}, {"oid": "17c30a65ccb2407f6d97f0ae7cca0b4f1878a7f9", "url": "https://github.com/apache/beam/commit/17c30a65ccb2407f6d97f0ae7cca0b4f1878a7f9", "message": "Use classes instead of strings during typecheck, and add tests", "committedDate": "2020-07-21T23:35:58Z", "type": "commit"}, {"oid": "27cb6f3cdb8f563850e3f380b2ac795cc0614fa7", "url": "https://github.com/apache/beam/commit/27cb6f3cdb8f563850e3f380b2ac795cc0614fa7", "message": "Resolve circular import error and fix readability issues", "committedDate": "2020-07-21T23:35:58Z", "type": "commit"}, {"oid": "c36eefebd176e14acf183b3188df9db7d06f4af1", "url": "https://github.com/apache/beam/commit/c36eefebd176e14acf183b3188df9db7d06f4af1", "message": "Fix lint errors", "committedDate": "2020-07-21T23:35:58Z", "type": "commit"}, {"oid": "0e6f19e438464fd34fa89a946f9c4f74a78315f1", "url": "https://github.com/apache/beam/commit/0e6f19e438464fd34fa89a946f9c4f74a78315f1", "message": "Add back accidentally removed test", "committedDate": "2020-07-21T23:35:58Z", "type": "commit"}, {"oid": "0e6f19e438464fd34fa89a946f9c4f74a78315f1", "url": "https://github.com/apache/beam/commit/0e6f19e438464fd34fa89a946f9c4f74a78315f1", "message": "Add back accidentally removed test", "committedDate": "2020-07-21T23:35:58Z", "type": "forcePushed"}, {"oid": "82c6f4c5d3d30676716f106e887be6bb12038998", "url": "https://github.com/apache/beam/commit/82c6f4c5d3d30676716f106e887be6bb12038998", "message": "Support None as an output annotation", "committedDate": "2020-07-27T19:27:48Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTI4NzkwMw==", "url": "https://github.com/apache/beam/pull/12009#discussion_r461287903", "bodyText": "Nit: This error message doesn't say what the incorrect type was. Ex:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  raise TypeCheckError(error_str)\n          \n          \n            \n                  raise TypeCheckError(error_str + ' Got: %s' % my_type)", "author": "udim", "createdAt": "2020-07-28T02:57:47Z", "path": "sdks/python/apache_beam/typehints/decorators.py", "diffHunk": "@@ -378,6 +379,67 @@ def has_simple_output_type(self):\n         self.output_types and len(self.output_types[0]) == 1 and\n         not self.output_types[1])\n \n+  def strip_pcoll(self):\n+    from apache_beam.pvalue import PBegin\n+    from apache_beam.pvalue import PDone\n+\n+    return self.strip_pcoll_helper(self.input_types,\n+                                   self._has_input_types,\n+                                   'input_types',\n+                                    [PBegin],\n+                                   'An input typehint to a PTransform must be '\n+                                   'a single (or nested) type wrapped by '\n+                                   'a PCollection or PBegin. ',\n+                                   'strip_pcoll_input()').\\\n+                strip_pcoll_helper(self.output_types,\n+                                   self.has_simple_output_type,\n+                                   'output_types',\n+                                   [PDone, None],\n+                                   'An output typehint to a PTransform must be '\n+                                   'a single (or nested) type wrapped by '\n+                                   'a PCollection, PDone, or None. ',\n+                                   'strip_pcoll_output()')\n+\n+  def strip_pcoll_helper(\n+      self,\n+      my_type,            # type: any\n+      has_my_type,        # type: Callable[[], bool]\n+      my_key,             # type: str\n+      special_containers,   # type: List[Union[PBegin, PDone, PCollection]]\n+      error_str,          # type: str\n+      source_str          # type: str\n+      ):\n+    # type: (...) -> IOTypeHints\n+    from apache_beam.pvalue import PCollection\n+\n+    if not has_my_type() or not my_type or len(my_type[0]) != 1:\n+      return self\n+\n+    my_type = my_type[0][0]\n+\n+    if isinstance(my_type, typehints.AnyTypeConstraint):\n+      return self\n+\n+    special_containers += [PCollection]\n+\n+    if (my_type not in special_containers and\n+        getattr(my_type, '__origin__', None) != PCollection):\n+      raise TypeCheckError(error_str)", "originalCommit": "82c6f4c5d3d30676716f106e887be6bb12038998", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "39ef9bdc286d16b1718a7ce2b50bff49afe4b124", "url": "https://github.com/apache/beam/commit/39ef9bdc286d16b1718a7ce2b50bff49afe4b124", "message": "Show incorrect type in error message\n\nCo-authored-by: Udi Meiri <udim@users.noreply.github.com>", "committedDate": "2020-07-28T05:46:50Z", "type": "commit"}, {"oid": "a30800c3850be824bacc0de91fe866270863d3dd", "url": "https://github.com/apache/beam/commit/a30800c3850be824bacc0de91fe866270863d3dd", "message": "Allow Pipeline as an input", "committedDate": "2020-07-29T22:31:34Z", "type": "commit"}, {"oid": "a56e947c97938338321a4325d10a4facd785a213", "url": "https://github.com/apache/beam/commit/a56e947c97938338321a4325d10a4facd785a213", "message": "Fix import bug", "committedDate": "2020-07-29T23:43:36Z", "type": "commit"}, {"oid": "6d3df884881433b3353435956d2fe2c9ebcad3f4", "url": "https://github.com/apache/beam/commit/6d3df884881433b3353435956d2fe2c9ebcad3f4", "message": "Alphabetically order imports inside function (but really this is just to force re-run the tests)", "committedDate": "2020-07-30T06:03:58Z", "type": "commit"}, {"oid": "444f5f44713e14ca2e29207e74f549e39ea3ff8a", "url": "https://github.com/apache/beam/commit/444f5f44713e14ca2e29207e74f549e39ea3ff8a", "message": "Display warning instead of throwing error for oddly formed type hints", "committedDate": "2020-07-31T23:37:03Z", "type": "commit"}, {"oid": "107e8e69f02f143bb38e50310f89d5558061c114", "url": "https://github.com/apache/beam/commit/107e8e69f02f143bb38e50310f89d5558061c114", "message": "Convert to Beam types", "committedDate": "2020-08-04T19:15:15Z", "type": "commit"}, {"oid": "2c046d6f1436f52c8c7482344f78cbbb66bcb80d", "url": "https://github.com/apache/beam/commit/2c046d6f1436f52c8c7482344f78cbbb66bcb80d", "message": "Add test for generic TypeVars", "committedDate": "2020-08-04T19:29:41Z", "type": "commit"}, {"oid": "fc54c04dc2be9fe37b0285fa05dacaf936d924d5", "url": "https://github.com/apache/beam/commit/fc54c04dc2be9fe37b0285fa05dacaf936d924d5", "message": "Fix bug by skipping DoOutputsTuple", "committedDate": "2020-08-04T19:32:56Z", "type": "commit"}, {"oid": "cb97557906732322c624c2c283077a33e7d73388", "url": "https://github.com/apache/beam/commit/cb97557906732322c624c2c283077a33e7d73388", "message": "Fix typo", "committedDate": "2020-08-04T23:30:20Z", "type": "commit"}, {"oid": "73891931f165e8bf86df0210ab252ef8d56aa345", "url": "https://github.com/apache/beam/commit/73891931f165e8bf86df0210ab252ef8d56aa345", "message": "Add test for DoOutputsTuple", "committedDate": "2020-08-05T06:37:04Z", "type": "commit"}, {"oid": "3c01bfd05e44c2442701f7522fc564d5b5ab4d7f", "url": "https://github.com/apache/beam/commit/3c01bfd05e44c2442701f7522fc564d5b5ab4d7f", "message": "Fix lint errors", "committedDate": "2020-08-06T04:48:34Z", "type": "commit"}]}