{"pr_number": 12480, "pr_title": "[BEAM-10647] Fixes get_query_location bug in BigQueryWrapper", "pr_createdAt": "2020-08-06T10:50:03Z", "pr_url": "https://github.com/apache/beam/pull/12480", "timeline": [{"oid": "5fca0c359a4f3d15a3e34e16f8022f62ea2df1a7", "url": "https://github.com/apache/beam/commit/5fca0c359a4f3d15a3e34e16f8022f62ea2df1a7", "message": "[BEAM-10647] Fixes get_query_location bug in BigQueryWrapper", "committedDate": "2020-08-06T11:00:24Z", "type": "forcePushed"}, {"oid": "1f8f392082ef6c474195a22ef5d62f6c4c3d449b", "url": "https://github.com/apache/beam/commit/1f8f392082ef6c474195a22ef5d62f6c4c3d449b", "message": "[BEAM-10647] Fixes get_query_location bug in BigQueryWrapper", "committedDate": "2020-08-06T11:06:45Z", "type": "forcePushed"}, {"oid": "dfdcd2e8aa5de52fe103648393d9d2e3f0f4a782", "url": "https://github.com/apache/beam/commit/dfdcd2e8aa5de52fe103648393d9d2e3f0f4a782", "message": "[BEAM-10647] Fixes get_query_location bug in BigQueryWrapper", "committedDate": "2020-08-06T11:54:09Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjU2Mjg4MA==", "url": "https://github.com/apache/beam/pull/12480#discussion_r466562880", "bodyText": "Is implied by the for loop and can be dropped.", "author": "apilloud", "createdAt": "2020-08-06T17:15:38Z", "path": "sdks/python/apache_beam/io/gcp/bigquery_tools.py", "diffHunk": "@@ -318,15 +319,20 @@ def get_query_location(self, project_id, query, use_legacy_sql):\n \n     referenced_tables = response.statistics.query.referencedTables\n     if referenced_tables:  # Guards against both non-empty and non-None", "originalCommit": "dfdcd2e8aa5de52fe103648393d9d2e3f0f4a782", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjY5NjA4OA==", "url": "https://github.com/apache/beam/pull/12480#discussion_r466696088", "bodyText": "@apilloud comment suggest that is also guarding against None value. If that's true, dropping this if, would break code for loop in case referenced_tables is actually None.\nTherefore my question is, are you sure we want to remove that if?", "author": "galuszkak", "createdAt": "2020-08-06T21:28:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjU2Mjg4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjY5OTE4MQ==", "url": "https://github.com/apache/beam/pull/12480#discussion_r466699181", "bodyText": "You are right, this needs to stay. (I'm getting go and python mixed up here, I don't use either of them very often.)", "author": "apilloud", "createdAt": "2020-08-06T21:35:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjU2Mjg4MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjU2MzcyNw==", "url": "https://github.com/apache/beam/pull/12480#discussion_r466563727", "bodyText": "This error message is slightly wrong now. How about: Query %s does not reference any tables you have permission to inspect.", "author": "apilloud", "createdAt": "2020-08-06T17:17:13Z", "path": "sdks/python/apache_beam/io/gcp/bigquery_tools.py", "diffHunk": "@@ -318,15 +319,20 @@ def get_query_location(self, project_id, query, use_legacy_sql):\n \n     referenced_tables = response.statistics.query.referencedTables\n     if referenced_tables:  # Guards against both non-empty and non-None\n-      table = referenced_tables[0]\n-      location = self.get_table_location(\n-          table.projectId, table.datasetId, table.tableId)\n-      _LOGGER.info(\n-          \"Using location %r from table %r referenced by query %s\",\n-          location,\n-          table,\n-          query)\n-      return location\n+      for table in referenced_tables:\n+        try:\n+          location = self.get_table_location(\n+              table.projectId, table.datasetId, table.tableId)\n+        except HttpForbiddenError:\n+          # Permission access for table (i.e. from authorized_view),\n+          # try next one\n+          continue\n+        _LOGGER.info(\n+            \"Using location %r from table %r referenced by query %s\",\n+            location,\n+            table,\n+            query)\n+        return location\n \n     _LOGGER.debug(\"Query %s does not reference any tables.\", query)", "originalCommit": "dfdcd2e8aa5de52fe103648393d9d2e3f0f4a782", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjY5NjIwNA==", "url": "https://github.com/apache/beam/pull/12480#discussion_r466696204", "bodyText": "@apilloud will change it. Thanks for pointing this out.", "author": "galuszkak", "createdAt": "2020-08-06T21:28:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjU2MzcyNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjU2ODA3MQ==", "url": "https://github.com/apache/beam/pull/12480#discussion_r466568071", "bodyText": "(@pabloem is this something we want to do?)", "author": "apilloud", "createdAt": "2020-08-06T17:22:26Z", "path": "sdks/python/apache_beam/io/gcp/bigquery_tools_test.py", "diffHunk": "@@ -50,6 +49,15 @@\n from apache_beam.io.gcp.internal.clients import bigquery\n from apache_beam.options.pipeline_options import PipelineOptions\n \n+# Protect against environments where bigquery library is not available.", "originalCommit": "dfdcd2e8aa5de52fe103648393d9d2e3f0f4a782", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjY5NzEwMQ==", "url": "https://github.com/apache/beam/pull/12480#discussion_r466697101", "bodyText": "@apilloud this is copy from bigquery_test.py I assumed we want this consistent between files.", "author": "galuszkak", "createdAt": "2020-08-06T21:30:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjU2ODA3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjcwMTIxNg==", "url": "https://github.com/apache/beam/pull/12480#discussion_r466701216", "bodyText": "Thanks for pointing that out. (I assumed we wouldn't want to do this in tests, but if we are doing it in others then follow that pattern.)", "author": "apilloud", "createdAt": "2020-08-06T21:40:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjU2ODA3MQ=="}], "type": "inlineReview"}, {"oid": "c31d2e14ef5ea67df0ca53d6329c5956c86c5efa", "url": "https://github.com/apache/beam/commit/c31d2e14ef5ea67df0ca53d6329c5956c86c5efa", "message": "[BEAM-10647] Fixes get_query_location bug in BigQueryWrapper", "committedDate": "2020-08-06T21:36:14Z", "type": "commit"}, {"oid": "c31d2e14ef5ea67df0ca53d6329c5956c86c5efa", "url": "https://github.com/apache/beam/commit/c31d2e14ef5ea67df0ca53d6329c5956c86c5efa", "message": "[BEAM-10647] Fixes get_query_location bug in BigQueryWrapper", "committedDate": "2020-08-06T21:36:14Z", "type": "forcePushed"}]}