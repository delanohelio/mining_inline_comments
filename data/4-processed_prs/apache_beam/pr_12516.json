{"pr_number": 12516, "pr_title": "[BEAM-9547] Implement dataframes top, join, merge.", "pr_createdAt": "2020-08-10T19:33:09Z", "pr_url": "https://github.com/apache/beam/pull/12516", "timeline": [{"oid": "975175ebef146296f26de74d73f71dc0dcd4adbd", "url": "https://github.com/apache/beam/commit/975175ebef146296f26de74d73f71dc0dcd4adbd", "message": "[BEAM-9547] Implement dataframes top, join, merge.", "committedDate": "2020-08-10T19:31:54Z", "type": "commit"}, {"oid": "4356ee9ed473a773e1d709b7146ff681605ee998", "url": "https://github.com/apache/beam/commit/4356ee9ed473a773e1d709b7146ff681605ee998", "message": "allow non parallel on test", "committedDate": "2020-08-10T19:39:07Z", "type": "commit"}, {"oid": "da9437c6b4fa1803cf65ca749259f5f360c72e29", "url": "https://github.com/apache/beam/commit/da9437c6b4fa1803cf65ca749259f5f360c72e29", "message": "lint", "committedDate": "2020-08-10T20:41:47Z", "type": "commit"}, {"oid": "dc21a154c32bb322bdbf5d7a65f1765ebe50547d", "url": "https://github.com/apache/beam/commit/dc21a154c32bb322bdbf5d7a65f1765ebe50547d", "message": "fix parameter", "committedDate": "2020-08-10T21:04:48Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODcwNzMzNg==", "url": "https://github.com/apache/beam/pull/12516#discussion_r468707336", "bodyText": "Would using 'nlargest' for the name of both the per-partition and global computed expression cause confusion for debugging or UX?", "author": "tysonjh", "createdAt": "2020-08-11T16:24:47Z", "path": "sdks/python/apache_beam/dataframe/frames.py", "diffHunk": "@@ -54,6 +54,42 @@ def agg(self, *args, **kwargs):\n       'order-sensitive')\n   diff = frame_base.wont_implement_method('order-sensitive')\n \n+  @frame_base.args_to_kwargs(pd.Series)\n+  def nlargest(self, **kwargs):\n+    if 'keep' in kwargs and kwargs['keep'] != 'all':\n+      raise frame_base.WontImplementError('order-sensitive')\n+    per_partition = expressions.ComputedExpression(\n+        'nlargest',", "originalCommit": "dc21a154c32bb322bdbf5d7a65f1765ebe50547d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODg2MjI1Ng==", "url": "https://github.com/apache/beam/pull/12516#discussion_r468862256", "bodyText": "Good point, updated.", "author": "robertwb", "createdAt": "2020-08-11T21:00:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODcwNzMzNg=="}], "type": "inlineReview"}, {"oid": "dbf6cfd1c4a6aa91e4f381f7c93ed4b7bb9162ee", "url": "https://github.com/apache/beam/commit/dbf6cfd1c4a6aa91e4f381f7c93ed4b7bb9162ee", "message": "Update naming.", "committedDate": "2020-08-11T21:00:39Z", "type": "commit"}, {"oid": "5c9288bcab2cf4e9ba557ec29e880f7fbb00ce21", "url": "https://github.com/apache/beam/commit/5c9288bcab2cf4e9ba557ec29e880f7fbb00ce21", "message": "py2 fix", "committedDate": "2020-08-13T16:42:04Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDMwMDcxNw==", "url": "https://github.com/apache/beam/pull/12516#discussion_r470300717", "bodyText": "How does 'keep' relate to the order sensitivity mentioned in the error? Using 'keep' can result in a possibly larger than n Series returned. Shouldn't this be using 'first' to return the first n occurrences?", "author": "tysonjh", "createdAt": "2020-08-13T23:21:11Z", "path": "sdks/python/apache_beam/dataframe/frames.py", "diffHunk": "@@ -54,6 +54,42 @@ def agg(self, *args, **kwargs):\n       'order-sensitive')\n   diff = frame_base.wont_implement_method('order-sensitive')\n \n+  @frame_base.args_to_kwargs(pd.Series)\n+  def nlargest(self, **kwargs):\n+    if 'keep' in kwargs and kwargs['keep'] != 'all':\n+      raise frame_base.WontImplementError('order-sensitive')", "originalCommit": "5c9288bcab2cf4e9ba557ec29e880f7fbb00ce21", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzE3NDQ2Mg==", "url": "https://github.com/apache/beam/pull/12516#discussion_r473174462", "bodyText": "When there is a tie, a specification like \"first\" or \"last\" makes the result depend on the ordering to decide which ones to keep. With \"all\" we may return more than n occurrences (as in Pandas) but we no longer have to worry about keeping (or discarding) the right ones.", "author": "robertwb", "createdAt": "2020-08-19T16:45:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDMwMDcxNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDMwMzM3MQ==", "url": "https://github.com/apache/beam/pull/12516#discussion_r470303371", "bodyText": "Should this be up with the other elementwise_methods (e.g. prod) in the class? Or closer to the call site? I'm just trying to understand why it is here.\nAlso, I tried to follow along the implementation of elementwise_method but got lost at the _proxy_function. What does this do?", "author": "tysonjh", "createdAt": "2020-08-13T23:30:44Z", "path": "sdks/python/apache_beam/dataframe/frames.py", "diffHunk": "@@ -54,6 +54,42 @@ def agg(self, *args, **kwargs):\n       'order-sensitive')\n   diff = frame_base.wont_implement_method('order-sensitive')\n \n+  @frame_base.args_to_kwargs(pd.Series)\n+  def nlargest(self, **kwargs):\n+    if 'keep' in kwargs and kwargs['keep'] != 'all':\n+      raise frame_base.WontImplementError('order-sensitive')\n+    per_partition = expressions.ComputedExpression(\n+        'nlargest-per-partition',\n+        lambda df: df.nlargest(**kwargs), [self._expr],\n+        preserves_partition_by=partitionings.Singleton(),\n+        requires_partition_by=partitionings.Nothing())\n+    with expressions.allow_non_parallel_operations(True):\n+      return frame_base.DeferredFrame.wrap(\n+          expressions.ComputedExpression(\n+              'nlargest',\n+              lambda df: df.nlargest(**kwargs), [per_partition],\n+              preserves_partition_by=partitionings.Singleton(),\n+              requires_partition_by=partitionings.Singleton()))\n+\n+  @frame_base.args_to_kwargs(pd.Series)\n+  def nsmallest(self, **kwargs):\n+    if 'keep' in kwargs and kwargs['keep'] != 'all':\n+      raise frame_base.WontImplementError('order-sensitive')\n+    per_partition = expressions.ComputedExpression(\n+        'nsmallest-per-partition',\n+        lambda df: df.nsmallest(**kwargs), [self._expr],\n+        preserves_partition_by=partitionings.Singleton(),\n+        requires_partition_by=partitionings.Nothing())\n+    with expressions.allow_non_parallel_operations(True):\n+      return frame_base.DeferredFrame.wrap(\n+          expressions.ComputedExpression(\n+              'nsmallest',\n+              lambda df: df.nsmallest(**kwargs), [per_partition],\n+              preserves_partition_by=partitionings.Singleton(),\n+              requires_partition_by=partitionings.Singleton()))\n+\n+  rename_axis = frame_base._elementwise_method('rename_axis')", "originalCommit": "5c9288bcab2cf4e9ba557ec29e880f7fbb00ce21", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzE3Nzk4NA==", "url": "https://github.com/apache/beam/pull/12516#discussion_r473177984", "bodyText": "Given I'm going for full coverage, I tried to keep them in basic alphabetical order, unless there is an obvious relationship between methods.\nAs for elementwise_method, basically it creates a method that returns expressions.ComputedExpression(name, lambda df: getattr(df, name)(args), self._expr, preserves=Singleton(), requires=Nothing) but also handles a mix of deferred and non-deferred arguments. It was such a common pattern that I made a helper for it.", "author": "robertwb", "createdAt": "2020-08-19T16:51:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDMwMzM3MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDQwMjUxNA==", "url": "https://github.com/apache/beam/pull/12516#discussion_r470402514", "bodyText": "Documentation? The method name itself is pretty self documenting but at least on the parameters? I had to go look them up from pd.Series. Similarly for other public methods in this class, documentation would be helpful and go a long way towards making this more accessible for contributors.", "author": "tysonjh", "createdAt": "2020-08-14T04:23:59Z", "path": "sdks/python/apache_beam/dataframe/frames.py", "diffHunk": "@@ -54,6 +54,42 @@ def agg(self, *args, **kwargs):\n       'order-sensitive')\n   diff = frame_base.wont_implement_method('order-sensitive')\n \n+  @frame_base.args_to_kwargs(pd.Series)\n+  def nlargest(self, **kwargs):", "originalCommit": "5c9288bcab2cf4e9ba557ec29e880f7fbb00ce21", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzE3MjgwNw==", "url": "https://github.com/apache/beam/pull/12516#discussion_r473172807", "bodyText": "All of these public methods are proxies for the (extensively documented) methods of the same name in Pandas.", "author": "robertwb", "createdAt": "2020-08-19T16:42:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDQwMjUxNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDQxMTQ0OA==", "url": "https://github.com/apache/beam/pull/12516#discussion_r470411448", "bodyText": "Are DeferredFrame expressions that are configured at pipeline construction but passed to workers for execution?", "author": "tysonjh", "createdAt": "2020-08-14T05:03:08Z", "path": "sdks/python/apache_beam/dataframe/frames.py", "diffHunk": "@@ -54,6 +54,42 @@ def agg(self, *args, **kwargs):\n       'order-sensitive')\n   diff = frame_base.wont_implement_method('order-sensitive')\n \n+  @frame_base.args_to_kwargs(pd.Series)\n+  def nlargest(self, **kwargs):\n+    if 'keep' in kwargs and kwargs['keep'] != 'all':\n+      raise frame_base.WontImplementError('order-sensitive')\n+    per_partition = expressions.ComputedExpression(\n+        'nlargest-per-partition',\n+        lambda df: df.nlargest(**kwargs), [self._expr],\n+        preserves_partition_by=partitionings.Singleton(),\n+        requires_partition_by=partitionings.Nothing())\n+    with expressions.allow_non_parallel_operations(True):\n+      return frame_base.DeferredFrame.wrap(", "originalCommit": "5c9288bcab2cf4e9ba557ec29e880f7fbb00ce21", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzE3NTI2NQ==", "url": "https://github.com/apache/beam/pull/12516#discussion_r473175265", "bodyText": "Technically, it's the Expressions that they wrap that are passed down to workers for execution, but yes, that's the basic idea.", "author": "robertwb", "createdAt": "2020-08-19T16:46:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDQxMTQ0OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDQyMzQyNg==", "url": "https://github.com/apache/beam/pull/12516#discussion_r470423426", "bodyText": "Why is this not defined as a method like revert is above?", "author": "tysonjh", "createdAt": "2020-08-14T05:50:38Z", "path": "sdks/python/apache_beam/dataframe/frames.py", "diffHunk": "@@ -200,9 +236,178 @@ def dropna(self, axis, **kwargs):\n   items = itertuples = iterrows = iteritems = frame_base.wont_implement_method(\n       'non-lazy')\n \n+  def _cols_as_temporary_index(self, cols, suffix=''):\n+    original_index_names = list(self._expr.proxy().index.names)\n+    new_index_names = [\n+        '__apache_beam_temp_%d_%s' % (ix, suffix)\n+        for (ix, _) in enumerate(original_index_names)]\n+    def revert(df):\n+      return frame_base.DeferredFrame.wrap(\n+          expressions.ComputedExpression(\n+              'join_restoreindex',\n+              lambda df:\n+                  df.reset_index().set_index(new_index_names)\n+                  .rename_axis(index=original_index_names, copy=False),\n+              [df._expr],\n+              preserves_partition_by=partitionings.Nothing(),\n+              requires_partition_by=partitionings.Nothing()))\n+    reindexed = frame_base.DeferredFrame.wrap(", "originalCommit": "5c9288bcab2cf4e9ba557ec29e880f7fbb00ce21", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzE4MjYxOA==", "url": "https://github.com/apache/beam/pull/12516#discussion_r473182618", "bodyText": "Good question. Only because it was always invoked right away. Updated to be a method for symmetry.", "author": "robertwb", "createdAt": "2020-08-19T16:57:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDQyMzQyNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDg5NjE0OQ==", "url": "https://github.com/apache/beam/pull/12516#discussion_r470896149", "bodyText": "keep='first' as well?", "author": "tysonjh", "createdAt": "2020-08-14T22:51:17Z", "path": "sdks/python/apache_beam/dataframe/pandas_doctests_test.py", "diffHunk": "@@ -43,6 +43,13 @@ def test_dataframe_tests(self):\n             'pandas.core.frame.DataFrame.itertuples': ['*'],\n             'pandas.core.frame.DataFrame.iterrows': ['*'],\n             'pandas.core.frame.DataFrame.iteritems': ['*'],\n+            'pandas.core.frame.DataFrame.nlargest': [\n+                \"df.nlargest(3, 'population', keep='last')\"", "originalCommit": "5c9288bcab2cf4e9ba557ec29e880f7fbb00ce21", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzE4MzY0Mw==", "url": "https://github.com/apache/beam/pull/12516#discussion_r473183643", "bodyText": "This is skipping a specific test that exists in the docstring.", "author": "robertwb", "createdAt": "2020-08-19T16:58:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDg5NjE0OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDg5ODYzMw==", "url": "https://github.com/apache/beam/pull/12516#discussion_r470898633", "bodyText": "'first' here too?", "author": "tysonjh", "createdAt": "2020-08-14T23:02:57Z", "path": "sdks/python/apache_beam/dataframe/pandas_doctests_test.py", "diffHunk": "@@ -121,6 +130,12 @@ def test_series_tests(self):\n             'pandas.core.series.Series.cumsum': ['*'],\n             'pandas.core.series.Series.cumprod': ['*'],\n             'pandas.core.series.Series.diff': ['*'],\n+            'pandas.core.series.Series.nlargest': [\n+                \"s.nlargest(3, keep='last')\"", "originalCommit": "5c9288bcab2cf4e9ba557ec29e880f7fbb00ce21", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzE4MzgxMg==", "url": "https://github.com/apache/beam/pull/12516#discussion_r473183812", "bodyText": "Same.", "author": "robertwb", "createdAt": "2020-08-19T16:58:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDg5ODYzMw=="}], "type": "inlineReview"}, {"oid": "59a1e9c941af511c5c7bb72ccbe44afd57525941", "url": "https://github.com/apache/beam/commit/59a1e9c941af511c5c7bb72ccbe44afd57525941", "message": "Reviewer comments.", "committedDate": "2020-08-19T16:59:30Z", "type": "commit"}, {"oid": "c428768186cf70789b38b51fd153d35c594cc944", "url": "https://github.com/apache/beam/commit/c428768186cf70789b38b51fd153d35c594cc944", "message": "Merge branch 'master' into dataframes-top-join-merge", "committedDate": "2020-08-19T17:03:43Z", "type": "commit"}, {"oid": "8a020e53317403f98943a2d88a92d62801a66fb2", "url": "https://github.com/apache/beam/commit/8a020e53317403f98943a2d88a92d62801a66fb2", "message": "fix merge", "committedDate": "2020-08-19T17:06:06Z", "type": "commit"}]}