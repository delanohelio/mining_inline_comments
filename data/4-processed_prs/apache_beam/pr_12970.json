{"pr_number": 12970, "pr_title": "[BEAM-8024] Add dataflow and flink runner to JPMS test", "pr_createdAt": "2020-09-29T22:55:44Z", "pr_url": "https://github.com/apache/beam/pull/12970", "timeline": [{"oid": "615d5093c9018bd039c196e458e3fc0af5c74208", "url": "https://github.com/apache/beam/commit/615d5093c9018bd039c196e458e3fc0af5c74208", "message": "Add e2e word count test for jpms", "committedDate": "2020-09-18T23:47:32Z", "type": "commit"}, {"oid": "388756f70c51c8cea45f3a749512b55fa41f4d5a", "url": "https://github.com/apache/beam/commit/388756f70c51c8cea45f3a749512b55fa41f4d5a", "message": "remove comments", "committedDate": "2020-09-19T00:02:06Z", "type": "commit"}, {"oid": "ce1f5e6c46b87aa4f8c6538e8a1c07560c04875e", "url": "https://github.com/apache/beam/commit/ce1f5e6c46b87aa4f8c6538e8a1c07560c04875e", "message": "formatting", "committedDate": "2020-09-19T00:12:37Z", "type": "commit"}, {"oid": "7e2385f4075807b10a0a16eb3279351f046577c5", "url": "https://github.com/apache/beam/commit/7e2385f4075807b10a0a16eb3279351f046577c5", "message": "Merge branch 'master' of github.com:apache/beam into beam-8024-jpms", "committedDate": "2020-09-21T21:30:37Z", "type": "commit"}, {"oid": "ef79bb9a32d6a854944922dd19da92f5dc831b49", "url": "https://github.com/apache/beam/commit/ef79bb9a32d6a854944922dd19da92f5dc831b49", "message": "formatting", "committedDate": "2020-09-21T21:35:18Z", "type": "commit"}, {"oid": "c262005c3254dc44697e6642df287ff0e1f263c4", "url": "https://github.com/apache/beam/commit/c262005c3254dc44697e6642df287ff0e1f263c4", "message": "add new jenkins job", "committedDate": "2020-09-22T17:35:15Z", "type": "commit"}, {"oid": "00b01ff0daf3aec5950287f7efd9a57db8063954", "url": "https://github.com/apache/beam/commit/00b01ff0daf3aec5950287f7efd9a57db8063954", "message": "move into separate job", "committedDate": "2020-09-22T19:07:33Z", "type": "commit"}, {"oid": "622084290126cb36bc30611de23640e7a8630ee9", "url": "https://github.com/apache/beam/commit/622084290126cb36bc30611de23640e7a8630ee9", "message": "fix precommit", "committedDate": "2020-09-22T21:04:15Z", "type": "commit"}, {"oid": "7f16e30b9ad7e3e6bbac8a34391f8117a0e12840", "url": "https://github.com/apache/beam/commit/7f16e30b9ad7e3e6bbac8a34391f8117a0e12840", "message": "Merge branch 'master' of github.com:apache/beam into beam-8024-jpms", "committedDate": "2020-09-22T22:03:32Z", "type": "commit"}, {"oid": "6060f926f58df3edbb279a9d0603f5fcd0730f9a", "url": "https://github.com/apache/beam/commit/6060f926f58df3edbb279a9d0603f5fcd0730f9a", "message": "format, skip all tests if jdk < 8", "committedDate": "2020-09-22T23:12:34Z", "type": "commit"}, {"oid": "bc6f9b9cf2c105fe69290c6e89b768bb2cf3fe3c", "url": "https://github.com/apache/beam/commit/bc6f9b9cf2c105fe69290c6e89b768bb2cf3fe3c", "message": "Merge branch 'master' of github.com:apache/beam into beam-8024-jpms", "committedDate": "2020-09-23T19:10:13Z", "type": "commit"}, {"oid": "60436c6707a11284a460437f8880fd7c81aee026", "url": "https://github.com/apache/beam/commit/60436c6707a11284a460437f8880fd7c81aee026", "message": "run test on flink and dataflow runner", "committedDate": "2020-09-29T18:18:57Z", "type": "commit"}, {"oid": "4aa88f1a94ce12175f1715cd8c0139c550a15dcb", "url": "https://github.com/apache/beam/commit/4aa88f1a94ce12175f1715cd8c0139c550a15dcb", "message": "add job to readme", "committedDate": "2020-09-29T22:27:39Z", "type": "commit"}, {"oid": "f7945fcc59b60d764f2b4ee3775fcde95514cf30", "url": "https://github.com/apache/beam/commit/f7945fcc59b60d764f2b4ee3775fcde95514cf30", "message": "Merge branch 'master' of github.com:apache/beam into beam-8024-jpms", "committedDate": "2020-09-29T22:40:59Z", "type": "commit"}, {"oid": "5952ce14fc44742f210a22cc1424fd08088c3edf", "url": "https://github.com/apache/beam/commit/5952ce14fc44742f210a22cc1424fd08088c3edf", "message": "fix comment", "committedDate": "2020-09-29T22:53:02Z", "type": "commit"}, {"oid": "ac0c88c5df11e25791c586d6d4dddc93a3b2cc95", "url": "https://github.com/apache/beam/commit/ac0c88c5df11e25791c586d6d4dddc93a3b2cc95", "message": "remove fork", "committedDate": "2020-09-29T23:15:20Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzE0NDU2Mg==", "url": "https://github.com/apache/beam/pull/12970#discussion_r497144562", "bodyText": "Aesthetically, I dislike building code identifiers (or similar) by string concat. Pragmatically it makes it hard to search for them. But looping out these configs makes sense. What do you think about something like a map from configuration name to runner class.\ndef postCommitConfigurations = {\n   \"directRunnerPostCommit\" : \"org.apache.beam.runners.direct.DirectRunner\",\n   \"flinkRunnerPostCommit\" : \"org.apache.beam.runners.flink.TestFlinkRunner\"\n   \"dataflowRunnerPostCommit\" : \"org.apache.beam.runners.dataflow.TestDataflowRunner\"\n}", "author": "kennknowles", "createdAt": "2020-09-29T23:38:17Z", "path": "sdks/java/testing/jpms-tests/build.gradle", "diffHunk": "@@ -31,13 +34,66 @@ enableJavaPerformanceTesting()\n description = \"Apache Beam :: SDKs :: Java :: Testing :: JPMS Tests\"\n ext.summary = \"E2E test for Java 9 modules\"\n \n+/*\n+ * List of runners to run post commit tests on.\n+ */\n+def postCommitRunnerClass = [\n+        directRunner: \"org.apache.beam.runners.direct.DirectRunner\",\n+        flinkRunner: \"org.apache.beam.runners.flink.TestFlinkRunner\",\n+        dataflowRunner: \"org.apache.beam.runners.dataflow.TestDataflowRunner\",\n+]\n+for (String runner : postCommitRunnerClass.keySet()) {", "originalCommit": "ac0c88c5df11e25791c586d6d4dddc93a3b2cc95", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzE0NTIwOA==", "url": "https://github.com/apache/beam/pull/12970#discussion_r497145208", "bodyText": "Especially considering this bit, the looping over configuration doesn't really save you much. Could be simpler to just define 3 configs with very straightforward control flow and data flow.", "author": "kennknowles", "createdAt": "2020-09-29T23:39:10Z", "path": "sdks/java/testing/jpms-tests/build.gradle", "diffHunk": "@@ -31,13 +34,66 @@ enableJavaPerformanceTesting()\n description = \"Apache Beam :: SDKs :: Java :: Testing :: JPMS Tests\"\n ext.summary = \"E2E test for Java 9 modules\"\n \n+/*\n+ * List of runners to run post commit tests on.\n+ */\n+def postCommitRunnerClass = [\n+        directRunner: \"org.apache.beam.runners.direct.DirectRunner\",\n+        flinkRunner: \"org.apache.beam.runners.flink.TestFlinkRunner\",\n+        dataflowRunner: \"org.apache.beam.runners.dataflow.TestDataflowRunner\",\n+]\n+for (String runner : postCommitRunnerClass.keySet()) {\n+  configurations.create(runner + \"PostCommit\")\n+}\n+\n dependencies {\n   compile project(path: \":sdks:java:core\", configuration: \"shadow\")\n-  compile project(path: \":runners:direct-java\")\n   compile project(path: \":sdks:java:extensions:google-cloud-platform-core\")\n \n   testCompile library.java.junit\n   testCompile library.java.hamcrest_core\n+\n+  // Add dependencies for the PostCommit configurations\n+  // For each runner a project level dependency on the test project.\n+  for (String runner : postCommitRunnerClass.keySet()) {\n+    delegate.add(runner + \"PostCommit\", project(\":sdks:java:testing:jpms-tests\"))\n+    delegate.add(runner + \"PostCommit\", project(path: \":sdks:java:testing:jpms-tests\", configuration: \"testRuntime\"))\n+  }\n+  directRunnerPostCommit project(\":runners:direct-java\")", "originalCommit": "ac0c88c5df11e25791c586d6d4dddc93a3b2cc95", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzE0NTY5Mg==", "url": "https://github.com/apache/beam/pull/12970#discussion_r497145692", "bodyText": "putting a pin in the fact that this is largely independent of your change and applies cross module (no action required)", "author": "kennknowles", "createdAt": "2020-09-29T23:39:52Z", "path": "sdks/java/testing/jpms-tests/build.gradle", "diffHunk": "@@ -31,13 +34,66 @@ enableJavaPerformanceTesting()\n description = \"Apache Beam :: SDKs :: Java :: Testing :: JPMS Tests\"\n ext.summary = \"E2E test for Java 9 modules\"\n \n+/*\n+ * List of runners to run post commit tests on.\n+ */\n+def postCommitRunnerClass = [\n+        directRunner: \"org.apache.beam.runners.direct.DirectRunner\",\n+        flinkRunner: \"org.apache.beam.runners.flink.TestFlinkRunner\",\n+        dataflowRunner: \"org.apache.beam.runners.dataflow.TestDataflowRunner\",\n+]\n+for (String runner : postCommitRunnerClass.keySet()) {\n+  configurations.create(runner + \"PostCommit\")\n+}\n+\n dependencies {\n   compile project(path: \":sdks:java:core\", configuration: \"shadow\")\n-  compile project(path: \":runners:direct-java\")\n   compile project(path: \":sdks:java:extensions:google-cloud-platform-core\")\n \n   testCompile library.java.junit\n   testCompile library.java.hamcrest_core\n+\n+  // Add dependencies for the PostCommit configurations\n+  // For each runner a project level dependency on the test project.\n+  for (String runner : postCommitRunnerClass.keySet()) {\n+    delegate.add(runner + \"PostCommit\", project(\":sdks:java:testing:jpms-tests\"))\n+    delegate.add(runner + \"PostCommit\", project(path: \":sdks:java:testing:jpms-tests\", configuration: \"testRuntime\"))\n+  }\n+  directRunnerPostCommit project(\":runners:direct-java\")\n+  flinkRunnerPostCommit project(\":runners:flink:1.10\")\n+  dataflowRunnerPostCommit project(\":runners:google-cloud-dataflow-java\")\n+}\n+\n+/*\n+ * Create a ${runner}PostCommit task for each runner which runs a set\n+ * of integration tests for WordCount and WindowedWordCount.\n+ */\n+def gcpProject = project.findProperty('gcpProject') ?: 'apache-beam-testing'", "originalCommit": "ac0c88c5df11e25791c586d6d4dddc93a3b2cc95", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzE0OTE5NA==", "url": "https://github.com/apache/beam/pull/12970#discussion_r497149194", "bodyText": "This is a laudable instinct, but I actually don't favor it. Reasons:\n\nPrefer to separate test suites from when they may run\nRunners often have fairly different infrastructures to spin up and potentially blow memory if accidentally run together\nWe want separate signals about what is unhealthy.\n\nRegarding naming of a test suite \"postcommit\" I want to acknowledge that you are noticing how things are currently organized and following those conventions. So that's sensible. But it is a convention I think we have to move away from. Gradle can be run from lots of places and the notion of precommit vs postcommit is inessential.", "author": "kennknowles", "createdAt": "2020-09-29T23:44:40Z", "path": "sdks/java/testing/jpms-tests/build.gradle", "diffHunk": "@@ -31,13 +34,66 @@ enableJavaPerformanceTesting()\n description = \"Apache Beam :: SDKs :: Java :: Testing :: JPMS Tests\"\n ext.summary = \"E2E test for Java 9 modules\"\n \n+/*\n+ * List of runners to run post commit tests on.\n+ */\n+def postCommitRunnerClass = [\n+        directRunner: \"org.apache.beam.runners.direct.DirectRunner\",\n+        flinkRunner: \"org.apache.beam.runners.flink.TestFlinkRunner\",\n+        dataflowRunner: \"org.apache.beam.runners.dataflow.TestDataflowRunner\",\n+]\n+for (String runner : postCommitRunnerClass.keySet()) {\n+  configurations.create(runner + \"PostCommit\")\n+}\n+\n dependencies {\n   compile project(path: \":sdks:java:core\", configuration: \"shadow\")\n-  compile project(path: \":runners:direct-java\")\n   compile project(path: \":sdks:java:extensions:google-cloud-platform-core\")\n \n   testCompile library.java.junit\n   testCompile library.java.hamcrest_core\n+\n+  // Add dependencies for the PostCommit configurations\n+  // For each runner a project level dependency on the test project.\n+  for (String runner : postCommitRunnerClass.keySet()) {\n+    delegate.add(runner + \"PostCommit\", project(\":sdks:java:testing:jpms-tests\"))\n+    delegate.add(runner + \"PostCommit\", project(path: \":sdks:java:testing:jpms-tests\", configuration: \"testRuntime\"))\n+  }\n+  directRunnerPostCommit project(\":runners:direct-java\")\n+  flinkRunnerPostCommit project(\":runners:flink:1.10\")\n+  dataflowRunnerPostCommit project(\":runners:google-cloud-dataflow-java\")\n+}\n+\n+/*\n+ * Create a ${runner}PostCommit task for each runner which runs a set\n+ * of integration tests for WordCount and WindowedWordCount.\n+ */\n+def gcpProject = project.findProperty('gcpProject') ?: 'apache-beam-testing'\n+def gcpRegion = project.findProperty('gcpRegion') ?: 'us-central1'\n+def gcsTempRoot = project.findProperty('gcsTempRoot') ?: 'gs://temp-storage-for-end-to-end-tests/'\n+\n+for (String runner : postCommitRunnerClass.keySet()) {\n+  tasks.create(name: runner + \"PostCommit\", type: Test) {\n+    def postCommitBeamTestPipelineOptions = [\n+            \"--project=${gcpProject}\",\n+            \"--tempRoot=${gcsTempRoot}\",\n+            \"--runner=\" + postCommitRunnerClass[runner],\n+    ]\n+    if (\"dataflowRunner\".equals(runner)) {\n+      postCommitBeamTestPipelineOptions.add(\"--region=${gcpRegion}\")\n+    }\n+    classpath = configurations.\"${runner}PostCommit\"\n+    include \"**/*IT.class\"\n+    maxParallelForks 4\n+    systemProperty \"beamTestPipelineOptions\", JsonOutput.toJson(postCommitBeamTestPipelineOptions)\n+  }\n+}\n+\n+/* Define a common postcommit task which depends on all the individual postcommits. */", "originalCommit": "ac0c88c5df11e25791c586d6d4dddc93a3b2cc95", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Nzk2MjE4NA==", "url": "https://github.com/apache/beam/pull/12970#discussion_r497962184", "bodyText": "Makes sense, changed the post commit references to integration test", "author": "kileys", "createdAt": "2020-10-01T03:21:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzE0OTE5NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzE1MTE5Ng==", "url": "https://github.com/apache/beam/pull/12970#discussion_r497151196", "bodyText": "Noted below that coupling the various runners has some drawbacks. It is some boilerplate but can we factor it out into a few jobs: direct (candidate for precommit), flink (also candidate, but slower), dataflow (too slow for precommit).", "author": "kennknowles", "createdAt": "2020-09-29T23:47:27Z", "path": ".test-infra/jenkins/job_PostCommit_Java_Jpms_Java11.groovy", "diffHunk": "@@ -39,7 +39,7 @@ PostcommitJobBuilder.postCommitJob('beam_PostCommit_Java_Jpms_Java11', 'Run Jpms\n       steps {\n         gradle {\n           rootBuildScriptDir(commonJobProperties.checkoutDir)\n-          tasks(':sdks:java:testing:jpms-tests:integrationTest')\n+          tasks(':sdks:java:testing:jpms-tests:postCommit')", "originalCommit": "ac0c88c5df11e25791c586d6d4dddc93a3b2cc95", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "0d01cbdd18424a911b1b196849d30b0b437b2921", "url": "https://github.com/apache/beam/commit/0d01cbdd18424a911b1b196849d30b0b437b2921", "message": "add separate jobs, update build", "committedDate": "2020-10-01T03:18:19Z", "type": "commit"}, {"oid": "36f695987df4d2673ac96b8c9da9f9b69168d0eb", "url": "https://github.com/apache/beam/commit/36f695987df4d2673ac96b8c9da9f9b69168d0eb", "message": "spotlessApply", "committedDate": "2020-10-02T02:53:22Z", "type": "commit"}]}