{"pr_number": 13335, "pr_title": "[BEAM-10921]: Fix BEAM-10921 and underlying issues", "pr_createdAt": "2020-11-13T19:07:40Z", "pr_url": "https://github.com/apache/beam/pull/13335", "timeline": [{"oid": "d4a28b955f58263ca81c284c156b57ab20095383", "url": "https://github.com/apache/beam/commit/d4a28b955f58263ca81c284c156b57ab20095383", "message": "Fix BEAM-10921 and underlying issues", "committedDate": "2020-11-13T19:23:29Z", "type": "forcePushed"}, {"oid": "a9864ffb7f93e5e143c0e474e76d9c35d6453b18", "url": "https://github.com/apache/beam/commit/a9864ffb7f93e5e143c0e474e76d9c35d6453b18", "message": "Fix BEAM-10921 and underlying issues", "committedDate": "2020-11-13T19:41:56Z", "type": "forcePushed"}, {"oid": "4de80057c23304d1b9e4d7be01916d8519d5466c", "url": "https://github.com/apache/beam/commit/4de80057c23304d1b9e4d7be01916d8519d5466c", "message": "Fix BEAM-10921 and underlying issues", "committedDate": "2020-11-13T20:46:22Z", "type": "commit"}, {"oid": "4de80057c23304d1b9e4d7be01916d8519d5466c", "url": "https://github.com/apache/beam/commit/4de80057c23304d1b9e4d7be01916d8519d5466c", "message": "Fix BEAM-10921 and underlying issues", "committedDate": "2020-11-13T20:46:22Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDUxNjg3Ng==", "url": "https://github.com/apache/beam/pull/13335#discussion_r524516876", "bodyText": "LGTM, only one question:\nDoes the UserPipelineTracker clean up the user pipeline and their derived pipelines when a user pipeline is out of scope (e.g., deleted or garbage collected)? Or are the pipelines tracked never get garbage collected at all?\nIs there any side effect when the user uses an outdated pipeline ref or a new pipeline ref (from re-executions) that results in the same __hash__ or __eq__/in to be True? Will that give back a wrong user_pipeline when the tracker thinks the pipeline is tracked while it's not?", "author": "KevinGG", "createdAt": "2020-11-16T19:24:39Z", "path": "sdks/python/apache_beam/runners/interactive/interactive_environment.py", "diffHunk": "@@ -163,7 +165,8 @@ def __init__(self):\n     # the gRPC server serves.\n     self._test_stream_service_controllers = {}\n     self._cached_source_signature = {}\n-    self._tracked_user_pipelines = set()", "originalCommit": "4de80057c23304d1b9e4d7be01916d8519d5466c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTQ2MDI0Nw==", "url": "https://github.com/apache/beam/pull/13335#discussion_r525460247", "bodyText": "Ack, added eviction capabilities. The __hash__ value is based on the id of the object. If the user still has a ref to the pipeline then the hash will still be unique. Your latter paragraph probably wouldn't occur in that case.", "author": "rohdesamuel", "createdAt": "2020-11-17T19:55:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDUxNjg3Ng=="}], "type": "inlineReview"}, {"oid": "4821b16ade2fb4411eda0cd81bf20206c4620902", "url": "https://github.com/apache/beam/commit/4821b16ade2fb4411eda0cd81bf20206c4620902", "message": "Add eviction capabilities to the UserPipelineTracker", "committedDate": "2020-11-17T01:04:14Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODg4MzUyOQ==", "url": "https://github.com/apache/beam/pull/13335#discussion_r528883529", "bodyText": "nit: relies -> relies on", "author": "davidyan74", "createdAt": "2020-11-23T17:40:35Z", "path": "sdks/python/apache_beam/pipeline.py", "diffHunk": "@@ -504,10 +504,12 @@ def run(self, test_runner_api='AUTO'):\n       if test_runner_api == 'AUTO':\n         # Don't pay the cost of a round-trip if we're going to be going through\n         # the FnApi anyway...\n+        # The InteractiveRunner relies a constant pipeline reference, skip it.", "originalCommit": "4821b16ade2fb4411eda0cd81bf20206c4620902", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTg1NDQ5NA==", "url": "https://github.com/apache/beam/pull/13335#discussion_r529854494", "bodyText": "Done", "author": "rohdesamuel", "createdAt": "2020-11-24T20:21:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODg4MzUyOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODg4NDA2NQ==", "url": "https://github.com/apache/beam/pull/13335#discussion_r528884065", "bodyText": "Is there a better way for the runner to indicate it relies on a constant pipeline reference?", "author": "davidyan74", "createdAt": "2020-11-23T17:41:29Z", "path": "sdks/python/apache_beam/pipeline.py", "diffHunk": "@@ -504,10 +504,12 @@ def run(self, test_runner_api='AUTO'):\n       if test_runner_api == 'AUTO':\n         # Don't pay the cost of a round-trip if we're going to be going through\n         # the FnApi anyway...\n+        # The InteractiveRunner relies a constant pipeline reference, skip it.\n         test_runner_api = (\n             not self.runner.is_fnapi_compatible() and (\n                 self.runner.__class__.__name__ != 'SwitchingDirectRunner' or\n-                self._options.view_as(StandardOptions).streaming))\n+                self._options.view_as(StandardOptions).streaming) and\n+            self.runner.__class__.__name__ != 'InteractiveRunner')", "originalCommit": "4821b16ade2fb4411eda0cd81bf20206c4620902", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTg1NTQ1OA==", "url": "https://github.com/apache/beam/pull/13335#discussion_r529855458", "bodyText": "@TheNeuralBit what do you think? I was following the precedence of the SwitchingDirectRunner. The InteractiveRunner already does this check in its code in multiple places, so there wouldn't be a safety regression if this line is added.", "author": "rohdesamuel", "createdAt": "2020-11-24T20:23:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODg4NDA2NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTg4OTIxNw==", "url": "https://github.com/apache/beam/pull/13335#discussion_r529889217", "bodyText": "The SwitchingDirectRunner case is a little different since its checking for a specific case where that runner will use the Fn API.\nIf there's no way to avoid the need for a constant pipeline reference I think this is ok (I think we're getting rid of this roundtrip soon anyway), but let's break this into separate booleans for clarity, something like:\nis_fnapi_compatible = self.runner.is_fnapi_compatible() or (\n                # DirectRunner uses the Fn API for batch only\n                self.runner.__class__.__name__ == 'SwitchingDirectRunner' and\n                not self._options.view_as(StandardOptions).streaming)\n\ntest_runner_api = (not is_fn_api_compatible or \n                   self.runner.__class__.__name__ == 'InteractiveRunner')", "author": "TheNeuralBit", "createdAt": "2020-11-24T21:28:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODg4NDA2NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTk3MjY1Ng==", "url": "https://github.com/apache/beam/pull/13335#discussion_r529972656", "bodyText": "Done.", "author": "rohdesamuel", "createdAt": "2020-11-24T22:57:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODg4NDA2NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODg4NTAwMg==", "url": "https://github.com/apache/beam/pull/13335#discussion_r528885002", "bodyText": "Should we take this opportunity to update the name according to the new convention? e.g. \"background caching job\" -> \"background source recording job\". It's fine if you plan to do this in a later PR instead.", "author": "davidyan74", "createdAt": "2020-11-23T17:43:04Z", "path": "sdks/python/apache_beam/runners/interactive/background_caching_job.py", "diffHunk": "@@ -121,7 +121,8 @@ def state(self):\n       return self._pipeline_result.state\n \n \n-def attempt_to_run_background_caching_job(runner, user_pipeline, options=None):\n+def attempt_to_run_background_caching_job(", "originalCommit": "4821b16ade2fb4411eda0cd81bf20206c4620902", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTg1NDYzNA==", "url": "https://github.com/apache/beam/pull/13335#discussion_r529854634", "bodyText": "I can do a follow-up PR", "author": "rohdesamuel", "createdAt": "2020-11-24T20:21:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODg4NTAwMg=="}], "type": "inlineReview"}, {"oid": "77c0d49893a1b96e4be7a1ec4d4a9aacc18fd682", "url": "https://github.com/apache/beam/commit/77c0d49893a1b96e4be7a1ec4d4a9aacc18fd682", "message": "Fix grammar", "committedDate": "2020-11-24T20:20:46Z", "type": "commit"}, {"oid": "05525987b6b85e1ea97af79905b0dde4970b874d", "url": "https://github.com/apache/beam/commit/05525987b6b85e1ea97af79905b0dde4970b874d", "message": "Clean up logic", "committedDate": "2020-11-24T22:56:28Z", "type": "commit"}]}