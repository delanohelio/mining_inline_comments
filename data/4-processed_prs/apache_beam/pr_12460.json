{"pr_number": 12460, "pr_title": "[BEAM-10545] HtmlView module", "pr_createdAt": "2020-08-04T00:46:12Z", "pr_url": "https://github.com/apache/beam/pull/12460", "timeline": [{"oid": "5ae71f90512866fee7362171a86184fc78fc201b", "url": "https://github.com/apache/beam/commit/5ae71f90512866fee7362171a86184fc78fc201b", "message": "[BEAM-10545] HtmlView module\n\n1. Added a HtmlView module to render given HTML and execute given\n   scripts from the provider model.\n2. Integrated react framework to the jest testing framework and eslint.\n3. Added line length limit (80) to eslint and prettier. Note prettier's\n   printWidth is not a hard limit as max-len rule. Sometimes, the code\n   needs to be written in a specific way to meet both eslint and\n   prettier. An example, long strings (if not url) should be broken into\n   suitable pieces.\n4. The jlpm(yarn/npm) installations are:\n   jlpm add --dev react-dom @types/react-dom eslint-plugin-react\n5. @types/react is resoluted to the version bundled with jupyter\n   apputils.", "committedDate": "2020-08-04T18:34:32Z", "type": "commit"}, {"oid": "5ae71f90512866fee7362171a86184fc78fc201b", "url": "https://github.com/apache/beam/commit/5ae71f90512866fee7362171a86184fc78fc201b", "message": "[BEAM-10545] HtmlView module\n\n1. Added a HtmlView module to render given HTML and execute given\n   scripts from the provider model.\n2. Integrated react framework to the jest testing framework and eslint.\n3. Added line length limit (80) to eslint and prettier. Note prettier's\n   printWidth is not a hard limit as max-len rule. Sometimes, the code\n   needs to be written in a specific way to meet both eslint and\n   prettier. An example, long strings (if not url) should be broken into\n   suitable pieces.\n4. The jlpm(yarn/npm) installations are:\n   jlpm add --dev react-dom @types/react-dom eslint-plugin-react\n5. @types/react is resoluted to the version bundled with jupyter\n   apputils.", "committedDate": "2020-08-04T18:34:32Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTc2NDE4Ng==", "url": "https://github.com/apache/beam/pull/12460#discussion_r465764186", "bodyText": "nit I think it's generally preferred to use string[] for primitive array types.", "author": "prodonjs", "createdAt": "2020-08-05T14:22:33Z", "path": "sdks/python/apache_beam/runners/interactive/extensions/apache-beam-jupyterlab-sidepanel/src/common/HtmlView.tsx", "diffHunk": "@@ -0,0 +1,119 @@\n+// Licensed under the Apache License, Version 2.0 (the 'License'); you may not\n+// use this file except in compliance with the License. You may obtain a copy of\n+// the License at\n+//\n+//   http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing, software\n+// distributed under the License is distributed on an 'AS IS' BASIS, WITHOUT\n+// WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+// License for the specific language governing permissions and limitations under\n+// the License.\n+\n+import * as React from 'react';\n+\n+export interface IHtmlProvider {\n+  readonly html: string;\n+  readonly script: Array<string>;", "originalCommit": "5ae71f90512866fee7362171a86184fc78fc201b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODc3ODY0Nw==", "url": "https://github.com/apache/beam/pull/12460#discussion_r468778647", "bodyText": "Acked. Change all occurrences to string[].", "author": "KevinGG", "createdAt": "2020-08-11T18:25:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTc2NDE4Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTc2Njc2OQ==", "url": "https://github.com/apache/beam/pull/12460#discussion_r465766769", "bodyText": "Is this only included for test purposes? Or is there somewhere else that it's expected to be used.", "author": "prodonjs", "createdAt": "2020-08-05T14:25:56Z", "path": "sdks/python/apache_beam/runners/interactive/extensions/apache-beam-jupyterlab-sidepanel/src/common/HtmlView.tsx", "diffHunk": "@@ -0,0 +1,119 @@\n+// Licensed under the Apache License, Version 2.0 (the 'License'); you may not\n+// use this file except in compliance with the License. You may obtain a copy of\n+// the License at\n+//\n+//   http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing, software\n+// distributed under the License is distributed on an 'AS IS' BASIS, WITHOUT\n+// WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+// License for the specific language governing permissions and limitations under\n+// the License.\n+\n+import * as React from 'react';\n+\n+export interface IHtmlProvider {\n+  readonly html: string;\n+  readonly script: Array<string>;\n+}\n+\n+interface IHtmlViewProps {\n+  htmlProvider: IHtmlProvider;\n+}\n+\n+interface IHtmlViewState {\n+  innerHtml: string;\n+  script: Array<string>;\n+}\n+\n+/**\n+ * A common HTML viewing component that renders given HTML and executes scripts\n+ * from the given provider.\n+ */\n+export class HtmlView extends React.Component<IHtmlViewProps, IHtmlViewState> {\n+  constructor(props: IHtmlViewProps) {\n+    super(props);\n+    this.state = {\n+      innerHtml: props.htmlProvider.html,\n+      script: []\n+    };\n+  }\n+\n+  componentDidMount(): void {\n+    this._updateRenderTimerId = setInterval(() => this.updateRender(), 1000);\n+  }\n+\n+  componentWillUnmount(): void {\n+    clearInterval(this._updateRenderTimerId);\n+  }\n+\n+  updateRender(): void {\n+    const currentHtml = this.state.innerHtml;\n+    const htmlToUpdate = this.props.htmlProvider.html;\n+    const currentScript = this.state.script;\n+    const scriptToUpdate = [...this.props.htmlProvider.script];\n+    if (htmlToUpdate !== currentHtml) {\n+      this.setState({\n+        innerHtml: htmlToUpdate,\n+        // As long as the html is updated, clear the script state.\n+        script: []\n+      });\n+    }\n+    /* Depending on whether this iteration updates the html, the scripts\n+     * are executed differently.\n+     * Html updated: all scripts are new, start execution from index 0;\n+     * Html not updated: only newly added scripts need to be executed.\n+     */\n+    const currentScriptLength =\n+      htmlToUpdate === currentHtml ? currentScript.length : 0;\n+    if (scriptToUpdate.length > currentScriptLength) {\n+      this.setState(\n+        {\n+          script: scriptToUpdate\n+        },\n+        // Executes scripts once the state is updated.\n+        () => {\n+          for (let i = currentScriptLength; i < scriptToUpdate.length; ++i) {\n+            new Function(scriptToUpdate[i])();\n+          }\n+        }\n+      );\n+    }\n+  }\n+\n+  render(): React.ReactNode {\n+    return (\n+      // This injects raw HTML fetched from kernel into JSX.\n+      <div dangerouslySetInnerHTML={{ __html: this.state.innerHtml }} />\n+    );\n+  }\n+\n+  private _updateRenderTimerId: number;\n+}\n+\n+/**\n+ * Makes the browser support HTML import and import HTML from given hrefs if\n+ * any is given.\n+ *\n+ * Native HTML import has been deprecated by modern browsers. To support\n+ * importing reusable HTML templates, webcomponentsjs library is needed.\n+ * The given hrefs will be imported once the library is loaded.\n+ *\n+ * Note everything is appended to head and if there are duplicated HTML\n+ * imports, only the first one will take effect.\n+ */\n+export function importHtml(hrefs: Array<string>): void {", "originalCommit": "5ae71f90512866fee7362171a86184fc78fc201b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODc0MDI5MA==", "url": "https://github.com/apache/beam/pull/12460#discussion_r468740290", "bodyText": "This is needed when initializing the lumino Widget during activation of the extension.\nThe importHtml only needs to be invoked once.\nThe HTML we are targeting is the one used by PAIR-facets.\nOnce invoked, later in the view, those facets visualization sent back from the kernel could be rendered correctly.", "author": "KevinGG", "createdAt": "2020-08-11T17:18:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTc2Njc2OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTc2OTMwNw==", "url": "https://github.com/apache/beam/pull/12460#discussion_r465769307", "bodyText": "Haha as the property name suggests, this is definitely a risky operation from a security perspective since the markup being injected has the ability to run scripts in the user's context with access to whatever resources their credentials provide.\nIs there any alternative that could be considered? Could you create an <iframe> element and render the HTML there so that it's sandboxed? I don't have any fundamental objections to this as I don't know the full context, bu  I know this type of thing has been looked upon with significant concern by our internal security reviewers and has implications for us being able to include certain types of extensions in our enterprise product.", "author": "prodonjs", "createdAt": "2020-08-05T14:29:25Z", "path": "sdks/python/apache_beam/runners/interactive/extensions/apache-beam-jupyterlab-sidepanel/src/common/HtmlView.tsx", "diffHunk": "@@ -0,0 +1,119 @@\n+// Licensed under the Apache License, Version 2.0 (the 'License'); you may not\n+// use this file except in compliance with the License. You may obtain a copy of\n+// the License at\n+//\n+//   http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing, software\n+// distributed under the License is distributed on an 'AS IS' BASIS, WITHOUT\n+// WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+// License for the specific language governing permissions and limitations under\n+// the License.\n+\n+import * as React from 'react';\n+\n+export interface IHtmlProvider {\n+  readonly html: string;\n+  readonly script: Array<string>;\n+}\n+\n+interface IHtmlViewProps {\n+  htmlProvider: IHtmlProvider;\n+}\n+\n+interface IHtmlViewState {\n+  innerHtml: string;\n+  script: Array<string>;\n+}\n+\n+/**\n+ * A common HTML viewing component that renders given HTML and executes scripts\n+ * from the given provider.\n+ */\n+export class HtmlView extends React.Component<IHtmlViewProps, IHtmlViewState> {\n+  constructor(props: IHtmlViewProps) {\n+    super(props);\n+    this.state = {\n+      innerHtml: props.htmlProvider.html,\n+      script: []\n+    };\n+  }\n+\n+  componentDidMount(): void {\n+    this._updateRenderTimerId = setInterval(() => this.updateRender(), 1000);\n+  }\n+\n+  componentWillUnmount(): void {\n+    clearInterval(this._updateRenderTimerId);\n+  }\n+\n+  updateRender(): void {\n+    const currentHtml = this.state.innerHtml;\n+    const htmlToUpdate = this.props.htmlProvider.html;\n+    const currentScript = this.state.script;\n+    const scriptToUpdate = [...this.props.htmlProvider.script];\n+    if (htmlToUpdate !== currentHtml) {\n+      this.setState({\n+        innerHtml: htmlToUpdate,\n+        // As long as the html is updated, clear the script state.\n+        script: []\n+      });\n+    }\n+    /* Depending on whether this iteration updates the html, the scripts\n+     * are executed differently.\n+     * Html updated: all scripts are new, start execution from index 0;\n+     * Html not updated: only newly added scripts need to be executed.\n+     */\n+    const currentScriptLength =\n+      htmlToUpdate === currentHtml ? currentScript.length : 0;\n+    if (scriptToUpdate.length > currentScriptLength) {\n+      this.setState(\n+        {\n+          script: scriptToUpdate\n+        },\n+        // Executes scripts once the state is updated.\n+        () => {\n+          for (let i = currentScriptLength; i < scriptToUpdate.length; ++i) {\n+            new Function(scriptToUpdate[i])();\n+          }\n+        }\n+      );\n+    }\n+  }\n+\n+  render(): React.ReactNode {\n+    return (\n+      // This injects raw HTML fetched from kernel into JSX.\n+      <div dangerouslySetInnerHTML={{ __html: this.state.innerHtml }} />", "originalCommit": "5ae71f90512866fee7362171a86184fc78fc201b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODc2NDI3Ng==", "url": "https://github.com/apache/beam/pull/12460#discussion_r468764276", "bodyText": "Yeah, it sounds scary :)\ndangerouslySetInnerHTML is React's replacement for innerHTML in the browser DOM.\nAnd the warning about using innerHTML is here. iframe has similar concerns.\nAll these concerns are about serving HTML from another domain that might contain malicious code.\nHere I think it's a valid use case because the HTML and scripts are returned from the kernel generated by the SDK as the user executes codes in their notebooks. They are known and trusted.\nThe purpose of this module is to render the generated visualization. Whether using dangerouslySetInnerHTML or iframe, to serve the purpose, the HTML has to be rendered and the scripts have to be executed. In the end, either way would do the same thing.\nThe security concern is similar to whether a notebook should execute scripts in an opened ipynb file. By default, Jupyter only renders HTML in the ipynb file (stored as JSON text, identical to this module getting those JSON fields through kernel messaging) and does not execute any script unless the notebook is trusted. A notebook is only trusted after the user executes jupyter trust notebook.ipynb or after the user executes the notebook in a kernel (identical to the extension's usage).", "author": "KevinGG", "createdAt": "2020-08-11T17:59:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTc2OTMwNw=="}], "type": "inlineReview"}, {"oid": "213c2c72a0e1a0fd15460add10df81e6b6c9c542", "url": "https://github.com/apache/beam/commit/213c2c72a0e1a0fd15460add10df81e6b6c9c542", "message": "Use primitive string[] to replace Array<string> type", "committedDate": "2020-08-11T20:41:42Z", "type": "commit"}]}