{"pr_number": 13292, "pr_title": "[BEAM-10475]Add WithShardedKey variation of GroupIntoBatches transform in Python SDK.", "pr_createdAt": "2020-11-10T05:26:40Z", "pr_url": "https://github.com/apache/beam/pull/13292", "timeline": [{"oid": "eb4f057bd21111d7a39d4af1aef56f8e76c53afb", "url": "https://github.com/apache/beam/commit/eb4f057bd21111d7a39d4af1aef56f8e76c53afb", "message": "Add withShardedKey option to GroupIntoBatches transform in Python SSDK.", "committedDate": "2020-11-10T05:25:24Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTYzMTk1NA==", "url": "https://github.com/apache/beam/pull/13292#discussion_r525631954", "bodyText": "Should this be tagged experimental similar to the Java change?", "author": "aaltay", "createdAt": "2020-11-18T01:18:12Z", "path": "sdks/python/apache_beam/transforms/util.py", "diffHunk": "@@ -780,6 +783,48 @@ def expand(self, pcoll):\n             self.max_buffering_duration_secs,\n             self.clock))\n \n+  @typehints.with_input_types(Tuple[K, V])\n+  @typehints.with_output_types(Tuple[K, Iterable[V]])\n+  class WithShardedKey(PTransform):", "originalCommit": "eb4f057bd21111d7a39d4af1aef56f8e76c53afb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjMwNzEwMg==", "url": "https://github.com/apache/beam/pull/13292#discussion_r526307102", "bodyText": "Done.", "author": "nehsyc", "createdAt": "2020-11-18T17:59:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTYzMTk1NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTYzMjA4OQ==", "url": "https://github.com/apache/beam/pull/13292#discussion_r525632089", "bodyText": "How does this work? When/how runner does this load balancing?", "author": "aaltay", "createdAt": "2020-11-18T01:18:37Z", "path": "sdks/python/apache_beam/transforms/util.py", "diffHunk": "@@ -780,6 +783,48 @@ def expand(self, pcoll):\n             self.max_buffering_duration_secs,\n             self.clock))\n \n+  @typehints.with_input_types(Tuple[K, V])\n+  @typehints.with_output_types(Tuple[K, Iterable[V]])\n+  class WithShardedKey(PTransform):\n+    \"\"\"A GroupIntoBatches transform that outputs batched elements associated\n+    with sharded input keys.\n+\n+    The sharding is determined by the runner to balance the load during the", "originalCommit": "eb4f057bd21111d7a39d4af1aef56f8e76c53afb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjMwOTEzMQ==", "url": "https://github.com/apache/beam/pull/13292#discussion_r526309131", "bodyText": "In Dataflow, the load balancing is done inside Windmill during the shuffle before the GroupIntoBatchesDoFn. Basically Windmill can re-distribute the input element to different workers and assign them different shard ids accordingly.\nDifferent runner may choose different strategies by overriding the default implementation here. We will add the transform to the runner api (in follow-up PRs) so runners are able to recognize the transform and do something special if they want.", "author": "nehsyc", "createdAt": "2020-11-18T18:02:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTYzMjA4OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjMyNDQ1Nw==", "url": "https://github.com/apache/beam/pull/13292#discussion_r526324457", "bodyText": "For my understanding. So, windmill understands the coding for shardedkey and the implementation here is the default implementation for cases where runner does not do this overriding?\nIf this is correct, could you update the comment to explain this a bit more to the reader?", "author": "aaltay", "createdAt": "2020-11-18T18:27:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTYzMjA4OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjMzNDQ2Mw==", "url": "https://github.com/apache/beam/pull/13292#discussion_r526334463", "bodyText": "Yes that is totally correct. I updated the documentation. How does it sound now?", "author": "nehsyc", "createdAt": "2020-11-18T18:43:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTYzMjA4OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTYzMzMwNA==", "url": "https://github.com/apache/beam/pull/13292#discussion_r525633304", "bodyText": "Why is the process id needed?\nNote that there is only 1 python process per container, and since all containers start the same way it is very likely that pid for each python process in their own containers might even be the same.\nIf you need to distinguish per worker, you may need some concept of worker id (which does not exist in Beam).", "author": "aaltay", "createdAt": "2020-11-18T01:22:15Z", "path": "sdks/python/apache_beam/transforms/util.py", "diffHunk": "@@ -780,6 +783,48 @@ def expand(self, pcoll):\n             self.max_buffering_duration_secs,\n             self.clock))\n \n+  @typehints.with_input_types(Tuple[K, V])\n+  @typehints.with_output_types(Tuple[K, Iterable[V]])\n+  class WithShardedKey(PTransform):\n+    \"\"\"A GroupIntoBatches transform that outputs batched elements associated\n+    with sharded input keys.\n+\n+    The sharding is determined by the runner to balance the load during the\n+    execution time. By default, it spreads the input elements with the same key\n+    to all available threads executing the transform.\n+    \"\"\"\n+    def __init__(self, batch_size, max_buffering_duration_secs=None):\n+      \"\"\"Create a new GroupIntoBatches.WithShardedKey.\n+\n+      Arguments:\n+        batch_size: (required) How many elements should be in a batch\n+        max_buffering_duration_secs: (optional) How long in seconds at most an\n+          incomplete batch of elements is allowed to be buffered in the states.\n+          The duration must be a positive second duration and should be given as\n+          an int or float.\n+      \"\"\"\n+      self.batch_size = batch_size\n+\n+      if max_buffering_duration_secs is not None:\n+        assert max_buffering_duration_secs > 0, (\n+            'max buffering duration should be a positive value')\n+      self.max_buffering_duration_secs = max_buffering_duration_secs\n+\n+    _pid = os.getpid()", "originalCommit": "eb4f057bd21111d7a39d4af1aef56f8e76c53afb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjMxMDM2Ng==", "url": "https://github.com/apache/beam/pull/13292#discussion_r526310366", "bodyText": "I see. The pid is probably not a good choice then. I changed it to use uuid instead, analogous to the Java implementation:\n\n  \n    \n      beam/sdks/java/core/src/main/java/org/apache/beam/sdk/transforms/GroupIntoBatches.java\n    \n    \n         Line 96\n      in\n      a016ba5\n    \n    \n    \n    \n\n        \n          \n           private static final long uuid = UUID.randomUUID().getMostSignificantBits();", "author": "nehsyc", "createdAt": "2020-11-18T18:04:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTYzMzMwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjMyMzE5Mg==", "url": "https://github.com/apache/beam/pull/13292#discussion_r526323192", "bodyText": "Yes both UUID and making it analogous to Java are good ideas. For my understanding what is the purpose of this key selection? Are we trying to by default to keep key space equal to the size of whole set of threads across all workers?", "author": "aaltay", "createdAt": "2020-11-18T18:25:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTYzMzMwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjMzNDQ4Nw==", "url": "https://github.com/apache/beam/pull/13292#discussion_r526334487", "bodyText": "The parallelism of theGroupIntoBatchesDoFn is tied to the number of keys (due to the per-key state semantics and the implementation of keyed state management). So choosing one shard per key (i.e., without key sharding) effectively means that we can not have more parallelism than the number of input keys. We are trying to by default spread the input elements to all available threads across workers, which is definitely not ideal but slightly better than no sharding.", "author": "nehsyc", "createdAt": "2020-11-18T18:43:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTYzMzMwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjM1NjU3Ng==", "url": "https://github.com/apache/beam/pull/13292#discussion_r526356576", "bodyText": "Sounds good. The updated comment also better explains this.", "author": "aaltay", "createdAt": "2020-11-18T19:19:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTYzMzMwNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTYzMzU1Nw==", "url": "https://github.com/apache/beam/pull/13292#discussion_r525633557", "bodyText": "Maybe use key_value instead of x ?", "author": "aaltay", "createdAt": "2020-11-18T01:23:09Z", "path": "sdks/python/apache_beam/transforms/util.py", "diffHunk": "@@ -780,6 +783,48 @@ def expand(self, pcoll):\n             self.max_buffering_duration_secs,\n             self.clock))\n \n+  @typehints.with_input_types(Tuple[K, V])\n+  @typehints.with_output_types(Tuple[K, Iterable[V]])\n+  class WithShardedKey(PTransform):\n+    \"\"\"A GroupIntoBatches transform that outputs batched elements associated\n+    with sharded input keys.\n+\n+    The sharding is determined by the runner to balance the load during the\n+    execution time. By default, it spreads the input elements with the same key\n+    to all available threads executing the transform.\n+    \"\"\"\n+    def __init__(self, batch_size, max_buffering_duration_secs=None):\n+      \"\"\"Create a new GroupIntoBatches.WithShardedKey.\n+\n+      Arguments:\n+        batch_size: (required) How many elements should be in a batch\n+        max_buffering_duration_secs: (optional) How long in seconds at most an\n+          incomplete batch of elements is allowed to be buffered in the states.\n+          The duration must be a positive second duration and should be given as\n+          an int or float.\n+      \"\"\"\n+      self.batch_size = batch_size\n+\n+      if max_buffering_duration_secs is not None:\n+        assert max_buffering_duration_secs > 0, (\n+            'max buffering duration should be a positive value')\n+      self.max_buffering_duration_secs = max_buffering_duration_secs\n+\n+    _pid = os.getpid()\n+\n+    def expand(self, pcoll):\n+      sharded_pcoll = pcoll | Map(\n+          lambda x: (", "originalCommit": "eb4f057bd21111d7a39d4af1aef56f8e76c53afb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjMxMDM0OA==", "url": "https://github.com/apache/beam/pull/13292#discussion_r526310348", "bodyText": "Done", "author": "nehsyc", "createdAt": "2020-11-18T18:04:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTYzMzU1Nw=="}], "type": "inlineReview"}, {"oid": "8049676915563b3d38ae54b7bd833b98ebe3637c", "url": "https://github.com/apache/beam/commit/8049676915563b3d38ae54b7bd833b98ebe3637c", "message": "fix ShardedKey hash function", "committedDate": "2020-11-18T06:26:01Z", "type": "commit"}, {"oid": "d28d4dd619fdfa008e5a25b5db5adc34035a0cc7", "url": "https://github.com/apache/beam/commit/d28d4dd619fdfa008e5a25b5db5adc34035a0cc7", "message": "Change pid to uuid; address comments", "committedDate": "2020-11-18T18:06:59Z", "type": "commit"}, {"oid": "d28d4dd619fdfa008e5a25b5db5adc34035a0cc7", "url": "https://github.com/apache/beam/commit/d28d4dd619fdfa008e5a25b5db5adc34035a0cc7", "message": "Change pid to uuid; address comments", "committedDate": "2020-11-18T18:06:59Z", "type": "forcePushed"}, {"oid": "e2c96163afb80b90c5fd0024688241aa1be5c01e", "url": "https://github.com/apache/beam/commit/e2c96163afb80b90c5fd0024688241aa1be5c01e", "message": "Change documentation", "committedDate": "2020-11-18T18:44:12Z", "type": "commit"}]}