{"pr_number": 11060, "pr_title": "[BEAM-9454] Create Deduplication transform based on user timer/state", "pr_createdAt": "2020-03-05T22:31:03Z", "pr_url": "https://github.com/apache/beam/pull/11060", "timeline": [{"oid": "52db933e30d4dd2fd8bdf46e351bcdeda5f0e006", "url": "https://github.com/apache/beam/commit/52db933e30d4dd2fd8bdf46e351bcdeda5f0e006", "message": "[BEAM-9454] Add Deduplication PTransform", "committedDate": "2020-03-10T01:57:05Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTcyNjA0Mg==", "url": "https://github.com/apache/beam/pull/11060#discussion_r391726042", "bodyText": "The Python timer API seems primitive compared to the Java SDK\nUse a switch case for the three types:\nDEPENDENT_REAL_TIME\nREAL_TIME\nWATERMARK\nand throw an error otherwise since you won't know what to do.", "author": "lukecwik", "createdAt": "2020-03-12T16:05:39Z", "path": "sdks/python/apache_beam/runners/sdf_utils.py", "diffHunk": "@@ -244,3 +251,63 @@ def get_estimator_state(self):\n         return None\n \n     return _NoOpWatermarkEstimator()\n+\n+\n+class DeduplictaionWithinDuration(ptransform.PTransform):\n+  \"\"\" A PTransform which deduplicate input records over a time domain and\n+  threshold. Values in different windows will NOT be considered duplicates of\n+  each other. Deduplication is best effort.\n+\n+  The durations specified may impose memory and/or storage requirements within\n+  a runner and care might need to be used to ensure that the deduplication time\n+  limit is long enough to remove duplicates but short enough to not cause\n+  performance problems within a runner. Each runner may provide an optimized\n+  implementation of their choice using the deduplication time domain and\n+  threshold specified.\n+\n+  Does not preserve any order the input PCollection might have had.\n+  \"\"\"\n+  def __init__(\n+      self,\n+      time_domain=userstate.TimeDomain.REAL_TIME,\n+      duration=Duration(10 * 60)):\n+    self.time_domain = time_domain\n+    self.duration = duration\n+\n+  def _create_deduplicate_fn(self):\n+    timer_spec = userstate.TimerSpec('expiry_timer', self.time_domain)\n+    state_spec = userstate.BagStateSpec('seen', BooleanCoder())\n+    duration = self.duration\n+    domain = self.time_domain\n+\n+    class DeduplicationFn(DoFn):\n+      def process(\n+          self,\n+          element,\n+          ts=DoFn.TimestampParam,\n+          seen_state=DoFn.StateParam(state_spec),\n+          expiry_timer=DoFn.TimerParam(timer_spec)):\n+        if True not in seen_state.read():\n+          if domain is userstate.TimeDomain.REAL_TIME:", "originalCommit": "3657894e8369634fc403a1e444acd4c666915b2d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjAzNzU2OA==", "url": "https://github.com/apache/beam/pull/11060#discussion_r392037568", "bodyText": "Python timer only supports REAL_TIME  and WATERMARK . I changed it to checking the type of TimeDomain when constructing DeduplictaionWithinDuration.\nThe type is string so it's not switchable, and python doesn't have switch.", "author": "boyuanzz", "createdAt": "2020-03-13T05:33:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTcyNjA0Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjAzODA4NQ==", "url": "https://github.com/apache/beam/pull/11060#discussion_r392038085", "bodyText": "When writing this part, I think we should update user-face timer API in python to do similar thing as Java, which makes life easier a lot.", "author": "boyuanzz", "createdAt": "2020-03-13T05:35:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTcyNjA0Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTcyNzUyOQ==", "url": "https://github.com/apache/beam/pull/11060#discussion_r391727529", "bodyText": "I should have used a guard style statement in the Java implementation instead of nesting.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    if True not in seen_state.read():\n          \n          \n            \n                      if domain is userstate.TimeDomain.REAL_TIME:\n          \n          \n            \n                        expiry_timer.set(Timestamp.now() + duration)\n          \n          \n            \n                      else:\n          \n          \n            \n                        expiry_timer.set(ts + duration)\n          \n          \n            \n                      seen_state.add(True)\n          \n          \n            \n                      value, _ = element\n          \n          \n            \n                      yield value\n          \n          \n            \n                    if True in seen_state.read():\n          \n          \n            \n                      return\n          \n          \n            \n            \n          \n          \n            \n                    if domain is userstate.TimeDomain.REAL_TIME:\n          \n          \n            \n                      expiry_timer.set(Timestamp.now() + duration)\n          \n          \n            \n                    else:\n          \n          \n            \n                      expiry_timer.set(ts + duration)\n          \n          \n            \n                    seen_state.add(True)\n          \n          \n            \n                    value, _ = element\n          \n          \n            \n                    yield value", "author": "lukecwik", "createdAt": "2020-03-12T16:07:55Z", "path": "sdks/python/apache_beam/runners/sdf_utils.py", "diffHunk": "@@ -244,3 +251,63 @@ def get_estimator_state(self):\n         return None\n \n     return _NoOpWatermarkEstimator()\n+\n+\n+class DeduplictaionWithinDuration(ptransform.PTransform):\n+  \"\"\" A PTransform which deduplicate input records over a time domain and\n+  threshold. Values in different windows will NOT be considered duplicates of\n+  each other. Deduplication is best effort.\n+\n+  The durations specified may impose memory and/or storage requirements within\n+  a runner and care might need to be used to ensure that the deduplication time\n+  limit is long enough to remove duplicates but short enough to not cause\n+  performance problems within a runner. Each runner may provide an optimized\n+  implementation of their choice using the deduplication time domain and\n+  threshold specified.\n+\n+  Does not preserve any order the input PCollection might have had.\n+  \"\"\"\n+  def __init__(\n+      self,\n+      time_domain=userstate.TimeDomain.REAL_TIME,\n+      duration=Duration(10 * 60)):\n+    self.time_domain = time_domain\n+    self.duration = duration\n+\n+  def _create_deduplicate_fn(self):\n+    timer_spec = userstate.TimerSpec('expiry_timer', self.time_domain)\n+    state_spec = userstate.BagStateSpec('seen', BooleanCoder())\n+    duration = self.duration\n+    domain = self.time_domain\n+\n+    class DeduplicationFn(DoFn):\n+      def process(\n+          self,\n+          element,\n+          ts=DoFn.TimestampParam,\n+          seen_state=DoFn.StateParam(state_spec),\n+          expiry_timer=DoFn.TimerParam(timer_spec)):\n+        if True not in seen_state.read():\n+          if domain is userstate.TimeDomain.REAL_TIME:\n+            expiry_timer.set(Timestamp.now() + duration)\n+          else:\n+            expiry_timer.set(ts + duration)\n+          seen_state.add(True)\n+          value, _ = element\n+          yield value", "originalCommit": "3657894e8369634fc403a1e444acd4c666915b2d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjAzNzU5Nw==", "url": "https://github.com/apache/beam/pull/11060#discussion_r392037597", "bodyText": "Done.", "author": "boyuanzz", "createdAt": "2020-03-13T05:33:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTcyNzUyOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTcyODYwMg==", "url": "https://github.com/apache/beam/pull/11060#discussion_r391728602", "bodyText": "It would be useful to expose a keyed deduplication transform as the common implementation that all use internally so in the future we can turn into a well known URN and then runners could provide optimized deduplication transform implementations.\nWe want pipeline authors to use this transform and I think it should go into sdks/python/apache_beam/transforms/util.py or into a dedicated file such as sdks/python/apache_beam/transforms/ such as deduplicate.py.\nCC: @udim What do you think?", "author": "lukecwik", "createdAt": "2020-03-12T16:09:37Z", "path": "sdks/python/apache_beam/runners/sdf_utils.py", "diffHunk": "@@ -244,3 +251,63 @@ def get_estimator_state(self):\n         return None\n \n     return _NoOpWatermarkEstimator()\n+\n+\n+class DeduplictaionWithinDuration(ptransform.PTransform):", "originalCommit": "3657894e8369634fc403a1e444acd4c666915b2d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTk2MjY4OA==", "url": "https://github.com/apache/beam/pull/11060#discussion_r391962688", "bodyText": "I would prefer the second one: sdks/python/apache_beam/transforms/deduplicate.py", "author": "boyuanzz", "createdAt": "2020-03-12T23:49:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTcyODYwMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjAzNzY5NQ==", "url": "https://github.com/apache/beam/pull/11060#discussion_r392037695", "bodyText": "Moved transform to sdks/python/apache_beam/transforms/deduplicate.py", "author": "boyuanzz", "createdAt": "2020-03-13T05:34:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTcyODYwMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjM4NjIyMQ==", "url": "https://github.com/apache/beam/pull/11060#discussion_r392386221", "bodyText": "Unlike Java, we typically don't put transforms in their own module in Python. I would recommend putting it under an existing file such as transforms/util.py.", "author": "udim", "createdAt": "2020-03-13T17:58:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTcyODYwMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjQ2MTE1NQ==", "url": "https://github.com/apache/beam/pull/11060#discussion_r392461155", "bodyText": "Thanks Udi! Similar to watermark_estimators.py, I'm thinking about providing a collection of transforms for deduplicating purpose. Any reason that we don't put a group of similar transforms into one module?", "author": "boyuanzz", "createdAt": "2020-03-13T20:39:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTcyODYwMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjUxNDg4NQ==", "url": "https://github.com/apache/beam/pull/11060#discussion_r392514885", "bodyText": "No, no reason. Go ahead with using a separate file", "author": "udim", "createdAt": "2020-03-13T22:34:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTcyODYwMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTcyOTg1Mg==", "url": "https://github.com/apache/beam/pull/11060#discussion_r391729852", "bodyText": "Is test stream unsupported in these other setups?", "author": "lukecwik", "createdAt": "2020-03-12T16:11:33Z", "path": "sdks/python/apache_beam/runners/portability/fn_api_runner_test.py", "diffHunk": "@@ -1250,6 +1313,9 @@ def test_sdf_with_sdf_initiated_checkpointing(self):\n   def test_sdf_with_watermark_tracking(self):\n     raise unittest.SkipTest(\"This test is for a single worker only.\")\n \n+  def test_deduplication_transform_with_processing_time(self):\n+    raise unittest.SkipTest(\"This test is for a single worker only.\")", "originalCommit": "3657894e8369634fc403a1e444acd4c666915b2d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTk2Mjc4MA==", "url": "https://github.com/apache/beam/pull/11060#discussion_r391962780", "bodyText": "No, I don't think so.", "author": "boyuanzz", "createdAt": "2020-03-12T23:49:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTcyOTg1Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTc0MDYwOA==", "url": "https://github.com/apache/beam/pull/11060#discussion_r391740608", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              \"\"\" A PTransform which deduplicate input records over a time domain and\n          \n          \n            \n              \"\"\" A PTransform which deduplicates input records over a time domain and", "author": "lukecwik", "createdAt": "2020-03-12T16:27:42Z", "path": "sdks/python/apache_beam/runners/sdf_utils.py", "diffHunk": "@@ -244,3 +251,63 @@ def get_estimator_state(self):\n         return None\n \n     return _NoOpWatermarkEstimator()\n+\n+\n+class DeduplictaionWithinDuration(ptransform.PTransform):\n+  \"\"\" A PTransform which deduplicate input records over a time domain and", "originalCommit": "3657894e8369634fc403a1e444acd4c666915b2d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "c97572c6b41684abc63241f19ed67819f7b6d499", "url": "https://github.com/apache/beam/commit/c97572c6b41684abc63241f19ed67819f7b6d499", "message": "[BEAM-9454] Add Deduplication PTransform", "committedDate": "2020-03-14T02:58:49Z", "type": "forcePushed"}, {"oid": "68c44dc083dea1934294ba71e571dbe97c54e710", "url": "https://github.com/apache/beam/commit/68c44dc083dea1934294ba71e571dbe97c54e710", "message": "[BEAM-9454] Add Deduplication PTransform", "committedDate": "2020-03-17T18:06:38Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzk2ODMzOQ==", "url": "https://github.com/apache/beam/pull/11060#discussion_r393968339", "bodyText": "fn_api_runner_test primarily for testing primitives. I would put this in apache_beam.transforms.deduplicate_test (or util_test, if that's where we plan to move it).", "author": "robertwb", "createdAt": "2020-03-17T21:01:53Z", "path": "sdks/python/apache_beam/runners/portability/fn_api_runner_test.py", "diffHunk": "@@ -448,6 +449,42 @@ def is_buffered_correctly(actual):\n \n       assert_that(actual, is_buffered_correctly)\n \n+  def test_deduplication_transform_with_processing_time(self):", "originalCommit": "68c44dc083dea1934294ba71e571dbe97c54e710", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzk2ODg0Ng==", "url": "https://github.com/apache/beam/pull/11060#discussion_r393968846", "bodyText": "Generally we've been following the convention of importing modules rather than objects from modules. http://google.github.io/styleguide/pyguide.html#22-imports", "author": "robertwb", "createdAt": "2020-03-17T21:03:01Z", "path": "sdks/python/apache_beam/runners/portability/fn_api_runner_test.py", "diffHunk": "@@ -65,6 +65,7 @@\n from apache_beam.transforms import environments\n from apache_beam.transforms import userstate\n from apache_beam.transforms import window\n+from apache_beam.transforms.deduplicate import DeduplictaionWithinDuration", "originalCommit": "68c44dc083dea1934294ba71e571dbe97c54e710", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDAzNjgwNQ==", "url": "https://github.com/apache/beam/pull/11060#discussion_r394036805", "bodyText": "Thanks for the pointer!", "author": "boyuanzz", "createdAt": "2020-03-17T23:57:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzk2ODg0Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzk2OTQ2OQ==", "url": "https://github.com/apache/beam/pull/11060#discussion_r393969469", "bodyText": "IIRC, the FnApiRunner does respect timestamps. (Not sure about the Create transform though.)", "author": "robertwb", "createdAt": "2020-03-17T21:04:08Z", "path": "sdks/python/apache_beam/runners/portability/fn_api_runner_test.py", "diffHunk": "@@ -448,6 +449,42 @@ def is_buffered_correctly(actual):\n \n       assert_that(actual, is_buffered_correctly)\n \n+  def test_deduplication_transform_with_processing_time(self):\n+    # Note that current FnApiRunner doesn't respect either real timestamp.", "originalCommit": "68c44dc083dea1934294ba71e571dbe97c54e710", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzk3MDQ1NA==", "url": "https://github.com/apache/beam/pull/11060#discussion_r393970454", "bodyText": "The duplication of value_1 probably merits a comment.", "author": "robertwb", "createdAt": "2020-03-17T21:06:00Z", "path": "sdks/python/apache_beam/runners/portability/fn_api_runner_test.py", "diffHunk": "@@ -448,6 +449,42 @@ def is_buffered_correctly(actual):\n \n       assert_that(actual, is_buffered_correctly)\n \n+  def test_deduplication_transform_with_processing_time(self):\n+    # Note that current FnApiRunner doesn't respect either real timestamp.\n+    with self.create_pipeline() as p:\n+      inputs = [\n+          window.TimestampedValue('value_1', 1),\n+          window.TimestampedValue('value_1', 2),\n+          window.TimestampedValue('value_1', 3)\n+      ]\n+      actual = (\n+          p\n+          | beam.Create(inputs)\n+          | beam.WindowInto(window.FixedWindows(10))\n+          | DeduplictaionWithinDuration(duration=timestamp.Duration(5)))\n+      assert_that(actual, equal_to(['value_1']))\n+\n+  @unittest.skip('TestStream not yet supported')\n+  def test_deduplication_transform_with_event_time(self):\n+    test_stream = (\n+        TestStream().advance_watermark_to(0).add_elements([\n+            window.TimestampedValue('value_1', 1),\n+            window.TimestampedValue('value_1', 2),\n+            window.TimestampedValue('value_1', 10)\n+        ]).advance_watermark_to(10).add_elements([\n+            window.TimestampedValue('value_1', 6)\n+        ]).add_elements([window.TimestampedValue('value_2', 15)\n+                         ]).advance_watermark_to_infinity())\n+\n+    with self.create_pipeline() as p:\n+      actual = (\n+          p\n+          | test_stream\n+          | DeduplictaionWithinDuration(\n+              duration=timestamp.Duration(10),\n+              time_domain=userstate.TimeDomain.WATERMARK))\n+      assert_that(actual, equal_to(['value_1', 'value_1', 'value_2']))", "originalCommit": "68c44dc083dea1934294ba71e571dbe97c54e710", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzk3Mjc4NA==", "url": "https://github.com/apache/beam/pull/11060#discussion_r393972784", "bodyText": "PTransform names are generally verbs. Perhaps just call this Deduplicate. The duration argument would typically be part of the constructor, e.g. Deduplicate(duration=...), so wouldn't need to be repeated in the name.", "author": "robertwb", "createdAt": "2020-03-17T21:10:37Z", "path": "sdks/python/apache_beam/transforms/deduplicate.py", "diffHunk": "@@ -0,0 +1,108 @@\n+#\n+# Licensed to the Apache Software Foundation (ASF) under one or more\n+# contributor license agreements.  See the NOTICE file distributed with\n+# this work for additional information regarding copyright ownership.\n+# The ASF licenses this file to You under the Apache License, Version 2.0\n+# (the \"License\"); you may not use this file except in compliance with\n+# the License.  You may obtain a copy of the License at\n+#\n+#    http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+#\n+\n+# pytype: skip-file\n+\n+\"\"\"a collection of ptransforms for deduplicating elements.\"\"\"\n+\n+from __future__ import absolute_import\n+from __future__ import division\n+\n+from apache_beam.coders.coders import BooleanCoder\n+from apache_beam.transforms import ptransform\n+from apache_beam.transforms import userstate\n+from apache_beam.transforms.core import DoFn\n+from apache_beam.transforms.core import Map\n+from apache_beam.transforms.core import ParDo\n+from apache_beam.transforms.timeutil import TimeDomain\n+from apache_beam.typehints import trivial_inference\n+from apache_beam.utils.timestamp import Duration\n+from apache_beam.utils.timestamp import Timestamp\n+\n+__all__ = [\n+    'DeduplictaionWithinDuration',\n+]\n+\n+\n+class DeduplictaionWithinDuration(ptransform.PTransform):", "originalCommit": "68c44dc083dea1934294ba71e571dbe97c54e710", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzk3NDY3Ng==", "url": "https://github.com/apache/beam/pull/11060#discussion_r393974676", "bodyText": "I would make duration a required parameter; I don't think there's a good default we can pick for all pipelines. (This also allows us to have a more intelligent default in the future, e.g. dynamically based on the actual watermark/propagation delay in the pipeline.)\nAlso, is it not possible to have both a real and watermark delay? This API forces you to do one or the other.", "author": "robertwb", "createdAt": "2020-03-17T21:14:35Z", "path": "sdks/python/apache_beam/transforms/deduplicate.py", "diffHunk": "@@ -0,0 +1,108 @@\n+#\n+# Licensed to the Apache Software Foundation (ASF) under one or more\n+# contributor license agreements.  See the NOTICE file distributed with\n+# this work for additional information regarding copyright ownership.\n+# The ASF licenses this file to You under the Apache License, Version 2.0\n+# (the \"License\"); you may not use this file except in compliance with\n+# the License.  You may obtain a copy of the License at\n+#\n+#    http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+#\n+\n+# pytype: skip-file\n+\n+\"\"\"a collection of ptransforms for deduplicating elements.\"\"\"\n+\n+from __future__ import absolute_import\n+from __future__ import division\n+\n+from apache_beam.coders.coders import BooleanCoder\n+from apache_beam.transforms import ptransform\n+from apache_beam.transforms import userstate\n+from apache_beam.transforms.core import DoFn\n+from apache_beam.transforms.core import Map\n+from apache_beam.transforms.core import ParDo\n+from apache_beam.transforms.timeutil import TimeDomain\n+from apache_beam.typehints import trivial_inference\n+from apache_beam.utils.timestamp import Duration\n+from apache_beam.utils.timestamp import Timestamp\n+\n+__all__ = [\n+    'DeduplictaionWithinDuration',\n+]\n+\n+\n+class DeduplictaionWithinDuration(ptransform.PTransform):\n+  \"\"\" A PTransform which deduplicates input records over a time domain and\n+  threshold. Values in different windows will NOT be considered duplicates of\n+  each other. Deduplication is best effort.\n+\n+  The durations specified may impose memory and/or storage requirements within\n+  a runner and care might need to be used to ensure that the deduplication time\n+  limit is long enough to remove duplicates but short enough to not cause\n+  performance problems within a runner. Each runner may provide an optimized\n+  implementation of their choice using the deduplication time domain and\n+  threshold specified.\n+\n+  Does not preserve any order the input PCollection might have had.\n+  \"\"\"\n+  def __init__(\n+      self, time_domain=TimeDomain.REAL_TIME, duration=Duration(10 * 60)):", "originalCommit": "68c44dc083dea1934294ba71e571dbe97c54e710", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDAyNTk4OA==", "url": "https://github.com/apache/beam/pull/11060#discussion_r394025988", "bodyText": "Also, is it not possible to have both a real and watermark delay? This API forces you to do one or the other.\n\nCurrently the API only allows either watermark based or walltime based.  I'm not sure what kind of strategy we can do if allowing both. Do we want to do no matter which fires first, just clear another?", "author": "boyuanzz", "createdAt": "2020-03-17T23:21:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzk3NDY3Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzk3NjM5OA==", "url": "https://github.com/apache/beam/pull/11060#discussion_r393976398", "bodyText": "I would expose a DeduplicatePerKey transform which emits a single KV per key, and then have the generic Deduplicate build on that.", "author": "robertwb", "createdAt": "2020-03-17T21:18:00Z", "path": "sdks/python/apache_beam/transforms/deduplicate.py", "diffHunk": "@@ -0,0 +1,108 @@\n+#\n+# Licensed to the Apache Software Foundation (ASF) under one or more\n+# contributor license agreements.  See the NOTICE file distributed with\n+# this work for additional information regarding copyright ownership.\n+# The ASF licenses this file to You under the Apache License, Version 2.0\n+# (the \"License\"); you may not use this file except in compliance with\n+# the License.  You may obtain a copy of the License at\n+#\n+#    http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+#\n+\n+# pytype: skip-file\n+\n+\"\"\"a collection of ptransforms for deduplicating elements.\"\"\"\n+\n+from __future__ import absolute_import\n+from __future__ import division\n+\n+from apache_beam.coders.coders import BooleanCoder\n+from apache_beam.transforms import ptransform\n+from apache_beam.transforms import userstate\n+from apache_beam.transforms.core import DoFn\n+from apache_beam.transforms.core import Map\n+from apache_beam.transforms.core import ParDo\n+from apache_beam.transforms.timeutil import TimeDomain\n+from apache_beam.typehints import trivial_inference\n+from apache_beam.utils.timestamp import Duration\n+from apache_beam.utils.timestamp import Timestamp\n+\n+__all__ = [\n+    'DeduplictaionWithinDuration',\n+]\n+\n+\n+class DeduplictaionWithinDuration(ptransform.PTransform):\n+  \"\"\" A PTransform which deduplicates input records over a time domain and\n+  threshold. Values in different windows will NOT be considered duplicates of\n+  each other. Deduplication is best effort.\n+\n+  The durations specified may impose memory and/or storage requirements within\n+  a runner and care might need to be used to ensure that the deduplication time\n+  limit is long enough to remove duplicates but short enough to not cause\n+  performance problems within a runner. Each runner may provide an optimized\n+  implementation of their choice using the deduplication time domain and\n+  threshold specified.\n+\n+  Does not preserve any order the input PCollection might have had.\n+  \"\"\"\n+  def __init__(\n+      self, time_domain=TimeDomain.REAL_TIME, duration=Duration(10 * 60)):\n+    if time_domain not in (TimeDomain.WATERMARK, TimeDomain.REAL_TIME):\n+      raise ValueError(\n+          'Unsupported TimeDomain: %r. DeduplictaionWithinDuration'\n+          'expects TimeDomain.WATERMARK or TimeDomain.REAL_TIME' %\n+          (time_domain, ))\n+    self.time_domain = time_domain\n+    self.duration = duration\n+\n+  def _create_deduplicate_fn(self):\n+    timer_spec = userstate.TimerSpec('expiry_timer', self.time_domain)\n+    state_spec = userstate.BagStateSpec('seen', BooleanCoder())\n+    duration = self.duration\n+    domain = self.time_domain\n+\n+    class DeduplicationFn(DoFn):\n+      def process(\n+          self,\n+          element,\n+          ts=DoFn.TimestampParam,\n+          seen_state=DoFn.StateParam(state_spec),\n+          expiry_timer=DoFn.TimerParam(timer_spec)):\n+        if True in seen_state.read():\n+          return\n+\n+        if domain == TimeDomain.REAL_TIME:\n+          expiry_timer.set(Timestamp.now() + duration)\n+        elif domain == TimeDomain.WATERMARK:\n+          expiry_timer.set(ts + duration)\n+        else:\n+          raise ValueError(\n+              'Unsupported TimeDomain: %r. DeduplictaionWithinDuration'\n+              'expects TimeDomain.WATERMARK or TimeDomain.REAL_TIME' %\n+              (domain, ))\n+        seen_state.add(True)\n+        value, _ = element\n+        yield value\n+\n+      def infer_output_type(self, input_type):\n+        key_type, _ = trivial_inference.key_value_types(input_type)\n+        return key_type\n+\n+      @userstate.on_timer(timer_spec)\n+      def process_timer(self, seen_state=DoFn.StateParam(state_spec)):\n+        seen_state.clear()\n+\n+    return DeduplicationFn()\n+\n+  def expand(self, pcoll):\n+    return (\n+        pcoll\n+        | 'KeyByElement' >> Map(lambda x: (x, None))\n+        | 'DeduplicateFn' >> ParDo(self._create_deduplicate_fn()))", "originalCommit": "68c44dc083dea1934294ba71e571dbe97c54e710", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDAyNjk4NQ==", "url": "https://github.com/apache/beam/pull/11060#discussion_r394026985", "bodyText": "Are you suggesting that we provide both DeduplicatePerKey and Deduplicate which uses value as key?", "author": "boyuanzz", "createdAt": "2020-03-17T23:25:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzk3NjM5OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzk3ODMyOA==", "url": "https://github.com/apache/beam/pull/11060#discussion_r393978328", "bodyText": "Suppose one has values with timestamps 10, 1, 12, and duration 10. This will not properly deduplicate because the timer will fire at 11 clearing state before 12 gets seen.", "author": "robertwb", "createdAt": "2020-03-17T21:22:12Z", "path": "sdks/python/apache_beam/transforms/deduplicate.py", "diffHunk": "@@ -0,0 +1,108 @@\n+#\n+# Licensed to the Apache Software Foundation (ASF) under one or more\n+# contributor license agreements.  See the NOTICE file distributed with\n+# this work for additional information regarding copyright ownership.\n+# The ASF licenses this file to You under the Apache License, Version 2.0\n+# (the \"License\"); you may not use this file except in compliance with\n+# the License.  You may obtain a copy of the License at\n+#\n+#    http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+#\n+\n+# pytype: skip-file\n+\n+\"\"\"a collection of ptransforms for deduplicating elements.\"\"\"\n+\n+from __future__ import absolute_import\n+from __future__ import division\n+\n+from apache_beam.coders.coders import BooleanCoder\n+from apache_beam.transforms import ptransform\n+from apache_beam.transforms import userstate\n+from apache_beam.transforms.core import DoFn\n+from apache_beam.transforms.core import Map\n+from apache_beam.transforms.core import ParDo\n+from apache_beam.transforms.timeutil import TimeDomain\n+from apache_beam.typehints import trivial_inference\n+from apache_beam.utils.timestamp import Duration\n+from apache_beam.utils.timestamp import Timestamp\n+\n+__all__ = [\n+    'DeduplictaionWithinDuration',\n+]\n+\n+\n+class DeduplictaionWithinDuration(ptransform.PTransform):\n+  \"\"\" A PTransform which deduplicates input records over a time domain and\n+  threshold. Values in different windows will NOT be considered duplicates of\n+  each other. Deduplication is best effort.\n+\n+  The durations specified may impose memory and/or storage requirements within\n+  a runner and care might need to be used to ensure that the deduplication time\n+  limit is long enough to remove duplicates but short enough to not cause\n+  performance problems within a runner. Each runner may provide an optimized\n+  implementation of their choice using the deduplication time domain and\n+  threshold specified.\n+\n+  Does not preserve any order the input PCollection might have had.\n+  \"\"\"\n+  def __init__(\n+      self, time_domain=TimeDomain.REAL_TIME, duration=Duration(10 * 60)):\n+    if time_domain not in (TimeDomain.WATERMARK, TimeDomain.REAL_TIME):\n+      raise ValueError(\n+          'Unsupported TimeDomain: %r. DeduplictaionWithinDuration'\n+          'expects TimeDomain.WATERMARK or TimeDomain.REAL_TIME' %\n+          (time_domain, ))\n+    self.time_domain = time_domain\n+    self.duration = duration\n+\n+  def _create_deduplicate_fn(self):\n+    timer_spec = userstate.TimerSpec('expiry_timer', self.time_domain)\n+    state_spec = userstate.BagStateSpec('seen', BooleanCoder())\n+    duration = self.duration\n+    domain = self.time_domain\n+\n+    class DeduplicationFn(DoFn):\n+      def process(\n+          self,\n+          element,\n+          ts=DoFn.TimestampParam,\n+          seen_state=DoFn.StateParam(state_spec),\n+          expiry_timer=DoFn.TimerParam(timer_spec)):\n+        if True in seen_state.read():\n+          return\n+\n+        if domain == TimeDomain.REAL_TIME:\n+          expiry_timer.set(Timestamp.now() + duration)\n+        elif domain == TimeDomain.WATERMARK:\n+          expiry_timer.set(ts + duration)", "originalCommit": "68c44dc083dea1934294ba71e571dbe97c54e710", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDAyOTk2OA==", "url": "https://github.com/apache/beam/pull/11060#discussion_r394029968", "bodyText": "Are you talking about the watermark case? yes the timer will be fires when the watermark advance to 11 if the timer is set by the value with timestamp 1", "author": "boyuanzz", "createdAt": "2020-03-17T23:35:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzk3ODMyOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzk3ODU0Nw==", "url": "https://github.com/apache/beam/pull/11060#discussion_r393978547", "bodyText": "It's be a stronger test to add elements one at a time.", "author": "robertwb", "createdAt": "2020-03-17T21:22:43Z", "path": "sdks/python/apache_beam/runners/portability/fn_api_runner_test.py", "diffHunk": "@@ -448,6 +449,42 @@ def is_buffered_correctly(actual):\n \n       assert_that(actual, is_buffered_correctly)\n \n+  def test_deduplication_transform_with_processing_time(self):\n+    # Note that current FnApiRunner doesn't respect either real timestamp.\n+    with self.create_pipeline() as p:\n+      inputs = [\n+          window.TimestampedValue('value_1', 1),\n+          window.TimestampedValue('value_1', 2),\n+          window.TimestampedValue('value_1', 3)\n+      ]\n+      actual = (\n+          p\n+          | beam.Create(inputs)\n+          | beam.WindowInto(window.FixedWindows(10))\n+          | DeduplictaionWithinDuration(duration=timestamp.Duration(5)))\n+      assert_that(actual, equal_to(['value_1']))\n+\n+  @unittest.skip('TestStream not yet supported')\n+  def test_deduplication_transform_with_event_time(self):\n+    test_stream = (\n+        TestStream().advance_watermark_to(0).add_elements([\n+            window.TimestampedValue('value_1', 1),\n+            window.TimestampedValue('value_1', 2),\n+            window.TimestampedValue('value_1', 10)", "originalCommit": "68c44dc083dea1934294ba71e571dbe97c54e710", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "6df2be73a464516a3cd6faccd409e38a10856655", "url": "https://github.com/apache/beam/commit/6df2be73a464516a3cd6faccd409e38a10856655", "message": "Fix lint", "committedDate": "2020-03-18T18:38:42Z", "type": "forcePushed"}, {"oid": "166b8a85f3c5c62aa26f0a53b618977e0f1a2ae9", "url": "https://github.com/apache/beam/commit/166b8a85f3c5c62aa26f0a53b618977e0f1a2ae9", "message": "Address comments", "committedDate": "2020-03-19T17:51:14Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjY3NTk1NA==", "url": "https://github.com/apache/beam/pull/11060#discussion_r396675954", "bodyText": "Perhaps this should be a combining state?", "author": "robertwb", "createdAt": "2020-03-23T18:41:24Z", "path": "sdks/python/apache_beam/transforms/deduplicate.py", "diffHunk": "@@ -0,0 +1,133 @@\n+#\n+# Licensed to the Apache Software Foundation (ASF) under one or more\n+# contributor license agreements.  See the NOTICE file distributed with\n+# this work for additional information regarding copyright ownership.\n+# The ASF licenses this file to You under the Apache License, Version 2.0\n+# (the \"License\"); you may not use this file except in compliance with\n+# the License.  You may obtain a copy of the License at\n+#\n+#    http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+#\n+\n+# pytype: skip-file\n+\n+\"\"\"a collection of ptransforms for deduplicating elements.\"\"\"\n+\n+from __future__ import absolute_import\n+from __future__ import division\n+\n+import typing\n+\n+from apache_beam import typehints\n+from apache_beam.coders.coders import BooleanCoder\n+from apache_beam.transforms import core\n+from apache_beam.transforms import ptransform\n+from apache_beam.transforms import userstate\n+from apache_beam.transforms.timeutil import TimeDomain\n+from apache_beam.utils import timestamp\n+\n+__all__ = [\n+    'Deduplicate',\n+    'DeduplicatePerKey',\n+]\n+\n+K = typing.TypeVar('K')\n+V = typing.TypeVar('V')\n+\n+\n+@typehints.with_input_types(typing.Tuple[K, V])\n+@typehints.with_output_types(typing.Tuple[K, V])\n+class DeduplicatePerKey(ptransform.PTransform):\n+  \"\"\" A PTransform which deduplicates <key, value> pair over a time domain and\n+  threshold. Values in different windows will NOT be considered duplicates of\n+  each other. Deduplication is best effort.\n+\n+  The durations specified may impose memory and/or storage requirements within\n+  a runner and care might need to be used to ensure that the deduplication time\n+  limit is long enough to remove duplicates but short enough to not cause\n+  performance problems within a runner. Each runner may provide an optimized\n+  implementation of their choice using the deduplication time domain and\n+  threshold specified.\n+\n+  Does not preserve any order the input PCollection might have had.\n+  \"\"\"\n+  def __init__(self, processing_time_duration=None, event_time_duration=None):\n+    if processing_time_duration is None and event_time_duration is None:\n+      raise ValueError(\n+          'DeduplicatePerKey requires at lease provide either'\n+          'processing_time_duration or event_time_duration.')\n+    self.processing_time_duration = processing_time_duration\n+    self.event_time_duration = event_time_duration\n+\n+  def _create_deduplicate_fn(self):\n+    processing_timer_spec = userstate.TimerSpec(\n+        'processing_timer', TimeDomain.REAL_TIME)\n+    event_timer_spec = userstate.TimerSpec('event_timer', TimeDomain.WATERMARK)\n+    state_spec = userstate.BagStateSpec('seen', BooleanCoder())", "originalCommit": "51611d387b547ea8856f8502181c7567f9bba57b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njc0Nzc2OQ==", "url": "https://github.com/apache/beam/pull/11060#discussion_r396747769", "bodyText": "The seen_state is only set once per key during that duration. I'm not sure whether combining state is more suitable here. What do you think?", "author": "boyuanzz", "createdAt": "2020-03-23T20:49:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjY3NTk1NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTU1OTkwNg==", "url": "https://github.com/apache/beam/pull/11060#discussion_r399559906", "bodyText": "To follow up from what we discussed off-line, I think combining state semantically makes slightly more sense here, but as we're not adding to the state unless it's the first element there's no performance concerns, and I'm also fine with this as is.", "author": "robertwb", "createdAt": "2020-03-27T22:06:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjY3NTk1NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjY3NzI1NA==", "url": "https://github.com/apache/beam/pull/11060#discussion_r396677254", "bodyText": "Is it not possible to sickbay it for only dataflow?", "author": "robertwb", "createdAt": "2020-03-23T18:43:37Z", "path": "sdks/python/apache_beam/transforms/deduplicate_test.py", "diffHunk": "@@ -0,0 +1,168 @@\n+#\n+# Licensed to the Apache Software Foundation (ASF) under one or more\n+# contributor license agreements.  See the NOTICE file distributed with\n+# this work for additional information regarding copyright ownership.\n+# The ASF licenses this file to You under the Apache License, Version 2.0\n+# (the \"License\"); you may not use this file except in compliance with\n+# the License.  You may obtain a copy of the License at\n+#\n+#    http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+#\n+\n+# pytype: skip-file\n+\n+\"\"\"Unit tests for deduplicate transform by using TestStream.\"\"\"\n+\n+from __future__ import absolute_import\n+\n+import unittest\n+\n+from nose.plugins.attrib import attr\n+\n+import apache_beam as beam\n+from apache_beam.coders import coders\n+from apache_beam.testing.test_pipeline import TestPipeline\n+from apache_beam.testing.test_stream import TestStream\n+from apache_beam.testing.util import assert_that\n+from apache_beam.testing.util import equal_to\n+from apache_beam.testing.util import equal_to_per_window\n+from apache_beam.transforms import deduplicate\n+from apache_beam.transforms import window\n+from apache_beam.utils.timestamp import Duration\n+from apache_beam.utils.timestamp import Timestamp\n+\n+\n+# TestStream is only supported in streaming pipeline. The Deduplicate transform\n+# also requires Timer support. Sickbaying this testsuite until dataflow runner\n+# supports both TestStream and user timer.\n+@attr('ValidatesRunner', 'sickbay-batch', 'sickbay-streaming')", "originalCommit": "51611d387b547ea8856f8502181c7567f9bba57b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njc0MjA5Nw==", "url": "https://github.com/apache/beam/pull/11060#discussion_r396742097", "bodyText": "The  'sickbay-batch' and 'sickbay-streaming' is only used by dataflow suite now. And unfortunately, I don't we have runners supporting these python test now.", "author": "boyuanzz", "createdAt": "2020-03-23T20:38:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjY3NzI1NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjY4MDYyMg==", "url": "https://github.com/apache/beam/pull/11060#discussion_r396680622", "bodyText": "I might phrase this as \"Time durations are required so as to avoid unbounded memory and/or storage requirements on the runner...\"", "author": "robertwb", "createdAt": "2020-03-23T18:49:25Z", "path": "sdks/python/apache_beam/transforms/deduplicate.py", "diffHunk": "@@ -0,0 +1,133 @@\n+#\n+# Licensed to the Apache Software Foundation (ASF) under one or more\n+# contributor license agreements.  See the NOTICE file distributed with\n+# this work for additional information regarding copyright ownership.\n+# The ASF licenses this file to You under the Apache License, Version 2.0\n+# (the \"License\"); you may not use this file except in compliance with\n+# the License.  You may obtain a copy of the License at\n+#\n+#    http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+#\n+\n+# pytype: skip-file\n+\n+\"\"\"a collection of ptransforms for deduplicating elements.\"\"\"\n+\n+from __future__ import absolute_import\n+from __future__ import division\n+\n+import typing\n+\n+from apache_beam import typehints\n+from apache_beam.coders.coders import BooleanCoder\n+from apache_beam.transforms import core\n+from apache_beam.transforms import ptransform\n+from apache_beam.transforms import userstate\n+from apache_beam.transforms.timeutil import TimeDomain\n+from apache_beam.utils import timestamp\n+\n+__all__ = [\n+    'Deduplicate',\n+    'DeduplicatePerKey',\n+]\n+\n+K = typing.TypeVar('K')\n+V = typing.TypeVar('V')\n+\n+\n+@typehints.with_input_types(typing.Tuple[K, V])\n+@typehints.with_output_types(typing.Tuple[K, V])\n+class DeduplicatePerKey(ptransform.PTransform):\n+  \"\"\" A PTransform which deduplicates <key, value> pair over a time domain and\n+  threshold. Values in different windows will NOT be considered duplicates of\n+  each other. Deduplication is best effort.\n+\n+  The durations specified may impose memory and/or storage requirements within", "originalCommit": "51611d387b547ea8856f8502181c7567f9bba57b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjY4MDc5OQ==", "url": "https://github.com/apache/beam/pull/11060#discussion_r396680799", "bodyText": "It's not really best effort, rather it is only respected within the time domains (and there you can count on it).", "author": "robertwb", "createdAt": "2020-03-23T18:49:46Z", "path": "sdks/python/apache_beam/transforms/deduplicate.py", "diffHunk": "@@ -0,0 +1,133 @@\n+#\n+# Licensed to the Apache Software Foundation (ASF) under one or more\n+# contributor license agreements.  See the NOTICE file distributed with\n+# this work for additional information regarding copyright ownership.\n+# The ASF licenses this file to You under the Apache License, Version 2.0\n+# (the \"License\"); you may not use this file except in compliance with\n+# the License.  You may obtain a copy of the License at\n+#\n+#    http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+#\n+\n+# pytype: skip-file\n+\n+\"\"\"a collection of ptransforms for deduplicating elements.\"\"\"\n+\n+from __future__ import absolute_import\n+from __future__ import division\n+\n+import typing\n+\n+from apache_beam import typehints\n+from apache_beam.coders.coders import BooleanCoder\n+from apache_beam.transforms import core\n+from apache_beam.transforms import ptransform\n+from apache_beam.transforms import userstate\n+from apache_beam.transforms.timeutil import TimeDomain\n+from apache_beam.utils import timestamp\n+\n+__all__ = [\n+    'Deduplicate',\n+    'DeduplicatePerKey',\n+]\n+\n+K = typing.TypeVar('K')\n+V = typing.TypeVar('V')\n+\n+\n+@typehints.with_input_types(typing.Tuple[K, V])\n+@typehints.with_output_types(typing.Tuple[K, V])\n+class DeduplicatePerKey(ptransform.PTransform):\n+  \"\"\" A PTransform which deduplicates <key, value> pair over a time domain and\n+  threshold. Values in different windows will NOT be considered duplicates of\n+  each other. Deduplication is best effort.", "originalCommit": "51611d387b547ea8856f8502181c7567f9bba57b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "68f436d35ede88ae71b03915e50e16ed3dca4f0c", "url": "https://github.com/apache/beam/commit/68f436d35ede88ae71b03915e50e16ed3dca4f0c", "message": "[BEAM-9454] Add Deduplication PTransform", "committedDate": "2020-03-29T00:39:55Z", "type": "forcePushed"}, {"oid": "67b0807623b0e38433f9326b06d37a6b4e3505ff", "url": "https://github.com/apache/beam/commit/67b0807623b0e38433f9326b06d37a6b4e3505ff", "message": "[BEAM-9454] Add Deduplication PTransform", "committedDate": "2020-03-29T03:22:42Z", "type": "forcePushed"}, {"oid": "f5c82ef811852f3b5735fce527a1ea5baaf49a46", "url": "https://github.com/apache/beam/commit/f5c82ef811852f3b5735fce527a1ea5baaf49a46", "message": "[BEAM-9454] Add Deduplication PTransform", "committedDate": "2020-03-29T03:28:07Z", "type": "forcePushed"}, {"oid": "21dc0072b36115cc5d596ae2079d13fa45be6ec0", "url": "https://github.com/apache/beam/commit/21dc0072b36115cc5d596ae2079d13fa45be6ec0", "message": "[BEAM-9454] Add Deduplication PTransform", "committedDate": "2020-03-30T22:14:23Z", "type": "forcePushed"}, {"oid": "203efbdaadbc3576e60bf66eb2b19a18ed886e3f", "url": "https://github.com/apache/beam/commit/203efbdaadbc3576e60bf66eb2b19a18ed886e3f", "message": "[BEAM-9454] Add Deduplication PTransform", "committedDate": "2020-03-30T23:20:35Z", "type": "commit"}, {"oid": "203efbdaadbc3576e60bf66eb2b19a18ed886e3f", "url": "https://github.com/apache/beam/commit/203efbdaadbc3576e60bf66eb2b19a18ed886e3f", "message": "[BEAM-9454] Add Deduplication PTransform", "committedDate": "2020-03-30T23:20:35Z", "type": "forcePushed"}]}