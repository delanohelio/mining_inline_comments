{"pr_number": 11492, "pr_title": "[BEAM-9801] Pass in fire timestamp to timer callback", "pr_createdAt": "2020-04-22T15:19:38Z", "pr_url": "https://github.com/apache/beam/pull/11492", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzE3NTMzMA==", "url": "https://github.com/apache/beam/pull/11492#discussion_r413175330", "bodyText": "The paneinfo should also be passed in here. You can get paneinfo from timer.paneinfo", "author": "boyuanzz", "createdAt": "2020-04-22T17:27:31Z", "path": "sdks/python/apache_beam/runners/common.py", "diffHunk": "@@ -229,7 +229,7 @@ def invoke_timer_callback(self, user_state_context, key, window, timestamp):\n         kwargs[kw] = user_state_context.get_state(state_spec, key, window)\n       for kw, timer_spec in self.timer_args_to_replace.items():\n         kwargs[kw] = user_state_context.get_timer(\n-            timer_spec, key, window, None, None)\n+            timer_spec, key, window, timestamp, None)", "originalCommit": "6c840654747306a2135a55ed1f6f9e426dea2748", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "9961394d4e25c8c3dd1ed5e59983b9a238664957", "url": "https://github.com/apache/beam/commit/9961394d4e25c8c3dd1ed5e59983b9a238664957", "message": "[BEAM-9801] Pass in fire timestamp and pane info to timer callback\n\nPass in the timestamp to avoid:\n\n```\nINFO:apache_beam.utils.subprocess_server:Caused by: java.lang.RuntimeException: Error received from SDK harness for instruction 4: Traceback (most recent call last):\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/worker/sdk_worker.py\", line 245, in _execute\nINFO:apache_beam.utils.subprocess_server: response = task()\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/worker/sdk_worker.py\", line 302, in <lambda>\nINFO:apache_beam.utils.subprocess_server: lambda: self.create_worker().do_instruction(request), request)\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/worker/sdk_worker.py\", line 471, in do_instruction\nINFO:apache_beam.utils.subprocess_server: getattr(request, request_type), request.instruction_id)\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/worker/sdk_worker.py\", line 506, in process_bundle\nINFO:apache_beam.utils.subprocess_server: bundle_processor.process_bundle(instruction_id))\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/worker/bundle_processor.py\", line 910, in process_bundle\nINFO:apache_beam.utils.subprocess_server: element.timer_family_id, timer_data)\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/worker/operations.py\", line 688, in process_timer\nINFO:apache_beam.utils.subprocess_server: timer_data.fire_timestamp)\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/common.py\", line 990, in process_user_timer\nINFO:apache_beam.utils.subprocess_server: self._reraise_augmented(exn)\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/common.py\", line 1043, in _reraise_augmented\nINFO:apache_beam.utils.subprocess_server: raise_with_traceback(new_exn)\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/common.py\", line 988, in process_user_timer\nINFO:apache_beam.utils.subprocess_server: self.do_fn_invoker.invoke_user_timer(timer_spec, key, window, timestamp)\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/common.py\", line 517, in invoke_user_timer\nINFO:apache_beam.utils.subprocess_server: self.user_state_context, key, window, timestamp))\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/common.py\", line 1093, in process_outputs\nINFO:apache_beam.utils.subprocess_server: for result in results:\nINFO:apache_beam.utils.subprocess_server: File \"/Users/max/Dev/beam/sdks/python/apache_beam/testing/load_tests/pardo_test.py\", line 185, in process_timer\nINFO:apache_beam.utils.subprocess_server: timer.set(0)\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/worker/bundle_processor.py\", line 589, in set\nINFO:apache_beam.utils.subprocess_server: self._timer_coder_impl.encode_to_stream(timer, self._output_stream, True)\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/coders/coder_impl.py\", line 651, in encode_to_stream\nINFO:apache_beam.utils.subprocess_server: value.hold_timestamp, out, True)\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/coders/coder_impl.py\", line 608, in encode_to_stream\nINFO:apache_beam.utils.subprocess_server: millis = value.micros // 1000\nINFO:apache_beam.utils.subprocess_server:AttributeError: 'NoneType' object has no attribute 'micros' [while running 'GenerateLoad']\n```", "committedDate": "2020-04-22T19:41:13Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzMxNDgzNQ==", "url": "https://github.com/apache/beam/pull/11492#discussion_r413314835", "bodyText": "timer_data.paneinfo", "author": "boyuanzz", "createdAt": "2020-04-22T20:42:03Z", "path": "sdks/python/apache_beam/runners/worker/operations.py", "diffHunk": "@@ -685,7 +685,8 @@ def process_timer(self, tag, timer_data):\n         timer_spec,\n         timer_data.user_key,\n         timer_data.windows[0],\n-        timer_data.fire_timestamp)\n+        timer_data.fire_timestamp,\n+        timer_data.pane_info)", "originalCommit": "9961394d4e25c8c3dd1ed5e59983b9a238664957", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzMxNTI4MQ==", "url": "https://github.com/apache/beam/pull/11492#discussion_r413315281", "bodyText": "https://github.com/apache/beam/blob/master/sdks/python/apache_beam/transforms/userstate.py#L134-L142", "author": "boyuanzz", "createdAt": "2020-04-22T20:42:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzMxNDgzNQ=="}], "type": "inlineReview"}, {"oid": "1134a70919e65f3af4a939da76750ac416d0eab3", "url": "https://github.com/apache/beam/commit/1134a70919e65f3af4a939da76750ac416d0eab3", "message": "[BEAM-9801] Pass in fire timestamp and pane info to timer callback\n\nPass in the timestamp to avoid:\n\n```\nINFO:apache_beam.utils.subprocess_server:Caused by: java.lang.RuntimeException: Error received from SDK harness for instruction 4: Traceback (most recent call last):\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/worker/sdk_worker.py\", line 245, in _execute\nINFO:apache_beam.utils.subprocess_server: response = task()\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/worker/sdk_worker.py\", line 302, in <lambda>\nINFO:apache_beam.utils.subprocess_server: lambda: self.create_worker().do_instruction(request), request)\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/worker/sdk_worker.py\", line 471, in do_instruction\nINFO:apache_beam.utils.subprocess_server: getattr(request, request_type), request.instruction_id)\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/worker/sdk_worker.py\", line 506, in process_bundle\nINFO:apache_beam.utils.subprocess_server: bundle_processor.process_bundle(instruction_id))\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/worker/bundle_processor.py\", line 910, in process_bundle\nINFO:apache_beam.utils.subprocess_server: element.timer_family_id, timer_data)\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/worker/operations.py\", line 688, in process_timer\nINFO:apache_beam.utils.subprocess_server: timer_data.fire_timestamp)\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/common.py\", line 990, in process_user_timer\nINFO:apache_beam.utils.subprocess_server: self._reraise_augmented(exn)\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/common.py\", line 1043, in _reraise_augmented\nINFO:apache_beam.utils.subprocess_server: raise_with_traceback(new_exn)\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/common.py\", line 988, in process_user_timer\nINFO:apache_beam.utils.subprocess_server: self.do_fn_invoker.invoke_user_timer(timer_spec, key, window, timestamp)\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/common.py\", line 517, in invoke_user_timer\nINFO:apache_beam.utils.subprocess_server: self.user_state_context, key, window, timestamp))\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/common.py\", line 1093, in process_outputs\nINFO:apache_beam.utils.subprocess_server: for result in results:\nINFO:apache_beam.utils.subprocess_server: File \"/Users/max/Dev/beam/sdks/python/apache_beam/testing/load_tests/pardo_test.py\", line 185, in process_timer\nINFO:apache_beam.utils.subprocess_server: timer.set(0)\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/worker/bundle_processor.py\", line 589, in set\nINFO:apache_beam.utils.subprocess_server: self._timer_coder_impl.encode_to_stream(timer, self._output_stream, True)\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/coders/coder_impl.py\", line 651, in encode_to_stream\nINFO:apache_beam.utils.subprocess_server: value.hold_timestamp, out, True)\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/coders/coder_impl.py\", line 608, in encode_to_stream\nINFO:apache_beam.utils.subprocess_server: millis = value.micros // 1000\nINFO:apache_beam.utils.subprocess_server:AttributeError: 'NoneType' object has no attribute 'micros' [while running 'GenerateLoad']\n```", "committedDate": "2020-04-23T10:35:57Z", "type": "forcePushed"}, {"oid": "ef32a4d84c4c6c5c936c20a7cbb32257a276ebd8", "url": "https://github.com/apache/beam/commit/ef32a4d84c4c6c5c936c20a7cbb32257a276ebd8", "message": "[BEAM-9801] Pass in fire timestamp and pane info to timer callback\n\nPass in the timestamp to avoid:\n\n```\nINFO:apache_beam.utils.subprocess_server:Caused by: java.lang.RuntimeException: Error received from SDK harness for instruction 4: Traceback (most recent call last):\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/worker/sdk_worker.py\", line 245, in _execute\nINFO:apache_beam.utils.subprocess_server: response = task()\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/worker/sdk_worker.py\", line 302, in <lambda>\nINFO:apache_beam.utils.subprocess_server: lambda: self.create_worker().do_instruction(request), request)\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/worker/sdk_worker.py\", line 471, in do_instruction\nINFO:apache_beam.utils.subprocess_server: getattr(request, request_type), request.instruction_id)\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/worker/sdk_worker.py\", line 506, in process_bundle\nINFO:apache_beam.utils.subprocess_server: bundle_processor.process_bundle(instruction_id))\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/worker/bundle_processor.py\", line 910, in process_bundle\nINFO:apache_beam.utils.subprocess_server: element.timer_family_id, timer_data)\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/worker/operations.py\", line 688, in process_timer\nINFO:apache_beam.utils.subprocess_server: timer_data.fire_timestamp)\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/common.py\", line 990, in process_user_timer\nINFO:apache_beam.utils.subprocess_server: self._reraise_augmented(exn)\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/common.py\", line 1043, in _reraise_augmented\nINFO:apache_beam.utils.subprocess_server: raise_with_traceback(new_exn)\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/common.py\", line 988, in process_user_timer\nINFO:apache_beam.utils.subprocess_server: self.do_fn_invoker.invoke_user_timer(timer_spec, key, window, timestamp)\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/common.py\", line 517, in invoke_user_timer\nINFO:apache_beam.utils.subprocess_server: self.user_state_context, key, window, timestamp))\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/common.py\", line 1093, in process_outputs\nINFO:apache_beam.utils.subprocess_server: for result in results:\nINFO:apache_beam.utils.subprocess_server: File \"/Users/max/Dev/beam/sdks/python/apache_beam/testing/load_tests/pardo_test.py\", line 185, in process_timer\nINFO:apache_beam.utils.subprocess_server: timer.set(0)\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/worker/bundle_processor.py\", line 589, in set\nINFO:apache_beam.utils.subprocess_server: self._timer_coder_impl.encode_to_stream(timer, self._output_stream, True)\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/coders/coder_impl.py\", line 651, in encode_to_stream\nINFO:apache_beam.utils.subprocess_server: value.hold_timestamp, out, True)\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/coders/coder_impl.py\", line 608, in encode_to_stream\nINFO:apache_beam.utils.subprocess_server: millis = value.micros // 1000\nINFO:apache_beam.utils.subprocess_server:AttributeError: 'NoneType' object has no attribute 'micros' [while running 'GenerateLoad']\n```", "committedDate": "2020-04-23T14:04:32Z", "type": "forcePushed"}, {"oid": "109d1f1c1a230c4a8ff62d25d228a9bbea8d5aec", "url": "https://github.com/apache/beam/commit/109d1f1c1a230c4a8ff62d25d228a9bbea8d5aec", "message": "[BEAM-9801] Pass in fire timestamp and pane info to timer callback\n\nPass in the timestamp to avoid:\n\n```\nINFO:apache_beam.utils.subprocess_server:Caused by: java.lang.RuntimeException: Error received from SDK harness for instruction 4: Traceback (most recent call last):\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/worker/sdk_worker.py\", line 245, in _execute\nINFO:apache_beam.utils.subprocess_server: response = task()\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/worker/sdk_worker.py\", line 302, in <lambda>\nINFO:apache_beam.utils.subprocess_server: lambda: self.create_worker().do_instruction(request), request)\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/worker/sdk_worker.py\", line 471, in do_instruction\nINFO:apache_beam.utils.subprocess_server: getattr(request, request_type), request.instruction_id)\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/worker/sdk_worker.py\", line 506, in process_bundle\nINFO:apache_beam.utils.subprocess_server: bundle_processor.process_bundle(instruction_id))\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/worker/bundle_processor.py\", line 910, in process_bundle\nINFO:apache_beam.utils.subprocess_server: element.timer_family_id, timer_data)\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/worker/operations.py\", line 688, in process_timer\nINFO:apache_beam.utils.subprocess_server: timer_data.fire_timestamp)\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/common.py\", line 990, in process_user_timer\nINFO:apache_beam.utils.subprocess_server: self._reraise_augmented(exn)\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/common.py\", line 1043, in _reraise_augmented\nINFO:apache_beam.utils.subprocess_server: raise_with_traceback(new_exn)\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/common.py\", line 988, in process_user_timer\nINFO:apache_beam.utils.subprocess_server: self.do_fn_invoker.invoke_user_timer(timer_spec, key, window, timestamp)\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/common.py\", line 517, in invoke_user_timer\nINFO:apache_beam.utils.subprocess_server: self.user_state_context, key, window, timestamp))\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/common.py\", line 1093, in process_outputs\nINFO:apache_beam.utils.subprocess_server: for result in results:\nINFO:apache_beam.utils.subprocess_server: File \"/Users/max/Dev/beam/sdks/python/apache_beam/testing/load_tests/pardo_test.py\", line 185, in process_timer\nINFO:apache_beam.utils.subprocess_server: timer.set(0)\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/worker/bundle_processor.py\", line 589, in set\nINFO:apache_beam.utils.subprocess_server: self._timer_coder_impl.encode_to_stream(timer, self._output_stream, True)\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/coders/coder_impl.py\", line 651, in encode_to_stream\nINFO:apache_beam.utils.subprocess_server: value.hold_timestamp, out, True)\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/coders/coder_impl.py\", line 608, in encode_to_stream\nINFO:apache_beam.utils.subprocess_server: millis = value.micros // 1000\nINFO:apache_beam.utils.subprocess_server:AttributeError: 'NoneType' object has no attribute 'micros' [while running 'GenerateLoad']\n```", "committedDate": "2020-04-23T14:26:55Z", "type": "forcePushed"}, {"oid": "10f217fb8adf21e54d5f7b2641bb8d0568372f9e", "url": "https://github.com/apache/beam/commit/10f217fb8adf21e54d5f7b2641bb8d0568372f9e", "message": "[BEAM-9801] Pass in fire timestamp and pane info to timer callback\n\nPass in the timestamp to avoid:\n\n```\nINFO:apache_beam.utils.subprocess_server:Caused by: java.lang.RuntimeException: Error received from SDK harness for instruction 4: Traceback (most recent call last):\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/worker/sdk_worker.py\", line 245, in _execute\nINFO:apache_beam.utils.subprocess_server: response = task()\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/worker/sdk_worker.py\", line 302, in <lambda>\nINFO:apache_beam.utils.subprocess_server: lambda: self.create_worker().do_instruction(request), request)\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/worker/sdk_worker.py\", line 471, in do_instruction\nINFO:apache_beam.utils.subprocess_server: getattr(request, request_type), request.instruction_id)\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/worker/sdk_worker.py\", line 506, in process_bundle\nINFO:apache_beam.utils.subprocess_server: bundle_processor.process_bundle(instruction_id))\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/worker/bundle_processor.py\", line 910, in process_bundle\nINFO:apache_beam.utils.subprocess_server: element.timer_family_id, timer_data)\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/worker/operations.py\", line 688, in process_timer\nINFO:apache_beam.utils.subprocess_server: timer_data.fire_timestamp)\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/common.py\", line 990, in process_user_timer\nINFO:apache_beam.utils.subprocess_server: self._reraise_augmented(exn)\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/common.py\", line 1043, in _reraise_augmented\nINFO:apache_beam.utils.subprocess_server: raise_with_traceback(new_exn)\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/common.py\", line 988, in process_user_timer\nINFO:apache_beam.utils.subprocess_server: self.do_fn_invoker.invoke_user_timer(timer_spec, key, window, timestamp)\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/common.py\", line 517, in invoke_user_timer\nINFO:apache_beam.utils.subprocess_server: self.user_state_context, key, window, timestamp))\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/common.py\", line 1093, in process_outputs\nINFO:apache_beam.utils.subprocess_server: for result in results:\nINFO:apache_beam.utils.subprocess_server: File \"/Users/max/Dev/beam/sdks/python/apache_beam/testing/load_tests/pardo_test.py\", line 185, in process_timer\nINFO:apache_beam.utils.subprocess_server: timer.set(0)\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/worker/bundle_processor.py\", line 589, in set\nINFO:apache_beam.utils.subprocess_server: self._timer_coder_impl.encode_to_stream(timer, self._output_stream, True)\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/coders/coder_impl.py\", line 651, in encode_to_stream\nINFO:apache_beam.utils.subprocess_server: value.hold_timestamp, out, True)\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/coders/coder_impl.py\", line 608, in encode_to_stream\nINFO:apache_beam.utils.subprocess_server: millis = value.micros // 1000\nINFO:apache_beam.utils.subprocess_server:AttributeError: 'NoneType' object has no attribute 'micros' [while running 'GenerateLoad']\n```", "committedDate": "2020-04-23T16:30:39Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDI3NjM3NA==", "url": "https://github.com/apache/beam/pull/11492#discussion_r414276374", "bodyText": "I don't think we should set timer_buffer.cleared to False here.  There is an assumption around FnApiRunner.ListBuffer that per key the timer is only fired once. It seems like the assumption is broken by setting a new timer when firing the timer. If that's the case, we should consider updating the logic around timer buffer.", "author": "boyuanzz", "createdAt": "2020-04-24T04:05:15Z", "path": "sdks/python/apache_beam/runners/portability/fn_api_runner/fn_runner.py", "diffHunk": "@@ -845,10 +845,12 @@ def process_bundle(self,\n           (result_future.is_done() and result_future.get().error)):\n         if isinstance(output, beam_fn_api_pb2.Elements.Timers) and not dry_run:\n           with BundleManager._lock:\n-            self.bundle_context_manager.get_buffer(\n+            timer_buffer = self.bundle_context_manager.get_buffer(\n                 expected_output_timers[(\n                     output.transform_id, output.timer_family_id)],\n-                output.transform_id).append(output.timers)\n+                output.transform_id)\n+            timer_buffer.cleared = False", "originalCommit": "10f217fb8adf21e54d5f7b2641bb8d0568372f9e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDUwNDEyMA==", "url": "https://github.com/apache/beam/pull/11492#discussion_r414504120", "bodyText": "Where can I find this assumption? Note that the tests are passing.\nI think it makes sense to reset the flag; when the timer is set after firing we should treat it independently from any prior settings of the timer. We may want to leave a comment here why this is necessary. Alternatively, the resetting may be done directly after the timer is fired.", "author": "mxm", "createdAt": "2020-04-24T11:30:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDI3NjM3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDczNDEzNw==", "url": "https://github.com/apache/beam/pull/11492#discussion_r414734137", "bodyText": "@pabloem who is the original author of ListBuffer. I prefer the second way Max mentioned above. What do you think? Other than this part, timer changes look good to me.", "author": "boyuanzz", "createdAt": "2020-04-24T17:14:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDI3NjM3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjkyMTk5OQ==", "url": "https://github.com/apache/beam/pull/11492#discussion_r416921999", "bodyText": "Did you run into these errors when setting a timer from the timer call, Max? I think it would be good to explicitly reset the buffer, rather than manipulate its flag (e.g. write a timer_buffer.reset function). Or at least check if timer_buffer.cleared: timer_buffer.cleared = False, to confirm that the rest of the internal context in ListBuffer is cleared.", "author": "pabloem", "createdAt": "2020-04-28T21:05:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDI3NjM3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzIxMTc3MQ==", "url": "https://github.com/apache/beam/pull/11492#discussion_r417211771", "bodyText": "Did you run into these errors when setting a timer from the timer call, Max?\n\nThat's the point of this PR :) It is simply not possible to set a new timer from a firing timer without resetting the timer buffer.\n\nOr at least check if timer_buffer.cleared: timer_buffer.cleared = False\n\nThat is semantically identical to the current code. It is redundant to have the if check because when timer_buffer.cleared is False, then setting it to False again won't have any effect.\nI can add a reset() method which additionally checks whether the buffer had been cleared before. I think this is what you meant by the check.", "author": "mxm", "createdAt": "2020-04-29T10:22:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDI3NjM3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzIyMTIwNg==", "url": "https://github.com/apache/beam/pull/11492#discussion_r417221206", "bodyText": "Updated. PTAL @pabloem", "author": "mxm", "createdAt": "2020-04-29T10:40:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDI3NjM3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzIzNTI2OQ==", "url": "https://github.com/apache/beam/pull/11492#discussion_r417235269", "bodyText": "This made things more complicated because I also have to allow resetting when the buffer has never been used before, i.e. when the timer set for the first time.", "author": "mxm", "createdAt": "2020-04-29T11:09:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDI3NjM3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzIzNTYwOA==", "url": "https://github.com/apache/beam/pull/11492#discussion_r417235608", "bodyText": "PTAL @pabloem", "author": "mxm", "createdAt": "2020-04-29T11:09:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDI3NjM3NA=="}], "type": "inlineReview"}, {"oid": "0294cc5a36e98cc9f38be659233667051935ddac", "url": "https://github.com/apache/beam/commit/0294cc5a36e98cc9f38be659233667051935ddac", "message": "[BEAM-9801] Pass in fire timestamp and pane info to timer callback\n\nPass in the timestamp to avoid:\n\n```\nINFO:apache_beam.utils.subprocess_server:Caused by: java.lang.RuntimeException: Error received from SDK harness for instruction 4: Traceback (most recent call last):\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/worker/sdk_worker.py\", line 245, in _execute\nINFO:apache_beam.utils.subprocess_server: response = task()\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/worker/sdk_worker.py\", line 302, in <lambda>\nINFO:apache_beam.utils.subprocess_server: lambda: self.create_worker().do_instruction(request), request)\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/worker/sdk_worker.py\", line 471, in do_instruction\nINFO:apache_beam.utils.subprocess_server: getattr(request, request_type), request.instruction_id)\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/worker/sdk_worker.py\", line 506, in process_bundle\nINFO:apache_beam.utils.subprocess_server: bundle_processor.process_bundle(instruction_id))\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/worker/bundle_processor.py\", line 910, in process_bundle\nINFO:apache_beam.utils.subprocess_server: element.timer_family_id, timer_data)\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/worker/operations.py\", line 688, in process_timer\nINFO:apache_beam.utils.subprocess_server: timer_data.fire_timestamp)\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/common.py\", line 990, in process_user_timer\nINFO:apache_beam.utils.subprocess_server: self._reraise_augmented(exn)\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/common.py\", line 1043, in _reraise_augmented\nINFO:apache_beam.utils.subprocess_server: raise_with_traceback(new_exn)\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/common.py\", line 988, in process_user_timer\nINFO:apache_beam.utils.subprocess_server: self.do_fn_invoker.invoke_user_timer(timer_spec, key, window, timestamp)\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/common.py\", line 517, in invoke_user_timer\nINFO:apache_beam.utils.subprocess_server: self.user_state_context, key, window, timestamp))\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/common.py\", line 1093, in process_outputs\nINFO:apache_beam.utils.subprocess_server: for result in results:\nINFO:apache_beam.utils.subprocess_server: File \"/Users/max/Dev/beam/sdks/python/apache_beam/testing/load_tests/pardo_test.py\", line 185, in process_timer\nINFO:apache_beam.utils.subprocess_server: timer.set(0)\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/worker/bundle_processor.py\", line 589, in set\nINFO:apache_beam.utils.subprocess_server: self._timer_coder_impl.encode_to_stream(timer, self._output_stream, True)\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/coders/coder_impl.py\", line 651, in encode_to_stream\nINFO:apache_beam.utils.subprocess_server: value.hold_timestamp, out, True)\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/coders/coder_impl.py\", line 608, in encode_to_stream\nINFO:apache_beam.utils.subprocess_server: millis = value.micros // 1000\nINFO:apache_beam.utils.subprocess_server:AttributeError: 'NoneType' object has no attribute 'micros' [while running 'GenerateLoad']\n```", "committedDate": "2020-04-24T10:33:42Z", "type": "forcePushed"}, {"oid": "7ac3e0acf3d9693aff261e13830219aae837005a", "url": "https://github.com/apache/beam/commit/7ac3e0acf3d9693aff261e13830219aae837005a", "message": "[BEAM-9733] Repeatedly fire in batch mode until there are no more timers", "committedDate": "2020-04-25T12:12:48Z", "type": "forcePushed"}, {"oid": "c986a53b88cba891c64d320a2ef2cf497868001f", "url": "https://github.com/apache/beam/commit/c986a53b88cba891c64d320a2ef2cf497868001f", "message": "[BEAM-9733] Repeatedly fire in batch mode until there are no more timers", "committedDate": "2020-04-29T10:40:15Z", "type": "forcePushed"}, {"oid": "07fb5aad4d7b697b39d49e82b40372def75b6ccf", "url": "https://github.com/apache/beam/commit/07fb5aad4d7b697b39d49e82b40372def75b6ccf", "message": "[BEAM-9733] Repeatedly fire in batch mode until there are no more timers", "committedDate": "2020-04-29T11:03:21Z", "type": "forcePushed"}, {"oid": "f656ad0ba5f1a6f0ba345071b3244c69714ed752", "url": "https://github.com/apache/beam/commit/f656ad0ba5f1a6f0ba345071b3244c69714ed752", "message": "[BEAM-9733] Repeatedly fire in batch mode until there are no more timers", "committedDate": "2020-04-30T09:31:56Z", "type": "forcePushed"}, {"oid": "3cfc993ad47f14bcca0aecb2201c3a085fef4b1f", "url": "https://github.com/apache/beam/commit/3cfc993ad47f14bcca0aecb2201c3a085fef4b1f", "message": "[BEAM-9733] Repeatedly fire in batch mode until there are no more timers", "committedDate": "2020-04-30T14:22:46Z", "type": "forcePushed"}, {"oid": "3a042b69a8bd97f322a674ac3753a09938648919", "url": "https://github.com/apache/beam/commit/3a042b69a8bd97f322a674ac3753a09938648919", "message": "[BEAM-9801] Pass in fire timestamp and pane info to timer callback\n\nPass in the timestamp to avoid:\n\n```\nINFO:apache_beam.utils.subprocess_server:Caused by: java.lang.RuntimeException: Error received from SDK harness for instruction 4: Traceback (most recent call last):\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/worker/sdk_worker.py\", line 245, in _execute\nINFO:apache_beam.utils.subprocess_server: response = task()\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/worker/sdk_worker.py\", line 302, in <lambda>\nINFO:apache_beam.utils.subprocess_server: lambda: self.create_worker().do_instruction(request), request)\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/worker/sdk_worker.py\", line 471, in do_instruction\nINFO:apache_beam.utils.subprocess_server: getattr(request, request_type), request.instruction_id)\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/worker/sdk_worker.py\", line 506, in process_bundle\nINFO:apache_beam.utils.subprocess_server: bundle_processor.process_bundle(instruction_id))\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/worker/bundle_processor.py\", line 910, in process_bundle\nINFO:apache_beam.utils.subprocess_server: element.timer_family_id, timer_data)\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/worker/operations.py\", line 688, in process_timer\nINFO:apache_beam.utils.subprocess_server: timer_data.fire_timestamp)\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/common.py\", line 990, in process_user_timer\nINFO:apache_beam.utils.subprocess_server: self._reraise_augmented(exn)\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/common.py\", line 1043, in _reraise_augmented\nINFO:apache_beam.utils.subprocess_server: raise_with_traceback(new_exn)\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/common.py\", line 988, in process_user_timer\nINFO:apache_beam.utils.subprocess_server: self.do_fn_invoker.invoke_user_timer(timer_spec, key, window, timestamp)\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/common.py\", line 517, in invoke_user_timer\nINFO:apache_beam.utils.subprocess_server: self.user_state_context, key, window, timestamp))\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/common.py\", line 1093, in process_outputs\nINFO:apache_beam.utils.subprocess_server: for result in results:\nINFO:apache_beam.utils.subprocess_server: File \"/Users/max/Dev/beam/sdks/python/apache_beam/testing/load_tests/pardo_test.py\", line 185, in process_timer\nINFO:apache_beam.utils.subprocess_server: timer.set(0)\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/runners/worker/bundle_processor.py\", line 589, in set\nINFO:apache_beam.utils.subprocess_server: self._timer_coder_impl.encode_to_stream(timer, self._output_stream, True)\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/coders/coder_impl.py\", line 651, in encode_to_stream\nINFO:apache_beam.utils.subprocess_server: value.hold_timestamp, out, True)\nINFO:apache_beam.utils.subprocess_server: File \"apache_beam/coders/coder_impl.py\", line 608, in encode_to_stream\nINFO:apache_beam.utils.subprocess_server: millis = value.micros // 1000\nINFO:apache_beam.utils.subprocess_server:AttributeError: 'NoneType' object has no attribute 'micros' [while running 'GenerateLoad']\n```", "committedDate": "2020-04-30T14:25:12Z", "type": "commit"}, {"oid": "dc8f17e7b18eab520dd5edff48b7c5c4eb385d31", "url": "https://github.com/apache/beam/commit/dc8f17e7b18eab520dd5edff48b7c5c4eb385d31", "message": "[BEAM-9733] Repeatedly fire in batch mode until there are no more timers", "committedDate": "2020-04-30T14:25:12Z", "type": "commit"}, {"oid": "dc8f17e7b18eab520dd5edff48b7c5c4eb385d31", "url": "https://github.com/apache/beam/commit/dc8f17e7b18eab520dd5edff48b7c5c4eb385d31", "message": "[BEAM-9733] Repeatedly fire in batch mode until there are no more timers", "committedDate": "2020-04-30T14:25:12Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODc3ODc0MA==", "url": "https://github.com/apache/beam/pull/11492#discussion_r418778740", "bodyText": "It makes sense to do this in batch as well since the processing timers should get dropped and any newly scheduled event time timers should be continually fired.\nThis would require updating FlinkExecutableStageFunction and SparkExecutableStageFunction", "author": "lukecwik", "createdAt": "2020-05-01T23:31:44Z", "path": "runners/flink/src/main/java/org/apache/beam/runners/flink/translation/functions/FlinkExecutableStageFunction.java", "diffHunk": "@@ -247,25 +247,27 @@ public void reduce(Iterable<WindowedValue<InputT>> iterable, Collector<RawUnionV\n     timerInternals.advanceSynchronizedProcessingTime(BoundedWindow.TIMESTAMP_MAX_VALUE);\n \n     // Now we fire the timers and process elements generated by timers (which may be timers itself)\n-    try (RemoteBundle bundle =\n-        stageBundleFactory.getBundle(\n-            receiverFactory, timerReceiverFactory, stateRequestHandler, progressHandler)) {\n-\n-      PipelineTranslatorUtils.fireEligibleTimers(\n-          timerInternals,\n-          (KV<String, String> transformAndTimerId, Timer<?> timerValue) -> {\n-            FnDataReceiver<Timer> fnTimerReceiver =\n-                bundle.getTimerReceivers().get(transformAndTimerId);\n-            Preconditions.checkNotNull(\n-                fnTimerReceiver, \"No FnDataReceiver found for %s\", transformAndTimerId);\n-            try {\n-              fnTimerReceiver.accept(timerValue);\n-            } catch (Exception e) {\n-              throw new RuntimeException(\n-                  String.format(Locale.ENGLISH, \"Failed to process timer: %s\", timerValue));\n-            }\n-          },\n-          currentTimerKey);\n+    while (timerInternals.hasPendingTimers()) {", "originalCommit": "dc8f17e7b18eab520dd5edff48b7c5c4eb385d31", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODc3ODgyOA==", "url": "https://github.com/apache/beam/pull/11492#discussion_r418778828", "bodyText": "Also, I made this same comment earlier today and it was lost somehow.", "author": "lukecwik", "createdAt": "2020-05-01T23:32:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODc3ODc0MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODc4MDU3Mw==", "url": "https://github.com/apache/beam/pull/11492#discussion_r418780573", "bodyText": "Agree that this should apply to Spark runner too. To clarify, FlinkExecutableStageFunction is for batch only, meaning this change only affected Flink batch. I assume Flink streaming (ExecutableStageDoFnOperator) was working from the start.", "author": "ibzib", "createdAt": "2020-05-01T23:41:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODc3ODc0MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODgxMzM2OQ==", "url": "https://github.com/apache/beam/pull/11492#discussion_r418813369", "bodyText": "Made #11595 to update Spark.", "author": "ibzib", "createdAt": "2020-05-02T01:23:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODc3ODc0MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODk0MzYxMg==", "url": "https://github.com/apache/beam/pull/11492#discussion_r418943612", "bodyText": "Yes, this is a batch-only change (also evident in the commit message). The streaming operator already does that.\n\nprocessing timers should get dropped and any newly scheduled event time timers should be continually fired.\n\nWe do not drop processing timers. We fire all timers, including new ones, until there are none left.", "author": "mxm", "createdAt": "2020-05-02T10:52:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODc3ODc0MA=="}], "type": "inlineReview"}]}