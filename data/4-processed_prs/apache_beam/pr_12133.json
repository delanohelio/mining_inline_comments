{"pr_number": 12133, "pr_title": "[BEAM-10385] Integrate SQL expansion into Flink job server ", "pr_createdAt": "2020-06-30T15:27:53Z", "pr_url": "https://github.com/apache/beam/pull/12133", "timeline": [{"oid": "28f4bfd3d356dd698cdd4e220ce24952b737f3cc", "url": "https://github.com/apache/beam/commit/28f4bfd3d356dd698cdd4e220ce24952b737f3cc", "message": "[BEAM-10385] Integrate SQL expansion into Flink job server\n\nUltimately, these dependencies should be moved to the base job server but this\nis a larger refactor which will potentially get rid of the runner-specific job\nserver projects completely.", "committedDate": "2020-07-01T15:29:36Z", "type": "forcePushed"}, {"oid": "10d3b6aab3f13d7f11fc50e7d72f6f6520c05bd6", "url": "https://github.com/apache/beam/commit/10d3b6aab3f13d7f11fc50e7d72f6f6520c05bd6", "message": "[BEAM-10385] Integrate SQL expansion into Flink job server\n\nUltimately, these dependencies should be moved to the base job server but this\nis a larger refactor which will potentially get rid of the runner-specific job\nserver projects completely.", "committedDate": "2020-07-01T15:57:27Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODUyNTQwNg==", "url": "https://github.com/apache/beam/pull/12133#discussion_r448525406", "bodyText": "We definitely want to accept an expansion service as an argument, but the default should remain BeamJarExpansionService(':sdks:java:extensions:sql:expansion-service:shadowJar').", "author": "robertwb", "createdAt": "2020-07-01T17:52:39Z", "path": "sdks/python/apache_beam/transforms/sql.py", "diffHunk": "@@ -67,10 +66,9 @@ class SqlTransform(ExternalTransform):\n   \"\"\"\n   URN = 'beam:external:java:sql:v1'\n \n-  def __init__(self, query, dialect=None):\n+  def __init__(self, query, dialect=None, expansion_service=None):\n     super(SqlTransform, self).__init__(\n         self.URN,\n         NamedTupleBasedPayloadBuilder(\n             SqlTransformSchema(query=query, dialect=dialect)),\n-        BeamJarExpansionService(\n-            ':sdks:java:extensions:sql:expansion-service:shadowJar'))\n+        expansion_service=expansion_service)", "originalCommit": "10d3b6aab3f13d7f11fc50e7d72f6f6520c05bd6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODUyNzkzMA==", "url": "https://github.com/apache/beam/pull/12133#discussion_r448527930", "bodyText": "Note that you can use JavaJarServer.beam_services() (automatically populated by the --beam_services flag) to specify an alternative jar or live expansion service for any beam target.", "author": "robertwb", "createdAt": "2020-07-01T17:57:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODUyNTQwNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODg1OTg4Mw==", "url": "https://github.com/apache/beam/pull/12133#discussion_r448859883", "bodyText": "Thanks for the pointer. The workaround via overriding the Gradle target may be acceptable for developers but exposing it via an argument to users does not seem right. Users shouldn't have to know Gradle to use Beam Python.\nAlso, the corresponding value can either be a URL or a host:port string which is confusing to users and probably will break for Ipv6 addresses.", "author": "mxm", "createdAt": "2020-07-02T09:08:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODUyNTQwNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTI2Njg2Nw==", "url": "https://github.com/apache/beam/pull/12133#discussion_r449266867", "bodyText": "Yes, the beam_services flag is primarily for developers/testing. The default should just work after running \"pip install apache_beam\" which is what BeamJarExpansionService aims to provide. Externally-started job servers running universal expansion services at a fixed port was useful for bootstrapping, but is a bit of a special configuration. Exactly how to best configure this (which, in large part, boils down to being able to name expansion (or other) services), is a good open question.", "author": "robertwb", "createdAt": "2020-07-02T21:08:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODUyNTQwNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTI5ODc1MQ==", "url": "https://github.com/apache/beam/pull/12133#discussion_r449298751", "bodyText": "If the goal is to make things easier/flexible for developers, then convenience built into Gradle tasks may be a good option. Users would probably find it rather problematic if by default there is an attempt to pull down artifacts behind the scenes and execute them. That is probably also going to fail within isolated production environments.", "author": "tweise", "createdAt": "2020-07-02T22:49:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODUyNTQwNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDE2MjI3Nw==", "url": "https://github.com/apache/beam/pull/12133#discussion_r450162277", "bodyText": "For a good out-of-the-box experience it may be acceptable to bundle the expansion service with the job server, which is already the case for the Flink Runner. That way we don't have to start a separate service. I was thinking to move the dependencies for expansion (SQL, Kafka, etc.) to the base job-service project (https://issues.apache.org/jira/browse/BEAM-10386), but decided to postpone it for now because it causes a larger refactoring. IMHO we should get rid of the Runner-specific job service projects entirely, each Runner's artifact should carry all the necessary dependencies through the central job-service project.\nThe current approach here is very modular but downloading jars is unexpected because most users would expect everything to be self-contained. The downside also is that it won't easily work for other languages. In the future we may want to either (a) include a self-contained expansion server in the final artifact (b) publish container images for all expansion servers.\nI'll keep the current default because this warrants a mailing list discussion.", "author": "mxm", "createdAt": "2020-07-06T11:38:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODUyNTQwNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDQ3ODYzMg==", "url": "https://github.com/apache/beam/pull/12133#discussion_r450478632", "bodyText": "+1, a wider discussion about expansion service discovery and bundling would be very good to have on the mailing list.", "author": "robertwb", "createdAt": "2020-07-06T21:03:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODUyNTQwNg=="}], "type": "inlineReview"}, {"oid": "e9fa78a752837bdfd8106b8d9c58f1708fc2422f", "url": "https://github.com/apache/beam/commit/e9fa78a752837bdfd8106b8d9c58f1708fc2422f", "message": "[BEAM-10385] Integrate SQL expansion into Flink job server\n\nUltimately, these dependencies should be moved to the base job server but this\nis a larger refactor which will potentially get rid of the runner-specific job\nserver projects completely.", "committedDate": "2020-07-06T11:46:09Z", "type": "forcePushed"}, {"oid": "50c63e70e2bfcf65cfbce9fb74901ac0495f8796", "url": "https://github.com/apache/beam/commit/50c63e70e2bfcf65cfbce9fb74901ac0495f8796", "message": "[BEAM-10387] Allow customizing expansion server for SqlTransform\n\nThis removes the hardcoded dependency on SQL expansion jar server.", "committedDate": "2020-07-06T18:57:59Z", "type": "commit"}, {"oid": "00a756c9476546e62cb34bbef3d8c3dfa4e57d88", "url": "https://github.com/apache/beam/commit/00a756c9476546e62cb34bbef3d8c3dfa4e57d88", "message": "[BEAM-10385] Integrate SQL expansion into Flink job server\n\nUltimately, these dependencies should be moved to the base job server but this\nis a larger refactor which will potentially get rid of the runner-specific job\nserver projects completely.", "committedDate": "2020-07-06T18:57:59Z", "type": "commit"}, {"oid": "00a756c9476546e62cb34bbef3d8c3dfa4e57d88", "url": "https://github.com/apache/beam/commit/00a756c9476546e62cb34bbef3d8c3dfa4e57d88", "message": "[BEAM-10385] Integrate SQL expansion into Flink job server\n\nUltimately, these dependencies should be moved to the base job server but this\nis a larger refactor which will potentially get rid of the runner-specific job\nserver projects completely.", "committedDate": "2020-07-06T18:57:59Z", "type": "forcePushed"}, {"oid": "88b6fe8426598bf5e64fc57cf1a9d2f17089b2b2", "url": "https://github.com/apache/beam/commit/88b6fe8426598bf5e64fc57cf1a9d2f17089b2b2", "message": "[BEAM-7252] Exclude SQL test from FlinkRunnerOptimized\n\nExternal transforms are not supported by the optimizer.", "committedDate": "2020-07-07T11:11:20Z", "type": "commit"}]}