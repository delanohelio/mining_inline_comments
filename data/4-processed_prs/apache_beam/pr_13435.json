{"pr_number": 13435, "pr_title": " [BEAM-11358] Remove unused endOfStreamMonitor from nexmark and remove redundant distributions from monitor", "pr_createdAt": "2020-11-29T11:52:35Z", "pr_url": "https://github.com/apache/beam/pull/13435", "timeline": [{"oid": "4b64d6fd53fe601d17cf57802ed1f6d85f3e0e61", "url": "https://github.com/apache/beam/commit/4b64d6fd53fe601d17cf57802ed1f6d85f3e0e61", "message": "Merge redundant distributions in nexmark monitor", "committedDate": "2020-11-29T14:49:52Z", "type": "forcePushed"}, {"oid": "af09a5b61ab97ec22f175fa9a3b4ef5ff4f28555", "url": "https://github.com/apache/beam/commit/af09a5b61ab97ec22f175fa9a3b4ef5ff4f28555", "message": "Remove unused endOfStreamMonitor from nexmark", "committedDate": "2020-11-30T13:40:07Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTA3ODg1OQ==", "url": "https://github.com/apache/beam/pull/13435#discussion_r535078859", "bodyText": "please revert this change as it is unrelated", "author": "echauchot", "createdAt": "2020-12-03T10:36:57Z", "path": "runners/core-construction-java/src/main/java/org/apache/beam/runners/core/construction/External.java", "diffHunk": "@@ -78,7 +78,7 @@\n   private static AtomicInteger namespaceCounter = new AtomicInteger(0);\n \n   private static final ExpansionServiceClientFactory DEFAULT =\n-     DefaultExpansionServiceClientFactory.create(\n+      DefaultExpansionServiceClientFactory.create(", "originalCommit": "af09a5b61ab97ec22f175fa9a3b4ef5ff4f28555", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjI2NjIyMQ==", "url": "https://github.com/apache/beam/pull/13435#discussion_r542266221", "bodyText": "+1 on cleaning", "author": "echauchot", "createdAt": "2020-12-14T10:15:50Z", "path": "sdks/java/testing/nexmark/src/main/java/org/apache/beam/sdk/nexmark/queries/NexmarkQuery.java", "diffHunk": "@@ -39,7 +39,6 @@\n   final NexmarkConfiguration configuration;\n   public final Monitor<Event> eventMonitor;\n   public final Monitor<T> resultMonitor;\n-  private final Monitor<Event> endOfStreamMonitor;", "originalCommit": "af09a5b61ab97ec22f175fa9a3b4ef5ff4f28555", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjI5NTU2MA==", "url": "https://github.com/apache/beam/pull/13435#discussion_r542295560", "bodyText": "it is not a timeStamp, it is in processing time (the wall clock) as opposed to a timestamp which is a component of an element put by the source. Please rename to \"processingTime\"", "author": "echauchot", "createdAt": "2020-12-14T11:00:24Z", "path": "sdks/java/testing/nexmark/src/main/java/org/apache/beam/sdk/nexmark/Monitor.java", "diffHunk": "@@ -39,20 +39,15 @@\n   private class MonitorDoFn extends DoFn<T, T> {\n     final Counter elementCounter = Metrics.counter(name, prefix + \".elements\");\n     final Counter bytesCounter = Metrics.counter(name, prefix + \".bytes\");\n-    final Distribution startTime = Metrics.distribution(name, prefix + \".startTime\");\n-    final Distribution endTime = Metrics.distribution(name, prefix + \".endTime\");\n-    final Distribution startTimestamp = Metrics.distribution(name, prefix + \".startTimestamp\");\n-    final Distribution endTimestamp = Metrics.distribution(name, prefix + \".endTimestamp\");\n+    final Distribution systemTimestamp = Metrics.distribution(name, prefix + \".systemTimestamp\");", "originalCommit": "af09a5b61ab97ec22f175fa9a3b4ef5ff4f28555", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzE3MDQ0Mw==", "url": "https://github.com/apache/beam/pull/13435#discussion_r553170443", "bodyText": "please rename also the metric name", "author": "echauchot", "createdAt": "2021-01-07T08:16:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjI5NTU2MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjI5Nzg3OA==", "url": "https://github.com/apache/beam/pull/13435#discussion_r542297878", "bodyText": "true that this expression is equivalent and simpler but less readable. I would prefer a revert", "author": "echauchot", "createdAt": "2020-12-14T11:04:05Z", "path": "sdks/java/testing/nexmark/src/main/java/org/apache/beam/sdk/nexmark/NexmarkLauncher.java", "diffHunk": "@@ -302,7 +302,7 @@ private NexmarkPerf currentPerf(\n       effectiveEnd = eventEnd;\n     }\n \n-    if (effectiveEnd >= 0 && eventStart >= 0 && effectiveEnd >= eventStart) {\n+    if (eventStart >= 0 && effectiveEnd >= eventStart) {", "originalCommit": "af09a5b61ab97ec22f175fa9a3b4ef5ff4f28555", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjI5ODEzMQ==", "url": "https://github.com/apache/beam/pull/13435#discussion_r542298131", "bodyText": "same here", "author": "echauchot", "createdAt": "2020-12-14T11:04:26Z", "path": "sdks/java/testing/nexmark/src/main/java/org/apache/beam/sdk/nexmark/NexmarkLauncher.java", "diffHunk": "@@ -336,7 +336,7 @@ private NexmarkPerf currentPerf(\n       perf.startupDelaySec = (eventStart - startMsSinceEpoch) / 1000.0;\n     }\n \n-    if (resultStart >= 0 && eventStart >= 0 && resultStart >= eventStart) {\n+    if (eventStart >= 0 && resultStart >= eventStart) {", "originalCommit": "af09a5b61ab97ec22f175fa9a3b4ef5ff4f28555", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjMwMzM4NA==", "url": "https://github.com/apache/beam/pull/13435#discussion_r542303384", "bodyText": "agree with your simplification for these reasons:\n\nfor each element processed, the distribution metrics start and end will be updated with the same value and, as the distribution reports min, max and average, and, as in MetricsReader we are requesting the minimum and the maximum, there is no impact of having a single distribution\nthe methods in MetricsReader use a SplitIterator on the distributions that is not immutable for the underlying source (which could explain that there was 2 distributions created) but it does only reading (by calling getMin() and getMax()) so there will be no side effect on the underlying distribution.", "author": "echauchot", "createdAt": "2020-12-14T11:13:12Z", "path": "sdks/java/testing/nexmark/src/main/java/org/apache/beam/sdk/nexmark/Monitor.java", "diffHunk": "@@ -39,20 +39,15 @@\n   private class MonitorDoFn extends DoFn<T, T> {\n     final Counter elementCounter = Metrics.counter(name, prefix + \".elements\");\n     final Counter bytesCounter = Metrics.counter(name, prefix + \".bytes\");\n-    final Distribution startTime = Metrics.distribution(name, prefix + \".startTime\");\n-    final Distribution endTime = Metrics.distribution(name, prefix + \".endTime\");\n-    final Distribution startTimestamp = Metrics.distribution(name, prefix + \".startTimestamp\");\n-    final Distribution endTimestamp = Metrics.distribution(name, prefix + \".endTimestamp\");\n+    final Distribution systemTimestamp = Metrics.distribution(name, prefix + \".systemTimestamp\");\n+    final Distribution eventTimestamp = Metrics.distribution(name, prefix + \".eventTimestamp\");\n \n     @ProcessElement\n     public void processElement(ProcessContext c) {\n       elementCounter.inc();\n       bytesCounter.inc(c.element().sizeInBytes());\n-      long now = System.currentTimeMillis();\n-      startTime.update(now);\n-      endTime.update(now);\n-      startTimestamp.update(c.timestamp().getMillis());\n-      endTimestamp.update(c.timestamp().getMillis());\n+      systemTimestamp.update(System.currentTimeMillis());", "originalCommit": "af09a5b61ab97ec22f175fa9a3b4ef5ff4f28555", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "995c776192cba6404c6a24cf694ad6a797ede7a7", "url": "https://github.com/apache/beam/commit/995c776192cba6404c6a24cf694ad6a797ede7a7", "message": "Remove unused endOfStreamMonitor from nexmark", "committedDate": "2020-12-16T18:42:22Z", "type": "commit"}, {"oid": "995c776192cba6404c6a24cf694ad6a797ede7a7", "url": "https://github.com/apache/beam/commit/995c776192cba6404c6a24cf694ad6a797ede7a7", "message": "Remove unused endOfStreamMonitor from nexmark", "committedDate": "2020-12-16T18:42:22Z", "type": "forcePushed"}, {"oid": "b0b8ffdf8029a44ca090d74cbcdb86e611833338", "url": "https://github.com/apache/beam/commit/b0b8ffdf8029a44ca090d74cbcdb86e611833338", "message": "Also rename metric", "committedDate": "2021-01-07T10:53:49Z", "type": "commit"}]}