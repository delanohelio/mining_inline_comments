{"pr_number": 12889, "pr_title": "Dataframe wordcount example.", "pr_createdAt": "2020-09-21T17:03:53Z", "pr_url": "https://github.com/apache/beam/pull/12889", "timeline": [{"oid": "0bd0e4481c7484b8994524bc83a671eee2e05f56", "url": "https://github.com/apache/beam/commit/0bd0e4481c7484b8994524bc83a671eee2e05f56", "message": "Update changes file.", "committedDate": "2020-09-21T17:06:12Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjIzOTM2NA==", "url": "https://github.com/apache/beam/pull/12889#discussion_r492239364", "bodyText": "Maybe use Select here?", "author": "TheNeuralBit", "createdAt": "2020-09-21T17:46:45Z", "path": "sdks/python/apache_beam/examples/wordcount_dataframe.py", "diffHunk": "@@ -0,0 +1,73 @@\n+#\n+# Licensed to the Apache Software Foundation (ASF) under one or more\n+# contributor license agreements.  See the NOTICE file distributed with\n+# this work for additional information regarding copyright ownership.\n+# The ASF licenses this file to You under the Apache License, Version 2.0\n+# (the \"License\"); you may not use this file except in compliance with\n+# the License.  You may obtain a copy of the License at\n+#\n+#    http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+#\n+\n+\"\"\"A word-counting workflow using dataframes.\"\"\"\n+\n+# pytype: skip-file\n+\n+from __future__ import absolute_import\n+\n+import argparse\n+import logging\n+\n+import apache_beam as beam\n+from apache_beam.dataframe import io\n+from apache_beam.dataframe.convert import to_dataframe\n+from apache_beam.io import ReadFromText\n+from apache_beam.options.pipeline_options import PipelineOptions\n+\n+\n+def run(argv=None):\n+  \"\"\"Main entry point; defines and runs the wordcount pipeline.\"\"\"\n+  parser = argparse.ArgumentParser()\n+  parser.add_argument(\n+      '--input',\n+      dest='input',\n+      default='gs://dataflow-samples/shakespeare/kinglear.txt',\n+      help='Input file to process.')\n+  parser.add_argument(\n+      '--output',\n+      dest='output',\n+      required=True,\n+      help='Output file to write results to.')\n+  known_args, pipeline_args = parser.parse_known_args(argv)\n+\n+  # Import this here to avoid pickling the main session.\n+  import re\n+\n+  # The pipeline will be run on exiting the with block.\n+  with beam.Pipeline(options=PipelineOptions(pipeline_args)) as p:\n+\n+    # Read the text file[pattern] into a PCollection.\n+    lines = p | 'Read' >> ReadFromText(known_args.input)\n+\n+    words = (\n+        lines\n+        | 'Split' >> beam.FlatMap(\n+            lambda line: re.findall(r'[\\w]+', line)).with_output_types(str)\n+        # Map to Row objects to generate a schema suitable for conversion to a dataframe.\n+        | 'ToRows' >> beam.Map(lambda word: beam.Row(word=word)))", "originalCommit": "0bd0e4481c7484b8994524bc83a671eee2e05f56", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjI4NDk3Nw==", "url": "https://github.com/apache/beam/pull/12889#discussion_r492284977", "bodyText": "I actually toyed with that, but it's not as natural (or time-saving) for 1-field schemas.", "author": "robertwb", "createdAt": "2020-09-21T19:08:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjIzOTM2NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjI0MTA1Mw==", "url": "https://github.com/apache/beam/pull/12889#discussion_r492241053", "bodyText": "It could be nice to tee the counted back to a PCollection and print it as an example of to_pcollection. That's easier to do once unbatching is the default, I can add it as part of #12882 WDYT?", "author": "TheNeuralBit", "createdAt": "2020-09-21T17:49:45Z", "path": "sdks/python/apache_beam/examples/wordcount_dataframe.py", "diffHunk": "@@ -0,0 +1,73 @@\n+#\n+# Licensed to the Apache Software Foundation (ASF) under one or more\n+# contributor license agreements.  See the NOTICE file distributed with\n+# this work for additional information regarding copyright ownership.\n+# The ASF licenses this file to You under the Apache License, Version 2.0\n+# (the \"License\"); you may not use this file except in compliance with\n+# the License.  You may obtain a copy of the License at\n+#\n+#    http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+#\n+\n+\"\"\"A word-counting workflow using dataframes.\"\"\"\n+\n+# pytype: skip-file\n+\n+from __future__ import absolute_import\n+\n+import argparse\n+import logging\n+\n+import apache_beam as beam\n+from apache_beam.dataframe import io\n+from apache_beam.dataframe.convert import to_dataframe\n+from apache_beam.io import ReadFromText\n+from apache_beam.options.pipeline_options import PipelineOptions\n+\n+\n+def run(argv=None):\n+  \"\"\"Main entry point; defines and runs the wordcount pipeline.\"\"\"\n+  parser = argparse.ArgumentParser()\n+  parser.add_argument(\n+      '--input',\n+      dest='input',\n+      default='gs://dataflow-samples/shakespeare/kinglear.txt',\n+      help='Input file to process.')\n+  parser.add_argument(\n+      '--output',\n+      dest='output',\n+      required=True,\n+      help='Output file to write results to.')\n+  known_args, pipeline_args = parser.parse_known_args(argv)\n+\n+  # Import this here to avoid pickling the main session.\n+  import re\n+\n+  # The pipeline will be run on exiting the with block.\n+  with beam.Pipeline(options=PipelineOptions(pipeline_args)) as p:\n+\n+    # Read the text file[pattern] into a PCollection.\n+    lines = p | 'Read' >> ReadFromText(known_args.input)\n+\n+    words = (\n+        lines\n+        | 'Split' >> beam.FlatMap(\n+            lambda line: re.findall(r'[\\w]+', line)).with_output_types(str)\n+        # Map to Row objects to generate a schema suitable for conversion to a dataframe.\n+        | 'ToRows' >> beam.Map(lambda word: beam.Row(word=word)))\n+\n+    df = to_dataframe(words)\n+    df['count'] = 1\n+    counted = df.groupby('word').sum()\n+    counted.to_csv(known_args.output)", "originalCommit": "0bd0e4481c7484b8994524bc83a671eee2e05f56", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjI4NDY0Nw==", "url": "https://github.com/apache/beam/pull/12889#discussion_r492284647", "bodyText": "Makes sense, let's do that.", "author": "robertwb", "createdAt": "2020-09-21T19:08:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjI0MTA1Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjI0MTgxNQ==", "url": "https://github.com/apache/beam/pull/12889#discussion_r492241815", "bodyText": "Should this comment be part of the Dataframes note above? I don't think pandas 1.x support has any broader implications", "author": "TheNeuralBit", "createdAt": "2020-09-21T17:51:05Z", "path": "CHANGES.md", "diffHunk": "@@ -71,11 +71,14 @@\n     More details will be in an upcoming [blog post](https://beam.apache.org/blog/python-improved-annotations/index.html).\n * Improved the Interactive Beam API where recording streaming jobs now start a long running background recording job. Running ib.show() or ib.collect() samples from the recording ([BEAM-10603](https://issues.apache.org/jira/browse/BEAM-10603)).\n * In Interactive Beam, ib.show() and ib.collect() now have \"n\" and \"duration\" as parameters. These mean read only up to \"n\" elements and up to \"duration\" seconds of data read from the recording ([BEAM-10603](https://issues.apache.org/jira/browse/BEAM-10603)).\n+* Initial preview of [Dataframes](https://s.apache.org/simpler-python-pipelines-2020#slide=id.g905ac9257b_1_21) support.\n+    See also example at apache_beam/examples/wordcount_dataframe.py\n * X feature added (Java/Python) ([BEAM-X](https://issues.apache.org/jira/browse/BEAM-X)).\n \n ## Breaking Changes\n \n-* X behavior was changed ([BEAM-X](https://issues.apache.org/jira/browse/BEAM-X)).\n+* Python 2 and Python 3.5 support dropped.\n+* Pandas 1.x allowed.  Older version of Pandas may still be used, but may not be as well tested.", "originalCommit": "0bd0e4481c7484b8994524bc83a671eee2e05f56", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjI4NjEwOQ==", "url": "https://github.com/apache/beam/pull/12889#discussion_r492286109", "bodyText": "I think it makes more sense here--the main implication here is how diamond dependencies might get resolved.", "author": "robertwb", "createdAt": "2020-09-21T19:10:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjI0MTgxNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjI5NTY1NQ==", "url": "https://github.com/apache/beam/pull/12889#discussion_r492295655", "bodyText": "Gotcha, makes sense", "author": "TheNeuralBit", "createdAt": "2020-09-21T19:27:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjI0MTgxNQ=="}], "type": "inlineReview"}, {"oid": "895f222435c233ea05f83d58d56112f276b11280", "url": "https://github.com/apache/beam/commit/895f222435c233ea05f83d58d56112f276b11280", "message": "Update changes file.", "committedDate": "2020-09-21T19:13:37Z", "type": "forcePushed"}, {"oid": "cd69312120d7a68d899f6cedacf18991dfddf2fb", "url": "https://github.com/apache/beam/commit/cd69312120d7a68d899f6cedacf18991dfddf2fb", "message": "Dataframe wordcount example.", "committedDate": "2020-09-21T23:55:54Z", "type": "commit"}, {"oid": "4146e55fd49bd3240135f7675121a21cb071f78a", "url": "https://github.com/apache/beam/commit/4146e55fd49bd3240135f7675121a21cb071f78a", "message": "Update changes file.", "committedDate": "2020-09-21T23:56:56Z", "type": "commit"}, {"oid": "4146e55fd49bd3240135f7675121a21cb071f78a", "url": "https://github.com/apache/beam/commit/4146e55fd49bd3240135f7675121a21cb071f78a", "message": "Update changes file.", "committedDate": "2020-09-21T23:56:56Z", "type": "forcePushed"}]}