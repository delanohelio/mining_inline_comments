{"pr_number": 11086, "pr_title": "[BEAM-8910] Make custom BQ source read from Avro", "pr_createdAt": "2020-03-09T22:03:46Z", "pr_url": "https://github.com/apache/beam/pull/11086", "timeline": [{"oid": "5c58f531c7bd90dd5c03fac1924980c963283da2", "url": "https://github.com/apache/beam/commit/5c58f531c7bd90dd5c03fac1924980c963283da2", "message": "Using avro logical types", "committedDate": "2020-03-10T22:15:36Z", "type": "forcePushed"}, {"oid": "a25b0793c44da4cdcc675fa2d6728271ca2367c0", "url": "https://github.com/apache/beam/commit/a25b0793c44da4cdcc675fa2d6728271ca2367c0", "message": "Matching appropriately", "committedDate": "2020-03-12T16:49:25Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTQyMjU3MA==", "url": "https://github.com/apache/beam/pull/11086#discussion_r395422570", "bodyText": "How intuitive will this behavior be to users? should't the output be consistent?\nIf we decide to keep it, how will this be documented?", "author": "tvalentyn", "createdAt": "2020-03-20T03:15:38Z", "path": "sdks/python/apache_beam/io/gcp/bigquery_read_it_test.py", "diffHunk": "@@ -236,11 +251,12 @@ def create_table(cls, table_name):\n     cls.bigquery_client.insert_rows(\n         cls.project, cls.dataset_id, table_name, table_data)\n \n-  def get_expected_data(self):\n+  def get_expected_data(self, native=True):\n+    byts = b'\\xab\\xac'\n     expected_row = {\n         'float': 0.33,\n         'numeric': Decimal('10'),\n-        'bytes': base64.b64encode(b'\\xab\\xac'),\n+        'bytes': base64.b64encode(byts) if native else byts,", "originalCommit": "950abf9d6d95f94c6284958b13248a7ab21702dc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTkxMDg1NQ==", "url": "https://github.com/apache/beam/pull/11086#discussion_r395910855", "bodyText": "The behavior will be different for different transforms. Users will need to explicitly change the transform in their code. We can make them aware of the new transform, and its typing differences in release notes, and possibly in Pydoc for the new transform as well. Thoughts?", "author": "pabloem", "createdAt": "2020-03-20T22:08:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTQyMjU3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODIzMjEwOA==", "url": "https://github.com/apache/beam/pull/11086#discussion_r398232108", "bodyText": "Bytes treatment should be called out in IO doc, we do mention it: \n  \n    \n      beam/sdks/python/apache_beam/io/gcp/bigquery.py\n    \n    \n         Line 227\n      in\n      8bc2880\n    \n    \n    \n    \n\n        \n          \n           BigQuery IO requires values of BYTES datatype to be encoded using base64 \n        \n    \n  \n\n.\nb64encoding may be unnecessary, and less efficient. I think the reason native IO encodes bytes with b64 is because that was the behavior in Java SDK. We can argue that's not necessary. However I am concerned about the consistency of the UX here. Different UX for two transforms means the transforms will not be interchangeable, and users might overlook this.  This might also cause friction in cross-language pipelines.", "author": "tvalentyn", "createdAt": "2020-03-25T23:29:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTQyMjU3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzMzODQzMg==", "url": "https://github.com/apache/beam/pull/11086#discussion_r403338432", "bodyText": "I think that's reasonable. But I'd think that after slight confusion, users would figure out the differences.\nAnother option is to provide a parameter to the transform to have backwards-compatible types at a performance cost.\n@chamikaramj @tvalentyn  wdyt?", "author": "pabloem", "createdAt": "2020-04-03T21:12:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTQyMjU3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDIxODEyMA==", "url": "https://github.com/apache/beam/pull/11086#discussion_r404218120", "bodyText": "Having a parameter for backwards-compatibility would make sense to me, but will defer to @chamikaramj  on this. Since new transform comes with a new name, whoever will be using it, will have to read the API, so will be aware of the issue. But that would mean we add a knob, potentially indefinitely.", "author": "tvalentyn", "createdAt": "2020-04-06T16:17:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTQyMjU3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTAxNDg2MA==", "url": "https://github.com/apache/beam/pull/11086#discussion_r405014860", "bodyText": "So the proposal right now is: To have a parameter for backwards compatibility in the transform, but by default return Avro-returned types. We will need to have clear Pydoc on _ReadFromBigQuery, and on CHANGES.md.\n@chamikaramj thoughts?", "author": "pabloem", "createdAt": "2020-04-07T18:14:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTQyMjU3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjkzMTIzOQ==", "url": "https://github.com/apache/beam/pull/11086#discussion_r406931239", "bodyText": "@chamikaramj @tvalentyn @kamilwu - added a backward compatibility flag. Can you review?", "author": "pabloem", "createdAt": "2020-04-10T20:32:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTQyMjU3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjkzMTQ3Mg==", "url": "https://github.com/apache/beam/pull/11086#discussion_r406931472", "bodyText": "If the changes are reasonable, I'll add to release notes", "author": "pabloem", "createdAt": "2020-04-10T20:33:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTQyMjU3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTAzMTMwMQ==", "url": "https://github.com/apache/beam/pull/11086#discussion_r409031301", "bodyText": "I think having a single \"backwards compatibility\" parameter can be confusing and error prone. We might still be backwards incompatible in some unknown ways. I think it's better to document exact differences between the transforms and give clear documentation/guidelines for anyone who is upgrading.", "author": "chamikaramj", "createdAt": "2020-04-15T18:00:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTQyMjU3MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjYzNzI2Mw==", "url": "https://github.com/apache/beam/pull/11086#discussion_r396637263", "bodyText": "Does it mean that coder is no longer needed for _CustomBigQuerySource?", "author": "kamilwu", "createdAt": "2020-03-23T17:43:28Z", "path": "sdks/python/apache_beam/io/gcp/bigquery.py", "diffHunk": "@@ -663,14 +662,10 @@ def split(self, desired_bundle_size, start_position=None, stop_position=None):\n         self._setup_temporary_dataset(bq)\n         self.table_reference = self._execute_query(bq)\n \n-      schema, metadata_list = self._export_files(bq)\n+      unused_schema, metadata_list = self._export_files(bq)", "originalCommit": "950abf9d6d95f94c6284958b13248a7ab21702dc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzMzNzk2OQ==", "url": "https://github.com/apache/beam/pull/11086#discussion_r403337969", "bodyText": "You're correct!", "author": "pabloem", "createdAt": "2020-04-03T21:11:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjYzNzI2Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDAwMDE1Mw==", "url": "https://github.com/apache/beam/pull/11086#discussion_r404000153", "bodyText": "This is great! That would mean that we can safely remove _JsonToDictCoder. Do you think you can do this as a part of this PR?", "author": "kamilwu", "createdAt": "2020-04-06T10:52:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjYzNzI2Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQ4MzExMA==", "url": "https://github.com/apache/beam/pull/11086#discussion_r404483110", "bodyText": "We may do that, but if we end up keeping a backwards compatibility flag, we'll need to keep the coder as-is.", "author": "pabloem", "createdAt": "2020-04-07T01:26:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjYzNzI2Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDcwODMzNg==", "url": "https://github.com/apache/beam/pull/11086#discussion_r404708336", "bodyText": "I see. Then let's wait for the decision.", "author": "kamilwu", "createdAt": "2020-04-07T10:36:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjYzNzI2Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjYzODcxMA==", "url": "https://github.com/apache/beam/pull/11086#discussion_r396638710", "bodyText": "We can combine this condition with the one below:\nif isinstance(v, datetime.time) or isinstance(v, datetime.date):", "author": "kamilwu", "createdAt": "2020-03-23T17:45:40Z", "path": "sdks/python/apache_beam/io/gcp/bigquery_read_it_test.py", "diffHunk": "@@ -69,6 +70,20 @@ def wrapped(self):\n   return inner\n \n \n+def datetime_to_utc(element):\n+  for k, v in element.items():\n+    if isinstance(v, datetime.time):", "originalCommit": "950abf9d6d95f94c6284958b13248a7ab21702dc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzkzMDc0OQ==", "url": "https://github.com/apache/beam/pull/11086#discussion_r423930749", "bodyText": "or isinstance(v, (datetime.time, datetime.date))", "author": "robertwb", "createdAt": "2020-05-12T18:03:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjYzODcxMA=="}], "type": "inlineReview"}, {"oid": "1f647e488d85eb1a072737a680825a2606d7dc8b", "url": "https://github.com/apache/beam/commit/1f647e488d85eb1a072737a680825a2606d7dc8b", "message": "Fixup", "committedDate": "2020-04-10T19:48:08Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjk2ODE3Mw==", "url": "https://github.com/apache/beam/pull/11086#discussion_r406968173", "bodyText": "Can we use a bool as a default value instead of None?\nCan we use rename this flag to something that describes the course of action, for example: use_json_data_representation=False - you can come up with a better name.", "author": "tvalentyn", "createdAt": "2020-04-10T22:26:23Z", "path": "sdks/python/apache_beam/io/gcp/bigquery.py", "diffHunk": "@@ -609,7 +611,8 @@ def __init__(\n       coder=None,\n       use_standard_sql=False,\n       flatten_results=True,\n-      kms_key=None):\n+      kms_key=None,\n+      backwards_compatible_data_format=None):", "originalCommit": "80138416bcd10b84b3a473d83738c52d970f91f5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTAyMTA1OA==", "url": "https://github.com/apache/beam/pull/11086#discussion_r409021058", "bodyText": "Done.\nI've called it use_json_exports - does that help?", "author": "pabloem", "createdAt": "2020-04-15T17:43:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjk2ODE3Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjk2OTYxMw==", "url": "https://github.com/apache/beam/pull/11086#discussion_r406969613", "bodyText": "Do all BQ types have a native python type?\nWhat are JSON-types?", "author": "tvalentyn", "createdAt": "2020-04-10T22:32:20Z", "path": "sdks/python/apache_beam/io/gcp/bigquery.py", "diffHunk": "@@ -1570,6 +1584,10 @@ class _ReadFromBigQuery(PTransform):\n       bucket where the extracted table should be written as a string or\n       a :class:`~apache_beam.options.value_provider.ValueProvider`. If\n       :data:`None`, then the temp_location parameter is used.\n+    backwards_compatible_data_format (bool): By default, this transform reads\n+      data in native Python types that come from Avro-exports of BigQuery. By\n+      setting this flag to True, the transform will return JSON-types, like\n+      the older BigQuerySource.", "originalCommit": "80138416bcd10b84b3a473d83738c52d970f91f5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTAyMTI1MA==", "url": "https://github.com/apache/beam/pull/11086#discussion_r409021250", "bodyText": "I've added a link to https://cloud.google.com/bigquery/docs/loading-data-cloud-storage-avro#avro_conversions for details on the conversions. I've also rephrased the doc. LMK what you think.", "author": "pabloem", "createdAt": "2020-04-15T17:43:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjk2OTYxMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTAyMjQyMQ==", "url": "https://github.com/apache/beam/pull/11086#discussion_r409022421", "bodyText": "Let's document subtle differences between the two types (and two transforms ?) in doc comments of _ReadFromBigQuery so that users who upgrade/change the BigQuery read transforms have clear guidelines for updating their pipelines.", "author": "chamikaramj", "createdAt": "2020-04-15T17:45:30Z", "path": "sdks/python/apache_beam/io/gcp/bigquery.py", "diffHunk": "@@ -732,11 +748,20 @@ def _export_files(self, bq):\n       bigquery.TableSchema instance, a list of FileMetadata instances\n     \"\"\"\n     job_id = uuid.uuid4().hex\n-    job_ref = bq.perform_extract_job([self.gcs_location],\n-                                     job_id,\n-                                     self.table_reference,\n-                                     bigquery_tools.FileFormat.JSON,\n-                                     include_header=False)\n+    if self.use_json_exports:\n+      job_ref = bq.perform_extract_job([self.gcs_location],\n+                                       job_id,\n+                                       self.table_reference,\n+                                       bigquery_tools.FileFormat.JSON,\n+                                       include_header=False)\n+    else:\n+      job_ref = bq.perform_extract_job([self.gcs_location],", "originalCommit": "0864dbdd00e47152b6d904d1d9b1ad8400c81f52", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTUxMTM0MQ==", "url": "https://github.com/apache/beam/pull/11086#discussion_r439511341", "bodyText": "Is this resolved?", "author": "tvalentyn", "createdAt": "2020-06-12T16:10:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTAyMjQyMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTAyNDg1OA==", "url": "https://github.com/apache/beam/pull/11086#discussion_r409024858", "bodyText": "Probably cleaner to use the \"param_name=value\" format here for keyword arguments and not specify anything when we just want the default.", "author": "chamikaramj", "createdAt": "2020-04-15T17:49:40Z", "path": "sdks/python/apache_beam/io/gcp/bigquery.py", "diffHunk": "@@ -669,6 +681,13 @@ def estimate_size(self):\n       # no access to the query that we're running.\n       return None\n \n+  def _create_source(self, path, schema):\n+    if not self.use_json_exports:\n+      return create_avro_source(path, 0, True, use_fastavro=True)", "originalCommit": "0864dbdd00e47152b6d904d1d9b1ad8400c81f52", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTAyNDk2Ng==", "url": "https://github.com/apache/beam/pull/11086#discussion_r409024966", "bodyText": "Ditto.", "author": "chamikaramj", "createdAt": "2020-04-15T17:49:50Z", "path": "sdks/python/apache_beam/io/gcp/bigquery.py", "diffHunk": "@@ -669,6 +681,13 @@ def estimate_size(self):\n       # no access to the query that we're running.\n       return None\n \n+  def _create_source(self, path, schema):\n+    if not self.use_json_exports:\n+      return create_avro_source(path, 0, True, use_fastavro=True)\n+    else:\n+      return TextSource(\n+          path, 0, CompressionTypes.UNCOMPRESSED, True, self.coder(schema))", "originalCommit": "0864dbdd00e47152b6d904d1d9b1ad8400c81f52", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTAyNTgwMg==", "url": "https://github.com/apache/beam/pull/11086#discussion_r409025802", "bodyText": "Is there a reason to continue supporting JSON for the new transform (once we get our current performance issues) ? Probably we should document why users may choose JSON over Avro if we want to support both.", "author": "chamikaramj", "createdAt": "2020-04-15T17:51:16Z", "path": "sdks/python/apache_beam/io/gcp/bigquery.py", "diffHunk": "@@ -610,7 +611,8 @@ def __init__(\n       coder=None,\n       use_standard_sql=False,\n       flatten_results=True,\n-      kms_key=None):\n+      kms_key=None,\n+      use_json_exports=False):", "originalCommit": "0864dbdd00e47152b6d904d1d9b1ad8400c81f52", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTA5MDEwMQ==", "url": "https://github.com/apache/beam/pull/11086#discussion_r409090101", "bodyText": "not supporting JSON would increase the amount of changes that users need to make to migrate to the new source, as the data output types would change. I don't think this would be ideal. Wouldn't it be better to allow users to migrate to the new source without having to change the rest of their pipeline?", "author": "pabloem", "createdAt": "2020-04-15T19:42:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTAyNTgwMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzkzNDI2OA==", "url": "https://github.com/apache/beam/pull/11086#discussion_r423934268", "bodyText": "Assuming Avro is a superior format, I think we should drop support for json (but not right away). My preference would be to have this choice be orthogonal to the choice of types (and having the bytes default to be base64 encoded feels really wrong) so do think having a backwards compatibility parameter is preferable. (If it's just the date and bytes types, I would split this into two parameters: use_base64_encoded_bytes and datedtime_type.)", "author": "robertwb", "createdAt": "2020-05-12T18:09:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTAyNTgwMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDA4OTcwMw==", "url": "https://github.com/apache/beam/pull/11086#discussion_r424089703", "bodyText": "\"having the bytes default to be base64 encoded feels really wrong\" .\n\nI think we changed bytes to be base64-encoded several years back, because Java SDK used that representation: https://github.com/apache/beam/blob/master/sdks/java/io/google-cloud-platform/src/main/java/org/apache/beam/sdk/io/gcp/bigquery/BigQueryIO.java#L181-L182", "author": "tvalentyn", "createdAt": "2020-05-12T23:25:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTAyNTgwMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDA5MjA3Ng==", "url": "https://github.com/apache/beam/pull/11086#discussion_r424092076", "bodyText": "Yes, the joys of matching what was done in Java years ago for the Dataflow service API.", "author": "lukecwik", "createdAt": "2020-05-12T23:33:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTAyNTgwMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODg3Nzg4NA==", "url": "https://github.com/apache/beam/pull/11086#discussion_r428877884", "bodyText": "Restarting this discussion after some rebasing and preparing...\nI think I'd prefer to allow users to choose the export file format. This is what we do for writing to BQ in Java and Python. Allowing users to choose output type for specific column types would add overhead of (if avro and json_format_bytes: formatbytes; if avro and json_datetime_format: formatdatetime; if not avro and not json_format_bytes: formatbytes; ...).\nWe can discourage users from using JSON (AVRO is already the default) - and eventually stop supporting it if that makes sense. Thoughts?", "author": "pabloem", "createdAt": "2020-05-21T19:52:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTAyNTgwMg=="}], "type": "inlineReview"}, {"oid": "cd86e13d982e57d06fb263924b31b9728d0d3c78", "url": "https://github.com/apache/beam/commit/cd86e13d982e57d06fb263924b31b9728d0d3c78", "message": "Addressing comments. Documenting. Nits", "committedDate": "2020-04-18T00:09:23Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODYwOTgxNw==", "url": "https://github.com/apache/beam/pull/11086#discussion_r418609817", "bodyText": "Typo in From", "author": "tvalentyn", "createdAt": "2020-05-01T16:06:50Z", "path": "sdks/python/apache_beam/io/gcp/bigquery.py", "diffHunk": "@@ -45,8 +45,8 @@\n may use some caching techniques to share the side inputs between calls in order\n to avoid excessive reading:::\n \n-  main_table = pipeline | 'VeryBig' >> beam.io.Read(beam.io.BigQuerySource()\n-  side_table = pipeline | 'NotBig' >> beam.io.Read(beam.io.BigQuerySource()\n+  main_table = pipeline | 'VeryBig' >> beam.io.ReadFroBigQuery(...)", "originalCommit": "e1aa4b68dd69221752d8a50a8dec4d6976e23333", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTUxMDQ4Ng==", "url": "https://github.com/apache/beam/pull/11086#discussion_r439510486", "bodyText": "Ping on this", "author": "tvalentyn", "createdAt": "2020-06-12T16:09:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODYwOTgxNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODYxNTM5Mw==", "url": "https://github.com/apache/beam/pull/11086#discussion_r418615393", "bodyText": "Can we add some guidance when to use which?", "author": "tvalentyn", "createdAt": "2020-05-01T16:19:35Z", "path": "sdks/python/apache_beam/io/gcp/bigquery.py", "diffHunk": "@@ -78,6 +72,12 @@\n or a table. Pipeline construction will fail with a validation error if neither\n or both are specified.\n \n+When reading from BigQuery using `BigQuerySource`, bytes are returned as", "originalCommit": "e1aa4b68dd69221752d8a50a8dec4d6976e23333", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTUxMTEyMg==", "url": "https://github.com/apache/beam/pull/11086#discussion_r439511122", "bodyText": "Ping on this - do we need to guide users in any way which transform they should use? Is some of them experimental or to be deprecated?", "author": "tvalentyn", "createdAt": "2020-06-12T16:10:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODYxNTM5Mw=="}], "type": "inlineReview"}, {"oid": "3f63511d7bd139b61fdd4c2942d090e27ab191fb", "url": "https://github.com/apache/beam/commit/3f63511d7bd139b61fdd4c2942d090e27ab191fb", "message": "Improve documentation and testing", "committedDate": "2020-05-05T02:13:04Z", "type": "forcePushed"}, {"oid": "4f3c3761244a1f4dd4f4eb1bb7adc4513618407b", "url": "https://github.com/apache/beam/commit/4f3c3761244a1f4dd4f4eb1bb7adc4513618407b", "message": "Test fixup", "committedDate": "2020-05-08T23:43:58Z", "type": "forcePushed"}, {"oid": "c5d6e1f45542a0286bf63dc5423907c8ab14ba4f", "url": "https://github.com/apache/beam/commit/c5d6e1f45542a0286bf63dc5423907c8ab14ba4f", "message": "Test fixup", "committedDate": "2020-05-11T20:46:09Z", "type": "forcePushed"}, {"oid": "0e3e6c170ff7128f7e39cb9343e180fcd34c9fed", "url": "https://github.com/apache/beam/commit/0e3e6c170ff7128f7e39cb9343e180fcd34c9fed", "message": "Test fixup", "committedDate": "2020-05-12T19:28:44Z", "type": "forcePushed"}, {"oid": "79b2285e2c078ed1397795a5a71befe28eea6ce0", "url": "https://github.com/apache/beam/commit/79b2285e2c078ed1397795a5a71befe28eea6ce0", "message": "fixup", "committedDate": "2020-05-15T19:21:47Z", "type": "forcePushed"}, {"oid": "58dd68604e568637cab28bdbecbb72d44502f7b4", "url": "https://github.com/apache/beam/commit/58dd68604e568637cab28bdbecbb72d44502f7b4", "message": "Addressing comments. Documenting. Nits", "committedDate": "2020-05-27T19:01:30Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjExMjQ0Mw==", "url": "https://github.com/apache/beam/pull/11086#discussion_r432112443", "bodyText": "Looks like we run this test internally using this name. Since this test now changes to  use_beam_bq_sink, please check that  maintain reasonable internal test coverage for the native sink, or use a new test name for new behavior.", "author": "tvalentyn", "createdAt": "2020-05-28T20:44:29Z", "path": "sdks/python/apache_beam/io/gcp/big_query_query_to_table_it_test.py", "diffHunk": "@@ -254,11 +256,36 @@ def test_big_query_new_types(self):\n         'output_schema': NEW_TYPES_OUTPUT_SCHEMA,\n         'use_standard_sql': False,\n         'wait_until_finish_duration': WAIT_UNTIL_FINISH_DURATION_MS,\n+        'use_json_exports': True,\n         'on_success_matcher': all_of(*pipeline_verifiers)\n     }\n     options = self.test_pipeline.get_full_options_as_args(**extra_opts)\n     big_query_query_to_table_pipeline.run_bq_pipeline(options)\n \n+  @attr('IT')\n+  def test_big_query_new_types(self):", "originalCommit": "58dd68604e568637cab28bdbecbb72d44502f7b4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzcxOTc1MQ==", "url": "https://github.com/apache/beam/pull/11086#discussion_r437719751", "bodyText": "Thanks for pointing that out. I've renamed the test cases to keep coverage for the feature on the same test.", "author": "pabloem", "createdAt": "2020-06-09T21:00:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjExMjQ0Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTUyMjEzNA==", "url": "https://github.com/apache/beam/pull/11086#discussion_r439522134", "bodyText": "nit: exports", "author": "tvalentyn", "createdAt": "2020-06-12T16:27:36Z", "path": "sdks/python/apache_beam/io/gcp/bigquery.py", "diffHunk": "@@ -78,6 +72,12 @@\n or a table. Pipeline construction will fail with a validation error if neither\n or both are specified.\n \n+When reading from BigQuery using `BigQuerySource`, bytes are returned as\n+base64-encoded bytes. When reading via `ReadFromBigQuery`, bytes are returned\n+as bytes without base64 encoding. This is due to the fact that ReadFromBigQuery\n+uses Avro expors by default. To get base64-encoded bytes, you can use the flag", "originalCommit": "5566f44a5a9027d3bdaa384c2ebce86284fded48", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTU5MjIwMQ==", "url": "https://github.com/apache/beam/pull/11086#discussion_r439592201", "bodyText": "done", "author": "pabloem", "createdAt": "2020-06-12T18:57:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTUyMjEzNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTUyMjc3MQ==", "url": "https://github.com/apache/beam/pull/11086#discussion_r439522771", "bodyText": "To confirm - there is no changes in behavior for old sync, right?", "author": "tvalentyn", "createdAt": "2020-06-12T16:28:59Z", "path": "CHANGES.md", "diffHunk": "@@ -58,6 +58,10 @@\n \n * Support for X source added (Java/Python) ([BEAM-X](https://issues.apache.org/jira/browse/BEAM-X)).\n * Support for reading from Snowflake added (Java) ([BEAM-9722](https://issues.apache.org/jira/browse/BEAM-9722)).\n+* A new transform to read from BigQuery has been added: `apache_beam.io.gcp.bigquery.ReadFromBigQuery`. This transform", "originalCommit": "5566f44a5a9027d3bdaa384c2ebce86284fded48", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTU5MjI5Nw==", "url": "https://github.com/apache/beam/pull/11086#discussion_r439592297", "bodyText": "that's correct.", "author": "pabloem", "createdAt": "2020-06-12T18:57:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTUyMjc3MQ=="}], "type": "inlineReview"}, {"oid": "df7efd5dd25fd9e3d38411e52baf23964514b357", "url": "https://github.com/apache/beam/commit/df7efd5dd25fd9e3d38411e52baf23964514b357", "message": "Fixup", "committedDate": "2020-06-12T19:15:29Z", "type": "forcePushed"}, {"oid": "0b6138933077a206794348a241d928b68448e704", "url": "https://github.com/apache/beam/commit/0b6138933077a206794348a241d928b68448e704", "message": "Make custom BQ source read from Avro", "committedDate": "2020-06-15T21:55:09Z", "type": "commit"}, {"oid": "b5a0b59dda9f4002b2a6b5193b24c47ed8b0ee56", "url": "https://github.com/apache/beam/commit/b5a0b59dda9f4002b2a6b5193b24c47ed8b0ee56", "message": "Using avro logical types", "committedDate": "2020-06-15T21:55:09Z", "type": "commit"}, {"oid": "2770d40e3b7bb615cb77b81488c07f9018d1e1d4", "url": "https://github.com/apache/beam/commit/2770d40e3b7bb615cb77b81488c07f9018d1e1d4", "message": "Working with test", "committedDate": "2020-06-15T21:55:09Z", "type": "commit"}, {"oid": "ce498ef6448361ac3889eb79197161a18cc11a9e", "url": "https://github.com/apache/beam/commit/ce498ef6448361ac3889eb79197161a18cc11a9e", "message": "Matching appropriately", "committedDate": "2020-06-15T21:55:09Z", "type": "commit"}, {"oid": "6d1cba6d3cdc3091c4d76884e0682c61022e9dc3", "url": "https://github.com/apache/beam/commit/6d1cba6d3cdc3091c4d76884e0682c61022e9dc3", "message": "Separate test behavior", "committedDate": "2020-06-15T21:55:09Z", "type": "commit"}, {"oid": "db71af399603053f04eb9dc5c246afc53e87f4a6", "url": "https://github.com/apache/beam/commit/db71af399603053f04eb9dc5c246afc53e87f4a6", "message": "Support Backwards Compatible output", "committedDate": "2020-06-15T21:55:10Z", "type": "commit"}, {"oid": "ac9aec2605ad6b94b177e9a40f48e9733704d6da", "url": "https://github.com/apache/beam/commit/ac9aec2605ad6b94b177e9a40f48e9733704d6da", "message": "Fix formatter", "committedDate": "2020-06-15T21:55:10Z", "type": "commit"}, {"oid": "649a01073e96bf809dea89e2e56674dbdbdc1c89", "url": "https://github.com/apache/beam/commit/649a01073e96bf809dea89e2e56674dbdbdc1c89", "message": "Fixup", "committedDate": "2020-06-15T21:55:10Z", "type": "commit"}, {"oid": "5b15b57df9f54b6c91898131676d2a46aeb085a4", "url": "https://github.com/apache/beam/commit/5b15b57df9f54b6c91898131676d2a46aeb085a4", "message": "Fixup", "committedDate": "2020-06-15T21:55:10Z", "type": "commit"}, {"oid": "5a29c5b06dca58e856d58ce9a5f8f4a907d4c955", "url": "https://github.com/apache/beam/commit/5a29c5b06dca58e856d58ce9a5f8f4a907d4c955", "message": "Addressing comments", "committedDate": "2020-06-15T21:55:10Z", "type": "commit"}, {"oid": "ea7d9f225bb36cf61f39aa1ac12fee7f0d5482e4", "url": "https://github.com/apache/beam/commit/ea7d9f225bb36cf61f39aa1ac12fee7f0d5482e4", "message": "Addressing comments", "committedDate": "2020-06-15T21:55:10Z", "type": "commit"}, {"oid": "a848a41ed43a7aace1a07f0f81960b182d6d0bf1", "url": "https://github.com/apache/beam/commit/a848a41ed43a7aace1a07f0f81960b182d6d0bf1", "message": "Addressing comments. Documenting. Nits", "committedDate": "2020-06-15T21:55:10Z", "type": "commit"}, {"oid": "84d83bcca87258737c644e441b6b8a9e1a17b12a", "url": "https://github.com/apache/beam/commit/84d83bcca87258737c644e441b6b8a9e1a17b12a", "message": "Keeping new_types test for JSON", "committedDate": "2020-06-15T21:55:10Z", "type": "commit"}, {"oid": "291010ebd94838c4bdbf4f7ee31b9caeddc94a8d", "url": "https://github.com/apache/beam/commit/291010ebd94838c4bdbf4f7ee31b9caeddc94a8d", "message": "Fixup", "committedDate": "2020-06-15T21:55:10Z", "type": "commit"}, {"oid": "291010ebd94838c4bdbf4f7ee31b9caeddc94a8d", "url": "https://github.com/apache/beam/commit/291010ebd94838c4bdbf4f7ee31b9caeddc94a8d", "message": "Fixup", "committedDate": "2020-06-15T21:55:10Z", "type": "forcePushed"}]}