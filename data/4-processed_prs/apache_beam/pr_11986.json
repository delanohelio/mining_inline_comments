{"pr_number": 11986, "pr_title": "[BEAM-10235] Adding a CountElms transform to the Go SDK.", "pr_createdAt": "2020-06-11T01:10:48Z", "pr_url": "https://github.com/apache/beam/pull/11986", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODg2ODk0NQ==", "url": "https://github.com/apache/beam/pull/11986#discussion_r438868945", "bodyText": "Consider removing that last sentence about injections (here and above). Or we can change it!\nI think it's supposed to require that the encodings be deterministic  (which is required since Count uses elements as keys) which is clearer than the formal wording that currently exists.", "author": "lostluck", "createdAt": "2020-06-11T15:26:28Z", "path": "sdks/go/pkg/beam/transforms/stats/count.go", "diffHunk": "@@ -18,18 +18,36 @@ package stats\n \n import (\n \t\"github.com/apache/beam/sdks/go/pkg/beam\"\n+\t\"github.com/apache/beam/sdks/go/pkg/beam/core/typex\"\n )\n \n-// Count counts the number of elements in a collection. It expects a\n-// PCollection<T> as input and returns a PCollection<KV<T,int>>. T's encoding\n-// must be a well-defined injection.\n+// Count counts the number of appearances of each element in a collection. It\n+// expects a PCollection<T> as input and returns a PCollection<KV<T,int>>. T's\n+// encoding must be a well-defined injection.\n func Count(s beam.Scope, col beam.PCollection) beam.PCollection {\n \ts = s.Scope(\"stats.Count\")\n \n-\tpre := beam.ParDo(s, mapFn, col)\n+\tpre := beam.ParDo(s, keyedMapFn, col)\n \treturn SumPerKey(s, pre)\n }\n \n-func mapFn(elm beam.T) (beam.T, int) {\n+func keyedMapFn(elm beam.T) (beam.T, int) {\n \treturn elm, 1\n }\n+\n+// CountElms counts the number of elements in a collection. It expects a\n+// PCollection<T> as input and returns a PCollection<int> of one element\n+// containing the count. T's encoding must be a well-defined injection.", "originalCommit": "6be9fea5568ee25224c4027ef0aa05cd964a7850", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTcxOTYxMQ==", "url": "https://github.com/apache/beam/pull/11986#discussion_r439719611", "bodyText": "Done for Count. And for CountElms I removed the line because T's encoding doesn't need to be deterministic since it's not used as a key.", "author": "youngoli", "createdAt": "2020-06-13T08:02:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODg2ODk0NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODg4NDYyNw==", "url": "https://github.com/apache/beam/pull/11986#discussion_r438884627", "bodyText": "Consider countFn?", "author": "lostluck", "createdAt": "2020-06-11T15:43:08Z", "path": "sdks/go/pkg/beam/transforms/stats/count.go", "diffHunk": "@@ -18,18 +18,36 @@ package stats\n \n import (\n \t\"github.com/apache/beam/sdks/go/pkg/beam\"\n+\t\"github.com/apache/beam/sdks/go/pkg/beam/core/typex\"\n )\n \n-// Count counts the number of elements in a collection. It expects a\n-// PCollection<T> as input and returns a PCollection<KV<T,int>>. T's encoding\n-// must be a well-defined injection.\n+// Count counts the number of appearances of each element in a collection. It\n+// expects a PCollection<T> as input and returns a PCollection<KV<T,int>>. T's\n+// encoding must be a well-defined injection.\n func Count(s beam.Scope, col beam.PCollection) beam.PCollection {\n \ts = s.Scope(\"stats.Count\")\n \n-\tpre := beam.ParDo(s, mapFn, col)\n+\tpre := beam.ParDo(s, keyedMapFn, col)\n \treturn SumPerKey(s, pre)\n }\n \n-func mapFn(elm beam.T) (beam.T, int) {\n+func keyedMapFn(elm beam.T) (beam.T, int) {\n \treturn elm, 1\n }\n+\n+// CountElms counts the number of elements in a collection. It expects a\n+// PCollection<T> as input and returns a PCollection<int> of one element\n+// containing the count. T's encoding must be a well-defined injection.\n+func CountElms(s beam.Scope, col beam.PCollection) beam.PCollection {\n+\ts = s.Scope(\"stats.CountElms\")\n+\n+\tif typex.IsKV(col.Type()) {\n+\t\tcol = beam.DropKey(s, col)\n+\t}\n+\tpre := beam.ParDo(s, mapFn, col)\n+\treturn Sum(s, pre)\n+}\n+\n+func mapFn(_ beam.T) int {", "originalCommit": "6be9fea5568ee25224c4027ef0aa05cd964a7850", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTcxOTkwOA==", "url": "https://github.com/apache/beam/pull/11986#discussion_r439719908", "bodyText": "Sounds good to me. Changed this to countFn and the other to keyedCountFn.", "author": "youngoli", "createdAt": "2020-06-13T08:07:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODg4NDYyNw=="}], "type": "inlineReview"}, {"oid": "d870be85a2e426868ebd8b729f6f9d16853f2afa", "url": "https://github.com/apache/beam/commit/d870be85a2e426868ebd8b729f6f9d16853f2afa", "message": "[BEAM-10235] Adding a CountElms transform to the Go SDK.\n\nThis transform counts the number of elements in a PTransform.", "committedDate": "2020-06-13T08:11:56Z", "type": "commit"}, {"oid": "d870be85a2e426868ebd8b729f6f9d16853f2afa", "url": "https://github.com/apache/beam/commit/d870be85a2e426868ebd8b729f6f9d16853f2afa", "message": "[BEAM-10235] Adding a CountElms transform to the Go SDK.\n\nThis transform counts the number of elements in a PTransform.", "committedDate": "2020-06-13T08:11:56Z", "type": "forcePushed"}]}