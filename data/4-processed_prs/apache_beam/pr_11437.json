{"pr_number": 11437, "pr_title": "[BEAM-9770] Add BigQueryIO deadletter pattern", "pr_createdAt": "2020-04-16T07:50:43Z", "pr_url": "https://github.com/apache/beam/pull/11437", "timeline": [{"oid": "3e15b7e6dc32f02e92cd721875fa6b18fe593afd", "url": "https://github.com/apache/beam/commit/3e15b7e6dc32f02e92cd721875fa6b18fe593afd", "message": "[BEAM-9770] Add BigQueryIO deadletter pattern", "committedDate": "2020-04-17T02:52:16Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDMyMDUyNw==", "url": "https://github.com/apache/beam/pull/11437#discussion_r410320527", "bodyText": "Probably change to \"retryTransientErrors\" ? I'm afraid many users will just copy and use this pipeline as a template and will keep this entry in their production pipelines.", "author": "chamikaramj", "createdAt": "2020-04-17T16:04:09Z", "path": "examples/java/src/main/java/org/apache/beam/examples/snippets/Snippets.java", "diffHunk": "@@ -753,35 +750,93 @@ public static void main(String[] args) {\n       // [START CustomSessionWindow5]\n \n       PCollection<TableRow> p =\n-          Pipeline.create()\n-              .apply(\n-                  \"Create data\",\n-                  Create.timestamped(\n-                      TimestampedValue.of(\n-                          new TableRow().set(\"user\", \"mobile\").set(\"score\", 12).set(\"gap\", 5),\n-                          new Instant()),\n-                      TimestampedValue.of(\n-                          new TableRow().set(\"user\", \"desktop\").set(\"score\", 4), new Instant()),\n-                      TimestampedValue.of(\n-                          new TableRow().set(\"user\", \"mobile\").set(\"score\", -3).set(\"gap\", 5),\n-                          new Instant().plus(2000)),\n-                      TimestampedValue.of(\n-                          new TableRow().set(\"user\", \"mobile\").set(\"score\", 2).set(\"gap\", 5),\n-                          new Instant().plus(9000)),\n-                      TimestampedValue.of(\n-                          new TableRow().set(\"user\", \"mobile\").set(\"score\", 7).set(\"gap\", 5),\n-                          new Instant().plus(12000)),\n-                      TimestampedValue.of(\n-                          new TableRow().set(\"user\", \"desktop\").set(\"score\", 10),\n-                          new Instant().plus(12000))));\n+              Pipeline.create()\n+                      .apply(\n+                              \"Create data\",\n+                              Create.timestamped(\n+                                      TimestampedValue.of(\n+                                              new TableRow().set(\"user\", \"mobile\").set(\"score\", 12).set(\"gap\", 5),\n+                                              new Instant()),\n+                                      TimestampedValue.of(\n+                                              new TableRow().set(\"user\", \"desktop\").set(\"score\", 4), new Instant()),\n+                                      TimestampedValue.of(\n+                                              new TableRow().set(\"user\", \"mobile\").set(\"score\", -3).set(\"gap\", 5),\n+                                              new Instant().plus(2000)),\n+                                      TimestampedValue.of(\n+                                              new TableRow().set(\"user\", \"mobile\").set(\"score\", 2).set(\"gap\", 5),\n+                                              new Instant().plus(9000)),\n+                                      TimestampedValue.of(\n+                                              new TableRow().set(\"user\", \"mobile\").set(\"score\", 7).set(\"gap\", 5),\n+                                              new Instant().plus(12000)),\n+                                      TimestampedValue.of(\n+                                              new TableRow().set(\"user\", \"desktop\").set(\"score\", 10),\n+                                              new Instant().plus(12000))));\n       // [END CustomSessionWindow5]\n \n       // [START CustomSessionWindow6]\n       p.apply(\n-          \"Window into sessions\",\n-          Window.<TableRow>into(\n-              DynamicSessions.withDefaultGapDuration(Duration.standardSeconds(10))));\n+              \"Window into sessions\",\n+              Window.<TableRow>into(\n+                      DynamicSessions.withDefaultGapDuration(Duration.standardSeconds(10))));\n       // [END CustomSessionWindow6]\n+    }\n+\n+    public static class DeadLetterBigQuery {\n+      public static void deadletter(String[] args) {\n+        // [START BigQueryIODeadLetter]\n+        // Create pipeline\n+        PipelineOptions options =\n+                PipelineOptionsFactory.fromArgs(args).withValidation().as(BigQueryOptions.class);\n+\n+        Pipeline p = Pipeline.create(options);\n+\n+        // Create a bug by writing the 2nd value as null. The API will correctly\n+        // throw an error when trying to insert a null value into a REQUIRED field.\n+        WriteResult result =\n+                p.apply(Create.of(1, 2))\n+                        .apply(\n+                                BigQueryIO.<Integer>write()\n+                                        .withSchema(\n+                                                new TableSchema()\n+                                                        .setFields(\n+                                                                com.google.common.collect.ImmutableList.of(\n+                                                                        new TableFieldSchema()\n+                                                                                .setName(\"num\")\n+                                                                                .setType(\"INTEGER\")\n+                                                                                .setMode(\"REQUIRED\"))))\n+                                        .to(\"Test.dummyTable\")\n+                                        .withFormatFunction(x -> new TableRow().set(\"num\", (x == 2) ? null : x))\n+                                        .withFailedInsertRetryPolicy(InsertRetryPolicy.neverRetry())", "originalCommit": "3e15b7e6dc32f02e92cd721875fa6b18fe593afd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTAzNDQ0Mg==", "url": "https://github.com/apache/beam/pull/11437#discussion_r411034442", "bodyText": "Fixed.", "author": "rezarokni", "createdAt": "2020-04-20T01:06:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDMyMDUyNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDMyMzI3NQ==", "url": "https://github.com/apache/beam/pull/11437#discussion_r410323275", "bodyText": "Let's mention retry policies here and mention that that dictates which failures will be added to the deadletter queue and whether we will retry.", "author": "chamikaramj", "createdAt": "2020-04-17T16:08:42Z", "path": "website/src/documentation/patterns/bigqueryio.md", "diffHunk": "@@ -0,0 +1,37 @@\n+---\n+layout: section\n+title: \"BigQuery patterns\"\n+section_menu: section-menu/documentation.html\n+permalink: /documentation/patterns/bigqueryio/\n+---\n+<!--\n+Licensed under the Apache License, Version 2.0 (the \"License\");\n+you may not use this file except in compliance with the License.\n+You may obtain a copy of the License at\n+\n+http://www.apache.org/licenses/LICENSE-2.0\n+\n+Unless required by applicable law or agreed to in writing, software\n+distributed under the License is distributed on an \"AS IS\" BASIS,\n+WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+See the License for the specific language governing permissions and\n+limitations under the License.\n+-->\n+\n+# Google BigQuery patterns\n+\n+The samples on this page show you common patterns for use with BigQueryIO.\n+\n+## BigQueryIO deadletter pattern\n+In production systems, it is useful to implement the deadletter pattern with BigQueryIO outputting any elements which had errors during processing by BigQueryIO into another PCollection for further processing. \n+\n+When using `STREAMING_INSERTS`  you can use the `WriteResult` object to access a `PCollection` with the `TableRows` that failed to be inserted into BigQuery. ", "originalCommit": "3e15b7e6dc32f02e92cd721875fa6b18fe593afd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTAzNDQ1Ng==", "url": "https://github.com/apache/beam/pull/11437#discussion_r411034456", "bodyText": "Fixed.", "author": "rezarokni", "createdAt": "2020-04-20T01:06:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDMyMzI3NQ=="}], "type": "inlineReview"}, {"oid": "73f1455e38b4decb4598230ce1aec40bb85195b6", "url": "https://github.com/apache/beam/commit/73f1455e38b4decb4598230ce1aec40bb85195b6", "message": "[BEAM-9770] Add BigQueryIO deadletter pattern\nChange Retry policy type.\nAdd note about InsertRetryPolicy.\nFix documentation.html bad URL for bigqueryio pattern", "committedDate": "2020-04-21T07:00:38Z", "type": "forcePushed"}, {"oid": "cfa11fb0ddc1ce178686e8d5dfc6ed615dd5763f", "url": "https://github.com/apache/beam/commit/cfa11fb0ddc1ce178686e8d5dfc6ed615dd5763f", "message": "[BEAM-9770] Add BigQueryIO deadletter pattern\nChange Retry policy type.\nAdd note about InsertRetryPolicy.\nFix documentation.html bad URL for bigqueryio pattern\n\nAdd language select to file.\n\nAdd Python example to BigQueryIO deadletter.", "committedDate": "2020-05-04T07:30:00Z", "type": "forcePushed"}, {"oid": "9bc7bf78b0339a175c70e98b998396ee179c0162", "url": "https://github.com/apache/beam/commit/9bc7bf78b0339a175c70e98b998396ee179c0162", "message": "[BEAM-9770] Add BigQueryIO deadletter pattern\nChange Retry policy type.\nAdd note about InsertRetryPolicy.\nFix documentation.html bad URL for bigqueryio pattern\n\nAdd language select to file.\n\nAdd Python example to BigQueryIO deadletter.", "committedDate": "2020-05-04T07:33:39Z", "type": "forcePushed"}, {"oid": "7df5e3f5527a17b739abb6dacdf753c9d579f126", "url": "https://github.com/apache/beam/commit/7df5e3f5527a17b739abb6dacdf753c9d579f126", "message": "[BEAM-9770] Add BigQueryIO deadletter pattern\nChange Retry policy type.\nAdd note about InsertRetryPolicy.\nFix documentation.html bad URL for bigqueryio pattern\n\nAdd language select to file.\n\nAdd Python example to BigQueryIO deadletter.\n\nfixup", "committedDate": "2020-05-14T03:36:16Z", "type": "forcePushed"}, {"oid": "dfb4f01ad812881a83f3d8a45342b11d5e4c85b4", "url": "https://github.com/apache/beam/commit/dfb4f01ad812881a83f3d8a45342b11d5e4c85b4", "message": "[BEAM-9770] Add BigQueryIO deadletter pattern\nDecouple .java and .py snippits commit for purpose of PR.", "committedDate": "2020-05-15T03:11:36Z", "type": "forcePushed"}, {"oid": "9d2295039fe72a87d2bc5e64d02f8c3363681c35", "url": "https://github.com/apache/beam/commit/9d2295039fe72a87d2bc5e64d02f8c3363681c35", "message": "[BEAM-9770] Add BigQueryIO deadletter pattern\nDecouple .java and .py snippits commit for purpose of PR.\nAdd back changes for Snippets.java", "committedDate": "2020-05-15T21:09:58Z", "type": "commit"}, {"oid": "9d2295039fe72a87d2bc5e64d02f8c3363681c35", "url": "https://github.com/apache/beam/commit/9d2295039fe72a87d2bc5e64d02f8c3363681c35", "message": "[BEAM-9770] Add BigQueryIO deadletter pattern\nDecouple .java and .py snippits commit for purpose of PR.\nAdd back changes for Snippets.java", "committedDate": "2020-05-15T21:09:58Z", "type": "forcePushed"}]}