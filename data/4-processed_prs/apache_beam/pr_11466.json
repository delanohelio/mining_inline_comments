{"pr_number": 11466, "pr_title": "[BEAM-9787] Clear error message on UW + BQSource", "pr_createdAt": "2020-04-20T18:55:04Z", "pr_url": "https://github.com/apache/beam/pull/11466", "timeline": [{"oid": "5f5f622e3f343c1c187f5d298b91aee408b3a91c", "url": "https://github.com/apache/beam/commit/5f5f622e3f343c1c187f5d298b91aee408b3a91c", "message": "Clear error message on UW + BQSource", "committedDate": "2020-04-20T18:53:14Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTYyNzYwNQ==", "url": "https://github.com/apache/beam/pull/11466#discussion_r411627605", "bodyText": "s/Unified Worker/Dataflow runner V2 I believe.\ncc: @robertwb @ananvay for the correct wording here.", "author": "chamikaramj", "createdAt": "2020-04-20T19:17:38Z", "path": "sdks/python/apache_beam/runners/dataflow/dataflow_runner.py", "diffHunk": "@@ -91,6 +91,12 @@\n _LOGGER = logging.getLogger(__name__)\n \n \n+BQ_SOURCE_UW_ERROR = (\n+    'The Read(BigQuerySource(...)) transform is not supported with newer stack '\n+    'features (Fn API, Unified Worker, etc). Please use the transform '", "originalCommit": "5f5f622e3f343c1c187f5d298b91aee408b3a91c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTYzMzAxNA==", "url": "https://github.com/apache/beam/pull/11466#discussion_r411633014", "bodyText": "+1 -- \"Dataflow Runner v2\"", "author": "ananvay", "createdAt": "2020-04-20T19:26:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTYyNzYwNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTYzMzI0OQ==", "url": "https://github.com/apache/beam/pull/11466#discussion_r411633249", "bodyText": "Done. Waiting for their pointers on wording.", "author": "pabloem", "createdAt": "2020-04-20T19:27:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTYyNzYwNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTYyODE5MA==", "url": "https://github.com/apache/beam/pull/11466#discussion_r411628190", "bodyText": "Should we also check for experiment use_runner_v2 or is this adequate ?", "author": "chamikaramj", "createdAt": "2020-04-20T19:18:32Z", "path": "sdks/python/apache_beam/runners/dataflow/dataflow_runner.py", "diffHunk": "@@ -1182,6 +1188,11 @@ def run_Read(self, transform_node, options):\n         raise ValueError(\n             'BigQuery source is not currently available for use '\n             'in streaming pipelines.')\n+      debug_options = options.view_as(DebugOptions)\n+      use_fn_api = (debug_options.experiments and\n+                    'beam_fn_api' in debug_options.experiments)\n+      if use_fn_api:", "originalCommit": "5f5f622e3f343c1c187f5d298b91aee408b3a91c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTYzMzQ3NQ==", "url": "https://github.com/apache/beam/pull/11466#discussion_r411633475", "bodyText": "Might make sense to, perhaps even only check use_runner_v2, since that's the top-level option we're expecting users to provide (and then we internally add beam_fn_api).", "author": "ananvay", "createdAt": "2020-04-20T19:27:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTYyODE5MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTYzMzY1MA==", "url": "https://github.com/apache/beam/pull/11466#discussion_r411633650", "bodyText": "This is enough. For beam_fn_api is added along with use_runner_v2.", "author": "pabloem", "createdAt": "2020-04-20T19:27:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTYyODE5MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTYzODQ1Nw==", "url": "https://github.com/apache/beam/pull/11466#discussion_r411638457", "bodyText": "oops Harsh , I did not see your message. ^^'\nBut the source is not supported on FnApi either, though, right? so that would also help users trying Batch FnApi jobs?", "author": "pabloem", "createdAt": "2020-04-20T19:36:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTYyODE5MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTY0NTc1NQ==", "url": "https://github.com/apache/beam/pull/11466#discussion_r411645755", "bodyText": "In general, yes, but the only support way of batch fnapi is with UW -- they shouldn't be trying fnapi batch jobs without it. That said, perhaps it makes sense to check both separately (just to ensure that the --use_runner_v2 also independently triggers this check, just in case someone in the future decides to accidentally modify something)?", "author": "ananvay", "createdAt": "2020-04-20T19:48:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTYyODE5MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTY0Nzk1Ng==", "url": "https://github.com/apache/beam/pull/11466#discussion_r411647956", "bodyText": "The unit test that I've added checks both of them separately, so if either of them changes, the unit test will fail. WDYT about that?", "author": "pabloem", "createdAt": "2020-04-20T19:52:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTYyODE5MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTY0OTQxNw==", "url": "https://github.com/apache/beam/pull/11466#discussion_r411649417", "bodyText": "Yes, that sounds great, thanks!", "author": "ananvay", "createdAt": "2020-04-20T19:54:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTYyODE5MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTc2MjM5Mw==", "url": "https://github.com/apache/beam/pull/11466#discussion_r411762393", "bodyText": "One thing I want to ensure (since I'm not completely familiar with the error semantics of the functions in Python), is that this error will stop the pipeline from being submitted, and essentially be the equivalent of a C++ CheckFail? We want this error to stop everything, otherwise users might miss this.", "author": "ananvay", "createdAt": "2020-04-20T23:32:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTYyODE5MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTc2NTEwNw==", "url": "https://github.com/apache/beam/pull/11466#discussion_r411765107", "bodyText": "Yes Harsh, this will stop the pipeline from being submitted, and fail the command. The unit test also goes through this flow (trying to submit to Dataflow, and having the pipeline throw an error, and not be submitted).", "author": "pabloem", "createdAt": "2020-04-20T23:40:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTYyODE5MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTYyODczNQ==", "url": "https://github.com/apache/beam/pull/11466#discussion_r411628735", "bodyText": "fnapi_fail (to be consistent with the above check).", "author": "chamikaramj", "createdAt": "2020-04-20T19:19:30Z", "path": "sdks/python/apache_beam/runners/dataflow/dataflow_runner_test.py", "diffHunk": "@@ -258,6 +259,18 @@ def test_biqquery_read_streaming_fail(self):\n                     PipelineOptions(self.default_properties)) as p:\n         _ = p | beam.io.Read(beam.io.BigQuerySource('some.table'))\n \n+  def test_biqquery_read_uw_fail(self):", "originalCommit": "5f5f622e3f343c1c187f5d298b91aee408b3a91c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTYzMzcwNw==", "url": "https://github.com/apache/beam/pull/11466#discussion_r411633707", "bodyText": "Done.", "author": "pabloem", "createdAt": "2020-04-20T19:28:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTYyODczNQ=="}], "type": "inlineReview"}, {"oid": "7752409ed868cb78edd3679b43d85475117291ef", "url": "https://github.com/apache/beam/commit/7752409ed868cb78edd3679b43d85475117291ef", "message": "address comments", "committedDate": "2020-04-20T19:26:29Z", "type": "commit"}, {"oid": "707ee9823a8689890eef5eeb431bdb442e4dca47", "url": "https://github.com/apache/beam/commit/707ee9823a8689890eef5eeb431bdb442e4dca47", "message": "fix lint, formatter", "committedDate": "2020-04-20T19:34:47Z", "type": "commit"}]}