{"pr_number": 11399, "pr_title": "Interpolate publish credentials as expected for Maven settings.xml", "pr_createdAt": "2020-04-12T17:23:29Z", "pr_url": "https://github.com/apache/beam/pull/11399", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzUyNzE5Ng==", "url": "https://github.com/apache/beam/pull/11399#discussion_r407527196", "bodyText": "Does this not change the semantics from using the username/password found in the settings to interpreting them as environment variables names and loading them from the environment? If so, shouldn't this be configurable?", "author": "mxm", "createdAt": "2020-04-13T15:07:38Z", "path": "buildSrc/src/main/groovy/org/apache/beam/gradle/BeamModulePlugin.groovy", "diffHunk": "@@ -600,9 +600,10 @@ class BeamModulePlugin implements Plugin<Project> {\n                   ? 'apache.releases.https' : 'apache.snapshots.https')\n           def m2SettingCreds = new XmlSlurper().parse(settingsXml).servers.server.find { server -> serverId.equals(server.id.text()) }\n           if (m2SettingCreds) {\n+            def GroovyShell shell = new GroovyShell(new Binding([env:System.getenv()]))\n             credentials {\n-              username m2SettingCreds.username.text()\n-              password m2SettingCreds.password.text()\n+              username shell.evaluate('\"' + m2SettingCreds.username.text() +'\"')\n+              password shell.evaluate('\"' + m2SettingCreds.password.text() +'\"')", "originalCommit": "ee0bb68c859d99900f1ea429cf43825506477506", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzUyOTM2Ng==", "url": "https://github.com/apache/beam/pull/11399#discussion_r407529366", "bodyText": "It doesn't change semantics but expands environment variables, when present.", "author": "tweise", "createdAt": "2020-04-13T15:11:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzUyNzE5Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzUzNDM4OA==", "url": "https://github.com/apache/beam/pull/11399#discussion_r407534388", "bodyText": "At the least I have to make sure for my password not to contain $}{ or any Groovy keywords. I think this also allows arbitrary groovy code to be injected into the build code. Could we introduce a flag in the xml settings to indicate whether we have an environment variable or a plain password?", "author": "mxm", "createdAt": "2020-04-13T15:20:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzUyNzE5Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzU0NTcyNQ==", "url": "https://github.com/apache/beam/pull/11399#discussion_r407545725", "bodyText": "What about considering using a plugin to do this, there seems to be a few promising ones:\nhttps://github.com/datlowe/gradle-maven-publish-auth\nhttps://github.com/sebersole/gradle-maven-publish-auth\n(might be more as well)\nAlso, if finding an existing plugin to do this doesn't work out, what about integrating with the maven settings builder?\nhttps://github.com/apache/maven/blob/a2b800de32cdb9adc1e64a43a0fc32e3ba878103/maven-core/src/main/java/org/apache/maven/settings/MavenSettingsBuilder.java#L42", "author": "lukecwik", "createdAt": "2020-04-13T15:42:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzUyNzE5Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzYwNTY4Nw==", "url": "https://github.com/apache/beam/pull/11399#discussion_r407605687", "bodyText": "@lukecwik the gradle-maven-publish-auth plugin looks like a good fit, but AFAIK the LGPL license would be in the way of using it (hard dependency in our build system).", "author": "tweise", "createdAt": "2020-04-13T17:31:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzUyNzE5Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzY1MTMyNA==", "url": "https://github.com/apache/beam/pull/11399#discussion_r407651324", "bodyText": "I see, followed up with one plugin author: hibernate/gradle-maven-publish-auth#16 (comment)", "author": "lukecwik", "createdAt": "2020-04-13T18:54:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzUyNzE5Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzg1NzY2OA==", "url": "https://github.com/apache/beam/pull/11399#discussion_r407857668", "bodyText": "@lukecwik I found a plugin with Apache license that achieves what is required. PTAL.", "author": "tweise", "createdAt": "2020-04-14T04:20:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzUyNzE5Ng=="}], "type": "inlineReview"}, {"oid": "cd48609fbcad3a8de1e8ab6a0cc44ed16fcbadc2", "url": "https://github.com/apache/beam/commit/cd48609fbcad3a8de1e8ab6a0cc44ed16fcbadc2", "message": "maven settings.xml plugin", "committedDate": "2020-04-14T04:45:26Z", "type": "forcePushed"}, {"oid": "a562f1e3c1660f6d9f2eacc244841bcd55303469", "url": "https://github.com/apache/beam/commit/a562f1e3c1660f6d9f2eacc244841bcd55303469", "message": "Fix py37-lint", "committedDate": "2020-04-14T23:09:24Z", "type": "commit"}, {"oid": "7438265f53b85a774b32a7c65a0901dbd0636a50", "url": "https://github.com/apache/beam/commit/7438265f53b85a774b32a7c65a0901dbd0636a50", "message": "Maven compatible publish repository authentication via settings.xml\n\nAllow for expansion of environment variables as supported by Maven. Example:\n\n<server>\n   <username>${env.CREDENTIALS_MAVEN_USERNAME}</username>\n   <password>${env.CREDENTIALS_MAVEN_PASSWORD}</password>\n   <id>private-repository</id>\n</server>", "committedDate": "2020-04-14T23:09:49Z", "type": "commit"}, {"oid": "7438265f53b85a774b32a7c65a0901dbd0636a50", "url": "https://github.com/apache/beam/commit/7438265f53b85a774b32a7c65a0901dbd0636a50", "message": "Maven compatible publish repository authentication via settings.xml\n\nAllow for expansion of environment variables as supported by Maven. Example:\n\n<server>\n   <username>${env.CREDENTIALS_MAVEN_USERNAME}</username>\n   <password>${env.CREDENTIALS_MAVEN_PASSWORD}</password>\n   <id>private-repository</id>\n</server>", "committedDate": "2020-04-14T23:09:49Z", "type": "forcePushed"}]}