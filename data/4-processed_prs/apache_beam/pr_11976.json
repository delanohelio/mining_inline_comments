{"pr_number": 11976, "pr_title": "[BEAM-10169] - ParDo functions with correct output N in their error messages.", "pr_createdAt": "2020-06-10T21:59:47Z", "pr_url": "https://github.com/apache/beam/pull/11976", "timeline": [{"oid": "326ab8b84526f640f3e6d61aa893b753a4ffb363", "url": "https://github.com/apache/beam/commit/326ab8b84526f640f3e6d61aa893b753a4ffb363", "message": "[BEAM-10169]: Function output size utility\n\nAs a part of setting up more concise error messages for ParDos\nwhich work on user defined DoFns it is necessary to understand the\ndimensions return object of the DoFn. This allows us to compare\nand to recommend a suitable ParDo function.\n\nIn this patch, we introduce the FunctionOutputSize function which\nconveniences the use of reflection to get the function output\ndimension. For brevity, it is placed in the reflectx package with\nits sibling FunctionName.", "committedDate": "2020-06-06T23:26:48Z", "type": "commit"}, {"oid": "b6fe772f0140c8cccb164afdf27dc67a51906800", "url": "https://github.com/apache/beam/commit/b6fe772f0140c8cccb164afdf27dc67a51906800", "message": "[BEAM-10690] Broader coverage for outputSize func\n\nCurrently, the coverage on the FunctionOutputSize was limited to a\ntest function with a single output.\n\nIn this patch, we increase the test coverage to a function with\nmultiple outputs.", "committedDate": "2020-06-07T00:55:48Z", "type": "commit"}, {"oid": "4172dd00474a940587346e7de321150e29a31ba6", "url": "https://github.com/apache/beam/commit/4172dd00474a940587346e7de321150e29a31ba6", "message": "[BEAM-10169] ParDo recommendation helper for DoFns\n\nBEAM-10169 Highlighted the requirement for a more helpful error\nmessage when the DoFns output is misaligned with the ParDo\nfunction which was applying the DoFn on the elements.\n\nIn this patch, we introduce two new functions to help implement\nthe feature.\n\nFirst, RecommendParDo is a function that given the expected\ndimensions of a DoFn returns the ParDo to be used.\n\nSecond, ParDoErrorFormatter, a convenience function to format the\nerror to be thrown by ParDos when there is a misalignment.", "committedDate": "2020-06-08T10:22:00Z", "type": "commit"}, {"oid": "1eba969bd6579311471a3e8df3a43d48a10d6cd9", "url": "https://github.com/apache/beam/commit/1eba969bd6579311471a3e8df3a43d48a10d6cd9", "message": "[BEAM-10169] Formatted error messages for ParDo\n\nCurrently, ParDo misalignment with DoFn messages were not very\nclear to the user.\n\nIn this patch we implement the use of a error formatter to format\na more clearer error. The error clearly states which DoFn had the\nmisalignment and also recommends a ParDo to be used to correct the\nmisalignment.", "committedDate": "2020-06-09T09:28:29Z", "type": "commit"}, {"oid": "f024bf5185f81db2d47be4b4d1e558b9f2cc1d54", "url": "https://github.com/apache/beam/commit/f024bf5185f81db2d47be4b4d1e558b9f2cc1d54", "message": "Merge branch 'master' of https://github.com/apache/beam into improvement/BEAM-10169-output-n", "committedDate": "2020-06-09T10:05:50Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODQ3NTIwNw==", "url": "https://github.com/apache/beam/pull/11976#discussion_r438475207", "bodyText": "Conventionally, if there are multiple cases for a given test, they should be combined into the same function, and run as a loop.\nSee https://gobyexample.com/testing for an excellent example.\nOtherwise, this function should be named TestFunctionOutputSize_2", "author": "lostluck", "createdAt": "2020-06-11T00:16:53Z", "path": "sdks/go/pkg/beam/core/util/reflectx/functions_test.go", "diffHunk": "@@ -41,3 +45,19 @@ func TestLoadFunction(t *testing.T) {\n \t\tt.Errorf(\"got %d, wanted %d\", out[0].Int(), testFunction())\n \t}\n }\n+\n+func TestFunctionOutputSize(t *testing.T) {\n+\texpected := 1\n+\treceived := FunctionOutputSize(testFunction)\n+\tif received != expected {\n+\t\tt.Errorf(\"got %d, wanted %d\", received, expected)\n+\t}\n+}\n+\n+func TestFunction2OutputSize(t *testing.T) {", "originalCommit": "f024bf5185f81db2d47be4b4d1e558b9f2cc1d54", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTcyMzUyNw==", "url": "https://github.com/apache/beam/pull/11976#discussion_r439723527", "bodyText": "I had a look at the go by example, was very helpful. Changes in a4d5083 .", "author": "codeBehindMe", "createdAt": "2020-06-13T09:08:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODQ3NTIwNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODQ3NjY1NQ==", "url": "https://github.com/apache/beam/pull/11976#discussion_r438476655", "bodyText": "In Go, Identifiers that start with a capital letter are Exported and accessible by code importing the package. As such Exported functions form the packages external API. Not that doesn't prevent the function from being unit tested in the associated _test.go file.\nWe don't want this function as part of the Beam API surface, as it's an internal implementation detail, that isn't necessary for users to invoke directly.\nFurther, the \"er\" bit idiomatically implies that it's an interface. Eg. Closer, Writer, Reader which are interfaces for values with a Close, Write, and Read methods respectively.\nSo with all that together, consider renaming it formatParDoError.", "author": "lostluck", "createdAt": "2020-06-11T00:22:18Z", "path": "sdks/go/pkg/beam/pardo.go", "diffHunk": "@@ -414,7 +414,45 @@ func ParDo6(s Scope, dofn interface{}, col PCollection, opts ...Option) (PCollec\n func ParDo7(s Scope, dofn interface{}, col PCollection, opts ...Option) (PCollection, PCollection, PCollection, PCollection, PCollection, PCollection, PCollection) {\n \tret := MustN(TryParDo(s, dofn, col, opts...))\n \tif len(ret) != 7 {\n-\t\tpanic(fmt.Sprintf(\"expected 7 output. Found: %v\", ret))\n+\t\tpanic(ParDoErrorFormatter(dofn, ParDo7))\n \t}\n \treturn ret[0], ret[1], ret[2], ret[3], ret[4], ret[5], ret[6]\n }\n+\n+//ParDoErrorFormatter is a helper function to provide a more concise error\n+// message to the users when a DoFn and its ParDo pairing is incorrect.\n+func ParDoErrorFormatter(doFn interface{}, parDo interface{}) string {", "originalCommit": "f024bf5185f81db2d47be4b4d1e558b9f2cc1d54", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODQ3NzU0NA==", "url": "https://github.com/apache/beam/pull/11976#discussion_r438477544", "bodyText": "Same comment here, WRT exported functions being part of the external API. Please rename this to recommendParDo.", "author": "lostluck", "createdAt": "2020-06-11T00:25:46Z", "path": "sdks/go/pkg/beam/pardo.go", "diffHunk": "@@ -414,7 +414,45 @@ func ParDo6(s Scope, dofn interface{}, col PCollection, opts ...Option) (PCollec\n func ParDo7(s Scope, dofn interface{}, col PCollection, opts ...Option) (PCollection, PCollection, PCollection, PCollection, PCollection, PCollection, PCollection) {\n \tret := MustN(TryParDo(s, dofn, col, opts...))\n \tif len(ret) != 7 {\n-\t\tpanic(fmt.Sprintf(\"expected 7 output. Found: %v\", ret))\n+\t\tpanic(ParDoErrorFormatter(dofn, ParDo7))\n \t}\n \treturn ret[0], ret[1], ret[2], ret[3], ret[4], ret[5], ret[6]\n }\n+\n+//ParDoErrorFormatter is a helper function to provide a more concise error\n+// message to the users when a DoFn and its ParDo pairing is incorrect.\n+func ParDoErrorFormatter(doFn interface{}, parDo interface{}) string {\n+\tdoFnName := reflectx.FunctionName(doFn)\n+\tdoFnOutSize := reflectx.FunctionOutputSize(doFn)\n+\n+\tparDoName := reflectx.FunctionName(parDo)\n+\tparDoOutSize := reflectx.FunctionOutputSize(parDo)\n+\n+\tuseParDo := reflectx.FunctionName(RecommendParDo(doFnOutSize))\n+\treturn fmt.Sprintf(\"DoFn %v has %v outptus, but %v requires %v outputs, Use %v instead.\", doFnName, doFnOutSize, parDoName, parDoOutSize, useParDo)\n+\n+}\n+\n+// recommendParDo takes a in a DoFns emit dimension and recommends the correct\n+// ParDo to use.\n+func RecommendParDo(emitDim int) interface{} {", "originalCommit": "f024bf5185f81db2d47be4b4d1e558b9f2cc1d54", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTcyNjYxNw==", "url": "https://github.com/apache/beam/pull/11976#discussion_r439726617", "bodyText": "db99bf4", "author": "codeBehindMe", "createdAt": "2020-06-13T09:58:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODQ3NzU0NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODQ3Nzk2MA==", "url": "https://github.com/apache/beam/pull/11976#discussion_r438477960", "bodyText": "Following from the comment I made before, if this test remains stand alone, TestRecommendParDo_OneOutput is the idiomatic name.  The general form is  Test<Func/struct under test>_", "author": "lostluck", "createdAt": "2020-06-11T00:27:22Z", "path": "sdks/go/test/regression/pardo_test.go", "diffHunk": "@@ -56,3 +58,39 @@ func TestEmitParDoAfterGBK(t *testing.T) {\n \t\tt.Error(err)\n \t}\n }\n+\n+// Keep the ParDo misalignment messages concise.\n+// FIXME: Review\n+// [beam-10169] identified that the error message returned to the user when the\n+// DoFn output is misaligned with the ParDo output was unclear. in order to\n+// make the user debug experience shorter, a more concise error message is\n+// required.\n+//\n+// This suite of brittle tests are to ensure that the returned errors are adhere\n+// to the ParDo API provided by the go sdk.\n+\n+func TestRecommendParDoWithOneOutput(t *testing.T) {", "originalCommit": "f024bf5185f81db2d47be4b4d1e558b9f2cc1d54", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODQ3OTU0OQ==", "url": "https://github.com/apache/beam/pull/11976#discussion_r438479549", "bodyText": "Switch statements in Go can accept a value, so this can be rewritten as\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \tswitch {\n          \n          \n            \n            \tcase emitDim == 0:\n          \n          \n            \n            \t\treturn ParDo0\n          \n          \n            \n            \tcase emitDim == 1:\n          \n          \n            \n            \t\treturn ParDo\n          \n          \n            \n            \tcase emitDim == 2:\n          \n          \n            \n            \t\treturn ParDo2\n          \n          \n            \n            \tcase emitDim == 3:\n          \n          \n            \n            \t\treturn ParDo3\n          \n          \n            \n            \tcase emitDim == 4:\n          \n          \n            \n            \t\treturn ParDo4\n          \n          \n            \n            \tcase emitDim == 5:\n          \n          \n            \n            \t\treturn ParDo5\n          \n          \n            \n            \tcase emitDim == 6:\n          \n          \n            \n            \t\treturn ParDo6\n          \n          \n            \n            \tcase emitDim == 7:\n          \n          \n            \n            \t\treturn ParDo7\n          \n          \n            \n            \t}\n          \n          \n            \n            \treturn ParDoN\n          \n          \n            \n            }\n          \n          \n            \n            \tswitch emitDim {\n          \n          \n            \n            \tcase 0:\n          \n          \n            \n            \t\treturn ParDo0\n          \n          \n            \n            \tcase 1:\n          \n          \n            \n            \t\treturn ParDo\n          \n          \n            \n            \tcase 2:\n          \n          \n            \n            \t\treturn ParDo2\n          \n          \n            \n            \tcase 3:\n          \n          \n            \n            \t\treturn ParDo3\n          \n          \n            \n            \tcase  4:\n          \n          \n            \n            \t\treturn ParDo4\n          \n          \n            \n            \tcase 5:\n          \n          \n            \n            \t\treturn ParDo5\n          \n          \n            \n            \tcase 6:\n          \n          \n            \n            \t\treturn ParDo6\n          \n          \n            \n            \tcase 7:\n          \n          \n            \n            \t\treturn ParDo7\n          \n          \n            \n            \t}\n          \n          \n            \n            \treturn ParDoN\n          \n          \n            \n            }", "author": "lostluck", "createdAt": "2020-06-11T00:33:32Z", "path": "sdks/go/pkg/beam/pardo.go", "diffHunk": "@@ -414,7 +414,45 @@ func ParDo6(s Scope, dofn interface{}, col PCollection, opts ...Option) (PCollec\n func ParDo7(s Scope, dofn interface{}, col PCollection, opts ...Option) (PCollection, PCollection, PCollection, PCollection, PCollection, PCollection, PCollection) {\n \tret := MustN(TryParDo(s, dofn, col, opts...))\n \tif len(ret) != 7 {\n-\t\tpanic(fmt.Sprintf(\"expected 7 output. Found: %v\", ret))\n+\t\tpanic(ParDoErrorFormatter(dofn, ParDo7))\n \t}\n \treturn ret[0], ret[1], ret[2], ret[3], ret[4], ret[5], ret[6]\n }\n+\n+//ParDoErrorFormatter is a helper function to provide a more concise error\n+// message to the users when a DoFn and its ParDo pairing is incorrect.\n+func ParDoErrorFormatter(doFn interface{}, parDo interface{}) string {\n+\tdoFnName := reflectx.FunctionName(doFn)\n+\tdoFnOutSize := reflectx.FunctionOutputSize(doFn)\n+\n+\tparDoName := reflectx.FunctionName(parDo)\n+\tparDoOutSize := reflectx.FunctionOutputSize(parDo)\n+\n+\tuseParDo := reflectx.FunctionName(RecommendParDo(doFnOutSize))\n+\treturn fmt.Sprintf(\"DoFn %v has %v outptus, but %v requires %v outputs, Use %v instead.\", doFnName, doFnOutSize, parDoName, parDoOutSize, useParDo)\n+\n+}\n+\n+// recommendParDo takes a in a DoFns emit dimension and recommends the correct\n+// ParDo to use.\n+func RecommendParDo(emitDim int) interface{} {\n+\tswitch {\n+\tcase emitDim == 0:\n+\t\treturn ParDo0\n+\tcase emitDim == 1:\n+\t\treturn ParDo\n+\tcase emitDim == 2:\n+\t\treturn ParDo2\n+\tcase emitDim == 3:\n+\t\treturn ParDo3\n+\tcase emitDim == 4:\n+\t\treturn ParDo4\n+\tcase emitDim == 5:\n+\t\treturn ParDo5\n+\tcase emitDim == 6:\n+\t\treturn ParDo6\n+\tcase emitDim == 7:\n+\t\treturn ParDo7\n+\t}\n+\treturn ParDoN\n+}", "originalCommit": "f024bf5185f81db2d47be4b4d1e558b9f2cc1d54", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODUzNDEzMg==", "url": "https://github.com/apache/beam/pull/11976#discussion_r438534132", "bodyText": "What I'd recommend here instead though is to return a string instead of the function.\nswitch emitDim {\n case 0,2,3,4,5,6,7:\n  return fmt.Sprintf(\"ParDo%d\", emitDim)\ncase 1:\n  return \"ParDo\"  \ndefault:\n  return \"ParDoN\"\n}\n\nEasier to read, and see if it's correct. Read Effective Go for more about Switches", "author": "lostluck", "createdAt": "2020-06-11T04:20:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODQ3OTU0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTcyNjYwMg==", "url": "https://github.com/apache/beam/pull/11976#discussion_r439726602", "bodyText": "db99bf4", "author": "codeBehindMe", "createdAt": "2020-06-13T09:58:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODQ3OTU0OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODUzNDQ4MQ==", "url": "https://github.com/apache/beam/pull/11976#discussion_r438534481", "bodyText": "Consider putting this into the beam_test package rather than in the go regression test package. This package is intended for bugs when interacting with runners, which is harder to test independantly in the Go unit tests.\nIn particular, I recommend adding a new test file:\n.../sdks/go/pkg/beam/pardo_test.go\nThe main \"gotcha\" is you should copy the License header to the top of the file, as that's a requirement for the project.", "author": "lostluck", "createdAt": "2020-06-11T04:21:47Z", "path": "sdks/go/test/regression/pardo_test.go", "diffHunk": "@@ -16,6 +16,8 @@\n package regression", "originalCommit": "f024bf5185f81db2d47be4b4d1e558b9f2cc1d54", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODU0MDg2Nw==", "url": "https://github.com/apache/beam/pull/11976#discussion_r438540867", "bodyText": "Note that regardless of the DoFn we need to check the expectations for every value against a given constant.\nConsider wrapping the whole if block in the new function instead, and passing in the DoFn (so we can get the name), ret for the number of outputs, and the expected number of outputs from the constant. The function can be called mustHaveOutputs() . This way we can avoid specifying the expected number of outputs twice (in the if condition, and in the message) because it'll be in a function parameter.\n(In Go, a Must prefix indicates the function will panic if the operation fails, rather than return an error. Usually they're discouraged, but in this case we have no choice but to panic. The ParDo functions could be described as Must functions, but that would get tiring WRT pipeline construction very quickly, so the shorter version without must, but with a Try prefix variant for the one Error handling version (TryParDo) was chosen instead.)", "author": "lostluck", "createdAt": "2020-06-11T04:49:31Z", "path": "sdks/go/pkg/beam/pardo.go", "diffHunk": "@@ -414,7 +414,45 @@ func ParDo6(s Scope, dofn interface{}, col PCollection, opts ...Option) (PCollec\n func ParDo7(s Scope, dofn interface{}, col PCollection, opts ...Option) (PCollection, PCollection, PCollection, PCollection, PCollection, PCollection, PCollection) {\n \tret := MustN(TryParDo(s, dofn, col, opts...))\n \tif len(ret) != 7 {", "originalCommit": "f024bf5185f81db2d47be4b4d1e558b9f2cc1d54", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODU0MTIwOQ==", "url": "https://github.com/apache/beam/pull/11976#discussion_r438541209", "bodyText": "Style wise, you should have a space after the // and before the function name.", "author": "lostluck", "createdAt": "2020-06-11T04:50:52Z", "path": "sdks/go/pkg/beam/core/util/reflectx/functions.go", "diffHunk": "@@ -45,3 +45,13 @@ func LoadFunction(ptr uintptr, t reflect.Type) interface{} {\n \t*(*unsafe.Pointer)(unsafe.Pointer(v.Addr().Pointer())) = unsafe.Pointer(p)\n \treturn v.Interface()\n }\n+\n+//FunctionOutputSize returns the dimensions of the output of a function.", "originalCommit": "f024bf5185f81db2d47be4b4d1e558b9f2cc1d54", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODU0MTQzNw==", "url": "https://github.com/apache/beam/pull/11976#discussion_r438541437", "bodyText": "Per other comments, I don't think this function is necessary, as fun and cool reflection is, using it should be avoided unless impossible because it complicates maintenance.\n\nDoFns can be structs instead, with a ProcessElement method.\nDoFn outputs in a function signature aren't directly related to the function outputs, so this is incorrect.\n\nDoFns can have \"emitter functions\" as parameters, which are used to output 0 or more values to the Nth PCollection of the ParDo. The main return (if one exists) is always the first PCollection, and they proceed from there. Similarly\neg. a function with the signature\nfunc(K,V string, e1, e2, e3 func(string)) (string, string) would require a ParDo4 since it takes a PCollection<KV<string,string>> as an input, and has 4 outputs.\nThe first output is a KV<string,string>, and then there are 3 PCollection as well.", "author": "lostluck", "createdAt": "2020-06-11T04:51:50Z", "path": "sdks/go/pkg/beam/core/util/reflectx/functions.go", "diffHunk": "@@ -45,3 +45,13 @@ func LoadFunction(ptr uintptr, t reflect.Type) interface{} {\n \t*(*unsafe.Pointer)(unsafe.Pointer(v.Addr().Pointer())) = unsafe.Pointer(p)\n \treturn v.Interface()\n }\n+\n+//FunctionOutputSize returns the dimensions of the output of a function.\n+// Panics if the type is not a function.\n+func FunctionOutputSize(fn interface{}) int {", "originalCommit": "f024bf5185f81db2d47be4b4d1e558b9f2cc1d54", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODcxMDA2Mw==", "url": "https://github.com/apache/beam/pull/11976#discussion_r438710063", "bodyText": "Hmm I see, perhaps I've gone down a wrong path here then, let me have another review of the code and see what existing tooling is there to resolve this.", "author": "codeBehindMe", "createdAt": "2020-06-11T11:11:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODU0MTQzNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDExMDM5Mg==", "url": "https://github.com/apache/beam/pull/11976#discussion_r440110392", "bodyText": "8c9e030", "author": "codeBehindMe", "createdAt": "2020-06-15T11:30:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODU0MTQzNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODU0MTYyMw==", "url": "https://github.com/apache/beam/pull/11976#discussion_r438541623", "bodyText": "DoFns in the Go SDK can be Structs instead of funcs, which means these functions will panic with less helpful error messages since they won't be functions.\nHowever, we know about this already, so we have a suite of Go SDK internal functions to handle this. In this case You want graph.Fn which returns a graph.Fn which has a Name() method which can be used to get the DoFn's name.", "author": "lostluck", "createdAt": "2020-06-11T04:52:38Z", "path": "sdks/go/pkg/beam/pardo.go", "diffHunk": "@@ -414,7 +414,45 @@ func ParDo6(s Scope, dofn interface{}, col PCollection, opts ...Option) (PCollec\n func ParDo7(s Scope, dofn interface{}, col PCollection, opts ...Option) (PCollection, PCollection, PCollection, PCollection, PCollection, PCollection, PCollection) {\n \tret := MustN(TryParDo(s, dofn, col, opts...))\n \tif len(ret) != 7 {\n-\t\tpanic(fmt.Sprintf(\"expected 7 output. Found: %v\", ret))\n+\t\tpanic(ParDoErrorFormatter(dofn, ParDo7))\n \t}\n \treturn ret[0], ret[1], ret[2], ret[3], ret[4], ret[5], ret[6]\n }\n+\n+//ParDoErrorFormatter is a helper function to provide a more concise error\n+// message to the users when a DoFn and its ParDo pairing is incorrect.\n+func ParDoErrorFormatter(doFn interface{}, parDo interface{}) string {\n+\tdoFnName := reflectx.FunctionName(doFn)", "originalCommit": "f024bf5185f81db2d47be4b4d1e558b9f2cc1d54", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTcyOTMyMw==", "url": "https://github.com/apache/beam/pull/11976#discussion_r439729323", "bodyText": "@lostluck , do we cast it from interface{} to graph.Fn type? Is that safe to do so?", "author": "codeBehindMe", "createdAt": "2020-06-13T10:43:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODU0MTYyMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTcyOTg4Nw==", "url": "https://github.com/apache/beam/pull/11976#discussion_r439729887", "bodyText": "I used the FunctionName from the reflectx package because what's passed through to ParDo is a interface{} type.", "author": "codeBehindMe", "createdAt": "2020-06-13T10:52:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODU0MTYyMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTc2NTExOA==", "url": "https://github.com/apache/beam/pull/11976#discussion_r439765118", "bodyText": "I see where the confusion is coming in. What I meant was to call graph.NewFn(doFn) which will return the graph.Fn value which you can then call Name() on.\nhttps://github.com/apache/beam/blob/master/sdks/go/pkg/beam/core/graph/fn.go#L78\nAt the point you're calling it, you already know it's going to be valid (since it was called by the TryParDo earlier).  Go isn't magic, and won't change the type of an interface{} value unless assigned explicitly (which won't happen in this scope). interface{} values are passed by value, so even if you change the type them they'll remain the same in the outer scope: See an example here https://play.golang.org/p/A5QDrGyRwUu", "author": "lostluck", "createdAt": "2020-06-13T19:59:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODU0MTYyMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDEwNjY2Ng==", "url": "https://github.com/apache/beam/pull/11976#discussion_r440106666", "bodyText": "45f4a84", "author": "codeBehindMe", "createdAt": "2020-06-15T11:22:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODU0MTYyMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODU0MTc3NA==", "url": "https://github.com/apache/beam/pull/11976#discussion_r438541774", "bodyText": "typo: outputs\nThe \"Use\" should be \"use\",", "author": "lostluck", "createdAt": "2020-06-11T04:53:09Z", "path": "sdks/go/pkg/beam/pardo.go", "diffHunk": "@@ -414,7 +414,45 @@ func ParDo6(s Scope, dofn interface{}, col PCollection, opts ...Option) (PCollec\n func ParDo7(s Scope, dofn interface{}, col PCollection, opts ...Option) (PCollection, PCollection, PCollection, PCollection, PCollection, PCollection, PCollection) {\n \tret := MustN(TryParDo(s, dofn, col, opts...))\n \tif len(ret) != 7 {\n-\t\tpanic(fmt.Sprintf(\"expected 7 output. Found: %v\", ret))\n+\t\tpanic(ParDoErrorFormatter(dofn, ParDo7))\n \t}\n \treturn ret[0], ret[1], ret[2], ret[3], ret[4], ret[5], ret[6]\n }\n+\n+//ParDoErrorFormatter is a helper function to provide a more concise error\n+// message to the users when a DoFn and its ParDo pairing is incorrect.\n+func ParDoErrorFormatter(doFn interface{}, parDo interface{}) string {\n+\tdoFnName := reflectx.FunctionName(doFn)\n+\tdoFnOutSize := reflectx.FunctionOutputSize(doFn)\n+\n+\tparDoName := reflectx.FunctionName(parDo)\n+\tparDoOutSize := reflectx.FunctionOutputSize(parDo)\n+\n+\tuseParDo := reflectx.FunctionName(RecommendParDo(doFnOutSize))\n+\treturn fmt.Sprintf(\"DoFn %v has %v outptus, but %v requires %v outputs, Use %v instead.\", doFnName, doFnOutSize, parDoName, parDoOutSize, useParDo)", "originalCommit": "f024bf5185f81db2d47be4b4d1e558b9f2cc1d54", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDEwNzU1MQ==", "url": "https://github.com/apache/beam/pull/11976#discussion_r440107551", "bodyText": "45f4a84", "author": "codeBehindMe", "createdAt": "2020-06-15T11:24:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODU0MTc3NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODU0MzcyMA==", "url": "https://github.com/apache/beam/pull/11976#discussion_r438543720", "bodyText": "Idiomatically, Go uses \"got and want\" as the variables, as well as in the test error output.", "author": "lostluck", "createdAt": "2020-06-11T05:01:43Z", "path": "sdks/go/pkg/beam/core/util/reflectx/functions_test.go", "diffHunk": "@@ -41,3 +45,19 @@ func TestLoadFunction(t *testing.T) {\n \t\tt.Errorf(\"got %d, wanted %d\", out[0].Int(), testFunction())\n \t}\n }\n+\n+func TestFunctionOutputSize(t *testing.T) {\n+\texpected := 1\n+\treceived := FunctionOutputSize(testFunction)\n+\tif received != expected {\n+\t\tt.Errorf(\"got %d, wanted %d\", received, expected)\n+\t}\n+}\n+\n+func TestFunction2OutputSize(t *testing.T) {\n+\texpected := 2\n+\treceived := FunctionOutputSize(testFunction2)", "originalCommit": "f024bf5185f81db2d47be4b4d1e558b9f2cc1d54", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTcyNjg0NA==", "url": "https://github.com/apache/beam/pull/11976#discussion_r439726844", "bodyText": "a4d5083", "author": "codeBehindMe", "createdAt": "2020-06-13T10:02:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODU0MzcyMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODU0NDEwMg==", "url": "https://github.com/apache/beam/pull/11976#discussion_r438544102", "bodyText": "It should be possible for a user to not look at the test code to understand what happened for this test.\nSo a better test output would be:\nt.Errorf(\"FunctionOutputSize(%v) =  %d, want %d\", <testfunctionname/signature>,received, expected)", "author": "lostluck", "createdAt": "2020-06-11T05:03:22Z", "path": "sdks/go/pkg/beam/core/util/reflectx/functions_test.go", "diffHunk": "@@ -41,3 +45,19 @@ func TestLoadFunction(t *testing.T) {\n \t\tt.Errorf(\"got %d, wanted %d\", out[0].Int(), testFunction())\n \t}\n }\n+\n+func TestFunctionOutputSize(t *testing.T) {\n+\texpected := 1\n+\treceived := FunctionOutputSize(testFunction)\n+\tif received != expected {\n+\t\tt.Errorf(\"got %d, wanted %d\", received, expected)\n+\t}\n+}\n+\n+func TestFunction2OutputSize(t *testing.T) {\n+\texpected := 2\n+\treceived := FunctionOutputSize(testFunction2)\n+\tif received != expected {\n+\t\tt.Errorf(\"got %d, wanted %d\", received, expected)", "originalCommit": "f024bf5185f81db2d47be4b4d1e558b9f2cc1d54", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTcyODU3Mw==", "url": "https://github.com/apache/beam/pull/11976#discussion_r439728573", "bodyText": "945dc7a", "author": "codeBehindMe", "createdAt": "2020-06-13T10:31:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODU0NDEwMg=="}], "type": "inlineReview"}, {"oid": "a4d5083dbf2f07d50dd6d360635314e7f49124a6", "url": "https://github.com/apache/beam/commit/a4d5083dbf2f07d50dd6d360635314e7f49124a6", "message": "[BEAM-10169] Made more idiomatic go tests\n\nCurrently the tests written to gest the FunctionOutputSize function did\nnot follow an idiomatic go testing structure.\n\nIn this patch, we structure the tests in a way that is more familiar to\nother gophers.", "committedDate": "2020-06-13T09:04:19Z", "type": "commit"}, {"oid": "db99bf446ac38a68291983c222755cdaea0f1de3", "url": "https://github.com/apache/beam/commit/db99bf446ac38a68291983c222755cdaea0f1de3", "message": "[BEAM-10169] Internalised recommendParDo function\n\nCurrently, an inernal function used for recommending the correct ParDo\npairing for a DoFn was being exported to the user of the API. In addition\nit was not an idomatically written function. The tests for this function\nwere also incorrectly placed in a different package and not in the correct\n_test.go file in the same package.\n\nIn this patch, we remove the exporting of this function to the beam users,\nin addition, we provide a more idomatic representation of this function.\nThe tests are correctly placed in the _test.go file in the beam package.", "committedDate": "2020-06-13T09:51:43Z", "type": "commit"}, {"oid": "945dc7a264b94ac4386f3b8f55b093bb9b07728d", "url": "https://github.com/apache/beam/commit/945dc7a264b94ac4386f3b8f55b093bb9b07728d", "message": "[BEAM-10169] Cleaner formatted error message.", "committedDate": "2020-06-13T10:11:05Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTc2NTIzNA==", "url": "https://github.com/apache/beam/pull/11976#discussion_r439765234", "bodyText": "Note that now that you've changed the return type of recommendParDo, you don't need to call reflectx.FunctionName anymore.", "author": "lostluck", "createdAt": "2020-06-13T20:00:56Z", "path": "sdks/go/pkg/beam/pardo.go", "diffHunk": "@@ -428,31 +428,20 @@ func ParDoErrorFormatter(doFn interface{}, parDo interface{}) string {\n \tparDoName := reflectx.FunctionName(parDo)\n \tparDoOutSize := reflectx.FunctionOutputSize(parDo)\n \n-\tuseParDo := reflectx.FunctionName(RecommendParDo(doFnOutSize))\n+\tuseParDo := reflectx.FunctionName(recommendParDo(doFnOutSize))", "originalCommit": "945dc7a264b94ac4386f3b8f55b093bb9b07728d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDEwNzYxMQ==", "url": "https://github.com/apache/beam/pull/11976#discussion_r440107611", "bodyText": "45f4a84", "author": "codeBehindMe", "createdAt": "2020-06-15T11:24:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTc2NTIzNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTc2NTMzOQ==", "url": "https://github.com/apache/beam/pull/11976#discussion_r439765339", "bodyText": "The name needs to be updated here: recommendParDo", "author": "lostluck", "createdAt": "2020-06-13T20:02:36Z", "path": "sdks/go/pkg/beam/pardo_test.go", "diffHunk": "@@ -0,0 +1,40 @@\n+// Licensed to the Apache Software Foundation (ASF) under one or more\n+// contributor license agreements.  See the NOTICE file distributed with\n+// this work for additional information regarding copyright ownership.\n+// The ASF licenses this file to You under the Apache License, Version 2.0\n+// (the \"License\"); you may not use this file except in compliance with\n+// the License.  You may obtain a copy of the License at\n+//\n+//    http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing, software\n+// distributed under the License is distributed on an \"AS IS\" BASIS,\n+// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+// See the License for the specific language governing permissions and\n+// limitations under the License.\n+\n+package beam\n+\n+import \"testing\"\n+\n+func TestRecommendParDo(t *testing.T) {\n+\tvar tests = []struct {\n+\t\tname      string\n+\t\toutputDim int\n+\t\twant      string\n+\t}{\n+\t\t{\"zero outputs\", 0, \"ParDo0\"},\n+\t\t{\"one output\", 1, \"ParDo\"},\n+\t\t{\"more than 7 outputs\", 10, \"ParDoN\"},\n+\t}\n+\n+\tfor _, tt := range tests {\n+\t\ttestName := tt.name\n+\t\tt.Run(testName, func(t *testing.T) {\n+\t\t\tgot := recommendParDo(tt.outputDim)\n+\t\t\tif got != tt.want {\n+\t\t\t\tt.Errorf(\"RecommendParDo(%v) = %v, want %v\", tt.outputDim, got, tt.want)", "originalCommit": "945dc7a264b94ac4386f3b8f55b093bb9b07728d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDEwNzk3OA==", "url": "https://github.com/apache/beam/pull/11976#discussion_r440107978", "bodyText": "db99bf4", "author": "codeBehindMe", "createdAt": "2020-06-15T11:25:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTc2NTMzOQ=="}], "type": "inlineReview"}, {"oid": "45f4a84e57f2392c63d2960a05769350b7d82a18", "url": "https://github.com/apache/beam/commit/45f4a84e57f2392c63d2960a05769350b7d82a18", "message": "[BEAM-10169] formatParDoError fixed for DoFn\n\nCurrently, the formatParDo error function had a number of flaws with its\nAPI and implementation which made it unsuitable for its intent. This was\nhilighted in the code review process, which resulted in a number of\nrecommendations including, dropping the use of reflection, removing its\nexposure as a public function and renaming the function to be more\nidomatic to gophers.\n\nIn this patch, we implement the above requests. We also introduce a test\nin the pard_test.go file, which takes a sample function and tests what\nthe formatted error is when a formatParDoError is called on it.", "committedDate": "2020-06-15T11:18:10Z", "type": "commit"}, {"oid": "8c9e030351bd55d830b324cfe53b157835e4d0e8", "url": "https://github.com/apache/beam/commit/8c9e030351bd55d830b324cfe53b157835e4d0e8", "message": "[BEAM-10169] Removed FunctionOutputSize\n\nCurrently, as a part of BEAM-10169, a new helper function was introduced\nto the reflectx package. However code review showed that this was not\nneeded.\n\nIn this patch, we simply remove this function.", "committedDate": "2020-06-15T11:28:17Z", "type": "commit"}, {"oid": "17ebec9d3fc8e5d23296de7ec915474920bbafc4", "url": "https://github.com/apache/beam/commit/17ebec9d3fc8e5d23296de7ec915474920bbafc4", "message": "[BEAM-10169] Minor formatting changes", "committedDate": "2020-06-15T11:31:46Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDMxMTY2Ng==", "url": "https://github.com/apache/beam/pull/11976#discussion_r440311666", "bodyText": "Ah clever! But not in the hard to debug way. :D I like it.\nOptional Nit: It's no longer really recommending, but naming the appropriate DoFn for the size in this use. parDoForSize might be a more accurate name, but, honestly, either is fine.\nHad there only been the one call, I'd have suggested inlining it since the switch isn't that large.\nEither way, since it's being used twice, that justifies that switch being in it's own function.", "author": "lostluck", "createdAt": "2020-06-15T16:49:29Z", "path": "sdks/go/pkg/beam/pardo.go", "diffHunk": "@@ -414,7 +412,36 @@ func ParDo6(s Scope, dofn interface{}, col PCollection, opts ...Option) (PCollec\n func ParDo7(s Scope, dofn interface{}, col PCollection, opts ...Option) (PCollection, PCollection, PCollection, PCollection, PCollection, PCollection, PCollection) {\n \tret := MustN(TryParDo(s, dofn, col, opts...))\n \tif len(ret) != 7 {\n-\t\tpanic(fmt.Sprintf(\"expected 7 output. Found: %v\", ret))\n+\t\tpanic(formatParDoError(dofn, len(ret), 7))\n \t}\n \treturn ret[0], ret[1], ret[2], ret[3], ret[4], ret[5], ret[6]\n }\n+\n+//formatParDoError is a helper function to provide a more concise error\n+// message to the users when a DoFn and its ParDo pairing is incorrect.\n+//\n+// We construct a new graph.Fn using the doFn which is passed. We explicitly\n+// ignore the error since we already know that its already a DoFn type as\n+// TryParDo would have panicked otherwise.\n+func formatParDoError(doFn interface{}, emitSize int, parDoSize int) string {\n+\tdoFun, _ := graph.NewFn(doFn)\n+\tdoFnName := doFun.Name()\n+\n+\tthisParDo := recommendParDo(parDoSize) // Conveniently keeps the API slim.", "originalCommit": "17ebec9d3fc8e5d23296de7ec915474920bbafc4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDUzMTY3NA==", "url": "https://github.com/apache/beam/pull/11976#discussion_r440531674", "bodyText": "I like brevity, I will implement this.", "author": "codeBehindMe", "createdAt": "2020-06-16T01:17:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDMxMTY2Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDcyNTg1OA==", "url": "https://github.com/apache/beam/pull/11976#discussion_r440725858", "bodyText": "b31ab3a", "author": "codeBehindMe", "createdAt": "2020-06-16T09:47:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDMxMTY2Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDMxNjc5NQ==", "url": "https://github.com/apache/beam/pull/11976#discussion_r440316795", "bodyText": "It might be worth commenting here that this function is just to validate that the name is sourced properly in TestFormatParDoError since the number of errors don't match.", "author": "lostluck", "createdAt": "2020-06-15T16:58:12Z", "path": "sdks/go/pkg/beam/pardo_test.go", "diffHunk": "@@ -0,0 +1,54 @@\n+// Licensed to the Apache Software Foundation (ASF) under one or more\n+// contributor license agreements.  See the NOTICE file distributed with\n+// this work for additional information regarding copyright ownership.\n+// The ASF licenses this file to You under the Apache License, Version 2.0\n+// (the \"License\"); you may not use this file except in compliance with\n+// the License.  You may obtain a copy of the License at\n+//\n+//    http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing, software\n+// distributed under the License is distributed on an \"AS IS\" BASIS,\n+// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+// See the License for the specific language governing permissions and\n+// limitations under the License.\n+\n+package beam\n+\n+import (\n+\t\"testing\"\n+)\n+\n+func TestRecommendParDo(t *testing.T) {\n+\tvar tests = []struct {\n+\t\tname      string\n+\t\toutputDim int\n+\t\twant      string\n+\t}{\n+\t\t{\"zero outputs\", 0, \"ParDo0\"},\n+\t\t{\"one output\", 1, \"ParDo\"},\n+\t\t{\"more than 7 outputs\", 10, \"ParDoN\"},\n+\t}\n+\n+\tfor _, tt := range tests {\n+\t\ttestName := tt.name\n+\t\tt.Run(testName, func(t *testing.T) {\n+\t\t\tgot := recommendParDo(tt.outputDim)\n+\t\t\tif got != tt.want {\n+\t\t\t\tt.Errorf(\"RecommendParDo(%v) = %v, want %v\", tt.outputDim, got, tt.want)\n+\t\t\t}\n+\t\t})\n+\t}\n+}\n+\n+func testFunction() int64 {", "originalCommit": "17ebec9d3fc8e5d23296de7ec915474920bbafc4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDUzMTgxOA==", "url": "https://github.com/apache/beam/pull/11976#discussion_r440531818", "bodyText": "Good idea, I will implement this. Thanks.", "author": "codeBehindMe", "createdAt": "2020-06-16T01:17:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDMxNjc5NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDcyNTc5Nw==", "url": "https://github.com/apache/beam/pull/11976#discussion_r440725797", "bodyText": "0affb73", "author": "codeBehindMe", "createdAt": "2020-06-16T09:47:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDMxNjc5NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDMyMDIzNg==", "url": "https://github.com/apache/beam/pull/11976#discussion_r440320236", "bodyText": "Please add  3 more test cases here for 2 and 7,8 to cover those boundary conditions.", "author": "lostluck", "createdAt": "2020-06-15T17:04:18Z", "path": "sdks/go/pkg/beam/pardo_test.go", "diffHunk": "@@ -0,0 +1,54 @@\n+// Licensed to the Apache Software Foundation (ASF) under one or more\n+// contributor license agreements.  See the NOTICE file distributed with\n+// this work for additional information regarding copyright ownership.\n+// The ASF licenses this file to You under the Apache License, Version 2.0\n+// (the \"License\"); you may not use this file except in compliance with\n+// the License.  You may obtain a copy of the License at\n+//\n+//    http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing, software\n+// distributed under the License is distributed on an \"AS IS\" BASIS,\n+// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+// See the License for the specific language governing permissions and\n+// limitations under the License.\n+\n+package beam\n+\n+import (\n+\t\"testing\"\n+)\n+\n+func TestRecommendParDo(t *testing.T) {\n+\tvar tests = []struct {\n+\t\tname      string\n+\t\toutputDim int\n+\t\twant      string\n+\t}{\n+\t\t{\"zero outputs\", 0, \"ParDo0\"},\n+\t\t{\"one output\", 1, \"ParDo\"},", "originalCommit": "17ebec9d3fc8e5d23296de7ec915474920bbafc4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDUzMTkxOA==", "url": "https://github.com/apache/beam/pull/11976#discussion_r440531918", "bodyText": "Will do. Cheers.", "author": "codeBehindMe", "createdAt": "2020-06-16T01:18:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDMyMDIzNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDcyOTgzMw==", "url": "https://github.com/apache/beam/pull/11976#discussion_r440729833", "bodyText": "d9b5ef0", "author": "codeBehindMe", "createdAt": "2020-06-16T09:54:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDMyMDIzNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDMyMTgzNw==", "url": "https://github.com/apache/beam/pull/11976#discussion_r440321837", "bodyText": "Since the \"complicated\" bit for this is in the recommendParDo code, which is already being tested very well, this test should be sufficient for the parts in formatParDoError. I don't expect the formatting to change any time soon.\nWe do have the english grammar nit (\"1 outputs\"), but handling that grammar correction isn't worth the extra code to resolve it.", "author": "lostluck", "createdAt": "2020-06-15T17:07:15Z", "path": "sdks/go/pkg/beam/pardo_test.go", "diffHunk": "@@ -0,0 +1,54 @@\n+// Licensed to the Apache Software Foundation (ASF) under one or more\n+// contributor license agreements.  See the NOTICE file distributed with\n+// this work for additional information regarding copyright ownership.\n+// The ASF licenses this file to You under the Apache License, Version 2.0\n+// (the \"License\"); you may not use this file except in compliance with\n+// the License.  You may obtain a copy of the License at\n+//\n+//    http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing, software\n+// distributed under the License is distributed on an \"AS IS\" BASIS,\n+// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+// See the License for the specific language governing permissions and\n+// limitations under the License.\n+\n+package beam\n+\n+import (\n+\t\"testing\"\n+)\n+\n+func TestRecommendParDo(t *testing.T) {\n+\tvar tests = []struct {\n+\t\tname      string\n+\t\toutputDim int\n+\t\twant      string\n+\t}{\n+\t\t{\"zero outputs\", 0, \"ParDo0\"},\n+\t\t{\"one output\", 1, \"ParDo\"},\n+\t\t{\"more than 7 outputs\", 10, \"ParDoN\"},\n+\t}\n+\n+\tfor _, tt := range tests {\n+\t\ttestName := tt.name\n+\t\tt.Run(testName, func(t *testing.T) {\n+\t\t\tgot := recommendParDo(tt.outputDim)\n+\t\t\tif got != tt.want {\n+\t\t\t\tt.Errorf(\"RecommendParDo(%v) = %v, want %v\", tt.outputDim, got, tt.want)\n+\t\t\t}\n+\t\t})\n+\t}\n+}\n+\n+func testFunction() int64 {\n+\treturn 42\n+}\n+\n+func TestFormatParDoError(t *testing.T) {\n+\tgot := formatParDoError(testFunction, 2, 1)", "originalCommit": "17ebec9d3fc8e5d23296de7ec915474920bbafc4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDUzMjUzOQ==", "url": "https://github.com/apache/beam/pull/11976#discussion_r440532539", "bodyText": "I'm open to spend a bit more time to do this, or would you like me to remove the test here?\nI agree, covering the the recommendParDo function is more important. Happy to defer to your decision here.", "author": "codeBehindMe", "createdAt": "2020-06-16T01:20:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDMyMTgzNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTE1NzIwMg==", "url": "https://github.com/apache/beam/pull/11976#discussion_r441157202", "bodyText": "Please do keep the test! My comment was that because the logic that's unique to formatParDoError is so small, the test can also be small.", "author": "lostluck", "createdAt": "2020-06-16T21:38:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDMyMTgzNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDMyMjI2NA==", "url": "https://github.com/apache/beam/pull/11976#discussion_r440322264", "bodyText": "Nit: add a space between // and formatParDoError", "author": "lostluck", "createdAt": "2020-06-15T17:08:01Z", "path": "sdks/go/pkg/beam/pardo.go", "diffHunk": "@@ -414,7 +412,36 @@ func ParDo6(s Scope, dofn interface{}, col PCollection, opts ...Option) (PCollec\n func ParDo7(s Scope, dofn interface{}, col PCollection, opts ...Option) (PCollection, PCollection, PCollection, PCollection, PCollection, PCollection, PCollection) {\n \tret := MustN(TryParDo(s, dofn, col, opts...))\n \tif len(ret) != 7 {\n-\t\tpanic(fmt.Sprintf(\"expected 7 output. Found: %v\", ret))\n+\t\tpanic(formatParDoError(dofn, len(ret), 7))\n \t}\n \treturn ret[0], ret[1], ret[2], ret[3], ret[4], ret[5], ret[6]\n }\n+\n+//formatParDoError is a helper function to provide a more concise error", "originalCommit": "17ebec9d3fc8e5d23296de7ec915474920bbafc4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDUzNDMzOQ==", "url": "https://github.com/apache/beam/pull/11976#discussion_r440534339", "bodyText": "7c612c9", "author": "codeBehindMe", "createdAt": "2020-06-16T01:27:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDMyMjI2NA=="}], "type": "inlineReview"}, {"oid": "7c612c9db29e94e8438c336434a559374363dc10", "url": "https://github.com/apache/beam/commit/7c612c9db29e94e8438c336434a559374363dc10", "message": "[BEAM-10169] Minor formatting changes", "committedDate": "2020-06-16T01:27:05Z", "type": "commit"}, {"oid": "b31ab3a8854d314b7aab4c608db2ee30ec97eb48", "url": "https://github.com/apache/beam/commit/b31ab3a8854d314b7aab4c608db2ee30ec97eb48", "message": "[BEAM-10169] Renamed function for brevity", "committedDate": "2020-06-16T09:42:20Z", "type": "commit"}, {"oid": "0affb736559c9159845111f97bb6fc7ad541f058", "url": "https://github.com/apache/beam/commit/0affb736559c9159845111f97bb6fc7ad541f058", "message": "[BEAM-10169] Added function description to test function", "committedDate": "2020-06-16T09:47:22Z", "type": "commit"}, {"oid": "d9b5ef08e9421e010900bc83f8e73dd10f6dd563", "url": "https://github.com/apache/beam/commit/d9b5ef08e9421e010900bc83f8e73dd10f6dd563", "message": "[BEAM=10169] Test coverage and name changed\n\nCurrently, the test coverage for parDoForSize function had some cases but\ndid not cover all corner cases. In addition, the name of the test was\nTestRecommendParDo which did not reflect the proper function which was\nbeing tested, parDoForSize which had been changed in a previous commit.\n\nIn this patch, we introduce 3 new corner cases to increase the robustness\nof the tests. We also correct the test name to be TestParDoForSize.", "committedDate": "2020-06-16T09:51:03Z", "type": "commit"}]}