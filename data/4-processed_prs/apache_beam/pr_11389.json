{"pr_number": 11389, "pr_title": "Refactor the BCJ and capture controls to be more testable", "pr_createdAt": "2020-04-10T21:10:27Z", "pr_url": "https://github.com/apache/beam/pull/11389", "timeline": [{"oid": "73a0570167b9b32d08cc62caab0579ead75b9a79", "url": "https://github.com/apache/beam/commit/73a0570167b9b32d08cc62caab0579ead75b9a79", "message": "Refactor the BCJ and capture controls to be more testable\n\nChange-Id: I51c5869a30ab4c82d727486604a77e3fc300f5be", "committedDate": "2020-04-10T21:07:48Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzY4NDcxOQ==", "url": "https://github.com/apache/beam/pull/11389#discussion_r407684719", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                \"\"\"Returns True if the limiter has triggered.\"\"\"\n          \n          \n            \n                \"\"\"Returns True if the limiter has triggered, and caching should stop.\"\"\"", "author": "pabloem", "createdAt": "2020-04-13T19:57:01Z", "path": "sdks/python/apache_beam/runners/interactive/options/capture_limiters.py", "diffHunk": "@@ -0,0 +1,70 @@\n+#\n+# Licensed to the Apache Software Foundation (ASF) under one or more\n+# contributor license agreements.  See the NOTICE file distributed with\n+# this work for additional information regarding copyright ownership.\n+# The ASF licenses this file to You under the Apache License, Version 2.0\n+# (the \"License\"); you may not use this file except in compliance with\n+# the License.  You may obtain a copy of the License at\n+#\n+#    http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+#\n+\n+\"\"\"Module to condition how Interactive Beam stops capturing data.\n+\n+For internal use only; no backwards-compatibility guarantees.\n+\"\"\"\n+\n+from __future__ import absolute_import\n+\n+import threading\n+\n+from apache_beam.runners.interactive import interactive_environment as ie\n+\n+\n+class Limiter:\n+  \"\"\"Limits an aspect of the caching layer.\"\"\"\n+  def is_triggered(self):\n+    # type: () -> bool\n+\n+    \"\"\"Returns True if the limiter has triggered.\"\"\"", "originalCommit": "73a0570167b9b32d08cc62caab0579ead75b9a79", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzY4OTQ4Nw==", "url": "https://github.com/apache/beam/pull/11389#discussion_r407689487", "bodyText": "IIUC, the test will run at most for 5 seconds (at least .5 from the sleep time of the BCJ checker, right?), but will pass as soon as >= 10 elements are available, right?", "author": "pabloem", "createdAt": "2020-04-13T20:06:15Z", "path": "sdks/python/apache_beam/runners/interactive/interactive_runner_test.py", "diffHunk": "@@ -196,6 +197,28 @@ def process(self, element):\n     # applied but needs an IPython environment. So we manually run this here.\n     ie.current_env().track_user_pipelines()\n \n+    # Create a fake limiter that cancels the BCJ once the main job receives the\n+    # expected amount of results.\n+    class FakeLimiter:\n+      def __init__(self, p, pcoll):\n+        self.p = p\n+        self.pcoll = pcoll\n+\n+      def is_triggered(self):\n+        result = ie.current_env().pipeline_result(self.p)\n+        if result:\n+          try:\n+            results = result.get(self.pcoll)\n+          except ValueError:\n+            return False\n+          return len(results) >= 10\n+        return False\n+\n+    # This sets the limiters to stop reading when the test receives 10 elements\n+    # or after 5 seconds have elapsed (to eliminate the possibility of hanging).\n+    ie.current_env().options.capture_control.set_limiters_for_test(\n+        [FakeLimiter(p, data), DurationLimiter(timedelta(seconds=5))])", "originalCommit": "73a0570167b9b32d08cc62caab0579ead75b9a79", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzc0NTAwNg==", "url": "https://github.com/apache/beam/pull/11389#discussion_r407745006", "bodyText": "Yep!", "author": "rohdesamuel", "createdAt": "2020-04-13T21:57:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzY4OTQ4Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzY5MzM5OQ==", "url": "https://github.com/apache/beam/pull/11389#discussion_r407693399", "bodyText": "maybe the wait time should be parameterizable? Is it pretty cheap to check the limiters? Up to you.", "author": "pabloem", "createdAt": "2020-04-13T20:13:44Z", "path": "sdks/python/apache_beam/runners/interactive/background_caching_job.py", "diffHunk": "@@ -66,61 +66,40 @@ class BackgroundCachingJob(object):\n   In both situations, the background caching job should be treated as done\n   successfully.\n   \"\"\"\n-  def __init__(self, pipeline_result, start_limit_checkers=True):\n+  def __init__(self, pipeline_result, limiters):\n     self._pipeline_result = pipeline_result\n-    self._timer = threading.Timer(\n-        ie.current_env().options.capture_duration.total_seconds(), self._cancel)\n-    self._timer.daemon = True\n     self._condition_checker = threading.Thread(\n         target=self._background_caching_job_condition_checker, daemon=True)\n-    if start_limit_checkers:\n-      self._timer.start()\n-      self._condition_checker.start()\n-    self._timer_triggered = False\n-    self._condition_checker_triggered = False\n+\n+    # Limiters are checks s.t. if any are triggered then the background caching\n+    # job gets cancelled.\n+    self._limiters = limiters\n+    self._condition_checker.start()\n \n   def _background_caching_job_condition_checker(self):\n     while not PipelineState.is_terminal(self._pipeline_result.state):\n       if self._should_end_condition_checker():\n+        self.cancel()\n         break\n-      time.sleep(5)\n+      time.sleep(0.5)", "originalCommit": "73a0570167b9b32d08cc62caab0579ead75b9a79", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzc0NTQyOA==", "url": "https://github.com/apache/beam/pull/11389#discussion_r407745428", "bodyText": "It's pretty cheap to check the limiters, so I don't think the wait needs to be parameterizable. This sleep is only here so that this loop doesn't chew up the CPU.", "author": "rohdesamuel", "createdAt": "2020-04-13T21:58:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzY5MzM5OQ=="}], "type": "inlineReview"}, {"oid": "554df496728fc99913b94d52ed80cca865b197ed", "url": "https://github.com/apache/beam/commit/554df496728fc99913b94d52ed80cca865b197ed", "message": "Update sdks/python/apache_beam/runners/interactive/options/capture_limiters.py\n\nCo-Authored-By: Pablo <pabloem@users.noreply.github.com>", "committedDate": "2020-04-13T21:56:58Z", "type": "commit"}]}