{"pr_number": 12445, "pr_title": "[BEAM-9919] Added an External Transform API to Go SDK", "pr_createdAt": "2020-08-01T03:08:49Z", "pr_url": "https://github.com/apache/beam/pull/12445", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDY3MjM3OQ==", "url": "https://github.com/apache/beam/pull/12445#discussion_r464672379", "bodyText": "Let's keep these unrelated documentation updates in a separate PR.", "author": "chamikaramj", "createdAt": "2020-08-03T21:29:45Z", "path": "runners/core-construction-java/src/test/java/org/apache/beam/runners/core/construction/ValidateRunnerXlangTest.java", "diffHunk": "@@ -177,6 +232,14 @@ public void coGroupByKeyTest() {\n     PAssert.that(col).containsInAnyOrder(\"0:1,2,4\", \"1:3,5,6\");\n   }\n \n+  /**\n+   * Motivation behind combineGloballyTest.", "originalCommit": "f04e9faf616717bb8c4bb3dbf4b6be70fcbb01a6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTM2MDkwMQ==", "url": "https://github.com/apache/beam/pull/12445#discussion_r465360901", "bodyText": "Resolving since this was caused due to botched git workflows and have since been corrected.", "author": "pskevin", "createdAt": "2020-08-04T22:15:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDY3MjM3OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDY3Mjc1Mg==", "url": "https://github.com/apache/beam/pull/12445#discussion_r464672752", "bodyText": "Is it possible to use a generated input for tests instead of committing this file ?", "author": "chamikaramj", "createdAt": "2020-08-03T21:30:33Z", "path": "sdks/go/examples/xlang/wordcount/input", "diffHunk": "@@ -0,0 +1,5 @@\n+Lorem ipsum dolor sit amet, consectetur adipiscing elit. Mauris id tellus vehicula, rutrum turpis quis, suscipit est. Quisque vehicula nec ex a interdum. Phasellus vulputate nunc sit amet nisl dapibus tincidunt ut ullamcorper nisi. Mauris gravida porta leo vel congue. Duis sit amet arcu eu nisl pharetra interdum a eget enim. Nulla facilisis massa ut egestas interdum. Nunc elit dui, hendrerit at pharetra a, pellentesque non turpis. Integer auctor vulputate congue. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. Ut sagittis convallis lorem non semper. Ut ultrices elit a enim pulvinar fermentum.", "originalCommit": "f04e9faf616717bb8c4bb3dbf4b6be70fcbb01a6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDcxNzI5MA==", "url": "https://github.com/apache/beam/pull/12445#discussion_r464717290", "bodyText": "+1. For example/demo reasons, we can just do an \"in memory\" file instead.\nAKA, copy pasted this into a variable (note the back tics for go's Raw string handling, eg for the newlines.)\nconst lorem = `\nLorem ipsum...\n`\n, and load that into beam.Create. One of the wordcount examples does this.", "author": "lostluck", "createdAt": "2020-08-03T23:39:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDY3Mjc1Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTM2MTAxOA==", "url": "https://github.com/apache/beam/pull/12445#discussion_r465361018", "bodyText": "Makes sense! Ack.", "author": "pskevin", "createdAt": "2020-08-04T22:16:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDY3Mjc1Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDY3MjgzNw==", "url": "https://github.com/apache/beam/pull/12445#discussion_r464672837", "bodyText": "You need to add Apache license to all new files.", "author": "chamikaramj", "createdAt": "2020-08-03T21:30:47Z", "path": "sdks/go/examples/xlang/wordcount/xlang_wordcount.go", "diffHunk": "@@ -0,0 +1,100 @@\n+package main", "originalCommit": "f04e9faf616717bb8c4bb3dbf4b6be70fcbb01a6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTM2MTI0Mw==", "url": "https://github.com/apache/beam/pull/12445#discussion_r465361243", "bodyText": "Ack.", "author": "pskevin", "createdAt": "2020-08-04T22:16:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDY3MjgzNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDY3MzI2Ng==", "url": "https://github.com/apache/beam/pull/12445#discussion_r464673266", "bodyText": "Woohoo!", "author": "chamikaramj", "createdAt": "2020-08-03T21:31:50Z", "path": "sdks/go/examples/xlang/wordcount/xlang_wordcount.go", "diffHunk": "@@ -0,0 +1,100 @@\n+package main\n+\n+import (\n+\t\"context\"\n+\t\"flag\"\n+\t\"fmt\"\n+\t\"log\"\n+\t\"regexp\"\n+\t\"strings\"\n+\n+\t\"github.com/apache/beam/sdks/go/pkg/beam/core/typex\"\n+\t\"github.com/apache/beam/sdks/go/pkg/beam/core/util/reflectx\"\n+\n+\t\"github.com/apache/beam/sdks/go/pkg/beam\"\n+\t\"github.com/apache/beam/sdks/go/pkg/beam/io/textio\"\n+\t\"github.com/apache/beam/sdks/go/pkg/beam/x/beamx\"\n+\n+\t// Imports to enable correct filesystem access and runner setup in LOOPBACK mode\n+\t_ \"github.com/apache/beam/sdks/go/pkg/beam/io/filesystem/gcs\"\n+\t_ \"github.com/apache/beam/sdks/go/pkg/beam/io/filesystem/local\"\n+\t_ \"github.com/apache/beam/sdks/go/pkg/beam/runners/universal\"\n+)\n+\n+var (\n+\t// Set this option to choose a different input file or glob.\n+\tinput = flag.String(\"input\", \"./input\", \"File(s) to read.\")\n+\n+\t// Set this required option to specify where to write the output.\n+\toutput = flag.String(\"output\", \"./output\", \"Output file (required).\")\n+)\n+\n+var (\n+\twordRE  = regexp.MustCompile(`[a-zA-Z]+('[a-z])?`)\n+\tempty   = beam.NewCounter(\"extract\", \"emptyLines\")\n+\tlineLen = beam.NewDistribution(\"extract\", \"lineLenDistro\")\n+)\n+\n+// extractFn is a DoFn that emits the words in a given line.\n+func extractFn(ctx context.Context, line string, emit func(string)) {\n+\tlineLen.Update(ctx, int64(len(line)))\n+\tif len(strings.TrimSpace(line)) == 0 {\n+\t\tempty.Inc(ctx, 1)\n+\t}\n+\tfor _, word := range wordRE.FindAllString(line, -1) {\n+\t\temit(word)\n+\t}\n+}\n+\n+// formatFn is a DoFn that formats a word and its count as a string.\n+func formatFn(w string, c int64) string {\n+\tfmt.Println(w, c)\n+\treturn fmt.Sprintf(\"%s: %v\", w, c)\n+}\n+\n+func init() {\n+\tbeam.RegisterFunction(extractFn)\n+\tbeam.RegisterFunction(formatFn)\n+}\n+\n+func main() {\n+\t// If beamx or Go flags are used, flags must be parsed first.\n+\tflag.Parse()\n+\t// beam.Init() is an initialization hook that must be called on startup. On\n+\t// distributed runners, it is used to intercept control.\n+\tbeam.Init()\n+\n+\t// Input validation is done as usual. Note that it must be after Init().\n+\tif *output == \"\" {\n+\t\tlog.Fatal(\"No output provided\")\n+\t}\n+\n+\t// Concepts #3 and #4: The pipeline uses the named transform and DoFn.\n+\tp := beam.NewPipeline()\n+\ts := p.Root()\n+\n+\tlines := textio.Read(s, *input)\n+\t// Convert lines of text into individual words.\n+\tcol := beam.ParDo(s, extractFn, lines)\n+\n+\t// Using Cross-language Count from Python's test expansion service\n+\t// TODO(pskevin): Cleaner using-face API\n+\toutputType := typex.NewKV(typex.New(reflectx.String), typex.New(reflectx.Int64))\n+\texternal := &beam.ExternalTransform{", "originalCommit": "f04e9faf616717bb8c4bb3dbf4b6be70fcbb01a6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDY3MzkyMA==", "url": "https://github.com/apache/beam/pull/12445#discussion_r464673920", "bodyText": "Can we directly setup 'CrossLanguage' transform as the primary user API instead of having to setup a separate ExternalTransform struct ?", "author": "chamikaramj", "createdAt": "2020-08-03T21:33:21Z", "path": "sdks/go/examples/xlang/wordcount/xlang_wordcount.go", "diffHunk": "@@ -0,0 +1,100 @@\n+package main\n+\n+import (\n+\t\"context\"\n+\t\"flag\"\n+\t\"fmt\"\n+\t\"log\"\n+\t\"regexp\"\n+\t\"strings\"\n+\n+\t\"github.com/apache/beam/sdks/go/pkg/beam/core/typex\"\n+\t\"github.com/apache/beam/sdks/go/pkg/beam/core/util/reflectx\"\n+\n+\t\"github.com/apache/beam/sdks/go/pkg/beam\"\n+\t\"github.com/apache/beam/sdks/go/pkg/beam/io/textio\"\n+\t\"github.com/apache/beam/sdks/go/pkg/beam/x/beamx\"\n+\n+\t// Imports to enable correct filesystem access and runner setup in LOOPBACK mode\n+\t_ \"github.com/apache/beam/sdks/go/pkg/beam/io/filesystem/gcs\"\n+\t_ \"github.com/apache/beam/sdks/go/pkg/beam/io/filesystem/local\"\n+\t_ \"github.com/apache/beam/sdks/go/pkg/beam/runners/universal\"\n+)\n+\n+var (\n+\t// Set this option to choose a different input file or glob.\n+\tinput = flag.String(\"input\", \"./input\", \"File(s) to read.\")\n+\n+\t// Set this required option to specify where to write the output.\n+\toutput = flag.String(\"output\", \"./output\", \"Output file (required).\")\n+)\n+\n+var (\n+\twordRE  = regexp.MustCompile(`[a-zA-Z]+('[a-z])?`)\n+\tempty   = beam.NewCounter(\"extract\", \"emptyLines\")\n+\tlineLen = beam.NewDistribution(\"extract\", \"lineLenDistro\")\n+)\n+\n+// extractFn is a DoFn that emits the words in a given line.\n+func extractFn(ctx context.Context, line string, emit func(string)) {\n+\tlineLen.Update(ctx, int64(len(line)))\n+\tif len(strings.TrimSpace(line)) == 0 {\n+\t\tempty.Inc(ctx, 1)\n+\t}\n+\tfor _, word := range wordRE.FindAllString(line, -1) {\n+\t\temit(word)\n+\t}\n+}\n+\n+// formatFn is a DoFn that formats a word and its count as a string.\n+func formatFn(w string, c int64) string {\n+\tfmt.Println(w, c)\n+\treturn fmt.Sprintf(\"%s: %v\", w, c)\n+}\n+\n+func init() {\n+\tbeam.RegisterFunction(extractFn)\n+\tbeam.RegisterFunction(formatFn)\n+}\n+\n+func main() {\n+\t// If beamx or Go flags are used, flags must be parsed first.\n+\tflag.Parse()\n+\t// beam.Init() is an initialization hook that must be called on startup. On\n+\t// distributed runners, it is used to intercept control.\n+\tbeam.Init()\n+\n+\t// Input validation is done as usual. Note that it must be after Init().\n+\tif *output == \"\" {\n+\t\tlog.Fatal(\"No output provided\")\n+\t}\n+\n+\t// Concepts #3 and #4: The pipeline uses the named transform and DoFn.\n+\tp := beam.NewPipeline()\n+\ts := p.Root()\n+\n+\tlines := textio.Read(s, *input)\n+\t// Convert lines of text into individual words.\n+\tcol := beam.ParDo(s, extractFn, lines)\n+\n+\t// Using Cross-language Count from Python's test expansion service\n+\t// TODO(pskevin): Cleaner using-face API\n+\toutputType := typex.NewKV(typex.New(reflectx.String), typex.New(reflectx.Int64))\n+\texternal := &beam.ExternalTransform{\n+\t\tIn:            []beam.PCollection{col},\n+\t\tUrn:           \"beam:transforms:xlang:count\",\n+\t\tExpansionAddr: \"localhost:8118\",\n+\t\tOut:           []typex.FullType{outputType},\n+\t\tBounded:       true, // TODO(pskevin): Infer this value from output PCollection(s) part of the expanded tranform\n+\t}\n+\tcounted := beam.CrossLanguage(s, p, external) // TODO(pskevin): Add external transform to Pipeline without passing it to the transform", "originalCommit": "f04e9faf616717bb8c4bb3dbf4b6be70fcbb01a6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDcxOTI1Ng==", "url": "https://github.com/apache/beam/pull/12445#discussion_r464719256", "bodyText": "+1 I would strongly prefer not having a separate ExternalTransform struct. Pass the arguments in. I wouldn't worry about trying to accommodate the previous External api.", "author": "lostluck", "createdAt": "2020-08-03T23:46:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDY3MzkyMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTM2NTIwNg==", "url": "https://github.com/apache/beam/pull/12445#discussion_r465365206", "bodyText": "Ack.\nAll references to the previous API are just placeholders where (in the future) code to port the legacy API will go. They don't influence how the current API is being developed. In fact it's just a bonus that the previous API can be cleanly supported.", "author": "pskevin", "createdAt": "2020-08-04T22:27:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDY3MzkyMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDY3NTE5Nw==", "url": "https://github.com/apache/beam/pull/12445#discussion_r464675197", "bodyText": "Do we need this ?", "author": "chamikaramj", "createdAt": "2020-08-03T21:36:32Z", "path": "sdks/python/Pipfile", "diffHunk": "@@ -0,0 +1,12 @@\n+[[source]]\n+name = \"pypi\"", "originalCommit": "f04e9faf616717bb8c4bb3dbf4b6be70fcbb01a6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTM2MTkzNA==", "url": "https://github.com/apache/beam/pull/12445#discussion_r465361934", "bodyText": "Resolving since this was caused due to botched git workflows and have since been corrected.", "author": "pskevin", "createdAt": "2020-08-04T22:18:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDY3NTE5Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDY3NTI2Mw==", "url": "https://github.com/apache/beam/pull/12445#discussion_r464675263", "bodyText": "Ditto.", "author": "chamikaramj", "createdAt": "2020-08-03T21:36:43Z", "path": "sdks/python/Pipfile.lock", "diffHunk": "@@ -0,0 +1,946 @@\n+{\n+    \"_meta\": {\n+        \"hash\": {\n+            \"sha256\": \"4d830f0b6c127288985ac4b35fef456c1bfcd8ffb2d771f32593d302e04bb80c\"\n+        },\n+        \"pipfile-spec\": 6,\n+        \"requires\": {", "originalCommit": "f04e9faf616717bb8c4bb3dbf4b6be70fcbb01a6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTM2MTk2Nw==", "url": "https://github.com/apache/beam/pull/12445#discussion_r465361967", "bodyText": "Resolving since this was caused due to botched git workflows and have since been corrected.", "author": "pskevin", "createdAt": "2020-08-04T22:18:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDY3NTI2Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDY3NTUzNg==", "url": "https://github.com/apache/beam/pull/12445#discussion_r464675536", "bodyText": "Probably extract out these wordcount_xxx updates to a separate PR.", "author": "chamikaramj", "createdAt": "2020-08-03T21:37:24Z", "path": "sdks/python/apache_beam/examples/wordcount_docker.py", "diffHunk": "@@ -0,0 +1,148 @@\n+#\n+# Licensed to the Apache Software Foundation (ASF) under one or more\n+# contributor license agreements.  See the NOTICE file distributed with\n+# this work for additional information regarding copyright ownership.", "originalCommit": "f04e9faf616717bb8c4bb3dbf4b6be70fcbb01a6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTM2MjA2OQ==", "url": "https://github.com/apache/beam/pull/12445#discussion_r465362069", "bodyText": "Resolving since this was caused due to botched git workflows and have since been corrected.", "author": "pskevin", "createdAt": "2020-08-04T22:18:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDY3NTUzNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDY3NTgyOQ==", "url": "https://github.com/apache/beam/pull/12445#discussion_r464675829", "bodyText": "Ditto regarding keeping these documentation updates in the other PR.", "author": "chamikaramj", "createdAt": "2020-08-03T21:38:03Z", "path": "sdks/python/apache_beam/transforms/validate_runner_xlang_test.py", "diffHunk": "@@ -14,6 +14,42 @@\n # See the License for the specific language governing permissions and\n # limitations under the License.\n #\n+\n+\"\"\"\n+###########################################################\n+Runner Validation Test Suite for Cross-language Transforms\n+###########################################################\n+ As per Beams's Portability Framework design, Cross-language transforms", "originalCommit": "f04e9faf616717bb8c4bb3dbf4b6be70fcbb01a6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTM2MjAwNw==", "url": "https://github.com/apache/beam/pull/12445#discussion_r465362007", "bodyText": "Resolving since this was caused due to botched git workflows and have since been corrected.", "author": "pskevin", "createdAt": "2020-08-04T22:18:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDY3NTgyOQ=="}], "type": "inlineReview"}, {"oid": "c5698709a9b257950b88dcccbf9de820a9d55cdf", "url": "https://github.com/apache/beam/commit/c5698709a9b257950b88dcccbf9de820a9d55cdf", "message": "[BEAM-9919] Added basic external transform API", "committedDate": "2020-08-03T23:04:11Z", "type": "forcePushed"}, {"oid": "7081012b408b2cf4219cb10ab695f3b14a88d978", "url": "https://github.com/apache/beam/commit/7081012b408b2cf4219cb10ab695f3b14a88d978", "message": "[BEAM-9919] Added basic external transform API", "committedDate": "2020-08-03T23:23:20Z", "type": "forcePushed"}, {"oid": "d19d78511e297e42051d11bef6a8ed2140144d29", "url": "https://github.com/apache/beam/commit/d19d78511e297e42051d11bef6a8ed2140144d29", "message": "correct req building", "committedDate": "2020-08-03T23:29:19Z", "type": "commit"}, {"oid": "5ab737d522d004673f6ca1e17b4d953e8a482e40", "url": "https://github.com/apache/beam/commit/5ab737d522d004673f6ca1e17b4d953e8a482e40", "message": "initial form of a complete pipeline", "committedDate": "2020-08-03T23:29:19Z", "type": "commit"}, {"oid": "db71161a52a259ffb8ecb33bd81923d79c96b45e", "url": "https://github.com/apache/beam/commit/db71161a52a259ffb8ecb33bd81923d79c96b45e", "message": "working pipeline", "committedDate": "2020-08-03T23:29:20Z", "type": "commit"}, {"oid": "148a51d12a5d49e52f2f4205b2dc9956e1b470b7", "url": "https://github.com/apache/beam/commit/148a51d12a5d49e52f2f4205b2dc9956e1b470b7", "message": "feat(beam/sdks/go): adding basic xlang capability and a wordcount example", "committedDate": "2020-08-03T23:29:20Z", "type": "commit"}, {"oid": "43a4a119bf0d95a1fc33c65842b99ef0ebbcf041", "url": "https://github.com/apache/beam/commit/43a4a119bf0d95a1fc33c65842b99ef0ebbcf041", "message": "[BEAM-9919] Added basic external transform API", "committedDate": "2020-08-03T23:29:20Z", "type": "commit"}, {"oid": "43a4a119bf0d95a1fc33c65842b99ef0ebbcf041", "url": "https://github.com/apache/beam/commit/43a4a119bf0d95a1fc33c65842b99ef0ebbcf041", "message": "[BEAM-9919] Added basic external transform API", "committedDate": "2020-08-03T23:29:20Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDcxNzk5Ng==", "url": "https://github.com/apache/beam/pull/12445#discussion_r464717996", "bodyText": "Arguably we can remove this line for debugging.", "author": "lostluck", "createdAt": "2020-08-03T23:41:50Z", "path": "sdks/go/examples/xlang/wordcount/xlang_wordcount.go", "diffHunk": "@@ -0,0 +1,100 @@\n+package main\n+\n+import (\n+\t\"context\"\n+\t\"flag\"\n+\t\"fmt\"\n+\t\"log\"\n+\t\"regexp\"\n+\t\"strings\"\n+\n+\t\"github.com/apache/beam/sdks/go/pkg/beam/core/typex\"\n+\t\"github.com/apache/beam/sdks/go/pkg/beam/core/util/reflectx\"\n+\n+\t\"github.com/apache/beam/sdks/go/pkg/beam\"\n+\t\"github.com/apache/beam/sdks/go/pkg/beam/io/textio\"\n+\t\"github.com/apache/beam/sdks/go/pkg/beam/x/beamx\"\n+\n+\t// Imports to enable correct filesystem access and runner setup in LOOPBACK mode\n+\t_ \"github.com/apache/beam/sdks/go/pkg/beam/io/filesystem/gcs\"\n+\t_ \"github.com/apache/beam/sdks/go/pkg/beam/io/filesystem/local\"\n+\t_ \"github.com/apache/beam/sdks/go/pkg/beam/runners/universal\"\n+)\n+\n+var (\n+\t// Set this option to choose a different input file or glob.\n+\tinput = flag.String(\"input\", \"./input\", \"File(s) to read.\")\n+\n+\t// Set this required option to specify where to write the output.\n+\toutput = flag.String(\"output\", \"./output\", \"Output file (required).\")\n+)\n+\n+var (\n+\twordRE  = regexp.MustCompile(`[a-zA-Z]+('[a-z])?`)\n+\tempty   = beam.NewCounter(\"extract\", \"emptyLines\")\n+\tlineLen = beam.NewDistribution(\"extract\", \"lineLenDistro\")\n+)\n+\n+// extractFn is a DoFn that emits the words in a given line.\n+func extractFn(ctx context.Context, line string, emit func(string)) {\n+\tlineLen.Update(ctx, int64(len(line)))\n+\tif len(strings.TrimSpace(line)) == 0 {\n+\t\tempty.Inc(ctx, 1)\n+\t}\n+\tfor _, word := range wordRE.FindAllString(line, -1) {\n+\t\temit(word)\n+\t}\n+}\n+\n+// formatFn is a DoFn that formats a word and its count as a string.\n+func formatFn(w string, c int64) string {\n+\tfmt.Println(w, c)", "originalCommit": "43a4a119bf0d95a1fc33c65842b99ef0ebbcf041", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTM2NTUwNg==", "url": "https://github.com/apache/beam/pull/12445#discussion_r465365506", "bodyText": "Thanks for catching that! Ack.", "author": "pskevin", "createdAt": "2020-08-04T22:28:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDcxNzk5Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDcxODUxMA==", "url": "https://github.com/apache/beam/pull/12445#discussion_r464718510", "bodyText": "Go packages and binaries should have a doc string with a blank line between it and the apache license.\n// xlang_wordcount use a cross language transform from Python to count words from a file.", "author": "lostluck", "createdAt": "2020-08-03T23:43:39Z", "path": "sdks/go/examples/xlang/wordcount/xlang_wordcount.go", "diffHunk": "@@ -0,0 +1,100 @@\n+package main", "originalCommit": "43a4a119bf0d95a1fc33c65842b99ef0ebbcf041", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTQ3ODQ5MA==", "url": "https://github.com/apache/beam/pull/12445#discussion_r465478490", "bodyText": "Ack.", "author": "pskevin", "createdAt": "2020-08-05T05:18:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDcxODUxMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDcxODg0NQ==", "url": "https://github.com/apache/beam/pull/12445#discussion_r464718845", "bodyText": "Feel free to delete the copy pasted documentation from the original wordcount here, it doesn't need to be repeated as it draws focus away from the important part: Cross Language.", "author": "lostluck", "createdAt": "2020-08-03T23:44:52Z", "path": "sdks/go/examples/xlang/wordcount/xlang_wordcount.go", "diffHunk": "@@ -0,0 +1,100 @@\n+package main\n+\n+import (\n+\t\"context\"\n+\t\"flag\"\n+\t\"fmt\"\n+\t\"log\"\n+\t\"regexp\"\n+\t\"strings\"\n+\n+\t\"github.com/apache/beam/sdks/go/pkg/beam/core/typex\"\n+\t\"github.com/apache/beam/sdks/go/pkg/beam/core/util/reflectx\"\n+\n+\t\"github.com/apache/beam/sdks/go/pkg/beam\"\n+\t\"github.com/apache/beam/sdks/go/pkg/beam/io/textio\"\n+\t\"github.com/apache/beam/sdks/go/pkg/beam/x/beamx\"\n+\n+\t// Imports to enable correct filesystem access and runner setup in LOOPBACK mode\n+\t_ \"github.com/apache/beam/sdks/go/pkg/beam/io/filesystem/gcs\"\n+\t_ \"github.com/apache/beam/sdks/go/pkg/beam/io/filesystem/local\"\n+\t_ \"github.com/apache/beam/sdks/go/pkg/beam/runners/universal\"\n+)\n+\n+var (\n+\t// Set this option to choose a different input file or glob.\n+\tinput = flag.String(\"input\", \"./input\", \"File(s) to read.\")\n+\n+\t// Set this required option to specify where to write the output.\n+\toutput = flag.String(\"output\", \"./output\", \"Output file (required).\")\n+)\n+\n+var (\n+\twordRE  = regexp.MustCompile(`[a-zA-Z]+('[a-z])?`)\n+\tempty   = beam.NewCounter(\"extract\", \"emptyLines\")\n+\tlineLen = beam.NewDistribution(\"extract\", \"lineLenDistro\")\n+)\n+\n+// extractFn is a DoFn that emits the words in a given line.\n+func extractFn(ctx context.Context, line string, emit func(string)) {\n+\tlineLen.Update(ctx, int64(len(line)))\n+\tif len(strings.TrimSpace(line)) == 0 {\n+\t\tempty.Inc(ctx, 1)\n+\t}\n+\tfor _, word := range wordRE.FindAllString(line, -1) {\n+\t\temit(word)\n+\t}\n+}\n+\n+// formatFn is a DoFn that formats a word and its count as a string.\n+func formatFn(w string, c int64) string {\n+\tfmt.Println(w, c)\n+\treturn fmt.Sprintf(\"%s: %v\", w, c)\n+}\n+\n+func init() {\n+\tbeam.RegisterFunction(extractFn)\n+\tbeam.RegisterFunction(formatFn)\n+}\n+\n+func main() {\n+\t// If beamx or Go flags are used, flags must be parsed first.", "originalCommit": "43a4a119bf0d95a1fc33c65842b99ef0ebbcf041", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTM3MDgxMw==", "url": "https://github.com/apache/beam/pull/12445#discussion_r465370813", "bodyText": "Thanks for catching that! Will do.", "author": "pskevin", "createdAt": "2020-08-04T22:43:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDcxODg0NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDcxOTMzMQ==", "url": "https://github.com/apache/beam/pull/12445#discussion_r464719331", "bodyText": "Same comment here: Delete the unnecessary extra documentation.", "author": "lostluck", "createdAt": "2020-08-03T23:46:29Z", "path": "sdks/go/examples/xlang/wordcount/xlang_wordcount.go", "diffHunk": "@@ -0,0 +1,100 @@\n+package main\n+\n+import (\n+\t\"context\"\n+\t\"flag\"\n+\t\"fmt\"\n+\t\"log\"\n+\t\"regexp\"\n+\t\"strings\"\n+\n+\t\"github.com/apache/beam/sdks/go/pkg/beam/core/typex\"\n+\t\"github.com/apache/beam/sdks/go/pkg/beam/core/util/reflectx\"\n+\n+\t\"github.com/apache/beam/sdks/go/pkg/beam\"\n+\t\"github.com/apache/beam/sdks/go/pkg/beam/io/textio\"\n+\t\"github.com/apache/beam/sdks/go/pkg/beam/x/beamx\"\n+\n+\t// Imports to enable correct filesystem access and runner setup in LOOPBACK mode\n+\t_ \"github.com/apache/beam/sdks/go/pkg/beam/io/filesystem/gcs\"\n+\t_ \"github.com/apache/beam/sdks/go/pkg/beam/io/filesystem/local\"\n+\t_ \"github.com/apache/beam/sdks/go/pkg/beam/runners/universal\"\n+)\n+\n+var (\n+\t// Set this option to choose a different input file or glob.\n+\tinput = flag.String(\"input\", \"./input\", \"File(s) to read.\")\n+\n+\t// Set this required option to specify where to write the output.\n+\toutput = flag.String(\"output\", \"./output\", \"Output file (required).\")\n+)\n+\n+var (\n+\twordRE  = regexp.MustCompile(`[a-zA-Z]+('[a-z])?`)\n+\tempty   = beam.NewCounter(\"extract\", \"emptyLines\")\n+\tlineLen = beam.NewDistribution(\"extract\", \"lineLenDistro\")\n+)\n+\n+// extractFn is a DoFn that emits the words in a given line.\n+func extractFn(ctx context.Context, line string, emit func(string)) {\n+\tlineLen.Update(ctx, int64(len(line)))\n+\tif len(strings.TrimSpace(line)) == 0 {\n+\t\tempty.Inc(ctx, 1)\n+\t}\n+\tfor _, word := range wordRE.FindAllString(line, -1) {\n+\t\temit(word)\n+\t}\n+}\n+\n+// formatFn is a DoFn that formats a word and its count as a string.\n+func formatFn(w string, c int64) string {\n+\tfmt.Println(w, c)\n+\treturn fmt.Sprintf(\"%s: %v\", w, c)\n+}\n+\n+func init() {\n+\tbeam.RegisterFunction(extractFn)\n+\tbeam.RegisterFunction(formatFn)\n+}\n+\n+func main() {\n+\t// If beamx or Go flags are used, flags must be parsed first.\n+\tflag.Parse()\n+\t// beam.Init() is an initialization hook that must be called on startup. On\n+\t// distributed runners, it is used to intercept control.\n+\tbeam.Init()\n+\n+\t// Input validation is done as usual. Note that it must be after Init().\n+\tif *output == \"\" {\n+\t\tlog.Fatal(\"No output provided\")\n+\t}\n+\n+\t// Concepts #3 and #4: The pipeline uses the named transform and DoFn.\n+\tp := beam.NewPipeline()\n+\ts := p.Root()\n+\n+\tlines := textio.Read(s, *input)\n+\t// Convert lines of text into individual words.\n+\tcol := beam.ParDo(s, extractFn, lines)\n+\n+\t// Using Cross-language Count from Python's test expansion service\n+\t// TODO(pskevin): Cleaner using-face API\n+\toutputType := typex.NewKV(typex.New(reflectx.String), typex.New(reflectx.Int64))\n+\texternal := &beam.ExternalTransform{\n+\t\tIn:            []beam.PCollection{col},\n+\t\tUrn:           \"beam:transforms:xlang:count\",\n+\t\tExpansionAddr: \"localhost:8118\",\n+\t\tOut:           []typex.FullType{outputType},\n+\t\tBounded:       true, // TODO(pskevin): Infer this value from output PCollection(s) part of the expanded tranform\n+\t}\n+\tcounted := beam.CrossLanguage(s, p, external) // TODO(pskevin): Add external transform to Pipeline without passing it to the transform\n+\n+\tformatted := beam.ParDo(s, formatFn, counted[0])\n+\ttextio.Write(s, *output, formatted)\n+\n+\t// Concept #1: The beamx.Run convenience wrapper allows a number of", "originalCommit": "43a4a119bf0d95a1fc33c65842b99ef0ebbcf041", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTM3MDkwOA==", "url": "https://github.com/apache/beam/pull/12445#discussion_r465370908", "bodyText": "Ack.", "author": "pskevin", "createdAt": "2020-08-04T22:43:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDcxOTMzMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDcxOTU4MA==", "url": "https://github.com/apache/beam/pull/12445#discussion_r464719580", "bodyText": "As mentioned, don't worry about the legacy API at this point, focus on a clean implementation of the new API.", "author": "lostluck", "createdAt": "2020-08-03T23:47:28Z", "path": "sdks/go/pkg/beam/external.go", "diffHunk": "@@ -16,10 +16,151 @@\n package beam\n \n import (\n+\t\"context\"\n+\t\"fmt\"\n+\n \t\"github.com/apache/beam/sdks/go/pkg/beam/core/graph\"\n+\t\"github.com/apache/beam/sdks/go/pkg/beam/core/runtime/graphx\"\n \t\"github.com/apache/beam/sdks/go/pkg/beam/internal/errors\"\n+\tjobpb \"github.com/apache/beam/sdks/go/pkg/beam/model/jobmanagement_v1\"\n+\tpipepb \"github.com/apache/beam/sdks/go/pkg/beam/model/pipeline_v1\"\n+\t\"google.golang.org/grpc\"\n )\n \n+// ExternalTransform represents the cross-language transform in and out of the Pipeline as a MultiEdge and Expanded proto respectively\n+type ExternalTransform struct {\n+\tid                int\n+\tUrn               string\n+\tPayload           []byte\n+\tIn                []PCollection\n+\tOut               []FullType\n+\tBounded           bool\n+\tExpansionAddr     string\n+\tComponents        *pipepb.Components\n+\tExpandedTransform *pipepb.PTransform\n+\tRequirements      []string\n+}\n+\n+// CrossLanguage is the temporary API to execute external transforms\n+// TODO(pskevin): Handle errors using the TryN and Must strategies instead one function handling multiple points of failure\n+func CrossLanguage(s Scope, p *Pipeline, e *ExternalTransform) []PCollection {\n+\tif e.ExpansionAddr == \"\" { // TODO(pskevin): Better way to check if the value was ever set", "originalCommit": "43a4a119bf0d95a1fc33c65842b99ef0ebbcf041", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTg3NzIyNA==", "url": "https://github.com/apache/beam/pull/12445#discussion_r465877224", "bodyText": "Note, by this comment, the intent was for you to remove this dead code, as it's unnecessary.", "author": "lostluck", "createdAt": "2020-08-05T17:09:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDcxOTU4MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDcxOTc0NQ==", "url": "https://github.com/apache/beam/pull/12445#discussion_r464719745", "bodyText": "Uncomment this validation please, and remove the print out.", "author": "lostluck", "createdAt": "2020-08-03T23:48:05Z", "path": "sdks/go/pkg/beam/external.go", "diffHunk": "@@ -16,10 +16,151 @@\n package beam\n \n import (\n+\t\"context\"\n+\t\"fmt\"\n+\n \t\"github.com/apache/beam/sdks/go/pkg/beam/core/graph\"\n+\t\"github.com/apache/beam/sdks/go/pkg/beam/core/runtime/graphx\"\n \t\"github.com/apache/beam/sdks/go/pkg/beam/internal/errors\"\n+\tjobpb \"github.com/apache/beam/sdks/go/pkg/beam/model/jobmanagement_v1\"\n+\tpipepb \"github.com/apache/beam/sdks/go/pkg/beam/model/pipeline_v1\"\n+\t\"google.golang.org/grpc\"\n )\n \n+// ExternalTransform represents the cross-language transform in and out of the Pipeline as a MultiEdge and Expanded proto respectively\n+type ExternalTransform struct {\n+\tid                int\n+\tUrn               string\n+\tPayload           []byte\n+\tIn                []PCollection\n+\tOut               []FullType\n+\tBounded           bool\n+\tExpansionAddr     string\n+\tComponents        *pipepb.Components\n+\tExpandedTransform *pipepb.PTransform\n+\tRequirements      []string\n+}\n+\n+// CrossLanguage is the temporary API to execute external transforms\n+// TODO(pskevin): Handle errors using the TryN and Must strategies instead one function handling multiple points of failure\n+func CrossLanguage(s Scope, p *Pipeline, e *ExternalTransform) []PCollection {\n+\tif e.ExpansionAddr == \"\" { // TODO(pskevin): Better way to check if the value was ever set\n+\t\t// return Legacy External API\n+\t}\n+\n+\t/*\n+\t\tAdd ExternalTranform to the Graph\n+\t*/\n+\t// Validating scope and inputs\n+\tif !s.IsValid() {\n+\t\t// return nil, errors.New(\"invalid scope\")", "originalCommit": "43a4a119bf0d95a1fc33c65842b99ef0ebbcf041", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTM3MzMyNw==", "url": "https://github.com/apache/beam/pull/12445#discussion_r465373327", "bodyText": "Ack.", "author": "pskevin", "createdAt": "2020-08-04T22:50:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDcxOTc0NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDcxOTg2NQ==", "url": "https://github.com/apache/beam/pull/12445#discussion_r464719865", "bodyText": "Either remove this block comment entirely, or convert it to a line comment and fix the typo.", "author": "lostluck", "createdAt": "2020-08-03T23:48:39Z", "path": "sdks/go/pkg/beam/external.go", "diffHunk": "@@ -16,10 +16,151 @@\n package beam\n \n import (\n+\t\"context\"\n+\t\"fmt\"\n+\n \t\"github.com/apache/beam/sdks/go/pkg/beam/core/graph\"\n+\t\"github.com/apache/beam/sdks/go/pkg/beam/core/runtime/graphx\"\n \t\"github.com/apache/beam/sdks/go/pkg/beam/internal/errors\"\n+\tjobpb \"github.com/apache/beam/sdks/go/pkg/beam/model/jobmanagement_v1\"\n+\tpipepb \"github.com/apache/beam/sdks/go/pkg/beam/model/pipeline_v1\"\n+\t\"google.golang.org/grpc\"\n )\n \n+// ExternalTransform represents the cross-language transform in and out of the Pipeline as a MultiEdge and Expanded proto respectively\n+type ExternalTransform struct {\n+\tid                int\n+\tUrn               string\n+\tPayload           []byte\n+\tIn                []PCollection\n+\tOut               []FullType\n+\tBounded           bool\n+\tExpansionAddr     string\n+\tComponents        *pipepb.Components\n+\tExpandedTransform *pipepb.PTransform\n+\tRequirements      []string\n+}\n+\n+// CrossLanguage is the temporary API to execute external transforms\n+// TODO(pskevin): Handle errors using the TryN and Must strategies instead one function handling multiple points of failure\n+func CrossLanguage(s Scope, p *Pipeline, e *ExternalTransform) []PCollection {\n+\tif e.ExpansionAddr == \"\" { // TODO(pskevin): Better way to check if the value was ever set\n+\t\t// return Legacy External API\n+\t}\n+\n+\t/*\n+\t\tAdd ExternalTranform to the Graph", "originalCommit": "43a4a119bf0d95a1fc33c65842b99ef0ebbcf041", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTM3MzI5Ng==", "url": "https://github.com/apache/beam/pull/12445#discussion_r465373296", "bodyText": "I'm definitely missing something since I can't see any typo. Could you be more explicit?\nAlso, the block comments were meant just to separate sections of independent logic which I expect to break down into functions during clean up. Should I remove all the block comments?", "author": "pskevin", "createdAt": "2020-08-04T22:50:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDcxOTg2NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTM4MDU2Mw==", "url": "https://github.com/apache/beam/pull/12445#discussion_r465380563", "bodyText": "ExternalTranform should be ExternalTransform.\nI'd prefer no block comments. They're uncommon in Go code.\nTo be clear, commenting on what the next sections of code is what comments are for. They don't need to take up so much space though.", "author": "lostluck", "createdAt": "2020-08-04T23:12:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDcxOTg2NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTM4MDgyMQ==", "url": "https://github.com/apache/beam/pull/12445#discussion_r465380821", "bodyText": "To be pedantically clear: No block comments doesn't mean no comments. In my original comment, I suggested the line comment alternative.", "author": "lostluck", "createdAt": "2020-08-04T23:13:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDcxOTg2NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTQ3OTMzMg==", "url": "https://github.com/apache/beam/pull/12445#discussion_r465479332", "bodyText": "Thanks for clarifying in detail. Reflected the changes.", "author": "pskevin", "createdAt": "2020-08-05T05:21:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDcxOTg2NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDcyMDA3OA==", "url": "https://github.com/apache/beam/pull/12445#discussion_r464720078", "bodyText": "Same here, uncomment the error return and remove the fmt.", "author": "lostluck", "createdAt": "2020-08-03T23:49:21Z", "path": "sdks/go/pkg/beam/external.go", "diffHunk": "@@ -16,10 +16,151 @@\n package beam\n \n import (\n+\t\"context\"\n+\t\"fmt\"\n+\n \t\"github.com/apache/beam/sdks/go/pkg/beam/core/graph\"\n+\t\"github.com/apache/beam/sdks/go/pkg/beam/core/runtime/graphx\"\n \t\"github.com/apache/beam/sdks/go/pkg/beam/internal/errors\"\n+\tjobpb \"github.com/apache/beam/sdks/go/pkg/beam/model/jobmanagement_v1\"\n+\tpipepb \"github.com/apache/beam/sdks/go/pkg/beam/model/pipeline_v1\"\n+\t\"google.golang.org/grpc\"\n )\n \n+// ExternalTransform represents the cross-language transform in and out of the Pipeline as a MultiEdge and Expanded proto respectively\n+type ExternalTransform struct {\n+\tid                int\n+\tUrn               string\n+\tPayload           []byte\n+\tIn                []PCollection\n+\tOut               []FullType\n+\tBounded           bool\n+\tExpansionAddr     string\n+\tComponents        *pipepb.Components\n+\tExpandedTransform *pipepb.PTransform\n+\tRequirements      []string\n+}\n+\n+// CrossLanguage is the temporary API to execute external transforms\n+// TODO(pskevin): Handle errors using the TryN and Must strategies instead one function handling multiple points of failure\n+func CrossLanguage(s Scope, p *Pipeline, e *ExternalTransform) []PCollection {\n+\tif e.ExpansionAddr == \"\" { // TODO(pskevin): Better way to check if the value was ever set\n+\t\t// return Legacy External API\n+\t}\n+\n+\t/*\n+\t\tAdd ExternalTranform to the Graph\n+\t*/\n+\t// Validating scope and inputs\n+\tif !s.IsValid() {\n+\t\t// return nil, errors.New(\"invalid scope\")\n+\t\tfmt.Println(\"invalid scope\")\n+\t}\n+\tfor i, col := range e.In {\n+\t\tif !col.IsValid() {\n+\t\t\t// return nil, errors.Errorf(\"invalid pcollection to external: index %v\", i)", "originalCommit": "43a4a119bf0d95a1fc33c65842b99ef0ebbcf041", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDcyMDc3MA==", "url": "https://github.com/apache/beam/pull/12445#discussion_r464720770", "bodyText": "Have both a TryCrossLanguage, which has an error return (to handle all the newly uncommented validations) and CrossLanguage without the error return. You can see how External passes the TryExternal results to a Must, so errors can be panicked if necesarry but otherwise propagated properly if Try is used.\n\n  \n    \n      beam/sdks/go/pkg/beam/external.go\n    \n    \n         Line 170\n      in\n      43a4a11\n    \n    \n    \n    \n\n        \n          \n           return MustN(TryExternal(s, spec, payload, in, out, bounded))", "author": "lostluck", "createdAt": "2020-08-03T23:51:34Z", "path": "sdks/go/pkg/beam/external.go", "diffHunk": "@@ -16,10 +16,151 @@\n package beam\n \n import (\n+\t\"context\"\n+\t\"fmt\"\n+\n \t\"github.com/apache/beam/sdks/go/pkg/beam/core/graph\"\n+\t\"github.com/apache/beam/sdks/go/pkg/beam/core/runtime/graphx\"\n \t\"github.com/apache/beam/sdks/go/pkg/beam/internal/errors\"\n+\tjobpb \"github.com/apache/beam/sdks/go/pkg/beam/model/jobmanagement_v1\"\n+\tpipepb \"github.com/apache/beam/sdks/go/pkg/beam/model/pipeline_v1\"\n+\t\"google.golang.org/grpc\"\n )\n \n+// ExternalTransform represents the cross-language transform in and out of the Pipeline as a MultiEdge and Expanded proto respectively\n+type ExternalTransform struct {\n+\tid                int\n+\tUrn               string\n+\tPayload           []byte\n+\tIn                []PCollection\n+\tOut               []FullType\n+\tBounded           bool\n+\tExpansionAddr     string\n+\tComponents        *pipepb.Components\n+\tExpandedTransform *pipepb.PTransform\n+\tRequirements      []string\n+}\n+\n+// CrossLanguage is the temporary API to execute external transforms\n+// TODO(pskevin): Handle errors using the TryN and Must strategies instead one function handling multiple points of failure\n+func CrossLanguage(s Scope, p *Pipeline, e *ExternalTransform) []PCollection {", "originalCommit": "43a4a119bf0d95a1fc33c65842b99ef0ebbcf041", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTQ3ODY2NA==", "url": "https://github.com/apache/beam/pull/12445#discussion_r465478664", "bodyText": "Ack.", "author": "pskevin", "createdAt": "2020-08-05T05:18:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDcyMDc3MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDcyMTE4MA==", "url": "https://github.com/apache/beam/pull/12445#discussion_r464721180", "bodyText": "As discussed, this data can be part of the graph.External node (or a new graph.CrossLanguage struct if desired) which keeps it as part of the graph and can be handled appropriately in graphx/translate.go. There's absolutely no need to add a new way to pass information in through the pipeline OR the suggestion you have for scope.\nUse the existing abstraction. If it's not sufficient, please articulate why.", "author": "lostluck", "createdAt": "2020-08-03T23:52:56Z", "path": "sdks/go/pkg/beam/external.go", "diffHunk": "@@ -16,10 +16,151 @@\n package beam\n \n import (\n+\t\"context\"\n+\t\"fmt\"\n+\n \t\"github.com/apache/beam/sdks/go/pkg/beam/core/graph\"\n+\t\"github.com/apache/beam/sdks/go/pkg/beam/core/runtime/graphx\"\n \t\"github.com/apache/beam/sdks/go/pkg/beam/internal/errors\"\n+\tjobpb \"github.com/apache/beam/sdks/go/pkg/beam/model/jobmanagement_v1\"\n+\tpipepb \"github.com/apache/beam/sdks/go/pkg/beam/model/pipeline_v1\"\n+\t\"google.golang.org/grpc\"\n )\n \n+// ExternalTransform represents the cross-language transform in and out of the Pipeline as a MultiEdge and Expanded proto respectively\n+type ExternalTransform struct {\n+\tid                int\n+\tUrn               string\n+\tPayload           []byte\n+\tIn                []PCollection\n+\tOut               []FullType\n+\tBounded           bool\n+\tExpansionAddr     string\n+\tComponents        *pipepb.Components\n+\tExpandedTransform *pipepb.PTransform\n+\tRequirements      []string\n+}\n+\n+// CrossLanguage is the temporary API to execute external transforms\n+// TODO(pskevin): Handle errors using the TryN and Must strategies instead one function handling multiple points of failure\n+func CrossLanguage(s Scope, p *Pipeline, e *ExternalTransform) []PCollection {\n+\tif e.ExpansionAddr == \"\" { // TODO(pskevin): Better way to check if the value was ever set\n+\t\t// return Legacy External API\n+\t}\n+\n+\t/*\n+\t\tAdd ExternalTranform to the Graph\n+\t*/\n+\t// Validating scope and inputs\n+\tif !s.IsValid() {\n+\t\t// return nil, errors.New(\"invalid scope\")\n+\t\tfmt.Println(\"invalid scope\")\n+\t}\n+\tfor i, col := range e.In {\n+\t\tif !col.IsValid() {\n+\t\t\t// return nil, errors.Errorf(\"invalid pcollection to external: index %v\", i)\n+\t\t\tfmt.Printf(\"\\ninvalid pcollection to external: index %v\", i)\n+\n+\t\t}\n+\t}\n+\n+\t// Using exisiting MultiEdge format to represent ExternalTransform (already backwards compatible)\n+\tpayload := &graph.Payload{\n+\t\tURN:  e.Urn,\n+\t\tData: e.Payload,\n+\t}\n+\tvar ins []*graph.Node\n+\tfor _, col := range e.In {\n+\t\tins = append(ins, col.n)\n+\t}\n+\tedge := graph.NewCrossLanguage(s.real, s.scope, ins, payload)\n+\n+\t// TODO(pskevin): There needs to be a better way of associating this ExternalTransform to the pipeline\n+\t// Adding ExternalTransform to pipeline referenced by MultiEdge ID\n+\tif p.ExpandedTransforms == nil {\n+\t\tp.ExpandedTransforms = make(map[string]*ExternalTransform)\n+\t}\n+\tp.ExpandedTransforms[fmt.Sprintf(\"e%v\", edge.ID())] = e", "originalCommit": "43a4a119bf0d95a1fc33c65842b99ef0ebbcf041", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTc5NDA2Mw==", "url": "https://github.com/apache/beam/pull/12445#discussion_r471794063", "bodyText": "Ack. Updated!", "author": "pskevin", "createdAt": "2020-08-17T21:49:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDcyMTE4MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDcyMjAzOQ==", "url": "https://github.com/apache/beam/pull/12445#discussion_r464722039", "bodyText": "Change to a return once this can return errors.\nreturn errors.Wrapf(err, \"unable to connect to expansion service at %v, e.ExpansionAddr)", "author": "lostluck", "createdAt": "2020-08-03T23:55:49Z", "path": "sdks/go/pkg/beam/external.go", "diffHunk": "@@ -16,10 +16,151 @@\n package beam\n \n import (\n+\t\"context\"\n+\t\"fmt\"\n+\n \t\"github.com/apache/beam/sdks/go/pkg/beam/core/graph\"\n+\t\"github.com/apache/beam/sdks/go/pkg/beam/core/runtime/graphx\"\n \t\"github.com/apache/beam/sdks/go/pkg/beam/internal/errors\"\n+\tjobpb \"github.com/apache/beam/sdks/go/pkg/beam/model/jobmanagement_v1\"\n+\tpipepb \"github.com/apache/beam/sdks/go/pkg/beam/model/pipeline_v1\"\n+\t\"google.golang.org/grpc\"\n )\n \n+// ExternalTransform represents the cross-language transform in and out of the Pipeline as a MultiEdge and Expanded proto respectively\n+type ExternalTransform struct {\n+\tid                int\n+\tUrn               string\n+\tPayload           []byte\n+\tIn                []PCollection\n+\tOut               []FullType\n+\tBounded           bool\n+\tExpansionAddr     string\n+\tComponents        *pipepb.Components\n+\tExpandedTransform *pipepb.PTransform\n+\tRequirements      []string\n+}\n+\n+// CrossLanguage is the temporary API to execute external transforms\n+// TODO(pskevin): Handle errors using the TryN and Must strategies instead one function handling multiple points of failure\n+func CrossLanguage(s Scope, p *Pipeline, e *ExternalTransform) []PCollection {\n+\tif e.ExpansionAddr == \"\" { // TODO(pskevin): Better way to check if the value was ever set\n+\t\t// return Legacy External API\n+\t}\n+\n+\t/*\n+\t\tAdd ExternalTranform to the Graph\n+\t*/\n+\t// Validating scope and inputs\n+\tif !s.IsValid() {\n+\t\t// return nil, errors.New(\"invalid scope\")\n+\t\tfmt.Println(\"invalid scope\")\n+\t}\n+\tfor i, col := range e.In {\n+\t\tif !col.IsValid() {\n+\t\t\t// return nil, errors.Errorf(\"invalid pcollection to external: index %v\", i)\n+\t\t\tfmt.Printf(\"\\ninvalid pcollection to external: index %v\", i)\n+\n+\t\t}\n+\t}\n+\n+\t// Using exisiting MultiEdge format to represent ExternalTransform (already backwards compatible)\n+\tpayload := &graph.Payload{\n+\t\tURN:  e.Urn,\n+\t\tData: e.Payload,\n+\t}\n+\tvar ins []*graph.Node\n+\tfor _, col := range e.In {\n+\t\tins = append(ins, col.n)\n+\t}\n+\tedge := graph.NewCrossLanguage(s.real, s.scope, ins, payload)\n+\n+\t// TODO(pskevin): There needs to be a better way of associating this ExternalTransform to the pipeline\n+\t// Adding ExternalTransform to pipeline referenced by MultiEdge ID\n+\tif p.ExpandedTransforms == nil {\n+\t\tp.ExpandedTransforms = make(map[string]*ExternalTransform)\n+\t}\n+\tp.ExpandedTransforms[fmt.Sprintf(\"e%v\", edge.ID())] = e\n+\n+\t/*\n+\t\tBuild the ExpansionRequest\n+\t*/\n+\t// Obtaining the components and transform proto representing this transform\n+\tpipeline, err := graphx.Marshal([]*graph.MultiEdge{edge}, &graphx.Options{})\n+\tif err != nil {\n+\t\tpanic(err)\n+\t}\n+\n+\t// Adding fake impulses to each input as required for correct expansion\n+\t// TODO(pskevin): Remove these fake impulses from final Pipeline since multiple producers of the same PCollections is logically wrong\n+\ttransforms := pipeline.Components.Transforms\n+\trootTransformID := pipeline.RootTransformIds[0]\n+\tfor tag, id := range transforms[rootTransformID].Inputs {\n+\t\tkey := fmt.Sprintf(\"%s_%s\", \"impulse\", tag)\n+\n+\t\toutput := map[string]string{\"out\": id}\n+\t\timpulse := &pipepb.PTransform{\n+\t\t\tUniqueName: key,\n+\t\t\tSpec: &pipepb.FunctionSpec{\n+\t\t\t\tUrn: graphx.URNImpulse,\n+\t\t\t},\n+\t\t\tOutputs: output,\n+\t\t}\n+\n+\t\ttransforms[key] = impulse\n+\t}\n+\n+\t// Assembling ExpansionRequest proto\n+\treq := &jobpb.ExpansionRequest{\n+\t\tComponents: pipeline.Components,\n+\t\tTransform:  transforms[rootTransformID],\n+\t\tNamespace:  s.String(),\n+\t}\n+\n+\t/*\n+\t\tQuerying Expansion Service\n+\t*/\n+\t// Setting grpc client\n+\tconn, err := grpc.Dial(e.ExpansionAddr, grpc.WithInsecure())\n+\tif err != nil {\n+\t\tpanic(err)", "originalCommit": "43a4a119bf0d95a1fc33c65842b99ef0ebbcf041", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTM3MzU2Nw==", "url": "https://github.com/apache/beam/pull/12445#discussion_r465373567", "bodyText": "Ack! Thanks for also exemplifying the correct function to use.", "author": "pskevin", "createdAt": "2020-08-04T22:51:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDcyMjAzOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDcyMjg5NA==", "url": "https://github.com/apache/beam/pull/12445#discussion_r464722894", "bodyText": "Note these can be added as fields (in one form or another), as an exported field on graph.MultiEdge\nhttps://github.com/apache/beam/blob/master/sdks/go/pkg/beam/core/graph/edge.go#L143\nFor now disregard the restriction on dealing with protos in graph.\nTechnically, one other approach to avoid the dependencies is to simply re-Marshal the received protos back to []byte and Unmarshal them in graphx/translate.go. As always, get it working first before trying to fix this dependency knot.", "author": "lostluck", "createdAt": "2020-08-03T23:59:02Z", "path": "sdks/go/pkg/beam/external.go", "diffHunk": "@@ -16,10 +16,151 @@\n package beam\n \n import (\n+\t\"context\"\n+\t\"fmt\"\n+\n \t\"github.com/apache/beam/sdks/go/pkg/beam/core/graph\"\n+\t\"github.com/apache/beam/sdks/go/pkg/beam/core/runtime/graphx\"\n \t\"github.com/apache/beam/sdks/go/pkg/beam/internal/errors\"\n+\tjobpb \"github.com/apache/beam/sdks/go/pkg/beam/model/jobmanagement_v1\"\n+\tpipepb \"github.com/apache/beam/sdks/go/pkg/beam/model/pipeline_v1\"\n+\t\"google.golang.org/grpc\"\n )\n \n+// ExternalTransform represents the cross-language transform in and out of the Pipeline as a MultiEdge and Expanded proto respectively\n+type ExternalTransform struct {\n+\tid                int\n+\tUrn               string\n+\tPayload           []byte\n+\tIn                []PCollection\n+\tOut               []FullType\n+\tBounded           bool\n+\tExpansionAddr     string\n+\tComponents        *pipepb.Components\n+\tExpandedTransform *pipepb.PTransform\n+\tRequirements      []string\n+}\n+\n+// CrossLanguage is the temporary API to execute external transforms\n+// TODO(pskevin): Handle errors using the TryN and Must strategies instead one function handling multiple points of failure\n+func CrossLanguage(s Scope, p *Pipeline, e *ExternalTransform) []PCollection {\n+\tif e.ExpansionAddr == \"\" { // TODO(pskevin): Better way to check if the value was ever set\n+\t\t// return Legacy External API\n+\t}\n+\n+\t/*\n+\t\tAdd ExternalTranform to the Graph\n+\t*/\n+\t// Validating scope and inputs\n+\tif !s.IsValid() {\n+\t\t// return nil, errors.New(\"invalid scope\")\n+\t\tfmt.Println(\"invalid scope\")\n+\t}\n+\tfor i, col := range e.In {\n+\t\tif !col.IsValid() {\n+\t\t\t// return nil, errors.Errorf(\"invalid pcollection to external: index %v\", i)\n+\t\t\tfmt.Printf(\"\\ninvalid pcollection to external: index %v\", i)\n+\n+\t\t}\n+\t}\n+\n+\t// Using exisiting MultiEdge format to represent ExternalTransform (already backwards compatible)\n+\tpayload := &graph.Payload{\n+\t\tURN:  e.Urn,\n+\t\tData: e.Payload,\n+\t}\n+\tvar ins []*graph.Node\n+\tfor _, col := range e.In {\n+\t\tins = append(ins, col.n)\n+\t}\n+\tedge := graph.NewCrossLanguage(s.real, s.scope, ins, payload)\n+\n+\t// TODO(pskevin): There needs to be a better way of associating this ExternalTransform to the pipeline\n+\t// Adding ExternalTransform to pipeline referenced by MultiEdge ID\n+\tif p.ExpandedTransforms == nil {\n+\t\tp.ExpandedTransforms = make(map[string]*ExternalTransform)\n+\t}\n+\tp.ExpandedTransforms[fmt.Sprintf(\"e%v\", edge.ID())] = e\n+\n+\t/*\n+\t\tBuild the ExpansionRequest\n+\t*/\n+\t// Obtaining the components and transform proto representing this transform\n+\tpipeline, err := graphx.Marshal([]*graph.MultiEdge{edge}, &graphx.Options{})\n+\tif err != nil {\n+\t\tpanic(err)\n+\t}\n+\n+\t// Adding fake impulses to each input as required for correct expansion\n+\t// TODO(pskevin): Remove these fake impulses from final Pipeline since multiple producers of the same PCollections is logically wrong\n+\ttransforms := pipeline.Components.Transforms\n+\trootTransformID := pipeline.RootTransformIds[0]\n+\tfor tag, id := range transforms[rootTransformID].Inputs {\n+\t\tkey := fmt.Sprintf(\"%s_%s\", \"impulse\", tag)\n+\n+\t\toutput := map[string]string{\"out\": id}\n+\t\timpulse := &pipepb.PTransform{\n+\t\t\tUniqueName: key,\n+\t\t\tSpec: &pipepb.FunctionSpec{\n+\t\t\t\tUrn: graphx.URNImpulse,\n+\t\t\t},\n+\t\t\tOutputs: output,\n+\t\t}\n+\n+\t\ttransforms[key] = impulse\n+\t}\n+\n+\t// Assembling ExpansionRequest proto\n+\treq := &jobpb.ExpansionRequest{\n+\t\tComponents: pipeline.Components,\n+\t\tTransform:  transforms[rootTransformID],\n+\t\tNamespace:  s.String(),\n+\t}\n+\n+\t/*\n+\t\tQuerying Expansion Service\n+\t*/\n+\t// Setting grpc client\n+\tconn, err := grpc.Dial(e.ExpansionAddr, grpc.WithInsecure())\n+\tif err != nil {\n+\t\tpanic(err)\n+\t}\n+\tdefer conn.Close()\n+\tclient := jobpb.NewExpansionServiceClient(conn)\n+\n+\t// Handling ExpansionResponse\n+\tres, err := client.Expand(context.Background(), req)\n+\tif err != nil {\n+\t\tpanic(err)\n+\t}\n+\te.Components = res.GetComponents()", "originalCommit": "43a4a119bf0d95a1fc33c65842b99ef0ebbcf041", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTg4NTMxNw==", "url": "https://github.com/apache/beam/pull/12445#discussion_r465885317", "bodyText": "I don't know why it didn't occur to me before, but if the deserialized proto object needs to be \"stored\" on an object in the graph package, that field can just be an interface{} and be commented that it's expected to be the proto type. As the fields are only usable by beam framework internals, it's fine to assume that they'll be the correct types by construction (validated by unit tests at some juncture).", "author": "lostluck", "createdAt": "2020-08-05T17:23:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDcyMjg5NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTc5NDIzOQ==", "url": "https://github.com/apache/beam/pull/12445#discussion_r471794239", "bodyText": "That's a great suggestion. I've updated it to be in line with it.", "author": "pskevin", "createdAt": "2020-08-17T21:49:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDcyMjg5NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDcyMzg5Nw==", "url": "https://github.com/apache/beam/pull/12445#discussion_r464723897", "bodyText": "Since the next change will handle PCollection mappings by user provided string keys, we can probably get rid of this for now. Do add a TODO(lostluck) to remind me to plug in the schema coders here instead of what we're doing for the output types.", "author": "lostluck", "createdAt": "2020-08-04T00:02:53Z", "path": "sdks/go/pkg/beam/external.go", "diffHunk": "@@ -16,10 +16,151 @@\n package beam\n \n import (\n+\t\"context\"\n+\t\"fmt\"\n+\n \t\"github.com/apache/beam/sdks/go/pkg/beam/core/graph\"\n+\t\"github.com/apache/beam/sdks/go/pkg/beam/core/runtime/graphx\"\n \t\"github.com/apache/beam/sdks/go/pkg/beam/internal/errors\"\n+\tjobpb \"github.com/apache/beam/sdks/go/pkg/beam/model/jobmanagement_v1\"\n+\tpipepb \"github.com/apache/beam/sdks/go/pkg/beam/model/pipeline_v1\"\n+\t\"google.golang.org/grpc\"\n )\n \n+// ExternalTransform represents the cross-language transform in and out of the Pipeline as a MultiEdge and Expanded proto respectively\n+type ExternalTransform struct {\n+\tid                int\n+\tUrn               string\n+\tPayload           []byte\n+\tIn                []PCollection\n+\tOut               []FullType\n+\tBounded           bool\n+\tExpansionAddr     string\n+\tComponents        *pipepb.Components\n+\tExpandedTransform *pipepb.PTransform\n+\tRequirements      []string\n+}\n+\n+// CrossLanguage is the temporary API to execute external transforms\n+// TODO(pskevin): Handle errors using the TryN and Must strategies instead one function handling multiple points of failure\n+func CrossLanguage(s Scope, p *Pipeline, e *ExternalTransform) []PCollection {\n+\tif e.ExpansionAddr == \"\" { // TODO(pskevin): Better way to check if the value was ever set\n+\t\t// return Legacy External API\n+\t}\n+\n+\t/*\n+\t\tAdd ExternalTranform to the Graph\n+\t*/\n+\t// Validating scope and inputs\n+\tif !s.IsValid() {\n+\t\t// return nil, errors.New(\"invalid scope\")\n+\t\tfmt.Println(\"invalid scope\")\n+\t}\n+\tfor i, col := range e.In {\n+\t\tif !col.IsValid() {\n+\t\t\t// return nil, errors.Errorf(\"invalid pcollection to external: index %v\", i)\n+\t\t\tfmt.Printf(\"\\ninvalid pcollection to external: index %v\", i)\n+\n+\t\t}\n+\t}\n+\n+\t// Using exisiting MultiEdge format to represent ExternalTransform (already backwards compatible)\n+\tpayload := &graph.Payload{\n+\t\tURN:  e.Urn,\n+\t\tData: e.Payload,\n+\t}\n+\tvar ins []*graph.Node\n+\tfor _, col := range e.In {\n+\t\tins = append(ins, col.n)\n+\t}\n+\tedge := graph.NewCrossLanguage(s.real, s.scope, ins, payload)\n+\n+\t// TODO(pskevin): There needs to be a better way of associating this ExternalTransform to the pipeline\n+\t// Adding ExternalTransform to pipeline referenced by MultiEdge ID\n+\tif p.ExpandedTransforms == nil {\n+\t\tp.ExpandedTransforms = make(map[string]*ExternalTransform)\n+\t}\n+\tp.ExpandedTransforms[fmt.Sprintf(\"e%v\", edge.ID())] = e\n+\n+\t/*\n+\t\tBuild the ExpansionRequest\n+\t*/\n+\t// Obtaining the components and transform proto representing this transform\n+\tpipeline, err := graphx.Marshal([]*graph.MultiEdge{edge}, &graphx.Options{})\n+\tif err != nil {\n+\t\tpanic(err)\n+\t}\n+\n+\t// Adding fake impulses to each input as required for correct expansion\n+\t// TODO(pskevin): Remove these fake impulses from final Pipeline since multiple producers of the same PCollections is logically wrong\n+\ttransforms := pipeline.Components.Transforms\n+\trootTransformID := pipeline.RootTransformIds[0]\n+\tfor tag, id := range transforms[rootTransformID].Inputs {\n+\t\tkey := fmt.Sprintf(\"%s_%s\", \"impulse\", tag)\n+\n+\t\toutput := map[string]string{\"out\": id}\n+\t\timpulse := &pipepb.PTransform{\n+\t\t\tUniqueName: key,\n+\t\t\tSpec: &pipepb.FunctionSpec{\n+\t\t\t\tUrn: graphx.URNImpulse,\n+\t\t\t},\n+\t\t\tOutputs: output,\n+\t\t}\n+\n+\t\ttransforms[key] = impulse\n+\t}\n+\n+\t// Assembling ExpansionRequest proto\n+\treq := &jobpb.ExpansionRequest{\n+\t\tComponents: pipeline.Components,\n+\t\tTransform:  transforms[rootTransformID],\n+\t\tNamespace:  s.String(),\n+\t}\n+\n+\t/*\n+\t\tQuerying Expansion Service\n+\t*/\n+\t// Setting grpc client\n+\tconn, err := grpc.Dial(e.ExpansionAddr, grpc.WithInsecure())\n+\tif err != nil {\n+\t\tpanic(err)\n+\t}\n+\tdefer conn.Close()\n+\tclient := jobpb.NewExpansionServiceClient(conn)\n+\n+\t// Handling ExpansionResponse\n+\tres, err := client.Expand(context.Background(), req)\n+\tif err != nil {\n+\t\tpanic(err)\n+\t}\n+\te.Components = res.GetComponents()\n+\te.ExpandedTransform = res.GetTransform()\n+\te.Requirements = res.GetRequirements()\n+\n+\t/*\n+\t\tAssociating output PCollections of the expanded transform with correct internal outbound links and nodes\n+\t*/\n+\t// No information about the output types and bounded nature has been explicitly passed by the user\n+\tif len(e.Out) == 0 || cap(e.Out) == 0 {\n+\t\t// Infer output types from ExpansionResponse and update e.Out\n+\t\tif e.Out == nil {\n+\t\t\t// Use reverse schema encoding\n+\t\t} else {\n+\t\t\t// Use the coders list and map from coder id to internal FullType?\n+\t\t}\n+\t}", "originalCommit": "43a4a119bf0d95a1fc33c65842b99ef0ebbcf041", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTM3MzY4MA==", "url": "https://github.com/apache/beam/pull/12445#discussion_r465373680", "bodyText": "Makes sense. Will do!", "author": "pskevin", "createdAt": "2020-08-04T22:51:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDcyMzg5Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDcyNDQzNw==", "url": "https://github.com/apache/beam/pull/12445#discussion_r464724437", "bodyText": "As discussed, we don't want to have to hang the expanded transforms on the pipeline here.", "author": "lostluck", "createdAt": "2020-08-04T00:05:07Z", "path": "sdks/go/pkg/beam/pipeline.go", "diffHunk": "@@ -60,7 +60,8 @@ func (s Scope) String() string {\n // Pipelines can safely be executed concurrently.\n type Pipeline struct {\n \t// real is the deferred execution Graph as it is being constructed.\n-\treal *graph.Graph\n+\treal               *graph.Graph\n+\tExpandedTransforms map[string]*ExternalTransform", "originalCommit": "43a4a119bf0d95a1fc33c65842b99ef0ebbcf041", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTc5NDM0Mg==", "url": "https://github.com/apache/beam/pull/12445#discussion_r471794342", "bodyText": "Removed from pipeline.", "author": "pskevin", "createdAt": "2020-08-17T21:50:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDcyNDQzNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDcyNDczMg==", "url": "https://github.com/apache/beam/pull/12445#discussion_r464724732", "bodyText": "Similarly, this code should be moved into graphx/translate.go (though TBH this is substantial enough that having things isolated in function in a graphx/xlang.go which are then called in translate.go would be a good move.)", "author": "lostluck", "createdAt": "2020-08-04T00:06:07Z", "path": "sdks/go/pkg/beam/runners/universal/universal.go", "diffHunk": "@@ -82,6 +82,54 @@ func Execute(ctx context.Context, p *beam.Pipeline) error {\n \t\treturn errors.WithContextf(err, \"generating model pipeline\")\n \t}\n \n+\t// Adding Expanded transforms to their counterparts in the Pipeline\n+\tfor id, external := range p.ExpandedTransforms {", "originalCommit": "43a4a119bf0d95a1fc33c65842b99ef0ebbcf041", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTc5NDY3OA==", "url": "https://github.com/apache/beam/pull/12445#discussion_r471794678", "bodyText": "I've reorganized much of the code. Your opinions would be helpful to understand which of them are not relevant.", "author": "pskevin", "createdAt": "2020-08-17T21:50:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDcyNDczMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDcyNTM1MQ==", "url": "https://github.com/apache/beam/pull/12445#discussion_r464725351", "bodyText": "You should be able to clean this up with pipelinex.Update\nhttps://github.com/apache/beam/blob/master/sdks/go/pkg/beam/core/runtime/pipelinex/replace.go#L32\nNote that you'll need to delete the \"go\" entry from the environments first to do that safely for the loopback mode fix.", "author": "lostluck", "createdAt": "2020-08-04T00:08:37Z", "path": "sdks/go/pkg/beam/runners/universal/universal.go", "diffHunk": "@@ -82,6 +82,54 @@ func Execute(ctx context.Context, p *beam.Pipeline) error {\n \t\treturn errors.WithContextf(err, \"generating model pipeline\")\n \t}\n \n+\t// Adding Expanded transforms to their counterparts in the Pipeline\n+\tfor id, external := range p.ExpandedTransforms {\n+\t\tpipeline.Requirements = append(pipeline.Requirements, external.Requirements...)\n+\n+\t\t// Correct update of transform corresponding to the ExpandedTransform\n+\t\t// TODO(pskevin): Figure if there is a better way of supporting multiple outputs\n+\t\ttransform := pipeline.Components.Transforms[id]\n+\t\texistingInput := \"\"\n+\t\tnewInput := \"\"\n+\t\tfor _, v := range transform.Outputs {\n+\t\t\texistingInput = v\n+\t\t}\n+\t\tfor _, v := range external.ExpandedTransform.Outputs {\n+\t\t\tnewInput = v\n+\t\t}\n+\n+\t\tfor _, t := range pipeline.Components.Transforms {\n+\t\t\tfor idx, i := range t.Inputs {\n+\t\t\t\tif i == existingInput {\n+\t\t\t\t\tt.Inputs[idx] = newInput\n+\t\t\t\t}\n+\t\t\t}\n+\t\t}\n+\n+\t\t// Adding components of the Expanded Transforms to the current Pipeline\n+\t\tfor k, v := range external.Components.Transforms {", "originalCommit": "43a4a119bf0d95a1fc33c65842b99ef0ebbcf041", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTM3Mzg4Nw==", "url": "https://github.com/apache/beam/pull/12445#discussion_r465373887", "bodyText": "That's an awesome helper. Thanks for pointing it out.", "author": "pskevin", "createdAt": "2020-08-04T22:51:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDcyNTM1MQ=="}], "type": "inlineReview"}, {"oid": "ec2742680c0adb7c84ee019fa31c6b35628ca5f1", "url": "https://github.com/apache/beam/commit/ec2742680c0adb7c84ee019fa31c6b35628ca5f1", "message": "fix(xlang): resolving general comments", "committedDate": "2020-08-05T05:16:49Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTg3OTcyMA==", "url": "https://github.com/apache/beam/pull/12445#discussion_r465879720", "bodyText": "Per the other thread, please move these to parameters on CrossLanguage and TryCrossLanguage instead. Do not try to force in compatibility with the legacy External, it's OK for them to have two separate calls and paths.\nBy having them as a struct it's not clear what is required and what is not, and the compiler won't help the user by failing at compile time.\nAn aside: The other issue here is you've mixed up user side parameters with internal implementation details, and made them part of the API surface. APIs are easiest to use when the user knows how to fill everything and what is required or not. The components and Expanded transform and requirements fields are not something that users would be filling in for example. Types are cheap. Make a new type instead of trying to reuse something that almost fits.", "author": "lostluck", "createdAt": "2020-08-05T17:13:43Z", "path": "sdks/go/pkg/beam/external.go", "diffHunk": "@@ -16,10 +16,144 @@\n package beam\n \n import (\n+\t\"context\"\n+\t\"fmt\"\n+\n \t\"github.com/apache/beam/sdks/go/pkg/beam/core/graph\"\n+\t\"github.com/apache/beam/sdks/go/pkg/beam/core/runtime/graphx\"\n \t\"github.com/apache/beam/sdks/go/pkg/beam/internal/errors\"\n+\tjobpb \"github.com/apache/beam/sdks/go/pkg/beam/model/jobmanagement_v1\"\n+\tpipepb \"github.com/apache/beam/sdks/go/pkg/beam/model/pipeline_v1\"\n+\t\"google.golang.org/grpc\"\n )\n \n+// ExternalTransform represents the cross-language transform in and out of the Pipeline as a MultiEdge and Expanded proto respectively\n+type ExternalTransform struct {", "originalCommit": "ec2742680c0adb7c84ee019fa31c6b35628ca5f1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTkzNDU5MA==", "url": "https://github.com/apache/beam/pull/12445#discussion_r465934590", "bodyText": "The current version was never meant to be representative of what the final API would be. Only after discussing code organization was the API surface meant to be refined.\nThanks for the new type idea! It'll make separation of concerns much clearer.", "author": "pskevin", "createdAt": "2020-08-05T18:52:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTg3OTcyMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTg4MjcxOA==", "url": "https://github.com/apache/beam/pull/12445#discussion_r465882718", "bodyText": "Move these to a graph.CrossLanguage struct, but have their proto types be interface{} instead, with a comment about what the types should be. Given those fields are only used by beam framework internals, there's little risk in using type assertions for them in the right places, such as the graphx package.", "author": "lostluck", "createdAt": "2020-08-05T17:18:47Z", "path": "sdks/go/pkg/beam/external.go", "diffHunk": "@@ -16,10 +16,144 @@\n package beam\n \n import (\n+\t\"context\"\n+\t\"fmt\"\n+\n \t\"github.com/apache/beam/sdks/go/pkg/beam/core/graph\"\n+\t\"github.com/apache/beam/sdks/go/pkg/beam/core/runtime/graphx\"\n \t\"github.com/apache/beam/sdks/go/pkg/beam/internal/errors\"\n+\tjobpb \"github.com/apache/beam/sdks/go/pkg/beam/model/jobmanagement_v1\"\n+\tpipepb \"github.com/apache/beam/sdks/go/pkg/beam/model/pipeline_v1\"\n+\t\"google.golang.org/grpc\"\n )\n \n+// ExternalTransform represents the cross-language transform in and out of the Pipeline as a MultiEdge and Expanded proto respectively\n+type ExternalTransform struct {\n+\tid                int\n+\tUrn               string\n+\tPayload           []byte\n+\tIn                []PCollection\n+\tOut               []FullType\n+\tBounded           bool\n+\tExpansionAddr     string\n+\tComponents        *pipepb.Components\n+\tExpandedTransform *pipepb.PTransform\n+\tRequirements      []string", "originalCommit": "ec2742680c0adb7c84ee019fa31c6b35628ca5f1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTkzNDkwNg==", "url": "https://github.com/apache/beam/pull/12445#discussion_r465934906", "bodyText": "Awesome suggestion. Will work on it.", "author": "pskevin", "createdAt": "2020-08-05T18:53:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTg4MjcxOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjA1MzQ3OA==", "url": "https://github.com/apache/beam/pull/12445#discussion_r466053478", "bodyText": "Expansion address seems like a good candidate to be a flag instead.", "author": "youngoli", "createdAt": "2020-08-05T23:10:28Z", "path": "sdks/go/examples/xlang/wordcount/xlang_wordcount.go", "diffHunk": "@@ -0,0 +1,107 @@\n+// Licensed to the Apache Software Foundation (ASF) under one or more\n+// contributor license agreements.  See the NOTICE file distributed with\n+// this work for additional information regarding copyright ownership.\n+// The ASF licenses this file to You under the Apache License, Version 2.0\n+// (the \"License\"); you may not use this file except in compliance with\n+// the License.  You may obtain a copy of the License at\n+//\n+//    http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing, software\n+// distributed under the License is distributed on an \"AS IS\" BASIS,\n+// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+// See the License for the specific language governing permissions and\n+// limitations under the License.\n+\n+// xlang_wordcount exemplifies using a cross language transform from Python to count words\n+package main\n+\n+import (\n+\t\"context\"\n+\t\"flag\"\n+\t\"fmt\"\n+\t\"log\"\n+\t\"regexp\"\n+\t\"strings\"\n+\n+\t\"github.com/apache/beam/sdks/go/pkg/beam/core/typex\"\n+\t\"github.com/apache/beam/sdks/go/pkg/beam/core/util/reflectx\"\n+\n+\t\"github.com/apache/beam/sdks/go/pkg/beam\"\n+\t\"github.com/apache/beam/sdks/go/pkg/beam/io/textio\"\n+\t\"github.com/apache/beam/sdks/go/pkg/beam/x/beamx\"\n+\n+\t// Imports to enable correct filesystem access and runner setup in LOOPBACK mode\n+\t_ \"github.com/apache/beam/sdks/go/pkg/beam/io/filesystem/gcs\"\n+\t_ \"github.com/apache/beam/sdks/go/pkg/beam/io/filesystem/local\"\n+\t_ \"github.com/apache/beam/sdks/go/pkg/beam/runners/universal\"\n+)\n+\n+var (\n+\t// Set this option to choose a different input file or glob.\n+\tinput = flag.String(\"input\", \"./input\", \"File(s) to read.\")\n+\n+\t// Set this required option to specify where to write the output.\n+\toutput = flag.String(\"output\", \"./output\", \"Output file (required).\")\n+)\n+\n+var (\n+\twordRE  = regexp.MustCompile(`[a-zA-Z]+('[a-z])?`)\n+\tempty   = beam.NewCounter(\"extract\", \"emptyLines\")\n+\tlineLen = beam.NewDistribution(\"extract\", \"lineLenDistro\")\n+)\n+\n+// extractFn is a DoFn that emits the words in a given line.\n+func extractFn(ctx context.Context, line string, emit func(string)) {\n+\tlineLen.Update(ctx, int64(len(line)))\n+\tif len(strings.TrimSpace(line)) == 0 {\n+\t\tempty.Inc(ctx, 1)\n+\t}\n+\tfor _, word := range wordRE.FindAllString(line, -1) {\n+\t\temit(word)\n+\t}\n+}\n+\n+// formatFn is a DoFn that formats a word and its count as a string.\n+func formatFn(w string, c int64) string {\n+\treturn fmt.Sprintf(\"%s: %v\", w, c)\n+}\n+\n+func init() {\n+\tbeam.RegisterFunction(extractFn)\n+\tbeam.RegisterFunction(formatFn)\n+}\n+\n+func main() {\n+\tflag.Parse()\n+\tbeam.Init()\n+\n+\tif *output == \"\" {\n+\t\tlog.Fatal(\"No output provided\")\n+\t}\n+\n+\tp := beam.NewPipeline()\n+\ts := p.Root()\n+\n+\tlines := textio.Read(s, *input)\n+\tcol := beam.ParDo(s, extractFn, lines)\n+\n+\t// Using Cross-language Count from Python's test expansion service\n+\t// TODO(pskevin): Cleaner using-face API\n+\toutputType := typex.NewKV(typex.New(reflectx.String), typex.New(reflectx.Int64))\n+\texternal := &beam.ExternalTransform{\n+\t\tIn:            []beam.PCollection{col},\n+\t\tUrn:           \"beam:transforms:xlang:count\",\n+\t\tExpansionAddr: \"localhost:8118\",", "originalCommit": "ec2742680c0adb7c84ee019fa31c6b35628ca5f1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjU1MjkxMg==", "url": "https://github.com/apache/beam/pull/12445#discussion_r466552912", "bodyText": "Alas, it's got to be a parameter. Users may request transforms from multiple independent expansion servers (eg. a Java one, a python one, a dataflow one...)", "author": "lostluck", "createdAt": "2020-08-06T16:57:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjA1MzQ3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Njc1ODY0OQ==", "url": "https://github.com/apache/beam/pull/12445#discussion_r466758649", "bodyText": "Gotcha, but it might still be a good idea in this example if the expansion servers' addresses can change. I'd expect that if you were a user writing and running cross language pipelines, you wouldn't want to change the address in your code each time, you'd want some flag you can change instead. Same if you have multiple different expansion servers.\nOf course, if expansion servers are expected to have a consistent address then this seems good as-is.", "author": "youngoli", "createdAt": "2020-08-07T00:41:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjA1MzQ3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTc5MjU4MQ==", "url": "https://github.com/apache/beam/pull/12445#discussion_r471792581", "bodyText": "Thanks for that suggestion @youngoli! I've updated it.", "author": "pskevin", "createdAt": "2020-08-17T21:45:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjA1MzQ3OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjA1NjYzNg==", "url": "https://github.com/apache/beam/pull/12445#discussion_r466056636", "bodyText": "This example requires running an expansion service separately in order to work, right? I'd add instructions to the package comment on how to run that so people can run this example without existing knowledge of how xlang works. See the stringsplit example for an example of this. It requires running on a job service that supports splitting, so I included instructions for running an external job service.", "author": "youngoli", "createdAt": "2020-08-05T23:20:37Z", "path": "sdks/go/examples/xlang/wordcount/xlang_wordcount.go", "diffHunk": "@@ -0,0 +1,107 @@\n+// Licensed to the Apache Software Foundation (ASF) under one or more\n+// contributor license agreements.  See the NOTICE file distributed with\n+// this work for additional information regarding copyright ownership.\n+// The ASF licenses this file to You under the Apache License, Version 2.0\n+// (the \"License\"); you may not use this file except in compliance with\n+// the License.  You may obtain a copy of the License at\n+//\n+//    http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing, software\n+// distributed under the License is distributed on an \"AS IS\" BASIS,\n+// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+// See the License for the specific language governing permissions and\n+// limitations under the License.\n+\n+// xlang_wordcount exemplifies using a cross language transform from Python to count words\n+package main", "originalCommit": "ec2742680c0adb7c84ee019fa31c6b35628ca5f1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjA3NDExMQ==", "url": "https://github.com/apache/beam/pull/12445#discussion_r466074111", "bodyText": "Nit: Typo\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t// Using exisiting MultiEdge format to represent ExternalTransform (already backwards compatible)\n          \n          \n            \n            \t// Using existing MultiEdge format to represent ExternalTransform (already backwards compatible)", "author": "youngoli", "createdAt": "2020-08-06T00:19:48Z", "path": "sdks/go/pkg/beam/external.go", "diffHunk": "@@ -16,10 +16,144 @@\n package beam\n \n import (\n+\t\"context\"\n+\t\"fmt\"\n+\n \t\"github.com/apache/beam/sdks/go/pkg/beam/core/graph\"\n+\t\"github.com/apache/beam/sdks/go/pkg/beam/core/runtime/graphx\"\n \t\"github.com/apache/beam/sdks/go/pkg/beam/internal/errors\"\n+\tjobpb \"github.com/apache/beam/sdks/go/pkg/beam/model/jobmanagement_v1\"\n+\tpipepb \"github.com/apache/beam/sdks/go/pkg/beam/model/pipeline_v1\"\n+\t\"google.golang.org/grpc\"\n )\n \n+// ExternalTransform represents the cross-language transform in and out of the Pipeline as a MultiEdge and Expanded proto respectively\n+type ExternalTransform struct {\n+\tid                int\n+\tUrn               string\n+\tPayload           []byte\n+\tIn                []PCollection\n+\tOut               []FullType\n+\tBounded           bool\n+\tExpansionAddr     string\n+\tComponents        *pipepb.Components\n+\tExpandedTransform *pipepb.PTransform\n+\tRequirements      []string\n+}\n+\n+// CrossLanguage is the temporary API to execute external transforms\n+func CrossLanguage(s Scope, p *Pipeline, e *ExternalTransform) []PCollection {\n+\treturn MustN(TryCrossLanguage(s, p, e))\n+}\n+\n+func TryCrossLanguage(s Scope, p *Pipeline, e *ExternalTransform) ([]PCollection, error) {\n+\tif e.ExpansionAddr == \"\" { // TODO(pskevin): Better way to check if the value was ever set\n+\t\t// return Legacy External API\n+\t}\n+\n+\t// Add ExternalTransform to the Graph\n+\n+\t// Validating scope and inputs\n+\tif !s.IsValid() {\n+\t\treturn nil, errors.New(\"invalid scope\")\n+\t}\n+\tfor i, col := range e.In {\n+\t\tif !col.IsValid() {\n+\t\t\treturn nil, errors.Errorf(\"invalid pcollection to external: index %v\", i)\n+\t\t}\n+\t}\n+\n+\t// Using exisiting MultiEdge format to represent ExternalTransform (already backwards compatible)", "originalCommit": "ec2742680c0adb7c84ee019fa31c6b35628ca5f1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "a7770f9f21fd9d6044a33e48e07f3632a3511bc8", "url": "https://github.com/apache/beam/commit/a7770f9f21fd9d6044a33e48e07f3632a3511bc8", "message": "feat(beam/sdks/go): skeleton for n:n input/output", "committedDate": "2020-08-12T15:51:15Z", "type": "commit"}, {"oid": "12d27cd6e893f8f442e881866eab2985a289df09", "url": "https://github.com/apache/beam/commit/12d27cd6e893f8f442e881866eab2985a289df09", "message": "feat(beam/sdks/go): sample working n:n input/output", "committedDate": "2020-08-17T07:08:18Z", "type": "commit"}, {"oid": "5f5de93b799ef605ae25af9d7953fc8a832c330f", "url": "https://github.com/apache/beam/commit/5f5de93b799ef605ae25af9d7953fc8a832c330f", "message": "fix(beam/sdks/go): cleaning up comments and prints", "committedDate": "2020-08-17T21:33:40Z", "type": "commit"}, {"oid": "d2725660da5fea07bb83087b820cf93449f6af7c", "url": "https://github.com/apache/beam/commit/d2725660da5fea07bb83087b820cf93449f6af7c", "message": "fix(beam/sdks/go): adding apache license wherever applicable", "committedDate": "2020-08-17T22:03:40Z", "type": "commit"}, {"oid": "dd2f49c31efdf1e87c1ba35056a5c176dcf87e2d", "url": "https://github.com/apache/beam/commit/dd2f49c31efdf1e87c1ba35056a5c176dcf87e2d", "message": "fix(beam/go/sdks): removed input files", "committedDate": "2020-08-17T23:44:17Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTgzNzMxMw==", "url": "https://github.com/apache/beam/pull/12445#discussion_r471837313", "bodyText": "Good use of a value method here and the similar functions.", "author": "lostluck", "createdAt": "2020-08-17T23:57:33Z", "path": "sdks/go/pkg/beam/core/graph/xlang.go", "diffHunk": "@@ -0,0 +1,129 @@\n+// Licensed to the Apache Software Foundation (ASF) under one or more\n+// contributor license agreements.  See the NOTICE file distributed with\n+// this work for additional information regarding copyright ownership.\n+// The ASF licenses this file to You under the Apache License, Version 2.0\n+// (the \"License\"); you may not use this file except in compliance with\n+// the License.  You may obtain a copy of the License at\n+//\n+//    http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing, software\n+// distributed under the License is distributed on an \"AS IS\" BASIS,\n+// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+// See the License for the specific language governing permissions and\n+// limitations under the License.\n+\n+package graph\n+\n+import (\n+\t\"github.com/apache/beam/sdks/go/pkg/beam/core/typex\"\n+\t\"github.com/apache/beam/sdks/go/pkg/beam/internal/errors\"\n+\tpipepb \"github.com/apache/beam/sdks/go/pkg/beam/model/pipeline_v1\"\n+)\n+\n+type ExpandedTransform struct {\n+\tComponents_     interface{} // *pipepb.Components\n+\tTransform_      interface{} //*pipepb.PTransform\n+\tRequirements_   []string\n+\tBoundedOutputs_ map[string]bool\n+}\n+\n+func (exp *ExpandedTransform) Components() *pipepb.Components {\n+\tif c, ok := exp.Components_.(*pipepb.Components); ok {\n+\t\treturn c\n+\t}\n+\tpanic(errors.Errorf(\"malformed components; %v lacks a conforming pipeline component\", exp))\n+}\n+\n+func (exp *ExpandedTransform) Transform() *pipepb.PTransform {\n+\tif t, ok := exp.Transform_.(*pipepb.PTransform); ok {\n+\t\treturn t\n+\t}\n+\tpanic(errors.Errorf(\"malformed transform; %v lacks a conforming pipeline ptransform\", exp))\n+}\n+\n+func (exp *ExpandedTransform) Requirements() []string {\n+\tif exp.Requirements_ != nil {\n+\t\treturn exp.Requirements_\n+\t}\n+\treturn nil\n+}\n+\n+func (exp *ExpandedTransform) BoundedOutputs() map[string]bool {\n+\tif exp.BoundedOutputs_ != nil {\n+\t\treturn exp.BoundedOutputs_\n+\t}\n+\treturn nil\n+}\n+\n+// ExternalTransform represents the cross-language transform in and out of the Pipeline as a MultiEdge and Expanded proto respectively\n+type ExternalTransform struct {\n+\tUrn           string\n+\tPayload       []byte\n+\tExpansionAddr string\n+\n+\t//replace all input/output fields with Inbound and Outbound id maps referencing the orginal Multiedge\n+\n+\tinputs      map[string]*Node\n+\tOutputs     map[string]*Node\n+\toutputTypes map[string]typex.FullType\n+\n+\tExpanded_ *ExpandedTransform\n+}\n+\n+func (ext ExternalTransform) WithNamedInputs(inputs map[string]*Node) ExternalTransform {\n+\tif ext.inputs != nil {\n+\t\tpanic(errors.Errorf(\"inputs already set as: \\n%v\", ext.inputs))\n+\t}\n+\text.inputs = inputs\n+\treturn ext\n+}\n+\n+func (ext ExternalTransform) WithNamedOutputs(outputTypes map[string]typex.FullType) ExternalTransform {", "originalCommit": "dd2f49c31efdf1e87c1ba35056a5c176dcf87e2d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "5ed60ad43b86d854390ce3745f5fe27cf03df051", "url": "https://github.com/apache/beam/commit/5ed60ad43b86d854390ce3745f5fe27cf03df051", "message": "fix(beam/sdks/go): adding todos and moving code to correct places", "committedDate": "2020-08-18T00:14:24Z", "type": "commit"}, {"oid": "69deedf50d98447b43e1f561c23aa56d7465c644", "url": "https://github.com/apache/beam/commit/69deedf50d98447b43e1f561c23aa56d7465c644", "message": "Delete output\n\nRemove accidental inclusion of a test output.", "committedDate": "2020-08-18T00:18:05Z", "type": "commit"}]}