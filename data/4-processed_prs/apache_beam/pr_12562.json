{"pr_number": 12562, "pr_title": "[BEAM-10200] Respect profile_memory option and add memory profiler to\u2026", "pr_createdAt": "2020-08-13T01:27:42Z", "pr_url": "https://github.com/apache/beam/pull/12562", "timeline": [{"oid": "7b426a3cd094c1cf891358e851e61e1a2411c95a", "url": "https://github.com/apache/beam/commit/7b426a3cd094c1cf891358e851e61e1a2411c95a", "message": "[BEAM-10200] Respect profile_memory option and add memory profiler to sdk worker", "committedDate": "2020-08-13T01:27:12Z", "type": "commit"}, {"oid": "c4feb867825307f236ce8da23d9486a0efa936c8", "url": "https://github.com/apache/beam/commit/c4feb867825307f236ce8da23d9486a0efa936c8", "message": "mypy fix", "committedDate": "2020-08-13T16:49:49Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTc1OTAzMA==", "url": "https://github.com/apache/beam/pull/12562#discussion_r491759030", "bodyText": "Let's log the import failure", "author": "angoenka", "createdAt": "2020-09-21T01:13:37Z", "path": "sdks/python/apache_beam/utils/profiler.py", "diffHunk": "@@ -44,59 +42,91 @@\n \n \n class Profile(object):\n-  \"\"\"cProfile wrapper context for saving and logging profiler results.\"\"\"\n+  \"\"\"cProfile and Heapy wrapper context for saving and logging profiler\n+  results.\"\"\"\n \n   SORTBY = 'cumulative'\n \n   def __init__(\n       self,\n-      profile_id,\n-      profile_location=None,\n-      log_results=False,\n-      file_copy_fn=None,\n-      time_prefix='%Y-%m-%d_%H_%M_%S-'):\n+      profile_id, # type: str\n+      profile_location=None, # type: Optional[str]\n+      log_results=False, # type: bool\n+      file_copy_fn=None, # type: Optional[Callable[[str, str], None]]\n+      time_prefix='%Y-%m-%d_%H_%M_%S-', # type: str\n+      enable_cpu_profiling=False, # type: bool\n+      enable_memory_profiling=False, # type: bool\n+  ):\n+    \"\"\"Creates a Profile object.\n+\n+    Args:\n+      profile_id: Unique id of the profiling session.\n+      profile_location: The file location where the profiling results will be\n+        stored.\n+      log_results: Log the result to console if true.\n+      file_copy_fn: Lambda function for copying files.\n+      time_prefix: Format of the timestamp prefix in profiling result files.\n+      enable_cpu_profiling: CPU profiler will be enabled during the profiling\n+        session.\n+      enable_memory_profiling: Memory profiler will be enabled during the\n+        profiling session, the profiler only records the newly allocated objects\n+        in this session.\n+    \"\"\"\n     self.stats = None\n     self.profile_id = str(profile_id)\n     self.profile_location = profile_location\n     self.log_results = log_results\n     self.file_copy_fn = file_copy_fn or self.default_file_copy_fn\n     self.time_prefix = time_prefix\n     self.profile_output = None\n+    self.enable_cpu_profiling = enable_cpu_profiling\n+    self.enable_memory_profiling = enable_memory_profiling\n \n   def __enter__(self):\n     _LOGGER.info('Start profiling: %s', self.profile_id)\n-    self.profile = cProfile.Profile()\n-    self.profile.enable()\n+    if self.enable_cpu_profiling:\n+      self.profile = cProfile.Profile()\n+      self.profile.enable()\n+    if self.enable_memory_profiling:\n+      try:\n+        from guppy import hpy\n+        self.hpy = hpy()\n+        self.hpy.setrelheap()\n+      except ImportError:", "originalCommit": "c4feb867825307f236ce8da23d9486a0efa936c8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "30fae7af2aebf6a3d55fd53a0a78e55fbd90c16d", "url": "https://github.com/apache/beam/commit/30fae7af2aebf6a3d55fd53a0a78e55fbd90c16d", "message": "Address comment", "committedDate": "2020-09-21T17:52:33Z", "type": "commit"}, {"oid": "b29fdccd4e3c44237311da1de5ca66eb79f80ec0", "url": "https://github.com/apache/beam/commit/b29fdccd4e3c44237311da1de5ca66eb79f80ec0", "message": "Add unit test", "committedDate": "2020-09-25T22:18:03Z", "type": "commit"}, {"oid": "b29fdccd4e3c44237311da1de5ca66eb79f80ec0", "url": "https://github.com/apache/beam/commit/b29fdccd4e3c44237311da1de5ca66eb79f80ec0", "message": "Add unit test", "committedDate": "2020-09-25T22:18:03Z", "type": "forcePushed"}]}