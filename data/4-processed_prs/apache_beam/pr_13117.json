{"pr_number": 13117, "pr_title": "[BEAM-11067] Update java license script to include source for GNU and Mozilla dependencies", "pr_createdAt": "2020-10-14T21:02:37Z", "pr_url": "https://github.com/apache/beam/pull/13117", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDk3OTIzMQ==", "url": "https://github.com/apache/beam/pull/13117#discussion_r504979231", "bodyText": "Do all source jars follow this pattern?", "author": "Hannah-Jiang", "createdAt": "2020-10-14T21:21:14Z", "path": "sdks/java/container/license_scripts/pull_licenses_java.py", "diffHunk": "@@ -101,13 +101,22 @@ def pull_from_url(file_name, url, dep, no_list):\n \n def pull_source_code(base_url, dir_name, dep):\n     # base_url example: https://repo1.maven.org/maven2/org/mortbay/jetty/jsp-2.1/6.1.14/\n-    soup = BeautifulSoup(urlopen(base_url).read(), \"html.parser\")\n+    try:\n+      soup = BeautifulSoup(urlopen(base_url).read(), \"html.parser\")\n+    except:\n+      logging.error('Error reading source base from {base_url}'.format(base_url=base_url))\n+      raise\n+    source_count = 0\n     for href in (a[\"href\"] for a in soup.select(\"a[href]\")):\n         if href.endswith(\n-                '.jar') and not 'javadoc' in href:  # download jar file only\n+                '.jar') and 'sources.jar' in href:  # download sources jar file only", "originalCommit": "e38d9df43ffe961c3ef8b31cce60db5e3a6d28d5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTY4MDk2MA==", "url": "https://github.com/apache/beam/pull/13117#discussion_r505680960", "bodyText": "Yes, and this is guarded by the check that at least one file is found matching.\nif source_count == 0:\n  raise RuntimeError('No source found at {base_url}'.format(base_url=base_url))", "author": "alanmyrvold", "createdAt": "2020-10-15T16:31:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDk3OTIzMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDk4MDk3OA==", "url": "https://github.com/apache/beam/pull/13117#discussion_r504980978", "bodyText": "How about changing the level to debug? If there are many packages need to pull source, there would be a lot of log printed out.", "author": "Hannah-Jiang", "createdAt": "2020-10-14T21:25:00Z", "path": "sdks/java/container/license_scripts/pull_licenses_java.py", "diffHunk": "@@ -101,13 +101,22 @@ def pull_from_url(file_name, url, dep, no_list):\n \n def pull_source_code(base_url, dir_name, dep):\n     # base_url example: https://repo1.maven.org/maven2/org/mortbay/jetty/jsp-2.1/6.1.14/\n-    soup = BeautifulSoup(urlopen(base_url).read(), \"html.parser\")\n+    try:\n+      soup = BeautifulSoup(urlopen(base_url).read(), \"html.parser\")\n+    except:\n+      logging.error('Error reading source base from {base_url}'.format(base_url=base_url))\n+      raise\n+    source_count = 0\n     for href in (a[\"href\"] for a in soup.select(\"a[href]\")):\n         if href.endswith(\n-                '.jar') and not 'javadoc' in href:  # download jar file only\n+                '.jar') and 'sources.jar' in href:  # download sources jar file only\n             file_name = dir_name + '/' + href\n             url = base_url + '/' + href\n+            logging.info('Pulling source from {url}'.format(url=url))", "originalCommit": "e38d9df43ffe961c3ef8b31cce60db5e3a6d28d5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTY4MDkxMw==", "url": "https://github.com/apache/beam/pull/13117#discussion_r505680913", "bodyText": "done", "author": "alanmyrvold", "createdAt": "2020-10-15T16:31:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDk4MDk3OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTA5MTk5Mw==", "url": "https://github.com/apache/beam/pull/13117#discussion_r505091993", "bodyText": "Do we only skip self-dependencies for non-auto-pulled libraries? Mostly this function seems very long and complicated to start with, and having the skipping returns at the top would make me feel a little better.", "author": "emilymye", "createdAt": "2020-10-15T00:15:16Z", "path": "sdks/java/container/license_scripts/pull_licenses_java.py", "diffHunk": "@@ -140,17 +149,22 @@ def execute(dep):\n     }\n     '''\n \n-    name = dep['moduleName'].split(':')[1].lower()\n+    name = dep['moduleName'].split(':')[1]\n     version = dep['moduleVersion']\n     name_version = name + '-' + version\n+    # javac is not a runtime dependency\n+    if name == 'javac':\n+      logging.debug('Skipping', name_version)\n+      return\n     dir_name = '{license_dir}/{name_version}.jar'.format(\n         license_dir=license_dir, name_version=name_version)\n \n     # if auto pulled, directory is existing at {license_dir}\n     if not os.path.isdir(dir_name):\n         # skip self dependencies\n         if dep['moduleName'].startswith('beam'):\n-            logging.debug('Skippig', name_version)\n+            logging.debug('Skipping', name_version)", "originalCommit": "e38d9df43ffe961c3ef8b31cce60db5e3a6d28d5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTY4MDg1OA==", "url": "https://github.com/apache/beam/pull/13117#discussion_r505680858", "bodyText": "Moved to the top.", "author": "alanmyrvold", "createdAt": "2020-10-15T16:31:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTA5MTk5Mw=="}], "type": "inlineReview"}, {"oid": "1db7b6e3282826fc047ecc9c2542cae65401ccb1", "url": "https://github.com/apache/beam/commit/1db7b6e3282826fc047ecc9c2542cae65401ccb1", "message": "[BEAM-11067] Update java license script to include source for GNU and Mozilla dependencies", "committedDate": "2020-10-15T16:35:56Z", "type": "forcePushed"}, {"oid": "d4255e07ecb843c1e4ecb7987ed81c95b480f00a", "url": "https://github.com/apache/beam/commit/d4255e07ecb843c1e4ecb7987ed81c95b480f00a", "message": "[BEAM-11067] Update java license script to include source for GNU and Mozilla dependencies", "committedDate": "2020-10-15T16:57:26Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTcwMzI5Mg==", "url": "https://github.com/apache/beam/pull/13117#discussion_r505703292", "bodyText": "If I compare to the original code, it should be dep['moduleName'] instead of name. If a beam package is 'beam:xxx' and the xxx does not has beam in it, it wouldn't skipped. And I also recommend applying lower() when checking if startswith 'beam'.", "author": "Hannah-Jiang", "createdAt": "2020-10-15T17:06:53Z", "path": "sdks/java/container/license_scripts/pull_licenses_java.py", "diffHunk": "@@ -140,17 +149,22 @@ def execute(dep):\n     }\n     '''\n \n-    name = dep['moduleName'].split(':')[1].lower()\n+    name = dep['moduleName'].split(':')[1]\n     version = dep['moduleVersion']\n     name_version = name + '-' + version\n+    # javac is not a runtime dependency\n+    if name == 'javac':\n+      logging.debug('Skipping', name_version)\n+      return\n+    # skip self dependencies\n+    if name.startswith('beam'):", "originalCommit": "d4255e07ecb843c1e4ecb7987ed81c95b480f00a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTcxMDU0Mw==", "url": "https://github.com/apache/beam/pull/13117#discussion_r505710543", "bodyText": "Good catch. Changed it to be:\nif dep['moduleName'].lower().startswith('beam'):", "author": "alanmyrvold", "createdAt": "2020-10-15T17:18:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTcwMzI5Mg=="}], "type": "inlineReview"}, {"oid": "098a36ac45f7b8d8b7cbca247f86cd272cb0e6f4", "url": "https://github.com/apache/beam/commit/098a36ac45f7b8d8b7cbca247f86cd272cb0e6f4", "message": "[BEAM-11067] Update java license script to include source for GNU and Mozilla dependencies", "committedDate": "2020-10-15T17:19:01Z", "type": "commit"}, {"oid": "098a36ac45f7b8d8b7cbca247f86cd272cb0e6f4", "url": "https://github.com/apache/beam/commit/098a36ac45f7b8d8b7cbca247f86cd272cb0e6f4", "message": "[BEAM-11067] Update java license script to include source for GNU and Mozilla dependencies", "committedDate": "2020-10-15T17:19:01Z", "type": "forcePushed"}]}