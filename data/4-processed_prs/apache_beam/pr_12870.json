{"pr_number": 12870, "pr_title": "[BEAM-2146] Continuously test Dataflow ValidatesRunner forcing streaming", "pr_createdAt": "2020-09-18T17:42:11Z", "pr_url": "https://github.com/apache/beam/pull/12870", "timeline": [{"oid": "a074f62a07d036fdca96a404c79fd8ef84889bf1", "url": "https://github.com/apache/beam/commit/a074f62a07d036fdca96a404c79fd8ef84889bf1", "message": "Add Jenkins job for ValidatesRunner against Dataflow forcing streaming mode", "committedDate": "2020-10-02T19:31:59Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTkyMjA0MA==", "url": "https://github.com/apache/beam/pull/12870#discussion_r499922040", "bodyText": "Why change the name to drop LegacyWorker? If the plan is to reuse this for other runner versions should the worker:legacy-worker:shadowJar dependency be injected somehow as well?", "author": "tysonjh", "createdAt": "2020-10-05T23:16:32Z", "path": "runners/google-cloud-dataflow-java/build.gradle", "diffHunk": "@@ -151,33 +161,34 @@ def commonExcludeCategories = [\n \n // For the following test tasks using legacy worker, set workerHarnessContainerImage to empty to\n // make Dataflow pick up the non-versioned container image, which handles a staged worker jar.\n-task validatesRunnerLegacyWorkerTest(type: Test) {\n-  group = \"Verification\"\n-  dependsOn \":runners:google-cloud-dataflow-java:worker:legacy-worker:shadowJar\"\n-\n-  systemProperty \"beamTestPipelineOptions\", JsonOutput.toJson([\n-          \"--runner=TestDataflowRunner\",\n-          \"--project=${dataflowProject}\",\n-          \"--region=${dataflowRegion}\",\n-          \"--tempRoot=${dataflowValidatesTempRoot}\",\n-          \"--dataflowWorkerJar=${dataflowLegacyWorkerJar}\",\n-          \"--workerHarnessContainerImage=\",\n-  ])\n-\n-  // Increase test parallelism up to the number of Gradle workers. By default this is equal\n-  // to the number of CPU cores, but can be increased by setting --max-workers=N.\n-  maxParallelForks Integer.MAX_VALUE\n-  classpath = configurations.validatesRunner\n-  testClassesDirs = files(project(\":sdks:java:core\").sourceSets.test.output.classesDirs) +\n-          files(project(project.path).sourceSets.test.output.classesDirs)\n-  useJUnit {\n-    includeCategories 'org.apache.beam.sdk.testing.ValidatesRunner'\n-    commonExcludeCategories.each {\n-      excludeCategories it\n+def createValidatesRunnerTest = { name, pipelineOptions=legacyPipelineOptions, disabledTests=[] ->", "originalCommit": "a074f62a07d036fdca96a404c79fd8ef84889bf1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ0MTkyMQ==", "url": "https://github.com/apache/beam/pull/12870#discussion_r500441921", "bodyText": "The actual task name is the same, and defined on line 238. Here I have just made a function for producing variants. The new variant is defined on line 244.", "author": "kennknowles", "createdAt": "2020-10-06T16:38:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTkyMjA0MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDUxMTc5NA==", "url": "https://github.com/apache/beam/pull/12870#discussion_r500511794", "bodyText": "I meant the name of this method specifically, not the tasks. This method has a dependsOn dependency with the legacy worker, so it will always be for the legacy worker and the naming change seems to make this less clear. Unless of course, in the future, this method could be used for new runners (e.g. runner v2)?\nI was considering if it would possible to pull out the dependsOn ...legacy-worker:shadowJar (by passing it in as a parameter, specifying the dependency in some other scope, or some other injection mechanism) and then reusing the createValidatesRunnerTest method for the runner v2 by passing in pipelineOptions + [\"--experiments=use_runner_v2\"].", "author": "tysonjh", "createdAt": "2020-10-06T18:31:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTkyMjA0MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTEzMjMyMQ==", "url": "https://github.com/apache/beam/pull/12870#discussion_r501132321", "bodyText": "Agree with your naming point, and pushed a rename.\nI believe that is possible to continue to configure with a block but Groovy's scope configuration blocks confuse the heck out of me so I did not try to do it. I expect you can do it either by passing the closure in to the createValidatesRunner function or by returning something that is ready to accept a block. I'm a bit hazy on how/when the latter works.", "author": "kennknowles", "createdAt": "2020-10-07T16:04:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTkyMjA0MA=="}], "type": "inlineReview"}, {"oid": "3a468cefe0db634f51b2702b667533c368218467", "url": "https://github.com/apache/beam/commit/3a468cefe0db634f51b2702b667533c368218467", "message": "Add gradle target for ValidatesRunner against Dataflow forcing streaming mode", "committedDate": "2020-10-09T16:33:39Z", "type": "commit"}, {"oid": "5140d7f387ea99b5324be35368a0e9c756207ad4", "url": "https://github.com/apache/beam/commit/5140d7f387ea99b5324be35368a0e9c756207ad4", "message": "Add Jenkins job for ValidatesRunner against Dataflow forcing streaming mode", "committedDate": "2020-10-09T16:33:39Z", "type": "commit"}, {"oid": "5140d7f387ea99b5324be35368a0e9c756207ad4", "url": "https://github.com/apache/beam/commit/5140d7f387ea99b5324be35368a0e9c756207ad4", "message": "Add Jenkins job for ValidatesRunner against Dataflow forcing streaming mode", "committedDate": "2020-10-09T16:33:39Z", "type": "forcePushed"}]}