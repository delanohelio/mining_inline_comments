{"pr_number": 13410, "pr_title": "[BEAM-11327] Replace Charset.defaultCharset() with StandardCharsets.UTF_8", "pr_createdAt": "2020-11-24T01:23:34Z", "pr_url": "https://github.com/apache/beam/pull/13410", "timeline": [{"oid": "32d15ec51dc8f881314b25a7402088f234987e89", "url": "https://github.com/apache/beam/commit/32d15ec51dc8f881314b25a7402088f234987e89", "message": "[BEAM-11327] Replace Charset.defaultCharset() with StandardCharsets.UTF_8", "committedDate": "2020-11-24T01:19:37Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTE1MzAxMQ==", "url": "https://github.com/apache/beam/pull/13410#discussion_r529153011", "bodyText": "@scwhittle I was wondering if you could comment on this since you added this line in #11096. Do you know if this change is safe? Is there a reason this needs to use defaultCharset?\nAs it is, testLogRawBytes below can fail if the system encoding isn't UTF-8", "author": "TheNeuralBit", "createdAt": "2020-11-24T02:26:54Z", "path": "runners/google-cloud-dataflow-java/worker/src/main/java/org/apache/beam/runners/dataflow/worker/logging/JulHandlerPrintStreamAdapterFactory.java", "diffHunk": "@@ -86,7 +86,7 @@ public void write(int i) throws IOException {\n       this.logger = Logger.getLogger(loggerName);\n       this.buffer = new StringBuilder();\n       this.decoder =\n-          Charset.defaultCharset()\n+          StandardCharsets.UTF_8", "originalCommit": "32d15ec51dc8f881314b25a7402088f234987e89", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTkwNTAzNw==", "url": "https://github.com/apache/beam/pull/13410#discussion_r529905037", "bodyText": "This class is going to be used to replace the default System.out/System.err which appears to be specified to use the default charset.\nSo it seems better to keep it consistent IMO to avoid surprises when someone expects that charset writing to System.out, not UTF-8.  If the test is incorrect, it should be fixed (by examining or setting the defaultCharset)", "author": "scwhittle", "createdAt": "2020-11-24T21:53:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTE1MzAxMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDAwODEwOQ==", "url": "https://github.com/apache/beam/pull/13410#discussion_r530008109", "bodyText": "OK thanks, I thought that may be the case\nHow about this - we can make this class (the private constructor and the create() method below) parameterized by Charset. The places where its used as the default System.out/System.err in the Dataflow worker can pass in Charset.defaultCharset(), but the test can pass in Charsets.UTF_8", "author": "TheNeuralBit", "createdAt": "2020-11-24T23:34:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTE1MzAxMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjIwMDM5Ng==", "url": "https://github.com/apache/beam/pull/13410#discussion_r536200396", "bodyText": "@scwhittle  does that work for you? I can make the change if so!", "author": "omarismail94", "createdAt": "2020-12-04T15:56:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTE1MzAxMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDQ3NzY4OA==", "url": "https://github.com/apache/beam/pull/13410#discussion_r540477688", "bodyText": "Let's go ahead and do that", "author": "TheNeuralBit", "createdAt": "2020-12-10T20:33:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTE1MzAxMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDc4Mjc3Nw==", "url": "https://github.com/apache/beam/pull/13410#discussion_r540782777", "bodyText": "Sorry lost track of that comment, I believe it's only uses are for System.out/System.err and the test. But allowing the test to specify a specific charset so it passes reliably sounds like a good solution.", "author": "scwhittle", "createdAt": "2020-12-11T08:46:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTE1MzAxMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTA4NTk4MQ==", "url": "https://github.com/apache/beam/pull/13410#discussion_r541085981", "bodyText": "OK, I will make the changes and re-commit. Thanks!", "author": "omarismail94", "createdAt": "2020-12-11T16:52:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTE1MzAxMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjE2OTM0MQ==", "url": "https://github.com/apache/beam/pull/13410#discussion_r552169341", "bodyText": "This hasn't been done yet has it?", "author": "TheNeuralBit", "createdAt": "2021-01-05T20:14:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTE1MzAxMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzY4Mjg0Mg==", "url": "https://github.com/apache/beam/pull/13410#discussion_r553682842", "bodyText": "How about this - we can make this class (the private constructor and the create() method below) parameterized by Charset.\n\nThe variables that are passed in do not use any of the Charset methods though right?\n\nThe places where its used as the default System.out/System.err in the Dataflow worker can pass in Charset.defaultCharset(), but the test can pass in Charsets.UTF_8\n\nThe test file has StandardCharsets.UTF_8 replacing Charset.defaultCharset().\nLet me know if I am missing something @TheNeuralBit !", "author": "omarismail94", "createdAt": "2021-01-08T01:07:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTE1MzAxMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzY5MjY4NQ==", "url": "https://github.com/apache/beam/pull/13410#discussion_r553692685", "bodyText": "What I was suggesting is that we should add a new argument to the private constructor and the static create() method: Charset charset. Then in the constructor we'll use charset instead of Charset.defaultCharset() to create encoder.\nCurrently the test is using StandardCharsets.UTF_8, but only to create the expected outputs. It also needs to create a JulHandlerPrintStreamAdapterFactory that uses UTF_8 explicitly, so we need a way to pass that through. I think as it is this test could still fail if the default charset isn't UTF-8", "author": "TheNeuralBit", "createdAt": "2021-01-08T01:42:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTE1MzAxMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzY5ODA2OA==", "url": "https://github.com/apache/beam/pull/13410#discussion_r553698068", "bodyText": "Oooh, OK! And because the constructor is private, it can only be accessed from create() method inside the class, meaning this is the only file I have to change \ud83e\udd2f\nIll give this a shot!", "author": "omarismail94", "createdAt": "2021-01-08T02:00:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTE1MzAxMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzY5OTU2Ng==", "url": "https://github.com/apache/beam/pull/13410#discussion_r553699566", "bodyText": "Well you'll also want to add an argument to create(), and update the places that call it, for example in the test: \n  \n    \n      beam/runners/google-cloud-dataflow-java/worker/src/test/java/org/apache/beam/runners/dataflow/worker/logging/JulHandlerPrintStreamAdapterFactoryTest.java\n    \n    \n         Line 168\n      in\n      df74d74\n    \n    \n    \n    \n\n        \n          \n           return JulHandlerPrintStreamAdapterFactory.create(handler, LOGGER_NAME, Level.INFO); \n        \n    \n  \n\n\nWould become return JulHandlerPrintStreamAdapterFactory.create(handler, LOGGER_NAME, Level.INFO, StandardCharsets.UTF_8);", "author": "TheNeuralBit", "createdAt": "2021-01-08T02:06:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTE1MzAxMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzcwMTI2MA==", "url": "https://github.com/apache/beam/pull/13410#discussion_r553701260", "bodyText": "Will do, thanks!", "author": "omarismail94", "createdAt": "2021-01-08T02:13:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTE1MzAxMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDAxNjczMA==", "url": "https://github.com/apache/beam/pull/13410#discussion_r554016730", "bodyText": "@TheNeuralBit  I had to create a new PR for this as this got merged:\nNew PR: #13701", "author": "omarismail94", "createdAt": "2021-01-08T15:38:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTE1MzAxMQ=="}], "type": "inlineReview"}, {"oid": "a14bd548bb647a87921f7ee87f72bfddeffbce33", "url": "https://github.com/apache/beam/commit/a14bd548bb647a87921f7ee87f72bfddeffbce33", "message": "[BEAM-11327] Replace Charset.defaultCharset() with StandardCharsets.UTF_8", "committedDate": "2021-01-03T00:35:49Z", "type": "commit"}, {"oid": "49bb55b80476ae4d0e7dc2442d4bc0e6e67309d0", "url": "https://github.com/apache/beam/commit/49bb55b80476ae4d0e7dc2442d4bc0e6e67309d0", "message": "[BEAM-11327] Replace Charset.defaultCharset() with StandardCharsets.UTF_8", "committedDate": "2021-01-03T00:37:36Z", "type": "commit"}, {"oid": "f19467a8007d6f5817c89cf175a66e07aa4bdd8d", "url": "https://github.com/apache/beam/commit/f19467a8007d6f5817c89cf175a66e07aa4bdd8d", "message": "[BEAM-11327] Replace Charset.defaultCharset() with StandardCharsets.UTF_8", "committedDate": "2021-01-03T00:40:55Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTE5ODQ1MA==", "url": "https://github.com/apache/beam/pull/13410#discussion_r551198450", "bodyText": "nit: ultra minor (you can ignore me but good if changed) s/ForbidCharset/ForbidDefaultCharset", "author": "iemejia", "createdAt": "2021-01-04T09:23:40Z", "path": "sdks/java/build-tools/src/main/resources/beam/checkstyle.xml", "diffHunk": "@@ -119,6 +119,14 @@ page at http://checkstyle.sourceforge.net/config.html -->\n       <property name=\"message\" value=\"You are using raw guava, please use vendored guava classes.\"/>\n     </module>\n \n+    <!-- Forbid use of Charset.defaultCharset()-->\n+    <module name=\"RegexpSinglelineJava\">\n+      <property name=\"id\" value=\"ForbidCharset\"/>", "originalCommit": "f19467a8007d6f5817c89cf175a66e07aa4bdd8d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTQ4MjAyNA==", "url": "https://github.com/apache/beam/pull/13410#discussion_r551482024", "bodyText": "Updated, thanks!", "author": "omarismail94", "createdAt": "2021-01-04T18:13:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTE5ODQ1MA=="}], "type": "inlineReview"}, {"oid": "4a7823fe84b32a25193c8b47373a2452e2b5fe2c", "url": "https://github.com/apache/beam/commit/4a7823fe84b32a25193c8b47373a2452e2b5fe2c", "message": "[BEAM-11327] Replace Charset.defaultCharset() with StandardCharsets.UTF_8", "committedDate": "2021-01-04T18:13:22Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjEwMTA2NA==", "url": "https://github.com/apache/beam/pull/13410#discussion_r552101064", "bodyText": "Shouldn't this be ForbidDefaultCharset?", "author": "TheNeuralBit", "createdAt": "2021-01-05T18:03:55Z", "path": "runners/google-cloud-dataflow-java/worker/src/main/java/org/apache/beam/runners/dataflow/worker/logging/JulHandlerPrintStreamAdapterFactory.java", "diffHunk": "@@ -69,6 +69,9 @@\n     private int carryOverBytes;\n     private byte[] carryOverByteArray;\n \n+    @SuppressWarnings({\n+      \"unchecked\" // [BEAM-11327] Replace Charset.defaultCharset() with StandardCharsets.UTF_8", "originalCommit": "4a7823fe84b32a25193c8b47373a2452e2b5fe2c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjEwODkyMQ==", "url": "https://github.com/apache/beam/pull/13410#discussion_r552108921", "bodyText": "Yes! Changed to Suppress ForbidDefaultCharset checkstyle", "author": "omarismail94", "createdAt": "2021-01-05T18:17:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjEwMTA2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjE2OTAwNw==", "url": "https://github.com/apache/beam/pull/13410#discussion_r552169007", "bodyText": "It's concerning that the precommit didn't break when this was suppressing the wrong warning. Have you seen the new checkstyle rule break checkstyleMain or checkstyleTest?\nI tried to get it to fail locally, but even with the SuppressWarnings removed its not triggering on Charset.defaultCharset", "author": "TheNeuralBit", "createdAt": "2021-01-05T20:13:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjEwMTA2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjM3NTAwOQ==", "url": "https://github.com/apache/beam/pull/13410#discussion_r552375009", "bodyText": "Aaaah, I finally found out what causes that. checkstyleMain.enabled is set to false in the build.gradle for the worker project. I set it to true, then removed the SuppressionWarning, and when I run checkstyleMain, I can see the rule gets triggered. I also didn't know you can set the ID used as the label in, SuppressionWarnings, so I fixed that as well!\nIf you want to test, I think if you set the flag to true in the build.gradle file, and comment out the SuppressionWarnings(\"ForbidDefaultCharset\"), then run the checkstyleMain, it should work", "author": "omarismail94", "createdAt": "2021-01-06T05:20:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjEwMTA2NA=="}], "type": "inlineReview"}, {"oid": "2c934920ab307174e9f6778b46a72634e9079a06", "url": "https://github.com/apache/beam/commit/2c934920ab307174e9f6778b46a72634e9079a06", "message": "[BEAM-11327] Replace Charset.defaultCharset() with StandardCharsets.UTF_8", "committedDate": "2021-01-05T18:16:05Z", "type": "commit"}, {"oid": "32aba3e6616e5cbcfe0434ac404492338094a09b", "url": "https://github.com/apache/beam/commit/32aba3e6616e5cbcfe0434ac404492338094a09b", "message": "[BEAM-11327] Replace Charset.defaultCharset() with StandardCharsets.UTF_8", "committedDate": "2021-01-06T05:18:01Z", "type": "commit"}, {"oid": "3e3ef68bfa050f12bf13734b028edad5ce1b3f87", "url": "https://github.com/apache/beam/commit/3e3ef68bfa050f12bf13734b028edad5ce1b3f87", "message": "[BEAM-11327] Replace Charset.defaultCharset() with StandardCharsets.UTF_8", "committedDate": "2021-01-06T05:22:06Z", "type": "commit"}]}