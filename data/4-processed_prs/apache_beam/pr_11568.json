{"pr_number": 11568, "pr_title": "[BEAM-8078] streaming_wordcount_debugging.py is missing a test", "pr_createdAt": "2020-04-29T13:03:26Z", "pr_url": "https://github.com/apache/beam/pull/11568", "timeline": [{"oid": "4452536581186363fc7739178c372a31ecc5d511", "url": "https://github.com/apache/beam/commit/4452536581186363fc7739178c372a31ecc5d511", "message": "Streaming_wordcount_debugging.py example update. Logging functionality fix, deprecated methods changed.", "committedDate": "2020-02-20T17:01:17Z", "type": "commit"}, {"oid": "7ff251fe26241924cf62e845419aa9bd53d74e5b", "url": "https://github.com/apache/beam/commit/7ff251fe26241924cf62e845419aa9bd53d74e5b", "message": "streaming_wordcount_debugging.py test added", "committedDate": "2020-02-20T17:19:56Z", "type": "commit"}, {"oid": "b9bde33aba8f58bf0b6cae2b91ae8ac53e7f6070", "url": "https://github.com/apache/beam/commit/b9bde33aba8f58bf0b6cae2b91ae8ac53e7f6070", "message": "Merge remote-tracking branch 'upstream/master'", "committedDate": "2020-02-27T20:04:22Z", "type": "commit"}, {"oid": "7f8f2e99b36f4edd4d146a78dbb27f38949aa4da", "url": "https://github.com/apache/beam/commit/7f8f2e99b36f4edd4d146a78dbb27f38949aa4da", "message": "Code review comments fixed", "committedDate": "2020-02-28T11:04:36Z", "type": "commit"}, {"oid": "8e62a8273f01d3da1828a2103068a98ea7f937a9", "url": "https://github.com/apache/beam/commit/8e62a8273f01d3da1828a2103068a98ea7f937a9", "message": "[BEAM-9373] Spark/Flink tests fix string concat", "committedDate": "2020-02-28T21:18:01Z", "type": "commit"}, {"oid": "66851e663f8282dd811e502604242d7c06cdcff2", "url": "https://github.com/apache/beam/commit/66851e663f8282dd811e502604242d7c06cdcff2", "message": "[BEAM-9300] convert struct literal in ZetaSQL", "committedDate": "2020-02-28T21:18:01Z", "type": "commit"}, {"oid": "f7047ed73e8a126b1f1c8d1e5aa8eb972dc06977", "url": "https://github.com/apache/beam/commit/f7047ed73e8a126b1f1c8d1e5aa8eb972dc06977", "message": "Linkage Checker 1.1.4", "committedDate": "2020-02-28T21:18:01Z", "type": "commit"}, {"oid": "c442701fd075f60213305a87f0afdb087d2a7647", "url": "https://github.com/apache/beam/commit/c442701fd075f60213305a87f0afdb087d2a7647", "message": "Bump Dataflow Java worker container version", "committedDate": "2020-02-28T21:18:01Z", "type": "commit"}, {"oid": "07b74a5cd2d2ac5738ae3f0ef52fafb5bb3ccb7c", "url": "https://github.com/apache/beam/commit/07b74a5cd2d2ac5738ae3f0ef52fafb5bb3ccb7c", "message": "Test schema does not need to be nullable.", "committedDate": "2020-02-28T21:18:01Z", "type": "commit"}, {"oid": "654356ead207d95798b25332acf1c008a2aa8f04", "url": "https://github.com/apache/beam/commit/654356ead207d95798b25332acf1c008a2aa8f04", "message": "[BEAM-9396] Match Docker image names in Jenkins jobs with those generated by Gradle tasks (#10985)", "committedDate": "2020-02-28T21:18:01Z", "type": "commit"}, {"oid": "cca4493056e4941c395eba322b0529a9cf21c7b4", "url": "https://github.com/apache/beam/commit/cca4493056e4941c395eba322b0529a9cf21c7b4", "message": "[BEAM-9392] Fix Multi TestStream assertion errors (#10982)", "committedDate": "2020-02-28T21:18:01Z", "type": "commit"}, {"oid": "7741da27263b37bfa88f41514dfa2f1c13489898", "url": "https://github.com/apache/beam/commit/7741da27263b37bfa88f41514dfa2f1c13489898", "message": "Lint check fixed", "committedDate": "2020-03-19T08:39:24Z", "type": "commit"}, {"oid": "ed155271a7111c8490ffc864489ce3b8588402dd", "url": "https://github.com/apache/beam/commit/ed155271a7111c8490ffc864489ce3b8588402dd", "message": "Merge remote-tracking branch 'upstream/master'", "committedDate": "2020-03-19T08:49:07Z", "type": "commit"}, {"oid": "e8f69b5802286e79571729cd0dc4f6e1941c73b7", "url": "https://github.com/apache/beam/commit/e8f69b5802286e79571729cd0dc4f6e1941c73b7", "message": "Update streaming_wordcount_debugging.py\n\nRename elem to timestamp for clarity.", "committedDate": "2020-03-21T01:52:12Z", "type": "commit"}, {"oid": "4381e750ee3d37058865b0e6ed397b93633871b1", "url": "https://github.com/apache/beam/commit/4381e750ee3d37058865b0e6ed397b93633871b1", "message": "Added save_main_session option as was hard-coded", "committedDate": "2020-03-23T18:11:16Z", "type": "commit"}, {"oid": "a1ade7308c85ee021f825470c70a6deb3db83607", "url": "https://github.com/apache/beam/commit/a1ade7308c85ee021f825470c70a6deb3db83607", "message": "Merge remote-tracking branch 'origin/master'", "committedDate": "2020-03-23T18:12:40Z", "type": "commit"}, {"oid": "fb8bc152b9babaa6d7d78fb4c2d1251c08e99c73", "url": "https://github.com/apache/beam/commit/fb8bc152b9babaa6d7d78fb4c2d1251c08e99c73", "message": "Merge remote-tracking branch 'upstream/master'", "committedDate": "2020-04-22T08:27:37Z", "type": "commit"}, {"oid": "3b9ae4421bbacbcc4df4161bd31d756b8ccfedaf", "url": "https://github.com/apache/beam/commit/3b9ae4421bbacbcc4df4161bd31d756b8ccfedaf", "message": "Merge remote-tracking branch 'upstream/master'\n\n# Conflicts:\n#\tsdks/python/apache_beam/examples/streaming_wordcount_debugging_it_test.py", "committedDate": "2020-04-22T08:37:08Z", "type": "commit"}, {"oid": "dbf0396447a301b04f31ba095631268713294a0d", "url": "https://github.com/apache/beam/commit/dbf0396447a301b04f31ba095631268713294a0d", "message": "Streaming_wordcount_debugging.py e2e test updated, unit-test added.", "committedDate": "2020-04-29T12:51:25Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzcwNTExNQ==", "url": "https://github.com/apache/beam/pull/11568#discussion_r417705115", "bodyText": "I believe you're missing a save_main_session=False here, otherwise it won't run successfully with the pytest-xdist plugin (pickle error). You can test it on your machine with tox -e py37-cloud.", "author": "udim", "createdAt": "2020-04-30T01:28:35Z", "path": "sdks/python/apache_beam/examples/streaming_wordcount_debugging_test.py", "diffHunk": "@@ -0,0 +1,109 @@\n+#\n+# Licensed to the Apache Software Foundation (ASF) under one or more\n+# contributor license agreements.  See the NOTICE file distributed with\n+# this work for additional information regarding copyright ownership.\n+# The ASF licenses this file to You under the Apache License, Version 2.0\n+# (the \"License\"); you may not use this file except in compliance with\n+# the License.  You may obtain a copy of the License at\n+#\n+#    http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+#\n+\n+\"\"\"Unit test for the streaming wordcount example with debug.\"\"\"\n+\n+# pytype: skip-file\n+\n+from __future__ import absolute_import\n+\n+import unittest\n+\n+import mock\n+\n+import apache_beam as beam\n+from apache_beam.examples import streaming_wordcount_debugging\n+from apache_beam.testing.test_stream import TestStream\n+from apache_beam.testing.util import assert_that\n+from apache_beam.testing.util import equal_to\n+\n+# Protect against environments where the PubSub library is not available.\n+# pylint: disable=wrong-import-order, wrong-import-position\n+try:\n+  from google.cloud import pubsub\n+except ImportError:\n+  pubsub = None\n+# pylint: enable=wrong-import-order, wrong-import-position\n+\n+\n+class StreamingWordcountDebugging(unittest.TestCase):\n+  @unittest.skipIf(pubsub is None, 'GCP dependencies are not installed')\n+  @mock.patch('apache_beam.io.ReadFromPubSub')\n+  @mock.patch('apache_beam.io.WriteToPubSub')\n+  def test_streaming_wordcount_debugging(self, *unused_mocks):\n+    def FakeReadFromPubSub(topic=None, subscription=None, values=None):\n+      expected_topic = topic\n+      expected_subscription = subscription\n+\n+      def _inner(topic=None, subscription=None):\n+        assert topic == expected_topic\n+        assert subscription == expected_subscription\n+        return TestStream().add_elements(values)\n+\n+      return _inner\n+\n+    class AssertTransform(beam.PTransform):\n+      def __init__(self, matcher):\n+        self.matcher = matcher\n+\n+      def expand(self, pcoll):\n+        assert_that(pcoll, self.matcher)\n+\n+    def FakeWriteToPubSub(topic=None, values=None):\n+      expected_topic = topic\n+\n+      def _inner(topic=None, subscription=None):\n+        assert topic == expected_topic\n+        return AssertTransform(equal_to(values))\n+\n+      return _inner\n+\n+    input_topic = 'projects/fake-beam-test-project/topic/intopic'\n+    input_values = [\n+        '150', '151', '152', '153', '154', '210', '211', '212', '213', '214'\n+    ]\n+    output_topic = 'projects/fake-beam-test-project/topic/outtopic'\n+    output_values = [\n+        '150: 1',\n+        '151: 1',\n+        '152: 1',\n+        '153: 1',\n+        '154: 1',\n+        '210: 1',\n+        '211: 1',\n+        '212: 1',\n+        '213: 1',\n+        '214: 1'\n+    ]\n+    beam.io.ReadFromPubSub = (\n+        FakeReadFromPubSub(\n+            topic=input_topic,\n+            values=list(x.encode('utf-8') for x in input_values)))\n+    beam.io.WriteToPubSub = (\n+        FakeWriteToPubSub(\n+            topic=output_topic,\n+            values=list(x.encode('utf-8') for x in output_values)))\n+    streaming_wordcount_debugging.run([", "originalCommit": "dbf0396447a301b04f31ba095631268713294a0d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzg4ODM3OQ==", "url": "https://github.com/apache/beam/pull/11568#discussion_r417888379", "bodyText": "Yes, I missed that param. Fixed.", "author": "Tesio", "createdAt": "2020-04-30T09:46:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzcwNTExNQ=="}], "type": "inlineReview"}, {"oid": "ffefebacc2c89ec78b05771fdac6b34850d83372", "url": "https://github.com/apache/beam/commit/ffefebacc2c89ec78b05771fdac6b34850d83372", "message": "Added save_main_session option", "committedDate": "2020-04-30T09:39:28Z", "type": "commit"}]}