{"pr_number": 10826, "pr_title": "[BEAM-8335] Modify the TestStreamPayload to accept an argument of output_tags and\u2026", "pr_createdAt": "2020-02-10T23:39:10Z", "pr_url": "https://github.com/apache/beam/pull/10826", "timeline": [{"oid": "571c49e734ce5a4ed686a8795ebce1e9c5a89947", "url": "https://github.com/apache/beam/commit/571c49e734ce5a4ed686a8795ebce1e9c5a89947", "message": "Modify the TestStreamPayload to accept an argument of output_tags and modify the TestStreamFileRecord to use TestStreamPayload events.\n\nChange-Id: I84ec1dd4698534c26c3a5219669da5f1a127250a", "committedDate": "2020-02-10T23:45:38Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzQwMjk1NA==", "url": "https://github.com/apache/beam/pull/10826#discussion_r377402954", "bodyText": "Don't think this is worth duplicating information already present on existing test stream events.", "author": "lukecwik", "createdAt": "2020-02-11T00:54:22Z", "path": "model/pipeline/src/main/proto/beam_runner_api.proto", "diffHunk": "@@ -525,6 +525,11 @@ message TestStreamPayload {\n   // used to retrieve events.\n   ApiServiceDescriptor endpoint = 3;\n \n+  // (Optional) The PCollection tags this TestStream will be outputting to. If\n+  // empty, this will assume it will be outputting to the single main\n+  // output PCollection.\n+  repeated string output_tags = 4;", "originalCommit": "571c49e734ce5a4ed686a8795ebce1e9c5a89947", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzgwMDU5Nw==", "url": "https://github.com/apache/beam/pull/10826#discussion_r377800597", "bodyText": "Without this field of \"output_tags\" it is impossible to recreate a TestStream from the TestStreamPayload without also giving the events.", "author": "rohdesamuel", "createdAt": "2020-02-11T17:56:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzQwMjk1NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODQ1NzU3Mw==", "url": "https://github.com/apache/beam/pull/10826#discussion_r378457573", "bodyText": "This information duplicates the \"output\" map keys on the PTransform that contains the TestStreamPayload.", "author": "lukecwik", "createdAt": "2020-02-12T19:14:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzQwMjk1NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTEyMzY3Mg==", "url": "https://github.com/apache/beam/pull/10826#discussion_r379123672", "bodyText": "Cool, got rid the of the output_tags.", "author": "rohdesamuel", "createdAt": "2020-02-13T21:18:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzQwMjk1NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzQwMzQ2Mw==", "url": "https://github.com/apache/beam/pull/10826#discussion_r377403463", "bodyText": "Can you provide more context as to why this is needed?\nIs this the pcollection id, or the output name or the ptransform id representing the test stream?", "author": "lukecwik", "createdAt": "2020-02-11T00:56:18Z", "path": "model/pipeline/src/main/proto/beam_runner_api.proto", "diffHunk": "@@ -576,7 +581,12 @@ service TestStreamService {\n   // A TestStream will request for events using this RPC.\n   rpc Events(EventsRequest) returns (stream TestStreamPayload.Event) {}\n }\n-message EventsRequest {}\n+\n+message EventsRequest {\n+  // The set of keys to read from. The keys are the specific PCollections to\n+  // read.\n+  repeated string keys = 1;", "originalCommit": "571c49e734ce5a4ed686a8795ebce1e9c5a89947", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzgwODIxNA==", "url": "https://github.com/apache/beam/pull/10826#discussion_r377808214", "bodyText": "Changed to comment to: The set of tags to read from. These tags are a subset of the TestStreamPayload's output_tags. This allows Interactive Beam to cache many PCollections from a pipeline then replay a subset of them.", "author": "rohdesamuel", "createdAt": "2020-02-11T18:11:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzQwMzQ2Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzQwMzkyNQ==", "url": "https://github.com/apache/beam/pull/10826#discussion_r377403925", "bodyText": "Why do the recorded events not have AdvanceProcessingTime events?", "author": "lukecwik", "createdAt": "2020-02-11T00:57:47Z", "path": "model/interactive/src/main/proto/beam_interactive_api.proto", "diffHunk": "@@ -40,18 +40,22 @@ import \"google/protobuf/timestamp.proto\";\n message TestStreamFileHeader {\n   // The PCollection tag this stream is associated with.\n   string tag = 1;\n+\n+  // The file format version. This is used to ensure backwards compatibility\n+  // when decoding from file.\n+  int32 version = 2;\n }\n \n // A record is a recorded element that a source produced. Its function is to\n // give enough information to create a faithful recreation of the original\n // stream of data.\n message TestStreamFileRecord {\n   oneof recorded_event {\n-    // The recorded element with its event timestamp (when it was produced).\n-    org.apache.beam.model.pipeline.v1.TestStreamPayload.TimestampedElement element = 1;\n+    // The recorded bundle with its event timestamp (when it was produced).\n+    org.apache.beam.model.pipeline.v1.TestStreamPayload.Event.AddElements element_event = 1;\n \n     // Indicating the output watermark of the source changed.\n-    google.protobuf.Timestamp watermark = 2;\n+    org.apache.beam.model.pipeline.v1.TestStreamPayload.Event.AdvanceWatermark watermark_event = 2;\n   }\n \n   // The wall-time timestamp of either the new element or watermark change.", "originalCommit": "571c49e734ce5a4ed686a8795ebce1e9c5a89947", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzgwOTA4Nw==", "url": "https://github.com/apache/beam/pull/10826#discussion_r377809087", "bodyText": "It's an optimization. This way if there are no elements or watermark events for a long time, we don't have to record every time the clock advanced forward.", "author": "rohdesamuel", "createdAt": "2020-02-11T18:13:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzQwMzkyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODQ1OTQ0MA==", "url": "https://github.com/apache/beam/pull/10826#discussion_r378459440", "bodyText": "You would still be able to do that \"compression\" yourself and only add a single AdvanceProcessingTime yet still have the flexibility to record multiple AdvanceProcessingTime events if they were ever necessary.", "author": "lukecwik", "createdAt": "2020-02-12T19:18:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzQwMzkyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTEyNTQwNQ==", "url": "https://github.com/apache/beam/pull/10826#discussion_r379125405", "bodyText": "Turned into a single proto with the TestStreamPayload.Event.", "author": "rohdesamuel", "createdAt": "2020-02-13T21:21:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzQwMzkyNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzQwNDA3Mg==", "url": "https://github.com/apache/beam/pull/10826#discussion_r377404072", "bodyText": "Shouldn't proto versioning handle this?", "author": "lukecwik", "createdAt": "2020-02-11T00:58:16Z", "path": "model/interactive/src/main/proto/beam_interactive_api.proto", "diffHunk": "@@ -40,18 +40,22 @@ import \"google/protobuf/timestamp.proto\";\n message TestStreamFileHeader {\n   // The PCollection tag this stream is associated with.\n   string tag = 1;\n+\n+  // The file format version. This is used to ensure backwards compatibility\n+  // when decoding from file.\n+  int32 version = 2;", "originalCommit": "571c49e734ce5a4ed686a8795ebce1e9c5a89947", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzgwOTE2Mg==", "url": "https://github.com/apache/beam/pull/10826#discussion_r377809162", "bodyText": "Ack, deleted.", "author": "rohdesamuel", "createdAt": "2020-02-11T18:13:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzQwNDA3Mg=="}], "type": "inlineReview"}, {"oid": "2b6c043477459a9fa267e02881feb42db4230d60", "url": "https://github.com/apache/beam/commit/2b6c043477459a9fa267e02881feb42db4230d60", "message": "Modify the TestStreamPayload to accept an argument of output_tags and modify the TestStreamFileRecord to use TestStreamPayload events.\n\nChange-Id: I84ec1dd4698534c26c3a5219669da5f1a127250a", "committedDate": "2020-02-11T18:14:26Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODQ2MDkyMw==", "url": "https://github.com/apache/beam/pull/10826#discussion_r378460923", "bodyText": "The usage of tag and tags is a poor name choice. I would suggest replacing them with output_id and output_ids and please update the comments to refer to the PTransform outputs local names.", "author": "lukecwik", "createdAt": "2020-02-12T19:20:55Z", "path": "model/pipeline/src/main/proto/beam_runner_api.proto", "diffHunk": "@@ -576,7 +581,13 @@ service TestStreamService {\n   // A TestStream will request for events using this RPC.\n   rpc Events(EventsRequest) returns (stream TestStreamPayload.Event) {}\n }\n-message EventsRequest {}\n+\n+message EventsRequest {\n+  // The set of tags to read from. These tags are a subset of the\n+  // TestStreamPayload's output_tags. This allows Interactive Beam to cache\n+  // many PCollections from a pipeline then replay a subset of them.\n+  repeated string tags = 1;", "originalCommit": "2b6c043477459a9fa267e02881feb42db4230d60", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTEyNzU5MA==", "url": "https://github.com/apache/beam/pull/10826#discussion_r379127590", "bodyText": "Updated to output_ids and modified the comment.", "author": "rohdesamuel", "createdAt": "2020-02-13T21:26:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODQ2MDkyMw=="}], "type": "inlineReview"}, {"oid": "6fee530e092b861544dc3c2bffd189b4e68983ef", "url": "https://github.com/apache/beam/commit/6fee530e092b861544dc3c2bffd189b4e68983ef", "message": "Modify the TestStreamFileRecord to use TestStreamPayload events.\n\nChange-Id: I84ec1dd4698534c26c3a5219669da5f1a127250a", "committedDate": "2020-02-13T21:15:59Z", "type": "commit"}, {"oid": "6fee530e092b861544dc3c2bffd189b4e68983ef", "url": "https://github.com/apache/beam/commit/6fee530e092b861544dc3c2bffd189b4e68983ef", "message": "Modify the TestStreamFileRecord to use TestStreamPayload events.\n\nChange-Id: I84ec1dd4698534c26c3a5219669da5f1a127250a", "committedDate": "2020-02-13T21:15:59Z", "type": "forcePushed"}]}