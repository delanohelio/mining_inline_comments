{"pr_number": 10919, "pr_title": "[BEAM-9347] Don't overwrite default runner harness for unified worker", "pr_createdAt": "2020-02-21T00:04:46Z", "pr_url": "https://github.com/apache/beam/pull/10919", "timeline": [{"oid": "7962fa6027083277db4b63c649f598938ea62272", "url": "https://github.com/apache/beam/commit/7962fa6027083277db4b63c649f598938ea62272", "message": "[BEAM-9347] Don't overwrite default runner harness for unified worker", "committedDate": "2020-02-21T00:38:46Z", "type": "commit"}, {"oid": "7962fa6027083277db4b63c649f598938ea62272", "url": "https://github.com/apache/beam/commit/7962fa6027083277db4b63c649f598938ea62272", "message": "[BEAM-9347] Don't overwrite default runner harness for unified worker", "committedDate": "2020-02-21T00:38:46Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg3NTEyMg==", "url": "https://github.com/apache/beam/pull/10919#discussion_r382875122", "bodyText": "PTAL at this method - we need to remove some of the statements in 922-928.", "author": "tvalentyn", "createdAt": "2020-02-22T01:50:28Z", "path": "sdks/python/apache_beam/runners/dataflow/internal/apiclient.py", "diffHunk": "@@ -916,6 +919,9 @@ def _use_unified_worker(pipeline_options):\n   debug_options = pipeline_options.view_as(DebugOptions)\n   use_unified_worker_flag = 'use_unified_worker'\n \n+  if debug_options.lookup_experiment(use_unified_worker_flag):", "originalCommit": "7962fa6027083277db4b63c649f598938ea62272", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg3NjE3OQ==", "url": "https://github.com/apache/beam/pull/10919#discussion_r382876179", "bodyText": "Do we need 922-924?", "author": "tvalentyn", "createdAt": "2020-02-22T02:01:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg3NTEyMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg3NjM0Ng==", "url": "https://github.com/apache/beam/pull/10919#discussion_r382876346", "bodyText": "nvm, reading this again, looks like this logic is intenional", "author": "tvalentyn", "createdAt": "2020-02-22T02:03:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg3NTEyMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg3NzYxNw==", "url": "https://github.com/apache/beam/pull/10919#discussion_r382877617", "bodyText": "Ok, I think I understand the intent but I think it is confusing - can we move lines 925-926 to dataflow_runner.py, see: \n  \n    \n      beam/sdks/python/apache_beam/runners/dataflow/dataflow_runner.py\n    \n    \n         Line 480\n      in\n      1117508\n    \n    \n    \n    \n\n        \n          \n           # Elevate \"min_cpu_platform\" to pipeline option, but using the existing \n        \n    \n  \n\n, and replace  920-928 with line 928?", "author": "tvalentyn", "createdAt": "2020-02-22T02:20:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg3NTEyMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzQ5MjYzNg==", "url": "https://github.com/apache/beam/pull/10919#discussion_r383492636", "bodyText": "We can move 925-926 to dataflow_runner.py but then i feel the logic to determine unified_worker usage will be more staggered.\nI think it will be better to keep the interpretation of use_unified_worker and use_runner_v2 at a single place.\nFor now, we support both flag but I think we will transition to use_runner_v2 over time (not sure by when).", "author": "angoenka", "createdAt": "2020-02-24T20:19:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg3NTEyMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzUxNjUyMg==", "url": "https://github.com/apache/beam/pull/10919#discussion_r383516522", "bodyText": "I think that it would be cleaner to not modify experiments in _use_unified_worker, since the name of this method does not suggest that it modifies the state, and it would also be easier to follow the logic. Also, if Dataflow runner relies on the fact that \"use_runner_v2\" experiment is set, it might be better to set it explicitly at some point, instead of relying on the fact that \"_use_unified_worker\" will be called. Leaving this up to you.", "author": "tvalentyn", "createdAt": "2020-02-24T21:11:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg3NTEyMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg3NTgzMg==", "url": "https://github.com/apache/beam/pull/10919#discussion_r382875832", "bodyText": "I think it will be easier to read if we restructure this:\nif (self.debug_options.lookup_experiment('runner_harness_container_image') or \n    _use_unified_worker(self.debug_options)):\n   # Comment on WHY we don't want to set the override\n   pass\nelse:\n   <...set the override...>\n\nWDYT?", "author": "tvalentyn", "createdAt": "2020-02-22T01:58:04Z", "path": "sdks/python/apache_beam/runners/dataflow/internal/apiclient.py", "diffHunk": "@@ -186,8 +186,11 @@ def __init__(self, packages, options, environment_version, pipeline_url):\n     if job_type.startswith('FNAPI_'):\n       self.debug_options = self.debug_options or DebugOptions()\n       self.debug_options.experiments = self.debug_options.experiments or []\n+      # Don't add the default image overwrite if user overwrites or", "originalCommit": "7962fa6027083277db4b63c649f598938ea62272", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg3NjAxNw==", "url": "https://github.com/apache/beam/pull/10919#discussion_r382876017", "bodyText": "Also, should we be passing pipeline_options instead of debug options? Perhaps it works either way but passing pipeline options would be cleaner since that's what the signature of _use_unified_worker() expects.", "author": "tvalentyn", "createdAt": "2020-02-22T02:00:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg3NTgzMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzQ5NjYzNw==", "url": "https://github.com/apache/beam/pull/10919#discussion_r383496637", "bodyText": "I think it will be easier to read if we restructure this:\nif (self.debug_options.lookup_experiment('runner_harness_container_image') or \n    _use_unified_worker(self.debug_options)):\n   # Comment on WHY we don't want to set the override\n   pass\nelse:\n   <...set the override...>\n\nWDYT?\n\nI think it makes sense. Will update it.\n\nAlso, should we be passing pipeline_options instead of debug options? Perhaps it works either way but passing pipeline options would be cleaner since that's what the signature of _use_unified_worker() expects.\n\nI think the code is structured in a way that a self.debug_options is referenced every where and the reference to it can be different from options passed in the method argument. So I think it will need a more thoughtful refactoring to move to change it to options in the right manner. Which I think we can differ.", "author": "angoenka", "createdAt": "2020-02-24T20:28:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg3NTgzMg=="}], "type": "inlineReview"}, {"oid": "8cd57753e2c179861562de24cd7ae4f02bfd8aca", "url": "https://github.com/apache/beam/commit/8cd57753e2c179861562de24cd7ae4f02bfd8aca", "message": "Addressing comments.", "committedDate": "2020-02-24T20:31:23Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzUxNjk1Mw==", "url": "https://github.com/apache/beam/pull/10919#discussion_r383516953", "bodyText": "Few thoughts here\n\nI think we cannot instantiate DebugOptions() in self.debug_options = self.debug_options or DebugOptions(). We should create a view of existing options.  All views of pipeline options should be views of the same underlying object, and I think that line can break this invariant if we follow the or branch. Do you know why we added it?\nFor the purpose of this PR it should be sufficient to pass options into _use_unified_worker() in line 190.", "author": "tvalentyn", "createdAt": "2020-02-24T21:12:28Z", "path": "sdks/python/apache_beam/runners/dataflow/internal/apiclient.py", "diffHunk": "@@ -186,8 +186,13 @@ def __init__(self, packages, options, environment_version, pipeline_url):\n     if job_type.startswith('FNAPI_'):\n       self.debug_options = self.debug_options or DebugOptions()\n       self.debug_options.experiments = self.debug_options.experiments or []\n-      if not self.debug_options.lookup_experiment(\n-          'runner_harness_container_image'):\n+      if self.debug_options.lookup_experiment(", "originalCommit": "8cd57753e2c179861562de24cd7ae4f02bfd8aca", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzUyMjYyOQ==", "url": "https://github.com/apache/beam/pull/10919#discussion_r383522629", "bodyText": "I agree. I think I added it because in certain case it was passed in test. I might be wrong though.\nMakes sense. I will update the PR with both these suggestions.", "author": "angoenka", "createdAt": "2020-02-24T21:23:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzUxNjk1Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzUxODc5MQ==", "url": "https://github.com/apache/beam/pull/10919#discussion_r383518791", "bodyText": "This comment repeats the logic; I thought you might want to explain why we don't want to pin the image for UW.\nConsider: \"In case of using UW, harness container should be defined by DF service unless explicitly overridden.\"", "author": "tvalentyn", "createdAt": "2020-02-24T21:16:13Z", "path": "sdks/python/apache_beam/runners/dataflow/internal/apiclient.py", "diffHunk": "@@ -186,8 +186,13 @@ def __init__(self, packages, options, environment_version, pipeline_url):\n     if job_type.startswith('FNAPI_'):\n       self.debug_options = self.debug_options or DebugOptions()\n       self.debug_options.experiments = self.debug_options.experiments or []\n-      if not self.debug_options.lookup_experiment(\n-          'runner_harness_container_image'):\n+      if self.debug_options.lookup_experiment(\n+          'runner_harness_container_image') or _use_unified_worker(\n+              self.debug_options):\n+        # Don't add the default image overwrite if user overwrites or", "originalCommit": "8cd57753e2c179861562de24cd7ae4f02bfd8aca", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzUyNTc4NA==", "url": "https://github.com/apache/beam/pull/10919#discussion_r383525784", "bodyText": "Updates the comment.", "author": "angoenka", "createdAt": "2020-02-24T21:30:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzUxODc5MQ=="}], "type": "inlineReview"}, {"oid": "aae13bdd1351b4dc80d91f36a42c996c03e05976", "url": "https://github.com/apache/beam/commit/aae13bdd1351b4dc80d91f36a42c996c03e05976", "message": "Addressing more comments.", "committedDate": "2020-02-24T21:33:02Z", "type": "commit"}]}