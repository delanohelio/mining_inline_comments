{"pr_number": 13431, "pr_title": "[BEAM-11354] Allow DoFn itself to be used as the restriction provider.", "pr_createdAt": "2020-11-25T23:57:42Z", "pr_url": "https://github.com/apache/beam/pull/13431", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjk5MjYwNg==", "url": "https://github.com/apache/beam/pull/13431#discussion_r532992606", "bodyText": "Can we add WatermarkEstimatorProvider for testing as well?", "author": "boyuanzz", "createdAt": "2020-12-01T00:27:38Z", "path": "sdks/python/apache_beam/runners/portability/fn_api_runner/fn_runner_test.py", "diffHunk": "@@ -510,6 +510,21 @@ def process(\n       actual = (p | beam.Create(data) | beam.ParDo(ExpandingStringsDoFn()))\n       assert_that(actual, equal_to(list(''.join(data))))\n \n+  def test_sdf_with_dofn_as_restriction_provider(self):", "originalCommit": "dd34d04df24733b3af421673b358a447d8969e0c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzAxNjQ4Nw==", "url": "https://github.com/apache/beam/pull/13431#discussion_r533016487", "bodyText": "Done.", "author": "robertwb", "createdAt": "2020-12-01T01:39:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjk5MjYwNg=="}], "type": "inlineReview"}, {"oid": "4e7414c1d8194b0c45b81e77bc7b963cb78fe455", "url": "https://github.com/apache/beam/commit/4e7414c1d8194b0c45b81e77bc7b963cb78fe455", "message": "[BEAM-11354] Allow DoFn itself to be used as the restriction provider.", "committedDate": "2020-12-01T00:28:38Z", "type": "commit"}, {"oid": "6555b3985ad67c3ce2d43b1eb61cb8987052a5af", "url": "https://github.com/apache/beam/commit/6555b3985ad67c3ce2d43b1eb61cb8987052a5af", "message": "[BEAM-11354] Also allow DoFn for WatermarkEstimator.", "committedDate": "2020-12-01T00:28:38Z", "type": "commit"}, {"oid": "218a922e5b18cd296e75ded13f6a2bb0bbde8f95", "url": "https://github.com/apache/beam/commit/218a922e5b18cd296e75ded13f6a2bb0bbde8f95", "message": "[BEAM-11354] Update docs.", "committedDate": "2020-12-01T00:28:38Z", "type": "commit"}, {"oid": "218a922e5b18cd296e75ded13f6a2bb0bbde8f95", "url": "https://github.com/apache/beam/commit/218a922e5b18cd296e75ded13f6a2bb0bbde8f95", "message": "[BEAM-11354] Update docs.", "committedDate": "2020-12-01T00:28:38Z", "type": "forcePushed"}, {"oid": "4e16a85c0e79e980abd67a33f00d334490dd1954", "url": "https://github.com/apache/beam/commit/4e16a85c0e79e980abd67a33f00d334490dd1954", "message": "Test for watermark tracker.", "committedDate": "2020-12-01T01:39:09Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzY3OTE4OA==", "url": "https://github.com/apache/beam/pull/13431#discussion_r533679188", "bodyText": "It might be less likely to happen but I'm curious what if the sdk author provides different RestrictionProvider from both ways, which one should be dominant. From implementation here, it seems like we will pick the param one.", "author": "boyuanzz", "createdAt": "2020-12-01T19:50:22Z", "path": "sdks/python/apache_beam/runners/common.py", "diffHunk": "@@ -218,10 +218,11 @@ def __init__(self, obj_to_invoke, method_name):\n       elif core.DoFn.KeyParam == v:\n         self.key_arg_name = kw\n       elif isinstance(v, core.DoFn.RestrictionParam):\n-        self.restriction_provider = v.restriction_provider\n+        self.restriction_provider = v.restriction_provider or obj_to_invoke", "originalCommit": "4e16a85c0e79e980abd67a33f00d334490dd1954", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzY4Mzk3NQ==", "url": "https://github.com/apache/beam/pull/13431#discussion_r533683975", "bodyText": "v.restriction_provider will be None iff None was passed to DoFn.RestrictionParam (or omitted, as None is the default value).", "author": "robertwb", "createdAt": "2020-12-01T19:58:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzY3OTE4OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzc1MTkyNg==", "url": "https://github.com/apache/beam/pull/13431#discussion_r533751926", "bodyText": "I understand. The case I'm wondering is like:\nclass MySDF(beam.DoFn, TypeARestrictionTracker):\n  def process(restriction_tracker=RestrictionParam(TypeBRestrictionTracker()))\nIn this case, the sdk will pick up TypeBRestrictionTracker implementation. Is it ideal? I thought we want to pick up TypeARestrictionTracker in this case or just say the DoFn is not valid.", "author": "boyuanzz", "createdAt": "2020-12-01T22:04:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzY3OTE4OA=="}], "type": "inlineReview"}, {"oid": "3231026cff5138a1d5f2fc7769e67365903269a8", "url": "https://github.com/apache/beam/commit/3231026cff5138a1d5f2fc7769e67365903269a8", "message": "Add a note to the programming guide.", "committedDate": "2020-12-01T20:05:06Z", "type": "commit"}, {"oid": "67e8649ac409f2943878999fb4c5a07154e654e0", "url": "https://github.com/apache/beam/commit/67e8649ac409f2943878999fb4c5a07154e654e0", "message": "Skip tests unimplemented for multiple workers.", "committedDate": "2020-12-01T20:08:49Z", "type": "commit"}]}