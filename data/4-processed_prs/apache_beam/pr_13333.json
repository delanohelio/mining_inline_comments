{"pr_number": 13333, "pr_title": "Further dataframe batch consolidation.", "pr_createdAt": "2020-11-13T18:23:57Z", "pr_url": "https://github.com/apache/beam/pull/13333", "timeline": [{"oid": "a7ea758f2cbcb01a17e5db01ad5d7a6210331eab", "url": "https://github.com/apache/beam/commit/a7ea758f2cbcb01a17e5db01ad5d7a6210331eab", "message": "Further dataframe batch consolidation.\n\n* Concatinate small dataframe before shuffle.\n* Omit shuffling of empty partitions.\n    - This requires some adjustment to use the proxy object\n      if *all* partitions from all workers are empty.\n\nProjections, filterings, and aggregations are common operations\nthat often greatly reduce the size of a dataframe, and can result\nin small output batches which have high relative overhead.", "committedDate": "2020-11-13T18:21:12Z", "type": "commit"}, {"oid": "9ef95b5ede1e5a66de21b84c4f8e4d3b525379ee", "url": "https://github.com/apache/beam/commit/9ef95b5ede1e5a66de21b84c4f8e4d3b525379ee", "message": "Add another test.\n\nAlso use iloc in place of bare index to fix non-int indices.", "committedDate": "2020-11-13T18:21:21Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDQ5NjQzOA==", "url": "https://github.com/apache/beam/pull/13333#discussion_r524496438", "bodyText": "nit: maybe add a comment like this to clarify the intention\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        return expr.proxy(\n          \n          \n            \n                        ).iloc[:0] if partition[expr._id] is None else partition[expr._id]\n          \n          \n            \n                        # Use proxy if there's no data in this partition\n          \n          \n            \n                        return expr.proxy(\n          \n          \n            \n                        ).iloc[:0] if partition[expr._id] is None else partition[expr._id]", "author": "TheNeuralBit", "createdAt": "2020-11-16T18:49:39Z", "path": "sdks/python/apache_beam/dataframe/transforms.py", "diffHunk": "@@ -223,8 +235,12 @@ def expand(self, pcolls):\n \n         # Actually evaluate the expressions.\n         def evaluate(partition, stage=self.stage, **side_inputs):\n+          def lookup(expr):\n+            return expr.proxy(\n+            ).iloc[:0] if partition[expr._id] is None else partition[expr._id]", "originalCommit": "9ef95b5ede1e5a66de21b84c4f8e4d3b525379ee", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDUwMzMxNQ==", "url": "https://github.com/apache/beam/pull/13333#discussion_r524503315", "bodyText": "This is frustratingly similar to _ReBatch... but I don't see a reasonable way to combine them.", "author": "TheNeuralBit", "createdAt": "2020-11-16T19:01:09Z", "path": "sdks/python/apache_beam/dataframe/transforms.py", "diffHunk": "@@ -410,6 +426,35 @@ def _total_memory_usage(frame):\n     float('inf')\n \n \n+class _PreBatch(beam.DoFn):\n+  def __init__(self, target_size=TARGET_PARTITION_SIZE):\n+    self._target_size = target_size\n+\n+  def start_bundle(self):\n+    self._parts = collections.defaultdict(list)\n+    self._running_size = 0\n+\n+  def process(\n+      self,\n+      part,\n+      window=beam.DoFn.WindowParam,\n+      timestamp=beam.DoFn.TimestampParam):\n+    part_size = _total_memory_usage(part)\n+    if part_size >= self._target_size:\n+      yield part\n+    else:\n+      self._running_size += part_size\n+      self._parts[window, timestamp].append(part)\n+      if self._running_size >= self._target_size:\n+        yield from self.finish_bundle()\n+\n+  def finish_bundle(self):\n+    for (window, timestamp), parts in self._parts.items():\n+      yield windowed_value.WindowedValue(\n+          pd.concat(parts), timestamp, (window, ))\n+    self.start_bundle()", "originalCommit": "9ef95b5ede1e5a66de21b84c4f8e4d3b525379ee", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDUwODQ5Nw==", "url": "https://github.com/apache/beam/pull/13333#discussion_r524508497", "bodyText": "Yeah, I was thinking exactly the same...", "author": "robertwb", "createdAt": "2020-11-16T19:10:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDUwMzMxNQ=="}], "type": "inlineReview"}, {"oid": "6300c332b32c0de4940532f865c13ef74b66cca6", "url": "https://github.com/apache/beam/commit/6300c332b32c0de4940532f865c13ef74b66cca6", "message": "Update sdks/python/apache_beam/dataframe/transforms.py\n\nCo-authored-by: Brian Hulette <hulettbh@gmail.com>", "committedDate": "2020-11-16T19:08:13Z", "type": "commit"}]}