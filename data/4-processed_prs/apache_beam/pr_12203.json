{"pr_number": 12203, "pr_title": "[BEAM-6928] Make Python SDK custom Sink the default Sink for BigQuery", "pr_createdAt": "2020-07-09T00:13:23Z", "pr_url": "https://github.com/apache/beam/pull/12203", "timeline": [{"oid": "08045ebbc136b2a1c1c8ae1354a41d4267000348", "url": "https://github.com/apache/beam/commit/08045ebbc136b2a1c1c8ae1354a41d4267000348", "message": "Making Beam sink the default sink for BigQuery", "committedDate": "2020-07-09T00:09:37Z", "type": "commit"}, {"oid": "af449954bb8f1ceac1df0e5e57e50bdefa6e2ee5", "url": "https://github.com/apache/beam/commit/af449954bb8f1ceac1df0e5e57e50bdefa6e2ee5", "message": "Sharing the Beam sink update in CHANGES.md", "committedDate": "2020-07-09T00:12:43Z", "type": "commit"}, {"oid": "957cdde34fee7cffb41ec471132a2a1c99695560", "url": "https://github.com/apache/beam/commit/957cdde34fee7cffb41ec471132a2a1c99695560", "message": "Fixing precommit", "committedDate": "2020-07-09T21:03:14Z", "type": "commit"}, {"oid": "585241da6d61ba27b6d57a5fbf90b6b4e93b87a1", "url": "https://github.com/apache/beam/commit/585241da6d61ba27b6d57a5fbf90b6b4e93b87a1", "message": "Fix formatter", "committedDate": "2020-07-09T21:44:36Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTcwMzI2OQ==", "url": "https://github.com/apache/beam/pull/12203#discussion_r459703269", "bodyText": "Did you mean BigQuerySink ?", "author": "chamikaramj", "createdAt": "2020-07-23T20:17:21Z", "path": "CHANGES.md", "diffHunk": "@@ -55,6 +55,9 @@\n \n * New overloads for BigtableIO.Read.withKeyRange() and BigtableIO.Read.withRowFilter()\n   methods that take ValueProvider as a parameter (Java) ([BEAM-10283](https://issues.apache.org/jira/browse/BEAM-10283)).\n+* The WriteToBigQuery transform (Python) in Dataflow Batch no longer relies on BigQuerySource by default. It relies on ", "originalCommit": "585241da6d61ba27b6d57a5fbf90b6b4e93b87a1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDIwNzgxOA==", "url": "https://github.com/apache/beam/pull/12203#discussion_r460207818", "bodyText": "Ah yes, done.", "author": "pabloem", "createdAt": "2020-07-24T18:02:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTcwMzI2OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTcwNDE1OA==", "url": "https://github.com/apache/beam/pull/12203#discussion_r459704158", "bodyText": "Can we just change this sink to use the new sink ?", "author": "chamikaramj", "createdAt": "2020-07-23T20:19:03Z", "path": "sdks/python/apache_beam/io/gcp/big_query_query_to_table_it_test.py", "diffHunk": "@@ -227,6 +225,7 @@ def test_big_query_standard_sql_kms_key_native(self):\n         'on_success_matcher': all_of(*pipeline_verifiers),\n         'kms_key': kms_key,\n         'native': True,\n+        'experiments': 'use_dataflow_bq_sink',", "originalCommit": "585241da6d61ba27b6d57a5fbf90b6b4e93b87a1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDIwNzgzOQ==", "url": "https://github.com/apache/beam/pull/12203#discussion_r460207839", "bodyText": "I'm trying to preserve the same test coverage after the change, and remove BQSink tests later on. Would htis be fine?", "author": "pabloem", "createdAt": "2020-07-24T18:02:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTcwNDE1OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTk2ODgwNA==", "url": "https://github.com/apache/beam/pull/12203#discussion_r461968804", "bodyText": "I think we should either change tests to use the default sink (which will be used by most of the users going forward) or run tests for both.", "author": "chamikaramj", "createdAt": "2020-07-29T00:27:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTcwNDE1OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTcwNDIzOQ==", "url": "https://github.com/apache/beam/pull/12203#discussion_r459704239", "bodyText": "Ditto.", "author": "chamikaramj", "createdAt": "2020-07-23T20:19:15Z", "path": "sdks/python/apache_beam/io/gcp/big_query_query_to_table_it_test.py", "diffHunk": "@@ -305,7 +303,8 @@ def test_big_query_new_types_native(self):\n         'use_standard_sql': False,\n         'native': True,\n         'wait_until_finish_duration': WAIT_UNTIL_FINISH_DURATION_MS,\n-        'on_success_matcher': all_of(*pipeline_verifiers)\n+        'on_success_matcher': all_of(*pipeline_verifiers),\n+        'experiments': 'use_dataflow_bq_sink',", "originalCommit": "585241da6d61ba27b6d57a5fbf90b6b4e93b87a1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDIwNzg5Mw==", "url": "https://github.com/apache/beam/pull/12203#discussion_r460207893", "bodyText": "I'm trying to preserve the same test coverage after the change, and remove BQSink tests later on. Would htis be fine?", "author": "pabloem", "createdAt": "2020-07-24T18:03:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTcwNDIzOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTcwNDYwNg==", "url": "https://github.com/apache/beam/pull/12203#discussion_r459704606", "bodyText": "May be call this \"use_legacy_bq_sink\" ?", "author": "chamikaramj", "createdAt": "2020-07-23T20:19:56Z", "path": "CHANGES.md", "diffHunk": "@@ -55,6 +55,9 @@\n \n * New overloads for BigtableIO.Read.withKeyRange() and BigtableIO.Read.withRowFilter()\n   methods that take ValueProvider as a parameter (Java) ([BEAM-10283](https://issues.apache.org/jira/browse/BEAM-10283)).\n+* The WriteToBigQuery transform (Python) in Dataflow Batch no longer relies on BigQuerySource by default. It relies on \n+  a new, fully-featured transform based on file loads into BigQuery. To revert the behavior to the old implementation,\n+  you may use `--experiments=use_dataflow_bq_sink`.", "originalCommit": "585241da6d61ba27b6d57a5fbf90b6b4e93b87a1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDIwNzk1NQ==", "url": "https://github.com/apache/beam/pull/12203#discussion_r460207955", "bodyText": "Done everywhere. Thanks!", "author": "pabloem", "createdAt": "2020-07-24T18:03:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTcwNDYwNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTcwNTU2NA==", "url": "https://github.com/apache/beam/pull/12203#discussion_r459705564", "bodyText": "Why not run this using the new sink ?", "author": "chamikaramj", "createdAt": "2020-07-23T20:21:37Z", "path": "sdks/python/apache_beam/runners/dataflow/dataflow_runner_test.py", "diffHunk": "@@ -698,6 +698,7 @@ def test_gbk_translation(self):\n   def test_write_bigquery_translation(self):\n     runner = DataflowRunner()\n \n+    self.default_properties.append('--experiments=use_dataflow_bq_sink')", "originalCommit": "585241da6d61ba27b6d57a5fbf90b6b4e93b87a1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDIwODI0MA==", "url": "https://github.com/apache/beam/pull/12203#discussion_r460208240", "bodyText": "this test checks that the transform is replaced appropriately.", "author": "pabloem", "createdAt": "2020-07-24T18:03:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTcwNTU2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDIwOTA3Mw==", "url": "https://github.com/apache/beam/pull/12203#discussion_r460209073", "bodyText": "so we verify that the Native sink is being replaced appropriately", "author": "pabloem", "createdAt": "2020-07-24T18:05:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTcwNTU2NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTcwNTc2Nw==", "url": "https://github.com/apache/beam/pull/12203#discussion_r459705767", "bodyText": "Ditto.", "author": "chamikaramj", "createdAt": "2020-07-23T20:21:57Z", "path": "sdks/python/apache_beam/runners/dataflow/dataflow_runner_test.py", "diffHunk": "@@ -749,12 +750,13 @@ def test_write_bigquery_failed_translation(self):\n     \"\"\"Tests that WriteToBigQuery cannot have any consumers if replaced.\"\"\"\n     runner = DataflowRunner()\n \n-    with self.assertRaises(ValueError):\n+    self.default_properties.append('--experiments=use_dataflow_bq_sink')", "originalCommit": "585241da6d61ba27b6d57a5fbf90b6b4e93b87a1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDIwOTI4MA==", "url": "https://github.com/apache/beam/pull/12203#discussion_r460209280", "bodyText": "same as above", "author": "pabloem", "createdAt": "2020-07-24T18:06:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTcwNTc2Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTcwNjgzNA==", "url": "https://github.com/apache/beam/pull/12203#discussion_r459706834", "bodyText": "Can we use the experiment here ? You can get hold of the PipelineOptions through input.", "author": "chamikaramj", "createdAt": "2020-07-23T20:24:14Z", "path": "sdks/python/apache_beam/runners/dataflow/ptransform_overrides.py", "diffHunk": "@@ -236,7 +236,10 @@ def enter_composite_transform(self, transform_node):\n         self.visit_transform(transform_node)\n \n       def visit_transform(self, transform_node):\n-        if [o for o in self.outputs if o in transform_node.inputs]:\n+        # Internal consumers of the outputs we're overriding are expected.\n+        # We only error out on non-internal consumers.\n+        if ('BigQueryBatchFileLoads' not in transform_node.full_label and", "originalCommit": "585241da6d61ba27b6d57a5fbf90b6b4e93b87a1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDIyNjcxOA==", "url": "https://github.com/apache/beam/pull/12203#discussion_r460226718", "bodyText": "What would we use the experiment for? In this case, the experiment is absent, so we would not need it.", "author": "pabloem", "createdAt": "2020-07-24T18:43:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTcwNjgzNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTcwNzQ1Ng==", "url": "https://github.com/apache/beam/pull/12203#discussion_r459707456", "bodyText": "Why did we have to add this explicit fail ? I don't think we add such visitors for other transforms that do not produce output. Usually succeeding transform just ends up being an no-op.", "author": "chamikaramj", "createdAt": "2020-07-23T20:25:22Z", "path": "sdks/python/apache_beam/runners/dataflow/ptransform_overrides.py", "diffHunk": "@@ -236,7 +236,10 @@ def enter_composite_transform(self, transform_node):\n         self.visit_transform(transform_node)\n \n       def visit_transform(self, transform_node):\n-        if [o for o in self.outputs if o in transform_node.inputs]:\n+        # Internal consumers of the outputs we're overriding are expected.", "originalCommit": "585241da6d61ba27b6d57a5fbf90b6b4e93b87a1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDIxODk5OQ==", "url": "https://github.com/apache/beam/pull/12203#discussion_r460218999", "bodyText": "This is because BQ FIle loads returns a series of pcollections (e.g. files written, jobs started) - and if the downstream transforms depend on these outputs, they will not work properly when replacing WriteToBQ with BQSink, so we error out.", "author": "pabloem", "createdAt": "2020-07-24T18:26:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTcwNzQ1Ng=="}], "type": "inlineReview"}, {"oid": "f5758f44332e3eb0bd747ad62be7a90bbb777c87", "url": "https://github.com/apache/beam/commit/f5758f44332e3eb0bd747ad62be7a90bbb777c87", "message": "addressing comments", "committedDate": "2020-07-24T18:43:48Z", "type": "commit"}, {"oid": "d09d0de384bde212354e8c9756a231c3b9c4b063", "url": "https://github.com/apache/beam/commit/d09d0de384bde212354e8c9756a231c3b9c4b063", "message": "Merge branch 'master' into bq-main-sink", "committedDate": "2020-08-04T18:28:58Z", "type": "commit"}]}