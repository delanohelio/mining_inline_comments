{"pr_number": 10689, "pr_title": "[BEAM-6703] Make Dataflow ValidatesRunner test use Java 11 in test execution", "pr_createdAt": "2020-01-27T07:38:37Z", "pr_url": "https://github.com/apache/beam/pull/10689", "timeline": [{"oid": "fe87ee7d377477ddcb0863ccc0be482dbfe476bb", "url": "https://github.com/apache/beam/commit/fe87ee7d377477ddcb0863ccc0be482dbfe476bb", "message": "[BEAM-6703] Make Dataflow ValidatesRunner test use Java 11 in test execution", "committedDate": "2020-01-24T14:48:31Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjAwNDM4MQ==", "url": "https://github.com/apache/beam/pull/10689#discussion_r372004381", "bodyText": "I suggest use trigger phrase\n\"Run beam_PostCommit_Java_ValidatesRunner_Dataflow_Java11\"\nit is same in terms of being descriptive, but much easier to figure out.\nOr \"Run Google Cloud Dataflow Runner ValidatesRunner Tests On Java 11\".", "author": "Ardagan", "createdAt": "2020-01-28T19:18:16Z", "path": ".test-infra/jenkins/job_PostCommit_Java_ValidatesRunner_Dataflow_Java11.groovy", "diffHunk": "@@ -20,26 +20,40 @@ import CommonJobProperties as commonJobProperties\n import PostcommitJobBuilder\n \n \n-PostcommitJobBuilder.postCommitJob('beam_PostCommit_Java11_ValidatesRunner_Dataflow',\n+PostcommitJobBuilder.postCommitJob('beam_PostCommit_Java_ValidatesRunner_Dataflow_Java11',\n   'Run Dataflow ValidatesRunner Java 11', 'Google Cloud Dataflow Runner ValidatesRunner Tests On Java 11', this) {", "originalCommit": "fe87ee7d377477ddcb0863ccc0be482dbfe476bb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjQyNjA4Mg==", "url": "https://github.com/apache/beam/pull/10689#discussion_r372426082", "bodyText": "I recently changed other ValidatesRunner trigger phrases to be similar to this one, wouldn't it be better to be consistent here?", "author": "mwalenia", "createdAt": "2020-01-29T14:49:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjAwNDM4MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjY4MzI3MA==", "url": "https://github.com/apache/beam/pull/10689#discussion_r372683270", "bodyText": "Can we preferably use a Jenkins environment variable for the Java home locations here and in the direct runner Java 11 case?", "author": "lukecwik", "createdAt": "2020-01-29T23:14:40Z", "path": ".test-infra/jenkins/job_PostCommit_Java_ValidatesRunner_Dataflow_Java11.groovy", "diffHunk": "@@ -20,26 +20,40 @@ import CommonJobProperties as commonJobProperties\n import PostcommitJobBuilder\n \n \n-PostcommitJobBuilder.postCommitJob('beam_PostCommit_Java11_ValidatesRunner_Dataflow',\n+PostcommitJobBuilder.postCommitJob('beam_PostCommit_Java_ValidatesRunner_Dataflow_Java11',\n   'Run Dataflow ValidatesRunner Java 11', 'Google Cloud Dataflow Runner ValidatesRunner Tests On Java 11', this) {\n \n   description('Runs the ValidatesRunner suite on the Dataflow runner with Java 11 worker harness.')\n \n-  commonJobProperties.setTopLevelMainJobProperties(delegate, 'master', 270)\n+  def JAVA_11_HOME = '/usr/lib/jvm/java-11-openjdk-amd64'", "originalCommit": "fe87ee7d377477ddcb0863ccc0be482dbfe476bb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mjc4NzQzOA==", "url": "https://github.com/apache/beam/pull/10689#discussion_r372787438", "bodyText": "I'm not sure if such variables exist, but I agree it would be better to use those instead of the paths. Maybe after Jenkins for Beam is up and running we'll be able to add the envs", "author": "mwalenia", "createdAt": "2020-01-30T07:09:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjY4MzI3MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjY4MzM0Mw==", "url": "https://github.com/apache/beam/pull/10689#discussion_r372683343", "bodyText": "Any reason why we aren't using the paths specified in https://cwiki.apache.org/confluence/display/INFRA/JDK+Installation+Matrix?\nIf we aren't using an ASF jenkins machine VM image as our base then that is fine but can we define the constants somewhere and share them across the relevant locations?", "author": "lukecwik", "createdAt": "2020-01-29T23:14:55Z", "path": ".test-infra/jenkins/job_PostCommit_Java_ValidatesRunner_Dataflow_Java11.groovy", "diffHunk": "@@ -20,26 +20,40 @@ import CommonJobProperties as commonJobProperties\n import PostcommitJobBuilder\n \n \n-PostcommitJobBuilder.postCommitJob('beam_PostCommit_Java11_ValidatesRunner_Dataflow',\n+PostcommitJobBuilder.postCommitJob('beam_PostCommit_Java_ValidatesRunner_Dataflow_Java11',\n   'Run Dataflow ValidatesRunner Java 11', 'Google Cloud Dataflow Runner ValidatesRunner Tests On Java 11', this) {\n \n   description('Runs the ValidatesRunner suite on the Dataflow runner with Java 11 worker harness.')\n \n-  commonJobProperties.setTopLevelMainJobProperties(delegate, 'master', 270)\n+  def JAVA_11_HOME = '/usr/lib/jvm/java-11-openjdk-amd64'\n+  def JAVA_8_HOME = '/usr/lib/jvm/java-8-openjdk-amd64'", "originalCommit": "fe87ee7d377477ddcb0863ccc0be482dbfe476bb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjY4NDA3OQ==", "url": "https://github.com/apache/beam/pull/10689#discussion_r372684079", "bodyText": "Why do we have a validatesJava11Runner task? (Shouldn't we just invoke the validatesRunner task?)", "author": "lukecwik", "createdAt": "2020-01-29T23:17:21Z", "path": ".test-infra/jenkins/job_PostCommit_Java_ValidatesRunner_Dataflow_Java11.groovy", "diffHunk": "@@ -20,26 +20,40 @@ import CommonJobProperties as commonJobProperties\n import PostcommitJobBuilder\n \n \n-PostcommitJobBuilder.postCommitJob('beam_PostCommit_Java11_ValidatesRunner_Dataflow',\n+PostcommitJobBuilder.postCommitJob('beam_PostCommit_Java_ValidatesRunner_Dataflow_Java11',\n   'Run Dataflow ValidatesRunner Java 11', 'Google Cloud Dataflow Runner ValidatesRunner Tests On Java 11', this) {\n \n   description('Runs the ValidatesRunner suite on the Dataflow runner with Java 11 worker harness.')\n \n-  commonJobProperties.setTopLevelMainJobProperties(delegate, 'master', 270)\n+  def JAVA_11_HOME = '/usr/lib/jvm/java-11-openjdk-amd64'\n+  def JAVA_8_HOME = '/usr/lib/jvm/java-8-openjdk-amd64'\n \n+  commonJobProperties.setTopLevelMainJobProperties(delegate, 'master', 270)\n   publishers {\n     archiveJunit('**/build/test-results/**/*.xml')\n   }\n \n   steps {\n+    gradle {\n+      rootBuildScriptDir(commonJobProperties.checkoutDir)\n+      tasks(':runners:google-cloud-dataflow-java:testJar')\n+      tasks(':runners:google-cloud-dataflow-java:worker:legacy-worker:shadowJar')\n+      switches(\"-Dorg.gradle.java.home=${JAVA_8_HOME}\")\n+    }\n+    \n     gradle {\n       rootBuildScriptDir(commonJobProperties.checkoutDir)\n       tasks(':runners:google-cloud-dataflow-java:validatesJava11Runner')", "originalCommit": "fe87ee7d377477ddcb0863ccc0be482dbfe476bb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzQxMDk4NA==", "url": "https://github.com/apache/beam/pull/10689#discussion_r373410984", "bodyText": "Running a Dataflow validatesRunner with Java 11 requires setting an additional task parameter in order to have correct worker harness image (java.specification.version). Since I don't think we can parametrize Gradle tasks, we're stuck with two of them", "author": "mwalenia", "createdAt": "2020-01-31T10:27:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjY4NDA3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzU4MDQyMQ==", "url": "https://github.com/apache/beam/pull/10689#discussion_r373580421", "bodyText": "Shouldn't java.specification.version come automatically from the JVM and if we are using a Java 11 virtual machine, it should already provide java.specification.version of 11 while a Java 8 virtual machine would specify 8?", "author": "lukecwik", "createdAt": "2020-01-31T16:53:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjY4NDA3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDU0MDYwMw==", "url": "https://github.com/apache/beam/pull/10689#discussion_r374540603", "bodyText": "You're right, the whole duplicate is redundant. I'll fix this", "author": "mwalenia", "createdAt": "2020-02-04T08:52:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjY4NDA3OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjY4NDUwNQ==", "url": "https://github.com/apache/beam/pull/10689#discussion_r372684505", "bodyText": "Can we override the javaVersion property instead of splitting these into two commands?\nThis would lead us to using the Java 11 compiler with a source and class target of version 8 or do we want to explicitly guarantee that we are using the Java 8 compiler?", "author": "lukecwik", "createdAt": "2020-01-29T23:18:53Z", "path": ".test-infra/jenkins/job_PostCommit_Java_ValidatesRunner_Dataflow_Java11.groovy", "diffHunk": "@@ -20,26 +20,40 @@ import CommonJobProperties as commonJobProperties\n import PostcommitJobBuilder\n \n \n-PostcommitJobBuilder.postCommitJob('beam_PostCommit_Java11_ValidatesRunner_Dataflow',\n+PostcommitJobBuilder.postCommitJob('beam_PostCommit_Java_ValidatesRunner_Dataflow_Java11',\n   'Run Dataflow ValidatesRunner Java 11', 'Google Cloud Dataflow Runner ValidatesRunner Tests On Java 11', this) {\n \n   description('Runs the ValidatesRunner suite on the Dataflow runner with Java 11 worker harness.')\n \n-  commonJobProperties.setTopLevelMainJobProperties(delegate, 'master', 270)\n+  def JAVA_11_HOME = '/usr/lib/jvm/java-11-openjdk-amd64'\n+  def JAVA_8_HOME = '/usr/lib/jvm/java-8-openjdk-amd64'\n \n+  commonJobProperties.setTopLevelMainJobProperties(delegate, 'master', 270)\n   publishers {\n     archiveJunit('**/build/test-results/**/*.xml')\n   }\n \n   steps {\n+    gradle {\n+      rootBuildScriptDir(commonJobProperties.checkoutDir)", "originalCommit": "fe87ee7d377477ddcb0863ccc0be482dbfe476bb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDUyNTA1MA==", "url": "https://github.com/apache/beam/pull/10689#discussion_r374525050", "bodyText": "I think we want to guarantee that Beam compiled with 1.8 as per release process will work on Java 11 runtime.", "author": "mwalenia", "createdAt": "2020-02-04T08:14:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjY4NDUwNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDgyOTE5NA==", "url": "https://github.com/apache/beam/pull/10689#discussion_r374829194", "bodyText": "I don't fully understand your response.", "author": "lukecwik", "createdAt": "2020-02-04T17:57:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjY4NDUwNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTA5MzQ0Nw==", "url": "https://github.com/apache/beam/pull/10689#discussion_r375093447", "bodyText": "We want to check if the released version of Beam, which is compiled with Java 8, will work when a user with Java 11 environment imports it from Maven and uses it in their code.\nIn other words: yes, we want to explicitly use the Java 8 compiler.", "author": "mwalenia", "createdAt": "2020-02-05T07:25:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjY4NDUwNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTQ2NjY3OA==", "url": "https://github.com/apache/beam/pull/10689#discussion_r375466678", "bodyText": "Java 11 compiler when told to use source/target version of 8 will produce Java 8 classes and not Java 11 classes.", "author": "lukecwik", "createdAt": "2020-02-05T19:38:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjY4NDUwNQ=="}], "type": "inlineReview"}, {"oid": "7506ccef6cc272a80c7edf2aa3260aaed3db1c3c", "url": "https://github.com/apache/beam/commit/7506ccef6cc272a80c7edf2aa3260aaed3db1c3c", "message": "Change JDK paths in job definition", "committedDate": "2020-01-31T10:40:00Z", "type": "commit"}, {"oid": "acd5ae9f5ce5cd5cce7e429b1b27b740925a2763", "url": "https://github.com/apache/beam/commit/acd5ae9f5ce5cd5cce7e429b1b27b740925a2763", "message": "Change JDk paths back", "committedDate": "2020-01-31T11:54:46Z", "type": "commit"}, {"oid": "dc34d08c53eb2b6d7b1be524e62d489b5374a3c8", "url": "https://github.com/apache/beam/commit/dc34d08c53eb2b6d7b1be524e62d489b5374a3c8", "message": "Remove redundant gradle tasks", "committedDate": "2020-02-05T08:49:40Z", "type": "commit"}, {"oid": "dc34d08c53eb2b6d7b1be524e62d489b5374a3c8", "url": "https://github.com/apache/beam/commit/dc34d08c53eb2b6d7b1be524e62d489b5374a3c8", "message": "Remove redundant gradle tasks", "committedDate": "2020-02-05T08:49:40Z", "type": "forcePushed"}]}