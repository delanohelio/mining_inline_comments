{"pr_number": 11787, "pr_title": "[BEAM-10063] Better emulate the pandas testing environment.", "pr_createdAt": "2020-05-22T00:56:44Z", "pr_url": "https://github.com/apache/beam/pull/11787", "timeline": [{"oid": "5bfa04b3fd5f89ec72f9f4451401eb0347737efb", "url": "https://github.com/apache/beam/commit/5bfa04b3fd5f89ec72f9f4451401eb0347737efb", "message": "[BEAM-10063] Better emulate the pandas testing environment.", "committedDate": "2020-05-22T16:12:57Z", "type": "commit"}, {"oid": "5bfa04b3fd5f89ec72f9f4451401eb0347737efb", "url": "https://github.com/apache/beam/commit/5bfa04b3fd5f89ec72f9f4451401eb0347737efb", "message": "[BEAM-10063] Better emulate the pandas testing environment.", "committedDate": "2020-05-22T16:12:57Z", "type": "forcePushed"}, {"oid": "a34ed5ec5cd90a735ac214aab7ffee82d0c8cb64", "url": "https://github.com/apache/beam/commit/a34ed5ec5cd90a735ac214aab7ffee82d0c8cb64", "message": "lint", "committedDate": "2020-05-26T16:18:51Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDkxOTMwMw==", "url": "https://github.com/apache/beam/pull/11787#discussion_r434919303", "bodyText": "It looks like this is inlined in FakePandasObject.__call__ now, we should either remove _deferred_frame or call it from FakePandasObject. I think I'm partial to the latter since the method modifies _inputs, but either way is fine.", "author": "TheNeuralBit", "createdAt": "2020-06-03T23:57:08Z", "path": "sdks/python/apache_beam/dataframe/doctests.py", "diffHunk": "@@ -66,30 +93,19 @@ def __init__(self):\n     self._all_frames = {}\n \n   def fake_pandas_module(self):\n-    class FakePandas(object):\n-      \"\"\"A stand-in for the pandas top-level module.\n-      \"\"\"\n-      # For now, only populated with the frame types (below).\n-      # TODO(BEAM-9561): We may want to put more here.\n-      pass\n-\n-    fake_pd = FakePandas()\n-    for pandas_type, deferred_type in DeferredFrame._pandas_type_map.items():\n-      setattr(\n-          fake_pd,\n-          pandas_type.__name__,\n-          self._deferred_frame(pandas_type, deferred_type))\n-\n-    return fake_pd\n-\n-  def _deferred_frame(self, pandas_type, deferred_type):\n+    return FakePandasObject(pd, self)\n+\n+  def _deferred_frame(self, pandas_callable):\n     \"\"\"Creates a \"constructor\" that record the actual value as an input and\n     returns a placeholder frame in its place.\"\"\"\n     def wrapper(*args, **kwargs):\n-      df = pandas_type(*args, **kwargs)\n-      placeholder = expressions.PlaceholderExpression(df[0:0])\n-      self._inputs[placeholder] = df\n-      return deferred_type(placeholder)\n+      df = pandas_callable(*args, **kwargs)\n+      if type(df) in DeferredFrame._pandas_type_map.keys():\n+        placeholder = expressions.PlaceholderExpression(df[0:0])\n+        self._inputs[placeholder] = df\n+        return DeferredFrame.wrap(placeholder)\n+      else:\n+        return df", "originalCommit": "a34ed5ec5cd90a735ac214aab7ffee82d0c8cb64", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTM3MDczNQ==", "url": "https://github.com/apache/beam/pull/11787#discussion_r435370735", "bodyText": "Thanks. Removed.", "author": "robertwb", "createdAt": "2020-06-04T15:58:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDkxOTMwMw=="}], "type": "inlineReview"}, {"oid": "c10a2517875dc7e27adbc5e0c50eb7a6f8766b29", "url": "https://github.com/apache/beam/commit/c10a2517875dc7e27adbc5e0c50eb7a6f8766b29", "message": "remove unused copy of code", "committedDate": "2020-06-04T04:11:02Z", "type": "commit"}]}