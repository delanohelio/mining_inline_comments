{"pr_number": 10702, "pr_title": "[BEAM-5605] Migrate splittable DoFn methods to use \"new\" DoFn style argument providing.", "pr_createdAt": "2020-01-28T17:54:52Z", "pr_url": "https://github.com/apache/beam/pull/10702", "timeline": [{"oid": "3b8940f239cbbed019564d3a33f083b9df2c0229", "url": "https://github.com/apache/beam/commit/3b8940f239cbbed019564d3a33f083b9df2c0229", "message": "[BEAM-5605] Migrate splittable DoFn methods to use \"new\" DoFn style argument providing.\n\nDefined a new @Restriction parameter type to pass in the restriction.\nUpdated GetSize/GetInitialRestriction/SplitRestriction/NewTracker to take these new DoFn style parameters.\nUpdated lots of documentation and existing implementations to use the new DoFn argument passing.\nFixed ByteBuddyDoFnInvokerFactory to support return values that aren't references.", "committedDate": "2020-01-28T22:39:07Z", "type": "commit"}, {"oid": "565da3cb324d58e618c3e5851027f6dca072f8af", "url": "https://github.com/apache/beam/commit/565da3cb324d58e618c3e5851027f6dca072f8af", "message": "fixup! Fix ValidatesRunner splittable DoFn tests.", "committedDate": "2020-01-28T22:39:13Z", "type": "commit"}, {"oid": "565da3cb324d58e618c3e5851027f6dca072f8af", "url": "https://github.com/apache/beam/commit/565da3cb324d58e618c3e5851027f6dca072f8af", "message": "fixup! Fix ValidatesRunner splittable DoFn tests.", "committedDate": "2020-01-28T22:39:13Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjEzMDE3MA==", "url": "https://github.com/apache/beam/pull/10702#discussion_r372130170", "bodyText": "What happens if one chooses not to implement these? Might be useful to describe that here to encourage users to do it.", "author": "TheNeuralBit", "createdAt": "2020-01-29T00:16:01Z", "path": "sdks/java/core/src/main/java/org/apache/beam/sdk/transforms/DoFn.java", "diffHunk": "@@ -614,45 +612,93 @@ public Duration getAllowedTimestampSkew() {\n    * <p>See <a href=\"https://s.apache.org/splittable-do-fn\">the proposal</a> for an overview of the\n    * involved concepts (<i>splittable DoFn</i>, <i>restriction</i>, <i>restriction tracker</i>).\n    *\n-   * <p>If a {@link DoFn} is splittable, the following constraints must be respected:\n+   * <p>A splittable {@link DoFn} must obey the following constraints:\n    *\n    * <ul>\n    *   <li>It <i>must</i> define a {@link GetInitialRestriction} method.\n-   *   <li>It <i>may</i> define a {@link GetSize} method.\n-   *   <li>It <i>may</i> define a {@link SplitRestriction} method.\n+   *   <li>It <i>should</i> define a {@link GetSize} method or ensure that the {@link\n+   *       RestrictionTracker} implements {@link Sizes.HasSize}.\n+   *   <li>It <i>should</i> define a {@link SplitRestriction} method.", "originalCommit": "565da3cb324d58e618c3e5851027f6dca072f8af", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjUxNDA0Nw==", "url": "https://github.com/apache/beam/pull/10702#discussion_r372514047", "bodyText": "Done", "author": "lukecwik", "createdAt": "2020-01-29T17:08:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjEzMDE3MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjEzNjA3Mg==", "url": "https://github.com/apache/beam/pull/10702#discussion_r372136072", "bodyText": "Is this similar to the GetSize requirement in that one should do one or the other? Or is it required that the user does exactly one of them? Maybe this is just because I'm unfamiliar with SDF, but I think these either/or requirements could be clearer.", "author": "TheNeuralBit", "createdAt": "2020-01-29T00:39:09Z", "path": "sdks/java/core/src/main/java/org/apache/beam/sdk/transforms/DoFn.java", "diffHunk": "@@ -614,45 +612,93 @@ public Duration getAllowedTimestampSkew() {\n    * <p>See <a href=\"https://s.apache.org/splittable-do-fn\">the proposal</a> for an overview of the\n    * involved concepts (<i>splittable DoFn</i>, <i>restriction</i>, <i>restriction tracker</i>).\n    *\n-   * <p>If a {@link DoFn} is splittable, the following constraints must be respected:\n+   * <p>A splittable {@link DoFn} must obey the following constraints:\n    *\n    * <ul>\n    *   <li>It <i>must</i> define a {@link GetInitialRestriction} method.\n-   *   <li>It <i>may</i> define a {@link GetSize} method.\n-   *   <li>It <i>may</i> define a {@link SplitRestriction} method.\n+   *   <li>It <i>should</i> define a {@link GetSize} method or ensure that the {@link\n+   *       RestrictionTracker} implements {@link Sizes.HasSize}.\n+   *   <li>It <i>should</i> define a {@link SplitRestriction} method.\n    *   <li>It <i>may</i> define a {@link NewTracker} method returning a subtype of {@code\n    *       RestrictionTracker<R>} where {@code R} is the restriction type returned by {@link\n    *       GetInitialRestriction}. This method is optional in case the restriction type returned by\n    *       {@link GetInitialRestriction} implements {@link HasDefaultTracker}.", "originalCommit": "565da3cb324d58e618c3e5851027f6dca072f8af", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjUxNDA5Mw==", "url": "https://github.com/apache/beam/pull/10702#discussion_r372514093", "bodyText": "Done", "author": "lukecwik", "createdAt": "2020-01-29T17:08:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjEzNjA3Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjEzNzE5Mg==", "url": "https://github.com/apache/beam/pull/10702#discussion_r372137192", "bodyText": "nit: maybe this should be first and should read The type of restrictions, {@code R}, used in all restriction methods must be the same.\nThen you can reference R elsewhere without having to define it again.\nUp to you, just an idea I had that may increase clarity", "author": "TheNeuralBit", "createdAt": "2020-01-29T00:43:45Z", "path": "sdks/java/core/src/main/java/org/apache/beam/sdk/transforms/DoFn.java", "diffHunk": "@@ -614,45 +612,93 @@ public Duration getAllowedTimestampSkew() {\n    * <p>See <a href=\"https://s.apache.org/splittable-do-fn\">the proposal</a> for an overview of the\n    * involved concepts (<i>splittable DoFn</i>, <i>restriction</i>, <i>restriction tracker</i>).\n    *\n-   * <p>If a {@link DoFn} is splittable, the following constraints must be respected:\n+   * <p>A splittable {@link DoFn} must obey the following constraints:\n    *\n    * <ul>\n    *   <li>It <i>must</i> define a {@link GetInitialRestriction} method.\n-   *   <li>It <i>may</i> define a {@link GetSize} method.\n-   *   <li>It <i>may</i> define a {@link SplitRestriction} method.\n+   *   <li>It <i>should</i> define a {@link GetSize} method or ensure that the {@link\n+   *       RestrictionTracker} implements {@link Sizes.HasSize}.\n+   *   <li>It <i>should</i> define a {@link SplitRestriction} method.\n    *   <li>It <i>may</i> define a {@link NewTracker} method returning a subtype of {@code\n    *       RestrictionTracker<R>} where {@code R} is the restriction type returned by {@link\n    *       GetInitialRestriction}. This method is optional in case the restriction type returned by\n    *       {@link GetInitialRestriction} implements {@link HasDefaultTracker}.\n    *   <li>It <i>may</i> define a {@link GetRestrictionCoder} method.\n    *   <li>The type of restrictions used by all of these methods must be the same.", "originalCommit": "565da3cb324d58e618c3e5851027f6dca072f8af", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjUxNDQyOQ==", "url": "https://github.com/apache/beam/pull/10702#discussion_r372514429", "bodyText": "Done", "author": "lukecwik", "createdAt": "2020-01-29T17:09:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjEzNzE5Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjE0MDgxMw==", "url": "https://github.com/apache/beam/pull/10702#discussion_r372140813", "bodyText": "What does it mean that schema element parameters aren't supported - that you can't use FieldAccess? Or that we won't automatically convert types that have equivalent schemas? both (seems likely)?", "author": "TheNeuralBit", "createdAt": "2020-01-29T00:57:54Z", "path": "sdks/java/core/src/main/java/org/apache/beam/sdk/transforms/DoFn.java", "diffHunk": "@@ -758,11 +804,19 @@ public Duration getAllowedTimestampSkew() {\n    * Annotation for the method that maps an element to an initial restriction for a <a\n    * href=\"https://s.apache.org/splittable-do-fn\">splittable</a> {@link DoFn}.\n    *\n-   * <p>Signature: {@code RestrictionT getInitialRestriction(InputT element, <optional arguments>);}\n+   * <p>Signature: {@code RestrictionT getInitialRestriction(<arguments>);}\n    *\n-   * <p>The optional arguments are allowed to be:\n+   * <p>This method must satisfy the following constraints:\n    *\n    * <ul>\n+   *   <li>The return type {@code RestrictionT} defines the restriction type used within this\n+   *       splittable DoFn. All other methods that use a {@link Restriction @Restriction} parameter\n+   *       must use the same type that is used here. It is suggested to use as narrow of a return\n+   *       type definition as possible (for example prefer to use a square type over a shape type as\n+   *       a square is a type of a shape).\n+   *   <li>If one of its arguments is tagged with the {@link Element} annotation, then it will be\n+   *       passed the current element being processed; the argument must be of type {@code InputT}.\n+   *       Note that schema element parameters are currently unsupported.", "originalCommit": "565da3cb324d58e618c3e5851027f6dca072f8af", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjUxNjQ3MQ==", "url": "https://github.com/apache/beam/pull/10702#discussion_r372516471", "bodyText": "I would also suggest updating the DoFn documentation related to schemas since the docs around what is FieldAccess and how @element parameters interact seems to be incorrect since the documentation currently states that \"the argument type must match the input type of this DoFn\"", "author": "lukecwik", "createdAt": "2020-01-29T17:13:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjE0MDgxMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjU0MDU2NQ==", "url": "https://github.com/apache/beam/pull/10702#discussion_r372540565", "bodyText": "good point. I filed BEAM-9217 to follow-up with that.", "author": "TheNeuralBit", "createdAt": "2020-01-29T17:59:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjE0MDgxMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjE0MTYxNw==", "url": "https://github.com/apache/beam/pull/10702#discussion_r372141617", "bodyText": "Would be helpful to add an \"If this DoFn is splittable,\" here just to be very clear.", "author": "TheNeuralBit", "createdAt": "2020-01-29T01:00:57Z", "path": "sdks/java/core/src/main/java/org/apache/beam/sdk/transforms/DoFn.java", "diffHunk": "@@ -614,45 +612,93 @@ public Duration getAllowedTimestampSkew() {\n    * <p>See <a href=\"https://s.apache.org/splittable-do-fn\">the proposal</a> for an overview of the\n    * involved concepts (<i>splittable DoFn</i>, <i>restriction</i>, <i>restriction tracker</i>).\n    *\n-   * <p>If a {@link DoFn} is splittable, the following constraints must be respected:\n+   * <p>A splittable {@link DoFn} must obey the following constraints:\n    *\n    * <ul>\n    *   <li>It <i>must</i> define a {@link GetInitialRestriction} method.\n-   *   <li>It <i>may</i> define a {@link GetSize} method.\n-   *   <li>It <i>may</i> define a {@link SplitRestriction} method.\n+   *   <li>It <i>should</i> define a {@link GetSize} method or ensure that the {@link\n+   *       RestrictionTracker} implements {@link Sizes.HasSize}.\n+   *   <li>It <i>should</i> define a {@link SplitRestriction} method.\n    *   <li>It <i>may</i> define a {@link NewTracker} method returning a subtype of {@code\n    *       RestrictionTracker<R>} where {@code R} is the restriction type returned by {@link\n    *       GetInitialRestriction}. This method is optional in case the restriction type returned by\n    *       {@link GetInitialRestriction} implements {@link HasDefaultTracker}.\n    *   <li>It <i>may</i> define a {@link GetRestrictionCoder} method.\n    *   <li>The type of restrictions used by all of these methods must be the same.\n-   *   <li>Its {@link ProcessElement} method <i>may</i> return a {@link ProcessContinuation} to\n-   *       indicate whether there is more work to be done for the current element.\n-   *   <li>Its {@link ProcessElement} method <i>must not</i> use any extra context parameters, such\n-   *       as {@link BoundedWindow}.\n    *   <li>The {@link DoFn} itself <i>may</i> be annotated with {@link BoundedPerElement} or {@link\n    *       UnboundedPerElement}, but not both at the same time. If it's not annotated with either of\n    *       these, it's assumed to be {@link BoundedPerElement} if its {@link ProcessElement} method\n    *       returns {@code void} and {@link UnboundedPerElement} if it returns a {@link\n    *       ProcessContinuation}.\n+   *   <li>Timers and state must not be used.\n    * </ul>\n    *\n    * <p>A non-splittable {@link DoFn} <i>must not</i> define any of these methods.\n+   *\n+   * <p>This method must satisfy the following constraints:", "originalCommit": "565da3cb324d58e618c3e5851027f6dca072f8af", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjUxNTUzMg==", "url": "https://github.com/apache/beam/pull/10702#discussion_r372515532", "bodyText": "Done", "author": "lukecwik", "createdAt": "2020-01-29T17:11:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjE0MTYxNw=="}], "type": "inlineReview"}, {"oid": "92b638dda24b1a8a6831562dec94cd4866efd544", "url": "https://github.com/apache/beam/commit/92b638dda24b1a8a6831562dec94cd4866efd544", "message": "fixup! Address javadoc comments", "committedDate": "2020-01-29T17:16:05Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjE0NTY2MQ==", "url": "https://github.com/apache/beam/pull/10702#discussion_r372145661", "bodyText": "Does creating tracker require passing in element?", "author": "boyuanzz", "createdAt": "2020-01-29T01:17:43Z", "path": "sdks/java/core/src/main/java/org/apache/beam/sdk/transforms/DoFn.java", "diffHunk": "@@ -871,13 +960,20 @@ public Duration getAllowedTimestampSkew() {\n    * Annotation for the method that creates a new {@link RestrictionTracker} for the restriction of\n    * a <a href=\"https://s.apache.org/splittable-do-fn\">splittable</a> {@link DoFn}.\n    *\n-   * <p>Signature: {@code MyRestrictionTracker newTracker(RestrictionT restriction, <optional\n-   * arguments>);} where {@code MyRestrictionTracker} must be a subtype of {@code\n-   * RestrictionTracker<RestrictionT>}.\n+   * <p>Signature: {@code MyRestrictionTracker newTracker(<optional arguments>);}\n    *\n-   * <p>The optional arguments are allowed to be:\n+   * <p>This method must satisfy the following constraints:\n    *\n    * <ul>\n+   *   <li>The return type must be a subtype of {@code RestrictionTracker<RestrictionT, PositionT>}.\n+   *       It is suggested to use as narrow of a return type definition as possible (for example\n+   *       prefer to use a square type over a shape type as a square is a type of a shape).\n+   *   <li>If one of its arguments is tagged with the {@link Element} annotation, then it will be", "originalCommit": "565da3cb324d58e618c3e5851027f6dca072f8af", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzcyMjYzMA==", "url": "https://github.com/apache/beam/pull/10702#discussion_r373722630", "bodyText": "No.", "author": "lukecwik", "createdAt": "2020-01-31T23:00:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjE0NTY2MQ=="}], "type": "inlineReview"}]}