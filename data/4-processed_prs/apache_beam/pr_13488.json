{"pr_number": 13488, "pr_title": "[BEAM-11361] Dynamic splitting of dataframe csv reads.", "pr_createdAt": "2020-12-04T18:54:16Z", "pr_url": "https://github.com/apache/beam/pull/13488", "timeline": [{"oid": "8098e65dd224a14b7627f7ad62b8bd2926f2b507", "url": "https://github.com/apache/beam/commit/8098e65dd224a14b7627f7ad62b8bd2926f2b507", "message": "Refactor splitters for further customization.", "committedDate": "2020-12-04T18:56:49Z", "type": "commit"}, {"oid": "3ef446bdbe4696a2f2d6333b6fa0a1426ed7015e", "url": "https://github.com/apache/beam/commit/3ef446bdbe4696a2f2d6333b6fa0a1426ed7015e", "message": "[BEAM-11361] Dynamic splitting of dataframe csv reads.\n\nSupport for headers, but not for escaped newlines (so not yet on by default).", "committedDate": "2020-12-04T18:56:49Z", "type": "commit"}, {"oid": "3ef446bdbe4696a2f2d6333b6fa0a1426ed7015e", "url": "https://github.com/apache/beam/commit/3ef446bdbe4696a2f2d6333b6fa0a1426ed7015e", "message": "[BEAM-11361] Dynamic splitting of dataframe csv reads.\n\nSupport for headers, but not for escaped newlines (so not yet on by default).", "committedDate": "2020-12-04T18:56:49Z", "type": "forcePushed"}, {"oid": "77ca3fc8709fb7ffb3273fb72765b0c6892359d1", "url": "https://github.com/apache/beam/commit/77ca3fc8709fb7ffb3273fb72765b0c6892359d1", "message": "lint", "committedDate": "2020-12-04T20:25:27Z", "type": "commit"}, {"oid": "f23dc2d67398ebe11de6b91af335af6e02aa1fa2", "url": "https://github.com/apache/beam/commit/f23dc2d67398ebe11de6b91af335af6e02aa1fa2", "message": "lint", "committedDate": "2020-12-15T01:21:41Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjkwOTYwMA==", "url": "https://github.com/apache/beam/pull/13488#discussion_r542909600", "bodyText": "Can we make this warn that using splittable=True with quoted newlines could lead to dataloss?", "author": "TheNeuralBit", "createdAt": "2020-12-14T23:04:20Z", "path": "sdks/python/apache_beam/dataframe/io.py", "diffHunk": "@@ -31,16 +33,28 @@\n _DEFAULT_BYTES_CHUNKSIZE = 1 << 20\n \n \n-def read_csv(path, *args, **kwargs):\n+def read_csv(path, *args, splittable=False, **kwargs):\n   \"\"\"Emulates `pd.read_csv` from Pandas, but as a Beam PTransform.\n \n   Use this as\n \n       df = p | beam.dataframe.io.read_csv(...)\n \n   to get a deferred Beam dataframe representing the contents of the file.\n+\n+  If your files are large and records do not contain quoted newlines, you may\n+  pass the extra argument splittable=True to enable dynamic splitting for this\n+  read.", "originalCommit": "77ca3fc8709fb7ffb3273fb72765b0c6892359d1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mzc1NDk4OQ==", "url": "https://github.com/apache/beam/pull/13488#discussion_r543754989", "bodyText": "Good point. Done.", "author": "robertwb", "createdAt": "2020-12-15T23:12:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjkwOTYwMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjkzMzgxMg==", "url": "https://github.com/apache/beam/pull/13488#discussion_r542933812", "bodyText": "Might be helpful to clarify that this is splitting on delimiters between records, it's easy to get mixed up in the CSV case where there's also a field delimiter.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            class _DelimSplitter(_Splitter):\n          \n          \n            \n              def __init__(self, delim, read_chunk_size=_DEFAULT_BYTES_CHUNKSIZE):\n          \n          \n            \n            class _RecordDelimSplitter(_Splitter):\n          \n          \n            \n              \"\"\" A _Splitter that splits on delimiters between records. \"\"\"\n          \n          \n            \n              def __init__(self, delim, read_chunk_size=_DEFAULT_BYTES_CHUNKSIZE):", "author": "TheNeuralBit", "createdAt": "2020-12-14T23:57:45Z", "path": "sdks/python/apache_beam/dataframe/io.py", "diffHunk": "@@ -192,14 +207,134 @@ def expand(self, root):\n                 self.reader,\n                 self.args,\n                 self.kwargs,\n+                self.binary,\n                 self.incremental,\n-                self.splittable,\n-                self.binary)))\n+                self.splitter)))\n     from apache_beam.dataframe import convert\n     return convert.to_dataframe(\n         pcoll, proxy=_prefix_range_index_with(':', sample[:0]))\n \n \n+class _Splitter:\n+  def empty_buffer(self):\n+    raise NotImplementedError(self)\n+\n+  def read_header(self, handle):\n+    raise NotImplementedError(self)\n+\n+  def read_to_record_boundary(self, buffered, handle):\n+    raise NotImplementedError(self)\n+\n+\n+class _DelimSplitter(_Splitter):\n+  def __init__(self, delim, read_chunk_size=_DEFAULT_BYTES_CHUNKSIZE):", "originalCommit": "77ca3fc8709fb7ffb3273fb72765b0c6892359d1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mzc2MDk4Ng==", "url": "https://github.com/apache/beam/pull/13488#discussion_r543760986", "bodyText": "Done.", "author": "robertwb", "createdAt": "2020-12-15T23:25:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjkzMzgxMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mjk4MTU4OQ==", "url": "https://github.com/apache/beam/pull/13488#discussion_r542981589", "bodyText": "Could you add docstrings and/or typehints for this class so its clear what implementations should do", "author": "TheNeuralBit", "createdAt": "2020-12-15T01:45:54Z", "path": "sdks/python/apache_beam/dataframe/io.py", "diffHunk": "@@ -192,14 +207,133 @@ def expand(self, root):\n                 self.reader,\n                 self.args,\n                 self.kwargs,\n+                self.binary,\n                 self.incremental,\n-                self.splittable,\n-                self.binary)))\n+                self.splitter)))\n     from apache_beam.dataframe import convert\n     return convert.to_dataframe(\n         pcoll, proxy=_prefix_range_index_with(':', sample[:0]))\n \n \n+class _Splitter:\n+  def empty_buffer(self):\n+    raise NotImplementedError(self)\n+\n+  def read_header(self, handle):\n+    raise NotImplementedError(self)\n+\n+  def read_to_record_boundary(self, buffered, handle):\n+    raise NotImplementedError(self)", "originalCommit": "f23dc2d67398ebe11de6b91af335af6e02aa1fa2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mzc2MDUzOQ==", "url": "https://github.com/apache/beam/pull/13488#discussion_r543760539", "bodyText": "I actually tried to add typehints initially; they work poorly due to the fact that this works both on bytes and strings (but it's hard for mypy to know that it will be all one or all the other). But I added some comments at least.", "author": "robertwb", "createdAt": "2020-12-15T23:24:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mjk4MTU4OQ=="}], "type": "inlineReview"}, {"oid": "114c0988062e64112e343344357874ce9b1b31e5", "url": "https://github.com/apache/beam/commit/114c0988062e64112e343344357874ce9b1b31e5", "message": "Add comments.", "committedDate": "2020-12-15T23:25:43Z", "type": "commit"}, {"oid": "3b7effec4d434a1ff9edb1c763676f1c37974c13", "url": "https://github.com/apache/beam/commit/3b7effec4d434a1ff9edb1c763676f1c37974c13", "message": "lint", "committedDate": "2020-12-16T01:26:12Z", "type": "commit"}]}