{"pr_number": 10810, "pr_title": "[BEAM-9274] Support running yapf in a git pre-commit hook", "pr_createdAt": "2020-02-09T05:14:20Z", "pr_url": "https://github.com/apache/beam/pull/10810", "timeline": [{"oid": "4fe1e45c2eac3e2f8bd190e004cd12597bf4f5d9", "url": "https://github.com/apache/beam/commit/4fe1e45c2eac3e2f8bd190e004cd12597bf4f5d9", "message": "Support running yapf in a git pre-commit hook", "committedDate": "2020-02-09T05:22:04Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzI3MTY3OA==", "url": "https://github.com/apache/beam/pull/10810#discussion_r377271678", "bodyText": "Please add a similar comment in tox.ini.", "author": "udim", "createdAt": "2020-02-10T19:33:23Z", "path": ".pre-commit-config.yaml", "diffHunk": "@@ -0,0 +1,32 @@\n+# Licensed under the Apache License, Version 2.0 (the \"License\");\n+# you may not use this file except in compliance with the License.\n+# You may obtain a copy of the License at\n+#\n+# http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+\n+repos:\n+  - repo: https://github.com/pre-commit/mirrors-yapf\n+    # this rev is a release tag in the repo above and corresponds with a yapf\n+    # version. make sure this matches the version of yapf in tox.ini.\n+    rev: v0.29.0", "originalCommit": "4fe1e45c2eac3e2f8bd190e004cd12597bf4f5d9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjU4NjY4Mg==", "url": "https://github.com/apache/beam/pull/10810#discussion_r386586682", "bodyText": "Please address", "author": "udim", "createdAt": "2020-03-02T19:00:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzI3MTY3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjY4NjQzNQ==", "url": "https://github.com/apache/beam/pull/10810#discussion_r386686435", "bodyText": "done!", "author": "chadrik", "createdAt": "2020-03-02T22:21:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzI3MTY3OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzg1NDg3MA==", "url": "https://github.com/apache/beam/pull/10810#discussion_r377854870", "bodyText": "What happens if we don't keep these in sync? Will we run yapf unnecessarily (OK) or skip it when we should run it?", "author": "robertwb", "createdAt": "2020-02-11T19:37:36Z", "path": ".pre-commit-config.yaml", "diffHunk": "@@ -0,0 +1,32 @@\n+# Licensed under the Apache License, Version 2.0 (the \"License\");\n+# you may not use this file except in compliance with the License.\n+# You may obtain a copy of the License at\n+#\n+# http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+\n+repos:\n+  - repo: https://github.com/pre-commit/mirrors-yapf\n+    # this rev is a release tag in the repo above and corresponds with a yapf\n+    # version. make sure this matches the version of yapf in tox.ini.\n+    rev: v0.29.0\n+    hooks:\n+      - id: yapf\n+        files: ^sdks/python/apache_beam/\n+        # keep these in sync with sdks/python/.yapfignore", "originalCommit": "4fe1e45c2eac3e2f8bd190e004cd12597bf4f5d9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzg3MzMyNA==", "url": "https://github.com/apache/beam/pull/10810#discussion_r377873324", "bodyText": "First, some background:\npre-commit triggers its hooks based on changed files, matching based on 3 values:\n\nfile type (i.e. pre-commit maintains a mapping from \"python\" to , \".py\", etc)\nfiles:  include patttern\nexclude: exclude pattern\n\npre-commit always passes an explicit list of changed files to the underlying tool, and never relies on recursive flags.\nOk, on to your question.  Our exclude patterns target autogenerated files.  So, if a new autogenerated file were added to the repo which was excluded in .yapfignore but not in .pre-commit-config.yaml (which I think would be the most common \"failure\" scenario), then the first time that a developer with pre-commit enabled changed that file (say, by regenerating it) and tried to commit those changes, yapf would autoformat it, and then pre-commit would fail the commit with a message like this:\nyapf.....................................................................Failed\n- hook id: yapf\n- files were modified by this hook\n\nAt this point hopefully the developer realizes that the failure is due to yapf, and finds the trail of comments leading them to .pre-commit-config.yaml.  Worst case scenario is that they commit it with the autoformatted changes, which would be pretty innocuous, and would not fail any jenkins tests because those same autogenerated files are excluded from pylint.\nAnother thing to note is that this is all just a convenience for developers.  Jenkins remains our last line of defense.\nAlso note that it's possible to invoke your lint tools using pre-commit within tox, so that you can consolidate all of your includes and excludes across all tools into one file, the pre-commit-config.yaml.  This is what we do where I work.", "author": "chadrik", "createdAt": "2020-02-11T20:15:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzg1NDg3MA=="}], "type": "inlineReview"}, {"oid": "f547fe32b71ae91ed9776d00d5bcc37ab17cffe1", "url": "https://github.com/apache/beam/commit/f547fe32b71ae91ed9776d00d5bcc37ab17cffe1", "message": "[BEAM-9274] Support running yapf in a git pre-commit hook", "committedDate": "2020-03-02T22:20:43Z", "type": "forcePushed"}, {"oid": "ccdcc22f84943f98ca12384e4afceb72b2194e6f", "url": "https://github.com/apache/beam/commit/ccdcc22f84943f98ca12384e4afceb72b2194e6f", "message": "Support running yapf in a git pre-commit hook", "committedDate": "2020-03-03T05:39:10Z", "type": "forcePushed"}, {"oid": "e07e65b67f9cef21cd295feef955e448d253d70d", "url": "https://github.com/apache/beam/commit/e07e65b67f9cef21cd295feef955e448d253d70d", "message": "[BEAM-9274] Support running yapf in a git pre-commit hook", "committedDate": "2020-03-03T18:33:38Z", "type": "commit"}, {"oid": "e07e65b67f9cef21cd295feef955e448d253d70d", "url": "https://github.com/apache/beam/commit/e07e65b67f9cef21cd295feef955e448d253d70d", "message": "[BEAM-9274] Support running yapf in a git pre-commit hook", "committedDate": "2020-03-03T18:33:38Z", "type": "forcePushed"}, {"oid": "ccdcc22f84943f98ca12384e4afceb72b2194e6f", "url": "https://github.com/apache/beam/commit/ccdcc22f84943f98ca12384e4afceb72b2194e6f", "message": "Support running yapf in a git pre-commit hook", "committedDate": "2020-03-03T05:39:10Z", "type": "forcePushed"}, {"oid": "e07e65b67f9cef21cd295feef955e448d253d70d", "url": "https://github.com/apache/beam/commit/e07e65b67f9cef21cd295feef955e448d253d70d", "message": "[BEAM-9274] Support running yapf in a git pre-commit hook", "committedDate": "2020-03-03T18:33:38Z", "type": "forcePushed"}]}