{"pr_number": 13517, "pr_title": "[BEAM-11432] put latest tag when publishing SDK head containers to gcr", "pr_createdAt": "2020-12-10T01:13:34Z", "pr_url": "https://github.com/apache/beam/pull/13517", "timeline": [{"oid": "b92966ff6159b713b6548778f457cd1b1c43400d", "url": "https://github.com/apache/beam/commit/b92966ff6159b713b6548778f457cd1b1c43400d", "message": "[BEAM-11432] put latest tag when publishing SDK head containers to gcr", "committedDate": "2020-12-10T01:13:06Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTIyNDM5Mg==", "url": "https://github.com/apache/beam/pull/13517#discussion_r541224392", "bodyText": "awesome, I didn't know this existed! thanks", "author": "emilymye", "createdAt": "2020-12-11T19:58:33Z", "path": ".test-infra/jenkins/job_Publish_SDK_Image_Snapshots.groovy", "diffHunk": "@@ -41,12 +41,12 @@ job('beam_Publish_Beam_SDK_Snapshots') {\n     gradle {\n       rootBuildScriptDir(commonJobProperties.checkoutDir)\n       commonJobProperties.setGradleSwitches(delegate)\n-      tasks(':sdks:go:container:dockerPush')\n+      tasks(':sdks:go:container:dockerTagPush')\n       SUPPORTED_JAVA_CONTAINER_TASKS.each { taskVer ->\n-        tasks(\":sdks:java:container:${taskVer}:dockerPush\")\n+        tasks(\":sdks:java:container:${taskVer}:dockerTagPush\")", "originalCommit": "b92966ff6159b713b6548778f457cd1b1c43400d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTIyNzY1Nw==", "url": "https://github.com/apache/beam/pull/13517#discussion_r541227657", "bodyText": "By default this will always push latest tag, which I'm not sure we actually want to force. Would it be better to make docker-tag a comma-separated string list parameter and use split? That way we can also allow people to push more than one tag that isn't just latest.", "author": "emilymye", "createdAt": "2020-12-11T20:02:09Z", "path": "sdks/go/container/build.gradle", "diffHunk": "@@ -47,12 +47,14 @@ golang {\n   }\n }\n \n+def defaultTag = project.rootProject.hasProperty([\"docker-tag\"]) ? [project.rootProject[\"docker-tag\"], 'latest'] : ['latest']", "originalCommit": "b92966ff6159b713b6548778f457cd1b1c43400d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTM0MjM3NQ==", "url": "https://github.com/apache/beam/pull/13517#discussion_r541342375", "bodyText": "Thanks for the comment.\n\nBy default this will always push latest tag, which I'm not sure we actually want to force.\n\nFYI, 'latest' tag is only attached when we use dockerTagPush command (not dockerPush).\nIf we allow a comma-separated string in docker-tag, it will break docker task. docker and dockerTag are different commands where docker command only works with the tag specified by docker-tag property but dockerTag command respects the list of tags in tags.\nWe should define a separate property something like docker-aux-tag (or docker-secondary-tag) and set docker-tag + docker-aux-tag for tags to let users append their own tags. Do you want to go with this option?", "author": "ihji", "createdAt": "2020-12-11T22:02:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTIyNzY1Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTM0NjI5Mg==", "url": "https://github.com/apache/beam/pull/13517#discussion_r541346292", "bodyText": "ah, I see. Would it work to just ignore docker-tag for dockerTagPush and just use one flag like docker-tags or docker-tag-list? Mostly I don't quite like the idea of splitting the tag flag - if docker-tags isn't given, we can just construct a list from docker-tag, or use [\"latest\"]?", "author": "emilymye", "createdAt": "2020-12-11T22:07:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTIyNzY1Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mjc1NzE5NA==", "url": "https://github.com/apache/beam/pull/13517#discussion_r542757194", "bodyText": "Changed to getting from 'docker-tag-list' and generating the default value from 'docker-tag' if the first option is not available.", "author": "ihji", "createdAt": "2020-12-14T20:38:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTIyNzY1Nw=="}], "type": "inlineReview"}, {"oid": "cfdd2ce8b735a5df94a68488c2b44d0e3646c038", "url": "https://github.com/apache/beam/commit/cfdd2ce8b735a5df94a68488c2b44d0e3646c038", "message": "get from docker-tag-list if available", "committedDate": "2020-12-14T20:23:40Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mzc1MDcyMw==", "url": "https://github.com/apache/beam/pull/13517#discussion_r543750723", "bodyText": "Can you add comments that say this property only gets used by dockerTagPush? I think it will be confusing otherwise.", "author": "emilymye", "createdAt": "2020-12-15T23:02:39Z", "path": "sdks/go/container/build.gradle", "diffHunk": "@@ -53,6 +53,7 @@ docker {\n           root: project.rootProject.hasProperty([\"docker-repository-root\"]) ?\n                   project.rootProject[\"docker-repository-root\"] :\n                   project.docker_image_default_repo_root)\n+  tags containerImageTags()", "originalCommit": "cfdd2ce8b735a5df94a68488c2b44d0e3646c038", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mzc5ODM3Nw==", "url": "https://github.com/apache/beam/pull/13517#discussion_r543798377", "bodyText": "Done", "author": "ihji", "createdAt": "2020-12-16T00:58:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mzc1MDcyMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mzc1MTY5Mw==", "url": "https://github.com/apache/beam/pull/13517#discussion_r543751693", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  switches(\"-Pdocker-tag=${imageTag}\")\n          \n          \n            \n                  switches(\"-Pdocker-tag-list=${imageTag},latest\")", "author": "emilymye", "createdAt": "2020-12-15T23:04:45Z", "path": ".test-infra/jenkins/job_Publish_SDK_Image_Snapshots.groovy", "diffHunk": "@@ -41,12 +41,12 @@ job('beam_Publish_Beam_SDK_Snapshots') {\n     gradle {\n       rootBuildScriptDir(commonJobProperties.checkoutDir)\n       commonJobProperties.setGradleSwitches(delegate)\n-      tasks(':sdks:go:container:dockerPush')\n+      tasks(':sdks:go:container:dockerTagPush')\n       SUPPORTED_JAVA_CONTAINER_TASKS.each { taskVer ->\n-        tasks(\":sdks:java:container:${taskVer}:dockerPush\")\n+        tasks(\":sdks:java:container:${taskVer}:dockerTagPush\")\n       }\n       SUPPORTED_PYTHON_CONTAINER_TASKS.each { taskVer ->\n-        tasks(\":sdks:python:container:${taskVer}:dockerPush\")\n+        tasks(\":sdks:python:container:${taskVer}:dockerTagPush\")\n       }\n       switches(\"-Pdocker-repository-root=${imageRepo}\")\n       switches(\"-Pdocker-tag=${imageTag}\")", "originalCommit": "cfdd2ce8b735a5df94a68488c2b44d0e3646c038", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mzc5ODQzNw==", "url": "https://github.com/apache/beam/pull/13517#discussion_r543798437", "bodyText": "Done.", "author": "ihji", "createdAt": "2020-12-16T00:59:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mzc1MTY5Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mzc1MzAzNw==", "url": "https://github.com/apache/beam/pull/13517#discussion_r543753037", "bodyText": "I'm not a huge fan of adding this default vs using tags = [project.rootProject[\"docker-tag\"]] and having a caller provide docker-tag-list=${sdk_version},latest. Is this specific to work you are planning?", "author": "emilymye", "createdAt": "2020-12-15T23:07:30Z", "path": "buildSrc/src/main/groovy/org/apache/beam/gradle/BeamModulePlugin.groovy", "diffHunk": "@@ -1704,6 +1704,20 @@ class BeamModulePlugin implements Plugin<Project> {\n       return \"${configuration.root}/${configuration.name}:${configuration.tag}\"\n     }\n \n+    project.ext.containerImageTags = {\n+      String[] tags\n+      if (project.rootProject.hasProperty([\"docker-tag-list\"])) {\n+        tags = project.rootProject[\"docker-tag-list\"].split(',')\n+      } else {\n+        tags = [\n+          project.rootProject.hasProperty([\"docker-tag\"]) ?\n+          project.rootProject[\"docker-tag\"] : project.sdk_version,", "originalCommit": "cfdd2ce8b735a5df94a68488c2b44d0e3646c038", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mzc1Njk2Ng==", "url": "https://github.com/apache/beam/pull/13517#discussion_r543756966", "bodyText": "We need to add some default anyway in case that docker-tag property is not given. Since we already use  project.sdk_version as a default for docker command, I choose the same default for dockerTag.", "author": "ihji", "createdAt": "2020-12-15T23:16:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mzc1MzAzNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mzc4MTcwMw==", "url": "https://github.com/apache/beam/pull/13517#discussion_r543781703", "bodyText": "oh, I see - I thought I hadn't seen it in the existing files but I only looked at the golang task. Can we do just the sdk_version tag then?", "author": "emilymye", "createdAt": "2020-12-16T00:15:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mzc1MzAzNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mzc5ODU1OA==", "url": "https://github.com/apache/beam/pull/13517#discussion_r543798558", "bodyText": "Done.", "author": "ihji", "createdAt": "2020-12-16T00:59:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mzc1MzAzNw=="}], "type": "inlineReview"}, {"oid": "880a6d7806d3946144535b34a864dedea3668a6a", "url": "https://github.com/apache/beam/commit/880a6d7806d3946144535b34a864dedea3668a6a", "message": "add comment, remove default latest tag", "committedDate": "2020-12-16T00:57:29Z", "type": "commit"}]}