{"pr_number": 12762, "pr_title": "[BEAM-10948] Ensuring that BigQuery jobs are tagged with the Dataflow step that launches them", "pr_createdAt": "2020-09-02T21:20:47Z", "pr_url": "https://github.com/apache/beam/pull/12762", "timeline": [{"oid": "afb923ded86e4e3b1d3cc8e7dab9d8a3fcd943c7", "url": "https://github.com/apache/beam/commit/afb923ded86e4e3b1d3cc8e7dab9d8a3fcd943c7", "message": "Adding step names to BQ jobs", "committedDate": "2020-09-02T21:19:45Z", "type": "commit"}, {"oid": "887382ac72a7a77538fcbf6f777302f2b910946e", "url": "https://github.com/apache/beam/commit/887382ac72a7a77538fcbf6f777302f2b910946e", "message": "fixup", "committedDate": "2020-09-02T22:22:18Z", "type": "commit"}, {"oid": "b1b1ae73d10d050b5b0fb572ceec2b1ee411627e", "url": "https://github.com/apache/beam/commit/b1b1ae73d10d050b5b0fb572ceec2b1ee411627e", "message": "Fixin step naming. Cannot add step name to BQ job name.", "committedDate": "2020-09-03T20:10:33Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzIzOTA4OA==", "url": "https://github.com/apache/beam/pull/12762#discussion_r483239088", "bodyText": "This is likely to cause the BQ job to fail. The step_name would need to be sanitized. For the cloud label format\nhttps://cloud.google.com/resource-manager/docs/creating-managing-labels#requirements\n\nKeys have a minimum length of 1 character and a maximum length of 63 characters, and cannot be empty. Values can be empty, and have a maximum length of 63 characters.\nKeys and values can contain only lowercase letters, numeric characters, underscores, and dashes. All characters must use UTF-8 encoding, and international characters are allowed.", "author": "ajamato", "createdAt": "2020-09-03T20:34:13Z", "path": "sdks/python/apache_beam/io/gcp/bigquery_io_metadata.py", "diffHunk": "@@ -64,6 +64,8 @@ def create_bigquery_io_metadata():\n     # As we do not want a bad label to fail the BQ job.\n     if _is_valid_cloud_label_value(dataflow_job_id):\n       kwargs['beam_job_id'] = dataflow_job_id\n+  if step_name:\n+    kwargs['step_name'] = step_name", "originalCommit": "b1b1ae73d10d050b5b0fb572ceec2b1ee411627e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzI0OTM3Nw==", "url": "https://github.com/apache/beam/pull/12762#discussion_r483249377", "bodyText": "You're right that we need to sanitize. The step name would be something like CustomerTransform/ReadFromBigquery/Read/_CustomBigQuertSouce. I can add sanitization to it.", "author": "pabloem", "createdAt": "2020-09-03T20:56:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzIzOTA4OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzI3NTE2MA==", "url": "https://github.com/apache/beam/pull/12762#discussion_r483275160", "bodyText": "I've added a sanitizer and a conditional append.", "author": "pabloem", "createdAt": "2020-09-03T21:56:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzIzOTA4OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzI0MDA2OQ==", "url": "https://github.com/apache/beam/pull/12762#discussion_r483240069", "bodyText": "Do we know the format of the step_name. Is this just what the SDK harness is referring to the step as?\nIIRC these did not reflect something meaningful, in the original graph to the user. So we probably don't want to show them\nI know the pcollections in python at least were very opaque \"pcollection1\", \"pcollection2\", etc.\nNormally we rely on the DF RunnerHarness to translate those before sending to the UI (ex: on metrics)", "author": "ajamato", "createdAt": "2020-09-03T20:36:16Z", "path": "sdks/python/apache_beam/io/gcp/bigquery_file_loads.py", "diffHunk": "@@ -826,7 +836,8 @@ def _load_data(\n             TriggerCopyJobs(\n                 create_disposition=self.create_disposition,\n                 write_disposition=self.write_disposition,\n-                test_client=self.test_client),\n+                test_client=self.test_client,\n+                step_name=step_name),", "originalCommit": "b1b1ae73d10d050b5b0fb572ceec2b1ee411627e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzI3NTMxOQ==", "url": "https://github.com/apache/beam/pull/12762#discussion_r483275319", "bodyText": "in this case I believe it's pretty useful. The step would be UserTransform/ReadFromBigQuery/_CustomBigQuerySource or whatever.", "author": "pabloem", "createdAt": "2020-09-03T21:56:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzI0MDA2OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzI0MDM2OQ==", "url": "https://github.com/apache/beam/pull/12762#discussion_r483240369", "bodyText": "Would you mind sharing the motivation with me on this. Its not entirely clear why you are making this change to me.\nCan you make equivalent changes in the Java implementation as well? For a consistent experience", "author": "ajamato", "createdAt": "2020-09-03T20:36:58Z", "path": "sdks/python/apache_beam/io/gcp/bigquery.py", "diffHunk": "@@ -625,6 +625,7 @@ def to_type_hint(self):\n \n \n class _CustomBigQuerySource(BoundedSource):\n+\n   def __init__(", "originalCommit": "b1b1ae73d10d050b5b0fb572ceec2b1ee411627e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzI3NjE5NA==", "url": "https://github.com/apache/beam/pull/12762#discussion_r483276194", "bodyText": "Yes, I'll make the change on the Java side as well.\nThis is part of a series of improvements to BQ. Part of the requirements is to include the launching step info along with the Dataflow job info.", "author": "pabloem", "createdAt": "2020-09-03T21:58:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzI0MDM2OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzI0MjU1OQ==", "url": "https://github.com/apache/beam/pull/12762#discussion_r483242559", "bodyText": "I looked at the file, and it seems like self.label not referenced anywhere else in the class, and I don't see a call to super ctor which would set it.\nIs this using a werid pattern, where something external is taking the object and attaching parameters to it?\nIs it possible to fix up that style, so there is a clear method or something we can see where it gets added extenrally?\nOr to t lease define a default, empty value with a comment saying how it gets set", "author": "ajamato", "createdAt": "2020-09-03T20:41:49Z", "path": "sdks/python/apache_beam/io/gcp/bigquery.py", "diffHunk": "@@ -1875,14 +1895,22 @@ def process(self, unused_element, signal):\n     temp_location = pcoll.pipeline.options.view_as(\n         GoogleCloudOptions).temp_location\n     gcs_location = self._get_destination_uri(temp_location)\n+    job_name = pcoll.pipeline.options.view_as(GoogleCloudOptions).job_name\n \n+    try:\n+      step_name = self.label", "originalCommit": "b1b1ae73d10d050b5b0fb572ceec2b1ee411627e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjM0MzczNQ==", "url": "https://github.com/apache/beam/pull/12762#discussion_r492343735", "bodyText": "This is set by the Python SDK as it expands transforms. It's definitely not orthodox to rely on it, and a little unusual.", "author": "pabloem", "createdAt": "2020-09-21T21:01:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzI0MjU1OQ=="}], "type": "inlineReview"}, {"oid": "fdc7b18aab1ddea17175151f6d943eb52c0645c2", "url": "https://github.com/apache/beam/commit/fdc7b18aab1ddea17175151f6d943eb52c0645c2", "message": "fixup", "committedDate": "2020-09-03T21:37:50Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTc0NTMwNA==", "url": "https://github.com/apache/beam/pull/12762#discussion_r489745304", "bodyText": "Ah, just remembered that I checked in helpers in both python and java a python/apache_beam/io/gcp/bigquery_io_metadata.py\nYou may want to move the santize function to those files.\n_is_valid_cloud_label_value", "author": "ajamato", "createdAt": "2020-09-16T20:48:45Z", "path": "sdks/python/apache_beam/io/gcp/bigquery_io_metadata.py", "diffHunk": "@@ -28,6 +28,11 @@\n _VALID_CLOUD_LABEL_PATTERN = re.compile(r'^[a-z0-9\\_\\-]{1,63}$')\n \n \n+def _sanitize_value(value):\n+  \"\"\"Sanitizes a value into a valid BigQuery label value.\"\"\"\n+  return re.sub('[^\\w-]+', '', value.lower().replace('/', '-'))[0:63]", "originalCommit": "fdc7b18aab1ddea17175151f6d943eb52c0645c2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjMzMjczMQ==", "url": "https://github.com/apache/beam/pull/12762#discussion_r492332731", "bodyText": "This is in bigquery_io_metadata. Thanks!", "author": "pabloem", "createdAt": "2020-09-21T20:39:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTc0NTMwNA=="}], "type": "inlineReview"}, {"oid": "5971ec692d3a5a522474147dd85339410aaa65c2", "url": "https://github.com/apache/beam/commit/5971ec692d3a5a522474147dd85339410aaa65c2", "message": "Fixup", "committedDate": "2020-09-21T20:48:53Z", "type": "commit"}, {"oid": "d4904c0b6c6e491af2db063c43324b60983590d6", "url": "https://github.com/apache/beam/commit/d4904c0b6c6e491af2db063c43324b60983590d6", "message": "fixup", "committedDate": "2020-09-21T22:21:58Z", "type": "commit"}, {"oid": "a5d802017ea8a99357cdf20a72380a3c2b453a22", "url": "https://github.com/apache/beam/commit/a5d802017ea8a99357cdf20a72380a3c2b453a22", "message": "fixup", "committedDate": "2020-09-22T00:47:18Z", "type": "commit"}]}