{"pr_number": 12605, "pr_title": "Copy subtransforms to output of translations.pipeline_from_stages()", "pr_createdAt": "2020-08-17T19:36:13Z", "pr_url": "https://github.com/apache/beam/pull/12605", "timeline": [{"oid": "f3d0298cba5013dc117038c8afc444d737793343", "url": "https://github.com/apache/beam/commit/f3d0298cba5013dc117038c8afc444d737793343", "message": "Copy subtransforms to output of translations.pipeline_from_stages()", "committedDate": "2020-08-17T17:58:07Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzE5ODIyNQ==", "url": "https://github.com/apache/beam/pull/12605#discussion_r473198225", "bodyText": "Given that the set of subtransformation is a tree (no cycles) we can get rid of this.", "author": "robertwb", "createdAt": "2020-08-19T17:19:01Z", "path": "sdks/python/apache_beam/runners/portability/fn_api_runner/translations.py", "diffHunk": "@@ -524,6 +524,22 @@ def add_parent(child, parent):\n         add_parent(parent, parents.get(parent))\n       components.transforms[parent].subtransforms.append(child)\n \n+  copied_subtransform_ids = set()", "originalCommit": "f3d0298cba5013dc117038c8afc444d737793343", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDI3NDc4NA==", "url": "https://github.com/apache/beam/pull/12605#discussion_r474274784", "bodyText": "Thanks! This simplifies things.", "author": "yifanmai", "createdAt": "2020-08-20T21:10:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzE5ODIyNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzIwMzg4NA==", "url": "https://github.com/apache/beam/pull/12605#discussion_r473203884", "bodyText": "I think we only want to copy sub-transforms of the transforms from line 552 above, perhaps move this logic up there? (Just a thought, maybe having the method be called (copy_subtransforms and having it copy (recursively) just the subtransforms could make this even easier to follow).", "author": "robertwb", "createdAt": "2020-08-19T17:28:29Z", "path": "sdks/python/apache_beam/runners/portability/fn_api_runner/translations.py", "diffHunk": "@@ -541,6 +557,14 @@ def add_parent(child, parent):\n     components.transforms[transform_id].CopyFrom(transform)\n     add_parent(transform_id, stage.parent)\n \n+  if partial:", "originalCommit": "f3d0298cba5013dc117038c8afc444d737793343", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDI3NDgyMQ==", "url": "https://github.com/apache/beam/pull/12605#discussion_r474274821", "bodyText": "Moved it back up and cleaned up the method.", "author": "yifanmai", "createdAt": "2020-08-20T21:10:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzIwMzg4NA=="}], "type": "inlineReview"}, {"oid": "4598d6f5ee40a6f856b0b881886bd6ef1876bdc3", "url": "https://github.com/apache/beam/commit/4598d6f5ee40a6f856b0b881886bd6ef1876bdc3", "message": "Clean up copy_subtransforms", "committedDate": "2020-08-20T21:09:15Z", "type": "commit"}, {"oid": "578d08b631a107a7e1526beeed9e25ece7be5715", "url": "https://github.com/apache/beam/commit/578d08b631a107a7e1526beeed9e25ece7be5715", "message": "lint", "committedDate": "2020-08-25T19:47:05Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjY5NDYwNQ==", "url": "https://github.com/apache/beam/pull/12605#discussion_r476694605", "bodyText": "Nit: You can move this up into the if partial block above.", "author": "robertwb", "createdAt": "2020-08-25T19:43:53Z", "path": "sdks/python/apache_beam/runners/portability/fn_api_runner/translations.py", "diffHunk": "@@ -540,6 +549,8 @@ def add_parent(child, parent):\n     transform_id = unique_name(components.transforms, stage.name)\n     components.transforms[transform_id].CopyFrom(transform)\n     add_parent(transform_id, stage.parent)\n+    if partial:\n+      copy_subtransforms(transform)", "originalCommit": "4598d6f5ee40a6f856b0b881886bd6ef1876bdc3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjY5NTkzMw==", "url": "https://github.com/apache/beam/pull/12605#discussion_r476695933", "bodyText": "14:14:31 apache_beam/runners/portability/fn_api_runner/translations.py:1485: error: syntax error in type comment 'Stage -> beam_runner_api_pb2.PTransform'  [syntax]\n14:14:31 apache_beam/runners/portability/fn_api_runner/translations.py:1485: note: Suggestion: wrap argument types in parentheses\n14:14:31 Found 1 error in 1 file (checked 719 source files)\n14:14:31 error: mypy exited with status 2\n14:14:32 ERROR: InvocationError for command /home/jenkins/jenkins-slave/workspace/beam_PreCommit_PythonLint_Commit/src/sdks/python/test-suites/tox/py37/build/srcs/sdks/python/target/.tox-py37-mypy/py37-mypy/bin/python setup.py mypy (exited with code 1)\n14:14:32 py37-mypy run-test-post: commands[0] | bash /home/jenkins/jenkins-slave/workspace/beam_PreCommit_PythonLint_Commit/src/sdks/python/test-suites/tox/py37/build/srcs/sdks/python/scripts/run_tox_cleanup.sh\n14:14:32 ___________________________________ summary ____________________________________\n14:14:32 ERROR:   py37-mypy: commands failed", "author": "robertwb", "createdAt": "2020-08-25T19:46:13Z", "path": "sdks/python/apache_beam/runners/portability/fn_api_runner/translations.py", "diffHunk": "@@ -1475,6 +1482,12 @@ def only_element(iterable):\n   return element\n \n \n+def only_transform(stage):\n+  # type: Stage -> beam_runner_api_pb2.PTransform", "originalCommit": "4598d6f5ee40a6f856b0b881886bd6ef1876bdc3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzUwODk3Ng==", "url": "https://github.com/apache/beam/pull/12605#discussion_r477508976", "bodyText": "Fixed.", "author": "yifanmai", "createdAt": "2020-08-26T18:40:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjY5NTkzMw=="}], "type": "inlineReview"}, {"oid": "ad51e78ba38d4fae0784cb5103adb677d6b85490", "url": "https://github.com/apache/beam/commit/ad51e78ba38d4fae0784cb5103adb677d6b85490", "message": "Fixes", "committedDate": "2020-08-26T18:40:34Z", "type": "commit"}, {"oid": "04096c6ae767a394220430493fe463dc51ae9743", "url": "https://github.com/apache/beam/commit/04096c6ae767a394220430493fe463dc51ae9743", "message": "Merge branch 'yifanmai/subtransforms' of https://github.com/yifanmai/beam into yifanmai/subtransforms", "committedDate": "2020-08-26T18:40:47Z", "type": "commit"}, {"oid": "233a6633db941f37972343d880486b041057627d", "url": "https://github.com/apache/beam/commit/233a6633db941f37972343d880486b041057627d", "message": "Ran yapf", "committedDate": "2020-08-26T18:45:36Z", "type": "commit"}, {"oid": "d4e80b6c333b0531c038d957a60ff6cb1e0c66b9", "url": "https://github.com/apache/beam/commit/d4e80b6c333b0531c038d957a60ff6cb1e0c66b9", "message": "Merge branch 'master' into yifanmai/subtransforms", "committedDate": "2020-08-28T16:12:56Z", "type": "commit"}]}