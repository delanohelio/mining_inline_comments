{"pr_number": 11163, "pr_title": "[BEAM-9548] Add better error handling to the TestStreamServiceController", "pr_createdAt": "2020-03-18T21:12:44Z", "pr_url": "https://github.com/apache/beam/pull/11163", "timeline": [{"oid": "4fa5ed4d7b694cdd57080a778517a0ea0b22a64d", "url": "https://github.com/apache/beam/commit/4fa5ed4d7b694cdd57080a778517a0ea0b22a64d", "message": "Add better error handling to the TestStreamServiceController\n\nChange-Id: I022f25840207eb6c931c97358f159f134393c180", "committedDate": "2020-03-23T17:49:19Z", "type": "commit"}, {"oid": "4fa5ed4d7b694cdd57080a778517a0ea0b22a64d", "url": "https://github.com/apache/beam/commit/4fa5ed4d7b694cdd57080a778517a0ea0b22a64d", "message": "Add better error handling to the TestStreamServiceController\n\nChange-Id: I022f25840207eb6c931c97358f159f134393c180", "committedDate": "2020-03-23T17:49:19Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njc2Njk4Ng==", "url": "https://github.com/apache/beam/pull/11163#discussion_r396766986", "bodyText": "I hadn't stopeed to think that labels are a file name too, huh? I guess the final file name is the PCollection variable name? If so, users may name their PCollections something that is not supported by the OS? (or maybe not since they have to be Python variable names?)\nAnyway this is not for this PR. But just to think about.", "author": "pabloem", "createdAt": "2020-03-23T21:26:50Z", "path": "sdks/python/apache_beam/runners/interactive/caching/streaming_cache.py", "diffHunk": "@@ -166,13 +169,15 @@ def _wait_until_file_exists(self, timeout_secs=30):\n \n     # Wait for up to `timeout_secs` for the file to be available.\n     start = time.time()\n-    path = os.path.join(self._cache_dir, *self._labels)\n-    while not os.path.exists(path):\n+    while not os.path.exists(self._path):\n       time.sleep(1)\n       if time.time() - start > timeout_timestamp_secs:\n+        from apache_beam.runners.interactive.pipeline_instrument import CacheKey\n+        pcollection_var = CacheKey.from_str(self._labels[-1]).var", "originalCommit": "4fa5ed4d7b694cdd57080a778517a0ea0b22a64d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzM0MjQxNg==", "url": "https://github.com/apache/beam/pull/11163#discussion_r397342416", "bodyText": "Yeah, because these are Python variables, they have very strict naming conventions which is ok to use for file names (alphanumeric with the addition of an underscore).", "author": "rohdesamuel", "createdAt": "2020-03-24T17:40:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njc2Njk4Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njc2NzkyNA==", "url": "https://github.com/apache/beam/pull/11163#discussion_r396767924", "bodyText": "Do we just skip? This may mean that the file is corrupted? Should we stop consuming (i.e. rethrow the exception)?", "author": "pabloem", "createdAt": "2020-03-23T21:28:49Z", "path": "sdks/python/apache_beam/runners/interactive/caching/streaming_cache.py", "diffHunk": "@@ -202,14 +207,24 @@ def _emit_from_file(self, fh, tail):\n         # The first line at pos = 0 is always the header. Read the line without\n         # the new line.\n         to_decode = line[:-1]\n-        if pos == 0:\n-          header = TestStreamFileHeader()\n-          header.ParseFromString(self._coder.decode(to_decode))\n-          yield header\n+        proto_cls = TestStreamFileHeader if pos == 0 else TestStreamFileRecord\n+        msg = self._try_parse_as(proto_cls, to_decode)\n+        if msg:\n+          yield msg\n         else:\n-          record = TestStreamFileRecord()\n-          record.ParseFromString(self._coder.decode(to_decode))\n-          yield record\n+          break\n+\n+  def _try_parse_as(self, proto_cls, to_decode):\n+    try:\n+      msg = proto_cls()\n+      msg.ParseFromString(self._coder.decode(to_decode))\n+    except DecodeError:\n+      _LOGGER.error(\n+          'Could not parse as %s. This can indicate that the cache is '\n+          'corruputed. Please restart the kernel. '\n+          '\\nfile: %s \\nmessage: %s', proto_cls, self._path, to_decode)\n+      msg = None", "originalCommit": "4fa5ed4d7b694cdd57080a778517a0ea0b22a64d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzM0NDQxMQ==", "url": "https://github.com/apache/beam/pull/11163#discussion_r397344411", "bodyText": "No, if we rethrow the exception, it will get handled by the GRPC layer above and get turned into gobbledygook. This does stop processing because it returns msg = None which breaks out of the loop.", "author": "rohdesamuel", "createdAt": "2020-03-24T17:43:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njc2NzkyNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjgxMDM0MA==", "url": "https://github.com/apache/beam/pull/11163#discussion_r396810340", "bodyText": "Same as above. Do we just log and not stop processing?", "author": "pabloem", "createdAt": "2020-03-23T23:06:56Z", "path": "sdks/python/apache_beam/runners/interactive/interactive_runner.py", "diffHunk": "@@ -170,8 +170,13 @@ def run_pipeline(self, pipeline, options):\n               user_pipeline)):\n         streaming_cache_manager = ie.current_env().cache_manager()\n         if streaming_cache_manager:\n+\n+          def exception_handler(e):\n+            _LOGGER.error(str(e))", "originalCommit": "4fa5ed4d7b694cdd57080a778517a0ea0b22a64d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzM0NzE2OQ==", "url": "https://github.com/apache/beam/pull/11163#discussion_r397347169", "bodyText": "For here, we this is caught at the TestStreamService level and for the same reason, we just log the error so that it's easier for the user to understand. Because it's caught at the service level, it means that we have already stopped processing.", "author": "rohdesamuel", "createdAt": "2020-03-24T17:47:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjgxMDM0MA=="}], "type": "inlineReview"}, {"oid": "792d0092ae28e2a25f9a6728e52b1b917a8261af", "url": "https://github.com/apache/beam/commit/792d0092ae28e2a25f9a6728e52b1b917a8261af", "message": "run tox\n\nChange-Id: I9f9122e19f38978696deeb1bfd68aab9b25285d9", "committedDate": "2020-03-24T19:18:44Z", "type": "commit"}]}