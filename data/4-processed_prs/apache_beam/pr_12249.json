{"pr_number": 12249, "pr_title": "Make tracking/cleanup of cache and in-environment states per pipeline", "pr_createdAt": "2020-07-14T00:54:03Z", "pr_url": "https://github.com/apache/beam/pull/12249", "timeline": [{"oid": "6af74af09471dfc24932225731d9c4461f2269b9", "url": "https://github.com/apache/beam/commit/6af74af09471dfc24932225731d9c4461f2269b9", "message": "Make tracking/cleanup of cache and in-environment states per pipeline\n\nChange-Id: I37c9a65c461d619cf7ae1f762eae54ba02091c38", "committedDate": "2020-07-14T01:29:46Z", "type": "commit"}, {"oid": "6af74af09471dfc24932225731d9c4461f2269b9", "url": "https://github.com/apache/beam/commit/6af74af09471dfc24932225731d9c4461f2269b9", "message": "Make tracking/cleanup of cache and in-environment states per pipeline\n\nChange-Id: I37c9a65c461d619cf7ae1f762eae54ba02091c38", "committedDate": "2020-07-14T01:29:46Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDUxOTE4Mw==", "url": "https://github.com/apache/beam/pull/12249#discussion_r454519183", "bodyText": "Do you need to call cleanup for evicted cache manager(s) ?", "author": "aaltay", "createdAt": "2020-07-14T17:23:30Z", "path": "sdks/python/apache_beam/runners/interactive/interactive_environment.py", "diffHunk": "@@ -286,24 +298,40 @@ def watching(self):\n         watching.append(vars(watchable).items())\n     return watching\n \n-  def set_cache_manager(self, cache_manager):\n-    \"\"\"Sets the cache manager held by current Interactive Environment.\"\"\"\n-    if self._cache_manager is cache_manager:\n+  def set_cache_manager(self, cache_manager, pipeline):\n+    \"\"\"Sets the cache manager held by current Interactive Environment for the\n+    given pipeline.\"\"\"\n+    if self.get_cache_manager(pipeline) is cache_manager:\n       # NOOP if setting to the same cache_manager.\n       return\n-    if self._cache_manager:\n+    if self.get_cache_manager(pipeline):\n       # Invoke cleanup routine when a new cache_manager is forcefully set and\n       # current cache_manager is not None.\n-      self.cleanup()\n-      atexit.unregister(self.cleanup)\n-    self._cache_manager = cache_manager\n-    if self._cache_manager:\n-      # Re-register cleanup routine for the new cache_manager if it's not None.\n-      atexit.register(self.cleanup)\n-\n-  def cache_manager(self):\n-    \"\"\"Gets the cache manager held by current Interactive Environment.\"\"\"\n-    return self._cache_manager\n+      self.cleanup(pipeline)\n+    self._cache_managers[str(id(pipeline))] = cache_manager\n+\n+  def get_cache_manager(self, pipeline, create_if_absent=False):\n+    \"\"\"Gets the cache manager held by current Interactive Environment for the\n+    given pipeline. If the pipeline is absent from the environment while\n+    create_if_absent is True, creates and returns a new file based cache\n+    manager for the pipeline.\"\"\"\n+    cache_manager = self._cache_managers.get(str(id(pipeline)), None)\n+    if not cache_manager and create_if_absent:\n+      cache_dir = tempfile.mkdtemp(\n+          suffix=str(id(pipeline)),\n+          prefix='interactive-temp-',\n+          dir=os.environ.get('TEST_TMPDIR', None))\n+      cache_manager = cache.FileBasedCacheManager(cache_dir)\n+      self._cache_managers[str(id(pipeline))] = cache_manager\n+    return cache_manager\n+\n+  def evict_cache_manager(self, pipeline=None):\n+    \"\"\"Evicts the cache manager held by current Interactive Environment for the\n+    given pipeline. Noop if the pipeline is absent from the environment. If no\n+    pipeline is specified, evicts for all pipelines.\"\"\"", "originalCommit": "6af74af09471dfc24932225731d9c4461f2269b9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDUzOTg4Nw==", "url": "https://github.com/apache/beam/pull/12249#discussion_r454539887", "bodyText": "Thanks! Yes, I'll add a cleanup here.", "author": "KevinGG", "createdAt": "2020-07-14T17:56:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDUxOTE4Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDUyMzM4NA==", "url": "https://github.com/apache/beam/pull/12249#discussion_r454523384", "bodyText": "Do you need this? You can change L569 to use create_if_absent=True instead.", "author": "aaltay", "createdAt": "2020-07-14T17:29:58Z", "path": "sdks/python/apache_beam/runners/interactive/pipeline_instrument.py", "diffHunk": "@@ -556,19 +556,26 @@ def _process(self, pcoll):\n             if not self._pin._user_pipeline:\n               # Retrieve a reference to the user defined pipeline instance.\n               self._pin._user_pipeline = user_pcoll.pipeline\n-              # Once user_pipeline is retrieved, check if the user pipeline\n-              # contains any source to cache. If so, current cache manager held\n-              # by current interactive environment might get wrapped into a\n-              # streaming cache, thus re-assign the reference to that cache\n-              # manager.\n+              # Retrieve a reference to the cache manager for the user defined\n+              # pipeline instance.\n+              self._pin._cache_manager = ie.current_env().get_cache_manager(", "originalCommit": "6af74af09471dfc24932225731d9c4461f2269b9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDU0NTYxMw==", "url": "https://github.com/apache/beam/pull/12249#discussion_r454545613", "bodyText": "L569 might not get executed at all if the background_caching_job does not has_source_to_cache. This line makes sure the cache manager is initialized (if never initialized before) in either conditions.", "author": "KevinGG", "createdAt": "2020-07-14T18:05:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDUyMzM4NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDY4NzAzMw==", "url": "https://github.com/apache/beam/pull/12249#discussion_r454687033", "bodyText": "Does it matter though, because then there will be L577 to initialize? Is there a case if not self._user_pipeline: would not be true in the first run?", "author": "aaltay", "createdAt": "2020-07-14T22:43:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDUyMzM4NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDcwNzkxOQ==", "url": "https://github.com/apache/beam/pull/12249#discussion_r454707919", "bodyText": "This line is the \"official\" way within the module to initialize the cache manager.\n(Outside the module, each time a user appends a PTransform, a cache manager will be created_if_absent for the user defined pipeline)\nTL;DR: L577 is only a fallback when the user defined pipeline cannot be identified from the given pipeline. It might not get executed either.\nThere are 2 scenarios that the user defined pipeline can not be identified:\n\nThe given pipeline is empty without any PCollection in it.\nThe given pipeline is the user defined pipeline (would not happen internally except tests).\n\nIn either scenarios, use the given pipeline as the user pipeline as a fallback last resort.", "author": "KevinGG", "createdAt": "2020-07-14T23:45:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDUyMzM4NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDUyMzg3MQ==", "url": "https://github.com/apache/beam/pull/12249#discussion_r454523871", "bodyText": "Do you need to check that cache_manager is not None?", "author": "aaltay", "createdAt": "2020-07-14T17:30:43Z", "path": "sdks/python/apache_beam/runners/interactive/interactive_runner.py", "diffHunk": "@@ -259,7 +247,8 @@ def read(self, pcoll, include_window_info=False):\n     WindowedValues. Otherwise, return the element as itself.\n     \"\"\"\n     key = self._pipeline_instrument.cache_key(pcoll)\n-    cache_manager = ie.current_env().cache_manager()\n+    cache_manager = ie.current_env().get_cache_manager(\n+        self._pipeline_instrument.user_pipeline)\n     if cache_manager.exists('full', key):", "originalCommit": "6af74af09471dfc24932225731d9c4461f2269b9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDU0MzIyMA==", "url": "https://github.com/apache/beam/pull/12249#discussion_r454543220", "bodyText": "That is not needed since PipelineResult takes in the PipelineInstrument in the constructor. The cache manager must have been initialized during the instrumenting.", "author": "KevinGG", "createdAt": "2020-07-14T18:01:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDUyMzg3MQ=="}], "type": "inlineReview"}, {"oid": "370fbc942927964930a0807e30a910ea47ed669f", "url": "https://github.com/apache/beam/commit/370fbc942927964930a0807e30a910ea47ed669f", "message": "Added cleanup when evicting cache_managers\n\nChange-Id: Ie6ef39594bbd99168ddb25816dcffa91e5143ec0", "committedDate": "2020-07-14T18:26:54Z", "type": "commit"}]}