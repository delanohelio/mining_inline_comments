{"pr_number": 11502, "pr_title": "[BEAM-9797] use virtualenv for Java license pulling", "pr_createdAt": "2020-04-22T22:21:17Z", "pr_url": "https://github.com/apache/beam/pull/11502", "timeline": [{"oid": "b0ae8d0117641fea7c35d61a1ddbf6d834828ad0", "url": "https://github.com/apache/beam/commit/b0ae8d0117641fea7c35d61a1ddbf6d834828ad0", "message": "use tox for license pulling", "committedDate": "2020-04-22T22:25:52Z", "type": "forcePushed"}, {"oid": "5283245656cebd10e3319f4fba13f57e0d43a9a9", "url": "https://github.com/apache/beam/commit/5283245656cebd10e3319f4fba13f57e0d43a9a9", "message": "use tox for license pulling", "committedDate": "2020-04-22T22:28:36Z", "type": "forcePushed"}, {"oid": "fc6d0ee8c573ba4dd50191c75f8c5cf2a43fb519", "url": "https://github.com/apache/beam/commit/fc6d0ee8c573ba4dd50191c75f8c5cf2a43fb519", "message": "use tox for license pulling", "committedDate": "2020-04-22T22:29:55Z", "type": "forcePushed"}, {"oid": "11079e3dd5c8e3e2970dc2ac4f219173afa456b4", "url": "https://github.com/apache/beam/commit/11079e3dd5c8e3e2970dc2ac4f219173afa456b4", "message": "use tox for license pulling", "committedDate": "2020-04-22T23:06:56Z", "type": "forcePushed"}, {"oid": "5bbf32dd2ba727f9125d63d2c9a8fc07ebfb2752", "url": "https://github.com/apache/beam/commit/5bbf32dd2ba727f9125d63d2c9a8fc07ebfb2752", "message": "use tox for license pulling", "committedDate": "2020-04-23T21:51:28Z", "type": "forcePushed"}, {"oid": "05f5a6684e53f9d9eeae7dc808acee3f2907b0ff", "url": "https://github.com/apache/beam/commit/05f5a6684e53f9d9eeae7dc808acee3f2907b0ff", "message": "use tox for license pulling", "committedDate": "2020-04-23T22:08:23Z", "type": "forcePushed"}, {"oid": "3b71cbd59599aff0654c2b449e4e4b9e5559c943", "url": "https://github.com/apache/beam/commit/3b71cbd59599aff0654c2b449e4e4b9e5559c943", "message": "use tox for license pulling", "committedDate": "2020-04-23T22:35:03Z", "type": "forcePushed"}, {"oid": "1e037036cb3a73914d87e606871a08537ba8805d", "url": "https://github.com/apache/beam/commit/1e037036cb3a73914d87e606871a08537ba8805d", "message": "use tox for license pulling", "committedDate": "2020-04-23T22:48:31Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDIwNzI0Mg==", "url": "https://github.com/apache/beam/pull/11502#discussion_r414207242", "bodyText": "The solution could be to do something like:\n# Creates a new directory $env_path and installs a virtual environment in it.\nenv_path=$ROOT_DIR/build/license_scripts_env\nvirtualenv $env_path --python python3.7\nsource $env_path/bin/activate\n# Install tox, or just install the packages directly. Might be less complicated to skip using tox in this case.\npip install ...", "author": "udim", "createdAt": "2020-04-24T00:14:39Z", "path": "sdks/java/container/license_scripts/license_script.sh", "diffHunk": "@@ -15,39 +15,33 @@\n  # limitations under the License.\n \n set -e\n+ROOT_DIR=$(pwd)\n+CONTAINER_DIR=\"$ROOT_DIR/sdks/java/container\"\n+\n # reports are generated at ~/beam/java_third_party_licenses\n ./gradlew generateLicenseReport --rerun-tasks\n \n-# install packages needed for pull_licenses_java.py\n-pip install \"beautifulsoup4>=4.9.0,<5.0\"\n-pip install \"future>=0.16.0,<1.0.0\"\n-pip install \"pyyaml>=3.12,<6.0.0\"\n-pip install \"tenacity>=5.0.2,<6.0\"\n+# pip install 'tox>=3.14.6,<3.15.0'\n+pip install --no-cache-dir tox==3.11.1", "originalCommit": "1e037036cb3a73914d87e606871a08537ba8805d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDIwODk0MA==", "url": "https://github.com/apache/beam/pull/11502#discussion_r414208940", "bodyText": "This needs to install virtualenv and changes user environment as well. How about keep the original approach (installing pyyaml, tenacity etc) but remove the uninstall part to avoid race conditions?", "author": "Hannah-Jiang", "createdAt": "2020-04-24T00:19:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDIwNzI0Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDIwOTgxMw==", "url": "https://github.com/apache/beam/pull/11502#discussion_r414209813", "bodyText": "and probably, using tox or virtualenv installs more packages then the original approach.", "author": "Hannah-Jiang", "createdAt": "2020-04-24T00:21:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDIwNzI0Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDIxMjY5MQ==", "url": "https://github.com/apache/beam/pull/11502#discussion_r414212691", "bodyText": "The virtualenv command should already be installed, and all the changes it makes are limited to the given directory.\nOnce you run the activate command pip install will no longer change the user environment.\nActually, according to Beam's guide, Python 3 already has a built-in virtualenv tool:\npython3 -m venv env && source env/bin/activate\n\nhttps://beam.apache.org/documentation/sdks/python-dependencies/", "author": "udim", "createdAt": "2020-04-24T00:30:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDIwNzI0Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDIxNjk1Nw==", "url": "https://github.com/apache/beam/pull/11502#discussion_r414216957", "bodyText": "ok, I will try with virtualenv.", "author": "Hannah-Jiang", "createdAt": "2020-04-24T00:43:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDIwNzI0Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDI3Nzg1NQ==", "url": "https://github.com/apache/beam/pull/11502#discussion_r414277855", "bodyText": "I tried with virtureenv. It works fine locally, but fails with Jenkins.\nTry1:\npython3 -m venv env && source env/bin/activate\n\nError:\n21:01:17 The virtual environment was not created successfully because ensurepip is not\n21:01:17 available.  On Debian/Ubuntu systems, you need to install the python3-venv\n21:01:17 package using the following command.\n21:01:17 \n21:01:17     apt-get install python3-venv\n21:01:17 \n21:01:17 You may need to use sudo with that command.  After installing the python3-venv\n21:01:17 package, recreate your virtual environment.\n21:01:17 \n21:01:17 Failing command: ['/home/jenkins/jenkins-slave/workspace/beam_PreCommit_Java_Commit/src/env/bin/python3', '-Im', 'ensurepip', '--upgrade', '--default-pip']\n\nIt failed to create virtueenv and ran with default local python env, which is py2.7.\nTry2:\npython3 -m venv env && source env/bin/activate || pip install virtualenv && virtualenv env && source env/bin/activate\n\nOk, this time, if virtueenv with py3 fails, create it with py2. Both commands failed and ran at default py env.\nError: link\n20:24:40 Using base prefix '/usr'\n20:24:40 New python executable in /home/jenkins/jenkins-slave/workspace/beam_PreCommit_Java_Commit/src/env/bin/python3\n20:24:41 Traceback (most recent call last):\n20:24:41   File \"/usr/local/bin/virtualenv\", line 11, in <module>\n20:24:41     sys.exit(main())\n20:24:41   File \"/usr/local/lib/python3.5/dist-packages/virtualenv.py\", line 793, in main\n20:24:41     symlink=options.symlink,\n20:24:41   File \"/usr/local/lib/python3.5/dist-packages/virtualenv.py\", line 1071, in create_environment\n20:24:41     install_python(home_dir, lib_dir, inc_dir, bin_dir, site_packages=site_packages, clear=clear, symlink=symlink)\n20:24:41   File \"/usr/local/lib/python3.5/dist-packages/virtualenv.py\", line 1457, in install_python\n20:24:41     shutil.copyfile(executable, py_executable)\n20:24:41   File \"/usr/lib/python3.5/shutil.py\", line 98, in copyfile\n20:24:41     raise SameFileError(\"{!r} and {!r} are the same file\".format(src, dst))\n20:24:41 shutil.SameFileError: '/usr/bin/python3' and '/home/jenkins/jenkins-slave/workspace/beam_PreCommit_Java_Commit/src/env/bin/python3' are the same file\n\nTry3:\napt-get install python3-venv\npython3 -m venv env && source env/bin/activate\n\nIn order to apt-get install, need to run with sudo.\nTry4:\nsudo apt-get install python3-venv\npython3 -m venv env && source env/bin/activate\n\nAdded sudo, and it asks to input password and failed.", "author": "Hannah-Jiang", "createdAt": "2020-04-24T04:09:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDIwNzI0Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDc1NjAyMg==", "url": "https://github.com/apache/beam/pull/11502#discussion_r414756022", "bodyText": "My fault, I didn't know python3 venv wasn't properly installed on our Jenkins nodes.\nOur gradle scripts for Python tests use the virtualenv command.\nJenkins jobs should not be installing system-wide packages.", "author": "udim", "createdAt": "2020-04-24T17:50:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDIwNzI0Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDkzMDU3Nw==", "url": "https://github.com/apache/beam/pull/11502#discussion_r414930577", "bodyText": "ok, virtualenv worked.\nPlease take a look the PR when you have time.", "author": "Hannah-Jiang", "createdAt": "2020-04-25T00:17:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDIwNzI0Mg=="}], "type": "inlineReview"}, {"oid": "7400a017179f12c8ede11419b58a24a86b0e29dc", "url": "https://github.com/apache/beam/commit/7400a017179f12c8ede11419b58a24a86b0e29dc", "message": "use virtualenv", "committedDate": "2020-04-24T03:40:08Z", "type": "forcePushed"}, {"oid": "c8052cd4914158516d2f01b26cf149d63fb6bed7", "url": "https://github.com/apache/beam/commit/c8052cd4914158516d2f01b26cf149d63fb6bed7", "message": "use virtualenv", "committedDate": "2020-04-24T03:55:03Z", "type": "forcePushed"}, {"oid": "152e8894f2f7f2e41f6954c6c55e57b5806eccd5", "url": "https://github.com/apache/beam/commit/152e8894f2f7f2e41f6954c6c55e57b5806eccd5", "message": "virtualenv", "committedDate": "2020-04-24T23:20:58Z", "type": "forcePushed"}, {"oid": "327f5b63469e7bfa59ae9d3e2264ed16343a8cf5", "url": "https://github.com/apache/beam/commit/327f5b63469e7bfa59ae9d3e2264ed16343a8cf5", "message": "virtualenv", "committedDate": "2020-04-24T23:29:49Z", "type": "forcePushed"}, {"oid": "436997c1776e2fcece0395dbcadedb8cb97a6dc7", "url": "https://github.com/apache/beam/commit/436997c1776e2fcece0395dbcadedb8cb97a6dc7", "message": "virtualenv", "committedDate": "2020-04-25T00:11:53Z", "type": "commit"}, {"oid": "436997c1776e2fcece0395dbcadedb8cb97a6dc7", "url": "https://github.com/apache/beam/commit/436997c1776e2fcece0395dbcadedb8cb97a6dc7", "message": "virtualenv", "committedDate": "2020-04-25T00:11:53Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzY4NjI2Mw==", "url": "https://github.com/apache/beam/pull/11502#discussion_r417686263", "bodyText": "@Hannah-Jiang @udim should we keep the py2 imports for now? I still have python 2 as the default python on my machine, so this change broke :sdks:java:container:docker for me\nOr maybe I should have changed the default by now?", "author": "TheNeuralBit", "createdAt": "2020-04-30T00:19:31Z", "path": "sdks/java/container/license_scripts/pull_licenses_java.py", "diffHunk": "@@ -35,18 +35,9 @@\n from tenacity import retry\n from tenacity import stop_after_attempt\n from tenacity import wait_exponential\n+from urllib.request import urlopen, URLError, HTTPError\n+\n \n-try:\n-    # py2\n-    from future.moves.urllib.request import urlopen\n-    from future.moves.urllib.request import URLError, HTTPError\n-except:\n-    # py3\n-    from future import standard_library\n-    from urllib.request import urlopen, URLError, HTTPError", "originalCommit": "436997c1776e2fcece0395dbcadedb8cb97a6dc7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzY5NjM1NQ==", "url": "https://github.com/apache/beam/pull/11502#discussion_r417696355", "bodyText": "This is running in a virtualenv as implemented here.\nWhen I check locally with py2, it created py3.7 env. Default Python version on Jenkins is also 2.7 and the script run successfully. Maybe in both cases, Python3 was installed on the machine, so it is able to create virtualenv with Python3?\nCan you please check what version of Python was installed at sdks/java/container/build/virtualenv?", "author": "Hannah-Jiang", "createdAt": "2020-04-30T00:55:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzY4NjI2Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzcwNDE0Nw==", "url": "https://github.com/apache/beam/pull/11502#discussion_r417704147", "bodyText": "Does  adding --python=python3 to the virtualenv command fix this for you, Brian?", "author": "udim", "createdAt": "2020-04-30T01:24:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzY4NjI2Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODE2MzUyNw==", "url": "https://github.com/apache/beam/pull/11502#discussion_r418163527", "bodyText": "Can you please check what version of Python was installed at sdks/java/container/build/virtualenv?\n\n\u276f ./sdks/java/container/build/virtualenv/bin/python --version\nPython 2.7.18rc1\n\nIf this is working for others maybe I just have something else wrong with my setup...\n\nDoes adding --python=python3 to the virtualenv command fix this for you, Brian?\n\nyeah that's what I did to get it passing. I thought about putting up a PR for the change, but not sure if that's a universal solution or not.", "author": "TheNeuralBit", "createdAt": "2020-04-30T17:13:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzY4NjI2Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODE3ODE2Ng==", "url": "https://github.com/apache/beam/pull/11502#discussion_r418178166", "bodyText": "I think your setup is fine - it defaults to Python 2. Since the from urllib.request import urlopen, URLError, HTTPErro line doesn't work on 2.x, adding the flag should be a universal solution.", "author": "udim", "createdAt": "2020-04-30T17:38:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzY4NjI2Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODE4MTU4OQ==", "url": "https://github.com/apache/beam/pull/11502#discussion_r418181589", "bodyText": "Well what I'm wondering is if --python=python3 always works, or if it only works if you have a python3 symlink, etc...", "author": "TheNeuralBit", "createdAt": "2020-04-30T17:44:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzY4NjI2Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODE4NzMxNA==", "url": "https://github.com/apache/beam/pull/11502#discussion_r418187314", "bodyText": "Yes, we use it elsewhere in our build (BeamModulePlugin.groovy)", "author": "udim", "createdAt": "2020-04-30T17:53:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzY4NjI2Mw=="}], "type": "inlineReview"}]}