{"pr_number": 178, "pr_title": "Importing creates content:// for attached pictures and exporting with\u2026", "pr_createdAt": "2020-04-07T19:36:33Z", "pr_url": "https://github.com/OpenTracksApp/OpenTracks/pull/178", "timeline": [{"oid": "4e8496fba82c488a8354411da27eb44121f0ea03", "url": "https://github.com/OpenTracksApp/OpenTracks/commit/4e8496fba82c488a8354411da27eb44121f0ea03", "message": "Importing creates content:// for attached pictures. Also, exporting without points bug fixed and images href contains relative link. Fixes #166 and #176.", "committedDate": "2020-04-08T16:42:07Z", "type": "forcePushed"}, {"oid": "4e8496fba82c488a8354411da27eb44121f0ea03", "url": "https://github.com/OpenTracksApp/OpenTracks/commit/4e8496fba82c488a8354411da27eb44121f0ea03", "message": "Importing creates content:// for attached pictures. Also, exporting without points bug fixed and images href contains relative link. Fixes #166 and #176.", "committedDate": "2020-04-08T16:42:07Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTY4NTk3MQ==", "url": "https://github.com/OpenTracksApp/OpenTracks/pull/178#discussion_r405685971", "bodyText": "I know it was not handled before, but what happens if the URL is invalid?", "author": "dennisguse", "createdAt": "2020-04-08T17:17:29Z", "path": "src/main/java/de/dennisguse/opentracks/io/file/exporter/KmlTrackWriter.java", "diffHunk": "@@ -345,7 +347,7 @@ private void writePhotoOverlay(String name, String category, String description,\n             writeCategory(category);\n \n             if (exportPhotos) {\n-                printWriter.println(\"<Icon><href>\" + Uri.decode(photoUrl) + \"</href></Icon>\");", "originalCommit": "4e8496fba82c488a8354411da27eb44121f0ea03", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTcyMTY0Nw==", "url": "https://github.com/OpenTracksApp/OpenTracks/pull/178#discussion_r405721647", "bodyText": "If it's not valid then Marker not show the photo (obviously) because the importer expect that the \"last path segment\" was valid (we would have a broken link).\nI don't know how importer can check it because in the importing process firstly it creates the URI and later copy images to internal memory.\nThe same for the exporter: firstly creates the URL and then copy the files inside \"images\".", "author": "rgmf", "createdAt": "2020-04-08T18:17:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTY4NTk3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTc4MzYzNA==", "url": "https://github.com/OpenTracksApp/OpenTracks/pull/178#discussion_r405783634", "bodyText": "So, we should first the get all files and the parse the KML, right?\nThen we can copy the used files into the app-external directory.\nFor now, I guess, we should just apply a your fix now (then release v3.6) and then rework this properly afterwards.\nAbout the writer: I would prefer to be careful as we never now what is actually in the database (and what some previous OpenTracks version actually did).\n@rgmf What do you think?", "author": "dennisguse", "createdAt": "2020-04-08T20:09:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTY4NTk3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTgwNDc4Mg==", "url": "https://github.com/OpenTracksApp/OpenTracks/pull/178#discussion_r405804782", "bodyText": "For now, I guess, we should just apply a your fix now (then release v3.6) and then rework this > properly afterwards.\n\nOk @dennisguse\n\nSo, we should first the get all files and the parse the KML, right?\nThen we can copy the used files into the app-external directory.\n\nChecking that URLs are valid ones need more time.\nDoing so in the importer seems feasible.\nBut in the exporter seems more difficult because it writes the kml file first and if it success then write images. If you write images firstly and then you write kml file then you have to delete images if kml file couldn't be written. Anyway I have to deep on that.\n\nAbout the writer: I would prefer to be careful as we never now what is actually in the database (and what some previous OpenTracks version actually did).\n\nWriter get track, trackpoint and waypoint from database and write them out to the kml file. The only transformation I do is the photoUrl value. In the database is a file:// or a content:// and in the kml file will be a relative path with the same name.\nExport works with file:// and content://\nImport now generates only content://\nWhy do you think we should careful with the writer?", "author": "rgmf", "createdAt": "2020-04-08T20:47:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTY4NTk3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTgxMjMzOQ==", "url": "https://github.com/OpenTracksApp/OpenTracks/pull/178#discussion_r405812339", "bodyText": "About the exporter: in the future, we might change photoUrl to just contain the actual filename and not storing the whole content-URL.\nAnd existing installations of OpenTracks might contain some weird things in their databases - there weren't to many changes regarding photoUrl.\nI guess the biggest one was migration to Storage Access Framework.\nSo, basically we should keep it in mind to not rely too much on the current implementation, but also expects some quirks introduced by previous versions.", "author": "dennisguse", "createdAt": "2020-04-08T21:01:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTY4NTk3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTgxNzQ5Ng==", "url": "https://github.com/OpenTracksApp/OpenTracks/pull/178#discussion_r405817496", "bodyText": "Ok, tomorrow I'll open an Issue to write down all these changes and I'm going to work on it.", "author": "rgmf", "createdAt": "2020-04-08T21:11:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTY4NTk3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTk2NjAzOA==", "url": "https://github.com/OpenTracksApp/OpenTracks/pull/178#discussion_r405966038", "bodyText": "And there is another change that affected photoUrl (use of a FileProvider to get images from the camera):\n828a19a\nIt was released with the very first OpenTracks version (v3.0.0).", "author": "dennisguse", "createdAt": "2020-04-09T05:35:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTY4NTk3MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTY4NjYzMA==", "url": "https://github.com/OpenTracksApp/OpenTracks/pull/178#discussion_r405686630", "bodyText": "Better use: \"\"  + photoUri to avoid NullPointer.", "author": "dennisguse", "createdAt": "2020-04-08T17:18:28Z", "path": "src/main/java/de/dennisguse/opentracks/io/file/importer/AbstractFileTrackImporter.java", "diffHunk": "@@ -372,9 +372,13 @@ protected String getPhotoUrl(String fileName) {\n         if (importTrackId == -1L) {\n             return null;\n         }\n+\n         File dir = FileUtils.getPhotoDir(context, importTrackId);\n         File file = new File(dir, fileName);\n-        return Uri.fromFile(file).toString();\n+\n+        Uri photoUri = FileUtils.getUriForFile(context, file);\n+\n+        return photoUri.toString();", "originalCommit": "4e8496fba82c488a8354411da27eb44121f0ea03", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTY4NzA3MQ==", "url": "https://github.com/OpenTracksApp/OpenTracks/pull/178#discussion_r405687071", "bodyText": "Uri parsing might fail and there might be no path.\nAnd as we are importing here something from somewhere, we should check this carefully.", "author": "dennisguse", "createdAt": "2020-04-08T17:19:11Z", "path": "src/main/java/de/dennisguse/opentracks/io/file/importer/KmlFileTrackImporter.java", "diffHunk": "@@ -186,9 +186,9 @@ private void onWaypointEnd() throws SAXException {\n             return;\n         }\n \n+        // If there is photoUrl it has to be changed because that url in kml file isn't a valid content:// to the imported one.\n         if (photoUrl != null) {\n-            Uri uri = Uri.parse(photoUrl);\n-            photoUrl = getPhotoUrl(uri.getLastPathSegment());\n+            photoUrl = getPhotoUrl(Uri.parse(photoUrl).getLastPathSegment());", "originalCommit": "4e8496fba82c488a8354411da27eb44121f0ea03", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "a1ec4293881cd446d4dc1128ad81d5c78fbe474c", "url": "https://github.com/OpenTracksApp/OpenTracks/commit/a1ec4293881cd446d4dc1128ad81d5c78fbe474c", "message": "Avoid NullPointer in creating photoUrl when importing", "committedDate": "2020-04-09T09:34:52Z", "type": "commit"}, {"oid": "cecdc164a7f02626fc8d2f47c647b3e45a5edbd8", "url": "https://github.com/OpenTracksApp/OpenTracks/commit/cecdc164a7f02626fc8d2f47c647b3e45a5edbd8", "message": "While importing photos, check url carefully.\n\n(cherry picked from commit 309c96e4789bd7623b84720a8c8f2bf297c95d59)", "committedDate": "2020-04-10T08:27:07Z", "type": "commit"}]}