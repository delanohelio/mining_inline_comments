{"pr_number": 519, "pr_title": "Import marker photos", "pr_createdAt": "2020-11-14T19:25:50Z", "pr_url": "https://github.com/OpenTracksApp/OpenTracks/pull/519", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzc3MDgyNw==", "url": "https://github.com/OpenTracksApp/OpenTracks/pull/519#discussion_r523770827", "bodyText": "This try-catch is not doing anything.\nIs it not necessary to cleanup the failed import on exception?", "author": "dennisguse", "createdAt": "2020-11-15T15:04:53Z", "path": "src/main/java/de/dennisguse/opentracks/io/file/importer/KmzTrackImporter.java", "diffHunk": "@@ -69,20 +68,18 @@ public KmzTrackImporter(Context context, Uri uriFile) {\n     public Track.Id importFile(InputStream inputStream) {\n         Track.Id trackId;\n \n-        if (!copyKmzImages()) {\n-            cleanImport(context, importTrackId);\n-            return null;\n-        }\n-\n         try {\n             trackId = findAndParseKmlFile(inputStream);\n         } catch (Exception e) {\n-            cleanImport(context, importTrackId);\n             throw e;", "originalCommit": "eb9889c763739fb4a67c3c475631f8fb45a28b5a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzc3MjgzMQ==", "url": "https://github.com/OpenTracksApp/OpenTracks/pull/519#discussion_r523772831", "bodyText": "The cleanImport needs the track id but if findAndParseKmlFile fails then trackId is not known (now the track is created after import is finishes).", "author": "rgmf", "createdAt": "2020-11-15T15:21:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzc3MDgyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzc3MzYzNQ==", "url": "https://github.com/OpenTracksApp/OpenTracks/pull/519#discussion_r523773635", "bodyText": "Then we still don't need to catch the exception and throw the same one - so we can remove this try catch, right?", "author": "dennisguse", "createdAt": "2020-11-15T15:28:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzc3MDgyNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzc3MDk4NQ==", "url": "https://github.com/OpenTracksApp/OpenTracks/pull/519#discussion_r523770985", "bodyText": "I guess this should not happen.\nWe could improve this by making findAndParseKmlFile to always throw an exception if it would not return a trackId.", "author": "dennisguse", "createdAt": "2020-11-15T15:06:13Z", "path": "src/main/java/de/dennisguse/opentracks/io/file/importer/KmzTrackImporter.java", "diffHunk": "@@ -69,20 +68,18 @@ public KmzTrackImporter(Context context, Uri uriFile) {\n     public Track.Id importFile(InputStream inputStream) {\n         Track.Id trackId;\n \n-        if (!copyKmzImages()) {\n-            cleanImport(context, importTrackId);\n-            return null;\n-        }\n-\n         try {\n             trackId = findAndParseKmlFile(inputStream);\n         } catch (Exception e) {\n-            cleanImport(context, importTrackId);\n             throw e;\n         }\n \n         if (trackId == null) {", "originalCommit": "eb9889c763739fb4a67c3c475631f8fb45a28b5a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzc3NjA5Mw==", "url": "https://github.com/OpenTracksApp/OpenTracks/pull/519#discussion_r523776093", "bodyText": "What exception should it throw if not trackId won't be returned? RuntimeException?", "author": "rgmf", "createdAt": "2020-11-15T15:50:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzc3MDk4NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzc3MTA1Ng==", "url": "https://github.com/OpenTracksApp/OpenTracks/pull/519#discussion_r523771056", "bodyText": "fileNameUri should be @nonnull and the null check should be done by the caller (if needed).", "author": "dennisguse", "createdAt": "2020-11-15T15:06:47Z", "path": "src/main/java/de/dennisguse/opentracks/util/FileUtils.java", "diffHunk": "@@ -289,6 +289,30 @@ public static File getPhotoFileIfExists(Context context, Track.Id trackId, Uri u\n         return file;\n     }\n \n+    /**\n+     * Builds interval photo file object for fileNameUri Uri.\n+     *\n+     * @param context     the Context.\n+     * @param trackId     the id of the Track.\n+     * @param fileNameUri the file name uri.\n+     * @return            file object or null.\n+     */\n+    public static File buildInternalPhotoFile(Context context, Track.Id trackId, Uri fileNameUri) {", "originalCommit": "eb9889c763739fb4a67c3c475631f8fb45a28b5a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzc3MTI5Mg==", "url": "https://github.com/OpenTracksApp/OpenTracks/pull/519#discussion_r523771292", "bodyText": "Attribute must be removed completely (it is always null) and we have an if (importTrackId == null) on this class.", "author": "dennisguse", "createdAt": "2020-11-15T15:09:00Z", "path": "src/main/java/de/dennisguse/opentracks/io/file/importer/AbstractFileTrackImporter.java", "diffHunk": "@@ -104,11 +104,6 @@\n         this.recordingDistanceInterval = PreferencesUtils.getRecordingDistanceInterval(context);\n     }\n \n-    AbstractFileTrackImporter(Context context, ContentProviderUtils contentProviderUtils, Track.Id importTrackId) {\n-        this(context, contentProviderUtils);\n-        this.importTrackId = importTrackId;", "originalCommit": "eb9889c763739fb4a67c3c475631f8fb45a28b5a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzQ1NDEzNA==", "url": "https://github.com/OpenTracksApp/OpenTracks/pull/519#discussion_r523454134", "bodyText": "@dennisguse I've removed this but I don't understand... If you selected all markers (markerIds.length == viewBinding.markerList.getCount()) then markerIds was set to null and no deletion was do.\nIs there something I don't get here?", "author": "rgmf", "createdAt": "2020-11-14T19:29:34Z", "path": "src/main/java/de/dennisguse/opentracks/MarkerListActivity.java", "diffHunk": "@@ -237,9 +237,6 @@ private boolean handleContextItem(int itemId, long... longMarkerIds) {\n                 }\n                 return true;\n             case R.id.list_context_menu_delete:\n-                if (markerIds.length > 1 && markerIds.length == viewBinding.markerList.getCount()) {", "originalCommit": "eb9889c763739fb4a67c3c475631f8fb45a28b5a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzc3NDA3NQ==", "url": "https://github.com/OpenTracksApp/OpenTracks/pull/519#discussion_r523774075", "bodyText": "markerIds must be null, so that DeleteMarkerDialogFragment will show the \"delete all message\".\nDon't know if the current is code is working without this if - markerIds might be an initialized array with length=0.\nAnd then the deletion will not happen anymore.", "author": "dennisguse", "createdAt": "2020-11-15T15:32:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzQ1NDEzNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzc3NzE0OA==", "url": "https://github.com/OpenTracksApp/OpenTracks/pull/519#discussion_r523777148", "bodyText": "If markerIds is null then OT crashes. Look at 82 DeleteMarkerDialogFragment's line (it uses markerIds but it can be null):\nfor (Marker.Id markerId : markerIds) {\n    contentProviderUtils.deleteMarker(getContext(), markerId);\n}\nAll that code was only for show \"Delete all markers?\" instead of \"Delete selected?\" in the title of the Dialog.", "author": "rgmf", "createdAt": "2020-11-15T15:59:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzQ1NDEzNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzc3Nzc2MQ==", "url": "https://github.com/OpenTracksApp/OpenTracks/pull/519#discussion_r523777761", "bodyText": "In my last commit is my proposal (it can be undo :D)", "author": "rgmf", "createdAt": "2020-11-15T16:04:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzQ1NDEzNA=="}], "type": "inlineReview"}, {"oid": "607ac91440bb499cc2527f9a3754137a6439b571", "url": "https://github.com/OpenTracksApp/OpenTracks/commit/607ac91440bb499cc2527f9a3754137a6439b571", "message": "Cleanup DeleteMarkerDialogFragment.", "committedDate": "2020-11-15T16:26:30Z", "type": "forcePushed"}, {"oid": "f4b2f2dc7fde1c18b40d679da9fb9dc853587655", "url": "https://github.com/OpenTracksApp/OpenTracks/commit/f4b2f2dc7fde1c18b40d679da9fb9dc853587655", "message": "Marker Bugfixes: markers deletion didn't work and track import didn't include marker's photos. Fixes #514.\nMarker edition bugfixed: orphan photos are deleted.", "committedDate": "2020-11-17T20:56:45Z", "type": "commit"}, {"oid": "f4b2f2dc7fde1c18b40d679da9fb9dc853587655", "url": "https://github.com/OpenTracksApp/OpenTracks/commit/f4b2f2dc7fde1c18b40d679da9fb9dc853587655", "message": "Marker Bugfixes: markers deletion didn't work and track import didn't include marker's photos. Fixes #514.\nMarker edition bugfixed: orphan photos are deleted.", "committedDate": "2020-11-17T20:56:45Z", "type": "forcePushed"}]}