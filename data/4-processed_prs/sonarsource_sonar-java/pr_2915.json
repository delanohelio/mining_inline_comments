{"pr_number": 2915, "pr_title": "SONARJAVA-3365 Improved rule S1607 description, message and title. ", "pr_createdAt": "2020-04-22T16:35:12Z", "pr_url": "https://github.com/SonarSource/sonar-java/pull/2915", "timeline": [{"oid": "b74f6afde29bbcab498150218307fade7fb030c0", "url": "https://github.com/SonarSource/sonar-java/commit/b74f6afde29bbcab498150218307fade7fb030c0", "message": "SONARJAVA-3365 Improved rule S1607 description, message and title. Added more explicit explanations about the assumeX methods.", "committedDate": "2020-04-22T15:50:11Z", "type": "commit"}, {"oid": "9a9bcfa3ac0e03801fe3bed63a7920ae1b17e047", "url": "https://github.com/SonarSource/sonar-java/commit/9a9bcfa3ac0e03801fe3bed63a7920ae1b17e047", "message": "Fixed code style", "committedDate": "2020-04-22T16:03:33Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzYxNTc1MA==", "url": "https://github.com/SonarSource/sonar-java/pull/2915#discussion_r413615750", "bodyText": "Usually, we try to use comments only when the code is not explicit enough, or when something unusual happens and you can't name/organize it in a clear way.\nFor example, the one at line 65 makes sense to me, one can wonder why we are reporting assume, since it is an unusual way to skip tests.\nThis one seems superfluous to me though, the next line sounds clear enough.", "author": "quentin-jaquier-sonarsource", "createdAt": "2020-04-23T08:26:08Z", "path": "java-checks/src/main/java/org/sonar/java/checks/IgnoredTestsCheck.java", "diffHunk": "@@ -53,24 +53,35 @@ public void visitNode(Tree tree) {\n     }\n     MethodTree methodTree = (MethodTree) tree;\n     SymbolMetadata symbolMetadata = methodTree.symbol().metadata();\n-    if (isSilentlyIgnored(symbolMetadata, \"org.junit.Ignore\") || isSilentlyIgnored(symbolMetadata, \"org.junit.jupiter.api.Disabled\")) {\n-      reportIssue(methodTree.simpleName(), \"Fix or remove this skipped unit test\");\n+\n+    // check for @Ignore or @Disabled annotations\n+    boolean hasIgnoreAnnotation = isSilentlyIgnored(symbolMetadata, \"org.junit.Ignore\");\n+    boolean hasDisabledAnnotation = isSilentlyIgnored(symbolMetadata, \"org.junit.jupiter.api.Disabled\");\n+    if (hasIgnoreAnnotation || hasDisabledAnnotation) {\n+      reportIssue(methodTree.simpleName(), String.format(\"Either add an explanation about why this test is skipped or remove the \" +\n+        \"\\\"@%s\\\" annotation.\", hasIgnoreAnnotation ? \"Ignore\" : \"Disabled\"));\n     }\n+\n+    // check for \"assumeFalse(true)\" and \"assumeTrue(false)\"-calls, which may also result in permanent skipping of the given test\n     BlockTree block = methodTree.block();\n-    if(block != null) {\n+    if (block != null) {\n       block.body().stream()\n         .filter(s -> s.is(Tree.Kind.EXPRESSION_STATEMENT))\n         .map(s -> ((ExpressionStatementTree) s).expression())\n         .filter(s -> s.is(Tree.Kind.METHOD_INVOCATION))\n         .map(MethodInvocationTree.class::cast)\n         .filter(ASSUME_METHODS::matches)\n         .filter(IgnoredTestsCheck::hasConstantOppositeArg)\n-        .forEach(mit -> reportIssue(mit.methodSelect(), \"Fix or remove this skipped unit test\"));\n+        .forEach(mit -> reportIssue(mit, \"Either remove this assumption or use an @Ignore or @Disabled annotation in combination with \" +\n+          \"an explanation about why this test is skipped.\"));\n     }\n   }\n \n   private static boolean isSilentlyIgnored(SymbolMetadata symbolMetadata, String annotation) {\n     List<SymbolMetadata.AnnotationValue> annotationValues = symbolMetadata.valuesForAnnotation(annotation);\n+\n+    // check that an annotation of the given type is present and whether that annotation has any values that are passed to it (i.e. an\n+    // explanation for why the test is ignored)", "originalCommit": "9a9bcfa3ac0e03801fe3bed63a7920ae1b17e047", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzY4NDk3Nw==", "url": "https://github.com/SonarSource/sonar-java/pull/2915#discussion_r413684977", "bodyText": "As a general observation, always think twice about what tree is reported, it will define what is highlighted in the different products, if the tree is too big, it will result in something ugly.\nThis is especially true for method invocation: arguments can be unusually long, a huge lambda for example!\nIn this case, it will always be true or false, it can't go wrong... Can it?\nFirst, it can be more than just literals, if you look at line 78, .asConstant(Boolean.class); also checks if the tree is a reference to a constant. So this code:\nprivate static final boolean ignoreTest = false;\n// ...\nassumeTrue(ignoreTest);\nwill also report an issue.\nThen, what if someone is using strange formatting, fully qualified name...\nPutting all together, you can end up with something like that:\norg.junit.Assume.assumeTrue(\n// We use assumeTrue to ignore test because ...\nMyLongTestHelperClass.IGNORE_TEST_WITH_ASSUME_TRUE\n);\nwith everything highlighted!\nI agree that this is really unlikely to happen, but it illustrates well what can go wrong!\nI believe reporting on the method name is enough here.\nBy the way, you can use ExpressionUtils::methodName for this purpose.", "author": "quentin-jaquier-sonarsource", "createdAt": "2020-04-23T10:04:32Z", "path": "java-checks/src/main/java/org/sonar/java/checks/IgnoredTestsCheck.java", "diffHunk": "@@ -53,24 +53,35 @@ public void visitNode(Tree tree) {\n     }\n     MethodTree methodTree = (MethodTree) tree;\n     SymbolMetadata symbolMetadata = methodTree.symbol().metadata();\n-    if (isSilentlyIgnored(symbolMetadata, \"org.junit.Ignore\") || isSilentlyIgnored(symbolMetadata, \"org.junit.jupiter.api.Disabled\")) {\n-      reportIssue(methodTree.simpleName(), \"Fix or remove this skipped unit test\");\n+\n+    // check for @Ignore or @Disabled annotations\n+    boolean hasIgnoreAnnotation = isSilentlyIgnored(symbolMetadata, \"org.junit.Ignore\");\n+    boolean hasDisabledAnnotation = isSilentlyIgnored(symbolMetadata, \"org.junit.jupiter.api.Disabled\");\n+    if (hasIgnoreAnnotation || hasDisabledAnnotation) {\n+      reportIssue(methodTree.simpleName(), String.format(\"Either add an explanation about why this test is skipped or remove the \" +\n+        \"\\\"@%s\\\" annotation.\", hasIgnoreAnnotation ? \"Ignore\" : \"Disabled\"));\n     }\n+\n+    // check for \"assumeFalse(true)\" and \"assumeTrue(false)\"-calls, which may also result in permanent skipping of the given test\n     BlockTree block = methodTree.block();\n-    if(block != null) {\n+    if (block != null) {\n       block.body().stream()\n         .filter(s -> s.is(Tree.Kind.EXPRESSION_STATEMENT))\n         .map(s -> ((ExpressionStatementTree) s).expression())\n         .filter(s -> s.is(Tree.Kind.METHOD_INVOCATION))\n         .map(MethodInvocationTree.class::cast)\n         .filter(ASSUME_METHODS::matches)\n         .filter(IgnoredTestsCheck::hasConstantOppositeArg)\n-        .forEach(mit -> reportIssue(mit.methodSelect(), \"Fix or remove this skipped unit test\"));\n+        .forEach(mit -> reportIssue(mit, \"Either remove this assumption or use an @Ignore or @Disabled annotation in combination with \" +", "originalCommit": "9a9bcfa3ac0e03801fe3bed63a7920ae1b17e047", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDQyNDU3NA==", "url": "https://github.com/SonarSource/sonar-java/pull/2915#discussion_r414424574", "bodyText": "My reasoning behind changing the part being highlighted was, that since it is not in itself problematic to use assumeTrue(...) and only becomes problematic with a constant boolean value, the argument should be part of the highlighted code, given that it is a defining part of the problem. You make a good point, though, in that it could interfere with usability when the argument becomes complex. So generally speaking we rather want to opt for simpler highlights, even if that could mean we potentially don't highlight all parts of the problematic code?", "author": "johann-beleites-sonarsource", "createdAt": "2020-04-24T09:16:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzY4NDk3Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDQ1NDc4MA==", "url": "https://github.com/SonarSource/sonar-java/pull/2915#discussion_r414454780", "bodyText": "Good point, I agree that the argument is part of the problem, the current situation could be improved.\n\nSo generally speaking we rather want to opt for simpler highlights, even if that could mean we potentially don't highlight all parts of the problematic code?\n\nI think we should aim for both (as much as possible..)! To do this, you can use secondary locations. You can have a look at #2914 for an example!\nIn this case, I would change the message to state that the assume is called with a constant argument and use a secondary location to highlight the argument. The secondary location can still be huge, but it will not be shown when browsing the file, only the main location will be.\nDoes it make sense to you?", "author": "quentin-jaquier-sonarsource", "createdAt": "2020-04-24T10:04:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzY4NDk3Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDQ4MDUyMQ==", "url": "https://github.com/SonarSource/sonar-java/pull/2915#discussion_r414480521", "bodyText": "Perfect, that sounds like exactly the fitting solution in this case, thanks!", "author": "johann-beleites-sonarsource", "createdAt": "2020-04-24T10:47:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzY4NDk3Nw=="}], "type": "inlineReview"}, {"oid": "7e2eb073823631d9e53e11a4a88edd9056ae83ca", "url": "https://github.com/SonarSource/sonar-java/commit/7e2eb073823631d9e53e11a4a88edd9056ae83ca", "message": "SONARJAVA-3365 Removed comment, reduced code to be highlighted for the IgnoredTestsCheck (assume logic part).", "committedDate": "2020-04-24T09:29:40Z", "type": "commit"}, {"oid": "df5ea85c7cac05146d7eebb31100f9787d37d935", "url": "https://github.com/SonarSource/sonar-java/commit/df5ea85c7cac05146d7eebb31100f9787d37d935", "message": "Merge branch 'master' into SONARJAVA-3365", "committedDate": "2020-04-24T09:48:28Z", "type": "commit"}, {"oid": "5a0c20a867d6a02290e69d9a755d51983339d48d", "url": "https://github.com/SonarSource/sonar-java/commit/5a0c20a867d6a02290e69d9a755d51983339d48d", "message": "SONARJAVA-3365 Added secondary location to rule 3365 in cases where an assume call is made with a constant boolean value.", "committedDate": "2020-04-24T10:50:47Z", "type": "commit"}, {"oid": "2a5058c34bcf2275e96681f5356ba207c2c793f8", "url": "https://github.com/SonarSource/sonar-java/commit/2a5058c34bcf2275e96681f5356ba207c2c793f8", "message": "SONARJAVA-3365 updated test to improved assume-logic", "committedDate": "2020-04-24T10:54:26Z", "type": "commit"}]}