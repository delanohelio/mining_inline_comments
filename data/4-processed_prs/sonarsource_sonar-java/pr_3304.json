{"pr_number": 3304, "pr_title": "SONARJAVA-3619 FP S2589 when Boolean variable doesn't always evaluate to TRUE/FALSE", "pr_createdAt": "2020-11-27T13:46:02Z", "pr_url": "https://github.com/SonarSource/sonar-java/pull/3304", "timeline": [{"oid": "78293a33a952f62868e9b7fb31f3372f5c7d06ae", "url": "https://github.com/SonarSource/sonar-java/commit/78293a33a952f62868e9b7fb31f3372f5c7d06ae", "message": "SONARJAVA-3619 FP S2589 when Boolean variable doesn't always evaluate to TRUE/FALSE", "committedDate": "2020-11-30T10:45:43Z", "type": "commit"}, {"oid": "a2f7038caea9c8c01aa50954b08a2de2bb008754", "url": "https://github.com/SonarSource/sonar-java/commit/a2f7038caea9c8c01aa50954b08a2de2bb008754", "message": "SONARJAVA-3619 Move test sources to the separate module", "committedDate": "2020-11-30T10:45:43Z", "type": "commit"}, {"oid": "96aaf08a4214f7d92c421d670267f5317cc7e99d", "url": "https://github.com/SonarSource/sonar-java/commit/96aaf08a4214f7d92c421d670267f5317cc7e99d", "message": "SONARJAVA-3619 Refactoring", "committedDate": "2020-11-30T10:45:43Z", "type": "forcePushed"}, {"oid": "978bfeae1703200603fecbcc5f59e160ad741208", "url": "https://github.com/SonarSource/sonar-java/commit/978bfeae1703200603fecbcc5f59e160ad741208", "message": "SONARJAVA-3619 Refactoring", "committedDate": "2020-11-30T10:50:10Z", "type": "forcePushed"}, {"oid": "4d024622c418241c3b33d3f91c501ffa389f5223", "url": "https://github.com/SonarSource/sonar-java/commit/4d024622c418241c3b33d3f91c501ffa389f5223", "message": "SONARJAVA-3619 Refactoring", "committedDate": "2020-11-30T11:59:51Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjY5MDgyNg==", "url": "https://github.com/SonarSource/sonar-java/pull/3304#discussion_r532690826", "bodyText": "I'm really not sure about this null test here, I think it's impossible. At worst, an unknown symbol should return an unknown type., and so your test can probably simply be if (type.is(\"java.lang.Boolean\")) { ...", "author": "m-g-sonar", "createdAt": "2020-11-30T15:40:05Z", "path": "java-frontend/src/main/java/org/sonar/java/se/constraint/ConstraintManager.java", "diffHunk": "@@ -153,6 +157,14 @@ private SymbolicValue createIdentifierSymbolicValue(IdentifierTree identifier) {\n     }\n     return createDefaultSymbolicValue();\n   }\n+  \n+  private SymbolicValue createVariableSymbolicValue(VariableTree identifier) {\n+    final Type type = identifier.symbol().type();\n+    if (type != null && type.is(\"java.lang.Boolean\")) {", "originalCommit": "4d024622c418241c3b33d3f91c501ffa389f5223", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjY5MTE0Mw==", "url": "https://github.com/SonarSource/sonar-java/pull/3304#discussion_r532691143", "bodyText": "I would rename identifier into variable", "author": "m-g-sonar", "createdAt": "2020-11-30T15:40:27Z", "path": "java-frontend/src/main/java/org/sonar/java/se/constraint/ConstraintManager.java", "diffHunk": "@@ -153,6 +157,14 @@ private SymbolicValue createIdentifierSymbolicValue(IdentifierTree identifier) {\n     }\n     return createDefaultSymbolicValue();\n   }\n+  \n+  private SymbolicValue createVariableSymbolicValue(VariableTree identifier) {", "originalCommit": "4d024622c418241c3b33d3f91c501ffa389f5223", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjcxOTIzMQ==", "url": "https://github.com/SonarSource/sonar-java/pull/3304#discussion_r532719231", "bodyText": "Good old copy/paste)", "author": "margarita-nedzelska-sonarsource", "createdAt": "2020-11-30T16:17:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjY5MTE0Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjY5NTI2NA==", "url": "https://github.com/SonarSource/sonar-java/pull/3304#discussion_r532695264", "bodyText": "Question of style, but I would really prefer to have the parenthesis on the previous line and this one starting with .collect( to align dots", "author": "m-g-sonar", "createdAt": "2020-11-30T15:45:57Z", "path": "java-frontend/src/main/java/org/sonar/java/se/symbolicvalues/RelationalSymbolicValue.java", "diffHunk": "@@ -172,35 +172,64 @@ RelationalSymbolicValue inverse() {\n     return results;\n   }\n \n+  private boolean hasBooleanSymbolicValueAsOperand() {\n+    return (leftOp instanceof BooleanSymbolicValue) || (rightOp instanceof BooleanSymbolicValue);\n+  }\n+\n+  private boolean isEqualityCheck() {\n+    return Kind.METHOD_EQUALS == kind || Kind.NOT_METHOD_EQUALS == kind || Kind.EQUAL == kind || Kind.NOT_EQUAL == kind;\n+  }\n+\n   private List<ProgramState> addNullConstraintsForBooleanWrapper(ProgramState initialProgramState, List<ProgramState> copiedConstraints) {\n     BooleanConstraint leftConstraint = initialProgramState.getConstraint(leftOp, BooleanConstraint.class);\n     BooleanConstraint rightConstraint = initialProgramState.getConstraint(rightOp, BooleanConstraint.class);\n-    if (leftConstraint != null && rightConstraint == null && !isEquality()) {\n-      List<ProgramState> nullConstraints = copiedConstraints.stream()\n-        .flatMap(ps -> rightOp.setConstraint(ps, ObjectConstraint.NULL).stream())\n-        .map(ps -> ps.removeConstraintsOnDomain(rightOp, BooleanConstraint.class)\n-      ).collect(Collectors.toList());\n-      return ImmutableList.<ProgramState>builder().addAll(copiedConstraints).addAll(nullConstraints).build();\n+    \n+    if (shouldAddNullConstraint(leftConstraint, rightConstraint)) {\n+      return getProgramStatesWithNullConstraints(copiedConstraints, leftOp);\n+    }\n+    \n+    if (shouldAddNullConstraint(rightConstraint, leftConstraint)) {\n+      return getProgramStatesWithNullConstraints(copiedConstraints, rightOp);\n     }\n     return copiedConstraints;\n   }\n \n+  private boolean shouldAddNullConstraint(@Nullable BooleanConstraint constraint1, @Nullable BooleanConstraint constraint2) {\n+    return !isEquality() && constraint1 == null && constraint2 != null;\n+  }\n+\n+  private static List<ProgramState> getProgramStatesWithNullConstraints(List<ProgramState> copiedConstraints, SymbolicValue operand) {\n+    List<ProgramState> nullConstraints = copiedConstraints.stream()\n+      .flatMap(ps -> operand.setConstraint(ps, ObjectConstraint.NULL).stream())\n+      .map(ps -> ps.removeConstraintsOnDomain(operand, BooleanConstraint.class)\n+      ).collect(Collectors.toList());", "originalCommit": "4d024622c418241c3b33d3f91c501ffa389f5223", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjY5ODM5Nw==", "url": "https://github.com/SonarSource/sonar-java/pull/3304#discussion_r532698397", "bodyText": "What about:\nreturn isEquality() || Kind.NOT_METHOD_EQUALS == kind || Kind.NOT_EQUAL == kind;\n\nIn order to mark the difference with isEquality ?", "author": "m-g-sonar", "createdAt": "2020-11-30T15:49:59Z", "path": "java-frontend/src/main/java/org/sonar/java/se/symbolicvalues/RelationalSymbolicValue.java", "diffHunk": "@@ -172,35 +172,64 @@ RelationalSymbolicValue inverse() {\n     return results;\n   }\n \n+  private boolean hasBooleanSymbolicValueAsOperand() {\n+    return (leftOp instanceof BooleanSymbolicValue) || (rightOp instanceof BooleanSymbolicValue);\n+  }\n+\n+  private boolean isEqualityCheck() {\n+    return Kind.METHOD_EQUALS == kind || Kind.NOT_METHOD_EQUALS == kind || Kind.EQUAL == kind || Kind.NOT_EQUAL == kind;", "originalCommit": "4d024622c418241c3b33d3f91c501ffa389f5223", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjcxODYzOQ==", "url": "https://github.com/SonarSource/sonar-java/pull/3304#discussion_r532718639", "bodyText": "Nice idea!", "author": "margarita-nedzelska-sonarsource", "createdAt": "2020-11-30T16:16:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjY5ODM5Nw=="}], "type": "inlineReview"}, {"oid": "d89b9ecacbe09582bd1cdfded35a1cc01ab6b218", "url": "https://github.com/SonarSource/sonar-java/commit/d89b9ecacbe09582bd1cdfded35a1cc01ab6b218", "message": "SONARJAVA-3619 Refactoring", "committedDate": "2020-11-30T16:15:32Z", "type": "commit"}, {"oid": "d89b9ecacbe09582bd1cdfded35a1cc01ab6b218", "url": "https://github.com/SonarSource/sonar-java/commit/d89b9ecacbe09582bd1cdfded35a1cc01ab6b218", "message": "SONARJAVA-3619 Refactoring", "committedDate": "2020-11-30T16:15:32Z", "type": "forcePushed"}]}