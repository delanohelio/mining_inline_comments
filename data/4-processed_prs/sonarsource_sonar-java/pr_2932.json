{"pr_number": 2932, "pr_title": "SONARJAVA-3360 Rule S5778: Only one method invocation is expected when testing runtime exceptions", "pr_createdAt": "2020-05-01T12:24:01Z", "pr_url": "https://github.com/SonarSource/sonar-java/pull/2932", "timeline": [{"oid": "54c54555329868c10269e3b808d9f4d0cbffa792", "url": "https://github.com/SonarSource/sonar-java/commit/54c54555329868c10269e3b808d9f4d0cbffa792", "message": "SONARJAVA-3360 Rule S5778: Only one method invocation is expected when testing runtime exceptions", "committedDate": "2020-05-01T12:24:47Z", "type": "commit"}, {"oid": "54c54555329868c10269e3b808d9f4d0cbffa792", "url": "https://github.com/SonarSource/sonar-java/commit/54c54555329868c10269e3b808d9f4d0cbffa792", "message": "SONARJAVA-3360 Rule S5778: Only one method invocation is expected when testing runtime exceptions", "committedDate": "2020-05-01T12:24:47Z", "type": "forcePushed"}, {"oid": "ca5ab15c724bdada8ff95b4a80f32f3a1b062411", "url": "https://github.com/SonarSource/sonar-java/commit/ca5ab15c724bdada8ff95b4a80f32f3a1b062411", "message": "Improve coverage", "committedDate": "2020-05-01T13:25:54Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTI5MjM4Mw==", "url": "https://github.com/SonarSource/sonar-java/pull/2932#discussion_r419292383", "bodyText": "I really don't like this message in fact... \"expected\" does not make sense. I would prefer to have \"This call can throw an exception\" instead, and ideally, even the name of the exception!", "author": "m-g-sonar", "createdAt": "2020-05-04T08:48:16Z", "path": "java-checks/src/main/java/org/sonar/java/checks/AbstractOneExpectedExceptionRule.java", "diffHunk": "@@ -128,66 +127,42 @@ private static boolean isTryCatchFail(TryStatementTree tree) {\n     return false;\n   }\n \n-  private void reportMultipleCallThrowingExceptionInTree(List<Type> expectedExceptions, Tree treeToVisit, Tree reportLocation, String placeToRefactor) {\n-    List<Type> checkedTypes = expectedExceptions.stream()\n-      .filter(OneExpectedCheckExceptionCheck::isChecked)\n-      .collect(Collectors.toList());\n-\n-    if (checkedTypes.isEmpty()) {\n-      return;\n-    }\n-\n-    MethodInvocationThrowing visitor = new MethodInvocationThrowing(checkedTypes);\n-    treeToVisit.accept(visitor);\n-    List<Tree> invocationTree = visitor.invocationTree;\n-    if (invocationTree.size() > 1) {\n-      reportIssue(reportLocation,\n-        String.format(\"Refactor the %s in order to have only one invocation throwing an expected exception.\", placeToRefactor),\n-        secondaryLocations(invocationTree),\n-        null);\n-    }\n-  }\n+  abstract void reportMultipleCallInTree(List<Type> expectedExceptions, Tree treeToVisit, Tree reportLocation, String placeToRefactor);\n \n-  private static boolean isChecked(Type type) {\n+  static boolean isChecked(Type type) {\n     return !type.isSubtypeOf(\"java.lang.RuntimeException\") && !type.isSubtypeOf(\"java.lang.Error\");\n   }\n \n-  private static List<JavaFileScannerContext.Location> secondaryLocations(List<Tree> methodInvocationTrees) {\n+  static List<JavaFileScannerContext.Location> secondaryLocations(List<Tree> methodInvocationTrees) {\n     return methodInvocationTrees.stream()\n       .map(expr -> new JavaFileScannerContext.Location(\"This call can throw an expected exception\", expr))", "originalCommit": "ca5ab15c724bdada8ff95b4a80f32f3a1b062411", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTI5MzM1OQ==", "url": "https://github.com/SonarSource/sonar-java/pull/2932#discussion_r419293359", "bodyText": "Here as well, \"an expected\" feels bad. It can happen only once, according to the way it is tested, so, to me it should be \"the expected exception\", or even \"the exception\".", "author": "m-g-sonar", "createdAt": "2020-05-04T08:49:53Z", "path": "java-checks/src/main/java/org/sonar/java/checks/OneExpectedCheckedExceptionCheck.java", "diffHunk": "@@ -0,0 +1,59 @@\n+/*\n+ * SonarQube Java\n+ * Copyright (C) 2012-2020 SonarSource SA\n+ * mailto:info AT sonarsource DOT com\n+ *\n+ * This program is free software; you can redistribute it and/or\n+ * modify it under the terms of the GNU Lesser General Public\n+ * License as published by the Free Software Foundation; either\n+ * version 3 of the License, or (at your option) any later version.\n+ *\n+ * This program is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU\n+ * Lesser General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU Lesser General Public License\n+ * along with this program; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.\n+ */\n+package org.sonar.java.checks;\n+\n+import java.util.List;\n+import java.util.stream.Collectors;\n+import org.sonar.check.Rule;\n+import org.sonar.plugins.java.api.semantic.Symbol;\n+import org.sonar.plugins.java.api.semantic.Type;\n+import org.sonar.plugins.java.api.tree.Tree;\n+\n+@Rule(key = \"S5783\")\n+public class OneExpectedCheckedExceptionCheck extends AbstractOneExpectedExceptionRule {\n+\n+  @Override\n+  void reportMultipleCallInTree(List<Type> expectedExceptions, Tree treeToVisit, Tree reportLocation, String placeToRefactor) {\n+    List<Type> checkedTypes = expectedExceptions.stream()\n+      .filter(AbstractOneExpectedExceptionRule::isChecked)\n+      .collect(Collectors.toList());\n+\n+    if (checkedTypes.isEmpty()) {\n+      return;\n+    }\n+\n+    MethodInvocationCollector visitor = new MethodInvocationCollector(symbol -> throwExpectedException(symbol, checkedTypes));\n+    treeToVisit.accept(visitor);\n+    List<Tree> invocationTree = visitor.invocationTree;\n+    if (invocationTree.size() > 1) {\n+      reportIssue(reportLocation,\n+        String.format(\"Refactor the %s in order to have only one invocation throwing an expected exception.\", placeToRefactor),", "originalCommit": "ca5ab15c724bdada8ff95b4a80f32f3a1b062411", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTI5Mzc1OQ==", "url": "https://github.com/SonarSource/sonar-java/pull/2932#discussion_r419293759", "bodyText": "I would change it to \"the excepted exception\", or even \"the exception\". Simplicity is a key.", "author": "m-g-sonar", "createdAt": "2020-05-04T08:50:40Z", "path": "java-checks/src/main/java/org/sonar/java/checks/OneExpectedRuntimeExceptionCheck.java", "diffHunk": "@@ -0,0 +1,52 @@\n+/*\n+ * SonarQube Java\n+ * Copyright (C) 2012-2020 SonarSource SA\n+ * mailto:info AT sonarsource DOT com\n+ *\n+ * This program is free software; you can redistribute it and/or\n+ * modify it under the terms of the GNU Lesser General Public\n+ * License as published by the Free Software Foundation; either\n+ * version 3 of the License, or (at your option) any later version.\n+ *\n+ * This program is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU\n+ * Lesser General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU Lesser General Public License\n+ * along with this program; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.\n+ */\n+package org.sonar.java.checks;\n+\n+import java.util.List;\n+import java.util.stream.Collectors;\n+import org.sonar.check.Rule;\n+import org.sonar.plugins.java.api.semantic.Type;\n+import org.sonar.plugins.java.api.tree.Tree;\n+\n+@Rule(key = \"S5778\")\n+public class OneExpectedRuntimeExceptionCheck extends AbstractOneExpectedExceptionRule {\n+\n+  @Override\n+  void reportMultipleCallInTree(List<Type> expectedExceptions, Tree treeToVisit, Tree reportLocation, String placeToRefactor) {\n+    List<Type> checkedTypes = expectedExceptions.stream()\n+      .filter(e -> !isChecked(e))\n+      .collect(Collectors.toList());\n+\n+    if (checkedTypes.isEmpty()) {\n+      return;\n+    }\n+\n+    MethodInvocationCollector visitor = new MethodInvocationCollector(symbol -> !JUNIT_FAIL_MATCHER.matches(symbol));\n+    treeToVisit.accept(visitor);\n+    List<Tree> invocationTree = visitor.invocationTree;\n+    if (invocationTree.size() > 1) {\n+      reportIssue(reportLocation,\n+        String.format(\"Refactor the %s in order to have only one invocation throwing an expected exception.\", placeToRefactor),", "originalCommit": "ca5ab15c724bdada8ff95b4a80f32f3a1b062411", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "91de3973229ad48b7569671c22d0acb26802fa9f", "url": "https://github.com/SonarSource/sonar-java/commit/91de3973229ad48b7569671c22d0acb26802fa9f", "message": "Simplify message", "committedDate": "2020-05-04T14:34:02Z", "type": "commit"}]}