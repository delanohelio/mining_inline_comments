{"pr_number": 2925, "pr_title": "SONARJAVA-3355 Improve SourceMap API to provide InputFile for source file", "pr_createdAt": "2020-04-28T16:19:22Z", "pr_url": "https://github.com/SonarSource/sonar-java/pull/2925", "timeline": [{"oid": "cdfe88681b44952fbf82001829597db91e2dd8fd", "url": "https://github.com/SonarSource/sonar-java/commit/cdfe88681b44952fbf82001829597db91e2dd8fd", "message": "SONARJAVA-3355 Improve SourceMap API to provide InputFile for source file", "committedDate": "2020-04-28T16:30:04Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzE0MzA1Mw==", "url": "https://github.com/SonarSource/sonar-java/pull/2925#discussion_r417143053", "bodyText": "We can maybe avoid looking up the same lineFileId for every line by having just a check of the difference of lineInfo.lineFileId with the previous one as in most cases (if not all) we should not have a difference.", "author": "benzonico", "createdAt": "2020-04-29T08:18:10Z", "path": "java-frontend/src/main/java/org/sonar/java/model/GeneratedFile.java", "diffHunk": "@@ -80,21 +81,26 @@ public void addSmap(SmapFile smap) {\n \n     final Map<Integer, Location> lines = new HashMap<>();\n \n-    private SourceMapImpl() {\n+    private SourceMapImpl(Function<Path, Optional<InputFile>> fileResolver) {\n       for (SmapFile sm : smapFiles) {\n         for (SmapFile.LineInfo lineInfo : sm.getLineSection()) {\n-          for (int i = 0; i < lineInfo.repeatCount; i++) {\n-            int inputLine = lineInfo.inputStartLine + i;\n-            Path inputFile = sm.getUriRoot().resolve(sm.getFileSection().get(lineInfo.lineFileId).sourcePath);\n-            LocationImpl location = new LocationImpl(inputFile, inputLine, inputLine);\n-            int outputStart = lineInfo.outputStartLine + (i * lineInfo.outputLineIncrement);\n-            int outputEnd = lineInfo.outputStartLine + ((i + 1) * lineInfo.outputLineIncrement) - 1;\n-            // when outputLineIncrement == 0, end will be less than start (looks like bug in spec)\n-            outputEnd = max(outputStart, outputEnd);\n-            for (int j = outputStart; j <= outputEnd; j++) {\n-              lines.merge(j, location, LocationImpl::mergeLocations);\n-            }\n-          }\n+          Path sourcePath = sm.getUriRoot().resolve(sm.getFileSection().get(lineInfo.lineFileId).sourcePath);\n+          Optional<InputFile> inputFile = fileResolver.apply(sourcePath);", "originalCommit": "cdfe88681b44952fbf82001829597db91e2dd8fd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzYwMjA3OQ==", "url": "https://github.com/SonarSource/sonar-java/pull/2925#discussion_r417602079", "bodyText": "in fact I had a look into Jasper code and it seems that 1 JSP always maps to single Java file, so this was unnecessary. I removed the change and simplified this code.", "author": "saberduck", "createdAt": "2020-04-29T20:48:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzE0MzA1Mw=="}], "type": "inlineReview"}, {"oid": "16497ef451ef335f0343f38731884de7fcdfc304", "url": "https://github.com/SonarSource/sonar-java/commit/16497ef451ef335f0343f38731884de7fcdfc304", "message": "SONARJAVA-3355 [JSP] Improve SourceMap API to provide InputFile for source file", "committedDate": "2020-04-29T20:43:41Z", "type": "forcePushed"}, {"oid": "624bf7ab6a4968729c9601f3a094a79137f96778", "url": "https://github.com/SonarSource/sonar-java/commit/624bf7ab6a4968729c9601f3a094a79137f96778", "message": "SONARJAVA-3355 [JSP] Improve SourceMap API to provide InputFile for source file", "committedDate": "2020-04-29T20:57:27Z", "type": "forcePushed"}, {"oid": "056a002f104cbd1c02d3aa1b587056794bdde962", "url": "https://github.com/SonarSource/sonar-java/commit/056a002f104cbd1c02d3aa1b587056794bdde962", "message": "SONARJAVA-3355 [JSP] Improve SourceMap API to provide InputFile for source file", "committedDate": "2020-04-29T21:20:43Z", "type": "commit"}, {"oid": "056a002f104cbd1c02d3aa1b587056794bdde962", "url": "https://github.com/SonarSource/sonar-java/commit/056a002f104cbd1c02d3aa1b587056794bdde962", "message": "SONARJAVA-3355 [JSP] Improve SourceMap API to provide InputFile for source file", "committedDate": "2020-04-29T21:20:43Z", "type": "forcePushed"}, {"oid": "9daf8b82ee4493c60218c2d249a664384c39aa9d", "url": "https://github.com/SonarSource/sonar-java/commit/9daf8b82ee4493c60218c2d249a664384c39aa9d", "message": "Make API backwards compatible", "committedDate": "2020-04-30T09:41:11Z", "type": "commit"}, {"oid": "9daf8b82ee4493c60218c2d249a664384c39aa9d", "url": "https://github.com/SonarSource/sonar-java/commit/9daf8b82ee4493c60218c2d249a664384c39aa9d", "message": "Make API backwards compatible", "committedDate": "2020-04-30T09:41:11Z", "type": "forcePushed"}, {"oid": "d8f9d2940e074df62ab8560c5be2aa5bce8a9565", "url": "https://github.com/SonarSource/sonar-java/commit/d8f9d2940e074df62ab8560c5be2aa5bce8a9565", "message": "remove leftover @Nullable annotation", "committedDate": "2020-04-30T12:10:10Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzk2MTk4NQ==", "url": "https://github.com/SonarSource/sonar-java/pull/2925#discussion_r417961985", "bodyText": "This should not be annotated with @Nullable. This can not happen in production, only in tests.", "author": "m-g-sonar", "createdAt": "2020-04-30T12:09:31Z", "path": "java-frontend/src/main/java/org/sonar/java/model/GeneratedFile.java", "diffHunk": "@@ -48,17 +47,17 @@\n \n public class GeneratedFile implements InputFile {\n \n-  private static final Logger LOG = Loggers.get(GeneratedFile.class);\n-\n   private final Path path;\n \n   @VisibleForTesting\n   final List<SmapFile> smapFiles = new ArrayList<>();\n+  private final InputFile jspSourceFile;\n \n   private SourceMap sourceMap;\n \n-  public GeneratedFile(Path path) {\n+  public GeneratedFile(Path path, @Nullable InputFile jspSourceFile) {", "originalCommit": "9daf8b82ee4493c60218c2d249a664384c39aa9d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "0a1dd299b831670aca3b2bd738f575abcc00e727", "url": "https://github.com/SonarSource/sonar-java/commit/0a1dd299b831670aca3b2bd738f575abcc00e727", "message": "fix coverage", "committedDate": "2020-04-30T12:29:47Z", "type": "commit"}]}