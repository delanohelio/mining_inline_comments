{"pr_number": 3343, "pr_title": "SONARJAVA-2154 Remove usages of guava Sets, Iterables and AbstractIterator from java-frontend module", "pr_createdAt": "2020-12-10T10:18:03Z", "pr_url": "https://github.com/SonarSource/sonar-java/pull/3343", "timeline": [{"oid": "25da64e3ba157800c90071180497b0e7573b5e2e", "url": "https://github.com/SonarSource/sonar-java/commit/25da64e3ba157800c90071180497b0e7573b5e2e", "message": "SONARJAVA-2154 Remove usages of guava AbstractIterator from java-frontend module", "committedDate": "2020-12-10T11:23:44Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDE1NDAzNw==", "url": "https://github.com/SonarSource/sonar-java/pull/3343#discussion_r540154037", "bodyText": "I'm not sure about this implementation. According to the documentation of Guava, why not go for:\nSet<T> newSet1 = new HashSet<>(set1);\nnewSet1.removeAll(set2);\nreturn newSet1;", "author": "m-g-sonar", "createdAt": "2020-12-10T13:07:40Z", "path": "java-frontend/src/main/java/org/sonar/java/collections/SetUtils.java", "diffHunk": "@@ -47,4 +47,18 @@ private SetUtils() {\n       .flatMap(Set::stream)\n       .collect(Collectors.toSet());\n   }\n+\n+  public static <T> Set<T> difference(Set<T> set1, Set<T> set2) {\n+    return set1.stream()", "originalCommit": "25da64e3ba157800c90071180497b0e7573b5e2e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDE1NDQ2OQ==", "url": "https://github.com/SonarSource/sonar-java/pull/3343#discussion_r540154469", "bodyText": "this is a set, not a list", "author": "m-g-sonar", "createdAt": "2020-12-10T13:08:27Z", "path": "java-frontend/src/main/java/org/sonar/java/collections/SetUtils.java", "diffHunk": "@@ -47,4 +47,18 @@ private SetUtils() {\n       .flatMap(Set::stream)\n       .collect(Collectors.toSet());\n   }\n+\n+  public static <T> Set<T> difference(Set<T> set1, Set<T> set2) {\n+    return set1.stream()\n+      .filter(elem -> !set2.contains(elem))\n+      .collect(Collectors.toSet());\n+  }\n+\n+  public static <T> T getOnlyElement(Set<T> set) {\n+    if (set.size() == 1) {\n+      return set.iterator().next();\n+    }\n+    throw new IllegalArgumentException(String.format(\"Expected list of size 1, but was list of size %d.\", set.size()));", "originalCommit": "25da64e3ba157800c90071180497b0e7573b5e2e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDE1ODA4OA==", "url": "https://github.com/SonarSource/sonar-java/pull/3343#discussion_r540158088", "bodyText": "I think it might be simpler to write a new method in SymbolicExecutionMode accepting an Iterable instead of an array.", "author": "m-g-sonar", "createdAt": "2020-12-10T13:14:03Z", "path": "java-frontend/src/main/java/org/sonar/java/model/VisitorsBridgeForTests.java", "diffHunk": "@@ -58,7 +58,8 @@ public VisitorsBridgeForTests(Iterable<? extends JavaCheck> visitors, @Nullable\n   }\n \n   public VisitorsBridgeForTests(Iterable<? extends JavaCheck> visitors, List<File> projectClasspath, @Nullable SonarComponents sonarComponents) {\n-    super(visitors, projectClasspath, sonarComponents, SymbolicExecutionMode.getMode(Iterables.toArray(visitors, JavaCheck.class)));\n+    super(visitors, projectClasspath, sonarComponents, SymbolicExecutionMode.getMode(", "originalCommit": "25da64e3ba157800c90071180497b0e7573b5e2e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDE2MjQ2Ng==", "url": "https://github.com/SonarSource/sonar-java/pull/3343#discussion_r540162466", "bodyText": "The more I read about all these changes, the more I think that having children()  returning Iterable<Tree> in the JavaTree is stupid... we should have go for a List<Tree> from day one, or a least a Collection. It does not make sense to use an Iterable anymore. If you are searching for something else to improve, go for it!", "author": "m-g-sonar", "createdAt": "2020-12-10T13:20:33Z", "path": "java-frontend/src/main/java/org/sonar/java/model/statement/SwitchExpressionTreeImpl.java", "diffHunk": "@@ -101,7 +101,7 @@ public void accept(TreeVisitor visitor) {\n \n   @Override\n   public Iterable<Tree> children() {\n-    return Iterables.concat(\n+    return ListUtils.concat(", "originalCommit": "25da64e3ba157800c90071180497b0e7573b5e2e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDE5NTg4MA==", "url": "https://github.com/SonarSource/sonar-java/pull/3343#discussion_r540195880", "bodyText": "It looks like there are cases where we use custom implementation of Iterable. So maybe we can update this in other PR", "author": "margarita-nedzelska-sonarsource", "createdAt": "2020-12-10T14:07:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDE2MjQ2Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDIzMjUwNg==", "url": "https://github.com/SonarSource/sonar-java/pull/3343#discussion_r540232506", "bodyText": "Here it is #3345 :)", "author": "margarita-nedzelska-sonarsource", "createdAt": "2020-12-10T14:53:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDE2MjQ2Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDE2NDUzNg==", "url": "https://github.com/SonarSource/sonar-java/pull/3343#discussion_r540164536", "bodyText": "style, can you please align it as in others?\n  Stream.of(STRONG_NULLABLE_ANNOTATIONS, WEAK_NULLABLE_ANNOTATIONS)\n    .flatMap(Set::stream)\n    .collect(Collectors.toSet()));", "author": "m-g-sonar", "createdAt": "2020-12-10T13:23:36Z", "path": "java-frontend/src/main/java/org/sonar/java/se/NullableAnnotationUtils.java", "diffHunk": "@@ -65,28 +67,31 @@ private NullableAnnotationUtils() {\n     \"org.springframework.lang.Nullable\",\n     \"reactor.util.annotation.Nullable\");\n \n-  private static final Set<String> NULLABLE_ANNOTATIONS = new ImmutableSet.Builder<String>()\n-    .add(\"android.annotation.Nullable\")\n-    .add(\"android.support.annotation.Nullable\")\n-    .add(\"androidx.annotation.Nullable\")\n-    .add(\"com.sun.istack.internal.Nullable\")\n-    .add(\"edu.umd.cs.findbugs.annotations.Nullable\")\n-    .add(\"io.reactivex.annotations.Nullable\")\n-    .add(\"io.reactivex.rxjava3.annotations.Nullable\")\n-    .add(\"javax.annotation.Nullable\")\n-    .add(\"org.checkerframework.checker.nullness.compatqual.NullableDecl\")\n-    .add(\"org.checkerframework.checker.nullness.compatqual.NullableType\")\n-    .add(\"org.checkerframework.checker.nullness.qual.Nullable\")\n-    .add(\"org.eclipse.jdt.annotation.Nullable\")\n-    .add(\"org.eclipse.jgit.annotations.Nullable\")\n-    .add(\"org.jetbrains.annotations.Nullable\")\n-    .add(\"org.jmlspecs.annotation.Nullable\")\n-    .add(\"org.netbeans.api.annotations.common.NullAllowed\")\n-    .add(\"org.netbeans.api.annotations.common.NullUnknown\")\n-    .addAll(STRONG_NULLABLE_ANNOTATIONS)\n-    .build();\n-\n-  private static final Set<String> NONNULL_ANNOTATIONS = ImmutableSet.of(\n+\n+  private static final Set<String> WEAK_NULLABLE_ANNOTATIONS = SetUtils.immutableSetOf(\n+    \"android.annotation.Nullable\",\n+    \"android.support.annotation.Nullable\",\n+    \"androidx.annotation.Nullable\",\n+    \"com.sun.istack.internal.Nullable\",\n+    \"edu.umd.cs.findbugs.annotations.Nullable\",\n+    \"io.reactivex.annotations.Nullable\",\n+    \"io.reactivex.rxjava3.annotations.Nullable\",\n+    \"javax.annotation.Nullable\",\n+    \"org.checkerframework.checker.nullness.compatqual.NullableDecl\",\n+    \"org.checkerframework.checker.nullness.compatqual.NullableType\",\n+    \"org.checkerframework.checker.nullness.qual.Nullable\",\n+    \"org.eclipse.jdt.annotation.Nullable\",\n+    \"org.eclipse.jgit.annotations.Nullable\",\n+    \"org.jetbrains.annotations.Nullable\",\n+    \"org.jmlspecs.annotation.Nullable\",\n+    \"org.netbeans.api.annotations.common.NullAllowed\",\n+    \"org.netbeans.api.annotations.common.NullUnknown\");\n+\n+  private static final Set<String> NULLABLE_ANNOTATIONS = Collections.unmodifiableSet(\n+    Stream.of(STRONG_NULLABLE_ANNOTATIONS, WEAK_NULLABLE_ANNOTATIONS)\n+    .flatMap(Set::stream).collect(Collectors.toSet()));", "originalCommit": "25da64e3ba157800c90071180497b0e7573b5e2e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "f425d9aea7d0ad2debdedd432c4b0320222fb1e3", "url": "https://github.com/SonarSource/sonar-java/commit/f425d9aea7d0ad2debdedd432c4b0320222fb1e3", "message": "SONARJAVA-2154 Remove usages of guava Immutable Collections from java-frontend module", "committedDate": "2020-12-10T13:34:32Z", "type": "commit"}, {"oid": "8714484daabfdc045c06c3c46304f95fb7fbb387", "url": "https://github.com/SonarSource/sonar-java/commit/8714484daabfdc045c06c3c46304f95fb7fbb387", "message": "SONARJAVA-2154 Remove usages of guava Sets and Multimaps from java-frontend module", "committedDate": "2020-12-10T13:34:32Z", "type": "commit"}, {"oid": "6fb467e1aa0e1bf8d1842457b7bbd62ea519fe74", "url": "https://github.com/SonarSource/sonar-java/commit/6fb467e1aa0e1bf8d1842457b7bbd62ea519fe74", "message": "SONARJAVA-2154 Remove usages of guava Iterables from java-frontend module (WIP)", "committedDate": "2020-12-10T13:34:32Z", "type": "commit"}, {"oid": "b65125c60d5a9732e092f93c5f82497f9e455f70", "url": "https://github.com/SonarSource/sonar-java/commit/b65125c60d5a9732e092f93c5f82497f9e455f70", "message": "SONARJAVA-2154 Remove usages of guava AbstractIterator from java-frontend module", "committedDate": "2020-12-10T13:34:32Z", "type": "commit"}, {"oid": "34b3bcbf4b8d00d944286073c3b33659e24ce6cd", "url": "https://github.com/SonarSource/sonar-java/commit/34b3bcbf4b8d00d944286073c3b33659e24ce6cd", "message": "SONARJAVA-2154 Refactoring java-frontend after guava removal", "committedDate": "2020-12-10T14:05:51Z", "type": "commit"}, {"oid": "34b3bcbf4b8d00d944286073c3b33659e24ce6cd", "url": "https://github.com/SonarSource/sonar-java/commit/34b3bcbf4b8d00d944286073c3b33659e24ce6cd", "message": "SONARJAVA-2154 Refactoring java-frontend after guava removal", "committedDate": "2020-12-10T14:05:51Z", "type": "forcePushed"}]}