{"pr_number": 580, "pr_title": "SO-4103: New rule: Active descriptions on inactive concepts should have a single inactivation indicator member ", "pr_createdAt": "2020-06-04T12:09:14Z", "pr_url": "https://github.com/b2ihealthcare/snow-owl/pull/580", "timeline": [{"oid": "916882c85fedea52f1913f2f0fb81d95a5b37517", "url": "https://github.com/b2ihealthcare/snow-owl/commit/916882c85fedea52f1913f2f0fb81d95a5b37517", "message": "SO-4103: add new validation rule for inactive members", "committedDate": "2020-06-04T12:05:47Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzM2NzQ5Nw==", "url": "https://github.com/b2ihealthcare/snow-owl/pull/580#discussion_r437367497", "bodyText": "Loading all members from that refset to memory will kill the process, please use scrolling.", "author": "cmark", "createdAt": "2020-06-09T12:23:51Z", "path": "snomed/com.b2international.snowowl.validation.snomed/src/main/resources/scripts/rule671.groovy", "diffHunk": "@@ -0,0 +1,55 @@\n+package scripts;\n+\n+import com.b2international.index.query.Expressions\n+import com.b2international.index.query.Query\n+import com.b2international.index.query.Expressions.ExpressionBuilder\n+import com.b2international.index.revision.RevisionSearcher\n+import com.b2international.snowowl.core.ComponentIdentifier\n+import com.b2international.snowowl.core.date.EffectiveTimes\n+import com.b2international.snowowl.snomed.common.SnomedRf2Headers\n+import com.b2international.snowowl.snomed.common.SnomedTerminologyComponentConstants\n+import com.b2international.snowowl.snomed.common.SnomedConstants.Concepts\n+import com.b2international.snowowl.snomed.datastore.index.entry.SnomedConceptDocument\n+import com.b2international.snowowl.snomed.datastore.index.entry.SnomedRefSetMemberIndexEntry\n+import com.google.common.collect.Maps\n+import com.google.common.collect.Sets\n+\n+final Set<ComponentIdentifier> issues = Sets.newHashSet()\n+final RevisionSearcher searcher = ctx.service(RevisionSearcher.class)\n+\n+ExpressionBuilder filterExpressionBuilder = Expressions.builder()\n+\t\t.filter(SnomedConceptDocument.Expressions.inactive())\n+\n+if (params.isUnpublishedOnly) {\n+\tfilterExpressionBuilder.filter(SnomedConceptDocument.Expressions.effectiveTime(EffectiveTimes.UNSET_EFFECTIVE_TIME))\n+}\n+\n+Map<String, SnomedRefSetMemberIndexEntry> members = Maps.newHashMap()\n+\n+Query<String> queryRefsetMembers =Query.select(SnomedRefSetMemberIndexEntry.class)\n+\t\t.from(SnomedRefSetMemberIndexEntry.class)\n+\t\t.where(SnomedRefSetMemberIndexEntry.Expressions.referenceSetId(Concepts.REFSET_CONCEPT_INACTIVITY_INDICATOR))\n+\t\t.limit(Integer.MAX_VALUE)", "originalCommit": "916882c85fedea52f1913f2f0fb81d95a5b37517", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODg1Nzc2Mw==", "url": "https://github.com/b2ihealthcare/snow-owl/pull/580#discussion_r438857763", "bodyText": "Done", "author": "molnarlaura", "createdAt": "2020-06-11T15:10:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzM2NzQ5Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODg1ODEwNA==", "url": "https://github.com/b2ihealthcare/snow-owl/pull/580#discussion_r438858104", "bodyText": "Done", "author": "molnarlaura", "createdAt": "2020-06-11T15:10:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzM2NzQ5Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzM2Nzc4NQ==", "url": "https://github.com/b2ihealthcare/snow-owl/pull/580#discussion_r437367785", "bodyText": "Remove sysout.", "author": "cmark", "createdAt": "2020-06-09T12:24:10Z", "path": "snomed/com.b2international.snowowl.validation.snomed/src/main/resources/scripts/rule671.groovy", "diffHunk": "@@ -0,0 +1,55 @@\n+package scripts;\n+\n+import com.b2international.index.query.Expressions\n+import com.b2international.index.query.Query\n+import com.b2international.index.query.Expressions.ExpressionBuilder\n+import com.b2international.index.revision.RevisionSearcher\n+import com.b2international.snowowl.core.ComponentIdentifier\n+import com.b2international.snowowl.core.date.EffectiveTimes\n+import com.b2international.snowowl.snomed.common.SnomedRf2Headers\n+import com.b2international.snowowl.snomed.common.SnomedTerminologyComponentConstants\n+import com.b2international.snowowl.snomed.common.SnomedConstants.Concepts\n+import com.b2international.snowowl.snomed.datastore.index.entry.SnomedConceptDocument\n+import com.b2international.snowowl.snomed.datastore.index.entry.SnomedRefSetMemberIndexEntry\n+import com.google.common.collect.Maps\n+import com.google.common.collect.Sets\n+\n+final Set<ComponentIdentifier> issues = Sets.newHashSet()\n+final RevisionSearcher searcher = ctx.service(RevisionSearcher.class)\n+\n+ExpressionBuilder filterExpressionBuilder = Expressions.builder()\n+\t\t.filter(SnomedConceptDocument.Expressions.inactive())\n+\n+if (params.isUnpublishedOnly) {\n+\tfilterExpressionBuilder.filter(SnomedConceptDocument.Expressions.effectiveTime(EffectiveTimes.UNSET_EFFECTIVE_TIME))\n+}\n+\n+Map<String, SnomedRefSetMemberIndexEntry> members = Maps.newHashMap()\n+\n+Query<String> queryRefsetMembers =Query.select(SnomedRefSetMemberIndexEntry.class)\n+\t\t.from(SnomedRefSetMemberIndexEntry.class)\n+\t\t.where(SnomedRefSetMemberIndexEntry.Expressions.referenceSetId(Concepts.REFSET_CONCEPT_INACTIVITY_INDICATOR))\n+\t\t.limit(Integer.MAX_VALUE)\n+\t\t.build()\n+\n+searcher.search(queryRefsetMembers).forEach({SnomedRefSetMemberIndexEntry member ->\n+\tmembers.put(member.getReferencedComponentId(), member)\n+\n+})\n+\n+Query<String> queryConcepts = Query.select(SnomedConceptDocument.class)\n+\t\t.from(SnomedConceptDocument.class)\n+\t\t.where(filterExpressionBuilder.build())\n+\t\t.limit(Integer.MAX_VALUE)\n+\t\t.build()\n+\n+searcher.search(queryConcepts).forEach({SnomedConceptDocument concept ->\n+\tString inactivationIndicatorId = (String) members.get(concept.getId()).getProperties().get(SnomedRf2Headers.FIELD_VALUE_ID);\n+\tprintln(inactivationIndicatorId)", "originalCommit": "916882c85fedea52f1913f2f0fb81d95a5b37517", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzM2ODkzMQ==", "url": "https://github.com/b2ihealthcare/snow-owl/pull/580#discussion_r437368931", "bodyText": "Always compare the constant to the variable, in all cases. Concepts.PENDING_MOVE.equals(myVar)", "author": "cmark", "createdAt": "2020-06-09T12:25:24Z", "path": "snomed/com.b2international.snowowl.validation.snomed/src/main/resources/scripts/rule671.groovy", "diffHunk": "@@ -0,0 +1,55 @@\n+package scripts;\n+\n+import com.b2international.index.query.Expressions\n+import com.b2international.index.query.Query\n+import com.b2international.index.query.Expressions.ExpressionBuilder\n+import com.b2international.index.revision.RevisionSearcher\n+import com.b2international.snowowl.core.ComponentIdentifier\n+import com.b2international.snowowl.core.date.EffectiveTimes\n+import com.b2international.snowowl.snomed.common.SnomedRf2Headers\n+import com.b2international.snowowl.snomed.common.SnomedTerminologyComponentConstants\n+import com.b2international.snowowl.snomed.common.SnomedConstants.Concepts\n+import com.b2international.snowowl.snomed.datastore.index.entry.SnomedConceptDocument\n+import com.b2international.snowowl.snomed.datastore.index.entry.SnomedRefSetMemberIndexEntry\n+import com.google.common.collect.Maps\n+import com.google.common.collect.Sets\n+\n+final Set<ComponentIdentifier> issues = Sets.newHashSet()\n+final RevisionSearcher searcher = ctx.service(RevisionSearcher.class)\n+\n+ExpressionBuilder filterExpressionBuilder = Expressions.builder()\n+\t\t.filter(SnomedConceptDocument.Expressions.inactive())\n+\n+if (params.isUnpublishedOnly) {\n+\tfilterExpressionBuilder.filter(SnomedConceptDocument.Expressions.effectiveTime(EffectiveTimes.UNSET_EFFECTIVE_TIME))\n+}\n+\n+Map<String, SnomedRefSetMemberIndexEntry> members = Maps.newHashMap()\n+\n+Query<String> queryRefsetMembers =Query.select(SnomedRefSetMemberIndexEntry.class)\n+\t\t.from(SnomedRefSetMemberIndexEntry.class)\n+\t\t.where(SnomedRefSetMemberIndexEntry.Expressions.referenceSetId(Concepts.REFSET_CONCEPT_INACTIVITY_INDICATOR))\n+\t\t.limit(Integer.MAX_VALUE)\n+\t\t.build()\n+\n+searcher.search(queryRefsetMembers).forEach({SnomedRefSetMemberIndexEntry member ->\n+\tmembers.put(member.getReferencedComponentId(), member)\n+\n+})\n+\n+Query<String> queryConcepts = Query.select(SnomedConceptDocument.class)\n+\t\t.from(SnomedConceptDocument.class)\n+\t\t.where(filterExpressionBuilder.build())\n+\t\t.limit(Integer.MAX_VALUE)\n+\t\t.build()\n+\n+searcher.search(queryConcepts).forEach({SnomedConceptDocument concept ->\n+\tString inactivationIndicatorId = (String) members.get(concept.getId()).getProperties().get(SnomedRf2Headers.FIELD_VALUE_ID);\n+\tprintln(inactivationIndicatorId)\n+\tif (!(inactivationIndicatorId.equals(Concepts.PENDING_MOVE)|| inactivationIndicatorId.equals(Concepts.LIMITED) ||", "originalCommit": "916882c85fedea52f1913f2f0fb81d95a5b37517", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzM5NDY1Ng==", "url": "https://github.com/b2ihealthcare/snow-owl/pull/580#discussion_r437394656", "bodyText": "Done", "author": "molnarlaura", "createdAt": "2020-06-09T13:00:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzM2ODkzMQ=="}], "type": "inlineReview"}, {"oid": "4104a725ac75c6116b36b1e38711193d1fa912b0", "url": "https://github.com/b2ihealthcare/snow-owl/commit/4104a725ac75c6116b36b1e38711193d1fa912b0", "message": "SO-4103: remove sysout", "committedDate": "2020-06-09T12:44:35Z", "type": "commit"}, {"oid": "31deb5bda808d104f81b21c3f1b17547c099d074", "url": "https://github.com/b2ihealthcare/snow-owl/commit/31deb5bda808d104f81b21c3f1b17547c099d074", "message": "SO-4103: change order of equation", "committedDate": "2020-06-09T12:46:27Z", "type": "commit"}, {"oid": "2449f7c7f93fb3057f5147ab0956d03928488180", "url": "https://github.com/b2ihealthcare/snow-owl/commit/2449f7c7f93fb3057f5147ab0956d03928488180", "message": "SO-4103: fix rule", "committedDate": "2020-06-11T15:09:17Z", "type": "commit"}, {"oid": "9d46e459801c3ac1385e44cfeec1ae31d4299b9a", "url": "https://github.com/b2ihealthcare/snow-owl/commit/9d46e459801c3ac1385e44cfeec1ae31d4299b9a", "message": "SO-4103: add test for rule 671", "committedDate": "2020-06-11T16:06:03Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDA3MDUwNg==", "url": "https://github.com/b2ihealthcare/snow-owl/pull/580#discussion_r440070506", "bodyText": "The unpublished filter should be added to the inactivation indicator members query, not to the concept nor to the descriptions query.", "author": "cmark", "createdAt": "2020-06-15T10:09:35Z", "path": "snomed/com.b2international.snowowl.validation.snomed/src/main/resources/scripts/rule671.groovy", "diffHunk": "@@ -0,0 +1,74 @@\n+package scripts;\n+\n+import com.b2international.index.Hits\n+import com.b2international.index.query.Expressions\n+import com.b2international.index.query.Query\n+import com.b2international.index.query.Expressions.ExpressionBuilder\n+import com.b2international.index.revision.RevisionSearcher\n+import com.b2international.snowowl.core.ComponentIdentifier\n+import com.b2international.snowowl.core.date.EffectiveTimes\n+import com.b2international.snowowl.snomed.common.SnomedRf2Headers\n+import com.b2international.snowowl.snomed.common.SnomedTerminologyComponentConstants\n+import com.b2international.snowowl.snomed.common.SnomedConstants.Concepts\n+import com.b2international.snowowl.snomed.core.domain.SnomedDescription\n+import com.b2international.snowowl.snomed.core.domain.SnomedDescriptions\n+import com.b2international.snowowl.snomed.datastore.index.entry.SnomedConceptDocument\n+import com.b2international.snowowl.snomed.datastore.index.entry.SnomedRefSetMemberIndexEntry\n+import com.b2international.snowowl.snomed.datastore.request.SnomedRequests\n+import com.google.common.collect.Lists\n+import com.google.common.collect.Maps\n+import com.google.common.collect.Sets\n+\n+final Set<ComponentIdentifier> issues = Sets.newHashSet()\n+final RevisionSearcher searcher = ctx.service(RevisionSearcher.class)\n+\n+ExpressionBuilder filterExpressionBuilder = Expressions.builder()\n+\t\t.filter(SnomedConceptDocument.Expressions.inactive())\n+\n+if (params.isUnpublishedOnly) {\n+\tfilterExpressionBuilder.filter(SnomedConceptDocument.Expressions.effectiveTime(EffectiveTimes.UNSET_EFFECTIVE_TIME))", "originalCommit": "9d46e459801c3ac1385e44cfeec1ae31d4299b9a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDk5Njc5OA==", "url": "https://github.com/b2ihealthcare/snow-owl/pull/580#discussion_r440996798", "bodyText": "Done", "author": "molnarlaura", "createdAt": "2020-06-16T16:47:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDA3MDUwNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDA3MDk4NQ==", "url": "https://github.com/b2ihealthcare/snow-owl/pull/580#discussion_r440070985", "bodyText": "Use Set for distinct values and when you don't actually need the index.", "author": "cmark", "createdAt": "2020-06-15T10:10:31Z", "path": "snomed/com.b2international.snowowl.validation.snomed/src/main/resources/scripts/rule671.groovy", "diffHunk": "@@ -0,0 +1,74 @@\n+package scripts;\n+\n+import com.b2international.index.Hits\n+import com.b2international.index.query.Expressions\n+import com.b2international.index.query.Query\n+import com.b2international.index.query.Expressions.ExpressionBuilder\n+import com.b2international.index.revision.RevisionSearcher\n+import com.b2international.snowowl.core.ComponentIdentifier\n+import com.b2international.snowowl.core.date.EffectiveTimes\n+import com.b2international.snowowl.snomed.common.SnomedRf2Headers\n+import com.b2international.snowowl.snomed.common.SnomedTerminologyComponentConstants\n+import com.b2international.snowowl.snomed.common.SnomedConstants.Concepts\n+import com.b2international.snowowl.snomed.core.domain.SnomedDescription\n+import com.b2international.snowowl.snomed.core.domain.SnomedDescriptions\n+import com.b2international.snowowl.snomed.datastore.index.entry.SnomedConceptDocument\n+import com.b2international.snowowl.snomed.datastore.index.entry.SnomedRefSetMemberIndexEntry\n+import com.b2international.snowowl.snomed.datastore.request.SnomedRequests\n+import com.google.common.collect.Lists\n+import com.google.common.collect.Maps\n+import com.google.common.collect.Sets\n+\n+final Set<ComponentIdentifier> issues = Sets.newHashSet()\n+final RevisionSearcher searcher = ctx.service(RevisionSearcher.class)\n+\n+ExpressionBuilder filterExpressionBuilder = Expressions.builder()\n+\t\t.filter(SnomedConceptDocument.Expressions.inactive())\n+\n+if (params.isUnpublishedOnly) {\n+\tfilterExpressionBuilder.filter(SnomedConceptDocument.Expressions.effectiveTime(EffectiveTimes.UNSET_EFFECTIVE_TIME))\n+}\n+\n+List<String> inactiveIds = Lists.newArrayList()", "originalCommit": "9d46e459801c3ac1385e44cfeec1ae31d4299b9a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDk5NzEyMQ==", "url": "https://github.com/b2ihealthcare/snow-owl/pull/580#discussion_r440997121", "bodyText": "Done", "author": "molnarlaura", "createdAt": "2020-06-16T16:47:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDA3MDk4NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDA3MzU1Mw==", "url": "https://github.com/b2ihealthcare/snow-owl/pull/580#discussion_r440073553", "bodyText": "This Map variable still references only a single indicator per description, which is okay, but due to the nature of authoring in Snow Owl, it is possible that two or more indicators exists. There is a rule that checks and reports duplications in refsets, so here you don't need another check, but you have to check all existing members for all descriptions.", "author": "cmark", "createdAt": "2020-06-15T10:15:18Z", "path": "snomed/com.b2international.snowowl.validation.snomed/src/main/resources/scripts/rule671.groovy", "diffHunk": "@@ -0,0 +1,74 @@\n+package scripts;\n+\n+import com.b2international.index.Hits\n+import com.b2international.index.query.Expressions\n+import com.b2international.index.query.Query\n+import com.b2international.index.query.Expressions.ExpressionBuilder\n+import com.b2international.index.revision.RevisionSearcher\n+import com.b2international.snowowl.core.ComponentIdentifier\n+import com.b2international.snowowl.core.date.EffectiveTimes\n+import com.b2international.snowowl.snomed.common.SnomedRf2Headers\n+import com.b2international.snowowl.snomed.common.SnomedTerminologyComponentConstants\n+import com.b2international.snowowl.snomed.common.SnomedConstants.Concepts\n+import com.b2international.snowowl.snomed.core.domain.SnomedDescription\n+import com.b2international.snowowl.snomed.core.domain.SnomedDescriptions\n+import com.b2international.snowowl.snomed.datastore.index.entry.SnomedConceptDocument\n+import com.b2international.snowowl.snomed.datastore.index.entry.SnomedRefSetMemberIndexEntry\n+import com.b2international.snowowl.snomed.datastore.request.SnomedRequests\n+import com.google.common.collect.Lists\n+import com.google.common.collect.Maps\n+import com.google.common.collect.Sets\n+\n+final Set<ComponentIdentifier> issues = Sets.newHashSet()\n+final RevisionSearcher searcher = ctx.service(RevisionSearcher.class)\n+\n+ExpressionBuilder filterExpressionBuilder = Expressions.builder()\n+\t\t.filter(SnomedConceptDocument.Expressions.inactive())\n+\n+if (params.isUnpublishedOnly) {\n+\tfilterExpressionBuilder.filter(SnomedConceptDocument.Expressions.effectiveTime(EffectiveTimes.UNSET_EFFECTIVE_TIME))\n+}\n+\n+List<String> inactiveIds = Lists.newArrayList()\n+\n+searcher.scroll(Query.select(String.class)\n+\t\t.from(SnomedConceptDocument.class)\n+\t\t.fields(SnomedConceptDocument.Fields.ID)\n+\t\t.where(filterExpressionBuilder.build())\n+\t\t.limit(10_000)\n+\t\t.build())\n+\t\t.each({id ->\n+\t\t\tinactiveIds.add(id[0])\n+\t\t})\n+\n+Map<String, SnomedRefSetMemberIndexEntry> members = Maps.newHashMap()", "originalCommit": "9d46e459801c3ac1385e44cfeec1ae31d4299b9a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDk5NzA3MA==", "url": "https://github.com/b2ihealthcare/snow-owl/pull/580#discussion_r440997070", "bodyText": "Done", "author": "molnarlaura", "createdAt": "2020-06-16T16:47:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDA3MzU1Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDA3NTI1NQ==", "url": "https://github.com/b2ihealthcare/snow-owl/pull/580#discussion_r440075255", "bodyText": "Missing unpublished filter.\nIt would be much faster to construct a filter query instead of manually checking every 300.000 indicators each time we hit validate.\nYou can also execute two queries:\nOne for active descriptions where the value is not in the allowed set.\nAnother for inactive descriptions, where you don't have an indicator (hint: negate filter clauses).", "author": "cmark", "createdAt": "2020-06-15T10:18:34Z", "path": "snomed/com.b2international.snowowl.validation.snomed/src/main/resources/scripts/rule671.groovy", "diffHunk": "@@ -0,0 +1,74 @@\n+package scripts;\n+\n+import com.b2international.index.Hits\n+import com.b2international.index.query.Expressions\n+import com.b2international.index.query.Query\n+import com.b2international.index.query.Expressions.ExpressionBuilder\n+import com.b2international.index.revision.RevisionSearcher\n+import com.b2international.snowowl.core.ComponentIdentifier\n+import com.b2international.snowowl.core.date.EffectiveTimes\n+import com.b2international.snowowl.snomed.common.SnomedRf2Headers\n+import com.b2international.snowowl.snomed.common.SnomedTerminologyComponentConstants\n+import com.b2international.snowowl.snomed.common.SnomedConstants.Concepts\n+import com.b2international.snowowl.snomed.core.domain.SnomedDescription\n+import com.b2international.snowowl.snomed.core.domain.SnomedDescriptions\n+import com.b2international.snowowl.snomed.datastore.index.entry.SnomedConceptDocument\n+import com.b2international.snowowl.snomed.datastore.index.entry.SnomedRefSetMemberIndexEntry\n+import com.b2international.snowowl.snomed.datastore.request.SnomedRequests\n+import com.google.common.collect.Lists\n+import com.google.common.collect.Maps\n+import com.google.common.collect.Sets\n+\n+final Set<ComponentIdentifier> issues = Sets.newHashSet()\n+final RevisionSearcher searcher = ctx.service(RevisionSearcher.class)\n+\n+ExpressionBuilder filterExpressionBuilder = Expressions.builder()\n+\t\t.filter(SnomedConceptDocument.Expressions.inactive())\n+\n+if (params.isUnpublishedOnly) {\n+\tfilterExpressionBuilder.filter(SnomedConceptDocument.Expressions.effectiveTime(EffectiveTimes.UNSET_EFFECTIVE_TIME))\n+}\n+\n+List<String> inactiveIds = Lists.newArrayList()\n+\n+searcher.scroll(Query.select(String.class)\n+\t\t.from(SnomedConceptDocument.class)\n+\t\t.fields(SnomedConceptDocument.Fields.ID)\n+\t\t.where(filterExpressionBuilder.build())\n+\t\t.limit(10_000)\n+\t\t.build())\n+\t\t.each({id ->\n+\t\t\tinactiveIds.add(id[0])\n+\t\t})\n+\n+Map<String, SnomedRefSetMemberIndexEntry> members = Maps.newHashMap()\n+\n+searcher.scroll(Query.select(SnomedRefSetMemberIndexEntry.class)\n+\t\t.from(SnomedRefSetMemberIndexEntry.class)\n+\t\t.where(SnomedRefSetMemberIndexEntry.Expressions.referenceSetId(Concepts.REFSET_DESCRIPTION_INACTIVITY_INDICATOR))", "originalCommit": "9d46e459801c3ac1385e44cfeec1ae31d4299b9a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDk5NzAzNw==", "url": "https://github.com/b2ihealthcare/snow-owl/pull/580#discussion_r440997037", "bodyText": "Done", "author": "molnarlaura", "createdAt": "2020-06-16T16:47:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDA3NTI1NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDA3NzI5Mw==", "url": "https://github.com/b2ihealthcare/snow-owl/pull/580#discussion_r440077293", "bodyText": "There is no test for active description with incorrect indicator value in the refset.\nThere is no test for inactive description without any indicator value in the refset.", "author": "cmark", "createdAt": "2020-06-15T10:22:36Z", "path": "snomed/com.b2international.snowowl.validation.snomed/src/test/java/com/b2international/snowowl/validation/snomed/GenericValidationRuleTest.java", "diffHunk": "@@ -499,5 +499,36 @@ public void rule670() throws Exception {\n \t\tassertAffectedComponents(issues, \n \t\t\t\tComponentIdentifier.of(SnomedTerminologyComponentConstants.CONCEPT_NUMBER, Concepts.IS_A));\n \t}\n+\n+\t@Test\n+\tpublic void rule671() throws Exception {\n+\t\tfinal String ruleId = \"671\";\n+\t\tindexRule(ruleId);\n+\t\t\n+\t\tString conceptId = generateConceptId();\n+\t\tSnomedDescriptionIndexEntry fsn = description(generateDescriptionId(), Concepts.FULLY_SPECIFIED_NAME, \"Fully specified name 3 (tag)\")\n+\t\t\t\t.conceptId(conceptId)\n+\t\t\t\t.acceptability(Concepts.REFSET_LANGUAGE_TYPE_ES, Acceptability.PREFERRED)\n+\t\t\t\t.build();\n+\t\tSnomedDescriptionIndexEntry pt = description(generateDescriptionId(), Concepts.SYNONYM, \"Preferred term 3\")\n+\t\t\t\t.acceptability(Concepts.REFSET_LANGUAGE_TYPE_ES, Acceptability.PREFERRED)\n+\t\t\t\t.conceptId(conceptId)\n+\t\t\t\t.build();\n+\t\tSnomedRefSetMemberIndexEntry ptMember = member(pt.getId(), SnomedTerminologyComponentConstants.DESCRIPTION_NUMBER, Concepts.REFSET_DESCRIPTION_INACTIVITY_INDICATOR).valueId(Concepts.CONCEPT_NON_CURRENT).build();", "originalCommit": "9d46e459801c3ac1385e44cfeec1ae31d4299b9a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDk5Njk3Mg==", "url": "https://github.com/b2ihealthcare/snow-owl/pull/580#discussion_r440996972", "bodyText": "Done", "author": "molnarlaura", "createdAt": "2020-06-16T16:47:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDA3NzI5Mw=="}], "type": "inlineReview"}, {"oid": "c71070368d91f9558d5158f0601b765e64118bbc", "url": "https://github.com/b2ihealthcare/snow-owl/commit/c71070368d91f9558d5158f0601b765e64118bbc", "message": "SO-4103: add new cases for testing rule 671", "committedDate": "2020-06-16T09:50:24Z", "type": "commit"}, {"oid": "7d13d7c23b4056e3f3f188886a2059733e60218f", "url": "https://github.com/b2ihealthcare/snow-owl/commit/7d13d7c23b4056e3f3f188886a2059733e60218f", "message": "SO-4103: change filtering logic", "committedDate": "2020-06-16T10:14:23Z", "type": "commit"}, {"oid": "8fc25cfa78ea555ff72754410a7f68cf1d8b6e86", "url": "https://github.com/b2ihealthcare/snow-owl/commit/8fc25cfa78ea555ff72754410a7f68cf1d8b6e86", "message": "SO-4103: fix test", "committedDate": "2020-06-16T13:18:27Z", "type": "commit"}, {"oid": "91e2695eb858b19268b50ff626e2139831b81e25", "url": "https://github.com/b2ihealthcare/snow-owl/commit/91e2695eb858b19268b50ff626e2139831b81e25", "message": "SO-4103: refactor script", "committedDate": "2020-06-16T13:22:46Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTM4ODcyNA==", "url": "https://github.com/b2ihealthcare/snow-owl/pull/580#discussion_r441388724", "bodyText": "Rename this variable to activeDescriptionIndicatorIds.", "author": "cmark", "createdAt": "2020-06-17T08:53:14Z", "path": "snomed/com.b2international.snowowl.validation.snomed/src/main/resources/scripts/rule671.groovy", "diffHunk": "@@ -0,0 +1,93 @@\n+package scripts;\n+\n+import com.b2international.index.query.Expressions\n+import com.b2international.index.query.Query\n+import com.b2international.index.query.Expressions.ExpressionBuilder\n+import com.b2international.index.revision.RevisionSearcher\n+import com.b2international.snowowl.core.ComponentIdentifier\n+import com.b2international.snowowl.core.date.EffectiveTimes\n+import com.b2international.snowowl.snomed.common.SnomedTerminologyComponentConstants\n+import com.b2international.snowowl.snomed.common.SnomedConstants.Concepts\n+import com.b2international.snowowl.snomed.core.domain.SnomedDescription\n+import com.b2international.snowowl.snomed.core.domain.SnomedDescriptions\n+import com.b2international.snowowl.snomed.datastore.index.entry.SnomedConceptDocument\n+import com.b2international.snowowl.snomed.datastore.index.entry.SnomedDescriptionIndexEntry\n+import com.b2international.snowowl.snomed.datastore.index.entry.SnomedRefSetMemberIndexEntry\n+import com.b2international.snowowl.snomed.datastore.request.SnomedRequests\n+import com.google.common.collect.ArrayListMultimap\n+import com.google.common.collect.ImmutableList\n+import com.google.common.collect.Lists\n+import com.google.common.collect.Sets\n+\n+final Set<ComponentIdentifier> issues = Sets.newHashSet()\n+final RevisionSearcher searcher = ctx.service(RevisionSearcher.class)\n+final List<String> filterIndicatorIds = ImmutableList.of(Concepts.PENDING_MOVE, Concepts.LIMITED, Concepts.CONCEPT_NON_CURRENT)", "originalCommit": "91e2695eb858b19268b50ff626e2139831b81e25", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTM5Mjc2MQ==", "url": "https://github.com/b2ihealthcare/snow-owl/pull/580#discussion_r441392761", "bodyText": "Done", "author": "molnarlaura", "createdAt": "2020-06-17T08:59:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTM4ODcyNA=="}], "type": "inlineReview"}, {"oid": "c1b24f2413cda8b5c1ed87bd3f360110b0566e7b", "url": "https://github.com/b2ihealthcare/snow-owl/commit/c1b24f2413cda8b5c1ed87bd3f360110b0566e7b", "message": "SO-4103: rename variable", "committedDate": "2020-06-17T08:59:10Z", "type": "commit"}]}