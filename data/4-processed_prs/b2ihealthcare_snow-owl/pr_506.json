{"pr_number": 506, "pr_title": "Introduce CodeSystemURI and CodeSystemResourceRequest", "pr_createdAt": "2020-03-04T13:26:25Z", "pr_url": "https://github.com/b2ihealthcare/snow-owl/pull/506", "timeline": [{"oid": "bafacd00c5bbe8a6884bb1ec4995d001167b0e7a", "url": "https://github.com/b2ihealthcare/snow-owl/commit/bafacd00c5bbe8a6884bb1ec4995d001167b0e7a", "message": "[api] introduce CodeSystemURI and CodeSystemResourceRequest\n\nSupport `build(uri)` request builder method on selected SNOMED CT APIs.\nThis allows clients to call the API with a CodeSystemURI String\nrepresentation instead of specifying the repositoryId and branch to\ndelegate the request to.\nCodeSystemURI represents a String in format of `<CODESYSTEM>[/<PATH>]`,\nwhere:\n- `<CODESYSTEM>` is the shortName ID of a Code System\n- `<PATH>` is one of the following values:\n  * `LATEST` - special value that represents the latest released version\nof the codesystem. This is the default value if PATH is omitted.\nExamples: `SNOMEDCT` (implicit latest) or `SNOMEDCT/LATEST` (explicit\nlatest).\n  * `HEAD` - special value that represents the latest development\nversion of the codesystem. Examples: `SNOMEDCT/HEAD`\n  * `<versionId>` - an explicit `versionId` that matches one existing\nversion of the Code System. Examples: `SNOMEDCT/2019-01-31` or\n`SNOMEDCT-UK/2019-10-31`\n  * `<branch_path>` - any other path value will be treated as relative\npath to the CodeSystem's current working branch\n(`CodeSystem.branchPath`). Examples: `SNOMEDCT/a/b`.\n\nThis new feature is available in all endpoints that require a `/:path`\nparameter.", "committedDate": "2020-03-04T13:25:43Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzY3MzQ0Mw==", "url": "https://github.com/b2ihealthcare/snow-owl/pull/506#discussion_r387673443", "bodyText": "The code system version search request is only used in the else block below; move the local variable declaration inside the block.", "author": "apeteri", "createdAt": "2020-03-04T13:43:26Z", "path": "core/com.b2international.snowowl.datastore/src/com/b2international/snowowl/datastore/request/CodeSystemResourceRequest.java", "diffHunk": "@@ -0,0 +1,101 @@\n+/*\n+ * Copyright 2020 B2i Healthcare Pte Ltd, http://b2i.sg\n+ * \n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.b2international.snowowl.datastore.request;\n+\n+import com.b2international.snowowl.core.ServiceProvider;\n+import com.b2international.snowowl.core.domain.BranchContext;\n+import com.b2international.snowowl.core.events.DelegatingRequest;\n+import com.b2international.snowowl.core.events.Request;\n+import com.b2international.snowowl.core.request.SearchResourceRequest;\n+import com.b2international.snowowl.core.uri.CodeSystemURI;\n+import com.b2international.snowowl.datastore.CodeSystemEntry;\n+import com.b2international.snowowl.datastore.CodeSystemVersionEntry;\n+import com.b2international.snowowl.terminologyregistry.core.request.CodeSystemRequests;\n+import com.b2international.snowowl.terminologyregistry.core.request.CodeSystemVersionSearchRequestBuilder;\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+\n+/**\n+ * @since 7.5\n+ */\n+public final class CodeSystemResourceRequest<R> extends DelegatingRequest<ServiceProvider, BranchContext, R> {\n+\n+\tprivate static final long serialVersionUID = 1L;\n+\t\n+\t@JsonProperty\n+\tprivate final CodeSystemURI uri;\n+\t\n+\tprivate transient CodeSystemEntry codeSystem;\n+\t\n+\tprivate transient String branchPath;\n+\t\n+\tCodeSystemResourceRequest(String codeSystemUri, Request<BranchContext, R> next) {\n+\t\tsuper(next);\n+\t\tthis.uri = new CodeSystemURI(codeSystemUri);\n+\t}\n+\n+\t@Override\n+\tpublic R execute(ServiceProvider context) {\n+\t\treturn new RepositoryRequest<R>(getRepositoryId(context),\n+\t\t\tnew BranchRequest<R>(getBranchPath(context),\n+\t\t\t\tnext()\n+\t\t\t)\n+\t\t).execute(context);\n+\t}\n+\n+\tpublic CodeSystemEntry getCodeSystem(ServiceProvider context) {\n+\t\tif (codeSystem == null) {\n+\t\t\tcodeSystem = CodeSystemRequests.getCodeSystem(context, uri.getCodeSystem());\n+\t\t}\n+\t\treturn codeSystem;\n+\t}\n+\t\n+\tpublic String getRepositoryId(ServiceProvider context) {\n+\t\treturn getCodeSystem(context).getRepositoryUuid();\n+\t}\n+\t\n+\tpublic String getBranchPath(ServiceProvider context) {\n+\t\tif (branchPath == null) {\n+\t\t\tCodeSystemVersionSearchRequestBuilder versionSearch = CodeSystemRequests.prepareSearchCodeSystemVersion()\n+\t\t\t\t.one()\n+\t\t\t\t.filterByCodeSystemShortName(codeSystem.getShortName());", "originalCommit": "bafacd00c5bbe8a6884bb1ec4995d001167b0e7a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzY3NTQ5MA==", "url": "https://github.com/b2ihealthcare/snow-owl/pull/506#discussion_r387675490", "bodyText": "Is there any replacement for this build method?", "author": "apeteri", "createdAt": "2020-03-04T13:47:05Z", "path": "core/com.b2international.snowowl.datastore/src/com/b2international/snowowl/datastore/request/RepositoryCommitRequestBuilder.java", "diffHunk": "@@ -84,18 +85,5 @@ public final RepositoryCommitRequestBuilder setParentContextDescription(String p\n \tprotected final Request<BranchContext, CommitResult> doBuild() {\n \t\treturn new TransactionalRequest(author, commitComment, getBody(), preparationTime, parentContextDescription);\n \t}\n-\t\n-\tpublic AsyncRequest<CommitResult> build(String repositoryId, String branch) {", "originalCommit": "bafacd00c5bbe8a6884bb1ec4995d001167b0e7a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzc1MjAxNQ==", "url": "https://github.com/b2ihealthcare/snow-owl/pull/506#discussion_r387752015", "bodyText": "This was the same build method as the one in RevisionIndexRequestBuilder.", "author": "cmark", "createdAt": "2020-03-04T15:43:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzY3NTQ5MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzY3NjAyNg==", "url": "https://github.com/b2ihealthcare/snow-owl/pull/506#discussion_r387676026", "bodyText": "The URI-based alternative doesn't include the health check request wrapper.", "author": "apeteri", "createdAt": "2020-03-04T13:48:03Z", "path": "core/com.b2international.snowowl.datastore/src/com/b2international/snowowl/datastore/request/RevisionIndexRequestBuilder.java", "diffHunk": "@@ -29,14 +30,32 @@\n  * @since 5.7\n  * @param <R> - the return type\n  */\n-public interface RevisionIndexRequestBuilder<R> extends RequestBuilder<BranchContext, R> {\n+public interface RevisionIndexRequestBuilder<R> extends BranchRequestBuilder<R> {\n \n+\t@Override\n \tdefault AsyncRequest<R> build(String repositoryId, String branch) {\n-\t\treturn new AsyncRequest<>(\n-\t\t\tnew RepositoryRequest<>(repositoryId,\n-\t\t\t\tnew BranchRequest<>(branch, \n-\t\t\t\t\tnew RevisionIndexReadRequest<>(build())\n+\t\t// if the branch starts with MAIN, then it is an explicit branch path with a repositoryId\n+\t\tif (Strings.nullToEmpty(branch).startsWith(Branch.MAIN_PATH)) {\n+\t\t\treturn new AsyncRequest<>(\n+\t\t\t\tnew RepositoryRequest<>(repositoryId,\n+\t\t\t\t\tnew HealthCheckingRequest<>(\n+\t\t\t\t\t\tnew BranchRequest<>(branch, \n+\t\t\t\t\t\t\tnew RevisionIndexReadRequest<>(build())\n+\t\t\t\t\t\t),\n+\t\t\t\t\t\tallowedHealthstates()\n+\t\t\t\t\t)\n \t\t\t\t)\n+\t\t\t);\n+\t\t} else {\n+\t\t\treturn build(branch);\n+\t\t}\n+\t}\n+\t\n+\tdefault AsyncRequest<R> build(String codeSystemUri) {\n+\t\treturn new AsyncRequest<>(\n+\t\t\tnew CodeSystemResourceRequest<>(\n+\t\t\t\tcodeSystemUri,\n+\t\t\t\tnew RevisionIndexReadRequest<>(build())", "originalCommit": "bafacd00c5bbe8a6884bb1ec4995d001167b0e7a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzc1MjIwOQ==", "url": "https://github.com/b2ihealthcare/snow-owl/pull/506#discussion_r387752209", "bodyText": "It does, internally.", "author": "cmark", "createdAt": "2020-03-04T15:43:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzY3NjAyNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzY3NzAwOQ==", "url": "https://github.com/b2ihealthcare/snow-owl/pull/506#discussion_r387677009", "bodyText": "What is the general consensus around repositories with YELLOW health? Can those still be read?", "author": "apeteri", "createdAt": "2020-03-04T13:49:46Z", "path": "core/com.b2international.snowowl.datastore/src/com/b2international/snowowl/terminologyregistry/core/request/CodeSystemRequests.java", "diffHunk": "@@ -47,5 +57,46 @@ public static CodeSystemVersionSearchRequestBuilder prepareSearchCodeSystemVersi\n \tpublic static CodeSystemVersionCreateRequestBuilder prepareNewCodeSystemVersion() {\n \t\treturn new CodeSystemVersionCreateRequestBuilder();\n \t}\n+\n+\t/**\n+\t * Returns all {@link CodeSystemEntry}s from all repositories.\n+\t * @param context\n+\t * @return\n+\t */\n+\tpublic static List<CodeSystemEntry> getAllCodeSystems(ServiceProvider context) {\n+\t\tfinal Repositories repositories = RepositoryRequests.prepareSearch()\n+\t\t\t.all()\n+\t\t\t.build()\n+\t\t\t.execute(context);\n+\t\t\n+\t\treturn repositories.getItems()\n+\t\t\t.stream()\n+\t\t\t.filter( repository -> RepositoryInfo.Health.GREEN == repository.health() )", "originalCommit": "bafacd00c5bbe8a6884bb1ec4995d001167b0e7a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzc1NDQ1Nw==", "url": "https://github.com/b2ihealthcare/snow-owl/pull/506#discussion_r387754457", "bodyText": "Yes, they can be read, I'll add yellow health state as well here.", "author": "cmark", "createdAt": "2020-03-04T15:46:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzY3NzAwOQ=="}], "type": "inlineReview"}, {"oid": "148b30aedf711bd8c993b8bcfdaf44f956f62b0f", "url": "https://github.com/b2ihealthcare/snow-owl/commit/148b30aedf711bd8c993b8bcfdaf44f956f62b0f", "message": "[api] fix failed ECL test cases", "committedDate": "2020-03-04T14:08:04Z", "type": "commit"}, {"oid": "12fea15f5ca87521d5c5c9e9d4aadcbd35a898dc", "url": "https://github.com/b2ihealthcare/snow-owl/commit/12fea15f5ca87521d5c5c9e9d4aadcbd35a898dc", "message": "[api] minor PR changes related to CodeSystemURI API feature", "committedDate": "2020-03-04T15:47:48Z", "type": "commit"}, {"oid": "2aeb0b5d4e591bccf192cd5f58dabb2e480fbc44", "url": "https://github.com/b2ihealthcare/snow-owl/commit/2aeb0b5d4e591bccf192cd5f58dabb2e480fbc44", "message": "[api] use health checking request properly in new CodeSystemRequests...\n\n...helper methods", "committedDate": "2020-03-04T15:53:23Z", "type": "commit"}]}