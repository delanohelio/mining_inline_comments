{"pr_number": 545, "pr_title": "INFRA-30: Extract docker image build to separate job", "pr_createdAt": "2020-04-26T22:55:27Z", "pr_url": "https://github.com/b2ihealthcare/snow-owl/pull/545", "timeline": [{"oid": "583bb49765ff6b37e4651b167b815e8e27843d3c", "url": "https://github.com/b2ihealthcare/snow-owl/commit/583bb49765ff6b37e4651b167b815e8e27843d3c", "message": "INFRA-30: Make product name and repo url configurable during docker ...\n\n... build\n\nhttps://snowowl.atlassian.net/browse/INFRA-30", "committedDate": "2020-04-26T13:50:52Z", "type": "commit"}, {"oid": "7b4f5e671ec896661b0005560c5de6812f9b1fd9", "url": "https://github.com/b2ihealthcare/snow-owl/commit/7b4f5e671ec896661b0005560c5de6812f9b1fd9", "message": "INFRA-30: Rename version argument to 'tag'\n\nhttps://snowowl.atlassian.net/browse/INFRA-30", "committedDate": "2020-04-26T19:49:12Z", "type": "commit"}, {"oid": "9c9288c7a83ca89ce88dc6f31129653876364e14", "url": "https://github.com/b2ihealthcare/snow-owl/commit/9c9288c7a83ca89ce88dc6f31129653876364e14", "message": "INFRA-30: Move docker image build to separate Jenkins job\n\nhttps://snowowl.atlassian.net/browse/INFRA-30", "committedDate": "2020-04-26T22:01:48Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTU2NTQxMw==", "url": "https://github.com/b2ihealthcare/snow-owl/pull/545#discussion_r415565413", "bodyText": "Set the old default values to the arguments, so anyone who comes to this repo can build the image with just docker build ..\nI know Nexus is something that's still required, we will remove that dependency in the next iteration of the docker build process.", "author": "cmark", "createdAt": "2020-04-27T07:11:43Z", "path": "docker/Dockerfile", "diffHunk": "@@ -40,22 +42,22 @@ EXPOSE 2036 8080\n \n LABEL org.label-schema.build-date=\"${BUILD_TIMESTAMP}\" \\\n   org.label-schema.vcs-ref=\"${GIT_REVISION}\" \\\n-  org.label-schema.version=\"${VERSION}\" \\\n+  org.label-schema.version=\"${TAG}\" \\\n   org.label-schema.license=\"Apache-2.0\" \\\n-  org.label-schema.name=\"Snow Owl OSS\" \\\n+  org.label-schema.name=\"${PRODUCT_NAME}\" \\\n   org.label-schema.schema-version=\"1.0\" \\\n-  org.label-schema.url=\"https://github.com/b2ihealthcare/snow-owl\" \\", "originalCommit": "9c9288c7a83ca89ce88dc6f31129653876364e14", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTY0NTgzMQ==", "url": "https://github.com/b2ihealthcare/snow-owl/pull/545#discussion_r415645831", "bodyText": "Default values are set for arguments so the image can be built as before", "author": "nagyo", "createdAt": "2020-04-27T09:12:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTU2NTQxMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTY3MTUyOA==", "url": "https://github.com/b2ihealthcare/snow-owl/pull/545#discussion_r415671528", "bodyText": "I see them now, okay.", "author": "cmark", "createdAt": "2020-04-27T09:50:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTU2NTQxMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTY2MTI2Ng==", "url": "https://github.com/b2ihealthcare/snow-owl/pull/545#discussion_r415661266", "bodyText": "Is there a default value given for the registry in the docker build job?", "author": "apeteri", "createdAt": "2020-04-27T09:35:25Z", "path": "Jenkinsfile", "diffHunk": "@@ -39,52 +31,30 @@ node('docker') {\n \t\t\t\t\tsh \"mvn clean deploy -Dmaven.test.skip=${skipTests} -Dmaven.install.skip=true -Dtycho.localArtifacts=ignore\"\n \t\t\t\t}\n \t\t\t}\n-\n+\t\t\t\n \t\t}\n+\t\t\n+\t}\n \n-\t\tif (currentBuild.resultIsBetterOrEqualTo('SUCCESS')) {\n-\n-\t\t\tstage('Find artifact') {\n-\n-\t\t\t\tdef artifact = findFiles(glob: \"releng/com.b2international.snowowl.server.update/target/snow-owl-oss*.tar.gz\")[0]\n-\t\t\t\tsh '\\\\cp -f -t ${WORKSPACE}/docker '+artifact.path+''\n-\t\t\t\tserverArtifact = artifact.name\n-\n-\t\t\t}\n-\n-\t\t\tdef buildArgs = \"--build-arg SNOWOWL_INSTALL_PACKAGE=${serverArtifact}\\\n-\t\t\t\t\t--build-arg BUILD_TIMESTAMP=\\\"${BUILD_TIMESTAMP}\\\"\\\n-\t\t\t\t\t--build-arg VERSION=${tag}\\\n-\t\t\t\t\t--build-arg GIT_REVISION=${revision} ./docker\"\n-\n-\t\t\tstage('Build docker image') {\n-\n-\t\t\t\tdocker.withRegistry('', '0f4c3f31-b252-4104-928a-286eeeb075dc') {\n-\n-\t\t\t\t\tdef image = docker.build(\"b2ihealthcare/snow-owl-oss:${tag}\", \"${buildArgs}\")\n-\t\t\t\t\timage.push()\n-\n-\t\t\t\t\tif (!currentVersion.contains(\"SNAPSHOT\")) {\n-\t\t\t\t\t\timage.push(\"latest\")\n-\t\t\t\t\t}\n-\n-\t\t\t\t}\n-\n-\t\t\t}\n-\n-\t\t\tstage('Clean up') {\n-\t\t\t\tsh 'rm -fv docker/*.tar.gz'\n-\t\t\t\tsh 'docker system prune --force --all --volumes'\n-\t\t\t}\n-\n-\t\t}\n+\tif (currentBuild.resultIsBetterOrEqualTo('SUCCESS')) {\n+\t\t\n+\t\tbuild job: 'snow-owl-docker-build', parameters: [\n+\t\t\tstring(name: 'groupId', value: 'com.b2international.snowowl'),\n+\t\t\tstring(name: 'artifactId', value: 'com.b2international.snowowl.server.update'),\n+\t\t\tstring(name: 'artifactVersion', value: currentVersion),\n+\t\t\tstring(name: 'classifier', value: 'oss'),\n+\t\t\tstring(name: 'extension', value: 'tar.gz'),\n+\t\t\tstring(name: 'imageClassifier', value: 'oss'),\n+\t\t\tstring(name: 'gitRevision', value: revision),", "originalCommit": "9c9288c7a83ca89ce88dc6f31129653876364e14", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTY2NTI2MA==", "url": "https://github.com/b2ihealthcare/snow-owl/pull/545#discussion_r415665260", "bodyText": "yes, empty registry means hub.docker.com", "author": "nagyo", "createdAt": "2020-04-27T09:41:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTY2MTI2Ng=="}], "type": "inlineReview"}]}