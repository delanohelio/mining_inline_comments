{"pr_number": 709, "pr_title": "SO-4460: track array property changes", "pr_createdAt": "2020-11-07T17:12:17Z", "pr_url": "https://github.com/b2ihealthcare/snow-owl/pull/709", "timeline": [{"oid": "1ae44b8882a22dc345bdf0b0223be44734d15269", "url": "https://github.com/b2ihealthcare/snow-owl/commit/1ae44b8882a22dc345bdf0b0223be44734d15269", "message": "SO-4660: support array property tracking properly\n\nRegister a single change per array property field.\nFromValue is the old array JSON string.\nNewValue is the new array JSON string.", "committedDate": "2020-11-06T17:20:57Z", "type": "commit"}, {"oid": "51008d1666f6884e30bb02cd2694a824dda88100", "url": "https://github.com/b2ihealthcare/snow-owl/commit/51008d1666f6884e30bb02cd2694a824dda88100", "message": "SO-4460: add branch merge resolable array property conflict test", "committedDate": "2020-11-07T16:40:20Z", "type": "commit"}, {"oid": "493cd47f5163610df977ab746cef4914e833b051", "url": "https://github.com/b2ihealthcare/snow-owl/commit/493cd47f5163610df977ab746cef4914e833b051", "message": "[index] remove unused close method from IndexClient", "committedDate": "2020-11-07T16:40:58Z", "type": "commit"}, {"oid": "6d53e5b8ca7c19d7252afd8a4c03a38ad0e7acac", "url": "https://github.com/b2ihealthcare/snow-owl/commit/6d53e5b8ca7c19d7252afd8a4c03a38ad0e7acac", "message": "[index] remove unused setRevised from Revision\n\nMove `Revision.toBuilder()` method to `RevisionDocument`", "committedDate": "2020-11-07T16:42:25Z", "type": "commit"}, {"oid": "57232cbf8021fd581801523c51e7c62e9b18753a", "url": "https://github.com/b2ihealthcare/snow-owl/commit/57232cbf8021fd581801523c51e7c62e9b18753a", "message": "[index] remove unused isRoot method from Revision class", "committedDate": "2020-11-07T16:43:44Z", "type": "commit"}, {"oid": "1fe242c00f243e97c12f03188322fdbf05e9678b", "url": "https://github.com/b2ihealthcare/snow-owl/commit/1fe242c00f243e97c12f03188322fdbf05e9678b", "message": "[index] add isDirty check to `StagingArea.commit()`", "committedDate": "2020-11-07T16:52:28Z", "type": "commit"}, {"oid": "2aa99f5796a2379e52a0c7dcb265b4a25c6c3b98", "url": "https://github.com/b2ihealthcare/snow-owl/commit/2aa99f5796a2379e52a0c7dcb265b4a25c6c3b98", "message": "[index] remove unused update branch script from Commit", "committedDate": "2020-11-07T16:54:10Z", "type": "commit"}, {"oid": "07d09edfbfad88fb995c7d1af19d0a6b5b4b915b", "url": "https://github.com/b2ihealthcare/snow-owl/commit/07d09edfbfad88fb995c7d1af19d0a6b5b4b915b", "message": "[index] remove unused Scroll constructors", "committedDate": "2020-11-07T16:59:44Z", "type": "commit"}, {"oid": "fdb64addd180bb27a03926f691b75d3747d9bf18", "url": "https://github.com/b2ihealthcare/snow-owl/commit/fdb64addd180bb27a03926f691b75d3747d9bf18", "message": "[index] remove unused `BulkUpdate.getIdField()`", "committedDate": "2020-11-07T17:02:53Z", "type": "commit"}, {"oid": "8b28663442d251360ffcfda2cd02ed1b0148fc17", "url": "https://github.com/b2ihealthcare/snow-owl/commit/8b28663442d251360ffcfda2cd02ed1b0148fc17", "message": "[index] add isDirty check to `StagingArea.commit()` (fix merge commits)", "committedDate": "2020-11-07T17:11:21Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDQyMTMyMg==", "url": "https://github.com/b2ihealthcare/snow-owl/pull/709#discussion_r520421322", "bodyText": "It turns out there is exactly one caller of TransactionContext#commit that is interested in the timestamp, returned via a CommitResult instance: \n  \n    \n      snow-owl/snomed/com.b2international.snowowl.snomed.reasoner/src/com/b2international/snowowl/snomed/reasoner/request/SaveJobRequest.java\n    \n    \n         Line 216\n      in\n      7f5e60d\n    \n    \n    \n    \n\n        \n          \n           classificationTracker.classificationSaved(classificationId, commitResult.getCommitTimestamp());", "author": "apeteri", "createdAt": "2020-11-10T09:40:16Z", "path": "core/com.b2international.snowowl.core/src/com/b2international/snowowl/core/repository/RepositoryTransactionContext.java", "diffHunk": "@@ -280,7 +280,7 @@ public Long commit(String author, String commitComment, String parentLockContext\n \t\t\tlog().info(\"Persisting changes to {}@{}\", path(), timestamp);\n \t\t\tcommit = staging.commit(null, timestamp, author, commitComment);\n \t\t\tlog().info(\"Changes have been successfully persisted to {}@{}.\", path(), timestamp);\n-\t\t\treturn commit == null ? null : commit.getTimestamp();\n+\t\t\treturn commit == null ? Commit.NO_COMMIT_TIMESTAMP : commit.getTimestamp();", "originalCommit": "8b28663442d251360ffcfda2cd02ed1b0148fc17", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDQyNjExMw==", "url": "https://github.com/b2ihealthcare/snow-owl/pull/709#discussion_r520426113", "bodyText": "Please add a comment somewhere that this field is only updated in Elasticsearch via the updateRevised script defined at the top, is never de-serialized (so if one looks at a Revision instance, it will not contain the revised branch+timestamp pairs) and is used in ES search expressions only.\nI got a bit confused when I saw that the setter could be removed, Jackson is only using the field when converting to JSON, it is always initialized with an empty list and no one is interested in the contents in Java either \ud83d\ude03", "author": "apeteri", "createdAt": "2020-11-10T09:47:15Z", "path": "commons/com.b2international.index/src/com/b2international/index/revision/Revision.java", "diffHunk": "@@ -73,10 +76,6 @@ final void setCreated(RevisionBranchPoint created) {\n \t\tthis.created = created;\n \t}\n \t\n-\tfinal void setRevised(List<RevisionBranchPoint> revised) {", "originalCommit": "8b28663442d251360ffcfda2cd02ed1b0148fc17", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDQyODI0Mw==", "url": "https://github.com/b2ihealthcare/snow-owl/pull/709#discussion_r520428243", "bodyText": "The inner Builder class could also be pushed down to RevisionDocument, like this method.", "author": "apeteri", "createdAt": "2020-11-10T09:50:29Z", "path": "commons/com.b2international.index/src/com/b2international/index/revision/Revision.java", "diffHunk": "@@ -122,15 +112,6 @@ protected ToStringHelper doToString() {\n \t\t\t\t.add(Revision.Fields.REVISED, revised);\n \t}\n \t\n-\t/**\n-\t * Converts an immutable object into a mutable builder with the usual prefixless setter methods.\n-\t * \n-\t * @return\n-\t */\n-\tprotected Builder<?, ? extends Revision> toBuilder() {", "originalCommit": "8b28663442d251360ffcfda2cd02ed1b0148fc17", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDQ2MjQ0Nw==", "url": "https://github.com/b2ihealthcare/snow-owl/pull/709#discussion_r520462447", "bodyText": "Yes, true, but there is one class that has this method implemented in the index.tests sources.", "author": "cmark", "createdAt": "2020-11-10T10:41:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDQyODI0Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDQ2Nzk2MA==", "url": "https://github.com/b2ihealthcare/snow-owl/pull/709#discussion_r520467960", "bodyText": "It is used by a handful of rebase tests in RevisionBranchMergeConflictTest which could be replaced with withXYZ methods (making the builder on RevisionData also redundant, and allowing this refactor to take place). They take the revision and change a single field on it.", "author": "apeteri", "createdAt": "2020-11-10T10:50:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDQyODI0Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDQ0MTQ3NQ==", "url": "https://github.com/b2ihealthcare/snow-owl/pull/709#discussion_r520441475", "bodyText": "These two properties could be added to fieldsToSkip at initialization time. Otherwise Revision.Fields.REVISED will needlessly undergo the collection-like conversion above \ud83e\udd14", "author": "apeteri", "createdAt": "2020-11-10T10:09:31Z", "path": "commons/com.b2international.index/src/com/b2international/index/revision/StagingArea.java", "diffHunk": "@@ -859,19 +849,39 @@ private RevisionDiff(Revision oldRevision, Revision newRevision) {\n \t\tpublic boolean hasChanges() {\n \t\t\treturn rawDiff().size() > 0;\n \t\t}\n+\t\t\n+\t\tpublic DocumentMapping getMapping() {\n+\t\t\treturn index.admin().mappings().getMapping(newRevision.getClass());\n+\t\t}\n \n \t\tprivate ArrayNode rawDiff() {\n \t\t\tif (rawDiff == null) {\n+\t\t\t\tfinal DocumentMapping mapping = getMapping();\n \t\t\t\tObjectNode oldRevisionSource = mapper.valueToTree(oldRevision);\n \t\t\t\tObjectNode newRevisionSource = mapper.valueToTree(newRevision);\n \t\t\t\tfinal JsonNode diff = JsonDiff.asJson(oldRevisionSource, newRevisionSource, DIFF_FLAGS);\n \t\t\t\tfinal ArrayNode rawDiff = ClassUtils.checkAndCast(diff, ArrayNode.class);\n \t\t\t\tfinal ArrayNode filteredRawDiff = mapper.createArrayNode();\n \t\t\t\tfinal Iterator<JsonNode> elements = rawDiff.elements();\n+\t\t\t\tSet<String> fieldsToSkip = null; \n \t\t\t\twhile (elements.hasNext()) {\n-\t\t\t\t\tJsonNode node = elements.next();\n-\t\t\t\t\tfinal ObjectNode change = ClassUtils.checkAndCast(node, ObjectNode.class);\n-\t\t\t\t\tfinal String property = change.get(\"path\").asText().substring(1);\n+\t\t\t\t\tObjectNode change = ClassUtils.checkAndCast(elements.next(), ObjectNode.class);\n+\t\t\t\t\tfinal String property = getChangeRootProperty(change);\n+\t\t\t\t\t\n+\t\t\t\t\tif (fieldsToSkip != null && fieldsToSkip.contains(property)) {\n+\t\t\t\t\t\tcontinue;\n+\t\t\t\t\t}\n+\t\t\t\t\t\n+\t\t\t\t\t// in case of a collection-like tracked property, convert the first diff to a full prop diff and ignore the rest of the prop changes on the same property\n+\t\t\t\t\tif (mapping.getRevisionFields().contains(property) && mapping.isCollection(property)) {\n+\t\t\t\t\t\t// construct a replacement JSON array patch node\n+\t\t\t\t\t\tchange = new RevisionPropertyDiff(property, serializeToCommitDetailValue(oldRevisionSource, property), serializeToCommitDetailValue(newRevisionSource, property))\n+\t\t\t\t\t\t\t\t.asPatch(mapper, oldRevisionSource, true /* includeFromValue */);\n+\t\t\t\t\t\tif (fieldsToSkip == null) {\n+\t\t\t\t\t\t\tfieldsToSkip = Sets.newHashSetWithExpectedSize(1); // expect a single array like property per type\n+\t\t\t\t\t\t}\n+\t\t\t\t\t\tfieldsToSkip.add(property);\n+\t\t\t\t\t}\n \t\t\t\t\t\n \t\t\t\t\t// Remove administrative revision fields from diff, but keep all other ones\n \t\t\t\t\tif (!Revision.Fields.CREATED.equals(property) && !Revision.Fields.REVISED.equals(property)) {", "originalCommit": "8b28663442d251360ffcfda2cd02ed1b0148fc17", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "966b36cff7444f4c3fa8a490724acc18c5fcd587", "url": "https://github.com/b2ihealthcare/snow-owl/commit/966b36cff7444f4c3fa8a490724acc18c5fcd587", "message": "SO-4660: add javadoc to Revision's `created` and `revised` fields", "committedDate": "2020-11-10T10:52:07Z", "type": "commit"}, {"oid": "0a613f7ab43f699f4964d1ec221fe8499bb8c67a", "url": "https://github.com/b2ihealthcare/snow-owl/commit/0a613f7ab43f699f4964d1ec221fe8499bb8c67a", "message": "SO-4660: filter out created/revised early when computing raw diff", "committedDate": "2020-11-10T10:56:29Z", "type": "commit"}, {"oid": "5d73728aa3a9dda84863641cd632861772dbd463", "url": "https://github.com/b2ihealthcare/snow-owl/commit/5d73728aa3a9dda84863641cd632861772dbd463", "message": "SO-4660: filter out created/revised early when computing raw diff...\n\n...properly :smile:", "committedDate": "2020-11-10T10:58:24Z", "type": "commit"}]}