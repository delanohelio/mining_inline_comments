{"pr_number": 760, "pr_title": "Object store/ aws", "pr_createdAt": "2020-07-20T22:44:26Z", "pr_url": "https://github.com/phac-nml/irida/pull/760", "timeline": [{"oid": "5763a6e2ce36070845a8e09779df4a70e5c10b55", "url": "https://github.com/phac-nml/irida/commit/5763a6e2ce36070845a8e09779df4a70e5c10b55", "message": "Added aws iridafilestorageservice to upload files to a s3 bucket", "committedDate": "2020-04-14T20:37:27Z", "type": "commit"}, {"oid": "d2f1e2309991104207583a33ccac71e3f607758f", "url": "https://github.com/phac-nml/irida/commit/d2f1e2309991104207583a33ccac71e3f607758f", "message": "Merge branch 'object_store/_base' into object_store/_aws", "committedDate": "2020-04-16T15:36:30Z", "type": "commit"}, {"oid": "83a0c4c7c9b5d380f2a0a17b72d1fb76f011c96d", "url": "https://github.com/phac-nml/irida/commit/83a0c4c7c9b5d380f2a0a17b72d1fb76f011c96d", "message": "Merge branch 'object_store/_base' into object_store/_aws", "committedDate": "2020-04-20T20:54:33Z", "type": "commit"}, {"oid": "cb0c0ce9d1e72d2b2becdc756e2140eb4720d3ea", "url": "https://github.com/phac-nml/irida/commit/cb0c0ce9d1e72d2b2becdc756e2140eb4720d3ea", "message": "Removed azure implementation from this branch as it is in it's own branch", "committedDate": "2020-04-20T21:24:12Z", "type": "commit"}, {"oid": "38ca693a0813ffa9c6565c0c0b3de137c420524b", "url": "https://github.com/phac-nml/irida/commit/38ca693a0813ffa9c6565c0c0b3de137c420524b", "message": "Removed azure dependencies", "committedDate": "2020-04-20T21:34:31Z", "type": "commit"}, {"oid": "da1c3dfe13b9fef10e9cefdb2644be03f0547533", "url": "https://github.com/phac-nml/irida/commit/da1c3dfe13b9fef10e9cefdb2644be03f0547533", "message": "Merged base branch and fixed merge conflicts", "committedDate": "2020-04-22T19:54:45Z", "type": "commit"}, {"oid": "dab4d194f728b838cba9a0e3fc4aec1976712537", "url": "https://github.com/phac-nml/irida/commit/dab4d194f728b838cba9a0e3fc4aec1976712537", "message": "Merge branch 'object_store/_base' into object_store/_aws", "committedDate": "2020-04-29T15:57:31Z", "type": "commit"}, {"oid": "32ec4162ede3a32934f5677e425d0f71890a1831", "url": "https://github.com/phac-nml/irida/commit/32ec4162ede3a32934f5677e425d0f71890a1831", "message": "Merge branch 'object_store/_base' into object_store/_aws", "committedDate": "2020-04-30T18:55:37Z", "type": "commit"}, {"oid": "b312730def25fe7e2fafd7f4934a2970cb92f905", "url": "https://github.com/phac-nml/irida/commit/b312730def25fe7e2fafd7f4934a2970cb92f905", "message": "Merge branch 'object_store/_base' into object_store/_aws", "committedDate": "2020-05-06T13:57:31Z", "type": "commit"}, {"oid": "d20f65e62ff5d6b4e5e318bbdfca3973d0d0c4c5", "url": "https://github.com/phac-nml/irida/commit/d20f65e62ff5d6b4e5e318bbdfca3973d0d0c4c5", "message": "Merge branch 'object_store/_base' into object_store/_aws", "committedDate": "2020-05-20T19:40:58Z", "type": "commit"}, {"oid": "480f446cdc1c435101a19d83ce721d432783f1c4", "url": "https://github.com/phac-nml/irida/commit/480f446cdc1c435101a19d83ce721d432783f1c4", "message": "Merge branch 'object_store/_base' into object_store/_aws", "committedDate": "2020-05-22T23:33:35Z", "type": "commit"}, {"oid": "04e2ea14ab90b134c94e781d1dec726cb797f676", "url": "https://github.com/phac-nml/irida/commit/04e2ea14ab90b134c94e781d1dec726cb797f676", "message": "Merge branch 'object_store/_base' into object_store/_aws", "committedDate": "2020-05-26T19:24:07Z", "type": "commit"}, {"oid": "8d1202371a5fc238e0c0463c42e97775b3e232b5", "url": "https://github.com/phac-nml/irida/commit/8d1202371a5fc238e0c0463c42e97775b3e232b5", "message": "Merge branch 'object_store/_base' into object_store/_aws", "committedDate": "2020-06-16T20:09:26Z", "type": "commit"}, {"oid": "10d129eb45cef3d8a5417f409ab7858ca88ba1f8", "url": "https://github.com/phac-nml/irida/commit/10d129eb45cef3d8a5417f409ab7858ca88ba1f8", "message": "Merged base branch, fixed merge conflict. Updated name to IridaFileStorageAwsUtilityImpl for aws implementation", "committedDate": "2020-06-17T19:17:34Z", "type": "commit"}, {"oid": "b52f1f535a668a401499587b3363b46598f8c118", "url": "https://github.com/phac-nml/irida/commit/b52f1f535a668a401499587b3363b46598f8c118", "message": "Merged base branch and fixed merge conflict", "committedDate": "2020-07-15T15:47:35Z", "type": "commit"}, {"oid": "3e93ab560369cdffacc0399574afb6c590ffd16d", "url": "https://github.com/phac-nml/irida/commit/3e93ab560369cdffacc0399574afb6c590ffd16d", "message": "Merge branch 'object-store' into object_store/_aws", "committedDate": "2020-07-17T15:52:30Z", "type": "commit"}, {"oid": "6eda5842de9093bd76f6f3c76b9a454aa6f367fe", "url": "https://github.com/phac-nml/irida/commit/6eda5842de9093bd76f6f3c76b9a454aa6f367fe", "message": "Merge branch 'object-store' into object_store/_aws", "committedDate": "2020-07-20T20:10:06Z", "type": "commit"}, {"oid": "0817eacadba60c4d9fb9b3a11424e384345dd07d", "url": "https://github.com/phac-nml/irida/commit/0817eacadba60c4d9fb9b3a11424e384345dd07d", "message": "Renamed method parameter to be generic. Updated text displayed when an IOException is thrown. Removed unused imports", "committedDate": "2020-07-20T22:43:10Z", "type": "commit"}, {"oid": "81de15102db4af789f20dd4d72dc4bdf0e5acb10", "url": "https://github.com/phac-nml/irida/commit/81de15102db4af789f20dd4d72dc4bdf0e5acb10", "message": "Merge branch 'object-store' into object_store/_aws", "committedDate": "2020-08-12T15:01:14Z", "type": "commit"}, {"oid": "4edd211625ed2c7284e7faa9c8bc68524c5e874f", "url": "https://github.com/phac-nml/irida/commit/4edd211625ed2c7284e7faa9c8bc68524c5e874f", "message": "Updated variable name", "committedDate": "2020-08-12T16:49:36Z", "type": "commit"}, {"oid": "e13867d7fb1efcf0490bde59ff4beaee2ca55bc7", "url": "https://github.com/phac-nml/irida/commit/e13867d7fb1efcf0490bde59ff4beaee2ca55bc7", "message": "Merge branch 'object-store' into object_store/_aws", "committedDate": "2020-08-13T16:38:23Z", "type": "commit"}, {"oid": "5dd2639460141f3df8e50e03833487d87ff0de25", "url": "https://github.com/phac-nml/irida/commit/5dd2639460141f3df8e50e03833487d87ff0de25", "message": "Merge branch 'object-store' into object_store/_aws", "committedDate": "2020-10-15T13:18:24Z", "type": "commit"}, {"oid": "48447d5efb3f6c094e5a0f7bd00431acf5c5f041", "url": "https://github.com/phac-nml/irida/commit/48447d5efb3f6c094e5a0f7bd00431acf5c5f041", "message": "Merge branch 'object-store' into object_store/_aws", "committedDate": "2020-11-02T15:19:45Z", "type": "commit"}, {"oid": "96e46b67aa98badb4de8b37c9907f59e19e89f7a", "url": "https://github.com/phac-nml/irida/commit/96e46b67aa98badb4de8b37c9907f59e19e89f7a", "message": "Merged in base branch and fixed merge conflicts. Updated AWS utility class to include cleanup method and refactored", "committedDate": "2020-11-04T21:29:30Z", "type": "commit"}, {"oid": "2954fe8656d6f558e5882255d52a951da3639cec", "url": "https://github.com/phac-nml/irida/commit/2954fe8656d6f558e5882255d52a951da3639cec", "message": "Removed unused import", "committedDate": "2020-11-04T21:40:33Z", "type": "commit"}, {"oid": "5af4797a72ba2d6ae58a2f1b9b6e1941296242ed", "url": "https://github.com/phac-nml/irida/commit/5af4797a72ba2d6ae58a2f1b9b6e1941296242ed", "message": "Updated aws maven package. Changed from using basiccredentials to using the default credentials chain provider (set credentials and region in a credentials and config file)", "committedDate": "2020-11-05T16:04:42Z", "type": "commit"}, {"oid": "f58fe1a35dd6f7d642496a54b42dbd6031672e69", "url": "https://github.com/phac-nml/irida/commit/f58fe1a35dd6f7d642496a54b42dbd6031672e69", "message": "Undid accidental change to azure maven version", "committedDate": "2020-11-05T16:07:43Z", "type": "commit"}, {"oid": "2901c73843eafa1a559b789725dd241de2df3ade", "url": "https://github.com/phac-nml/irida/commit/2901c73843eafa1a559b789725dd241de2df3ade", "message": "Removed duplicate azure maven package", "committedDate": "2020-11-05T16:09:17Z", "type": "commit"}, {"oid": "f06ae1cef45206f5b85bd7441f47b2d7429da994", "url": "https://github.com/phac-nml/irida/commit/f06ae1cef45206f5b85bd7441f47b2d7429da994", "message": "Removed unused imports", "committedDate": "2020-11-06T16:39:55Z", "type": "commit"}, {"oid": "6d893ae30cfc58fda5cc146d9388e5fdba11c0cf", "url": "https://github.com/phac-nml/irida/commit/6d893ae30cfc58fda5cc146d9388e5fdba11c0cf", "message": "Added closing of input stream to s3 object when method getFileInputStream is called", "committedDate": "2020-11-06T18:57:34Z", "type": "commit"}, {"oid": "1849064a7cdb69cb53b84c9cba118d33ea88c05d", "url": "https://github.com/phac-nml/irida/commit/1849064a7cdb69cb53b84c9cba118d33ea88c05d", "message": "Merge branch 'object-store' into object_store/_aws", "committedDate": "2020-11-17T17:02:41Z", "type": "commit"}, {"oid": "206263d4fbd866238220742e7646a8fd816e6cd5", "url": "https://github.com/phac-nml/irida/commit/206263d4fbd866238220742e7646a8fd816e6cd5", "message": "Updated aws storage utility to use config values from irida conf file and updated to use try/finally to make sure a connection to the s3object is closed in case of success or failure", "committedDate": "2020-11-17T22:07:05Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjE5MTI0OQ==", "url": "https://github.com/phac-nml/irida/pull/760#discussion_r526191249", "bodyText": "You can also add this line to the try-with-resources block above, and it'll automatically close both the S3Object and the S3ObjectInputStream.  Just separate them with a ;", "author": "tom114", "createdAt": "2020-11-18T15:45:34Z", "path": "src/main/java/ca/corefacility/bioinformatics/irida/repositories/filesystem/IridaFileStorageAwsUtilityImpl.java", "diffHunk": "@@ -0,0 +1,287 @@\n+package ca.corefacility.bioinformatics.irida.repositories.filesystem;\n+\n+import java.io.*;\n+import java.nio.channels.FileChannel;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.StandardOpenOption;\n+import java.util.List;\n+import java.util.Optional;\n+import java.util.zip.GZIPInputStream;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.stereotype.Component;\n+\n+import ca.corefacility.bioinformatics.irida.exceptions.StorageException;\n+import ca.corefacility.bioinformatics.irida.model.sequenceFile.SequenceFile;\n+import ca.corefacility.bioinformatics.irida.model.sequenceFile.SequencingObject;\n+import ca.corefacility.bioinformatics.irida.util.FileUtils;\n+\n+import com.amazonaws.AmazonServiceException;\n+import com.amazonaws.auth.AWSStaticCredentialsProvider;\n+import com.amazonaws.auth.BasicAWSCredentials;\n+import com.amazonaws.regions.Regions;\n+import com.amazonaws.services.s3.AmazonS3;\n+import com.amazonaws.services.s3.AmazonS3ClientBuilder;\n+import com.amazonaws.services.s3.model.S3Object;\n+import com.amazonaws.services.s3.model.S3ObjectInputStream;\n+\n+/**\n+ * Component implementation of file utitlities for aws storage\n+ */\n+@Component\n+public class IridaFileStorageAwsUtilityImpl implements IridaFileStorageUtility{\n+\tprivate static final Logger logger = LoggerFactory.getLogger(IridaFileStorageAwsUtilityImpl.class);\n+\n+\tprivate String bucketName;\n+\tprivate BasicAWSCredentials awsCreds;\n+\tprivate AmazonS3 s3;\n+\n+\t@Autowired\n+\tpublic IridaFileStorageAwsUtilityImpl(String bucketName, String bucketRegion, String accessKey, String secretKey){\n+\t\tthis.awsCreds = new BasicAWSCredentials(accessKey, secretKey);\n+\t\tthis.s3 = AmazonS3ClientBuilder.standard().withRegion(Regions.fromName(bucketRegion))\n+\t\t\t\t.withCredentials(new AWSStaticCredentialsProvider(awsCreds)).build();\n+\t\tthis.bucketName = bucketName;\n+\t}\n+\n+\t/**\n+\t * {@inheritDoc}\n+\t */\n+\t@Override\n+\tpublic IridaTemporaryFile getTemporaryFile(Path file) {\n+\t\ttry {\n+\t\t\tlogger.trace(\"Getting file from aws s3 [\" + file.toString() + \"]\");\n+\t\t\tPath tempDirectory = Files.createTempDirectory(\"aws-tmp-\");\n+\t\t\tPath tempFile = tempDirectory.resolve(file.getFileName().toString());\n+\n+\t\t\ttry(S3Object s3Object = s3.getObject(bucketName, getAwsFileAbsolutePath(file))) {\n+\t\t\t\tS3ObjectInputStream s3ObjectInputStream = s3Object.getObjectContent();", "originalCommit": "206263d4fbd866238220742e7646a8fd816e6cd5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjQyMzE3Mw==", "url": "https://github.com/phac-nml/irida/pull/760#discussion_r526423173", "bodyText": "Updated in 2ff8d49. Didn't realize I could add multiple things to the try-with-resources block. Thanks", "author": "deepsidhu85", "createdAt": "2020-11-18T21:11:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjE5MTI0OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjQxNDY5MQ==", "url": "https://github.com/phac-nml/irida/pull/760#discussion_r526414691", "bodyText": "In all these throw new StorageException lines can you add the throwable cause to the exception?  That way the  caused by lines in the stack trace will actually show us where the exception came from.\nSo like throw new StorageException(\"some message\", e)", "author": "tom114", "createdAt": "2020-11-18T20:56:00Z", "path": "src/main/java/ca/corefacility/bioinformatics/irida/repositories/filesystem/IridaFileStorageAwsUtilityImpl.java", "diffHunk": "@@ -0,0 +1,287 @@\n+package ca.corefacility.bioinformatics.irida.repositories.filesystem;\n+\n+import java.io.*;\n+import java.nio.channels.FileChannel;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.StandardOpenOption;\n+import java.util.List;\n+import java.util.Optional;\n+import java.util.zip.GZIPInputStream;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.stereotype.Component;\n+\n+import ca.corefacility.bioinformatics.irida.exceptions.StorageException;\n+import ca.corefacility.bioinformatics.irida.model.sequenceFile.SequenceFile;\n+import ca.corefacility.bioinformatics.irida.model.sequenceFile.SequencingObject;\n+import ca.corefacility.bioinformatics.irida.util.FileUtils;\n+\n+import com.amazonaws.AmazonServiceException;\n+import com.amazonaws.auth.AWSStaticCredentialsProvider;\n+import com.amazonaws.auth.BasicAWSCredentials;\n+import com.amazonaws.regions.Regions;\n+import com.amazonaws.services.s3.AmazonS3;\n+import com.amazonaws.services.s3.AmazonS3ClientBuilder;\n+import com.amazonaws.services.s3.model.S3Object;\n+import com.amazonaws.services.s3.model.S3ObjectInputStream;\n+\n+/**\n+ * Component implementation of file utitlities for aws storage\n+ */\n+@Component\n+public class IridaFileStorageAwsUtilityImpl implements IridaFileStorageUtility{\n+\tprivate static final Logger logger = LoggerFactory.getLogger(IridaFileStorageAwsUtilityImpl.class);\n+\n+\tprivate String bucketName;\n+\tprivate BasicAWSCredentials awsCreds;\n+\tprivate AmazonS3 s3;\n+\n+\t@Autowired\n+\tpublic IridaFileStorageAwsUtilityImpl(String bucketName, String bucketRegion, String accessKey, String secretKey){\n+\t\tthis.awsCreds = new BasicAWSCredentials(accessKey, secretKey);\n+\t\tthis.s3 = AmazonS3ClientBuilder.standard().withRegion(Regions.fromName(bucketRegion))\n+\t\t\t\t.withCredentials(new AWSStaticCredentialsProvider(awsCreds)).build();\n+\t\tthis.bucketName = bucketName;\n+\t}\n+\n+\t/**\n+\t * {@inheritDoc}\n+\t */\n+\t@Override\n+\tpublic IridaTemporaryFile getTemporaryFile(Path file) {\n+\t\ttry {\n+\t\t\tlogger.trace(\"Getting file from aws s3 [\" + file.toString() + \"]\");\n+\t\t\tPath tempDirectory = Files.createTempDirectory(\"aws-tmp-\");\n+\t\t\tPath tempFile = tempDirectory.resolve(file.getFileName().toString());\n+\n+\t\t\ttry(S3Object s3Object = s3.getObject(bucketName, getAwsFileAbsolutePath(file))) {\n+\t\t\t\tS3ObjectInputStream s3ObjectInputStream = s3Object.getObjectContent();\n+\t\t\t\torg.apache.commons.io.FileUtils.copyInputStreamToFile(s3ObjectInputStream, tempFile.toFile());\n+\t\t\t\ts3ObjectInputStream.close();\n+\t\t\t} catch (AmazonServiceException e) {\n+\t\t\t\tlogger.error(e.getErrorMessage());\n+\t\t\t\tthrow new StorageException(e.getMessage());\n+\t\t\t} catch (Exception e) {\n+\t\t\t\tlogger.error(\"Unable to get object from aws S3: \" + e);\n+\t\t\t\tthrow new StorageException(e.getMessage());\n+\t\t\t}\n+\n+\t\t\treturn new IridaTemporaryFile(tempFile, tempDirectory);\n+\t\t} catch (FileNotFoundException e) {\n+\t\t\tlogger.error(e.getMessage());\n+\t\t\tthrow new StorageException(e.getMessage());", "originalCommit": "206263d4fbd866238220742e7646a8fd816e6cd5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjQyMzIyMw==", "url": "https://github.com/phac-nml/irida/pull/760#discussion_r526423223", "bodyText": "Updated in 2ff8d49", "author": "deepsidhu85", "createdAt": "2020-11-18T21:11:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjQxNDY5MQ=="}], "type": "inlineReview"}, {"oid": "2ff8d49c203b54e1df18e5388736b81378b1323f", "url": "https://github.com/phac-nml/irida/commit/2ff8d49c203b54e1df18e5388736b81378b1323f", "message": "Added cause of storageexceptions and added s3ObjectInputStream to try-with-resources block", "committedDate": "2020-11-18T21:10:38Z", "type": "commit"}, {"oid": "4f260adf990a5bd2accf78a002c978514920bfaa", "url": "https://github.com/phac-nml/irida/commit/4f260adf990a5bd2accf78a002c978514920bfaa", "message": "Merge branch 'update-chromedriver-87' into object_store/_aws", "committedDate": "2020-11-18T21:16:58Z", "type": "commit"}, {"oid": "dfc69e7c3b4cd35c340bd086f7b7b634457bb426", "url": "https://github.com/phac-nml/irida/commit/dfc69e7c3b4cd35c340bd086f7b7b634457bb426", "message": "Merge branch 'object-store' into object_store/_aws", "committedDate": "2020-11-18T21:27:06Z", "type": "commit"}]}