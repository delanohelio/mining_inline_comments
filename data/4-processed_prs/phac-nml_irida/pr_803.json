{"pr_number": 803, "pr_title": "Fix remote oauth project sync settings", "pr_createdAt": "2020-09-15T17:38:13Z", "pr_url": "https://github.com/phac-nml/irida/pull/803", "timeline": [{"oid": "dfa5eb9b72f9eaa86543808399d04478990f3f19", "url": "https://github.com/phac-nml/irida/commit/dfa5eb9b72f9eaa86543808399d04478990f3f19", "message": "Updated remote project sync settings page to use ant design and react. Updated CHANGELOG", "committedDate": "2020-09-15T15:02:06Z", "type": "commit"}, {"oid": "26a8c51a985225f5d437842d7001c65d15ab100c", "url": "https://github.com/phac-nml/irida/commit/26a8c51a985225f5d437842d7001c65d15ab100c", "message": "Merged in create remote project branch", "committedDate": "2020-09-15T15:12:06Z", "type": "commit"}, {"oid": "54b94c5c35432332250094d188eaa406e7c1e38b", "url": "https://github.com/phac-nml/irida/commit/54b94c5c35432332250094d188eaa406e7c1e38b", "message": "Removed file no longer needed", "committedDate": "2020-09-15T17:19:35Z", "type": "commit"}, {"oid": "ce1fd0fb310580677d61cf5181f797dc265e52e1", "url": "https://github.com/phac-nml/irida/commit/ce1fd0fb310580677d61cf5181f797dc265e52e1", "message": "Merge branch 'FIX-remoate-oath-CREATE_REMOTE_PROJECT' into FIX-remote-oauth-PROJECT_SYNC_SETTINGS", "committedDate": "2020-09-15T17:37:00Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODg1MDE1NQ==", "url": "https://github.com/phac-nml/irida/pull/803#discussion_r488850155", "bodyText": "Comment", "author": "joshsadam", "createdAt": "2020-09-15T17:40:39Z", "path": "src/main/java/ca/corefacility/bioinformatics/irida/ria/web/ajax/projects/RemoteProjectInfo.java", "diffHunk": "@@ -0,0 +1,76 @@\n+package ca.corefacility.bioinformatics.irida.ria.web.ajax.projects;\n+\n+import java.util.Date;\n+\n+import ca.corefacility.bioinformatics.irida.model.RemoteAPI;\n+import ca.corefacility.bioinformatics.irida.model.project.ProjectSyncFrequency;\n+import ca.corefacility.bioinformatics.irida.model.remote.RemoteStatus;\n+import ca.corefacility.bioinformatics.irida.model.user.User;\n+", "originalCommit": "ce1fd0fb310580677d61cf5181f797dc265e52e1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODg2ODA1MQ==", "url": "https://github.com/phac-nml/irida/pull/803#discussion_r488868051", "bodyText": "Added in bb34052", "author": "deepsidhu85", "createdAt": "2020-09-15T18:12:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODg1MDE1NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODg1MDU3Mw==", "url": "https://github.com/phac-nml/irida/pull/803#discussion_r488850573", "bodyText": "We should come up with a naming scheme for these, we have models, details, etc...", "author": "joshsadam", "createdAt": "2020-09-15T17:41:20Z", "path": "src/main/java/ca/corefacility/bioinformatics/irida/ria/web/ajax/projects/RemoteProjectInfo.java", "diffHunk": "@@ -0,0 +1,76 @@\n+package ca.corefacility.bioinformatics.irida.ria.web.ajax.projects;\n+\n+import java.util.Date;\n+\n+import ca.corefacility.bioinformatics.irida.model.RemoteAPI;\n+import ca.corefacility.bioinformatics.irida.model.project.ProjectSyncFrequency;\n+import ca.corefacility.bioinformatics.irida.model.remote.RemoteStatus;\n+import ca.corefacility.bioinformatics.irida.model.user.User;\n+\n+public class RemoteProjectInfo {", "originalCommit": "ce1fd0fb310580677d61cf5181f797dc265e52e1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODg1NTkyOA==", "url": "https://github.com/phac-nml/irida/pull/803#discussion_r488855928", "bodyText": "Agreed", "author": "deepsidhu85", "createdAt": "2020-09-15T17:50:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODg1MDU3Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODg3NjMzMw==", "url": "https://github.com/phac-nml/irida/pull/803#discussion_r488876333", "bodyText": "Let's go with *Settings as that's what this dto is and we can use this naming scheme going forward", "author": "deepsidhu85", "createdAt": "2020-09-15T18:27:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODg1MDU3Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTQ0NjIzOA==", "url": "https://github.com/phac-nml/irida/pull/803#discussion_r489446238", "bodyText": "Updated in d6e05c3", "author": "deepsidhu85", "createdAt": "2020-09-16T13:41:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODg1MDU3Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODg1MDY5Mw==", "url": "https://github.com/phac-nml/irida/pull/803#discussion_r488850693", "bodyText": "Comments", "author": "joshsadam", "createdAt": "2020-09-15T17:41:34Z", "path": "src/main/java/ca/corefacility/bioinformatics/irida/ria/web/projects/settings/ProjectSettingsRemoteController.java", "diffHunk": "@@ -132,4 +137,20 @@ public String getProjectSettingsRemotePage(@PathVariable Long projectId, final M\n \t\tprojectControllerUtils.getProjectTemplateDetails(model, principal, project);\n \t\treturn \"projects/settings/pages/remote\";\n \t}\n+\n+\n+\t@RequestMapping(\"/remote-settings\")", "originalCommit": "ce1fd0fb310580677d61cf5181f797dc265e52e1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODg2NzkzMg==", "url": "https://github.com/phac-nml/irida/pull/803#discussion_r488867932", "bodyText": "Added in 68d3aca", "author": "deepsidhu85", "createdAt": "2020-09-15T18:12:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODg1MDY5Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODg1MDk0Nw==", "url": "https://github.com/phac-nml/irida/pull/803#discussion_r488850947", "bodyText": "I don't think you even need to add the /index.js", "author": "joshsadam", "createdAt": "2020-09-15T17:41:58Z", "path": "src/main/webapp/entries.js", "diffHunk": "@@ -42,8 +42,8 @@ module.exports = {\n   \"project-new\": \"./resources/js/pages/projects/projects-new.js\",\n   \"project-settings-basic\":\n     \"./resources/js/pages/projects/settings/project-settings-basic.js\",\n-  \"project-settings-remote\":\n-    \"./resources/js/pages/projects/settings/project-settings-remote.js\",\n+  \"project-remote\":\n+    \"./resources/js/pages/projects/remote/index.js\",", "originalCommit": "ce1fd0fb310580677d61cf5181f797dc265e52e1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODg2ODExNA==", "url": "https://github.com/phac-nml/irida/pull/803#discussion_r488868114", "bodyText": "Removed in bb34052", "author": "deepsidhu85", "createdAt": "2020-09-15T18:12:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODg1MDk0Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODg1MTIyOA==", "url": "https://github.com/phac-nml/irida/pull/803#discussion_r488851228", "bodyText": "Do you need this, I think there is a global variable for this. \u00a0Check window.TL on the page.html template", "author": "joshsadam", "createdAt": "2020-09-15T17:42:25Z", "path": "src/main/webapp/pages/projects/settings/pages/remote.html", "diffHunk": "@@ -1,69 +1,35 @@\n <!DOCTYPE html>\n-<html xmlns:th=\"http://www.thymeleaf.org\" xmlns:layout=\"http://www.ultraq.net.nz/thymeleaf/layout\"\n-      data-layout-decorate=\"~{projects/settings/_base}\">\n-<head>\n-    <title th:text=\"#{project.settings.page.title.remote}\">Title</title>\n+<html\n+  lang=\"en\"\n+  xmlns:th=\"http://www.thymeleaf.org\"\n+  xmlns:layout=\"http://www.ultraq.net.nz/thymeleaf/layout\"\n+  data-layout-decorate=\"~{projects/settings/_base}\"\n+>\n+  <head>\n+    <meta charset=\"UTF-8\" />\n+    <link rel=\"stylesheet\" href=\"/dist/css/project-remote.bundle.css\">\n+    <title th:text=\"#{ProjectRemoteSettings.title}\">Title</title>\n         <script th:inline=\"javascript\">\n-        var PAGE = {\n-            urls: {\n-            'sync': /*[[@{/projects/{id}/settings/sync(id=${project.getId()})}]]*/ '/projects/1/settings/sync',\n-            }\n-        };\n-        </script>\n-</head>\n-<body>\n-<div layout:fragment=\"settings-content\" th:with=\"status = ${project.getRemoteStatus()}\">\n-    <h2 class=\"h2-muted\" th:text=\"#{project.settings.sync.heading}\"></h2>\n-    <div class=\"form-group\">\n-        <label class=\"control-label\" th:text=\"#{project.settings.sync.lastSync}\">_Last Sync_</label>\n-        <div>\n-            <span th:text=\"${#calendars.format(project.getRemoteStatus().getLastUpdate(), 'dd MMM yyyy hh:mma')}\"></span>\n-            <button id=\"forceSync\" role=\"button\" class=\"btn btn-default btn-sm\"\n-                    th:text=\"#{project.settings.sync.forceSync}\">_Force Sync_\n-            </button>\n-        </div>\n-    </div>\n-    <div class=\"form-group connection-wrapper\">\n-        <label class=\"control-label\" th:text=\"#{project.settings.api}\">_API_</label>\n-        <div>\n-            <a href=\"#\" th:href=\"@{/remote_api/{id}(id=${status.getApi().getId()})}\"\n-               th:text=\"${status.getApi().getLabel()}\">_api_</a>\n-            <span id=\"api-status\" class=\"api-status js-status-wrapper\">\n-                <i class=\"fa fa-spinner fa-spin\"></i>\n-            </span>\n+            window.PAGE = {\n+                _USER: /*[[${session.CURRENT_USER_DETAILS}]]*/ {}", "originalCommit": "ce1fd0fb310580677d61cf5181f797dc265e52e1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODg1NjQwMQ==", "url": "https://github.com/phac-nml/irida/pull/803#discussion_r488856401", "bodyText": "I will take a look", "author": "deepsidhu85", "createdAt": "2020-09-15T17:51:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODg1MTIyOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODg2ODE4OA==", "url": "https://github.com/phac-nml/irida/pull/803#discussion_r488868188", "bodyText": "Updated in bb34052", "author": "deepsidhu85", "createdAt": "2020-09-15T18:12:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODg1MTIyOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODg1MTcyMQ==", "url": "https://github.com/phac-nml/irida/pull/803#discussion_r488851721", "bodyText": "I have translation for these in my branch. \u00a0Why are you adding them to the page?", "author": "joshsadam", "createdAt": "2020-09-15T17:43:16Z", "path": "src/main/webapp/pages/projects/settings/pages/remote.html", "diffHunk": "@@ -1,69 +1,35 @@\n <!DOCTYPE html>\n-<html xmlns:th=\"http://www.thymeleaf.org\" xmlns:layout=\"http://www.ultraq.net.nz/thymeleaf/layout\"\n-      data-layout-decorate=\"~{projects/settings/_base}\">\n-<head>\n-    <title th:text=\"#{project.settings.page.title.remote}\">Title</title>\n+<html\n+  lang=\"en\"\n+  xmlns:th=\"http://www.thymeleaf.org\"\n+  xmlns:layout=\"http://www.ultraq.net.nz/thymeleaf/layout\"\n+  data-layout-decorate=\"~{projects/settings/_base}\"\n+>\n+  <head>\n+    <meta charset=\"UTF-8\" />\n+    <link rel=\"stylesheet\" href=\"/dist/css/project-remote.bundle.css\">\n+    <title th:text=\"#{ProjectRemoteSettings.title}\">Title</title>\n         <script th:inline=\"javascript\">\n-        var PAGE = {\n-            urls: {\n-            'sync': /*[[@{/projects/{id}/settings/sync(id=${project.getId()})}]]*/ '/projects/1/settings/sync',\n-            }\n-        };\n-        </script>\n-</head>\n-<body>\n-<div layout:fragment=\"settings-content\" th:with=\"status = ${project.getRemoteStatus()}\">\n-    <h2 class=\"h2-muted\" th:text=\"#{project.settings.sync.heading}\"></h2>\n-    <div class=\"form-group\">\n-        <label class=\"control-label\" th:text=\"#{project.settings.sync.lastSync}\">_Last Sync_</label>\n-        <div>\n-            <span th:text=\"${#calendars.format(project.getRemoteStatus().getLastUpdate(), 'dd MMM yyyy hh:mma')}\"></span>\n-            <button id=\"forceSync\" role=\"button\" class=\"btn btn-default btn-sm\"\n-                    th:text=\"#{project.settings.sync.forceSync}\">_Force Sync_\n-            </button>\n-        </div>\n-    </div>\n-    <div class=\"form-group connection-wrapper\">\n-        <label class=\"control-label\" th:text=\"#{project.settings.api}\">_API_</label>\n-        <div>\n-            <a href=\"#\" th:href=\"@{/remote_api/{id}(id=${status.getApi().getId()})}\"\n-               th:text=\"${status.getApi().getLabel()}\">_api_</a>\n-            <span id=\"api-status\" class=\"api-status js-status-wrapper\">\n-                <i class=\"fa fa-spinner fa-spin\"></i>\n-            </span>\n+            window.PAGE = {\n+                _USER: /*[[${session.CURRENT_USER_DETAILS}]]*/ {}\n+            };\n \n-            <button type=\"button\" class=\"oauth-connect-link btn btn-default hidden js-connect-btn\" id=\"connect-button\"\n-                    data-toggle=\"modal\" data-target=\"#remote-connect-wrapper\"\n-                    th:text=\"#{remoteapi.status.connect.button}\" data:api-id=\"${status.getApi().getId()}\">\n-                _Connect_\n-            </button>\n-        </div>\n-    </div>\n-    <div class=\"form-group\">\n-        <label class=\"control-label\" for=\"frequency\" th:text=\"#{project.settings.sync.frequency}\">_Sync\n-            Frequency_</label>\n-        <select id=\"frequency\" class=\"form-control input-full sync-setting\">\n-            <option th:each=\"freq : ${frequencies}\" th:value=\"${freq}\"\n-                    th:text=\"#{'project.settings.frequency.' + ${freq}}\"\n-                    th:selected=\"${project.getSyncFrequency() == freq}\"></option>\n-        </select>\n-    </div>\n-    <div class=\"form-group\">\n-        <label class=\"control-label\" for=\"frequency\" th:text=\"#{project.settings.sync.user}\">_Sync User_</label>\n-        <div>\n-            <a href=\"#\" th:text=\"${status.getReadBy().getLabel()}\"\n-               th:href=\"@{/users/{id}(id=${status.getReadBy().getId()})}\">_User</a>\n-            <span class=\"api-connected-action\" hidden=\"hidden\">\n-              <button id=\"becomeSyncUser\" role=\"button\" class=\"btn btn-default btn-sm\"\n-                      th:text=\"#{project.settings.sync.becomeSyncUser}\">_Become owner_</button>\n-            </span>\n-        </div>\n+            window.translations = [{\n+                \"ProjectRemoteSettings.frequency.NEVER\": /*[[#{ProjectRemoteSettings.frequency.NEVER}]]*/ \"\",", "originalCommit": "ce1fd0fb310580677d61cf5181f797dc265e52e1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODg1NjYzMg==", "url": "https://github.com/phac-nml/irida/pull/803#discussion_r488856632", "bodyText": "I had this part done before I saw that you had them in your branch :)", "author": "deepsidhu85", "createdAt": "2020-09-15T17:51:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODg1MTcyMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTQxNzg3Ng==", "url": "https://github.com/phac-nml/irida/pull/803#discussion_r489417876", "bodyText": "Removed in de55c62", "author": "deepsidhu85", "createdAt": "2020-09-16T13:01:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODg1MTcyMQ=="}], "type": "inlineReview"}, {"oid": "68d3acaeba753d0395ebb82cf7b475f5af7d89c4", "url": "https://github.com/phac-nml/irida/commit/68d3acaeba753d0395ebb82cf7b475f5af7d89c4", "message": "Added javadoc for method", "committedDate": "2020-09-15T17:48:00Z", "type": "commit"}, {"oid": "bb34052964426a9d5f05269592dbeb56afcf1e82", "url": "https://github.com/phac-nml/irida/commit/bb34052964426a9d5f05269592dbeb56afcf1e82", "message": "Added comments, removed page variable", "committedDate": "2020-09-15T18:11:07Z", "type": "commit"}, {"oid": "444a9070624fde9eeebd2f33a1e2442564f72152", "url": "https://github.com/phac-nml/irida/commit/444a9070624fde9eeebd2f33a1e2442564f72152", "message": "Merge branch 'FIX-remoate-oath-CREATE_REMOTE_PROJECT' into FIX-remote-oauth-PROJECT_SYNC_SETTINGS", "committedDate": "2020-09-15T19:50:08Z", "type": "commit"}, {"oid": "de55c629770a6fc3924ffbd65eb135a6082c68e8", "url": "https://github.com/phac-nml/irida/commit/de55c629770a6fc3924ffbd65eb135a6082c68e8", "message": "Removed translations not needed and removed page variables for these translations. Updated ProjectSynchronizationSettings component to use SyncFrequencySelect component for selecting sync frequency", "committedDate": "2020-09-15T21:31:49Z", "type": "commit"}, {"oid": "99be6b95c6ae4c797b364ef41f1041e008012357", "url": "https://github.com/phac-nml/irida/commit/99be6b95c6ae4c797b364ef41f1041e008012357", "message": "Removed logging statement", "committedDate": "2020-09-15T21:34:12Z", "type": "commit"}, {"oid": "99b9b2d97a3014eecc0984690abfa1329d6c20b3", "url": "https://github.com/phac-nml/irida/commit/99b9b2d97a3014eecc0984690abfa1329d6c20b3", "message": "Merge branch 'FIX-remoate-oath-CREATE_REMOTE_PROJECT' into FIX-remote-oauth-PROJECT_SYNC_SETTINGS", "committedDate": "2020-09-16T13:02:53Z", "type": "commit"}, {"oid": "d6e05c3fc8762cb07c7bd654025517140657c154", "url": "https://github.com/phac-nml/irida/commit/d6e05c3fc8762cb07c7bd654025517140657c154", "message": "Renamed RemoteProjectInfo to RemoteProjectSettings. Added labelRequired to SyncFrequency which accepts true or false and will only display the label if it is set to true(default).", "committedDate": "2020-09-16T13:36:55Z", "type": "commit"}, {"oid": "613c3bdff8d57fd636f70faf98af2d158e57a3ff", "url": "https://github.com/phac-nml/irida/commit/613c3bdff8d57fd636f70faf98af2d158e57a3ff", "message": "Merge branch 'FIX-remoate-oath-CREATE_REMOTE_PROJECT' into FIX-remote-oauth-PROJECT_SYNC_SETTINGS", "committedDate": "2020-09-16T13:37:48Z", "type": "commit"}, {"oid": "12402016c95c022c3045f77f3884ff9f5a2844de", "url": "https://github.com/phac-nml/irida/commit/12402016c95c022c3045f77f3884ff9f5a2844de", "message": "Added translation", "committedDate": "2020-09-16T13:40:04Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODg2NTg4Mg==", "url": "https://github.com/phac-nml/irida/pull/803#discussion_r488865882", "bodyText": "Stop using redundant object attributes. \u00a0You only need { message } since message is defined", "author": "joshsadam", "createdAt": "2020-09-15T18:08:11Z", "path": "src/main/webapp/resources/js/pages/projects/remote/ProjectSynchronizationSettings.jsx", "diffHunk": "@@ -0,0 +1,116 @@\n+import React, { useEffect, useState } from \"react\";\n+import { Button, notification, Select } from \"antd\";\n+import { BasicList } from \"../../../components/lists\";\n+import { RemoteApiStatus } from \"../../admin/components/remote-connections/RemoteApiStatus\";\n+import {\n+  updateRemoteProjectSyncSettings,\n+  getRemoteProjectSyncSettings }\n+from \"../../../apis/projects/projects\";\n+import { formatDate } from \"../../../utilities/date-utilities\";\n+\n+/**\n+ * React component for render the remote project sync settings.\n+ * @returns {*}\n+ * @constructor\n+ */\n+export function ProjectSynchronizationSettings() {\n+  const projectId = window.project.id;\n+  const syncNowEnabledStates = [\"SYNCHRONIZED\", \"ERROR\"];\n+  const [remoteProjectData, setRemoteProjectData] = useState(null);\n+  const [disableSyncNow, setDisableSyncNow] = useState(false);\n+\n+  /*\n+  When this component is rendered, query the api for the specific settings\n+  for this remote project.\n+   */\n+  useEffect(() => {\n+    getRemoteProjectSyncSettings(projectId).then(res => {\n+      setRemoteProjectData(res.remoteProjectInfo);\n+    }).catch((message) => {\n+      notification.error({ message: message });", "originalCommit": "68d3acaeba753d0395ebb82cf7b475f5af7d89c4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTcyMjYxNQ==", "url": "https://github.com/phac-nml/irida/pull/803#discussion_r489722615", "bodyText": "Updated in 5bc543e", "author": "deepsidhu85", "createdAt": "2020-09-16T20:03:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODg2NTg4Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODg2NjI4NA==", "url": "https://github.com/phac-nml/irida/pull/803#discussion_r488866284", "bodyText": "Destructure .then(( {remoteProjectInfo }) => ) ...", "author": "joshsadam", "createdAt": "2020-09-15T18:08:58Z", "path": "src/main/webapp/resources/js/pages/projects/remote/ProjectSynchronizationSettings.jsx", "diffHunk": "@@ -0,0 +1,116 @@\n+import React, { useEffect, useState } from \"react\";\n+import { Button, notification, Select } from \"antd\";\n+import { BasicList } from \"../../../components/lists\";\n+import { RemoteApiStatus } from \"../../admin/components/remote-connections/RemoteApiStatus\";\n+import {\n+  updateRemoteProjectSyncSettings,\n+  getRemoteProjectSyncSettings }\n+from \"../../../apis/projects/projects\";\n+import { formatDate } from \"../../../utilities/date-utilities\";\n+\n+/**\n+ * React component for render the remote project sync settings.\n+ * @returns {*}\n+ * @constructor\n+ */\n+export function ProjectSynchronizationSettings() {\n+  const projectId = window.project.id;\n+  const syncNowEnabledStates = [\"SYNCHRONIZED\", \"ERROR\"];\n+  const [remoteProjectData, setRemoteProjectData] = useState(null);\n+  const [disableSyncNow, setDisableSyncNow] = useState(false);\n+\n+  /*\n+  When this component is rendered, query the api for the specific settings\n+  for this remote project.\n+   */\n+  useEffect(() => {\n+    getRemoteProjectSyncSettings(projectId).then(res => {", "originalCommit": "68d3acaeba753d0395ebb82cf7b475f5af7d89c4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTcyMjU2Mg==", "url": "https://github.com/phac-nml/irida/pull/803#discussion_r489722562", "bodyText": "Updated in 5bc543e", "author": "deepsidhu85", "createdAt": "2020-09-16T20:03:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODg2NjI4NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODg2NjU1Mw==", "url": "https://github.com/phac-nml/irida/pull/803#discussion_r488866553", "bodyText": "Get the id from window.location.href", "author": "joshsadam", "createdAt": "2020-09-15T18:09:27Z", "path": "src/main/webapp/resources/js/pages/projects/remote/ProjectSynchronizationSettings.jsx", "diffHunk": "@@ -0,0 +1,116 @@\n+import React, { useEffect, useState } from \"react\";\n+import { Button, notification, Select } from \"antd\";\n+import { BasicList } from \"../../../components/lists\";\n+import { RemoteApiStatus } from \"../../admin/components/remote-connections/RemoteApiStatus\";\n+import {\n+  updateRemoteProjectSyncSettings,\n+  getRemoteProjectSyncSettings }\n+from \"../../../apis/projects/projects\";\n+import { formatDate } from \"../../../utilities/date-utilities\";\n+\n+/**\n+ * React component for render the remote project sync settings.\n+ * @returns {*}\n+ * @constructor\n+ */\n+export function ProjectSynchronizationSettings() {\n+  const projectId = window.project.id;", "originalCommit": "68d3acaeba753d0395ebb82cf7b475f5af7d89c4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTcyMjQ5NA==", "url": "https://github.com/phac-nml/irida/pull/803#discussion_r489722494", "bodyText": "Updated in 5bc543e", "author": "deepsidhu85", "createdAt": "2020-09-16T20:03:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODg2NjU1Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTUzNDM1NA==", "url": "https://github.com/phac-nml/irida/pull/803#discussion_r489534354", "bodyText": "I would update this to take an object instead of all these individual parameters.", "author": "joshsadam", "createdAt": "2020-09-16T15:36:33Z", "path": "src/main/java/ca/corefacility/bioinformatics/irida/ria/web/projects/settings/ProjectSettingsRemoteController.java", "diffHunk": "@@ -64,23 +68,23 @@ public ProjectSettingsRemoteController(MessageSource messageSource, ProjectServi\n \t\t\t@RequestParam(required = false, defaultValue = \"false\") boolean forceSync,\n \t\t\t@RequestParam(required = false, defaultValue = \"false\") boolean changeUser, Principal principal,", "originalCommit": "12402016c95c022c3045f77f3884ff9f5a2844de", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTUzNDg1Ng==", "url": "https://github.com/phac-nml/irida/pull/803#discussion_r489534856", "bodyText": "This is also an asynchronous response to you should create an ajax controller for this.", "author": "joshsadam", "createdAt": "2020-09-16T15:37:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTUzNDM1NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTcyMjM1OA==", "url": "https://github.com/phac-nml/irida/pull/803#discussion_r489722358", "bodyText": "Updated both in 5bc543e", "author": "deepsidhu85", "createdAt": "2020-09-16T20:03:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTUzNDM1NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTUzNTQ4MQ==", "url": "https://github.com/phac-nml/irida/pull/803#discussion_r489535481", "bodyText": "Same here, this should be in an ajax controller", "author": "joshsadam", "createdAt": "2020-09-16T15:38:09Z", "path": "src/main/java/ca/corefacility/bioinformatics/irida/ria/web/projects/settings/ProjectSettingsRemoteController.java", "diffHunk": "@@ -132,4 +136,27 @@ public String getProjectSettingsRemotePage(@PathVariable Long projectId, final M\n \t\tprojectControllerUtils.getProjectTemplateDetails(model, principal, project);\n \t\treturn \"projects/settings/pages/remote\";\n \t}\n+\n+\t/**\n+\t * Gets the remote synchronization {@link Project} settings\n+\t *\n+\t * @param projectId the ID of the {@link Project} to read\n+\t * @return {@link RemoteProjectSettings} object which has the\n+\t * remote project synchronization settings\n+\t */\n+\t@RequestMapping(\"/remote-settings\")\n+\t@PreAuthorize(\"hasPermission(#projectId, 'canManageLocalProjectSettings')\")", "originalCommit": "12402016c95c022c3045f77f3884ff9f5a2844de", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTcyMjMxMA==", "url": "https://github.com/phac-nml/irida/pull/803#discussion_r489722310", "bodyText": "Updated in 5bc543e", "author": "deepsidhu85", "createdAt": "2020-09-16T20:03:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTUzNTQ4MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTUzNjIwOQ==", "url": "https://github.com/phac-nml/irida/pull/803#discussion_r489536209", "bodyText": "We should create a thymeleaf fragement that displays an internationalizaed loading component, before react takes over. \u00a0You don't need to do this here.", "author": "joshsadam", "createdAt": "2020-09-16T15:39:08Z", "path": "src/main/webapp/pages/projects/settings/pages/remote.html", "diffHunk": "@@ -1,69 +1,21 @@\n <!DOCTYPE html>\n-<html xmlns:th=\"http://www.thymeleaf.org\" xmlns:layout=\"http://www.ultraq.net.nz/thymeleaf/layout\"\n-      data-layout-decorate=\"~{projects/settings/_base}\">\n-<head>\n-    <title th:text=\"#{project.settings.page.title.remote}\">Title</title>\n-        <script th:inline=\"javascript\">\n-        var PAGE = {\n-            urls: {\n-            'sync': /*[[@{/projects/{id}/settings/sync(id=${project.getId()})}]]*/ '/projects/1/settings/sync',\n-            }\n-        };\n-        </script>\n-</head>\n-<body>\n-<div layout:fragment=\"settings-content\" th:with=\"status = ${project.getRemoteStatus()}\">\n-    <h2 class=\"h2-muted\" th:text=\"#{project.settings.sync.heading}\"></h2>\n-    <div class=\"form-group\">\n-        <label class=\"control-label\" th:text=\"#{project.settings.sync.lastSync}\">_Last Sync_</label>\n-        <div>\n-            <span th:text=\"${#calendars.format(project.getRemoteStatus().getLastUpdate(), 'dd MMM yyyy hh:mma')}\"></span>\n-            <button id=\"forceSync\" role=\"button\" class=\"btn btn-default btn-sm\"\n-                    th:text=\"#{project.settings.sync.forceSync}\">_Force Sync_\n-            </button>\n-        </div>\n+<html\n+  lang=\"en\"\n+  xmlns:th=\"http://www.thymeleaf.org\"\n+  xmlns:layout=\"http://www.ultraq.net.nz/thymeleaf/layout\"\n+  data-layout-decorate=\"~{projects/settings/_base}\"\n+>\n+  <head>\n+    <meta charset=\"UTF-8\" />\n+    <link rel=\"stylesheet\" href=\"/dist/css/project-remote.bundle.css\">\n+    <title th:text=\"#{ProjectRemoteSettings.title}\">Title</title>\n+  </head>\n+  <body>\n+    <div id=\"project-remote-root\" layout:fragment=\"settings-content\" >\n+      <div th:text=\"#{ProjectRemote.loading}\">LOADING ...</div>", "originalCommit": "12402016c95c022c3045f77f3884ff9f5a2844de", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTcyMjc5Nw==", "url": "https://github.com/phac-nml/irida/pull/803#discussion_r489722797", "bodyText": "Good idea!", "author": "deepsidhu85", "createdAt": "2020-09-16T20:04:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTUzNjIwOQ=="}], "type": "inlineReview"}, {"oid": "3a3484fc895a6fcb96b6682639f90ebd53b993b5", "url": "https://github.com/phac-nml/irida/commit/3a3484fc895a6fcb96b6682639f90ebd53b993b5", "message": "Added test for remote project synchronization settings page", "committedDate": "2020-09-16T17:44:05Z", "type": "commit"}, {"oid": "5bc543eee44a8410455f2cbe94057ef721e15826", "url": "https://github.com/phac-nml/irida/commit/5bc543eee44a8410455f2cbe94057ef721e15826", "message": "Moved ajax methods to new controller. Updated sync mapping method to accept a RemoteProjectSettingsUpdateRequest dto instead of individual params.", "committedDate": "2020-09-16T20:02:08Z", "type": "commit"}, {"oid": "cb49da0eb457ff518d28cbb65a89cbef087821f5", "url": "https://github.com/phac-nml/irida/commit/cb49da0eb457ff518d28cbb65a89cbef087821f5", "message": "Removed redundant setting of base url", "committedDate": "2020-09-16T20:07:30Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTg0NzUzNg==", "url": "https://github.com/phac-nml/irida/pull/803#discussion_r489847536", "bodyText": "Where's the UI service?  You are making this controller so messy.", "author": "joshsadam", "createdAt": "2020-09-17T01:16:14Z", "path": "src/main/java/ca/corefacility/bioinformatics/irida/ria/web/projects/settings/ProjectSettingsRemoteAjaxController.java", "diffHunk": "@@ -0,0 +1,136 @@\n+package ca.corefacility.bioinformatics.irida.ria.web.projects.settings;\n+\n+import java.security.Principal;\n+import java.util.Date;\n+import java.util.HashMap;\n+import java.util.Locale;\n+import java.util.Map;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.context.MessageSource;\n+import org.springframework.security.access.prepost.PreAuthorize;\n+import org.springframework.web.bind.annotation.*;\n+\n+import ca.corefacility.bioinformatics.irida.model.RemoteAPI;\n+import ca.corefacility.bioinformatics.irida.model.project.Project;\n+import ca.corefacility.bioinformatics.irida.model.project.ProjectSyncFrequency;\n+import ca.corefacility.bioinformatics.irida.model.remote.RemoteStatus;\n+import ca.corefacility.bioinformatics.irida.model.user.User;\n+import ca.corefacility.bioinformatics.irida.ria.web.ajax.dto.RemoteProjectSettings;\n+import ca.corefacility.bioinformatics.irida.ria.web.ajax.dto.RemoteProjectSettingsUpdateRequest;\n+import ca.corefacility.bioinformatics.irida.service.ProjectService;\n+import ca.corefacility.bioinformatics.irida.service.remote.ProjectRemoteService;\n+import ca.corefacility.bioinformatics.irida.service.user.UserService;\n+\n+import com.google.common.collect.ImmutableMap;\n+\n+/**\n+ * Controller for managing settings for a remotely sync'd project\n+ * asynchronously\n+ */\n+@RestController\n+@RequestMapping(\"/ajax/remote-projects/{projectId}/settings\")\n+public class ProjectSettingsRemoteAjaxController {\n+\tprivate MessageSource messageSource;", "originalCommit": "cb49da0eb457ff518d28cbb65a89cbef087821f5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDI2ODE2Nw==", "url": "https://github.com/phac-nml/irida/pull/803#discussion_r490268167", "bodyText": "Added in 3bd9372", "author": "deepsidhu85", "createdAt": "2020-09-17T13:58:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTg0NzUzNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTg0Nzg0Ng==", "url": "https://github.com/phac-nml/irida/pull/803#discussion_r489847846", "bodyText": "You should return an object not a Map, This is where those AjaxSuccessResponse and AjaxErrorResponse come into play", "author": "joshsadam", "createdAt": "2020-09-17T01:16:41Z", "path": "src/main/java/ca/corefacility/bioinformatics/irida/ria/web/projects/settings/ProjectSettingsRemoteAjaxController.java", "diffHunk": "@@ -0,0 +1,136 @@\n+package ca.corefacility.bioinformatics.irida.ria.web.projects.settings;\n+\n+import java.security.Principal;\n+import java.util.Date;\n+import java.util.HashMap;\n+import java.util.Locale;\n+import java.util.Map;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.context.MessageSource;\n+import org.springframework.security.access.prepost.PreAuthorize;\n+import org.springframework.web.bind.annotation.*;\n+\n+import ca.corefacility.bioinformatics.irida.model.RemoteAPI;\n+import ca.corefacility.bioinformatics.irida.model.project.Project;\n+import ca.corefacility.bioinformatics.irida.model.project.ProjectSyncFrequency;\n+import ca.corefacility.bioinformatics.irida.model.remote.RemoteStatus;\n+import ca.corefacility.bioinformatics.irida.model.user.User;\n+import ca.corefacility.bioinformatics.irida.ria.web.ajax.dto.RemoteProjectSettings;\n+import ca.corefacility.bioinformatics.irida.ria.web.ajax.dto.RemoteProjectSettingsUpdateRequest;\n+import ca.corefacility.bioinformatics.irida.service.ProjectService;\n+import ca.corefacility.bioinformatics.irida.service.remote.ProjectRemoteService;\n+import ca.corefacility.bioinformatics.irida.service.user.UserService;\n+\n+import com.google.common.collect.ImmutableMap;\n+\n+/**\n+ * Controller for managing settings for a remotely sync'd project\n+ * asynchronously\n+ */\n+@RestController\n+@RequestMapping(\"/ajax/remote-projects/{projectId}/settings\")\n+public class ProjectSettingsRemoteAjaxController {\n+\tprivate MessageSource messageSource;\n+\tprivate ProjectService projectService;\n+\tprivate ProjectRemoteService projectRemoteService;\n+\tprivate UserService userService;\n+\n+\t@Autowired\n+\tpublic ProjectSettingsRemoteAjaxController(MessageSource messageSource, ProjectService projectService,\n+\t\t\tProjectRemoteService projectRemoteService, UserService userService) {\n+\t\tthis.messageSource = messageSource;\n+\t\tthis.projectService = projectService;\n+\t\tthis.projectRemoteService = projectRemoteService;\n+\t\tthis.userService = userService;\n+\t}\n+\n+\t/**\n+\t * Update the project sync settings\n+\t *\n+\t * @param projectId                          the project id to update\n+\t * @param remoteProjectSettingsUpdateRequest object which\n+\t *                                           is used to update frequency, and sync user, as well as\n+\t *                                           force sync for a project\n+\t * @param principal                          The current logged in user\n+\t * @param locale                             user's locale\n+\t * @return result message if successful\n+\t */\n+\t@PostMapping(value = \"/sync\")\n+\tpublic Map<String, String> updateProjectSyncSettings(@PathVariable Long projectId,", "originalCommit": "cb49da0eb457ff518d28cbb65a89cbef087821f5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDI2ODI4NQ==", "url": "https://github.com/phac-nml/irida/pull/803#discussion_r490268285", "bodyText": "Updated in 3bd9372", "author": "deepsidhu85", "createdAt": "2020-09-17T13:58:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTg0Nzg0Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTg0OTY5Ng==", "url": "https://github.com/phac-nml/irida/pull/803#discussion_r489849696", "bodyText": "Preface message keys returned from the server with server. that way we can keep track of where they are being used.  I also usually add the name of the component it is being used in: server.MyComponent.userchange.error for example.", "author": "joshsadam", "createdAt": "2020-09-17T01:19:39Z", "path": "src/main/java/ca/corefacility/bioinformatics/irida/ria/web/projects/settings/ProjectSettingsRemoteAjaxController.java", "diffHunk": "@@ -0,0 +1,136 @@\n+package ca.corefacility.bioinformatics.irida.ria.web.projects.settings;\n+\n+import java.security.Principal;\n+import java.util.Date;\n+import java.util.HashMap;\n+import java.util.Locale;\n+import java.util.Map;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.context.MessageSource;\n+import org.springframework.security.access.prepost.PreAuthorize;\n+import org.springframework.web.bind.annotation.*;\n+\n+import ca.corefacility.bioinformatics.irida.model.RemoteAPI;\n+import ca.corefacility.bioinformatics.irida.model.project.Project;\n+import ca.corefacility.bioinformatics.irida.model.project.ProjectSyncFrequency;\n+import ca.corefacility.bioinformatics.irida.model.remote.RemoteStatus;\n+import ca.corefacility.bioinformatics.irida.model.user.User;\n+import ca.corefacility.bioinformatics.irida.ria.web.ajax.dto.RemoteProjectSettings;\n+import ca.corefacility.bioinformatics.irida.ria.web.ajax.dto.RemoteProjectSettingsUpdateRequest;\n+import ca.corefacility.bioinformatics.irida.service.ProjectService;\n+import ca.corefacility.bioinformatics.irida.service.remote.ProjectRemoteService;\n+import ca.corefacility.bioinformatics.irida.service.user.UserService;\n+\n+import com.google.common.collect.ImmutableMap;\n+\n+/**\n+ * Controller for managing settings for a remotely sync'd project\n+ * asynchronously\n+ */\n+@RestController\n+@RequestMapping(\"/ajax/remote-projects/{projectId}/settings\")\n+public class ProjectSettingsRemoteAjaxController {\n+\tprivate MessageSource messageSource;\n+\tprivate ProjectService projectService;\n+\tprivate ProjectRemoteService projectRemoteService;\n+\tprivate UserService userService;\n+\n+\t@Autowired\n+\tpublic ProjectSettingsRemoteAjaxController(MessageSource messageSource, ProjectService projectService,\n+\t\t\tProjectRemoteService projectRemoteService, UserService userService) {\n+\t\tthis.messageSource = messageSource;\n+\t\tthis.projectService = projectService;\n+\t\tthis.projectRemoteService = projectRemoteService;\n+\t\tthis.userService = userService;\n+\t}\n+\n+\t/**\n+\t * Update the project sync settings\n+\t *\n+\t * @param projectId                          the project id to update\n+\t * @param remoteProjectSettingsUpdateRequest object which\n+\t *                                           is used to update frequency, and sync user, as well as\n+\t *                                           force sync for a project\n+\t * @param principal                          The current logged in user\n+\t * @param locale                             user's locale\n+\t * @return result message if successful\n+\t */\n+\t@PostMapping(value = \"/sync\")\n+\tpublic Map<String, String> updateProjectSyncSettings(@PathVariable Long projectId,\n+\t\t\t@RequestBody RemoteProjectSettingsUpdateRequest remoteProjectSettingsUpdateRequest,\n+\t\t\tPrincipal principal,\n+\t\t\tLocale locale) {\n+\n+\t\tProject read = projectService.read(projectId);\n+\t\tRemoteStatus remoteStatus = read.getRemoteStatus();\n+\t\tMap<String, Object> updates = new HashMap<>();\n+\n+\t\tString message = null;\n+\t\tString error = null;\n+\n+\t\tif (remoteProjectSettingsUpdateRequest.getProjectSyncFrequency() != null) {\n+\t\t\tupdates.put(\"syncFrequency\", remoteProjectSettingsUpdateRequest.getProjectSyncFrequency());\n+\t\t\tmessage = messageSource.getMessage(\"project.settings.notifications.sync.frequencychange\", new Object[] {remoteProjectSettingsUpdateRequest.getProjectSyncFrequency()}, locale);\n+\t\t}\n+\n+\t\tif (remoteProjectSettingsUpdateRequest.getForceSync()) {\n+\t\t\tremoteStatus.setSyncStatus(RemoteStatus.SyncStatus.MARKED);\n+\t\t\tupdates.put(\"remoteStatus\", remoteStatus);\n+\t\t\tmessage = messageSource.getMessage(\"project.settings.notifications.sync.marked.for.sync\", new Object[] {}, locale);\n+\t\t}\n+\n+\t\tif (remoteProjectSettingsUpdateRequest.getChangeUser()) {\n+\t\t\t// ensure the user can read the project\n+\t\t\ttry {\n+\t\t\t\tprojectRemoteService.read(remoteStatus.getURL());\n+\n+\t\t\t\tUser user = userService.getUserByUsername(principal.getName());\n+\t\t\t\tremoteStatus.setReadBy(user);\n+\t\t\t\tupdates.put(\"remoteStatus\", remoteStatus);\n+\n+\t\t\t\tmessage = messageSource.getMessage(\"project.settings.notifications.sync.userchange\", new Object[] {},\n+\t\t\t\t\t\tlocale);\n+\t\t\t} catch (Exception ex) {\n+\t\t\t\terror = messageSource.getMessage(\"project.settings.notifications.sync.userchange.error\",", "originalCommit": "cb49da0eb457ff518d28cbb65a89cbef087821f5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDI2ODM3OA==", "url": "https://github.com/phac-nml/irida/pull/803#discussion_r490268378", "bodyText": "Updated in 3bd9372", "author": "deepsidhu85", "createdAt": "2020-09-17T13:58:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTg0OTY5Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTg1MDkzNA==", "url": "https://github.com/phac-nml/irida/pull/803#discussion_r489850934", "bodyText": "Also it would be better to return an ResponseEntitiy so you can return a bad status so your ui can handle it properly", "author": "joshsadam", "createdAt": "2020-09-17T01:21:41Z", "path": "src/main/java/ca/corefacility/bioinformatics/irida/ria/web/projects/settings/ProjectSettingsRemoteAjaxController.java", "diffHunk": "@@ -0,0 +1,136 @@\n+package ca.corefacility.bioinformatics.irida.ria.web.projects.settings;\n+\n+import java.security.Principal;\n+import java.util.Date;\n+import java.util.HashMap;\n+import java.util.Locale;\n+import java.util.Map;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.context.MessageSource;\n+import org.springframework.security.access.prepost.PreAuthorize;\n+import org.springframework.web.bind.annotation.*;\n+\n+import ca.corefacility.bioinformatics.irida.model.RemoteAPI;\n+import ca.corefacility.bioinformatics.irida.model.project.Project;\n+import ca.corefacility.bioinformatics.irida.model.project.ProjectSyncFrequency;\n+import ca.corefacility.bioinformatics.irida.model.remote.RemoteStatus;\n+import ca.corefacility.bioinformatics.irida.model.user.User;\n+import ca.corefacility.bioinformatics.irida.ria.web.ajax.dto.RemoteProjectSettings;\n+import ca.corefacility.bioinformatics.irida.ria.web.ajax.dto.RemoteProjectSettingsUpdateRequest;\n+import ca.corefacility.bioinformatics.irida.service.ProjectService;\n+import ca.corefacility.bioinformatics.irida.service.remote.ProjectRemoteService;\n+import ca.corefacility.bioinformatics.irida.service.user.UserService;\n+\n+import com.google.common.collect.ImmutableMap;\n+\n+/**\n+ * Controller for managing settings for a remotely sync'd project\n+ * asynchronously\n+ */\n+@RestController\n+@RequestMapping(\"/ajax/remote-projects/{projectId}/settings\")\n+public class ProjectSettingsRemoteAjaxController {\n+\tprivate MessageSource messageSource;\n+\tprivate ProjectService projectService;\n+\tprivate ProjectRemoteService projectRemoteService;\n+\tprivate UserService userService;\n+\n+\t@Autowired\n+\tpublic ProjectSettingsRemoteAjaxController(MessageSource messageSource, ProjectService projectService,\n+\t\t\tProjectRemoteService projectRemoteService, UserService userService) {\n+\t\tthis.messageSource = messageSource;\n+\t\tthis.projectService = projectService;\n+\t\tthis.projectRemoteService = projectRemoteService;\n+\t\tthis.userService = userService;\n+\t}\n+\n+\t/**\n+\t * Update the project sync settings\n+\t *\n+\t * @param projectId                          the project id to update\n+\t * @param remoteProjectSettingsUpdateRequest object which\n+\t *                                           is used to update frequency, and sync user, as well as\n+\t *                                           force sync for a project\n+\t * @param principal                          The current logged in user\n+\t * @param locale                             user's locale\n+\t * @return result message if successful\n+\t */\n+\t@PostMapping(value = \"/sync\")\n+\tpublic Map<String, String> updateProjectSyncSettings(@PathVariable Long projectId,\n+\t\t\t@RequestBody RemoteProjectSettingsUpdateRequest remoteProjectSettingsUpdateRequest,\n+\t\t\tPrincipal principal,\n+\t\t\tLocale locale) {\n+\n+\t\tProject read = projectService.read(projectId);\n+\t\tRemoteStatus remoteStatus = read.getRemoteStatus();\n+\t\tMap<String, Object> updates = new HashMap<>();\n+\n+\t\tString message = null;\n+\t\tString error = null;\n+\n+\t\tif (remoteProjectSettingsUpdateRequest.getProjectSyncFrequency() != null) {\n+\t\t\tupdates.put(\"syncFrequency\", remoteProjectSettingsUpdateRequest.getProjectSyncFrequency());\n+\t\t\tmessage = messageSource.getMessage(\"project.settings.notifications.sync.frequencychange\", new Object[] {remoteProjectSettingsUpdateRequest.getProjectSyncFrequency()}, locale);\n+\t\t}\n+\n+\t\tif (remoteProjectSettingsUpdateRequest.getForceSync()) {\n+\t\t\tremoteStatus.setSyncStatus(RemoteStatus.SyncStatus.MARKED);\n+\t\t\tupdates.put(\"remoteStatus\", remoteStatus);\n+\t\t\tmessage = messageSource.getMessage(\"project.settings.notifications.sync.marked.for.sync\", new Object[] {}, locale);\n+\t\t}\n+\n+\t\tif (remoteProjectSettingsUpdateRequest.getChangeUser()) {\n+\t\t\t// ensure the user can read the project\n+\t\t\ttry {\n+\t\t\t\tprojectRemoteService.read(remoteStatus.getURL());\n+\n+\t\t\t\tUser user = userService.getUserByUsername(principal.getName());\n+\t\t\t\tremoteStatus.setReadBy(user);\n+\t\t\t\tupdates.put(\"remoteStatus\", remoteStatus);\n+\n+\t\t\t\tmessage = messageSource.getMessage(\"project.settings.notifications.sync.userchange\", new Object[] {},\n+\t\t\t\t\t\tlocale);\n+\t\t\t} catch (Exception ex) {\n+\t\t\t\terror = messageSource.getMessage(\"project.settings.notifications.sync.userchange.error\",\n+\t\t\t\t\t\tnew Object[] {}, locale);\n+\t\t\t}\n+\t\t}\n+\n+\t\tprojectService.updateProjectSettings(read, updates);\n+\n+\t\tMap<String, String> response;\n+\t\tif (error == null) {\n+\t\t\tresponse = ImmutableMap.of(\"result\", message);\n+\t\t} else {", "originalCommit": "cb49da0eb457ff518d28cbb65a89cbef087821f5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDI2ODQ1Mg==", "url": "https://github.com/phac-nml/irida/pull/803#discussion_r490268452", "bodyText": "Updated in 3bd9372", "author": "deepsidhu85", "createdAt": "2020-09-17T13:58:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTg1MDkzNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTg1NDU1MQ==", "url": "https://github.com/phac-nml/irida/pull/803#discussion_r489854551", "bodyText": "You only need the br tag here because you used a span above which is an inline element.  Make it a block element div is the most basic, but you could you semantically appropriate one like a heading or paragraph.", "author": "joshsadam", "createdAt": "2020-09-17T01:27:16Z", "path": "src/main/webapp/resources/js/pages/projects/remote/ProjectSynchronizationSettings.jsx", "diffHunk": "@@ -0,0 +1,113 @@\n+import React, { useEffect, useState } from \"react\";\n+import { Button, Form, notification } from \"antd\";\n+import { BasicList } from \"../../../components/lists\";\n+import { RemoteApiStatus } from \"../../admin/components/remote-connections/RemoteApiStatus\";\n+import {\n+  updateRemoteProjectSyncSettings,\n+  getRemoteProjectSyncSettings }\n+from \"../../../apis/projects/remote-projects\";\n+import { formatDate } from \"../../../utilities/date-utilities\";\n+import { SyncFrequencySelect } from \"../../../components/remote-api/SyncFrequencySelect\";\n+import { HelpPopover } from \"../../../components/popovers\";\n+\n+/**\n+ * React component for render the remote project sync settings.\n+ * @returns {*}\n+ * @constructor\n+ */\n+export function ProjectSynchronizationSettings() {\n+  const projectId = window.location.pathname.match(/projects\\/(\\d+)/)[1];\n+  const syncNowEnabledStates = [\"SYNCHRONIZED\", \"ERROR\"];\n+  const [remoteProjectData, setRemoteProjectData] = useState(null);\n+  const [disableSyncNow, setDisableSyncNow] = useState(false);\n+\n+  /*\n+  When this component is rendered, query the api for the specific settings\n+  for this remote project.\n+   */\n+  useEffect(() => {\n+    getRemoteProjectSyncSettings(projectId).then(remoteProjectSettings => {\n+      setRemoteProjectData(remoteProjectSettings);\n+    }).catch((message) => {\n+      notification.error({ message });\n+    });\n+  }, []);\n+\n+  const syncSettings = remoteProjectData === null ? [] : [\n+      {\n+        title: i18n(\"ProjectRemoteSettings.lastSync\"),\n+        desc: (<div>\n+          <span>{formatDate({ date: remoteProjectData.lastUpdate })}</span>\n+          <br />\n+          <Button type=\"primary\"\n+                  onClick={() => updateSyncSettings({ forceSync: true })}\n+                  disabled={(disableSyncNow ? true : false) ||\n+                            (syncNowEnabledStates.includes(remoteProjectData.remoteStatus.syncStatus) ? false : true)}\n+                  className=\"t-sync-now-btn\"\n+          >\n+            {i18n(\"ProjectRemoteSettings.syncNow\")}\n+          </Button>\n+        </div>)\n+      },\n+      {\n+        title: i18n(\"ProjectRemoteSettings.remoteConnection\"),\n+        desc: (<span>{remoteProjectData.remoteAPI.label}<RemoteApiStatus\n+          key=\"status\"\n+          api={{ id: remoteProjectData.remoteAPI.identifier }}\n+        /></span>)\n+      },\n+      {\n+        title: <span>\n+                <span>{i18n(\"ProjectRemoteSettings.syncFrequency\")}</span>\n+                <HelpPopover\n+                  content={<div>{i18n(\"SyncFrequencySelect.frequency.help\")}</div>}\n+                />\n+               </span>,\n+        desc: (\n+          <Form initialValues={{\n+            frequency: remoteProjectData.projectSyncFrequencies.indexOf(remoteProjectData.projectSyncFrequency),\n+          }}>\n+            <SyncFrequencySelect\n+              onChange={(e) => updateSyncSettings({ projectSyncFrequency: remoteProjectData.projectSyncFrequencies[e] })}\n+              labelRequired={false}\n+            />\n+          </Form>\n+        )\n+      },\n+      {\n+        title: i18n(\"ProjectRemoteSettings.syncUser\"),\n+        desc: (<div>\n+          <span>{remoteProjectData.syncUser.label}</span>\n+          <br />", "originalCommit": "cb49da0eb457ff518d28cbb65a89cbef087821f5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDIyNjE0Nw==", "url": "https://github.com/phac-nml/irida/pull/803#discussion_r490226147", "bodyText": "Updated in 910177c", "author": "deepsidhu85", "createdAt": "2020-09-17T13:03:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTg1NDU1MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTg1NTYyMA==", "url": "https://github.com/phac-nml/irida/pull/803#discussion_r489855620", "bodyText": "Redundant if forceSync is true than the if statement is truth.", "author": "joshsadam", "createdAt": "2020-09-17T01:28:52Z", "path": "src/main/webapp/resources/js/pages/projects/remote/ProjectSynchronizationSettings.jsx", "diffHunk": "@@ -0,0 +1,113 @@\n+import React, { useEffect, useState } from \"react\";\n+import { Button, Form, notification } from \"antd\";\n+import { BasicList } from \"../../../components/lists\";\n+import { RemoteApiStatus } from \"../../admin/components/remote-connections/RemoteApiStatus\";\n+import {\n+  updateRemoteProjectSyncSettings,\n+  getRemoteProjectSyncSettings }\n+from \"../../../apis/projects/remote-projects\";\n+import { formatDate } from \"../../../utilities/date-utilities\";\n+import { SyncFrequencySelect } from \"../../../components/remote-api/SyncFrequencySelect\";\n+import { HelpPopover } from \"../../../components/popovers\";\n+\n+/**\n+ * React component for render the remote project sync settings.\n+ * @returns {*}\n+ * @constructor\n+ */\n+export function ProjectSynchronizationSettings() {\n+  const projectId = window.location.pathname.match(/projects\\/(\\d+)/)[1];\n+  const syncNowEnabledStates = [\"SYNCHRONIZED\", \"ERROR\"];\n+  const [remoteProjectData, setRemoteProjectData] = useState(null);\n+  const [disableSyncNow, setDisableSyncNow] = useState(false);\n+\n+  /*\n+  When this component is rendered, query the api for the specific settings\n+  for this remote project.\n+   */\n+  useEffect(() => {\n+    getRemoteProjectSyncSettings(projectId).then(remoteProjectSettings => {\n+      setRemoteProjectData(remoteProjectSettings);\n+    }).catch((message) => {\n+      notification.error({ message });\n+    });\n+  }, []);\n+\n+  const syncSettings = remoteProjectData === null ? [] : [\n+      {\n+        title: i18n(\"ProjectRemoteSettings.lastSync\"),\n+        desc: (<div>\n+          <span>{formatDate({ date: remoteProjectData.lastUpdate })}</span>\n+          <br />\n+          <Button type=\"primary\"\n+                  onClick={() => updateSyncSettings({ forceSync: true })}\n+                  disabled={(disableSyncNow ? true : false) ||\n+                            (syncNowEnabledStates.includes(remoteProjectData.remoteStatus.syncStatus) ? false : true)}\n+                  className=\"t-sync-now-btn\"\n+          >\n+            {i18n(\"ProjectRemoteSettings.syncNow\")}\n+          </Button>\n+        </div>)\n+      },\n+      {\n+        title: i18n(\"ProjectRemoteSettings.remoteConnection\"),\n+        desc: (<span>{remoteProjectData.remoteAPI.label}<RemoteApiStatus\n+          key=\"status\"\n+          api={{ id: remoteProjectData.remoteAPI.identifier }}\n+        /></span>)\n+      },\n+      {\n+        title: <span>\n+                <span>{i18n(\"ProjectRemoteSettings.syncFrequency\")}</span>\n+                <HelpPopover\n+                  content={<div>{i18n(\"SyncFrequencySelect.frequency.help\")}</div>}\n+                />\n+               </span>,\n+        desc: (\n+          <Form initialValues={{\n+            frequency: remoteProjectData.projectSyncFrequencies.indexOf(remoteProjectData.projectSyncFrequency),\n+          }}>\n+            <SyncFrequencySelect\n+              onChange={(e) => updateSyncSettings({ projectSyncFrequency: remoteProjectData.projectSyncFrequencies[e] })}\n+              labelRequired={false}\n+            />\n+          </Form>\n+        )\n+      },\n+      {\n+        title: i18n(\"ProjectRemoteSettings.syncUser\"),\n+        desc: (<div>\n+          <span>{remoteProjectData.syncUser.label}</span>\n+          <br />\n+          { window.TL._USER.identifier !== remoteProjectData.syncUser.identifier ?\n+              <Button\n+                onClick={() => updateSyncSettings({ changeUser: true })}\n+                className=\"t-become-sync-user-btn\"\n+              >\n+                {i18n(\"ProjectRemoteSettings.becomeSyncUser\")}\n+              </Button>\n+            : null\n+          }\n+        </div>)\n+      }\n+    ];\n+\n+  // Used to update sync user, sync frequency, and force to sync now\n+  function updateSyncSettings({forceSync, changeUser, projectSyncFrequency}) {\n+    updateRemoteProjectSyncSettings(projectId, {forceSync, changeUser, projectSyncFrequency}).then(res => {\n+      notification.success({ message: res.result });\n+      if(forceSync === true) {", "originalCommit": "cb49da0eb457ff518d28cbb65a89cbef087821f5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDIyNjA4Mw==", "url": "https://github.com/phac-nml/irida/pull/803#discussion_r490226083", "bodyText": "Updated in 910177c", "author": "deepsidhu85", "createdAt": "2020-09-17T13:03:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTg1NTYyMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTg1NjA0MQ==", "url": "https://github.com/phac-nml/irida/pull/803#discussion_r489856041", "bodyText": "Can you use the ant design heading", "author": "joshsadam", "createdAt": "2020-09-17T01:29:28Z", "path": "src/main/webapp/resources/js/pages/projects/remote/ProjectSynchronizationSettings.jsx", "diffHunk": "@@ -0,0 +1,113 @@\n+import React, { useEffect, useState } from \"react\";\n+import { Button, Form, notification } from \"antd\";\n+import { BasicList } from \"../../../components/lists\";\n+import { RemoteApiStatus } from \"../../admin/components/remote-connections/RemoteApiStatus\";\n+import {\n+  updateRemoteProjectSyncSettings,\n+  getRemoteProjectSyncSettings }\n+from \"../../../apis/projects/remote-projects\";\n+import { formatDate } from \"../../../utilities/date-utilities\";\n+import { SyncFrequencySelect } from \"../../../components/remote-api/SyncFrequencySelect\";\n+import { HelpPopover } from \"../../../components/popovers\";\n+\n+/**\n+ * React component for render the remote project sync settings.\n+ * @returns {*}\n+ * @constructor\n+ */\n+export function ProjectSynchronizationSettings() {\n+  const projectId = window.location.pathname.match(/projects\\/(\\d+)/)[1];\n+  const syncNowEnabledStates = [\"SYNCHRONIZED\", \"ERROR\"];\n+  const [remoteProjectData, setRemoteProjectData] = useState(null);\n+  const [disableSyncNow, setDisableSyncNow] = useState(false);\n+\n+  /*\n+  When this component is rendered, query the api for the specific settings\n+  for this remote project.\n+   */\n+  useEffect(() => {\n+    getRemoteProjectSyncSettings(projectId).then(remoteProjectSettings => {\n+      setRemoteProjectData(remoteProjectSettings);\n+    }).catch((message) => {\n+      notification.error({ message });\n+    });\n+  }, []);\n+\n+  const syncSettings = remoteProjectData === null ? [] : [\n+      {\n+        title: i18n(\"ProjectRemoteSettings.lastSync\"),\n+        desc: (<div>\n+          <span>{formatDate({ date: remoteProjectData.lastUpdate })}</span>\n+          <br />\n+          <Button type=\"primary\"\n+                  onClick={() => updateSyncSettings({ forceSync: true })}\n+                  disabled={(disableSyncNow ? true : false) ||\n+                            (syncNowEnabledStates.includes(remoteProjectData.remoteStatus.syncStatus) ? false : true)}\n+                  className=\"t-sync-now-btn\"\n+          >\n+            {i18n(\"ProjectRemoteSettings.syncNow\")}\n+          </Button>\n+        </div>)\n+      },\n+      {\n+        title: i18n(\"ProjectRemoteSettings.remoteConnection\"),\n+        desc: (<span>{remoteProjectData.remoteAPI.label}<RemoteApiStatus\n+          key=\"status\"\n+          api={{ id: remoteProjectData.remoteAPI.identifier }}\n+        /></span>)\n+      },\n+      {\n+        title: <span>\n+                <span>{i18n(\"ProjectRemoteSettings.syncFrequency\")}</span>\n+                <HelpPopover\n+                  content={<div>{i18n(\"SyncFrequencySelect.frequency.help\")}</div>}\n+                />\n+               </span>,\n+        desc: (\n+          <Form initialValues={{\n+            frequency: remoteProjectData.projectSyncFrequencies.indexOf(remoteProjectData.projectSyncFrequency),\n+          }}>\n+            <SyncFrequencySelect\n+              onChange={(e) => updateSyncSettings({ projectSyncFrequency: remoteProjectData.projectSyncFrequencies[e] })}\n+              labelRequired={false}\n+            />\n+          </Form>\n+        )\n+      },\n+      {\n+        title: i18n(\"ProjectRemoteSettings.syncUser\"),\n+        desc: (<div>\n+          <span>{remoteProjectData.syncUser.label}</span>\n+          <br />\n+          { window.TL._USER.identifier !== remoteProjectData.syncUser.identifier ?\n+              <Button\n+                onClick={() => updateSyncSettings({ changeUser: true })}\n+                className=\"t-become-sync-user-btn\"\n+              >\n+                {i18n(\"ProjectRemoteSettings.becomeSyncUser\")}\n+              </Button>\n+            : null\n+          }\n+        </div>)\n+      }\n+    ];\n+\n+  // Used to update sync user, sync frequency, and force to sync now\n+  function updateSyncSettings({forceSync, changeUser, projectSyncFrequency}) {\n+    updateRemoteProjectSyncSettings(projectId, {forceSync, changeUser, projectSyncFrequency}).then(res => {\n+      notification.success({ message: res.result });\n+      if(forceSync === true) {\n+        setDisableSyncNow(true);\n+      }\n+    }).catch((message) => {\n+      notification.error({ message });\n+    });\n+  }\n+\n+  return (\n+    <>\n+      <h1 className=\"t-main-heading\">{i18n(\"ProjectRemoteSettings.heading\")}</h1>", "originalCommit": "cb49da0eb457ff518d28cbb65a89cbef087821f5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDIyNjAxNg==", "url": "https://github.com/phac-nml/irida/pull/803#discussion_r490226016", "bodyText": "Updated in 910177c", "author": "deepsidhu85", "createdAt": "2020-09-17T13:03:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTg1NjA0MQ=="}], "type": "inlineReview"}, {"oid": "910177cfbe369c72a9c125601432c54076e13bc2", "url": "https://github.com/phac-nml/irida/commit/910177cfbe369c72a9c125601432c54076e13bc2", "message": "Removed br tags, updated to use ant design title, removed redudnant === true when checking if forceSync is set", "committedDate": "2020-09-17T13:02:45Z", "type": "commit"}, {"oid": "3bd93720a5eb17ec1c86cc4c22cfa47f30d13312", "url": "https://github.com/phac-nml/irida/commit/3bd93720a5eb17ec1c86cc4c22cfa47f30d13312", "message": "Created new UIRemoteProjectService and refactored code from ProjectSettingsRemoteAjaxController into this service to clean up controller. Updated translation keys to preface with server.ProjectRemote which are returned for that component. Updated controller methods to return ResponseEntity<DTOTYYPE> and uiremoteprojectservice to return objects rather than a map", "committedDate": "2020-09-17T13:57:31Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDI4MzEzNA==", "url": "https://github.com/phac-nml/irida/pull/803#discussion_r490283134", "bodyText": "JavaDoc", "author": "joshsadam", "createdAt": "2020-09-17T14:16:55Z", "path": "src/main/java/ca/corefacility/bioinformatics/irida/ria/web/ajax/dto/ajax/AjaxUpdateItemSuccessResponse.java", "diffHunk": "@@ -0,0 +1,17 @@\n+package ca.corefacility.bioinformatics.irida.ria.web.ajax.dto.ajax;\n+\n+public class AjaxUpdateItemSuccessResponse extends AjaxResponse {", "originalCommit": "3bd93720a5eb17ec1c86cc4c22cfa47f30d13312", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDI4NTI0NA==", "url": "https://github.com/phac-nml/irida/pull/803#discussion_r490285244", "bodyText": "Updated in a7b64f1", "author": "deepsidhu85", "createdAt": "2020-09-17T14:19:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDI4MzEzNA=="}], "type": "inlineReview"}, {"oid": "a7b64f193de58ec912b52536d2aaa704a43a136f", "url": "https://github.com/phac-nml/irida/commit/a7b64f193de58ec912b52536d2aaa704a43a136f", "message": "Added javadoc", "committedDate": "2020-09-17T14:19:01Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDI4NTk2NQ==", "url": "https://github.com/phac-nml/irida/pull/803#discussion_r490285965", "bodyText": "You should handle this a little differently. \u00a0Have your service throw an error catch it here and then create your responses. \u00a0The reason is that if it fails you can return an HttpStatus. error code.", "author": "joshsadam", "createdAt": "2020-09-17T14:20:38Z", "path": "src/main/java/ca/corefacility/bioinformatics/irida/ria/web/projects/settings/ProjectSettingsRemoteAjaxController.java", "diffHunk": "@@ -0,0 +1,63 @@\n+package ca.corefacility.bioinformatics.irida.ria.web.projects.settings;\n+\n+import java.security.Principal;\n+import java.util.Locale;\n+\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.http.ResponseEntity;\n+import org.springframework.security.access.prepost.PreAuthorize;\n+import org.springframework.web.bind.annotation.*;\n+\n+import ca.corefacility.bioinformatics.irida.model.project.Project;\n+import ca.corefacility.bioinformatics.irida.ria.web.ajax.dto.RemoteProjectSettings;\n+import ca.corefacility.bioinformatics.irida.ria.web.ajax.dto.RemoteProjectSettingsUpdateRequest;\n+import ca.corefacility.bioinformatics.irida.ria.web.ajax.dto.ajax.AjaxResponse;\n+import ca.corefacility.bioinformatics.irida.ria.web.services.UIRemoteProjectService;\n+\n+/**\n+ * Controller for managing settings for a remotely sync'd project\n+ * asynchronously\n+ */\n+@RestController\n+@RequestMapping(\"/ajax/remote-projects/{projectId}/settings\")\n+public class ProjectSettingsRemoteAjaxController {\n+\tprivate UIRemoteProjectService uiRemoteProjectService;\n+\n+\t@Autowired\n+\tpublic ProjectSettingsRemoteAjaxController(UIRemoteProjectService uiRemoteProjectService) {\n+\t\tthis.uiRemoteProjectService = uiRemoteProjectService;\n+\t}\n+\n+\t/**\n+\t * Update the remote project sync settings\n+\t *\n+\t * @param projectId                          the project id to update\n+\t * @param remoteProjectSettingsUpdateRequest object which\n+\t *                                           is used to update frequency, and sync user, as well as\n+\t *                                           force sync for a project\n+\t * @param principal                          The current logged in user\n+\t * @param locale                             user's locale\n+\t * @return AjaxResponse if error return AjaxErrorResponse otherwise return AjaxUpdateItemSuccessResponse\n+\t */\n+\t@PostMapping(value = \"/sync\")\n+\tpublic ResponseEntity<AjaxResponse> updateProjectSyncSettings(@PathVariable Long projectId,\n+\t\t\t@RequestBody RemoteProjectSettingsUpdateRequest remoteProjectSettingsUpdateRequest, Principal principal,", "originalCommit": "3bd93720a5eb17ec1c86cc4c22cfa47f30d13312", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDMyOTc0OA==", "url": "https://github.com/phac-nml/irida/pull/803#discussion_r490329748", "bodyText": "Updated in dc6a734", "author": "deepsidhu85", "createdAt": "2020-09-17T15:09:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDI4NTk2NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDI5MDk2Mg==", "url": "https://github.com/phac-nml/irida/pull/803#discussion_r490290962", "bodyText": "Use !Strings.isNullOrEmpty(error) for these checks", "author": "joshsadam", "createdAt": "2020-09-17T14:26:57Z", "path": "src/main/java/ca/corefacility/bioinformatics/irida/ria/web/services/UIRemoteProjectService.java", "diffHunk": "@@ -0,0 +1,127 @@\n+package ca.corefacility.bioinformatics.irida.ria.web.services;\n+\n+import java.security.Principal;\n+import java.util.Date;\n+import java.util.HashMap;\n+import java.util.Locale;\n+import java.util.Map;\n+\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.context.MessageSource;\n+import org.springframework.stereotype.Component;\n+\n+import ca.corefacility.bioinformatics.irida.model.RemoteAPI;\n+import ca.corefacility.bioinformatics.irida.model.project.Project;\n+import ca.corefacility.bioinformatics.irida.model.project.ProjectSyncFrequency;\n+import ca.corefacility.bioinformatics.irida.model.remote.RemoteStatus;\n+import ca.corefacility.bioinformatics.irida.model.user.User;\n+import ca.corefacility.bioinformatics.irida.ria.web.ajax.dto.RemoteProjectSettings;\n+import ca.corefacility.bioinformatics.irida.ria.web.ajax.dto.RemoteProjectSettingsUpdateRequest;\n+import ca.corefacility.bioinformatics.irida.ria.web.ajax.dto.ajax.AjaxErrorResponse;\n+import ca.corefacility.bioinformatics.irida.ria.web.ajax.dto.ajax.AjaxResponse;\n+import ca.corefacility.bioinformatics.irida.ria.web.ajax.dto.ajax.AjaxUpdateItemSuccessResponse;\n+import ca.corefacility.bioinformatics.irida.service.ProjectService;\n+import ca.corefacility.bioinformatics.irida.service.remote.ProjectRemoteService;\n+import ca.corefacility.bioinformatics.irida.service.user.UserService;\n+\n+/**\n+ * A utility class for doing operations on remote project sync settings.\n+ */\n+\n+@Component\n+public class UIRemoteProjectService {\n+\tprivate MessageSource messageSource;\n+\tprivate ProjectService projectService;\n+\tprivate ProjectRemoteService projectRemoteService;\n+\tprivate UserService userService;\n+\n+\t@Autowired\n+\tpublic UIRemoteProjectService(MessageSource messageSource, ProjectService projectService,\n+\t\t\tProjectRemoteService projectRemoteService, UserService userService) {\n+\t\tthis.messageSource = messageSource;\n+\t\tthis.projectService = projectService;\n+\t\tthis.projectRemoteService = projectRemoteService;\n+\t\tthis.userService = userService;\n+\t}\n+\n+\t/**\n+\t * Update the project sync settings\n+\t *\n+\t * @param projectId                          the project id to update\n+\t * @param remoteProjectSettingsUpdateRequest object which\n+\t *                                           is used to update frequency, and sync user, as well as\n+\t *                                           force sync for a project\n+\t * @param principal                          The current logged in user\n+\t * @param locale                             user's locale\n+\t * @return {@link AjaxResponse}\n+\t */\n+\tpublic AjaxResponse updateProjectSyncSettings(Long projectId,\n+\t\t\tRemoteProjectSettingsUpdateRequest remoteProjectSettingsUpdateRequest, Principal principal, Locale locale) {\n+\t\tProject project = projectService.read(projectId);\n+\n+\t\tif (project != null) {\n+\t\t\tRemoteStatus remoteStatus = project.getRemoteStatus();\n+\t\t\tMap<String, Object> updates = new HashMap<>();\n+\n+\t\t\tString message = null;\n+\t\t\tString error = null;\n+\n+\t\t\tif (remoteProjectSettingsUpdateRequest.getProjectSyncFrequency() != null) {\n+\t\t\t\tupdates.put(\"syncFrequency\", remoteProjectSettingsUpdateRequest.getProjectSyncFrequency());\n+\t\t\t\tmessage = messageSource.getMessage(\"server.ProjectRemote.frequency.change\",\n+\t\t\t\t\t\tnew Object[] { remoteProjectSettingsUpdateRequest.getProjectSyncFrequency() }, locale);\n+\t\t\t}\n+\n+\t\t\tif (remoteProjectSettingsUpdateRequest.getForceSync()) {\n+\t\t\t\tremoteStatus.setSyncStatus(RemoteStatus.SyncStatus.MARKED);\n+\t\t\t\tupdates.put(\"remoteStatus\", remoteStatus);\n+\t\t\t\tmessage = messageSource.getMessage(\"server.ProjectRemote.marked.for.sync\", new Object[] {}, locale);\n+\t\t\t}\n+\n+\t\t\tif (remoteProjectSettingsUpdateRequest.getChangeUser()) {\n+\t\t\t\t// ensure the user can read the project\n+\t\t\t\ttry {\n+\t\t\t\t\tprojectRemoteService.read(remoteStatus.getURL());\n+\n+\t\t\t\t\tUser user = userService.getUserByUsername(principal.getName());\n+\t\t\t\t\tremoteStatus.setReadBy(user);\n+\t\t\t\t\tupdates.put(\"remoteStatus\", remoteStatus);\n+\n+\t\t\t\t\tmessage = messageSource.getMessage(\"server.ProjectRemote.userchange\", new Object[] {}, locale);\n+\t\t\t\t} catch (Exception ex) {\n+\t\t\t\t\terror = messageSource.getMessage(\"server.ProjectRemote.userchange.error\", new Object[] {}, locale);\n+\t\t\t\t}\n+\t\t\t}\n+\n+\t\t\tprojectService.updateProjectSettings(project, updates);\n+\n+\t\t\tif (error != null) {", "originalCommit": "3bd93720a5eb17ec1c86cc4c22cfa47f30d13312", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDMyOTY2OA==", "url": "https://github.com/phac-nml/irida/pull/803#discussion_r490329668", "bodyText": "Removed in dc6a734 as we are catching the exception in the controller and throws the exception and returns the message", "author": "deepsidhu85", "createdAt": "2020-09-17T15:09:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDI5MDk2Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDI5MTkxMA==", "url": "https://github.com/phac-nml/irida/pull/803#discussion_r490291910", "bodyText": "This is what you could catch on your controller and return a bad http status", "author": "joshsadam", "createdAt": "2020-09-17T14:28:14Z", "path": "src/main/java/ca/corefacility/bioinformatics/irida/ria/web/services/UIRemoteProjectService.java", "diffHunk": "@@ -0,0 +1,127 @@\n+package ca.corefacility.bioinformatics.irida.ria.web.services;\n+\n+import java.security.Principal;\n+import java.util.Date;\n+import java.util.HashMap;\n+import java.util.Locale;\n+import java.util.Map;\n+\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.context.MessageSource;\n+import org.springframework.stereotype.Component;\n+\n+import ca.corefacility.bioinformatics.irida.model.RemoteAPI;\n+import ca.corefacility.bioinformatics.irida.model.project.Project;\n+import ca.corefacility.bioinformatics.irida.model.project.ProjectSyncFrequency;\n+import ca.corefacility.bioinformatics.irida.model.remote.RemoteStatus;\n+import ca.corefacility.bioinformatics.irida.model.user.User;\n+import ca.corefacility.bioinformatics.irida.ria.web.ajax.dto.RemoteProjectSettings;\n+import ca.corefacility.bioinformatics.irida.ria.web.ajax.dto.RemoteProjectSettingsUpdateRequest;\n+import ca.corefacility.bioinformatics.irida.ria.web.ajax.dto.ajax.AjaxErrorResponse;\n+import ca.corefacility.bioinformatics.irida.ria.web.ajax.dto.ajax.AjaxResponse;\n+import ca.corefacility.bioinformatics.irida.ria.web.ajax.dto.ajax.AjaxUpdateItemSuccessResponse;\n+import ca.corefacility.bioinformatics.irida.service.ProjectService;\n+import ca.corefacility.bioinformatics.irida.service.remote.ProjectRemoteService;\n+import ca.corefacility.bioinformatics.irida.service.user.UserService;\n+\n+/**\n+ * A utility class for doing operations on remote project sync settings.\n+ */\n+\n+@Component\n+public class UIRemoteProjectService {\n+\tprivate MessageSource messageSource;\n+\tprivate ProjectService projectService;\n+\tprivate ProjectRemoteService projectRemoteService;\n+\tprivate UserService userService;\n+\n+\t@Autowired\n+\tpublic UIRemoteProjectService(MessageSource messageSource, ProjectService projectService,\n+\t\t\tProjectRemoteService projectRemoteService, UserService userService) {\n+\t\tthis.messageSource = messageSource;\n+\t\tthis.projectService = projectService;\n+\t\tthis.projectRemoteService = projectRemoteService;\n+\t\tthis.userService = userService;\n+\t}\n+\n+\t/**\n+\t * Update the project sync settings\n+\t *\n+\t * @param projectId                          the project id to update\n+\t * @param remoteProjectSettingsUpdateRequest object which\n+\t *                                           is used to update frequency, and sync user, as well as\n+\t *                                           force sync for a project\n+\t * @param principal                          The current logged in user\n+\t * @param locale                             user's locale\n+\t * @return {@link AjaxResponse}\n+\t */\n+\tpublic AjaxResponse updateProjectSyncSettings(Long projectId,\n+\t\t\tRemoteProjectSettingsUpdateRequest remoteProjectSettingsUpdateRequest, Principal principal, Locale locale) {\n+\t\tProject project = projectService.read(projectId);\n+\n+\t\tif (project != null) {\n+\t\t\tRemoteStatus remoteStatus = project.getRemoteStatus();\n+\t\t\tMap<String, Object> updates = new HashMap<>();\n+\n+\t\t\tString message = null;\n+\t\t\tString error = null;\n+\n+\t\t\tif (remoteProjectSettingsUpdateRequest.getProjectSyncFrequency() != null) {\n+\t\t\t\tupdates.put(\"syncFrequency\", remoteProjectSettingsUpdateRequest.getProjectSyncFrequency());\n+\t\t\t\tmessage = messageSource.getMessage(\"server.ProjectRemote.frequency.change\",\n+\t\t\t\t\t\tnew Object[] { remoteProjectSettingsUpdateRequest.getProjectSyncFrequency() }, locale);\n+\t\t\t}\n+\n+\t\t\tif (remoteProjectSettingsUpdateRequest.getForceSync()) {\n+\t\t\t\tremoteStatus.setSyncStatus(RemoteStatus.SyncStatus.MARKED);\n+\t\t\t\tupdates.put(\"remoteStatus\", remoteStatus);\n+\t\t\t\tmessage = messageSource.getMessage(\"server.ProjectRemote.marked.for.sync\", new Object[] {}, locale);\n+\t\t\t}\n+\n+\t\t\tif (remoteProjectSettingsUpdateRequest.getChangeUser()) {\n+\t\t\t\t// ensure the user can read the project\n+\t\t\t\ttry {\n+\t\t\t\t\tprojectRemoteService.read(remoteStatus.getURL());\n+\n+\t\t\t\t\tUser user = userService.getUserByUsername(principal.getName());\n+\t\t\t\t\tremoteStatus.setReadBy(user);\n+\t\t\t\t\tupdates.put(\"remoteStatus\", remoteStatus);\n+\n+\t\t\t\t\tmessage = messageSource.getMessage(\"server.ProjectRemote.userchange\", new Object[] {}, locale);\n+\t\t\t\t} catch (Exception ex) {\n+\t\t\t\t\terror = messageSource.getMessage(\"server.ProjectRemote.userchange.error\", new Object[] {}, locale);", "originalCommit": "3bd93720a5eb17ec1c86cc4c22cfa47f30d13312", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDMzMDA5MA==", "url": "https://github.com/phac-nml/irida/pull/803#discussion_r490330090", "bodyText": "Updated in dc6a734", "author": "deepsidhu85", "createdAt": "2020-09-17T15:10:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDI5MTkxMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDI5MzA0Ng==", "url": "https://github.com/phac-nml/irida/pull/803#discussion_r490293046", "bodyText": "Does searching for an invalid project not though an EntityNotFounException?", "author": "joshsadam", "createdAt": "2020-09-17T14:29:43Z", "path": "src/main/java/ca/corefacility/bioinformatics/irida/ria/web/services/UIRemoteProjectService.java", "diffHunk": "@@ -0,0 +1,127 @@\n+package ca.corefacility.bioinformatics.irida.ria.web.services;\n+\n+import java.security.Principal;\n+import java.util.Date;\n+import java.util.HashMap;\n+import java.util.Locale;\n+import java.util.Map;\n+\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.context.MessageSource;\n+import org.springframework.stereotype.Component;\n+\n+import ca.corefacility.bioinformatics.irida.model.RemoteAPI;\n+import ca.corefacility.bioinformatics.irida.model.project.Project;\n+import ca.corefacility.bioinformatics.irida.model.project.ProjectSyncFrequency;\n+import ca.corefacility.bioinformatics.irida.model.remote.RemoteStatus;\n+import ca.corefacility.bioinformatics.irida.model.user.User;\n+import ca.corefacility.bioinformatics.irida.ria.web.ajax.dto.RemoteProjectSettings;\n+import ca.corefacility.bioinformatics.irida.ria.web.ajax.dto.RemoteProjectSettingsUpdateRequest;\n+import ca.corefacility.bioinformatics.irida.ria.web.ajax.dto.ajax.AjaxErrorResponse;\n+import ca.corefacility.bioinformatics.irida.ria.web.ajax.dto.ajax.AjaxResponse;\n+import ca.corefacility.bioinformatics.irida.ria.web.ajax.dto.ajax.AjaxUpdateItemSuccessResponse;\n+import ca.corefacility.bioinformatics.irida.service.ProjectService;\n+import ca.corefacility.bioinformatics.irida.service.remote.ProjectRemoteService;\n+import ca.corefacility.bioinformatics.irida.service.user.UserService;\n+\n+/**\n+ * A utility class for doing operations on remote project sync settings.\n+ */\n+\n+@Component\n+public class UIRemoteProjectService {\n+\tprivate MessageSource messageSource;\n+\tprivate ProjectService projectService;\n+\tprivate ProjectRemoteService projectRemoteService;\n+\tprivate UserService userService;\n+\n+\t@Autowired\n+\tpublic UIRemoteProjectService(MessageSource messageSource, ProjectService projectService,\n+\t\t\tProjectRemoteService projectRemoteService, UserService userService) {\n+\t\tthis.messageSource = messageSource;\n+\t\tthis.projectService = projectService;\n+\t\tthis.projectRemoteService = projectRemoteService;\n+\t\tthis.userService = userService;\n+\t}\n+\n+\t/**\n+\t * Update the project sync settings\n+\t *\n+\t * @param projectId                          the project id to update\n+\t * @param remoteProjectSettingsUpdateRequest object which\n+\t *                                           is used to update frequency, and sync user, as well as\n+\t *                                           force sync for a project\n+\t * @param principal                          The current logged in user\n+\t * @param locale                             user's locale\n+\t * @return {@link AjaxResponse}\n+\t */\n+\tpublic AjaxResponse updateProjectSyncSettings(Long projectId,\n+\t\t\tRemoteProjectSettingsUpdateRequest remoteProjectSettingsUpdateRequest, Principal principal, Locale locale) {\n+\t\tProject project = projectService.read(projectId);\n+", "originalCommit": "3bd93720a5eb17ec1c86cc4c22cfa47f30d13312", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "dc6a7340bb060bcf798d856d3e29b7da3fff9389", "url": "https://github.com/phac-nml/irida/commit/dc6a7340bb060bcf798d856d3e29b7da3fff9389", "message": "Updated to catch an exception and return bad request http status", "committedDate": "2020-09-17T15:08:25Z", "type": "commit"}, {"oid": "deadda89bc903a755b112249d583af346979c0b1", "url": "https://github.com/phac-nml/irida/commit/deadda89bc903a755b112249d583af346979c0b1", "message": "Fixed @throws", "committedDate": "2020-09-17T16:19:39Z", "type": "commit"}, {"oid": "3e5bf6b70ebe214662db5bfdb373e63ef3ce09c4", "url": "https://github.com/phac-nml/irida/commit/3e5bf6b70ebe214662db5bfdb373e63ef3ce09c4", "message": "Added tests for uiremoteprojectservice. Updated getProjectRemoteSettings method to catch an error. Updated remote-projects.js api calls to catch and throw errors that the component can catch and display", "committedDate": "2020-09-17T19:35:08Z", "type": "commit"}, {"oid": "ba7a8819c99d1ca4df9d991866f82f8ec1229d79", "url": "https://github.com/phac-nml/irida/commit/ba7a8819c99d1ca4df9d991866f82f8ec1229d79", "message": "Added missing @param to javadoc", "committedDate": "2020-09-17T19:56:12Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDM0NTEwOQ==", "url": "https://github.com/phac-nml/irida/pull/803#discussion_r490345109", "bodyText": "That's a pretty generic catch, but I guess it works.", "author": "joshsadam", "createdAt": "2020-09-17T15:30:33Z", "path": "src/main/java/ca/corefacility/bioinformatics/irida/ria/web/services/UIRemoteProjectService.java", "diffHunk": "@@ -0,0 +1,121 @@\n+package ca.corefacility.bioinformatics.irida.ria.web.services;\n+\n+import java.security.Principal;\n+import java.util.Date;\n+import java.util.HashMap;\n+import java.util.Locale;\n+import java.util.Map;\n+\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.context.MessageSource;\n+import org.springframework.stereotype.Component;\n+\n+import ca.corefacility.bioinformatics.irida.model.RemoteAPI;\n+import ca.corefacility.bioinformatics.irida.model.project.Project;\n+import ca.corefacility.bioinformatics.irida.model.project.ProjectSyncFrequency;\n+import ca.corefacility.bioinformatics.irida.model.remote.RemoteStatus;\n+import ca.corefacility.bioinformatics.irida.model.user.User;\n+import ca.corefacility.bioinformatics.irida.ria.web.ajax.dto.RemoteProjectSettings;\n+import ca.corefacility.bioinformatics.irida.ria.web.ajax.dto.RemoteProjectSettingsUpdateRequest;\n+import ca.corefacility.bioinformatics.irida.service.ProjectService;\n+import ca.corefacility.bioinformatics.irida.service.remote.ProjectRemoteService;\n+import ca.corefacility.bioinformatics.irida.service.user.UserService;\n+\n+\n+/**\n+ * A utility class for doing operations on remote project sync settings.\n+ */\n+\n+@Component\n+public class UIRemoteProjectService {\n+\tprivate MessageSource messageSource;\n+\tprivate ProjectService projectService;\n+\tprivate ProjectRemoteService projectRemoteService;\n+\tprivate UserService userService;\n+\n+\t@Autowired\n+\tpublic UIRemoteProjectService(MessageSource messageSource, ProjectService projectService,\n+\t\t\tProjectRemoteService projectRemoteService, UserService userService) {\n+\t\tthis.messageSource = messageSource;\n+\t\tthis.projectService = projectService;\n+\t\tthis.projectRemoteService = projectRemoteService;\n+\t\tthis.userService = userService;\n+\t}\n+\n+\t/**\n+\t * Update the project sync settings\n+\t *\n+\t * @param projectId                          the project id to update\n+\t * @param remoteProjectSettingsUpdateRequest object which\n+\t *                                           is used to update frequency, and sync user, as well as\n+\t *                                           force sync for a project\n+\t * @param principal                          The current logged in user\n+\t * @param locale                             user's locale\n+\t * @return {@link String}\n+\t * @throws {@link Exception}\n+\t */\n+\tpublic String updateProjectSyncSettings(Long projectId,\n+\t\tRemoteProjectSettingsUpdateRequest remoteProjectSettingsUpdateRequest, Principal principal, Locale locale) throws Exception {\n+\n+\t\ttry {\n+\t\t\tProject project = projectService.read(projectId);\n+\t\t\tRemoteStatus remoteStatus = project.getRemoteStatus();\n+\t\t\tMap<String, Object> updates = new HashMap<>();\n+\t\t\tString message = null;\n+\n+\t\t\tif (remoteProjectSettingsUpdateRequest.getProjectSyncFrequency() != null) {\n+\t\t\t\tupdates.put(\"syncFrequency\", remoteProjectSettingsUpdateRequest.getProjectSyncFrequency());\n+\t\t\t\tmessage = messageSource.getMessage(\"server.ProjectRemote.frequency.change\",\n+\t\t\t\t\t\tnew Object[] { remoteProjectSettingsUpdateRequest.getProjectSyncFrequency() }, locale);\n+\t\t\t}\n+\n+\t\t\tif (remoteProjectSettingsUpdateRequest.getForceSync()) {\n+\t\t\t\tremoteStatus.setSyncStatus(RemoteStatus.SyncStatus.MARKED);\n+\t\t\t\tupdates.put(\"remoteStatus\", remoteStatus);\n+\t\t\t\tmessage = messageSource.getMessage(\"server.ProjectRemote.marked.for.sync\", new Object[] {}, locale);\n+\t\t\t}\n+\n+\t\t\tif (remoteProjectSettingsUpdateRequest.getChangeUser()) {\n+\t\t\t\t// ensure the user can read the project\n+\t\t\t\ttry {\n+\t\t\t\t\tprojectRemoteService.read(remoteStatus.getURL());\n+\n+\t\t\t\t\tUser user = userService.getUserByUsername(principal.getName());\n+\t\t\t\t\tremoteStatus.setReadBy(user);\n+\t\t\t\t\tupdates.put(\"remoteStatus\", remoteStatus);\n+\n+\t\t\t\t\tmessage = messageSource.getMessage(\"server.ProjectRemote.userchange\", new Object[] {}, locale);\n+\t\t\t\t} catch (Exception ex) {\n+\t\t\t\t\tthrow new Exception(messageSource.getMessage(\"server.ProjectRemote.userchange.error\", new Object[] {}, locale));\n+\t\t\t\t}\n+\t\t\t}\n+\n+\t\t\tprojectService.updateProjectSettings(project, updates);\n+\n+\t\t\treturn message;\n+\n+\t\t} catch(Exception ex) {", "originalCommit": "dc6a7340bb060bcf798d856d3e29b7da3fff9389", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}