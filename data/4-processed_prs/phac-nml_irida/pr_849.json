{"pr_number": 849, "pr_title": "Add html result viewer", "pr_createdAt": "2020-11-03T17:22:41Z", "pr_url": "https://github.com/phac-nml/irida/pull/849", "timeline": [{"oid": "f05212811dbefa810913d59c9387fa0a7aae6bf7", "url": "https://github.com/phac-nml/irida/commit/f05212811dbefa810913d59c9387fa0a7aae6bf7", "message": "Added html viewer for analyses that output html files", "committedDate": "2020-11-03T17:21:30Z", "type": "commit"}, {"oid": "4b716ba4ef20348a402671ca75b7609aea6694c4", "url": "https://github.com/phac-nml/irida/commit/4b716ba4ef20348a402671ca75b7609aea6694c4", "message": "Merge branch 'development' into add-html-result-viewer", "committedDate": "2020-11-03T17:22:07Z", "type": "commit"}, {"oid": "81a7f0f4fba17564d339087790637315eb503520", "url": "https://github.com/phac-nml/irida/commit/81a7f0f4fba17564d339087790637315eb503520", "message": "Updated api call to throw an error if one is returned. Fixed formatting", "committedDate": "2020-11-03T18:56:07Z", "type": "commit"}, {"oid": "800391c3427e2c9f16a05b727cb23c20265e08de", "url": "https://github.com/phac-nml/irida/commit/800391c3427e2c9f16a05b727cb23c20265e08de", "message": "Updated CHANGELOG", "committedDate": "2020-11-03T18:57:08Z", "type": "commit"}, {"oid": "0d04040ae0f2e72cf9742b040a5f767e6b4b917e", "url": "https://github.com/phac-nml/irida/commit/0d04040ae0f2e72cf9742b040a5f767e6b4b917e", "message": "Updated api url", "committedDate": "2020-11-04T15:15:21Z", "type": "commit"}, {"oid": "c797de7d0d890c99dc7fb92d23d6d9b4763f7f89", "url": "https://github.com/phac-nml/irida/commit/c797de7d0d890c99dc7fb92d23d6d9b4763f7f89", "message": "Fixed issue with html data being undefined", "committedDate": "2020-11-04T15:36:46Z", "type": "commit"}, {"oid": "b8663e42a304c0afa42ac276fa812d231994d25c", "url": "https://github.com/phac-nml/irida/commit/b8663e42a304c0afa42ac276fa812d231994d25c", "message": "Changed to using an iframe.", "committedDate": "2020-11-04T17:19:55Z", "type": "commit"}, {"oid": "68daf3b89cfb568f4f1aedf9d4817134b02c733e", "url": "https://github.com/phac-nml/irida/commit/68daf3b89cfb568f4f1aedf9d4817134b02c733e", "message": "Removed file not required. Updated html output iframe to use border. Removed code not required in analysisajaxcontroller.", "committedDate": "2020-11-04T19:59:48Z", "type": "commit"}, {"oid": "725d7fe8edf2684a257bbdb84d8f9b6a44858458", "url": "https://github.com/phac-nml/irida/commit/725d7fe8edf2684a257bbdb84d8f9b6a44858458", "message": "Changed frameBorder to 0 for iframe", "committedDate": "2020-11-04T20:00:26Z", "type": "commit"}, {"oid": "8ebd843cfcae68d728042fae36db8c5b74284991", "url": "https://github.com/phac-nml/irida/commit/8ebd843cfcae68d728042fae36db8c5b74284991", "message": "Added link icon to the open button", "committedDate": "2020-11-05T11:25:59Z", "type": "commit"}, {"oid": "88cc7a3dba682122386c6118ca24ea7786d5b689", "url": "https://github.com/phac-nml/irida/commit/88cc7a3dba682122386c6118ca24ea7786d5b689", "message": "Removed api call not required", "committedDate": "2020-11-05T14:51:30Z", "type": "commit"}, {"oid": "d28bc684f81e7e6d7a5b28b15005830a86d49f4d", "url": "https://github.com/phac-nml/irida/commit/d28bc684f81e7e6d7a5b28b15005830a86d49f4d", "message": "Added missing javadoc", "committedDate": "2020-11-05T14:55:09Z", "type": "commit"}, {"oid": "e679bcc7ed83ae50123fac1dd468effd5359085e", "url": "https://github.com/phac-nml/irida/commit/e679bcc7ed83ae50123fac1dd468effd5359085e", "message": "Merge pull request #851 from phac-nml/add-html-result-viewer-iframe\n\nChanged to using an iframe.", "committedDate": "2020-11-05T14:59:54Z", "type": "commit"}, {"oid": "4460c5faf3abadfbe36e5e5b8d758c5d50f69107", "url": "https://github.com/phac-nml/irida/commit/4460c5faf3abadfbe36e5e5b8d758c5d50f69107", "message": "Added documentation on adding css/js to html output for it to work in viewer", "committedDate": "2020-11-05T15:20:51Z", "type": "commit"}, {"oid": "cefe4e3f1dcfb022c3195128a5e60257b03d84a4", "url": "https://github.com/phac-nml/irida/commit/cefe4e3f1dcfb022c3195128a5e60257b03d84a4", "message": "Removed finally block", "committedDate": "2020-11-05T15:21:51Z", "type": "commit"}, {"oid": "1df94bb4c184736cae511e9c9e6cbda54815147d", "url": "https://github.com/phac-nml/irida/commit/1df94bb4c184736cae511e9c9e6cbda54815147d", "message": "Merged dev and fixed merge conflicts", "committedDate": "2020-11-17T16:53:08Z", "type": "commit"}, {"oid": "9bd4187c2661666a078d4546a36965f4e93c3d70", "url": "https://github.com/phac-nml/irida/commit/9bd4187c2661666a078d4546a36965f4e93c3d70", "message": "Merged update to chromedriver 87 and fixed merge conflicts", "committedDate": "2020-11-18T21:22:17Z", "type": "commit"}, {"oid": "e44c473e943c064b2d7a2540199b7f546abfcb69", "url": "https://github.com/phac-nml/irida/commit/e44c473e943c064b2d7a2540199b7f546abfcb69", "message": "Merge branch 'development' into add-html-result-viewer", "committedDate": "2020-11-23T16:33:01Z", "type": "commit"}, {"oid": "7190a79bca71a2ac4df951f9694c188bce593e83", "url": "https://github.com/phac-nml/irida/commit/7190a79bca71a2ac4df951f9694c188bce593e83", "message": "Merged dev and fixed merge conflicts", "committedDate": "2020-11-30T20:50:28Z", "type": "commit"}, {"oid": "542a7e9675be7467bd23f922ecfda2b0395442a4", "url": "https://github.com/phac-nml/irida/commit/542a7e9675be7467bd23f922ecfda2b0395442a4", "message": "Merged dev and fixed merge conflicts", "committedDate": "2020-12-02T17:09:54Z", "type": "commit"}, {"oid": "850e2844ea5e61e32eed37c88bea37733a784ece", "url": "https://github.com/phac-nml/irida/commit/850e2844ea5e61e32eed37c88bea37733a784ece", "message": "Merge branch 'development' into add-html-result-viewer", "committedDate": "2020-12-02T19:08:55Z", "type": "commit"}, {"oid": "22bd83cb062ed613bb137bcd34f6ebd413cdee30", "url": "https://github.com/phac-nml/irida/commit/22bd83cb062ed613bb137bcd34f6ebd413cdee30", "message": "Merged dev and fixed merge conflicts", "committedDate": "2020-12-08T22:15:58Z", "type": "commit"}, {"oid": "c69fc2f495238f2cbd5943c49b6c3d0ec24bfa80", "url": "https://github.com/phac-nml/irida/commit/c69fc2f495238f2cbd5943c49b6c3d0ec24bfa80", "message": "Merged dev and fixed merge conflicts:", "committedDate": "2020-12-21T02:50:52Z", "type": "commit"}, {"oid": "b33f973411760eb43ead9ad69b6fe10e0eb6a6bf", "url": "https://github.com/phac-nml/irida/commit/b33f973411760eb43ead9ad69b6fe10e0eb6a6bf", "message": "Merged dev and fixed merge conflict", "committedDate": "2020-12-24T20:33:34Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTU1NjI5Mg==", "url": "https://github.com/phac-nml/irida/pull/849#discussion_r551556292", "bodyText": "An issue I can see with this is if the HTML file is really big.  I've seen some tools which may (for example) dump a pile of data in a javascript object for displaying a result on a page.  In a case like this loading everything into a string in memory could cause a problem.\nAlternative: can we stream this output directly as a response?  I think you can do something like that but I can't find an example in our existing codebase.  I know you can get a handle on the request & response objects in the controllers and write to them similar to what we do in FastqView.  Can you check if that's possible for these purposes as well?", "author": "tom114", "createdAt": "2021-01-04T20:39:54Z", "path": "src/main/java/ca/corefacility/bioinformatics/irida/ria/web/analysis/AnalysisController.java", "diffHunk": "@@ -151,4 +162,47 @@ public String getAdvancedPhylogeneticVisualizationPage(@PathVariable Long submis\n \t\tmodel.addAttribute(\"submission\", submission);\n \t\treturn BASE + \"visualizations/phylocanvas-metadata\";\n \t}\n+\n+\t/**\n+\t * Get the html page from the file name provided.\n+\t *\n+\t * @param submissionId {@link Long} identifier for an {@link AnalysisSubmission}\n+\t * @param filename     The html file name\n+\t * @param model        {@link Model}\n+\t * @param locale       User's locale\n+\t * @return {@link String} path to the page template.\n+\t */\n+\t@RequestMapping(\"/{submissionId}/html-output\")\n+\tpublic String getHtmlOutputForSubmission(@PathVariable Long submissionId, @RequestParam String filename,\n+\t\t\tModel model, Locale locale) {\n+\t\tAnalysisSubmission submission = analysisSubmissionService.read(submissionId);\n+\t\tSet<AnalysisOutputFile> files = submission.getAnalysis()\n+\t\t\t\t.getAnalysisOutputFiles();\n+\t\tAnalysisOutputFile outputFile = null;\n+\t\tString htmlExt = \"html\";\n+\t\tString htmlOutput = \"\";\n+\n+\t\tfor (AnalysisOutputFile file : files) {\n+\t\t\tif (file.getFile()\n+\t\t\t\t\t.toFile()\n+\t\t\t\t\t.getName()\n+\t\t\t\t\t.contains(filename) && FilenameUtils.getExtension(filename)\n+\t\t\t\t\t.equals(htmlExt)) {\n+\t\t\t\toutputFile = file;\n+\t\t\t\tbreak;\n+\t\t\t}\n+\t\t}\n+\n+\t\ttry {\n+\t\t\thtmlOutput = FileUtils.readFileToString(outputFile.getFile()", "originalCommit": "b33f973411760eb43ead9ad69b6fe10e0eb6a6bf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTU2NDY3NQ==", "url": "https://github.com/phac-nml/irida/pull/849#discussion_r551564675", "bodyText": "I can for sure take a look into if we can do that! Thanks :)", "author": "deepsidhu85", "createdAt": "2021-01-04T20:57:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTU1NjI5Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjkxMDY2Mw==", "url": "https://github.com/phac-nml/irida/pull/849#discussion_r552910663", "bodyText": "Updated in f9123a1", "author": "deepsidhu85", "createdAt": "2021-01-06T19:11:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTU1NjI5Mg=="}], "type": "inlineReview"}, {"oid": "f9123a19284ed01987451861e3da27613ae05b86", "url": "https://github.com/phac-nml/irida/commit/f9123a19284ed01987451861e3da27613ae05b86", "message": "Updated retrieval of html from file to stream input into the response outputstream rather than reading it into memory. Added translation", "committedDate": "2021-01-06T19:10:53Z", "type": "commit"}, {"oid": "694675faff1c81b67d390e1833219a4622e7275c", "url": "https://github.com/phac-nml/irida/commit/694675faff1c81b67d390e1833219a4622e7275c", "message": "Merged dev and fixed merge conflicts", "committedDate": "2021-01-06T19:25:21Z", "type": "commit"}, {"oid": "7f2c5a55bec80b281d95705dae38916805d18f4c", "url": "https://github.com/phac-nml/irida/commit/7f2c5a55bec80b281d95705dae38916805d18f4c", "message": "Added param and throws tags to javadoc", "committedDate": "2021-01-06T20:06:43Z", "type": "commit"}, {"oid": "7da7cf08c865e829a8358783db91f52628c4caed", "url": "https://github.com/phac-nml/irida/commit/7da7cf08c865e829a8358783db91f52628c4caed", "message": "Merged dev and fixed merge conflict", "committedDate": "2021-01-07T16:07:42Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDA4MjQyNQ==", "url": "https://github.com/phac-nml/irida/pull/849#discussion_r554082425", "bodyText": "I think the browser will handle things without this response header.  It looks like it should just stream the response.  That way if there's some filesystem size hiccup here it won't make the browser freak out that the content is different than the size it recieved.", "author": "tom114", "createdAt": "2021-01-08T17:19:28Z", "path": "src/main/java/ca/corefacility/bioinformatics/irida/ria/web/analysis/AnalysisController.java", "diffHunk": "@@ -151,4 +167,59 @@ public String getAdvancedPhylogeneticVisualizationPage(@PathVariable Long submis\n \t\tmodel.addAttribute(\"submission\", submission);\n \t\treturn BASE + \"visualizations/phylocanvas-metadata\";\n \t}\n+\n+\t/**\n+\t * Get the html page from the file name provided.\n+\t *\n+\t * @param submissionId {@link Long} identifier for an {@link AnalysisSubmission}\n+\t * @param filename     The html file name\n+\t * @param locale       User's locale\n+\t * @param response     {@link HttpServletResponse}\n+\t * @throws IOException if we can't write the file to the response\n+\t */\n+\t@RequestMapping(\"/{submissionId}/html-output\")\n+\tpublic void getHtmlOutputForSubmission(@PathVariable Long submissionId, @RequestParam String filename,\n+\t\t\tLocale locale, HttpServletResponse response) throws IOException {\n+\t\tAnalysisSubmission submission = analysisSubmissionService.read(submissionId);\n+\t\tSet<AnalysisOutputFile> files = submission.getAnalysis()\n+\t\t\t\t.getAnalysisOutputFiles();\n+\t\tAnalysisOutputFile outputFile = null;\n+\t\tString htmlExt = \"html\";\n+\n+\t\tfor (AnalysisOutputFile file : files) {\n+\t\t\tif (file.getFile()\n+\t\t\t\t\t.toFile()\n+\t\t\t\t\t.getName()\n+\t\t\t\t\t.contains(filename) && FilenameUtils.getExtension(filename)\n+\t\t\t\t\t.equals(htmlExt)) {\n+\t\t\t\toutputFile = file;\n+\t\t\t\tbreak;\n+\t\t\t}\n+\t\t}\n+\n+\t\t// Set the common Http headers\n+\t\tresponse.setHeader(HttpHeaders.CONTENT_DISPOSITION, \"inline\");\n+\t\tresponse.setHeader(HttpHeaders.CONTENT_TYPE, \"text/html\");\n+\n+\t\ttry (InputStream inputStream = new FileInputStream(outputFile.getFile()\n+\t\t\t\t.toString()); OutputStream outputStream = response.getOutputStream()) {\n+\t\t\tresponse.setHeader(HttpHeaders.CONTENT_LENGTH, String.valueOf(Files.size(outputFile.getFile())));", "originalCommit": "7da7cf08c865e829a8358783db91f52628c4caed", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDEyNDE1NQ==", "url": "https://github.com/phac-nml/irida/pull/849#discussion_r554124155", "bodyText": "Sounds good I will remove that response header", "author": "deepsidhu85", "createdAt": "2021-01-08T18:41:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDA4MjQyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDIxOTc4OQ==", "url": "https://github.com/phac-nml/irida/pull/849#discussion_r554219789", "bodyText": "Updated in 1c116df", "author": "deepsidhu85", "createdAt": "2021-01-08T22:05:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDA4MjQyNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDA4MzU2MA==", "url": "https://github.com/phac-nml/irida/pull/849#discussion_r554083560", "bodyText": "The output stream will get closed anyway with the try-with-resources block right?  Is this needed?", "author": "tom114", "createdAt": "2021-01-08T17:21:20Z", "path": "src/main/java/ca/corefacility/bioinformatics/irida/ria/web/analysis/AnalysisController.java", "diffHunk": "@@ -151,4 +167,59 @@ public String getAdvancedPhylogeneticVisualizationPage(@PathVariable Long submis\n \t\tmodel.addAttribute(\"submission\", submission);\n \t\treturn BASE + \"visualizations/phylocanvas-metadata\";\n \t}\n+\n+\t/**\n+\t * Get the html page from the file name provided.\n+\t *\n+\t * @param submissionId {@link Long} identifier for an {@link AnalysisSubmission}\n+\t * @param filename     The html file name\n+\t * @param locale       User's locale\n+\t * @param response     {@link HttpServletResponse}\n+\t * @throws IOException if we can't write the file to the response\n+\t */\n+\t@RequestMapping(\"/{submissionId}/html-output\")\n+\tpublic void getHtmlOutputForSubmission(@PathVariable Long submissionId, @RequestParam String filename,\n+\t\t\tLocale locale, HttpServletResponse response) throws IOException {\n+\t\tAnalysisSubmission submission = analysisSubmissionService.read(submissionId);\n+\t\tSet<AnalysisOutputFile> files = submission.getAnalysis()\n+\t\t\t\t.getAnalysisOutputFiles();\n+\t\tAnalysisOutputFile outputFile = null;\n+\t\tString htmlExt = \"html\";\n+\n+\t\tfor (AnalysisOutputFile file : files) {\n+\t\t\tif (file.getFile()\n+\t\t\t\t\t.toFile()\n+\t\t\t\t\t.getName()\n+\t\t\t\t\t.contains(filename) && FilenameUtils.getExtension(filename)\n+\t\t\t\t\t.equals(htmlExt)) {\n+\t\t\t\toutputFile = file;\n+\t\t\t\tbreak;\n+\t\t\t}\n+\t\t}\n+\n+\t\t// Set the common Http headers\n+\t\tresponse.setHeader(HttpHeaders.CONTENT_DISPOSITION, \"inline\");\n+\t\tresponse.setHeader(HttpHeaders.CONTENT_TYPE, \"text/html\");\n+\n+\t\ttry (InputStream inputStream = new FileInputStream(outputFile.getFile()\n+\t\t\t\t.toString()); OutputStream outputStream = response.getOutputStream()) {\n+\t\t\tresponse.setHeader(HttpHeaders.CONTENT_LENGTH, String.valueOf(Files.size(outputFile.getFile())));\n+\t\t\t// Copy the file contents to the response outputstream\n+\t\t\tIOUtils.copy(inputStream, outputStream);\n+\t\t} catch (IOException e) {\n+\t\t\tlogger.debug(\"Html output not found.\");\n+\t\t\tresponse.setHeader(HttpHeaders.CONTENT_LENGTH, \"0\");\n+\t\t\tString htmlOutputNotFound = messageSource.getMessage(\"analysis.html.file.not.found\",\n+\t\t\t\t\tnew Object[] { filename }, locale);\n+\t\t\tOutputStream outputStream = response.getOutputStream();\n+\t\t\t/*\n+\t\t\tWrite the htmlNotFound message to the outputstream. We do this\n+\t\t\tso that the page doesn't error and will instead display the\n+\t\t\tmessage.\n+\t\t\t */\n+\t\t\toutputStream.write(htmlOutputNotFound.getBytes(StandardCharsets.UTF_8));\n+\t\t\toutputStream.flush();\n+\t\t\toutputStream.close();", "originalCommit": "7da7cf08c865e829a8358783db91f52628c4caed", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDEyNDU3OQ==", "url": "https://github.com/phac-nml/irida/pull/849#discussion_r554124579", "bodyText": "Since we reaccess it in the catch block would it still close? Or will it just close the original access stream?", "author": "deepsidhu85", "createdAt": "2021-01-08T18:41:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDA4MzU2MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDIxNDcwOA==", "url": "https://github.com/phac-nml/irida/pull/849#discussion_r554214708", "bodyText": "Ah I'm sorry, I misread the code.  I think you have it correct.  Since you got a handle on a new stream a couple lines up you'll have to close it.  I thought for some reason that this was the same stream you opened in the try-resources block.  This is good and can stay as-is.", "author": "tom114", "createdAt": "2021-01-08T21:55:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDA4MzU2MA=="}], "type": "inlineReview"}, {"oid": "1c116df5695ce8f3b89c8013f76a705e6dd3482f", "url": "https://github.com/phac-nml/irida/commit/1c116df5695ce8f3b89c8013f76a705e6dd3482f", "message": "Removed content lengh from response header", "committedDate": "2021-01-08T22:03:44Z", "type": "commit"}, {"oid": "35a62ae804ec11f074327353a7bb4742c74ab816", "url": "https://github.com/phac-nml/irida/commit/35a62ae804ec11f074327353a7bb4742c74ab816", "message": "Removed unused import", "committedDate": "2021-01-08T22:06:44Z", "type": "commit"}]}