{"pr_number": 1894, "pr_title": "limit log size of logDispatcher", "pr_createdAt": "2020-10-29T02:05:24Z", "pr_url": "https://github.com/apache/iotdb/pull/1894", "timeline": [{"oid": "35fa0608d4f909a47f4f5dca455d89669e890d50", "url": "https://github.com/apache/iotdb/commit/35fa0608d4f909a47f4f5dca455d89669e890d50", "message": "limit log size of logDispatcher", "committedDate": "2020-10-29T02:52:13Z", "type": "commit"}, {"oid": "70550c129a07da292230643e43324b765a3760c3", "url": "https://github.com/apache/iotdb/commit/70550c129a07da292230643e43324b765a3760c3", "message": "fix log level", "committedDate": "2020-10-29T02:52:13Z", "type": "commit"}, {"oid": "70550c129a07da292230643e43324b765a3760c3", "url": "https://github.com/apache/iotdb/commit/70550c129a07da292230643e43324b765a3760c3", "message": "fix log level", "committedDate": "2020-10-29T02:52:13Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDEzNDE5NA==", "url": "https://github.com/apache/iotdb/pull/1894#discussion_r514134194", "bodyText": "maybe we can move the line outside of the while loop", "author": "neuyilan", "createdAt": "2020-10-29T09:55:21Z", "path": "cluster/src/main/java/org/apache/iotdb/cluster/log/LogDispatcher.java", "diffHunk": "@@ -289,32 +294,44 @@ private AppendEntriesRequest prepareRequest(List<ByteBuffer> logList,\n \n       request.setEntries(logList);\n       // set index for raft\n-      request.setPrevLogIndex(currBatch.get(0).getLog().getCurrLogIndex() - 1);\n+      request.setPrevLogIndex(currBatch.get(firstIndex).getLog().getCurrLogIndex() - 1);\n       try {\n-        request.setPrevLogTerm(currBatch.get(0).getAppendEntryRequest().prevLogTerm);\n+        request.setPrevLogTerm(currBatch.get(firstIndex).getAppendEntryRequest().prevLogTerm);\n       } catch (Exception e) {\n         logger.error(\"getTerm failed for newly append entries\", e);\n       }\n       return request;\n     }\n \n     private void sendLogs(List<SendLogRequest> currBatch) throws TException {\n-      List<ByteBuffer> logList = new ArrayList<>();\n-      for (SendLogRequest request : currBatch) {\n-        Timer.Statistic.LOG_DISPATCHER_LOG_IN_QUEUE\n-            .calOperationCostTimeFromStart(request.getLog().getCreateTime());\n-        logList.add(request.getAppendEntryRequest().entry);\n-      }\n+      int logIndex = 0;\n+      logger.info(\"send logs from index {} to {}\", currBatch.get(0).getLog().getCurrLogIndex(),\n+        currBatch.get(currBatch.size() - 1).getLog().getCurrLogIndex());\n+      while (logIndex < currBatch.size()) {\n+        long logSize = IoTDBDescriptor.getInstance().getConfig().getThriftMaxFrameSize();", "originalCommit": "70550c129a07da292230643e43324b765a3760c3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDk0NDc5OQ==", "url": "https://github.com/apache/iotdb/pull/1894#discussion_r514944799", "bodyText": "be blocked", "author": "jt2594838", "createdAt": "2020-10-30T08:43:02Z", "path": "cluster/src/main/java/org/apache/iotdb/cluster/server/member/RaftMember.java", "diffHunk": "@@ -1524,7 +1529,7 @@ private AppendLogResult sendLogToFollowers(Log log, AtomicInteger voteCounter) {\n     try {\n       if (allNodes.size() > 2) {\n         // if there are more than one followers, send the requests in parallel so that one slow\n-        // follower will not\n+        // follower will not blocked", "originalCommit": "70550c129a07da292230643e43324b765a3760c3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "773e9f8264df138aec4574fc2d62e5b53abff6f0", "url": "https://github.com/apache/iotdb/commit/773e9f8264df138aec4574fc2d62e5b53abff6f0", "message": "fix grammer", "committedDate": "2020-10-30T08:56:18Z", "type": "commit"}, {"oid": "badc6f5e3fb9cc1fe0cb40b88099c5c2a92f0b1a", "url": "https://github.com/apache/iotdb/commit/badc6f5e3fb9cc1fe0cb40b88099c5c2a92f0b1a", "message": "add ut", "committedDate": "2020-11-01T07:22:19Z", "type": "commit"}, {"oid": "36ccfc3287910aab32e9654a90df1de330a72861", "url": "https://github.com/apache/iotdb/commit/36ccfc3287910aab32e9654a90df1de330a72861", "message": "add some log", "committedDate": "2020-11-01T07:37:50Z", "type": "commit"}]}