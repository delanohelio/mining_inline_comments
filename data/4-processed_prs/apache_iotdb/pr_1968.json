{"pr_number": 1968, "pr_title": "Fix the risk of deadlock by WeakReference", "pr_createdAt": "2020-11-06T08:55:27Z", "pr_url": "https://github.com/apache/iotdb/pull/1968", "timeline": [{"oid": "376426de99cb6f0282f7307cc590d3e2704ada7e", "url": "https://github.com/apache/iotdb/commit/376426de99cb6f0282f7307cc590d3e2704ada7e", "message": "Fix the risk of deadlock by WeakReference", "committedDate": "2020-11-06T07:41:54Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTA4NTg3Nw==", "url": "https://github.com/apache/iotdb/pull/1968#discussion_r519085877", "bodyText": "this should be discussed.\nWe may have too many devices and the memory is limited..", "author": "jixuan1989", "createdAt": "2020-11-07T02:50:33Z", "path": "server/src/main/java/org/apache/iotdb/db/engine/cache/TimeSeriesMetadataCache.java", "diffHunk": "@@ -60,6 +64,7 @@\n \n   private final ReadWriteLock lock = new ReentrantReadWriteLock();\n \n+  private final Map<String, WeakReference<String>> devices = Collections.synchronizedMap(new WeakHashMap<>());", "originalCommit": "376426de99cb6f0282f7307cc590d3e2704ada7e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTE1NjEzNg==", "url": "https://github.com/apache/iotdb/pull/1968#discussion_r519156136", "bodyText": "Hi, @jixuan1989 . Thanks for your reply. Indeed, taking this into consideration, so WeakReference is used here, which is more GC friendly. Moreover, I think the previous method has the risk of deadlock and the memory usage is not small.", "author": "asdf2014", "createdAt": "2020-11-07T09:11:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTA4NTg3Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTMwMTc4MA==", "url": "https://github.com/apache/iotdb/pull/1968#discussion_r521301780", "bodyText": "Hi, can you give more details about the mentioned deadlock thing?", "author": "JackieTien97", "createdAt": "2020-11-11T11:45:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTA4NTg3Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDkwNjgzMQ==", "url": "https://github.com/apache/iotdb/pull/1968#discussion_r544906831", "bodyText": "Hi, @JackieTien97 . FYI, https://stackoverflow.com/a/134154/4719867", "author": "asdf2014", "createdAt": "2020-12-17T08:41:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTA4NTg3Nw=="}], "type": "inlineReview"}, {"oid": "8161dbb54f76fc86a07eeef505a4af74e2ae9516", "url": "https://github.com/apache/iotdb/commit/8161dbb54f76fc86a07eeef505a4af74e2ae9516", "message": "Merge branch 'master' into fix_dead_lock_risk", "committedDate": "2020-11-18T06:25:46Z", "type": "commit"}]}