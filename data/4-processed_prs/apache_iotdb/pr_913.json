{"pr_number": 913, "pr_title": "[IOTDB-500] Let timeColumn and batchData store time in the same struct", "pr_createdAt": "2020-03-15T03:47:00Z", "pr_url": "https://github.com/apache/iotdb/pull/913", "timeline": [{"oid": "ffa4e57243f8e641e67a5ec719e0a76bd298b290", "url": "https://github.com/apache/iotdb/commit/ffa4e57243f8e641e67a5ec719e0a76bd298b290", "message": "[IOTDB-500] Let timeColumn and batchData store time in the same struct\n\nsimple clone timeRet\n\nfix bug", "committedDate": "2020-03-15T14:03:21Z", "type": "commit"}, {"oid": "de98ed7384f6bd5072e221526783c40c4ab21aea", "url": "https://github.com/apache/iotdb/commit/de98ed7384f6bd5072e221526783c40c4ab21aea", "message": "make code clean", "committedDate": "2020-03-15T14:35:28Z", "type": "commit"}, {"oid": "255a78d664a7f526681c701f578185c3f1b2698e", "url": "https://github.com/apache/iotdb/commit/255a78d664a7f526681c701f578185c3f1b2698e", "message": "make code clean", "committedDate": "2020-03-15T14:46:06Z", "type": "commit"}, {"oid": "10461382d788a7ce187fba4d76c375818dbd5f17", "url": "https://github.com/apache/iotdb/commit/10461382d788a7ce187fba4d76c375818dbd5f17", "message": "del DYNAMIC_DATA_SIZE", "committedDate": "2020-03-15T14:59:54Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mjc2MDA2Nw==", "url": "https://github.com/apache/iotdb/pull/913#discussion_r392760067", "bodyText": "Remove this useless import", "author": "samperson1997", "createdAt": "2020-03-16T02:48:05Z", "path": "tsfile/src/main/java/org/apache/iotdb/tsfile/read/common/BatchData.java", "diffHunk": "@@ -21,6 +21,7 @@\n import java.io.Serializable;\n import java.util.ArrayList;\n import org.apache.iotdb.tsfile.common.conf.TSFileConfig;", "originalCommit": "10461382d788a7ce187fba4d76c375818dbd5f17", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mjc2NzgzNQ==", "url": "https://github.com/apache/iotdb/pull/913#discussion_r392767835", "bodyText": "done", "author": "liutaohua", "createdAt": "2020-03-16T03:32:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mjc2MDA2Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mjc2MDU4OQ==", "url": "https://github.com/apache/iotdb/pull/913#discussion_r392760589", "bodyText": "How about using List here", "author": "samperson1997", "createdAt": "2020-03-16T02:50:55Z", "path": "tsfile/src/main/java/org/apache/iotdb/tsfile/read/common/TimeColumn.java", "diffHunk": "@@ -19,60 +19,115 @@\n package org.apache.iotdb.tsfile.read.common;\n \n \n+import java.nio.ReadOnlyBufferException;\n+import java.util.ArrayList;\n+import org.apache.iotdb.tsfile.common.conf.TSFileDescriptor;\n+\n public class TimeColumn {\n \n-  private static final int DEFAULT_INIT_SIZE = 1000;\n+  private static final int capacityThreshold = TSFileDescriptor.getInstance().getConfig()\n+      .getBatchSize();\n+  private int capacity = 16;\n \n+  // outer list index for read\n+  private int readCurListIndex;\n+  // inner array index for read\n+  private int readCurArrayIndex;\n \n-  private long[] times;\n+  // outer list index for write\n+  private int writeCurListIndex;\n+  // inner array index for write\n+  private int writeCurArrayIndex;\n \n-  private int size;\n+  // the insert timestamp number of timeRet\n+  private int count;\n \n-  private int cur;\n+  private ArrayList<long[]> timeRet;", "originalCommit": "10461382d788a7ce187fba4d76c375818dbd5f17", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mjc2Nzg3MQ==", "url": "https://github.com/apache/iotdb/pull/913#discussion_r392767871", "bodyText": "done", "author": "liutaohua", "createdAt": "2020-03-16T03:32:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mjc2MDU4OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mjc2MDYzMw==", "url": "https://github.com/apache/iotdb/pull/913#discussion_r392760633", "bodyText": "Also use List", "author": "samperson1997", "createdAt": "2020-03-16T02:51:12Z", "path": "tsfile/src/main/java/org/apache/iotdb/tsfile/read/common/TimeColumn.java", "diffHunk": "@@ -19,60 +19,115 @@\n package org.apache.iotdb.tsfile.read.common;\n \n \n+import java.nio.ReadOnlyBufferException;\n+import java.util.ArrayList;\n+import org.apache.iotdb.tsfile.common.conf.TSFileDescriptor;\n+\n public class TimeColumn {\n \n-  private static final int DEFAULT_INIT_SIZE = 1000;\n+  private static final int capacityThreshold = TSFileDescriptor.getInstance().getConfig()\n+      .getBatchSize();\n+  private int capacity = 16;\n \n+  // outer list index for read\n+  private int readCurListIndex;\n+  // inner array index for read\n+  private int readCurArrayIndex;\n \n-  private long[] times;\n+  // outer list index for write\n+  private int writeCurListIndex;\n+  // inner array index for write\n+  private int writeCurArrayIndex;\n \n-  private int size;\n+  // the insert timestamp number of timeRet\n+  private int count;\n \n-  private int cur;\n+  private ArrayList<long[]> timeRet;\n \n   public TimeColumn() {\n-    this(DEFAULT_INIT_SIZE);\n+    this.readCurListIndex = 0;\n+    this.readCurArrayIndex = 0;\n+    this.writeCurListIndex = 0;\n+    this.writeCurArrayIndex = 0;\n+    timeRet = new ArrayList<>();\n+    timeRet.add(new long[capacity]);\n+    count = 0;\n   }\n \n-  public TimeColumn(int initSize) {\n-    times = new long[initSize];\n-  }\n+  public TimeColumn(ArrayList<long[]> timeRet, int count) {", "originalCommit": "10461382d788a7ce187fba4d76c375818dbd5f17", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mjc2Nzg4OQ==", "url": "https://github.com/apache/iotdb/pull/913#discussion_r392767889", "bodyText": "done", "author": "liutaohua", "createdAt": "2020-03-16T03:32:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mjc2MDYzMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mjc2MDkyMg==", "url": "https://github.com/apache/iotdb/pull/913#discussion_r392760922", "bodyText": "could be simpliy:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                } else if (readCurListIndex == writeCurListIndex) {\n          \n          \n            \n                  return readCurArrayIndex < writeCurArrayIndex;\n          \n          \n            \n                } else {\n          \n          \n            \n                  return false;\n          \n          \n            \n                }\n          \n          \n            \n                } else {\n          \n          \n            \n                  return readCurListIndex == writeCurListIndex && readCurArrayIndex < writeCurArrayIndex;\n          \n          \n            \n                }", "author": "samperson1997", "createdAt": "2020-03-16T02:52:45Z", "path": "tsfile/src/main/java/org/apache/iotdb/tsfile/read/common/TimeColumn.java", "diffHunk": "@@ -19,60 +19,115 @@\n package org.apache.iotdb.tsfile.read.common;\n \n \n+import java.nio.ReadOnlyBufferException;\n+import java.util.ArrayList;\n+import org.apache.iotdb.tsfile.common.conf.TSFileDescriptor;\n+\n public class TimeColumn {\n \n-  private static final int DEFAULT_INIT_SIZE = 1000;\n+  private static final int capacityThreshold = TSFileDescriptor.getInstance().getConfig()\n+      .getBatchSize();\n+  private int capacity = 16;\n \n+  // outer list index for read\n+  private int readCurListIndex;\n+  // inner array index for read\n+  private int readCurArrayIndex;\n \n-  private long[] times;\n+  // outer list index for write\n+  private int writeCurListIndex;\n+  // inner array index for write\n+  private int writeCurArrayIndex;\n \n-  private int size;\n+  // the insert timestamp number of timeRet\n+  private int count;\n \n-  private int cur;\n+  private ArrayList<long[]> timeRet;\n \n   public TimeColumn() {\n-    this(DEFAULT_INIT_SIZE);\n+    this.readCurListIndex = 0;\n+    this.readCurArrayIndex = 0;\n+    this.writeCurListIndex = 0;\n+    this.writeCurArrayIndex = 0;\n+    timeRet = new ArrayList<>();\n+    timeRet.add(new long[capacity]);\n+    count = 0;\n   }\n \n-  public TimeColumn(int initSize) {\n-    times = new long[initSize];\n-  }\n+  public TimeColumn(ArrayList<long[]> timeRet, int count) {\n+    this.count = count;\n+    this.readCurListIndex = 0;\n+    this.readCurArrayIndex = 0;\n \n+    while (capacity < capacityThreshold) {\n+      capacity <<= 1;\n+    }\n \n-  public TimeColumn(long[] times) {\n-    this.times = times;\n+    this.writeCurListIndex = count / capacity;\n+    this.writeCurArrayIndex = count & (capacity - 1);\n+    this.timeRet = timeRet;\n   }\n \n   public void add(long time) {\n-    if (size == times.length) {\n-      long[] newArray = new long[times.length * 2];\n-      System.arraycopy(times, 0, newArray, 0, times.length);\n-      times = newArray;\n+    if (writeCurArrayIndex == capacity) {\n+      if (capacity >= capacityThreshold) {\n+        timeRet.add(new long[capacity]);\n+        writeCurListIndex++;\n+        writeCurArrayIndex = 0;\n+      } else {\n+        int newCapacity = capacity << 1;\n+\n+        long[] newTimeData = new long[newCapacity];\n+        System.arraycopy(timeRet.get(0), 0, newTimeData, 0, capacity);\n+        timeRet.set(0, newTimeData);\n+\n+        capacity = newCapacity;\n+      }\n     }\n-    times[size++] = time;\n-  }\n-\n-  public long[] getTimes() {\n-    return times;\n+    timeRet.get(writeCurListIndex)[writeCurArrayIndex] = time;\n+    writeCurArrayIndex++;\n+    count++;\n   }\n \n   public boolean hasCurrent() {\n-    return size > 0 && cur < size;\n+    if (readCurListIndex < writeCurListIndex) {\n+      return readCurArrayIndex < capacity;\n+    } else if (readCurListIndex == writeCurListIndex) {\n+      return readCurArrayIndex < writeCurArrayIndex;\n+    } else {\n+      return false;\n+    }", "originalCommit": "10461382d788a7ce187fba4d76c375818dbd5f17", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mjc3MjIwMg==", "url": "https://github.com/apache/iotdb/pull/913#discussion_r392772202", "bodyText": "excellent advice,  exchange order will be more easy to understand", "author": "liutaohua", "createdAt": "2020-03-16T03:58:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mjc2MDkyMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mjc2MTA0NQ==", "url": "https://github.com/apache/iotdb/pull/913#discussion_r392761045", "bodyText": "use List ?", "author": "samperson1997", "createdAt": "2020-03-16T02:53:28Z", "path": "tsfile/src/main/java/org/apache/iotdb/tsfile/read/common/TimeColumn.java", "diffHunk": "@@ -19,60 +19,115 @@\n package org.apache.iotdb.tsfile.read.common;\n \n \n+import java.nio.ReadOnlyBufferException;\n+import java.util.ArrayList;\n+import org.apache.iotdb.tsfile.common.conf.TSFileDescriptor;\n+\n public class TimeColumn {\n \n-  private static final int DEFAULT_INIT_SIZE = 1000;\n+  private static final int capacityThreshold = TSFileDescriptor.getInstance().getConfig()\n+      .getBatchSize();\n+  private int capacity = 16;\n \n+  // outer list index for read\n+  private int readCurListIndex;\n+  // inner array index for read\n+  private int readCurArrayIndex;\n \n-  private long[] times;\n+  // outer list index for write\n+  private int writeCurListIndex;\n+  // inner array index for write\n+  private int writeCurArrayIndex;\n \n-  private int size;\n+  // the insert timestamp number of timeRet\n+  private int count;\n \n-  private int cur;\n+  private ArrayList<long[]> timeRet;\n \n   public TimeColumn() {\n-    this(DEFAULT_INIT_SIZE);\n+    this.readCurListIndex = 0;\n+    this.readCurArrayIndex = 0;\n+    this.writeCurListIndex = 0;\n+    this.writeCurArrayIndex = 0;\n+    timeRet = new ArrayList<>();\n+    timeRet.add(new long[capacity]);\n+    count = 0;\n   }\n \n-  public TimeColumn(int initSize) {\n-    times = new long[initSize];\n-  }\n+  public TimeColumn(ArrayList<long[]> timeRet, int count) {\n+    this.count = count;\n+    this.readCurListIndex = 0;\n+    this.readCurArrayIndex = 0;\n \n+    while (capacity < capacityThreshold) {\n+      capacity <<= 1;\n+    }\n \n-  public TimeColumn(long[] times) {\n-    this.times = times;\n+    this.writeCurListIndex = count / capacity;\n+    this.writeCurArrayIndex = count & (capacity - 1);\n+    this.timeRet = timeRet;\n   }\n \n   public void add(long time) {\n-    if (size == times.length) {\n-      long[] newArray = new long[times.length * 2];\n-      System.arraycopy(times, 0, newArray, 0, times.length);\n-      times = newArray;\n+    if (writeCurArrayIndex == capacity) {\n+      if (capacity >= capacityThreshold) {\n+        timeRet.add(new long[capacity]);\n+        writeCurListIndex++;\n+        writeCurArrayIndex = 0;\n+      } else {\n+        int newCapacity = capacity << 1;\n+\n+        long[] newTimeData = new long[newCapacity];\n+        System.arraycopy(timeRet.get(0), 0, newTimeData, 0, capacity);\n+        timeRet.set(0, newTimeData);\n+\n+        capacity = newCapacity;\n+      }\n     }\n-    times[size++] = time;\n-  }\n-\n-  public long[] getTimes() {\n-    return times;\n+    timeRet.get(writeCurListIndex)[writeCurArrayIndex] = time;\n+    writeCurArrayIndex++;\n+    count++;\n   }\n \n   public boolean hasCurrent() {\n-    return size > 0 && cur < size;\n+    if (readCurListIndex < writeCurListIndex) {\n+      return readCurArrayIndex < capacity;\n+    } else if (readCurListIndex == writeCurListIndex) {\n+      return readCurArrayIndex < writeCurArrayIndex;\n+    } else {\n+      return false;\n+    }\n   }\n \n   public long currentTime() {\n-    return times[cur];\n+    return this.timeRet.get(readCurListIndex)[readCurArrayIndex];\n   }\n \n   public void next() {\n-    cur++;\n+    readCurArrayIndex++;\n+    if (readCurArrayIndex == capacity) {\n+      readCurArrayIndex = 0;\n+      readCurListIndex++;\n+    }\n   }\n \n-  public long getLastTime() {\n-    return times[size - 1];\n+  public int size() {\n+    return this.count;\n   }\n \n-  public int size() {\n-    return size;\n+  public TimeColumnR asReadOnlyTimeColumn() {\n+    return new TimeColumnR(timeRet, count);\n+  }\n+\n+  private class TimeColumnR extends TimeColumn {\n+\n+    public TimeColumnR(ArrayList<long[]> timeRet, int count) {", "originalCommit": "10461382d788a7ce187fba4d76c375818dbd5f17", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mjc3MDQxNQ==", "url": "https://github.com/apache/iotdb/pull/913#discussion_r392770415", "bodyText": "done", "author": "liutaohua", "createdAt": "2020-03-16T03:47:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mjc2MTA0NQ=="}], "type": "inlineReview"}, {"oid": "7c8baba999f74e752eda0b0081cd6f87bdbe1992", "url": "https://github.com/apache/iotdb/commit/7c8baba999f74e752eda0b0081cd6f87bdbe1992", "message": "fix review", "committedDate": "2020-03-16T03:55:55Z", "type": "commit"}, {"oid": "d24a003fb2e676cd125a975bf27db61bd837d0c4", "url": "https://github.com/apache/iotdb/commit/d24a003fb2e676cd125a975bf27db61bd837d0c4", "message": "del readOnly", "committedDate": "2020-03-17T04:44:17Z", "type": "commit"}, {"oid": "3140d9975970b9e0a06f05b0c9e98453966b465a", "url": "https://github.com/apache/iotdb/commit/3140d9975970b9e0a06f05b0c9e98453966b465a", "message": "fix mod", "committedDate": "2020-03-17T04:45:23Z", "type": "commit"}, {"oid": "76349d9ef5981eb0733491ca1ad08fc3b071efed", "url": "https://github.com/apache/iotdb/commit/76349d9ef5981eb0733491ca1ad08fc3b071efed", "message": "revert DYNAMIC_DATA_SIZE", "committedDate": "2020-03-17T05:53:04Z", "type": "commit"}, {"oid": "ba1f76bfadc0e05bd4944703c84356ea26929178", "url": "https://github.com/apache/iotdb/commit/ba1f76bfadc0e05bd4944703c84356ea26929178", "message": "rename DYNAMIC_DATA_SIZE to ARRAY_CAPACITY_THRESHOLD", "committedDate": "2020-03-17T06:53:11Z", "type": "commit"}]}