{"pr_number": 782, "pr_title": "[IOTDB-405] cache results in the client and makes the display look nice.", "pr_createdAt": "2020-02-08T16:01:58Z", "pr_url": "https://github.com/apache/iotdb/pull/782", "timeline": [{"oid": "0e885bd1523fb27b0f350f69d91b55e33bdde2a9", "url": "https://github.com/apache/iotdb/commit/0e885bd1523fb27b0f350f69d91b55e33bdde2a9", "message": "cache result in client.", "committedDate": "2020-02-08T15:56:41Z", "type": "commit"}, {"oid": "8601e3baffbc34bf34cbf182dd875f4801e1e237", "url": "https://github.com/apache/iotdb/commit/8601e3baffbc34bf34cbf182dd875f4801e1e237", "message": "try with resource.", "committedDate": "2020-02-09T05:15:27Z", "type": "commit"}, {"oid": "5226766a408adbeb8e605182ac725ddde719038e", "url": "https://github.com/apache/iotdb/commit/5226766a408adbeb8e605182ac725ddde719038e", "message": "remove duplicate code.", "committedDate": "2020-02-09T05:57:55Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njg4MDMzNA==", "url": "https://github.com/apache/iotdb/pull/782#discussion_r376880334", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              static int maxPrintRowCount = 100000;\n          \n          \n            \n              static int maxPrintRowCount = 1000;", "author": "qiaojialin", "createdAt": "2020-02-10T06:04:52Z", "path": "client/src/main/java/org/apache/iotdb/client/AbstractClient.java", "diffHunk": "@@ -82,89 +82,29 @@\n   static final String TIMESTAMP_STR = \"Time\";\n   static final int ISO_DATETIME_LEN = 35;\n   private static final String IMPORT_CMD = \"import\";\n-  private static final String NEED_NOT_TO_PRINT_TIMESTAMP = \"AGGREGATION\";\n   private static final String DEFAULT_TIME_FORMAT = \"default\";\n   private static String timeFormat = DEFAULT_TIME_FORMAT;\n   static int maxPrintRowCount = 100000;", "originalCommit": "5226766a408adbeb8e605182ac725ddde719038e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njg4MDQwMA==", "url": "https://github.com/apache/iotdb/pull/782#discussion_r376880400", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              private static int fetchSize = 10000;\n          \n          \n            \n              private static int fetchSize = 1000;", "author": "qiaojialin", "createdAt": "2020-02-10T06:05:13Z", "path": "client/src/main/java/org/apache/iotdb/client/AbstractClient.java", "diffHunk": "@@ -82,89 +82,29 @@\n   static final String TIMESTAMP_STR = \"Time\";\n   static final int ISO_DATETIME_LEN = 35;\n   private static final String IMPORT_CMD = \"import\";\n-  private static final String NEED_NOT_TO_PRINT_TIMESTAMP = \"AGGREGATION\";\n   private static final String DEFAULT_TIME_FORMAT = \"default\";\n   private static String timeFormat = DEFAULT_TIME_FORMAT;\n   static int maxPrintRowCount = 100000;\n   private static int fetchSize = 10000;", "originalCommit": "5226766a408adbeb8e605182ac725ddde719038e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njg4MDc2MQ==", "url": "https://github.com/apache/iotdb/pull/782#discussion_r376880761", "bodyText": "change this 30 to a field of this class", "author": "qiaojialin", "createdAt": "2020-02-10T06:06:51Z", "path": "client/src/main/java/org/apache/iotdb/client/AbstractClient.java", "diffHunk": "@@ -805,34 +503,100 @@ private static void importCmd(String specialCmd, String cmd, IoTDBConnection con\n     } catch (SQLException e) {\n       println(String.format(\"Failed to import from %s because %s\",\n           cmd.split(\" \")[1], e.getMessage()));\n-      handleException(e);\n     } catch (TException e) {\n       println(\"Cannot connect to server\");\n-      handleException(e);\n     }\n   }\n \n   private static void executeQuery(IoTDBConnection connection, String cmd) {\n     long startTime = System.currentTimeMillis();\n-    try (Statement statement = connection.createStatement();) {\n+    try (Statement statement = connection.createStatement()) {\n       ZoneId zoneId = ZoneId.of(connection.getTimeZone());\n       statement.setFetchSize(fetchSize);\n       boolean hasResultSet = statement.execute(cmd.trim());\n       if (hasResultSet) {\n-        ResultSet resultSet = statement.getResultSet();\n-        output(resultSet, printToConsole, zoneId);\n-        if (resultSet != null) {\n-          resultSet.close();\n+        try (ResultSet resultSet = statement.getResultSet()) {\n+          ResultSetMetaData resultSetMetaData = resultSet.getMetaData();\n+          int columnLength = resultSetMetaData.getColumnCount();\n+          List<Integer> maxSizeList = new ArrayList<>(columnLength);\n+          List<List<String>> lists = cacheResult(resultSet, maxSizeList, columnLength,\n+              resultSetMetaData, zoneId);\n+          output(lists, maxSizeList);\n         }\n       }\n     } catch (Exception e) {\n       println(\"Msg: \" + e.getMessage());\n-      handleException(e);\n     }\n     long costTime = System.currentTimeMillis() - startTime;\n     println(String.format(\"It costs %.3fs\", costTime / 1000.0));\n   }\n \n+  private static List<List<String>> cacheResult(ResultSet resultSet, List<Integer> maxSizeList,\n+      int columnLength, ResultSetMetaData resultSetMetaData, ZoneId zoneId)\n+      throws SQLException {\n+    boolean printTimestamp = !((IoTDBQueryResultSet) resultSet).isIgnoreTimeStamp();\n+    List<List<String>> lists = new ArrayList<>(columnLength);\n+    for(int i = 1; i <= columnLength; i++) {\n+      List<String> list = new ArrayList<>(30);", "originalCommit": "5226766a408adbeb8e605182ac725ddde719038e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njg4MTIzMg==", "url": "https://github.com/apache/iotdb/pull/782#discussion_r376881232", "bodyText": "format", "author": "qiaojialin", "createdAt": "2020-02-10T06:09:09Z", "path": "client/src/main/java/org/apache/iotdb/client/AbstractClient.java", "diffHunk": "@@ -805,34 +503,100 @@ private static void importCmd(String specialCmd, String cmd, IoTDBConnection con\n     } catch (SQLException e) {\n       println(String.format(\"Failed to import from %s because %s\",\n           cmd.split(\" \")[1], e.getMessage()));\n-      handleException(e);\n     } catch (TException e) {\n       println(\"Cannot connect to server\");\n-      handleException(e);\n     }\n   }\n \n   private static void executeQuery(IoTDBConnection connection, String cmd) {\n     long startTime = System.currentTimeMillis();\n-    try (Statement statement = connection.createStatement();) {\n+    try (Statement statement = connection.createStatement()) {\n       ZoneId zoneId = ZoneId.of(connection.getTimeZone());\n       statement.setFetchSize(fetchSize);\n       boolean hasResultSet = statement.execute(cmd.trim());\n       if (hasResultSet) {\n-        ResultSet resultSet = statement.getResultSet();\n-        output(resultSet, printToConsole, zoneId);\n-        if (resultSet != null) {\n-          resultSet.close();\n+        try (ResultSet resultSet = statement.getResultSet()) {\n+          ResultSetMetaData resultSetMetaData = resultSet.getMetaData();\n+          int columnLength = resultSetMetaData.getColumnCount();\n+          List<Integer> maxSizeList = new ArrayList<>(columnLength);\n+          List<List<String>> lists = cacheResult(resultSet, maxSizeList, columnLength,\n+              resultSetMetaData, zoneId);\n+          output(lists, maxSizeList);\n         }\n       }\n     } catch (Exception e) {\n       println(\"Msg: \" + e.getMessage());\n-      handleException(e);\n     }\n     long costTime = System.currentTimeMillis() - startTime;\n     println(String.format(\"It costs %.3fs\", costTime / 1000.0));\n   }\n \n+  private static List<List<String>> cacheResult(ResultSet resultSet, List<Integer> maxSizeList,\n+      int columnLength, ResultSetMetaData resultSetMetaData, ZoneId zoneId)\n+      throws SQLException {\n+    boolean printTimestamp = !((IoTDBQueryResultSet) resultSet).isIgnoreTimeStamp();\n+    List<List<String>> lists = new ArrayList<>(columnLength);\n+    for(int i = 1; i <= columnLength; i++) {\n+      List<String> list = new ArrayList<>(30);\n+      list.add(resultSetMetaData.getColumnLabel(i));\n+      lists.add(list);\n+      maxSizeList.add(resultSetMetaData.getColumnLabel(i).length());\n+    }\n+    int j = 0;\n+    while (resultSet.next()) {\n+      if(j > maxPrintRowCount) {\n+        break;\n+      }\n+      for(int i = 1; i <= columnLength; i++) {\n+        String tmp;\n+        if(printTimestamp && i == 1) {\n+          tmp = formatDatetime(resultSet.getLong(TIMESTAMP_STR), zoneId);\n+        } else {\n+          tmp = resultSet.getString(i);\n+        }\n+        lists.get(i-1).add(tmp);\n+        if(maxSizeList.get(i-1) < tmp.length()) {", "originalCommit": "5226766a408adbeb8e605182ac725ddde719038e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njk3MDM0NA==", "url": "https://github.com/apache/iotdb/pull/782#discussion_r376970344", "bodyText": "format what?", "author": "Genius-pig", "createdAt": "2020-02-10T10:12:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njg4MTIzMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzAyNDc4OQ==", "url": "https://github.com/apache/iotdb/pull/782#discussion_r377024789", "bodyText": "oh, nothing", "author": "qiaojialin", "createdAt": "2020-02-10T12:10:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njg4MTIzMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njg4MTMxMA==", "url": "https://github.com/apache/iotdb/pull/782#discussion_r376881310", "bodyText": "add some javadoc", "author": "qiaojialin", "createdAt": "2020-02-10T06:09:39Z", "path": "client/src/main/java/org/apache/iotdb/client/AbstractClient.java", "diffHunk": "@@ -805,34 +503,100 @@ private static void importCmd(String specialCmd, String cmd, IoTDBConnection con\n     } catch (SQLException e) {\n       println(String.format(\"Failed to import from %s because %s\",\n           cmd.split(\" \")[1], e.getMessage()));\n-      handleException(e);\n     } catch (TException e) {\n       println(\"Cannot connect to server\");\n-      handleException(e);\n     }\n   }\n \n   private static void executeQuery(IoTDBConnection connection, String cmd) {\n     long startTime = System.currentTimeMillis();\n-    try (Statement statement = connection.createStatement();) {\n+    try (Statement statement = connection.createStatement()) {\n       ZoneId zoneId = ZoneId.of(connection.getTimeZone());\n       statement.setFetchSize(fetchSize);\n       boolean hasResultSet = statement.execute(cmd.trim());\n       if (hasResultSet) {\n-        ResultSet resultSet = statement.getResultSet();\n-        output(resultSet, printToConsole, zoneId);\n-        if (resultSet != null) {\n-          resultSet.close();\n+        try (ResultSet resultSet = statement.getResultSet()) {\n+          ResultSetMetaData resultSetMetaData = resultSet.getMetaData();\n+          int columnLength = resultSetMetaData.getColumnCount();\n+          List<Integer> maxSizeList = new ArrayList<>(columnLength);\n+          List<List<String>> lists = cacheResult(resultSet, maxSizeList, columnLength,\n+              resultSetMetaData, zoneId);\n+          output(lists, maxSizeList);\n         }\n       }\n     } catch (Exception e) {\n       println(\"Msg: \" + e.getMessage());\n-      handleException(e);\n     }\n     long costTime = System.currentTimeMillis() - startTime;\n     println(String.format(\"It costs %.3fs\", costTime / 1000.0));\n   }\n \n+  private static List<List<String>> cacheResult(ResultSet resultSet, List<Integer> maxSizeList,", "originalCommit": "5226766a408adbeb8e605182ac725ddde719038e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njk3MjA1MA==", "url": "https://github.com/apache/iotdb/pull/782#discussion_r376972050", "bodyText": "fixed", "author": "Genius-pig", "createdAt": "2020-02-10T10:16:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njg4MTMxMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njg4MTQ4Mg==", "url": "https://github.com/apache/iotdb/pull/782#discussion_r376881482", "bodyText": "There is a null pointer exception, I can not print result in my client. Try to fix it...", "author": "qiaojialin", "createdAt": "2020-02-10T06:10:37Z", "path": "client/src/main/java/org/apache/iotdb/client/AbstractClient.java", "diffHunk": "@@ -805,34 +503,100 @@ private static void importCmd(String specialCmd, String cmd, IoTDBConnection con\n     } catch (SQLException e) {\n       println(String.format(\"Failed to import from %s because %s\",\n           cmd.split(\" \")[1], e.getMessage()));\n-      handleException(e);\n     } catch (TException e) {\n       println(\"Cannot connect to server\");\n-      handleException(e);\n     }\n   }\n \n   private static void executeQuery(IoTDBConnection connection, String cmd) {\n     long startTime = System.currentTimeMillis();\n-    try (Statement statement = connection.createStatement();) {\n+    try (Statement statement = connection.createStatement()) {\n       ZoneId zoneId = ZoneId.of(connection.getTimeZone());\n       statement.setFetchSize(fetchSize);\n       boolean hasResultSet = statement.execute(cmd.trim());\n       if (hasResultSet) {\n-        ResultSet resultSet = statement.getResultSet();\n-        output(resultSet, printToConsole, zoneId);\n-        if (resultSet != null) {\n-          resultSet.close();\n+        try (ResultSet resultSet = statement.getResultSet()) {\n+          ResultSetMetaData resultSetMetaData = resultSet.getMetaData();\n+          int columnLength = resultSetMetaData.getColumnCount();\n+          List<Integer> maxSizeList = new ArrayList<>(columnLength);\n+          List<List<String>> lists = cacheResult(resultSet, maxSizeList, columnLength,\n+              resultSetMetaData, zoneId);\n+          output(lists, maxSizeList);\n         }\n       }\n     } catch (Exception e) {\n       println(\"Msg: \" + e.getMessage());", "originalCommit": "5226766a408adbeb8e605182ac725ddde719038e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njk3MTk2OA==", "url": "https://github.com/apache/iotdb/pull/782#discussion_r376971968", "bodyText": "fixed.", "author": "Genius-pig", "createdAt": "2020-02-10T10:16:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njg4MTQ4Mg=="}], "type": "inlineReview"}, {"oid": "6f61a134181563ad92e66f1a7d0026b203ca44ab", "url": "https://github.com/apache/iotdb/commit/6f61a134181563ad92e66f1a7d0026b203ca44ab", "message": "Update client/src/main/java/org/apache/iotdb/client/AbstractClient.java\n\nCo-Authored-By: Jialin Qiao <qjl16@mails.tsinghua.edu.cn>", "committedDate": "2020-02-10T10:11:06Z", "type": "commit"}, {"oid": "90a8bc341132372755b8425167646e5a038a35b9", "url": "https://github.com/apache/iotdb/commit/90a8bc341132372755b8425167646e5a038a35b9", "message": "Update client/src/main/java/org/apache/iotdb/client/AbstractClient.java\n\nCo-Authored-By: Jialin Qiao <qjl16@mails.tsinghua.edu.cn>", "committedDate": "2020-02-10T10:11:26Z", "type": "commit"}, {"oid": "cc2b58725ea4935e9ea479f7428abff40c76257f", "url": "https://github.com/apache/iotdb/commit/cc2b58725ea4935e9ea479f7428abff40c76257f", "message": "fix according to review", "committedDate": "2020-02-10T10:17:11Z", "type": "commit"}, {"oid": "d462e30ab2470fd09cfb9d1a22651742ff66d490", "url": "https://github.com/apache/iotdb/commit/d462e30ab2470fd09cfb9d1a22651742ff66d490", "message": "Merge branch 'client_chache' of https://github.com/apache/incubator-iotdb into client_chache", "committedDate": "2020-02-10T10:18:21Z", "type": "commit"}, {"oid": "ebed4a60dc4d3eafa77b896fcdb97b8b6c8c77ea", "url": "https://github.com/apache/iotdb/commit/ebed4a60dc4d3eafa77b896fcdb97b8b6c8c77ea", "message": "set 30 to 1001", "committedDate": "2020-02-10T11:12:23Z", "type": "commit"}]}