{"pr_number": 1846, "pr_title": "[IOTDB-872] Use system timezone in CLI (Session)", "pr_createdAt": "2020-10-22T11:26:28Z", "pr_url": "https://github.com/apache/iotdb/pull/1846", "timeline": [{"oid": "263b7835e25c9914c73bcbb81c091741dc5b3c4e", "url": "https://github.com/apache/iotdb/commit/263b7835e25c9914c73bcbb81c091741dc5b3c4e", "message": "Update docs/Documentation-CHN/UserGuide/5-Operation Manual/4-SQL Reference.md", "committedDate": "2020-03-11T03:35:39Z", "type": "commit"}, {"oid": "63d5b09b4cc4f194bbd2ea083fda67b4c8c6c8be", "url": "https://github.com/apache/iotdb/commit/63d5b09b4cc4f194bbd2ea083fda67b4c8c6c8be", "message": "Update docs/Documentation/UserGuide/5-Operation Manual/4-SQL Reference.md", "committedDate": "2020-03-11T03:35:46Z", "type": "commit"}, {"oid": "e705465f975fc8c36019ca3956558ec1231c0d6d", "url": "https://github.com/apache/iotdb/commit/e705465f975fc8c36019ca3956558ec1231c0d6d", "message": "Merge branch 'master' of https://github.com/apache/iotdb", "committedDate": "2020-10-08T06:45:01Z", "type": "commit"}, {"oid": "8636472a1f1c52dae952e5729635030459b4777f", "url": "https://github.com/apache/iotdb/commit/8636472a1f1c52dae952e5729635030459b4777f", "message": "modify session timezone", "committedDate": "2020-10-22T11:25:01Z", "type": "commit"}, {"oid": "6b120560a42dde2c6f48369e882c676aa201af1e", "url": "https://github.com/apache/iotdb/commit/6b120560a42dde2c6f48369e882c676aa201af1e", "message": "modify typo", "committedDate": "2020-10-22T11:25:30Z", "type": "commit"}, {"oid": "4a45fe55ec9ebff4b39fdf0b4b8c2bfd08c209a0", "url": "https://github.com/apache/iotdb/commit/4a45fe55ec9ebff4b39fdf0b4b8c2bfd08c209a0", "message": "modify session Constructor", "committedDate": "2020-10-22T11:58:28Z", "type": "commit"}, {"oid": "ce7b4f5d4b50d3b34b6c133f01c1cf4e935371ad", "url": "https://github.com/apache/iotdb/commit/ce7b4f5d4b50d3b34b6c133f01c1cf4e935371ad", "message": "modify typo", "committedDate": "2020-10-22T12:03:06Z", "type": "commit"}, {"oid": "6cd85e176958bc1d7b99164c24c88c10f624dac5", "url": "https://github.com/apache/iotdb/commit/6cd85e176958bc1d7b99164c24c88c10f624dac5", "message": "rename timezone", "committedDate": "2020-10-22T12:04:15Z", "type": "commit"}, {"oid": "81079d18575dbd540c03eb5475184fb9cba65bea", "url": "https://github.com/apache/iotdb/commit/81079d18575dbd540c03eb5475184fb9cba65bea", "message": "string to zoneId", "committedDate": "2020-10-22T12:23:23Z", "type": "commit"}, {"oid": "4771a8ddcde3be096db0b3001b8e718369baf20e", "url": "https://github.com/apache/iotdb/commit/4771a8ddcde3be096db0b3001b8e718369baf20e", "message": "Merge pull request #2 from apache/master\n\nmerge master", "committedDate": "2020-10-26T02:01:34Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTg5NTk4MA==", "url": "https://github.com/apache/iotdb/pull/1846#discussion_r511895980", "bodyText": "There is something wrong with the logic.\nIt should be the default value that the server stores when the client is not registered with the server.", "author": "liutaohua", "createdAt": "2020-10-26T11:37:46Z", "path": "session/src/main/java/org/apache/iotdb/session/Session.java", "diffHunk": "@@ -916,23 +922,14 @@ public boolean checkTimeseriesExists(String path)\n     return result;\n   }\n \n-  private synchronized String getTimeZone()\n-      throws StatementExecutionException, IoTDBConnectionException {\n+  private synchronized String getTimeZone() {\n     if (zoneId != null) {\n       return zoneId.toString();\n     }\n-\n-    TSGetTimeZoneResp resp;\n-    try {\n-      resp = client.getTimeZone(sessionId);\n-    } catch (TException e) {\n-      throw new IoTDBConnectionException(e);\n-    }\n-    RpcUtils.verifySuccess(resp.getStatus());\n-    return resp.getTimeZone();\n+    return ZoneId.systemDefault().getId();", "originalCommit": "81079d18575dbd540c03eb5475184fb9cba65bea", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTg5NzM3NA==", "url": "https://github.com/apache/iotdb/pull/1846#discussion_r511897374", "bodyText": "There may be a bug here, because the value stored by the server does not necessarily change when an error is encountered, but the local cached zoneId does", "author": "liutaohua", "createdAt": "2020-10-26T11:40:30Z", "path": "session/src/main/java/org/apache/iotdb/session/Session.java", "diffHunk": "@@ -916,23 +922,14 @@ public boolean checkTimeseriesExists(String path)\n     return result;\n   }\n \n-  private synchronized String getTimeZone()\n-      throws StatementExecutionException, IoTDBConnectionException {\n+  private synchronized String getTimeZone() {\n     if (zoneId != null) {\n       return zoneId.toString();\n     }\n-\n-    TSGetTimeZoneResp resp;\n-    try {\n-      resp = client.getTimeZone(sessionId);\n-    } catch (TException e) {\n-      throw new IoTDBConnectionException(e);\n-    }\n-    RpcUtils.verifySuccess(resp.getStatus());\n-    return resp.getTimeZone();\n+    return ZoneId.systemDefault().getId();\n   }\n \n-  private synchronized void setTimeZone(String zoneId)\n+  public synchronized void setTimeZone(String zoneId)\n       throws StatementExecutionException, IoTDBConnectionException {\n     TSSetTimeZoneReq req = new TSSetTimeZoneReq(sessionId, zoneId);\n     TSStatus resp;", "originalCommit": "81079d18575dbd540c03eb5475184fb9cba65bea", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "a1ab2c6903cdc7b0df4de8ab88e680061c8702cd", "url": "https://github.com/apache/iotdb/commit/a1ab2c6903cdc7b0df4de8ab88e680061c8702cd", "message": "Merge branch 'timezone' of github.com:Alima777/incubator-iotdb into timezone", "committedDate": "2020-10-26T11:53:23Z", "type": "commit"}, {"oid": "ade0b5929132e40bed2bd3cb49ef0b8f5ebf4b50", "url": "https://github.com/apache/iotdb/commit/ade0b5929132e40bed2bd3cb49ef0b8f5ebf4b50", "message": "remove timezone in server side", "committedDate": "2020-10-26T14:26:23Z", "type": "commit"}, {"oid": "55f54a478a935120f7ee3894918b70897c7f49e5", "url": "https://github.com/apache/iotdb/commit/55f54a478a935120f7ee3894918b70897c7f49e5", "message": "modify getTimeZone()", "committedDate": "2020-10-26T14:27:25Z", "type": "commit"}, {"oid": "b37e419566cb91b455f78f4a6271102f149fe35c", "url": "https://github.com/apache/iotdb/commit/b37e419566cb91b455f78f4a6271102f149fe35c", "message": "recover some comments", "committedDate": "2020-10-26T14:47:44Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjQzNDM5Mg==", "url": "https://github.com/apache/iotdb/pull/1846#discussion_r512434392", "bodyText": "So we have to fill a null to the constructor of SessionPool if we don't want to set timezone, right?\nI think we'd better don't change these tests and add an extra test of setting timezone.", "author": "HTHou", "createdAt": "2020-10-27T06:00:27Z", "path": "session/src/test/java/org/apache/iotdb/session/pool/SessionPoolTest.java", "diffHunk": "@@ -163,7 +163,7 @@ private void correctQuery(SessionPool pool) {\n \n   @Test\n   public void tryIfTheServerIsRestart() {\n-    SessionPool pool = new SessionPool(\"127.0.0.1\", 6667, \"root\", \"root\", 3, 1, 6000, false);\n+    SessionPool pool = new SessionPool(\"127.0.0.1\", 6667, \"root\", \"root\", 3, 1, 6000, false, null);", "originalCommit": "b37e419566cb91b455f78f4a6271102f149fe35c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjU3ODc2OA==", "url": "https://github.com/apache/iotdb/pull/1846#discussion_r512578768", "bodyText": "Not Exactly. We can use a constructor which doesn't need a timezone parameter instead.", "author": "Alima777", "createdAt": "2020-10-27T10:35:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjQzNDM5Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjQzNDQxNQ==", "url": "https://github.com/apache/iotdb/pull/1846#discussion_r512434415", "bodyText": "Please update thrift/rpc-changelist.md.", "author": "HTHou", "createdAt": "2020-10-27T06:00:32Z", "path": "thrift/src/main/thrift/rpc.thrift", "diffHunk": "@@ -79,9 +79,10 @@ struct TSOpenSessionResp {\n // Open a session (connection) on the server against which operations may be executed.\n struct TSOpenSessionReq {\n   1: required TSProtocolVersion client_protocol = TSProtocolVersion.IOTDB_SERVICE_PROTOCOL_V3\n-  2: optional string username\n-  3: optional string password\n-  4: optional map<string, string> configuration\n+  2: required string zoneId\n+  3: optional string username\n+  4: optional string password\n+  5: optional map<string, string> configuration", "originalCommit": "b37e419566cb91b455f78f4a6271102f149fe35c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjU3NjAyNQ==", "url": "https://github.com/apache/iotdb/pull/1846#discussion_r512576025", "bodyText": "Fixed.", "author": "Alima777", "createdAt": "2020-10-27T10:31:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjQzNDQxNQ=="}], "type": "inlineReview"}, {"oid": "c52785142c0ab22047071bf8d081d6b06b109acf", "url": "https://github.com/apache/iotdb/commit/c52785142c0ab22047071bf8d081d6b06b109acf", "message": "modify rpc-changelist.md", "committedDate": "2020-10-27T10:47:40Z", "type": "commit"}, {"oid": "16734bdde94cafeb26dca36c1324f0eb65240840", "url": "https://github.com/apache/iotdb/commit/16734bdde94cafeb26dca36c1324f0eb65240840", "message": "add timezone test", "committedDate": "2020-10-28T09:03:26Z", "type": "commit"}]}