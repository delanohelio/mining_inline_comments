{"pr_number": 1051, "pr_title": "[IOTDB-526] Support some metadata queries", "pr_createdAt": "2020-04-15T00:51:34Z", "pr_url": "https://github.com/apache/iotdb/pull/1051", "timeline": [{"oid": "77bfc4c5fbf0e77b801f9bce3b6d11566eb9eab4", "url": "https://github.com/apache/iotdb/commit/77bfc4c5fbf0e77b801f9bce3b6d11566eb9eab4", "message": "implement getNodesList", "committedDate": "2020-04-15T00:45:52Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODUzMzg1Ng==", "url": "https://github.com/apache/iotdb/pull/1051#discussion_r408533856", "bodyText": "The same handler is used in different threads and its response and contact are set concurrently, so I am afraid that only the result from one node is returned because there is only one response in the handler.\nAnd the answer is still correct because the default replica number and node number are both 3, so timeseries are fully replicated in each node and even if you only query one node, it will have all timeseries. Thus I suggest you test in a different configuration, like 4-node-3-replica or 3-node-2-replica.", "author": "jt2594838", "createdAt": "2020-04-15T01:49:40Z", "path": "cluster/src/main/java/org/apache/iotdb/cluster/query/ClusterPlanExecutor.java", "diffHunk": "@@ -81,10 +97,48 @@ public QueryDataSet processQuery(PhysicalPlan queryPlan, QueryContext context)\n   }\n \n   @Override\n-  protected List<String> getNodesList(String schemaPattern, int level) {\n-    // TODO-Cluster: enable meta queries\n-    throw new UnsupportedOperationException(\"Not implemented\");\n-    //return metaGroupMember.getNodeList(schemaPattern, level);\n+  protected List<String> getNodesList(String schemaPattern, int level)\n+      throws IOException, TException, InterruptedException, MetadataException {\n+    Set<String> nodeListSet = new HashSet<>(\n+        MManager.getInstance().getNodesList(schemaPattern, level));\n+\n+    GetNodesListHandler handler = new GetNodesListHandler();\n+\n+    ExecutorService pool = new ScheduledThreadPoolExecutor(THREAD_POOL_SIZE);\n+\n+    for (Node node : metaGroupMember.getAllNodes()) {\n+      if (node.equals(metaGroupMember.getThisNode())) {\n+        continue;\n+      }\n+      pool.submit(() -> {\n+        DataClient client = null;\n+        try {\n+          client = metaGroupMember.getDataClient(node);\n+        } catch (IOException e) {\n+          logger.error(\"Failed to connect to node: {}\", node, e);\n+        }\n+        AtomicReference<List<String>> response = new AtomicReference<>(null);\n+        handler.setResponse(response);\n+        handler.setContact(node);", "originalCommit": "77bfc4c5fbf0e77b801f9bce3b6d11566eb9eab4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODY2MjM4NQ==", "url": "https://github.com/apache/iotdb/pull/1051#discussion_r408662385", "bodyText": "Yes, there's a problem. Thanks for your reminding. The initialization of handler should be inside each thread.", "author": "Ring-k", "createdAt": "2020-04-15T08:16:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODUzMzg1Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODUzNDM4MA==", "url": "https://github.com/apache/iotdb/pull/1051#discussion_r408534380", "bodyText": "As nodeListSet is modified in different threads, maybe you should use a concurrent class.\nBy the way, the naming nodeListSet is confusing, probably better to just use nodeSet.", "author": "jt2594838", "createdAt": "2020-04-15T01:51:39Z", "path": "cluster/src/main/java/org/apache/iotdb/cluster/query/ClusterPlanExecutor.java", "diffHunk": "@@ -81,10 +97,48 @@ public QueryDataSet processQuery(PhysicalPlan queryPlan, QueryContext context)\n   }\n \n   @Override\n-  protected List<String> getNodesList(String schemaPattern, int level) {\n-    // TODO-Cluster: enable meta queries\n-    throw new UnsupportedOperationException(\"Not implemented\");\n-    //return metaGroupMember.getNodeList(schemaPattern, level);\n+  protected List<String> getNodesList(String schemaPattern, int level)\n+      throws IOException, TException, InterruptedException, MetadataException {\n+    Set<String> nodeListSet = new HashSet<>(\n+        MManager.getInstance().getNodesList(schemaPattern, level));\n+\n+    GetNodesListHandler handler = new GetNodesListHandler();\n+\n+    ExecutorService pool = new ScheduledThreadPoolExecutor(THREAD_POOL_SIZE);\n+\n+    for (Node node : metaGroupMember.getAllNodes()) {\n+      if (node.equals(metaGroupMember.getThisNode())) {\n+        continue;\n+      }\n+      pool.submit(() -> {\n+        DataClient client = null;\n+        try {\n+          client = metaGroupMember.getDataClient(node);\n+        } catch (IOException e) {\n+          logger.error(\"Failed to connect to node: {}\", node, e);\n+        }\n+        AtomicReference<List<String>> response = new AtomicReference<>(null);\n+        handler.setResponse(response);\n+        handler.setContact(node);\n+        synchronized (response) {\n+          try {\n+            if(client!= null){\n+              client.getNodeList(null, schemaPattern, level, handler);\n+              response.wait(connectionTimeoutInMS);\n+            }\n+          } catch (TException e) {\n+            logger.error(\"Error occurs when getting node lists in node {}.\", node, e);\n+          } catch (InterruptedException e) {\n+            logger.error(\"Interrupted when getting node lists in node {}.\", node, e);\n+          }\n+        }\n+        List<String> paths = response.get();\n+        if (paths != null) {\n+          nodeListSet.addAll(response.get());", "originalCommit": "77bfc4c5fbf0e77b801f9bce3b6d11566eb9eab4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODYyMjUzNA==", "url": "https://github.com/apache/iotdb/pull/1051#discussion_r408622534", "bodyText": "Thanks for your reminding. ConcurrentSkipListSet is used instead of Set now.", "author": "Ring-k", "createdAt": "2020-04-15T07:02:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODUzNDM4MA=="}], "type": "inlineReview"}, {"oid": "b07f98482af1564fa3b1e7a48f40bcffab9399c4", "url": "https://github.com/apache/iotdb/commit/b07f98482af1564fa3b1e7a48f40bcffab9399c4", "message": "implement get child path in next level", "committedDate": "2020-04-15T01:53:53Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODUzNzQ1NQ==", "url": "https://github.com/apache/iotdb/pull/1051#discussion_r408537455", "bodyText": "Why not skip the local node?", "author": "jt2594838", "createdAt": "2020-04-15T02:02:22Z", "path": "cluster/src/main/java/org/apache/iotdb/cluster/query/ClusterPlanExecutor.java", "diffHunk": "@@ -107,9 +108,6 @@ public QueryDataSet processQuery(PhysicalPlan queryPlan, QueryContext context)\n     ExecutorService pool = new ScheduledThreadPoolExecutor(THREAD_POOL_SIZE);\n \n     for (Node node : metaGroupMember.getAllNodes()) {\n-      if (node.equals(metaGroupMember.getThisNode())) {\n-        continue;\n-      }", "originalCommit": "b07f98482af1564fa3b1e7a48f40bcffab9399c4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODYxNTM4MQ==", "url": "https://github.com/apache/iotdb/pull/1051#discussion_r408615381", "bodyText": "I thought maybe I can use client == null to check if it is the local node. Since it makes no differentce, I use the if (node.equals(metaGroupMember.getThisNode())) as before.", "author": "Ring-k", "createdAt": "2020-04-15T06:46:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODUzNzQ1NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODUzNzc4Nw==", "url": "https://github.com/apache/iotdb/pull/1051#discussion_r408537787", "bodyText": "Please notice the concurrent problem as the above one.", "author": "jt2594838", "createdAt": "2020-04-15T02:03:28Z", "path": "cluster/src/main/java/org/apache/iotdb/cluster/query/ClusterPlanExecutor.java", "diffHunk": "@@ -138,13 +136,53 @@ public QueryDataSet processQuery(PhysicalPlan queryPlan, QueryContext context)\n         }\n       });\n     }\n+    pool.shutdown();\n+    pool.awaitTermination(WAIT_GET_NODES_LIST_TIME, WAIT_GET_NODES_LIST_TIME_UNIT);\n     return new ArrayList<>(nodeListSet);\n   }\n \n   @Override\n-  protected Set<String> getPathNextChildren(String path) {\n-    // TODO-Cluster: enable meta queries\n-    throw new UnsupportedOperationException(\"Not implemented\");\n+  protected Set<String> getPathNextChildren(String path)\n+      throws MetadataException, InterruptedException {\n+    Set<String> nodeListSet = new HashSet<>(\n+        MManager.getInstance().getChildNodePathInNextLevel(path));\n+\n+    GetChildNodeNextLevelPathHandler handler = new GetChildNodeNextLevelPathHandler();\n+\n+    ExecutorService pool = new ScheduledThreadPoolExecutor(THREAD_POOL_SIZE);\n+\n+    for (Node node : metaGroupMember.getAllNodes()) {\n+      pool.submit(() -> {\n+        DataClient client = null;\n+        try {\n+          client = metaGroupMember.getDataClient(node);\n+        } catch (IOException e) {\n+          logger.error(\"Failed to connect to node: {}\", node, e);\n+        }\n+        AtomicReference<List<String>> response = new AtomicReference<>(null);\n+        handler.setResponse(response);\n+        handler.setContact(node);", "originalCommit": "b07f98482af1564fa3b1e7a48f40bcffab9399c4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "2b5d6472f59f4ed81072b738a74c4f706dde06b1", "url": "https://github.com/apache/iotdb/commit/2b5d6472f59f4ed81072b738a74c4f706dde06b1", "message": "implement get timeseries schema", "committedDate": "2020-04-15T03:51:50Z", "type": "commit"}, {"oid": "e9ad29f726d7ad29e5c95a717c9fef7eecd7ae77", "url": "https://github.com/apache/iotdb/commit/e9ad29f726d7ad29e5c95a717c9fef7eecd7ae77", "message": "use concurrent class", "committedDate": "2020-04-15T07:01:31Z", "type": "commit"}, {"oid": "389e8c598189e6002af6f17819d42235b600767c", "url": "https://github.com/apache/iotdb/commit/389e8c598189e6002af6f17819d42235b600767c", "message": "send to each group instead of each node", "committedDate": "2020-04-15T08:09:29Z", "type": "commit"}, {"oid": "31ade1dfbf60436e71ba827f2f83ac4e57642eb3", "url": "https://github.com/apache/iotdb/commit/31ade1dfbf60436e71ba827f2f83ac4e57642eb3", "message": "add license", "committedDate": "2020-04-15T08:24:24Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODY3ODg4Mg==", "url": "https://github.com/apache/iotdb/pull/1051#discussion_r408678882", "bodyText": "It will be more robust if, for each group, you will try querying each node in the group until one result is returned. So that even if one node is down, you can still get the result from its replicas.", "author": "jt2594838", "createdAt": "2020-04-15T08:43:52Z", "path": "cluster/src/main/java/org/apache/iotdb/cluster/query/ClusterPlanExecutor.java", "diffHunk": "@@ -121,38 +124,41 @@ public QueryDataSet processQuery(PhysicalPlan queryPlan, QueryContext context)\n         synchronized (response) {\n           try {\n             if (client != null) {\n-              client.getNodeList(null, schemaPattern, level, handler);\n+              client.getNodeList(node, schemaPattern, level, handler);\n               response.wait(connectionTimeoutInMS);\n             }\n           } catch (TException e) {\n             logger.error(\"Error occurs when getting node lists in node {}.\", node, e);", "originalCommit": "389e8c598189e6002af6f17819d42235b600767c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODg0NjMxNw==", "url": "https://github.com/apache/iotdb/pull/1051#discussion_r408846317", "bodyText": "Thanks for your suggestion.", "author": "Ring-k", "createdAt": "2020-04-15T13:36:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODY3ODg4Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODY4NDU5OQ==", "url": "https://github.com/apache/iotdb/pull/1051#discussion_r408684599", "bodyText": "The current implementation cannot avoid the problem of sending duplicated metadata.\nThe solution may be modifying the interfaces in MManager to add a filter that will skip the unsatisfying timeseries that do not belong to the slots managed by the member.\nIt is a little tricky and it is okay if you do it in another PR.", "author": "jt2594838", "createdAt": "2020-04-15T08:53:35Z", "path": "cluster/src/main/java/org/apache/iotdb/cluster/server/member/DataGroupMember.java", "diffHunk": "@@ -1369,6 +1370,24 @@ public void getChildNodePathInNextLevel(Node header, String path,\n     }\n   }\n \n+  @Override\n+  public void getAllMeasurementSchema(Node header, String path,\n+      AsyncMethodCallback<List<List<String>>> resultHandler) throws TException {\n+    if (!syncLeader()) {\n+      resultHandler.onError(new LeaderUnknownException(getAllNodes()));\n+      return;\n+    }\n+    try {\n+      List<List<String>> res = new ArrayList<>();\n+      for(String[] element : MManager.getInstance().getAllMeasurementSchema(path)){\n+        res.add(Arrays.asList(element));\n+      }\n+      resultHandler.onComplete(res);", "originalCommit": "389e8c598189e6002af6f17819d42235b600767c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "abfdc3c154cb504d148c81a42ef2b63ddd859ffd", "url": "https://github.com/apache/iotdb/commit/abfdc3c154cb504d148c81a42ef2b63ddd859ffd", "message": "modify getNodesList", "committedDate": "2020-04-15T12:59:01Z", "type": "commit"}, {"oid": "252fe9d7409b9898fb3dfc51ec2f20e3f09dac29", "url": "https://github.com/apache/iotdb/commit/252fe9d7409b9898fb3dfc51ec2f20e3f09dac29", "message": "robust", "committedDate": "2020-04-15T13:35:35Z", "type": "commit"}, {"oid": "242f1a1276092eadd45ff1b9396c5fb8ca92b68d", "url": "https://github.com/apache/iotdb/commit/242f1a1276092eadd45ff1b9396c5fb8ca92b68d", "message": "remove empty lines", "committedDate": "2020-04-15T13:40:51Z", "type": "commit"}, {"oid": "3b7bbd3dea63de1d2826147c7e9175c695d7a01c", "url": "https://github.com/apache/iotdb/commit/3b7bbd3dea63de1d2826147c7e9175c695d7a01c", "message": "add comparator in concurrent class", "committedDate": "2020-04-16T16:46:35Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTk3MzEyOQ==", "url": "https://github.com/apache/iotdb/pull/1051#discussion_r409973129", "bodyText": "Local groups are the groups that the local node is in and they do not necessarily cover all groups. For example, if replica number is 2, and there are 4 nodes 1,2,3,4 the local groups of 1 will only be [4,1] and [1,2].", "author": "jt2594838", "createdAt": "2020-04-17T03:34:13Z", "path": "cluster/src/main/java/org/apache/iotdb/cluster/query/ClusterPlanExecutor.java", "diffHunk": "@@ -81,22 +99,172 @@ public QueryDataSet processQuery(PhysicalPlan queryPlan, QueryContext context)\n   }\n \n   @Override\n-  protected List<String> getNodesList(String schemaPattern, int level) {\n-    // TODO-Cluster: enable meta queries\n-    throw new UnsupportedOperationException(\"Not implemented\");\n-    //return metaGroupMember.getNodeList(schemaPattern, level);\n+  protected List<String> getNodesList(String schemaPattern, int level)\n+      throws IOException, TException, InterruptedException, MetadataException {\n+    ConcurrentSkipListSet<String> nodeSet = new ConcurrentSkipListSet<>(\n+        MManager.getInstance().getNodesList(schemaPattern, level));\n+\n+    ExecutorService pool = new ScheduledThreadPoolExecutor(THREAD_POOL_SIZE);\n+\n+    for (PartitionGroup group : metaGroupMember.getPartitionTable().getLocalGroups()) {", "originalCommit": "3b7bbd3dea63de1d2826147c7e9175c695d7a01c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDA2MjcxMg==", "url": "https://github.com/apache/iotdb/pull/1051#discussion_r410062712", "bodyText": "That's right. Thanks for your reminding.", "author": "Ring-k", "createdAt": "2020-04-17T08:11:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTk3MzEyOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTk3NDEwNQ==", "url": "https://github.com/apache/iotdb/pull/1051#discussion_r409974105", "bodyText": "It would be better to leave a log here if you fail to get result from all nodes in the group.", "author": "jt2594838", "createdAt": "2020-04-17T03:38:20Z", "path": "cluster/src/main/java/org/apache/iotdb/cluster/query/ClusterPlanExecutor.java", "diffHunk": "@@ -81,22 +99,172 @@ public QueryDataSet processQuery(PhysicalPlan queryPlan, QueryContext context)\n   }\n \n   @Override\n-  protected List<String> getNodesList(String schemaPattern, int level) {\n-    // TODO-Cluster: enable meta queries\n-    throw new UnsupportedOperationException(\"Not implemented\");\n-    //return metaGroupMember.getNodeList(schemaPattern, level);\n+  protected List<String> getNodesList(String schemaPattern, int level)\n+      throws IOException, TException, InterruptedException, MetadataException {\n+    ConcurrentSkipListSet<String> nodeSet = new ConcurrentSkipListSet<>(\n+        MManager.getInstance().getNodesList(schemaPattern, level));\n+\n+    ExecutorService pool = new ScheduledThreadPoolExecutor(THREAD_POOL_SIZE);\n+\n+    for (PartitionGroup group : metaGroupMember.getPartitionTable().getLocalGroups()) {\n+      Node header = group.getHeader();\n+      if (header.equals(metaGroupMember.getThisNode())) {\n+        continue;\n+      }\n+      pool.submit(() -> {\n+        GetNodesListHandler handler = new GetNodesListHandler();\n+        AtomicReference<List<String>> response = new AtomicReference<>(null);\n+        handler.setResponse(response);\n+\n+        for (Node node : group) {\n+          try {\n+            DataClient client = metaGroupMember.getDataClient(node);\n+            handler.setContact(node);\n+            synchronized (response) {\n+              if (client != null) {\n+                client.getNodeList(header, schemaPattern, level, handler);\n+                response.wait(connectionTimeoutInMS);\n+              }\n+            }\n+            List<String> paths = response.get();\n+            if (paths != null) {\n+              nodeSet.addAll(paths);\n+              break;\n+            }\n+          } catch (IOException e) {\n+            logger.error(\"Failed to connect to node: {}\", node, e);\n+          } catch (TException e) {\n+            logger.error(\"Error occurs when getting node lists in node {}.\", node, e);\n+          } catch (InterruptedException e) {\n+            logger.error(\"Interrupted when getting node lists in node {}.\", node, e);\n+            Thread.currentThread().interrupt();\n+          }\n+        }", "originalCommit": "3b7bbd3dea63de1d2826147c7e9175c695d7a01c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDA2Mjg5Mw==", "url": "https://github.com/apache/iotdb/pull/1051#discussion_r410062893", "bodyText": "Yes, it would be more clear.", "author": "Ring-k", "createdAt": "2020-04-17T08:11:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTk3NDEwNQ=="}], "type": "inlineReview"}, {"oid": "56aaa6a9375deaab686c143770095c40e0200098", "url": "https://github.com/apache/iotdb/commit/56aaa6a9375deaab686c143770095c40e0200098", "message": "add get global groups", "committedDate": "2020-04-17T07:30:06Z", "type": "commit"}, {"oid": "dc1bfee0cff0e181034d6d95a6ed962953bd559e", "url": "https://github.com/apache/iotdb/commit/dc1bfee0cff0e181034d6d95a6ed962953bd559e", "message": "add log when failed to connect the group", "committedDate": "2020-04-17T07:37:33Z", "type": "commit"}, {"oid": "0b7221e36dcb2ba70348b2acbf84c80ca9953765", "url": "https://github.com/apache/iotdb/commit/0b7221e36dcb2ba70348b2acbf84c80ca9953765", "message": "fix conflict", "committedDate": "2020-04-17T07:50:43Z", "type": "commit"}, {"oid": "a59140cf4b4cb21382b6f8666ccc6cb022cc4ea4", "url": "https://github.com/apache/iotdb/commit/a59140cf4b4cb21382b6f8666ccc6cb022cc4ea4", "message": "fix test", "committedDate": "2020-04-17T08:00:20Z", "type": "commit"}]}