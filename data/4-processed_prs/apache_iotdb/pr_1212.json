{"pr_number": 1212, "pr_title": "[IOTDB-680] Make LRUCache more accurate", "pr_createdAt": "2020-05-15T07:51:35Z", "pr_url": "https://github.com/apache/iotdb/pull/1212", "timeline": [{"oid": "03a6b58566eac33b1a5a12fa1e1fe8ffdbc03775", "url": "https://github.com/apache/iotdb/commit/03a6b58566eac33b1a5a12fa1e1fe8ffdbc03775", "message": "change LRU", "committedDate": "2020-05-13T14:51:18Z", "type": "commit"}, {"oid": "4d63322f4df893d1bdfef0e4a3fb29094a361725", "url": "https://github.com/apache/iotdb/commit/4d63322f4df893d1bdfef0e4a3fb29094a361725", "message": "refactor lru", "committedDate": "2020-05-14T06:37:08Z", "type": "commit"}, {"oid": "2bb91f50c8630ff5a362ea9717d08f7acd047c49", "url": "https://github.com/apache/iotdb/commit/2bb91f50c8630ff5a362ea9717d08f7acd047c49", "message": "final version", "committedDate": "2020-05-15T06:39:23Z", "type": "commit"}, {"oid": "4c5706ee8132c75c375f5e946dcf4af6e2c16507", "url": "https://github.com/apache/iotdb/commit/4c5706ee8132c75c375f5e946dcf4af6e2c16507", "message": "finish", "committedDate": "2020-05-15T07:31:07Z", "type": "commit"}, {"oid": "4469f182984c18955f4ee65f3247fa44b2cce4a7", "url": "https://github.com/apache/iotdb/commit/4469f182984c18955f4ee65f3247fa44b2cce4a7", "message": "license", "committedDate": "2020-05-15T09:20:54Z", "type": "commit"}, {"oid": "8814f05585bc0d1d934543f7efd44b16ee42026a", "url": "https://github.com/apache/iotdb/commit/8814f05585bc0d1d934543f7efd44b16ee42026a", "message": "add some comments", "committedDate": "2020-05-15T12:43:30Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTc3NTUyMw==", "url": "https://github.com/apache/iotdb/pull/1212#discussion_r425775523", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              private long RAMSize;\n          \n          \n            \n              private long ramSize;", "author": "qiaojialin", "createdAt": "2020-05-15T12:44:15Z", "path": "server/src/main/java/org/apache/iotdb/db/engine/cache/AccountableString.java", "diffHunk": "@@ -0,0 +1,63 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.iotdb.db.engine.cache;\n+\n+import java.util.Objects;\n+import org.apache.iotdb.tsfile.common.cache.Accountable;\n+\n+public class AccountableString implements Accountable {\n+\n+  private final String string;\n+  private long RAMSize;", "originalCommit": "8814f05585bc0d1d934543f7efd44b16ee42026a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTc3NjkzMA==", "url": "https://github.com/apache/iotdb/pull/1212#discussion_r425776930", "bodyText": "This may be not enough, it also has a statistics, in which different data type may have different occupation, especially the TEXT type.", "author": "qiaojialin", "createdAt": "2020-05-15T12:46:45Z", "path": "server/src/main/java/org/apache/iotdb/db/engine/cache/ChunkMetadataCache.java", "diffHunk": "@@ -47,45 +47,55 @@\n   private static final Logger logger = LoggerFactory.getLogger(ChunkMetadataCache.class);\n   private static final IoTDBConfig config = IoTDBDescriptor.getInstance().getConfig();\n   private static final long MEMORY_THRESHOLD_IN_B = config.getAllocateMemoryForChunkMetaDataCache();\n-  private static boolean cacheEnable = config.isMetaDataCacheEnable();\n+  private static final boolean cacheEnable = config.isMetaDataCacheEnable();\n+  private static final long CHUNK_METADATA_FIXED_RAM_SIZE = 160;\n+\n   /**\n    * key: file path dot deviceId dot sensorId.\n    * <p>\n    * value: chunkMetaData list of one timeseries in the file.\n    */\n-  private final LRULinkedHashMap<String, List<ChunkMetadata>> lruCache;\n+  private final LRULinkedHashMap<AccountableString, List<ChunkMetadata>> lruCache;\n \n   private final ReadWriteLock lock = new ReentrantReadWriteLock();\n \n-  private AtomicLong cacheHitNum = new AtomicLong();\n-  private AtomicLong cacheRequestNum = new AtomicLong();\n+  private final AtomicLong cacheHitNum = new AtomicLong();\n+  private final AtomicLong cacheRequestNum = new AtomicLong();\n \n \n   private ChunkMetadataCache(long memoryThreshold) {\n     if (cacheEnable) {\n       logger.info(\"ChunkMetadataCache size = \" + memoryThreshold);\n     }\n-    lruCache = new LRULinkedHashMap<String, List<ChunkMetadata>>(memoryThreshold, true) {\n+    lruCache = new LRULinkedHashMap<AccountableString, List<ChunkMetadata>>(memoryThreshold) {\n       @Override\n-      protected long calEntrySize(String key, List<ChunkMetadata> value) {\n+      protected long calEntrySize(AccountableString key, List<ChunkMetadata> value) {\n         if (value.isEmpty()) {\n-          return key.getBytes().length + averageSize * value.size();\n+          return RamUsageEstimator.sizeOf(key) + RamUsageEstimator.shallowSizeOf(value);\n         }\n+        long entrySize;\n         if (count < 10) {\n-          long currentSize = RamUsageEstimator.shallowSizeOf(value.get(0)) + RamUsageEstimator\n-              .shallowSizeOf(value.get(0).getStatistics());\n+          long currentSize = CHUNK_METADATA_FIXED_RAM_SIZE + RamUsageEstimator", "originalCommit": "8814f05585bc0d1d934543f7efd44b16ee42026a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTc3ODg0Mw==", "url": "https://github.com/apache/iotdb/pull/1212#discussion_r425778843", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private long RAMSize;\n          \n          \n            \n                private long ramSize;", "author": "qiaojialin", "createdAt": "2020-05-15T12:50:10Z", "path": "server/src/main/java/org/apache/iotdb/db/engine/cache/TimeSeriesMetadataCache.java", "diffHunk": "@@ -198,11 +206,14 @@ public void remove(TimeSeriesMetadataCacheKey key) {\n     lock.writeLock().unlock();\n   }\n \n-  public static class TimeSeriesMetadataCacheKey {\n+  public static class TimeSeriesMetadataCacheKey implements Accountable {\n+\n+    private final String filePath;\n+    private final String device;\n+    private final String measurement;\n+\n+    private long RAMSize;", "originalCommit": "8814f05585bc0d1d934543f7efd44b16ee42026a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTc4MDAwNQ==", "url": "https://github.com/apache/iotdb/pull/1212#discussion_r425780005", "bodyText": "As we already replace the reader by resource, do we need to copy?\nBut the resource may be also removed from memory, so copy is fine...", "author": "qiaojialin", "createdAt": "2020-05-15T12:52:27Z", "path": "server/src/main/java/org/apache/iotdb/db/engine/cache/TimeSeriesMetadataCache.java", "diffHunk": "@@ -134,7 +142,7 @@ public TimeseriesMetadata get(TimeSeriesMetadataCacheKey key, Set<String> allSen\n       timeSeriesMetadataList.forEach(timeseriesMetadata ->\n           lruCache.put(new TimeSeriesMetadataCacheKey(key.filePath, key.device,\n               timeseriesMetadata.getMeasurementId()), timeseriesMetadata));\n-      return lruCache.get(key);\n+      return new TimeseriesMetadata(lruCache.get(key));", "originalCommit": "8814f05585bc0d1d934543f7efd44b16ee42026a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "d4c3fd2f3aa0f5acbd76ebe5d552b6f1cd3d1567", "url": "https://github.com/apache/iotdb/commit/d4c3fd2f3aa0f5acbd76ebe5d552b6f1cd3d1567", "message": "change calculation of statistics", "committedDate": "2020-05-17T03:16:47Z", "type": "commit"}, {"oid": "6e5146e51c7671ac5170b13c5ac9a3c6e96f81a1", "url": "https://github.com/apache/iotdb/commit/6e5146e51c7671ac5170b13c5ac9a3c6e96f81a1", "message": "remove boxing in RamUsageEstimator", "committedDate": "2020-05-17T05:47:44Z", "type": "commit"}, {"oid": "f470e02efdcc04dc135b72c91f82bb2937861e85", "url": "https://github.com/apache/iotdb/commit/f470e02efdcc04dc135b72c91f82bb2937861e85", "message": "rename RAMSize to ramSize", "committedDate": "2020-05-17T05:49:46Z", "type": "commit"}, {"oid": "64b23eeeb9e95d0c2e12de798a42b4f0e16e8ec7", "url": "https://github.com/apache/iotdb/commit/64b23eeeb9e95d0c2e12de798a42b4f0e16e8ec7", "message": "fix sonar", "committedDate": "2020-05-17T06:48:02Z", "type": "commit"}]}