{"pr_number": 1112, "pr_title": "[IOTDB-354] Implement batch append entries", "pr_createdAt": "2020-04-28T08:52:35Z", "pr_url": "https://github.com/apache/iotdb/pull/1112", "timeline": [{"oid": "b21730ee75ea529e4d872be639b2f1a4f0cc1bb3", "url": "https://github.com/apache/iotdb/commit/b21730ee75ea529e4d872be639b2f1a4f0cc1bb3", "message": "add log batch append", "committedDate": "2020-03-24T06:31:43Z", "type": "commit"}, {"oid": "d269c65b54c380fa8772e8f3f18d9a0d7f3b17c0", "url": "https://github.com/apache/iotdb/commit/d269c65b54c380fa8772e8f3f18d9a0d7f3b17c0", "message": "fix bugs", "committedDate": "2020-03-24T06:49:52Z", "type": "commit"}, {"oid": "737c944e2959465cb77f92319d587faff2c8979f", "url": "https://github.com/apache/iotdb/commit/737c944e2959465cb77f92319d587faff2c8979f", "message": "Add license", "committedDate": "2020-03-31T01:12:21Z", "type": "commit"}, {"oid": "5e3a64cfaae9b597cd0ed390e987fb96d2201aa9", "url": "https://github.com/apache/iotdb/commit/5e3a64cfaae9b597cd0ed390e987fb96d2201aa9", "message": "Merge branch 'cluster_new' of https://github.com/apache/incubator-iotdb into IOTDB-354-Implement-batch-append-entries\n\n# Conflicts:\n#\tcluster/src/main/java/org/apache/iotdb/cluster/server/member/RaftMember.java", "committedDate": "2020-04-10T09:28:33Z", "type": "commit"}, {"oid": "a625068b820adbb7a809606c4b4b6c8860a23658", "url": "https://github.com/apache/iotdb/commit/a625068b820adbb7a809606c4b4b6c8860a23658", "message": "Merge branch 'cluster_new' of https://github.com/apache/incubator-iotdb into IOTDB-354-Implement-batch-append-entries\n\n# Conflicts:\n#\tcluster/src/main/java/org/apache/iotdb/cluster/query/ClusterFillExecutor.java", "committedDate": "2020-04-15T01:13:07Z", "type": "commit"}, {"oid": "c6ce58f4b673f3dc02b979a99ceefc9dd4b8af35", "url": "https://github.com/apache/iotdb/commit/c6ce58f4b673f3dc02b979a99ceefc9dd4b8af35", "message": "Merge branch 'cluster_new' of https://github.com/apache/incubator-iotdb into IOTDB-354-Implement-batch-append-entries", "committedDate": "2020-04-17T01:01:25Z", "type": "commit"}, {"oid": "117e030219a246e983a73dbe7d303253211dd14f", "url": "https://github.com/apache/iotdb/commit/117e030219a246e983a73dbe7d303253211dd14f", "message": "Merge branch 'cluster_new' of https://github.com/apache/incubator-iotdb into IOTDB-354-Implement-batch-append-entries\n\n# Conflicts:\n#\tcluster/src/main/java/org/apache/iotdb/cluster/server/member/RaftMember.java", "committedDate": "2020-04-27T01:42:32Z", "type": "commit"}, {"oid": "9fc4d053a67e9f9e14533691c18875ac005220a1", "url": "https://github.com/apache/iotdb/commit/9fc4d053a67e9f9e14533691c18875ac005220a1", "message": "merge", "committedDate": "2020-04-28T08:51:38Z", "type": "commit"}, {"oid": "213e38a6b3f01b56b46112e8179a83efe3578053", "url": "https://github.com/apache/iotdb/commit/213e38a6b3f01b56b46112e8179a83efe3578053", "message": "merge", "committedDate": "2020-04-29T06:57:28Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzE2ODMwMg==", "url": "https://github.com/apache/iotdb/pull/1112#discussion_r417168302", "bodyText": "The class is moved to another package and modified, you should remove it.", "author": "jt2594838", "createdAt": "2020-04-29T09:02:17Z", "path": "cluster/src/main/java/org/apache/iotdb/cluster/query/ClusterFillExecutor.java", "diffHunk": "@@ -0,0 +1,56 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.iotdb.cluster.query;\n+\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Set;\n+import org.apache.iotdb.cluster.server.member.MetaGroupMember;\n+import org.apache.iotdb.db.exception.StorageEngineException;\n+import org.apache.iotdb.db.query.context.QueryContext;\n+import org.apache.iotdb.db.query.executor.FillQueryExecutor;\n+import org.apache.iotdb.db.query.fill.IFill;\n+import org.apache.iotdb.tsfile.file.metadata.enums.TSDataType;\n+import org.apache.iotdb.tsfile.read.common.Path;\n+\n+public class ClusterFillExecutor extends FillQueryExecutor {", "originalCommit": "213e38a6b3f01b56b46112e8179a83efe3578053", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzE5NzU5Nw==", "url": "https://github.com/apache/iotdb/pull/1112#discussion_r417197597", "bodyText": "Sure. I will fix it~", "author": "SilverNarcissus", "createdAt": "2020-04-29T09:55:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzE2ODMwMg=="}], "type": "inlineReview"}, {"oid": "f4eab24696a232cf667df7bfee8c45d745f0ab37", "url": "https://github.com/apache/iotdb/commit/f4eab24696a232cf667df7bfee8c45d745f0ab37", "message": "Merge branch 'cluster_new' of https://github.com/apache/incubator-iotdb into IOTDB-354-Implement-batch-append-entries\n\n# Conflicts:\n#\tcluster/src/main/java/org/apache/iotdb/cluster/server/member/RaftMember.java", "committedDate": "2020-04-29T09:55:00Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzIyOTMyMw==", "url": "https://github.com/apache/iotdb/pull/1112#discussion_r417229323", "bodyText": "I've found that this way of appendEntries has a high concurrency bug, this is the fix document. Please refer to function appendEntry's implementation.", "author": "LebronAl", "createdAt": "2020-04-29T10:56:53Z", "path": "cluster/src/main/java/org/apache/iotdb/cluster/server/member/RaftMember.java", "diffHunk": "@@ -384,7 +385,89 @@ public void appendEntry(AppendEntryRequest request, AsyncMethodCallback resultHa\n \n   @Override\n   public void appendEntries(AppendEntriesRequest request, AsyncMethodCallback resultHandler) {\n-    //TODO-Cluster#354: implement\n+    logger.debug(\"{} received an AppendEntriesRequest\", name);\n+\n+    // the term checked here is that of the leader, not that of the log\n+    if (!checkRequestTerm(request, resultHandler)) {\n+      return;\n+    }\n+\n+    try {\n+      long response = 0;\n+      List<Log> logs = new ArrayList<>();\n+      for (ByteBuffer buffer : request.getEntries()) {\n+        Log log = LogParser.getINSTANCE().parse(buffer);\n+        logs.add(log);\n+      }\n+\n+      response = appendEntries(logs);\n+      resultHandler.onComplete(response);\n+      logger.debug(\"{} AppendEntriesRequest of log size {} completed\", name,\n+          request.getEntries().size());\n+    } catch (UnknownLogTypeException e) {\n+      resultHandler.onError(e);\n+    }\n+  }\n+\n+  /**\n+   * Find the local previous log of \"log\". If such log is found, discard all local logs behind it\n+   * and append \"log\" to it. Otherwise report a log mismatch.\n+   *\n+   * @param logs\n+   * @return Response.RESPONSE_AGREE when the log is successfully appended or Response\n+   * .RESPONSE_LOG_MISMATCH if the previous log of \"log\" is not found.\n+   */\n+  private long appendEntries(List<Log> logs) {", "originalCommit": "f4eab24696a232cf667df7bfee8c45d745f0ab37", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzIzNzk2NQ==", "url": "https://github.com/apache/iotdb/pull/1112#discussion_r417237965", "bodyText": "I guess LebronAl is talking about the chance that the logs are disjoint with the local last log, but as appendEntries is only used in catch-up, I think the possibility of that case is relatively low.\nStill, it would be better to check the index of the first coming log and the last local log, which I previously hoped to be done inside the LogManager. As you can see, other users may not bother to do the checks (the may not know the checks actually), so any necessary checks are better to be done within underlined classes.", "author": "jt2594838", "createdAt": "2020-04-29T11:14:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzIyOTMyMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzI4NTAwMw==", "url": "https://github.com/apache/iotdb/pull/1112#discussion_r417285003", "bodyText": "Actually,I used to think that the interface raftLogManager exposed to followers to append logs was maybeAppend, and in that function we can handle this check, but now appendEntry's RPC doesn't have lastLogTerm, lastLogIndex, leaderCommit. So i have to use append . This is indeed a not very good implementation, let me solve it.\nSo now we can either add some fields to the appendEntry rpc to support the use of maybeAppend, or we can do this check inside append. What's your opinion?", "author": "LebronAl", "createdAt": "2020-04-29T12:44:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzIyOTMyMw=="}], "type": "inlineReview"}, {"oid": "227868f37dfbfa94ab123dc8999f7b21e6cd5129", "url": "https://github.com/apache/iotdb/commit/227868f37dfbfa94ab123dc8999f7b21e6cd5129", "message": "Merge branch 'cluster_new' of https://github.com/apache/incubator-iotdb into IOTDB-354-Implement-batch-append-entries", "committedDate": "2020-04-29T11:20:40Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzcxNjc1MQ==", "url": "https://github.com/apache/iotdb/pull/1112#discussion_r417716751", "bodyText": "I think maybe it's better to make useBatch a configuration item instead of calling it manually every time", "author": "LebronAl", "createdAt": "2020-04-30T02:15:48Z", "path": "cluster/src/main/java/org/apache/iotdb/cluster/log/catchup/LogCatchUpTask.java", "diffHunk": "@@ -39,17 +43,25 @@\n public class LogCatchUpTask implements Runnable {\n \n   private static final Logger logger = LoggerFactory.getLogger(LogCatchUpTask.class);\n-\n-  private List<Log> logs;\n+  private static final int LOG_NUM_IN_BATCH = 128;\n   Node node;\n   RaftMember raftMember;\n+  private List<Log> logs;\n+  private boolean useBatch = false;\n \n   public LogCatchUpTask(List<Log> logs, Node node, RaftMember raftMember) {\n     this.logs = logs;\n     this.node = node;\n     this.raftMember = raftMember;\n   }\n \n+  public LogCatchUpTask(List<Log> logs, Node node, RaftMember raftMember, boolean useBatch) {", "originalCommit": "227868f37dfbfa94ab123dc8999f7b21e6cd5129", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDQ5MzIxOQ==", "url": "https://github.com/apache/iotdb/pull/1112#discussion_r420493219", "bodyText": "Sure, I will fix it", "author": "SilverNarcissus", "createdAt": "2020-05-06T01:01:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzcxNjc1MQ=="}], "type": "inlineReview"}, {"oid": "c104653806d2bc0fb358ff52d204ebed87d77358", "url": "https://github.com/apache/iotdb/commit/c104653806d2bc0fb358ff52d204ebed87d77358", "message": "fix concurrency bug", "committedDate": "2020-05-01T02:55:20Z", "type": "commit"}, {"oid": "41505edaf499ce9c87eb6a8e8645dcf391c32637", "url": "https://github.com/apache/iotdb/commit/41505edaf499ce9c87eb6a8e8645dcf391c32637", "message": "change use batch as a config", "committedDate": "2020-05-06T01:28:25Z", "type": "commit"}, {"oid": "ff6f79fa373dd1decf536e4bf5e97ee0242f2978", "url": "https://github.com/apache/iotdb/commit/ff6f79fa373dd1decf536e4bf5e97ee0242f2978", "message": "Merge branch 'cluster_new' into IOTDB-354-Implement-batch-append-entries", "committedDate": "2020-05-06T01:40:23Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDUwMzgyMw==", "url": "https://github.com/apache/iotdb/pull/1112#discussion_r420503823", "bodyText": "LebronAl has now provided a safer method called maybeAppendBatch in RaftLogManager, please switch to that and check the return value.", "author": "jt2594838", "createdAt": "2020-05-06T01:46:15Z", "path": "cluster/src/main/java/org/apache/iotdb/cluster/server/member/RaftMember.java", "diffHunk": "@@ -398,7 +399,92 @@ public void appendEntry(AppendEntryRequest request, AsyncMethodCallback resultHa\n \n   @Override\n   public void appendEntries(AppendEntriesRequest request, AsyncMethodCallback resultHandler) {\n-    //TODO-Cluster#354: implement\n+    logger.debug(\"{} received an AppendEntriesRequest\", name);\n+\n+    // the term checked here is that of the leader, not that of the log\n+    if (!checkRequestTerm(request, resultHandler)) {\n+      return;\n+    }\n+\n+    try {\n+      long response = 0;\n+      List<Log> logs = new ArrayList<>();\n+      for (ByteBuffer buffer : request.getEntries()) {\n+        Log log = LogParser.getINSTANCE().parse(buffer);\n+        logs.add(log);\n+      }\n+\n+      response = appendEntries(logs);\n+      resultHandler.onComplete(response);\n+      logger.debug(\"{} AppendEntriesRequest of log size {} completed\", name,\n+          request.getEntries().size());\n+    } catch (UnknownLogTypeException e) {\n+      resultHandler.onError(e);\n+    }\n+  }\n+\n+  /**\n+   * Find the local previous log of \"log\". If such log is found, discard all local logs behind it\n+   * and append \"log\" to it. Otherwise report a log mismatch.\n+   *\n+   * @param logs\n+   * @return Response.RESPONSE_AGREE when the log is successfully appended or Response\n+   * .RESPONSE_LOG_MISMATCH if the previous log of \"log\" is not found.\n+   */\n+  private long appendEntries(List<Log> logs) {\n+    if (logs.isEmpty()) {\n+      return Response.RESPONSE_AGREE;\n+    }\n+\n+    long resp;\n+    synchronized (logManager) {\n+      if (logs.get(0).getCurrLogIndex() > logManager.getLastLogIndex() + 1) {\n+        // the incoming log points to an illegal position, reject it\n+        resp = Response.RESPONSE_LOG_MISMATCH;\n+      } else {\n+        logManager.append(logs);", "originalCommit": "ff6f79fa373dd1decf536e4bf5e97ee0242f2978", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDc1MDA1MA==", "url": "https://github.com/apache/iotdb/pull/1112#discussion_r420750050", "bodyText": "Fine~ Fixed~", "author": "SilverNarcissus", "createdAt": "2020-05-06T12:27:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDUwMzgyMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDUwNDM2OQ==", "url": "https://github.com/apache/iotdb/pull/1112#discussion_r420504369", "bodyText": "The implementation of checkRequestTerm for AppendEntryRequest has been changed slightly, so please see to it and make necessary modifications.\nBy the way, the log message should use AppendEntriesRequest here instead of AppendEntriesRequest.", "author": "jt2594838", "createdAt": "2020-05-06T01:48:51Z", "path": "cluster/src/main/java/org/apache/iotdb/cluster/server/member/RaftMember.java", "diffHunk": "@@ -398,7 +399,92 @@ public void appendEntry(AppendEntryRequest request, AsyncMethodCallback resultHa\n \n   @Override\n   public void appendEntries(AppendEntriesRequest request, AsyncMethodCallback resultHandler) {\n-    //TODO-Cluster#354: implement\n+    logger.debug(\"{} received an AppendEntriesRequest\", name);\n+\n+    // the term checked here is that of the leader, not that of the log\n+    if (!checkRequestTerm(request, resultHandler)) {\n+      return;\n+    }\n+\n+    try {\n+      long response = 0;\n+      List<Log> logs = new ArrayList<>();\n+      for (ByteBuffer buffer : request.getEntries()) {\n+        Log log = LogParser.getINSTANCE().parse(buffer);\n+        logs.add(log);\n+      }\n+\n+      response = appendEntries(logs);\n+      resultHandler.onComplete(response);\n+      logger.debug(\"{} AppendEntriesRequest of log size {} completed\", name,\n+          request.getEntries().size());\n+    } catch (UnknownLogTypeException e) {\n+      resultHandler.onError(e);\n+    }\n+  }\n+\n+  /**\n+   * Find the local previous log of \"log\". If such log is found, discard all local logs behind it\n+   * and append \"log\" to it. Otherwise report a log mismatch.\n+   *\n+   * @param logs\n+   * @return Response.RESPONSE_AGREE when the log is successfully appended or Response\n+   * .RESPONSE_LOG_MISMATCH if the previous log of \"log\" is not found.\n+   */\n+  private long appendEntries(List<Log> logs) {\n+    if (logs.isEmpty()) {\n+      return Response.RESPONSE_AGREE;\n+    }\n+\n+    long resp;\n+    synchronized (logManager) {\n+      if (logs.get(0).getCurrLogIndex() > logManager.getLastLogIndex() + 1) {\n+        // the incoming log points to an illegal position, reject it\n+        resp = Response.RESPONSE_LOG_MISMATCH;\n+      } else {\n+        logManager.append(logs);\n+        if (logger.isDebugEnabled()) {\n+          logger.debug(\"{} append new logs list {}\", name, logs);\n+        }\n+        resp = Response.RESPONSE_AGREE;\n+      }\n+    }\n+    return resp;\n+  }\n+\n+  /**\n+   * Check the term of the AppendEntryRequest. The term checked is the term of the leader, not the\n+   * term of the log. A new leader can still send logs of old leaders.\n+   *\n+   * @param request\n+   * @param resultHandler if the term is illegal, the \"resultHandler\" will be invoked so the caller\n+   *                      does not need to invoke it again\n+   * @return true if the term is legal, false otherwise\n+   */\n+  private boolean checkRequestTerm(AppendEntriesRequest request,\n+      AsyncMethodCallback resultHandler) {\n+    long leaderTerm = request.getTerm();\n+    long localTerm;\n+\n+    synchronized (term) {\n+      // if the request comes before the heartbeat arrives, the local term may be smaller than the\n+      // leader term\n+      localTerm = term.get();\n+      if (leaderTerm < localTerm) {\n+        logger.debug(\"{} rejected the AppendEntryRequest for term: {}/{}\", name, leaderTerm,", "originalCommit": "ff6f79fa373dd1decf536e4bf5e97ee0242f2978", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDc1MDAxNQ==", "url": "https://github.com/apache/iotdb/pull/1112#discussion_r420750015", "bodyText": "Fixed~", "author": "SilverNarcissus", "createdAt": "2020-05-06T12:27:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDUwNDM2OQ=="}], "type": "inlineReview"}, {"oid": "0debba40a289d23608b0255270c07ac985bf86ff", "url": "https://github.com/apache/iotdb/commit/0debba40a289d23608b0255270c07ac985bf86ff", "message": "Merge branch 'cluster_new' of https://github.com/apache/incubator-iotdb into IOTDB-354-Implement-batch-append-entries\n\n# Conflicts:\n#\tcluster/src/main/java/org/apache/iotdb/cluster/server/member/RaftMember.java", "committedDate": "2020-05-06T12:36:59Z", "type": "commit"}, {"oid": "d060a6c4c7873823b01307e9d13be95794d04585", "url": "https://github.com/apache/iotdb/commit/d060a6c4c7873823b01307e9d13be95794d04585", "message": "Merge branch 'IOTDB-354-Implement-batch-append-entries' of https://github.com/SilverNarcissus/incubator-iotdb into IOTDB-354-Implement-batch-append-entries", "committedDate": "2020-05-06T12:41:07Z", "type": "commit"}]}