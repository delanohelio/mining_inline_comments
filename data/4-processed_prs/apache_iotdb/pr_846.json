{"pr_number": 846, "pr_title": "[IOTDB-512] file reader close bug", "pr_createdAt": "2020-02-26T13:12:48Z", "pr_url": "https://github.com/apache/iotdb/pull/846", "timeline": [{"oid": "7b874d9f1e752de8bb3ae014d85a062dfcc08608", "url": "https://github.com/apache/iotdb/commit/7b874d9f1e752de8bb3ae014d85a062dfcc08608", "message": "add more logs", "committedDate": "2020-02-24T12:47:23Z", "type": "commit"}, {"oid": "ffc64df3a220a9291fe83c8f833390efa05ca629", "url": "https://github.com/apache/iotdb/commit/ffc64df3a220a9291fe83c8f833390efa05ca629", "message": "add close reason log", "committedDate": "2020-02-24T14:59:34Z", "type": "commit"}, {"oid": "b40f446acc7e667957d553b6da74af1d1647a663", "url": "https://github.com/apache/iotdb/commit/b40f446acc7e667957d553b6da74af1d1647a663", "message": "PrintAllStackInfo while calling close()", "committedDate": "2020-02-25T01:56:51Z", "type": "commit"}, {"oid": "bd7944d1b6f0320c3232352309319e43a23ef252", "url": "https://github.com/apache/iotdb/commit/bd7944d1b6f0320c3232352309319e43a23ef252", "message": "change some remove", "committedDate": "2020-02-25T07:53:53Z", "type": "commit"}, {"oid": "318763575d9da8066f9ddd13c7dba3a850d3b85f", "url": "https://github.com/apache/iotdb/commit/318763575d9da8066f9ddd13c7dba3a850d3b85f", "message": "more logs", "committedDate": "2020-02-25T11:52:03Z", "type": "commit"}, {"oid": "7c5f8a263fdc59d270523f795f7eb7d8f6560c94", "url": "https://github.com/apache/iotdb/commit/7c5f8a263fdc59d270523f795f7eb7d8f6560c94", "message": "delete useless logs", "committedDate": "2020-02-25T12:28:52Z", "type": "commit"}, {"oid": "8413a613ff20dbfd37ea88f5297b9ee1eae0d5fe", "url": "https://github.com/apache/iotdb/commit/8413a613ff20dbfd37ea88f5297b9ee1eae0d5fe", "message": "add reopen operation", "committedDate": "2020-02-25T12:34:18Z", "type": "commit"}, {"oid": "5ba9fe508b6a2984f296328894856e8a7abfaace", "url": "https://github.com/apache/iotdb/commit/5ba9fe508b6a2984f296328894856e8a7abfaace", "message": "s", "committedDate": "2020-02-25T13:24:11Z", "type": "commit"}, {"oid": "e1b41e8b870203e0982d8b0d42c2f8a9550967e4", "url": "https://github.com/apache/iotdb/commit/e1b41e8b870203e0982d8b0d42c2f8a9550967e4", "message": "prove", "committedDate": "2020-02-26T07:40:05Z", "type": "commit"}, {"oid": "8edcfd94cbdd56f28314e5c837989d3b627dce36", "url": "https://github.com/apache/iotdb/commit/8edcfd94cbdd56f28314e5c837989d3b627dce36", "message": "add count print", "committedDate": "2020-02-26T08:50:06Z", "type": "commit"}, {"oid": "962ebe9b37df8b2ec4113c94b3d8e92fae6f8165", "url": "https://github.com/apache/iotdb/commit/962ebe9b37df8b2ec4113c94b3d8e92fae6f8165", "message": "final bug", "committedDate": "2020-02-26T13:08:26Z", "type": "commit"}, {"oid": "0fe2210a9c1a025d40f064220b8aa288749cf392", "url": "https://github.com/apache/iotdb/commit/0fe2210a9c1a025d40f064220b8aa288749cf392", "message": "delete some useless change", "committedDate": "2020-02-26T13:14:43Z", "type": "commit"}, {"oid": "550a0ef577cc609ef36373a89cd36ec76efc8e1e", "url": "https://github.com/apache/iotdb/commit/550a0ef577cc609ef36373a89cd36ec76efc8e1e", "message": "try finally", "committedDate": "2020-02-26T13:29:24Z", "type": "commit"}, {"oid": "a13aa85df18c265019a874523abc6b669ff11613", "url": "https://github.com/apache/iotdb/commit/a13aa85df18c265019a874523abc6b669ff11613", "message": "add catch", "committedDate": "2020-02-26T13:32:22Z", "type": "commit"}, {"oid": "d06cd002698b9c30f3988a12fc1639ea14e4b277", "url": "https://github.com/apache/iotdb/commit/d06cd002698b9c30f3988a12fc1639ea14e4b277", "message": "Merge remote-tracking branch 'origin/master' into FileClosedDebug", "committedDate": "2020-02-27T01:02:44Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDg2NDIwOQ==", "url": "https://github.com/apache/iotdb/pull/846#discussion_r384864209", "bodyText": "change to debug", "author": "qiaojialin", "createdAt": "2020-02-27T01:22:28Z", "path": "server/src/main/java/org/apache/iotdb/db/query/control/FileReaderManager.java", "diffHunk": "@@ -199,6 +202,26 @@ void decreaseFileReaderReference(TsFileResource tsFile, boolean isClosed) {\n    * integration tests will not conflict with each other.\n    */\n   public synchronized void closeAndRemoveAllOpenedReaders() throws IOException {\n+    Iterator<Map.Entry<TsFileResource, TsFileSequenceReader>> iterator = closedFileReaderMap.entrySet().iterator();\n+    while (iterator.hasNext()) {\n+      Map.Entry<TsFileResource, TsFileSequenceReader> entry = iterator.next();\n+      entry.getValue().close();\n+      if (resourceLogger.isInfoEnabled()) {", "originalCommit": "d06cd002698b9c30f3988a12fc1639ea14e4b277", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDg2NDUwMQ==", "url": "https://github.com/apache/iotdb/pull/846#discussion_r384864501", "bodyText": "duplicated?", "author": "qiaojialin", "createdAt": "2020-02-27T01:23:38Z", "path": "server/src/main/java/org/apache/iotdb/db/query/control/FileReaderManager.java", "diffHunk": "@@ -199,6 +202,26 @@ void decreaseFileReaderReference(TsFileResource tsFile, boolean isClosed) {\n    * integration tests will not conflict with each other.\n    */\n   public synchronized void closeAndRemoveAllOpenedReaders() throws IOException {\n+    Iterator<Map.Entry<TsFileResource, TsFileSequenceReader>> iterator = closedFileReaderMap.entrySet().iterator();\n+    while (iterator.hasNext()) {\n+      Map.Entry<TsFileResource, TsFileSequenceReader> entry = iterator.next();\n+      entry.getValue().close();\n+      if (resourceLogger.isInfoEnabled()) {\n+        resourceLogger.info(\"{} closedTsFileReader is closed.\", entry.getValue().getFileName());\n+      }\n+      closedReferenceMap.remove(entry.getKey());\n+      iterator.remove();", "originalCommit": "d06cd002698b9c30f3988a12fc1639ea14e4b277", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDg4MTk4Mw==", "url": "https://github.com/apache/iotdb/pull/846#discussion_r384881983", "bodyText": "different map. iterator is the closedFileReaderMap's iterator.", "author": "JackieTien97", "createdAt": "2020-02-27T02:30:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDg2NDUwMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDg2NDkwOA==", "url": "https://github.com/apache/iotdb/pull/846#discussion_r384864908", "bodyText": "duplicated", "author": "qiaojialin", "createdAt": "2020-02-27T01:25:21Z", "path": "server/src/main/java/org/apache/iotdb/db/query/control/FileReaderManager.java", "diffHunk": "@@ -199,6 +202,26 @@ void decreaseFileReaderReference(TsFileResource tsFile, boolean isClosed) {\n    * integration tests will not conflict with each other.\n    */\n   public synchronized void closeAndRemoveAllOpenedReaders() throws IOException {\n+    Iterator<Map.Entry<TsFileResource, TsFileSequenceReader>> iterator = closedFileReaderMap.entrySet().iterator();\n+    while (iterator.hasNext()) {\n+      Map.Entry<TsFileResource, TsFileSequenceReader> entry = iterator.next();\n+      entry.getValue().close();\n+      if (resourceLogger.isInfoEnabled()) {\n+        resourceLogger.info(\"{} closedTsFileReader is closed.\", entry.getValue().getFileName());\n+      }\n+      closedReferenceMap.remove(entry.getKey());\n+      iterator.remove();\n+    }\n+    iterator = unclosedFileReaderMap.entrySet().iterator();\n+    while (iterator.hasNext()) {\n+      Map.Entry<TsFileResource, TsFileSequenceReader> entry = iterator.next();\n+      entry.getValue().close();\n+      if (resourceLogger.isInfoEnabled()) {\n+        resourceLogger.info(\"{} unclosedTsFileReader is closed.\", entry.getValue().getFileName());\n+      }\n+      unclosedReferenceMap.remove(entry.getKey());\n+      iterator.remove();", "originalCommit": "d06cd002698b9c30f3988a12fc1639ea14e4b277", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDg2NTExMQ==", "url": "https://github.com/apache/iotdb/pull/846#discussion_r384865111", "bodyText": "this should be removed..", "author": "qiaojialin", "createdAt": "2020-02-27T01:26:07Z", "path": "server/src/main/java/org/apache/iotdb/db/query/control/FileReaderManager.java", "diffHunk": "@@ -199,6 +202,26 @@ void decreaseFileReaderReference(TsFileResource tsFile, boolean isClosed) {\n    * integration tests will not conflict with each other.\n    */\n   public synchronized void closeAndRemoveAllOpenedReaders() throws IOException {\n+    Iterator<Map.Entry<TsFileResource, TsFileSequenceReader>> iterator = closedFileReaderMap.entrySet().iterator();\n+    while (iterator.hasNext()) {\n+      Map.Entry<TsFileResource, TsFileSequenceReader> entry = iterator.next();\n+      entry.getValue().close();\n+      if (resourceLogger.isInfoEnabled()) {\n+        resourceLogger.info(\"{} closedTsFileReader is closed.\", entry.getValue().getFileName());\n+      }\n+      closedReferenceMap.remove(entry.getKey());\n+      iterator.remove();\n+    }\n+    iterator = unclosedFileReaderMap.entrySet().iterator();\n+    while (iterator.hasNext()) {\n+      Map.Entry<TsFileResource, TsFileSequenceReader> entry = iterator.next();\n+      entry.getValue().close();\n+      if (resourceLogger.isInfoEnabled()) {\n+        resourceLogger.info(\"{} unclosedTsFileReader is closed.\", entry.getValue().getFileName());\n+      }\n+      unclosedReferenceMap.remove(entry.getKey());\n+      iterator.remove();\n+    }\n     for (Map.Entry<TsFileResource, TsFileSequenceReader> entry : closedFileReaderMap.entrySet()) {", "originalCommit": "d06cd002698b9c30f3988a12fc1639ea14e4b277", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDg2NTU1Nw==", "url": "https://github.com/apache/iotdb/pull/846#discussion_r384865557", "bodyText": "what If does not contain the tsfileResource, is it a bug?", "author": "qiaojialin", "createdAt": "2020-02-27T01:27:39Z", "path": "server/src/main/java/org/apache/iotdb/db/query/control/QueryFileManager.java", "diffHunk": "@@ -77,8 +74,9 @@ private void addUsedFilesForQuery(long queryId, List<TsFileResource> resources)\n       // this file may be deleted just before we lock it\r\n       if (tsFileResource.isDeleted()) {\r\n         Map<Long, Set<TsFileResource>> pathMap = !isClosed ? unsealedFilePathsMap : sealedFilePathsMap;\r\n-        pathMap.get(queryId).remove(tsFileResource);\r\n-        FileReaderManager.getInstance().decreaseFileReaderReference(tsFileResource, isClosed);\r\n+        if (pathMap.get(queryId).remove(tsFileResource)) {\r", "originalCommit": "d06cd002698b9c30f3988a12fc1639ea14e4b277", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDg4MzY1OA==", "url": "https://github.com/apache/iotdb/pull/846#discussion_r384883658", "bodyText": "Nope, It may have been decreased because of it's deleted, but another thread may also enter into the same block, it also remove it(although it's an empty operation, the resource has been removed by another thread, so the remove operation return false), in this case, the second thread should not decrease it again.", "author": "JackieTien97", "createdAt": "2020-02-27T02:37:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDg2NTU1Nw=="}], "type": "inlineReview"}, {"oid": "5bbf15d757412417e8b60b0cca7ae8535fb65b33", "url": "https://github.com/apache/iotdb/commit/5bbf15d757412417e8b60b0cca7ae8535fb65b33", "message": "change for qiao", "committedDate": "2020-02-27T02:42:48Z", "type": "commit"}]}