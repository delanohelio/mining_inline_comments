{"pr_number": 966, "pr_title": "Fix visible metadata, version, work processor bugs when recovering", "pr_createdAt": "2020-03-31T12:13:57Z", "pr_url": "https://github.com/apache/iotdb/pull/966", "timeline": [{"oid": "230dd5419242ded39431ba88efa554fa76d4eaea", "url": "https://github.com/apache/iotdb/commit/230dd5419242ded39431ba88efa554fa76d4eaea", "message": "fix recover bugs", "committedDate": "2020-03-31T11:10:38Z", "type": "commit"}, {"oid": "e7c387d5ee4ba2d7afeec7be498a845f08d56882", "url": "https://github.com/apache/iotdb/commit/e7c387d5ee4ba2d7afeec7be498a845f08d56882", "message": "fix partition -1 when recover", "committedDate": "2020-03-31T12:02:08Z", "type": "commit"}, {"oid": "f56d8397e5ad1f0dec7174557a87976d67458e30", "url": "https://github.com/apache/iotdb/commit/f56d8397e5ad1f0dec7174557a87976d67458e30", "message": "fix conilct javadoc", "committedDate": "2020-03-31T12:13:40Z", "type": "commit"}, {"oid": "10c1bee3aa53a760e708d0a25b57dcec46f34302", "url": "https://github.com/apache/iotdb/commit/10c1bee3aa53a760e708d0a25b57dcec46f34302", "message": "add restart IT", "committedDate": "2020-03-31T13:11:30Z", "type": "commit"}, {"oid": "20e16e61ce1cb50f2c6c1f7561c62448feb18231", "url": "https://github.com/apache/iotdb/commit/20e16e61ce1cb50f2c6c1f7561c62448feb18231", "message": "move getPartition to TsFileResource", "committedDate": "2020-03-31T13:42:17Z", "type": "commit"}, {"oid": "7dc091cac195888284f6d92380f4eb2faa1891da", "url": "https://github.com/apache/iotdb/commit/7dc091cac195888284f6d92380f4eb2faa1891da", "message": "fix sonar", "committedDate": "2020-03-31T14:12:09Z", "type": "commit"}, {"oid": "20ae6bfe1710ab70b5cc9e1a79ec1f5c314ff96c", "url": "https://github.com/apache/iotdb/commit/20ae6bfe1710ab70b5cc9e1a79ec1f5c314ff96c", "message": "optimize TsFileSequenceReader selfCheck", "committedDate": "2020-03-31T14:27:57Z", "type": "commit"}, {"oid": "ab7aee45f6f1c2ed4744e24708600db324ee6262", "url": "https://github.com/apache/iotdb/commit/ab7aee45f6f1c2ed4744e24708600db324ee6262", "message": "restore goon", "committedDate": "2020-03-31T14:30:01Z", "type": "commit"}, {"oid": "a48a519a26671cd23fde9d8815a667cb1261617b", "url": "https://github.com/apache/iotdb/commit/a48a519a26671cd23fde9d8815a667cb1261617b", "message": "optimize TsFileSequenceReader", "committedDate": "2020-03-31T14:37:18Z", "type": "commit"}, {"oid": "35c675127dabc5d2766ff8f2a255472b5a5160e2", "url": "https://github.com/apache/iotdb/commit/35c675127dabc5d2766ff8f2a255472b5a5160e2", "message": "optimize TsFileSequenceReader", "committedDate": "2020-03-31T14:37:35Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTA3MDcyOA==", "url": "https://github.com/apache/iotdb/pull/966#discussion_r401070728", "bodyText": "If we sync a tsfile from other iotdb, will this tsfile has time partition directory? Maybe we should use startTimeMap to get time partition", "author": "SilverNarcissus", "createdAt": "2020-03-31T17:00:13Z", "path": "server/src/main/java/org/apache/iotdb/db/engine/storagegroup/TsFileResource.java", "diffHunk": "@@ -471,4 +473,12 @@ public void setProcessor(TsFileProcessor processor) {\n   public TimeseriesMetadata getTimeSeriesMetadata() {\n     return timeSeriesMetadata;\n   }\n+\n+  public long getTimePartition() {\n+    if (startTimeMap != null && !startTimeMap.isEmpty()) {\n+      return StorageEngine.getTimePartition(startTimeMap.values().iterator().next());\n+    }\n+    String[] splits = FilePathUtils.splitTsFilePath(this);\n+    return Long.parseLong(splits[splits.length - 2]);", "originalCommit": "35c675127dabc5d2766ff8f2a255472b5a5160e2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTI5ODMyMA==", "url": "https://github.com/apache/iotdb/pull/966#discussion_r401298320", "bodyText": "Thanks, I use the startTimeMap first, then the path", "author": "qiaojialin", "createdAt": "2020-04-01T00:58:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTA3MDcyOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTMzMDA5OQ==", "url": "https://github.com/apache/iotdb/pull/966#discussion_r401330099", "bodyText": "It is not guaranteed that the other IoTDB will use the same partition interval, so it is better to check the whole startTimeMap and endTimeMap to see if any device has crossed a partition and report an exception if so.", "author": "jt2594838", "createdAt": "2020-04-01T03:05:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTA3MDcyOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTMzNjcwMg==", "url": "https://github.com/apache/iotdb/pull/966#discussion_r401336702", "bodyText": "restart and load could use different getPartition method, one check partition and the other not. I will add a method with partition check", "author": "qiaojialin", "createdAt": "2020-04-01T03:32:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTA3MDcyOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTA4MjczMA==", "url": "https://github.com/apache/iotdb/pull/966#discussion_r401082730", "bodyText": "Since Pair<String, List<ChunkMetadata> > is similar to previous ChunkGroupMetadata, I'm thinking if it's necessary to add ChunkGroupMetadata back instead of using the pair.", "author": "HTHou", "createdAt": "2020-03-31T17:19:21Z", "path": "tsfile/src/main/java/org/apache/iotdb/tsfile/write/writer/TsFileIOWriter.java", "diffHunk": "@@ -65,14 +66,19 @@\n   }\n \n   protected TsFileOutput out;\n-  protected List<Pair<String, List<ChunkMetadata>>> chunkGroupInfoList = new ArrayList<>();\n   protected boolean canWrite = true;\n   protected int totalChunkNum = 0;\n   protected int invalidChunkNum;\n   protected File file;\n-  protected List<ChunkMetadata> chunkMetadataList = new ArrayList<>();\n-  protected Map<Path, List<ChunkMetadata>> chunkMetadataListMap = new TreeMap<>();\n+\n+\n+  // current flushed Chunk\n   private ChunkMetadata currentChunkMetadata;\n+  // current flushed ChunkGroup\n+  protected List<ChunkMetadata> chunkMetadataList = new ArrayList<>();\n+  // all flushed ChunkGroup,  device -> List<ChunkMetadata>\n+  protected List<Pair<String, List<ChunkMetadata>>> chunkGroupMetadataList = new ArrayList<>();\n+", "originalCommit": "35c675127dabc5d2766ff8f2a255472b5a5160e2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTMwNTUzOA==", "url": "https://github.com/apache/iotdb/pull/966#discussion_r401305538", "bodyText": "Good idea, I have added it", "author": "qiaojialin", "createdAt": "2020-04-01T01:26:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTA4MjczMA=="}], "type": "inlineReview"}, {"oid": "df92e70a4b40d124ed02145975f6bcae1fe0ed24", "url": "https://github.com/apache/iotdb/commit/df92e70a4b40d124ed02145975f6bcae1fe0ed24", "message": "add ChunkGroupMetadata", "committedDate": "2020-04-01T01:15:15Z", "type": "commit"}, {"oid": "9d9a4ef6069ca2a6ab41394939e9a95520f7a3bc", "url": "https://github.com/apache/iotdb/commit/9d9a4ef6069ca2a6ab41394939e9a95520f7a3bc", "message": "add a getTimePartitionWithCheck in TsFileResource", "committedDate": "2020-04-01T03:39:25Z", "type": "commit"}, {"oid": "0a4c36960d662f45f133fc83827524027c40f785", "url": "https://github.com/apache/iotdb/commit/0a4c36960d662f45f133fc83827524027c40f785", "message": "fix sonar", "committedDate": "2020-04-01T05:14:26Z", "type": "commit"}]}