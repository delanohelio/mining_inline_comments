{"pr_number": 1824, "pr_title": "[IOTDB-942] Optimization of query with long time unsequence page", "pr_createdAt": "2020-10-13T08:32:51Z", "pr_url": "https://github.com/apache/iotdb/pull/1824", "timeline": [{"oid": "7ce3c9cd813894a36ed6acc86067080b5b09036c", "url": "https://github.com/apache/iotdb/commit/7ce3c9cd813894a36ed6acc86067080b5b09036c", "message": "init", "committedDate": "2020-10-08T13:09:58Z", "type": "commit"}, {"oid": "9770de8de06e3dfb2cddf870a128589a85474e2b", "url": "https://github.com/apache/iotdb/commit/9770de8de06e3dfb2cddf870a128589a85474e2b", "message": "add some todo", "committedDate": "2020-10-10T02:26:22Z", "type": "commit"}, {"oid": "847b2c341a84f0cc637e922f8aba21df005e49c2", "url": "https://github.com/apache/iotdb/commit/847b2c341a84f0cc637e922f8aba21df005e49c2", "message": "implement function of ascending", "committedDate": "2020-10-13T06:29:24Z", "type": "commit"}, {"oid": "ffc52308b6f49ad6fa9f4dcb67bcf1efb3ac88f1", "url": "https://github.com/apache/iotdb/commit/ffc52308b6f49ad6fa9f4dcb67bcf1efb3ac88f1", "message": "Merge branch 'UnseqImprove' of github.com:Alima777/incubator-iotdb into UnseqImprove", "committedDate": "2020-10-13T08:41:28Z", "type": "commit"}, {"oid": "53fb90f4f200eed00f78cbc6ced000c9955d326e", "url": "https://github.com/apache/iotdb/commit/53fb90f4f200eed00f78cbc6ced000c9955d326e", "message": "implement desc part", "committedDate": "2020-10-13T11:44:41Z", "type": "commit"}, {"oid": "8fbb3554c7e8764f51d0111ccd067619f811356b", "url": "https://github.com/apache/iotdb/commit/8fbb3554c7e8764f51d0111ccd067619f811356b", "message": "mark the bug position", "committedDate": "2020-10-13T13:59:02Z", "type": "commit"}, {"oid": "f239f0ba0aa1673fa3204f594736f55975781427", "url": "https://github.com/apache/iotdb/commit/f239f0ba0aa1673fa3204f594736f55975781427", "message": "Merge branch 'UnseqImprove' of github.com:Alima777/incubator-iotdb into UnseqImprove", "committedDate": "2020-10-14T02:28:03Z", "type": "commit"}, {"oid": "795cb1c482ebba7ba7f6d01e2ab46b6a10cfac99", "url": "https://github.com/apache/iotdb/commit/795cb1c482ebba7ba7f6d01e2ab46b6a10cfac99", "message": "fix bugs", "committedDate": "2020-10-14T08:21:33Z", "type": "commit"}, {"oid": "5a4a1a91e8514813c05b5a6bfe3cbf582eed4933", "url": "https://github.com/apache/iotdb/commit/5a4a1a91e8514813c05b5a6bfe3cbf582eed4933", "message": "update currentPageEndPointTime", "committedDate": "2020-10-14T08:37:29Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzQ4MzgyNw==", "url": "https://github.com/apache/iotdb/pull/1824#discussion_r507483827", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  if (seqStatistics.getStartTime() < unseqStatistics.getStartTime()) {\n          \n          \n            \n                    return true;\n          \n          \n            \n                  }\n          \n          \n            \n                  return false;\n          \n          \n            \n                 return seqStatistics.getStartTime() < unseqStatistics.getStartTime());", "author": "samperson1997", "createdAt": "2020-10-19T05:50:25Z", "path": "server/src/main/java/org/apache/iotdb/db/query/reader/series/SeriesReader.java", "diffHunk": "@@ -931,11 +1043,31 @@ public TsFileResource getNextSeqFileResource(List<TsFileResource> seqResources,\n           (c1, c2) -> Long.compare(keyExtractor.applyAsLong(c1), keyExtractor.applyAsLong(c2));\n     }\n \n+    @Override\n+    public long getCurrentEndPoint(long time, Statistics<? extends Object> statistics) {\n+      return Math.min(time, statistics.getEndTime());\n+    }\n+\n+    @Override\n+    public long getCurrentEndPoint(Statistics<? extends Object> seqStatistics,\n+        Statistics<? extends Object> unseqStatistics) {\n+      return Math.min(seqStatistics.getEndTime(), unseqStatistics.getEndTime());\n+    }\n+\n     @Override\n     public boolean isExcessEndpoint(long time, long endpointTime) {\n       return time > endpointTime;\n     }\n \n+    @Override\n+    public boolean isTakeSeqAsFirst(Statistics<? extends Object> seqStatistics,\n+        Statistics<? extends Object> unseqStatistics) {\n+      if (seqStatistics.getStartTime() < unseqStatistics.getStartTime()) {\n+        return true;\n+      }\n+      return false;", "originalCommit": "5a4a1a91e8514813c05b5a6bfe3cbf582eed4933", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzQ4NDA1OA==", "url": "https://github.com/apache/iotdb/pull/1824#discussion_r507484058", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  if (seqStatistics.getEndTime() > unseqStatistics.getEndTime()) {\n          \n          \n            \n                    return true;\n          \n          \n            \n                  }\n          \n          \n            \n                  return false;\n          \n          \n            \n                  return seqStatistics.getEndTime() > unseqStatistics.getEndTime();", "author": "samperson1997", "createdAt": "2020-10-19T05:50:55Z", "path": "server/src/main/java/org/apache/iotdb/db/query/reader/series/SeriesReader.java", "diffHunk": "@@ -870,12 +963,31 @@ public TsFileResource getNextSeqFileResource(List<TsFileResource> seqResources,\n           (c1, c2) -> Long.compare(keyExtractor.applyAsLong(c2), keyExtractor.applyAsLong(c1));\n     }\n \n+    @Override\n+    public long getCurrentEndPoint(long time, Statistics<? extends Object> statistics) {\n+      return Math.max(time, statistics.getStartTime());\n+    }\n+\n+    @Override\n+    public long getCurrentEndPoint(Statistics<? extends Object> seqStatistics,\n+        Statistics<? extends Object> unseqStatistics) {\n+      return Math.max(seqStatistics.getStartTime(), unseqStatistics.getStartTime());\n+    }\n \n     @Override\n     public boolean isExcessEndpoint(long time, long endpointTime) {\n       return time < endpointTime;\n     }\n \n+    @Override\n+    public boolean isTakeSeqAsFirst(Statistics<? extends Object> seqStatistics,\n+        Statistics<? extends Object> unseqStatistics) {\n+      if (seqStatistics.getEndTime() > unseqStatistics.getEndTime()) {\n+        return true;\n+      }\n+      return false;", "originalCommit": "5a4a1a91e8514813c05b5a6bfe3cbf582eed4933", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzU0NDczMg==", "url": "https://github.com/apache/iotdb/pull/1824#discussion_r507544732", "bodyText": "Fixed.", "author": "Alima777", "createdAt": "2020-10-19T07:57:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzQ4NDA1OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzQ4NDQyOQ==", "url": "https://github.com/apache/iotdb/pull/1824#discussion_r507484429", "bodyText": "Add java doc for these new abstract methods", "author": "samperson1997", "createdAt": "2020-10-19T05:51:55Z", "path": "server/src/main/java/org/apache/iotdb/db/query/reader/series/SeriesReader.java", "diffHunk": "@@ -816,8 +901,16 @@ boolean isModified() {\n \n     <T> Comparator<T> comparingLong(ToLongFunction<? super T> keyExtractor);\n \n+    long getCurrentEndPoint(long time, Statistics<? extends Object> statistics);\n+\n+    long getCurrentEndPoint(Statistics<? extends Object> seqStatistics,\n+        Statistics<? extends Object> unseqStatistics);\n+\n     boolean isExcessEndpoint(long time, long endpointTime);\n \n+    boolean isTakeSeqAsFirst(Statistics<? extends Object> seqStatistics,", "originalCommit": "5a4a1a91e8514813c05b5a6bfe3cbf582eed4933", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzY3OTE5Ng==", "url": "https://github.com/apache/iotdb/pull/1824#discussion_r507679196", "bodyText": "@Alima777 Don't forget this one : )", "author": "samperson1997", "createdAt": "2020-10-19T11:41:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzQ4NDQyOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzY4NDg0Ng==", "url": "https://github.com/apache/iotdb/pull/1824#discussion_r507684846", "bodyText": "OK~ Thank you", "author": "Alima777", "createdAt": "2020-10-19T11:52:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzQ4NDQyOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzQ4OTYzOA==", "url": "https://github.com/apache/iotdb/pull/1824#discussion_r507489638", "bodyText": "better to extract these complicate condition statements into a private method, since they appear not only once in this file (for example, in lines 395-398)", "author": "samperson1997", "createdAt": "2020-10-19T06:05:01Z", "path": "server/src/main/java/org/apache/iotdb/db/query/reader/series/SeriesReader.java", "diffHunk": "@@ -407,11 +409,15 @@ boolean hasNextPage() throws IOException {\n     }\n \n     // make sure firstPageReader won't be null while cachedPageReaders has more cached page readers\n-    while (firstPageReader == null && !cachedPageReaders.isEmpty()) {\n-      firstPageReader = cachedPageReaders.poll();\n-      if (!cachedPageReaders.isEmpty()\n-          && orderUtils.isOverlapped(firstPageReader.getStatistics(),\n-          cachedPageReaders.peek().getStatistics())) {\n+    while (firstPageReader == null && (!seqPageReaders.isEmpty() || !unSeqPageReaders.isEmpty())) {\n+\n+      initFirstPageReader();\n+\n+      if ((!seqPageReaders.isEmpty() && orderUtils\n+          .isOverlapped(firstPageReader.getStatistics(), seqPageReaders.get(0).getStatistics()))\n+          || (!unSeqPageReaders.isEmpty() && orderUtils\n+          .isOverlapped(firstPageReader.getStatistics(),\n+              unSeqPageReaders.peek().getStatistics()))) {", "originalCommit": "5a4a1a91e8514813c05b5a6bfe3cbf582eed4933", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzU0NDk3MQ==", "url": "https://github.com/apache/iotdb/pull/1824#discussion_r507544971", "bodyText": "You are right, fixed~", "author": "Alima777", "createdAt": "2020-10-19T07:57:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzQ4OTYzOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzQ5MDgzMQ==", "url": "https://github.com/apache/iotdb/pull/1824#discussion_r507490831", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                if (firstPageReader != null && !firstPageReader.isSeq &&\n          \n          \n            \n                if (firstPageReader != null && !firstPageReader.isSeq() &&", "author": "samperson1997", "createdAt": "2020-10-19T06:08:11Z", "path": "server/src/main/java/org/apache/iotdb/db/query/reader/series/SeriesReader.java", "diffHunk": "@@ -610,18 +674,33 @@ private void tryToPutAllDirectlyOverlappedPageReadersIntoMergeReader() throws IO\n     }\n \n     /*\n-     * put all currently directly overlapped page reader to merge reader\n+     * put all currently directly overlapped unseq page reader to merge reader\n      */\n-    unpackAllOverlappedCachedPageReadersToMergeReader(currentPageEndpointTime);\n+    unpackAllOverlappedUnseqPageReadersToMergeReader(currentPageEndpointTime);\n   }\n \n-  private void unpackAllOverlappedCachedPageReadersToMergeReader(long endpointTime)\n+  private void initFirstPageReader() {\n+    if (!seqPageReaders.isEmpty() && !unSeqPageReaders.isEmpty()) {\n+      if (orderUtils.isTakeSeqAsFirst(seqPageReaders.get(0).getStatistics(), unSeqPageReaders.peek()\n+          .getStatistics())) {\n+        firstPageReader = seqPageReaders.remove(0);\n+      } else {\n+        firstPageReader = unSeqPageReaders.poll();\n+      }\n+    } else if (!seqPageReaders.isEmpty()) {\n+      firstPageReader = seqPageReaders.remove(0);\n+    } else if (!unSeqPageReaders.isEmpty()) {\n+      firstPageReader = unSeqPageReaders.poll();\n+    }\n+  }\n+\n+  private void unpackAllOverlappedUnseqPageReadersToMergeReader(long endpointTime)\n       throws IOException {\n-    while (!cachedPageReaders.isEmpty()\n-        && orderUtils.isOverlapped(endpointTime, cachedPageReaders.peek().data.getStatistics())) {\n-      putPageReaderToMergeReader(cachedPageReaders.poll());\n+    while (!unSeqPageReaders.isEmpty()\n+        && orderUtils.isOverlapped(endpointTime, unSeqPageReaders.peek().data.getStatistics())) {\n+      putPageReaderToMergeReader(unSeqPageReaders.poll());\n     }\n-    if (firstPageReader != null &&\n+    if (firstPageReader != null && !firstPageReader.isSeq &&", "originalCommit": "5a4a1a91e8514813c05b5a6bfe3cbf582eed4933", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzQ5MTc5Ng==", "url": "https://github.com/apache/iotdb/pull/1824#discussion_r507491796", "bodyText": "Since you modified the field name of cachedPageReaders, maybe the name of this method should be updated as well.", "author": "samperson1997", "createdAt": "2020-10-19T06:10:18Z", "path": "server/src/main/java/org/apache/iotdb/db/query/reader/series/SeriesReader.java", "diffHunk": "@@ -381,19 +383,19 @@ boolean hasNextPage() throws IOException {\n       /*\n        * first chunk metadata is already unpacked, consume cached pages\n        */\n-      if (!cachedPageReaders.isEmpty()) {\n-        firstPageReader = cachedPageReaders.poll();\n+      initFirstPageReader();\n+      if (firstPageReader != null) {\n         long endpointTime = orderUtils.getOverlapCheckTime(firstPageReader.getStatistics());\n         unpackAllOverlappedTsFilesToTimeSeriesMetadata(endpointTime);\n         unpackAllOverlappedTimeSeriesMetadataToCachedChunkMetadata(endpointTime, false);\n         unpackAllOverlappedChunkMetadataToCachedPageReaders(endpointTime, false);", "originalCommit": "5a4a1a91e8514813c05b5a6bfe3cbf582eed4933", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzU0NTUzMQ==", "url": "https://github.com/apache/iotdb/pull/1824#discussion_r507545531", "bodyText": "Remaining this name is still good I think.", "author": "Alima777", "createdAt": "2020-10-19T07:58:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzQ5MTc5Ng=="}], "type": "inlineReview"}, {"oid": "e41edd433099501c4f0201287835c67b5c31f2c6", "url": "https://github.com/apache/iotdb/commit/e41edd433099501c4f0201287835c67b5c31f2c6", "message": "fix code style", "committedDate": "2020-10-19T07:59:53Z", "type": "commit"}, {"oid": "84e210b581ad861ec441bba7b804f556e00056bd", "url": "https://github.com/apache/iotdb/commit/84e210b581ad861ec441bba7b804f556e00056bd", "message": "Merge branch 'UnseqImprove' of github.com:Alima777/incubator-iotdb into UnseqImprove", "committedDate": "2020-10-19T08:00:22Z", "type": "commit"}, {"oid": "9a7237be2378f7c90672b8795e299371fcf806e3", "url": "https://github.com/apache/iotdb/commit/9a7237be2378f7c90672b8795e299371fcf806e3", "message": "add javadoc", "committedDate": "2020-10-19T11:51:04Z", "type": "commit"}]}