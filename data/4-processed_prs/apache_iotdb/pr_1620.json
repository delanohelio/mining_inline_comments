{"pr_number": 1620, "pr_title": "Change hot compact way to level merge", "pr_createdAt": "2020-08-14T08:20:38Z", "pr_url": "https://github.com/apache/iotdb/pull/1620", "timeline": [{"oid": "712e43afe27c4bb92ac32f648070ef8e919adec5", "url": "https://github.com/apache/iotdb/commit/712e43afe27c4bb92ac32f648070ef8e919adec5", "message": "recover TsFileProcessor(may not pass ci)", "committedDate": "2020-07-23T10:39:21Z", "type": "commit"}, {"oid": "625e8266e720b0eb214f2a2a93d1033ec368a189", "url": "https://github.com/apache/iotdb/commit/625e8266e720b0eb214f2a2a93d1033ec368a189", "message": "fix ts bug", "committedDate": "2020-07-23T14:10:19Z", "type": "commit"}, {"oid": "f21fbdf21267f42a71c2fadaf02457f1a4d7c4fc", "url": "https://github.com/apache/iotdb/commit/f21fbdf21267f42a71c2fadaf02457f1a4d7c4fc", "message": "Merge pull request #1550 from zhanglingzhe0820/recover_TsFileProcessor\n\nrecover TsFileProcessor(may not pass ci)", "committedDate": "2020-07-29T01:42:57Z", "type": "commit"}, {"oid": "e55e75254ae0f890919052152030bfe6b2c96b52", "url": "https://github.com/apache/iotdb/commit/e55e75254ae0f890919052152030bfe6b2c96b52", "message": "change back recover and query", "committedDate": "2020-07-29T02:48:00Z", "type": "commit"}, {"oid": "8b272324bf2519f7dc1f1b8cecc539bdeca98af2", "url": "https://github.com/apache/iotdb/commit/8b272324bf2519f7dc1f1b8cecc539bdeca98af2", "message": "Merge remote-tracking branch 'origin/master' into merge", "committedDate": "2020-08-12T08:04:36Z", "type": "commit"}, {"oid": "107f83a1d5770044d7a1a8bd03605db442eeb84a", "url": "https://github.com/apache/iotdb/commit/107f83a1d5770044d7a1a8bd03605db442eeb84a", "message": "add tsfilemanage-merge (#1597)\n\n* add tsfilemanage", "committedDate": "2020-08-14T08:16:21Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mzc4MDUxNA==", "url": "https://github.com/apache/iotdb/pull/1620#discussion_r473780514", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              LevelStrategy,\n          \n          \n            \n              NormalStrategy;\n          \n          \n            \n              LEVEL_STRATEGY,\n          \n          \n            \n              NORMAL_STRATEGY;", "author": "samperson1997", "createdAt": "2020-08-20T08:52:02Z", "path": "server/src/main/java/org/apache/iotdb/db/engine/tsfilemanagement/TsFileManagementStrategy.java", "diffHunk": "@@ -0,0 +1,38 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.iotdb.db.engine.tsfilemanagement;\n+\n+import org.apache.iotdb.db.engine.tsfilemanagement.level.LevelTsFileManagement;\n+import org.apache.iotdb.db.engine.tsfilemanagement.normal.NormalTsFileManagement;\n+\n+public enum TsFileManagementStrategy {\n+  LevelStrategy,\n+  NormalStrategy;", "originalCommit": "107f83a1d5770044d7a1a8bd03605db442eeb84a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mzc4MTU5Ng==", "url": "https://github.com/apache/iotdb/pull/1620#discussion_r473781596", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  assertTrue(cnt == 0);\n          \n          \n            \n                  assertEquals(0, cnt);", "author": "samperson1997", "createdAt": "2020-08-20T08:53:14Z", "path": "server/src/test/java/org/apache/iotdb/db/integration/IoTDBMergeTest.java", "diffHunk": "@@ -272,7 +294,7 @@ public void testShowMergeStatus() throws SQLException {\n       }\n       // it is uncertain whether the sub tasks are created at this time point, and we are only\n       // sure that the main task is created\n-      assertTrue(cnt >= 1);\n+      assertTrue(cnt == 0);", "originalCommit": "107f83a1d5770044d7a1a8bd03605db442eeb84a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDM3OTQ0MA==", "url": "https://github.com/apache/iotdb/pull/1620#discussion_r474379440", "bodyText": "Why delete this?", "author": "samperson1997", "createdAt": "2020-08-21T02:52:37Z", "path": "server/src/test/java/org/apache/iotdb/db/integration/IoTDBRemovePartitionIT.java", "diffHunk": "@@ -177,7 +183,6 @@ private static void insertData() throws ClassNotFoundException {\n         sqls.add(\"FLUSH\");\n       }\n     }\n-    sqls.add(\"MERGE\");", "originalCommit": "107f83a1d5770044d7a1a8bd03605db442eeb84a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDQyNjY4Nw==", "url": "https://github.com/apache/iotdb/pull/1620#discussion_r474426687", "bodyText": "5 or 10? Be unified before merged : )", "author": "samperson1997", "createdAt": "2020-08-21T06:05:35Z", "path": "server/src/main/java/org/apache/iotdb/db/conf/IoTDBConfig.java", "diffHunk": "@@ -249,24 +250,26 @@\n   private int avgSeriesPointNumberThreshold = 500000;\n \n   /**\n-   * When merge point number reaches this, merge the vmfile to the tsfile.\n+   * Work when tsfile_manage_strategy is level_strategy. When merge point number reaches this, merge\n+   * the files to the last level.\n    */\n   private int mergeChunkPointNumberThreshold = 100000;\n \n   /**\n-   * Is vm merge enable\n+   * TsFile manage strategy, define use which hot compaction strategy\n    */\n-  private boolean enableVm = true;\n+  private TsFileManagementStrategy tsFileManagementStrategy = TsFileManagementStrategy.LevelStrategy;\n \n   /**\n-   * The max vm num of each memtable. When vm num exceeds this, the vm files will merge to one.\n+   * Work when tsfile_manage_strategy is level_strategy. The max file num of each level. When file\n+   * num exceeds this, the files in one level will merge to one.\n    */\n-  private int maxVmNum = 5;\n+  private int maxFileNumInEachLevel = 5;", "originalCommit": "107f83a1d5770044d7a1a8bd03605db442eeb84a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDQyNjg1NQ==", "url": "https://github.com/apache/iotdb/pull/1620#discussion_r474426855", "bodyText": "unified to 5 or 10 to keep same as iotdb-engine.properties as well", "author": "samperson1997", "createdAt": "2020-08-21T06:06:03Z", "path": "server/src/main/java/org/apache/iotdb/db/conf/IoTDBConfig.java", "diffHunk": "@@ -249,24 +250,26 @@\n   private int avgSeriesPointNumberThreshold = 500000;\n \n   /**\n-   * When merge point number reaches this, merge the vmfile to the tsfile.\n+   * Work when tsfile_manage_strategy is level_strategy. When merge point number reaches this, merge\n+   * the files to the last level.\n    */\n   private int mergeChunkPointNumberThreshold = 100000;\n \n   /**\n-   * Is vm merge enable\n+   * TsFile manage strategy, define use which hot compaction strategy\n    */\n-  private boolean enableVm = true;\n+  private TsFileManagementStrategy tsFileManagementStrategy = TsFileManagementStrategy.LevelStrategy;\n \n   /**\n-   * The max vm num of each memtable. When vm num exceeds this, the vm files will merge to one.\n+   * Work when tsfile_manage_strategy is level_strategy. The max file num of each level. When file\n+   * num exceeds this, the files in one level will merge to one.\n    */\n-  private int maxVmNum = 5;\n+  private int maxFileNumInEachLevel = 5;\n \n   /**\n-   * When vmfiles merge times exceeds this, merge the vmfile to the tsfile.\n+   * Work when tsfile_manage_strategy is level_strategy. The max num of level.\n    */\n-  private int maxMergeChunkNumInTsFile = 25;\n+  private int maxLevelNum = 5;", "originalCommit": "107f83a1d5770044d7a1a8bd03605db442eeb84a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDQyNzM3Mg==", "url": "https://github.com/apache/iotdb/pull/1620#discussion_r474427372", "bodyText": "Is tsFileManagementStrategy a config which could only be modified at the first time starting IoTDB? If so, you may have to add it to IoTDBConfigCheck to abandon changing it when restarting.", "author": "samperson1997", "createdAt": "2020-08-21T06:07:34Z", "path": "server/src/main/java/org/apache/iotdb/db/conf/IoTDBConfig.java", "diffHunk": "@@ -249,24 +250,26 @@\n   private int avgSeriesPointNumberThreshold = 500000;\n \n   /**\n-   * When merge point number reaches this, merge the vmfile to the tsfile.\n+   * Work when tsfile_manage_strategy is level_strategy. When merge point number reaches this, merge\n+   * the files to the last level.\n    */\n   private int mergeChunkPointNumberThreshold = 100000;\n \n   /**\n-   * Is vm merge enable\n+   * TsFile manage strategy, define use which hot compaction strategy\n    */\n-  private boolean enableVm = true;\n+  private TsFileManagementStrategy tsFileManagementStrategy = TsFileManagementStrategy.LevelStrategy;", "originalCommit": "107f83a1d5770044d7a1a8bd03605db442eeb84a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDQzMDIzNg==", "url": "https://github.com/apache/iotdb/pull/1620#discussion_r474430236", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              private static final Logger LOGGER = LoggerFactory\n          \n          \n            \n              private static final Logger logger = LoggerFactory", "author": "samperson1997", "createdAt": "2020-08-21T06:16:56Z", "path": "server/src/main/java/org/apache/iotdb/db/engine/tsfilemanagement/HotCompactionMergeTaskPoolManager.java", "diffHunk": "@@ -0,0 +1,118 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.iotdb.db.engine.tsfilemanagement;\n+\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.TimeUnit;\n+import org.apache.iotdb.db.concurrent.IoTDBThreadPoolFactory;\n+import org.apache.iotdb.db.concurrent.ThreadName;\n+import org.apache.iotdb.db.engine.tsfilemanagement.TsFileManagement.HotCompactionMergeTask;\n+import org.apache.iotdb.db.service.IService;\n+import org.apache.iotdb.db.service.ServiceType;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * HotCompactionMergeTaskPoolManager provides a ThreadPool to queue and run all hot compaction\n+ * tasks.\n+ */\n+public class HotCompactionMergeTaskPoolManager implements IService {\n+\n+  private static final Logger LOGGER = LoggerFactory", "originalCommit": "107f83a1d5770044d7a1a8bd03605db442eeb84a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDQ0NTA0Mg==", "url": "https://github.com/apache/iotdb/pull/1620#discussion_r474445042", "bodyText": "Could we omit the last 2 params since they are null and this method is only called here?", "author": "samperson1997", "createdAt": "2020-08-21T06:57:31Z", "path": "server/src/main/java/org/apache/iotdb/db/engine/tsfilemanagement/utils/HotCompactionUtils.java", "diffHunk": "@@ -180,44 +193,52 @@ public static void merge(RestorableTsFileIOWriter writer,\n         for (Entry<String, MeasurementSchema> entry : deviceMeasurementEntry.getValue()\n             .entrySet()) {\n           String measurementId = entry.getKey();\n-          Pair<ChunkMetadata, Chunk> chunkPair = writeSeqChunk(writer, storageGroup,\n-              tsFileSequenceReaderMap, deviceId, measurementId, vmWriters, null, null);\n+          Pair<ChunkMetadata, Chunk> chunkPair = writeSeqChunk(storageGroup,\n+              tsFileSequenceReaderMap, deviceId, measurementId, tsFileResources, null,\n+              null);", "originalCommit": "107f83a1d5770044d7a1a8bd03605db442eeb84a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDQ0ODgyOA==", "url": "https://github.com/apache/iotdb/pull/1620#discussion_r474448828", "bodyText": "Could we keep the logger not null before calling this method?", "author": "samperson1997", "createdAt": "2020-08-21T07:03:21Z", "path": "server/src/main/java/org/apache/iotdb/db/engine/tsfilemanagement/utils/HotCompactionUtils.java", "diffHunk": "@@ -180,44 +193,52 @@ public static void merge(RestorableTsFileIOWriter writer,\n         for (Entry<String, MeasurementSchema> entry : deviceMeasurementEntry.getValue()\n             .entrySet()) {\n           String measurementId = entry.getKey();\n-          Pair<ChunkMetadata, Chunk> chunkPair = writeSeqChunk(writer, storageGroup,\n-              tsFileSequenceReaderMap, deviceId, measurementId, vmWriters, null, null);\n+          Pair<ChunkMetadata, Chunk> chunkPair = writeSeqChunk(storageGroup,\n+              tsFileSequenceReaderMap, deviceId, measurementId, tsFileResources, null,\n+              null);\n           ChunkMetadata newChunkMetadata = chunkPair.left;\n           Chunk newChunk = chunkPair.right;\n           if (newChunkMetadata != null && newChunk != null) {\n             writer.writeChunk(newChunk, newChunkMetadata);\n+            targetResource.updateStartTime(deviceId, newChunkMetadata.getStartTime());\n+            targetResource.updateEndTime(deviceId, newChunkMetadata.getEndTime());\n           }\n         }\n         writer.endChunkGroup();\n-        if (vmLogger != null) {\n-          vmLogger.logDevice(deviceId, writer.getPos());\n+        if (hotCompactionLogger != null) {", "originalCommit": "107f83a1d5770044d7a1a8bd03605db442eeb84a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzExNTEwNQ==", "url": "https://github.com/apache/iotdb/pull/1620#discussion_r477115105", "bodyText": "just confirm that the logger is not null", "author": "zhanglingzhe0820", "createdAt": "2020-08-26T08:10:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDQ0ODgyOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDQ2MDMzNA==", "url": "https://github.com/apache/iotdb/pull/1620#discussion_r474460334", "bodyText": "Don't forget to change name of param", "author": "samperson1997", "createdAt": "2020-08-21T07:18:14Z", "path": "server/src/main/java/org/apache/iotdb/db/engine/tsfilemanagement/level/LevelTsFileManagement.java", "diffHunk": "@@ -0,0 +1,540 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.iotdb.db.engine.tsfilemanagement.level;\n+\n+import static org.apache.iotdb.db.conf.IoTDBConstant.FILE_NAME_SEPARATOR;\n+import static org.apache.iotdb.db.engine.tsfilemanagement.normal.NormalTsFileManagement.compareFileName;\n+import static org.apache.iotdb.db.engine.tsfilemanagement.utils.HotCompactionLogger.HOT_COMPACTION_LOG_NAME;\n+import static org.apache.iotdb.db.engine.tsfilemanagement.utils.HotCompactionLogger.SOURCE_NAME;\n+import static org.apache.iotdb.db.engine.tsfilemanagement.utils.HotCompactionLogger.TARGET_NAME;\n+import static org.apache.iotdb.tsfile.common.constant.TsFileConstant.TSFILE_SUFFIX;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.nio.file.Files;\n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.HashMap;\n+import java.util.HashSet;\n+import java.util.Iterator;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Map.Entry;\n+import java.util.Set;\n+import java.util.TreeSet;\n+import java.util.concurrent.CopyOnWriteArrayList;\n+import java.util.concurrent.locks.ReadWriteLock;\n+import org.apache.iotdb.db.conf.IoTDBDescriptor;\n+import org.apache.iotdb.db.engine.cache.ChunkMetadataCache;\n+import org.apache.iotdb.db.engine.storagegroup.TsFileResource;\n+import org.apache.iotdb.db.engine.tsfilemanagement.TsFileManagement;\n+import org.apache.iotdb.db.engine.tsfilemanagement.utils.HotCompactionLogAnalyzer;\n+import org.apache.iotdb.db.engine.tsfilemanagement.utils.HotCompactionLogger;\n+import org.apache.iotdb.db.engine.tsfilemanagement.utils.HotCompactionUtils;\n+import org.apache.iotdb.db.query.control.FileReaderManager;\n+import org.apache.iotdb.tsfile.file.metadata.ChunkMetadata;\n+import org.apache.iotdb.tsfile.fileSystem.FSFactoryProducer;\n+import org.apache.iotdb.tsfile.read.common.Path;\n+import org.apache.iotdb.tsfile.write.schema.MeasurementSchema;\n+import org.apache.iotdb.tsfile.write.writer.RestorableTsFileIOWriter;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+public class LevelTsFileManagement extends TsFileManagement {\n+\n+  private static final Logger logger = LoggerFactory.getLogger(LevelTsFileManagement.class);\n+  private int maxLevelNum = IoTDBDescriptor.getInstance().getConfig().getMaxLevelNum();\n+  private final List<TreeSet<TsFileResource>> sequenceTsFileResources = new CopyOnWriteArrayList<>();\n+  private final List<List<TsFileResource>> unSequenceTsFileResources = new CopyOnWriteArrayList<>();\n+  private final List<List<TsFileResource>> forkedSequenceTsFileResources = new ArrayList<>();\n+  private final List<List<TsFileResource>> forkedUnSequenceTsFileResources = new ArrayList<>();\n+\n+  public LevelTsFileManagement(String storageGroupName, String storageGroupDir) {\n+    super(storageGroupName, storageGroupDir);\n+    clear();\n+  }\n+\n+  private void deleteLevelFiles(Collection<TsFileResource> vmMergeTsFiles) {", "originalCommit": "107f83a1d5770044d7a1a8bd03605db442eeb84a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDQ3MDE3OA==", "url": "https://github.com/apache/iotdb/pull/1620#discussion_r474470178", "bodyText": "Why static?", "author": "samperson1997", "createdAt": "2020-08-21T07:30:34Z", "path": "server/src/main/java/org/apache/iotdb/db/engine/tsfilemanagement/level/LevelTsFileManagement.java", "diffHunk": "@@ -0,0 +1,540 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.iotdb.db.engine.tsfilemanagement.level;\n+\n+import static org.apache.iotdb.db.conf.IoTDBConstant.FILE_NAME_SEPARATOR;\n+import static org.apache.iotdb.db.engine.tsfilemanagement.normal.NormalTsFileManagement.compareFileName;\n+import static org.apache.iotdb.db.engine.tsfilemanagement.utils.HotCompactionLogger.HOT_COMPACTION_LOG_NAME;\n+import static org.apache.iotdb.db.engine.tsfilemanagement.utils.HotCompactionLogger.SOURCE_NAME;\n+import static org.apache.iotdb.db.engine.tsfilemanagement.utils.HotCompactionLogger.TARGET_NAME;\n+import static org.apache.iotdb.tsfile.common.constant.TsFileConstant.TSFILE_SUFFIX;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.nio.file.Files;\n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.HashMap;\n+import java.util.HashSet;\n+import java.util.Iterator;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Map.Entry;\n+import java.util.Set;\n+import java.util.TreeSet;\n+import java.util.concurrent.CopyOnWriteArrayList;\n+import java.util.concurrent.locks.ReadWriteLock;\n+import org.apache.iotdb.db.conf.IoTDBDescriptor;\n+import org.apache.iotdb.db.engine.cache.ChunkMetadataCache;\n+import org.apache.iotdb.db.engine.storagegroup.TsFileResource;\n+import org.apache.iotdb.db.engine.tsfilemanagement.TsFileManagement;\n+import org.apache.iotdb.db.engine.tsfilemanagement.utils.HotCompactionLogAnalyzer;\n+import org.apache.iotdb.db.engine.tsfilemanagement.utils.HotCompactionLogger;\n+import org.apache.iotdb.db.engine.tsfilemanagement.utils.HotCompactionUtils;\n+import org.apache.iotdb.db.query.control.FileReaderManager;\n+import org.apache.iotdb.tsfile.file.metadata.ChunkMetadata;\n+import org.apache.iotdb.tsfile.fileSystem.FSFactoryProducer;\n+import org.apache.iotdb.tsfile.read.common.Path;\n+import org.apache.iotdb.tsfile.write.schema.MeasurementSchema;\n+import org.apache.iotdb.tsfile.write.writer.RestorableTsFileIOWriter;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+public class LevelTsFileManagement extends TsFileManagement {\n+\n+  private static final Logger logger = LoggerFactory.getLogger(LevelTsFileManagement.class);\n+  private int maxLevelNum = IoTDBDescriptor.getInstance().getConfig().getMaxLevelNum();\n+  private final List<TreeSet<TsFileResource>> sequenceTsFileResources = new CopyOnWriteArrayList<>();\n+  private final List<List<TsFileResource>> unSequenceTsFileResources = new CopyOnWriteArrayList<>();\n+  private final List<List<TsFileResource>> forkedSequenceTsFileResources = new ArrayList<>();\n+  private final List<List<TsFileResource>> forkedUnSequenceTsFileResources = new ArrayList<>();\n+\n+  public LevelTsFileManagement(String storageGroupName, String storageGroupDir) {\n+    super(storageGroupName, storageGroupDir);\n+    clear();\n+  }\n+\n+  private void deleteLevelFiles(Collection<TsFileResource> vmMergeTsFiles) {\n+    logger.debug(\"{} [hot compaction] merge starts to delete file\", storageGroupName);\n+    for (TsFileResource vmMergeTsFile : vmMergeTsFiles) {\n+      deleteLevelFile(vmMergeTsFile);\n+    }\n+    for (int i = 0; i < maxLevelNum; i++) {\n+      sequenceTsFileResources.get(i).removeAll(vmMergeTsFiles);\n+      unSequenceTsFileResources.get(i).removeAll(vmMergeTsFiles);\n+    }\n+  }\n+\n+  private static void deleteLevelFile(TsFileResource seqFile) {", "originalCommit": "107f83a1d5770044d7a1a8bd03605db442eeb84a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDQ3MDQxNg==", "url": "https://github.com/apache/iotdb/pull/1620#discussion_r474470416", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                } catch (Exception e) {\n          \n          \n            \n                } catch (IOException e) {", "author": "samperson1997", "createdAt": "2020-08-21T07:30:43Z", "path": "server/src/main/java/org/apache/iotdb/db/engine/tsfilemanagement/level/LevelTsFileManagement.java", "diffHunk": "@@ -0,0 +1,540 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.iotdb.db.engine.tsfilemanagement.level;\n+\n+import static org.apache.iotdb.db.conf.IoTDBConstant.FILE_NAME_SEPARATOR;\n+import static org.apache.iotdb.db.engine.tsfilemanagement.normal.NormalTsFileManagement.compareFileName;\n+import static org.apache.iotdb.db.engine.tsfilemanagement.utils.HotCompactionLogger.HOT_COMPACTION_LOG_NAME;\n+import static org.apache.iotdb.db.engine.tsfilemanagement.utils.HotCompactionLogger.SOURCE_NAME;\n+import static org.apache.iotdb.db.engine.tsfilemanagement.utils.HotCompactionLogger.TARGET_NAME;\n+import static org.apache.iotdb.tsfile.common.constant.TsFileConstant.TSFILE_SUFFIX;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.nio.file.Files;\n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.HashMap;\n+import java.util.HashSet;\n+import java.util.Iterator;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Map.Entry;\n+import java.util.Set;\n+import java.util.TreeSet;\n+import java.util.concurrent.CopyOnWriteArrayList;\n+import java.util.concurrent.locks.ReadWriteLock;\n+import org.apache.iotdb.db.conf.IoTDBDescriptor;\n+import org.apache.iotdb.db.engine.cache.ChunkMetadataCache;\n+import org.apache.iotdb.db.engine.storagegroup.TsFileResource;\n+import org.apache.iotdb.db.engine.tsfilemanagement.TsFileManagement;\n+import org.apache.iotdb.db.engine.tsfilemanagement.utils.HotCompactionLogAnalyzer;\n+import org.apache.iotdb.db.engine.tsfilemanagement.utils.HotCompactionLogger;\n+import org.apache.iotdb.db.engine.tsfilemanagement.utils.HotCompactionUtils;\n+import org.apache.iotdb.db.query.control.FileReaderManager;\n+import org.apache.iotdb.tsfile.file.metadata.ChunkMetadata;\n+import org.apache.iotdb.tsfile.fileSystem.FSFactoryProducer;\n+import org.apache.iotdb.tsfile.read.common.Path;\n+import org.apache.iotdb.tsfile.write.schema.MeasurementSchema;\n+import org.apache.iotdb.tsfile.write.writer.RestorableTsFileIOWriter;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+public class LevelTsFileManagement extends TsFileManagement {\n+\n+  private static final Logger logger = LoggerFactory.getLogger(LevelTsFileManagement.class);\n+  private int maxLevelNum = IoTDBDescriptor.getInstance().getConfig().getMaxLevelNum();\n+  private final List<TreeSet<TsFileResource>> sequenceTsFileResources = new CopyOnWriteArrayList<>();\n+  private final List<List<TsFileResource>> unSequenceTsFileResources = new CopyOnWriteArrayList<>();\n+  private final List<List<TsFileResource>> forkedSequenceTsFileResources = new ArrayList<>();\n+  private final List<List<TsFileResource>> forkedUnSequenceTsFileResources = new ArrayList<>();\n+\n+  public LevelTsFileManagement(String storageGroupName, String storageGroupDir) {\n+    super(storageGroupName, storageGroupDir);\n+    clear();\n+  }\n+\n+  private void deleteLevelFiles(Collection<TsFileResource> vmMergeTsFiles) {\n+    logger.debug(\"{} [hot compaction] merge starts to delete file\", storageGroupName);\n+    for (TsFileResource vmMergeTsFile : vmMergeTsFiles) {\n+      deleteLevelFile(vmMergeTsFile);\n+    }\n+    for (int i = 0; i < maxLevelNum; i++) {\n+      sequenceTsFileResources.get(i).removeAll(vmMergeTsFiles);\n+      unSequenceTsFileResources.get(i).removeAll(vmMergeTsFiles);\n+    }\n+  }\n+\n+  private static void deleteLevelFile(TsFileResource seqFile) {\n+    seqFile.writeLock();\n+    try {\n+      ChunkMetadataCache.getInstance().remove(seqFile);\n+      FileReaderManager.getInstance().closeFileAndRemoveReader(seqFile.getTsFilePath());\n+      seqFile.setDeleted(true);\n+      if (seqFile.getTsFile().exists()) {\n+        Files.delete(seqFile.getTsFile().toPath());\n+      }\n+    } catch (Exception e) {", "originalCommit": "107f83a1d5770044d7a1a8bd03605db442eeb84a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "11962e5bce8b439e50f4b4637f44502cd13d9bd5", "url": "https://github.com/apache/iotdb/commit/11962e5bce8b439e50f4b4637f44502cd13d9bd5", "message": "[merge]Fix partition and sonar (#1654)", "committedDate": "2020-08-31T08:57:43Z", "type": "commit"}, {"oid": "838765622c91ca5ee90a3997b29f046cd3e528da", "url": "https://github.com/apache/iotdb/commit/838765622c91ca5ee90a3997b29f046cd3e528da", "message": "[merge]Merge compaction conflicts (#1675)", "committedDate": "2020-09-02T12:46:48Z", "type": "commit"}, {"oid": "7422734f4ac52039f9fb22c2a0539038b5813425", "url": "https://github.com/apache/iotdb/commit/7422734f4ac52039f9fb22c2a0539038b5813425", "message": "Compaction comflicts (#1680)", "committedDate": "2020-09-03T04:53:05Z", "type": "commit"}, {"oid": "3f97e7b6d95057adee78b11b788834d2767795af", "url": "https://github.com/apache/iotdb/commit/3f97e7b6d95057adee78b11b788834d2767795af", "message": "[merge]Compaction conflicts (#1686)", "committedDate": "2020-09-03T13:38:52Z", "type": "commit"}, {"oid": "e68bd0e5dd373bda71b4fbbdfa6aad3f91a75df2", "url": "https://github.com/apache/iotdb/commit/e68bd0e5dd373bda71b4fbbdfa6aad3f91a75df2", "message": "[merge]Compaction conflicts (#1687)", "committedDate": "2020-09-03T13:49:57Z", "type": "commit"}, {"oid": "bb5b9c9552267c7254ee5214e7d872c5e7722ca8", "url": "https://github.com/apache/iotdb/commit/bb5b9c9552267c7254ee5214e7d872c5e7722ca8", "message": "fix conflict", "committedDate": "2020-09-03T14:17:45Z", "type": "commit"}, {"oid": "32fd45db35aed506cabf1daa6887d5d4ba43279d", "url": "https://github.com/apache/iotdb/commit/32fd45db35aed506cabf1daa6887d5d4ba43279d", "message": "fix bug", "committedDate": "2020-09-04T02:40:58Z", "type": "commit"}]}