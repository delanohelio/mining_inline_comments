{"pr_number": 1707, "pr_title": "[Hot compaction] Add upgrade logic for TsFileManagement", "pr_createdAt": "2020-09-08T11:20:12Z", "pr_url": "https://github.com/apache/iotdb/pull/1707", "timeline": [{"oid": "712e43afe27c4bb92ac32f648070ef8e919adec5", "url": "https://github.com/apache/iotdb/commit/712e43afe27c4bb92ac32f648070ef8e919adec5", "message": "recover TsFileProcessor(may not pass ci)", "committedDate": "2020-07-23T10:39:21Z", "type": "commit"}, {"oid": "625e8266e720b0eb214f2a2a93d1033ec368a189", "url": "https://github.com/apache/iotdb/commit/625e8266e720b0eb214f2a2a93d1033ec368a189", "message": "fix ts bug", "committedDate": "2020-07-23T14:10:19Z", "type": "commit"}, {"oid": "f21fbdf21267f42a71c2fadaf02457f1a4d7c4fc", "url": "https://github.com/apache/iotdb/commit/f21fbdf21267f42a71c2fadaf02457f1a4d7c4fc", "message": "Merge pull request #1550 from zhanglingzhe0820/recover_TsFileProcessor\n\nrecover TsFileProcessor(may not pass ci)", "committedDate": "2020-07-29T01:42:57Z", "type": "commit"}, {"oid": "e55e75254ae0f890919052152030bfe6b2c96b52", "url": "https://github.com/apache/iotdb/commit/e55e75254ae0f890919052152030bfe6b2c96b52", "message": "change back recover and query", "committedDate": "2020-07-29T02:48:00Z", "type": "commit"}, {"oid": "8b272324bf2519f7dc1f1b8cecc539bdeca98af2", "url": "https://github.com/apache/iotdb/commit/8b272324bf2519f7dc1f1b8cecc539bdeca98af2", "message": "Merge remote-tracking branch 'origin/master' into merge", "committedDate": "2020-08-12T08:04:36Z", "type": "commit"}, {"oid": "107f83a1d5770044d7a1a8bd03605db442eeb84a", "url": "https://github.com/apache/iotdb/commit/107f83a1d5770044d7a1a8bd03605db442eeb84a", "message": "add tsfilemanage-merge (#1597)\n\n* add tsfilemanage", "committedDate": "2020-08-14T08:16:21Z", "type": "commit"}, {"oid": "11962e5bce8b439e50f4b4637f44502cd13d9bd5", "url": "https://github.com/apache/iotdb/commit/11962e5bce8b439e50f4b4637f44502cd13d9bd5", "message": "[merge]Fix partition and sonar (#1654)", "committedDate": "2020-08-31T08:57:43Z", "type": "commit"}, {"oid": "838765622c91ca5ee90a3997b29f046cd3e528da", "url": "https://github.com/apache/iotdb/commit/838765622c91ca5ee90a3997b29f046cd3e528da", "message": "[merge]Merge compaction conflicts (#1675)", "committedDate": "2020-09-02T12:46:48Z", "type": "commit"}, {"oid": "7422734f4ac52039f9fb22c2a0539038b5813425", "url": "https://github.com/apache/iotdb/commit/7422734f4ac52039f9fb22c2a0539038b5813425", "message": "Compaction comflicts (#1680)", "committedDate": "2020-09-03T04:53:05Z", "type": "commit"}, {"oid": "3f97e7b6d95057adee78b11b788834d2767795af", "url": "https://github.com/apache/iotdb/commit/3f97e7b6d95057adee78b11b788834d2767795af", "message": "[merge]Compaction conflicts (#1686)", "committedDate": "2020-09-03T13:38:52Z", "type": "commit"}, {"oid": "e68bd0e5dd373bda71b4fbbdfa6aad3f91a75df2", "url": "https://github.com/apache/iotdb/commit/e68bd0e5dd373bda71b4fbbdfa6aad3f91a75df2", "message": "[merge]Compaction conflicts (#1687)", "committedDate": "2020-09-03T13:49:57Z", "type": "commit"}, {"oid": "bb5b9c9552267c7254ee5214e7d872c5e7722ca8", "url": "https://github.com/apache/iotdb/commit/bb5b9c9552267c7254ee5214e7d872c5e7722ca8", "message": "fix conflict", "committedDate": "2020-09-03T14:17:45Z", "type": "commit"}, {"oid": "32fd45db35aed506cabf1daa6887d5d4ba43279d", "url": "https://github.com/apache/iotdb/commit/32fd45db35aed506cabf1daa6887d5d4ba43279d", "message": "fix bug", "committedDate": "2020-09-04T02:40:58Z", "type": "commit"}, {"oid": "6d6f9c472ae87f5005a3e50d33a4159040712c8c", "url": "https://github.com/apache/iotdb/commit/6d6f9c472ae87f5005a3e50d33a4159040712c8c", "message": "fix read lock release", "committedDate": "2020-09-04T06:17:20Z", "type": "commit"}, {"oid": "3ffe6cd6b1b5ec55ead48e630e40047f708383db", "url": "https://github.com/apache/iotdb/commit/3ffe6cd6b1b5ec55ead48e630e40047f708383db", "message": "update comment and method", "committedDate": "2020-09-04T06:40:37Z", "type": "commit"}, {"oid": "17e8029eedf46b1ad8f349e8aebb415cdc932f34", "url": "https://github.com/apache/iotdb/commit/17e8029eedf46b1ad8f349e8aebb415cdc932f34", "message": "add hot compaction zh doc", "committedDate": "2020-09-04T07:02:55Z", "type": "commit"}, {"oid": "2deab7b77dd35cbdd4cbae769262830db7c42a75", "url": "https://github.com/apache/iotdb/commit/2deab7b77dd35cbdd4cbae769262830db7c42a75", "message": "update doc", "committedDate": "2020-09-04T07:12:30Z", "type": "commit"}, {"oid": "ffd33d10217445c7c4d971bfe0dae86f8437afcc", "url": "https://github.com/apache/iotdb/commit/ffd33d10217445c7c4d971bfe0dae86f8437afcc", "message": "add tsfilemanage upgrade", "committedDate": "2020-09-08T02:36:57Z", "type": "commit"}, {"oid": "c586a0ddc824da8af7893f161cc67996ee7f57b3", "url": "https://github.com/apache/iotdb/commit/c586a0ddc824da8af7893f161cc67996ee7f57b3", "message": "update lock, doc, upgrade", "committedDate": "2020-09-08T11:01:42Z", "type": "commit"}, {"oid": "dc22ff882212b0efccee212a864c85b3494b4cdd", "url": "https://github.com/apache/iotdb/commit/dc22ff882212b0efccee212a864c85b3494b4cdd", "message": "fix comflicts", "committedDate": "2020-09-08T11:19:36Z", "type": "commit"}, {"oid": "8ee2a8809baabef230f520a797323a520b1ea2f3", "url": "https://github.com/apache/iotdb/commit/8ee2a8809baabef230f520a797323a520b1ea2f3", "message": "update doc and logic", "committedDate": "2020-09-09T03:28:43Z", "type": "commit"}, {"oid": "87ad7d5439c6ea9c7ec6ffdd53bd571250055cd2", "url": "https://github.com/apache/iotdb/commit/87ad7d5439c6ea9c7ec6ffdd53bd571250055cd2", "message": "update doc", "committedDate": "2020-09-09T03:42:51Z", "type": "commit"}, {"oid": "e9cd89784e183e69a0879a46890c31a7d7a0bd89", "url": "https://github.com/apache/iotdb/commit/e9cd89784e183e69a0879a46890c31a7d7a0bd89", "message": "update doc", "committedDate": "2020-09-09T04:06:20Z", "type": "commit"}, {"oid": "231efbb480db0c00b96ed9aaa501890b63926ce4", "url": "https://github.com/apache/iotdb/commit/231efbb480db0c00b96ed9aaa501890b63926ce4", "message": "update doc", "committedDate": "2020-09-09T06:35:30Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTUzNzA5Mg==", "url": "https://github.com/apache/iotdb/pull/1707#discussion_r485537092", "bodyText": "fix", "author": "qiaojialin", "createdAt": "2020-09-09T11:27:11Z", "path": "docs/zh/SystemDesign/StorageEngine/TsFileManagement.md", "diffHunk": "@@ -0,0 +1,223 @@\n+<!--\n+\n+    Licensed to the Apache Software Foundation (ASF) under one\n+    or more contributor license agreements.  See the NOTICE file\n+    distributed with this work for additional information\n+    regarding copyright ownership.  The ASF licenses this file\n+    to you under the Apache License, Version 2.0 (the\n+    \"License\"); you may not use this file except in compliance\n+    with the License.  You may obtain a copy of the License at\n+    \n+        http://www.apache.org/licenses/LICENSE-2.0\n+    \n+    Unless required by applicable law or agreed to in writing,\n+    software distributed under the License is distributed on an\n+    \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+    KIND, either express or implied.  See the License for the\n+    specific language governing permissions and limitations\n+    under the License.\n+\n+-->\n+\n+# TsFileManagement -\u70ed\u5408\u5e76\n+\n+## \u6574\u4f53\u601d\u8def\n+\n+\u73b0\u5728 iotdb \u4f1a\u56e0\u4e3a\u81ea\u52a8\u53c2\u6570\u4f18\u5316\u5c06\u5f88\u5c0f\u7684\u6570\u636e\u5757\u5199\u5165\u6587\u4ef6\uff0c\u4f7f\u5f97\u6570\u636e\u6587\u4ef6\u53d8\u5f97\u96f6\u6563\u5316\uff0c\u8fd9\u5bfc\u81f4\u4e86\u7528\u6237\u8fdb\u884c\u5373\u5e2d\u67e5\u8be2\u65f6\u9700\u8981\u7684\u8bfb\u76d8\u6b21\u6570\u8fc7\u591a\uff0c\u800c\u540e\u671f\u7684\u5408\u5e76\u8fc7\u7a0b\u53c8\u4e0d\u662f\u5373\u65f6\u8fdb\u884c\u7684\uff0c\u8fd9\u5bfc\u81f4\u4e86\u7cfb\u7edf\u5bf9\u70ed\u6570\u636e\u7684\u67e5\u8be2\u6548\u7387\u53d8\u6162\uff0c\u6240\u4ee5\u6211\u4eec\u501f\u9274\u4e86\u865a\u62df\u5185\u5b58\u7684\u601d\u60f3\uff0c\u5728\u5199\u5165\u6d41\u7a0b\u4e2d\u589e\u52a0\u4e86\u70ed\u5408\u5e76\u8fc7\u7a0b\uff0c\u901a\u8fc7\u63d0\u9ad8\u4e00\u90e8\u5206\u5199\u653e\u5927\u4fdd\u8bc1\u4e86\u5199\u5165\u5230\u6b63\u5f0f\u6587\u4ef6\u7684\u6570\u636e\u5757\u4e0d\u5c0f\u4e8e\u7ed9\u5b9a\u9608\u503c\uff0c\u63d0\u5347\u7cfb\u7edf\u5373\u5e2d\u67e5\u8be2\u7684\u6548\u7387\u3002\u5c06\u8fd9\u90e8\u5206\u903b\u8f91\u5199\u5230 StorageGroupProcessor \u91cc\u53bb\uff0c\u9488\u5bf9\u5c01\u53e3\u7684 tsfile \u6587\u4ef6\u8fdb\u884c\u5408\u5e76\u3002\n+\n+- iotdb-engine.properties \u52a0\u4e00\u4e2a\u53c2\u6570 tsfile_manage_strategy\uff1a\u8868\u793a tsfile \u6587\u4ef6\u7ba1\u7406\u7b56\u7565\n+- tsfile_manage_strategy \u5185\u7f6e\u4e24\u4e2a\u7b56\u7565\uff1aLevelStrategy \u548c NormalStrategy\n+- LevelStrategy \u5373\u5f00\u542f\u70ed\u5408\u5e76\u5e76\u4f7f\u7528\u5c42\u7ea7\u5408\u5e76\u65b9\u6cd5\uff0cNormalStrategy \u5373\u5173\u95ed\u70ed\u5408\u5e76\n+- iotdb-engine.properties \u4e2d\u52a0 merge_chunk_point_number\uff1a\u6700\u5927\u7684chunk\u5927\u5c0f\u9650\u5236\uff0cLevelStrategy \u65f6\uff0c\u5f53\u8fbe\u5230\u8be5\u53c2\u6570\u5c31\u5408\u5e76\u5230\u6700\u540e\u4e00\u5c42\n+- iotdb-engine.properties \u52a0\u4e00\u4e2a\u53c2\u6570 max_level_num\uff1aLevelStrategy \u65f6\u6700\u5927\u5c42\u6570\n+- \u65b0\u5efa\u4e00\u4e2a TsFileManagement \u7c7b\uff0c\u4e13\u95e8\u7ba1\u7406 StorageGroupProcessor \u4e2d\u7684 seqFileList \u548c unSeqFileList \uff0c\u5728\u8fd9\u91cc\u5199\u70ed\u5408\u5e76\u7684\u4e3b\u4f53\u903b\u8f91\uff0c\u5bf9\u5916\u62bd\u8c61\u5bf9seqFileList\u548cunSeqFileList\u7684\u4e00\u7cfb\u5217\u6240\u9700\u63a5\u53e3\n+- \u5bf9\u4e8e\u666e\u901a merge \u4f1a\u8c03\u7528 TsFileManagement \u7684 getStableTsFileList() \u6765\u83b7\u53d6\u51c6\u5907\u8fdb\u884c\u6587\u4ef6\u5408\u5e76\u7684\u6587\u4ef6\u5217\u8868\uff0c\u8fd9\u91cc\u5bf9\u4e8e LevelStrategy \u6765\u8bf4\u5c31\u662f\u8fd4\u56de\u7b2c {max_level_num - 1} \u5c42\u7684\u6587\u4ef6\uff0c\u5bf9\u4e8e NormalStrategy \u6765\u8bf4\u5c31\u662f\u8fd4\u56de\u6240\u6709\u6587\u4ef6\u5217\u8868\n+- \u6bcf\u4e00\u6b21\u70ed\u5408\u5e76\u4f1a\u53d6\u7b2c\u4e00\u4e2a\u88ab\u5408\u5e76\u6587\u4ef6\u7684\u65f6\u95f4\u6233\u4f5c\u4e3a\u65b0\u6587\u4ef6\u7684\u65f6\u95f4\u6233\uff0c\u5373 {firstFileTimestamp}-{version}-{mergeVerion + 1}.tsfiles\n+\n+## TsFileManagement \u5bf9\u5916\u63d0\u4f9b\u7684\u63a5\u53e3\u548c\u7c7b\n+\n+- TsFileManagement \u4e5f\u7ba1\u7406\u672a\u5c01\u53e3\u6587\u4ef6\n+- TsFileManagement \u540c\u65f6\u7ba1\u7406 Seq \u548c UnSeq \u6587\u4ef6\u5217\u8868\uff0c\u5728 StorageGroupProcessor \u4e2d\u53ea\u521b\u5efa\u4e00\u4e2a TsFileManagement\n+- List\\<TsFileResource\\> getStableTsFileList() \u5bf9\u5916\u63d0\u4f9b\u7a33\u5b9a\u7684 TsFileResource \u5217\u8868\n+- List\\<TsFileResource\\> getTsFileList(boolean sequence) \u5bf9\u5916\u63d0\u4f9b\uff08\u987a\u5e8f/\u4e71\u5e8f\uff09\u6587\u4ef6\u5217\u8868\uff08\u5982\u679c sequence = true\uff0c\u5219\u63d0\u4f9b\u6309\u65f6\u95f4\u6233\u987a\u5e8f\u7684\u5217\u8868\uff09\n+- Iterator\\<TsFileResource\\> getIterator(boolean sequence) \u5bf9\u5916\u63d0\u4f9b\uff08\u987a\u5e8f/\u4e71\u5e8f\uff09\u6587\u4ef6\u8fed\u4ee3\u5668\uff08\u5982\u679c sequence = true\uff0c\u5219\u63d0\u4f9b\u6309\u65f6\u95f4\u6233\u987a\u5e8f\u7684\u8fed\u4ee3\u5668\uff09\n+- void remove(TsFileResource tsFileResource, boolean sequence) \u5220\u9664\u5bf9\u5e94\u7684 TsFileResource \u6587\u4ef6\n+- void removeAll(List\\<TsFileResource\\> tsfileReourceList, boolean sequence) \u5220\u9664\u5bf9\u5e94\u7684 TsFileResource \u5217\u8868\n+- void addAll(List\\<TsFileResource\\> tsfileReourceList, boolean sequence) \u6279\u91cf\u52a0\u5165 TsFileResource \u5217\u8868\n+- boolean isEmpty(boolean sequence) \u662f\u5426\u4e3a\u7a7a\n+- int size(boolean sequence) \u5bf9\u5e94\u7684\u6587\u4ef6\u5217\u8868\u957f\u5ea6\n+- void forkCurrentFileList(long timePartition) \u4fdd\u5b58\u5f53\u524d\u6587\u4ef6\u7684\u67d0\u65f6\u95f4\u5206\u533a\u5217\u8868\n+- void recover() \u8c03\u7528\u5bf9\u5e94\u7684\u6062\u590d\u6d41\u7a0b\n+- HotCompactionMergeTask \u8c03\u7528\u5bf9\u5e94\u7684\u5f02\u6b65\u5408\u5e76\u6d41\u7a0b\uff0c\u4f20\u5165 closeUnsealedTsFileProcessorCallBack \u4ee5\u901a\u77e5\u5916\u90e8\u7c7b\u5408\u5e76\u7ed3\u675f\n+\n+## LevelStrategy merge \u6d41\u7a0b\n+\n+* \u5916\u90e8\u8c03\u7528 forkCurrentFileList(long timePartition) \u4fdd\u5b58\u5f53\u524d\u6587\u4ef6\u7684\u67d0\u65f6\u95f4\u5206\u533a\u5217\u8868\n+  * \u8fd9\u91cc\u9009\u62e9\u7684\u6587\u4ef6\u5217\u8868 chunk \u70b9\u6570\u4e4b\u548c\u4e0d\u8d85\u51fa merge_chunk_point_number\n+* \u5916\u90e8\u5f02\u6b65\u521b\u5efa\u5e76\u63d0\u4ea4 merge \u7ebf\u7a0b\n+* \u5224\u65ad\u662f\u5426\u8981\u8fdb\u884c\u5168\u5c40\u70ed\u5408\u5e76\n+\t* \u751f\u6210\u76ee\u6807\u6587\u4ef6 {first_file_name}-{max_level_num - 1}.tsfile\n+\t* \u751f\u6210\u5408\u5e76\u65e5\u5fd7 .hot_compaction.log\n+\t* \u8bb0\u5f55\u662f\u5168\u5c40\u5408\u5e76\n+\t* \u8bb0\u5f55\u76ee\u6807\u6587\u4ef6\n+\t* \u8fdb\u884c\u5408\u5e76\uff08\u8bb0\u5f55\u65e5\u5fd7 device - offset\uff09\n+\t* \u8bb0\u5f55\u5b8c\u6210\u5408\u5e76\n+* \u5faa\u73af\u5224\u65ad\u6bcf\u4e00\u5c42\u7684\u6587\u4ef6\u662f\u5426\u8981\u5408\u5e76\u5230\u4e0b\u4e00\u5c42\n+\t* \u751f\u6210\u76ee\u6807\u6587\u4ef6 {first_file_name}-{level + 1}.tsfile\n+\t* \u751f\u6210\u5408\u5e76\u65e5\u5fd7 .hot_compaction.log\n+\t* \u8bb0\u5f55\u662f\u5168\u5c40\u5408\u5e76", "originalCommit": "231efbb480db0c00b96ed9aaa501890b63926ce4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTU0OTUzOA==", "url": "https://github.com/apache/iotdb/pull/1707#discussion_r485549538", "bodyText": "I fix it to level", "author": "zhanglingzhe0820", "createdAt": "2020-09-09T11:51:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTUzNzA5Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTUzNzYyMg==", "url": "https://github.com/apache/iotdb/pull/1707#discussion_r485537622", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            0: t2-0 t3-0 t4-0\n          \n          \n            \n            level-0: t2-0 t3-0 t4-0\n          \n      \n    \n    \n  \n\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            0: t2-0 t3-0 t4-0\n          \n          \n            \n            0: t2-0 t3-0 t4-0", "author": "qiaojialin", "createdAt": "2020-09-09T11:28:22Z", "path": "docs/zh/SystemDesign/StorageEngine/TsFileManagement.md", "diffHunk": "@@ -0,0 +1,223 @@\n+<!--\n+\n+    Licensed to the Apache Software Foundation (ASF) under one\n+    or more contributor license agreements.  See the NOTICE file\n+    distributed with this work for additional information\n+    regarding copyright ownership.  The ASF licenses this file\n+    to you under the Apache License, Version 2.0 (the\n+    \"License\"); you may not use this file except in compliance\n+    with the License.  You may obtain a copy of the License at\n+    \n+        http://www.apache.org/licenses/LICENSE-2.0\n+    \n+    Unless required by applicable law or agreed to in writing,\n+    software distributed under the License is distributed on an\n+    \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+    KIND, either express or implied.  See the License for the\n+    specific language governing permissions and limitations\n+    under the License.\n+\n+-->\n+\n+# TsFileManagement -\u70ed\u5408\u5e76\n+\n+## \u6574\u4f53\u601d\u8def\n+\n+\u73b0\u5728 iotdb \u4f1a\u56e0\u4e3a\u81ea\u52a8\u53c2\u6570\u4f18\u5316\u5c06\u5f88\u5c0f\u7684\u6570\u636e\u5757\u5199\u5165\u6587\u4ef6\uff0c\u4f7f\u5f97\u6570\u636e\u6587\u4ef6\u53d8\u5f97\u96f6\u6563\u5316\uff0c\u8fd9\u5bfc\u81f4\u4e86\u7528\u6237\u8fdb\u884c\u5373\u5e2d\u67e5\u8be2\u65f6\u9700\u8981\u7684\u8bfb\u76d8\u6b21\u6570\u8fc7\u591a\uff0c\u800c\u540e\u671f\u7684\u5408\u5e76\u8fc7\u7a0b\u53c8\u4e0d\u662f\u5373\u65f6\u8fdb\u884c\u7684\uff0c\u8fd9\u5bfc\u81f4\u4e86\u7cfb\u7edf\u5bf9\u70ed\u6570\u636e\u7684\u67e5\u8be2\u6548\u7387\u53d8\u6162\uff0c\u6240\u4ee5\u6211\u4eec\u501f\u9274\u4e86\u865a\u62df\u5185\u5b58\u7684\u601d\u60f3\uff0c\u5728\u5199\u5165\u6d41\u7a0b\u4e2d\u589e\u52a0\u4e86\u70ed\u5408\u5e76\u8fc7\u7a0b\uff0c\u901a\u8fc7\u63d0\u9ad8\u4e00\u90e8\u5206\u5199\u653e\u5927\u4fdd\u8bc1\u4e86\u5199\u5165\u5230\u6b63\u5f0f\u6587\u4ef6\u7684\u6570\u636e\u5757\u4e0d\u5c0f\u4e8e\u7ed9\u5b9a\u9608\u503c\uff0c\u63d0\u5347\u7cfb\u7edf\u5373\u5e2d\u67e5\u8be2\u7684\u6548\u7387\u3002\u5c06\u8fd9\u90e8\u5206\u903b\u8f91\u5199\u5230 StorageGroupProcessor \u91cc\u53bb\uff0c\u9488\u5bf9\u5c01\u53e3\u7684 tsfile \u6587\u4ef6\u8fdb\u884c\u5408\u5e76\u3002\n+\n+- iotdb-engine.properties \u52a0\u4e00\u4e2a\u53c2\u6570 tsfile_manage_strategy\uff1a\u8868\u793a tsfile \u6587\u4ef6\u7ba1\u7406\u7b56\u7565\n+- tsfile_manage_strategy \u5185\u7f6e\u4e24\u4e2a\u7b56\u7565\uff1aLevelStrategy \u548c NormalStrategy\n+- LevelStrategy \u5373\u5f00\u542f\u70ed\u5408\u5e76\u5e76\u4f7f\u7528\u5c42\u7ea7\u5408\u5e76\u65b9\u6cd5\uff0cNormalStrategy \u5373\u5173\u95ed\u70ed\u5408\u5e76\n+- iotdb-engine.properties \u4e2d\u52a0 merge_chunk_point_number\uff1a\u6700\u5927\u7684chunk\u5927\u5c0f\u9650\u5236\uff0cLevelStrategy \u65f6\uff0c\u5f53\u8fbe\u5230\u8be5\u53c2\u6570\u5c31\u5408\u5e76\u5230\u6700\u540e\u4e00\u5c42\n+- iotdb-engine.properties \u52a0\u4e00\u4e2a\u53c2\u6570 max_level_num\uff1aLevelStrategy \u65f6\u6700\u5927\u5c42\u6570\n+- \u65b0\u5efa\u4e00\u4e2a TsFileManagement \u7c7b\uff0c\u4e13\u95e8\u7ba1\u7406 StorageGroupProcessor \u4e2d\u7684 seqFileList \u548c unSeqFileList \uff0c\u5728\u8fd9\u91cc\u5199\u70ed\u5408\u5e76\u7684\u4e3b\u4f53\u903b\u8f91\uff0c\u5bf9\u5916\u62bd\u8c61\u5bf9seqFileList\u548cunSeqFileList\u7684\u4e00\u7cfb\u5217\u6240\u9700\u63a5\u53e3\n+- \u5bf9\u4e8e\u666e\u901a merge \u4f1a\u8c03\u7528 TsFileManagement \u7684 getStableTsFileList() \u6765\u83b7\u53d6\u51c6\u5907\u8fdb\u884c\u6587\u4ef6\u5408\u5e76\u7684\u6587\u4ef6\u5217\u8868\uff0c\u8fd9\u91cc\u5bf9\u4e8e LevelStrategy \u6765\u8bf4\u5c31\u662f\u8fd4\u56de\u7b2c {max_level_num - 1} \u5c42\u7684\u6587\u4ef6\uff0c\u5bf9\u4e8e NormalStrategy \u6765\u8bf4\u5c31\u662f\u8fd4\u56de\u6240\u6709\u6587\u4ef6\u5217\u8868\n+- \u6bcf\u4e00\u6b21\u70ed\u5408\u5e76\u4f1a\u53d6\u7b2c\u4e00\u4e2a\u88ab\u5408\u5e76\u6587\u4ef6\u7684\u65f6\u95f4\u6233\u4f5c\u4e3a\u65b0\u6587\u4ef6\u7684\u65f6\u95f4\u6233\uff0c\u5373 {firstFileTimestamp}-{version}-{mergeVerion + 1}.tsfiles\n+\n+## TsFileManagement \u5bf9\u5916\u63d0\u4f9b\u7684\u63a5\u53e3\u548c\u7c7b\n+\n+- TsFileManagement \u4e5f\u7ba1\u7406\u672a\u5c01\u53e3\u6587\u4ef6\n+- TsFileManagement \u540c\u65f6\u7ba1\u7406 Seq \u548c UnSeq \u6587\u4ef6\u5217\u8868\uff0c\u5728 StorageGroupProcessor \u4e2d\u53ea\u521b\u5efa\u4e00\u4e2a TsFileManagement\n+- List\\<TsFileResource\\> getStableTsFileList() \u5bf9\u5916\u63d0\u4f9b\u7a33\u5b9a\u7684 TsFileResource \u5217\u8868\n+- List\\<TsFileResource\\> getTsFileList(boolean sequence) \u5bf9\u5916\u63d0\u4f9b\uff08\u987a\u5e8f/\u4e71\u5e8f\uff09\u6587\u4ef6\u5217\u8868\uff08\u5982\u679c sequence = true\uff0c\u5219\u63d0\u4f9b\u6309\u65f6\u95f4\u6233\u987a\u5e8f\u7684\u5217\u8868\uff09\n+- Iterator\\<TsFileResource\\> getIterator(boolean sequence) \u5bf9\u5916\u63d0\u4f9b\uff08\u987a\u5e8f/\u4e71\u5e8f\uff09\u6587\u4ef6\u8fed\u4ee3\u5668\uff08\u5982\u679c sequence = true\uff0c\u5219\u63d0\u4f9b\u6309\u65f6\u95f4\u6233\u987a\u5e8f\u7684\u8fed\u4ee3\u5668\uff09\n+- void remove(TsFileResource tsFileResource, boolean sequence) \u5220\u9664\u5bf9\u5e94\u7684 TsFileResource \u6587\u4ef6\n+- void removeAll(List\\<TsFileResource\\> tsfileReourceList, boolean sequence) \u5220\u9664\u5bf9\u5e94\u7684 TsFileResource \u5217\u8868\n+- void addAll(List\\<TsFileResource\\> tsfileReourceList, boolean sequence) \u6279\u91cf\u52a0\u5165 TsFileResource \u5217\u8868\n+- boolean isEmpty(boolean sequence) \u662f\u5426\u4e3a\u7a7a\n+- int size(boolean sequence) \u5bf9\u5e94\u7684\u6587\u4ef6\u5217\u8868\u957f\u5ea6\n+- void forkCurrentFileList(long timePartition) \u4fdd\u5b58\u5f53\u524d\u6587\u4ef6\u7684\u67d0\u65f6\u95f4\u5206\u533a\u5217\u8868\n+- void recover() \u8c03\u7528\u5bf9\u5e94\u7684\u6062\u590d\u6d41\u7a0b\n+- HotCompactionMergeTask \u8c03\u7528\u5bf9\u5e94\u7684\u5f02\u6b65\u5408\u5e76\u6d41\u7a0b\uff0c\u4f20\u5165 closeUnsealedTsFileProcessorCallBack \u4ee5\u901a\u77e5\u5916\u90e8\u7c7b\u5408\u5e76\u7ed3\u675f\n+\n+## LevelStrategy merge \u6d41\u7a0b\n+\n+* \u5916\u90e8\u8c03\u7528 forkCurrentFileList(long timePartition) \u4fdd\u5b58\u5f53\u524d\u6587\u4ef6\u7684\u67d0\u65f6\u95f4\u5206\u533a\u5217\u8868\n+  * \u8fd9\u91cc\u9009\u62e9\u7684\u6587\u4ef6\u5217\u8868 chunk \u70b9\u6570\u4e4b\u548c\u4e0d\u8d85\u51fa merge_chunk_point_number\n+* \u5916\u90e8\u5f02\u6b65\u521b\u5efa\u5e76\u63d0\u4ea4 merge \u7ebf\u7a0b\n+* \u5224\u65ad\u662f\u5426\u8981\u8fdb\u884c\u5168\u5c40\u70ed\u5408\u5e76\n+\t* \u751f\u6210\u76ee\u6807\u6587\u4ef6 {first_file_name}-{max_level_num - 1}.tsfile\n+\t* \u751f\u6210\u5408\u5e76\u65e5\u5fd7 .hot_compaction.log\n+\t* \u8bb0\u5f55\u662f\u5168\u5c40\u5408\u5e76\n+\t* \u8bb0\u5f55\u76ee\u6807\u6587\u4ef6\n+\t* \u8fdb\u884c\u5408\u5e76\uff08\u8bb0\u5f55\u65e5\u5fd7 device - offset\uff09\n+\t* \u8bb0\u5f55\u5b8c\u6210\u5408\u5e76\n+* \u5faa\u73af\u5224\u65ad\u6bcf\u4e00\u5c42\u7684\u6587\u4ef6\u662f\u5426\u8981\u5408\u5e76\u5230\u4e0b\u4e00\u5c42\n+\t* \u751f\u6210\u76ee\u6807\u6587\u4ef6 {first_file_name}-{level + 1}.tsfile\n+\t* \u751f\u6210\u5408\u5e76\u65e5\u5fd7 .hot_compaction.log\n+\t* \u8bb0\u5f55\u662f\u5168\u5c40\u5408\u5e76\n+\t* \u8bb0\u5f55\u76ee\u6807\u6587\u4ef6\n+\t* \u8fdb\u884c\u5408\u5e76\uff08\u8bb0\u5f55\u65e5\u5fd7 device - offset\uff09\n+\t* \u8bb0\u5f55\u5b8c\u6210\u5408\u5e76\n+* \u52a0\u5199\u9501\n+* \u4ece\u78c1\u76d8\u5220\u6389\u5f85\u5408\u5e76\u7684\u6587\u4ef6\uff0c\u5e76\u4ece\u6b63\u5f0f\u6587\u4ef6\u5217\u8868\u4e2d\u79fb\u9664\n+* \u5220\u9664\u5408\u5e76\u65e5\u5fd7 .hot_compaction.log\n+* \u91ca\u653e\u5199\u9501\n+\n+## LevelStrategy recover \u6d41\u7a0b\n+\n+* \u5982\u679c\u65e5\u5fd7\u6587\u4ef6\u5b58\u5728\n+\t* \u5982\u679c\u662f\u5168\u5c40\u5408\u5e76\uff08\u628a\u6240\u6709\u5c0f\u6587\u4ef6\u5408\u5e76\u5230\u6700\u540e\u4e00\u5c42\uff09\n+\t\t* \u5982\u679c\u5408\u5e76\u6ca1\u7ed3\u675f\n+\t\t\t* \u622a\u65ad\u6587\u4ef6\n+\t\t\t* \u7ee7\u7eed\u5168\u5c40\u5408\u5e76\n+\t* \u5982\u679c\u662f\u5c42\u7ea7\u5408\u5e76\n+\t\t* \u5982\u679c\u5408\u5e76\u6ca1\u7ed3\u675f\n+\t\t\t* \u622a\u65ad\u6587\u4ef6\n+\t\t\t* \u7ee7\u7eed\u5c42\u7ea7\u5408\u5e76\n+* \u5982\u679c\u65e5\u5fd7\u6587\u4ef6\u4e0d\u5b58\u5728\n+\t* \u65e0\u9700\u6062\u590d\n+\n+## LevelStrategy \u4f8b\u5b50\n+\n+\u8bbe\u7f6e max_file_num_in_each_level = 3\uff0ctsfile_manage_strategy = LevelStrategy\uff0c max_level_num = 3\uff0c\u6b64\u65f6\u6587\u4ef6\u7ed3\u6784\u4e3a\uff0c\u7b2c0\u5c42\u3001\u7b2c1\u5c42\u3001\u7b2c2\u5c42\uff0c\u5176\u4e2d\u7b2c2\u5c42\u662f\u4e0d\u518d\u505a\u70ed\u5408\u5e76\u7684\u7a33\u5b9a\u7684\u6587\u4ef6\u5217\u8868\n+\n+### \u5b8c\u5168\u6839\u636e level \u5408\u5e76\u7684\u60c5\u51b5\n+\u5047\u8bbe\u6b64\u65f6\u6574\u4e2a\u7cfb\u7edf\u4e2d\u67095\u4e2a\u6587\u4ef6\uff0c\u6700\u540e\u4e00\u4e2a\u6587\u4ef6\u6ca1\u6709\u5173\u95ed,\u5219\u5176\u7ed3\u6784\u53ca\u987a\u5e8f\u5206\u5e03\u5982\u4e0b\n+0: t2-0 t3-0 t4-0", "originalCommit": "231efbb480db0c00b96ed9aaa501890b63926ce4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTU0OTY1OQ==", "url": "https://github.com/apache/iotdb/pull/1707#discussion_r485549659", "bodyText": "okay, I will add it", "author": "zhanglingzhe0820", "createdAt": "2020-09-09T11:51:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTUzNzYyMg=="}], "type": "inlineReview"}, {"oid": "3ee5fb6a55ca1c6c988a0e6c9ed609e27024a0ff", "url": "https://github.com/apache/iotdb/commit/3ee5fb6a55ca1c6c988a0e6c9ed609e27024a0ff", "message": "update doc", "committedDate": "2020-09-09T11:55:50Z", "type": "commit"}, {"oid": "8c1af4592e332be9cab70dd74576feeb0a22b113", "url": "https://github.com/apache/iotdb/commit/8c1af4592e332be9cab70dd74576feeb0a22b113", "message": "update doc", "committedDate": "2020-09-09T12:20:41Z", "type": "commit"}]}