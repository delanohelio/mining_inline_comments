{"pr_number": 3911, "pr_title": "DHFPROD-4728: Grant role to allow user to export data", "pr_createdAt": "2020-05-04T19:53:54Z", "pr_url": "https://github.com/marklogic/marklogic-data-hub/pull/3911", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTY5Mzc0NQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3911#discussion_r419693745", "bodyText": "Do the Cypress tests actually hit ML? I thought UI tests were just operating against mocks.\nIf they do hit ML, I recommend having a generic \"test user\" and then enhancing the test framework so that it's easy to change roles on that user. That's something we have in the HC JUnit tests.", "author": "rjrudin", "createdAt": "2020-05-04T20:02:40Z", "path": "marklogic-data-hub-central/ui/e2e/cypress/fixtures/users/developer.json", "diffHunk": "@@ -2,5 +2,5 @@\n     \"user-name\": \"dh-dev\",\n     \"description\": \"A data hub dev user\",\n     \"password\": \"dh-dev\",\n-    \"role\": [\"data-hub-developer\"]\n+    \"role\": [\"data-hub-developer\", \"hub-central-entity-exporter\"]", "originalCommit": "b562a9d85b8a3f118b1eb5b6e4b7ee7d5adfaccd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTcwMDM2Mg==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3911#discussion_r419700362", "bodyText": "Yes, Cypress hits ML. Since we deploy data-hub project with all the test users and data before running tests it may be difficult to achieve that at test running stage. I will sync with Srikanth about that.", "author": "timur-isangulov", "createdAt": "2020-05-04T20:14:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTY5Mzc0NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDM5NTIyMw==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3911#discussion_r420395223", "bodyText": "This test can be verified via RTL and not e2e worthy.", "author": "bsrikan", "createdAt": "2020-05-05T20:45:56Z", "path": "marklogic-data-hub-central/ui/e2e/cypress/integration/scenarios.queries.tsx", "diffHunk": "@@ -59,6 +59,13 @@ describe('save/manage queries scenarios', () => {\n         queryComponent.getSubmitButton().click();\n     });\n \n+    it('check export icon displays', () => {", "originalCommit": "b562a9d85b8a3f118b1eb5b6e4b7ee7d5adfaccd", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDM5NTgxNg==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3911#discussion_r420395816", "bodyText": "not e2e worthy. Should be covered using RTL.", "author": "bsrikan", "createdAt": "2020-05-05T20:47:02Z", "path": "marklogic-data-hub-central/ui/e2e/cypress/integration/scenarios.queries.tsx", "diffHunk": "@@ -74,6 +81,51 @@ describe('save/manage queries scenarios', () => {\n         queryComponent.getDeleteQueryYesButton().click({force: true})\n     });\n \n+});\n+\n+describe('save/manage queries scenarios, operator role', () => {\n+\n+    beforeEach(() => {\n+        cy.visit('/');\n+        cy.contains('MarkLogic Data Hub');\n+        cy.loginAsOperator();\n+        cy.wait(500);\n+        homePage.getBrowseEntities().click();\n+        cy.wait(1000);\n+        browsePage.getFacetView();\n+        browsePage.selectEntity('All Entities');\n+    });\n+\n+    it('apply facet search,open save modal and save queries', () => {\n+        browsePage.selectEntity('Customer');\n+        browsePage.getSelectedEntity().should('contain', 'Customer');\n+        cy.wait(500);\n+        browsePage.getFacetItemCheckbox('firstname', 'Kelley').click();\n+        browsePage.getFacetItemCheckbox('firstname', 'Lara').click();\n+        browsePage.getSelectedFacets().should('exist');\n+        browsePage.getGreySelectedFacets('Kelley').should('exist');\n+        browsePage.getFacetApplyButton().should('exist');\n+        browsePage.getFacetApplyButton().click();\n+        browsePage.getSaveModalIcon().click();\n+        cy.wait(500);\n+        browsePage.getSaveQueryName().should('be.visible');\n+        browsePage.getSaveQueryName().type('new-query');\n+        browsePage.getSaveQueryDescription().should('be.visible');\n+        browsePage.getSaveQueryDescription().type('new-query description');\n+        browsePage.getSaveQueryButton().click();\n+        cy.wait(500);\n+        browsePage.getSelectedQuery().should('contain', 'new-query');\n+        browsePage.getSaveQueryButton().should('not.be.visible');\n+        browsePage.getSaveQueriesDropdown().should('be.visible');\n+    });\n+\n+    it('check export icon does not display', () => {", "originalCommit": "b562a9d85b8a3f118b1eb5b6e4b7ee7d5adfaccd", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDM5ODE2Nw==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3911#discussion_r420398167", "bodyText": "I would recommend trying to achieve this using RTL as well. The story is for export data and this test seems to be for search/save queries. Exporting data could be an e2e scenario, although I would recommend trying to use RTL first.", "author": "bsrikan", "createdAt": "2020-05-05T20:51:17Z", "path": "marklogic-data-hub-central/ui/e2e/cypress/integration/scenarios.queries.tsx", "diffHunk": "@@ -74,6 +81,51 @@ describe('save/manage queries scenarios', () => {\n         queryComponent.getDeleteQueryYesButton().click({force: true})\n     });\n \n+});\n+\n+describe('save/manage queries scenarios, operator role', () => {\n+\n+    beforeEach(() => {\n+        cy.visit('/');\n+        cy.contains('MarkLogic Data Hub');\n+        cy.loginAsOperator();\n+        cy.wait(500);\n+        homePage.getBrowseEntities().click();\n+        cy.wait(1000);\n+        browsePage.getFacetView();\n+        browsePage.selectEntity('All Entities');\n+    });\n+\n+    it('apply facet search,open save modal and save queries', () => {", "originalCommit": "b562a9d85b8a3f118b1eb5b6e4b7ee7d5adfaccd", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "538712361c50894f6b813fa425c5436f538d9571", "url": "https://github.com/marklogic/marklogic-data-hub/commit/538712361c50894f6b813fa425c5436f538d9571", "message": "DHFPROD-4728: Grant role to allow user to export data", "committedDate": "2020-05-06T15:29:08Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDkxMTI5NA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3911#discussion_r420911294", "bodyText": "I will approve this now. Just a thought for future tests we add, that the 2 modal visibility tests can be combined with a description \"Verify modal visibility\" and the assertion for not visible until you click on the modal icon can be moved into that test.", "author": "bsrikan", "createdAt": "2020-05-06T16:06:33Z", "path": "marklogic-data-hub-central/ui/src/components/queries/managing/manage-query-modal/manage-query.test.tsx", "diffHunk": "@@ -5,18 +5,35 @@ import ManageQuery from './manage-query';\n \n describe('Query Modal Component', () => {\n \n-    test('Modal is not visible', () => {\n-      const { queryByTestId } =  render(<ManageQuery />);\n+  let query = [{ \"savedQuery\": { \"id\": \"00529904-ed6e-4539-b7d8-eeddaf15aaa4\", \"name\": \"Lee\", \"description\": \"\", \"query\": { \"searchText\": \"\", \"entityTypeIds\": [\"Customer\"], \"selectedFacets\": { \"firstname\": { \"dataType\": \"xs:string\", \"stringValues\": [\"Lee\"] } } }, \"propertiesToDisplay\": [\"id\"], \"owner\": \"admin\", \"systemMetadata\": { \"createdBy\": \"admin\", \"createdDateTime\": \"2020-05-05T14:48:53.206721-07:00\", \"lastUpdatedBy\": \"admin\", \"lastUpdatedDateTime\": \"2020-05-05T14:48:53.206721-07:00\" } } }]\n \n-      expect(queryByTestId('manage-queries-modal')).toBeNull();\n-    });\n+  test('Modal is not visible', () => {\n+    const { queryByTestId } = render(<ManageQuery />);\n+    expect(queryByTestId('manage-queries-modal')).toBeNull();", "originalCommit": "538712361c50894f6b813fa425c5436f538d9571", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDkxNTEyMQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3911#discussion_r420915121", "bodyText": "click event will fail if the testid is not in the document. I would like to avoid assertions that dont add value to a test.\nMoreover I see a patter here, which we should avoid as well.\nAll 3 test steps in 'Modal is visible' is duplicated in subsequent steps. We have to click on the icon, there is no way around it, but in doing so 'Modal is visible' is getting tested automatically and so we dont need a separate test doing just that.", "author": "bsrikan", "createdAt": "2020-05-06T16:12:09Z", "path": "marklogic-data-hub-central/ui/src/components/queries/managing/manage-query-modal/manage-query.test.tsx", "diffHunk": "@@ -5,18 +5,35 @@ import ManageQuery from './manage-query';\n \n describe('Query Modal Component', () => {\n \n-    test('Modal is not visible', () => {\n-      const { queryByTestId } =  render(<ManageQuery />);\n+  let query = [{ \"savedQuery\": { \"id\": \"00529904-ed6e-4539-b7d8-eeddaf15aaa4\", \"name\": \"Lee\", \"description\": \"\", \"query\": { \"searchText\": \"\", \"entityTypeIds\": [\"Customer\"], \"selectedFacets\": { \"firstname\": { \"dataType\": \"xs:string\", \"stringValues\": [\"Lee\"] } } }, \"propertiesToDisplay\": [\"id\"], \"owner\": \"admin\", \"systemMetadata\": { \"createdBy\": \"admin\", \"createdDateTime\": \"2020-05-05T14:48:53.206721-07:00\", \"lastUpdatedBy\": \"admin\", \"lastUpdatedDateTime\": \"2020-05-05T14:48:53.206721-07:00\" } } }]\n \n-      expect(queryByTestId('manage-queries-modal')).toBeNull();\n-    });\n+  test('Modal is not visible', () => {\n+    const { queryByTestId } = render(<ManageQuery />);\n+    expect(queryByTestId('manage-queries-modal')).toBeNull();\n+  });\n \n-    test('Modal is visible', () => {\n-        const { getByTestId } =  render(<ManageQuery />);    \n+  test('Modal is visible', () => {\n+    const { getByTestId } = render(<ManageQuery />);\n+    expect(getByTestId('manage-queries-modal-icon')).toBeInTheDocument();", "originalCommit": "538712361c50894f6b813fa425c5436f538d9571", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "c149d6fcd7a6e4ef46f9dfad7e19ddfd0f2f8962", "url": "https://github.com/marklogic/marklogic-data-hub/commit/c149d6fcd7a6e4ef46f9dfad7e19ddfd0f2f8962", "message": "DHFPROD-4728: Grant role to allow user to export data", "committedDate": "2020-05-06T16:38:29Z", "type": "commit"}, {"oid": "c149d6fcd7a6e4ef46f9dfad7e19ddfd0f2f8962", "url": "https://github.com/marklogic/marklogic-data-hub/commit/c149d6fcd7a6e4ef46f9dfad7e19ddfd0f2f8962", "message": "DHFPROD-4728: Grant role to allow user to export data", "committedDate": "2020-05-06T16:38:29Z", "type": "forcePushed"}]}