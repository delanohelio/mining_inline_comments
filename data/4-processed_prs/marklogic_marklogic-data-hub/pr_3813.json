{"pr_number": 3813, "pr_title": "DHFPROD-3992:Backend work for running the mapping", "pr_createdAt": "2020-04-14T08:52:01Z", "pr_url": "https://github.com/marklogic/marklogic-data-hub/pull/3813", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODEwNjU3Ng==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3813#discussion_r408106576", "bodyText": "Why does stepDefinition needs it own code here?", "author": "rjrudin", "createdAt": "2020-04-14T12:45:12Z", "path": "marklogic-data-hub/src/main/java/com/marklogic/hub/deploy/commands/LoadUserArtifactsCommand.java", "diffHunk": "@@ -142,15 +142,23 @@ protected Modules findModulesWithResolvedBaseDir(String resolvedBaseDir) {\n                         return modules;\n                     }\n                 };\n-                Files.walkFileTree(artifactPath, new SimpleFileVisitor<Path>() {\n-                    @Override\n-                    public FileVisitResult preVisitDirectory(Path dir, BasicFileAttributes attrs) throws IOException {\n-                        if (dir.toFile().isDirectory()) {\n-                            executeWalkWithDataService(dir, modulesFinder, artifactService, typeInfo);\n+                if(\"stepDefinition\".equals(artifactType)){", "originalCommit": "6ed16cf6c854d816cd3b2734bd602cc030a18f38", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTkxODA5MQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3813#discussion_r409918091", "bodyText": "All artifacts are present in base dir except stepdef, hence calling File.walk in case of stepdef,\nalso we don't want to reload the previously loaded mappings(using REST) using DS.", "author": "srinathgit", "createdAt": "2020-04-17T00:07:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODEwNjU3Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODEwODg5MQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3813#discussion_r408108891", "bodyText": "Why aren't we still using http://marklogic.com/data-hub/mappings ?", "author": "rjrudin", "createdAt": "2020-04-14T12:49:00Z", "path": "marklogic-data-hub/src/main/resources/hub-internal-config/triggers/ml-dh-json-new-mapping-create.json", "diffHunk": "@@ -0,0 +1,39 @@\n+{\n+  \"name\": \"ml-dh-json-new-mapping-create\",\n+  \"description\": \"MarkLogic Data Hub JSON mapping creation trigger\",\n+  \"event\": {\n+    \"data-event\": {\n+      \"collection-scope\": {\n+        \"uri\": \"http://marklogic.com/data-hub/mapping-artifact\"", "originalCommit": "6ed16cf6c854d816cd3b2734bd602cc030a18f38", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTkyMDA3MQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3813#discussion_r409920071", "bodyText": "Reverted to  http://marklogic.com/data-hub/mappings", "author": "srinathgit", "createdAt": "2020-04-17T00:13:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODEwODg5MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODExMDYyMA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3813#discussion_r408110620", "bodyText": "Assuming we do need a new collection (that's a separate question), should at least avoid the duplication of the query construction and make a function that accepts a collection name and returns the cts.andQuery.", "author": "rjrudin", "createdAt": "2020-04-14T12:51:24Z", "path": "marklogic-data-hub/src/main/resources/ml-modules/root/data-hub/5/builtins/steps/mapping/default/lib.sjs", "diffHunk": "@@ -15,7 +15,12 @@ function getModel(targetEntity, version = '0.0.1') {\n }\n \n function getMapping(mappingName) {\n-  return fn.head(cts.search(cts.andQuery([cts.collectionQuery('http://marklogic.com/data-hub/mappings'), cts.jsonPropertyValueQuery('name', mappingName, ['case-insensitive'])]), [\"unfiltered\", cts.indexOrder(cts.uriReference(), \"descending\")]));\n+  //Look in new collection, if artifact is not present fallback to the old collection\n+  let mapping =  fn.head(cts.search(cts.andQuery([cts.collectionQuery('http://marklogic.com/data-hub/mapping-artifact'), cts.jsonPropertyValueQuery('name', mappingName, ['case-insensitive'])]), [\"unfiltered\", cts.indexOrder(cts.uriReference(), \"descending\")]));", "originalCommit": "6ed16cf6c854d816cd3b2734bd602cc030a18f38", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODExMTY1NA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3813#discussion_r408111654", "bodyText": "Whoa - why are we supporting another location for the sourceQuery? Why would it be on the mapping?", "author": "rjrudin", "createdAt": "2020-04-14T12:52:59Z", "path": "marklogic-data-hub/src/main/resources/ml-modules/root/data-hub/5/endpoints/collectorLib.sjs", "diffHunk": "@@ -39,11 +43,25 @@ class CollectorLib {\n       return fn.normalizeSpace(`${sourceQuery}`);\n     }\n \n+    //Get sourceQuery from mapping artifact if present\n+    if(combinedOptions.mapping) {", "originalCommit": "6ed16cf6c854d816cd3b2734bd602cc030a18f38", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODExMzE0MQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3813#discussion_r408113141", "bodyText": "If the purpose of this test is to run a flow and not to test the creation of a step, I think it's better just to add the step to the test flow file.", "author": "rjrudin", "createdAt": "2020-04-14T12:55:11Z", "path": "marklogic-data-hub-central/src/test/java/com/marklogic/hub/curation/controllers/FlowControllerTest.java", "diffHunk": "@@ -177,6 +178,39 @@ void runFlow() {\n         JsonNode job = jobsController.getJob(resp.getJobId());\n         String jobStatus = job.get(\"jobStatus\").asText();\n         assertEquals(\"finished\", jobStatus, \"Job status should be 'finished' once threads complete; job doc: \" + job);\n+\n+\n+        addStagingDoc(\"input/mapInput.json\", \"/input/mapInput.json\", \"default-ingestion\");\n+\n+        //Equivalent to adding a step from GUI\n+        controller.createStep(\"testFlow\" , 2, \"{\\n\" +", "originalCommit": "6ed16cf6c854d816cd3b2734bd602cc030a18f38", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODExNDIwOQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3813#discussion_r408114209", "bodyText": "Can you switch this to use the reference project instead of \"run-flow-test\"? I'd like for as many tests as possible to use the reference project. Adding a flow there with an entity-services-mapping would be a very useful addition.", "author": "rjrudin", "createdAt": "2020-04-14T12:56:51Z", "path": "marklogic-data-hub-central/src/test/java/com/marklogic/hub/curation/controllers/FlowControllerTest.java", "diffHunk": "@@ -166,7 +167,7 @@ void getFlow() throws IOException {\n     }\n \n     @Test\n-    void runFlow() {\n+    void runFlow() throws IOException {", "originalCommit": "6ed16cf6c854d816cd3b2734bd602cc030a18f38", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTkxODMzOA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3813#discussion_r409918338", "bodyText": "Used reference-project for the tests", "author": "srinathgit", "createdAt": "2020-04-17T00:08:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODExNDIwOQ=="}], "type": "inlineReview"}, {"oid": "fbda5fd10133f3b38da5603af334ac8abbaa599e", "url": "https://github.com/marklogic/marklogic-data-hub/commit/fbda5fd10133f3b38da5603af334ac8abbaa599e", "message": "DHFPROD-3992:Backend work for running the mapping", "committedDate": "2020-04-17T00:04:28Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTkxOTgyNQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3813#discussion_r409919825", "bodyText": "Spoke with @sbayatpur , she said DHF 5.3.0 will be supported on ML servers  >=9.0-11 for 9.x and >=10.0-2.1 for 10.x. Hence removed the check.", "author": "srinathgit", "createdAt": "2020-04-17T00:13:12Z", "path": "marklogic-data-hub/src/main/java/com/marklogic/hub/step/impl/MappingStepDefinitionImpl.java", "diffHunk": "@@ -42,14 +40,7 @@ public MappingStepDefinitionImpl(String name) {\n \n         options.put(\"sourceDatabase\", HubConfig.DEFAULT_STAGING_NAME);\n         options.put(\"targetDatabase\", HubConfig.DEFAULT_FINAL_NAME);\n-        Versions versions = ApplicationContextReference.getBean(Versions.class);\n-        if (versions == null || versions.isVersionCompatibleWithES()){\n-            setModulePath(\"/data-hub/5/builtins/steps/mapping/entity-services/main.sjs\");\n-        }\n-        else {\n-            setModulePath(\"/data-hub/5/builtins/steps/mapping/default/main.sjs\");\n-        }\n-", "originalCommit": "fbda5fd10133f3b38da5603af334ac8abbaa599e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTkyOTAyMQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3813#discussion_r409929021", "bodyText": "You can remove this, as I'm just going to end up removing it in 4757 since it involves the filesystem. Can remove the line above it too, though you can leave it if you want and I'll delete it as part of 4757.", "author": "rjrudin", "createdAt": "2020-04-17T00:44:35Z", "path": "marklogic-data-hub/src/main/java/com/marklogic/hub/impl/ArtifactManagerImpl.java", "diffHunk": "@@ -52,7 +52,15 @@ public ArrayNode getArtifacts(String artifactType) {\n     public ObjectNode updateArtifact(String artifactType, String artifactName, JsonNode artifactJson) {\n         ObjectNode resp = (ObjectNode) getArtifactService().setArtifact(artifactType, artifactName, artifactJson);\n         writeArtifactInProject(artifactType, (ObjectNode) artifactJson, false);\n-        return resp;\n+        //Write default settings to project", "originalCommit": "fbda5fd10133f3b38da5603af334ac8abbaa599e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTkyOTI1MA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3813#discussion_r409929250", "bodyText": "Can you remove this line of code? retryLimit isn't used anywhere, no need to set it.", "author": "rjrudin", "createdAt": "2020-04-17T00:45:31Z", "path": "marklogic-data-hub/src/main/java/com/marklogic/hub/step/impl/Step.java", "diffHunk": "@@ -134,9 +133,9 @@ public static Step deserialize(JsonNode json) {\n         step.setDescription(jsonObject.getString(\"description\"));\n         step.setOptions(jsonObject.getMap(\"options\"));\n         step.setCustomHook(jsonObject.getNode(\"customHook\"));\n-        step.setRetryLimit(jsonObject.getInt(\"retryLimit\"));\n-        step.setBatchSize(jsonObject.getInt(\"batchSize\"));\n-        step.setThreadCount(jsonObject.getInt(\"threadCount\"));\n+        step.setRetryLimit(jsonObject.getIntValue(\"retryLimit\"));", "originalCommit": "fbda5fd10133f3b38da5603af334ac8abbaa599e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTkzMDUzNw==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3813#discussion_r409930537", "bodyText": "I think this needs to be populated so that you can verify that these are concatenated to the collections specified below. Really need three tests - one where this doesn't exist, one where it's empty, and one where it has at least one value.", "author": "rjrudin", "createdAt": "2020-04-17T00:50:40Z", "path": "marklogic-data-hub/src/test/ml-modules/root/test/suites/data-hub/5/data-services/artifacts/mappingTest.sjs", "diffHunk": "@@ -1,11 +1,64 @@\n const test = require(\"/test/test-helper.xqy\");\n+const DataHubSingleton = require('/data-hub/5/datahub-singleton.sjs');\n+const dataHub = DataHubSingleton.instance();\n const Artifacts = require('/data-hub/5/artifacts/core.sjs');\n+const flowNode  =\n+  {\n+  \"name\": \"testFlow\",\n+  \"steps\": {\n+    \"1\": {\n+      \"name\": \"rty\",\n+      \"options\": {\n+        \"loadData\": {\n+          \"name\": \"rty\"\n+        }\n+      },\n+      \"stepDefinitionName\": \"default-ingestion\",\n+      \"stepDefinitionType\": \"INGESTION\"\n+    },\n+    \"2\": {\n+      \"name\": \"TestMapping\",\n+      \"options\": {\n+        \"mapping\": {\n+          \"name\": \"TestMapping\"\n+        }\n+      },\n+      \"stepDefinitionName\": \"entity-services-mapping\",\n+      \"stepDefinitionType\": \"MAPPING\"\n+    },\n+    \"3\": {\n+      \"name\": \"mapjson\",\n+      \"description\": \"\",\n+      \"options\": {\n+        \"additionalCollections\": [],", "originalCommit": "fbda5fd10133f3b38da5603af334ac8abbaa599e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTkzODUyOA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3813#discussion_r409938528", "bodyText": "flow.addSettingsToFlow() method adds settings to the step options (for all artifacts except 'loadData') only if it looks like this\n    \"<artifact_type>\": {\n      \"name\": \"<artifact_name>\"\n    }\n  } ```\n\n\n\nElse, it should just return the step as is (old versions of step). This is an old version of step. So, the test was to ensure it is returned as is.\n2.  I agree , I will add test to ensure that 'additionalCollections' is concatenated to 'collections' array", "author": "srinathgit", "createdAt": "2020-04-17T01:20:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTkzMDUzNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTkzMDgwMQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3813#discussion_r409930801", "bodyText": "hub-test:load-artifacts should load your entity models for you, no need for this. That avoids duplicating knowledge of how to insert entity models.", "author": "rjrudin", "createdAt": "2020-04-17T00:51:54Z", "path": "marklogic-data-hub/src/test/ml-modules/root/test/suites/data-hub/5/data-services/artifacts/suite-setup.xqy", "diffHunk": "@@ -5,4 +5,18 @@ xquery version \"1.0-ml\";\n import module namespace hub-test = \"http://marklogic.com/data-hub/test\" at \"/test/data-hub-test-helper.xqy\";\n import module namespace test = \"http://marklogic.com/test\" at \"/test/test-helper.xqy\";\n \n+xdmp:invoke-function(function() {", "originalCommit": "fbda5fd10133f3b38da5603af334ac8abbaa599e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTkzNTkzOA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3813#discussion_r409935938", "bodyText": "It loads it to final db, I want entities to be load to staging db . I used hub-test:load-artifacts for loading it to final.", "author": "srinathgit", "createdAt": "2020-04-17T01:11:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTkzMDgwMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDE2MDY3OQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3813#discussion_r410160679", "bodyText": "Okay - I think it'd be better to add a new function to data-hub-test-helper - e.g. \"load-artifacts-into-staging\" - but that can be done later, don't need to do that in this PR.\nI'm missing why the staging db matters though for the test - are there assertions on making sure something exists in both the staging and final db?", "author": "rjrudin", "createdAt": "2020-04-17T11:24:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTkzMDgwMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDMyNjcyMA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3813#discussion_r410326720", "bodyText": "So, the artifact service writes mappings to both staging and final db. In order to write the mappings in both the db, the entities should be present(this is necessitated by the fact that we now write mappings to same collection (http://marklogic.com/data-hub/mappings) as before and it has associate triggers which will fail in generating xslt if entity is not found in staging db.", "author": "srinathgit", "createdAt": "2020-04-17T16:14:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTkzMDgwMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTkzMDg3Ng==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3813#discussion_r409930876", "bodyText": "And delete-artifacts should delete your entity models for you too.", "author": "rjrudin", "createdAt": "2020-04-17T00:52:13Z", "path": "marklogic-data-hub/src/test/ml-modules/root/test/suites/data-hub/5/data-services/artifacts/suite-teardown.xqy", "diffHunk": "@@ -3,4 +3,11 @@ xquery version \"1.0-ml\";\n import module namespace hub-test = \"http://marklogic.com/data-hub/test\" at \"/test/data-hub-test-helper.xqy\";\n import module namespace test = \"http://marklogic.com/test\" at \"/test/test-helper.xqy\";\n \n+xdmp:invoke-function(function() {", "originalCommit": "fbda5fd10133f3b38da5603af334ac8abbaa599e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTkzNjE2MQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3813#discussion_r409936161", "bodyText": "I have used hub-test:delete-artifacts which deletes from final db, this code is to delete from staging db", "author": "srinathgit", "createdAt": "2020-04-17T01:12:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTkzMDg3Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTkzMTUwNw==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3813#discussion_r409931507", "bodyText": "Do you need a new entity type here - can't Customer or Order work? I'd like to keep the reference project down to the bare minimum number of things needed for our tests. It's fine to add some new mappings, I just don't want to add a new entity type unless there's something that Customer and Order aren't sufficient for.", "author": "rjrudin", "createdAt": "2020-04-17T00:54:36Z", "path": "marklogic-data-hub-central/src/test/resources/test-projects/reference-project/entities/Item.entity.json", "diffHunk": "@@ -0,0 +1,30 @@\n+{", "originalCommit": "fbda5fd10133f3b38da5603af334ac8abbaa599e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTk0MjI1Ng==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3813#discussion_r409942256", "bodyText": "I will rework the test to use Customer or Order", "author": "srinathgit", "createdAt": "2020-04-17T01:34:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTkzMTUwNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTkzMTg2NA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3813#discussion_r409931864", "bodyText": "This is great that this is all going away - is there just not a need for StepModel anymore, and Step is sufficient?", "author": "rjrudin", "createdAt": "2020-04-17T00:56:09Z", "path": "marklogic-data-hub-central/src/main/java/com/marklogic/hub/central/controllers/FlowController.java", "diffHunk": "@@ -379,100 +370,13 @@ public StepModel createStep(String flowName, Integer stepOrder, String stepId, S\n         }\n \n         if (existingStep != null && existingStep.isEqual(step)) {\n-            return transformStepToWebModel(existingStep);\n+            return existingStep;\n         }\n \n         flowManager.saveFlow(flow);\n-        return transformStepToWebModel(step);\n-    }\n-\n-    private List<StepModel> getStepsToWebModel(String flowName) {", "originalCommit": "fbda5fd10133f3b38da5603af334ac8abbaa599e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTk0NDk4MA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3813#discussion_r409944980", "bodyText": "If the step is going to look something like the one below, I don't think it's needed. We allowed creating custom steps in QS, hence StepModel contained \"modulePath\"  (which was not in Step) which was used to create a step definition and a step in the backend. Since we won't do that, I believe it wouldn't be necessary. We can include it if there is a need\n    \"1\" : {\n      \"name\" : \"mapItem\",\n      \"options\" : {\n        \"mapping\" : {\n          \"name\" : \"mapItem\"\n        }\n      },\n      \"stepDefinitionName\" : \"entity-services-mapping\",\n      \"stepDefinitionType\" : \"MAPPING\"\n    }", "author": "srinathgit", "createdAt": "2020-04-17T01:44:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTkzMTg2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDE1ODczMw==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3813#discussion_r410158733", "bodyText": "Sounds good!", "author": "rjrudin", "createdAt": "2020-04-17T11:20:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTkzMTg2NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTkzMjc1Ng==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3813#discussion_r409932756", "bodyText": "Does FlowRunnerImpl not need the \"fully populated\" flow document? Only the ML code needs it?", "author": "rjrudin", "createdAt": "2020-04-17T00:59:47Z", "path": "marklogic-data-hub/src/main/resources/ml-modules/root/data-hub/5/impl/flow.sjs", "diffHunk": "@@ -102,22 +103,53 @@ class Flow {\n     if (cachedFlows[name] === undefined) {\n       let uriMatches = cts.uriMatch('/flows/' + name + '.flow.json', ['case-insensitive'], cts.directoryQuery(\"/flows/\"));\n       // cache flow to prevent repeated calls.\n+      let flowObject;\n       if (fn.count(uriMatches) === 1) {\n-        cachedFlows[name] = cts.doc(fn.head(uriMatches)).toObject();\n+        flowObject = cts.doc(fn.head(uriMatches)).toObject();\n       } else if (fn.count(uriMatches) > 1) {\n         for (let uri of uriMatches) {\n           if (uri === '/flows/' + name + '.flow.json') {\n-            cachedFlows[name] = cts.doc(uriMatches).toObject();\n+            flowObject  = cts.doc(uriMatches).toObject();\n             break;\n           }\n         }\n       } else {\n         cachedFlows[name] = null;\n+        return null;\n       }\n+      flowObject = this.addSettingsToFlow(name, flowObject);\n+      cachedFlows[name] = flowObject;\n     }\n     return cachedFlows[name];\n   }\n \n+  addSettingsToFlow(flowName, flowNode){", "originalCommit": "fbda5fd10133f3b38da5603af334ac8abbaa599e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTk0MTEzMQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3813#discussion_r409941131", "bodyText": "WriteStepRunner requires the \"fully populated\" document, I believe steps that use QueryStepRunner don't (except for 'disableJobOutput' property which is not part of settings artifact). I think Ryan's code takes care of getting the settings doc and applying them in case of WriteStepRunner\nI initially changed core.sjs/getArtifact() to return \"fully populated\" flow doc  (FlowManager.getFlow()  and in turn FlowRunner uses it).  It worked fine but whenever a flow is edited (add/remove step) , the flows that gets written back has  the fully populated document (since when creating/deleting a new step, we get the flow (fully populated doc) and adds steps to it and persists it (unless we choose to create and use a different method to get the flow doc in the db in case of creating/deleting a step). So, I moved this method from core.sjs 's getArtifact to impl/flows.sjs 's getFlow() method", "author": "srinathgit", "createdAt": "2020-04-17T01:30:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTkzMjc1Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDcxNDA3OA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3813#discussion_r410714078", "bodyText": "Added a new endpoint that gets fullFlow() to be used by FlowRunner", "author": "srinathgit", "createdAt": "2020-04-18T15:44:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTkzMjc1Ng=="}], "type": "inlineReview"}, {"oid": "125c93b8b721de50d1d649918d25e61b23a7a2dc", "url": "https://github.com/marklogic/marklogic-data-hub/commit/125c93b8b721de50d1d649918d25e61b23a7a2dc", "message": "DHFPROD-3992:Backend work for running the mapping", "committedDate": "2020-04-18T15:45:36Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDcyNTk3OA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3813#discussion_r410725978", "bodyText": "You don't need this, the task is generated dynamically based on your service.json file. In fact, you can delete the two task definitions above it.", "author": "rjrudin", "createdAt": "2020-04-18T17:26:14Z", "path": "marklogic-data-hub/build.gradle", "diffHunk": "@@ -200,6 +200,10 @@ task generateEntitySearchInterface(type: com.marklogic.client.tools.gradle.Endpo\n     serviceDeclarationFile = dataServicesPath + \"/entitySearch/service.json\"\n }\n \n+task generateFlowInterface(type: com.marklogic.client.tools.gradle.EndpointProxiesGenTask, group: dataServicesGroup) {", "originalCommit": "125c93b8b721de50d1d649918d25e61b23a7a2dc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDcyOTYwMw==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3813#discussion_r410729603", "bodyText": "Removed all 3 tasks", "author": "srinathgit", "createdAt": "2020-04-18T17:57:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDcyNTk3OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDcyNjQ0MQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3813#discussion_r410726441", "bodyText": "This looks good, but shouldn't this go into artifacts/flows.sjs since it's flow-specific?\nAlso @ryanjdew - do we really get any benefit from caching artifacts? That's only good for the duration of the transaction, right? I doubt we need any caching in this function.", "author": "rjrudin", "createdAt": "2020-04-18T17:30:06Z", "path": "marklogic-data-hub/src/main/resources/ml-modules/root/data-hub/5/artifacts/core.sjs", "diffHunk": "@@ -341,6 +353,82 @@ function getEntityTitles() {\n     return cts.search(cts.collectionQuery(\"http://marklogic.com/entity-services/models\")).toArray().map(e => e.xpath(\"//info//title\"));\n }\n \n+function getFullFlow(flowName, artifactVersion = 'latest') {", "originalCommit": "125c93b8b721de50d1d649918d25e61b23a7a2dc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDcyNzkxMg==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3813#discussion_r410727912", "bodyText": "getFullFlow() has to fetch 'loadData', 'mapping', 'matching' artifacts and settings to build full flow. core.sjs provides a generic interface regardless of artifact type to access them(getArtifact, getArtifactSettings), otherwise if this is in flow.sjs, I will have to include each and every module('loadData'.sjs', 'mapping.sjs' etc) and have multiple 'if' conditions for each type of artifact. It seems better to add it here", "author": "srinathgit", "createdAt": "2020-04-18T17:42:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDcyNjQ0MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDcyOTY4OQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3813#discussion_r410729689", "bodyText": "Removed caching for fullFlow()", "author": "srinathgit", "createdAt": "2020-04-18T17:58:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDcyNjQ0MQ=="}], "type": "inlineReview"}, {"oid": "3c668b650200a7e481b203fb07692f22cb01b834", "url": "https://github.com/marklogic/marklogic-data-hub/commit/3c668b650200a7e481b203fb07692f22cb01b834", "message": "DHFPROD-3992:Backend work for running the mapping", "committedDate": "2020-04-18T17:54:53Z", "type": "forcePushed"}, {"oid": "230ccb1915dc7fdc63f94ca115833276e8c5d829", "url": "https://github.com/marklogic/marklogic-data-hub/commit/230ccb1915dc7fdc63f94ca115833276e8c5d829", "message": "DHFPROD-3992:Backend work for running the mapping", "committedDate": "2020-04-18T20:29:27Z", "type": "forcePushed"}, {"oid": "f455f4040865e1a629e3bc7c54d097e4b58afb76", "url": "https://github.com/marklogic/marklogic-data-hub/commit/f455f4040865e1a629e3bc7c54d097e4b58afb76", "message": "DHFPROD-3992:Backend work for running the mapping", "committedDate": "2020-04-20T17:21:49Z", "type": "commit"}, {"oid": "f455f4040865e1a629e3bc7c54d097e4b58afb76", "url": "https://github.com/marklogic/marklogic-data-hub/commit/f455f4040865e1a629e3bc7c54d097e4b58afb76", "message": "DHFPROD-3992:Backend work for running the mapping", "committedDate": "2020-04-20T17:21:49Z", "type": "forcePushed"}]}