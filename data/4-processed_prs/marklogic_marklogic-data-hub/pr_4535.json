{"pr_number": 4535, "pr_title": "DHFPROD-5786: Updates to e2e readme, setup script and build.gradle", "pr_createdAt": "2020-09-08T15:15:11Z", "pr_url": "https://github.com/marklogic/marklogic-data-hub/pull/4535", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTAwMjY5NQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4535#discussion_r485002695", "bodyText": "@SameeraPriyathamTadikonda can you pls verify the steps noted here for DHS is what we follow in  Jenkins as well for e2e tests running against DHS.", "author": "bsrikan", "createdAt": "2020-09-08T15:18:12Z", "path": "marklogic-data-hub-central/ui/e2e/README.md", "diffHunk": "@@ -4,28 +4,39 @@ This hc-qa-project is intended to run HC e2e test.\n \n Run the setup script first from under `marklogic-data-hub-central/ui/e2e` directory, to initialize, deploy and run flows:\n \n-    ./setup.sh dhs=<true/false> mlHost=<curatoinEndpoint/localhost>\n- \n+    For DHS -", "originalCommit": "c1d6a266605caf65d22603105c038d119a754c1a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTAyMjk0MQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4535#discussion_r485022941", "bodyText": "Does \"curation endpoint\" mean \"a host with one or more app servers assigned to the Curation group in ML\"? I ask because I don't believe that group is guaranteed to exist in DHS. I think what matters is that the host has all the app servers that setup.sh depends on.", "author": "rjrudin", "createdAt": "2020-09-08T15:47:34Z", "path": "marklogic-data-hub-central/ui/e2e/README.md", "diffHunk": "@@ -4,28 +4,39 @@ This hc-qa-project is intended to run HC e2e test.\n \n Run the setup script first from under `marklogic-data-hub-central/ui/e2e` directory, to initialize, deploy and run flows:\n \n-    ./setup.sh dhs=<true/false> mlHost=<curatoinEndpoint/localhost>\n- \n+    For DHS -\n+        * Create users as admin using the payload in cypress/fixtures/users for the tests\n+        * ./setup.sh dhs=true mlHost=<curationEndpoint>\n+            * example of curation endpoint is dwgz7dnkj.ec2dentifier10.a.marklogicsvc.com", "originalCommit": "c1d6a266605caf65d22603105c038d119a754c1a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTA2ODQyMA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4535#discussion_r485068420", "bodyText": "curation endpoint is simply the Curation stack: https://docs.marklogic.com/cloudservices/aws/refs/endpoints-and-port-numbers.html and the naming(curation endpoint) is based on its usage across cloud services and our team. The portal API we use to bring up a stack, throws an output saying curationEndpoint=<....> and I understand now from @SameeraPriyathamTadikonda that its now been changed to httpsendpoint.\nIts just how curation stack is referred to.", "author": "bsrikan", "createdAt": "2020-09-08T17:01:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTAyMjk0MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTA4NDkwNg==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4535#discussion_r485084906", "bodyText": "I believe curation endpoint is the loadbalancer endpoint which will redirect to MLHost in the cluster.", "author": "SameeraPriyathamTadikonda", "createdAt": "2020-09-08T17:30:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTAyMjk0MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTAyNDM0Mw==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4535#discussion_r485024343", "bodyText": "Instead of requiring a property to be specified, I recommend making two concrete tasks - e.g. verifyStagingCounts and verifyFinalCounts. Those are easier for a user to invoke and they have self-documenting task names.\n\"script\" then becomes a property of your custom task class. CallResourceTask in https://github.com/marklogic-community/ml-gradle/wiki/Writing-your-own-task is an example of that.", "author": "rjrudin", "createdAt": "2020-09-08T15:49:38Z", "path": "marklogic-data-hub-central/ui/e2e/hc-qa-project/build.gradle", "diffHunk": "@@ -49,3 +51,32 @@ task loadThesaurus(type: com.marklogic.gradle.task.MlcpTask) {\n }\n \n hubDeployAsDeveloper.finalizedBy(\"loadThesaurus\")\n+\n+class DocCount extends HubTask {\n+    @TaskAction\n+    def getDocCount() {\n+        int result\n+        String script\n+        def client\n+        def propName = \"database\"\n+        def database = project.hasProperty(propName) ? project.property(propName).toString() : null\n+        if (database == null) {\n+            throw new GradleException(\"Please specify a database via -Pdatabase=(name of staging or final database)\")\n+        } else if(database == \"staging\") {", "originalCommit": "c1d6a266605caf65d22603105c038d119a754c1a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "c79ab636ffd2d9c30bcb393dc80830c13c2bfdd3", "url": "https://github.com/marklogic/marklogic-data-hub/commit/c79ab636ffd2d9c30bcb393dc80830c13c2bfdd3", "message": "DHFPROD-5786: Updates to e2e readme, setup script and build.gradle to include task to verify flow", "committedDate": "2020-09-08T16:36:55Z", "type": "forcePushed"}, {"oid": "d71cb4db0867636c89c3d6d5c415b8dc087239d5", "url": "https://github.com/marklogic/marklogic-data-hub/commit/d71cb4db0867636c89c3d6d5c415b8dc087239d5", "message": "DHFPROD-5786: Updates to e2e readme, setup script and build.gradle to include task to verify flow", "committedDate": "2020-09-08T16:37:52Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTA2OTYzNA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4535#discussion_r485069634", "bodyText": "Will fix the typo here.", "author": "bsrikan", "createdAt": "2020-09-08T17:03:30Z", "path": "marklogic-data-hub-central/ui/e2e/hc-qa-project/build.gradle", "diffHunk": "@@ -49,3 +52,27 @@ task loadThesaurus(type: com.marklogic.gradle.task.MlcpTask) {\n }\n \n hubDeployAsDeveloper.finalizedBy(\"loadThesaurus\")\n+\n+class DocCount extends HubTask {\n+    DatabaseClient client\n+    String script\n+    @TaskAction\n+    def getDocCount() {\n+        int result = Integer.parseInt(client.newServerEval().javascript(script).evalAs(String.class));\n+        if(result != 34) {\n+            throw new GradleException(\"Record count did not match. Expected 34 in ${client.getDatabase()} database, got \"+ result)\n+        } else {\n+            println(\"Flow/steps were run successfully and got expected number of records in ${client.getDatabase()} database\")\n+        }\n+    }\n+}\n+\n+task verifyStagingCounts(type: DocCount) {\n+    client = hubConfig.newStagingClient()\n+    script = \"fn.count(fn.collection(['loadCustomersJSON', 'loadCustomersXML', 'order-input', 'loadPersonJSON']))\"\n+}\n+\n+task verifyFinalCounts(type: DocCount) {\n+    client = hubConfig.newFinalClient()\n+    script = \"fn.count(fn.cverifyFinalCountsollection(['mapCustomersJSON', 'mapCustomersXML', 'map-orders', 'mapPersonJSON']))\"", "originalCommit": "d71cb4db0867636c89c3d6d5c415b8dc087239d5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "b127fd1e03d83bd82bcf9be30f0ed81353b59e96", "url": "https://github.com/marklogic/marklogic-data-hub/commit/b127fd1e03d83bd82bcf9be30f0ed81353b59e96", "message": "DHFPROD-5786: Updates to e2e readme, setup script and build.gradle to include task to verify flow", "committedDate": "2020-09-08T17:11:47Z", "type": "commit"}, {"oid": "b127fd1e03d83bd82bcf9be30f0ed81353b59e96", "url": "https://github.com/marklogic/marklogic-data-hub/commit/b127fd1e03d83bd82bcf9be30f0ed81353b59e96", "message": "DHFPROD-5786: Updates to e2e readme, setup script and build.gradle to include task to verify flow", "committedDate": "2020-09-08T17:11:47Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTA3NTcxMQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4535#discussion_r485075711", "bodyText": "The task with typo was still passing. Added finally and now both the tasks fail when expected. to", "author": "bsrikan", "createdAt": "2020-09-08T17:14:28Z", "path": "marklogic-data-hub-central/ui/e2e/hc-qa-project/build.gradle", "diffHunk": "@@ -49,3 +52,31 @@ task loadThesaurus(type: com.marklogic.gradle.task.MlcpTask) {\n }\n \n hubDeployAsDeveloper.finalizedBy(\"loadThesaurus\")\n+\n+class DocCount extends HubTask {\n+    DatabaseClient client\n+    String script\n+    @TaskAction\n+    def getDocCount() {\n+        try {\n+            int result = Integer.parseInt(client.newServerEval().javascript(script).evalAs(String.class));\n+            if(result != 34) {\n+                throw new GradleException(\"Record count did not match. Expected 34 in ${client.getDatabase()} database, got \"+ result)\n+            } else {\n+                println(\"Flow/steps were run successfully and got expected number of records in ${client.getDatabase()} database\")\n+            }\n+        } finally {\n+            client.release()", "originalCommit": "b127fd1e03d83bd82bcf9be30f0ed81353b59e96", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTEwMjA0Mw==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4535#discussion_r485102043", "bodyText": "Quick note - fn.count on fn.collection works fine if the counts are in the thousands or less, maybe tens of thousands. But it forces every document to be read in.\nThe faster approach is cts.estimate(cts.collectionQuery(['...'])) . That will return a subsecond response for any number of results.", "author": "rjrudin", "createdAt": "2020-09-08T18:02:46Z", "path": "marklogic-data-hub-central/ui/e2e/hc-qa-project/build.gradle", "diffHunk": "@@ -49,3 +52,31 @@ task loadThesaurus(type: com.marklogic.gradle.task.MlcpTask) {\n }\n \n hubDeployAsDeveloper.finalizedBy(\"loadThesaurus\")\n+\n+class DocCount extends HubTask {\n+    DatabaseClient client\n+    String script\n+    @TaskAction\n+    def getDocCount() {\n+        try {\n+            int result = Integer.parseInt(client.newServerEval().javascript(script).evalAs(String.class));\n+            if(result != 34) {\n+                throw new GradleException(\"Record count did not match. Expected 34 in ${client.getDatabase()} database, got \"+ result)\n+            } else {\n+                println(\"Flow/steps were run successfully and got expected number of records in ${client.getDatabase()} database\")\n+            }\n+        } finally {\n+            client.release()\n+        }\n+    }\n+}\n+\n+task verifyStagingCounts(type: DocCount) {\n+    client = hubConfig.newStagingClient()\n+    script = \"fn.count(fn.collection(['loadCustomersJSON', 'loadCustomersXML', 'order-input', 'loadPersonJSON']))\"", "originalCommit": "b127fd1e03d83bd82bcf9be30f0ed81353b59e96", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}