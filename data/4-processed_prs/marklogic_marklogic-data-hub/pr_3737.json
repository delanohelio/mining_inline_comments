{"pr_number": 3737, "pr_title": "DHFPROD-4504: Not able to persist mapping artifact with same name in another entity", "pr_createdAt": "2020-03-23T17:35:36Z", "pr_url": "https://github.com/marklogic/marklogic-data-hub/pull/3737", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjcyNDE0MA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3737#discussion_r396724140", "bodyText": "Is this doing its own form of validation? The server is validating this already, and throwing an error with a message of \"A mapping with the same name but for a different entity type already exists. Please choose a different name.\".\nIf this is doing the validation by comparing the mapping names to the known set of names already - I don't think that's 100% reliable, because a new mapping could have been created between the time that the UI fetches the set of names and the user then tries to create one. That's why the server has to do the validation. The UI should just catch the error from the server and then display it.", "author": "rjrudin", "createdAt": "2020-03-23T20:04:16Z", "path": "one-ui/ui/src/components/entities/mapping/create-edit-mapping-dialog/create-edit-mapping-dialog.tsx", "diffHunk": "@@ -320,8 +321,8 @@ const CreateEditMappingDialog = (props) => {\n           Name:&nbsp;<span className={styles.asterisk}>*</span>\n           &nbsp;\n             </span>} labelAlign=\"left\"\n-          validateStatus={(mapName || !isMapNameTouched) ? '' : 'error'}\n-          help={(mapName || !isMapNameTouched) ? '' : 'Name is required'}\n+          validateStatus={(mapName || !isMapNameTouched) ? (props.title === 'Edit Mapping' ? '' : (!props.mapNames.hasOwnProperty(mapName) ? '' : 'error')) : 'error'}\n+          help={(mapName || !isMapNameTouched) ? (props.title !== 'Edit Mapping'? (props.mapNames.hasOwnProperty(mapName) ? 'A mapping step with the same name already exists. Enter a unique name.':'') : '') : 'Name is required'}", "originalCommit": "0c9edeeda2cc689b3c930632d0bd291872c0d085", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njc1Mjg3OQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3737#discussion_r396752879", "bodyText": "+1", "author": "bsrikan", "createdAt": "2020-03-23T20:59:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjcyNDE0MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njc5MDc0NA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3737#discussion_r396790744", "bodyText": "@bsrikan - The way it works currently is that as soon as you create a mapping artifact, the react refreshes the entity page showing the new map artifact created. By this time the mapping names object is already refreshed along with the entire mapping list for that entity or else you will not even see the newly created artifact in UI.\nThis approach is really good for validating on the fly as user types the names. Otherwise use will have to click on Save button several times to hit the right name.\nHowever, we can add another validation on top of this on Save button, just to take care of the case where the newly added artifact has not shown up yet in the UI and for some reason user again tries to add another artifact with same name.\nLet me know your thoughts.", "author": "xnikhil08", "createdAt": "2020-03-23T22:18:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjcyNDE0MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njc5NzczMw==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3737#discussion_r396797733", "bodyText": "One problem is that multiple users could try to create the same mapping at the same time. The UI shouldn't do any validation here. It should depend on the server to ensure that two mappings with the same name can't be created. The server will throw an error when that happens, and the UI should then display the error message from the server.", "author": "rjrudin", "createdAt": "2020-03-23T22:35:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjcyNDE0MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjgwMDg4Ng==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3737#discussion_r396800886", "bodyText": "Just handling the error based on the backend server validation (as Rob describes) seems like the cleaner way to do this. I don't think this error is common enough to require the on-the-fly checking. @xnikhil08 are you OK with that?", "author": "wooldridge", "createdAt": "2020-03-23T22:43:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjcyNDE0MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjgwMTA5Mw==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3737#discussion_r396801093", "bodyText": "@rjrudin - OK, but the current server validation throws error only when the same mapping name exists in another entity but doesn't throw any error when it's the same entity. I am assuming we need this validation for same entity as well right?", "author": "xnikhil08", "createdAt": "2020-03-23T22:44:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjcyNDE0MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjgwMzQ5OA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3737#discussion_r396803498", "bodyText": "@wooldridge - Yeah i am fine with it. I guess my only concern was the user experience, if there are a lot more mappings then user would have to keep clicking on the save button to get to the unique value. Thats why now i was thinking of having a sort of combination of both backend and on-the-fly validation.\nBut yeah we can remove the on-the-fly validation completely if thats not needed here.", "author": "xnikhil08", "createdAt": "2020-03-23T22:50:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjcyNDE0MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjgwNTUxMw==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3737#discussion_r396805513", "bodyText": "@xnikhil08 if the backend can be fixed to recognize the case where there are same-name mappings for the same entity, then I think we should just let the backend handle the validation and keep the UI code cleaner.", "author": "wooldridge", "createdAt": "2020-03-23T22:54:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjcyNDE0MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njg2MzEzMQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3737#discussion_r396863131", "bodyText": "@rjrudin , @bsrikan & @wooldridge - Please review now. Updated the PR as discussed.", "author": "xnikhil08", "createdAt": "2020-03-24T02:05:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjcyNDE0MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njc1NjQ3NA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3737#discussion_r396756474", "bodyText": "does this test pass when running locally? The props \"data\" is not right for the mapping card. Try using RTL to render like so and verify if you get back mapping card HTML or an empty div\nimport { render } from \"@testing-library/react\"; \n\ndescribe.... \n\ntest('it renders mapping card div correctly' , () => {\nconst { debug } = render(<MappingCard data />);\ndebug();\n};", "author": "bsrikan", "createdAt": "2020-03-23T21:05:55Z", "path": "one-ui/ui/src/components/entities/mapping/mapping-card.test.tsx", "diffHunk": "@@ -12,6 +12,7 @@ describe('Mapping cards view component', () => {\n       updateMappingArtifact\n       canReadOnly\n       canReadWrite\n-      entityModel/>);\n+      entityModel\n+      mapNames/>);", "originalCommit": "0c9edeeda2cc689b3c930632d0bd291872c0d085", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njg2Mjc4Ng==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3737#discussion_r396862786", "bodyText": "@bsrikan - Yes, it already passes as-is when running locally.", "author": "xnikhil08", "createdAt": "2020-03-24T02:04:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njc1NjQ3NA=="}], "type": "inlineReview"}, {"oid": "9e7a7b1824950e3c08fd1133434bff97a891a4e7", "url": "https://github.com/marklogic/marklogic-data-hub/commit/9e7a7b1824950e3c08fd1133434bff97a891a4e7", "message": "DHFPROD-4504: Validating Map name based on the response from server", "committedDate": "2020-03-24T02:02:08Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzA5ODkyNA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3737#discussion_r397098924", "bodyText": "This is probably safe for now, but I wanted to note that the UI is making an assumption here - that a 400 status means that the name is a duplicate. That isn't guaranteed to be true, and it could certainly change in the future when some other validation rule is added.", "author": "rjrudin", "createdAt": "2020-03-24T12:00:15Z", "path": "one-ui/ui/src/components/entities/mapping/create-edit-mapping-dialog/create-edit-mapping-dialog.tsx", "diffHunk": "@@ -148,9 +149,11 @@ const CreateEditMappingDialog = (props) => {\n \n     let status = await props.createMappingArtifact(dataPayload);\n \n-    if (status === '200') {\n+    if (status.code === 200) {\n       props.setNewMap(false);\n-    } else if (status === '400') {\n+    } else if (status.code === 400) {\n+      \n+      setErrorMessage(status.message)\n       setIsNameDuplicate(true);", "originalCommit": "cc62225e1ae6e5f02679541b4e897297313af1a8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzQxODA0OQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3737#discussion_r397418049", "bodyText": "@rjrudin I'm reading this as that the UI is seeing a 400 error status and displaying the associated error message sent from the backend, there's not an assumption/interpretation of the type of error (e.g., duplicate name) on the UI's part other than it's a 400 status.", "author": "wooldridge", "createdAt": "2020-03-24T19:47:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzA5ODkyNA=="}], "type": "inlineReview"}, {"oid": "e179e6991f7fb38bada66ec612db7020e700210e", "url": "https://github.com/marklogic/marklogic-data-hub/commit/e179e6991f7fb38bada66ec612db7020e700210e", "message": "DHFPROD-4504: Fixing the bug where it was not throwing any error when saving  mapping artifact with same name in another entity.\n (+2 squashed commits)\nSquashed commits:\n[9e7a7b182] DHFPROD-4504: Validating Map name based on the response from server\n[6eb02747b] DHFPROD-4504: Not able to persist mapping artifact with same name in another entity\nAlso fixed the popover issue in one-ui.", "committedDate": "2020-03-24T21:30:45Z", "type": "commit"}, {"oid": "e179e6991f7fb38bada66ec612db7020e700210e", "url": "https://github.com/marklogic/marklogic-data-hub/commit/e179e6991f7fb38bada66ec612db7020e700210e", "message": "DHFPROD-4504: Fixing the bug where it was not throwing any error when saving  mapping artifact with same name in another entity.\n (+2 squashed commits)\nSquashed commits:\n[9e7a7b182] DHFPROD-4504: Validating Map name based on the response from server\n[6eb02747b] DHFPROD-4504: Not able to persist mapping artifact with same name in another entity\nAlso fixed the popover issue in one-ui.", "committedDate": "2020-03-24T21:30:45Z", "type": "forcePushed"}]}