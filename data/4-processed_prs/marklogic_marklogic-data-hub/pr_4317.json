{"pr_number": 4317, "pr_title": "DHFPROD-3577: Global sort based on sortable properties", "pr_createdAt": "2020-07-30T17:43:59Z", "pr_url": "https://github.com/marklogic/marklogic-data-hub/pull/4317", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzE5ODE3Ng==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4317#discussion_r463198176", "bodyText": "You can use StringUtils.capitalize() here", "author": "akshaysonvane", "createdAt": "2020-07-30T18:43:00Z", "path": "marklogic-data-hub-central/src/main/java/com/marklogic/hub/central/entities/search/EntitySearchManager.java", "diffHunk": "@@ -371,32 +346,14 @@ private String getFileNameForDownload(JsonNode queryDocument, String fileExtensi\n         return FILE_PREFIX + queryInfo + SEPARATOR + timestamp + fileExtension;\n     }\n \n-    private void buildSortOrderOptions(StringBuilder sb, SearchQuery searchQuery) {\n+    private void buildSearchTextWithSortOperator(SearchQuery searchQuery) {\n+        StringBuilder searchTextBuilder = new StringBuilder(searchQuery.getQuery().getSearchText());\n         Optional<List<SearchQuery.SortOrder>> sortOrders = searchQuery.getSortOrder();\n-        sortOrders.ifPresent(so -> {\n-            sb.append(\"<options>\");\n-            so.forEach(o -> {\n-                sb.append(\"<sort-order\");\n-                if (!METADATA_FIELD_NAME.contains(o.getName())) {\n-                    sb.append(String.format(\" type=\\\"xs:%s\\\"\", StringEscapeUtils.escapeXml10(o.getDataType())));\n-                }\n-\n-                if (o.isAscending()) {\n-                    sb.append(\" direction=\\\"ascending\\\">\");\n-                }\n-                else {\n-                    sb.append(\" direction=\\\"descending\\\">\");\n-                }\n-\n-                if (METADATA_FIELD_NAME.contains(o.getName())) {\n-                    sb.append(String.format(\"<field name=\\\"%s\\\"/>\\n\", StringEscapeUtils.escapeXml10(o.getName())));\n-                }\n-                else {\n-                    sb.append(String.format(\"<element ns=\\\"\\\" name=\\\"%s\\\"/>\\n\", StringEscapeUtils.escapeXml10(o.getName())));\n-                }\n-                sb.append(\"</sort-order>\");\n-            });\n-            sb.append(\"</options>\");\n-        });\n+        sortOrders.ifPresent(sortOrderList -> sortOrderList.forEach(sortOrder -> {\n+            String sortOperator = \"sort\".concat(sortOrder.getSortOperator().substring(0, 1).toUpperCase()).concat(sortOrder.getSortOperator().substring(1));\n+            String sortDirection = sortOperator.concat(sortOrder.getSortDirection().substring(0, 1).toUpperCase()).concat(sortOrder.getSortDirection().substring(1));", "originalCommit": "ea9cad1264d14cf44d85f6829f6bc9fa170fbb0c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "e1fb0d277de0cd6c5ed38b0e20343e2d01aa7d39", "url": "https://github.com/marklogic/marklogic-data-hub/commit/e1fb0d277de0cd6c5ed38b0e20343e2d01aa7d39", "message": "DHFPROD-3577: Global sort based on sortable properties\n\nAdding tests", "committedDate": "2020-07-30T19:26:40Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzIyNzAzMQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4317#discussion_r463227031", "bodyText": "Are there tests for this line of code? This seems brittle - what if the the namespace prefix is \"aes\"? Then an occurrence of \"aes:\" would end up as \"a*:\", which I believe will fail.\nI recommend putting the conversion of a property path into a constraint name into a separate non-private function and writing unit tests for that. That will both verify and document the behavior of the function.", "author": "rjrudin", "createdAt": "2020-07-30T19:38:40Z", "path": "marklogic-data-hub/src/main/resources/ml-modules/root/data-hub/5/impl/hub-entities.xqy", "diffHunk": "@@ -235,6 +237,28 @@ declare %private function hent:fix-options-exp($nodes as node()*, $sortable-prop\n       default return $n\n };\n \n+declare %private function hent:add-sort-operators-to-search-options($sortable-properties as map:map)\n+{\n+  let $sort-operators :=\n+    for $property-path in map:keys($sortable-properties)\n+      let $property-path := fn:replace($property-path, \"es:\", \"*:\")", "originalCommit": "e1fb0d277de0cd6c5ed38b0e20343e2d01aa7d39", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzIzMDA4Mw==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4317#discussion_r463230083", "bodyText": "Also, see my comment below - I don't think we need property paths here, because for 5.3.0, we're only supporting sorting on top-level properties. Thus, a simple property name will suffice. And I don't think that should have a namespace prefix in it, in which case there's no need to replace \"es:\".", "author": "rjrudin", "createdAt": "2020-07-30T19:44:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzIyNzAzMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzIyOTYzNg==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4317#discussion_r463229636", "bodyText": "We only need a single operator with a name of \"sort\". Then, for every sortable property, we have two states - \"(propertyName)Ascending\" and \"(propertyName)Descending\".\nI believe you can get away with \"propertyName\" and not property path because for 5.3.0, we're only supporting sorting on top-level properties. Thus, we do not need to worry about property paths (we may never have to).", "author": "rjrudin", "createdAt": "2020-07-30T19:43:44Z", "path": "marklogic-data-hub/src/main/resources/ml-modules/root/data-hub/5/impl/hub-entities.xqy", "diffHunk": "@@ -235,6 +237,28 @@ declare %private function hent:fix-options-exp($nodes as node()*, $sortable-prop\n       default return $n\n };\n \n+declare %private function hent:add-sort-operators-to-search-options($sortable-properties as map:map)\n+{\n+  let $sort-operators :=\n+    for $property-path in map:keys($sortable-properties)\n+      let $property-path := fn:replace($property-path, \"es:\", \"*:\")\n+      let $constraint-name := fn:concat(\"sort\", xdmp:initcap(fn:tokenize($property-path, \"/\")[last()]))\n+      return\n+        <search:operator name=\"{$constraint-name}\">", "originalCommit": "e1fb0d277de0cd6c5ed38b0e20343e2d01aa7d39", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzIzMTM0Mg==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4317#discussion_r463231342", "bodyText": "I believe we need two kinds of tests in this class:\n\nOne or more tests that verify that the correct \"criteria\" is constructed based on the SortOrder objects in the SearchQuery\nA test that verifies that inserts two customer entity instances and verifies that sorting on a property in ascending and then descending order returns the 2 instances in the correct order.", "author": "rjrudin", "createdAt": "2020-07-30T19:47:04Z", "path": "marklogic-data-hub-central/src/test/java/com/marklogic/hub/central/entities/search/EntitySearchManagerTest.java", "diffHunk": "@@ -122,41 +122,6 @@ public void testSearchResultsOnNoData() {\n         assertTrue(new EntitySearchManager(getHubClient()).search(query).get().isEmpty());\n     }", "originalCommit": "e1fb0d277de0cd6c5ed38b0e20343e2d01aa7d39", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "28911c6bcb881fcee6257c4aa9292ff8823e5b65", "url": "https://github.com/marklogic/marklogic-data-hub/commit/28911c6bcb881fcee6257c4aa9292ff8823e5b65", "message": "DHFPROD-3577: Global sort based on sortable properties", "committedDate": "2020-08-01T21:20:44Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDEyOTQyNA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4317#discussion_r464129424", "bodyText": "This is fine to keep here - 5626 will turns this into \"/:envelope/:instance/:Book/:title\", just an FYI.", "author": "rjrudin", "createdAt": "2020-08-02T22:11:22Z", "path": "marklogic-data-hub/src/test/ml-modules/root/test/suites/data-hub/5/impl/hub-entities/generateSearchOptions.sjs", "diffHunk": "@@ -135,7 +135,73 @@ function generateExplorerWithFacetableAndSortableProperties() {\n   ];\n }\n \n+function verifySortOperatorsForSortableProperties() {\n+  const input = [{\n+    \"info\" : {\n+      \"title\": \"Book\"\n+    },\n+    \"definitions\": {\n+      \"Book\": {\n+        \"elementRangeIndex\": [\"bookId\"],\n+        \"properties\": {\n+          \"title\": {\"datatype\": \"string\", \"facetable\": true, \"sortable\": true, \"collation\": \"http://marklogic.com/collation/\"},\n+          \"authors\": {\"datatype\": \"array\", \"sortable\": true, \"items\": {\"datatype\": \"string\"}},\n+          \"bookId\": {\"datatype\": \"string\", \"collation\": \"http://marklogic.com/collation/\"},\n+          \"completedDate\": {\"datatype\": \"dateTime\", \"facetable\": true},\n+        }\n+      }\n+    }\n+  }];\n+\n+  const expOptions = hent.dumpSearchOptions(input, true);\n+  return [\n+    test.assertEqual(\"sort\", xs.string(fn.head(expOptions.xpath(\"/*:operator/@name\")))),\n+    test.assertExists(expOptions.xpath(\"/*:operator/*:state[@name = 'titleDescending']\")),\n+    test.assertEqual(\"descending\", xs.string(fn.head(expOptions.xpath(\"/*:operator[@name = 'sort']/*:state[@name = 'titleDescending']/*:sort-order/@direction\")))),\n+    test.assertEqual(\"//*:instance/Book/title\", xs.string(fn.head(expOptions.xpath(\"/*:operator[@name = 'sort']/*:state[@name = 'titleDescending']/*:sort-order/*:path-index\")))),", "originalCommit": "28911c6bcb881fcee6257c4aa9292ff8823e5b65", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDEyOTQ4MQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4317#discussion_r464129481", "bodyText": "I am hoping 5626 removes the need for this, as path expressions will now always have \"/*:\" in them instead of \"/es:\", but I'm not 100% sure of that yet.", "author": "rjrudin", "createdAt": "2020-08-02T22:12:00Z", "path": "marklogic-data-hub/src/test/ml-modules/root/test/suites/data-hub/5/impl/hub-entities/generateSearchOptions.sjs", "diffHunk": "@@ -135,7 +135,73 @@ function generateExplorerWithFacetableAndSortableProperties() {\n   ];\n }\n \n+function verifySortOperatorsForSortableProperties() {\n+  const input = [{\n+    \"info\" : {\n+      \"title\": \"Book\"\n+    },\n+    \"definitions\": {\n+      \"Book\": {\n+        \"elementRangeIndex\": [\"bookId\"],\n+        \"properties\": {\n+          \"title\": {\"datatype\": \"string\", \"facetable\": true, \"sortable\": true, \"collation\": \"http://marklogic.com/collation/\"},\n+          \"authors\": {\"datatype\": \"array\", \"sortable\": true, \"items\": {\"datatype\": \"string\"}},\n+          \"bookId\": {\"datatype\": \"string\", \"collation\": \"http://marklogic.com/collation/\"},\n+          \"completedDate\": {\"datatype\": \"dateTime\", \"facetable\": true},\n+        }\n+      }\n+    }\n+  }];\n+\n+  const expOptions = hent.dumpSearchOptions(input, true);\n+  return [\n+    test.assertEqual(\"sort\", xs.string(fn.head(expOptions.xpath(\"/*:operator/@name\")))),\n+    test.assertExists(expOptions.xpath(\"/*:operator/*:state[@name = 'titleDescending']\")),\n+    test.assertEqual(\"descending\", xs.string(fn.head(expOptions.xpath(\"/*:operator[@name = 'sort']/*:state[@name = 'titleDescending']/*:sort-order/@direction\")))),\n+    test.assertEqual(\"//*:instance/Book/title\", xs.string(fn.head(expOptions.xpath(\"/*:operator[@name = 'sort']/*:state[@name = 'titleDescending']/*:sort-order/*:path-index\")))),\n+    test.assertExists(expOptions.xpath(\"/*:operator/*:state[@name = 'titleAscending']\")),\n+    test.assertEqual(\"ascending\", xs.string(fn.head(expOptions.xpath(\"/*:operator[@name = 'sort']/*:state[@name = 'titleAscending']/*:sort-order/@direction\")))),\n+    test.assertEqual(\"//*:instance/Book/title\", xs.string(fn.head(expOptions.xpath(\"/*:operator[@name = 'sort']/*:state[@name = 'titleAscending']/*:sort-order/*:path-index\")))),\n+    test.assertExists(expOptions.xpath(\"/*:operator/*:state[@name = 'authorsDescending']\")),\n+    test.assertEqual(\"descending\", xs.string(fn.head(expOptions.xpath(\"/*:operator[@name = 'sort']/*:state[@name = 'authorsDescending']/*:sort-order/@direction\")))),\n+    test.assertEqual(\"//*:instance/Book/authors\", xs.string(fn.head(expOptions.xpath(\"/*:operator[@name = 'sort']/*:state[@name = 'authorsDescending']/*:sort-order/*:path-index\")))),\n+    test.assertExists(expOptions.xpath(\"/*:operator/*:state[@name = 'authorsAscending']\")),\n+    test.assertEqual(\"ascending\", xs.string(fn.head(expOptions.xpath(\"/*:operator[@name = 'sort']/*:state[@name = 'authorsAscending']/*:sort-order/@direction\")))),\n+    test.assertEqual(\"//*:instance/Book/authors\", xs.string(fn.head(expOptions.xpath(\"/*:operator[@name = 'sort']/*:state[@name = 'authorsAscending']/*:sort-order/*:path-index\")))),\n+    test.assertNotExists(expOptions.xpath(\"/*:operator[@name = 'bookId']\")),\n+    test.assertNotExists(expOptions.xpath(\"/*:operator[@name = 'completedDate']\"))\n+  ];\n+}\n+\n+function verifyReplaceEsNamespace() {\n+  let propertyPath = \"/es:instance/es:entityType/es:value\";", "originalCommit": "28911c6bcb881fcee6257c4aa9292ff8823e5b65", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDEyOTUzNA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4317#discussion_r464129534", "bodyText": "Are these empty arrays intentionally here to clear out the indexes?", "author": "rjrudin", "createdAt": "2020-08-02T22:12:39Z", "path": "marklogic-data-hub/src/test/resources/test-config/databases/staging-database.json", "diffHunk": "@@ -0,0 +1,5 @@\n+{\n+  \"database-name\": \"data-hub-STAGING\",\n+  \"range-element-index\" : [],", "originalCommit": "28911c6bcb881fcee6257c4aa9292ff8823e5b65", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDE3MzIyNA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4317#discussion_r464173224", "bodyText": "Yes. To restore the staging database index config to the previous state, just as for data-hub-FINAL database. Since there were no indexes previously, I have added empty arrays", "author": "rahulvudutala", "createdAt": "2020-08-03T03:13:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDEyOTUzNA=="}], "type": "inlineReview"}, {"oid": "4eef6a414c01bf3eadf0825fcaf1b335c44db521", "url": "https://github.com/marklogic/marklogic-data-hub/commit/4eef6a414c01bf3eadf0825fcaf1b335c44db521", "message": "DHFPROD-3577: Global sort based on sortable properties\n\nDHFPROD-3577: Addressing Export related changes for Sort", "committedDate": "2020-08-03T17:38:52Z", "type": "commit"}, {"oid": "4eef6a414c01bf3eadf0825fcaf1b335c44db521", "url": "https://github.com/marklogic/marklogic-data-hub/commit/4eef6a414c01bf3eadf0825fcaf1b335c44db521", "message": "DHFPROD-3577: Global sort based on sortable properties\n\nDHFPROD-3577: Addressing Export related changes for Sort", "committedDate": "2020-08-03T17:38:52Z", "type": "forcePushed"}]}