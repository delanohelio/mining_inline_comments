{"pr_number": 4882, "pr_title": "DHFPROD-6229: Dynamic source names for priority order", "pr_createdAt": "2020-11-19T04:39:55Z", "pr_url": "https://github.com/marklogic/marklogic-data-hub/pull/4882", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjg3OTA4MQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4882#discussion_r526879081", "bodyText": "Since \"Activity\" is used elsewhere, I think this should be \"..MergingActivity\" instead of \"..MergingInfo\".", "author": "rjrudin", "createdAt": "2020-11-19T13:28:03Z", "path": "marklogic-data-hub-central/ui/src/components/entities/merging/merging-step-detail/merging-step-detail.tsx", "diffHunk": "@@ -57,11 +59,26 @@ const MergingStepDetail: React.FC = () => {\n         if (Object.keys(curationOptions.activeStep.stepArtifact).length !== 0) {\n             const mergingStepArtifact: MergingStep = curationOptions.activeStep.stepArtifact;\n             setMergingStep(mergingStepArtifact);\n+            retrieveCalculatedMergingInfo(mergingStepArtifact);\n         } else {\n             history.push('/tiles/curate');\n         }\n     }, [JSON.stringify(curationOptions.activeStep.stepArtifact)]);\n \n+    const retrieveCalculatedMergingInfo = async (mergingStepArtifact: MergingStep) => {", "originalCommit": "39b8fa34f020eb39f7092a409691661ad4b2b0b8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODkwMjE2MA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4882#discussion_r528902160", "bodyText": "Any reason to keep this \"Info\" instead of \"Activity\"?", "author": "rjrudin", "createdAt": "2020-11-23T18:11:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjg3OTA4MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjg4MTc4Ng==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4882#discussion_r526881786", "bodyText": "Should remove this, as it's not used and the library has been renamed.", "author": "rjrudin", "createdAt": "2020-11-19T13:30:28Z", "path": "marklogic-data-hub/src/main/resources/ml-modules/root/data-hub/5/data-services/mastering/calculateMergingActivity.sjs", "diffHunk": "@@ -0,0 +1,30 @@\n+/**\n+ Copyright (c) 2020 MarkLogic Corporation\n+\n+ Licensed under the Apache License, Version 2.0 (the \"License\");\n+ you may not use this file except in compliance with the License.\n+ You may obtain a copy of the License at\n+\n+ http://www.apache.org/licenses/LICENSE-2.0\n+\n+ Unless required by applicable law or agreed to in writing, software\n+ distributed under the License is distributed on an \"AS IS\" BASIS,\n+ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ See the License for the specific language governing permissions and\n+ limitations under the License.\n+ */\n+'use strict';\n+\n+const ds = require(\"/data-hub/5/data-services/ds-utils.sjs\");", "originalCommit": "39b8fa34f020eb39f7092a409691661ad4b2b0b8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjg4ODIyMg==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4882#discussion_r526888222", "bodyText": "This is a bit tangential, but what is \"queryLatest\" supposed to mean? It's more confusing to see that than \"xdmp.invokeFunction\" - I have to lookup queryLatest to see what it does, and the only thing of note is that it passes ignoreAmps:true in - and there's no indication of why it's doing that. So why use queryLatest instead of xdmp.invokeFunction?", "author": "rjrudin", "createdAt": "2020-11-19T13:35:03Z", "path": "marklogic-data-hub/src/main/resources/ml-modules/root/data-hub/5/data-services/mastering/calculateMergingActivityLib.sjs", "diffHunk": "@@ -0,0 +1,54 @@\n+/**\n+ Copyright (c) 2020 MarkLogic Corporation\n+\n+ Licensed under the Apache License, Version 2.0 (the \"License\");\n+ you may not use this file except in compliance with the License.\n+ You may obtain a copy of the License at\n+\n+ http://www.apache.org/licenses/LICENSE-2.0\n+\n+ Unless required by applicable law or agreed to in writing, software\n+ distributed under the License is distributed on an \"AS IS\" BASIS,\n+ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ See the License for the specific language governing permissions and\n+ limitations under the License.\n+ */\n+'use strict';\n+\n+const currentDatabaseName = xdmp.databaseName(xdmp.database());\n+\n+function calculateMergingActivity(step)\n+{\n+    let sourceDatabaseName = step.sourceDatabase || currentDatabaseName;\n+    if (sourceDatabaseName !== currentDatabaseName) {\n+        const HubUtils = require(\"/data-hub/5/impl/hub-utils.sjs\");\n+        return new HubUtils().queryLatest(function () {", "originalCommit": "39b8fa34f020eb39f7092a409691661ad4b2b0b8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODAwMDcxMw==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4882#discussion_r528000713", "bodyText": "It has been used to query at the latest timestamp. At the time the function was created we were trying to consolidate functions, like invoke/eval, that required special privileges.", "author": "ryanjdew", "createdAt": "2020-11-20T22:17:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjg4ODIyMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjg5NTMyMQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4882#discussion_r526895321", "bodyText": "Pinging @rahulvudutala  - this query is saying \"I can find instances of an entity type by querying on 'title' or 'es:title'\", while the Explore feature is saying \"I can find instances of an entity type by querying on a collection with the same name as the entity type title\". We should have one way of querying for entities of a particular type - what's the right answer?", "author": "rjrudin", "createdAt": "2020-11-19T13:42:00Z", "path": "marklogic-data-hub/src/main/resources/ml-modules/root/data-hub/5/data-services/mastering/calculateMergingActivityLib.sjs", "diffHunk": "@@ -0,0 +1,54 @@\n+/**\n+ Copyright (c) 2020 MarkLogic Corporation\n+\n+ Licensed under the Apache License, Version 2.0 (the \"License\");\n+ you may not use this file except in compliance with the License.\n+ You may obtain a copy of the License at\n+\n+ http://www.apache.org/licenses/LICENSE-2.0\n+\n+ Unless required by applicable law or agreed to in writing, software\n+ distributed under the License is distributed on an \"AS IS\" BASIS,\n+ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ See the License for the specific language governing permissions and\n+ limitations under the License.\n+ */\n+'use strict';\n+\n+const currentDatabaseName = xdmp.databaseName(xdmp.database());\n+\n+function calculateMergingActivity(step)\n+{\n+    let sourceDatabaseName = step.sourceDatabase || currentDatabaseName;\n+    if (sourceDatabaseName !== currentDatabaseName) {\n+        const HubUtils = require(\"/data-hub/5/impl/hub-utils.sjs\");\n+        return new HubUtils().queryLatest(function () {\n+            return internalCalculateMergingActivity(step);\n+        }, sourceDatabaseName);\n+    } else {\n+        return internalCalculateMergingActivity(step);\n+    }\n+}\n+\n+function internalCalculateMergingActivity(step)\n+{\n+    const targetEntityType = step.targetEntity || step.targetEntityType;\n+    let query = null;\n+    if (targetEntityType) {\n+        let entityTypeTitle = targetEntityType;\n+        if (targetEntityType.includes('/')) {\n+            entityTypeTitle = require(\"/data-hub/5/impl/entity-lib.sjs\").getEntityTypeIdParts(targetEntityType).entityTypeTitle;\n+        }\n+        query = cts.orQuery([", "originalCommit": "39b8fa34f020eb39f7092a409691661ad4b2b0b8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjg5Njk1Ng==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4882#discussion_r526896956", "bodyText": "Pinging @rahulvudutala  - these will need to be updated once the datahubSourceName field index is pointing at datahubSourceName instead of name.", "author": "rjrudin", "createdAt": "2020-11-19T13:44:22Z", "path": "marklogic-data-hub/src/test/ml-modules/root/test/suites/data-hub/5/data-services/mastering/test-data/content/matchSourceQuery.json", "diffHunk": "@@ -0,0 +1,14 @@\n+{\n+  \"envelope\": {\n+    \"headers\": {\n+      \"sources\": [{\n+        \"name\": \"matchingSourceJSON\"", "originalCommit": "39b8fa34f020eb39f7092a409691661ad4b2b0b8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "b256bc64e816f680e4aa0d972fe8ae503b48ba11", "url": "https://github.com/marklogic/marklogic-data-hub/commit/b256bc64e816f680e4aa0d972fe8ae503b48ba11", "message": "DHFPROD-6229: Dynamic source names for priority order", "committedDate": "2020-11-20T23:51:50Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODkyMTk1Mw==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4882#discussion_r528921953", "bodyText": "Wondering if this will have other data besides \"sourceNames\", as \"calculateMergingActivity\" implies to me that possible merges will be calculated.", "author": "rjrudin", "createdAt": "2020-11-23T18:47:35Z", "path": "marklogic-data-hub/src/main/resources/ml-modules/root/data-hub/5/data-services/mastering/calculateMergingActivityLib.sjs", "diffHunk": "@@ -0,0 +1,51 @@\n+/**\n+ Copyright (c) 2020 MarkLogic Corporation\n+\n+ Licensed under the Apache License, Version 2.0 (the \"License\");\n+ you may not use this file except in compliance with the License.\n+ You may obtain a copy of the License at\n+\n+ http://www.apache.org/licenses/LICENSE-2.0\n+\n+ Unless required by applicable law or agreed to in writing, software\n+ distributed under the License is distributed on an \"AS IS\" BASIS,\n+ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ See the License for the specific language governing permissions and\n+ limitations under the License.\n+ */\n+'use strict';\n+\n+const currentDatabaseName = xdmp.databaseName(xdmp.database());\n+\n+function calculateMergingActivity(step)\n+{\n+    let sourceDatabaseName = step.sourceDatabase || currentDatabaseName;\n+    if (sourceDatabaseName !== currentDatabaseName) {\n+        const HubUtils = require(\"/data-hub/5/impl/hub-utils.sjs\");\n+        return new HubUtils().queryLatest(function () {\n+            return internalCalculateMergingActivity(step);\n+        }, sourceDatabaseName);\n+    } else {\n+        return internalCalculateMergingActivity(step);\n+    }\n+}\n+\n+function internalCalculateMergingActivity(step)\n+{\n+    const targetEntityType = step.targetEntity || step.targetEntityType;\n+    let query = null;\n+    if (targetEntityType) {\n+        let entityTypeTitle = targetEntityType;\n+        if (targetEntityType.includes('/')) {\n+            entityTypeTitle = require(\"/data-hub/5/impl/entity-lib.sjs\").getEntityTypeIdParts(targetEntityType).entityTypeTitle;\n+        }\n+        query = cts.collectionQuery(entityTypeTitle);\n+    }\n+    const sourceNames = cts.values(cts.fieldReference('datahubSourceName'), null, null, query).toArray();\n+    return {", "originalCommit": "b256bc64e816f680e4aa0d972fe8ae503b48ba11", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTAwNTkwOA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4882#discussion_r529005908", "bodyText": "In the future, there will at least be warnings for certain situations like if the merge rules don't align with the entity model, etc. See https://project.marklogic.com/jira/browse/DHFPROD-5147", "author": "ryanjdew", "createdAt": "2020-11-23T21:24:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODkyMTk1Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODkyNDU3Ng==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4882#discussion_r528924576", "bodyText": "I think a \"desc\" would be very helpful here to describe what will be returned (which has the benefit of then appearing in the generated Java code).", "author": "rjrudin", "createdAt": "2020-11-23T18:52:13Z", "path": "marklogic-data-hub/src/main/resources/ml-modules/root/data-hub/5/data-services/mastering/calculateMergingActivity.api", "diffHunk": "@@ -0,0 +1,13 @@\n+{\n+  \"functionName\": \"calculateMergingActivity\",", "originalCommit": "b256bc64e816f680e4aa0d972fe8ae503b48ba11", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "f5af4736460f9cb780bb76849ed5c42666128be6", "url": "https://github.com/marklogic/marklogic-data-hub/commit/f5af4736460f9cb780bb76849ed5c42666128be6", "message": "DHFPROD-6229: Dynamic source names for priority order", "committedDate": "2020-11-23T21:34:08Z", "type": "forcePushed"}, {"oid": "d0d9b1e2e3fe4d58c392087c3a1713cfc2676e83", "url": "https://github.com/marklogic/marklogic-data-hub/commit/d0d9b1e2e3fe4d58c392087c3a1713cfc2676e83", "message": "DHFPROD-6229: Dynamic source names for priority order", "committedDate": "2020-11-23T21:42:14Z", "type": "forcePushed"}, {"oid": "0e7171822f45e46594d4f565a6bf738cdaad8d63", "url": "https://github.com/marklogic/marklogic-data-hub/commit/0e7171822f45e46594d4f565a6bf738cdaad8d63", "message": "DHFPROD-6229: Dynamic source names for priority order", "committedDate": "2020-11-24T21:18:42Z", "type": "forcePushed"}, {"oid": "298d3567e435e0adb8e8c4a0ac693e099d3c0956", "url": "https://github.com/marklogic/marklogic-data-hub/commit/298d3567e435e0adb8e8c4a0ac693e099d3c0956", "message": "DHFPROD-6229: Dynamic source names for priority order", "committedDate": "2020-11-25T17:47:14Z", "type": "commit"}, {"oid": "298d3567e435e0adb8e8c4a0ac693e099d3c0956", "url": "https://github.com/marklogic/marklogic-data-hub/commit/298d3567e435e0adb8e8c4a0ac693e099d3c0956", "message": "DHFPROD-6229: Dynamic source names for priority order", "committedDate": "2020-11-25T17:47:14Z", "type": "forcePushed"}]}