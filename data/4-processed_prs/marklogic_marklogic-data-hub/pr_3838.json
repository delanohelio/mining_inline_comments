{"pr_number": 3838, "pr_title": "DHFPROD-4720: Core project now publishes a test fixture for reusability", "pr_createdAt": "2020-04-19T21:28:58Z", "pr_url": "https://github.com/marklogic/marklogic-data-hub/pull/3838", "timeline": [{"oid": "afb556cc1f81262711905154f5f76739f69f7869", "url": "https://github.com/marklogic/marklogic-data-hub/commit/afb556cc1f81262711905154f5f76739f69f7869", "message": "DHFPROD-4720: Core project now publishes a test fixture for reusability\n\nIntent is to remove duplication of test plumbing between core and central. Summary of changes:\n\n- Added new AbstractHubTest as a base class for HubTestBase and AbstractHubCentralTest. It has logic for resetting the project before a test runs, and for load project files. This is accomplished via the new \"testFixturesApi\" - \"java-test-fixture\" is a new feature in Gradle 5.6 for this exact use case, where test fixtures in core can be reused in the other DH projects. \n\n- LoadHubArtifactsCommand no longer has a \"force\" property to it; artifacts are always loaded. Modified it to ensure it never loads two documents with the same URI at the same time, which happens in some scenarios in our tests. \n\n- Modified LoadHubModuledCommand to default to a batch size of 10. In some scenarios when bootstrapping the test app, the config.sjs/config.xqy modules are being loaded twice, which causes a conflicting updates error. This prevents that. \n\n- The Installer program always install the test application. I changed this primarily for local convenience, as I often need to install the test app after e.g. adding a role, and the fact that the test app Installer doesn't run if it thinks DH is already installed is not helpful. \n\n- Replaced temporal-document-write.sjs with WriteDocumentsTest. \n\n- Moved jaeger-config dependency from core into QuickStart, as it's only used there. \n\n- Removed spring-integration dependency from core; it's not needed anywhere.", "committedDate": "2020-04-20T01:10:24Z", "type": "forcePushed"}, {"oid": "dae01734c747230e385258c1d38b1e61a2bf0e6e", "url": "https://github.com/marklogic/marklogic-data-hub/commit/dae01734c747230e385258c1d38b1e61a2bf0e6e", "message": "DHFPROD-4720: Core project now publishes a test fixture for reusability\n\nIntent is to remove duplication of test plumbing between core and central. Summary of changes:\n\n- Added new AbstractHubTest as a base class for HubTestBase and AbstractHubCentralTest. It has logic for resetting the project before a test runs, and for load project files. This is accomplished via the new \"testFixturesApi\" - \"java-test-fixture\" is a new feature in Gradle 5.6 for this exact use case, where test fixtures in core can be reused in the other DH projects. \n\n- LoadHubArtifactsCommand no longer has a \"force\" property to it; artifacts are always loaded. Modified it to ensure it never loads two documents with the same URI at the same time, which happens in some scenarios in our tests. \n\n- Modified LoadHubModuledCommand to default to a batch size of 10. In some scenarios when bootstrapping the test app, the config.sjs/config.xqy modules are being loaded twice, which causes a conflicting updates error. This prevents that. \n\n- The Installer program always install the test application. I changed this primarily for local convenience, as I often need to install the test app after e.g. adding a role, and the fact that the test app Installer doesn't run if it thinks DH is already installed is not helpful. \n\n- Replaced temporal-document-write.sjs with WriteDocumentsTest. \n\n- Moved jaeger-config dependency from core into QuickStart, as it's only used there. \n\n- Removed spring-integration dependency from core; it's not needed anywhere.", "committedDate": "2020-04-20T12:35:55Z", "type": "forcePushed"}, {"oid": "6c00ebad27672a64f78a47e1ee8b53a05404eb54", "url": "https://github.com/marklogic/marklogic-data-hub/commit/6c00ebad27672a64f78a47e1ee8b53a05404eb54", "message": "DHFPROD-4720: Core project now publishes a test fixture for reusability\n\nIntent is to remove duplication of test plumbing between core and central. Summary of changes:\n\n- Added new AbstractHubTest as a base class for HubTestBase and AbstractHubCentralTest. It has logic for resetting the project before a test runs, and for load project files. This is accomplished via the new \"testFixturesApi\" - \"java-test-fixture\" is a new feature in Gradle 5.6 for this exact use case, where test fixtures in core can be reused in the other DH projects. \n\n- LoadHubArtifactsCommand no longer has a \"force\" property to it; artifacts are always loaded. Modified it to ensure it never loads two documents with the same URI at the same time, which happens in some scenarios in our tests. \n\n- Modified LoadHubModuledCommand to default to a batch size of 10. In some scenarios when bootstrapping the test app, the config.sjs/config.xqy modules are being loaded twice, which causes a conflicting updates error. This prevents that. \n\n- The Installer program always install the test application. I changed this primarily for local convenience, as I often need to install the test app after e.g. adding a role, and the fact that the test app Installer doesn't run if it thinks DH is already installed is not helpful. \n\n- Replaced temporal-document-write.sjs with WriteDocumentsTest. \n\n- Moved jaeger-config dependency from core into QuickStart, as it's only used there. \n\n- Removed spring-integration dependency from core; it's not needed anywhere. \n\n- Removed calls to installHubModules except where hub modules had clearly been modified. No test should have to worry about hub modules being properly installed; if a test modifies hub modules, it's up to that test to undo its changes.", "committedDate": "2020-04-20T14:21:30Z", "type": "forcePushed"}, {"oid": "6c00ebad27672a64f78a47e1ee8b53a05404eb54", "url": "https://github.com/marklogic/marklogic-data-hub/commit/6c00ebad27672a64f78a47e1ee8b53a05404eb54", "message": "DHFPROD-4720: Core project now publishes a test fixture for reusability\n\nIntent is to remove duplication of test plumbing between core and central. Summary of changes:\n\n- Added new AbstractHubTest as a base class for HubTestBase and AbstractHubCentralTest. It has logic for resetting the project before a test runs, and for load project files. This is accomplished via the new \"testFixturesApi\" - \"java-test-fixture\" is a new feature in Gradle 5.6 for this exact use case, where test fixtures in core can be reused in the other DH projects. \n\n- LoadHubArtifactsCommand no longer has a \"force\" property to it; artifacts are always loaded. Modified it to ensure it never loads two documents with the same URI at the same time, which happens in some scenarios in our tests. \n\n- Modified LoadHubModuledCommand to default to a batch size of 10. In some scenarios when bootstrapping the test app, the config.sjs/config.xqy modules are being loaded twice, which causes a conflicting updates error. This prevents that. \n\n- The Installer program always install the test application. I changed this primarily for local convenience, as I often need to install the test app after e.g. adding a role, and the fact that the test app Installer doesn't run if it thinks DH is already installed is not helpful. \n\n- Replaced temporal-document-write.sjs with WriteDocumentsTest. \n\n- Moved jaeger-config dependency from core into QuickStart, as it's only used there. \n\n- Removed spring-integration dependency from core; it's not needed anywhere. \n\n- Removed calls to installHubModules except where hub modules had clearly been modified. No test should have to worry about hub modules being properly installed; if a test modifies hub modules, it's up to that test to undo its changes.", "committedDate": "2020-04-20T14:21:30Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTU0MTQyMw==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3838#discussion_r411541423", "bodyText": "Not required now but we should remove the count from the message.", "author": "akshaysonvane", "createdAt": "2020-04-20T17:01:25Z", "path": "marklogic-data-hub/src/test/java/com/marklogic/hub/deploy/commands/BuildAssetFileLoaderTest.java", "diffHunk": "@@ -19,12 +19,10 @@ public void withCustomBatchSize() {\n         CommandContext context = new CommandContext(appConfig, null, null);\n \n         TestAssetFileLoader loader = new TestAssetFileLoader(null);\n-        command.prepareAssetFileLoader(loader, context);\n-        assertNull(loader.batchSize, \"The batch size should still be null because it is null on the AppConfig object\");\n \n-        appConfig.setModulesLoaderBatchSize(10);\n+        appConfig.setModulesLoaderBatchSize(7);\n         command.prepareAssetFileLoader(loader, context);\n-        assertEquals(10, (int) loader.batchSize, \"The batch size should now be 10; this gives the user a way to load hub \" +\n+        assertEquals(7, (int) loader.batchSize, \"The batch size should now be 10; this gives the user a way to load hub \" +", "originalCommit": "6c00ebad27672a64f78a47e1ee8b53a05404eb54", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}