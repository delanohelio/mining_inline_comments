{"pr_number": 4950, "pr_title": "DHFPROD-6303: Download a record or artifact from All Data View", "pr_createdAt": "2020-12-07T23:14:57Z", "pr_url": "https://github.com/marklogic/marklogic-data-hub/pull/4950", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzkyMDQ3Ng==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4950#discussion_r537920476", "bodyText": "I think this can be simpler and wholly implemented in the controller by using a DocumentManager from a DatabaseClient. Just read the URI as an InputStreamHandle, then use Spring's FileCopyUtils class to copy that class's InputStream to the HTTP response's OutputStream. You can remove all the code from the Manager (which doesn't really add any value here), and only have one try/catch too.", "author": "rjrudin", "createdAt": "2020-12-07T23:44:11Z", "path": "marklogic-data-hub-central/src/main/java/com/marklogic/hub/central/controllers/EntitySearchController.java", "diffHunk": "@@ -54,7 +57,22 @@ public String search(@RequestBody SearchQuery searchQuery, @RequestParam(default\n     @RequestMapping(method = RequestMethod.GET)\n     @ResponseBody\n     public JsonNode getRecord(@RequestParam String docUri, @RequestParam(defaultValue = \"final\") String database) {\n-        return getEntitySearchService(database).getRecord(docUri);\n+        return getEntitySearchService(database).getRecord(docUri, true);\n+    }\n+\n+    @RequestMapping(value = \"/downloadRecord\", method = RequestMethod.GET)\n+    public void downloadRecord(@RequestParam String docUri, @RequestParam(defaultValue = \"final\") String database, HttpServletResponse response) {\n+        String[] docUriArray = docUri.split(\"/\");\n+        String fileName = docUriArray[docUriArray.length-1];\n+        response.setContentType(MediaType.APPLICATION_OCTET_STREAM_VALUE);\n+        response.addHeader(\"Content-Disposition\", String.format(\"attachment; filename=%s\", fileName));\n+\n+        try (OutputStream out = response.getOutputStream()) {\n+            newEntitySearchManager(database).downloadRecord(docUri, out);", "originalCommit": "4ed377a7f5cbeea76b5c42a5e04cb7c5b7e423c2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzkyMDgxOQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4950#discussion_r537920819", "bodyText": "Can undo this, assuming just using DatabaseClient.newDocumentManager works.", "author": "rjrudin", "createdAt": "2020-12-07T23:44:53Z", "path": "marklogic-data-hub/src/main/resources/ml-modules/root/data-hub/5/data-services/entitySearch/getRecord.api", "diffHunk": "@@ -1,10 +1,17 @@\n {\n   \"functionName\" : \"getRecord\",\n-  \"params\" : [ {\n+  \"params\" : [", "originalCommit": "4ed377a7f5cbeea76b5c42a5e04cb7c5b7e423c2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzkyMTM0OQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4950#discussion_r537921349", "bodyText": "Should be \"getDocumentSize\", since \"record\" refers to the abstraction containing the URI, the document, metadata, etc - we're only interested in the document size.", "author": "rjrudin", "createdAt": "2020-12-07T23:46:15Z", "path": "marklogic-data-hub/src/main/resources/ml-modules/root/data-hub/5/entities/entity-search-lib.sjs", "diffHunk": "@@ -637,12 +638,30 @@ function findFlowsAsMap() {\n   return flows;\n }\n \n+function getRecordSize(docUri) {", "originalCommit": "4ed377a7f5cbeea76b5c42a5e04cb7c5b7e423c2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzkyMTk4OQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4950#discussion_r537921989", "bodyText": "Just test the controller instead via an AbstractMvcTest - that gives us coverage over the controller as well, which is missing right now.\nShould test downloading a binary as well - that could be as simple as capturing the bytes of the string \"hello world\" and storing that as a document. Can assert on its size too.", "author": "rjrudin", "createdAt": "2020-12-07T23:47:44Z", "path": "marklogic-data-hub-central/src/test/java/com/marklogic/hub/central/entities/search/EntitySearchManagerTest.java", "diffHunk": "@@ -274,6 +279,39 @@ void testGetQueryOptions() {\n         assertThrows(RuntimeException.class, () -> new EntitySearchManager(getHubClient()).getQueryOptions(\"non-existent-options\"), \"Search options doesn't exist\");\n     }\n \n+    @Test\n+    void testDownloadRecord() {", "originalCommit": "4ed377a7f5cbeea76b5c42a5e04cb7c5b7e423c2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzkyMzQ3NQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4950#discussion_r537923475", "bodyText": "Also, no need to install the reference project and create customer entities. The \"download\" feature doesn't care about whether the doc is an entity or not - it just takes a URI as an input and returns the document in the HTTP response output stream.\nFor testing then, I'd have 5 separate tests - one a JSON doc, one for XML, one for Text, one for Binary, and one for a missing URI (verify you get an appropriate error message).", "author": "rjrudin", "createdAt": "2020-12-07T23:51:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzkyMTk4OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzkyMjc0Nw==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4950#discussion_r537922747", "bodyText": "I didn't see any tests for record size? I recommend doing some unit tests here to verify you're getting the correct result. And instead of passing in a URI, pass in the document itself - that makes it easier to test, as you don't have to persist a document first.\nShould test documents that result in each of the 3 sizes being used too.", "author": "rjrudin", "createdAt": "2020-12-07T23:49:35Z", "path": "marklogic-data-hub/src/main/resources/ml-modules/root/data-hub/5/entities/entity-search-lib.sjs", "diffHunk": "@@ -637,12 +638,30 @@ function findFlowsAsMap() {\n   return flows;\n }\n \n+function getRecordSize(docUri) {\n+  const doc = cts.doc(docUri);\n+  const sizes = ['B', 'KB', 'MB'];\n+  const nodeKind = xdmp.nodeKind(doc.root);\n+  let bytes = 0;\n+\n+  if(nodeKind === 'binary') {\n+    bytes = xdmp.binarySize(fn.head(doc).root);\n+  } else {\n+    bytes = xdmp.binarySize(fn.head(xdmp.unquote(xdmp.quote(doc), null, \"format-binary\")).root)\n+  }\n+\n+  let power = Math.floor(Math.log(bytes) / Math.log(1024));\n+  power = power > 2 ? 2 : power;\n+  return (bytes / Math.pow(1024, power)).toFixed(2) * 1 + ' ' + sizes[power];", "originalCommit": "4ed377a7f5cbeea76b5c42a5e04cb7c5b7e423c2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzkyMzY4Mw==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4950#discussion_r537923683", "bodyText": "Use \"URI\" in the error message ; \"docUri\" is a variable name that is not as meaningful to a user like Pari as \"URI\" is.", "author": "rjrudin", "createdAt": "2020-12-07T23:51:49Z", "path": "marklogic-data-hub-central/src/main/java/com/marklogic/hub/central/controllers/EntitySearchController.java", "diffHunk": "@@ -54,7 +57,22 @@ public String search(@RequestBody SearchQuery searchQuery, @RequestParam(default\n     @RequestMapping(method = RequestMethod.GET)\n     @ResponseBody\n     public JsonNode getRecord(@RequestParam String docUri, @RequestParam(defaultValue = \"final\") String database) {\n-        return getEntitySearchService(database).getRecord(docUri);\n+        return getEntitySearchService(database).getRecord(docUri, true);\n+    }\n+\n+    @RequestMapping(value = \"/downloadRecord\", method = RequestMethod.GET)\n+    public void downloadRecord(@RequestParam String docUri, @RequestParam(defaultValue = \"final\") String database, HttpServletResponse response) {\n+        String[] docUriArray = docUri.split(\"/\");\n+        String fileName = docUriArray[docUriArray.length-1];\n+        response.setContentType(MediaType.APPLICATION_OCTET_STREAM_VALUE);\n+        response.addHeader(\"Content-Disposition\", String.format(\"attachment; filename=%s\", fileName));\n+\n+        try (OutputStream out = response.getOutputStream()) {\n+            newEntitySearchManager(database).downloadRecord(docUri, out);\n+            response.flushBuffer();\n+        } catch (IOException e) {\n+            throw new RuntimeException(String.format(\"Unable to download record with docUri: %s with cause: %s\", docUri, e.getMessage()));", "originalCommit": "4ed377a7f5cbeea76b5c42a5e04cb7c5b7e423c2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODc3Mzk5MA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4950#discussion_r538773990", "bodyText": "Can you return recordSize as a two parameters, recordSize and recordSizeUnit ?", "author": "timur-isangulov", "createdAt": "2020-12-08T20:13:15Z", "path": "marklogic-data-hub/src/main/resources/ml-modules/root/data-hub/5/entities/entity-search-lib.sjs", "diffHunk": "@@ -494,6 +494,7 @@ function addDocumentMetadataToSearchResults(searchResponse) {\n       hubMetadata[\"lastProcessedByStep\"] = documentMetadata.datahubCreatedByStep;\n       hubMetadata[\"lastProcessedDateTime\"] = documentMetadata.datahubCreatedOn;\n       hubMetadata[\"sources\"] = getEntitySources(docUri);\n+      hubMetadata[\"recordSize\"] = getRecordSize(docUri);", "originalCommit": "4ed377a7f5cbeea76b5c42a5e04cb7c5b7e423c2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "55ab47236c5677f0a3af27c48a991e5b91f16ca8", "url": "https://github.com/marklogic/marklogic-data-hub/commit/55ab47236c5677f0a3af27c48a991e5b91f16ca8", "message": "DHFPROD-6303: Download a record or artifact from All Data View", "committedDate": "2020-12-09T00:41:00Z", "type": "forcePushed"}, {"oid": "8a3ae2b53037f6771c2ed45347dca7823d948176", "url": "https://github.com/marklogic/marklogic-data-hub/commit/8a3ae2b53037f6771c2ed45347dca7823d948176", "message": "DHFPROD-6303: Download a record or artifact from All Data View", "committedDate": "2020-12-09T05:36:02Z", "type": "forcePushed"}, {"oid": "d88ae43b293be2d5bf31b52a6df64c5cd595e7b0", "url": "https://github.com/marklogic/marklogic-data-hub/commit/d88ae43b293be2d5bf31b52a6df64c5cd595e7b0", "message": "DHFPROD-6303: Download a record or artifact from All Data View", "committedDate": "2020-12-09T17:50:45Z", "type": "forcePushed"}, {"oid": "121178a2ff6920f33f12ad137c8faa19b44cc491", "url": "https://github.com/marklogic/marklogic-data-hub/commit/121178a2ff6920f33f12ad137c8faa19b44cc491", "message": "DHFPROD-6303: Download a record or artifact from All Data View", "committedDate": "2020-12-09T17:58:10Z", "type": "forcePushed"}, {"oid": "4aab108104361b656b1ce9e56efa75d7068db709", "url": "https://github.com/marklogic/marklogic-data-hub/commit/4aab108104361b656b1ce9e56efa75d7068db709", "message": "DHFPROD-6303: Download a record or artifact from All Data View", "committedDate": "2020-12-09T18:16:22Z", "type": "commit"}, {"oid": "4aab108104361b656b1ce9e56efa75d7068db709", "url": "https://github.com/marklogic/marklogic-data-hub/commit/4aab108104361b656b1ce9e56efa75d7068db709", "message": "DHFPROD-6303: Download a record or artifact from All Data View", "committedDate": "2020-12-09T18:16:22Z", "type": "forcePushed"}]}