{"pr_number": 3868, "pr_title": "DHFPROD-4654: Added 500 error support to hub central", "pr_createdAt": "2020-04-24T16:36:50Z", "pr_url": "https://github.com/marklogic/marklogic-data-hub/pull/3868", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjk5OTY4NQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3868#discussion_r416999685", "bodyText": "can we get rid of this debug from the test.", "author": "bsrikan", "createdAt": "2020-04-29T00:15:02Z", "path": "marklogic-data-hub-central/ui/src/components/modal-status/modal-status.test.tsx", "diffHunk": "@@ -1,12 +1,211 @@\n import React from 'react';\n-import { render } from '@testing-library/react';\n+import { BrowserRouter as Router } from 'react-router-dom';\n+import { render, wait } from '@testing-library/react';\n+import axiosMock from 'axios'\n+import userEvent from \"@testing-library/user-event\";\n+\n import ModalStatus from './modal-status';\n+import NoMatchRedirect from '../../pages/noMatchRedirect';\n+import { UserContext } from '../../util/user-context';\n+\n+jest.mock('axios');\n \n describe('Modal Status Component', () => {\n-  test('Modal session status renders', () => {\n-    const { getByTestId } = render( <ModalStatus visible={true} />);\n-      expect(getByTestId('inactivity')).toBeInTheDocument();\n-  })\n+  afterEach(() => {\n+    jest.clearAllMocks();\n+  });\n+\n+  test('Modal session status renders and click continue session', async () => {\n+    axiosMock.get.mockImplementation(() => Promise.resolve({ status: 200 }));\n+\n+    const context = {\n+      user: {\n+        error : { \n+          title: '', \n+          message: '',\n+          type: ''\n+        },\n+        maxSessionTime: 300,\n+        sessionWarning: true\n+      },\n+      userNotAuthenticated: jest.fn(),\n+      handleError: jest.fn(),\n+      resetSessionTime: jest.fn(),\n+      setSessionWarning: jest.fn(),\n+      clearErrorMessage: jest.fn()\n+    }\n+    const { getByText } = render( \n+      <Router>\n+        <UserContext.Provider value={context}>\n+          <ModalStatus/>\n+        </UserContext.Provider>\n+      </Router>);\n+\n+      expect(getByText('Due to Inactivity, you will be logged out in')).toBeInTheDocument();\n+\n+      await wait(() => {\n+        userEvent.click(getByText('Continue Session'));\n+      });\n+      expect(axiosMock.get).toHaveBeenCalledTimes(1);\n+  });\n+\n+  test('Modal session status renders and can click logout', async () => {\n+    axiosMock.get.mockImplementation(() => Promise.resolve({ status: 200 }));\n+\n+    const context = {\n+      user: {\n+        error : { \n+          title: '', \n+          message: '',\n+          type: ''\n+        },\n+        maxSessionTime: 300,\n+        sessionWarning: true\n+      },\n+      userNotAuthenticated: jest.fn(),\n+      handleError: jest.fn(),\n+      resetSessionTime: jest.fn(),\n+      setSessionWarning: jest.fn(),\n+      clearErrorMessage: jest.fn()\n+    }\n+    const { getByText } = render( \n+      <Router>\n+        <UserContext.Provider value={context}>\n+          <ModalStatus/>\n+        </UserContext.Provider>\n+      </Router>);\n+\n+      expect(getByText('Due to Inactivity, you will be logged out in')).toBeInTheDocument();\n+\n+      await wait(() => {\n+        userEvent.click(getByText('Log Out'));\n+      });\n+      expect(axiosMock.get).toHaveBeenCalledTimes(1);\n+  });\n+\n+  test('Modal can render 500 error and can click OK', async () => {\n+    const context = {\n+      user: {\n+        error : { \n+          title: '500 Internal Server Error', \n+          message: 'java.net.ConnectException: Failed to connect to localhost/0:0:0:0:0:0:0:1:8011',\n+          type: 'MODAL'\n+        },\n+        maxSessionTime: 300,\n+        sessionWarning: false\n+      },\n+      userNotAuthenticated: jest.fn(),\n+      handleError: jest.fn(),\n+      resetSessionTime: jest.fn(),\n+      setSessionWarning: jest.fn(),\n+      clearErrorMessage: jest.fn()\n+    }\n+    const { getByText } = render( \n+      <Router>\n+        <UserContext.Provider value={context}>\n+          <ModalStatus/>\n+        </UserContext.Provider>\n+      </Router>);\n+\n+      expect(getByText('500 Internal Server Error')).toBeInTheDocument();\n+      expect(getByText('java.net.ConnectException: Failed to connect to localhost/0:0:0:0:0:0:0:1:8011')).toBeInTheDocument();\n+\n+      await wait(() => {\n+        userEvent.click(getByText('OK'));\n+      });\n+      expect(context.clearErrorMessage).toBeCalledTimes(1);\n+  });\n+\n+  test('Modal can render 500 error and can click Cancel', async () => {\n+    const context = {\n+      user: {\n+        error : { \n+          title: '500 Internal Server Error', \n+          message: 'java.net.ConnectException: Failed to connect to localhost/0:0:0:0:0:0:0:1:8011',\n+          type: 'MODAL'\n+        },\n+        maxSessionTime: 300,\n+        sessionWarning: false\n+      },\n+      userNotAuthenticated: jest.fn(),\n+      handleError: jest.fn(),\n+      resetSessionTime: jest.fn(),\n+      setSessionWarning: jest.fn(),\n+      clearErrorMessage: jest.fn()\n+    }\n+    const { getByText, debug } = render( \n+      <Router>\n+        <UserContext.Provider value={context}>\n+          <ModalStatus/>\n+          <NoMatchRedirect/>\n+        </UserContext.Provider>\n+      </Router>);\n+\n+      expect(getByText('500 Internal Server Error')).toBeInTheDocument();\n+      expect(getByText('java.net.ConnectException: Failed to connect to localhost/0:0:0:0:0:0:0:1:8011')).toBeInTheDocument();\n+\n+      await wait(() => {\n+        userEvent.click(getByText('Cancel'));\n+      });\n+\n+      debug()", "originalCommit": "922b6b24b46e967262cf2857b52ab58d108d553d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODE0NzQwMw==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3868#discussion_r418147403", "bodyText": "Removed the debug", "author": "brucean52", "createdAt": "2020-04-30T16:45:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjk5OTY4NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzAwMTA1NQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3868#discussion_r417001055", "bodyText": "Can you pls create a test config file to keep the context and export that to the test. This is being used in several tests, so it will be great if we can extract that out. Similar thing for the error context..\nFor mapping tests we have created a data.config.js under config directory. Probably not the right place to mix test data config with application configs, and I plan to move them to a better place later.", "author": "bsrikan", "createdAt": "2020-04-29T00:19:40Z", "path": "marklogic-data-hub-central/ui/src/components/modal-status/modal-status.test.tsx", "diffHunk": "@@ -1,12 +1,211 @@\n import React from 'react';\n-import { render } from '@testing-library/react';\n+import { BrowserRouter as Router } from 'react-router-dom';\n+import { render, wait } from '@testing-library/react';\n+import axiosMock from 'axios'\n+import userEvent from \"@testing-library/user-event\";\n+\n import ModalStatus from './modal-status';\n+import NoMatchRedirect from '../../pages/noMatchRedirect';\n+import { UserContext } from '../../util/user-context';\n+\n+jest.mock('axios');\n \n describe('Modal Status Component', () => {\n-  test('Modal session status renders', () => {\n-    const { getByTestId } = render( <ModalStatus visible={true} />);\n-      expect(getByTestId('inactivity')).toBeInTheDocument();\n-  })\n+  afterEach(() => {\n+    jest.clearAllMocks();\n+  });\n+\n+  test('Modal session status renders and click continue session', async () => {\n+    axiosMock.get.mockImplementation(() => Promise.resolve({ status: 200 }));\n+\n+    const context = {", "originalCommit": "922b6b24b46e967262cf2857b52ab58d108d553d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODE0ODAyMg==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3868#discussion_r418148022", "bodyText": "I created a user-context-mock under '/assets/mock-data' since it's mocking Context data and not configuration for the app.", "author": "brucean52", "createdAt": "2020-04-30T16:46:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzAwMTA1NQ=="}], "type": "inlineReview"}, {"oid": "cb8e59f886533c82d2f211cd4098343b8545b817", "url": "https://github.com/marklogic/marklogic-data-hub/commit/cb8e59f886533c82d2f211cd4098343b8545b817", "message": "DHFPROD-4654: Added 500 error support to hub central\n\nDHFPROD-4654: created user context mock file", "committedDate": "2020-04-30T16:44:50Z", "type": "commit"}, {"oid": "cb8e59f886533c82d2f211cd4098343b8545b817", "url": "https://github.com/marklogic/marklogic-data-hub/commit/cb8e59f886533c82d2f211cd4098343b8545b817", "message": "DHFPROD-4654: Added 500 error support to hub central\n\nDHFPROD-4654: created user context mock file", "committedDate": "2020-04-30T16:44:50Z", "type": "forcePushed"}]}