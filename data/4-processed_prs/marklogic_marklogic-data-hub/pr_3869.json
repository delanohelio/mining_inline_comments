{"pr_number": 3869, "pr_title": "DHFPROD-4775: Introducing HubClient as a simplified interface", "pr_createdAt": "2020-04-24T18:54:03Z", "pr_url": "https://github.com/marklogic/marklogic-data-hub/pull/3869", "timeline": [{"oid": "05f221ca61627d4b073d0d4d92c475b42f2e4790", "url": "https://github.com/marklogic/marklogic-data-hub/commit/05f221ca61627d4b073d0d4d92c475b42f2e4790", "message": "DHFPROD-4775: Introducing HubClient as a simplified interface\n\nMost of the changes in here are switching HC code over from HubConfig to HubClient. That's an easy change, since HC doesn't need any of the HubProject stuff in HubConfig. \n\nNote that AbstractHubCentralTest still has a HubProject, since tests are like Pari - they need to be able to deploy apps for testing. \n\nThen changed the following HC core classes:\n\n- HubConfig now has newHubClient, as HubConfig has all the config needed to know how to create a HubClient\n- Saw an unused method in HubProjectImpl, removed it\n- CollectorImpl now gets a RestTemplate from HubClient. Removed 4 methods from the Collector interface that were not invoked anywhere too. \n- QueryStepRunner now depends on a HubClient and a sourceDatabase. The latter is used to control which database is sent to the collector endpoint. The RestTemplate still always talks to the staging app server when hitting the collector, which is now more clear in the code. \n- WriteStepRunner now uses getFinalClient() when an ingestion wants to write to the final database. Wasn't sure if this was tested anywhere, so added IngestInFinalTest to verify it works. \n- Removed \"withSourceClient\" from StepRunner, as that concept no longer exists. It only applied to QueryStepRunner, and QueryStepRunner will always use getStagingClient() to talk to the collector and mlRunFlow endpoints.", "committedDate": "2020-04-24T18:55:05Z", "type": "forcePushed"}, {"oid": "7b817f5a667a2243c6fe776d2c163230751511b4", "url": "https://github.com/marklogic/marklogic-data-hub/commit/7b817f5a667a2243c6fe776d2c163230751511b4", "message": "DHFPROD-4775: Introducing HubClient as a simplified interface\n\nMost of the changes in here are switching HC code over from HubConfig to HubClient. That's an easy change, since HC doesn't need any of the HubProject stuff in HubConfig. \n\nNote that AbstractHubCentralTest still has a HubProject, since tests are like Pari - they need to be able to deploy apps for testing. \n\nThen changed the following HC core classes:\n\n- HubConfig now has newHubClient, as HubConfig has all the config needed to know how to create a HubClient\n- Saw an unused method in HubProjectImpl, removed it\n- CollectorImpl now gets a RestTemplate from HubClient. Removed 4 methods from the Collector interface that were not invoked anywhere too. \n- QueryStepRunner now depends on a HubClient and a sourceDatabase. The latter is used to control which database is sent to the collector endpoint. The RestTemplate still always talks to the staging app server when hitting the collector, which is now more clear in the code. \n- WriteStepRunner now uses getFinalClient() when an ingestion wants to write to the final database. Wasn't sure if this was tested anywhere, so added IngestInFinalTest to verify it works. \n- Removed \"withSourceClient\" from StepRunner, as that concept no longer exists. It only applied to QueryStepRunner, and QueryStepRunner will always use getStagingClient() to talk to the collector and mlRunFlow endpoints.", "committedDate": "2020-04-24T20:43:13Z", "type": "forcePushed"}, {"oid": "7b817f5a667a2243c6fe776d2c163230751511b4", "url": "https://github.com/marklogic/marklogic-data-hub/commit/7b817f5a667a2243c6fe776d2c163230751511b4", "message": "DHFPROD-4775: Introducing HubClient as a simplified interface\n\nMost of the changes in here are switching HC code over from HubConfig to HubClient. That's an easy change, since HC doesn't need any of the HubProject stuff in HubConfig. \n\nNote that AbstractHubCentralTest still has a HubProject, since tests are like Pari - they need to be able to deploy apps for testing. \n\nThen changed the following HC core classes:\n\n- HubConfig now has newHubClient, as HubConfig has all the config needed to know how to create a HubClient\n- Saw an unused method in HubProjectImpl, removed it\n- CollectorImpl now gets a RestTemplate from HubClient. Removed 4 methods from the Collector interface that were not invoked anywhere too. \n- QueryStepRunner now depends on a HubClient and a sourceDatabase. The latter is used to control which database is sent to the collector endpoint. The RestTemplate still always talks to the staging app server when hitting the collector, which is now more clear in the code. \n- WriteStepRunner now uses getFinalClient() when an ingestion wants to write to the final database. Wasn't sure if this was tested anywhere, so added IngestInFinalTest to verify it works. \n- Removed \"withSourceClient\" from StepRunner, as that concept no longer exists. It only applied to QueryStepRunner, and QueryStepRunner will always use getStagingClient() to talk to the collector and mlRunFlow endpoints.", "committedDate": "2020-04-24T20:43:13Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTQ4NjUwMw==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3869#discussion_r415486503", "bodyText": "Is this going to be temporary and will go away when Collector is implemented using OkHttp ?", "author": "srinathgit", "createdAt": "2020-04-27T03:34:38Z", "path": "marklogic-data-hub/src/main/java/com/marklogic/hub/HubClient.java", "diffHunk": "@@ -0,0 +1,42 @@\n+/*\n+ * Copyright (c) 2020 MarkLogic Corporation\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.marklogic.hub;\n+\n+import com.marklogic.client.DatabaseClient;\n+import org.springframework.web.client.RestTemplate;\n+\n+public interface HubClient {\n+\n+    /**\n+     * @return the name of the MarkLogic user associated with this client\n+     */\n+    String getUsername();\n+\n+    DatabaseClient getStagingClient();\n+\n+    DatabaseClient getFinalClient();\n+\n+    DatabaseClient getJobsClient();\n+\n+    String getDbName(DatabaseKind kind);\n+\n+    /**\n+     * This is needed by the CollectorImpl class, which is not yet able to use a DatabaseClient.\n+     *\n+     * @return\n+     */\n+    RestTemplate getStagingRestTemplate();", "originalCommit": "7b817f5a667a2243c6fe776d2c163230751511b4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTc5MjA3Ng==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3869#discussion_r415792076", "bodyText": "Correct.", "author": "rjrudin", "createdAt": "2020-04-27T13:01:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTQ4NjUwMw=="}], "type": "inlineReview"}]}