{"pr_number": 3867, "pr_title": "DHFPROD-4189:Source fields dropdown for Mapping and filtering", "pr_createdAt": "2020-04-23T20:52:36Z", "pr_url": "https://github.com/marklogic/marklogic-data-hub/pull/3867", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDEyOTE1MA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3867#discussion_r414129150", "bodyText": "Theses props can be replaced with just {...data.mapProps} sourceData={[]} mappingVisible={true}", "author": "bsrikan", "createdAt": "2020-04-23T21:15:05Z", "path": "marklogic-data-hub-central/ui/src/components/entities/mapping/source-entity-map/source-to-entity-map.test.tsx", "diffHunk": "@@ -1,14 +1,21 @@\n import React from 'react';\n-import { render, cleanup, fireEvent, getByTestId } from '@testing-library/react';\n+import { waitForElement, render, cleanup, fireEvent, queryByAttribute } from '@testing-library/react';\n import SourceToEntityMap from './source-to-entity-map';\n import data from '../../../../config/data.config';\n import { shallow } from 'enzyme';\n import SplitPane from 'react-split-pane';\n+import axiosMock from 'axios';\n \n+jest.mock('axios');\n+\n+afterEach(() => {\n+    jest.clearAllMocks();\n+    cleanup();\n+});\n describe('RTL Source-to-entity map tests', () => {\n     afterEach(cleanup);\n     test('RTL tests with no source data', () => {\n-        const { getByTestId,  getByText, getByRole } = render(<SourceToEntityMap {... {mapData: data.mapProps.mapData, entityTypeTitle : data.mapProps.entityTypeTitle, sourceData: [], extractCollectionFromSrcQuery: jest.fn()}} mappingVisible={true}/>);\n+        const { getByTestId,  getByText, getByRole } = render(<SourceToEntityMap {... {mapData: data.mapProps.mapData,entityTypeProperties:data.mapProps.entityTypeProperties, entityTypeTitle : data.mapProps.entityTypeTitle, sourceData: [], extractCollectionFromSrcQuery: jest.fn()}} mappingVisible={true}/>);", "originalCommit": "db944d3b379ac6dd6ff1758457faffff883581b5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDYwMTQ4NA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3867#discussion_r414601484", "bodyText": "Did the proposed change not work for you?", "author": "bsrikan", "createdAt": "2020-04-24T14:03:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDEyOTE1MA=="}], "type": "inlineReview"}, {"oid": "fa2464d6d6b199c82149017a2195b8fe430e5191", "url": "https://github.com/marklogic/marklogic-data-hub/commit/fa2464d6d6b199c82149017a2195b8fe430e5191", "message": "DHFPROD-4189:Source fields dropdown for Mapping and filtering", "committedDate": "2020-04-24T05:56:00Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDU3NzcwMA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3867#discussion_r414577700", "bodyText": "Try adding data-testid={row.name.split('/').pop()+'-mapexpression'} so we can get map expression for an entity property instead of using getAll*", "author": "bsrikan", "createdAt": "2020-04-24T13:31:04Z", "path": "marklogic-data-hub-central/ui/src/components/entities/mapping/source-entity-map/source-to-entity-map.tsx", "diffHunk": "@@ -489,15 +513,20 @@ const SourceToEntityMap = (props) => {\n             render: (text, row) => (<div className={styles.mapExpParentContainer}><div className={styles.mapExpressionContainer}>\n                 <TextArea\n                     id=\"mapexpression\"\n+                    data-testid=\"mapexpression\"", "originalCommit": "fa2464d6d6b199c82149017a2195b8fe430e5191", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDU4MjEyOQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3867#discussion_r414582129", "bodyText": "Same as above. Try adding data-testid={row.name.split('/').pop()+'-listIcon'}. Selectors should always be unique.\nShould the handleSourceList take row.name as input just like function list handler?", "author": "bsrikan", "createdAt": "2020-04-24T13:37:33Z", "path": "marklogic-data-hub-central/ui/src/components/entities/mapping/source-entity-map/source-to-entity-map.tsx", "diffHunk": "@@ -489,15 +513,20 @@ const SourceToEntityMap = (props) => {\n             render: (text, row) => (<div className={styles.mapExpParentContainer}><div className={styles.mapExpressionContainer}>\n                 <TextArea\n                     id=\"mapexpression\"\n+                    data-testid=\"mapexpression\"\n                     style={mapExpressionStyle(row.name)}\n                     onClick={handleClickInTextArea}\n                     value={mapExp[row.name]}\n                     onChange={(e) => handleMapExp(row.name, e)}\n                     onBlur={handleExpSubmit}\n                     autoSize={{ minRows: 1 }}\n                     disabled={!props.canReadWrite}></TextArea>&nbsp;&nbsp;\n-                <i id=\"listIcon\"><FontAwesomeIcon icon={faList} size=\"lg\" className={styles.listIcon}\n-                /></i>&nbsp;&nbsp;\n+                <span>\n+                    <Dropdown overlay={sourceSearchMenu} trigger={['click']} >\n+                        <i  id=\"listIcon\"><FontAwesomeIcon icon={faList} size=\"lg\" data-testid= \"listSources\"  className={styles.listIcon} onClick={(e) => handleSourceList(row)}/></i>", "originalCommit": "fa2464d6d6b199c82149017a2195b8fe430e5191", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDkzODI1OA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3867#discussion_r414938258", "bodyText": "The function requires 'row' as parameter", "author": "srinathgit", "createdAt": "2020-04-25T00:49:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDU4MjEyOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDU5OTk0MQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3867#discussion_r414599941", "bodyText": "Do we need a testid for successMessage. Will the test work if we expect(getByText('All changes are saved')). Lets try to use data-testid as last resort if nothing works.", "author": "bsrikan", "createdAt": "2020-04-24T14:01:41Z", "path": "marklogic-data-hub-central/ui/src/components/entities/mapping/source-entity-map/source-to-entity-map.tsx", "diffHunk": "@@ -544,12 +573,11 @@ const SourceToEntityMap = (props) => {\n         let mesg = `All changes are saved on ${convertDateFromISO(new Date())}`\n         let errorMesg = `An error occured while saving the changes.`\n \n-        let msg = <span id=\"successMessage\"><Alert type=\"success\" message={mesg} banner style={saveMessageCSS} /></span>\n-        let errorMsg = <span id=\"errorMessage\"><Alert type=\"error\" message={errorMesg} banner style={saveMessageCSS} /></span>\n+        let msg = <span data-testid=\"successMessage\" id=\"successMessage\"><Alert type=\"success\" message={mesg} banner style={saveMessageCSS} /></span>", "originalCommit": "fa2464d6d6b199c82149017a2195b8fe430e5191", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDkzMDg2MA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3867#discussion_r414930860", "bodyText": "I did try it but getByText('All changes are saved') doesn't work for some reason even though debug prints this text. I am not sure why this happens with antd Alert messages , until there is another solution, I will go with this", "author": "srinathgit", "createdAt": "2020-04-25T00:18:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDU5OTk0MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDYwMjg3NQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3867#discussion_r414602875", "bodyText": "can we move afterEach inside describe. We already have one in there.", "author": "bsrikan", "createdAt": "2020-04-24T14:05:58Z", "path": "marklogic-data-hub-central/ui/src/components/entities/mapping/source-entity-map/source-to-entity-map.test.tsx", "diffHunk": "@@ -1,15 +1,22 @@\n import React from 'react';\n-import { render, cleanup, fireEvent, within } from '@testing-library/react';\n+import { waitForElement, render, cleanup, fireEvent, queryByAttribute, within } from '@testing-library/react';\n import SourceToEntityMap from './source-to-entity-map';\n import data from '../../../../config/data.config';\n import { shallow } from 'enzyme';\n import SplitPane from 'react-split-pane';\n+import axiosMock from 'axios';\n import { validateMappingTableRow } from '../../../../util/test-utils';\n \n+jest.mock('axios');\n+\n+afterEach(() => {", "originalCommit": "fa2464d6d6b199c82149017a2195b8fe430e5191", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDYxNTY2Ng==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3867#discussion_r414615666", "bodyText": "fx search also has the same className. Can we ensure we are getting the correct inputBox here", "author": "bsrikan", "createdAt": "2020-04-24T14:23:21Z", "path": "marklogic-data-hub-central/ui/src/components/entities/mapping/source-entity-map/source-to-entity-map.test.tsx", "diffHunk": "@@ -259,6 +266,120 @@ describe('RTL Source-to-entity map tests', () => {\n     });\n });\n \n+\n+test('Nested source data - Right XPATH expression',  async() => {\n+    axiosMock.post.mockImplementationOnce(data.mapProps.updateMappingArtifact);\n+    const { getByText,getAllByText, queryByText, getAllByTestId, getAllByRole, debug} = render(<SourceToEntityMap {...data.mapProps}  mappingVisible={true}/>);\n+    expect(getByText('Source Data')).toBeInTheDocument();\n+    expect(getByText('Entity: Person')).toBeInTheDocument();\n+    expect(getByText('Test')).toBeEnabled();\n+\n+    //Ensure source selectors are present\n+    let sourceSelectors = getAllByTestId(\"listSources\");\n+\n+    expect(sourceSelectors.length).toEqual(8)\n+\n+    //corresponds to 'itemTypes' source selector\n+    fireEvent.click(sourceSelectors[3]);\n+\n+    await(waitForElement(() =>  getAllByRole(\"option\"),{\"timeout\":200}))\n+    let firstName = getAllByText(\"FirstNamePreferred\");\n+    expect(firstName.length).toEqual(2)\n+\n+    //Check if indentation is right\n+    expect(firstName[1]).toHaveStyle(\"line-height: 2vh; text-indent: 20px;\");\n+\n+    //Click on 'FirstNamePreferred'\n+    fireEvent.click(getAllByText(\"FirstNamePreferred\")[1]);\n+\n+    //mapping is saved\n+    expect(await(waitForElement(() => getAllByTestId(\"successMessage\").length,{\"timeout\":200}))).toEqual(1)\n+\n+    let mapExp = getAllByTestId(\"mapexpression\");\n+    //Right Xpath is populated\n+    expect(mapExp[3]).toHaveTextContent(\"nutFreeName/FirstNamePreferred\");\n+\n+});\n+\n+test('Nested source data/entity - Right XPATH with source context',  async() => {\n+    axiosMock.post.mockImplementationOnce(data.mapProps.updateMappingArtifact);\n+    const {getAllByText,getAllByTestId, getAllByRole,debug } = render(<SourceToEntityMap {...data.mapProps}  mappingVisible={true}/>);\n+\n+    //Ensure source selectors are present\n+    let sourceSelectors = getAllByTestId(\"listSources\");\n+    expect(sourceSelectors.length).toEqual(8)\n+\n+    // Set 'sourceContext' for ItemType entity\n+    fireEvent.click(sourceSelectors[2]);\n+    await(waitForElement(() =>  getAllByRole(\"option\"),{\"timeout\":200}))\n+    //Set 'sourceContext' to 'nutFreeName'\n+    fireEvent.click(getAllByText(\"nutFreeName\")[1]);\n+    expect(await(waitForElement(() => getAllByTestId(\"successMessage\").length,{\"timeout\":200}))).toEqual(1)\n+    let mapExp = getAllByTestId(\"mapexpression\");\n+    //Right Xpath is populated\n+    expect(mapExp[2]).toHaveTextContent(\"nutFreeName\");\n+\n+\n+    //Click on the fourth selector (FirstNamePreferred)\n+    fireEvent.click(sourceSelectors[3]);\n+    await(waitForElement(() => getAllByRole(\"option\"),{\"timeout\":400}))\n+    let firstName = getAllByText(\"FirstNamePreferred\");\n+    fireEvent.click(firstName[1]);\n+    //mapping is saved\n+    expect(await(waitForElement(() => getAllByTestId(\"successMessage\").length,{\"timeout\":200}))).toEqual(1)\n+    mapExp = getAllByTestId(\"mapexpression\");\n+\n+    //Right Xpath is populated (and not nutFreeName/FirstNamePreferred since sourceContext is set)\n+    expect(mapExp[3]).toHaveTextContent(\"FirstNamePreferred\");\n+\n+});\n+\n+test('Search source',  async() => {\n+    axiosMock.post.mockImplementationOnce(data.mapProps.updateMappingArtifact);\n+    const {getByText,getAllByText, getAllByTestId, getAllByRole} = render(<SourceToEntityMap {...data.mapProps}  mappingVisible={true}/>);\n+\n+    //Ensure source selectors are present\n+    let sourceSelectors = getAllByTestId(\"listSources\");\n+\n+    expect(sourceSelectors.length).toEqual(8)\n+\n+    //corresponds to 'id' source selector\n+    fireEvent.click(sourceSelectors[3]);\n+\n+    await(waitForElement(() =>  getAllByRole(\"option\"),{\"timeout\":200}))\n+    let firstName = getAllByText(\"FirstNamePreferred\");\n+    expect(firstName.length).toEqual(2)\n+\n+    let lastName = getAllByText(\"LastName\");\n+    expect(lastName.length).toEqual(2)\n+\n+    let inputBox = getByText(\n+        (_content, element) =>\n+            element.className != null &&\n+            element.className ===\"ant-select-search__field\"", "originalCommit": "fa2464d6d6b199c82149017a2195b8fe430e5191", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDcyODk5Nw==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3867#discussion_r414728997", "bodyText": "The point is only one of them should be rendered in the UI at any time and the one rendered should be the one I click. So, I believe, this is ok", "author": "srinathgit", "createdAt": "2020-04-24T17:06:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDYxNTY2Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDYyNjY1NQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3867#discussion_r414626655", "bodyText": "Since we are able to verify indentation using RTL, can we add a test using XML data to verify indentation, namespaces and attributes.", "author": "bsrikan", "createdAt": "2020-04-24T14:37:55Z", "path": "marklogic-data-hub-central/ui/src/components/entities/mapping/source-entity-map/source-to-entity-map.test.tsx", "diffHunk": "@@ -259,6 +266,120 @@ describe('RTL Source-to-entity map tests', () => {\n     });\n });\n \n+\n+test('Nested source data - Right XPATH expression',  async() => {\n+    axiosMock.post.mockImplementationOnce(data.mapProps.updateMappingArtifact);\n+    const { getByText,getAllByText, queryByText, getAllByTestId, getAllByRole, debug} = render(<SourceToEntityMap {...data.mapProps}  mappingVisible={true}/>);\n+    expect(getByText('Source Data')).toBeInTheDocument();\n+    expect(getByText('Entity: Person')).toBeInTheDocument();\n+    expect(getByText('Test')).toBeEnabled();\n+\n+    //Ensure source selectors are present\n+    let sourceSelectors = getAllByTestId(\"listSources\");\n+\n+    expect(sourceSelectors.length).toEqual(8)\n+\n+    //corresponds to 'itemTypes' source selector\n+    fireEvent.click(sourceSelectors[3]);\n+\n+    await(waitForElement(() =>  getAllByRole(\"option\"),{\"timeout\":200}))\n+    let firstName = getAllByText(\"FirstNamePreferred\");\n+    expect(firstName.length).toEqual(2)\n+\n+    //Check if indentation is right\n+    expect(firstName[1]).toHaveStyle(\"line-height: 2vh; text-indent: 20px;\");", "originalCommit": "fa2464d6d6b199c82149017a2195b8fe430e5191", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDkzOTI0Nw==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3867#discussion_r414939247", "bodyText": "Added test for XML data", "author": "srinathgit", "createdAt": "2020-04-25T00:54:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDYyNjY1NQ=="}], "type": "inlineReview"}, {"oid": "1396bbff0192af1a9b551f4bfef7d67e2c04330a", "url": "https://github.com/marklogic/marklogic-data-hub/commit/1396bbff0192af1a9b551f4bfef7d67e2c04330a", "message": "DHFPROD-4189:Source fields dropdown for Mapping and filtering", "committedDate": "2020-04-25T00:52:46Z", "type": "forcePushed"}, {"oid": "ae8c665d4bf6faf9aeb268185cd6887ca228d840", "url": "https://github.com/marklogic/marklogic-data-hub/commit/ae8c665d4bf6faf9aeb268185cd6887ca228d840", "message": "DHFPROD-4189:Source fields dropdown for Mapping and filtering", "committedDate": "2020-04-26T20:10:55Z", "type": "forcePushed"}, {"oid": "daf3efbc3bdbadd1d549c9a499ca439022e56432", "url": "https://github.com/marklogic/marklogic-data-hub/commit/daf3efbc3bdbadd1d549c9a499ca439022e56432", "message": "DHFPROD-4189:Source fields dropdown for Mapping and filtering", "committedDate": "2020-04-26T22:45:04Z", "type": "forcePushed"}, {"oid": "6ec4ce384db59f405784c7ea1b9fc2fbccf5aba2", "url": "https://github.com/marklogic/marklogic-data-hub/commit/6ec4ce384db59f405784c7ea1b9fc2fbccf5aba2", "message": "DHFPROD-4189:Source fields dropdown for Mapping and filtering", "committedDate": "2020-04-27T00:43:26Z", "type": "forcePushed"}, {"oid": "6ba694c54fb1d575195586c1006604661fe5a551", "url": "https://github.com/marklogic/marklogic-data-hub/commit/6ba694c54fb1d575195586c1006604661fe5a551", "message": "DHFPROD-4189:Source fields dropdown for Mapping and filtering", "committedDate": "2020-04-27T02:31:36Z", "type": "forcePushed"}, {"oid": "ad2ffd49576960483338d484cb2df46df70dc3c0", "url": "https://github.com/marklogic/marklogic-data-hub/commit/ad2ffd49576960483338d484cb2df46df70dc3c0", "message": "DHFPROD-4189:Source fields dropdown for Mapping and filtering", "committedDate": "2020-04-27T04:06:52Z", "type": "forcePushed"}, {"oid": "1951ad308687168c6dceab87fc321c9d6127777e", "url": "https://github.com/marklogic/marklogic-data-hub/commit/1951ad308687168c6dceab87fc321c9d6127777e", "message": "DHFPROD-4189:Source fields dropdown for Mapping and filtering", "committedDate": "2020-04-27T06:24:33Z", "type": "forcePushed"}, {"oid": "e7017386a548b04b257794d090c98d7cbda1882f", "url": "https://github.com/marklogic/marklogic-data-hub/commit/e7017386a548b04b257794d090c98d7cbda1882f", "message": "DHFPROD-4189:Source fields dropdown for Mapping and filtering", "committedDate": "2020-04-27T08:12:42Z", "type": "commit"}, {"oid": "e7017386a548b04b257794d090c98d7cbda1882f", "url": "https://github.com/marklogic/marklogic-data-hub/commit/e7017386a548b04b257794d090c98d7cbda1882f", "message": "DHFPROD-4189:Source fields dropdown for Mapping and filtering", "committedDate": "2020-04-27T08:12:42Z", "type": "forcePushed"}]}