{"pr_number": 4769, "pr_title": "DHFPROD-6117:Handle duplicate custom mapping functions", "pr_createdAt": "2020-10-26T23:26:33Z", "pr_url": "https://github.com/marklogic/marklogic-data-hub/pull/4769", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjMzMjQ4NQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4769#discussion_r512332485", "bodyText": "If there's a test failing for this, can the test be upgraded to verify that there's only one instance of the \"echo\" function? And this seems to be introducing logic that says - if there are duplicates, then whichever one is found last \"wins\" - i.e. the signature is for the last one. Is that the case?", "author": "rjrudin", "createdAt": "2020-10-26T23:39:58Z", "path": "marklogic-data-hub/src/main/resources/ml-modules/root/data-hub/5/builtins/steps/mapping/entity-services/lib.sjs", "diffHunk": "@@ -476,21 +476,31 @@ function getMarkLogicMappingFunctions() {\n   return fn.head(datahub.hubUtils.queryLatest(function() {\n     let fnMetadata = fn.collection(\"http://marklogic.com/entity-services/function-metadata\")\n     let ns = {\"m\":\"http://marklogic.com/entity-services/mapping\"};\n+    const functionsAdded = [];\n     let output = [];\n \n     for (const metaData of fnMetadata){\n       if(metaData.xpath(\"/m:function-defs\",ns)) {\n         let j = 1;\n         let fnLocation = metaData.xpath(\"/m:function-defs/@location\",ns)\n         for (const mlFunction of metaData.xpath(\"/m:function-defs/m:function-def\",ns )){\n-          let funcName = metaData.xpath(\"/m:function-defs/m:function-def[\"+j+\"]/@name\", ns);\n+          let funcName = String(metaData.xpath(\"/m:function-defs/m:function-def[\"+j+\"]/@name\", ns));\n           let params = String(metaData.xpath(\"/m:function-defs/m:function-def[\"+j+\"]/m:parameters/m:parameter/@name\",ns)).replace(\"\\n\",\",\");\n           j++;\n-          let singleFunction ={};\n-          singleFunction[\"functionName\"] = funcName;\n-          singleFunction[\"signature\"] = funcName +\"(\"+params+\")\";\n-          singleFunction[\"category\"] = (String(fnLocation).includes(\"/data-hub/5/mapping-functions\")) ? \"builtin\" : \"custom\";\n-          output.push(singleFunction)\n+          if(functionsAdded.includes(funcName)){\n+            let addedFunction = output.find(func => {\n+              return func.functionName == funcName\n+            });\n+            addedFunction[\"signature\"] = funcName +\"(\"+params+\")\";", "originalCommit": "bd211be3d55118d729dbad79262085a7b6a9e436", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjM0NDczMA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4769#discussion_r512344730", "bodyText": "The functionality is going to remain the same. Earlier the response was an object, so the last one always wins.\n{\"echo\":\n\"category\":\"custom\"\n\"signature\":\"echo(value1, value2)\"}\n\nNow since it is an array, it can look like the below array, so I will have to include the logic.\n[\n{\n\"functionName\": \"echo,\n\"category\":\"custom\",\n\"signature\": \"echo(value)\"\n},\n{\n\"functionName\": \"echo,\n\"category\":\"custom\",\n\"signature\": \"echo(value1, value2)\"\n}\n]\n\nI will add a test that checks that echo (if present as the function was addd by previous tests) is present only once.", "author": "srinathgit", "createdAt": "2020-10-27T00:21:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjMzMjQ4NQ=="}], "type": "inlineReview"}, {"oid": "d4b99e2e7d4dac4f2687e4c252dda825ed121998", "url": "https://github.com/marklogic/marklogic-data-hub/commit/d4b99e2e7d4dac4f2687e4c252dda825ed121998", "message": "DHFPROD-6117:Handle duplicate custom mapping functions", "committedDate": "2020-10-27T00:21:57Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjgxMjIyMg==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4769#discussion_r512812222", "bodyText": "Instead of searching in both functionsAdded and output arrays, can we use a Map here with the key being the function name and the value being the function object?\nMap also provides an iterator for values that can then be used to create the output array.\nconst map1 = new Map();\nmap1.set('a', {'a':'a'});\nmap1.set('b', {'b':'b'});\nconst ar = [...map1.values()];", "author": "akshaysonvane", "createdAt": "2020-10-27T15:51:28Z", "path": "marklogic-data-hub/src/main/resources/ml-modules/root/data-hub/5/builtins/steps/mapping/entity-services/lib.sjs", "diffHunk": "@@ -476,21 +476,31 @@ function getMarkLogicMappingFunctions() {\n   return fn.head(datahub.hubUtils.queryLatest(function() {\n     let fnMetadata = fn.collection(\"http://marklogic.com/entity-services/function-metadata\")\n     let ns = {\"m\":\"http://marklogic.com/entity-services/mapping\"};\n+    const functionsAdded = [];\n     let output = [];\n \n     for (const metaData of fnMetadata){\n       if(metaData.xpath(\"/m:function-defs\",ns)) {\n         let j = 1;\n         let fnLocation = metaData.xpath(\"/m:function-defs/@location\",ns)\n         for (const mlFunction of metaData.xpath(\"/m:function-defs/m:function-def\",ns )){\n-          let funcName = metaData.xpath(\"/m:function-defs/m:function-def[\"+j+\"]/@name\", ns);\n+          let funcName = String(metaData.xpath(\"/m:function-defs/m:function-def[\"+j+\"]/@name\", ns));\n           let params = String(metaData.xpath(\"/m:function-defs/m:function-def[\"+j+\"]/m:parameters/m:parameter/@name\",ns)).replace(\"\\n\",\",\");\n           j++;\n-          let singleFunction ={};\n-          singleFunction[\"functionName\"] = funcName;\n-          singleFunction[\"signature\"] = funcName +\"(\"+params+\")\";\n-          singleFunction[\"category\"] = (String(fnLocation).includes(\"/data-hub/5/mapping-functions\")) ? \"builtin\" : \"custom\";\n-          output.push(singleFunction)\n+          if(functionsAdded.includes(funcName)){\n+            let addedFunction = output.find(func => {\n+              return func.functionName == funcName\n+            });", "originalCommit": "d4b99e2e7d4dac4f2687e4c252dda825ed121998", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjgxNjczNw==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4769#discussion_r512816737", "bodyText": "That's a good call, that will be a lot faster than calling \"includes\" N times and then having to call \"find\" as well.", "author": "rjrudin", "createdAt": "2020-10-27T15:56:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjgxMjIyMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzE0NTUyMQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4769#discussion_r513145521", "bodyText": "The spread operator doesn't work in ML 9. So, iterated through the values.", "author": "srinathgit", "createdAt": "2020-10-28T02:40:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjgxMjIyMg=="}], "type": "inlineReview"}, {"oid": "6103039db6fae911aeae8f6a1f59e4c92f9d760d", "url": "https://github.com/marklogic/marklogic-data-hub/commit/6103039db6fae911aeae8f6a1f59e4c92f9d760d", "message": "DHFPROD-6117:Handle duplicate mapping functions", "committedDate": "2020-10-28T02:39:39Z", "type": "commit"}, {"oid": "6103039db6fae911aeae8f6a1f59e4c92f9d760d", "url": "https://github.com/marklogic/marklogic-data-hub/commit/6103039db6fae911aeae8f6a1f59e4c92f9d760d", "message": "DHFPROD-6117:Handle duplicate mapping functions", "committedDate": "2020-10-28T02:39:39Z", "type": "forcePushed"}]}