{"pr_number": 4019, "pr_title": "DHFPROD-4672: Add hub-central-load-writer role", "pr_createdAt": "2020-05-28T19:03:00Z", "pr_url": "https://github.com/marklogic/marklogic-data-hub/pull/4019", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjYwMjA4NQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4019#discussion_r432602085", "bodyText": "should data-hub-ingestion-writer get data-hub-common-writer role just like data-hub-mapping-writer", "author": "bsrikan", "createdAt": "2020-05-29T16:33:50Z", "path": "marklogic-data-hub/src/main/resources/hub-internal-config/security/roles/data-hub-ingestion-writer.json", "diffHunk": "@@ -1,4 +1,7 @@\n {\n   \"role-name\": \"data-hub-ingestion-writer\",\n-  \"description\": \"Permits reading a load data configuration\"\n+  \"description\": \"Permits reading a load data configuration\",", "originalCommit": "963a458401d6d6714caf7e980223b40f9322215d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjg2NzUwNQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4019#discussion_r432867505", "bodyText": "I think that's a good idea.", "author": "rjrudin", "createdAt": "2020-05-30T16:20:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjYwMjA4NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjg2NzU2Nw==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4019#discussion_r432867567", "bodyText": "Oh wait I take that back - I think we're just using this as a \"data\" role, while the hub-central-* roles are \"privilege\" roles.\nThe description does need to be modified though - change \"reading\" to \"writing\".", "author": "rjrudin", "createdAt": "2020-05-30T16:21:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjYwMjA4NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzQ1Mjg4NQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4019#discussion_r433452885", "bodyText": "I added the data-hub-common-writer role to the data-hub-ingestion-writer. It makes sense to me that the data-hub-ingestion-writer should be enough provide enough privileges/permissions to write an ingestion step outside the context of hub-central.", "author": "ryanjdew", "createdAt": "2020-06-01T19:50:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjYwMjA4NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjg2NzQ5OQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4019#discussion_r432867499", "bodyText": "One downside to JSON is we don't have a way to have inline comments about why a privilege is needed. I've used README.md files in the same directory as JSON files before to provide those comments. But those can be difficult to keep in sync - someone has to remember to update them.\nIn theory though, if someone wonders why this privilege is set, they could remove it and run the test suite and something should fail, which would point out what code needs the privilege, right?", "author": "rjrudin", "createdAt": "2020-05-30T16:20:40Z", "path": "marklogic-data-hub/src/main/resources/hub-internal-config/security/roles/data-hub-common-writer.json", "diffHunk": "@@ -29,6 +29,11 @@\n       \"privilege-name\": \"rest-writer\",\n       \"action\": \"http://marklogic.com/xdmp/privileges/rest-writer\",\n       \"kind\": \"execute\"\n+    },\n+    {\n+      \"privilege-name\": \"xdmp:invoke\",", "originalCommit": "963a458401d6d6714caf7e980223b40f9322215d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzM1NDQwNg==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4019#discussion_r433354406", "bodyText": "True. This one stems from the need to insert via hub-utils. It was missed when doing the mapping roles since the mapping reader already provided it as part of testing the mapping.", "author": "ryanjdew", "createdAt": "2020-06-01T16:40:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjg2NzQ5OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjg2NzY0NA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4019#discussion_r432867644", "bodyText": "Are these assertions necessary since you have the tests on the controller, which verifies that the ROLE_* stuff works, which means the right authorities are being returned?", "author": "rjrudin", "createdAt": "2020-05-30T16:23:00Z", "path": "marklogic-data-hub/src/test/ml-modules/root/test/suites/data-hub/5/impl/security/getAuthoritiesTest.sjs", "diffHunk": "@@ -45,6 +45,15 @@ hubTest.runWithRolesAndPrivileges(['hub-central-load-reader'], [], function() {\n     assertions.push(test.assertFalse(authorities.includes('writeIngestion'), 'hub-central-load-reader should not have \"writeIngestion\"'));\n });\n \n+// Test hub-central-load-writer\n+hubTest.runWithRolesAndPrivileges(['hub-central-load-writer'], [], function() {", "originalCommit": "963a458401d6d6714caf7e980223b40f9322215d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzQ0MTczNQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4019#discussion_r433441735", "bodyText": "Will the controller test fail, if the role doesnt include loginToHubCentral or readIngestion authorities?", "author": "bsrikan", "createdAt": "2020-06-01T19:28:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjg2NzY0NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzQ1MzM1MA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4019#discussion_r433453350", "bodyText": "Yes - the loginAsTestUser method in AbstractMvcTest is making a POST to /api/login, so it's going through all the same plumbing as when a user authenticates in HC. So if a call is made with a user that can't login, the test will immediately fail.", "author": "rjrudin", "createdAt": "2020-06-01T19:51:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjg2NzY0NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzQ3NjM4Ng==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4019#discussion_r433476386", "bodyText": "OK Thanks. I will update the test plan likewise.", "author": "bsrikan", "createdAt": "2020-06-01T20:39:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjg2NzY0NA=="}], "type": "inlineReview"}, {"oid": "c5469d7880b6fe419c5354a9987f99a6fb257cdb", "url": "https://github.com/marklogic/marklogic-data-hub/commit/c5469d7880b6fe419c5354a9987f99a6fb257cdb", "message": "DHFPROD-4672: Add hub-central-load-writer role", "committedDate": "2020-06-01T19:45:49Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzQ1NDUwOQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4019#discussion_r433454509", "bodyText": "With Mike's latest changes, I believe we refactored all the mock responses for the test under config/mocks.config.ts.\nCan this mock delete be moved as well?", "author": "bsrikan", "createdAt": "2020-06-01T19:53:58Z", "path": "marklogic-data-hub-central/ui/src/pages/Load.test.tsx", "diffHunk": "@@ -27,58 +27,91 @@ describe('Load component', () => {\n         const authorityService = new AuthoritiesService();\n         authorityService.setAuthorities(['readIngestion']);\n \n-        const { getByText, getByLabelText, getByTestId, debug } = render(<AuthoritiesContext.Provider value={authorityService}><Load/></AuthoritiesContext.Provider>);\n-            debug();\n-        expect(await(waitForElement(() => getByLabelText('load-list')))).toBeInTheDocument();\n+        const { getByText, getByTitle, getByLabelText, getByTestId, queryByTestId, queryByText, queryByTitle } = render(<AuthoritiesContext.Provider value={authorityService}><Load/></AuthoritiesContext.Provider>);\n+\n+        expect(await(waitForElement(() => getByLabelText('switch-view-list')))).toBeInTheDocument();\n \n         // Check for steps to be populated\n         expect(axiosMock.get).toBeCalledWith('/api/steps/ingestion');\n         expect(getByText('testLoad')).toBeInTheDocument();\n \n         // Check list view\n         await fireEvent.click(getByLabelText('switch-view-list'));\n+        // test 'Add New' button\n+        expect(queryByText('Add New')).not.toBeInTheDocument();\n \n         await fireEvent.click(getByTestId('testLoad-settings'));\n         expect(await(waitForElement(() => getByText('Target Database:')))).toBeInTheDocument();\n \n         expect(getByText('Save')).toBeDisabled();\n         await fireEvent.click(getByText('Cancel'));\n-        // Check card view\n+        // test delete\n+        expect(queryByTestId('testLoad-delete')).not.toBeInTheDocument();\n+\n+        // Check card layout\n         await fireEvent.click(getByLabelText('switch-view-card'));\n \n+        // test 'Add New' button\n+        expect(queryByText('Add New')).not.toBeInTheDocument();\n+\n+        // test settings\n         await fireEvent.click(getByLabelText('icon: setting'));\n         expect(await(waitForElement(() => getByText('Target Database:')))).toBeInTheDocument();\n         expect(getByText('Save')).toBeDisabled();\n         await fireEvent.click(getByText('Cancel'));\n+\n+        // test delete\n+        expect(queryByTitle('delete')).not.toBeInTheDocument();\n     });\n \n-    test('Verify can edit with readIngestion and writeIngestion authorities', async () => {\n+    test('Verify edit with readIngestion and writeIngestion authorities', async () => {\n         const authorityService = new AuthoritiesService();\n         authorityService.setAuthorities(['readIngestion','writeIngestion']);\n \n-        const { getByText, getByLabelText, getByTestId } = render(<AuthoritiesContext.Provider value={authorityService}><Load/></AuthoritiesContext.Provider>);\n+        axiosMock.delete['mockImplementation']((url) => {", "originalCommit": "c5469d7880b6fe419c5354a9987f99a6fb257cdb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzQ3NTI1MA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4019#discussion_r433475250", "bodyText": "sure", "author": "ryanjdew", "createdAt": "2020-06-01T20:36:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzQ1NDUwOQ=="}], "type": "inlineReview"}, {"oid": "1597425e4e6acf88217d44ac816e7d8260d0ba9e", "url": "https://github.com/marklogic/marklogic-data-hub/commit/1597425e4e6acf88217d44ac816e7d8260d0ba9e", "message": "DHFPROD-4672: Add hub-central-load-writer role", "committedDate": "2020-06-01T20:55:18Z", "type": "forcePushed"}, {"oid": "2ecfeedebd415cebe131713ed1da1981211906a9", "url": "https://github.com/marklogic/marklogic-data-hub/commit/2ecfeedebd415cebe131713ed1da1981211906a9", "message": "DHFPROD-4672: Add hub-central-load-writer role", "committedDate": "2020-06-01T22:43:56Z", "type": "forcePushed"}, {"oid": "fe8ad25bf3720ba244274d74e8c41480cd4982e0", "url": "https://github.com/marklogic/marklogic-data-hub/commit/fe8ad25bf3720ba244274d74e8c41480cd4982e0", "message": "DHFPROD-4672: Add hub-central-load-writer role", "committedDate": "2020-06-01T22:48:56Z", "type": "commit"}, {"oid": "fe8ad25bf3720ba244274d74e8c41480cd4982e0", "url": "https://github.com/marklogic/marklogic-data-hub/commit/fe8ad25bf3720ba244274d74e8c41480cd4982e0", "message": "DHFPROD-4672: Add hub-central-load-writer role", "committedDate": "2020-06-01T22:48:56Z", "type": "forcePushed"}]}