{"pr_number": 4460, "pr_title": "DHFPROD-5530: e2e test for mapping with processors, DHFPROD-5765: rem\u2026", "pr_createdAt": "2020-08-21T15:06:40Z", "pr_url": "https://github.com/marklogic/marklogic-data-hub/pull/4460", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDc1ODE2OQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4460#discussion_r474758169", "bodyText": "I couldn't get clicking on the list icon and then clicking on the source mapping property to pass consistently, so I typed the xPath expression instead for the e2e test.", "author": "brucean52", "createdAt": "2020-08-21T15:07:52Z", "path": "marklogic-data-hub-central/ui/e2e/cypress/support/components/mapping/source-to-entity-map.tsx", "diffHunk": "@@ -0,0 +1,116 @@\n+class SourceToEntityMap {\n+  clearMap() {\n+    return cy.findByTestId('Clear-btn');\n+  }\n+\n+  testMap() {\n+    return cy.findByTestId('Test-btn');\n+  }\n+\n+  navigateUrisRight() {\n+    return cy.findByTestId('navigate-uris-right');\n+  }\n+\n+  navigateUrisLeft() {\n+    return cy.findByTestId('navigate-uris-left');\n+  }\n+  \n+  expandCollapseSource() {\n+    return cy.findByTestId('expandCollapseBtn-source');\n+  }\n+\n+  toggleSourceFilterMenu() {\n+    cy.findByTestId('filterIcon-key').click();\n+  }\n+\n+  setSourceSearch(propertyName: string) {\n+    cy.get('#searchInput-key').focus().type(propertyName);\n+  }\n+\n+  resetSourceSearch() {\n+    return cy.findByTestId('ResetSearch-key');\n+  }\n+\n+  submitSourceSearch() {\n+    return cy.findByTestId('submitSearch-key');\n+  }  \n+\n+  expandCollapseEntity() {\n+    return cy.findByTestId('expandCollapseBtn-entity');\n+  }\n+\n+  toggleEntityFilterMenu () {\n+    cy.findByTestId('filterIcon-name').click();\n+  }\n+\n+  setEntitySearch(propertyName: string) {\n+    cy.get('#searchInput-name').focus().type(propertyName);\n+  }\n+\n+  resetEntitySearch() {\n+    return cy.findByTestId('ResetSearch-name');\n+  }\n+\n+  submitEntitySearch() {\n+    return cy.findByTestId('submitSearch-name');\n+  }\n+\n+  /**\n+   * Get property icon from dropdown list by Entity type property name\n+   * @param propertyName\n+   * @example OrderId, address\n+   */\n+  getListIcon(propertyName: string) {", "originalCommit": "b8a9de75c283f6cc39b83d257054116f120bb90c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "76c3fd1e990a18d901bddd15a82c2a52a9dc7e09", "url": "https://github.com/marklogic/marklogic-data-hub/commit/76c3fd1e990a18d901bddd15a82c2a52a9dc7e09", "message": "DHFPROD-5530: e2e test for mapping with processors, DHFPROD-5765: removed unsupported datatypes in modeling", "committedDate": "2020-08-21T16:31:35Z", "type": "commit"}, {"oid": "76c3fd1e990a18d901bddd15a82c2a52a9dc7e09", "url": "https://github.com/marklogic/marklogic-data-hub/commit/76c3fd1e990a18d901bddd15a82c2a52a9dc7e09", "message": "DHFPROD-5530: e2e test for mapping with processors, DHFPROD-5765: removed unsupported datatypes in modeling", "committedDate": "2020-08-21T16:31:35Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDk3NzMwNw==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4460#discussion_r474977307", "bodyText": "@briantang has a PR where the messaging is changed a little. \"Mapping\" should be lower case after it goes in.", "author": "bsrikan", "createdAt": "2020-08-21T21:27:07Z", "path": "marklogic-data-hub-central/ui/e2e/cypress/integration/curation/curate/mapping.spec.tsx", "diffHunk": "@@ -0,0 +1,81 @@\n+import { Application } from \"../../../support/application.config\";\n+import { tiles, toolbar } from \"../../../support/components/common\";\n+import {\n+  advancedSettingsDialog,\n+  createEditMappingDialog,\n+  sourceToEntityMap\n+} from '../../../support/components/mapping/index';\n+import browsePage from \"../../../support/pages/browse\";\n+import curatePage from \"../../../support/pages/curate\";\n+import runPage from \"../../../support/pages/run\";\n+import 'cypress-wait-until';\n+\n+describe('Mapping', () => {\n+\n+  beforeEach(() => {\n+    cy.visit('/');\n+    cy.contains(Application.title);\n+    cy.loginAsTestUserWithRoles(\"hub-central-flow-writer\", \"hub-central-mapping-writer\").withRequest();\n+    cy.waitUntil(() => toolbar.getCurateToolbarIcon()).click();\n+    cy.waitUntil(() => curatePage.getEntityTypePanel('Customer').should('be.visible'));\n+  });\n+\n+  afterEach(() => {\n+    cy.resetTestUser();\n+  })\n+\n+  after(() => {\n+    cy.loginAsDeveloper().withRequest();\n+    cy.deleteSteps('mapping', 'order-processors');\n+    cy.deleteFlows( 'orderFlow');\n+  })\n+\n+  it('can create mapping with processors, create new flow, add mapping step, run flow and verify processors', () => {\n+    const stepProcessors = '[{{}\"path\":\"/custom-modules/step-processors/addHeaders.sjs\",\"when\":\"beforeContentPersisted\",\"vars\":{{}\"exampleVariable\":\"testValue\"{}} {}},{{}\"path\":\"/org.example/addPermissions.sjs\",\"when\":\"beforeContentPersisted\"{}}]'\n+\n+    curatePage.toggleEntityTypeId('Order');\n+    curatePage.addNewMapStep().click();\n+\n+    // create mapping step\n+    createEditMappingDialog.setMappingName('order-processors');\n+    createEditMappingDialog.setMappingDescription('An order mapping with custom processors');\n+    createEditMappingDialog.setSourceRadio('Query');\n+    createEditMappingDialog.setQueryInput(\"cts.collectionQuery(['ingest-orders'])\")\n+    createEditMappingDialog.saveButton().click(); \n+    curatePage.verifyStepNameIsVisible('order-processors');\n+\n+    // add processors\n+    curatePage.stepSettings('order-processors').click();\n+    advancedSettingsDialog.toggleProcessors();\n+    advancedSettingsDialog.getProcessors().clear();\n+    advancedSettingsDialog.setProcessors(stepProcessors);\n+    advancedSettingsDialog.saveSettings('order-processors').click();\n+    advancedSettingsDialog.saveSettings('order-processors').should('not.be.visible');\n+\n+    // map source to entity\n+    curatePage.openSourceToEntityMap('Order', 'order-processors');\n+    sourceToEntityMap.expandCollapseEntity().should('be.visible').click();\n+    sourceToEntityMap.setXpathExpressionInput('orderId', 'OrderID');\n+    sourceToEntityMap.setXpathExpressionInput('address', '/');\n+    sourceToEntityMap.setXpathExpressionInput('city', 'ShipCity');\n+    sourceToEntityMap.setXpathExpressionInput('state', 'ShipAddress');\n+    sourceToEntityMap.setXpathExpressionInput('orderDetails', '/');\n+    sourceToEntityMap.setXpathExpressionInput('productID', 'OrderDetails/ProductID');\n+    sourceToEntityMap.setXpathExpressionInput('unitPrice', 'head(OrderDetails/UnitPrice)');\n+    sourceToEntityMap.setXpathExpressionInput('quantity', 'OrderDetails/Quantity');\n+    sourceToEntityMap.setXpathExpressionInput('discount', 'head(OrderDetails/Discount)');\n+    sourceToEntityMap.setXpathExpressionInput('shipRegion', 'ShipRegion');\n+    sourceToEntityMap.setXpathExpressionInput('shippedDate', 'ShippedDate');\n+    // close modal\n+    cy.get('body').type('{esc}');\n+\n+    curatePage.addToNewFlow('Order', 'order-processors');\n+    runPage.setFlowName('orderFlow');\n+    runPage.editSave().click();\n+    runPage.runStep('order-processors').click();\n+    cy.verifyStepRunResult('success','Mapping', 'order-processors');", "originalCommit": "76c3fd1e990a18d901bddd15a82c2a52a9dc7e09", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDk4NDY3Mw==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4460#discussion_r474984673", "bodyText": "Thanks @bsrikan for the awareness, actually this current line is consistent with all the cy.verifyStepRunResult() calls after my PR. My PR fix was to just update inside the command itself so it changes the stepType input parameter to lower case no matter what. Hopefully that makes sense.", "author": "briantang", "createdAt": "2020-08-21T21:49:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDk3NzMwNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDk4MjEyNw==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4460#discussion_r474982127", "bodyText": "'order-processors' is used in multiple places, so for maintainability I would have used it in a variable. No need to change now, but something to think about.", "author": "bsrikan", "createdAt": "2020-08-21T21:41:54Z", "path": "marklogic-data-hub-central/ui/e2e/cypress/integration/curation/curate/mapping.spec.tsx", "diffHunk": "@@ -0,0 +1,81 @@\n+import { Application } from \"../../../support/application.config\";\n+import { tiles, toolbar } from \"../../../support/components/common\";\n+import {\n+  advancedSettingsDialog,\n+  createEditMappingDialog,\n+  sourceToEntityMap\n+} from '../../../support/components/mapping/index';\n+import browsePage from \"../../../support/pages/browse\";\n+import curatePage from \"../../../support/pages/curate\";\n+import runPage from \"../../../support/pages/run\";\n+import 'cypress-wait-until';\n+\n+describe('Mapping', () => {\n+\n+  beforeEach(() => {\n+    cy.visit('/');\n+    cy.contains(Application.title);\n+    cy.loginAsTestUserWithRoles(\"hub-central-flow-writer\", \"hub-central-mapping-writer\").withRequest();\n+    cy.waitUntil(() => toolbar.getCurateToolbarIcon()).click();\n+    cy.waitUntil(() => curatePage.getEntityTypePanel('Customer').should('be.visible'));\n+  });\n+\n+  afterEach(() => {\n+    cy.resetTestUser();\n+  })\n+\n+  after(() => {\n+    cy.loginAsDeveloper().withRequest();\n+    cy.deleteSteps('mapping', 'order-processors');\n+    cy.deleteFlows( 'orderFlow');\n+  })\n+\n+  it('can create mapping with processors, create new flow, add mapping step, run flow and verify processors', () => {\n+    const stepProcessors = '[{{}\"path\":\"/custom-modules/step-processors/addHeaders.sjs\",\"when\":\"beforeContentPersisted\",\"vars\":{{}\"exampleVariable\":\"testValue\"{}} {}},{{}\"path\":\"/org.example/addPermissions.sjs\",\"when\":\"beforeContentPersisted\"{}}]'\n+\n+    curatePage.toggleEntityTypeId('Order');\n+    curatePage.addNewMapStep().click();\n+\n+    // create mapping step\n+    createEditMappingDialog.setMappingName('order-processors');", "originalCommit": "76c3fd1e990a18d901bddd15a82c2a52a9dc7e09", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDk4NTEyMw==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4460#discussion_r474985123", "bodyText": "FYI. Ingest test uses fixtures to get the content and type it in and felt it to be easier than parsing special characters in the spec file.", "author": "bsrikan", "createdAt": "2020-08-21T21:50:57Z", "path": "marklogic-data-hub-central/ui/e2e/cypress/support/components/mapping/advanced-settings-dialog.tsx", "diffHunk": "@@ -0,0 +1,110 @@\n+class AdvancedSettingsDialog {\n+  /**\n+   * Set Source Database\n+   * @param dbName\n+   * @example data-hub-STAGING, data-hub-FINAL\n+   */\n+  setSourceDatabase(dbName: string) {\n+    cy.findByLabelText(`sourceDatabase-select`).click();\n+    cy.findByTestId(`sourceDbOptions-${dbName}`).click();\n+  }\n+\n+  /**\n+   * Set Target Database\n+   * @param dbName\n+   * @example data-hub-STAGING, data-hub-FINAL\n+   */\n+  setTargetDatabase(dbName: string) {\n+    cy.findByLabelText(`targetDatabase-select`).click();\n+    cy.findByTestId(`targetDbOptions-${dbName}`).click();\n+  }\n+\n+  addTargetCollection(collection: string) {\n+    cy.findByLabelText(`additionalColl-select`);\n+    cy.get('#property-name').type(collection);\n+  }\n+\n+  /**\n+   * Set format\n+   * @param format\n+   * @example JSON, XML\n+   */\n+  setTargetFormat(format: string) {\n+    cy.findByLabelText(`targetFormat-select`).click();\n+    // update id\n+  }\n+\n+  /**\n+   * Set Provenance Granularity\n+   * @param provenance\n+   * @example Coarse-grained, Off\n+   */\n+  setProvenanceGranularity(provenance: string) {\n+    cy.findByLabelText(`provGranularity-select`);\n+    cy.findByTestId(`provOptions-${provenance}`).click();\n+  }\n+\n+  /**\n+   * Set Entity Validation\n+   * @param index\n+   * @example 0 = Do not validate, 1 = store errors in headers, 2 = skip docs w/ errors \n+   */\n+  setEntityValidation(index: string) {\n+    cy.get('#validateEntity');\n+    cy.findByTestId(`entityValOpts-${index}`).click();\n+  }\n+\n+  batchSize() {\n+    return cy.get('#batchSize');\n+  }\n+\n+  /**\n+   * Set custom header content\n+   * @param headerContent\n+   * @example {} as valid JSON string\n+   */\n+  setHeaderContent(headerContent: string) {\n+    return cy.get('#headers').type(headerContent);\n+  }\n+\n+  toggleProcessors() {\n+    cy.findByText('Processors').click();\n+  }\n+\n+  getProcessors() {\n+    return cy.get('#processors');\n+  }\n+\n+  /**\n+   * Set processors\n+   * @param processor\n+   * @example [] as valid JSON string\n+   */\n+  setProcessors(processor: string) {", "originalCommit": "76c3fd1e990a18d901bddd15a82c2a52a9dc7e09", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}