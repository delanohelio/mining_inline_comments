{"pr_number": 4810, "pr_title": "DHFPROD-6168:Ensure we can get latest job details if a step is added more than once to a flow", "pr_createdAt": "2020-11-02T20:23:47Z", "pr_url": "https://github.com/marklogic/marklogic-data-hub/pull/4810", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjI5MjkwNw==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4810#discussion_r516292907", "bodyText": "Oof this is brittle - a word search on an unstructured string. Also, the step number can change over time - e.g. a user can move steps around in the flow. I'm really reluctant to base anything on step number for this reason.\nIn fact, this seems like it could break for steps that aren't in a flow twice. For example, let's say my ABC mapping step is step 2, and I run it. Then I change my flow and make it step 3. Then I run this query - I no longer get anything back for my ABC step. Right?\nBecause of the rarity of a step being in a flow twice (we shouldn't prohibit it, because we have no reason to do that, and there may be a valid reason to do it), I think we should just take the latest document and then say - see if there's a stepRunResponse with the same stepNumber and stepName as the given step. If so, use it. If not, then check for a stepRunResponse with the same stepName. If there's 1 or more, use the latest one.", "author": "rjrudin", "createdAt": "2020-11-02T22:27:24Z", "path": "marklogic-data-hub/src/main/resources/ml-modules/root/data-hub/5/data-services/flow/getFlowWithLatestJobInfo.sjs", "diffHunk": "@@ -30,13 +30,19 @@ fn.head(datahub.hubUtils.queryLatest(function() {\n     jobQueries.push(cts.collectionQuery('Job'));\n     jobQueries.push(cts.jsonPropertyValueQuery(\"flow\",flowWithStepDetails.name));\n     jobQueries.push(cts.jsonPropertyValueQuery(\"stepName\",step.stepName));\n+    //A flow may contain same step more then once. 'status' in step response always contains step number", "originalCommit": "b5eaeb1d92ce83d4b04cb6443da0f19248e918ed", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjM0NTgyNw==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4810#discussion_r516345827", "bodyText": "So, in HC where we can run only one step at a time, it essentially means that if a step occurs twice in a flow, the latest job details for both the steps will be the same ?", "author": "srinathgit", "createdAt": "2020-11-02T23:58:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjI5MjkwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjY0NzUyMA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4810#discussion_r516647520", "bodyText": "This is a tough call, as stepNumber is effectively the unique ID for a step within a flow - except that the stepNumber can change, meaning that it's not a very good ID.\nGiven that the previous code was already depending on stepNumber to find the given step, the simplest thing is to keep doing that. The scenario I mentioned above is already a problem with the current approach - i.e. that if the stepNumber changes for a step, then the latest job info will not be found. So constraining the query on the stepNumber being in status isn't any different.\nWe still need tests for at least these scenarios that I can think of:\n\nA single job document that has stepResponses for both occurrences of a step in a flow\nTwo job documents, one for each occurrence of the step in a flow (which would be produced by HC)", "author": "rjrudin", "createdAt": "2020-11-03T12:59:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjI5MjkwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjc2NDAwOQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4810#discussion_r516764009", "bodyText": "@rjrudin\nJust to be clear, the current implementation(changes in getFlowWithLatestJobInfo.sjs) in the PR is good. You want a couple of tests to be added. Is that correct ?", "author": "srinathgit", "createdAt": "2020-11-03T15:42:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjI5MjkwNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjI5MzI5OA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4810#discussion_r516293298", "bodyText": "For testing, don't you need a job document that has at least two step responses - one for each occurrence of the step in the flow?", "author": "rjrudin", "createdAt": "2020-11-02T22:28:19Z", "path": "marklogic-data-hub/src/test/ml-modules/root/test/suites/data-hub/5/data-services/flow/test-data/jobs/job3.json", "diffHunk": "@@ -0,0 +1,32 @@\n+{", "originalCommit": "b5eaeb1d92ce83d4b04cb6443da0f19248e918ed", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjc3Nzg1OA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4810#discussion_r516777858", "bodyText": "Right, I think we need those two scenarios above addressed. But depending on the stepNumber - while brittle - seems reasonable for now, since it's what DHF has been doing.", "author": "rjrudin", "createdAt": "2020-11-03T16:01:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjI5MzI5OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjkxNDQ0NQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4810#discussion_r516914445", "bodyText": "job3.json and job4.json addresses scenario 1 and job5.json scenario2.", "author": "srinathgit", "createdAt": "2020-11-03T19:44:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjI5MzI5OA=="}], "type": "inlineReview"}, {"oid": "2acd21a41ca6f8a84088bda07476af27e8c716fb", "url": "https://github.com/marklogic/marklogic-data-hub/commit/2acd21a41ca6f8a84088bda07476af27e8c716fb", "message": "DHFPROD-6168:Ensure we can get latest job details if a step is added more than once to a flow", "committedDate": "2020-11-03T19:43:29Z", "type": "commit"}, {"oid": "2acd21a41ca6f8a84088bda07476af27e8c716fb", "url": "https://github.com/marklogic/marklogic-data-hub/commit/2acd21a41ca6f8a84088bda07476af27e8c716fb", "message": "DHFPROD-6168:Ensure we can get latest job details if a step is added more than once to a flow", "committedDate": "2020-11-03T19:43:29Z", "type": "forcePushed"}]}