{"pr_number": 4778, "pr_title": "DHFPROD-6163:Add the AWS Glue job info in the job document.", "pr_createdAt": "2020-10-27T20:50:03Z", "pr_url": "https://github.com/marklogic/marklogic-data-hub/pull/4778", "timeline": [{"oid": "65a4f6b30d3c8fe6fdd515dcb13eee10a5623cdb", "url": "https://github.com/marklogic/marklogic-data-hub/commit/65a4f6b30d3c8fe6fdd515dcb13eee10a5623cdb", "message": "DHFPROD-6163:Add the AWS Glue job info in the job document.", "committedDate": "2020-10-27T20:52:04Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzA0OTg2Mw==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4778#discussion_r513049863", "bodyText": "why do we need to set this to null explicitly if user does not configure?", "author": "SameeraPriyathamTadikonda", "createdAt": "2020-10-27T21:41:31Z", "path": "marklogic-data-hub-spark-connector/src/main/java/com/marklogic/hub/spark/sql/sources/v2/DefaultSource.java", "diffHunk": "@@ -237,14 +237,17 @@ private DocumentMetadataHandle buildDocumentMetadata() {\n     private String initializeJob(StructType schema) {\n         loadJobEndpoints();\n \n-        ObjectNode sparkMetadata = objectMapper.createObjectNode();\n+        ObjectNode externalMetadata = objectMapper.createObjectNode();\n         try {\n-            sparkMetadata.set(\"schema\", objectMapper.readTree(schema.json()));\n+            externalMetadata.set(\"additionalExternalMetadata\",", "originalCommit": "65a4f6b30d3c8fe6fdd515dcb13eee10a5623cdb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzA2MzEyNA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4778#discussion_r513063124", "bodyText": "I'll edit the JIRA ticket with my proposal - I don't think we should force an \"additionalExternalMetadata\" key to exist. Instead, each key from the additionalexternalmetadata object should be added to the externalMetadata object.", "author": "rjrudin", "createdAt": "2020-10-27T22:10:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzA0OTg2Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzA1MTc5Mg==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4778#discussion_r513051792", "bodyText": "you might need to regenerate the service class again.", "author": "SameeraPriyathamTadikonda", "createdAt": "2020-10-27T21:45:30Z", "path": "marklogic-data-hub-spark-connector/src/main/java/com/marklogic/hub/spark/dataservices/SparkService.java", "diffHunk": "@@ -103,7 +103,7 @@ private String initializeJob(BaseProxy.DBFunctionRequest request, com.fasterxml.\n               return BaseProxy.StringType.toString(\n                 request\n                       .withParams(\n-                          BaseProxy.documentParam(\"sparkMetadata\", true, BaseProxy.JsonDocumentType.fromJsonNode(sparkMetadata))", "originalCommit": "65a4f6b30d3c8fe6fdd515dcb13eee10a5623cdb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzA2NTE1OA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4778#discussion_r513065158", "bodyText": "The story isn't calling for this, so I don't think we should add more logging here. I don't think this logging is solving any problem either. Ernie already knows what the Run ID of the Glue job is; he can use that to find the DHF job document.", "author": "rjrudin", "createdAt": "2020-10-27T22:15:08Z", "path": "marklogic-data-hub-spark-connector/src/main/java/com/marklogic/hub/spark/sql/sources/v2/writer/HubDataWriter.java", "diffHunk": "@@ -80,6 +82,8 @@ public WriterCommitMessage commit() {\n         bulkInputCaller.awaitCompletion();\n         if (writeException != null) {\n             logger.info(\"At least one write failed\");\n+            logger.info(\"Additional External Metadata - \"+ options.get(\"additionalexternalmetadata\"));", "originalCommit": "65a4f6b30d3c8fe6fdd515dcb13eee10a5623cdb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzA3NTY1OA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4778#discussion_r513075658", "bodyText": "But if the option \"additionalexternalmetadata\" is not there in the script, there is no way Ernie will  know the Glue Run id. In that case we might want to add a logger saying what and where he needs to add/change his Glue script.", "author": "anu3990", "createdAt": "2020-10-27T22:41:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzA2NTE1OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzA5ODM1NQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4778#discussion_r513098355", "bodyText": "I'm not following - I can see logging the DHF job ID here, because if Ernie doesn't provide the Glue Run ID in the options, then the DHF job ID would be useful in the Glue logs as a way of finding the associated DHF job document - though it won't be that helpful, since it won't have any additional info in it.\nBut if Ernie doesn't provide additionalexternalmetadata - well that's his choice. Our documentation can make it clear that that's the way he can add additional data to the job document. Also, we wouldn't want Glue-specific logging in a Spark-generic connector.", "author": "rjrudin", "createdAt": "2020-10-27T23:50:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzA2NTE1OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzA2NTcwOA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4778#discussion_r513065708", "bodyText": "Let's add a \"desc\" to this to make it clear what the purpose of this is. How about: \"JSON object that, if not null, will be added to the job document with a key of 'externalMetadata'\".", "author": "rjrudin", "createdAt": "2020-10-27T22:16:26Z", "path": "marklogic-data-hub/src/main/resources/ml-modules/root/marklogic-data-hub-spark-connector/initializeJob.api", "diffHunk": "@@ -2,7 +2,7 @@\n   \"functionName\" : \"initializeJob\",\n   \"desc\" : \"Creates a job document with the given sparkMetadata as a property\",\n   \"params\" : [ {\n-    \"name\" : \"sparkMetadata\",\n+    \"name\" : \"externalMetadata\",", "originalCommit": "65a4f6b30d3c8fe6fdd515dcb13eee10a5623cdb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzA2NTc1OQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4778#discussion_r513065759", "bodyText": "Need to rename to externalMetadata", "author": "rjrudin", "createdAt": "2020-10-27T22:16:35Z", "path": "marklogic-data-hub/src/main/resources/ml-modules/root/marklogic-data-hub-spark-connector/initializeJob.api", "diffHunk": "@@ -2,7 +2,7 @@\n   \"functionName\" : \"initializeJob\",\n   \"desc\" : \"Creates a job document with the given sparkMetadata as a property\",", "originalCommit": "65a4f6b30d3c8fe6fdd515dcb13eee10a5623cdb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "d0b6ff9f3fd834cea4649faeba58d2532abd8d66", "url": "https://github.com/marklogic/marklogic-data-hub/commit/d0b6ff9f3fd834cea4649faeba58d2532abd8d66", "message": "DHFPROD-6163:Add the AWS Glue job info in the job document.", "committedDate": "2020-10-28T04:26:34Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzU3NTA2MA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4778#discussion_r513575060", "bodyText": "@SameeraPriyathamTadikonda it is here.", "author": "anu3990", "createdAt": "2020-10-28T16:13:03Z", "path": "specs/models/Job.schema.json", "diffHunk": "@@ -35,7 +35,7 @@\n       \"type\": \"string\",\n       \"description\": \"dateTime at which the job ended\"\n     },\n-    \"sparkMetadata\": {\n+    \"externalMetadata\": {", "originalCommit": "d0b6ff9f3fd834cea4649faeba58d2532abd8d66", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzU3NzA1MQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4778#discussion_r513577051", "bodyText": "sorry, missed it somehow.", "author": "SameeraPriyathamTadikonda", "createdAt": "2020-10-28T16:15:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzU3NTA2MA=="}], "type": "inlineReview"}, {"oid": "235c4243481bc9a36430672090efd9aee501f98b", "url": "https://github.com/marklogic/marklogic-data-hub/commit/235c4243481bc9a36430672090efd9aee501f98b", "message": "DHFPROD-6163:Add the AWS Glue job info in the job document.", "committedDate": "2020-10-28T16:45:48Z", "type": "forcePushed"}, {"oid": "08c4b34fe6e25efc4ad36f280a6b951f88e89ff3", "url": "https://github.com/marklogic/marklogic-data-hub/commit/08c4b34fe6e25efc4ad36f280a6b951f88e89ff3", "message": "DHFPROD-6163:Add the AWS Glue job info in the job document.", "committedDate": "2020-10-28T17:09:27Z", "type": "forcePushed"}, {"oid": "d7481f90414523b3c04310256acb94c08a67bbaa", "url": "https://github.com/marklogic/marklogic-data-hub/commit/d7481f90414523b3c04310256acb94c08a67bbaa", "message": "DHFPROD-6163:Add the AWS Glue job info in the job document.", "committedDate": "2020-10-28T18:07:42Z", "type": "commit"}, {"oid": "d7481f90414523b3c04310256acb94c08a67bbaa", "url": "https://github.com/marklogic/marklogic-data-hub/commit/d7481f90414523b3c04310256acb94c08a67bbaa", "message": "DHFPROD-6163:Add the AWS Glue job info in the job document.", "committedDate": "2020-10-28T18:07:42Z", "type": "forcePushed"}]}