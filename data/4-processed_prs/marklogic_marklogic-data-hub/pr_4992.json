{"pr_number": 4992, "pr_title": "DHFPROD-5983: Run new OOTB step to add sourceName and sourceType to user-specified documents", "pr_createdAt": "2020-12-12T02:38:15Z", "pr_url": "https://github.com/marklogic/marklogic-data-hub/pull/4992", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTk0MjEyNA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4992#discussion_r541942124", "bodyText": "Call both of these functions \"addSourceTo...\", since only one source is being added (even though that may require adding a \"sources\" property).", "author": "rjrudin", "createdAt": "2020-12-13T15:01:12Z", "path": "marklogic-data-hub/src/main/resources/ml-modules/root/data-hub/5/builtins/steps/custom/addSourceNameAndType/main.sjs", "diffHunk": "@@ -0,0 +1,65 @@\n+function main(content, options) {\n+  if(options[\"sourceNameToAdd\"] || options[\"sourceTypeToAdd\"]) {\n+    // See https://docs.marklogic.com/Node.nodeType\n+    if(content.value.root && 1 === content.value.root.nodeType) {\n+      addSourcesToXmlDocuments(content, options[\"sourceNameToAdd\"], options[\"sourceTypeToAdd\"]);", "originalCommit": "9398340f92e3a92827d25ad833a21191976b9780", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTk0MjQwNw==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4992#discussion_r541942407", "bodyText": "You should be able to use \"makeInputFilePathsAbsoluteInFlow\" here.\nPinging @akshaysonvane  about this - I am wondering though if the best way to override this in tests is via setInputFilePath. But it should be a lot easier than this when there's only one ingestion step (the above makeInputfilePaths function is useful when there are multiple ingestion steps, and each needs it's one absolute path). How about:\naddAbsoluteInputFilePath(flowInputs, \"data\");\n\nThat would use the current HubProject to resolve the \"data\" directory and then add the absolute file path of that directory to flowInputs.", "author": "rjrudin", "createdAt": "2020-12-13T15:02:33Z", "path": "marklogic-data-hub/src/test/java/com/marklogic/hub/flow/AddSourceNameAndTypeStepDefTest.java", "diffHunk": "@@ -0,0 +1,124 @@\n+package com.marklogic.hub.flow;\n+\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.fasterxml.jackson.databind.node.ArrayNode;\n+import com.marklogic.hub.AbstractHubCoreTest;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.w3c.dom.Document;\n+import org.w3c.dom.NodeList;\n+\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+import static org.junit.jupiter.api.Assertions.*;\n+\n+public class AddSourceNameAndTypeStepDefTest extends AbstractHubCoreTest {\n+    @BeforeEach\n+    void beforeEach() {\n+        installProjectInFolder(\"test-projects/addSources-step-definition-test\");\n+        String path = \"test-projects/addSources-step-definition-test/data\";\n+        FlowInputs inputs = new FlowInputs(\"addSourcesFlow\", \"1\");\n+        inputs.setInputFilePath(getClass().getClassLoader().getResource(path).getPath());", "originalCommit": "9398340f92e3a92827d25ad833a21191976b9780", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTk5NTQ0MA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4992#discussion_r541995440", "bodyText": "Added the method addAbsoluteInputFilePath in AbstractHubTest class which reads flowInputs and input filePath and adds the absolute path of the directory to flowInputs", "author": "rahulvudutala", "createdAt": "2020-12-13T20:08:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTk0MjQwNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTk0MzMwMw==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4992#discussion_r541943303", "bodyText": "Nice - simplest document possible!", "author": "rjrudin", "createdAt": "2020-12-13T15:07:27Z", "path": "marklogic-data-hub/src/test/resources/test-projects/addSources-step-definition-test/data/customer1.json", "diffHunk": "@@ -0,0 +1,3 @@\n+{", "originalCommit": "9398340f92e3a92827d25ad833a21191976b9780", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTk0MzQwNw==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4992#discussion_r541943407", "bodyText": "Can't both steps be run at the same time since they use the same input path?", "author": "rjrudin", "createdAt": "2020-12-13T15:08:07Z", "path": "marklogic-data-hub/src/test/java/com/marklogic/hub/flow/AddSourceNameAndTypeStepDefTest.java", "diffHunk": "@@ -0,0 +1,124 @@\n+package com.marklogic.hub.flow;\n+\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.fasterxml.jackson.databind.node.ArrayNode;\n+import com.marklogic.hub.AbstractHubCoreTest;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.w3c.dom.Document;\n+import org.w3c.dom.NodeList;\n+\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+import static org.junit.jupiter.api.Assertions.*;\n+\n+public class AddSourceNameAndTypeStepDefTest extends AbstractHubCoreTest {\n+    @BeforeEach\n+    void beforeEach() {\n+        installProjectInFolder(\"test-projects/addSources-step-definition-test\");\n+        String path = \"test-projects/addSources-step-definition-test/data\";\n+        FlowInputs inputs = new FlowInputs(\"addSourcesFlow\", \"1\");\n+        inputs.setInputFilePath(getClass().getClassLoader().getResource(path).getPath());\n+        runFlow(inputs);\n+\n+        inputs.setSteps(Arrays.asList(\"2\"));\n+        runFlow(inputs);", "originalCommit": "9398340f92e3a92827d25ad833a21191976b9780", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTk0NDA2OQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4992#discussion_r541944069", "bodyText": "These are really good tests, but I think we need a couple more things - need to verify that if \"sources\" already exists, then a new source is added and the existing ones aren't modified. You can simply add one more JSON doc and one more XML doc to your test data and verify them as part of the first test scenario (I don't think you need to verify them in every other test).", "author": "rjrudin", "createdAt": "2020-12-13T15:11:49Z", "path": "marklogic-data-hub/src/test/java/com/marklogic/hub/flow/AddSourceNameAndTypeStepDefTest.java", "diffHunk": "@@ -0,0 +1,124 @@\n+package com.marklogic.hub.flow;\n+\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.fasterxml.jackson.databind.node.ArrayNode;\n+import com.marklogic.hub.AbstractHubCoreTest;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.w3c.dom.Document;\n+import org.w3c.dom.NodeList;\n+\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+import static org.junit.jupiter.api.Assertions.*;\n+\n+public class AddSourceNameAndTypeStepDefTest extends AbstractHubCoreTest {", "originalCommit": "9398340f92e3a92827d25ad833a21191976b9780", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTk5NTMzNA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4992#discussion_r541995334", "bodyText": "I have run the same flow with different options on the same files without adding new files and verified if the previously added sources are not updated.", "author": "rahulvudutala", "createdAt": "2020-12-13T20:07:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTk0NDA2OQ=="}], "type": "inlineReview"}, {"oid": "efbc12035cb779cd98ef3e7a8ca3bb94b05111ad", "url": "https://github.com/marklogic/marklogic-data-hub/commit/efbc12035cb779cd98ef3e7a8ca3bb94b05111ad", "message": "DHFPROD-5983: Run new OOTB step to add sourceName and sourceType to user-specified documents", "committedDate": "2020-12-13T20:04:57Z", "type": "commit"}, {"oid": "efbc12035cb779cd98ef3e7a8ca3bb94b05111ad", "url": "https://github.com/marklogic/marklogic-data-hub/commit/efbc12035cb779cd98ef3e7a8ca3bb94b05111ad", "message": "DHFPROD-5983: Run new OOTB step to add sourceName and sourceType to user-specified documents", "committedDate": "2020-12-13T20:04:57Z", "type": "forcePushed"}]}