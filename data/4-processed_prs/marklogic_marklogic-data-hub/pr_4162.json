{"pr_number": 4162, "pr_title": "DHFPROD-4812: UI: Clear user data from Hub Central", "pr_createdAt": "2020-06-26T21:17:04Z", "pr_url": "https://github.com/marklogic/marklogic-data-hub/pull/4162", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjcwOTE0NQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4162#discussion_r446709145", "bodyText": "I think we should probably refactor all the tests for this component such that text assertions are not repeated.\n\n\"should verify project info display, user with \"Download\" and \"Clear\" button disabled'\" with authority [], to verify all the text, like service name, DH/ML version, Download/Clear texts alongwith Download and Clear button disabled.\n\"verify project info display, user with \"Download\" button enabled\" with authority [downloadProjectFiles] that asserts Download is enabled, Clear is disabled and click Download and verify alert message\n\"verify project info display, user with \"Clear\" button enabled\" with authority [clearUserData] that asserts Download is disabled, Clear is enabled and click Clear and verify alert message.\n\nAdditionally a test to verify error response for Clear when status != 200. You can refer login tests for this purpose.", "author": "bsrikan", "createdAt": "2020-06-28T23:00:09Z", "path": "marklogic-data-hub-central/ui/src/components/header/system-info.test.tsx", "diffHunk": "@@ -26,18 +27,19 @@ describe('Update data load settings component', () => {\n         expect(getByText('MarkLogic version:')).toBeInTheDocument();\n         expect(getByText(data.environment.marklogicVersion)).toBeInTheDocument();\n         expect(getByText('Download Configuration Files')).toBeInTheDocument();\n-        expect(getByText('Clear All User Data')).toBeInTheDocument();\n+        expect(getByTestId('clearData')).toBeInTheDocument();", "originalCommit": "e9f2547393888fda72468aff7fed5544e9157b57", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjcxNTQ1Ng==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4162#discussion_r446715456", "bodyText": "Clear data alert has display:'none', so the alert might show up in the DOM passing this assertion even when alert message doesnt appear.\ntoBeVisible() may be better suited in this situation. To verify using the text which has inline bold tags, refer getSubElements() in Run.test.tsx", "author": "bsrikan", "createdAt": "2020-06-29T00:00:51Z", "path": "marklogic-data-hub-central/ui/src/components/header/system-info.test.tsx", "diffHunk": "@@ -47,8 +49,36 @@ describe('Update data load settings component', () => {\n         expect(getByText('MarkLogic version:')).toBeInTheDocument();\n         expect(getByText(data.environment.marklogicVersion)).toBeInTheDocument();\n         expect(getByText('Download Configuration Files')).toBeInTheDocument();\n-        expect(getByText('Clear All User Data')).toBeInTheDocument();\n+        expect(getByTestId('clearData')).toBeInTheDocument();\n         expect(getByText('Download')).toBeDisabled();\n+        expect(getByText('Clear')).toBeDisabled();\n+    });\n+\n+    test('verify project info display, user with \"Clear\" button enabled', async () => {\n+        const authorityService = new AuthoritiesService();\n+        authorityService.setAuthorities(['clearUserData']);\n+        const { getByText,getByTestId } = render(<Router><AuthoritiesContext.Provider value={authorityService}>\n+            <SystemInfo {...data.environment}\n+                        systemInfoVisible={true}\n+                        setSystemInfoVisible={jest.fn()}\n+            />\n+        </AuthoritiesContext.Provider></Router>);\n+        expect(getByText(data.environment.serviceName)).toBeInTheDocument();\n+        expect(getByText('Data Hub version:')).toBeInTheDocument();\n+        expect(getByText(data.environment.dataHubVersion)).toBeInTheDocument();\n+        expect(getByText('MarkLogic version:')).toBeInTheDocument();\n+        expect(getByText(data.environment.marklogicVersion)).toBeInTheDocument();\n+        expect(getByText('Download Configuration Files')).toBeInTheDocument();\n+        expect(getByTestId('clearData')).toBeInTheDocument();\n+        expect(getByText('Download a zip file containing flow definitions, step definitions and other user artifacts created or modified by Hub Central.')).toBeInTheDocument();\n+        expect(getByText('Delete all user data in STAGING, FINAL, and JOBS databases.')).toBeInTheDocument();\n+        expect(getByText('Download')).toBeDisabled();\n+        expect(getByText('Clear')).toBeEnabled();\n+        let clearBtn = getByText('Clear');\n+        await wait (()=> {\n+            fireEvent.submit(clearBtn);\n+        });\n+        expect(getByTestId('alertTrue')).toBeInTheDocument();", "originalCommit": "e9f2547393888fda72468aff7fed5544e9157b57", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjcxNjQyOA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4162#discussion_r446716428", "bodyText": "If getByText('Clear All User Data') works we can get rid of the data-testid here. data-testid should be used as a last resort. RTL encourages good testing practices with the primary guiding principle:\nThe more your tests resemble the way your software is used, the more confidence they can give you.", "author": "bsrikan", "createdAt": "2020-06-29T00:09:21Z", "path": "marklogic-data-hub-central/ui/src/components/header/system-info.tsx", "diffHunk": "@@ -55,48 +77,58 @@ const SystemInfo = (props) => {\n             className={styles.systemModal}\n             destroyOnClose={true}\n         >\n-        <div className={styles.systemContainer}>\n-            <div className={styles.serviceName}>{serviceName}</div>\n-            <div className={styles.version}>\n-                <div className={styles.label}>Data Hub version:</div>\n-                <div className={styles.value}>{dataHubVersion}</div>\n-            </div>\n-            <div className={styles.version}>\n-                <div className={styles.label}>MarkLogic version:</div>\n-                <div className={styles.value}>{marklogicVersion}</div>\n-            </div>\n-            <div className={styles.cardsContainer}>\n-                <div className={styles.cards}>\n-                    <Row gutter={16} type=\"flex\" >\n+            <div className={styles.systemContainer}>\n+                <div data-testid=\"alertTrue\" className={styles.alertPosition} style={message.show ? {display: 'block'} : {display: 'none'}}>\n+                    <Alert message={<p><b>Clear All User Data </b>completed successfully</p>} type='success' showIcon />\n+                </div>\n+                <div className={styles.serviceName}>{serviceName}</div>\n+                <div className={styles.version}>\n+                    <div className={styles.label}>Data Hub version:</div>\n+                    <div className={styles.value}>{dataHubVersion}</div>\n+                </div>\n+                <div className={styles.version}>\n+                    <div className={styles.label}>MarkLogic version:</div>\n+                    <div className={styles.value}>{marklogicVersion}</div>\n+                </div>\n+                <div className={styles.cardsContainer}>\n+                    <div className={styles.cards}>\n+                        <Row gutter={16} type=\"flex\" >\n \n-                        <Col>\n-                            <Card size=\"small\" className={styles.download} >\n-                                <div className={styles.title}>Download Configuration Files</div>\n-                                <p>Download a zip file containing flow definitions, step definitions and other user artifacts created or modified by Hub Central.</p>\n-                                <div className={styles.buttonContainer}>\n-                                    <Button \n-                                        type=\"primary\" \n-                                        disabled = {! authorityService.canDownloadProjectFiles()}\n-                                        onClick={download}\n-                                    >Download</Button>\n-                                </div>\n-                            </Card>\n-                        </Col>\n+                            <Col>\n+                                <Card size=\"small\" className={styles.download} >\n+                                    <div className={styles.title}>Download Configuration Files</div>\n+                                    <p>Download a zip file containing flow definitions, step definitions and other user artifacts created or modified by Hub Central.</p>\n+                                    <div className={styles.buttonContainer}>\n+                                        <Button\n+                                            type=\"primary\"\n+                                            disabled = {! authorityService.canDownloadProjectFiles()}\n+                                            onClick={download}\n+                                        >Download</Button>\n+                                    </div>\n+                                </Card>\n+                            </Col>\n \n-                        <Col>\n-                            <Card size=\"small\" className={styles.clearAll} >\n-                                <div className={styles.title}>Clear All User Data</div>\n-                                <p>Delete all user data in STAGING, FINAL, and JOBS databases.</p>\n-                                <div className={styles.buttonContainer}>\n-                                    <Button type=\"primary\">Clear</Button>\n-                                </div>\n-                            </Card>\n-                        </Col>\n+                            <Col>\n+                                <Card size=\"small\" className={styles.clearAll}>\n+                                    {isLoading === true ? <div className={styles.spinRunning}>\n+                                         <Spin size={\"large\"} />\n+                                    </div>: ''}\n+                                    <div className={styles.title} data-testid=\"clearData\">Clear All User Data</div>", "originalCommit": "e9f2547393888fda72468aff7fed5544e9157b57", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzI2MTE4MQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4162#discussion_r447261181", "bodyText": "@AkshayBajajML ,\ngetByText('Clear All User Data') doesn't work ?", "author": "srinathgit", "createdAt": "2020-06-29T21:21:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjcxNjQyOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzI2NDY2OA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4162#discussion_r447264668", "bodyText": "Since Alert \"Clear All User Data completed successfully\" has initial words same as \"Clear All User Data\" button, due to this most of the test cases fail so had to use data-testid in order to avoid ambiguity.", "author": "AkshayBajajML", "createdAt": "2020-06-29T21:28:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjcxNjQyOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzI2NjE4MQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4162#discussion_r447266181", "bodyText": "But, doesn't the alert appears after the button is clicked ? So, before the button is clicked, getByText('Clear All User Data') refers to the button and there is no ambiguity right ?", "author": "srinathgit", "createdAt": "2020-06-29T21:31:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjcxNjQyOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzMwODc1OQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4162#discussion_r447308759", "bodyText": "As Srikanth previously mentioned that alert is set to none when button is not clicked due to which its still present in DOM even it is not visible hence fails the test case using getByText.", "author": "AkshayBajajML", "createdAt": "2020-06-29T23:06:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjcxNjQyOA=="}], "type": "inlineReview"}, {"oid": "260ba405954e24fd1b9137c27164c0da455652a8", "url": "https://github.com/marklogic/marklogic-data-hub/commit/260ba405954e24fd1b9137c27164c0da455652a8", "message": "DHFPROD-4812: UI: Clear user data from Hub Central", "committedDate": "2020-06-29T19:17:03Z", "type": "forcePushed"}, {"oid": "3ee7c0080afad8b7699f592d186d9f2351188ab6", "url": "https://github.com/marklogic/marklogic-data-hub/commit/3ee7c0080afad8b7699f592d186d9f2351188ab6", "message": "DHFPROD-4812: UI: Clear user data from Hub Central", "committedDate": "2020-06-29T22:39:57Z", "type": "commit"}, {"oid": "3ee7c0080afad8b7699f592d186d9f2351188ab6", "url": "https://github.com/marklogic/marklogic-data-hub/commit/3ee7c0080afad8b7699f592d186d9f2351188ab6", "message": "DHFPROD-4812: UI: Clear user data from Hub Central", "committedDate": "2020-06-29T22:39:57Z", "type": "forcePushed"}]}