{"pr_number": 3730, "pr_title": "DHFPROD-3647: Save personal search query and its associated filters", "pr_createdAt": "2020-03-19T19:21:19Z", "pr_url": "https://github.com/marklogic/marklogic-data-hub/pull/3730", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTI2NjM5NA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3730#discussion_r395266394", "bodyText": "I believe \"data-hub-saved-query-writer\" should be assigned to \"data-hub-developer\"", "author": "srinathgit", "createdAt": "2020-03-19T19:24:03Z", "path": "marklogic-data-hub/src/main/resources/hub-internal-config/security/roles/data-hub-operator.json", "diffHunk": "@@ -12,7 +12,9 @@\n     \"data-hub-step-definition-reader\",\n     \"data-hub-load-data-reader\",\n     \"data-hub-match-merge-reader\",\n-    \"tde-view\"\n+    \"tde-view\",\n+    \"data-hub-saved-query-reader\",\n+    \"data-hub-saved-query-writer\"", "originalCommit": "0822bf6cd052cbc1a15e24826cc4e1dddd9b8d33", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTI3MTY4MQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3730#discussion_r395271681", "bodyText": "Users able to run flows and see entity instances should be able to save personal queries. So added the write capability to data-hub-operator.\ndata-hub-developer inherits data-hub-operator role. So didn't any role for data-hub-developer", "author": "rahulvudutala", "createdAt": "2020-03-19T19:33:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTI2NjM5NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTI4NzU5NA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3730#discussion_r395287594", "bodyText": "Yeah, normally the reader role would go to operator and writer to developer, but this is different since an operator has to be able to read and write saved queries.", "author": "rjrudin", "createdAt": "2020-03-19T20:03:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTI2NjM5NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTI4ODY3MA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3730#discussion_r395288670", "bodyText": "I'd change that to be an assertTrue(response.roles.length > 17, \"with some message here explaining what the minimum number of expected roles is\"). This assertion is otherwise going to break whenever roles are added.", "author": "rjrudin", "createdAt": "2020-03-19T20:04:59Z", "path": "marklogic-data-hub/src/test/ml-modules/root/test/suites/data-hub/5/data-services/security/getAuthoritiesTest.sjs", "diffHunk": "@@ -8,17 +8,18 @@ function invokeService() {\n }\n \n const response = invokeService();\n-\n+xdmp.log(response.authorities.toString());\n+xdmp.log(response.roles.toString());\n [\n     test.assertEqual(\"flow-developer\", xdmp.getCurrentUser()),\n     test.assertEqual(10, response.authorities.length),\n     test.assertEqual(\"canWriteLoadData,canReadLoadData,canWriteFlows,canReadFlows,\" +\n         \"canWriteStepDefinitions,canReadStepDefinitions,canWriteMappings,canReadMappings,canWriteMatching,canReadMatching\",\n         response.authorities.toString()),\n-    test.assertEqual(17, response.roles.length),\n-    test.assertEqual(\"data-hub-operator,data-hub-entity-model-reader,data-hub-mapping-writer,data-hub-mapping-reader,\"+\n-    \"data-hub-match-merge-writer,data-hub-load-data-writer,data-hub-module-writer,data-hub-load-data-reader,\"+\n-    \"data-hub-job-reader,data-hub-flow-reader,data-hub-step-definition-reader,data-hub-match-merge-reader,data-hub-step-definition-writer,\"+\n-    \"data-hub-flow-writer,data-hub-developer,data-hub-entity-model-writer,data-hub-module-reader\",\n-        response.roles.toString())\n-]\n+    test.assertEqual(19, response.roles.length),", "originalCommit": "0822bf6cd052cbc1a15e24826cc4e1dddd9b8d33", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTI5ODg0OA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3730#discussion_r395298848", "bodyText": "No need to change now, but there's a ResponseEntity.ok method you can use to get this all done in one line of code (I think by rule, a controller method should be one line of code, but there will of course be exceptions).\nThere's also ResponseEntity.created, but it requires a URI - which makes me think that perhaps the saveQueryDocument method should just return the queryId?", "author": "rjrudin", "createdAt": "2020-03-19T20:24:52Z", "path": "one-ui/src/main/java/com/marklogic/hub/oneui/controllers/SavedQueriesController.java", "diffHunk": "@@ -0,0 +1,47 @@\n+package com.marklogic.hub.oneui.controllers;\n+\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.marklogic.hub.oneui.managers.SavedQueriesManager;\n+import com.marklogic.hub.oneui.models.HubConfigSession;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.context.annotation.Bean;\n+import org.springframework.context.annotation.Scope;\n+import org.springframework.context.annotation.ScopedProxyMode;\n+import org.springframework.http.HttpStatus;\n+import org.springframework.http.ResponseEntity;\n+import org.springframework.stereotype.Controller;\n+import org.springframework.web.bind.annotation.RequestBody;\n+import org.springframework.web.bind.annotation.RequestMapping;\n+import org.springframework.web.bind.annotation.RequestMethod;\n+import org.springframework.web.bind.annotation.ResponseBody;\n+\n+@Controller\n+@RequestMapping(value = \"/api/savedQueries\")\n+public class SavedQueriesController {\n+\n+    @Autowired\n+    private SavedQueriesManager savedQueriesManager;\n+\n+    @Autowired\n+    private HubConfigSession hubConfig;\n+\n+    @Bean\n+    @Scope(proxyMode = ScopedProxyMode.TARGET_CLASS, value = \"request\")\n+    SavedQueriesManager savedQueriesManager() {\n+        return new SavedQueriesManager(hubConfig);\n+    }\n+\n+    @RequestMapping(method = RequestMethod.POST)\n+    @ResponseBody\n+    public ResponseEntity<JsonNode> saveQueryDocument(@RequestBody JsonNode queryDocument) {\n+        JsonNode savedQuery = savedQueriesManager.saveOrUpdateQueryDocument(queryDocument);\n+        return new ResponseEntity<>(savedQuery, HttpStatus.CREATED);\n+    }\n+\n+    @RequestMapping(method = RequestMethod.PUT)\n+    @ResponseBody\n+    public ResponseEntity<JsonNode> updateQueryDocument(@RequestBody JsonNode queryDocument) {\n+        JsonNode savedQuery = savedQueriesManager.saveOrUpdateQueryDocument(queryDocument);\n+        return new ResponseEntity<>(savedQuery, HttpStatus.OK);", "originalCommit": "0822bf6cd052cbc1a15e24826cc4e1dddd9b8d33", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTI5OTAxNw==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3730#discussion_r395299017", "bodyText": "I don't think Bean is buying you anything here, right? I think the method works the same without these two annotations on it. I recommend removing them to avoid any confusion.", "author": "rjrudin", "createdAt": "2020-03-19T20:25:14Z", "path": "one-ui/src/main/java/com/marklogic/hub/oneui/controllers/SavedQueriesController.java", "diffHunk": "@@ -0,0 +1,47 @@\n+package com.marklogic.hub.oneui.controllers;\n+\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.marklogic.hub.oneui.managers.SavedQueriesManager;\n+import com.marklogic.hub.oneui.models.HubConfigSession;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.context.annotation.Bean;\n+import org.springframework.context.annotation.Scope;\n+import org.springframework.context.annotation.ScopedProxyMode;\n+import org.springframework.http.HttpStatus;\n+import org.springframework.http.ResponseEntity;\n+import org.springframework.stereotype.Controller;\n+import org.springframework.web.bind.annotation.RequestBody;\n+import org.springframework.web.bind.annotation.RequestMapping;\n+import org.springframework.web.bind.annotation.RequestMethod;\n+import org.springframework.web.bind.annotation.ResponseBody;\n+\n+@Controller\n+@RequestMapping(value = \"/api/savedQueries\")\n+public class SavedQueriesController {\n+\n+    @Autowired\n+    private SavedQueriesManager savedQueriesManager;\n+\n+    @Autowired\n+    private HubConfigSession hubConfig;\n+\n+    @Bean", "originalCommit": "0822bf6cd052cbc1a15e24826cc4e1dddd9b8d33", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTI5OTMxNQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3730#discussion_r395299315", "bodyText": "You don't need this if you're using savedQueriesManager(), right?", "author": "rjrudin", "createdAt": "2020-03-19T20:25:44Z", "path": "one-ui/src/main/java/com/marklogic/hub/oneui/controllers/SavedQueriesController.java", "diffHunk": "@@ -0,0 +1,47 @@\n+package com.marklogic.hub.oneui.controllers;\n+\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.marklogic.hub.oneui.managers.SavedQueriesManager;\n+import com.marklogic.hub.oneui.models.HubConfigSession;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.context.annotation.Bean;\n+import org.springframework.context.annotation.Scope;\n+import org.springframework.context.annotation.ScopedProxyMode;\n+import org.springframework.http.HttpStatus;\n+import org.springframework.http.ResponseEntity;\n+import org.springframework.stereotype.Controller;\n+import org.springframework.web.bind.annotation.RequestBody;\n+import org.springframework.web.bind.annotation.RequestMapping;\n+import org.springframework.web.bind.annotation.RequestMethod;\n+import org.springframework.web.bind.annotation.ResponseBody;\n+\n+@Controller\n+@RequestMapping(value = \"/api/savedQueries\")\n+public class SavedQueriesController {\n+\n+    @Autowired\n+    private SavedQueriesManager savedQueriesManager;", "originalCommit": "0822bf6cd052cbc1a15e24826cc4e1dddd9b8d33", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTI5OTc5OA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3730#discussion_r395299798", "bodyText": "Does this really work? I'm thinking this will break because newFinalClient() passes in a finalDbName, which will cause Data Services to throw an error. I think you want newFinalClient(null).", "author": "rjrudin", "createdAt": "2020-03-19T20:26:37Z", "path": "one-ui/src/main/java/com/marklogic/hub/oneui/managers/SavedQueriesManager.java", "diffHunk": "@@ -0,0 +1,43 @@\n+package com.marklogic.hub.oneui.managers;\n+\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.marklogic.client.DatabaseClient;\n+import com.marklogic.client.MarkLogicServerException;\n+import com.marklogic.hub.HubConfig;\n+import com.marklogic.hub.dataservices.SavedQueriesService;\n+import com.marklogic.hub.oneui.exceptions.BadRequestException;\n+import com.marklogic.hub.oneui.exceptions.DataHubException;\n+\n+public class SavedQueriesManager {\n+\n+    private DatabaseClient finalDataServiceClient;\n+\n+    public SavedQueriesManager(HubConfig hubConfig) {\n+        finalDataServiceClient = hubConfig.newFinalClient();", "originalCommit": "0822bf6cd052cbc1a15e24826cc4e1dddd9b8d33", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTMwMTExMw==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3730#discussion_r395301113", "bodyText": "Also, instead of hanging onto a reference to the DatabaseClient, why not instantiate the SavedQueriesService here?", "author": "rjrudin", "createdAt": "2020-03-19T20:29:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTI5OTc5OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTMwMDc0Mg==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3730#discussion_r395300742", "bodyText": "What's the purpose of wrapping this in a DataHubException?", "author": "rjrudin", "createdAt": "2020-03-19T20:28:24Z", "path": "one-ui/src/main/java/com/marklogic/hub/oneui/managers/SavedQueriesManager.java", "diffHunk": "@@ -0,0 +1,43 @@\n+package com.marklogic.hub.oneui.managers;\n+\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.marklogic.client.DatabaseClient;\n+import com.marklogic.client.MarkLogicServerException;\n+import com.marklogic.hub.HubConfig;\n+import com.marklogic.hub.dataservices.SavedQueriesService;\n+import com.marklogic.hub.oneui.exceptions.BadRequestException;\n+import com.marklogic.hub.oneui.exceptions.DataHubException;\n+\n+public class SavedQueriesManager {\n+\n+    private DatabaseClient finalDataServiceClient;\n+\n+    public SavedQueriesManager(HubConfig hubConfig) {\n+        finalDataServiceClient = hubConfig.newFinalClient();\n+    }\n+\n+    public JsonNode saveOrUpdateQueryDocument(JsonNode queryDocument) {\n+        if (queryDocument == null || queryDocument.get(\"savedQuery\") == null) {\n+            throw new BadRequestException(\"The request is empty or malformed\");\n+        }\n+\n+        if (queryDocument.get(\"savedQuery\").get(\"name\") == null || queryDocument.get(\"savedQuery\").get(\"name\").asText().isEmpty()) {\n+            throw new BadRequestException(\"Query name is missing\");\n+        }\n+\n+        if (queryDocument.get(\"savedQuery\").get(\"query\") == null || queryDocument.get(\"savedQuery\").get(\"query\").isEmpty()) {\n+            throw new BadRequestException(\"Query to be saved cannot be empty\");\n+        }\n+\n+        if (queryDocument.get(\"savedQuery\").get(\"propertiesToDisplay\") == null || queryDocument.get(\"savedQuery\")\n+                .get(\"propertiesToDisplay\").isEmpty()) {\n+            throw new BadRequestException(\"Entity type properties to be displayed cannot be empty\");\n+        }\n+\n+        try {\n+            return SavedQueriesService.on(finalDataServiceClient).saveSavedQuery(queryDocument);\n+        } catch (MarkLogicServerException mse) {\n+            throw new DataHubException(mse.getServerMessage(), mse);", "originalCommit": "0822bf6cd052cbc1a15e24826cc4e1dddd9b8d33", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTMwMjI0MA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3730#discussion_r395302240", "bodyText": "We don't want to autowire in Manager classes - just create one with the HubConfig in the test framework.", "author": "rjrudin", "createdAt": "2020-03-19T20:31:17Z", "path": "one-ui/src/test/java/com/marklogic/hub/oneui/managers/SavedQueriesManagerTest.java", "diffHunk": "@@ -0,0 +1,136 @@\n+package com.marklogic.hub.oneui.managers;\n+\n+import com.fasterxml.jackson.core.JsonProcessingException;\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.marklogic.hub.oneui.Application;\n+import com.marklogic.hub.oneui.TestHelper;\n+import com.marklogic.hub.oneui.exceptions.BadRequestException;\n+import org.junit.jupiter.api.*;\n+import org.junit.jupiter.api.extension.ExtendWith;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.boot.test.context.SpringBootTest;\n+import org.springframework.test.context.junit.jupiter.SpringExtension;\n+\n+@ExtendWith(SpringExtension.class)\n+@SpringBootTest(classes = {Application.class})\n+public class SavedQueriesManagerTest extends TestHelper {\n+\n+    @Autowired\n+    private SavedQueriesManager savedQueriesManager;", "originalCommit": "0822bf6cd052cbc1a15e24826cc4e1dddd9b8d33", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTMwMzE4NA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3730#discussion_r395303184", "bodyText": "I think all of this logic should be in the DS endpoint - this is all validation logic, and similar to artifacts, we want to enforce this in the DS, not in Java code.\nBy doing that, you don't even need this class - the controller can just interact directly with the SavedQueryService.\nAlso, @ryanjdew - this seems like a case in the future where we could use JSON schema to validate the incoming JSON so we don't have to write a lot of imperative code like this, right?", "author": "rjrudin", "createdAt": "2020-03-19T20:33:10Z", "path": "one-ui/src/main/java/com/marklogic/hub/oneui/managers/SavedQueriesManager.java", "diffHunk": "@@ -0,0 +1,43 @@\n+package com.marklogic.hub.oneui.managers;\n+\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.marklogic.client.DatabaseClient;\n+import com.marklogic.client.MarkLogicServerException;\n+import com.marklogic.hub.HubConfig;\n+import com.marklogic.hub.dataservices.SavedQueriesService;\n+import com.marklogic.hub.oneui.exceptions.BadRequestException;\n+import com.marklogic.hub.oneui.exceptions.DataHubException;\n+\n+public class SavedQueriesManager {\n+\n+    private DatabaseClient finalDataServiceClient;\n+\n+    public SavedQueriesManager(HubConfig hubConfig) {\n+        finalDataServiceClient = hubConfig.newFinalClient();\n+    }\n+\n+    public JsonNode saveOrUpdateQueryDocument(JsonNode queryDocument) {\n+        if (queryDocument == null || queryDocument.get(\"savedQuery\") == null) {", "originalCommit": "0822bf6cd052cbc1a15e24826cc4e1dddd9b8d33", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTMwMzg1OA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3730#discussion_r395303858", "bodyText": "For consistency, this should be \"savedQueryRequest\" with a \"d\"", "author": "rjrudin", "createdAt": "2020-03-19T20:34:35Z", "path": "one-ui/ui/api/swagger/mocks.json", "diffHunk": "@@ -3768,6 +3768,128 @@\n         \"x-swagger-router-controller\": \"facetValue\"\n       }\n     },\n+    \"/savedQueries\":{\n+      \"post\":{\n+        \"tags\":[\n+          \"Saved Queries\"\n+        ],\n+        \"summary\":\"Save user search query into database\",\n+        \"description\":\"....\",\n+        \"operationId\":\"saveQuery\",\n+        \"produces\":[\n+          \"application/json\"\n+        ],\n+        \"parameters\":[\n+          {\n+            \"in\":\"body\",\n+            \"name\":\"body\",\n+            \"required\":true,\n+            \"schema\":{\n+              \"$ref\":\"#/definitions/saveQueryRequest\"", "originalCommit": "0822bf6cd052cbc1a15e24826cc4e1dddd9b8d33", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTMwNDgwMA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3730#discussion_r395304800", "bodyText": "This test should also confirm the expected URI, permissions, and collections on the saved query.", "author": "rjrudin", "createdAt": "2020-03-19T20:36:23Z", "path": "marklogic-data-hub/src/test/ml-modules/root/test/suites/data-hub/5/data-services/savedQueries/saveSavedQueryTest.sjs", "diffHunk": "@@ -0,0 +1,82 @@\n+const test = require(\"/test/test-helper.xqy\");\n+\n+var saveQuery = JSON.stringify({\n+  \"savedQuery\": {\n+    \"id\": \"\",\n+    \"name\": \"some-query\",\n+    \"description\": \"some-query-description\",\n+    \"query\": {\n+      \"searchText\": \"some-string\",\n+      \"entityTypeIds\": [\n+        \"Entity1\"\n+      ],\n+      \"selectedFacets\": {\n+        \"Collection\": {\n+          \"dataType\": \"string\",\n+          \"stringValues\": [\n+            \"Entity1\",\n+            \"Collection1\"\n+          ]\n+        },\n+        \"facet1\": {\n+          \"dataType\": \"decimal\",\n+          \"rangeValues\": {\n+            \"lowerBound\": \"2.5\",\n+            \"upperBound\": \"15\"\n+          }\n+        },\n+        \"facet2\": {\n+          \"dataType\": \"dateTime\",\n+          \"rangeValues\": {\n+            \"lowerBound\": \"2020-01-01T13:06:17\",\n+            \"upperBound\": \"2020-01-22T13:06:17\"\n+          }\n+        }\n+      }\n+    },\n+    \"propertiesToDisplay\": [\"facet1\", \"EntityTypeProperty1\"]\n+  }\n+});\n+\n+function invokeService(saveQuery) {\n+  return fn.head(xdmp.invoke(\n+      \"/data-hub/5/data-services/savedQueries/saveSavedQuery.sjs\",\n+      {\n+        \"saveQuery\": saveQuery\n+      }\n+  ));\n+}\n+\n+\n+function testSaveNewQuery() {\n+  const result = invokeService(saveQuery);", "originalCommit": "0822bf6cd052cbc1a15e24826cc4e1dddd9b8d33", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjgxMjY5Mg==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3730#discussion_r396812692", "bodyText": "the complete js file is run as a single transaction. So cannot get the document until the transaction is committed. Added the tests in the java layer", "author": "rahulvudutala", "createdAt": "2020-03-23T23:13:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTMwNDgwMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTMwNTExNQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3730#discussion_r395305115", "bodyText": "Also include \"xdmp.defaultPermissions()\"", "author": "rjrudin", "createdAt": "2020-03-19T20:36:58Z", "path": "marklogic-data-hub/src/main/resources/ml-modules/root/data-hub/5/data-services/savedQueries/saveSavedQuery.sjs", "diffHunk": "@@ -0,0 +1,36 @@\n+'use strict';\n+declareUpdate();\n+\n+var saveQuery;\n+var userCollections = [\"http://marklogic.com/data-hub/saved-query\"];\n+var queryDocument = JSON.parse(saveQuery);\n+\n+try {\n+  if(queryDocument.savedQuery.id) {\n+    queryDocument.savedQuery.systemMetadata.lastUpdatedBy = xdmp.getCurrentUser();\n+    queryDocument.savedQuery.systemMetadata.lastUpdatedDateTime = fn.currentDateTime();\n+  } else {\n+    queryDocument.savedQuery.id = sem.uuidString();\n+    queryDocument.savedQuery.owner = xdmp.getCurrentUser();\n+    queryDocument.savedQuery.systemMetadata = {\n+      \"createdBy\": xdmp.getCurrentUser(),\n+      \"createdDateTime\": fn.currentDateTime(),\n+      \"lastUpdatedBy\": xdmp.getCurrentUser(),\n+      \"lastUpdatedDateTime\": fn.currentDateTime()\n+    }\n+  }\n+\n+  let docUri = \"/saved-queries/\"+queryDocument.savedQuery.id;\n+  let permissions = [xdmp.permission('data-hub-saved-query-reader', 'read'),", "originalCommit": "0822bf6cd052cbc1a15e24826cc4e1dddd9b8d33", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjgxMjI0Ng==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3730#discussion_r396812246", "bodyText": "Added it in the new commit", "author": "rahulvudutala", "createdAt": "2020-03-23T23:12:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTMwNTExNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTMwNTk5Mg==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3730#discussion_r395305992", "bodyText": "In the case of an update, we actually don't want to do a documentInsert. That's because a user may have adjusted the permissions/collections on the document. By doing a documentInsert, we instead have to be careful not to lose any such additional permissions/collections.\nInstead, do this:\nxdmp.nodeReplace(cts.doc(\"/saved-queries/\" + id + \".json\"), queryDocument);\n\nThat way, you only update the contents of the document, which is all you want to update here.", "author": "rjrudin", "createdAt": "2020-03-19T20:38:35Z", "path": "marklogic-data-hub/src/main/resources/ml-modules/root/data-hub/5/data-services/savedQueries/saveSavedQuery.sjs", "diffHunk": "@@ -0,0 +1,36 @@\n+'use strict';\n+declareUpdate();\n+\n+var saveQuery;\n+var userCollections = [\"http://marklogic.com/data-hub/saved-query\"];\n+var queryDocument = JSON.parse(saveQuery);\n+\n+try {\n+  if(queryDocument.savedQuery.id) {", "originalCommit": "0822bf6cd052cbc1a15e24826cc4e1dddd9b8d33", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTg5NDk0MA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3730#discussion_r395894940", "bodyText": "@rahulvudutala If need it, you can use this helper function in hubUtils: https://github.com/marklogic/marklogic-data-hub/blob/develop/marklogic-data-hub/src/main/resources/ml-modules/root/data-hub/5/impl/hub-utils.sjs#L67", "author": "ryanjdew", "createdAt": "2020-03-20T21:20:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTMwNTk5Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjgxMjMyNQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3730#discussion_r396812325", "bodyText": "Added xdmp.nodeReplace", "author": "rahulvudutala", "createdAt": "2020-03-23T23:12:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTMwNTk5Mg=="}], "type": "inlineReview"}, {"oid": "1617720c2effe03bd5e91760b644aa15a34f9aea", "url": "https://github.com/marklogic/marklogic-data-hub/commit/1617720c2effe03bd5e91760b644aa15a34f9aea", "message": "DHFPROD-3647: Save personal search query and its associated filters\n\nDHFPROD-3647: Adding reader and writer roles for saved query documents\n\nDHFPROD-3647: Save Query dataservice modules\n\nDHFPROD-3647: Optimizing code", "committedDate": "2020-03-23T07:35:49Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjgyMTYyNA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3730#discussion_r396821624", "bodyText": "I don't think this is necessary. I think you just need to say that if /saved-queries/id.json exists already, then nodeReplace it, else documentInsert it.", "author": "rjrudin", "createdAt": "2020-03-23T23:33:43Z", "path": "marklogic-data-hub/src/main/resources/ml-modules/root/data-hub/5/data-services/savedQueries/saveSavedQuery.sjs", "diffHunk": "@@ -0,0 +1,56 @@\n+'use strict';\n+declareUpdate();\n+\n+var saveQuery;\n+var userCollections = [\"http://marklogic.com/data-hub/saved-query\"];\n+var queryDocument = JSON.parse(saveQuery);\n+\n+if (queryDocument == null || queryDocument.savedQuery == null) {\n+    throw Error(\"The request is empty or malformed\");\n+}\n+\n+if (queryDocument.savedQuery.name == null || !queryDocument.savedQuery.name) {\n+    throw Error(\"Query name is missing\");\n+}\n+\n+if (queryDocument.savedQuery.query == null || Object.keys(queryDocument.savedQuery.query) == 0) {\n+    throw Error(\"Query to be saved cannot be empty\");\n+}\n+\n+if (queryDocument.savedQuery.propertiesToDisplay == null || queryDocument.savedQuery.propertiesToDisplay.length == 0) {\n+    throw Error(\"Entity type properties to be displayed cannot be empty\");\n+}\n+\n+let id = queryDocument.savedQuery.id;\n+\n+if(id) {\n+    if(cts.doc(\"/saved-queries/\"+id+\".json\")) {\n+        queryDocument.savedQuery.systemMetadata.lastUpdatedBy = xdmp.getCurrentUser();\n+        queryDocument.savedQuery.systemMetadata.lastUpdatedDateTime = fn.currentDateTime();\n+        xdmp.nodeReplace(cts.doc(\"/saved-queries/\" + id+\".json\"), queryDocument);\n+    } else {\n+        throw Error(\"The requested resource with \" + id + \" is not found\")", "originalCommit": "1617720c2effe03bd5e91760b644aa15a34f9aea", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzMwMTE4MA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3730#discussion_r397301180", "bodyText": "Address in the new commit", "author": "rahulvudutala", "createdAt": "2020-03-24T16:42:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjgyMTYyNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjgyMjA3OQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3730#discussion_r396822079", "bodyText": "There's no need for a separate test here. Just add these assertions to the first test for creating a saved query here.", "author": "rjrudin", "createdAt": "2020-03-23T23:35:07Z", "path": "one-ui/src/test/java/com/marklogic/hub/oneui/controllers/SavedQueriesControllerTest.java", "diffHunk": "@@ -0,0 +1,215 @@\n+package com.marklogic.hub.oneui.controllers;\n+\n+import com.fasterxml.jackson.core.JsonProcessingException;\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.marklogic.client.FailedRequestException;\n+import com.marklogic.client.document.GenericDocumentManager;\n+import com.marklogic.client.io.DocumentMetadataHandle;\n+import com.marklogic.hub.DatabaseKind;\n+import com.marklogic.hub.oneui.Application;\n+import com.marklogic.hub.oneui.TestHelper;\n+import org.junit.jupiter.api.Assertions;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.extension.ExtendWith;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.boot.test.context.SpringBootTest;\n+import org.springframework.http.ResponseEntity;\n+import org.springframework.test.context.junit.jupiter.SpringExtension;\n+\n+import java.util.Arrays;\n+import java.util.HashSet;\n+import java.util.Set;\n+\n+@ExtendWith(SpringExtension.class)\n+@SpringBootTest(classes = {Application.class})\n+public class SavedQueriesControllerTest extends TestHelper {\n+\n+    private static JsonNode queryDoc;\n+\n+    @Autowired\n+    private SavedQueriesController savedQueriesController;\n+\n+    @BeforeEach\n+    void before() throws JsonProcessingException {\n+        authenticateSession();\n+        String jsonString = \"{\\n\" +\n+                \"  \\\"savedQuery\\\": {\\n\" +\n+                \"    \\\"id\\\": \\\"\\\",\\n\" +\n+                \"    \\\"name\\\": \\\"some-query\\\",\\n\" +\n+                \"    \\\"description\\\": \\\"some-query-description\\\",\\n\" +\n+                \"    \\\"query\\\": {\\n\" +\n+                \"      \\\"searchText\\\": \\\"some-string\\\",\\n\" +\n+                \"      \\\"entityTypeIds\\\": [\\n\" +\n+                \"        \\\"Entity1\\\"\\n\" +\n+                \"      ],\\n\" +\n+                \"      \\\"selectedFacets\\\": {\\n\" +\n+                \"        \\\"Collection\\\": {\\n\" +\n+                \"          \\\"dataType\\\": \\\"string\\\",\\n\" +\n+                \"          \\\"stringValues\\\": [\\n\" +\n+                \"            \\\"Entity1\\\",\\n\" +\n+                \"            \\\"Collection1\\\"\\n\" +\n+                \"          ]\\n\" +\n+                \"        },\\n\" +\n+                \"        \\\"facet1\\\": {\\n\" +\n+                \"          \\\"dataType\\\": \\\"decimal\\\",\\n\" +\n+                \"          \\\"rangeValues\\\": {\\n\" +\n+                \"            \\\"lowerBound\\\": \\\"2.5\\\",\\n\" +\n+                \"            \\\"upperBound\\\": \\\"15\\\"\\n\" +\n+                \"          }\\n\" +\n+                \"        },\\n\" +\n+                \"        \\\"facet2\\\": {\\n\" +\n+                \"          \\\"dataType\\\": \\\"dateTime\\\",\\n\" +\n+                \"          \\\"rangeValues\\\": {\\n\" +\n+                \"            \\\"lowerBound\\\": \\\"2020-01-01T13:06:17\\\",\\n\" +\n+                \"            \\\"upperBound\\\": \\\"2020-01-22T13:06:17\\\"\\n\" +\n+                \"          }\\n\" +\n+                \"        }\\n\" +\n+                \"      }\\n\" +\n+                \"    },\\n\" +\n+                \"    \\\"propertiesToDisplay\\\": [\\\"facet1\\\", \\\"EntityTypeProperty1\\\"]\\n\" +\n+                \"  }\\n\" +\n+                \"}\";\n+        ObjectMapper mapper = new ObjectMapper();\n+        queryDoc = mapper.readTree(jsonString);\n+    }\n+\n+    @Test\n+    void testSaveNewQuery() {\n+        ResponseEntity<JsonNode> response = savedQueriesController.saveQueryDocument(queryDoc);\n+        JsonNode responseBody = response.getBody();\n+\n+        Assertions.assertEquals(201, response.getStatusCodeValue());\n+        Assertions.assertNotNull(responseBody);\n+        Assertions.assertNotNull(responseBody.get(\"savedQuery\"));\n+        Assertions.assertNotNull(responseBody.get(\"savedQuery\").get(\"id\"));\n+        Assertions.assertNotNull(responseBody.get(\"savedQuery\").get(\"systemMetadata\"));\n+        Assertions.assertEquals(\"some-query\", responseBody.get(\"savedQuery\").get(\"name\").asText());\n+        Assertions.assertEquals(4, responseBody.get(\"savedQuery\").get(\"systemMetadata\").size());\n+        Assertions.assertEquals(\"test-data-hub-developer\", responseBody.get(\"savedQuery\").get(\"owner\").asText());\n+        Assertions.assertEquals(\"test-data-hub-developer\", responseBody.get(\"savedQuery\").get(\"systemMetadata\").get(\"createdBy\").asText());\n+    }\n+\n+    @Test\n+    void testModifyExistingQuery() {\n+        JsonNode firstResponse = savedQueriesController.saveQueryDocument(queryDoc).getBody();\n+        ObjectNode savedQueryNode = (ObjectNode) firstResponse.get(\"savedQuery\");\n+        String id = savedQueryNode.get(\"id\").asText();\n+        savedQueryNode.put(\"name\", \"modified-name\");\n+        ResponseEntity<JsonNode> modifiedResponse = savedQueriesController.updateQueryDocument(firstResponse);\n+        JsonNode modifiedResponseBody = modifiedResponse.getBody();\n+\n+        Assertions.assertEquals(200, modifiedResponse.getStatusCodeValue());\n+        Assertions.assertNotNull(modifiedResponseBody);\n+        Assertions.assertEquals(id, modifiedResponseBody.get(\"savedQuery\").get(\"id\").asText());\n+        Assertions.assertEquals(\"test-data-hub-developer\", modifiedResponseBody.get(\"savedQuery\").get(\"owner\").asText());\n+        Assertions.assertEquals(\"modified-name\", modifiedResponseBody.get(\"savedQuery\").get(\"name\").asText());\n+    }\n+\n+    @Test\n+    void testCollectionsAndPermissionOnSavedQuery() {\n+        JsonNode response = savedQueriesController.saveQueryDocument(queryDoc).getBody();", "originalCommit": "1617720c2effe03bd5e91760b644aa15a34f9aea", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjgyMjI0MQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3730#discussion_r396822241", "bodyText": "Same thing, just add these assertions to the test for modifying a query.\nReally, you can cover both things - creating a query and modifying it - in the same test.", "author": "rjrudin", "createdAt": "2020-03-23T23:35:36Z", "path": "one-ui/src/test/java/com/marklogic/hub/oneui/controllers/SavedQueriesControllerTest.java", "diffHunk": "@@ -0,0 +1,215 @@\n+package com.marklogic.hub.oneui.controllers;\n+\n+import com.fasterxml.jackson.core.JsonProcessingException;\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.marklogic.client.FailedRequestException;\n+import com.marklogic.client.document.GenericDocumentManager;\n+import com.marklogic.client.io.DocumentMetadataHandle;\n+import com.marklogic.hub.DatabaseKind;\n+import com.marklogic.hub.oneui.Application;\n+import com.marklogic.hub.oneui.TestHelper;\n+import org.junit.jupiter.api.Assertions;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.extension.ExtendWith;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.boot.test.context.SpringBootTest;\n+import org.springframework.http.ResponseEntity;\n+import org.springframework.test.context.junit.jupiter.SpringExtension;\n+\n+import java.util.Arrays;\n+import java.util.HashSet;\n+import java.util.Set;\n+\n+@ExtendWith(SpringExtension.class)\n+@SpringBootTest(classes = {Application.class})\n+public class SavedQueriesControllerTest extends TestHelper {\n+\n+    private static JsonNode queryDoc;\n+\n+    @Autowired\n+    private SavedQueriesController savedQueriesController;\n+\n+    @BeforeEach\n+    void before() throws JsonProcessingException {\n+        authenticateSession();\n+        String jsonString = \"{\\n\" +\n+                \"  \\\"savedQuery\\\": {\\n\" +\n+                \"    \\\"id\\\": \\\"\\\",\\n\" +\n+                \"    \\\"name\\\": \\\"some-query\\\",\\n\" +\n+                \"    \\\"description\\\": \\\"some-query-description\\\",\\n\" +\n+                \"    \\\"query\\\": {\\n\" +\n+                \"      \\\"searchText\\\": \\\"some-string\\\",\\n\" +\n+                \"      \\\"entityTypeIds\\\": [\\n\" +\n+                \"        \\\"Entity1\\\"\\n\" +\n+                \"      ],\\n\" +\n+                \"      \\\"selectedFacets\\\": {\\n\" +\n+                \"        \\\"Collection\\\": {\\n\" +\n+                \"          \\\"dataType\\\": \\\"string\\\",\\n\" +\n+                \"          \\\"stringValues\\\": [\\n\" +\n+                \"            \\\"Entity1\\\",\\n\" +\n+                \"            \\\"Collection1\\\"\\n\" +\n+                \"          ]\\n\" +\n+                \"        },\\n\" +\n+                \"        \\\"facet1\\\": {\\n\" +\n+                \"          \\\"dataType\\\": \\\"decimal\\\",\\n\" +\n+                \"          \\\"rangeValues\\\": {\\n\" +\n+                \"            \\\"lowerBound\\\": \\\"2.5\\\",\\n\" +\n+                \"            \\\"upperBound\\\": \\\"15\\\"\\n\" +\n+                \"          }\\n\" +\n+                \"        },\\n\" +\n+                \"        \\\"facet2\\\": {\\n\" +\n+                \"          \\\"dataType\\\": \\\"dateTime\\\",\\n\" +\n+                \"          \\\"rangeValues\\\": {\\n\" +\n+                \"            \\\"lowerBound\\\": \\\"2020-01-01T13:06:17\\\",\\n\" +\n+                \"            \\\"upperBound\\\": \\\"2020-01-22T13:06:17\\\"\\n\" +\n+                \"          }\\n\" +\n+                \"        }\\n\" +\n+                \"      }\\n\" +\n+                \"    },\\n\" +\n+                \"    \\\"propertiesToDisplay\\\": [\\\"facet1\\\", \\\"EntityTypeProperty1\\\"]\\n\" +\n+                \"  }\\n\" +\n+                \"}\";\n+        ObjectMapper mapper = new ObjectMapper();\n+        queryDoc = mapper.readTree(jsonString);\n+    }\n+\n+    @Test\n+    void testSaveNewQuery() {\n+        ResponseEntity<JsonNode> response = savedQueriesController.saveQueryDocument(queryDoc);\n+        JsonNode responseBody = response.getBody();\n+\n+        Assertions.assertEquals(201, response.getStatusCodeValue());\n+        Assertions.assertNotNull(responseBody);\n+        Assertions.assertNotNull(responseBody.get(\"savedQuery\"));\n+        Assertions.assertNotNull(responseBody.get(\"savedQuery\").get(\"id\"));\n+        Assertions.assertNotNull(responseBody.get(\"savedQuery\").get(\"systemMetadata\"));\n+        Assertions.assertEquals(\"some-query\", responseBody.get(\"savedQuery\").get(\"name\").asText());\n+        Assertions.assertEquals(4, responseBody.get(\"savedQuery\").get(\"systemMetadata\").size());\n+        Assertions.assertEquals(\"test-data-hub-developer\", responseBody.get(\"savedQuery\").get(\"owner\").asText());\n+        Assertions.assertEquals(\"test-data-hub-developer\", responseBody.get(\"savedQuery\").get(\"systemMetadata\").get(\"createdBy\").asText());\n+    }\n+\n+    @Test\n+    void testModifyExistingQuery() {\n+        JsonNode firstResponse = savedQueriesController.saveQueryDocument(queryDoc).getBody();\n+        ObjectNode savedQueryNode = (ObjectNode) firstResponse.get(\"savedQuery\");\n+        String id = savedQueryNode.get(\"id\").asText();\n+        savedQueryNode.put(\"name\", \"modified-name\");\n+        ResponseEntity<JsonNode> modifiedResponse = savedQueriesController.updateQueryDocument(firstResponse);\n+        JsonNode modifiedResponseBody = modifiedResponse.getBody();\n+\n+        Assertions.assertEquals(200, modifiedResponse.getStatusCodeValue());\n+        Assertions.assertNotNull(modifiedResponseBody);\n+        Assertions.assertEquals(id, modifiedResponseBody.get(\"savedQuery\").get(\"id\").asText());\n+        Assertions.assertEquals(\"test-data-hub-developer\", modifiedResponseBody.get(\"savedQuery\").get(\"owner\").asText());\n+        Assertions.assertEquals(\"modified-name\", modifiedResponseBody.get(\"savedQuery\").get(\"name\").asText());\n+    }\n+\n+    @Test\n+    void testCollectionsAndPermissionOnSavedQuery() {\n+        JsonNode response = savedQueriesController.saveQueryDocument(queryDoc).getBody();\n+        String docUri = \"/saved-queries/\" + response.get(\"savedQuery\").get(\"id\").asText() + \".json\";\n+\n+        DocumentMetadataHandle metadataHandle = new DocumentMetadataHandle();\n+        GenericDocumentManager docMgr = getFinalGenericDocumentManager(DatabaseKind.FINAL);\n+        docMgr.readMetadata(docUri, metadataHandle);\n+        DocumentMetadataHandle.DocumentPermissions permissions = metadataHandle.getPermissions();\n+        DocumentMetadataHandle.DocumentCollections collections = metadataHandle.getCollections();\n+        Set<DocumentMetadataHandle.Capability> readQueryCap = new HashSet<>(Arrays.asList(DocumentMetadataHandle.Capability.READ));\n+        Set<DocumentMetadataHandle.Capability> writeQueryCap = new HashSet<>(Arrays.asList(DocumentMetadataHandle.Capability.UPDATE));\n+        Set<String> expectedCollections = new HashSet<>(Arrays.asList(\"http://marklogic.com/data-hub/saved-query\"));\n+\n+        Assertions.assertNotNull(permissions.get(\"data-hub-saved-query-writer\"));\n+        Assertions.assertNotNull(permissions.get(\"data-hub-saved-query-reader\"));\n+        Assertions.assertTrue(readQueryCap.equals(permissions.get(\"data-hub-saved-query-reader\")));\n+        Assertions.assertTrue(writeQueryCap.equals(permissions.get(\"data-hub-saved-query-writer\")));\n+        Assertions.assertTrue(expectedCollections.equals(collections));\n+    }\n+\n+    @Test\n+    void testCollectionsAndPermissionOnModifiedQuery() {\n+        JsonNode firstResponse = savedQueriesController.saveQueryDocument(queryDoc).getBody();", "originalCommit": "1617720c2effe03bd5e91760b644aa15a34f9aea", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjgyMzgyNA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3730#discussion_r396823824", "bodyText": "I emailed Ryan and Srikanth about this - I'd rather see all these tests against the data service and thus the tests should be in the core project, not in one-ui. The core project is its own thing, and we want to verify its functionality within the core project. We don't want to depend on a UI project to verify it.\nAdditionally, I don't think testing the controller proves much of anything, since the controller only needs to construct the appropriate DatabaseClient.\nNo action yet on this, waiting to hear back from Ryan and Srikanth.", "author": "rjrudin", "createdAt": "2020-03-23T23:40:39Z", "path": "one-ui/src/test/java/com/marklogic/hub/oneui/controllers/SavedQueriesControllerTest.java", "diffHunk": "@@ -0,0 +1,215 @@\n+package com.marklogic.hub.oneui.controllers;\n+\n+import com.fasterxml.jackson.core.JsonProcessingException;\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.marklogic.client.FailedRequestException;\n+import com.marklogic.client.document.GenericDocumentManager;\n+import com.marklogic.client.io.DocumentMetadataHandle;\n+import com.marklogic.hub.DatabaseKind;\n+import com.marklogic.hub.oneui.Application;\n+import com.marklogic.hub.oneui.TestHelper;\n+import org.junit.jupiter.api.Assertions;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.extension.ExtendWith;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.boot.test.context.SpringBootTest;\n+import org.springframework.http.ResponseEntity;\n+import org.springframework.test.context.junit.jupiter.SpringExtension;\n+\n+import java.util.Arrays;\n+import java.util.HashSet;\n+import java.util.Set;\n+\n+@ExtendWith(SpringExtension.class)\n+@SpringBootTest(classes = {Application.class})\n+public class SavedQueriesControllerTest extends TestHelper {", "originalCommit": "1617720c2effe03bd5e91760b644aa15a34f9aea", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "893ed27018261703116b1e50a24e05693dc4117b", "url": "https://github.com/marklogic/marklogic-data-hub/commit/893ed27018261703116b1e50a24e05693dc4117b", "message": "DHFPROD-3647: Save personal search query and its associated filters\n\nDHFPROD-3647: Adding reader and writer roles for saved query documents\n\nDHFPROD-3647: Save Query dataservice modules\n\nDHFPROD-3647: Optimizing code\n\nDHFPROD-3647: Addressing code request changes and refactoring tests", "committedDate": "2020-03-24T16:38:52Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzM2NjQ2Nw==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3730#discussion_r397366467", "bodyText": "I really recommend combining these assertions with the first test. The setup of the test is identical - you're saving a single saved query. You then want to assert on the contents of the persisted document, along with its URI and collections/permissions. There's no reason to do that in two separate tests, it just makes our test suite take a little longer to finish.", "author": "rjrudin", "createdAt": "2020-03-24T18:18:01Z", "path": "marklogic-data-hub/src/test/java/com/marklogic/hub/dataservices/savedQueries/SavedQueriesServiceTest.java", "diffHunk": "@@ -0,0 +1,192 @@\n+package com.marklogic.hub.dataservices.savedQueries;\n+\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.marklogic.client.FailedRequestException;\n+import com.marklogic.client.io.DocumentMetadataHandle;\n+import com.marklogic.hub.ApplicationConfig;\n+import com.marklogic.hub.HubTestBase;\n+import com.marklogic.hub.dataservices.SavedQueriesService;\n+import org.junit.jupiter.api.Assertions;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.TestInstance;\n+import org.junit.jupiter.api.extension.ExtendWith;\n+import org.springframework.test.context.ContextConfiguration;\n+import org.springframework.test.context.junit.jupiter.SpringExtension;\n+\n+import java.io.IOException;\n+import java.util.Arrays;\n+import java.util.HashSet;\n+import java.util.Set;\n+\n+@ExtendWith(SpringExtension.class)\n+@ContextConfiguration(classes = ApplicationConfig.class)\n+@TestInstance(TestInstance.Lifecycle.PER_CLASS)\n+public class SavedQueriesServiceTest extends HubTestBase {\n+\n+    private static JsonNode queryDoc;\n+    private SavedQueriesService savedQueriesService;\n+\n+    @BeforeAll\n+    void createSavedQueriesServiceInstance() {\n+        this.savedQueriesService = SavedQueriesService.on(adminHubConfig.newFinalClient(null));\n+    }\n+\n+    @BeforeEach\n+    void before() throws IOException {\n+        String jsonString = \"{\\n\" +\n+                \"  \\\"savedQuery\\\": {\\n\" +\n+                \"    \\\"id\\\": \\\"\\\",\\n\" +\n+                \"    \\\"name\\\": \\\"some-query\\\",\\n\" +\n+                \"    \\\"description\\\": \\\"some-query-description\\\",\\n\" +\n+                \"    \\\"query\\\": {\\n\" +\n+                \"      \\\"searchText\\\": \\\"some-string\\\",\\n\" +\n+                \"      \\\"entityTypeIds\\\": [\\n\" +\n+                \"        \\\"Entity1\\\"\\n\" +\n+                \"      ],\\n\" +\n+                \"      \\\"selectedFacets\\\": {\\n\" +\n+                \"        \\\"Collection\\\": {\\n\" +\n+                \"          \\\"dataType\\\": \\\"string\\\",\\n\" +\n+                \"          \\\"stringValues\\\": [\\n\" +\n+                \"            \\\"Entity1\\\",\\n\" +\n+                \"            \\\"Collection1\\\"\\n\" +\n+                \"          ]\\n\" +\n+                \"        },\\n\" +\n+                \"        \\\"facet1\\\": {\\n\" +\n+                \"          \\\"dataType\\\": \\\"decimal\\\",\\n\" +\n+                \"          \\\"rangeValues\\\": {\\n\" +\n+                \"            \\\"lowerBound\\\": \\\"2.5\\\",\\n\" +\n+                \"            \\\"upperBound\\\": \\\"15\\\"\\n\" +\n+                \"          }\\n\" +\n+                \"        },\\n\" +\n+                \"        \\\"facet2\\\": {\\n\" +\n+                \"          \\\"dataType\\\": \\\"dateTime\\\",\\n\" +\n+                \"          \\\"rangeValues\\\": {\\n\" +\n+                \"            \\\"lowerBound\\\": \\\"2020-01-01T13:06:17\\\",\\n\" +\n+                \"            \\\"upperBound\\\": \\\"2020-01-22T13:06:17\\\"\\n\" +\n+                \"          }\\n\" +\n+                \"        }\\n\" +\n+                \"      }\\n\" +\n+                \"    },\\n\" +\n+                \"    \\\"propertiesToDisplay\\\": [\\\"facet1\\\", \\\"EntityTypeProperty1\\\"]\\n\" +\n+                \"  }\\n\" +\n+                \"}\";\n+        ObjectMapper mapper = new ObjectMapper();\n+        queryDoc = mapper.readTree(jsonString);\n+    }\n+\n+    @Test\n+    void testSaveAndModifyQuery() {\n+        JsonNode firstResponse = savedQueriesService.saveSavedQuery(queryDoc);\n+\n+        Assertions.assertNotNull(firstResponse);\n+        Assertions.assertNotNull(firstResponse.get(\"savedQuery\"));\n+        Assertions.assertNotNull(firstResponse.get(\"savedQuery\").get(\"id\"));\n+        Assertions.assertNotNull(firstResponse.get(\"savedQuery\").get(\"systemMetadata\"));\n+        Assertions.assertEquals(\"some-query\", firstResponse.get(\"savedQuery\").get(\"name\").asText());\n+        Assertions.assertEquals(4, firstResponse.get(\"savedQuery\").get(\"systemMetadata\").size());\n+        Assertions.assertEquals(\"flow-developer\", firstResponse.get(\"savedQuery\").get(\"owner\").asText());\n+        Assertions.assertEquals(\"flow-developer\", firstResponse.get(\"savedQuery\").get(\"systemMetadata\").get(\"createdBy\").asText());\n+\n+        ObjectNode savedQueryNode = (ObjectNode) firstResponse.get(\"savedQuery\");\n+        String id = savedQueryNode.get(\"id\").asText();\n+        savedQueryNode.put(\"name\", \"modified-name\");\n+        JsonNode modifiedResponse = savedQueriesService.saveSavedQuery(firstResponse);\n+\n+        Assertions.assertNotNull(modifiedResponse);\n+        Assertions.assertEquals(id, modifiedResponse.get(\"savedQuery\").get(\"id\").asText());\n+        Assertions.assertEquals(\"flow-developer\", modifiedResponse.get(\"savedQuery\").get(\"owner\").asText());\n+        Assertions.assertEquals(\"modified-name\", modifiedResponse.get(\"savedQuery\").get(\"name\").asText());\n+    }\n+\n+    @Test\n+    void testCollectionsAndPermissionOnSavedAndModifiedQuery() {\n+        JsonNode firstResponse = savedQueriesService.saveSavedQuery(queryDoc);", "originalCommit": "893ed27018261703116b1e50a24e05693dc4117b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzM2NzEwOA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3730#discussion_r397367108", "bodyText": "I recommend adding this so that this reads a bit easier; it's also consistent with most of our existing tests (unfortunately not all of them):\nimport static org.junit.jupiter.api.Assertions.*;", "author": "rjrudin", "createdAt": "2020-03-24T18:19:03Z", "path": "marklogic-data-hub/src/test/java/com/marklogic/hub/dataservices/savedQueries/SavedQueriesServiceTest.java", "diffHunk": "@@ -0,0 +1,192 @@\n+package com.marklogic.hub.dataservices.savedQueries;\n+\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.marklogic.client.FailedRequestException;\n+import com.marklogic.client.io.DocumentMetadataHandle;\n+import com.marklogic.hub.ApplicationConfig;\n+import com.marklogic.hub.HubTestBase;\n+import com.marklogic.hub.dataservices.SavedQueriesService;\n+import org.junit.jupiter.api.Assertions;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.TestInstance;\n+import org.junit.jupiter.api.extension.ExtendWith;\n+import org.springframework.test.context.ContextConfiguration;\n+import org.springframework.test.context.junit.jupiter.SpringExtension;\n+\n+import java.io.IOException;\n+import java.util.Arrays;\n+import java.util.HashSet;\n+import java.util.Set;\n+\n+@ExtendWith(SpringExtension.class)\n+@ContextConfiguration(classes = ApplicationConfig.class)\n+@TestInstance(TestInstance.Lifecycle.PER_CLASS)\n+public class SavedQueriesServiceTest extends HubTestBase {\n+\n+    private static JsonNode queryDoc;\n+    private SavedQueriesService savedQueriesService;\n+\n+    @BeforeAll\n+    void createSavedQueriesServiceInstance() {\n+        this.savedQueriesService = SavedQueriesService.on(adminHubConfig.newFinalClient(null));\n+    }\n+\n+    @BeforeEach\n+    void before() throws IOException {\n+        String jsonString = \"{\\n\" +\n+                \"  \\\"savedQuery\\\": {\\n\" +\n+                \"    \\\"id\\\": \\\"\\\",\\n\" +\n+                \"    \\\"name\\\": \\\"some-query\\\",\\n\" +\n+                \"    \\\"description\\\": \\\"some-query-description\\\",\\n\" +\n+                \"    \\\"query\\\": {\\n\" +\n+                \"      \\\"searchText\\\": \\\"some-string\\\",\\n\" +\n+                \"      \\\"entityTypeIds\\\": [\\n\" +\n+                \"        \\\"Entity1\\\"\\n\" +\n+                \"      ],\\n\" +\n+                \"      \\\"selectedFacets\\\": {\\n\" +\n+                \"        \\\"Collection\\\": {\\n\" +\n+                \"          \\\"dataType\\\": \\\"string\\\",\\n\" +\n+                \"          \\\"stringValues\\\": [\\n\" +\n+                \"            \\\"Entity1\\\",\\n\" +\n+                \"            \\\"Collection1\\\"\\n\" +\n+                \"          ]\\n\" +\n+                \"        },\\n\" +\n+                \"        \\\"facet1\\\": {\\n\" +\n+                \"          \\\"dataType\\\": \\\"decimal\\\",\\n\" +\n+                \"          \\\"rangeValues\\\": {\\n\" +\n+                \"            \\\"lowerBound\\\": \\\"2.5\\\",\\n\" +\n+                \"            \\\"upperBound\\\": \\\"15\\\"\\n\" +\n+                \"          }\\n\" +\n+                \"        },\\n\" +\n+                \"        \\\"facet2\\\": {\\n\" +\n+                \"          \\\"dataType\\\": \\\"dateTime\\\",\\n\" +\n+                \"          \\\"rangeValues\\\": {\\n\" +\n+                \"            \\\"lowerBound\\\": \\\"2020-01-01T13:06:17\\\",\\n\" +\n+                \"            \\\"upperBound\\\": \\\"2020-01-22T13:06:17\\\"\\n\" +\n+                \"          }\\n\" +\n+                \"        }\\n\" +\n+                \"      }\\n\" +\n+                \"    },\\n\" +\n+                \"    \\\"propertiesToDisplay\\\": [\\\"facet1\\\", \\\"EntityTypeProperty1\\\"]\\n\" +\n+                \"  }\\n\" +\n+                \"}\";\n+        ObjectMapper mapper = new ObjectMapper();\n+        queryDoc = mapper.readTree(jsonString);\n+    }\n+\n+    @Test\n+    void testSaveAndModifyQuery() {\n+        JsonNode firstResponse = savedQueriesService.saveSavedQuery(queryDoc);\n+\n+        Assertions.assertNotNull(firstResponse);", "originalCommit": "893ed27018261703116b1e50a24e05693dc4117b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "760521a37d561f8d9d4b9b3e580c38b2b4f5b986", "url": "https://github.com/marklogic/marklogic-data-hub/commit/760521a37d561f8d9d4b9b3e580c38b2b4f5b986", "message": "DHFPROD-3647: Save personal search query and its associated filters\n\nDHFPROD-3647: Adding reader and writer roles for saved query documents\n\nDHFPROD-3647: Save Query dataservice modules\n\nDHFPROD-3647: Optimizing code\n\nDHFPROD-3647: Addressing code request changes and refactoring tests", "committedDate": "2020-03-24T20:00:16Z", "type": "commit"}, {"oid": "760521a37d561f8d9d4b9b3e580c38b2b4f5b986", "url": "https://github.com/marklogic/marklogic-data-hub/commit/760521a37d561f8d9d4b9b3e580c38b2b4f5b986", "message": "DHFPROD-3647: Save personal search query and its associated filters\n\nDHFPROD-3647: Adding reader and writer roles for saved query documents\n\nDHFPROD-3647: Save Query dataservice modules\n\nDHFPROD-3647: Optimizing code\n\nDHFPROD-3647: Addressing code request changes and refactoring tests", "committedDate": "2020-03-24T20:00:16Z", "type": "forcePushed"}]}