{"pr_number": 3830, "pr_title": "DHFPROD-3650: Delete saved personal queries feature", "pr_createdAt": "2020-04-16T22:23:02Z", "pr_url": "https://github.com/marklogic/marklogic-data-hub/pull/3830", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTkyMzc0MA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3830#discussion_r409923740", "bodyText": "I'm of the opinion that it's perfectly fine just to toss the test of deletion onto an existing test method, like the existing createThenUpdate test. Fewer test methods means less time setting up tests, which means our test suite is faster.", "author": "rjrudin", "createdAt": "2020-04-17T00:26:24Z", "path": "marklogic-data-hub-central/src/test/java/com/marklogic/hub/central/controllers/EntitySearchControllerTest.java", "diffHunk": "@@ -110,4 +110,38 @@ void getSavedQuery() throws Exception {\n                     assertEquals(savedQueryResponse.get(\"savedQuery\").get(\"id\").asText(), response.get(\"savedQuery\").get(\"id\").asText());\n                 });\n     }\n+\n+    @Test\n+    void deleteSavedQuery() throws Exception {", "originalCommit": "8f176af8a985cc27278a98c02b48095dc128b877", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTkyNDgwNA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3830#discussion_r409924804", "bodyText": "For deleting a document, since we know what the URI should be, just do:\nif (cts.exists(cts.documentQuery(uri)) then delete the uri\n\nWe only want to use cts.search when we want the document back.", "author": "rjrudin", "createdAt": "2020-04-17T00:29:52Z", "path": "marklogic-data-hub/src/main/resources/ml-modules/root/data-hub/5/data-services/entitySearch/deleteSavedQuery.sjs", "diffHunk": "@@ -0,0 +1,12 @@\n+'use strict';\n+declareUpdate();\n+\n+var id;\n+\n+let savedQuery = cts.search(cts.andQuery([cts.collectionQuery(\"http://marklogic.com/data-hub/saved-query\"),", "originalCommit": "8f176af8a985cc27278a98c02b48095dc128b877", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTk1MDM3NA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3830#discussion_r409950374", "bodyText": "Since only the user who saved the query should be able to delete the query, I am adding the following query:\ncts.exists(cts.andQuery([cts.documentQuery(docUri), cts.jsonPropertyValueQuery(\"owner\", xdmp.getCurrentUser())]))", "author": "rahulvudutala", "createdAt": "2020-04-17T02:05:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTkyNDgwNA=="}], "type": "inlineReview"}, {"oid": "af7024da2af0e2cc9389b1e22b4d0c71c806da18", "url": "https://github.com/marklogic/marklogic-data-hub/commit/af7024da2af0e2cc9389b1e22b4d0c71c806da18", "message": "DHFPROD-3650: Delete saved personal queries", "committedDate": "2020-04-17T02:32:21Z", "type": "commit"}, {"oid": "d3e2e34607c2cca813187f3b822215ea73449138", "url": "https://github.com/marklogic/marklogic-data-hub/commit/d3e2e34607c2cca813187f3b822215ea73449138", "message": "DHFPROD-3650: Refactoring Search API to match with SavedQueries feature", "committedDate": "2020-04-17T02:32:37Z", "type": "commit"}, {"oid": "d3e2e34607c2cca813187f3b822215ea73449138", "url": "https://github.com/marklogic/marklogic-data-hub/commit/d3e2e34607c2cca813187f3b822215ea73449138", "message": "DHFPROD-3650: Refactoring Search API to match with SavedQueries feature", "committedDate": "2020-04-17T02:32:37Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDE1NTgxNg==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3830#discussion_r410155816", "bodyText": "Pinging @ryanjdew on this - I am wondering what is needed for security here. Just occurred to me that we presumably at least need a check on the owner of the saved query being the same as the MarkLogic user that's connecting, right? Otherwise one user could delete anyone's saved query.\n@rahulvudutala Is there a role required for creating/deleting saved queries? If so, I believe we want an xdmp.securityAssert check here. I defer to @ryanjdew on whether we want to start requiring this now or wait a couple more stories, as @ryanjdew is getting a policy into place where we secure all of our DS endpoints with an xdmp.securityAssert check.", "author": "rjrudin", "createdAt": "2020-04-17T11:13:26Z", "path": "marklogic-data-hub/src/main/resources/ml-modules/root/data-hub/5/data-services/entitySearch/deleteSavedQuery.sjs", "diffHunk": "@@ -0,0 +1,10 @@\n+'use strict';", "originalCommit": "d3e2e34607c2cca813187f3b822215ea73449138", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDI5NzIwOQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3830#discussion_r410297209", "bodyText": "@rjrudin\n\nOwner validation is performed as below,\nlet canDelete = cts.exists(cts.andQuery([cts.documentQuery(documentUri), cts.jsonPropertyValueQuery(\"owner\", xdmp.getCurrentUser())]));\nYes. We have data-hub-saved-query-writer role with update permissions on the savedQuery document\nYes.", "author": "rahulvudutala", "createdAt": "2020-04-17T15:26:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDE1NTgxNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDM1MTQ0Nw==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3830#discussion_r410351447", "bodyText": "Oops sorry, I missed that part of the query.\n@ryanjdew I defer to you if you want to get an xdmp.securityAssert in place here, or table it for now. We'll of course need to add those to a lot of existing endpoints at some point.", "author": "rjrudin", "createdAt": "2020-04-17T16:58:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDE1NTgxNg=="}], "type": "inlineReview"}]}