{"pr_number": 3535, "pr_title": "DHFPROD-4096: Middle-tier Update load data API to store settings", "pr_createdAt": "2020-01-31T17:29:36Z", "pr_url": "https://github.com/marklogic/marklogic-data-hub/pull/3535", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzYxNTAzNg==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3535#discussion_r373615036", "bodyText": "What's the difference between a \"loadData\" artifact and a \"loadDataSettings\" artifact? I'm reading DHFPROD-4096, and the purpose of the new endpoints is to support only modifying the \"settings\" of a \"loadData\" config. That doesn't seem like it would mean that \"settings\" is a separate artifact type though, right?", "author": "rjrudin", "createdAt": "2020-01-31T18:15:33Z", "path": "marklogic-data-hub/src/main/resources/ml-modules/root/data-hub/5/artifacts/core.mjs", "diffHunk": "@@ -26,7 +27,8 @@ const cachedArtifacts = {};\n const registeredArtifactTypes = {\n     loadData: LoadData,", "originalCommit": "a54f4c6302a9aec1e2e2ea599f09bfa186b5a3ef", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzY0OTg2NQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3535#discussion_r373649865", "bodyText": "I understand, Conceptionally, the settings is not artififact type. One loadData artifact can be associated with only one setting. I just wanted to separate different implementation details because of different validation (different required fields, document properties) and query.  I can certainly add different methods for settings in the loadData.mjs instead of have a new type implmetation (loadDataSetting.mjs).", "author": "hao1st", "createdAt": "2020-01-31T19:35:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzYxNTAzNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mzc5MTkwNg==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3535#discussion_r373791906", "bodyText": "If the settings is not an artifact type, then this will permanently create confusion by including it in a variable called \"registeredArtifactTypes\".\nIs the goal for the web client to have an endpoint where it only needs to pass in a portion of a LoadData object? If so, couldn't the middle tier wrap it in an otherwise-empty LoadData object? And the LoadData module would be able to figure out that only the settings are being passed in. That seems much easier to understand vs corrupting the meaning of an \"artifact\" by including both \"LoadData\" and \"LoadDataSettings\" in it.", "author": "rjrudin", "createdAt": "2020-02-01T17:37:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzYxNTAzNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mzg3NjU2MQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3535#discussion_r373876561", "bodyText": "@rjrudin i removed the confusion in the latest check-in...", "author": "hao1st", "createdAt": "2020-02-02T21:26:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzYxNTAzNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzYxOTMwNQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3535#discussion_r373619305", "bodyText": "Tiny nit - I think it's better just to return the result, there's no value in defining a variable here and then returning it.", "author": "rjrudin", "createdAt": "2020-01-31T18:25:16Z", "path": "one-ui/src/main/java/com/marklogic/hub/curation/controllers/LoadDataController.java", "diffHunk": "@@ -108,6 +108,19 @@ public String getArtifactType() {\n         return \"loadData\";\n     }\n \n+    @RequestMapping(value = \"/{artifactName}/settings\", method = RequestMethod.GET)\n+    @ResponseBody\n+    public ResponseEntity<JsonNode> getArtifactSettings(@PathVariable String artifactName) {\n+        ResponseEntity<JsonNode> resp = super.getArtifactSettings(artifactName);", "originalCommit": "a54f4c6302a9aec1e2e2ea599f09bfa186b5a3ef", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzY1MDE5NQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3535#discussion_r373650195", "bodyText": "Yeah, i forgot simplifying after testing.", "author": "hao1st", "createdAt": "2020-01-31T19:36:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzYxOTMwNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzcyNjc0NQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3535#discussion_r373726745", "bodyText": "@ryanjdew ,\nShould the permissions here be \"data-hub-load-data-reader,read,data-hub-load-data-reader,update\" ? If so, this change has to be made for all the artifacts ?", "author": "srinathgit", "createdAt": "2020-01-31T23:18:08Z", "path": "marklogic-data-hub/src/main/resources/ml-modules/root/data-hub/5/artifacts/loadDataSettings.mjs", "diffHunk": "@@ -0,0 +1,68 @@\n+/**\n+ Copyright 2012-2019 MarkLogic Corporation\n+\n+ Licensed under the Apache License, Version 2.0 (the \"License\");\n+ you may not use this file except in compliance with the License.\n+ You may obtain a copy of the License at\n+\n+ http://www.apache.org/licenses/LICENSE-2.0\n+\n+ Unless required by applicable law or agreed to in writing, software\n+ distributed under the License is distributed on an \"AS IS\" BASIS,\n+ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ See the License for the specific language governing permissions and\n+ limitations under the License.\n+ */\n+'use strict';\n+\n+const DataHubSingleton = require('/data-hub/5/datahub-singleton.sjs');\n+\n+// define constants for caching expensive operations\n+const dataHub = DataHubSingleton.instance();\n+\n+const collections = ['http://marklogic.com/data-hub/load-data-artifact/settings'];\n+const databases = [dataHub.config.STAGINGDATABASE, dataHub.config.FINALDATABASE];\n+const permissions = [xdmp.permission(dataHub.consts.DATA_HUB_DEVELOPER_ROLE, 'update'), xdmp.permission(dataHub.consts.DATA_HUB_OPERATOR_ROLE, 'read')];", "originalCommit": "32812b1f41e9e6bb92da2763dd89fc7c3a5a3795", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzcyODExNw==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3535#discussion_r373728117", "bodyText": "I believe @bsrikan will be addressing that in another PR (#3536). If not, we can create a task to adjust it after the roles have been added.", "author": "ryanjdew", "createdAt": "2020-01-31T23:24:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzcyNjc0NQ=="}], "type": "inlineReview"}, {"oid": "81a60895bfcbcf2a7fa77d015a26635353e8d4c9", "url": "https://github.com/marklogic/marklogic-data-hub/commit/81a60895bfcbcf2a7fa77d015a26635353e8d4c9", "message": "DHFPROD-4096: Middle-tier Update load data API to store settings", "committedDate": "2020-02-02T18:51:27Z", "type": "commit"}, {"oid": "bf9e99d1847d679376993859b95e6501e2fc1645", "url": "https://github.com/marklogic/marklogic-data-hub/commit/bf9e99d1847d679376993859b95e6501e2fc1645", "message": "DHFPROD-4096: Fixed test cases failure", "committedDate": "2020-02-02T18:51:27Z", "type": "commit"}, {"oid": "4fd7e056c8cfc7278576d24533f1b014e0e78958", "url": "https://github.com/marklogic/marklogic-data-hub/commit/4fd7e056c8cfc7278576d24533f1b014e0e78958", "message": "DHFPROD-4096: Added a new server-side test case for loaddata settings", "committedDate": "2020-02-02T18:51:27Z", "type": "commit"}, {"oid": "cb583c9d140754a5428393bf7b9b5214a0c2ab72", "url": "https://github.com/marklogic/marklogic-data-hub/commit/cb583c9d140754a5428393bf7b9b5214a0c2ab72", "message": "DHFPROD-4096: Remove LoadDataSetting as an artifact", "committedDate": "2020-02-02T21:22:49Z", "type": "commit"}, {"oid": "cb583c9d140754a5428393bf7b9b5214a0c2ab72", "url": "https://github.com/marklogic/marklogic-data-hub/commit/cb583c9d140754a5428393bf7b9b5214a0c2ab72", "message": "DHFPROD-4096: Remove LoadDataSetting as an artifact", "committedDate": "2020-02-02T21:22:49Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDExOTI3Nw==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3535#discussion_r374119277", "bodyText": "Is the issue that loadData has a separate settings document, but other artifacts do not? If so, why is it a separate document? Conceptually, I would think that the \"settings\" of a \"loadData\" would be part of the \"loadData\" document.", "author": "rjrudin", "createdAt": "2020-02-03T14:05:05Z", "path": "marklogic-data-hub/src/main/resources/ml-modules/root/data-hub/5/artifacts/core.mjs", "diffHunk": "@@ -67,10 +67,30 @@ export function getArtifacts(artifactType) {\n export function deleteArtifact(artifactType, artifactName, artifactVersion = 'latest') {\n     const artifactKey = generateArtifactKey(artifactType, artifactName, artifactVersion);\n     const artifactLibrary =  getArtifactTypeLibrary(artifactType);\n+\n     // Currently there is no versioning for loadData artifacts\n     const node = getArtifactNode(artifactType, artifactName, artifactVersion);\n+\n+    let settingNode = {};\n+    if (artifactType == 'loadData') {\n+        //delete related config file if existed\n+        settingNode = artifactLibrary.getArtifactSettingNode(artifactName,", "originalCommit": "cb583c9d140754a5428393bf7b9b5214a0c2ab72", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDIyMjgxMg==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3535#discussion_r374222812", "bodyText": "@rjrudin The implementation was based on https://project.marklogic.com/jira/browse/DHFPROD-4096\nI assumed we could stored them as two different kinds of documents for flexibility and easier write/read. @ryanjdew What do you think?", "author": "hao1st", "createdAt": "2020-02-03T17:01:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDExOTI3Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDIzOTA2MQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3535#discussion_r374239061", "bodyText": "I don't see anything in 4096 that suggests any benefits from having a separate document. The middle tier of course won't care. But in ML, I think life is a lot simpler if it's a single document. You may need a separate endpoint for just changing settings on loadData specifically, as opposed to trying to toss that into the generic artifact endpoint. That would be good in the sense that the generic artifact endpoint wouldn't end up with multiple \"If this is loadData, then do this loadData-specific code\" blocks.", "author": "rjrudin", "createdAt": "2020-02-03T17:33:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDExOTI3Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDI3MTIxMQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3535#discussion_r374271211", "bodyText": "https://project.marklogic.com/jira/browse/DHFPROD-4173\nData mapping settings only have three more properties than data loading settings (Source database,  Provenance granularity and Target Format). I think we should consider them...", "author": "hao1st", "createdAt": "2020-02-03T18:40:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDExOTI3Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDI3NzQyNQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3535#discussion_r374277425", "bodyText": "I personally like the separate documents. We're treating the writing of the settings and the artifact separately in the UI. Also, the settings serve a different purpose. With the exception of ingest/load-data, the artifacts themselves will be primarily used server-side, while the settings will be used by the Data Hub orchestration code.", "author": "ryanjdew", "createdAt": "2020-02-03T18:52:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDExOTI3Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDExOTg1OQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3535#discussion_r374119859", "bodyText": "Given that this is setting collections that are specific to loadData, shouldn't this have a loadData-specific name?", "author": "rjrudin", "createdAt": "2020-02-03T14:06:12Z", "path": "marklogic-data-hub/src/main/resources/ml-modules/root/data-hub/5/artifacts/core.mjs", "diffHunk": "@@ -106,6 +126,42 @@ export function setArtifact(artifactType, artifactName, artifact) {\n     return artifact;\n }\n \n+export function getArtifactSettings(artifactType, artifactName, artifactVersion = 'latest') {\n+    const artifactSettingKey = generateArtifactKey(artifactType + 'Settings', artifactName);\n+    if (!cachedArtifacts[artifactSettingKey]) {\n+        const settingLibrary = getArtifactTypeLibrary(artifactType);\n+        const settingNode = settingLibrary.getArtifactSettingNode(artifactName, artifactVersion);\n+\n+        if (fn.empty(settingNode)) {\n+            return {};\n+        }\n+        cachedArtifacts[artifactSettingKey] = settingNode.toObject();\n+    }\n+    return cachedArtifacts[artifactSettingKey];\n+}\n+\n+export function setArtifactSettings(artifactType, artifactName, settings) {", "originalCommit": "cb583c9d140754a5428393bf7b9b5214a0c2ab72", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDIyNDUwNw==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3535#discussion_r374224507", "bodyText": "you mean we can use\nhttp://marklogic.com/data-hub/load-data-artifact/settings/{loadArtifactName} insteads of http://marklogic.com/data-hub/load-data-artifact/settings ?\nIt should be better for query/update.", "author": "hao1st", "createdAt": "2020-02-03T17:05:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDExOTg1OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDI3OTQ2MA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3535#discussion_r374279460", "bodyText": "@hao1st  It think what is meant is the collection more like http://marklogic.com/data-hub/${artifactType}/settings. Perhaps we could get the collection from the artifactLibrary and append \"/settings\" to them to stay consistent.", "author": "ryanjdew", "createdAt": "2020-02-03T18:57:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDExOTg1OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDI5NDM4NQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3535#discussion_r374294385", "bodyText": "@ryanjdew  makes sense.", "author": "hao1st", "createdAt": "2020-02-03T19:27:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDExOTg1OQ=="}], "type": "inlineReview"}, {"oid": "600d8378507323c61edf3e41ea6a442742a71e8e", "url": "https://github.com/marklogic/marklogic-data-hub/commit/600d8378507323c61edf3e41ea6a442742a71e8e", "message": "DHFPROD-4096: Modify collection name of artifact setting docs & refactor", "committedDate": "2020-02-03T22:50:13Z", "type": "commit"}]}