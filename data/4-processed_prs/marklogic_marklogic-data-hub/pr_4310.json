{"pr_number": 4310, "pr_title": "DHFPROD-5043: Incorrect collection name shows up in mapping UI", "pr_createdAt": "2020-07-29T18:45:04Z", "pr_url": "https://github.com/marklogic/marklogic-data-hub/pull/4310", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjUxNTc5MA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4310#discussion_r462515790", "bodyText": "I think a test is needed for cts.collectionQuery('testCollection') as well, as single quotes are valid.\nThere's also nothing prohibiting a user from having e.g. cts.collectionQuery([\"one\", \"two\"]) . I am assuming that if that's the case, then [\"one\", \"two\"] will show up?", "author": "rjrudin", "createdAt": "2020-07-29T18:52:55Z", "path": "marklogic-data-hub-central/ui/src/components/entities/mapping/create-edit-mapping-dialog/create-edit-mapping-dialog.test.tsx", "diffHunk": "@@ -89,7 +89,9 @@ describe('Create/Edit Mapping Step artifact component', () => {\n     const queryInput = getByPlaceholderText('Enter Source Query');\n     fireEvent.change(queryInput, { target: {value: 'cts.collectionQuery([\"testCollection\"])'}});\n     expect(queryInput).toHaveTextContent('cts.collectionQuery([\"testCollection\"])');\n-\n+    fireEvent.change(queryInput, { target: {value: 'cts.collectionQuery(\"testCollection\")'}});\n+    expect(queryInput).toHaveTextContent('cts.collectionQuery(\"testCollection\")');", "originalCommit": "b3a78cf055d7423ff3f2bb9e307fe7a858d8ebd4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjUzNzY1Nw==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4310#discussion_r462537657", "bodyText": "@rjrudin when user has cts.collectionQuery([\"one\", \"two\"]) then it collection Name shows as one,\"two. Since in order to fetch collection name we are grabbing characters between initial start and end quotes.", "author": "AkshayBajajML", "createdAt": "2020-07-29T19:31:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjUxNTc5MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzE3Nzg1OA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4310#discussion_r463177858", "bodyText": "Can you pls explain the intent of these new assertions. Seems to be duplicated.", "author": "bsrikan", "createdAt": "2020-07-30T18:05:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjUxNTc5MA=="}], "type": "inlineReview"}, {"oid": "b77bed7b2d93702dbcfb9be48d16c99034555ae0", "url": "https://github.com/marklogic/marklogic-data-hub/commit/b77bed7b2d93702dbcfb9be48d16c99034555ae0", "message": "DHFPROD-5043: Incorrect collection name shows up in mapping UI", "committedDate": "2020-07-29T19:35:36Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzE4MzkxNg==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4310#discussion_r463183916", "bodyText": "I think the real issue here is that sourceQuery is expecting a list when it should expect a singular value.\nThe input field was a \"select\" list in QuickStart with a typeahead showing existing collections in STAGING. For HubCentral I think we decided not to provide type ahead and go with 1 collection.\n@rjrudin  @xnikhil08 please correct me if I am wrong.", "author": "bsrikan", "createdAt": "2020-07-30T18:16:32Z", "path": "marklogic-data-hub-central/ui/src/components/entities/mapping/create-edit-mapping-dialog/create-edit-mapping-dialog.tsx", "diffHunk": "@@ -37,11 +37,20 @@ const CreateEditMappingDialog = (props) => {\n       setSrcQuery(props.mapData.sourceQuery);\n       setSelectedSource(props.mapData.selectedSource);\n       if(props.mapData.selectedSource === 'collection'){\n-      let srcCollection = props.mapData.sourceQuery.substring(\n-          props.mapData.sourceQuery.lastIndexOf(\"[\") + 2, \n-          props.mapData.sourceQuery.lastIndexOf(\"]\") - 1\n-      );\n-      setCollections(srcCollection);\n+      if(props.mapData.sourceQuery.includes('[') && props.mapData.sourceQuery.includes(']')) {", "originalCommit": "b77bed7b2d93702dbcfb9be48d16c99034555ae0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "f960058797fc06c030367beb8b4983a530f04dfb", "url": "https://github.com/marklogic/marklogic-data-hub/commit/f960058797fc06c030367beb8b4983a530f04dfb", "message": "DHFPROD-5043: Incorrect collection name shows up in mapping UI", "committedDate": "2020-07-31T20:26:54Z", "type": "forcePushed"}, {"oid": "899f039635b9bfea13771a6c3d8a88d08995ccff", "url": "https://github.com/marklogic/marklogic-data-hub/commit/899f039635b9bfea13771a6c3d8a88d08995ccff", "message": "DHFPROD-5043: Incorrect collection name shows up in mapping UI", "committedDate": "2020-08-03T21:51:14Z", "type": "commit"}, {"oid": "899f039635b9bfea13771a6c3d8a88d08995ccff", "url": "https://github.com/marklogic/marklogic-data-hub/commit/899f039635b9bfea13771a6c3d8a88d08995ccff", "message": "DHFPROD-5043: Incorrect collection name shows up in mapping UI", "committedDate": "2020-08-03T21:51:14Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTg2NjMwMQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4310#discussion_r465866301", "bodyText": "@AkshayBajajML do we need this code block here if the issue is taken care of by handling it in conversionFunctions?", "author": "bsrikan", "createdAt": "2020-08-05T16:51:05Z", "path": "marklogic-data-hub-central/ui/src/components/entities/mapping/create-edit-mapping-dialog/create-edit-mapping-dialog.tsx", "diffHunk": "@@ -37,11 +37,20 @@ const CreateEditMappingDialog = (props) => {\n       setSrcQuery(props.mapData.sourceQuery);\n       setSelectedSource(props.mapData.selectedSource);\n       if(props.mapData.selectedSource === 'collection'){\n-      let srcCollection = props.mapData.sourceQuery.substring(\n-          props.mapData.sourceQuery.lastIndexOf(\"[\") + 2, \n-          props.mapData.sourceQuery.lastIndexOf(\"]\") - 1\n-      );\n-      setCollections(srcCollection);\n+      if(props.mapData.sourceQuery.includes('[') && props.mapData.sourceQuery.includes(']')) {\n+          let srcCollection = props.mapData.sourceQuery.substring(\n+              props.mapData.sourceQuery.lastIndexOf(\"[\") + 2,\n+              props.mapData.sourceQuery.lastIndexOf(\"]\") - 1\n+          );\n+          setCollections(srcCollection);\n+      }\n+      else{\n+          let srcCollection = props.mapData.sourceQuery.substring(\n+            props.mapData.sourceQuery.lastIndexOf(\"(\") + 2,\n+            props.mapData.sourceQuery.lastIndexOf(\")\") - 1\n+          );\n+          setCollections(srcCollection);\n+      }", "originalCommit": "899f039635b9bfea13771a6c3d8a88d08995ccff", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTkyOTUyOQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4310#discussion_r465929529", "bodyText": "Change in conversion function takes care of the collection name for mapping card that we see by default after deploying the sample project. This highlighted block change takes care of the collection name when we make any changes to existing source query name by editing it.", "author": "AkshayBajajML", "createdAt": "2020-08-05T18:43:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTg2NjMwMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTk0NTY3OQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4310#discussion_r465945679", "bodyText": "I will file a separate bug for the following issue. If you change the query to \"test\", collInput will still show up as \"testCollection\" ie change in sourceQuery is not reflected in sourceCollection", "author": "bsrikan", "createdAt": "2020-08-05T19:13:24Z", "path": "marklogic-data-hub-central/ui/src/components/entities/mapping/create-edit-mapping-dialog/create-edit-mapping-dialog.test.tsx", "diffHunk": "@@ -89,7 +89,15 @@ describe('Create/Edit Mapping Step artifact component', () => {\n     const queryInput = getByPlaceholderText('Enter Source Query');\n     fireEvent.change(queryInput, { target: {value: 'cts.collectionQuery([\"testCollection\"])'}});\n     expect(queryInput).toHaveTextContent('cts.collectionQuery([\"testCollection\"])');\n-\n+    fireEvent.change(queryInput, { target: {value: 'cts.collectionQuery(\"testCollection\")'}});\n+    expect(queryInput).toHaveTextContent('cts.collectionQuery(\"testCollection\")');\n+    expect(collInput).toHaveValue(\"testCollection\");\n+    fireEvent.change(queryInput, { target: {value: \"cts.collectionQuery(['testCollection'])\"}});\n+    expect(queryInput).toHaveTextContent(\"cts.collectionQuery(['testCollection'])\");\n+    expect(collInput).toHaveValue('testCollection');\n+    fireEvent.change(queryInput, { target: {value: \"cts.collectionQuery('testCollection')\"}});\n+    expect(queryInput).toHaveTextContent(\"cts.collectionQuery('testCollection')\");\n+    expect(collInput).toHaveValue('testCollection');", "originalCommit": "899f039635b9bfea13771a6c3d8a88d08995ccff", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}