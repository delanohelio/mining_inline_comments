{"pr_number": 4154, "pr_title": "DHFPROD-5277: Fix ML-9.0-12 tests", "pr_createdAt": "2020-06-25T23:48:03Z", "pr_url": "https://github.com/marklogic/marklogic-data-hub/pull/4154", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjI2Nzg3Mw==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4154#discussion_r446267873", "bodyText": "Unfortunately, the spread syntax isn't supported in ML 9.", "author": "ryanjdew", "createdAt": "2020-06-26T15:53:42Z", "path": "marklogic-data-hub/src/main/resources/ml-modules/root/data-hub/5/entities/entity-search-lib.sjs", "diffHunk": "@@ -127,7 +127,7 @@ function buildAllMetadata(parentPropertyName, entityModel, entityName) {\n       propertyMetadata[\"properties\"] = metaData[\"allPropertiesMetadata\"];\n       propertyMetadataObject[\"properties\"] = metaData[\"allPropertiesMetadata\"];\n \n-      granularPropertyMetadata = {...granularPropertyMetadata, ...metaData[\"granularPropertyMetadata\"]};\n+      granularPropertyMetadata = Object.assign({},granularPropertyMetadata, metaData[\"granularPropertyMetadata\"]);", "originalCommit": "84ccffdcb7f2235c0c281d863751b1d1c9c65ab2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjI3NzM3Ng==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4154#discussion_r446277376", "bodyText": "In 'manageCustomStep.sjs' , I used spread operator. I believe that should fail as well in 9.0-12", "author": "srinathgit", "createdAt": "2020-06-26T16:10:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjI2Nzg3Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjQ0OTk5MQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4154#discussion_r446449991", "bodyText": "updated there now as well.", "author": "ryanjdew", "createdAt": "2020-06-26T23:24:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjI2Nzg3Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjE0OTM4Nw==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4154#discussion_r446149387", "bodyText": "I believe this waitForTasksToFinish can be removed since there aren't any post-commit triggers on the modules database. We only need it after loading entity models.", "author": "rjrudin", "createdAt": "2020-06-26T12:20:38Z", "path": "marklogic-data-hub/src/testFixtures/java/com/marklogic/hub/test/AbstractHubTest.java", "diffHunk": "@@ -289,26 +289,33 @@ protected void installUserModulesAndArtifacts(HubConfig hubConfig, boolean force\n         loadUserModulesCommand.setLoadQueryOptions(loadQueryOptions);\n         commands.add(loadUserModulesCommand);\n \n-        LoadUserArtifactsCommand loadUserArtifactsCommand = new LoadUserArtifactsCommand(hubConfig);\n-        loadUserArtifactsCommand.setForceLoad(forceLoad);\n-        commands.add(loadUserArtifactsCommand);\n-\n         SimpleAppDeployer deployer = new SimpleAppDeployer(hubConfig.getManageClient(), hubConfig.getAdminManager());\n         deployer.setCommands(commands);\n         deployer.deploy(hubConfig.getAppConfig());\n \n-        // Wait for post-commit triggers to finish\n         waitForTasksToFinish();\n-\n+        // Generate function metadata must occur after loading modules", "originalCommit": "84ccffdcb7f2235c0c281d863751b1d1c9c65ab2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjE0OTkwNQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4154#discussion_r446149905", "bodyText": "If this is needed, then just change this class to extend AbstractHubCoreTest instead of HubTestBase, as AHCT is calling resetHubProject. Can remove the Spring annotations from this test class too.", "author": "rjrudin", "createdAt": "2020-06-26T12:21:48Z", "path": "marklogic-data-hub/src/test/java/com/marklogic/hub/cli/client/RunFlowViaMainTest.java", "diffHunk": "@@ -36,6 +33,11 @@ public static void cleanUp() {\n         new Installer().deleteProjectDir();\n     }\n \n+    @BeforeEach\n+    public void beforeEach() {", "originalCommit": "84ccffdcb7f2235c0c281d863751b1d1c9c65ab2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjQ1MDA0Ng==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4154#discussion_r446450046", "bodyText": "recommended changes made", "author": "ryanjdew", "createdAt": "2020-06-26T23:24:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjE0OTkwNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjE1MDM3Mw==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4154#discussion_r446150373", "bodyText": "This is never used anywhere, does it need to be added?", "author": "rjrudin", "createdAt": "2020-06-26T12:22:42Z", "path": "marklogic-data-hub/src/main/java/com/marklogic/hub/impl/HubClientImpl.java", "diffHunk": "@@ -38,6 +40,7 @@ public HubClientImpl(HubConfigImpl hubConfig, Map<DatabaseKind, String> database\n         jobsClient = hubConfig.newJobDbClient();\n         this.databaseNames = databaseNames;\n         this.manageClient = hubConfig.getManageClient();\n+        this.modulesClient = hubConfig.newModulesDbClient();", "originalCommit": "84ccffdcb7f2235c0c281d863751b1d1c9c65ab2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "c91ed5cb541d4faa4ab46dc3ba0db5bbfc4f8962", "url": "https://github.com/marklogic/marklogic-data-hub/commit/c91ed5cb541d4faa4ab46dc3ba0db5bbfc4f8962", "message": "DHFPROD-5277: Fix ML-9.0-12 tests", "committedDate": "2020-06-26T19:41:37Z", "type": "forcePushed"}, {"oid": "e9ea8a8484e1a4b5db70c43ae7707ff421fe5242", "url": "https://github.com/marklogic/marklogic-data-hub/commit/e9ea8a8484e1a4b5db70c43ae7707ff421fe5242", "message": "DHFPROD-5277: Fix ML-9.0-12 tests", "committedDate": "2020-06-26T22:50:18Z", "type": "forcePushed"}, {"oid": "d198b65d536f9d547326ebb6d028fc7303d90aec", "url": "https://github.com/marklogic/marklogic-data-hub/commit/d198b65d536f9d547326ebb6d028fc7303d90aec", "message": "DHFPROD-5277: Fix ML-9.0-12 tests", "committedDate": "2020-06-26T23:22:04Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjQ0OTg0MA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4154#discussion_r446449840", "bodyText": "Also, Object.entries is not available in ML 9.", "author": "ryanjdew", "createdAt": "2020-06-26T23:23:41Z", "path": "marklogic-data-hub/src/main/resources/ml-modules/root/data-hub/5/data-services/customStep/getCustomStep.sjs", "diffHunk": "@@ -22,9 +22,9 @@ let dataHubOptions = [\"sourceQuery\", \"sourceQueryIsScript\", \"constrainSourceQuer\n let additionalSettings = {};\n let step = Artifacts.getArtifact(\"custom\", stepName)\n let options = Artifacts.convertStepReferenceToInlineStep(step.stepId).options;\n-for (let [key, value] of Object.entries(options)) {\n+for (let key of Object.keys(options)) {", "originalCommit": "d198b65d536f9d547326ebb6d028fc7303d90aec", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjUzOTIzOQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4154#discussion_r446539239", "bodyText": "I'm thinking we should make a list of the strings that won't work in ML 9, and we can then have a JUnit test that scans each SJS file and throws an error if any are found. So far, we have at least Object.entries and \"{...\", right? I can write up a JIRA ticket for it, and we can always add to the list.", "author": "rjrudin", "createdAt": "2020-06-27T15:46:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjQ0OTg0MA=="}], "type": "inlineReview"}, {"oid": "853a5e4f8dcfb343db24a8eae0f9fff0f7137fc2", "url": "https://github.com/marklogic/marklogic-data-hub/commit/853a5e4f8dcfb343db24a8eae0f9fff0f7137fc2", "message": "DHFPROD-5277: Fix ML-9.0-12 tests", "committedDate": "2020-06-26T23:25:56Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjUzOTE2OQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4154#discussion_r446539169", "bodyText": "This can still be removed right?", "author": "rjrudin", "createdAt": "2020-06-27T15:45:40Z", "path": "marklogic-data-hub/src/main/java/com/marklogic/hub/impl/HubClientImpl.java", "diffHunk": "@@ -28,6 +28,8 @@\n     private DatabaseClient stagingClient;\n     private DatabaseClient finalClient;\n     private DatabaseClient jobsClient;\n+    private DatabaseClient modulesClient;", "originalCommit": "853a5e4f8dcfb343db24a8eae0f9fff0f7137fc2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzA4MzU2Mg==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4154#discussion_r447083562", "bodyText": "removed", "author": "ryanjdew", "createdAt": "2020-06-29T16:04:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjUzOTE2OQ=="}], "type": "inlineReview"}, {"oid": "2cfad16da5ee8e68dd82d1fa763b8e2ef109e6b4", "url": "https://github.com/marklogic/marklogic-data-hub/commit/2cfad16da5ee8e68dd82d1fa763b8e2ef109e6b4", "message": "DHFPROD-5277: Fix ML-9.0-12 tests", "committedDate": "2020-06-29T05:37:02Z", "type": "commit"}, {"oid": "2cfad16da5ee8e68dd82d1fa763b8e2ef109e6b4", "url": "https://github.com/marklogic/marklogic-data-hub/commit/2cfad16da5ee8e68dd82d1fa763b8e2ef109e6b4", "message": "DHFPROD-5277: Fix ML-9.0-12 tests", "committedDate": "2020-06-29T05:37:02Z", "type": "forcePushed"}]}