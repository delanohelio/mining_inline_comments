{"pr_number": 3920, "pr_title": "DHFPROD-4888: Add entity type title as collection to mapped documents", "pr_createdAt": "2020-05-06T18:57:27Z", "pr_url": "https://github.com/marklogic/marklogic-data-hub/pull/3920", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTAyNzY0MA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3920#discussion_r421027640", "bodyText": "Thoughts on parsing this out instead of doing a query? I'm just thinking that for mapping 1 million docs, this means 1 million additional triple lookups.\nI've also tried to start a naming convention in entity-lib.sjs where \"find\" indicates that a function will do a query, and \"get\" indicates that a function will not do a query. I've found this to be helpful on previous projects, though of course this is just one of dozens of DH libraries. But I do think it's a helpful way so readers can quickly detect where queries occur when analyzing code for performance.", "author": "rjrudin", "createdAt": "2020-05-06T19:09:17Z", "path": "marklogic-data-hub/src/main/resources/ml-modules/root/data-hub/5/impl/hub-es.sjs", "diffHunk": "@@ -121,8 +121,23 @@ function getRefEntityIdentifiers(entityIRI, entityInfo, prop) {\n   return refEntityId;\n }\n \n+function getEntityServiceTitle(iri) {\n+  if (!(iri instanceof sem.iri)) {\n+    iri = sem.iri(iri);\n+  }\n+  const triple = fn.head(cts.triples(iri,", "originalCommit": "8b798f1a0621e256fa8e771ed5c845c7cafe8f55", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTA5NzIxMA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3920#discussion_r421097210", "bodyText": "@rjrudin I'm trying to recall, did we add validation to the entity title to ensure we don't have spaces and other things that potentially require knowing the right decoding rules to get the value from the URI? If we have that, I don't have an issue with parsing it from the IRI.\nI can also make some adjustments to limit the triples query to the models and cache the value for the duration of a batch/transaction.", "author": "ryanjdew", "createdAt": "2020-05-06T21:15:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTAyNzY0MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTEwNzAyMQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3920#discussion_r421107021", "bodyText": "We do have validation in the new model endpoints in 5.3, but of course that won't impact existing entity models. Though since we'll have docs telling people how to upgrade their entity models for HC and 5.3, we could tell them to ensure their titles conform to the validation rules in 5.3.\nentity-lib.sjs has a function too for doing the parsing - getEntityTypeIdParts .", "author": "rjrudin", "createdAt": "2020-05-06T21:35:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTAyNzY0MA=="}], "type": "inlineReview"}, {"oid": "ae4fa171b79a3a05e5f024a9a0e25c408bf0d7f4", "url": "https://github.com/marklogic/marklogic-data-hub/commit/ae4fa171b79a3a05e5f024a9a0e25c408bf0d7f4", "message": "DHFPROD-4888: Add entity type title as collection to mapped documents", "committedDate": "2020-05-06T21:39:01Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTI4MTQ0NQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3920#discussion_r421281445", "bodyText": "Shouldnt the default collection be both entityType title and stepName to be consistent with pre 5.3?", "author": "bsrikan", "createdAt": "2020-05-07T07:01:12Z", "path": "marklogic-data-hub-central/src/test/java/com/marklogic/hub/central/controllers/MappingControllerTest.java", "diffHunk": "@@ -166,7 +166,7 @@ public void testMappingSettings() {\n         // Check for defaults\n         assertEquals(\"TestCustomerMapping\", result.get(\"artifactName\").asText());\n         assertEquals(1, result.get(\"collections\").size());\n-        assertEquals(\"default-mapping\", result.get(\"collections\").get(0).asText());\n+        assertEquals(\"Customer\", result.get(\"collections\").get(0).asText());", "originalCommit": "ae4fa171b79a3a05e5f024a9a0e25c408bf0d7f4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTUzMzUxNA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3920#discussion_r421533514", "bodyText": "\"default-mapping\" is technically the step definition name, though I don't think it has any meaning other than to be a sensible default for a collection for mapped documents. If the entityType is used as the sensible default, then I don't see any reason nor meaning in the step definition name being used as a default collection too.", "author": "rjrudin", "createdAt": "2020-05-07T14:09:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTI4MTQ0NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTU4NjE1OA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3920#discussion_r421586158", "bodyText": "I was looking for \"TestCustomerMapping\" and agree that \"default-mapping\" shouldnt be used as a default collection.", "author": "bsrikan", "createdAt": "2020-05-07T15:17:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTI4MTQ0NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTY0OTI0OQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3920#discussion_r421649249", "bodyText": "@bsrikan added the step name to the default collections.", "author": "ryanjdew", "createdAt": "2020-05-07T16:50:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTI4MTQ0NQ=="}], "type": "inlineReview"}, {"oid": "7cf3d62611327087a26a4fd163590650d6409556", "url": "https://github.com/marklogic/marklogic-data-hub/commit/7cf3d62611327087a26a4fd163590650d6409556", "message": "DHFPROD-4888: Add entity type title as collection to mapped documents", "committedDate": "2020-05-07T16:47:41Z", "type": "forcePushed"}, {"oid": "0f181af14eba600b3af8ea54dde171676784545d", "url": "https://github.com/marklogic/marklogic-data-hub/commit/0f181af14eba600b3af8ea54dde171676784545d", "message": "DHFPROD-4888: Add entity type title as collection to mapped documents", "committedDate": "2020-05-07T21:11:55Z", "type": "commit"}, {"oid": "0f181af14eba600b3af8ea54dde171676784545d", "url": "https://github.com/marklogic/marklogic-data-hub/commit/0f181af14eba600b3af8ea54dde171676784545d", "message": "DHFPROD-4888: Add entity type title as collection to mapped documents", "committedDate": "2020-05-07T21:11:55Z", "type": "forcePushed"}]}