{"pr_number": 4692, "pr_title": "DHFPROD-5254: Add Synonym Type to Single Ruleset Modal", "pr_createdAt": "2020-10-09T18:16:20Z", "pr_url": "https://github.com/marklogic/marklogic-data-hub/pull/4692", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzI5NTc0NQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4692#discussion_r503295745", "bodyText": "Should be \"URI\" instead of \"uri\".", "author": "rjrudin", "createdAt": "2020-10-12T13:27:59Z", "path": "marklogic-data-hub-central/ui/src/components/entities/matching/ruleset-single-modal/ruleset-single-modal.tsx", "diffHunk": "@@ -37,19 +39,37 @@ const { MLOption } = MLSelect;\n const MatchRulesetModal: React.FC<Props> = (props) => {\n   const { curationOptions, updateActiveStepDefinition } = useContext(CurationContext);\n \n-  const [entityTypeDefinition, setEntityTypeDefinition] = useState<Definition>(DEFAULT_ENTITY_DEFINITION)\n-  const [selectedProperty, setSelectedProperty] = useState<string | undefined>(undefined)\n+  const [entityTypeDefinition, setEntityTypeDefinition] = useState<Definition>(DEFAULT_ENTITY_DEFINITION);\n+\n+  const [selectedProperty, setSelectedProperty] = useState<string | undefined>(undefined);\n   const [propertyTypeErrorMessage, setPropertyTypeErrorMessage] = useState('');\n   const [matchType, setMatchType] = useState('')\n   const [matchTypeErrorMessage, setMatchTypeErrorMessage] = useState('');\n \n+  const [thesaurusValue, setThesaurusValue] = useState('');\n+  const [thesaurusErrorMessage, setThesaurusErrorMessage] = useState('');\n+  const [filterValue, setFilterValue] = useState('')\n+\n   useEffect(() => {\n     if (props.isVisible && curationOptions.entityDefinitionsArray.length > 0 && curationOptions.activeStep.entityName !== '') {\n       let entityTypeDefinition: Definition = curationOptions.entityDefinitionsArray.find( entityDefinition => entityDefinition.name === curationOptions.activeStep.entityName) || DEFAULT_ENTITY_DEFINITION;\n       setEntityTypeDefinition(entityTypeDefinition);\n     }\n   }, [props.isVisible]);\n \n+  const handleInputChange = (event) => {\n+    if (event.target.id === 'thesaurus-uri-input') {\n+      if (event.target.value === '') {\n+        setThesaurusErrorMessage('A thesaurus uri is required')", "originalCommit": "6983210f872f7fc9819cd52e22b853093920ba07", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzI5Nzk2Mg==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4692#discussion_r503297962", "bodyText": "@ryanjdew @brucean52 @wooldridge I think the backend should validate this. But I also don't see any requirement in 5254 about prohibiting duplicates, nor what defines a duplicate.", "author": "rjrudin", "createdAt": "2020-10-12T13:31:37Z", "path": "marklogic-data-hub-central/ui/src/components/entities/matching/ruleset-single-modal/ruleset-single-modal.tsx", "diffHunk": "@@ -76,40 +100,78 @@ const MatchRulesetModal: React.FC<Props> = (props) => {\n       case 'exact':\n       case 'reduce':\n       case 'zip':\n-        let propertyName = selectedProperty || '';\n-\n-        let matchRule: MatchRule = {\n-          entityPropertyPath: propertyName,\n-          matchType: matchType,\n-          options: {}\n-        }\n+        {\n+          let propertyName = selectedProperty || '';\n \n-        let matchRuleset: MatchRuleset = {\n-          name: propertyName,\n-          weight: 0,\n-          matchRules: [matchRule]\n+          let matchRule: MatchRule = {\n+            entityPropertyPath: propertyName,\n+            matchType: matchType,\n+            options: {}\n+          }\n+  \n+          let matchRuleset: MatchRuleset = {\n+            name: propertyName,\n+            weight: 0,\n+            matchRules: [matchRule]\n+          }\n+  \n+          //check for duplicate\n+          let propertyRulesets = curationOptions.activeStep.stepDefinition['matchRulesets'].filter(matchRuleset => matchRuleset['name'] === propertyName)\n+          if (propertyRulesets.length > 0) {", "originalCommit": "6983210f872f7fc9819cd52e22b853093920ba07", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzM5MzMwNw==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4692#discussion_r503393307", "bodyText": "I confirmed with @ryanjdew that we shouldn't allow duplicate rulesets.", "author": "brucean52", "createdAt": "2020-10-12T16:03:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzI5Nzk2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzM5NTEzOA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4692#discussion_r503395138", "bodyText": "But what is the logic for defining \"duplicate\"? That's not in the JIRA ticket either. This logic only is applied on rulesets whose matchRules array has a length of 1. What if it's 2?\nMy main point is - since the JIRA ticket says nothing about duplicates, there shouldn't be any code in this PR for duplicates. Otherwise, how does whomever does QA on this know if the duplicate logic is correct?", "author": "rjrudin", "createdAt": "2020-10-12T16:06:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzI5Nzk2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzM5ODE2Ng==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4692#discussion_r503398166", "bodyText": "If it's 2 then it isn't a duplicate. It's a ruleset for multiple properties and not a single one.\nError handling isn't described in all tickets. Should it be a separate ticket?", "author": "brucean52", "createdAt": "2020-10-12T16:12:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzI5Nzk2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzQxNzU4Nw==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4692#discussion_r503417587", "bodyText": "We only want to write code in support of requirements written in JIRA tickets. I assume that this duplicate logic would be relevant regardless of how the step is being saved - i.e. it should be applied when saving a step via Gradle. So the logic should be in the backend. Since 5254 seems to be a UI-only ticket, then a separate ticket makes sense.", "author": "rjrudin", "createdAt": "2020-10-12T16:50:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzI5Nzk2Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzI5OTY5MQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4692#discussion_r503299691", "bodyText": "Does \"stepDefinition\" here refer to the configuration of this step? If so, I highly recommend not using the term \"step definition\", which in DHF means \"an artifact that identifies a name and type and module path for a step\". I actually wouldn't expect anything in between \"activeStep\" and \"matchRulesets\" either, since matchRulesets is a top-level property of a step. If \"activeStep\" is actually a wrapper containing the step config and other properties, I would call it something besides a \"step\", because its name to me implies that matchRulesets should be a property of it.", "author": "rjrudin", "createdAt": "2020-10-12T13:34:25Z", "path": "marklogic-data-hub-central/ui/src/components/entities/matching/ruleset-single-modal/ruleset-single-modal.tsx", "diffHunk": "@@ -76,40 +100,78 @@ const MatchRulesetModal: React.FC<Props> = (props) => {\n       case 'exact':\n       case 'reduce':\n       case 'zip':\n-        let propertyName = selectedProperty || '';\n-\n-        let matchRule: MatchRule = {\n-          entityPropertyPath: propertyName,\n-          matchType: matchType,\n-          options: {}\n-        }\n+        {\n+          let propertyName = selectedProperty || '';\n \n-        let matchRuleset: MatchRuleset = {\n-          name: propertyName,\n-          weight: 0,\n-          matchRules: [matchRule]\n+          let matchRule: MatchRule = {\n+            entityPropertyPath: propertyName,\n+            matchType: matchType,\n+            options: {}\n+          }\n+  \n+          let matchRuleset: MatchRuleset = {\n+            name: propertyName,\n+            weight: 0,\n+            matchRules: [matchRule]\n+          }\n+  \n+          //check for duplicate\n+          let propertyRulesets = curationOptions.activeStep.stepDefinition['matchRulesets'].filter(matchRuleset => matchRuleset['name'] === propertyName)", "originalCommit": "6983210f872f7fc9819cd52e22b853093920ba07", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzM5MTc1OQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4692#discussion_r503391759", "bodyText": "stepDefinition = stepArtifact from payload. I can rename it to that.", "author": "brucean52", "createdAt": "2020-10-12T16:00:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzI5OTY5MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzMwMDMzNQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4692#discussion_r503300335", "bodyText": "Same thing - we should call this a \"step\", not a \"stepDefinition\".", "author": "rjrudin", "createdAt": "2020-10-12T13:35:16Z", "path": "marklogic-data-hub-central/ui/src/components/entities/matching/ruleset-single-modal/ruleset-single-modal.tsx", "diffHunk": "@@ -76,40 +100,78 @@ const MatchRulesetModal: React.FC<Props> = (props) => {\n       case 'exact':\n       case 'reduce':\n       case 'zip':\n-        let propertyName = selectedProperty || '';\n-\n-        let matchRule: MatchRule = {\n-          entityPropertyPath: propertyName,\n-          matchType: matchType,\n-          options: {}\n-        }\n+        {\n+          let propertyName = selectedProperty || '';\n \n-        let matchRuleset: MatchRuleset = {\n-          name: propertyName,\n-          weight: 0,\n-          matchRules: [matchRule]\n+          let matchRule: MatchRule = {\n+            entityPropertyPath: propertyName,\n+            matchType: matchType,\n+            options: {}\n+          }\n+  \n+          let matchRuleset: MatchRuleset = {\n+            name: propertyName,\n+            weight: 0,\n+            matchRules: [matchRule]\n+          }\n+  \n+          //check for duplicate\n+          let propertyRulesets = curationOptions.activeStep.stepDefinition['matchRulesets'].filter(matchRuleset => matchRuleset['name'] === propertyName)\n+          if (propertyRulesets.length > 0) {\n+            propertyRulesets.forEach( ruleset => {\n+              if (ruleset['matchRules'].length === 1 && ruleset['matchRules'][0].matchType === matchType) {\n+                propertyErrorMessage = 'A ruleset with these selections already exists';\n+              }\n+            });\n+          }\n+  \n+          if (propertyErrorMessage === '' && matchErrorMessage === '') {\n+            // TODO save step to backend\n+            let newStepDefinition: MatchingStep = curationOptions.activeStep.stepDefinition;", "originalCommit": "6983210f872f7fc9819cd52e22b853093920ba07", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzMwMTA5NQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4692#discussion_r503301095", "bodyText": "@ryanjdew Does it matter what database the thesaurus is in? As a user, that's the first question I have when reading this.", "author": "rjrudin", "createdAt": "2020-10-12T13:36:30Z", "path": "marklogic-data-hub-central/ui/src/config/tooltips.config.js", "diffHunk": "@@ -62,6 +62,9 @@ const NewMatchTooltips = {\n     'sourceDatabase': 'The database where the input data is read from. Must be the same as the Matching Step *Source Database*.',\n     'description': 'The description of this matching configuration.',\t    'targetDatabase': 'The database where to store the processed data. Must be the same as the Matching Step *Source Database*.',\n     'sourceQuery' : 'The collection or CTS query that selects the source data to process in this configuration.',\n+    'thesaurusUri' : 'The path to the thesaurus used to determine synonyms',", "originalCommit": "6983210f872f7fc9819cd52e22b853093920ba07", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "3e3d733df3a305335ef48d4408de91cf854cbf1e", "url": "https://github.com/marklogic/marklogic-data-hub/commit/3e3d733df3a305335ef48d4408de91cf854cbf1e", "message": "DHFPROD-5254: Add Synonym Type to Single Ruleset Modal", "committedDate": "2020-10-12T18:54:40Z", "type": "commit"}, {"oid": "3e3d733df3a305335ef48d4408de91cf854cbf1e", "url": "https://github.com/marklogic/marklogic-data-hub/commit/3e3d733df3a305335ef48d4408de91cf854cbf1e", "message": "DHFPROD-5254: Add Synonym Type to Single Ruleset Modal", "committedDate": "2020-10-12T18:54:40Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzUwMzc5NQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4692#discussion_r503503795", "bodyText": "These 5 lines are repeated below, but I assume that can be addressed when this is enhanced to talk to the backend.", "author": "rjrudin", "createdAt": "2020-10-12T19:56:06Z", "path": "marklogic-data-hub-central/ui/src/components/entities/matching/ruleset-single-modal/ruleset-single-modal.tsx", "diffHunk": "@@ -76,40 +100,68 @@ const MatchRulesetModal: React.FC<Props> = (props) => {\n       case 'exact':\n       case 'reduce':\n       case 'zip':\n-        let propertyName = selectedProperty || '';\n-\n-        let matchRule: MatchRule = {\n-          entityPropertyPath: propertyName,\n-          matchType: matchType,\n-          options: {}\n-        }\n+        {\n+          let propertyName = selectedProperty || '';\n \n-        let matchRuleset: MatchRuleset = {\n-          name: propertyName,\n-          weight: 0,\n-          matchRules: [matchRule]\n+          let matchRule: MatchRule = {\n+            entityPropertyPath: propertyName,\n+            matchType: matchType,\n+            options: {}\n+          }\n+  \n+          let matchRuleset: MatchRuleset = {\n+            name: propertyName,\n+            weight: 0,\n+            matchRules: [matchRule]\n+          }\n+  \n+          if (propertyErrorMessage === '' && matchErrorMessage === '') {\n+            // TODO save step to backend\n+            let newStepArtifact: MatchingStep = curationOptions.activeStep.stepArtifact;", "originalCommit": "3e3d733df3a305335ef48d4408de91cf854cbf1e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}