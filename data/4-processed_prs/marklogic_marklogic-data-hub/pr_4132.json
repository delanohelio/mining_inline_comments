{"pr_number": 4132, "pr_title": "DHFPROD-5204: BackEnd - Add primary Key value field in the searchAPI results response", "pr_createdAt": "2020-06-23T21:27:15Z", "pr_url": "https://github.com/marklogic/marklogic-data-hub/pull/4132", "timeline": [{"oid": "feab7ee1b999e84ce1189abda5f34968b97ff7fb", "url": "https://github.com/marklogic/marklogic-data-hub/commit/feab7ee1b999e84ce1189abda5f34968b97ff7fb", "message": "DHFPROD-5204: added primaryKey value field to searchAPI results response", "committedDate": "2020-06-23T21:40:56Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDU1MDAyMw==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4132#discussion_r444550023", "bodyText": "I'm unclear why it is stringifying and then parsing immediately after. Is it is to convert from a JSON node to a plain JSON object? If so, I think that is worth adding a comment for. Also,  selectedPropertyMetadata.toObject() may be a better way.", "author": "ryanjdew", "createdAt": "2020-06-23T22:48:39Z", "path": "marklogic-data-hub/src/main/resources/ml-modules/root/data-hub/5/entities/entity-search-lib.sjs", "diffHunk": "@@ -43,10 +43,13 @@ function addPropertiesToSearchResponse(entityName, searchResponse, propertiesToD\n     selectedPropertyMetadata = buildSelectedPropertiesMetadata(allMetadata, selectedPropertyNames);\n   }\n   selectedPropertyMetadata = selectedPropertyMetadata.length > 0 ? selectedPropertyMetadata : propertyMetadata.slice(0, maxDefaultProperties);\n+  let selectedPropertyMetadataFinal = JSON.parse(JSON.stringify(selectedPropertyMetadata));", "originalCommit": "feab7ee1b999e84ce1189abda5f34968b97ff7fb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDU1NDA0OA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4132#discussion_r444554048", "bodyText": "This is to create a deep copy of selectedPropertyMetadata with its own object references, as I later modify the objects inside of selectedPropertyMetadataFinal. I will add a clarifying comment.", "author": "saarimrahman", "createdAt": "2020-06-23T23:00:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDU1MDAyMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTEwMjUwOA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4132#discussion_r445102508", "bodyText": "Is this no longer needed now that selectedPropertyMetadata isn't being modified?", "author": "rjrudin", "createdAt": "2020-06-24T18:52:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDU1MDAyMw=="}], "type": "inlineReview"}, {"oid": "267d8974d596366922d55068597ff6ced5afd1f1", "url": "https://github.com/marklogic/marklogic-data-hub/commit/267d8974d596366922d55068597ff6ced5afd1f1", "message": "DHFPROD-5204: added primaryKey value field to searchAPI results response", "committedDate": "2020-06-23T23:07:25Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDg3MzY4Mg==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4132#discussion_r444873682", "bodyText": "I was able to comment out most of the new code here and the tests all still pass. I did this:\n            if (entityDef.hasOwnProperty(\"primaryKey\")) {\n              let primaryKey = entityDef.primaryKey;\n              if (entityInstance.hasOwnProperty((primaryKey))) {\n                  result.primaryKey.propertyPath = primaryKey;\n                  result.primaryKey.propertyValue = entityInstance[primaryKey];\n              } else { // no primaryKey in entityInstance, so use uri\n                result.primaryKey.propertyPath = \"uri\";\n                result.primaryKey.propertyValue = result.uri;\n              }\n            }\n\nSo I'm not clear on why all the other logic is needed. If it's for the All Entities view, I don't think we care about selected properties there, right? The user shouldn't be able to do that for that feature. In that context, we know the identifier should always be first.\nAlso, in the above logic, it's not handling the case where there's no primaryKey property defined, right? I think what we really want is a getPrimaryValue(entityInstance, entityDefinition) function that will return an object containing propertyPath/propertyValue, or it will return null. If it returns null, then use URI.", "author": "rjrudin", "createdAt": "2020-06-24T12:58:31Z", "path": "marklogic-data-hub/src/main/resources/ml-modules/root/data-hub/5/entities/entity-search-lib.sjs", "diffHunk": "@@ -55,19 +60,56 @@ function addPropertiesToSearchResponse(entityName, searchResponse, propertiesToD\n       console.log(`Unable to obtain entity instance from document with URI '${result.uri}'; will not add entity properties to its search result`);\n     }\n \n+    let entityDef = entityModel.definitions[entityName];\n     if (instance != null) {\n       const entityInstance = instance[entityName];\n       if (!entityInstance) {\n         console.log(`Unable to obtain entity instance from document with URI '${result.uri}' and entity name '${entityName}'; will not add entity properties to its search result`);\n       } else {\n         selectedPropertyMetadata.forEach(parentProperty => {\n-          result.entityProperties.push(getPropertyValues(parentProperty, entityInstance));\n-        });\n+            result.entityProperties.push(getPropertyValues(parentProperty, entityInstance));\n+\n+            if (entityDef.hasOwnProperty(\"primaryKey\")) {", "originalCommit": "267d8974d596366922d55068597ff6ced5afd1f1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDg3NDQ1OQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4132#discussion_r444874459", "bodyText": "@saarimrahman @rahulvudutala All of the functions in here need to return an array of assertions so that they all get reported back (as opposed to JUnit, where you only have to call test functions).\nSo this should be:\n  return [\n    test.assertEqual(101, response.results[0].primaryKey.propertyValue),\n    test.assertEqual(\"customerId\", response.results[0].primaryKey.propertyPath),\n    test.assertEqual(101, response.results[1].primaryKey.propertyValue),\n    test.assertEqual(\"customerId\", response.results[1].primaryKey.propertyPath)\n  ]\n\nThat needs to be done for all of the functions.", "author": "rjrudin", "createdAt": "2020-06-24T12:59:52Z", "path": "marklogic-data-hub/src/test/ml-modules/root/test/suites/data-hub/5/entities/search/addPropertiesToSearchResponse.sjs", "diffHunk": "@@ -373,8 +373,54 @@ function verifyResultsWithoutSelectedProperties() {\n   test.assertEqual(7, response.entityPropertyDefinitions.length);\n }\n \n+function verifyPrimaryKeyWithDefinedEntities() {\n+  const response = {\n+    \"snippet-format\": \"snippet\",\n+    \"total\": 2,\n+    \"results\": [\n+      {\n+        \"index\": 1,\n+        \"uri\": \"/content/jane.json\",\n+      },\n+      {\n+        \"index\": 2,\n+        \"uri\": \"/content/sally.json\",\n+      }\n+    ]\n+  };\n+  entitySearchLib.addPropertiesToSearchResponse(entityName, response);\n+  test.assertEqual(101, response.results[0].primaryKey.propertyValue);", "originalCommit": "267d8974d596366922d55068597ff6ced5afd1f1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "c010037a2c4a26420148d59f2cd6e5b3641c5a50", "url": "https://github.com/marklogic/marklogic-data-hub/commit/c010037a2c4a26420148d59f2cd6e5b3641c5a50", "message": "DHFPROD-5204: added primaryKey value field to searchAPI results response", "committedDate": "2020-06-24T18:44:30Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTEwMjg0MQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4132#discussion_r445102841", "bodyText": "And I think this can just be selectedPropertyMetadata again?", "author": "rjrudin", "createdAt": "2020-06-24T18:53:16Z", "path": "marklogic-data-hub/src/main/resources/ml-modules/root/data-hub/5/entities/entity-search-lib.sjs", "diffHunk": "@@ -55,19 +60,30 @@ function addPropertiesToSearchResponse(entityName, searchResponse, propertiesToD\n       console.log(`Unable to obtain entity instance from document with URI '${result.uri}'; will not add entity properties to its search result`);\n     }\n \n+    let entityDef = entityModel.definitions[entityName];\n     if (instance != null) {\n       const entityInstance = instance[entityName];\n       if (!entityInstance) {\n         console.log(`Unable to obtain entity instance from document with URI '${result.uri}' and entity name '${entityName}'; will not add entity properties to its search result`);\n       } else {\n         selectedPropertyMetadata.forEach(parentProperty => {\n-          result.entityProperties.push(getPropertyValues(parentProperty, entityInstance));\n-        });\n+            result.entityProperties.push(getPropertyValues(parentProperty, entityInstance));\n+            result.primaryKey = getPrimaryValue(entityInstance, entityDef);\n+\n+            // no primaryKey in entity instance, so use URI\n+            if (result.primaryKey === null) {\n+              result.primaryKey = {\n+                \"propertyPath\": \"uri\",\n+                \"propertyValue\": result.uri\n+              }\n+            }\n+          }\n+        );\n       }\n     }\n   });\n   // Make it easy for the client to know which property names were used, and which ones exist\n-  searchResponse.selectedPropertyDefinitions = selectedPropertyMetadata;\n+  searchResponse.selectedPropertyDefinitions = selectedPropertyMetadataFinal;", "originalCommit": "c010037a2c4a26420148d59f2cd6e5b3641c5a50", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTEwMzQwNg==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4132#discussion_r445103406", "bodyText": "I think there's one more scenario to support here - the primaryKey property exists, but it does not have a value. Would be unusual, but could happen. So if entityInstance[primaryKey] is null or an empty string, return null here as well.", "author": "rjrudin", "createdAt": "2020-06-24T18:54:22Z", "path": "marklogic-data-hub/src/main/resources/ml-modules/root/data-hub/5/entities/entity-search-lib.sjs", "diffHunk": "@@ -269,6 +285,23 @@ function getPropertyValues(currentProperty, entityInstance) {\n   return resultObject;\n }\n \n+// returns null to use uri\n+function getPrimaryValue(entityInstance, entityDefinition) {\n+  let primaryKeyData = {}\n+  if (entityDefinition.hasOwnProperty(\"primaryKey\")) {\n+    let primaryKey = entityDefinition.primaryKey;\n+    if (entityInstance.hasOwnProperty((primaryKey))) {\n+      primaryKeyData.propertyPath = primaryKey;\n+      primaryKeyData.propertyValue = entityInstance[primaryKey];", "originalCommit": "c010037a2c4a26420148d59f2cd6e5b3641c5a50", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "559509053f075aced6f207202e5063d422b284a9", "url": "https://github.com/marklogic/marklogic-data-hub/commit/559509053f075aced6f207202e5063d422b284a9", "message": "DHFPROD-5204: added primaryKey value field to searchAPI results response", "committedDate": "2020-06-24T19:13:37Z", "type": "forcePushed"}, {"oid": "b7694ebe2d7a32feda1f5d19862b132905b52bb1", "url": "https://github.com/marklogic/marklogic-data-hub/commit/b7694ebe2d7a32feda1f5d19862b132905b52bb1", "message": "DHFPROD-5204: added primaryKey value field to searchAPI results response", "committedDate": "2020-06-24T20:02:48Z", "type": "commit"}, {"oid": "b7694ebe2d7a32feda1f5d19862b132905b52bb1", "url": "https://github.com/marklogic/marklogic-data-hub/commit/b7694ebe2d7a32feda1f5d19862b132905b52bb1", "message": "DHFPROD-5204: added primaryKey value field to searchAPI results response", "committedDate": "2020-06-24T20:02:48Z", "type": "forcePushed"}]}