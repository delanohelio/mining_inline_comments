{"pr_number": 4868, "pr_title": "DHFPROD-6218:Throw 404 or 400 instead of 500 when backend operation cannot find something", "pr_createdAt": "2020-11-16T21:19:18Z", "pr_url": "https://github.com/marklogic/marklogic-data-hub/pull/4868", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDczMTIxOA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4868#discussion_r524731218", "bodyText": "Let's convert this to use ds-util.sjs too. That library of course is a little mis-named now - we may want to rename it to \"http-util.sjs\", since the functions are generic to HTTP. But the more error handling that's routed through those functions, the better, as it makes it easier for us to track where we're throwing errors. And of course, it reduces duplication of the usage of RESTAPI-SRVEXERR.", "author": "rjrudin", "createdAt": "2020-11-16T23:16:01Z", "path": "marklogic-data-hub/src/main/resources/ml-modules/root/data-hub/4/transforms/mlcp-flow-transform.sjs", "diffHunk": "@@ -49,7 +49,7 @@ function transform(content, context) {\n   let flow = flowlib.getFlow(entityName, flowName, consts.INPUT_FLOW);\n \n   if (!flow) {\n-    fn.error(null, \"RESTAPI-SRVEXERR\", \"The specified flow \" + params.flow + \" is missing.\");\n+    fn.error(null, \"RESTAPI-SRVEXERR\", Sequence.from([404, \"Not Found\", \"The specified flow \" + params.flow + \" is missing.\"]));", "originalCommit": "5246e8319604604921b8bdf5759c02d88eeb50e3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDgwNjA5NQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4868#discussion_r524806095", "bodyText": "The uri of http-utils.sjs will be /data-hub/5/data-services/http-utils.sjs . Should that be changed to /data-hub/5/impl/http-utils.sjs or /data-hub/5/http-utils.sjs ? I have moved it to /data-hub/5/impl/http-utils.sjs in my latest commit.", "author": "srinathgit", "createdAt": "2020-11-17T00:29:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDczMTIxOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTE1MDEyNw==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4868#discussion_r525150127", "bodyText": "Oh I was saying - don't rename it now, let's take care of that in a separate PR. Sorry for the confusion.", "author": "rjrudin", "createdAt": "2020-11-17T13:25:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDczMTIxOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTM2NDI5OQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4868#discussion_r525364299", "bodyText": "Since we are using it outside of ds, is it ok to rename in this PR itself ?", "author": "srinathgit", "createdAt": "2020-11-17T17:49:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDczMTIxOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTQwMTE2Mg==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4868#discussion_r525401162", "bodyText": "Sure, that's fine. I'm not a fan of the \"impl\" directory (since \"impl\" is meaningless), but putting it in there is consistent with \"hub-utils\" and \"flow-utils\", so that'll work for now.", "author": "rjrudin", "createdAt": "2020-11-17T18:44:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDczMTIxOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTQwMjkyNQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4868#discussion_r525402925", "bodyText": "I think the PR is ready for review then", "author": "srinathgit", "createdAt": "2020-11-17T18:47:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDczMTIxOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDczNjY2NQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4868#discussion_r524736665", "bodyText": "For these, let's add throwNotFoundWithArray(args) and throwBadRequestWithArray(args) so that when a client wants to return multiple things, it's easy to do so.", "author": "rjrudin", "createdAt": "2020-11-16T23:19:14Z", "path": "marklogic-data-hub/src/main/resources/ml-modules/root/data-hub/5/transforms/mlcp-flow-transform.sjs", "diffHunk": "@@ -62,7 +62,7 @@ function transform(content, context = {}) {\n \n     if (!flow) {\n       datahub.debug.log({message: params, type: 'error'});\n-      fn.error(null, \"RESTAPI-SRVEXERR\", Sequence.from([\"DH-FLOWMISSING\", \"The specified flow \" + flowName + \" is missing.\", content.uri]));\n+      fn.error(null, \"RESTAPI-SRVEXERR\", Sequence.from([404, \"DH-FLOWMISSING\", \"The specified flow \" + flowName + \" is missing.\", content.uri]));", "originalCommit": "5246e8319604604921b8bdf5759c02d88eeb50e3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "f74ea547eac25878a862785dcac03462d6df9e3f", "url": "https://github.com/marklogic/marklogic-data-hub/commit/f74ea547eac25878a862785dcac03462d6df9e3f", "message": "DHFPROD-6218:Throw 404 or 400 instead of 500 when backend operation cannot find something", "committedDate": "2020-11-17T04:41:03Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDg4MTE0Nw==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4868#discussion_r524881147", "bodyText": "@rahulvudutala ,\nIn entity-search-lib.sjs line 48, I changed the HTTP error code from 500 to 404. It causes this endpoint to return null instead of exception it used to throw earlier ? let me know if that's ok.", "author": "srinathgit", "createdAt": "2020-11-17T04:44:25Z", "path": "marklogic-data-hub-central/src/test/java/com/marklogic/hub/central/entities/search/EntitySearchManagerTest.java", "diffHunk": "@@ -96,7 +96,7 @@ public void testSearchResultsOnNonExistentEntityModel() {\n \n         SearchQuery searchQuery = new SearchQuery();\n         searchQuery.getQuery().setEntityTypeIds(Arrays.asList(\"Some-entityType\"));\n-        assertThrows(MarkLogicServerException.class, () -> new EntitySearchManager(getHubClient()).search(searchQuery), \"Entity Model with name Some-entityType doesn't exist \");\n+        assertNull(new EntitySearchManager(getHubClient()).search(searchQuery), \"Entity Model with name Some-entityType doesn't exist \");", "originalCommit": "f74ea547eac25878a862785dcac03462d6df9e3f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTUxNjY5NA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4868#discussion_r525516694", "bodyText": "Yeah it should be ok.", "author": "rahulvudutala", "createdAt": "2020-11-17T20:52:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDg4MTE0Nw=="}], "type": "inlineReview"}, {"oid": "719ccc9958d1098ca4af126bc2c3d0b5ce54611d", "url": "https://github.com/marklogic/marklogic-data-hub/commit/719ccc9958d1098ca4af126bc2c3d0b5ce54611d", "message": "DHFPROD-6218:Throw 404 or 400 instead of 500 when backend operation cannot find something", "committedDate": "2020-11-17T20:59:39Z", "type": "forcePushed"}, {"oid": "75225834e6db8824340d8ed0f183ea917030b66f", "url": "https://github.com/marklogic/marklogic-data-hub/commit/75225834e6db8824340d8ed0f183ea917030b66f", "message": "DHFPROD-6218:Throw 404 or 400 instead of 500 when backend operation cannot find something", "committedDate": "2020-11-18T00:10:49Z", "type": "commit"}, {"oid": "75225834e6db8824340d8ed0f183ea917030b66f", "url": "https://github.com/marklogic/marklogic-data-hub/commit/75225834e6db8824340d8ed0f183ea917030b66f", "message": "DHFPROD-6218:Throw 404 or 400 instead of 500 when backend operation cannot find something", "committedDate": "2020-11-18T00:10:49Z", "type": "forcePushed"}]}