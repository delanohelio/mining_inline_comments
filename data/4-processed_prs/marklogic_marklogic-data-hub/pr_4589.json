{"pr_number": 4589, "pr_title": "DHFPROD-5991:Add test to run flow with stemming searches set to advanced", "pr_createdAt": "2020-09-17T20:59:31Z", "pr_url": "https://github.com/marklogic/marklogic-data-hub/pull/4589", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDYwNTA1MQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4589#discussion_r490605051", "bodyText": "Just call this \"hubConfig\", as \"adminConfig\" implies it's an admin user.", "author": "rjrudin", "createdAt": "2020-09-17T22:51:40Z", "path": "marklogic-data-hub/src/test/java/com/marklogic/hub/flow/impl/FlowRunnerTest.java", "diffHunk": "@@ -81,6 +83,32 @@ public void testRunFlow() {\n         Assertions.assertTrue(file.contains(\"ingest.csv\"));\n     }\n \n+    @Test\n+    void runFlowWithStemmingSearch(){\n+        try{\n+            updateStemmingOnStagingDb(true);\n+            testRunFlow();\n+        }\n+        finally {\n+            updateStemmingOnStagingDb(false);\n+        }\n+\n+    }\n+\n+    private void updateStemmingOnStagingDb(boolean enableStemming) {\n+        HubConfig adminConfig = runAsDataHubDeveloper();", "originalCommit": "1a5bb5dbd8c48f7183eec83ef1399149a765b6b2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDYwNjA1MA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4589#discussion_r490606050", "bodyText": "Initially, I thought I needed to get runAsAdmin(), so had it named 'adminConfig' but later realized I could do it as developer, but forgot to rename it. Will do", "author": "srinathgit", "createdAt": "2020-09-17T22:54:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDYwNTA1MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDYwNTI3OQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4589#discussion_r490605279", "bodyText": "Does this break on the nightly?", "author": "rjrudin", "createdAt": "2020-09-17T22:52:16Z", "path": "marklogic-data-hub/src/test/java/com/marklogic/hub/flow/impl/FlowRunnerTest.java", "diffHunk": "@@ -81,6 +83,32 @@ public void testRunFlow() {\n         Assertions.assertTrue(file.contains(\"ingest.csv\"));\n     }\n \n+    @Test\n+    void runFlowWithStemmingSearch(){\n+        try{\n+            updateStemmingOnStagingDb(true);\n+            testRunFlow();", "originalCommit": "1a5bb5dbd8c48f7183eec83ef1399149a765b6b2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDYwNjE0Mw==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4589#discussion_r490606143", "bodyText": "Yes, it breaks in today's nightly build", "author": "srinathgit", "createdAt": "2020-09-17T22:54:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDYwNTI3OQ=="}], "type": "inlineReview"}, {"oid": "3a46ed8a782846d5529a83c35febb703bb3cd8f3", "url": "https://github.com/marklogic/marklogic-data-hub/commit/3a46ed8a782846d5529a83c35febb703bb3cd8f3", "message": "DHFPROD-5991:Add test to run flow with stemming searches set to \"advanced\"", "committedDate": "2020-09-17T22:56:43Z", "type": "forcePushed"}, {"oid": "3ee5021d8c3c4641c949995cac04a4b8db577a57", "url": "https://github.com/marklogic/marklogic-data-hub/commit/3ee5021d8c3c4641c949995cac04a4b8db577a57", "message": "DHFPROD-5991:Add test to run flow with stemming searches set to \"advanced\"", "committedDate": "2020-09-19T07:05:50Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjI5NjY0NQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4589#discussion_r492296645", "bodyText": "You can use \"sleep\" in the parent class so you don't have to deal with InterruptedException.", "author": "rjrudin", "createdAt": "2020-09-21T19:29:33Z", "path": "marklogic-data-hub/src/test/java/com/marklogic/hub/flow/impl/FlowRunnerTest.java", "diffHunk": "@@ -81,6 +84,89 @@ public void testRunFlow() {\n         Assertions.assertTrue(file.contains(\"ingest.csv\"));\n     }\n \n+    /*\n+     https://bugtrack.marklogic.com/54003\n+     When stemmed search is set to \"advanced\", fetching step definition fails and hence running flow would fail in all server versions.\n+     After that if db is re-indexed, fetching flow succeeds in versions < 10.0-4 and fails in version >=10.0-5 and nightly server.\n+     With this server fix, fetching step definition, legacy mappings (and other artifacts ?) would fail and the json property value\n+     query requires 'lang=zxx' to be included in order to ensure artifacts can be fetched if stemming (and/or reindexing is done) is turned on.\n+     */\n+    @Test\n+    void runFlowWithStemmingSearch() throws InterruptedException {\n+        Versions.MarkLogicVersion mlVersion = versions.getMLVersion();\n+        Assumptions.assumeTrue(mlVersion.getMajor() >=10);\n+        HubConfig hubConfig = runAsDataHubDeveloper();\n+        try{\n+            updateStemmingOnStagingDb(hubConfig,true);\n+            RunFlowResponse resp = runFlow();\n+            Assertions.assertTrue(JobStatus.STOP_ON_ERROR.toString().equalsIgnoreCase(resp.getJobStatus()));\n+            hubConfig = runAsDataHubDeveloper();\n+            DatabaseManager dbManager = new DatabaseManager(hubConfig.getManageClient());\n+            dbManager.reindexDatabase(hubConfig.getDbName(DatabaseKind.STAGING));\n+            String query = \"(\\n\" +\n+                \"  for $forest-id in xdmp:database-forests(xdmp:database('data-hub-STAGING'))\\n\" +\n+                \"  return xdmp:forest-status($forest-id)//*:reindexing\\n\" +\n+                \") = fn:true()\";\n+            StringHandle stringHandle;\n+            String status;\n+            int attempts = 5;\n+            do{\n+                Thread.sleep(5000L);", "originalCommit": "3ee5021d8c3c4641c949995cac04a4b8db577a57", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjI5NzIyNQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4589#discussion_r492297225", "bodyText": "Also, let's get this all into a separate method called \"waitForReindexingToFinish\". And limit the sleep to maybe 500ms or so - the call to check on it is extremely fast, so we want this loop to finish as soon as the reindexer is done.", "author": "rjrudin", "createdAt": "2020-09-21T19:30:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjI5NjY0NQ=="}], "type": "inlineReview"}, {"oid": "d8a56647475175ae56d315bfb59d18e8b6a515be", "url": "https://github.com/marklogic/marklogic-data-hub/commit/d8a56647475175ae56d315bfb59d18e8b6a515be", "message": "DHFPROD-5991:Add test to run flow with stemming searches set to advanced and db reindexed", "committedDate": "2020-09-29T07:11:24Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjY3NDg5Ng==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4589#discussion_r496674896", "bodyText": "For consistency, can you name this \"RunFlowWithStemmingEnabledTest\"?", "author": "rjrudin", "createdAt": "2020-09-29T12:27:40Z", "path": "marklogic-data-hub/src/test/java/com/marklogic/hub/flow/impl/StemmingTest.java", "diffHunk": "@@ -0,0 +1,102 @@\n+package com.marklogic.hub.flow.impl;\n+\n+import com.marklogic.client.io.StringHandle;\n+import com.marklogic.hub.AbstractHubCoreTest;\n+import com.marklogic.hub.DatabaseKind;\n+import com.marklogic.hub.HubConfig;\n+import com.marklogic.hub.flow.RunFlowResponse;\n+import com.marklogic.hub.impl.Versions;\n+import com.marklogic.hub.job.JobStatus;\n+import com.marklogic.mgmt.api.API;\n+import com.marklogic.mgmt.api.database.Database;\n+import com.marklogic.mgmt.resource.databases.DatabaseManager;\n+import org.junit.jupiter.api.Assertions;\n+import org.junit.jupiter.api.Assumptions;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.springframework.beans.factory.annotation.Autowired;\n+\n+import static org.junit.jupiter.api.Assertions.fail;\n+\n+public class StemmingTest extends AbstractHubCoreTest {", "originalCommit": "d8a56647475175ae56d315bfb59d18e8b6a515be", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjY3NTczNg==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4589#discussion_r496675736", "bodyText": "Should this go to develop or 5.4-develop - is there any benefit having it on develop?\nIf you go to 5.4-develop, you can use the runFlow method that handles everything for you. Actually, that's on develop too.\nIn any case, don't use Autowired here - that can causes problems with parallel tests since FlowRunnerImpl isn't a thread-safe class.", "author": "rjrudin", "createdAt": "2020-09-29T12:29:02Z", "path": "marklogic-data-hub/src/test/java/com/marklogic/hub/flow/impl/StemmingTest.java", "diffHunk": "@@ -0,0 +1,102 @@\n+package com.marklogic.hub.flow.impl;\n+\n+import com.marklogic.client.io.StringHandle;\n+import com.marklogic.hub.AbstractHubCoreTest;\n+import com.marklogic.hub.DatabaseKind;\n+import com.marklogic.hub.HubConfig;\n+import com.marklogic.hub.flow.RunFlowResponse;\n+import com.marklogic.hub.impl.Versions;\n+import com.marklogic.hub.job.JobStatus;\n+import com.marklogic.mgmt.api.API;\n+import com.marklogic.mgmt.api.database.Database;\n+import com.marklogic.mgmt.resource.databases.DatabaseManager;\n+import org.junit.jupiter.api.Assertions;\n+import org.junit.jupiter.api.Assumptions;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.springframework.beans.factory.annotation.Autowired;\n+\n+import static org.junit.jupiter.api.Assertions.fail;\n+\n+public class StemmingTest extends AbstractHubCoreTest {\n+\n+    Database db;\n+    @Autowired\n+    FlowRunnerImpl flowRunner;", "originalCommit": "d8a56647475175ae56d315bfb59d18e8b6a515be", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjY3NTk3Nw==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4589#discussion_r496675977", "bodyText": "Just curious, shouldn't a data-hub-developer be able to do this?", "author": "rjrudin", "createdAt": "2020-09-29T12:29:27Z", "path": "marklogic-data-hub/src/test/java/com/marklogic/hub/flow/impl/StemmingTest.java", "diffHunk": "@@ -0,0 +1,102 @@\n+package com.marklogic.hub.flow.impl;\n+\n+import com.marklogic.client.io.StringHandle;\n+import com.marklogic.hub.AbstractHubCoreTest;\n+import com.marklogic.hub.DatabaseKind;\n+import com.marklogic.hub.HubConfig;\n+import com.marklogic.hub.flow.RunFlowResponse;\n+import com.marklogic.hub.impl.Versions;\n+import com.marklogic.hub.job.JobStatus;\n+import com.marklogic.mgmt.api.API;\n+import com.marklogic.mgmt.api.database.Database;\n+import com.marklogic.mgmt.resource.databases.DatabaseManager;\n+import org.junit.jupiter.api.Assertions;\n+import org.junit.jupiter.api.Assumptions;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.springframework.beans.factory.annotation.Autowired;\n+\n+import static org.junit.jupiter.api.Assertions.fail;\n+\n+public class StemmingTest extends AbstractHubCoreTest {\n+\n+    Database db;\n+    @Autowired\n+    FlowRunnerImpl flowRunner;\n+\n+    @BeforeEach\n+    public void setupEach() {\n+        HubConfig hubConfig = runAsAdmin();", "originalCommit": "d8a56647475175ae56d315bfb59d18e8b6a515be", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjY3NzQ0Mw==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4589#discussion_r496677443", "bodyText": "assertTrue/False should really only be used when you're testing against a boolean variable. The problem is that if this fails, you don't see what the two values are.\nWhen you're not sure about case, just lowercase both, though you don't need to do that since JobStatus is already lowercased - so e.g. assertEquals(JobStatus.STOP_ON_ERROR.toString(), resp.getJobStatus().toLowerCase())", "author": "rjrudin", "createdAt": "2020-09-29T12:31:45Z", "path": "marklogic-data-hub/src/test/java/com/marklogic/hub/flow/impl/StemmingTest.java", "diffHunk": "@@ -0,0 +1,102 @@\n+package com.marklogic.hub.flow.impl;\n+\n+import com.marklogic.client.io.StringHandle;\n+import com.marklogic.hub.AbstractHubCoreTest;\n+import com.marklogic.hub.DatabaseKind;\n+import com.marklogic.hub.HubConfig;\n+import com.marklogic.hub.flow.RunFlowResponse;\n+import com.marklogic.hub.impl.Versions;\n+import com.marklogic.hub.job.JobStatus;\n+import com.marklogic.mgmt.api.API;\n+import com.marklogic.mgmt.api.database.Database;\n+import com.marklogic.mgmt.resource.databases.DatabaseManager;\n+import org.junit.jupiter.api.Assertions;\n+import org.junit.jupiter.api.Assumptions;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.springframework.beans.factory.annotation.Autowired;\n+\n+import static org.junit.jupiter.api.Assertions.fail;\n+\n+public class StemmingTest extends AbstractHubCoreTest {\n+\n+    Database db;\n+    @Autowired\n+    FlowRunnerImpl flowRunner;\n+\n+    @BeforeEach\n+    public void setupEach() {\n+        HubConfig hubConfig = runAsAdmin();\n+        db = new Database(new API(hubConfig.getManageClient()), hubConfig.getDbName(DatabaseKind.STAGING));\n+        db.setStemmedSearches(\"advanced\");\n+        db.save();\n+        installProjectInFolder(\"flow-runner-test\");\n+    }\n+    /*\n+     https://bugtrack.marklogic.com/54003\n+     When stemmed search is set to \"advanced\", fetching legacy mappings (and/or step definition) fails and hence running\n+     testFlow would fail. After that if db is reindexed, fetching of artifacts succeeds. In order to apply the fix for\n+     bug 54003 in server, \"Reindex JSON language property\u201d trace event has to be added and the test should be run on\n+     nightly servers. With the fix applied, the flow will fail after reindexing as well as queries requires 'lang=zxx'\n+     to be included so as to fetch artifacts.\n+     */\n+    @Test\n+    void runFlowWithStemmingSearch() {\n+        Versions.MarkLogicVersion mlVersion = versions.getMLVersion();\n+        Assumptions.assumeTrue(mlVersion.getMajor() >=10);\n+\n+        try{\n+            RunFlowResponse resp = runFlow();\n+            Assertions.assertTrue(JobStatus.STOP_ON_ERROR.toString().equalsIgnoreCase(resp.getJobStatus()));", "originalCommit": "d8a56647475175ae56d315bfb59d18e8b6a515be", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjY3OTA0Mw==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4589#discussion_r496679043", "bodyText": "If this is reliable, I think it's a good thing to move up to AbstractHubTest. But for consistency, do \"Reindex\" instead of \"ReIndex\", as ML treats it as one word.\nI'm also going to open a ticket for this in ml-app-deployer, this would be a nice feature to have in there - e.g. new Database(...).waitForReindex().", "author": "rjrudin", "createdAt": "2020-09-29T12:34:23Z", "path": "marklogic-data-hub/src/test/java/com/marklogic/hub/flow/impl/StemmingTest.java", "diffHunk": "@@ -0,0 +1,102 @@\n+package com.marklogic.hub.flow.impl;\n+\n+import com.marklogic.client.io.StringHandle;\n+import com.marklogic.hub.AbstractHubCoreTest;\n+import com.marklogic.hub.DatabaseKind;\n+import com.marklogic.hub.HubConfig;\n+import com.marklogic.hub.flow.RunFlowResponse;\n+import com.marklogic.hub.impl.Versions;\n+import com.marklogic.hub.job.JobStatus;\n+import com.marklogic.mgmt.api.API;\n+import com.marklogic.mgmt.api.database.Database;\n+import com.marklogic.mgmt.resource.databases.DatabaseManager;\n+import org.junit.jupiter.api.Assertions;\n+import org.junit.jupiter.api.Assumptions;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.springframework.beans.factory.annotation.Autowired;\n+\n+import static org.junit.jupiter.api.Assertions.fail;\n+\n+public class StemmingTest extends AbstractHubCoreTest {\n+\n+    Database db;\n+    @Autowired\n+    FlowRunnerImpl flowRunner;\n+\n+    @BeforeEach\n+    public void setupEach() {\n+        HubConfig hubConfig = runAsAdmin();\n+        db = new Database(new API(hubConfig.getManageClient()), hubConfig.getDbName(DatabaseKind.STAGING));\n+        db.setStemmedSearches(\"advanced\");\n+        db.save();\n+        installProjectInFolder(\"flow-runner-test\");\n+    }\n+    /*\n+     https://bugtrack.marklogic.com/54003\n+     When stemmed search is set to \"advanced\", fetching legacy mappings (and/or step definition) fails and hence running\n+     testFlow would fail. After that if db is reindexed, fetching of artifacts succeeds. In order to apply the fix for\n+     bug 54003 in server, \"Reindex JSON language property\u201d trace event has to be added and the test should be run on\n+     nightly servers. With the fix applied, the flow will fail after reindexing as well as queries requires 'lang=zxx'\n+     to be included so as to fetch artifacts.\n+     */\n+    @Test\n+    void runFlowWithStemmingSearch() {\n+        Versions.MarkLogicVersion mlVersion = versions.getMLVersion();\n+        Assumptions.assumeTrue(mlVersion.getMajor() >=10);\n+\n+        try{\n+            RunFlowResponse resp = runFlow();\n+            Assertions.assertTrue(JobStatus.STOP_ON_ERROR.toString().equalsIgnoreCase(resp.getJobStatus()));\n+\n+            HubConfig hubConfig = runAsAdmin();\n+            DatabaseManager dbManager = new DatabaseManager(hubConfig.getManageClient());\n+            dbManager.reindexDatabase(hubConfig.getDbName(DatabaseKind.STAGING));\n+\n+            waitForReIndex(runAsAdmin());\n+            resp = runFlow();\n+            Assertions.assertTrue(JobStatus.FINISHED.toString().equalsIgnoreCase(resp.getJobStatus()));\n+\n+        }\n+        finally {\n+            db.setStemmedSearches(\"off\");\n+            db.save();\n+        }\n+    }\n+\n+    private RunFlowResponse runFlow(){\n+        runAsDataHubOperator();\n+        RunFlowResponse resp = null;\n+        try{\n+            resp = flowRunner.runFlow(\"testFlow\", null, null, null, null);\n+        }\n+        catch (Exception e){\n+            logger.error(\"Flow run failed;cause: \"+ e.getMessage());\n+        }\n+\n+        flowRunner.awaitCompletion();\n+        return resp;\n+    }\n+\n+    private void waitForReIndex(HubConfig hubConfig){", "originalCommit": "d8a56647475175ae56d315bfb59d18e8b6a515be", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjY4MDA1MA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4589#discussion_r496680050", "bodyText": "One tweak to make this simpler:\nString status = hubConfig...xquery(query).evalAs(String.class);\n\nThen you don't need a StringHandle, nor do you need to fiddle with an iterator.", "author": "rjrudin", "createdAt": "2020-09-29T12:35:57Z", "path": "marklogic-data-hub/src/test/java/com/marklogic/hub/flow/impl/StemmingTest.java", "diffHunk": "@@ -0,0 +1,102 @@\n+package com.marklogic.hub.flow.impl;\n+\n+import com.marklogic.client.io.StringHandle;\n+import com.marklogic.hub.AbstractHubCoreTest;\n+import com.marklogic.hub.DatabaseKind;\n+import com.marklogic.hub.HubConfig;\n+import com.marklogic.hub.flow.RunFlowResponse;\n+import com.marklogic.hub.impl.Versions;\n+import com.marklogic.hub.job.JobStatus;\n+import com.marklogic.mgmt.api.API;\n+import com.marklogic.mgmt.api.database.Database;\n+import com.marklogic.mgmt.resource.databases.DatabaseManager;\n+import org.junit.jupiter.api.Assertions;\n+import org.junit.jupiter.api.Assumptions;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.springframework.beans.factory.annotation.Autowired;\n+\n+import static org.junit.jupiter.api.Assertions.fail;\n+\n+public class StemmingTest extends AbstractHubCoreTest {\n+\n+    Database db;\n+    @Autowired\n+    FlowRunnerImpl flowRunner;\n+\n+    @BeforeEach\n+    public void setupEach() {\n+        HubConfig hubConfig = runAsAdmin();\n+        db = new Database(new API(hubConfig.getManageClient()), hubConfig.getDbName(DatabaseKind.STAGING));\n+        db.setStemmedSearches(\"advanced\");\n+        db.save();\n+        installProjectInFolder(\"flow-runner-test\");\n+    }\n+    /*\n+     https://bugtrack.marklogic.com/54003\n+     When stemmed search is set to \"advanced\", fetching legacy mappings (and/or step definition) fails and hence running\n+     testFlow would fail. After that if db is reindexed, fetching of artifacts succeeds. In order to apply the fix for\n+     bug 54003 in server, \"Reindex JSON language property\u201d trace event has to be added and the test should be run on\n+     nightly servers. With the fix applied, the flow will fail after reindexing as well as queries requires 'lang=zxx'\n+     to be included so as to fetch artifacts.\n+     */\n+    @Test\n+    void runFlowWithStemmingSearch() {\n+        Versions.MarkLogicVersion mlVersion = versions.getMLVersion();\n+        Assumptions.assumeTrue(mlVersion.getMajor() >=10);\n+\n+        try{\n+            RunFlowResponse resp = runFlow();\n+            Assertions.assertTrue(JobStatus.STOP_ON_ERROR.toString().equalsIgnoreCase(resp.getJobStatus()));\n+\n+            HubConfig hubConfig = runAsAdmin();\n+            DatabaseManager dbManager = new DatabaseManager(hubConfig.getManageClient());\n+            dbManager.reindexDatabase(hubConfig.getDbName(DatabaseKind.STAGING));\n+\n+            waitForReIndex(runAsAdmin());\n+            resp = runFlow();\n+            Assertions.assertTrue(JobStatus.FINISHED.toString().equalsIgnoreCase(resp.getJobStatus()));\n+\n+        }\n+        finally {\n+            db.setStemmedSearches(\"off\");\n+            db.save();\n+        }\n+    }\n+\n+    private RunFlowResponse runFlow(){\n+        runAsDataHubOperator();\n+        RunFlowResponse resp = null;\n+        try{\n+            resp = flowRunner.runFlow(\"testFlow\", null, null, null, null);\n+        }\n+        catch (Exception e){\n+            logger.error(\"Flow run failed;cause: \"+ e.getMessage());\n+        }\n+\n+        flowRunner.awaitCompletion();\n+        return resp;\n+    }\n+\n+    private void waitForReIndex(HubConfig hubConfig){\n+        String query = \"(\\n\" +\n+            \"  for $forest-id in xdmp:database-forests(xdmp:database('data-hub-STAGING'))\\n\" +\n+            \"  return xdmp:forest-status($forest-id)//*:reindexing\\n\" +\n+            \") = fn:true()\";\n+        StringHandle stringHandle;\n+        String status;\n+        int attempts = 1;\n+        do{\n+            sleep(1000L);\n+            stringHandle = new StringHandle();\n+            hubConfig.newStagingClient().newServerEval().xquery(query).eval().next().get(stringHandle);", "originalCommit": "d8a56647475175ae56d315bfb59d18e8b6a515be", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "57a9174f56859021f92b9ada57f478b291f634f7", "url": "https://github.com/marklogic/marklogic-data-hub/commit/57a9174f56859021f92b9ada57f478b291f634f7", "message": "DHFPROD-5991:Add test to run flow with stemming searches set to advanced", "committedDate": "2020-09-29T18:48:09Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njk2ODQ2MQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4589#discussion_r496968461", "bodyText": "I believe there's an issue here in that if the version of ML isn't supported, then the call to set stemmed searches to \"off\" won't be executed. So I'd just move this to the test.\nIn fact, I think private methods can make this read nicely:\n\nenableAdvancedStemming();\nrun the flow and verify an error occurs (I think it'd be good to assert on the contents of stepOutput too, as we can verify there are words in there indicating that a step definition was not found)\nreindexDatabase()\nrun the flow again and verify it succeeds", "author": "rjrudin", "createdAt": "2020-09-29T18:59:35Z", "path": "marklogic-data-hub/src/test/java/com/marklogic/hub/flow/impl/RunFlowWithStemmingEnabledTest.java", "diffHunk": "@@ -0,0 +1,61 @@\n+package com.marklogic.hub.flow.impl;\n+\n+import com.marklogic.hub.AbstractHubCoreTest;\n+import com.marklogic.hub.DatabaseKind;\n+import com.marklogic.hub.HubConfig;\n+import com.marklogic.hub.flow.FlowInputs;\n+import com.marklogic.hub.flow.RunFlowResponse;\n+import com.marklogic.hub.impl.Versions;\n+import com.marklogic.hub.job.JobStatus;\n+import com.marklogic.mgmt.api.API;\n+import com.marklogic.mgmt.api.database.Database;\n+import com.marklogic.mgmt.resource.databases.DatabaseManager;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+import static org.junit.jupiter.api.Assumptions.assumeTrue;\n+\n+public class RunFlowWithStemmingEnabledTest extends AbstractHubCoreTest {\n+\n+    Database db;\n+\n+    @BeforeEach\n+    public void setupEach() {\n+        HubConfig hubConfig = runAsDataHubDeveloper();", "originalCommit": "57a9174f56859021f92b9ada57f478b291f634f7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njk5NTIwNw==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4589#discussion_r496995207", "bodyText": "I think moving assumeTrue(new Versions(getHubConfig()).getMLVersion().getMajor() >= 10);  to the first line of setupEach () should resolve that issue right ?", "author": "srinathgit", "createdAt": "2020-09-29T19:34:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njk2ODQ2MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njk5NjM2Ng==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4589#discussion_r496996366", "bodyText": "Since you only have the one test method, I think it's simpler to just put everything in that method. But if you want to keep the BeforeEach method, then I think assumeTrue will do the trick there.", "author": "rjrudin", "createdAt": "2020-09-29T19:36:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njk2ODQ2MQ=="}], "type": "inlineReview"}, {"oid": "78c578a4b8e868ddc02ee2fee37bd04e3454b608", "url": "https://github.com/marklogic/marklogic-data-hub/commit/78c578a4b8e868ddc02ee2fee37bd04e3454b608", "message": "DHFPROD-5991:Add test to run flow with stemming searches set to advanced", "committedDate": "2020-09-29T20:20:23Z", "type": "forcePushed"}, {"oid": "c868453ada34a281185a49e049a8c2430312cb69", "url": "https://github.com/marklogic/marklogic-data-hub/commit/c868453ada34a281185a49e049a8c2430312cb69", "message": "DHFPROD-5991:Add test to run flow with stemming searches set to advanced", "committedDate": "2020-09-30T00:46:07Z", "type": "forcePushed"}, {"oid": "3ab680ad831e7c533e049472639d7fae15e8a96a", "url": "https://github.com/marklogic/marklogic-data-hub/commit/3ab680ad831e7c533e049472639d7fae15e8a96a", "message": "DHFPROD-5991:Add test to run flow with stemming searches set to advanced", "committedDate": "2020-09-30T07:18:21Z", "type": "forcePushed"}, {"oid": "526d065be6d46a89277d07a826202f973ee03e5d", "url": "https://github.com/marklogic/marklogic-data-hub/commit/526d065be6d46a89277d07a826202f973ee03e5d", "message": "DHFPROD-5991:Add test to run flow with stemming searches set to advanced", "committedDate": "2020-09-30T07:21:58Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzI5NDY3Nw==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4589#discussion_r497294677", "bodyText": "The test keeps failing in the pipeline even though it passed in my local. I am increasing the sleep time to see of if the test passes. I will then work to see why the query isn't reliable.", "author": "srinathgit", "createdAt": "2020-09-30T07:23:26Z", "path": "marklogic-data-hub/src/testFixtures/java/com/marklogic/hub/test/AbstractHubTest.java", "diffHunk": "@@ -529,6 +529,26 @@ protected RunFlowResponse runFlow(FlowInputs flowInputs) {\n         return response;\n     }\n \n+    protected void waitForReindex(HubConfig hubConfig, String database){\n+        String query = \"(\\n\" +\n+            \"  for $forest-id in xdmp:database-forests(xdmp:database('\" + database + \"'))\\n\" +\n+            \"  return xdmp:forest-status($forest-id)//*:reindexing\\n\" +\n+            \") = fn:true()\";\n+        String status;\n+        int attempts = 0;\n+        do{\n+            sleep(15000L);", "originalCommit": "526d065be6d46a89277d07a826202f973ee03e5d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzQ5ODE4Mg==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4589#discussion_r497498182", "bodyText": "You could try running this as a little main program (not the test itself, just this code - we don't want to clear the database) against the HC nightly index, just to test against an ML instance that isn't running on your laptop. I recommend checking with the DB team too to see if there's a recommended script for checking to see if the database is reindexing or not.", "author": "rjrudin", "createdAt": "2020-09-30T13:13:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzI5NDY3Nw=="}], "type": "inlineReview"}, {"oid": "606a70356068d8556ba803c1e53fc887e9fe5805", "url": "https://github.com/marklogic/marklogic-data-hub/commit/606a70356068d8556ba803c1e53fc887e9fe5805", "message": "DHFPROD-5991:Add test to run flow with stemming searches set to advanced", "committedDate": "2020-09-30T23:20:01Z", "type": "forcePushed"}, {"oid": "fdeb041614039138027faeb3d27b45948bdbf8ea", "url": "https://github.com/marklogic/marklogic-data-hub/commit/fdeb041614039138027faeb3d27b45948bdbf8ea", "message": "DHFPROD-5991:Add test to run flow with stemming searches set to advanced", "committedDate": "2020-10-01T16:40:50Z", "type": "commit"}, {"oid": "fdeb041614039138027faeb3d27b45948bdbf8ea", "url": "https://github.com/marklogic/marklogic-data-hub/commit/fdeb041614039138027faeb3d27b45948bdbf8ea", "message": "DHFPROD-5991:Add test to run flow with stemming searches set to advanced", "committedDate": "2020-10-01T16:40:50Z", "type": "forcePushed"}]}