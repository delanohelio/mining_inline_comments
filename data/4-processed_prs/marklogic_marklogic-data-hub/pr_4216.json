{"pr_number": 4216, "pr_title": "DHFPROD-5018: Enable faceting for entity properties marked \"facet-able\" via modeling", "pr_createdAt": "2020-07-15T00:46:04Z", "pr_url": "https://github.com/marklogic/marklogic-data-hub/pull/4216", "timeline": [{"oid": "a3fc9d0958b21c7f41b75332112f4e83323d21e1", "url": "https://github.com/marklogic/marklogic-data-hub/commit/a3fc9d0958b21c7f41b75332112f4e83323d21e1", "message": "DHFPROD-5018: Enable faceting for entity properties marked \"facet-able\" via modeling", "committedDate": "2020-07-15T14:15:30Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTE1OTQxOQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4216#discussion_r455159419", "bodyText": "I think this function deserves a comment, because for a new developer, it begs the question - Wait, aren't range indexes already supported in the model?\nWe want to make it immediately clear that the intent here is to support the custom DHF properties of facetable (and eventually sortable) by adding range indexes based on their existence.", "author": "rjrudin", "createdAt": "2020-07-15T15:57:28Z", "path": "marklogic-data-hub/src/main/resources/ml-modules/root/data-hub/5/impl/hub-entities.xqy", "diffHunk": "@@ -523,3 +525,42 @@ declare function hent:json-schema-generate($entity-title as xs:string, $uber-mod\n   )\n   return xdmp:to-json($uber-model)\n };\n+\n+declare %private function hent:add-range-indexes-to-model($entities as json:array) {", "originalCommit": "a3fc9d0958b21c7f41b75332112f4e83323d21e1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTE3MDk1Nw==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4216#discussion_r455170957", "bodyText": "@rjrudin I will add the function level comment", "author": "rahulvudutala", "createdAt": "2020-07-15T16:17:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTE1OTQxOQ=="}], "type": "inlineReview"}, {"oid": "c3e4220cc9c13e53a2f5db7b398cfff795049dbd", "url": "https://github.com/marklogic/marklogic-data-hub/commit/c3e4220cc9c13e53a2f5db7b398cfff795049dbd", "message": "DHFPROD-5018: Enable faceting for entity properties marked \"facet-able\" via modeling", "committedDate": "2020-07-15T17:58:15Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTc0OTkzMQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4216#discussion_r455749931", "bodyText": "I couldn't figure out what this \"else\" block was doing. I removed it locally and then ran the updated tests in this PR, and they still passed. If the top-level property has a \"$ref\", then it's a structured property, in which case we aren't yet supporting facetable on its child properties, right?\nThis was the impl of the for loop that I tested locally (I like using \"where\" to avoid empty \"else\" statements, also think it makes the code more self-documenting):\n(: Iterate over each top-level property and if it's facetable, add it to the rangeIndex array:)\n    let $_ :=\n      for $entity-type-property in map:keys($entity-type-properties)\n      let $ref := map:get($entity-type-properties, $entity-type-property)=>map:get(\"$ref\")\n      where fn:empty($ref)\n      return \n        let $is-facetable :=\n          let $items := map:get($entity-type-properties, $entity-type-property)=>map:get(\"items\")\n          return \n            if (fn:empty($items)) then \n              map:get($entity-type-properties, $entity-type-property)=>map:get(\"facetable\")\n            else \n              fn:not(fn:starts-with(map:get($items, \"$ref\"), \"#\")) and \n              map:get($entity-type-properties, $entity-type-property)=>map:get(\"facetable\")\n        where $is-facetable\n        return json:array-push(map:get($entity-type, \"rangeIndex\"), $entity-type-property)", "author": "rjrudin", "createdAt": "2020-07-16T12:31:30Z", "path": "marklogic-data-hub/src/main/resources/ml-modules/root/data-hub/5/impl/hub-entities.xqy", "diffHunk": "@@ -523,3 +525,47 @@ declare function hent:json-schema-generate($entity-title as xs:string, $uber-mod\n   )\n   return xdmp:to-json($uber-model)\n };\n+\n+(:\n+  this function finds the first level facetable entityType properties and constrcuts and adds the rangeIndex array to\n+  the entityModel. All the structured properties are ignored for now even if a property is modeled as facetable as per\n+  https://project.marklogic.com/jira/browse/DHFPROD-5018\n+:)\n+declare %private function hent:add-indexes-for-entity-properties($entities as json:array) {\n+  let $models := json:array-values($entities) ! xdmp:to-json(.)/object-node()\n+  let $updated-models := json:array()\n+\n+  let $_ :=\n+    for $model as map:map in $models\n+      let $entity-type := map:get($model, \"definitions\")=>map:get(map:get($model, \"info\")=>map:get(\"title\"))\n+      let $entity-type-properties :=\n+        let $empty-map := map:map()\n+          return\n+            if (fn:empty($entity-type)) then\n+              let $_ := xdmp:log(\"Could not find entity definition with name: \" || map:get($model, \"info\")=>map:get(\"title\"))\n+              return $empty-map\n+            else\n+              let $_ :=\n+                if (fn:empty(map:get($entity-type, \"rangeIndex\"))) then map:put($entity-type, \"rangeIndex\", json:array())\n+                else ()\n+              return map:get($entity-type, \"properties\")\n+\n+      let $_ :=\n+        for $entity-type-property in map:keys($entity-type-properties)\n+          let $ref := map:get($entity-type-properties, $entity-type-property)=>map:get(\"$ref\")\n+          let $is-facetable :=\n+            if (fn:empty($ref)) then\n+              let $result :=\n+                let $items := map:get($entity-type-properties, $entity-type-property)=>map:get(\"items\")\n+                return if(fn:empty($items)) then map:get($entity-type-properties, $entity-type-property)=>map:get(\"facetable\")\n+                else fn:not(fn:starts-with(map:get($items, \"$ref\"), \"#\")) and map:get($entity-type-properties, $entity-type-property)=>map:get(\"facetable\")\n+              return $result\n+            else\n+              let $items := map:get($entity-type-properties, $entity-type-property)=>map:get(\"items\")", "originalCommit": "c3e4220cc9c13e53a2f5db7b398cfff795049dbd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTkyNTAxOQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4216#discussion_r455925019", "bodyText": "Addressed them in the latest commit", "author": "rahulvudutala", "createdAt": "2020-07-16T16:43:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTc0OTkzMQ=="}], "type": "inlineReview"}, {"oid": "ff1311105eb08146de39cdacb449932ce83ac257", "url": "https://github.com/marklogic/marklogic-data-hub/commit/ff1311105eb08146de39cdacb449932ce83ac257", "message": "DHFPROD-5018: Enable faceting for entity properties marked \"facet-able\" via modeling", "committedDate": "2020-07-16T16:30:07Z", "type": "forcePushed"}, {"oid": "ac59b809d836592db6dcb0e7f0f5ae70e730b0dc", "url": "https://github.com/marklogic/marklogic-data-hub/commit/ac59b809d836592db6dcb0e7f0f5ae70e730b0dc", "message": "DHFPROD-5018: Enable faceting for entity properties marked \"facet-able\" via modeling", "committedDate": "2020-07-16T16:42:55Z", "type": "commit"}, {"oid": "ac59b809d836592db6dcb0e7f0f5ae70e730b0dc", "url": "https://github.com/marklogic/marklogic-data-hub/commit/ac59b809d836592db6dcb0e7f0f5ae70e730b0dc", "message": "DHFPROD-5018: Enable faceting for entity properties marked \"facet-able\" via modeling", "committedDate": "2020-07-16T16:42:55Z", "type": "forcePushed"}]}