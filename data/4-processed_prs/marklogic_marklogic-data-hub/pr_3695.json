{"pr_number": 3695, "pr_title": "DHFPROD-4519: Move job-info under models endpoint", "pr_createdAt": "2020-03-13T17:06:31Z", "pr_url": "https://github.com/marklogic/marklogic-data-hub/pull/3695", "timeline": [{"oid": "d346ef1438e90770d813a6720154fcb64bf34fdb", "url": "https://github.com/marklogic/marklogic-data-hub/commit/d346ef1438e90770d813a6720154fcb64bf34fdb", "message": "DHFPROD-4519: Move job-info under /models", "committedDate": "2020-03-13T00:37:37Z", "type": "commit"}, {"oid": "60ad736797c9d8db9e5f8597a2e8e0ea987cb5e0", "url": "https://github.com/marklogic/marklogic-data-hub/commit/60ad736797c9d8db9e5f8597a2e8e0ea987cb5e0", "message": "DHFPROD-4519: Update mocks with new job-info endpoint", "committedDate": "2020-03-13T16:32:04Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjM2MTE2OQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3695#discussion_r392361169", "bodyText": "I agree with including this here, as this is job stuff that's specific to models, as opposed to job stuff that is global to a project.", "author": "rjrudin", "createdAt": "2020-03-13T17:11:15Z", "path": "one-ui/src/main/java/com/marklogic/hub/oneui/controllers/ModelController.java", "diffHunk": "@@ -60,4 +62,18 @@ ModelManager modelManager() {\n         JsonNode json = modelManager.getModel(modelName);\n         return new ResponseEntity<>(json, HttpStatus.OK);\n     }\n+\n+    @RequestMapping(value = \"/job-info\", method = RequestMethod.GET)\n+    @ResponseBody\n+    public ResponseEntity<?> getLatestJobInfoForAllModels() {", "originalCommit": "60ad736797c9d8db9e5f8597a2e8e0ea987cb5e0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjM2MTkwMQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3695#discussion_r392361901", "bodyText": "One tweak I'd make because I like single-line methods in a controller - no need to change now, but I'd just do this:\nreturn new ResponseEntity<>(modelManager.getLatestJobInfoForAllModels(), HttpStatus.OK);\n\nAnd since I'm really lazy, I'd have an AbstractController class with generic reusable methods, such as one that would let me do this here instead:\nreturn ok(modelManager.getLatestJobInfoForAllModels());", "author": "rjrudin", "createdAt": "2020-03-13T17:12:42Z", "path": "one-ui/src/main/java/com/marklogic/hub/oneui/controllers/ModelController.java", "diffHunk": "@@ -60,4 +62,18 @@ ModelManager modelManager() {\n         JsonNode json = modelManager.getModel(modelName);\n         return new ResponseEntity<>(json, HttpStatus.OK);\n     }\n+\n+    @RequestMapping(value = \"/job-info\", method = RequestMethod.GET)\n+    @ResponseBody\n+    public ResponseEntity<?> getLatestJobInfoForAllModels() {\n+        List<JsonNode> modelList = modelManager.getLatestJobInfoForAllModels();\n+        return new ResponseEntity<>(modelList, HttpStatus.OK);", "originalCommit": "60ad736797c9d8db9e5f8597a2e8e0ea987cb5e0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjQ4MDcyMw==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3695#discussion_r392480723", "bodyText": "Good idea.", "author": "akshaysonvane", "createdAt": "2020-03-13T21:13:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjM2MTkwMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjcxNzg2OA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3695#discussion_r392717868", "bodyText": "Added 3029f55", "author": "akshaysonvane", "createdAt": "2020-03-15T22:09:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjM2MTkwMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjM2NDEwNA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3695#discussion_r392364104", "bodyText": "Why would the user not be authorized? I'm wondering more generally - why would we call this method if the user isn't authorized? This seems like something we'd want to handle via authorities - I think Spring Security has a method for checking this programmatically so an exception isn't thrown right away - e.g. https://stackoverflow.com/questions/3021200/how-to-check-hasrole-in-java-code-with-spring-security .\nI think this needs to be changed because if this exception occurs for some other reason, we don't necessarily want to just log it and move on.", "author": "rjrudin", "createdAt": "2020-03-13T17:16:47Z", "path": "one-ui/src/main/java/com/marklogic/hub/oneui/managers/ModelManager.java", "diffHunk": "@@ -154,4 +157,43 @@ public JsonNode getModel(String modelName) {\n \n         return handle.get();\n     }\n+\n+    /**\n+     * Get latest job info for specified model\n+     *\n+     * @param modelName Name of the entity model\n+     * @return - a JsonNode containing job info\n+     */\n+    public JsonNode getLatestJobInfo(String modelName) {\n+        return getJobInfoFromDB(finalDataServiceClient, modelName);\n+    }\n+\n+    /**\n+     * Get latest job info for all models\n+     *\n+     * @return - a list of JsonNode containing job info\n+     */\n+    public List<JsonNode> getLatestJobInfoForAllModels() {\n+        return getModelNames()\n+            .stream()\n+            .map(s -> getJobInfoFromDB(finalDataServiceClient, s))\n+            .filter(Objects::nonNull)\n+            .collect(Collectors.toList());\n+    }\n+\n+    JsonNode getJobInfoFromDB(DatabaseClient dbClient, String modelName) {\n+        JsonNode node = null;\n+        try {\n+            node = JobInfo.on(dbClient).getLatestJobData(modelName);\n+        }\n+        catch (MarkLogicServerException e) {\n+            /*", "originalCommit": "60ad736797c9d8db9e5f8597a2e8e0ea987cb5e0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjQ4MDc4MA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3695#discussion_r392480780", "bodyText": "Explore has two users, the architect user that can only access the entity models but not the entity instances and the user that can access both the entity models and instances.\nThe explorer architect user won't have access to this job info data service endpoint and in that case, the UI does not show any data in the last harmonized timestamp column.\nNow, that we have authorities we can rely on them to hide that column from the UI.\nI'll just create a task to check for the right authority for now as this would require additional work on the UI to hide the extra column for an explorer architect user. Making the change just on the backend will break the app as the frontend would not handle the 403 access denied when this call is made.\nWe can take up this task up once @brucean52 completes the task of merging the frontend explorer code with OneUI.", "author": "akshaysonvane", "createdAt": "2020-03-13T21:13:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjM2NDEwNA=="}], "type": "inlineReview"}, {"oid": "3029f5529211221da4ad83bd1e2a2403857c99fd", "url": "https://github.com/marklogic/marklogic-data-hub/commit/3029f5529211221da4ad83bd1e2a2403857c99fd", "message": "DHFPROD-4519: Use shortcut for creating ResponseEntity object", "committedDate": "2020-03-15T22:06:39Z", "type": "commit"}]}