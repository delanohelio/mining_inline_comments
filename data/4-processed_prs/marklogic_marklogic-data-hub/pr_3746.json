{"pr_number": 3746, "pr_title": "DHFPROD-4559: Explorer returns empty results when there is no data", "pr_createdAt": "2020-03-24T16:51:45Z", "pr_url": "https://github.com/marklogic/marklogic-data-hub/pull/3746", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzM2NDA4Ng==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3746#discussion_r397364086", "bodyText": "This seems like something we can check on before trying to do the search, right?\nAlso, I'd say we should add a test - but it doesn't look like SearchHelper is actually being tested at all??? I see in SearchManagerTest that it's being mocked.\nWhy is SearchHelper separate from SearchManager? SearchManager isn't doing anything other than delegating to SearchHelper.\nI recommend trying to write a real test here. This one is easy, because you don't need any data - just pass in a SearchQuery with no entity names, and verify you get back an empty StringHandle.", "author": "rjrudin", "createdAt": "2020-03-24T18:14:09Z", "path": "one-ui/src/main/java/com/marklogic/hub/oneui/util/SearchHelper.java", "diffHunk": "@@ -96,6 +99,12 @@ public StringHandle search(SearchQuery searchQuery) {\n \n         }\n         catch (MarkLogicServerException e) {\n+            // If there are no entityTypes to search, return empty result set", "originalCommit": "940a592494cfe84c0688bcbdbd28f994532482f1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzQ2NzcwNQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3746#discussion_r397467705", "bodyText": "The reason for adding this check in the catch block is we have to make a getModels call for every search request. This is handled by adding empty list to the collection query if the searchQuery.getQuery().getEntityNames() is empty which results in no results.\nIf there are no entityTypes, then there are no search options and we get 400 error with a missing options file. So I added this check in case of exception.", "author": "rahulvudutala", "createdAt": "2020-03-24T21:19:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzM2NDA4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzQ2Nzk5Mw==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3746#discussion_r397467993", "bodyText": "I will add a comment as you suggested\n\"if there are no entity models, then we expect an error because no search options will exist\"", "author": "rahulvudutala", "createdAt": "2020-03-24T21:20:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzM2NDA4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzgyNDk0OA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3746#discussion_r397824948", "bodyText": "What about a test for this? Can you submit a SearchQuery with no entity names and get this expected exception, and then verify that you get an empty StringHandle back?", "author": "rjrudin", "createdAt": "2020-03-25T12:45:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzM2NDA4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODcwOTkzNw==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3746#discussion_r398709937", "bodyText": "Addressed in new commits", "author": "rahulvudutala", "createdAt": "2020-03-26T16:25:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzM2NDA4Ng=="}], "type": "inlineReview"}, {"oid": "0c4bcdcd60a72f039553034d9381bf58f80c7858", "url": "https://github.com/marklogic/marklogic-data-hub/commit/0c4bcdcd60a72f039553034d9381bf58f80c7858", "message": "DHFPROD-4559: Refactoring SearchHelper, SearchManager classes and deprecated content", "committedDate": "2020-03-26T16:00:55Z", "type": "forcePushed"}, {"oid": "d275aec2d5d2a1189b088b8db6a922f039521e74", "url": "https://github.com/marklogic/marklogic-data-hub/commit/d275aec2d5d2a1189b088b8db6a922f039521e74", "message": "DHFPROD-4559: Refactoring SearchHelper, SearchManager classes and deprecated content", "committedDate": "2020-03-26T17:06:31Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODc3NzEyOA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3746#discussion_r398777128", "bodyText": "This is a lot of redundant logging for an exception. If the point is to make it clear what query failed, just rethrow the exception:\nthrow new RuntimeException(\"Failed to run query:  \" + query,e);", "author": "rjrudin", "createdAt": "2020-03-26T17:56:41Z", "path": "one-ui/src/test/java/com/marklogic/hub/oneui/TestHelper.java", "diffHunk": "@@ -188,11 +190,35 @@ private void assignRoleToUser(String username, String role) {\n         user.save();\n     }\n \n-    protected GenericDocumentManager getFinalGenericDocumentManager(DatabaseKind databaseKind) {\n-        return getFinalClient(databaseKind).newDocumentManager();\n+    protected EvalResultIterator runJsInDatabase(String query, String databaseName) {\n+        try {\n+            return getServerEval(databaseName).javascript(query).eval();\n+        }\n+        catch(FailedRequestException e) {\n+            logger.error(\"Failed run code: \" + query, e);\n+            e.printStackTrace();\n+            throw e;", "originalCommit": "d275aec2d5d2a1189b088b8db6a922f039521e74", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODc3Nzg4Mw==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3746#discussion_r398777883", "bodyText": "This is worth adding a unit test for - why escapeXml10 and not escapeXml? What scenario is this handling, such that it would break if we didn't call escapeXml10?", "author": "rjrudin", "createdAt": "2020-03-26T17:57:51Z", "path": "one-ui/src/main/java/com/marklogic/hub/oneui/util/SearchOptionBuilder.java", "diffHunk": "@@ -51,7 +51,7 @@ public String buildSearchOptions(String query, SearchQuery searchQuery) throws I\n         // Setting search string if provided by user\n         if (StringUtils.isNotEmpty(searchQuery.getQuery().getSearchStr())) {\n             sb.append(\"<qtext>\")\n-                .append(StringEscapeUtils.escapeXml(searchQuery.getQuery().getSearchStr()))\n+                .append(StringEscapeUtils.escapeXml10(searchQuery.getQuery().getSearchStr()))", "originalCommit": "d275aec2d5d2a1189b088b8db6a922f039521e74", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "ecf5e23ca76632897f2795411a531f1bda0f4d5f", "url": "https://github.com/marklogic/marklogic-data-hub/commit/ecf5e23ca76632897f2795411a531f1bda0f4d5f", "message": "DHFPROD-4559: Explorer returns empty results when there is no data", "committedDate": "2020-03-27T01:50:39Z", "type": "commit"}, {"oid": "6452684d6a4b82dfedb8ff68f190cf6eeae97ae0", "url": "https://github.com/marklogic/marklogic-data-hub/commit/6452684d6a4b82dfedb8ff68f190cf6eeae97ae0", "message": "DHFPROD-4559: Refactoring SearchHelper, SearchManager classes and deprecated content", "committedDate": "2020-03-27T01:50:39Z", "type": "commit"}, {"oid": "6452684d6a4b82dfedb8ff68f190cf6eeae97ae0", "url": "https://github.com/marklogic/marklogic-data-hub/commit/6452684d6a4b82dfedb8ff68f190cf6eeae97ae0", "message": "DHFPROD-4559: Refactoring SearchHelper, SearchManager classes and deprecated content", "committedDate": "2020-03-27T01:50:39Z", "type": "forcePushed"}]}