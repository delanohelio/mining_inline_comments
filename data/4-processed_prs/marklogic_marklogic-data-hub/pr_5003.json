{"pr_number": 5003, "pr_title": "DHFPROD-6241:'createdOn' and 'createdBy' in mapped documents are incorrect", "pr_createdAt": "2020-12-15T04:10:55Z", "pr_url": "https://github.com/marklogic/marklogic-data-hub/pull/5003", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzM1NDY3Ng==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/5003#discussion_r543354676", "bodyText": "I don't think we should include this sources line; while we agreed to keep it in ingestion steps for backwards compatibility, we also agreed that a step name is not really a source. So let's not introduce this behavior here.", "author": "rjrudin", "createdAt": "2020-12-15T13:48:18Z", "path": "marklogic-data-hub/src/main/resources/ml-modules/root/data-hub/5/artifacts/mapping.sjs", "diffHunk": "@@ -86,6 +86,11 @@ function defaultArtifact(artifactName, entityTypeId) {\n     defaultCollections.push(hubEs.findEntityServiceTitle(entityTypeId) || entityTypeId);\n   }\n   return {\n+    headers: {\n+      sources: [{name: artifactName}],", "originalCommit": "0e7a2c120c4660c5726eb960d9aa7923e91d59cc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzU3MTkzNg==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/5003#discussion_r543571936", "bodyText": "We currently have it for ingestion step as well. Should that be removed as well ?", "author": "srinathgit", "createdAt": "2020-12-15T18:10:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzM1NDY3Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzU4ODIxMw==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/5003#discussion_r543588213", "bodyText": "We agreed to keep it there for backwards compatibility purposes.", "author": "rjrudin", "createdAt": "2020-12-15T18:34:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzM1NDY3Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzM5OTA1NQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/5003#discussion_r543399055", "bodyText": "This definitely works when creating a new document. If a user is overwriting an existing document (perhaps the source document itself) - this still seems correct because we're really creating a brand new document from the perspective of the mapping step - i.e. we're overwriting a source document with an entity instance, and those are two totally different things. So overwriting createdOn/createdBy makes sense.\nCouple thoughts to make this easier to understand:\n\nRename \"headers\" to \"headersFromStepOptions\" to make it more clear what they're describing (they could be interpreted as headers from a source document)\nI think we should swap the order of the first two args in the function so that it is consistent with the order in the \"assign\" call. And the function needs comments on it to make it clear that the output will be the result of merging \"headersFromStepOptions\" into \"docHeaders\", where the former will overwrite the latter where there are duplicate keys.\n\nFinally, we need a unit test for this function. The HC test is fine, but that's a very high level test for a low level detail like this. The unit test won't care about steps - it'll just pass in in-memory args. Should include a scenario for XML as well so we have test coverage there.", "author": "rjrudin", "createdAt": "2020-12-15T14:35:17Z", "path": "marklogic-data-hub/src/main/resources/ml-modules/root/data-hub/5/impl/flow-utils.sjs", "diffHunk": "@@ -592,7 +592,7 @@ class FlowUtils {\n         }\n       }\n       docHeaders = docHeadersArray.reduce((acc, cur) => Object.assign(acc,cur), {});\n-      headers = Object.assign({}, headers, docHeaders);\n+      headers = Object.assign({}, docHeaders, headers);", "originalCommit": "0e7a2c120c4660c5726eb960d9aa7923e91d59cc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "2e8a21e93f56c4e25a1ad9f4b682896b1748a6d5", "url": "https://github.com/marklogic/marklogic-data-hub/commit/2e8a21e93f56c4e25a1ad9f4b682896b1748a6d5", "message": "DHFPROD-6241:'createdOn' and 'createdBy' in mapped documents are incorrect", "committedDate": "2020-12-16T03:47:27Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzkxMDUzMw==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/5003#discussion_r543910533", "bodyText": "@ryanjdew ,\nShould we call this.cleanData(this.mergeXmlHeaders(Sequence.from([this.jsonToXml(docHeaders), this.jsonToXml(headersFromStepOptions)]))) here or is this sufficient ?", "author": "srinathgit", "createdAt": "2020-12-16T04:01:08Z", "path": "marklogic-data-hub/src/main/resources/ml-modules/root/data-hub/5/impl/flow-utils.sjs", "diffHunk": "@@ -568,12 +568,19 @@ class FlowUtils {\n     return headers;\n   }\n \n-  mergeHeaders(headers, docHeaders, outputFormat) {\n+  /*\n+  This function will return the header obtained by merging \"headersFromStepOptions\" into \"docHeaders\",\n+  where the former will overwrite the latter where there are duplicate keys.\n+   */\n+  mergeHeaders(docHeaders, headersFromStepOptions, outputFormat) {\n     if (outputFormat === this.consts.XML) {\n-      headers = this.cleanData(Sequence.from([\n-        docHeaders,\n-        this.jsonToXml(headers)\n-      ]), \"headers\", outputFormat);\n+      if(docHeaders instanceof Element || docHeaders instanceof Sequence){\n+        headersFromStepOptions = this.mergeXmlHeaders(Sequence.from([docHeaders, this.jsonToXml(headersFromStepOptions)]));\n+      }\n+      else{\n+        headersFromStepOptions = this.mergeXmlHeaders(Sequence.from([this.jsonToXml(docHeaders), this.jsonToXml(headersFromStepOptions)]));", "originalCommit": "2e8a21e93f56c4e25a1ad9f4b682896b1748a6d5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDMzNDk2Ng==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/5003#discussion_r544334966", "bodyText": "I'm realizing now that while this will fix the problem for steps created starting in 5.4.0, it's still a problem for everyone's mapping steps prior to 5.4.0. In that sense, we're adding a new feature, but not fixing the bug.\nThe general problem here is that when a DHF step is creating a new document based on an input document, it shouldn't blindly copy createdOn/createdBy from the input document. The value of createdOn is almost certainly incorrect, and createdBy may be incorrect too.\nI don't think this should be fixed by step config, this should be fixed by code.\nThis appears to only be a problem with mapping steps, as those are the only ones calling the \"mergeHeaders\" function. I think we need a code fix in that function that doesn't depend on step config.\nThat function should say - after I merge the headers, then if createdOn/createdBy are present, I'll be sure to update those to the actual values - fn.currentDateTime() and xdmp.currentUser().", "author": "rjrudin", "createdAt": "2020-12-16T14:19:53Z", "path": "marklogic-data-hub/src/main/resources/ml-modules/root/data-hub/5/artifacts/mapping.sjs", "diffHunk": "@@ -86,6 +86,10 @@ function defaultArtifact(artifactName, entityTypeId) {\n     defaultCollections.push(hubEs.findEntityServiceTitle(entityTypeId) || entityTypeId);\n   }\n   return {\n+    headers: {", "originalCommit": "2e8a21e93f56c4e25a1ad9f4b682896b1748a6d5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "e2eceb124d7b6265a693e52e62b1a421a1cd426d", "url": "https://github.com/marklogic/marklogic-data-hub/commit/e2eceb124d7b6265a693e52e62b1a421a1cd426d", "message": "DHFPROD-6241:'createdOn' and 'createdBy' in mapped documents are incorrect", "committedDate": "2020-12-16T20:41:18Z", "type": "commit"}, {"oid": "e2eceb124d7b6265a693e52e62b1a421a1cd426d", "url": "https://github.com/marklogic/marklogic-data-hub/commit/e2eceb124d7b6265a693e52e62b1a421a1cd426d", "message": "DHFPROD-6241:'createdOn' and 'createdBy' in mapped documents are incorrect", "committedDate": "2020-12-16T20:41:18Z", "type": "forcePushed"}]}