{"pr_number": 3984, "pr_title": "DHFPROD-4671: Add hub-central-load-reader role", "pr_createdAt": "2020-05-21T20:54:27Z", "pr_url": "https://github.com/marklogic/marklogic-data-hub/pull/3984", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODk4OTY3Ng==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3984#discussion_r428989676", "bodyText": "No need to change, but just for future reference, you can do loginAsTestUserWithRoles(\"hub-central-load-reader\")", "author": "rjrudin", "createdAt": "2020-05-22T00:53:59Z", "path": "marklogic-data-hub-central/src/test/java/com/marklogic/hub/central/controllers/steps/IngestionStepControllerTest.java", "diffHunk": "@@ -46,4 +53,39 @@ void getIngestionSteps() throws Exception {\n                 assertEquals(\"secondStep\", array.get(1).get(\"name\").asText());\n             });\n     }\n+\n+    @Test\n+    void permittedReadUser() throws Exception {\n+        installReferenceModelProject();\n+        postJson(PATH + \"/firstStep\", newDefaultIngestionStep(\"firstStep\"));\n+\n+        setTestUserRoles(\"hub-central-load-reader\");\n+\n+        loginAsTestUser();", "originalCommit": "b3c8ddbd97a125c9dd41ba3761a387e32c7892bd", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODk5MjEwNw==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3984#discussion_r428992107", "bodyText": "I think you can just do getJson here?", "author": "rjrudin", "createdAt": "2020-05-22T01:04:08Z", "path": "marklogic-data-hub-central/src/test/java/com/marklogic/hub/central/controllers/steps/IngestionStepControllerTest.java", "diffHunk": "@@ -46,4 +53,39 @@ void getIngestionSteps() throws Exception {\n                 assertEquals(\"secondStep\", array.get(1).get(\"name\").asText());\n             });\n     }\n+\n+    @Test\n+    void permittedReadUser() throws Exception {\n+        installReferenceModelProject();\n+        postJson(PATH + \"/firstStep\", newDefaultIngestionStep(\"firstStep\"));\n+\n+        setTestUserRoles(\"hub-central-load-reader\");\n+\n+        loginAsTestUser();\n+\n+        mockMvc.perform(get(PATH + \"/{stepName}\", \"firstStep\")", "originalCommit": "b3c8ddbd97a125c9dd41ba3761a387e32c7892bd", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODk5MjY1Mg==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3984#discussion_r428992652", "bodyText": "Just an FYI, there's a verifyRequestIsForbidden helper method coming in the 4820 PR. I'll see if I can get that merged into develop tomorrow so you can use it.", "author": "rjrudin", "createdAt": "2020-05-22T01:06:33Z", "path": "marklogic-data-hub-central/src/test/java/com/marklogic/hub/central/controllers/steps/IngestionStepControllerTest.java", "diffHunk": "@@ -46,4 +53,39 @@ void getIngestionSteps() throws Exception {\n                 assertEquals(\"secondStep\", array.get(1).get(\"name\").asText());\n             });\n     }\n+\n+    @Test\n+    void permittedReadUser() throws Exception {\n+        installReferenceModelProject();\n+        postJson(PATH + \"/firstStep\", newDefaultIngestionStep(\"firstStep\"));\n+\n+        setTestUserRoles(\"hub-central-load-reader\");\n+\n+        loginAsTestUser();\n+\n+        mockMvc.perform(get(PATH + \"/{stepName}\", \"firstStep\")\n+                .contentType(MediaType.APPLICATION_JSON)\n+                .session(mockHttpSession))\n+                .andDo(result -> {\n+                    MockHttpServletResponse response = result.getResponse();\n+                    assertEquals(HttpStatus.OK.value(), response.getStatus());\n+                });\n+    }\n+\n+    @Test\n+    void forbiddenReadUser() throws Exception {", "originalCommit": "b3c8ddbd97a125c9dd41ba3761a387e32c7892bd", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODk5MjgzMQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3984#discussion_r428992831", "bodyText": "The 4820 PR will also do this automatically for you.", "author": "rjrudin", "createdAt": "2020-05-22T01:07:23Z", "path": "marklogic-data-hub/src/main/java/com/marklogic/hub/impl/HubProjectImpl.java", "diffHunk": "@@ -369,15 +367,16 @@ public Path getCustomMappingFunctionsDir() {\n         writeRoleFile(rolesDir, \"data-hub-common.json\");\n         writeRoleFile(rolesDir, \"data-hub-common-writer.json\");\n         writeRoleFile(rolesDir, \"data-hub-security-internal.json\");\n-        writeRoleFile(rolesDir, \"data-hub-load-data-reader.json\");\n-        writeRoleFile(rolesDir, \"data-hub-load-data-writer.json\");\n+        writeRoleFile(rolesDir, \"data-hub-load-reader.json\");", "originalCommit": "b3c8ddbd97a125c9dd41ba3761a387e32c7892bd", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODk5MzMxNA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3984#discussion_r428993314", "bodyText": "Shouldn't this be \"data-hub-ingestion-reader\" for consistency with \"data-hub-mapping-reader\"? I think \"hub-central-load-reader\" is fine since HC wants to use the term \"load\", but for core DH, I think we should stay with \"ingestion\" for consistency with existing core DH capabilities.", "author": "rjrudin", "createdAt": "2020-05-22T01:09:30Z", "path": "marklogic-data-hub/src/main/resources/hub-internal-config/security/roles/data-hub-load-reader.json", "diffHunk": "@@ -1,4 +1,4 @@\n {\n-  \"role-name\": \"data-hub-load-data-reader\",\n+  \"role-name\": \"data-hub-load-reader\",", "originalCommit": "b3c8ddbd97a125c9dd41ba3761a387e32c7892bd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODk5NDQ1Mg==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3984#discussion_r428994452", "bodyText": "I'm good with that. Makes sense to make it consistent.", "author": "ryanjdew", "createdAt": "2020-05-22T01:14:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODk5MzMxNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDU0NTUxNg==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3984#discussion_r430545516", "bodyText": "Cypress tests only test explorer for now, so its ok to not update developer and operator users. There also is an open PR with which Cypress tests can run with any roles, just like we set roles to a user in core HC tests.", "author": "bsrikan", "createdAt": "2020-05-26T16:27:02Z", "path": "marklogic-data-hub-central/ui/e2e/cypress/fixtures/users/developer.json", "diffHunk": "@@ -2,5 +2,5 @@\n     \"user-name\": \"dh-dev\",\n     \"description\": \"A data hub dev user\",\n     \"password\": \"dh-dev\",\n-    \"role\": [\"data-hub-developer\", \"hub-central-entity-exporter\", \"hub-central-mapping-reader\", \"hub-central-mapping-writer\"]\n+    \"role\": [\"data-hub-developer\", \"hub-central-entity-exporter\", \"hub-central-load-reader\", \"hub-central-mapping-reader\", \"hub-central-mapping-writer\"]", "originalCommit": "b3c8ddbd97a125c9dd41ba3761a387e32c7892bd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDU4NzUwNA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3984#discussion_r430587504", "bodyText": "Thanks. Good to know. I've removed the unnecessary roles with my latest PR updates.", "author": "ryanjdew", "createdAt": "2020-05-26T17:34:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDU0NTUxNg=="}], "type": "inlineReview"}, {"oid": "1a06dafa3532db6e74d93e5e1f8626712ad8551f", "url": "https://github.com/marklogic/marklogic-data-hub/commit/1a06dafa3532db6e74d93e5e1f8626712ad8551f", "message": "DHFPROD-4671: Add hub-central-load-reader role", "committedDate": "2020-05-26T17:29:39Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDYwOTc1Nw==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3984#discussion_r430609757", "bodyText": "In the UI work, we typically use JSON as the default case. Can we have setupMockAPIs use the loads object (the JSON version) for /api/steps/ingestion instead of loadsXML? That will also make the test data more consistent since the flows test data has a step with a sourceFormat of 'json'.", "author": "wooldridge", "createdAt": "2020-05-26T18:09:53Z", "path": "marklogic-data-hub-central/ui/src/config/bench.config.ts", "diffHunk": "@@ -347,6 +347,25 @@ const loadsXML = {\"data\" :\n   \"status\" :200\n };\n \n+const setupMockAPIs = (axiosMock) => {\n+  return axiosMock.get['mockImplementation']((url) => {\n+    switch (url) {\n+      case '/api/flows':\n+        return Promise.resolve(flows)\n+      case '/api/models/primaryEntityTypes':\n+        return Promise.resolve(primaryEntityTypes)\n+      case '/api/steps/ingestion':\n+        return Promise.resolve(loadsXML)", "originalCommit": "1a06dafa3532db6e74d93e5e1f8626712ad8551f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDczNTEwNQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3984#discussion_r430735105", "bodyText": "updated to use the loads object.", "author": "ryanjdew", "createdAt": "2020-05-26T22:09:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDYwOTc1Nw=="}], "type": "inlineReview"}, {"oid": "fd5b9dc7c5db7b0edfc7dd114ff294bf7ccee5c8", "url": "https://github.com/marklogic/marklogic-data-hub/commit/fd5b9dc7c5db7b0edfc7dd114ff294bf7ccee5c8", "message": "DHFPROD-4671: Add hub-central-load-reader role", "committedDate": "2020-05-26T19:02:24Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDY1NTE4Ng==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3984#discussion_r430655186", "bodyText": "This is ok now, but for future tests, lets just do click, since successful click validates that the item was in the document.", "author": "bsrikan", "createdAt": "2020-05-26T19:30:38Z", "path": "marklogic-data-hub-central/ui/src/pages/LoadData.test.tsx", "diffHunk": "@@ -0,0 +1,84 @@\n+import React, {useContext} from 'react';\n+import { render, fireEvent, waitForElement, cleanup } from '@testing-library/react'\n+import '@testing-library/jest-dom/extend-expect'\n+import TilesView from './TilesView';\n+import {AuthoritiesContext, AuthoritiesService} from '../util/authorities';\n+import axiosMock from 'axios';\n+import curateData from '../config/bench.config';\n+import authorities from '../config/authorities.config';\n+import data from \"../config/bench.config\";\n+import LoadData from \"./LoadData\";\n+\n+jest.mock('axios');\n+\n+describe('LoadData component', () => {\n+  test('Verify LoadData component cannot edit with only readIngestion authority', async () => {\n+      const authorityService = new AuthoritiesService();\n+      authorityService.setAuthorities(['readIngestion']);\n+\n+      await curateData.setupMockAPIs(axiosMock);\n+\n+      const { getByText, getByTitle, getByLabelText, getByTestId } = render(<AuthoritiesContext.Provider value={authorityService}><LoadData/></AuthoritiesContext.Provider>);\n+\n+      expect(await(waitForElement(() => getByTitle('table')))).toBeInTheDocument();\n+\n+      // Check for steps to be populated\n+      expect(axiosMock.get).toBeCalledWith('/api/steps/ingestion');\n+      expect(getByText('loadXML')).toBeInTheDocument();\n+\n+      // Check table layout\n+      const tableMenuItem = getByTitle('table');\n+      expect(tableMenuItem).toBeInTheDocument();\n+      await fireEvent.click(tableMenuItem);", "originalCommit": "fd5b9dc7c5db7b0edfc7dd114ff294bf7ccee5c8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDY2NDIzOQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3984#discussion_r430664239", "bodyText": "just like update here, can we add assertions for create(Add New) and delete as well for both readIngestion and writeIngestion.", "author": "bsrikan", "createdAt": "2020-05-26T19:42:21Z", "path": "marklogic-data-hub-central/ui/src/pages/LoadData.test.tsx", "diffHunk": "@@ -0,0 +1,84 @@\n+import React, {useContext} from 'react';\n+import { render, fireEvent, waitForElement, cleanup } from '@testing-library/react'\n+import '@testing-library/jest-dom/extend-expect'\n+import TilesView from './TilesView';\n+import {AuthoritiesContext, AuthoritiesService} from '../util/authorities';\n+import axiosMock from 'axios';\n+import curateData from '../config/bench.config';\n+import authorities from '../config/authorities.config';\n+import data from \"../config/bench.config\";\n+import LoadData from \"./LoadData\";\n+\n+jest.mock('axios');\n+\n+describe('LoadData component', () => {\n+  test('Verify LoadData component cannot edit with only readIngestion authority', async () => {\n+      const authorityService = new AuthoritiesService();\n+      authorityService.setAuthorities(['readIngestion']);\n+\n+      await curateData.setupMockAPIs(axiosMock);\n+\n+      const { getByText, getByTitle, getByLabelText, getByTestId } = render(<AuthoritiesContext.Provider value={authorityService}><LoadData/></AuthoritiesContext.Provider>);\n+\n+      expect(await(waitForElement(() => getByTitle('table')))).toBeInTheDocument();\n+\n+      // Check for steps to be populated\n+      expect(axiosMock.get).toBeCalledWith('/api/steps/ingestion');\n+      expect(getByText('loadXML')).toBeInTheDocument();\n+\n+      // Check table layout\n+      const tableMenuItem = getByTitle('table');\n+      expect(tableMenuItem).toBeInTheDocument();\n+      await fireEvent.click(tableMenuItem);\n+\n+      await fireEvent.click(getByTestId('loadXML-settings'));\n+      expect(await(waitForElement(() => getByText('Target Database:')))).toBeInTheDocument();\n+\n+      expect(getByText('Save')).toBeDisabled();", "originalCommit": "fd5b9dc7c5db7b0edfc7dd114ff294bf7ccee5c8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDc3MzM4MQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3984#discussion_r430773381", "bodyText": "@ryanjdew this is the only missing scenario in the tests. Approving the PR. Have noted this in the test plan as well. Maybe we can cover this when writing tests for hc-load-writer", "author": "bsrikan", "createdAt": "2020-05-27T00:07:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDY2NDIzOQ=="}], "type": "inlineReview"}, {"oid": "9689021f3ee50254dcd0930bd66d59682ac5ed2b", "url": "https://github.com/marklogic/marklogic-data-hub/commit/9689021f3ee50254dcd0930bd66d59682ac5ed2b", "message": "DHFPROD-4671: Add hub-central-load-reader role", "committedDate": "2020-05-26T19:43:27Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDY2NTYxOQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3984#discussion_r430665619", "bodyText": "Can we also add a test to verify readIngestion can not access Model, Curate and Run to ensure coverage per test plan.", "author": "bsrikan", "createdAt": "2020-05-26T19:44:55Z", "path": "marklogic-data-hub-central/ui/src/pages/TilesView.test.tsx", "diffHunk": "@@ -82,25 +56,49 @@ describe('TilesView component', () => {\n         expect(getByText('Customer')).toBeInTheDocument();\n     });\n \n+    test('Verify Load tile displays from toolbar with readIngestion authority', async () => {\n+        const authorityService = new AuthoritiesService();\n+        authorityService.setAuthorities(['readIngestion']);\n+        const {getByLabelText, getByText, queryByText} = render(<AuthoritiesContext.Provider value={authorityService}><TilesView/></AuthoritiesContext.Provider>);\n+\n+        // Curate tile not shown initially\n+        expect(queryByText(\"icon-load\")).not.toBeInTheDocument();\n+        expect(queryByText(\"title-load\")).not.toBeInTheDocument();\n+\n+        await curateData.setupMockAPIs(axiosMock);\n+        fireEvent.click(getByLabelText(\"tool-load\"));", "originalCommit": "9689021f3ee50254dcd0930bd66d59682ac5ed2b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDczNTM5OA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3984#discussion_r430735398", "bodyText": "added the check for access to other tiles.", "author": "ryanjdew", "createdAt": "2020-05-26T22:09:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDY2NTYxOQ=="}], "type": "inlineReview"}, {"oid": "dae0f38d865ccaa14bac8858862d50f15b600db0", "url": "https://github.com/marklogic/marklogic-data-hub/commit/dae0f38d865ccaa14bac8858862d50f15b600db0", "message": "DHFPROD-4671: Add hub-central-load-reader role", "committedDate": "2020-05-26T22:05:46Z", "type": "commit"}, {"oid": "dae0f38d865ccaa14bac8858862d50f15b600db0", "url": "https://github.com/marklogic/marklogic-data-hub/commit/dae0f38d865ccaa14bac8858862d50f15b600db0", "message": "DHFPROD-4671: Add hub-central-load-reader role", "committedDate": "2020-05-26T22:05:46Z", "type": "forcePushed"}]}