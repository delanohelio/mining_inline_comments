{"pr_number": 3497, "pr_title": "DHFPROD-4158: Can now deploy to DHS via multiple roles", "pr_createdAt": "2020-01-24T00:54:46Z", "pr_url": "https://github.com/marklogic/marklogic-data-hub/pull/3497", "timeline": [{"oid": "089c4e14b3dbcbf250c891b5ab8ab87f852c5c43", "url": "https://github.com/marklogic/marklogic-data-hub/commit/089c4e14b3dbcbf250c891b5ab8ab87f852c5c43", "message": "DHFPROD-4158: Can now deploy to DHS via multiple roles\n\nMost of the files in here are for a new example project - dhs-example. \n\nNote that \"dhsDeploy\" is being retained, but as an alias to \"hubDeploy\". The prior functionality of dhsDeploy - only loading modules and updating indexes - was intentionally replaced. But to prevent errors from the task no longer existing, it's aliased to hubDeploy.", "committedDate": "2020-01-24T00:55:51Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDQ1NDA0NQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3497#discussion_r370454045", "bodyText": "Should this be changed to hubDeployAsSecurityAdmin and other places as well?", "author": "bsrikan", "createdAt": "2020-01-24T02:47:24Z", "path": "examples/dhs-example/README.md", "diffHunk": "@@ -0,0 +1,97 @@\n+This example project demonstrates where to store resources that can be deployed to a DHS instance using a user with the \n+data-hub-developer role, or the data-hub-security-admin role, or both. \n+\n+This project is not meant to be deployed. It is intended only to serve as a reference for where resource files\n+should be stored. Because of this, it also does not define any Data Hub artifacts, such as flows or entities.\n+\n+## General deployment guidelines\n+\n+The tasks for deploying resources to DHS will never read from the src/main/hub-internal-config directory. The \n+resources in that directory are deployed automatically within DHS. For example, if you have defined your configuration\n+directories via the following property:\n+\n+    mlConfigPaths=src/main/hub-internal-config,src/main/ml-config,src/main/other-config\n+    \n+The ml-config and other-config directories will still be processed, but hub-internal-config will not be.\n+\n+## Deploying resources as a data-hub-security-admin user\n+\n+As of 5.2.0, a user with the data-hub-security-admin role is permitted to deploy roles that grant privileges that are\n+inherited by the user performing the deployment. As an example of this, the \n+src/main/ml-config/security/roles/custom-role1.json file defines a new role with the \"manage\" privilege, which is \n+inherited by the data-hub-security-admin role. \n+\n+Permitted resources can be deployed via the following task (assuming that gradle-dhs.properties defines the host and\n+credentials for the DHS instance):\n+\n+    ./gradlew -PenvironmentName=dhs dhsDeployAsSecurityAdmin", "originalCommit": "089c4e14b3dbcbf250c891b5ab8ab87f852c5c43", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDY4MTcyMA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3497#discussion_r370681720", "bodyText": "Good catch, made the fix.", "author": "rjrudin", "createdAt": "2020-01-24T15:07:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDQ1NDA0NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDQ1NDQxNg==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3497#discussion_r370454416", "bodyText": "Is it worth mentioning here that lsqt is not supported?", "author": "bsrikan", "createdAt": "2020-01-24T02:49:28Z", "path": "examples/dhs-example/README.md", "diffHunk": "@@ -0,0 +1,97 @@\n+This example project demonstrates where to store resources that can be deployed to a DHS instance using a user with the \n+data-hub-developer role, or the data-hub-security-admin role, or both. \n+\n+This project is not meant to be deployed. It is intended only to serve as a reference for where resource files\n+should be stored. Because of this, it also does not define any Data Hub artifacts, such as flows or entities.\n+\n+## General deployment guidelines\n+\n+The tasks for deploying resources to DHS will never read from the src/main/hub-internal-config directory. The \n+resources in that directory are deployed automatically within DHS. For example, if you have defined your configuration\n+directories via the following property:\n+\n+    mlConfigPaths=src/main/hub-internal-config,src/main/ml-config,src/main/other-config\n+    \n+The ml-config and other-config directories will still be processed, but hub-internal-config will not be.\n+\n+## Deploying resources as a data-hub-security-admin user\n+\n+As of 5.2.0, a user with the data-hub-security-admin role is permitted to deploy roles that grant privileges that are\n+inherited by the user performing the deployment. As an example of this, the \n+src/main/ml-config/security/roles/custom-role1.json file defines a new role with the \"manage\" privilege, which is \n+inherited by the data-hub-security-admin role. \n+\n+Permitted resources can be deployed via the following task (assuming that gradle-dhs.properties defines the host and\n+credentials for the DHS instance):\n+\n+    ./gradlew -PenvironmentName=dhs dhsDeployAsSecurityAdmin\n+    \n+## Deploying resources as a data-hub-developer user\n+\n+As of 5.2.0, a user with the data-hub-developer is permitted to deploy the following resources:\n+\n+- Indexes to the data-hub-STAGING, data-hub-FINAL, and data-hub-JOBS databases\n+- Artifacts (entities, flows, mappings, and step definitions)\n+- Modules\n+- Alert configs, rules, and actions\n+- Scheduled tasks\n+- Schemas\n+- Temporal axes and collections\n+- Triggers\n+\n+Permitted resources can be deployed via the following task (assuming that gradle-dhs.properties defines the host and\n+credentials for the DHS instance):\n+\n+    ./gradlew -PenvironmentName=dhs dhsDeployAsDeveloper\n+    \n+Each of the permitted resources is described below in more detail.\n+\n+### Database indexes\n+\n+Each database file that references data-hub-STAGING, data-hub-FINAL, and data-hub-JOBS will be processed. Database files\n+are located in the \"./databases\" directory in a configuration directory. In this example project, the \"test-database.json\"\n+file will not be processed since it does not reference one of those 3 databases. Also see \n+[the ml-gradle docs](https://github.com/marklogic-community/ml-gradle/wiki/Resource-reference#databases) for more information.\n+\n+## Artifacts\n+\n+Equivalent to on-premise deployment, all Data Hub artifacts in the ./entities, ./flows, ./mappings, and \n+./step-definitions directories will be deployed.\n+\n+## Modules\n+\n+All user modules in any directory specified by mlModulePaths (defaults to src/main/ml-modules) will be deployed. Contrary\n+to an on-premise deployment, the Data Hub modules themselves are not deployed. These are instead deployed automatically\n+within the DHS instance. Also see [the ml-gradle docs](https://github.com/marklogic-community/ml-gradle/wiki/How-modules-are-loaded) for more information. \n+\n+## Alert resources\n+\n+Alert resource files - configs, alerts, and rules - are stored in the directory \"./databases/(name of content database)/alerts\". \n+See src/main/ml-config/databases/data-hub-FINAL/alert for an example in this project. Also see \n+[the ml-gradle docs](https://github.com/marklogic-community/ml-gradle/wiki/Resource-reference#alerting) for more information.\n+\n+## Schemas \n+\n+Schema files are stored in the directory \"./databases/(name of schema database)/schemas\". See \n+src/main/ml-config/databases/data-hub-staging-SCHEMAS/schemas for an example in this project. Also see \n+[the ml-gradle docs](https://github.com/marklogic-community/ml-gradle/wiki/Loading-schemas) for more information. \n+\n+## Scheduled tasks\n+\n+Because a DHS instance uses multiple groups for application servers, and because a scheduled task is associated with a\n+group, scheduled task files are stored in the directory \"./tasks/(name of group)\". See \n+src/main/ml-config/tasks for an example in this project. Also see\n+[the ml-gradle docs](https://github.com/marklogic-community/ml-gradle/wiki/Resource-reference#scheduled-tasks) for more information.\n+\n+## Temporal axes and collections\n+", "originalCommit": "089c4e14b3dbcbf250c891b5ab8ab87f852c5c43", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDY4MTc3OA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3497#discussion_r370681778", "bodyText": "That's a good idea,  I added mention of that.", "author": "rjrudin", "createdAt": "2020-01-24T15:07:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDQ1NDQxNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDQ1NTI4Mw==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3497#discussion_r370455283", "bodyText": "nice addition.", "author": "bsrikan", "createdAt": "2020-01-24T02:55:16Z", "path": "ml-data-hub-plugin/src/main/groovy/com/marklogic/gradle/DataHubPlugin.groovy", "diffHunk": "@@ -190,10 +184,18 @@ class DataHubPlugin implements Plugin<Project> {\n         String flowGroup = \"MarkLogic Data Hub Flow Management\"\n         project.task(\"hubRunFlow\", group: flowGroup, type: RunFlowTask)\n \n-        String dhsGroup = \"DHS\"\n-        project.task(\"dhsDeploy\", group: dhsGroup, type: DhsDeployTask,\n-            description: \"Deploy project resources and modules into a DHS instance\"\n-        ).finalizedBy([\"hubGenerateExplorerOptions\"])\n+        project.task(\"hubDeployAsSecurityAdmin\", group: deployGroup, type: DeployAsSecurityAdminTask,\n+            description: \"Deploy roles as a user with the data-hub-security-admin role\")\n+\n+        project.task(\"hubDeployAsDeveloper\", group: deployGroup, type: DeployAsDeveloperTask,\n+            description: \"Deploy project configuration as a user with the data-hub-developer role\"\n+        ).finalizedBy([\"hubGenerateExplorerOptions\"]).mustRunAfter(\"hubDeployAsSecurityAdmin\")\n+\n+        project.task(\"hubDeploy\", group: deployGroup, dependsOn: [\"hubDeployAsDeveloper\", \"hubDeployAsSecurityAdmin\"],\n+            description: \"Deploy project configuration as a user with the data-hub-security-admin and data-hub-developer roles\")\n+\n+        project.task(\"dhsDeploy\", dependsOn: [\"hubDeploy\"],\n+            description: \"dhsDeploy has been replaced in 5.2.0 by hubDeploy and similar tasks. It is now simply an alias for hubDeploy.\")", "originalCommit": "089c4e14b3dbcbf250c891b5ab8ab87f852c5c43", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "333278ab49432f92c3ba5e5f2e041083af210545", "url": "https://github.com/marklogic/marklogic-data-hub/commit/333278ab49432f92c3ba5e5f2e041083af210545", "message": "DHFPROD-4158: Can now deploy to DHS via multiple roles\n\nMost of the files in here are for a new example project - dhs-example. \n\nNote that \"dhsDeploy\" is being retained, but as an alias to \"hubDeploy\". The prior functionality of dhsDeploy - only loading modules and updating indexes - was intentionally replaced. But to prevent errors from the task no longer existing, it's aliased to hubDeploy.", "committedDate": "2020-01-24T15:06:22Z", "type": "forcePushed"}, {"oid": "e94904f7890810d8658e31307c52ce5a5a331845", "url": "https://github.com/marklogic/marklogic-data-hub/commit/e94904f7890810d8658e31307c52ce5a5a331845", "message": "DHFPROD-4158: Can now deploy to DHS via multiple roles\n\nMost of the files in here are for a new example project - dhs-example. \n\nNote that \"dhsDeploy\" is being retained, but as an alias to \"hubDeploy\". The prior functionality of dhsDeploy - only loading modules and updating indexes - was intentionally replaced. But to prevent errors from the task no longer existing, it's aliased to hubDeploy.", "committedDate": "2020-01-24T15:07:33Z", "type": "commit"}, {"oid": "e94904f7890810d8658e31307c52ce5a5a331845", "url": "https://github.com/marklogic/marklogic-data-hub/commit/e94904f7890810d8658e31307c52ce5a5a331845", "message": "DHFPROD-4158: Can now deploy to DHS via multiple roles\n\nMost of the files in here are for a new example project - dhs-example. \n\nNote that \"dhsDeploy\" is being retained, but as an alias to \"hubDeploy\". The prior functionality of dhsDeploy - only loading modules and updating indexes - was intentionally replaced. But to prevent errors from the task no longer existing, it's aliased to hubDeploy.", "committedDate": "2020-01-24T15:07:33Z", "type": "forcePushed"}]}