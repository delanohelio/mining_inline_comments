{"pr_number": 3622, "pr_title": "DHFPROD-4285: Can now map multiple properties of the same entity type", "pr_createdAt": "2020-02-28T16:56:13Z", "pr_url": "https://github.com/marklogic/marklogic-data-hub/pull/3622", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjAwOTIzNA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3622#discussion_r386009234", "bodyText": "We have a failing test. null check required here.\ncom.marklogic.client.FailedRequestException: Local message: failed to apply resource at documents: Internal Server Error. Server Message: JS-JAVASCRIPT: Object.keys(mapping.properties).forEach(propertyTitle => { -- Error running JavaScript request: TypeError: Cannot convert undefined or null to object . See the MarkLogic server error log for further detail.", "author": "bsrikan", "createdAt": "2020-02-29T07:26:54Z", "path": "marklogic-data-hub/src/main/resources/ml-modules/root/data-hub/5/builtins/steps/mapping/entity-services/lib.sjs", "diffHunk": "@@ -141,16 +167,34 @@ function buildMapProperties(mapping, entityModel) {\n   return propertyLines.join('\\n');\n }\n \n-function getRelatedMappings(mapping, related = [mapping]) {\n-  // get references to sub mappings\n+/**\n+ * Recursive function that returns a mapping for each property with a targetEntityType, which signifies that it is\n+ * mapping to an object property. Each of these will need to be converted into an m:entity XML template. The name of\n+ * each template is guaranteed to be unique by being based on the propertyPath and the title of each object property\n+ * being mapped. This ensures that we have uniquely-named templates in the XSLT transform that's generated from the\n+ * XML mapping template.\n+ *\n+ * @param mapping\n+ * @param propertyPath\n+ * @param objectPropertyMappings\n+ * @return {*[]}\n+ */\n+function getObjectPropertyMappings(mapping, propertyPath, objectPropertyMappings = []) {\n   if (dhMappingTraceIsEnabled) {\n     xdmp.trace(dhMappingTrace, `Getting related mappings for '${xdmp.describe(mapping)}'`);\n   }\n-  let internalMappings = mapping.xpath('/properties//object-node()[exists(targetEntityType) and exists(properties)]');\n-  for (let internalMapping of internalMappings) {\n-    related.push(internalMapping);\n-  }\n-  return related;\n+  Object.keys(mapping.properties).forEach(propertyTitle => {\n+    const property = mapping.properties[propertyTitle];", "originalCommit": "9fe0bdb53fda0da1659c00e940c7255b3b704952", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjE3ODM4OQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3622#discussion_r386178389", "bodyText": "I'll fix it, but it's really due to an invalid test file - that test is generating a mapping file with \"null\" as the value of \"properties\", which doesn't make any sense.", "author": "rjrudin", "createdAt": "2020-03-02T02:59:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjAwOTIzNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjIxMjM5NA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3622#discussion_r386212394", "bodyText": "True that about the mapping file in the test. When a mapping step is created a version 0 file has similar structure ie no properties.", "author": "bsrikan", "createdAt": "2020-03-02T06:15:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjAwOTIzNA=="}], "type": "inlineReview"}, {"oid": "75c3d69524b98f78b12be35c8e824799e11f6f9b", "url": "https://github.com/marklogic/marklogic-data-hub/commit/75c3d69524b98f78b12be35c8e824799e11f6f9b", "message": "DHFPROD-4285: Can now map multiple properties of the same entity type\n\n\"m:entity\" now refers to a unique property path instead of an entity type title.", "committedDate": "2020-03-02T03:06:17Z", "type": "forcePushed"}, {"oid": "75c3d69524b98f78b12be35c8e824799e11f6f9b", "url": "https://github.com/marklogic/marklogic-data-hub/commit/75c3d69524b98f78b12be35c8e824799e11f6f9b", "message": "DHFPROD-4285: Can now map multiple properties of the same entity type\n\n\"m:entity\" now refers to a unique property path instead of an entity type title.", "committedDate": "2020-03-02T03:06:17Z", "type": "commit"}]}