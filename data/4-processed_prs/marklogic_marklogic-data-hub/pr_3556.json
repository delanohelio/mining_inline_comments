{"pr_number": 3556, "pr_title": "DHFPROD-4350: Ensure config directories in AppConfig get changed prop\u2026", "pr_createdAt": "2020-02-06T05:30:12Z", "pr_url": "https://github.com/marklogic/marklogic-data-hub/pull/3556", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTY2NzMyNA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3556#discussion_r375667324", "bodyText": "String directory = payload.get(\"directory\");\nIf (StringUtils.isEmpty(directory)) { // input validation should be checked in UI side, and here just in case\n    //maybe logger.error(...)\n    return payload;\n}\nhubConfig.createProject(directory);\n...\n\nwe had better put the line  \"environmentService.setProjectDirectory(directory)\" to the end when dhf has been succcessfully installed.", "author": "hao1st", "createdAt": "2020-02-06T07:01:08Z", "path": "one-ui/src/main/java/com/marklogic/hub/oneui/controllers/EnvironmentController.java", "diffHunk": "@@ -106,23 +108,23 @@ public void onError(String commandName, Exception exception) {\n                 template.convertAndSend(\"/topic/install-status\", new StatusMessage(lastPercentageComplete, message));\n                 logger.error(message, exception);\n                 dataHubConfigurationException[0] = exception;\n-                environmentService.setProjectDirectory(originalDirectory);\n             }\n         };\n         // setting the project directory will resolve any relative paths\n         try {\n             environmentService.setProjectDirectory(payload.get(\"directory\").asText(\"\"));", "originalCommit": "1ce33defe9da1ba6d3e7c2b83662bf7939d7258d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTY3NjQ3NQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3556#discussion_r375676475", "bodyText": "After checking the HubConfigImpl, I think we can simplify unnecessary calls here. We even do not need to check if the hubConfigImpl.getAppConfig() is null because it is null for sure.\nHubConfigImpl.java\nprotected void hydrateAppConfigs(Properties properties) {\n    com.marklogic.mgmt.util.PropertySource propertySource = properties::getProperty;\n\n    if (appConfig != null) {\n        // Still need to call this since the setter also \"updates\" appConfig with DHF-specific values\n        setAppConfig(appConfig);\n    } else {\n        DefaultAppConfigFactory appConfigFactory = new DefaultAppConfigFactory(propertySource);\n        if (hubProject != null && !StringUtils.isEmpty(hubProject.getProjectDirString())) {\n            appConfigFactory.setProjectDir(hubProject.getProjectDir().toFile());\n        }\n        setAppConfig(appConfigFactory.newAppConfig());\n    }\n\n}\n...\nafter changing the HubConfigImpl class as above, we can only have the following three lines' codes\nhubConfigImpl.createProject(projectDirectory);\nhubConfigImpl.refreshProject();\nthis.dataHub = new DataHubImpl(this);\nIdeally,  we also should make the similar modification for initHubProject in HubConfigImpl.java\n@Override \n public void initHubProject() {\n        if (appConfig == null) {\n            DefaultAppConfigFactory appConfigFactory = new DefaultAppConfigFactory();\n            if (hubProject != null && !StringUtils.isEmpty(hubProject.getProjectDirString())) {\n                appConfigFactory.setProjectDir(hubProject.getProjectDir().toFile());\n            }\n            appConfig = appConfigFactory.newAppConfig();\n        }\n        addDhfPropertiesToCustomTokens(appConfig);\n        this.requireHubProject().init(appConfig.getCustomTokens());\n   }", "author": "hao1st", "createdAt": "2020-02-06T07:34:17Z", "path": "one-ui/src/main/java/com/marklogic/hub/oneui/models/HubConfigSession.java", "diffHunk": "@@ -1000,14 +1002,14 @@ public void afterPropertiesSet() throws Exception {\n         if (hubConfigImpl.getAdminManager() == null) {\n             hubConfigImpl.setAdminManager(new AdminManager());\n         }\n+        String projectDirectory = environmentService.getProjectDirectory();", "originalCommit": "1ce33defe9da1ba6d3e7c2b83662bf7939d7258d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTg5MDcxNg==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3556#discussion_r375890716", "bodyText": "@hao1st Are you saying to change hydrateAppConfigs? I know for certain that AppConfig is not always null in the context of that method.", "author": "rjrudin", "createdAt": "2020-02-06T15:10:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTY3NjQ3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTkzMTQ5MA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3556#discussion_r375931490", "bodyText": "Yes, I think the root cause is how we glue those HubConfig/HubProject/AppConfig together. For one-ui installation case, we only need to deal with the situation when AppConfig is null.  And my gut feeling is that passing a valid project directory to AppConfig is always what we expect.  Plus I think the one-ui higher level api call should be simplier during createProject/refreshProject. For me, the following calls are confused and a hacker way to workaround.\npublic void afterPropertiesSet() in HubConfigSession class\n\n        if (hubConfigImpl.getAppConfig() == null) {\n            hubConfigImpl.setAppConfig(new AppConfig(), true);\n            hubConfigImpl.setAppConfig(new AppConfig(Paths.get(projectDirectory).toFile()), true);\n        }\n        hubConfigImpl.createProject(environmentService.getProjectDirectory());\n        hubConfigImpl.createProject(projectDirectory);\n        hubConfigImpl.refreshProject();\n        // resetting app config to trigger updates to values\n        hubConfigImpl.setAppConfig(hubConfigImpl.getAppConfig(), false);\n        hubConfigImpl.hydrateConfigs();", "author": "hao1st", "createdAt": "2020-02-06T16:12:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTY3NjQ3NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTg5MjUyMA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3556#discussion_r375892520", "bodyText": "I think we really need unit tests for the changes in here. My experience over the past couple months with trying to make changes to HubConfigImpl is that it's very difficult to know what any change might break, due to the class doing too many things. You can likely pull some of these changes into protected methods so that it's easier to test what they're doing.", "author": "rjrudin", "createdAt": "2020-02-06T15:13:05Z", "path": "one-ui/src/main/java/com/marklogic/hub/oneui/models/HubConfigSession.java", "diffHunk": "@@ -1000,14 +1002,14 @@ public void afterPropertiesSet() throws Exception {\n         if (hubConfigImpl.getAdminManager() == null) {\n             hubConfigImpl.setAdminManager(new AdminManager());\n         }\n+        String projectDirectory = environmentService.getProjectDirectory();\n         if (hubConfigImpl.getAppConfig() == null) {\n-            hubConfigImpl.setAppConfig(new AppConfig(), true);\n+            hubConfigImpl.setAppConfig(new AppConfig(Paths.get(projectDirectory).toFile()), true);\n         }\n-        hubConfigImpl.createProject(environmentService.getProjectDirectory());\n+        hubConfigImpl.createProject(projectDirectory);", "originalCommit": "1ce33defe9da1ba6d3e7c2b83662bf7939d7258d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "c791aa83f614f2dfc88e1dcfea4caf4e417f8215", "url": "https://github.com/marklogic/marklogic-data-hub/commit/c791aa83f614f2dfc88e1dcfea4caf4e417f8215", "message": "DHFPROD-4350: Ensure config directories in AppConfig get changed properly on install", "committedDate": "2020-02-06T21:43:02Z", "type": "forcePushed"}, {"oid": "5d96d9e5f81358584d53fff576c8b8ecb4372d2f", "url": "https://github.com/marklogic/marklogic-data-hub/commit/5d96d9e5f81358584d53fff576c8b8ecb4372d2f", "message": "DHFPROD-4350: Ensure config directories in AppConfig get changed properly on install", "committedDate": "2020-02-06T21:44:35Z", "type": "forcePushed"}, {"oid": "da889fb21c171343182e4a9ec07592429ec277d8", "url": "https://github.com/marklogic/marklogic-data-hub/commit/da889fb21c171343182e4a9ec07592429ec277d8", "message": "DHFPROD-4350: Ensure config directories in AppConfig get changed properly on install", "committedDate": "2020-02-06T21:55:09Z", "type": "commit"}, {"oid": "da889fb21c171343182e4a9ec07592429ec277d8", "url": "https://github.com/marklogic/marklogic-data-hub/commit/da889fb21c171343182e4a9ec07592429ec277d8", "message": "DHFPROD-4350: Ensure config directories in AppConfig get changed properly on install", "committedDate": "2020-02-06T21:55:09Z", "type": "forcePushed"}]}