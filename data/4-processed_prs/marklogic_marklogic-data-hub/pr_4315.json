{"pr_number": 4315, "pr_title": "DHFPROD-5484: Package hub-central as a RPM", "pr_createdAt": "2020-07-30T16:11:19Z", "pr_url": "https://github.com/marklogic/marklogic-data-hub/pull/4315", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzEzMDg3Nw==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4315#discussion_r463130877", "bodyText": "Can you include a comment here indicating why this is needed - i.e. so we can run it as a service?\nI think Spring bean declarations and Gradle configuration blocks are similar - both can get a lot done in a small amount of code, but there's often a question of why the code exists. It's really slick that all we need is \"launchScript()\" here, but it begs the question of why we need it.", "author": "rjrudin", "createdAt": "2020-07-30T16:44:07Z", "path": "marklogic-data-hub-central/build.gradle", "diffHunk": "@@ -38,6 +39,7 @@ ext.junitJupiterVersion = '5.3.1'\n \n bootWar {\n     baseName = springBootJarName\n+    launchScript()", "originalCommit": "8432c73241070ec78248a74c684a840696e01b10", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzEzMTE3NQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4315#discussion_r463131175", "bodyText": "What does \"release\" mean/affect here? When would we change this to some other value?", "author": "rjrudin", "createdAt": "2020-07-30T16:44:31Z", "path": "marklogic-data-hub-central/build.gradle", "diffHunk": "@@ -186,6 +188,63 @@ test {\n \tuseJUnitPlatform()\n }\n \n+ospackage {\n+    packageName = 'hub-central'\n+    version = \"${project.version}\"\n+    release = 1", "originalCommit": "8432c73241070ec78248a74c684a840696e01b10", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzEzOTkzOA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4315#discussion_r463139938", "bodyText": "It refers to the RPM release version.\nWe increment the release version only if the payload (hub-central) of the RPM remains the same but RPM itself undergoes some change.\nMeaning if we publish the RPM with hub-central 5.3.0 and if the RPM scripts have some issue and need to be updated then we will increment the release number for the RPM.\nThe RPM name is generally of the type NVR (Name-Version-Release)\nSo in the above case it becomes\nhub-central-5.3.0-1.noarch.rpm -> hub-central-5.3.0-2.noarch.rpm", "author": "akshaysonvane", "createdAt": "2020-07-30T16:58:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzEzMTE3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzIyMzg5OA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4315#discussion_r463223898", "bodyText": "Got it, thanks. That may be worth adding as a comment above the \"release\" line, as I imagine other developers down the road will wonder how \"version\" and \"release\" interact.", "author": "rjrudin", "createdAt": "2020-07-30T19:32:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzEzMTE3NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzEzMzc1Ng==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4315#discussion_r463133756", "bodyText": "Can you try moving this config to \"build-rpm.gradle\" in the same directory? I've found that build.gradle files can become very long over time - this seems like an easy way to split it up. On the other hand, sometimes extracting a separate file is harder than it should be.\nIdeally, we can move the ospackage plugin declaration to build-rpm.gradle, and also the entire ospackage block. The trick is often where you apply the separate file within build.gradle. We may still need ospackage declared in build.gradle.\nThe benefit would be that we'd have one separate Gradle file for everything pertaining to the rpm, instead of having to sift through hundreds of lines of config in build.gradle to find it.", "author": "rjrudin", "createdAt": "2020-07-30T16:48:35Z", "path": "marklogic-data-hub-central/build.gradle", "diffHunk": "@@ -186,6 +188,63 @@ test {\n \tuseJUnitPlatform()\n }\n \n+ospackage {", "originalCommit": "8432c73241070ec78248a74c684a840696e01b10", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzE3ODMwMQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4315#discussion_r463178301", "bodyText": "Done", "author": "akshaysonvane", "createdAt": "2020-07-30T18:06:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzEzMzc1Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzEzOTk1OQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4315#discussion_r463139959", "bodyText": "One other comment - can you put these files under \"src/rpm\"? I like to avoid a lot of root-level directories, and these files all still count as \"source code\".", "author": "rjrudin", "createdAt": "2020-07-30T16:58:51Z", "path": "marklogic-data-hub-central/installer/configs/hub-central.conf", "diffHunk": "@@ -0,0 +1,6 @@\n+# The location of the java executable is discovered by using the PATH by default, ", "originalCommit": "8432c73241070ec78248a74c684a840696e01b10", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "0db7f21bcb05585ae03664bfadb155888b0cb166", "url": "https://github.com/marklogic/marklogic-data-hub/commit/0db7f21bcb05585ae03664bfadb155888b0cb166", "message": "DHFPROD-5484: Package hub-central as a RPM", "committedDate": "2020-07-30T17:51:49Z", "type": "forcePushed"}, {"oid": "922debd5124c98ef4e0751124c0052a585156f25", "url": "https://github.com/marklogic/marklogic-data-hub/commit/922debd5124c98ef4e0751124c0052a585156f25", "message": "DHFPROD-5484: Package hub-central as a RPM", "committedDate": "2020-07-30T18:04:17Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzE3ODEwMw==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4315#discussion_r463178103", "bodyText": "Build fails if we remove it from here.", "author": "akshaysonvane", "createdAt": "2020-07-30T18:05:53Z", "path": "marklogic-data-hub-central/build.gradle", "diffHunk": "@@ -13,6 +13,7 @@ buildscript {\n plugins {\n     id \"net.saliman.properties\" version \"1.5.1\"\n     id \"java\"\n+    id \"nebula.ospackage\" version \"8.4.1\"", "originalCommit": "922debd5124c98ef4e0751124c0052a585156f25", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzIyNDA5Nw==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4315#discussion_r463224097", "bodyText": "Figured, ah well.", "author": "rjrudin", "createdAt": "2020-07-30T19:32:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzE3ODEwMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzU5NDQ0MA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4315#discussion_r463594440", "bodyText": "This is really cool, thanks for getting this together. Makes me think we should opt for an rpm whenever possible now.", "author": "rjrudin", "createdAt": "2020-07-31T12:56:54Z", "path": "marklogic-data-hub-central/build-rpm.gradle", "diffHunk": "@@ -0,0 +1,55 @@\n+ospackage {\n+    packageName = 'hub-central'\n+    version = \"${project.version}\"\n+    release = 1\n+    os = LINUX\n+    type = BINARY\n+    arch = NOARCH\n+    summary = 'Hub Central Application Server'\n+    url = 'http://marklogic.com/'\n+    vendor = 'MarkLogic Corporation'\n+\n+    preInstall file('src/rpm/scripts/pre-install.sh')\n+    postInstall file('src/rpm/scripts/post-install.sh')\n+    preUninstall file('src/rpm/scripts/pre-uninstall.sh')\n+    postUninstall file('src/rpm/scripts/post-uninstall.sh')\n+\n+    requires('systemd')\n+\n+    user 'hc-runner'\n+    permissionGroup 'hc-runner'\n+\n+    from(war.outputs.files) {\n+        rename { String fileName ->\n+            fileName.replace(\"marklogic-data-hub-central-${project.version}\", \"hub-central\")\n+        }\n+        fileMode 0755\n+        into '/opt/hub-central'\n+    }\n+\n+    from('src/rpm/services/hub-central.service') {", "originalCommit": "922debd5124c98ef4e0751124c0052a585156f25", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzU5NDg5Mg==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4315#discussion_r463594892", "bodyText": "Can this line not be in build-rpm.gradle? No problem if it has to be here.", "author": "rjrudin", "createdAt": "2020-07-31T12:57:47Z", "path": "marklogic-data-hub-central/build.gradle", "diffHunk": "@@ -186,6 +192,7 @@ test {\n \tuseJUnitPlatform()\n }\n \n+tasks.buildRpm.dependsOn(buildUi, copyUiFiles, bootWar)", "originalCommit": "922debd5124c98ef4e0751124c0052a585156f25", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzY0NDAxOQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4315#discussion_r463644019", "bodyText": "Nope, can't move it.", "author": "akshaysonvane", "createdAt": "2020-07-31T14:27:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzU5NDg5Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzU5NTI2MQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4315#discussion_r463595261", "bodyText": "Where does this write the rpm file to?", "author": "rjrudin", "createdAt": "2020-07-31T12:58:38Z", "path": "marklogic-data-hub-central/build-rpm.gradle", "diffHunk": "@@ -0,0 +1,55 @@\n+ospackage {\n+    packageName = 'hub-central'\n+    version = \"${project.version}\"\n+    release = 1\n+    os = LINUX\n+    type = BINARY\n+    arch = NOARCH\n+    summary = 'Hub Central Application Server'\n+    url = 'http://marklogic.com/'\n+    vendor = 'MarkLogic Corporation'\n+\n+    preInstall file('src/rpm/scripts/pre-install.sh')\n+    postInstall file('src/rpm/scripts/post-install.sh')\n+    preUninstall file('src/rpm/scripts/pre-uninstall.sh')\n+    postUninstall file('src/rpm/scripts/post-uninstall.sh')\n+\n+    requires('systemd')\n+\n+    user 'hc-runner'\n+    permissionGroup 'hc-runner'\n+\n+    from(war.outputs.files) {\n+        rename { String fileName ->\n+            fileName.replace(\"marklogic-data-hub-central-${project.version}\", \"hub-central\")\n+        }\n+        fileMode 0755\n+        into '/opt/hub-central'\n+    }\n+\n+    from('src/rpm/services/hub-central.service') {\n+        addParentDirs(false)\n+        fileMode 0755\n+        into '/etc/systemd/system'\n+    }\n+\n+    from('src/rpm/configs/hub-central.conf') {\n+        fileType CONFIG | NOREPLACE\n+        fileMode 0644\n+        into '/opt/hub-central'\n+    }\n+\n+    from('src/rpm/configs/hub-central.properties') {\n+        addParentDirs(false)\n+        fileType CONFIG | NOREPLACE\n+        fileMode 0644\n+        into '/etc/opt/hub-central'\n+    }\n+}\n+\n+buildRpm {", "originalCommit": "922debd5124c98ef4e0751124c0052a585156f25", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzY0NDA3MQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4315#discussion_r463644071", "bodyText": "The RPM gets generated under marklogic-data-hub-central/build/distributions", "author": "akshaysonvane", "createdAt": "2020-07-31T14:28:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzU5NTI2MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzY3ODkwMw==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4315#discussion_r463678903", "bodyText": "Can you add a \"doLast\" block to buildRpm that logs that the rpm was written to \"./build/distributions\" (don't need to specify the filename, that'll be obvious)? Otherwise a developer testing this has no idea where the file is written to.\nAlso, when I ran this locally, I noticed that the hyphen in the version name was changed to a tilde: hub-central-5.3~SNAPSHOT-1.noarch.rpm . Do you know what that is? In theory, that won't matter in practice because our real version names don't have hyphens, just curious what's going on.", "author": "rjrudin", "createdAt": "2020-07-31T15:29:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzU5NTI2MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzcwNjEyMQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4315#discussion_r463706121", "bodyText": "I believe that's because of the RPM naming conventions:\n[name]-[version]-[release].[arch].rpm\nSince - is the only way to distinguish between 'version' and 'release' the Redline java library gets rid of all hyphens in the version section.", "author": "akshaysonvane", "createdAt": "2020-07-31T16:21:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzU5NTI2MQ=="}], "type": "inlineReview"}, {"oid": "b32bafb4aa0d268c3c0d8941592d563eb5dec925", "url": "https://github.com/marklogic/marklogic-data-hub/commit/b32bafb4aa0d268c3c0d8941592d563eb5dec925", "message": "DHFPROD-5484: Package hub-central as a RPM", "committedDate": "2020-07-31T16:23:18Z", "type": "commit"}, {"oid": "b32bafb4aa0d268c3c0d8941592d563eb5dec925", "url": "https://github.com/marklogic/marklogic-data-hub/commit/b32bafb4aa0d268c3c0d8941592d563eb5dec925", "message": "DHFPROD-5484: Package hub-central as a RPM", "committedDate": "2020-07-31T16:23:18Z", "type": "forcePushed"}]}