{"pr_number": 4025, "pr_title": "DHFPROD-4967: Grant role to allow users to save queries", "pr_createdAt": "2020-05-29T20:18:57Z", "pr_url": "https://github.com/marklogic/marklogic-data-hub/pull/4025", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjc0NDkwOQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4025#discussion_r432744909", "bodyText": "It's fine to do this, but I think soon, we should remove all of these assertions. If the roles/privileges weren't correctly written out, that \"bootstrap\" would fail and none of the tests would run. So these assertions are redundant and not adding any value. Fine to keep them for now, I'll look into removing all of them soon.", "author": "rjrudin", "createdAt": "2020-05-29T21:31:58Z", "path": "marklogic-data-hub/src/test/java/com/marklogic/hub/core/HubProjectTest.java", "diffHunk": "@@ -92,8 +92,8 @@ public void testInit() throws IOException {\n         assertTrue(new File(projectPath, \"src/main/hub-internal-config/security/roles/data-hub-step-definition-writer.json\").exists());\n         assertTrue(new File(projectPath, \"src/main/hub-internal-config/security/roles/data-hub-entity-model-reader.json\").exists());\n         assertTrue(new File(projectPath, \"src/main/hub-internal-config/security/roles/data-hub-entity-model-writer.json\").exists());\n-        assertTrue(new File(projectPath, \"src/main/hub-internal-config/security/roles/data-hub-saved-query-reader.json\").exists());\n-        assertTrue(new File(projectPath, \"src/main/hub-internal-config/security/roles/data-hub-saved-query-writer.json\").exists());\n+        assertTrue(new File(projectPath, \"src/main/hub-internal-config/security/roles/hub-central-saved-query-reader.json\").exists());", "originalCommit": "7e0c4648e4a3e659d731f52317375e3b0d74d2ee", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjc0NTM0MQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4025#discussion_r432745341", "bodyText": "Shouldn't you be able to do this without the \"data-hub-developer\" role, since this is an HC-specific capability?", "author": "rjrudin", "createdAt": "2020-05-29T21:33:07Z", "path": "marklogic-data-hub/src/test/ml-modules/root/test/suites/data-hub/5/data-services/lib/entitySearchService.sjs", "diffHunk": "@@ -1,5 +1,11 @@\n+const hubTest = require(\"/test/data-hub-test-helper.sjs\");\n+\n function invokeSavedQuery(module, args) {\n-  return fn.head(xdmp.invoke(\"/data-hub/5/data-services/entitySearch/\" + module, args));\n+  return fn.head(hubTest.runWithRolesAndPrivileges(\n+      ['data-hub-developer', 'hub-central-saved-query-reader', 'hub-central-saved-query-writer'], [],", "originalCommit": "7e0c4648e4a3e659d731f52317375e3b0d74d2ee", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjc1NTMzNg==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4025#discussion_r432755336", "bodyText": "Yes. It should. The any-uri, any-collection privileges should be added to hub-central-saved-query-writer.", "author": "rahulvudutala", "createdAt": "2020-05-29T21:50:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjc0NTM0MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjc1OTQyNQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4025#discussion_r432759425", "bodyText": "I think hub-central-saved-query-writer just needs to inherit data-hub-common then, right @ryanjdew ?", "author": "rjrudin", "createdAt": "2020-05-29T22:03:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjc0NTM0MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjc3NDk0Nw==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4025#discussion_r432774947", "bodyText": "data-hub-common-writer has the any-uri and unprotected-collections privileges. Should I extend that role?", "author": "rahulvudutala", "createdAt": "2020-05-29T22:59:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjc0NTM0MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjc4NDIwMA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4025#discussion_r432784200", "bodyText": "Yes, I think that's the way to go.", "author": "rjrudin", "createdAt": "2020-05-29T23:44:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjc0NTM0MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjc0NTg5Mw==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4025#discussion_r432745893", "bodyText": "I don't think we want these assertions here. Instead, what we care about is that the EntitySearchController endpoints are secured correctly. Those should have @secure(\"ROLE_manageSavedQuery\") on them. You can then more effectively test the logic below by trying to hit the endpoints in a subclass of AbstractMvcTest as a user with that the saved-query roles, and without them.", "author": "rjrudin", "createdAt": "2020-05-29T21:34:53Z", "path": "marklogic-data-hub/src/test/ml-modules/root/test/suites/data-hub/5/impl/security/getAuthoritiesTest.sjs", "diffHunk": "@@ -62,4 +49,13 @@ hubTest.runWithRolesAndPrivileges(['hub-central-mapping-writer'], [], function()\n     assertions.push(test.assertTrue(authorities.includes('readMapping'), 'hub-central-mapping-writer should have \"readMapping\"'));\n     assertions.push(test.assertTrue(authorities.includes('writeMapping'), 'hub-central-mapping-writer should not have \"writeMapping\"'));\n });\n+\n+// Test hub-central-saved-query-writer", "originalCommit": "7e0c4648e4a3e659d731f52317375e3b0d74d2ee", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "e8f21701a512cffb6e79edad571dd8a5c27ba9aa", "url": "https://github.com/marklogic/marklogic-data-hub/commit/e8f21701a512cffb6e79edad571dd8a5c27ba9aa", "message": "DHFPROD-4967: Adding hub-central roles for saved query documents\n\nDHFPROD-4967: UI Changes\n\nDHFPROD-4967: Running tests using hub-central-saved-query-writer", "committedDate": "2020-05-31T01:29:53Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzIzNDE1Mg==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4025#discussion_r433234152", "bodyText": "No need to change, but you can do this in one method - loginAsTestUserWithRoles.", "author": "rjrudin", "createdAt": "2020-06-01T13:30:04Z", "path": "marklogic-data-hub-central/src/test/java/com/marklogic/hub/central/controllers/EntitySearchControllerTest.java", "diffHunk": "@@ -45,6 +45,9 @@ void testCRUDOnSavedQuery() throws Exception {\n             \"  }\\n\" +\n             \"}\";\n \n+        setTestUserRoles(\"hub-central-saved-query-writer\", \"hub-central-saved-query-reader\");\n+        loginAsTestUser();", "originalCommit": "e8f21701a512cffb6e79edad571dd8a5c27ba9aa", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzIzNTg2NQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4025#discussion_r433235865", "bodyText": "There's a helper method in AbstractMvcTest to make this a little easier, and it guarantees that the user's authenticated HttpSession is used - verifyRequestIsForbidden. Please use this instead.", "author": "rjrudin", "createdAt": "2020-06-01T13:33:18Z", "path": "marklogic-data-hub-central/src/test/java/com/marklogic/hub/central/controllers/EntitySearchControllerTest.java", "diffHunk": "@@ -94,6 +97,14 @@ void testCRUDOnSavedQuery() throws Exception {\n                 ObjectNode response = readJsonObject(result.getResponse().getContentAsString());\n                 assertTrue(response.isEmpty());\n             });\n+\n+        // Try save/update/delete without the required role \"hub-central-saved-query-writer\"\n+        setTestUserRoles(\"hub-central-saved-query-reader\");\n+        loginAsTestUser();\n+\n+        postJson(SAVED_QUERIES_PATH, json).andExpect(status().isForbidden());", "originalCommit": "e8f21701a512cffb6e79edad571dd8a5c27ba9aa", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "b4fcc66f77b23a489a7fd1a5d8c89205ada6bf90", "url": "https://github.com/marklogic/marklogic-data-hub/commit/b4fcc66f77b23a489a7fd1a5d8c89205ada6bf90", "message": "DHFPROD-4967: Grant role to allow users to save queries backend changes\n\nDHFPROD-4967: UI Changes", "committedDate": "2020-06-02T17:55:37Z", "type": "forcePushed"}, {"oid": "84eb181494d44b24f077eb8f7206bad9a4d046aa", "url": "https://github.com/marklogic/marklogic-data-hub/commit/84eb181494d44b24f077eb8f7206bad9a4d046aa", "message": "DHFPROD-4967: Grant role to allow users to save queries backend changes\n\nDHFPROD-4967: UI Changes\n\nDHFPROD-4967: Removing data-hub-common-writer role and adding required privileges to data-hub-saved-query-user role", "committedDate": "2020-06-02T20:08:45Z", "type": "commit"}, {"oid": "84eb181494d44b24f077eb8f7206bad9a4d046aa", "url": "https://github.com/marklogic/marklogic-data-hub/commit/84eb181494d44b24f077eb8f7206bad9a4d046aa", "message": "DHFPROD-4967: Grant role to allow users to save queries backend changes\n\nDHFPROD-4967: UI Changes\n\nDHFPROD-4967: Removing data-hub-common-writer role and adding required privileges to data-hub-saved-query-user role", "committedDate": "2020-06-02T20:08:45Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDE3NTgxMw==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4025#discussion_r434175813", "bodyText": "Why is rest-writer needed here? Saved queries are written via Data Services. I don't think this is needed.\nAny I missed why data-hub-common-writer didn't work?", "author": "rjrudin", "createdAt": "2020-06-02T21:07:03Z", "path": "marklogic-data-hub/src/main/resources/hub-internal-config/security/roles/data-hub-saved-query-user.json", "diffHunk": "@@ -0,0 +1,31 @@\n+{\n+  \"role-name\": \"data-hub-saved-query-user\",\n+  \"description\": \"Permits read, update and delete saved query documents\",\n+  \"privilege\": [\n+    {\n+      \"privilege-name\": \"xdmp:document-load\",\n+      \"action\": \"http://marklogic.com/xdmp/privileges/xdmp-document-load\",\n+      \"kind\": \"execute\"\n+    },\n+    {\n+      \"privilege-name\": \"unprotected-collections\",\n+      \"action\": \"http://marklogic.com/xdmp/privileges/unprotected-collections\",\n+      \"kind\": \"execute\"\n+    },\n+    {\n+      \"privilege-name\": \"unprotected-uri\",\n+      \"action\": \"http://marklogic.com/xdmp/privileges/unprotected-uri\",\n+      \"kind\": \"execute\"\n+    },\n+    {", "originalCommit": "84eb181494d44b24f077eb8f7206bad9a4d046aa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDE3ODIzNQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4025#discussion_r434178235", "bodyText": "Yeah. The LeagacyFlowRunner test was failing as data-hub-common-writer has the any-uri privilege. The flowOperator is expected to have unprotected-uri, so I checked with @ryanjdew and added the privileges. These are the similar privileges that data-hub-common-writer has except for any-uri and ps-user", "author": "rahulvudutala", "createdAt": "2020-06-02T21:12:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDE3NTgxMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDE4NDI2NA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4025#discussion_r434184264", "bodyText": "Pinging @ryanjdew  - flow-operator-role.json has unprotected-uri, so I don't see how an error could have occurred here based on what's in data-hub-saved-query-user.", "author": "rjrudin", "createdAt": "2020-06-02T21:24:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDE3NTgxMw=="}], "type": "inlineReview"}]}