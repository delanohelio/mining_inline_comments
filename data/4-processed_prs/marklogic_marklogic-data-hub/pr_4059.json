{"pr_number": 4059, "pr_title": "DHFPROD-5078: Display default properties for entity search results", "pr_createdAt": "2020-06-05T22:20:57Z", "pr_url": "https://github.com/marklogic/marklogic-data-hub/pull/4059", "timeline": [{"oid": "d5d8acb8cfc26c60942b76372643817bec449100", "url": "https://github.com/marklogic/marklogic-data-hub/commit/d5d8acb8cfc26c60942b76372643817bec449100", "message": "DHFPROD-5078: Adding search transform for returning entity properties\n\nDHFPROD-5078: EntitySearch Transform Modules\n\nDHFPROD-5078: reference entity model changes\n\nDHFPROD-5078: Adding tests", "committedDate": "2020-06-05T23:24:03Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjY5NjM2Nw==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4059#discussion_r436696367", "bodyText": "Is this supposed to differ from the first shipping address?", "author": "rjrudin", "createdAt": "2020-06-08T13:23:27Z", "path": "examples/reference-entity-model/input/json/Cust2.json", "diffHunk": "@@ -4,21 +4,37 @@\n     \"FirstName\": \"Adams\",\n     \"LastName\": \"Cole\"\n   },\n+  \"nicknames\": [\n+    \"ad\",\n+    \"coley\"\n+  ],\n   \"Email\": \"adamscole@nutralab.com\",\n-  \"Address\": {\n-    \"Shipping\": {\n-      \"Street\": \"Lefferts Place\",\n-      \"City\": \"Marenisco\",\n-      \"State\": \"Maryland\",\n-      \"Postal\": \"44582-8427\"\n+  \"Address\": [\n+    {\n+      \"Shipping\": {\n+        \"Street\": \"Lefferts Place\",\n+        \"City\": \"Marenisco\",\n+        \"State\": \"Maryland\",\n+        \"Postal\": \"44582-8427\"\n+      }\n     },\n-    \"Billing\": {\n-      \"Street\": \"Varick Avenue\",\n-      \"City\": \"Mooresburg\",\n-      \"State\": \"Delaware\",\n-      \"Postal\": \"17654-1292\"\n+    {\n+      \"Shipping\": {\n+        \"Street\": \"Lefferts Place\",", "originalCommit": "d5d8acb8cfc26c60942b76372643817bec449100", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjY5NzI4Nw==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4059#discussion_r436697287", "bodyText": "Is it possible to select more than one entity type? If not, can we change this to a string instead of a List? We don't want the code to imply that something is possible when it's not.", "author": "rjrudin", "createdAt": "2020-06-08T13:24:27Z", "path": "marklogic-data-hub-central/src/main/java/com/marklogic/hub/central/entities/search/EntitySearchManager.java", "diffHunk": "@@ -96,6 +97,14 @@ public StringHandle search(SearchQuery searchQuery) {\n             String query = queryDef.serialize();\n             StructureWriteHandle handle = new StringHandle(buildSearchOptions(query, searchQuery)).withMimetype(\"application/xml\");\n             RawCombinedQueryDefinition rcQueryDef = queryMgr.newRawCombinedQueryDefinition(handle, queryDef.getOptionsName());\n+\n+            // If an entity has been selected, then apply this transform\n+            List<String> entityTypeIds = searchQuery.getQuery().getEntityTypeIds();", "originalCommit": "d5d8acb8cfc26c60942b76372643817bec449100", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjcxNzkyNw==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4059#discussion_r436717927", "bodyText": "@rjrudin When AllEntities are selected, there can be more than 1 entityTypeId", "author": "rahulvudutala", "createdAt": "2020-06-08T13:49:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjY5NzI4Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjcwMzM3Ng==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4059#discussion_r436703376", "bodyText": "Need a nice error here - I think you can use the \"throw\"* functions in ds-util.sjs to get it done easily - e.g. throwBadRequest(\"entityName is required to generate search results containing entity properties\");", "author": "rjrudin", "createdAt": "2020-06-08T13:32:13Z", "path": "marklogic-data-hub/src/main/resources/ml-modules/transforms/hubEntitySearchTransform.sjs", "diffHunk": "@@ -0,0 +1,30 @@\n+/**\n+ Copyright (c) 2020 MarkLogic Corporation\n+\n+ Licensed under the Apache License, Version 2.0 (the \"License\");\n+ you may not use this file except in compliance with the License.\n+ You may obtain a copy of the License at\n+\n+ http://www.apache.org/licenses/LICENSE-2.0\n+\n+ Unless required by applicable law or agreed to in writing, software\n+ distributed under the License is distributed on an \"AS IS\" BASIS,\n+ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ See the License for the specific language governing permissions and\n+ limitations under the License.\n+ */\n+'use strict';\n+\n+const entitySearchLib = require(\"/data-hub/5/entities/entity-search-lib.sjs\");\n+\n+// Expects JSON content\n+function transform(context, params, content) {\n+  // TODO If entityName isn't defined, throw a nice error", "originalCommit": "d5d8acb8cfc26c60942b76372643817bec449100", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "7d720d52b1b73dd88e41b6dc248d7ffd5a3e7332", "url": "https://github.com/marklogic/marklogic-data-hub/commit/7d720d52b1b73dd88e41b6dc248d7ffd5a3e7332", "message": "DHFPROD-5078: Adding search transform for returning entity properties\n\nDHFPROD-5078: EntitySearch Transform Modules\n\nDHFPROD-5078: reference entity model changes\n\nDHFPROD-5078: Adding tests\n\nDHFPROD-5078: Error handling for search transform and updating Customer input docs in reference-entity-model", "committedDate": "2020-06-08T14:23:06Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjc5MDU5MA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4059#discussion_r436790590", "bodyText": "Is this here in case \"envelope.instance\" does not exist? If so, we shouldn't return - this might be one of 10 results, and the other 9 are fine. I also don't think it's an error - it simply means we can't add entity properties to that result. I think it's worth xdmp.tracing this - you can add a \"TRACE_ENTITY_SEARCH\" constant to consts.sjs to use as a trace event, with a value of \"data-hub-entity-search\". But just log that an instance could not be found and thus entity properties will not be added.", "author": "rjrudin", "createdAt": "2020-06-08T15:21:06Z", "path": "marklogic-data-hub/src/main/resources/ml-modules/root/data-hub/5/entities/entity-search-lib.sjs", "diffHunk": "@@ -0,0 +1,124 @@\n+/**\n+ Copyright (c) 2020 MarkLogic Corporation\n+\n+ Licensed under the Apache License, Version 2.0 (the \"License\");\n+ you may not use this file except in compliance with the License.\n+ You may obtain a copy of the License at\n+\n+ http://www.apache.org/licenses/LICENSE-2.0\n+\n+ Unless required by applicable law or agreed to in writing, software\n+ distributed under the License is distributed on an \"AS IS\" BASIS,\n+ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ See the License for the specific language governing permissions and\n+ limitations under the License.\n+ */\n+'use strict';\n+\n+// TODO Will move this to /data-hub/5/entities soon\n+const entityLib = require(\"/data-hub/5/impl/entity-lib.sjs\");\n+const DataHub = require(\"/data-hub/5/datahub.sjs\");\n+const datahub = new DataHub();\n+\n+\n+function addPropertiesToSearchResponse(entityName, searchResponse) {\n+  const maxDefaultProperties = 5;\n+  const allProperties = generateEntityProperties(\"\", entityName, entityName);\n+  const defaultProperties = allProperties.slice(0, maxDefaultProperties);\n+\n+  // Add entityProperties to each search result\n+  searchResponse.results.forEach(result => {\n+    let instance = {};\n+    try {\n+      instance = cts.doc(result.uri).toObject().envelope.instance;\n+    } catch (error) {\n+      datahub.debug.log({message: error, type: 'error'});", "originalCommit": "7d720d52b1b73dd88e41b6dc248d7ffd5a3e7332", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjgwMDgyMQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4059#discussion_r436800821", "bodyText": "When would \"#\" not be the first token?\nI think it'd be good to move all of the logic in this for loop into a separate function that can be easily unit-tested - i.e. you want to make sure that the propertyMetadata returned for a given property definition is correct.\nThat also provides a good way of documenting all the different property definitions we support, which in theory would provide an example too of a \"$ref\" that does not start with \"#\".", "author": "rjrudin", "createdAt": "2020-06-08T15:35:44Z", "path": "marklogic-data-hub/src/main/resources/ml-modules/root/data-hub/5/entities/entity-search-lib.sjs", "diffHunk": "@@ -0,0 +1,124 @@\n+/**\n+ Copyright (c) 2020 MarkLogic Corporation\n+\n+ Licensed under the Apache License, Version 2.0 (the \"License\");\n+ you may not use this file except in compliance with the License.\n+ You may obtain a copy of the License at\n+\n+ http://www.apache.org/licenses/LICENSE-2.0\n+\n+ Unless required by applicable law or agreed to in writing, software\n+ distributed under the License is distributed on an \"AS IS\" BASIS,\n+ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ See the License for the specific language governing permissions and\n+ limitations under the License.\n+ */\n+'use strict';\n+\n+// TODO Will move this to /data-hub/5/entities soon\n+const entityLib = require(\"/data-hub/5/impl/entity-lib.sjs\");\n+const DataHub = require(\"/data-hub/5/datahub.sjs\");\n+const datahub = new DataHub();\n+\n+\n+function addPropertiesToSearchResponse(entityName, searchResponse) {\n+  const maxDefaultProperties = 5;\n+  const allProperties = generateEntityProperties(\"\", entityName, entityName);\n+  const defaultProperties = allProperties.slice(0, maxDefaultProperties);\n+\n+  // Add entityProperties to each search result\n+  searchResponse.results.forEach(result => {\n+    let instance = {};\n+    try {\n+      instance = cts.doc(result.uri).toObject().envelope.instance;\n+    } catch (error) {\n+      datahub.debug.log({message: error, type: 'error'});\n+      return;\n+    }\n+\n+    const entityInstance = instance[entityName];\n+    result.entityProperties = [];\n+    defaultProperties.forEach(parentProperty => {\n+      result.entityProperties.push(getPropertyValues(parentProperty, entityInstance));\n+    });\n+  });\n+\n+  // Make it easy for the client to know which property names were used, and which ones exist\n+  searchResponse.selectedPropertyDefinitions = defaultProperties;\n+  searchResponse.entityPropertyDefinitions = allProperties;\n+}\n+\n+function generateEntityProperties(parentPropertyName, entityName, entityTypeName) {\n+  const allProperties = [];\n+  const entityType = entityLib.findEntityTypeFromModelByEntityName(entityName, entityTypeName);\n+  if(!entityType) {\n+    return allProperties;\n+  }\n+\n+  for (var propertyName of Object.keys(entityType.properties)) {\n+    const property = entityType.properties[propertyName];\n+\n+    const isSimpleProperty = property.datatype != \"array\" && !property[\"$ref\"];\n+    const isSimpleArrayProperty = property.datatype == \"array\" && (property[\"items\"] && !property[\"items\"][\"$ref\"]);\n+    const isStructuredProperty = property.datatype != \"array\" && property[\"$ref\"];\n+    const isStructuredArrayProperty = property.datatype == \"array\" && (property[\"items\"] && property[\"items\"][\"$ref\"]);\n+\n+    const propertyMetadata = {};\n+    propertyMetadata[\"propertyPath\"] = parentPropertyName ? parentPropertyName + \".\" + propertyName : propertyName;\n+    propertyMetadata[\"propertyLabel\"] = propertyName;\n+    propertyMetadata[\"datatype\"] = (isSimpleProperty || isSimpleArrayProperty) ? (isSimpleProperty ? property.datatype : property[\"items\"][\"datatype\"]) : \"object\";\n+    propertyMetadata[\"multiple\"] = (isSimpleArrayProperty || isStructuredArrayProperty) ? true : false;\n+\n+    if(isStructuredProperty || isStructuredArrayProperty) {\n+      let referenceInfo = isStructuredProperty ? property[\"$ref\"].split(\"/\") : property[\"items\"][\"$ref\"].split(\"/\");\n+      entityTypeName =  referenceInfo.pop();\n+      entityName = referenceInfo[0] === \"#\" ? entityName : referenceInfo.pop().toString().split(\"-\")[0];", "originalCommit": "7d720d52b1b73dd88e41b6dc248d7ffd5a3e7332", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjgyMTA2NQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4059#discussion_r436821065", "bodyText": "Hold off on this - I'm going to try writing these tests myself, just to get familiar with the code. I'll submit a PR into your PR.", "author": "rjrudin", "createdAt": "2020-06-08T16:04:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjgwMDgyMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjg0NDgxNQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4059#discussion_r436844815", "bodyText": "When would \"#\" not be the first token?\nI think it'd be good to move all of the logic in this for loop into a separate function that can be easily unit-tested - i.e. you want to make sure that the propertyMetadata returned for a given property definition is correct.\nThat also provides a good way of documenting all the different property definitions we support, which in theory would provide an example too of a \"$ref\" that does not start with \"#\".\n\nWhen we referencing an entityType property from another entityModel. For example, orders from reference-entity-model project", "author": "rahulvudutala", "createdAt": "2020-06-08T16:41:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjgwMDgyMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjgwNTIwMA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4059#discussion_r436805200", "bodyText": "We want to be careful about when we're dealing with \"properties\" and \"property definitions\" - the distinction between the two is critical, and we want the code to make it easy to know when we're dealing with one vs the other.\nAnd really, I think calling this \"property metadata\" - as you're doing below - is better, as a \"property definition\" should exclusively refer to how a property is defined within an entity type.\nTo that end, let's standardize on \"property metadata\" here:\n\nselectedPropertyMetadata\nentityPropertyMetadata\nAnd then call this function buildPropertyMetadata (I prefer \"build\" for when in-memory data is built and not persisted)", "author": "rjrudin", "createdAt": "2020-06-08T15:42:17Z", "path": "marklogic-data-hub/src/main/resources/ml-modules/root/data-hub/5/entities/entity-search-lib.sjs", "diffHunk": "@@ -0,0 +1,124 @@\n+/**\n+ Copyright (c) 2020 MarkLogic Corporation\n+\n+ Licensed under the Apache License, Version 2.0 (the \"License\");\n+ you may not use this file except in compliance with the License.\n+ You may obtain a copy of the License at\n+\n+ http://www.apache.org/licenses/LICENSE-2.0\n+\n+ Unless required by applicable law or agreed to in writing, software\n+ distributed under the License is distributed on an \"AS IS\" BASIS,\n+ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ See the License for the specific language governing permissions and\n+ limitations under the License.\n+ */\n+'use strict';\n+\n+// TODO Will move this to /data-hub/5/entities soon\n+const entityLib = require(\"/data-hub/5/impl/entity-lib.sjs\");\n+const DataHub = require(\"/data-hub/5/datahub.sjs\");\n+const datahub = new DataHub();\n+\n+\n+function addPropertiesToSearchResponse(entityName, searchResponse) {\n+  const maxDefaultProperties = 5;\n+  const allProperties = generateEntityProperties(\"\", entityName, entityName);\n+  const defaultProperties = allProperties.slice(0, maxDefaultProperties);\n+\n+  // Add entityProperties to each search result\n+  searchResponse.results.forEach(result => {\n+    let instance = {};\n+    try {\n+      instance = cts.doc(result.uri).toObject().envelope.instance;\n+    } catch (error) {\n+      datahub.debug.log({message: error, type: 'error'});\n+      return;\n+    }\n+\n+    const entityInstance = instance[entityName];\n+    result.entityProperties = [];\n+    defaultProperties.forEach(parentProperty => {\n+      result.entityProperties.push(getPropertyValues(parentProperty, entityInstance));\n+    });\n+  });\n+\n+  // Make it easy for the client to know which property names were used, and which ones exist\n+  searchResponse.selectedPropertyDefinitions = defaultProperties;\n+  searchResponse.entityPropertyDefinitions = allProperties;\n+}\n+\n+function generateEntityProperties(parentPropertyName, entityName, entityTypeName) {", "originalCommit": "7d720d52b1b73dd88e41b6dc248d7ffd5a3e7332", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjgwNTgxNg==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4059#discussion_r436805816", "bodyText": "I think we need to throw an error here, as something is very wrong if we cannot find the model. Should do a ds.throwServerError with a message indicating what entity cannot be found.", "author": "rjrudin", "createdAt": "2020-06-08T15:43:06Z", "path": "marklogic-data-hub/src/main/resources/ml-modules/root/data-hub/5/entities/entity-search-lib.sjs", "diffHunk": "@@ -0,0 +1,124 @@\n+/**\n+ Copyright (c) 2020 MarkLogic Corporation\n+\n+ Licensed under the Apache License, Version 2.0 (the \"License\");\n+ you may not use this file except in compliance with the License.\n+ You may obtain a copy of the License at\n+\n+ http://www.apache.org/licenses/LICENSE-2.0\n+\n+ Unless required by applicable law or agreed to in writing, software\n+ distributed under the License is distributed on an \"AS IS\" BASIS,\n+ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ See the License for the specific language governing permissions and\n+ limitations under the License.\n+ */\n+'use strict';\n+\n+// TODO Will move this to /data-hub/5/entities soon\n+const entityLib = require(\"/data-hub/5/impl/entity-lib.sjs\");\n+const DataHub = require(\"/data-hub/5/datahub.sjs\");\n+const datahub = new DataHub();\n+\n+\n+function addPropertiesToSearchResponse(entityName, searchResponse) {\n+  const maxDefaultProperties = 5;\n+  const allProperties = generateEntityProperties(\"\", entityName, entityName);\n+  const defaultProperties = allProperties.slice(0, maxDefaultProperties);\n+\n+  // Add entityProperties to each search result\n+  searchResponse.results.forEach(result => {\n+    let instance = {};\n+    try {\n+      instance = cts.doc(result.uri).toObject().envelope.instance;\n+    } catch (error) {\n+      datahub.debug.log({message: error, type: 'error'});\n+      return;\n+    }\n+\n+    const entityInstance = instance[entityName];\n+    result.entityProperties = [];\n+    defaultProperties.forEach(parentProperty => {\n+      result.entityProperties.push(getPropertyValues(parentProperty, entityInstance));\n+    });\n+  });\n+\n+  // Make it easy for the client to know which property names were used, and which ones exist\n+  searchResponse.selectedPropertyDefinitions = defaultProperties;\n+  searchResponse.entityPropertyDefinitions = allProperties;\n+}\n+\n+function generateEntityProperties(parentPropertyName, entityName, entityTypeName) {\n+  const allProperties = [];\n+  const entityType = entityLib.findEntityTypeFromModelByEntityName(entityName, entityTypeName);\n+  if(!entityType) {\n+    return allProperties;", "originalCommit": "7d720d52b1b73dd88e41b6dc248d7ffd5a3e7332", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjg0NjA0Ng==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4059#discussion_r436846046", "bodyText": "If a user does not permissions on entityModels, the data returned should be empty rather than throwing an error.", "author": "rahulvudutala", "createdAt": "2020-06-08T16:43:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjgwNTgxNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjgxNzU5Ng==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4059#discussion_r436817596", "bodyText": "What's an example that requires the second part of this conditional to be present? I think the first part of the conditional would suffice?", "author": "rjrudin", "createdAt": "2020-06-08T15:59:38Z", "path": "marklogic-data-hub/src/main/resources/ml-modules/root/data-hub/5/entities/entity-search-lib.sjs", "diffHunk": "@@ -0,0 +1,124 @@\n+/**\n+ Copyright (c) 2020 MarkLogic Corporation\n+\n+ Licensed under the Apache License, Version 2.0 (the \"License\");\n+ you may not use this file except in compliance with the License.\n+ You may obtain a copy of the License at\n+\n+ http://www.apache.org/licenses/LICENSE-2.0\n+\n+ Unless required by applicable law or agreed to in writing, software\n+ distributed under the License is distributed on an \"AS IS\" BASIS,\n+ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ See the License for the specific language governing permissions and\n+ limitations under the License.\n+ */\n+'use strict';\n+\n+// TODO Will move this to /data-hub/5/entities soon\n+const entityLib = require(\"/data-hub/5/impl/entity-lib.sjs\");\n+const DataHub = require(\"/data-hub/5/datahub.sjs\");\n+const datahub = new DataHub();\n+\n+\n+function addPropertiesToSearchResponse(entityName, searchResponse) {\n+  const maxDefaultProperties = 5;\n+  const allProperties = generateEntityProperties(\"\", entityName, entityName);\n+  const defaultProperties = allProperties.slice(0, maxDefaultProperties);\n+\n+  // Add entityProperties to each search result\n+  searchResponse.results.forEach(result => {\n+    let instance = {};\n+    try {\n+      instance = cts.doc(result.uri).toObject().envelope.instance;\n+    } catch (error) {\n+      datahub.debug.log({message: error, type: 'error'});\n+      return;\n+    }\n+\n+    const entityInstance = instance[entityName];\n+    result.entityProperties = [];\n+    defaultProperties.forEach(parentProperty => {\n+      result.entityProperties.push(getPropertyValues(parentProperty, entityInstance));\n+    });\n+  });\n+\n+  // Make it easy for the client to know which property names were used, and which ones exist\n+  searchResponse.selectedPropertyDefinitions = defaultProperties;\n+  searchResponse.entityPropertyDefinitions = allProperties;\n+}\n+\n+function generateEntityProperties(parentPropertyName, entityName, entityTypeName) {\n+  const allProperties = [];\n+  const entityType = entityLib.findEntityTypeFromModelByEntityName(entityName, entityTypeName);\n+  if(!entityType) {\n+    return allProperties;\n+  }\n+\n+  for (var propertyName of Object.keys(entityType.properties)) {\n+    const property = entityType.properties[propertyName];\n+\n+    const isSimpleProperty = property.datatype != \"array\" && !property[\"$ref\"];\n+    const isSimpleArrayProperty = property.datatype == \"array\" && (property[\"items\"] && !property[\"items\"][\"$ref\"]);\n+    const isStructuredProperty = property.datatype != \"array\" && property[\"$ref\"];\n+    const isStructuredArrayProperty = property.datatype == \"array\" && (property[\"items\"] && property[\"items\"][\"$ref\"]);\n+\n+    const propertyMetadata = {};\n+    propertyMetadata[\"propertyPath\"] = parentPropertyName ? parentPropertyName + \".\" + propertyName : propertyName;\n+    propertyMetadata[\"propertyLabel\"] = propertyName;\n+    propertyMetadata[\"datatype\"] = (isSimpleProperty || isSimpleArrayProperty) ? (isSimpleProperty ? property.datatype : property[\"items\"][\"datatype\"]) : \"object\";\n+    propertyMetadata[\"multiple\"] = (isSimpleArrayProperty || isStructuredArrayProperty) ? true : false;\n+\n+    if(isStructuredProperty || isStructuredArrayProperty) {\n+      let referenceInfo = isStructuredProperty ? property[\"$ref\"].split(\"/\") : property[\"items\"][\"$ref\"].split(\"/\");\n+      entityTypeName =  referenceInfo.pop();\n+      entityName = referenceInfo[0] === \"#\" ? entityName : referenceInfo.pop().toString().split(\"-\")[0];\n+      propertyMetadata[\"properties\"] = generateEntityProperties(propertyMetadata[\"propertyPath\"], entityName, entityTypeName);\n+    }\n+    allProperties.push(propertyMetadata);\n+  }\n+  return allProperties;\n+}\n+\n+function getPropertyValues(currentProperty, entityInstance) {\n+  let resultObject = {};\n+  resultObject.propertyPath = currentProperty.propertyPath;\n+  if(currentProperty.datatype === \"object\") {\n+    resultObject.propertyValue = [];\n+\n+    let propertyName = currentProperty.propertyPath.split(\".\").pop();\n+    if(!entityInstance[propertyName] || Object.keys(entityInstance[propertyName]).length == 0) {", "originalCommit": "7d720d52b1b73dd88e41b6dc248d7ffd5a3e7332", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjgyNjY1OQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4059#discussion_r436826659", "bodyText": "billingAddress: { }", "author": "rahulvudutala", "createdAt": "2020-06-08T16:12:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjgxNzU5Ng=="}], "type": "inlineReview"}, {"oid": "d1a3a3eb6414095bda8fcaa11fafa67ba493a160", "url": "https://github.com/marklogic/marklogic-data-hub/commit/d1a3a3eb6414095bda8fcaa11fafa67ba493a160", "message": "DHFPROD-5078: Adding search transform for returning entity properties\n\nDHFPROD-5078: EntitySearch Transform Modules\n\nDHFPROD-5078: reference entity model changes\n\nDHFPROD-5078: Adding tests\n\nDHFPROD-5078: Error handling for search transform and updating Customer input docs in reference-entity-model", "committedDate": "2020-06-08T17:58:31Z", "type": "forcePushed"}, {"oid": "6935e16909f6d80c7981538318c3b32987ad2ed1", "url": "https://github.com/marklogic/marklogic-data-hub/commit/6935e16909f6d80c7981538318c3b32987ad2ed1", "message": "DHFPROD-5078: Adding search transform for returning entity properties\n\nDHFPROD-5078: EntitySearch Transform Modules\n\nDHFPROD-5078: reference entity model changes\n\nDHFPROD-5078: Adding tests\n\nDHFPROD-5078: Error handling for search transform and updating Customer input docs in reference-entity-model", "committedDate": "2020-06-08T21:28:31Z", "type": "forcePushed"}, {"oid": "8743574e387161ee93519165a7da36fd92390764", "url": "https://github.com/marklogic/marklogic-data-hub/commit/8743574e387161ee93519165a7da36fd92390764", "message": "DHFPROD-5078: Adding search transform for returning entity properties\n\nDHFPROD-5078: EntitySearch Transform Modules\n\nDHFPROD-5078: reference entity model changes\n\nDHFPROD-5078: Adding tests\n\nDHFPROD-5078: Error handling for search transform and updating Customer input docs in reference-entity-model\n\nMaking Address/Street into an array", "committedDate": "2020-06-08T22:30:57Z", "type": "commit"}, {"oid": "8743574e387161ee93519165a7da36fd92390764", "url": "https://github.com/marklogic/marklogic-data-hub/commit/8743574e387161ee93519165a7da36fd92390764", "message": "DHFPROD-5078: Adding search transform for returning entity properties\n\nDHFPROD-5078: EntitySearch Transform Modules\n\nDHFPROD-5078: reference entity model changes\n\nDHFPROD-5078: Adding tests\n\nDHFPROD-5078: Error handling for search transform and updating Customer input docs in reference-entity-model\n\nMaking Address/Street into an array", "committedDate": "2020-06-08T22:30:57Z", "type": "forcePushed"}]}