{"pr_number": 4529, "pr_title": "DHFPROD-5338: Bookmark redirect", "pr_createdAt": "2020-09-04T06:33:45Z", "pr_url": "https://github.com/marklogic/marklogic-data-hub/pull/4529", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDUwNDg4Ng==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4529#discussion_r484504886", "bodyText": "noticed a lot of redirect requests for /websocket when running e2e. Filtering /websocket alongwith /api gets rid of the issue. Will probably push the changes after running some more e2e tests", "author": "bsrikan", "createdAt": "2020-09-07T15:57:56Z", "path": "marklogic-data-hub-central/src/main/java/com/marklogic/hub/central/auth/WebSecurityConfiguration.java", "diffHunk": "@@ -55,7 +59,13 @@ protected void configure(HttpSecurity http) throws Exception {\n             .addFilterAfter(new AuthenticationFilter(hubCentral, hubClientProvider), LogoutFilter.class)\n             .csrf().disable()\n             // Need to setStatus, sendError causes issues. see https://stackoverflow.com/a/34911131\n-            .exceptionHandling().authenticationEntryPoint(((request, response, authException) -> response.setStatus(HttpServletResponse.SC_UNAUTHORIZED)))\n+            .exceptionHandling().authenticationEntryPoint(((request, response, authException) -> {\n+                if (request.getRequestURI().startsWith(\"/api/\")) {", "originalCommit": "5899c981dac988aba90cd95521388b57047124a3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDU3NjYzOQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4529#discussion_r484576639", "bodyText": "This is fixed now.", "author": "bsrikan", "createdAt": "2020-09-07T22:17:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDUwNDg4Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDUwNTE2Mw==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4529#discussion_r484505163", "bodyText": "location should probably be loc @wooldridge ?", "author": "bsrikan", "createdAt": "2020-09-07T15:58:44Z", "path": "marklogic-data-hub-central/ui/src/App.tsx", "diffHunk": "@@ -41,6 +41,16 @@ const App: React.FC<Props> = ({history, location}) => {\n     )}/>\n   );\n \n+  const getPageRoute = (loc) => {\n+    if (loc.search && loc.search.startsWith(\"?from=\")) {\n+      return decodeURIComponent(loc.search.substring(6));\n+    } else if (location.pathname !== '/' && location.pathname !== '/noresponse') {\n+      return location.pathname", "originalCommit": "5899c981dac988aba90cd95521388b57047124a3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDU3NjY2NA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4529#discussion_r484576664", "bodyText": "Fixed.", "author": "bsrikan", "createdAt": "2020-09-07T22:17:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDUwNTE2Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDUxNTg1OA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4529#discussion_r484515858", "bodyText": "If bookmark url contains /tiles/explore/detail, authentication leads to 500 Internal Server Error, since docUri seems to be undefined: http://localhost:3000/api/entitySearch?docUri=undefined\nDetail component gets the uri from either location.state or from user preferences in LocalStorage. If the LocalStorage for the user doesnt include uri, we will get 500 Internal Server Error. Pinging @rahulvudutala  and @Sanjeevani19 for awarerness.", "author": "bsrikan", "createdAt": "2020-09-07T16:32:05Z", "path": "marklogic-data-hub-central/ui/src/App.tsx", "diffHunk": "@@ -53,9 +63,8 @@ const App: React.FC<Props> = ({history, location}) => {\n     } else {\n       if (user.error.type !== '') {\n         history.push('/error');\n-      } else if (location.pathname !== '/' && location.pathname !== '/noresponse') {\n-        user.pageRoute = location.pathname;\n       }\n+      user.pageRoute = getPageRoute(location);", "originalCommit": "5899c981dac988aba90cd95521388b57047124a3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDUxODI2MA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4529#discussion_r484518260", "bodyText": "Recently @xnikhil08 made changes to the uri as a part of this PR #4489, he might have a better idea about this.", "author": "Sanjeevani19", "createdAt": "2020-09-07T16:40:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDUxNTg1OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDY0NTExOQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4529#discussion_r484645119", "bodyText": "@bsrikan - are you still facing this issue?", "author": "xnikhil08", "createdAt": "2020-09-08T04:37:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDUxNTg1OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTAwNjg3OA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4529#discussion_r485006878", "bodyText": "@xnikhil08 yes, I am able to reproduce the 500 error when trying to login as a user who saved the bookmark, when there is no local storage. Its also easily reproducible when the bookmark is used by a different user.", "author": "bsrikan", "createdAt": "2020-09-08T15:24:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDUxNTg1OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTA1NTA3Ng==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4529#discussion_r485055076", "bodyText": "Can we fix this by either 1. moving necessary information to the URL or 2. redirecting to a different page if the docUri is undefined?", "author": "wooldridge", "createdAt": "2020-09-08T16:38:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDUxNTg1OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTI1MzkwNw==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4529#discussion_r485253907", "bodyText": "@bsrikan I addressed this error by redirecting to Explore when there is no URI accessible for the Detail view.", "author": "wooldridge", "createdAt": "2020-09-08T23:41:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDUxNTg1OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTkyMzg1Mg==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4529#discussion_r485923852", "bodyText": "Thanks @wooldridge . Fixed login e2e test to reflect the change.", "author": "bsrikan", "createdAt": "2020-09-09T21:10:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDUxNTg1OA=="}], "type": "inlineReview"}, {"oid": "c513445113b7487884e5d5a1078653c220482084", "url": "https://github.com/marklogic/marklogic-data-hub/commit/c513445113b7487884e5d5a1078653c220482084", "message": "DHFPROD-5338: e2e test and minor redirect fixes", "committedDate": "2020-09-07T20:39:23Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDU3NjQyMg==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4529#discussion_r484576422", "bodyText": "Fixed this redirect on 404 to /tiles from /home for \"Back Home\" button", "author": "bsrikan", "createdAt": "2020-09-07T22:15:44Z", "path": "marklogic-data-hub-central/ui/src/pages/noMatchRedirect.tsx", "diffHunk": "@@ -14,16 +14,16 @@ const NoMatchRedirect = ({history}) => {\n   }, []);\n \n   const backToHomePage = () => {\n-    return user.authenticated ? history.push('/home') : history.push('/');\n+    return user.authenticated ? history.push('/tiles') : history.push('/');", "originalCommit": "c513445113b7487884e5d5a1078653c220482084", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTc2Mzg4Ng==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4529#discussion_r485763886", "bodyText": "Thanks for fixing this.", "author": "wooldridge", "createdAt": "2020-09-09T16:43:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDU3NjQyMg=="}], "type": "inlineReview"}, {"oid": "1d1096b27c398a43533dfa7ff95003f7ee19edfa", "url": "https://github.com/marklogic/marklogic-data-hub/commit/1d1096b27c398a43533dfa7ff95003f7ee19edfa", "message": "DHFPROD-5338: Handle internal bookmarks when unauthorized\n1. Redirect user to login\n2. Include route as URL param for redirection\n\nDHFPROD-5338: e2e test and minor redirect fixes\n\nDHFPROD-5338: When Detail URI is undefined, redirect to Explore\n\nDHFPROD-5338: add unit test, updated e2e for login", "committedDate": "2020-09-09T21:06:14Z", "type": "commit"}, {"oid": "1d1096b27c398a43533dfa7ff95003f7ee19edfa", "url": "https://github.com/marklogic/marklogic-data-hub/commit/1d1096b27c398a43533dfa7ff95003f7ee19edfa", "message": "DHFPROD-5338: Handle internal bookmarks when unauthorized\n1. Redirect user to login\n2. Include route as URL param for redirection\n\nDHFPROD-5338: e2e test and minor redirect fixes\n\nDHFPROD-5338: When Detail URI is undefined, redirect to Explore\n\nDHFPROD-5338: add unit test, updated e2e for login", "committedDate": "2020-09-09T21:06:14Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTkyMzMxOQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4529#discussion_r485923319", "bodyText": "@ryanjdew @brucean52 @wooldridge I made this change to mock user context, since an authenticated user will have /tiles as landing page route.", "author": "bsrikan", "createdAt": "2020-09-09T21:09:18Z", "path": "marklogic-data-hub-central/ui/src/assets/mock-data/user-context-mock.ts", "diffHunk": "@@ -34,7 +34,7 @@ export const userAuthenticated: IUserContextInterface = Object.assign(defaultUse\n     error : {\n       type: ''\n     },\n-    pageRoute: '/',\n+    pageRoute: '/tiles',", "originalCommit": "1d1096b27c398a43533dfa7ff95003f7ee19edfa", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}