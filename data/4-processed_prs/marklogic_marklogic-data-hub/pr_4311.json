{"pr_number": 4311, "pr_title": "DHFPROD-5492: Manage session timeout across multiple tabs", "pr_createdAt": "2020-07-29T20:14:48Z", "pr_url": "https://github.com/marklogic/marklogic-data-hub/pull/4311", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjU3NzA3OQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4311#discussion_r462577079", "bodyText": "These should be removed, as @akshaysonvane has a separate ticket for logging these via logger.error.", "author": "rjrudin", "createdAt": "2020-07-29T20:44:28Z", "path": "marklogic-data-hub-central/src/main/java/com/marklogic/hub/central/exceptions/CustomExceptionHandler.java", "diffHunk": "@@ -41,6 +41,7 @@\n     @ExceptionHandler(FailedRequestException.class)\n     protected ResponseEntity<JsonNode> handleFailedRequestExceptionRequest(\n         FailedRequestException failedRequestException) {\n+        failedRequestException.printStackTrace();", "originalCommit": "8f676373951c97acc4170db971ae5db80afe5b13", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjYxODgxOA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4311#discussion_r462618818", "bodyText": "Yeah. Meant to back those changes out before pushing.", "author": "ryanjdew", "createdAt": "2020-07-29T22:09:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjU3NzA3OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjU3OTA2Mg==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4311#discussion_r462579062", "bodyText": "Autowiring in the HttpSession makes me nervous - I think it's simpler just to declare an HttpServletRequest as a parameter of getSystemInfo() (you may be able to declare HttpSession as a parameter too, I forget if Spring MVC will populate it automatically). You can get the session from the HttpServletRequest.", "author": "rjrudin", "createdAt": "2020-07-29T20:48:21Z", "path": "marklogic-data-hub-central/src/main/java/com/marklogic/hub/central/controllers/EnvironmentController.java", "diffHunk": "@@ -76,6 +81,11 @@ public SystemInfo getSystemInfo() {\n         info.marklogicVersion = versionInfo.getMarkLogicVersion();\n         info.host = hubCentral.getHost();\n         info.sessionTimeout = environment.getProperty(\"server.servlet.session.timeout\");\n+        Optional.of(session).ifPresent((session) -> {", "originalCommit": "8f676373951c97acc4170db971ae5db80afe5b13", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mjk0NzU2Nw==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4311#discussion_r462947567", "bodyText": "Just verified, you can just declare HttpSession as a parameter - https://www.logicbig.com/tutorials/spring-framework/spring-web-mvc/http-session-param.html - I think that's the better way to go, also makes testing easier. Note that the session will never be null too.", "author": "rjrudin", "createdAt": "2020-07-30T12:03:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjU3OTA2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzcyMzU1OQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4311#discussion_r463723559", "bodyText": "Moved to a parameter.", "author": "ryanjdew", "createdAt": "2020-07-31T16:57:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjU3OTA2Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjU3OTgyOQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4311#discussion_r462579829", "bodyText": "I feel it'd be safer for this to be explicitly named for its purpose today, which is for checking session status, right? So this could be \"/websocket/sessionStatus\", and we'd want to explicitly list that here instead of allowing anything under \"/websocket/\" (as we could add another path under \"/websocket/\" that does require authentication and forget to update this).", "author": "rjrudin", "createdAt": "2020-07-29T20:49:46Z", "path": "marklogic-data-hub-central/src/main/java/com/marklogic/hub/central/auth/WebSecurityConfiguration.java", "diffHunk": "@@ -71,6 +71,7 @@ protected void configure(HttpSecurity http) throws Exception {\n      */\n     protected String[] getAlwaysPermittedPatterns() {\n         return new String[]{\n+            \"/websocket/**\",", "originalCommit": "8f676373951c97acc4170db971ae5db80afe5b13", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzcyNjg0Ng==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4311#discussion_r463726846", "bodyText": "There are a lot more endpoints called for setting up WebSockets and they include randomly generated paths, so determining all the patterns that should be permitted isn't really practical.\nI was able to remove the WebSockets permitted pattern by refactoring the front-end to not attempt to connect to WebSockets when logged out, which was bring the browser its knees with connection attempts.", "author": "ryanjdew", "createdAt": "2020-07-31T17:04:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjU3OTgyOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjU4MDU1Ng==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4311#discussion_r462580556", "bodyText": "How could the template be null, since it's passed into the constructor? If it could be null, then the constructor should throw an exception because the system is ostensibly misconfigured.", "author": "rjrudin", "createdAt": "2020-07-29T20:51:04Z", "path": "marklogic-data-hub-central/src/main/java/com/marklogic/hub/central/auth/SessionMonitorInterceptor.java", "diffHunk": "@@ -0,0 +1,46 @@\n+package com.marklogic.hub.central.auth;\n+\n+import org.jetbrains.annotations.NotNull;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.context.annotation.Configuration;\n+import org.springframework.messaging.simp.SimpMessagingTemplate;\n+import org.springframework.stereotype.Component;\n+import org.springframework.web.servlet.HandlerInterceptor;\n+\n+import javax.servlet.http.HttpServletRequest;\n+import javax.servlet.http.HttpServletResponse;\n+import javax.servlet.http.HttpSession;\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+public class SessionMonitorInterceptor implements HandlerInterceptor {\n+    static final Map<String, Object> stompHeaders = new HashMap<>() {{\n+        put(\"content-type\",\"application/json\");\n+    }};\n+\n+    private SimpMessagingTemplate template;\n+\n+    public SessionMonitorInterceptor(SimpMessagingTemplate template) {\n+        this.template = template;\n+    }\n+\n+    @Override\n+    public boolean preHandle(\n+            HttpServletRequest request, @NotNull HttpServletResponse response, @NotNull Object handler) throws Exception {\n+        HttpSession session = request.getSession();\n+        if (!(template == null || session == null)) {", "originalCommit": "8f676373951c97acc4170db971ae5db80afe5b13", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjU4MDg3NQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4311#discussion_r462580875", "bodyText": "I think this \"else\" block goes away since we don't need to check for the template being null.", "author": "rjrudin", "createdAt": "2020-07-29T20:51:39Z", "path": "marklogic-data-hub-central/src/main/java/com/marklogic/hub/central/auth/SessionMonitorInterceptor.java", "diffHunk": "@@ -0,0 +1,46 @@\n+package com.marklogic.hub.central.auth;\n+\n+import org.jetbrains.annotations.NotNull;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.context.annotation.Configuration;\n+import org.springframework.messaging.simp.SimpMessagingTemplate;\n+import org.springframework.stereotype.Component;\n+import org.springframework.web.servlet.HandlerInterceptor;\n+\n+import javax.servlet.http.HttpServletRequest;\n+import javax.servlet.http.HttpServletResponse;\n+import javax.servlet.http.HttpSession;\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+public class SessionMonitorInterceptor implements HandlerInterceptor {\n+    static final Map<String, Object> stompHeaders = new HashMap<>() {{\n+        put(\"content-type\",\"application/json\");\n+    }};\n+\n+    private SimpMessagingTemplate template;\n+\n+    public SessionMonitorInterceptor(SimpMessagingTemplate template) {\n+        this.template = template;\n+    }\n+\n+    @Override\n+    public boolean preHandle(\n+            HttpServletRequest request, @NotNull HttpServletResponse response, @NotNull Object handler) throws Exception {\n+        HttpSession session = request.getSession();\n+        if (!(template == null || session == null)) {\n+            int sessionTimeout = session.getMaxInactiveInterval();\n+            template.convertAndSend(\"/topic/sessionStatus/\"+session.getAttribute(\"hubCentralSessionToken\"), new SessionStatus(sessionTimeout), stompHeaders);\n+        } else {\n+            System.out.println(\"Template: \" + template + \"\\nSession: \" + session);", "originalCommit": "8f676373951c97acc4170db971ae5db80afe5b13", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjU4MTU0NQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4311#discussion_r462581545", "bodyText": "I think both of these beans need comments to explain what's going on here. Referencing Spring docs on this is fine too. But the typical problem with Spring beans like this is they get a lot done in a small amount of code, but it's not clear why we're doing this.", "author": "rjrudin", "createdAt": "2020-07-29T20:52:54Z", "path": "marklogic-data-hub-central/src/main/java/com/marklogic/hub/central/WebSocketConfig.java", "diffHunk": "@@ -0,0 +1,39 @@\n+/*\n+ * Copyright 2012-2020 MarkLogic Corporation\n+ *\n+ *  Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *  you may not use this file except in compliance with the License.\n+ *  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  Unless required by applicable law or agreed to in writing, software\n+ *  distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *  See the License for the specific language governing permissions and\n+ *  limitations under the License.\n+ *\n+ */\n+package com.marklogic.hub.central;\n+\n+import org.springframework.context.annotation.Configuration;\n+import org.springframework.messaging.simp.config.MessageBrokerRegistry;\n+import org.springframework.web.socket.config.annotation.EnableWebSocketMessageBroker;\n+import org.springframework.web.socket.config.annotation.StompEndpointRegistry;\n+import org.springframework.web.socket.config.annotation.WebSocketMessageBrokerConfigurer;\n+\n+@Configuration\n+@EnableWebSocketMessageBroker\n+public class WebSocketConfig implements WebSocketMessageBrokerConfigurer {\n+\n+    @Override", "originalCommit": "8f676373951c97acc4170db971ae5db80afe5b13", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjYzMTAxNg==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4311#discussion_r462631016", "bodyText": "Why do we need a WebSocket to send the session timeout value continuously?\nWouldn't getMaxInactiveInterval always return 300 (5 minutes) in our case?", "author": "akshaysonvane", "createdAt": "2020-07-29T22:40:29Z", "path": "marklogic-data-hub-central/src/main/java/com/marklogic/hub/central/auth/SessionMonitorInterceptor.java", "diffHunk": "@@ -0,0 +1,46 @@\n+package com.marklogic.hub.central.auth;\n+\n+import org.jetbrains.annotations.NotNull;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.context.annotation.Configuration;\n+import org.springframework.messaging.simp.SimpMessagingTemplate;\n+import org.springframework.stereotype.Component;\n+import org.springframework.web.servlet.HandlerInterceptor;\n+\n+import javax.servlet.http.HttpServletRequest;\n+import javax.servlet.http.HttpServletResponse;\n+import javax.servlet.http.HttpSession;\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+public class SessionMonitorInterceptor implements HandlerInterceptor {\n+    static final Map<String, Object> stompHeaders = new HashMap<>() {{\n+        put(\"content-type\",\"application/json\");\n+    }};\n+\n+    private SimpMessagingTemplate template;\n+\n+    public SessionMonitorInterceptor(SimpMessagingTemplate template) {\n+        this.template = template;\n+    }\n+\n+    @Override\n+    public boolean preHandle(\n+            HttpServletRequest request, @NotNull HttpServletResponse response, @NotNull Object handler) throws Exception {\n+        HttpSession session = request.getSession();\n+        if (!(template == null || session == null)) {\n+            int sessionTimeout = session.getMaxInactiveInterval();", "originalCommit": "8f676373951c97acc4170db971ae5db80afe5b13", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mjk1MjE2MA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4311#discussion_r462952160", "bodyText": "I'm puzzled by that too - this is a constant value. I thought the intent was for the middle tier to send a message when the session expired, and/or when there are N seconds remaining before session expiration.\nAn HttpSessionListener can be used for sending a message when the session expires.\nIf there's a requirement for sending a message N seconds before expiration - I'm not sure how to do that. I could imagine some object we store in the HttpSession that waits until N seconds before expiration to send a message. That object would be overridden/reset every time a request is received.", "author": "rjrudin", "createdAt": "2020-07-30T12:13:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjYzMTAxNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzczNzAyMw==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4311#discussion_r463737023", "bodyText": "As @rjrudin points out, the HtttpSessionListener doesn't allow us to catch the situation where we are N seconds before closing the connection. The only opportunity to catch that is with each request. So with each request, I'm using the interceptor to reset the session count down on the front-end side.\nI'll make an update to only send out the update if the session last accessed time was more than a second ago to cut down on some of the chatter.", "author": "ryanjdew", "createdAt": "2020-07-31T17:26:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjYzMTAxNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjYzMjk4MQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4311#discussion_r462632981", "bodyText": "Do we need some sort of cross tab communication to propagate the timeout events on all tabs  https://dev.to/naismith/cross-tab-communication-with-javascript-1hc9", "author": "akshaysonvane", "createdAt": "2020-07-29T22:45:57Z", "path": "marklogic-data-hub-central/ui/src/util/user-context.tsx", "diffHunk": "@@ -40,8 +41,27 @@ const UserProvider: React.FC<{ children: any }> = ({children}) => {\n   const [user, setUser] = useState<UserContextInterface>(defaultUserData);\n   const sessionUser = localStorage.getItem('dataHubUser');\n   const authoritiesService = useContext(AuthoritiesContext);\n+  const stompService = useContext(StompContext);\n   let sessionCount = 300;\n   let sessionTimer = true;\n+  let unsubscribeId;\n+  const monitorSession = async () => {\n+    stompService.onConnected().then(() => {\n+      const hubCentralSessionToken = localStorage.getItem('hubCentralSessionToken');\n+      stompService.messages.subscribe((message) => {\n+        sessionCount = parseInt(JSON.parse(message.body).sessionTimeout);\n+      });\n+      stompService.subscribe(`/topic/sessionStatus/${hubCentralSessionToken}`, (msgId: string) => {\n+        unsubscribeId = msgId;\n+      });\n+    });\n+  };", "originalCommit": "8f676373951c97acc4170db971ae5db80afe5b13", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzcyMDQ0Mg==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4311#discussion_r463720442", "bodyText": "Each tab will be subscribed to the same sessionToken via WebSockets, so each tab will have sessionCount updated.", "author": "ryanjdew", "createdAt": "2020-07-31T16:51:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjYzMjk4MQ=="}], "type": "inlineReview"}, {"oid": "4ea30ba2f5700cc4ccf57673022894d0208487a5", "url": "https://github.com/marklogic/marklogic-data-hub/commit/4ea30ba2f5700cc4ccf57673022894d0208487a5", "message": "DHFPROD-5492: Manage session timeout across multiple tabs", "committedDate": "2020-07-30T19:21:27Z", "type": "forcePushed"}, {"oid": "d22e25a6a66deb5d475d7bd5ead00a1103e8d1aa", "url": "https://github.com/marklogic/marklogic-data-hub/commit/d22e25a6a66deb5d475d7bd5ead00a1103e8d1aa", "message": "DHFPROD-5492: Manage session timeout across multiple tabs", "committedDate": "2020-07-31T17:29:42Z", "type": "forcePushed"}, {"oid": "a31042e9cac55b6724dc7509aecaec7b8c457b93", "url": "https://github.com/marklogic/marklogic-data-hub/commit/a31042e9cac55b6724dc7509aecaec7b8c457b93", "message": "DHFPROD-5492: Manage session timeout across multiple tabs", "committedDate": "2020-08-04T21:28:45Z", "type": "forcePushed"}, {"oid": "67e9216a119c0e933f67ce0d84adf82f36a0083e", "url": "https://github.com/marklogic/marklogic-data-hub/commit/67e9216a119c0e933f67ce0d84adf82f36a0083e", "message": "DHFPROD-5492: Manage session timeout across multiple tabs", "committedDate": "2020-08-05T05:57:48Z", "type": "forcePushed"}, {"oid": "11b3df3862e7b2a6f90fa062b0980fdf93fee9fa", "url": "https://github.com/marklogic/marklogic-data-hub/commit/11b3df3862e7b2a6f90fa062b0980fdf93fee9fa", "message": "DHFPROD-5492: Manage session timeout across multiple tabs", "committedDate": "2020-08-05T16:02:29Z", "type": "forcePushed"}, {"oid": "c82d703d961ccf518f27b2df96c3a1328239778d", "url": "https://github.com/marklogic/marklogic-data-hub/commit/c82d703d961ccf518f27b2df96c3a1328239778d", "message": "DHFPROD-5492: Manage session timeout across multiple tabs", "committedDate": "2020-08-05T19:14:24Z", "type": "forcePushed"}, {"oid": "4f091bc133444570fcb958534be543334101b036", "url": "https://github.com/marklogic/marklogic-data-hub/commit/4f091bc133444570fcb958534be543334101b036", "message": "DHFPROD-5492: Manage session timeout across multiple tabs", "committedDate": "2020-08-05T21:02:38Z", "type": "commit"}, {"oid": "4f091bc133444570fcb958534be543334101b036", "url": "https://github.com/marklogic/marklogic-data-hub/commit/4f091bc133444570fcb958534be543334101b036", "message": "DHFPROD-5492: Manage session timeout across multiple tabs", "committedDate": "2020-08-05T21:02:38Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjA1MjYzNA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4311#discussion_r466052634", "bodyText": "Minor nitpick, no need to change, for now, we can get rid of these commented out lines.", "author": "akshaysonvane", "createdAt": "2020-08-05T23:08:12Z", "path": "marklogic-data-hub-central/src/main/java/com/marklogic/hub/central/auth/WebSecurityConfiguration.java", "diffHunk": "@@ -55,12 +59,19 @@ protected void configure(HttpSecurity http) throws Exception {\n             .and()\n             // Define requests that are always permitted, regardless of whether the user is authenticated or not\n             .authorizeRequests()\n+                // Needed for websocket tests\n+//                .antMatchers(\"/websocket/**\").permitAll()", "originalCommit": "4f091bc133444570fcb958534be543334101b036", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjA1Mjg1Ng==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4311#discussion_r466052856", "bodyText": "@rjrudin, FYI, we are permitting access to /websocket/** only while running tests.  So the production app has all endpoints behind spring security.", "author": "akshaysonvane", "createdAt": "2020-08-05T23:08:47Z", "path": "marklogic-data-hub-central/src/main/java/com/marklogic/hub/central/auth/WebSecurityConfiguration.java", "diffHunk": "@@ -55,12 +59,19 @@ protected void configure(HttpSecurity http) throws Exception {\n             .and()\n             // Define requests that are always permitted, regardless of whether the user is authenticated or not\n             .authorizeRequests()\n+                // Needed for websocket tests\n+//                .antMatchers(\"/websocket/**\").permitAll()\n                 // Needed for springfox to work - see https://github.com/springfox/springfox/issues/1996#issuecomment-335155187\n                 .antMatchers(\"/swagger-resources/**\", \"/swagger-ui.html\", \"/v2/api-docs\", \"/webjars/**\").permitAll()\n                 // Non-springfox patterns to permit\n-                .antMatchers(getAlwaysPermittedPatterns()).permitAll().anyRequest().authenticated()\n-            .and()\n-            .logout().logoutUrl(\"/api/logout\").logoutSuccessHandler(((request, response, authentication) -> request.getSession().invalidate()));\n+                .antMatchers(getAlwaysPermittedPatterns()).permitAll();\n+        // needed for WebSocket test\n+        if (environment.getProperty(\"hub.websocket.securityDisabled\",\"false\").equals(\"true\")) {\n+            http.authorizeRequests().antMatchers(\"/websocket/**\").permitAll();\n+        }", "originalCommit": "4f091bc133444570fcb958534be543334101b036", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}