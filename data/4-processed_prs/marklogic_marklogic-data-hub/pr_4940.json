{"pr_number": 4940, "pr_title": "DHFPROD-6284:Throw 4xx error when using fn:error if appropriate", "pr_createdAt": "2020-12-04T21:17:06Z", "pr_url": "https://github.com/marklogic/marklogic-data-hub/pull/4940", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzMyNDUyNg==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4940#discussion_r537324526", "bodyText": "@rjrudin ,\nThis change and a similar change in flow-lib.sjs in dhfprod-6284 are causing a number of test failures (These failures are for changes in flow-lib.sjs https://jenkins.marklogic.com/blue/organizations/jenkins/Datahub_CI/detail/develop/1692/tests/  alone). Should we not make this change in dhf 4 modules ? I am seeing that no matter a 4.x flow flow succeeds or fails, it always returns a http 200.", "author": "srinathgit", "createdAt": "2020-12-07T08:44:07Z", "path": "marklogic-data-hub/src/main/resources/ml-modules/root/data-hub/4/impl/flow-lib.xqy", "diffHunk": "@@ -1023,7 +1026,7 @@ declare function flow:safe-run($func)\n     catch($ex) {\n       debug:log(xdmp:describe($ex, (), ())),\n       trace:error-trace($rfc:item-context, $ex, xdmp:elapsed-time() - $before),\n-      fn:error((), \"DATAHUB-PLUGIN-ERROR\", $ex)\n+      httputils:throw-bad-request((), $ex)", "originalCommit": "065c4aee9cbe30766ddb908e02383d96920b9920", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzUxMjY3Nw==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4940#discussion_r537512677", "bodyText": "@srinathgit If a 200 is always returned, then yeah - no need to change these. Can you add a comment at the top of flow-lib.xqy and flow-lib.sjs describing why we're not using the httpUtils functions so future developers are aware?", "author": "rjrudin", "createdAt": "2020-12-07T13:39:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzMyNDUyNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzUxNTE3NA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4940#discussion_r537515174", "bodyText": "Can you test this to see what error you get in the client that calls an endpoint that invokes this trigger? I am thinking that the first argument adds no value and should be returned. We don't have some list of error codes that a user can refer to, and returning something that looks like an error code implies that we do keep a list like that. I'm thinking it's less confusing if we just return the error message starting with \"Unable to validate\".", "author": "rjrudin", "createdAt": "2020-12-07T13:43:10Z", "path": "marklogic-data-hub/src/main/resources/ml-modules/root/data-hub/4/triggers/entity-model-validate-trigger.xqy", "diffHunk": "@@ -84,7 +86,7 @@ let $uber-model :=\n     (: build uber model with original info :)\n     return hent:uber-model((xdmp:to-json($entity-def-map)/object-node(), $supporting-entity-defs)) => map:with(\"info\", $info-map)\n   } catch ($e) {\n-    fn:error(xs:QName(\"INVALID-MODEL\"), \"Unable to validate entity model at URI: \" || $trgr:uri || \"; cause: \" || xdmp:quote($e))\n+    httputils:throw-bad-request(xs:QName(\"INVALID-MODEL\"), \"Unable to validate entity model at URI: \" || $trgr:uri || \"; cause: \" || xdmp:quote($e))", "originalCommit": "065c4aee9cbe30766ddb908e02383d96920b9920", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzcxNDczMw==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4940#discussion_r537714733", "bodyText": "The first argument is error name as xs:Qname(). The second one is the code which is always \"RESTAPI-SRVEXERR\"(for 400, 404)\nfn:error((xs:QName(\"FAILED\")), \"RESTAPI-SRVEXERR\",(400,\"greater than 50\"))\nreturns\nRESTAPI-SRVEXERR: (FAILED) Extension Error: code: 400 message: greater than 50 document: %3\n2020-12-07 09:50:37.707 Info:+  <error:code>RESTAPI-SRVEXERR</error:code>\n2020-12-07 09:50:37.707 Info:+  <error:name>FAILED</error:name>\n2020-12-07 09:50:37.707 Info:+  <error:xquery-version>1.0-ml</error:xquery-version>\n2020-12-07 09:50:37.707 Info:+  <error:message>Extension Error: </error:message>\n2020-12-07 09:50:37.707 Info:+  <error:format-string>RESTAPI-SRVEXERR: (FAILED) Extension Error:  code: 400 message: greater than 50 document: %3</error:format-string>\n....\n\nfn:error( (), \"RESTAPI-SRVEXERR\",(400,\"greater than 50\")) returns\n RESTAPI-SRVEXERR: (err:FOER0000) Extension Error: code: 400 message: greater than 50 document: %3\n\n2020-12-07 09:49:40.410 Info:+  <error:code>RESTAPI-SRVEXERR</error:code>\n2020-12-07 09:49:40.410 Info:+  <error:name>err:FOER0000</error:name>\n2020-12-07 09:49:40.410 Info:+  <error:xquery-version>1.0-ml</error:xquery-version>\n2020-12-07 09:49:40.410 Info:+  <error:message>Extension Error: </error:message>\n2020-12-07 09:49:40.410 Info:+  <error:format-string>RESTAPI-SRVEXERR: (err:FOER0000) Extension Error:  code: 400 message: greater than 50 document: %3</error:format-string>\n...", "author": "srinathgit", "createdAt": "2020-12-07T18:03:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzUxNTE3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzcyMzYyMg==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4940#discussion_r537723622", "bodyText": "Oh I see, I missed that part. Looks good then.", "author": "rjrudin", "createdAt": "2020-12-07T18:17:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzUxNTE3NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzUxNTU4NQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4940#discussion_r537515585", "bodyText": "Why include \"()\" as the first arg here?", "author": "rjrudin", "createdAt": "2020-12-07T13:43:48Z", "path": "marklogic-data-hub/src/main/resources/ml-modules/services/mlFlow.xqy", "diffHunk": "@@ -69,7 +72,7 @@ declare function get(\n           return\n             if (fn:exists($flow)) then $flow\n             else\n-              fn:error((),\"RESTAPI-SRVEXERR\", (404, \"Not Found\", \"The requested flow was not found\"))\n+              httputils:throw-not-found((), \"The requested flow was not found\")", "originalCommit": "065c4aee9cbe30766ddb908e02383d96920b9920", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzcxNTI4NA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4940#discussion_r537715284", "bodyText": "In many places we pass error name (first argument for e.g. in SM project), so included that param.", "author": "srinathgit", "createdAt": "2020-12-07T18:04:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzUxNTU4NQ=="}], "type": "inlineReview"}, {"oid": "9094005b9c6aed009cdccb6b3832c9974c4bc63e", "url": "https://github.com/marklogic/marklogic-data-hub/commit/9094005b9c6aed009cdccb6b3832c9974c4bc63e", "message": "DHFPROD-6284:Throw 4xx error when using fn:error if appropriate", "committedDate": "2020-12-07T23:41:37Z", "type": "forcePushed"}, {"oid": "b1e8e07c6e046e2fd49e070ee79db065fa57e31f", "url": "https://github.com/marklogic/marklogic-data-hub/commit/b1e8e07c6e046e2fd49e070ee79db065fa57e31f", "message": "DHFPROD-6284:Throw 4xx error when using fn:error if appropriate", "committedDate": "2020-12-08T02:23:58Z", "type": "commit"}, {"oid": "b1e8e07c6e046e2fd49e070ee79db065fa57e31f", "url": "https://github.com/marklogic/marklogic-data-hub/commit/b1e8e07c6e046e2fd49e070ee79db065fa57e31f", "message": "DHFPROD-6284:Throw 4xx error when using fn:error if appropriate", "committedDate": "2020-12-08T02:23:58Z", "type": "forcePushed"}]}