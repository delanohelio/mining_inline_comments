{"pr_number": 4057, "pr_title": "DHFPROD-4670: Add hub-central-flow-writer role", "pr_createdAt": "2020-06-05T21:02:49Z", "pr_url": "https://github.com/marklogic/marklogic-data-hub/pull/4057", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjIwMDYwNA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4057#discussion_r436200604", "bodyText": "Is this change intentional. Srinath fixed it so test will pass in 9.0-12.", "author": "bsrikan", "createdAt": "2020-06-05T23:04:30Z", "path": "marklogic-data-hub-central/src/test/java/com/marklogic/hub/central/controllers/FlowMvcTest.java", "diffHunk": "@@ -25,12 +25,7 @@\n     @Test\n     void runIngestionStep() throws Exception {\n         installReferenceModelProject();\n-        if(isVersionCompatibleWith520Roles()) {\n-            loginAsTestUserWithRoles(\"hub-central-step-runner\");\n-        }\n-        else {\n-            loginAsTestUserWithRoles(\"hub-central-step-runner\", \"flow-operator-role\");\n-        }\n+        loginAsTestUserWithRoles(\"hub-central-step-runner\");", "originalCommit": "67a97c24dfbc6b1fa4d5a974a1547f51a09fcb90", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjIwMTM3NQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4057#discussion_r436201375", "bodyText": "Yes. I adjusted hub-central-step-runner to work with both 9.0-12 and 10.0-*", "author": "ryanjdew", "createdAt": "2020-06-05T23:08:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjIwMDYwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjIwMzU1Nw==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4057#discussion_r436203557", "bodyText": "Thanks Ryan. I deleted the other comment after seeing the existing flow was asserted and it seems to have deleted your comment as well. Sorry about that.", "author": "bsrikan", "createdAt": "2020-06-05T23:19:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjIwMDYwNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjIwNDUyMw==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4057#discussion_r436204523", "bodyText": "Currently we have tests for Run tile in Run.test.tsx, but they are run as developer and operator. Should we run them as flow-writer and step runner instead, so we would have verified a flow can be run with a lesser and more appropriate authority?", "author": "bsrikan", "createdAt": "2020-06-05T23:23:50Z", "path": "marklogic-data-hub-central/ui/src/pages/Run.tsx", "diffHunk": "@@ -34,7 +34,7 @@ const Run: React.FC = () => {\n     const authorityService = useContext(AuthoritiesContext);\n     const canReadFlow = authorityService.canReadStep();\n     const canWriteFlow = authorityService.canWriteStep();\n-    const hasOperatorRole = authorityService.hasOperatorRole();\n+    const hasOperatorRole = authorityService.canRunStep();", "originalCommit": "67a97c24dfbc6b1fa4d5a974a1547f51a09fcb90", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjIwNzI3Ng==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4057#discussion_r436207276", "bodyText": "wouldn't hurt. I'll adjust that.", "author": "ryanjdew", "createdAt": "2020-06-05T23:37:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjIwNDUyMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjIwNjMyMA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4057#discussion_r436206320", "bodyText": "Nice. I should probably comment after am done reviewing everything top down.\nWith this I think we can keep the Run tests as is and you can ignore my comment earlier regarding Run.test.", "author": "bsrikan", "createdAt": "2020-06-05T23:32:14Z", "path": "marklogic-data-hub-central/ui/src/pages/TilesView.test.tsx", "diffHunk": "@@ -106,8 +106,10 @@ describe('TilesView component', () => {\n \n     });\n \n-    test('Verify Run tile displays from toolbar', async () => {\n-        const {getByLabelText, getByText, queryByText, getByTestId} = await render(<AuthoritiesContext.Provider value={ mockDevRolesService}><TilesView/></AuthoritiesContext.Provider>);\n+    test('Verify Run tile displays from toolbar and can create/edit/delete with writeStep authority', async () => {\n+        const authorityService = new AuthoritiesService();\n+        authorityService.setAuthorities(['readStep','writeStep','runStep']);", "originalCommit": "67a97c24dfbc6b1fa4d5a974a1547f51a09fcb90", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjIwNjU0Mw==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4057#discussion_r436206543", "bodyText": "Can we add a custom step to run.config and verify it shows up in Run tile for these authorities?", "author": "bsrikan", "createdAt": "2020-06-05T23:33:31Z", "path": "marklogic-data-hub-central/ui/src/pages/TilesView.test.tsx", "diffHunk": "@@ -136,7 +138,7 @@ describe('TilesView component', () => {\n         expect(getByTestId('runStep-1')).toBeInTheDocument();\n     });\n \n-    test('Verify run tile cannot edit with only readStep authority', async () => {\n+    test('Verify run tile cannot edit or run with only readStep authority', async () => {", "originalCommit": "67a97c24dfbc6b1fa4d5a974a1547f51a09fcb90", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjIwODEyMQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4057#discussion_r436208121", "bodyText": "sure", "author": "ryanjdew", "createdAt": "2020-06-05T23:42:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjIwNjU0Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjgwMjUyMA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4057#discussion_r436802520", "bodyText": "added a custom step and a mapping step", "author": "ryanjdew", "createdAt": "2020-06-08T15:38:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjIwNjU0Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjQxOTQ2Mg==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4057#discussion_r436419462", "bodyText": "I think this needs to be writeFlow. I had asked Shannon to change step-writer to flow-writer because the role allows for modifying flows, not steps. We have separate roles - one per step type - that control who can write a step.", "author": "rjrudin", "createdAt": "2020-06-08T00:58:28Z", "path": "marklogic-data-hub-central/src/main/java/com/marklogic/hub/central/controllers/FlowController.java", "diffHunk": "@@ -54,32 +54,37 @@\n     @RequestMapping(method = RequestMethod.POST)\n     @ResponseBody\n     @ApiOperation(value = \"Create a flow\", response = FlowInfo.class)\n+    @Secured(\"ROLE_writeStep\")", "originalCommit": "67a97c24dfbc6b1fa4d5a974a1547f51a09fcb90", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjgwMjg3Ng==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4057#discussion_r436802876", "bodyText": "Refactored these to be readFlow/writeFlow", "author": "ryanjdew", "createdAt": "2020-06-08T15:38:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjQxOTQ2Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjQxOTU0MQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4057#discussion_r436419541", "bodyText": "I think \"runStep\" is fine, because ultimately the user is running a step that's defined within a particular flow.", "author": "rjrudin", "createdAt": "2020-06-08T00:59:36Z", "path": "marklogic-data-hub-central/ui/src/config/authorities.config.ts", "diffHunk": "@@ -49,7 +49,7 @@ class DeveloperRolesService implements IAuthoritiesContextInterface{\n     public isSavedQueryUser:() => boolean = () => {\n         return true;\n     };\n-    public hasOperatorRole:() => boolean = () => {\n+    public canRunStep:() => boolean = () => {", "originalCommit": "67a97c24dfbc6b1fa4d5a974a1547f51a09fcb90", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "ecd0ccd0a15f380499a0d80a6fa561b847c3e634", "url": "https://github.com/marklogic/marklogic-data-hub/commit/ecd0ccd0a15f380499a0d80a6fa561b847c3e634", "message": "DHFPROD-4670: Add hub-central-flow-writer role", "committedDate": "2020-06-08T05:53:14Z", "type": "forcePushed"}, {"oid": "9d314bba281b78a0386d1e9deda8f824dd6aa976", "url": "https://github.com/marklogic/marklogic-data-hub/commit/9d314bba281b78a0386d1e9deda8f824dd6aa976", "message": "DHFPROD-4670: Add hub-central-flow-writer role", "committedDate": "2020-06-08T17:12:29Z", "type": "forcePushed"}, {"oid": "0897f9b6a2eefcb0c022b85ee1a8758f4095de7b", "url": "https://github.com/marklogic/marklogic-data-hub/commit/0897f9b6a2eefcb0c022b85ee1a8758f4095de7b", "message": "DHFPROD-4670: Add hub-central-flow-writer role", "committedDate": "2020-06-08T20:27:08Z", "type": "forcePushed"}, {"oid": "990e3ea628d8ffe6b556b54f85e2f28a9ac61ccf", "url": "https://github.com/marklogic/marklogic-data-hub/commit/990e3ea628d8ffe6b556b54f85e2f28a9ac61ccf", "message": "DHFPROD-4670: Add hub-central-flow-writer role", "committedDate": "2020-06-08T23:55:21Z", "type": "commit"}, {"oid": "990e3ea628d8ffe6b556b54f85e2f28a9ac61ccf", "url": "https://github.com/marklogic/marklogic-data-hub/commit/990e3ea628d8ffe6b556b54f85e2f28a9ac61ccf", "message": "DHFPROD-4670: Add hub-central-flow-writer role", "committedDate": "2020-06-08T23:55:21Z", "type": "forcePushed"}]}