{"pr_number": 3567, "pr_title": "DHFPROD-3865: Can now run a step via a Data Services endpoint", "pr_createdAt": "2020-02-10T01:27:11Z", "pr_url": "https://github.com/marklogic/marklogic-data-hub/pull/3567", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjgzNzczNg==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3567#discussion_r376837736", "bodyText": "setSchemasPath was deprecated in ml-app-deployer 3.x and removed in 4.0 - this line of code was essentially having no impact, as the \"user schemas dir\" is src/main/ml-schemas, which is the default for ml-app-deployer (though it's better to use ml-config/databases/(db name)/schemas).", "author": "rjrudin", "createdAt": "2020-02-10T01:28:04Z", "path": "marklogic-data-hub/src/main/java/com/marklogic/hub/impl/HubConfigImpl.java", "diffHunk": "@@ -1947,8 +1947,6 @@ private void updateAppConfig(AppConfig config) {\n \n         initializeModulePaths(config);\n \n-        config.setSchemasPath(getUserSchemasDir().toString());", "originalCommit": "ae4788c1e5b57ddc4f4f77b5ca51cc0cfc4c81de", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzI2NTk4Ng==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3567#discussion_r377265986", "bodyText": "We might want to make sure we note the backwards dependency, as folks who were using the user schemas directory under older versions, will suddenly find their configs will not work when they upgrade.", "author": "aebadirad", "createdAt": "2020-02-10T19:22:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjgzNzczNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzM0MTgyOA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3567#discussion_r377341828", "bodyText": "Looking at HubProjectImpl, getUserSchemasDir is set to src/main/ml-modules, and a user can't override that. That's also the default in ml-app-deployer. So that's why I say that line of code was having no impact.", "author": "rjrudin", "createdAt": "2020-02-10T21:59:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjgzNzczNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjgzNzc5OQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3567#discussion_r376837799", "bodyText": "I deleted this because a) it wasn't being used anywhere, and b) it didn't work - \"this.hubUtils\" did not resolve.", "author": "rjrudin", "createdAt": "2020-02-10T01:28:36Z", "path": "marklogic-data-hub/src/main/resources/ml-modules/root/data-hub/5/impl/flow.sjs", "diffHunk": "@@ -96,16 +96,6 @@ class Flow {\n     return docs;\n   }\n \n-  deleteFlow(flowName) {", "originalCommit": "ae4788c1e5b57ddc4f4f77b5ca51cc0cfc4c81de", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzI3MzA4MA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3567#discussion_r377273080", "bodyText": "Should probably fix this or, comment it out/leave it and bug log it not remove it, as the new app is going to be atomicly changing things on the server instead of doing full reloads.", "author": "aebadirad", "createdAt": "2020-02-10T19:36:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjgzNzc5OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzM0MjMxNw==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3567#discussion_r377342317", "bodyText": "I believe this is being handled now by artifacts/core.sjs", "author": "rjrudin", "createdAt": "2020-02-10T22:00:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjgzNzc5OQ=="}], "type": "inlineReview"}, {"oid": "e0a85e43691c3c7be51315eef93e995f7dfecc50", "url": "https://github.com/marklogic/marklogic-data-hub/commit/e0a85e43691c3c7be51315eef93e995f7dfecc50", "message": "DHFPROD-3865: Can now run a step via a Data Services endpoint\n\nUpgraded to Java Client 5.1.0 to use the Bulk IO API for testing. This required upgrading to ml-gradle 4.0, which supports Java Client 5.1 (3.x does not). \n\nExtracted reusable code from mlRunFlow.sjs into flow.sjs/findMatchingContent. This helps minimize the code in mlRunFlow.sjs (REST) and runSteps.sjs (DS).", "committedDate": "2020-02-10T01:29:33Z", "type": "commit"}, {"oid": "e0a85e43691c3c7be51315eef93e995f7dfecc50", "url": "https://github.com/marklogic/marklogic-data-hub/commit/e0a85e43691c3c7be51315eef93e995f7dfecc50", "message": "DHFPROD-3865: Can now run a step via a Data Services endpoint\n\nUpgraded to Java Client 5.1.0 to use the Bulk IO API for testing. This required upgrading to ml-gradle 4.0, which supports Java Client 5.1 (3.x does not). \n\nExtracted reusable code from mlRunFlow.sjs into flow.sjs/findMatchingContent. This helps minimize the code in mlRunFlow.sjs (REST) and runSteps.sjs (DS).", "committedDate": "2020-02-10T01:29:33Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzI0NjQ4NQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3567#discussion_r377246485", "bodyText": "query can be null at this point? If query and filterQuery are null, what will it happen? I guess we do not want to continue calling queryToContentDescriptorArray. Do we need to add some logs for debugging purpose?", "author": "hao1st", "createdAt": "2020-02-10T18:44:43Z", "path": "marklogic-data-hub/src/main/resources/ml-modules/root/data-hub/5/impl/flow.sjs", "diffHunk": "@@ -140,6 +130,53 @@ class Flow {\n     }\n   }\n \n+  /**\n+   * Find records that match a query based on the given inputs. Each matching record is wrapped in a\n+   * \"content descriptor\" object that is guaranteed to have at least a \"uri\" property.\n+   *\n+   * @param flowName\n+   * @param stepNumber\n+   * @param options\n+   * @param filterQuery\n+   * @return {*}\n+   */\n+  findMatchingContent(flowName, stepNumber, options, filterQuery) {\n+    const flow = this.getFlow(flowName);\n+    const flowStep = flow.steps[stepNumber];\n+    const stepDetails = this.step.getStepByNameAndType(flowStep.stepDefinitionName, flowStep.stepDefinitionType);\n+    const combinedOptions = Object.assign({}, stepDetails.options || {}, flow.options || {}, flowStep.options || {}, options);\n+\n+    let query;\n+    let uris = null;\n+    if (options.uris) {\n+      uris = this.datahub.hubUtils.normalizeToArray(options.uris);\n+      query = cts.documentQuery(uris);\n+    } else {\n+      let sourceQuery = combinedOptions.sourceQuery || flow.sourceQuery;\n+      query = sourceQuery ? xdmp.eval(sourceQuery) : null;\n+    }\n+\n+    if (stepDetails.name === 'default-merging' && stepDetails.type === 'merging' && uris) {\n+      return uris.map((uri) => { return { uri }; });\n+    } else {\n+      let sourceDatabase = combinedOptions.sourceDatabase || this.globalContext.sourceDatabase;\n+      if (filterQuery) {", "originalCommit": "e0a85e43691c3c7be51315eef93e995f7dfecc50", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}