{"pr_number": 3964, "pr_title": "DHFPROD-4916: Making saved query name to be unique", "pr_createdAt": "2020-05-18T15:57:59Z", "pr_url": "https://github.com/marklogic/marklogic-data-hub/pull/3964", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjc1OTQxMg==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3964#discussion_r426759412", "bodyText": "Is there any benefit in keeping the commented-out code? I think it's almost always best to delete commented-out code - in the rare case something might be needed later, it can always be retrieved from version control.", "author": "rjrudin", "createdAt": "2020-05-18T16:42:29Z", "path": "marklogic-data-hub-central/ui/e2e/cypress/integration/authorization.spec.tsx", "diffHunk": "@@ -42,7 +42,8 @@ describe('login', () => {\n     cy.loginAsDeveloper()\n     .wait(500)\n     .url()\n-    .should('include', '/home');\n+     .should('include', '/tile')\n+    // .should('include', '/home');", "originalCommit": "0bfe711ef2c906c87d90d039bc7af23bc9c7a5da", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjc2MDg0Mw==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3964#discussion_r426760843", "bodyText": "Same thing here - why not just delete this code? What's the benefit of keeping it around? It's in version history if it's ever needed again.", "author": "rjrudin", "createdAt": "2020-05-18T16:44:55Z", "path": "marklogic-data-hub-central/ui/src/components/queries/queries.tsx", "diffHunk": "@@ -59,17 +59,21 @@ const Query = (props) => {\n                 propertiesToDisplay: props.columns,\n             }\n         }\n-        try {\n-            props.setIsLoading(true);\n-            await creatNewQuery(query);\n-            setOpenSaveModal(false);\n-            getSaveQueries();\n-        } catch (error) {\n-            handleError(error);\n-        } finally {\n-            props.setIsLoading(false);\n-            resetSessionTime();\n-        }\n+        props.setIsLoading(true);\n+        await creatNewQuery(query);\n+        setOpenSaveModal(false);\n+        getSaveQueries();\n+        // try {", "originalCommit": "0bfe711ef2c906c87d90d039bc7af23bc9c7a5da", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjc2MTgyMg==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3964#discussion_r426761822", "bodyText": "This seems to be repeated - it's in 3 different places.\n@wooldridge @xnikhil08  It seems there should be a way to reduce this duplication so that each \"catch\" block doesn't have to do so much work? The problem with repeating this work in multiple places is that if we ever want to change how we handle e.g. 400 errors, we have N places to modify as opposed to just one.", "author": "rjrudin", "createdAt": "2020-05-18T16:46:31Z", "path": "marklogic-data-hub-central/ui/src/components/queries/saving/edit-save-query/save-changes-modal.tsx", "diffHunk": "@@ -88,18 +94,28 @@ const SaveChangesModal: React.FC<Props> = (props) => {\n                 //const response = await updateQuery(currentQuery);\n                 const response = await axios.put(`/api/entitySearch/savedQueries`, currentQuery);\n                 if (response.data) {\n-                    props.setSaveChangesModalVisibility()\n+                    setAllSearchFacets(facets);\n+                    props.setSaveChangesModalVisibility();\n+                    applySaveQuery(searchOptions.query, searchOptions.entityTypeIds, facets, queryName);\n+                    props.setCurrentQueryDescription(queryDescription);\n                 }\n             } catch (error) {\n-                handleError(error);\n+                if (error.response.status === 400) {\n+                    if (error.response.data.hasOwnProperty('message')) {\n+                        setErrorMessage(error['response']['data']['message']);", "originalCommit": "0bfe711ef2c906c87d90d039bc7af23bc9c7a5da", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjg5MzQ4NQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3964#discussion_r426893485", "bodyText": "@rjrudin the values that are set in the catch are specific to the component. Apart from setErrorMessage state, there are other states that are set in different catch blocks. This error handling is specific to the child components of the Query component. There is also a handleError generic error handler, which handles 400 error.", "author": "rahulvudutala", "createdAt": "2020-05-18T21:07:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjc2MTgyMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjkzNzc0Ng==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3964#discussion_r426937746", "bodyText": "Yeah, I'm not really sure of better alternatives. async await in a try catch block is already pretty lean. One refactor I would recommend is combining the edit and save modals into one since they share inputs. The title and the save button endpoint are the differences.", "author": "brucean52", "createdAt": "2020-05-18T23:01:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjc2MTgyMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjc2MjI2OA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3964#discussion_r426762268", "bodyText": "This is the 4th occurrence of very similar logic for handling a 400 - hopefully there's a way to reduce this duplication??", "author": "rjrudin", "createdAt": "2020-05-18T16:47:21Z", "path": "marklogic-data-hub-central/ui/src/components/queries/saving/save-query-modal/save-query-modal.tsx", "diffHunk": "@@ -57,16 +67,31 @@ const SaveQueryModal: React.FC<Props> = (props) => {\n                 props.toggleApply(false);\n         }\n         if(queryName.length > 0 && queryName.trim().length !== 0){\n-            props.saveNewQuery(queryName, queryDescription, facets);\n-            props.setSaveNewIconVisibility(false);\n-            props.setSaveModalVisibility();\n-\n+            try {\n+                await props.saveNewQuery(queryName, queryDescription, facets);\n+                props.setSaveNewIconVisibility(false);\n+                props.setSaveModalVisibility();\n+                applySaveQuery(searchOptions.query, searchOptions.entityTypeIds, facets, queryName);\n+                props.setCurrentQueryName(queryName);\n+                props.setCurrentQueryDescription(queryDescription);\n+            } catch (error) {\n+                if (error.response.status === 400) {", "originalCommit": "0bfe711ef2c906c87d90d039bc7af23bc9c7a5da", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjc2MzI5Ng==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3964#discussion_r426763296", "bodyText": "A general technique for making queries easier to read is to put each query on a separate line - e.g.\ncts.andQuery([\n  cts.collectionQuery(\"..\"),\n  cts.jsonPropertyValueQuery(...),\n  cts.jsonPropertyValueQuery(...)\n])", "author": "rjrudin", "createdAt": "2020-05-18T16:49:12Z", "path": "marklogic-data-hub/src/main/resources/ml-modules/root/data-hub/5/data-services/entitySearch/saveSavedQuery.sjs", "diffHunk": "@@ -43,7 +43,15 @@ if (queryDocument.savedQuery.propertiesToDisplay == null || queryDocument.savedQ\n     ds.throwBadRequest(\"Entity type properties to be displayed cannot be empty\");\n }\n \n-let id = queryDocument.savedQuery.id;\n+const id = queryDocument.savedQuery.id;\n+const positiveQuery = cts.andQuery([cts.collectionQuery(\"http://marklogic.com/data-hub/saved-query\"), cts.jsonPropertyValueQuery(\"name\", queryDocument.savedQuery.name),", "originalCommit": "0bfe711ef2c906c87d90d039bc7af23bc9c7a5da", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjc2MzkwNw==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3964#discussion_r426763907", "bodyText": "I think this message needs to capture the fact that the current user already has the query; otherwise, the user could interpret this message as implying that no two users can use the same named queries.\nI recommend: \"You already have a saved query with a name of ${the name}\".", "author": "rjrudin", "createdAt": "2020-05-18T16:50:18Z", "path": "marklogic-data-hub/src/main/resources/ml-modules/root/data-hub/5/data-services/entitySearch/saveSavedQuery.sjs", "diffHunk": "@@ -43,7 +43,15 @@ if (queryDocument.savedQuery.propertiesToDisplay == null || queryDocument.savedQ\n     ds.throwBadRequest(\"Entity type properties to be displayed cannot be empty\");\n }\n \n-let id = queryDocument.savedQuery.id;\n+const id = queryDocument.savedQuery.id;\n+const positiveQuery = cts.andQuery([cts.collectionQuery(\"http://marklogic.com/data-hub/saved-query\"), cts.jsonPropertyValueQuery(\"name\", queryDocument.savedQuery.name),\n+    cts.jsonPropertyValueQuery(\"owner\", xdmp.getCurrentUser())]);\n+const negativeQuery = cts.documentQuery(\"/saved-queries/\" + id + \".json\");\n+const queryNameExists = cts.exists(cts.andNotQuery(positiveQuery, negativeQuery));\n+if(queryNameExists) {\n+    ds.throwBadRequest(`A query already exists with a name of ${queryDocument.savedQuery.name}`);", "originalCommit": "0bfe711ef2c906c87d90d039bc7af23bc9c7a5da", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjc2NDYxMw==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3964#discussion_r426764613", "bodyText": "I think this is an indicator that multiple test modules should be created. That's because marklogic-unit-test has built-in support for \"do something before every test\" - just make a setup.xqy module.", "author": "rjrudin", "createdAt": "2020-05-18T16:51:23Z", "path": "marklogic-data-hub/src/test/ml-modules/root/test/suites/data-hub/5/data-services/entitySearch/saveSavedQueryTest.sjs", "diffHunk": "@@ -38,45 +40,150 @@ var saveQuery = JSON.stringify({\n   }\n });\n \n-function invokeService(saveQuery) {\n-  return fn.head(xdmp.invoke(\n-      \"/data-hub/5/data-services/entitySearch/saveSavedQuery.sjs\",\n-      {\n-        \"saveQuery\": saveQuery\n-      }\n-  ));\n+function beforeEach() {", "originalCommit": "0bfe711ef2c906c87d90d039bc7af23bc9c7a5da", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjc2NTEyNw==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3964#discussion_r426765127", "bodyText": "Just call \"reset-hub()\" in data-hub-test-helper.xqy instead. That ensures that everything but the \"hub-core-artifact\" documents are retained.", "author": "rjrudin", "createdAt": "2020-05-18T16:52:13Z", "path": "marklogic-data-hub/src/test/ml-modules/root/test/suites/data-hub/5/data-services/entitySearch/saveSavedQueryTest.sjs", "diffHunk": "@@ -38,45 +40,150 @@ var saveQuery = JSON.stringify({\n   }\n });\n \n-function invokeService(saveQuery) {\n-  return fn.head(xdmp.invoke(\n-      \"/data-hub/5/data-services/entitySearch/saveSavedQuery.sjs\",\n-      {\n-        \"saveQuery\": saveQuery\n-      }\n-  ));\n+function beforeEach() {\n+  declareUpdate();\n+  xdmp.collectionDelete(\"http://marklogic.com/data-hub/saved-query\");", "originalCommit": "0bfe711ef2c906c87d90d039bc7af23bc9c7a5da", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "6025679f1f0340a58ea3b2dd32724bd7c4723a0b", "url": "https://github.com/marklogic/marklogic-data-hub/commit/6025679f1f0340a58ea3b2dd32724bd7c4723a0b", "message": "DHFPROD-4916: Making saved query name to be unique\n\nDHFPROD-4916: Making saved query name to be unique frontend changes", "committedDate": "2020-05-18T21:41:34Z", "type": "commit"}, {"oid": "e729ea7bbdc6be7585efae1d5d96047be12a2eb9", "url": "https://github.com/marklogic/marklogic-data-hub/commit/e729ea7bbdc6be7585efae1d5d96047be12a2eb9", "message": "DHFPROD-4916: Temporary changes to integration tests as tile is not working", "committedDate": "2020-05-18T21:43:50Z", "type": "commit"}, {"oid": "e729ea7bbdc6be7585efae1d5d96047be12a2eb9", "url": "https://github.com/marklogic/marklogic-data-hub/commit/e729ea7bbdc6be7585efae1d5d96047be12a2eb9", "message": "DHFPROD-4916: Temporary changes to integration tests as tile is not working", "committedDate": "2020-05-18T21:43:50Z", "type": "forcePushed"}]}