{"pr_number": 5055, "pr_title": "DHFPROD-6412: Fixing syntax error when writing prov data", "pr_createdAt": "2020-12-30T19:57:46Z", "pr_url": "https://github.com/marklogic/marklogic-data-hub/pull/5055", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDMzNjgwMw==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/5055#discussion_r550336803", "bodyText": "We still want to store the coarse-grain information from the entity-services-mapping step and the granularity level is set to fine, right?", "author": "ryanjdew", "createdAt": "2020-12-30T21:50:25Z", "path": "marklogic-data-hub/src/main/resources/ml-modules/root/data-hub/5/impl/flow.sjs", "diffHunk": "@@ -537,25 +534,26 @@ class Flow {\n           status: (stepDefTypeLowerCase === 'ingestion') ? 'created' : 'updated',\n           metadata: {}\n         };\n+\n         // We may want to hide some documents from provenance. e.g., we don't need provenance of mastering PROV documents\n         if (content.provenance !== false) {\n           let provResult;\n+\n           if (prov.granularityLevel() === prov.FINE_LEVEL && flowStep.stepDefinitionName === \"entity-services-mapping\") {\n             xdmp.trace(this.datahub.consts.TRACE_RUN_STEP, `'provenanceGranularityLevel' for step '${flowStep.name}' is set to 'fine'. This is not supported for mapping steps. So, coarse grained provenance data will be generated.`);\n           }\n-          if (prov.granularityLevel() === prov.FINE_LEVEL && content.provenance && flowStep.stepDefinitionName !== \"entity-services-mapping\") {\n+          else if (prov.granularityLevel() === prov.FINE_LEVEL && content.provenance) {\n             provResult = this.buildFineProvenanceData(jobId, flowName, stepName, flowStep.stepDefinitionName, stepDefTypeLowerCase, content, info);\n           } else {", "originalCommit": "1889e13e8712ac41bf3e29cd9af8d26d44a5b37b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDM0MzIzMg==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/5055#discussion_r550343232", "bodyText": "Oops - you're right, that's my bad.", "author": "rjrudin", "createdAt": "2020-12-30T22:20:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDMzNjgwMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDMzODY3MA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/5055#discussion_r550338670", "bodyText": "a test is failing since flowInstance is undefined here.", "author": "ryanjdew", "createdAt": "2020-12-30T21:59:26Z", "path": "marklogic-data-hub/src/main/resources/ml-modules/root/data-hub/5/impl/flow.sjs", "diffHunk": "@@ -537,25 +534,26 @@ class Flow {\n           status: (stepDefTypeLowerCase === 'ingestion') ? 'created' : 'updated',\n           metadata: {}\n         };\n+\n         // We may want to hide some documents from provenance. e.g., we don't need provenance of mastering PROV documents\n         if (content.provenance !== false) {\n           let provResult;\n+\n           if (prov.granularityLevel() === prov.FINE_LEVEL && flowStep.stepDefinitionName === \"entity-services-mapping\") {\n             xdmp.trace(this.datahub.consts.TRACE_RUN_STEP, `'provenanceGranularityLevel' for step '${flowStep.name}' is set to 'fine'. This is not supported for mapping steps. So, coarse grained provenance data will be generated.`);\n           }\n-          if (prov.granularityLevel() === prov.FINE_LEVEL && content.provenance && flowStep.stepDefinitionName !== \"entity-services-mapping\") {\n+          else if (prov.granularityLevel() === prov.FINE_LEVEL && content.provenance) {\n             provResult = this.buildFineProvenanceData(jobId, flowName, stepName, flowStep.stepDefinitionName, stepDefTypeLowerCase, content, info);\n           } else {\n             provResult = prov.createStepRecord(jobId, flowName, stepName, flowStep.stepDefinitionName, stepDefTypeLowerCase, content.uri, info);\n           }\n+\n           if (provResult instanceof Error) {\n             flowInstance.datahub.debug.log({message: provResult.message, type: 'error'});", "originalCommit": "1889e13e8712ac41bf3e29cd9af8d26d44a5b37b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDM0MzMyMQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/5055#discussion_r550343321", "bodyText": "Well this is a sloppy PR - this was the line of code that needed fixing, I accidentally committed it after putting \"flowInstance\" back in to make sure it broke.", "author": "rjrudin", "createdAt": "2020-12-30T22:21:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDMzODY3MA=="}], "type": "inlineReview"}, {"oid": "4accb4ee32b4ad95bf97a5d11936abcfd01ff624", "url": "https://github.com/marklogic/marklogic-data-hub/commit/4accb4ee32b4ad95bf97a5d11936abcfd01ff624", "message": "DHFPROD-6412: Fixing syntax error when writing prov data\n\nAlso improved ML unit test plumbing by making \"clear-jobs-database\" delete provenance data as well, which depends on an amp. \n\nOne other change to flow.sjs is that previously, a bunch of prov data could be generated, but if the granularity level is off, then nothing was done with it. It seems to make more sense that if the level is off, we can bail right away and not generate all that data.", "committedDate": "2020-12-30T22:29:45Z", "type": "forcePushed"}, {"oid": "f6ed805f2660dbbec76e24630a3aa164d206fdea", "url": "https://github.com/marklogic/marklogic-data-hub/commit/f6ed805f2660dbbec76e24630a3aa164d206fdea", "message": "DHFPROD-6412: Fixing syntax error when writing prov data\n\nAlso improved ML unit test plumbing by making \"clear-jobs-database\" delete provenance data as well, which depends on an amp. \n\nOne other change to flow.sjs is that previously, a bunch of prov data could be generated, but if the granularity level is off, then nothing was done with it. It seems to make more sense that if the level is off, we can bail right away and not generate all that data.", "committedDate": "2020-12-31T14:15:01Z", "type": "commit"}, {"oid": "f6ed805f2660dbbec76e24630a3aa164d206fdea", "url": "https://github.com/marklogic/marklogic-data-hub/commit/f6ed805f2660dbbec76e24630a3aa164d206fdea", "message": "DHFPROD-6412: Fixing syntax error when writing prov data\n\nAlso improved ML unit test plumbing by making \"clear-jobs-database\" delete provenance data as well, which depends on an amp. \n\nOne other change to flow.sjs is that previously, a bunch of prov data could be generated, but if the granularity level is off, then nothing was done with it. It seems to make more sense that if the level is off, we can bail right away and not generate all that data.", "committedDate": "2020-12-31T14:15:01Z", "type": "forcePushed"}]}