{"pr_number": 3639, "pr_title": "DHFPROD-4524: 5.3 Roles service doesn't provide granular enough feedb\u2026", "pr_createdAt": "2020-03-03T15:55:56Z", "pr_url": "https://github.com/marklogic/marklogic-data-hub/pull/3639", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzEyMzA0Ng==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3639#discussion_r387123046", "bodyText": "Let's not use the term \"privileges\" here, as that already has a definition within ML. Just call it \"response\", since this is the response object.", "author": "rjrudin", "createdAt": "2020-03-03T16:05:05Z", "path": "marklogic-data-hub/src/main/resources/ml-modules/root/data-hub/5/data-services/security/getAuthorities.sjs", "diffHunk": "@@ -15,14 +15,49 @@\n  */\n 'use strict';\n \n-// TODO This is just stubbed out, a real implementation is needed.\n-\n-let response = {\n-  \"authorities\": [\n-    \"canInstallDataHub\",\n-    \"canReadLoadData\",\n-    \"canWriteLoadData\"\n-  ]\n+const Artifacts = require('/data-hub/5/artifacts/core.sjs');\n+const roleIdToName = (roleID) => xdmp.roleName(roleID);\n+const currentRoles = xdmp.getCurrentRoles().toArray().map(String);\n+let currentRoleNames = currentRoles.map(roleIdToName);\n+\n+const defaultManageRoles = ['admin', 'data-hub-environment-manager'].map((roleName) => String(xdmp.role(roleName)));\n+const manageRolesMustAllMatched = ['manage-admin', 'security'].map((roleName) => String(xdmp.role(roleName)));\n+\n+let hasManagerRole = defaultManageRoles.some((role) => currentRoles.includes(role));\n+if (!hasManagerRole) {\n+  hasManagerRole = manageRolesMustAllMatched.every((role) => currentRoles.indexOf(role) !== -1);\n+}\n+\n+if (currentRoleNames.includes('admin')) {\n+  currentRoleNames = xdmp.roles().toArray().map(roleIdToName);\n+}\n+const datahubRoles  = currentRoleNames.filter((roleName) => fn.startsWith(roleName, 'data-hub'));\n+\n+const privileges = {", "originalCommit": "68f16495f7c1ce4e43a31305bfcf762da58264cc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzEyNTA5Mw==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3639#discussion_r387125093", "bodyText": "You can do this and the line near the end in one simpler line of code:\nresponse.roles = currentRolesNames.filter(roleName => fn.startsWith(roleName, \"data-hub\");", "author": "rjrudin", "createdAt": "2020-03-03T16:08:02Z", "path": "marklogic-data-hub/src/main/resources/ml-modules/root/data-hub/5/data-services/security/getAuthorities.sjs", "diffHunk": "@@ -15,14 +15,49 @@\n  */\n 'use strict';\n \n-// TODO This is just stubbed out, a real implementation is needed.\n-\n-let response = {\n-  \"authorities\": [\n-    \"canInstallDataHub\",\n-    \"canReadLoadData\",\n-    \"canWriteLoadData\"\n-  ]\n+const Artifacts = require('/data-hub/5/artifacts/core.sjs');\n+const roleIdToName = (roleID) => xdmp.roleName(roleID);\n+const currentRoles = xdmp.getCurrentRoles().toArray().map(String);\n+let currentRoleNames = currentRoles.map(roleIdToName);\n+\n+const defaultManageRoles = ['admin', 'data-hub-environment-manager'].map((roleName) => String(xdmp.role(roleName)));\n+const manageRolesMustAllMatched = ['manage-admin', 'security'].map((roleName) => String(xdmp.role(roleName)));\n+\n+let hasManagerRole = defaultManageRoles.some((role) => currentRoles.includes(role));\n+if (!hasManagerRole) {\n+  hasManagerRole = manageRolesMustAllMatched.every((role) => currentRoles.indexOf(role) !== -1);\n+}\n+\n+if (currentRoleNames.includes('admin')) {\n+  currentRoleNames = xdmp.roles().toArray().map(roleIdToName);\n+}\n+const datahubRoles  = currentRoleNames.filter((roleName) => fn.startsWith(roleName, 'data-hub'));", "originalCommit": "68f16495f7c1ce4e43a31305bfcf762da58264cc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzEyNjc0NA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3639#discussion_r387126744", "bodyText": "There are a lot of other scenarios to test here, each as a different user. Switching users is very difficult in marklogic-unit-test though. For that reason, I think this test should be converted into a JUnit test - GetAuthoritiestTest - where each test method uses a different user. We have test-data-hub-developer and test-data-hub-operator already, and I think you can use \"admin\" too.", "author": "rjrudin", "createdAt": "2020-03-03T16:10:22Z", "path": "marklogic-data-hub/src/test/ml-modules/root/test/suites/data-hub/5/data-services/security/getAuthoritiesTest.sjs", "diffHunk": "@@ -0,0 +1,24 @@\n+const test = require(\"/test/test-helper.xqy\");", "originalCommit": "68f16495f7c1ce4e43a31305bfcf762da58264cc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzE0Mjc1Ng==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3639#discussion_r387142756", "bodyText": "@rjrudin I thought about it. It is why I added more test cases in the AuthTest.", "author": "hao1st", "createdAt": "2020-03-03T16:31:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzEyNjc0NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzE2ODk5OQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3639#discussion_r387168999", "bodyText": "Consider though that we'll likely add a lot more logic to this endpoint. Will it be easier to write tests against SecurityService, where all we need to do is instantiate a SecurityService, or against the Spring MVC layer, where we need to deal with mock request and response objects and a lot of other logic that we don't really care about?\nIt's good to have one test against Spring MVC to verify that all the parts are integrated together nicely. But for all the different scenarios that getAuthorities.sjs will handle, it'll be a lot cheaper in the long run to verify those scenarios directly against the endpoint.", "author": "rjrudin", "createdAt": "2020-03-03T17:12:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzEyNjc0NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzI1NTQ1Ng==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3639#discussion_r387255456", "bodyText": "@rjrudin Can you give me an example of a java test class about how to invoke sjs ?", "author": "hao1st", "createdAt": "2020-03-03T19:50:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzEyNjc0NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzI1NjU3OQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3639#discussion_r387256579", "bodyText": "You'd just use the DS-generated one - SecurityService.", "author": "rjrudin", "createdAt": "2020-03-03T19:52:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzEyNjc0NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzEzMTQ0Mg==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3639#discussion_r387131442", "bodyText": "When we need a method to return a tuple of different things, I'd much rather see us use the Pair class or a custom class instead of passing arrays as ways to capture values.\nSo this can be simplified by returning a Pair<List<GrantedAuthority>, ArrayNode> . That makes it much more obvious what the method is doing.\nFor \"canInstallDataHub\" - can't LoginHandler just iterate over the list of GrantedAuthoritys to see if \"canInstallDataHub\" exists, and if so, write that to the JSON response? It shouldn't need to care about hasManagePrivileges anymore, right? That would get rid of this from this function, which shouldn't care about setting bits specific to the login response. It should just care about getting all the authorities (and for now, all the roles too, though that will soon go away).", "author": "rjrudin", "createdAt": "2020-03-03T16:16:47Z", "path": "one-ui/src/main/java/com/marklogic/hub/oneui/auth/AuthenticationFilter.java", "diffHunk": "@@ -137,15 +139,24 @@ protected AuthenticationToken authenticateUser(String username, String password)\n      * - see https://docs.spring.io/spring-security/site/docs/current/reference/htmlsingle/#appendix-faq-role-prefix.\n      *\n      * @param stagingClient\n+     * @param roles\n+     * @param canInstallDataHub\n      * @return\n      */\n-    protected List<GrantedAuthority> getAuthoritiesForAuthenticatedUser(DatabaseClient stagingClient) {\n+    protected List<GrantedAuthority> getAuthoritiesForAuthenticatedUser(DatabaseClient stagingClient, ArrayNode[] roles, boolean[] canInstallDataHub) {", "originalCommit": "68f16495f7c1ce4e43a31305bfcf762da58264cc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzE0MDk3MQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3639#discussion_r387140971", "bodyText": "@rjrudin Now UI needs hasManagePrivileges for convenience. Because we only send roles as response to UI, but those roles does not tell the if the user has manage-admin privilege or not. We can remove it once UI do not need it. Since we will remove roles, we can refactor the codes later on.", "author": "hao1st", "createdAt": "2020-03-03T16:29:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzEzMTQ0Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzE0NTIyMg==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3639#discussion_r387145222", "bodyText": "@rjrudin I do not see any difference between use a Pair as return and pass roles as a parameter...", "author": "hao1st", "createdAt": "2020-03-03T16:35:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzEzMTQ0Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzE2NzAxOA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3639#discussion_r387167018", "bodyText": "It's more clear what the inputs and outputs are. A signature of:\nList<GrantedAuthority> getGrantedAuthorities(DatabaseClient, ArrayNode); \n\nimplies that the DatabaseClient and ArrayNode are inputs needed to process a single List as the output. The reader has to do extra work to realize that one of the inputs is actually an output, not an input.\nBut this signature:\nPair<List, ArrayNode> getGrantedAuthorities(DatabaseClient);\n\nimplies that a single input is needed to produce two outputs.\nBut it's fine now not to change it - ideally, the roles will go away soon and we'll have a single output - the List of authorities.", "author": "rjrudin", "createdAt": "2020-03-03T17:09:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzEzMTQ0Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzI4ODgzNQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3639#discussion_r387288835", "bodyText": "FWIW, \"data-hub-portal-security-admin\" also has manage-admin role.\nmanage and manage-admin are 2 separate roles. Can we be specific and say defaultRolesWithManageAdmin.\n'admin' doesnt have manage-admin role. An 'admin' role just bypasses all the security.", "author": "bsrikan", "createdAt": "2020-03-03T20:57:15Z", "path": "marklogic-data-hub/src/main/resources/ml-modules/root/data-hub/5/data-services/security/getAuthorities.sjs", "diffHunk": "@@ -15,14 +15,49 @@\n  */\n 'use strict';\n \n-// TODO This is just stubbed out, a real implementation is needed.\n-\n-let response = {\n-  \"authorities\": [\n-    \"canInstallDataHub\",\n-    \"canReadLoadData\",\n-    \"canWriteLoadData\"\n-  ]\n+const Artifacts = require('/data-hub/5/artifacts/core.sjs');\n+const roleIdToName = (roleID) => xdmp.roleName(roleID);\n+const currentRoles = xdmp.getCurrentRoles().toArray().map(String);\n+let currentRoleNames = currentRoles.map(roleIdToName);\n+\n+const defaultManageRoles = ['admin', 'data-hub-environment-manager'].map((roleName) => String(xdmp.role(roleName)));", "originalCommit": "68f16495f7c1ce4e43a31305bfcf762da58264cc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzY5MjAzMg==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3639#discussion_r387692032", "bodyText": "I take that back - xdmp.getCurrentRoles() (and xdmp.roleRoles()) do return all inherited roles.\n@hao1st You don't need to check for \"data-hub-environment-manager\" then.  If a user has that role, then xdmp.getCurrentRoles() will return both \"manage-admin\" and \"security\".\nThe only role that requires special handling is \"admin\", since for a user with only \"admin\", xdmp.getCurrentRoles() will only return \"admin\".", "author": "rjrudin", "createdAt": "2020-03-04T14:15:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzI4ODgzNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODM5MDk5Mw==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3639#discussion_r388390993", "bodyText": "@rjrudin if the user has only \"data-hub-portal-security-admin\" role,  should we give \"canInstallDataHub\" authority?", "author": "hao1st", "createdAt": "2020-03-05T16:00:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzI4ODgzNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODM5NTI1OQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3639#discussion_r388395259", "bodyText": "@ryanjdew @rjrudin If the user has \"admin\" role, all the canRead{artifactType} and canWrite{artifactType} are false. Only \"canInstallDataHub\" is the authortity. It does not seem right. I mean that \"cores.sjs\" also needs to do special handling for \"admin\" role?\nIf we will use @secured annotation to special one role, it should make sure \"authorities\" includes all the authoritzed roles for a special user.", "author": "hao1st", "createdAt": "2020-03-05T16:07:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzI4ODgzNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODQwMTE5Mw==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3639#discussion_r388401193", "bodyText": "We don't care if the user has \"data-hub-portal-security-admin\" - that role is one of an infinite number of ways that a user may inherit manage-admin and security. All we care about is if the user has both manage-admin and security.", "author": "rjrudin", "createdAt": "2020-03-05T16:15:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzI4ODgzNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODQwMTY2NQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3639#discussion_r388401665", "bodyText": "Re: the admin role - IMO, the design should be that if the user has the admin role, then the user gains all authorities. That seems like the expected and intuitive approach, along with being consistent with how the admin role works within ML.", "author": "rjrudin", "createdAt": "2020-03-05T16:16:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzI4ODgzNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODQxMjMzMQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3639#discussion_r388412331", "bodyText": "@rjrudin the following response for \"admin\" is correct? As we talked before, we will remove the roles once UI starts to respect authorities.\n{\n\"authorities\": [\n\"canInstallDataHub\"\n], \n\"roles\": [\n\"data-hub-environment-manager\", \n\"data-hub-mapping-reader\", \n\"data-hub-module-writer\", \n\"data-hub-admin-role\", \n\"data-hub-module-reader\", \n\"data-hub-entity-model-reader\", \n\"data-hub-explorer-architect\", \n\"data-hub-security-admin\", \n\"data-hub-flow-reader\", \n\"data-hub-step-definition-writer\", \n\"data-hub-operator\", \n\"data-hub-mapping-writer\", \n\"data-hub-admin\", \n\"data-hub-load-data-writer\", \n\"data-hub-job-reader\", \n\"data-hub-job-internal\", \n\"data-hub-monitor\", \n\"data-hub-entity-model-writer\", \n\"data-hub-developer\", \n\"data-hub-portal-security-admin\", \n\"data-hub-load-data-reader\", \n\"data-hub-step-definition-reader\", \n\"data-hub-flow-writer\"\n]\n}", "author": "hao1st", "createdAt": "2020-03-05T16:32:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzI4ODgzNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODQyMTAyMg==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3639#discussion_r388421022", "bodyText": "If that's the complete set of authorities and DHF-related roles, then yes, it's correct. With the assumption that roles goes away very soon.", "author": "rjrudin", "createdAt": "2020-03-05T16:46:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzI4ODgzNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzI5MTQwMQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3639#discussion_r387291401", "bodyText": "This should be hasManageAdminRole.\nWith manageRolesMustAllMatched are we trying to check if a role has both manage-admin & security? If so, hasManageAdminAndSecurity sounds better to me.", "author": "bsrikan", "createdAt": "2020-03-03T21:02:15Z", "path": "marklogic-data-hub/src/main/resources/ml-modules/root/data-hub/5/data-services/security/getAuthorities.sjs", "diffHunk": "@@ -15,14 +15,49 @@\n  */\n 'use strict';\n \n-// TODO This is just stubbed out, a real implementation is needed.\n-\n-let response = {\n-  \"authorities\": [\n-    \"canInstallDataHub\",\n-    \"canReadLoadData\",\n-    \"canWriteLoadData\"\n-  ]\n+const Artifacts = require('/data-hub/5/artifacts/core.sjs');\n+const roleIdToName = (roleID) => xdmp.roleName(roleID);\n+const currentRoles = xdmp.getCurrentRoles().toArray().map(String);\n+let currentRoleNames = currentRoles.map(roleIdToName);\n+\n+const defaultManageRoles = ['admin', 'data-hub-environment-manager'].map((roleName) => String(xdmp.role(roleName)));\n+const manageRolesMustAllMatched = ['manage-admin', 'security'].map((roleName) => String(xdmp.role(roleName)));\n+\n+let hasManagerRole = defaultManageRoles.some((role) => currentRoles.includes(role));\n+if (!hasManagerRole) {\n+  hasManagerRole = manageRolesMustAllMatched.every((role) => currentRoles.indexOf(role) !== -1);", "originalCommit": "68f16495f7c1ce4e43a31305bfcf762da58264cc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzI5NDg2Nw==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3639#discussion_r387294867", "bodyText": "@ryanjdew we are still at the early stages of 5.3 so maybe we can change this now. Is hasManagePrivileges telling us if the user has manage-admin role? If so, then shouldnt we name it that way. I am saying this because data-hub-operator has manage privilege, will this flag then be true.", "author": "bsrikan", "createdAt": "2020-03-03T21:09:22Z", "path": "one-ui/src/test/java/com/marklogic/hub/oneui/AuthTest.java", "diffHunk": "@@ -46,14 +48,67 @@ void loginWithInvalidCredentials() throws Exception {\n     }\n \n     @Test\n-    void loginWithValidCredentialsAndLogout() throws Exception {\n+    void loginWithValidAdminAndLogout() throws Exception {\n         String payload = getLoginPayload(\"admin\", \"admin\");\n         final MockHttpSession session[] = new MockHttpSession[1];\n         // Login\n         mockMvc\n             .perform(post(LOGIN_URL).contentType(MediaType.APPLICATION_JSON).content(payload))\n-            .andDo(\n-                result -> session[0] = (MockHttpSession) result.getRequest().getSession())\n+            .andDo (\n+                result -> {\n+                    session[0] = (MockHttpSession) result.getRequest().getSession();\n+                    assertTrue(result.getResponse().getContentAsString().contains(\"\\\"hasManagePrivileges\\\":true\"));\n+                })\n+            .andExpect(status().isOk());\n+\n+        assertFalse(session[0].isInvalid());\n+\n+        // Logout\n+        mockMvc.perform(get(LOGOUT_URL).session(session[0]))\n+            .andExpect(status().isOk());\n+\n+        assertTrue(session[0].isInvalid());\n+    }\n+\n+    @Test\n+    void loginWithDataHubManagerAndLogout() throws Exception {\n+        String payload = getLoginPayload(\"data-hub-environment-manager-user\", \"data-hub-environment-manager-user\");\n+        final MockHttpSession session[] = new MockHttpSession[1];\n+        // Login\n+        mockMvc\n+            .perform(post(LOGIN_URL).contentType(MediaType.APPLICATION_JSON).content(payload))\n+            .andDo (\n+                result -> {\n+                    session[0] = (MockHttpSession) result.getRequest().getSession();\n+                    String strResponse = result.getResponse().getContentAsString();\n+                    ObjectMapper mapper = new ObjectMapper();\n+                    JsonNode jsonResonse = mapper.readTree(strResponse);\n+                    assertTrue(jsonResonse.get(\"roles\").isArray());\n+                    assertTrue(strResponse.contains(\"\\\"hasManagePrivileges\\\":true\"));", "originalCommit": "68f16495f7c1ce4e43a31305bfcf762da58264cc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzQ2Njk0NA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3639#discussion_r387466944", "bodyText": "It isn't explicitly \"has a role.\" It is depending on whether we have access to the Data Service endpoint it is really either doesn't get forbidden from the manage REST app server or if the Data Service endpoint is available it was checking the role, but now should check \"canInstallDataHub\".", "author": "ryanjdew", "createdAt": "2020-03-04T06:15:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzI5NDg2Nw=="}], "type": "inlineReview"}, {"oid": "c86a18dd7358a4aa2de117290b34f813d0756e10", "url": "https://github.com/marklogic/marklogic-data-hub/commit/c86a18dd7358a4aa2de117290b34f813d0756e10", "message": "DHFPROD-4524: 5.3 Roles service doesn't provide granular enough feedback to cover manage-admin/privileges", "committedDate": "2020-03-05T22:19:05Z", "type": "commit"}, {"oid": "11e70e870b30f3bc3aa90ba2918943f1dfd33740", "url": "https://github.com/marklogic/marklogic-data-hub/commit/11e70e870b30f3bc3aa90ba2918943f1dfd33740", "message": "DHFPROD-4524: rename & simplify", "committedDate": "2020-03-05T22:19:05Z", "type": "commit"}, {"oid": "9d31db306306fb89a74eeab0bfc9b6579d104ea4", "url": "https://github.com/marklogic/marklogic-data-hub/commit/9d31db306306fb89a74eeab0bfc9b6579d104ea4", "message": "DHFPROD-4524: let authorities as part of login response", "committedDate": "2020-03-05T22:19:05Z", "type": "commit"}, {"oid": "ab45f6c6b9721b3a97a0e2f77759e54e680bc4e6", "url": "https://github.com/marklogic/marklogic-data-hub/commit/ab45f6c6b9721b3a97a0e2f77759e54e680bc4e6", "message": "DHFPROD-4524: fix response name", "committedDate": "2020-03-05T22:19:05Z", "type": "commit"}, {"oid": "8e20f191fcfc19d80fc9bcb0589c5b1fd724f9b4", "url": "https://github.com/marklogic/marklogic-data-hub/commit/8e20f191fcfc19d80fc9bcb0589c5b1fd724f9b4", "message": "hao/DHFPROD-4524: refactor getAuthorities & test cases", "committedDate": "2020-03-05T23:01:05Z", "type": "commit"}, {"oid": "8e20f191fcfc19d80fc9bcb0589c5b1fd724f9b4", "url": "https://github.com/marklogic/marklogic-data-hub/commit/8e20f191fcfc19d80fc9bcb0589c5b1fd724f9b4", "message": "hao/DHFPROD-4524: refactor getAuthorities & test cases", "committedDate": "2020-03-05T23:01:05Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODg5NjY2NA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3639#discussion_r388896664", "bodyText": "Instead of this special case for this one capability, just add a method to AuthenticationToken like this:\n\nboolean hasAuthority(String authorityName);\n\nLoginFilter can then just call token.hasAuthority(\"canInstallDataHub\")\nThen you don't need the boolean array of a single value.", "author": "rjrudin", "createdAt": "2020-03-06T13:18:05Z", "path": "one-ui/src/main/java/com/marklogic/hub/oneui/auth/AuthenticationFilter.java", "diffHunk": "@@ -137,17 +141,38 @@ protected AuthenticationToken authenticateUser(String username, String password)\n      * - see https://docs.spring.io/spring-security/site/docs/current/reference/htmlsingle/#appendix-faq-role-prefix.\n      *\n      * @param stagingClient\n+     * @param roles\n+     * @param canInstallDataHub\n      * @return\n      */\n-    protected List<GrantedAuthority> getAuthoritiesForAuthenticatedUser(DatabaseClient stagingClient) {\n-        List<GrantedAuthority> authorities = new ArrayList<>();\n+    protected Pair<List<GrantedAuthority>, ArrayNode> getAuthoritiesForAuthenticatedUser(DatabaseClient stagingClient, ArrayNode[] roles, boolean[] canInstallDataHub) {\n+        List<GrantedAuthority> grantAuthorities = new ArrayList<>();\n+        ArrayNode authorities = null;\n         JsonNode response = SecurityService.on(stagingClient).getAuthorities();\n-        if (response != null && response.has(\"authorities\")) {\n-            response.get(\"authorities\").iterator().forEachRemaining(node -> {\n-                authorities.add(new SimpleGrantedAuthority(\"ROLE_\" + node.asText()));\n-            });\n+        if (response != null) {\n+            if (response.has(\"authorities\")) {\n+                response.get(\"authorities\").iterator().forEachRemaining(node -> {\n+                    String authority = node.asText();\n+                    if (\"canInstallDataHub\".equals(authority))  {", "originalCommit": "8e20f191fcfc19d80fc9bcb0589c5b1fd724f9b4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODk3Nzc0MA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3639#discussion_r388977740", "bodyText": "@rjrudin I thought about using another method before,.But as we discussed, we do not need to have hasManagerPrivileges after UI change. And I will change the method to remove the canInstallDataHub array.", "author": "hao1st", "createdAt": "2020-03-06T15:43:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODg5NjY2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODk4MDg3Nw==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3639#discussion_r388980877", "bodyText": "Okay, that's fair.", "author": "rjrudin", "createdAt": "2020-03-06T15:49:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODg5NjY2NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODg5ODE5OA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3639#discussion_r388898198", "bodyText": "\"Authorites\" is misspelled, but if it were spelled correctly, you'd get a compilation error because \"getAuthorities\" already exists.\nWe don't need to store the authorities in two separate fields in AuthenticationToken. Instead, just add a \"getAuthorityNames\" method that returns a List. It will iterate over each GrantedAuthority and get its value and remove the \"ROLE_\", since the UI doesn't want to deal with that.", "author": "rjrudin", "createdAt": "2020-03-06T13:21:22Z", "path": "one-ui/src/main/java/com/marklogic/hub/oneui/auth/LoginHandler.java", "diffHunk": "@@ -47,6 +47,9 @@ public void onAuthenticationSuccess(HttpServletRequest request, HttpServletRespo\n         if (token.getRoles() != null) {\n             jsonResponse.putArray(\"roles\").addAll(token.getRoles());\n         }\n+        if (token.getAuthorites() != null) {", "originalCommit": "8e20f191fcfc19d80fc9bcb0589c5b1fd724f9b4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODk4MDk0OQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3639#discussion_r388980949", "bodyText": "oops, i did not notice that. and will modify it.", "author": "hao1st", "createdAt": "2020-03-06T15:49:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODg5ODE5OA=="}], "type": "inlineReview"}, {"oid": "92d96af85f3522ed79b345b25a487351be90625e", "url": "https://github.com/marklogic/marklogic-data-hub/commit/92d96af85f3522ed79b345b25a487351be90625e", "message": "DHFPROD-4524: refactor authorities", "committedDate": "2020-03-06T17:14:06Z", "type": "commit"}]}