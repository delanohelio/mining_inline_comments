{"pr_number": 4153, "pr_title": "DHFPROD-5272: Cypress integration test fail on develop", "pr_createdAt": "2020-06-25T22:40:28Z", "pr_url": "https://github.com/marklogic/marklogic-data-hub/pull/4153", "timeline": [{"oid": "4a5611b61a782d19c176b2b6d862cba9dc681c0d", "url": "https://github.com/marklogic/marklogic-data-hub/commit/4a5611b61a782d19c176b2b6d862cba9dc681c0d", "message": "DHFPROD-5272: Cypress integration test fail on develop", "committedDate": "2020-06-25T22:42:12Z", "type": "forcePushed"}, {"oid": "e9642b633238820cbaaccd60dd82f2631a40d1e7", "url": "https://github.com/marklogic/marklogic-data-hub/commit/e9642b633238820cbaaccd60dd82f2631a40d1e7", "message": "DHFPROD-5272: Cypress integration test fail on develop", "committedDate": "2020-06-25T23:32:51Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTg4OTI1Mw==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4153#discussion_r445889253", "bodyText": "Is it necessary to use waitUntil for these tests. How often have they failed in Jenkins due to load timing issue?", "author": "bsrikan", "createdAt": "2020-06-25T23:18:30Z", "path": "marklogic-data-hub-central/ui/e2e/cypress/integration/authorization.spec.tsx", "diffHunk": "@@ -76,12 +76,15 @@ describe('login', () => {\n         //All tiles but Explore, should show a tooltip that says contact your administrator\n       ['Load', 'Model', 'Curate', 'Run'].forEach((tile) => {\n           toolbar.getToolBarIcon(tile).trigger('mouseover');\n-          cy.contains(`${tile}: Contact your security administrator to get the roles and permissions required to access this functionality.`);\n+        //   cy.contains(`${tile}: Contact your security administrator to get the roles and permissions required to access this functionality.`);\n+          cy.waitUntil(() => cy.contains(`${tile}: Contact your security administrator to get the roles and permissions required to access this functionality.`))", "originalCommit": "4a5611b61a782d19c176b2b6d862cba9dc681c0d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTkwMTU2NA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4153#discussion_r445901564", "bodyText": "They failed for me several times. Didn't fail after adding cy.waitUntil(()).", "author": "timur-isangulov", "createdAt": "2020-06-26T00:02:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTg4OTI1Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTg5MTc4OQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4153#discussion_r445891789", "bodyText": "I think we agreed to remove \"View Entities\" test. Can we pls remove this commented out describe block instead of updating the tests which shouldnt be run.", "author": "bsrikan", "createdAt": "2020-06-25T23:27:04Z", "path": "marklogic-data-hub-central/ui/e2e/cypress/integration/scenarios.json.tsx", "diffHunk": "@@ -14,7 +15,7 @@ xdescribe('json scenario on view entities page', () => {\n     cy.visit('/');\n     cy.contains(Application.title);\n     cy.loginAsDeveloper();\n-    cy.wait(1000);\n+    cy.location('pathname', { timeout: 10000 }).should('include', '/tiles');", "originalCommit": "4a5611b61a782d19c176b2b6d862cba9dc681c0d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTkwMTg3Mg==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4153#discussion_r445901872", "bodyText": "Removed. Thanks.", "author": "timur-isangulov", "createdAt": "2020-06-26T00:03:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTg5MTc4OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTg5Mjg3OQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4153#discussion_r445892879", "bodyText": "We can delete all the \"View Instance\" tests as agreed instead of skipping them.", "author": "bsrikan", "createdAt": "2020-06-25T23:30:46Z", "path": "marklogic-data-hub-central/ui/e2e/cypress/integration/scenarios.json.tsx", "diffHunk": "@@ -166,7 +164,7 @@ describe('json scenario for snippet on browse documents page', () => {\n     browsePage.getDocumentFileType(0).should('exist')\n   });\n \n-  it('verify instance view of the document', () => {\n+  xit('verify instance view of the document', () => {", "originalCommit": "4a5611b61a782d19c176b2b6d862cba9dc681c0d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTkwMjU0OA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4153#discussion_r445902548", "bodyText": "We can use these tests after 4149 is merged.", "author": "timur-isangulov", "createdAt": "2020-06-26T00:06:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTg5Mjg3OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTg5MzQ2MA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4153#discussion_r445893460", "bodyText": "since this is a before Each block, its probably ok to use waitUntil here. For getTotalDocuments which is a browsePage locator, I would add waitUntil in the page object itself, so we dont have to call waitUntil on every use of that locator in the test.\nThat way we can keep the tests clean and readable.", "author": "bsrikan", "createdAt": "2020-06-25T23:32:47Z", "path": "marklogic-data-hub-central/ui/e2e/cypress/integration/scenarios.json.tsx", "diffHunk": "@@ -54,19 +55,17 @@ describe('json scenario for snippet on browse documents page', () => {\n     cy.visit('/');\n     cy.contains(Application.title);\n     cy.loginAsDeveloper().withRequest();\n-    toolbar.getExploreToolbarIcon().should('exist');\n-    toolbar.getExploreToolbarIcon().click();\n-    browsePage.getExploreButton().should('exist');\n-    browsePage.getExploreButton().click();\n+    cy.location('pathname', { timeout: 10000 }).should('include', '/tiles');\n     cy.wait(200);\n+    cy.waitUntil(() => toolbar.getExploreToolbarIcon()).click();\n+    cy.waitUntil(() => browsePage.getExploreButton()).click();", "originalCommit": "4a5611b61a782d19c176b2b6d862cba9dc681c0d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTkxNzMzMA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4153#discussion_r445917330", "bodyText": "Thanks.", "author": "timur-isangulov", "createdAt": "2020-06-26T01:07:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTg5MzQ2MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTg5NTYwNg==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4153#discussion_r445895606", "bodyText": "same as above. Lets delete these skipped view entities test than updating them.", "author": "bsrikan", "createdAt": "2020-06-25T23:41:00Z", "path": "marklogic-data-hub-central/ui/e2e/cypress/integration/scenarios.xml.tsx", "diffHunk": "@@ -15,11 +15,12 @@ xdescribe('xml scenario on view entities page', () => {\n     cy.visit('/');\n     cy.contains(Application.title);\n     cy.loginAsDeveloper().withRequest();\n-    // temporary change as tile is not working\n-    homePage.getTitle().click();\n-    cy.wait(500);\n-    // temporary change end here\n-    homePage.getViewEntities().click();\n+    cy.location('pathname', { timeout: 10000 }).should('include', '/tiles');", "originalCommit": "e9642b633238820cbaaccd60dd82f2631a40d1e7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTg5NTk3OA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4153#discussion_r445895978", "bodyText": "We can delete this test file itself since the tests here are for obsolete \"View Entities\"", "author": "bsrikan", "createdAt": "2020-06-25T23:42:22Z", "path": "marklogic-data-hub-central/ui/e2e/cypress/integration/view-entities.validation.tsx", "diffHunk": "@@ -11,6 +12,7 @@ xdescribe('view page validation', () => {\n     cy.visit('/');\n     cy.contains(Application.title);\n     cy.loginAsDeveloper().withRequest();\n+    cy.location('pathname', { timeout: 10000 }).should('include', '/tiles');", "originalCommit": "e9642b633238820cbaaccd60dd82f2631a40d1e7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTg5OTU1MA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4153#discussion_r445899550", "bodyText": "cy.findByText('Manage Queries') is a better option. We should try using such locators through out existing tests as well, than using implementation detail for locators. Can we try with that for few runs before using waitUntil and explicit waits. Its just a lot of waits here.\nThe usage of waitUntil in the locator here is again a better approach than using them in tests. This is what I have suggested for getTotalDocuments. It should be applied to other changes in this PR if the same thing is being used in more than one place.", "author": "bsrikan", "createdAt": "2020-06-25T23:55:18Z", "path": "marklogic-data-hub-central/ui/e2e/cypress/support/pages/browse.tsx", "diffHunk": "@@ -336,8 +338,11 @@ class BrowsePage {\n   }\n \n   getManageQueriesModalOpened(){\n-    cy.get('.fa-cog').click();\n-    cy.get('.ant-dropdown-menu-item').click();\n+    cy.wait(200);\n+    cy.waitUntil(() => cy.get('.fa-cog')).click();\n+    cy.wait(200);\n+    cy.waitUntil(() => cy.get('.ant-dropdown-menu-item')).click();\n+    cy.wait(200);", "originalCommit": "e9642b633238820cbaaccd60dd82f2631a40d1e7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTkwNDQ0OA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4153#discussion_r445904448", "bodyText": "Some methods require additional wait times.", "author": "timur-isangulov", "createdAt": "2020-06-26T00:13:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTg5OTU1MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTkwMDgxOA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4153#discussion_r445900818", "bodyText": "I dont see a usage of this in test anywhere. Is the intent here to wait until the spinner disappears or wait for spinner to appear. If we have usage for both then we should have 2 different locator methods for this purpose to be used in the test later.", "author": "bsrikan", "createdAt": "2020-06-25T23:59:52Z", "path": "marklogic-data-hub-central/ui/e2e/cypress/support/pages/browse.tsx", "diffHunk": "@@ -396,6 +401,10 @@ class BrowsePage {\n     return cy.get('[data-cy=explore]');\n }\n \n+getLoadingSpinner(){\n+  return cy.get('[data-cy=spinner]');", "originalCommit": "e9642b633238820cbaaccd60dd82f2631a40d1e7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTkwMjgyMg==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4153#discussion_r445902822", "bodyText": "Removed.", "author": "timur-isangulov", "createdAt": "2020-06-26T00:07:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTkwMDgxOA=="}], "type": "inlineReview"}, {"oid": "06971d5a28e8796d0f6ecc32ecdd00783e4be8dd", "url": "https://github.com/marklogic/marklogic-data-hub/commit/06971d5a28e8796d0f6ecc32ecdd00783e4be8dd", "message": "DHFPROD-5272: Cypress integration test fail on develop", "committedDate": "2020-06-26T01:07:10Z", "type": "forcePushed"}, {"oid": "83aff97d98acb5daaa36c07995eb3c33bc6b87de", "url": "https://github.com/marklogic/marklogic-data-hub/commit/83aff97d98acb5daaa36c07995eb3c33bc6b87de", "message": "DHFPROD-5272: Cypress integration test fail on develop", "committedDate": "2020-06-26T16:48:47Z", "type": "commit"}, {"oid": "83aff97d98acb5daaa36c07995eb3c33bc6b87de", "url": "https://github.com/marklogic/marklogic-data-hub/commit/83aff97d98acb5daaa36c07995eb3c33bc6b87de", "message": "DHFPROD-5272: Cypress integration test fail on develop", "committedDate": "2020-06-26T16:48:47Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjMyNjkzNg==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4153#discussion_r446326936", "bodyText": "Going to give this a pass now, since tests seem to pass.\nBut if they do fail again in Jenkins, the best approach for locators is just to return the element back and take action on them in the test. We shouldnt be doing click action in the locator and certainly avoid using callbacks which leads to brittle tests like we see today.\nIdeally we would want to split this out into \"selectEntityDropDown()\" and \"selectEntityType(entityType: string)\" and return cy.findByText(entityType). Then the test will look like\nbrowsePage.selectEntityDropDown().click();\nbrowsePage.selectEntityType('Customer').click()", "author": "bsrikan", "createdAt": "2020-06-26T17:50:48Z", "path": "marklogic-data-hub-central/ui/e2e/cypress/support/pages/browse.tsx", "diffHunk": "@@ -1,22 +1,28 @@\n+import 'cypress-wait-until';\n+\n class BrowsePage {\n \n   getSelectedEntity() {\n     return cy.get('.ant-select-selection-selected-value').invoke('text')\n   }\n \n   selectEntity(entity: string) {\n-    cy.get('#entity-select').click();\n-    return cy.get('[data-cy=entity-option]').each(function (item) {\n+    cy.waitUntil(() => cy.get('#entity-select')).click();\n+    return cy.waitUntil(() => cy.get('[data-cy=entity-option]')).each(function (item) {", "originalCommit": "83aff97d98acb5daaa36c07995eb3c33bc6b87de", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjMzMTY1NA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4153#discussion_r446331654", "bodyText": "Ideally we would like to hide the logic from the tests and move it to the helper methods on browse, model, etc pages. So we don't duplicate the same actions browsePage.selectEntityDropDown().click();\nbrowsePage.selectEntityType('Customer').click() in every test. This will make tests shorter, readable and stable.", "author": "timur-isangulov", "createdAt": "2020-06-26T18:00:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjMyNjkzNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjM1OTU0MA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4153#discussion_r446359540", "bodyText": "I agree that we should hide logic from the tests and in this scenario we are talking about a couple of clicks. That is what a user would do when he comes to zero state of Explorer, click open the dropdown and select an entityType. I dont see a logic involved here.\nInfact the locator is introducing a logic when there is no need to. If the intent was to have less lines of test code, then IMO robust and stable tests take priority over less lines of test code.\nThese tests were not stable with such use of the locator and that is why we are having to add waitUntil and waits with this PR.", "author": "bsrikan", "createdAt": "2020-06-26T19:02:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjMyNjkzNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjM2NjI5Mw==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4153#discussion_r446366293", "bodyText": "I think we need to use more waitUntil methods for the steps which requires api and page rendering. The main reason for the test to fail is that the api call or page elements rendering takes sometimes much more time while running tests in Cypress than in real browser.", "author": "timur-isangulov", "createdAt": "2020-06-26T19:18:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjMyNjkzNg=="}], "type": "inlineReview"}]}