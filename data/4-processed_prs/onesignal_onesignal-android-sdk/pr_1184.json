{"pr_number": 1184, "pr_title": "Fix/implement adm message handler job base", "pr_createdAt": "2020-10-13T18:17:49Z", "pr_url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1184", "timeline": [{"oid": "567000a15d5a78a1ad519570ac00f6964dfc9e9a", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/567000a15d5a78a1ad519570ac00f6964dfc9e9a", "message": "Updating to ADM 1.1.0", "committedDate": "2020-10-13T18:14:50Z", "type": "commit"}, {"oid": "765f77e126e7d0d990f6a43165aa1b2f0dffe088", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/765f77e126e7d0d990f6a43165aa1b2f0dffe088", "message": "adding amazon api_key and updating the signing debug keystore", "committedDate": "2020-10-13T18:14:50Z", "type": "commit"}, {"oid": "cf3d57b69695afd086b53186f70c2c77eb4e5b9c", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/cf3d57b69695afd086b53186f70c2c77eb4e5b9c", "message": "Updating dev app AndroidManifest to support Amazon", "committedDate": "2020-10-13T18:14:50Z", "type": "commit"}, {"oid": "7de8a1195f9c4838a6c6a79cdbded5804c3b5043", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/7de8a1195f9c4838a6c6a79cdbded5804c3b5043", "message": "creating ADMMessageHandlerJob class", "committedDate": "2020-10-13T18:14:50Z", "type": "commit"}, {"oid": "dd85fb43a8dfb732c2486edff57d8721f1e3b983", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/dd85fb43a8dfb732c2486edff57d8721f1e3b983", "message": "implementing ADMMessageHandlerJob and updating receiver", "committedDate": "2020-10-13T18:14:50Z", "type": "commit"}, {"oid": "672fe79cc7bacb5189ef835d7e7524022c143e47", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/672fe79cc7bacb5189ef835d7e7524022c143e47", "message": "Updating job id", "committedDate": "2020-10-13T18:14:50Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDIyNTQ4NA==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1184#discussion_r504225484", "bodyText": "is this something necessary? do we want this to be pushed?", "author": "Jeasmine", "createdAt": "2020-10-13T20:09:18Z", "path": "Examples/OneSignalDemo/app/src/main/assets/api_key.txt", "diffHunk": "@@ -0,0 +1 @@\n+eyJhbGciOiJSU0EtU0hBMjU2IiwidmVyIjoiMSJ9.eyJ2ZXIiOiIzIiwiZW5kcG9pbnRzIjp7ImF1dGh6IjoiaHR0cHM6Ly93d3cuYW1hem9uLmNvbS9hcC9vYSIsInRva2VuRXhjaGFuZ2UiOiJodHRwczovL2FwaS5hbWF6b24uY29tL2F1dGgvbzIvdG9rZW4ifSwiY2xpZW50SWQiOiJhbXpuMS5hcHBsaWNhdGlvbi1vYTItY2xpZW50LjE4YzMyNDljZGU0YzQ3YTI5YmZmZDQ5NTFiZTVmMjRlIiwiYXBwRmFtaWx5SWQiOiJhbXpuMS5hcHBsaWNhdGlvbi43MDMxNjFhNTk5NjM0MWY0ODI2N2RmNWU2Yzc1MTM5MiIsImlzcyI6IkFtYXpvbiIsInR5cGUiOiJBUElLZXkiLCJwa2ciOiJjb20ub25lc2lnbmFsLnNka3Rlc3QiLCJhcHBWYXJpYW50SWQiOiJhbXpuMS5hcHBsaWNhdGlvbi1jbGllbnQuZGUxZDljYTk3MDk3NGRmYjlmMDVkMjg3YWEzNDhjYjEiLCJ0cnVzdFBvb2wiOm51bGwsImFwcHNpZ1NoYTI1NiI6IkQyOjgzOjBDOjAyOkU2OkExOjYzOkZEOkU1OkYxOjdDOjM4OkI2Ojk1OkM3OkVBOjBCOjQyOkQ1OkY5OjlDOjMyOkRGOkI1OjUzOkFEOjU0OjJEOjc2OkNFOkY5OkE3IiwiYXBwc2lnIjoiRTU6OTY6RkY6RTU6RjU6RDg6QkM6MDk6Qzk6QUY6OTA6RkU6Rjk6QUY6RUY6QTYiLCJhcHBJZCI6ImFtem4xLmFwcGxpY2F0aW9uLWNsaWVudC5kZTFkOWNhOTcwOTc0ZGZiOWYwNWQyODdhYTM0OGNiMSIsImlkIjoiOTA4ZDZhMzgtOGFhMy00Zjg4LTg3NWUtNzM3YjdlMzNkMzNmIiwiaWF0IjoiMTYwMjU1NTYyMTgzMSJ9.EhgKSIl9JKbVIe+CNeN0WkFbGoMJpAZEX0jq3mXTGv2kX+DN/GdFpJkIlOQ30dF1o7CLgWz4lxK0AHUAmeuNdGzyBAf7EmzqRukGmQ6Gh5sgo+YoecQnRFXSMv/uRt9KIDYWY9YvOWeNxfrWPOu6JNfLRgrFt/gmtDEk/THIOS5UDtRJW59+x3e6aVOXNJBt7Vo8gaUgqE7JK/p/iGRyT5AnaTDQICrlIomYFg6ZrJ61zQ0ATg+e5GTGeURcOMWDff8lMdfOC3pDGUGCW574aslTlV1/dCIbWLJ6bbxvcZNwAB/eU7F3XvwANDY4xvQm4V9RJz37zcWJ2rObz2P0/w==", "originalCommit": "672fe79cc7bacb5189ef835d7e7524022c143e47", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDI3MTE2OA==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1184#discussion_r504271168", "bodyText": "It is going to be different based on the package name and the Android Signing keys used to build your app.\nI think it would be good to have this file here but instead the contents of this file should point to our docs on how they can generate this file.", "author": "jkasten2", "createdAt": "2020-10-13T21:32:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDIyNTQ4NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDIyNjM5NQ==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1184#discussion_r504226395", "bodyText": "Were all these Gradle changes made, in order to use the demo app as an independent project?", "author": "Jeasmine", "createdAt": "2020-10-13T20:11:05Z", "path": "OneSignalSDK/app/gradlew", "diffHunk": "@@ -0,0 +1,172 @@\n+#!/usr/bin/env sh", "originalCommit": "672fe79cc7bacb5189ef835d7e7524022c143e47", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDI2ODg3OQ==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1184#discussion_r504268879", "bodyText": "Ya we don't need any of these files under OneSignalSDK/app. We actually don't have a \"dev\" app anymore. The SDK workspace points to the example to share the same code", "author": "jkasten2", "createdAt": "2020-10-13T21:28:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDIyNjM5NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDIyODEwNQ==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1184#discussion_r504228105", "bodyText": "reformat code \ud83d\ude4f", "author": "Jeasmine", "createdAt": "2020-10-13T20:14:45Z", "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/ADMMessageHandler.java", "diffHunk": "@@ -43,6 +44,18 @@\n    public static class Receiver extends ADMMessageReceiver {\n       public Receiver() {\n          super(ADMMessageHandler.class);\n+         boolean ADMLatestAvailable = false;\n+         try{", "originalCommit": "672fe79cc7bacb5189ef835d7e7524022c143e47", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDIyODIwNg==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1184#discussion_r504228206", "bodyText": "can we log this?", "author": "Jeasmine", "createdAt": "2020-10-13T20:14:58Z", "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/ADMMessageHandler.java", "diffHunk": "@@ -43,6 +44,18 @@\n    public static class Receiver extends ADMMessageReceiver {\n       public Receiver() {\n          super(ADMMessageHandler.class);\n+         boolean ADMLatestAvailable = false;\n+         try{\n+            Class.forName( \"com.amazon.device.messaging.ADMMessageHandlerJobBase\" );\n+            ADMLatestAvailable = true ;\n+         }\n+         catch (ClassNotFoundException e)\n+         {\n+            // Handle the exception.", "originalCommit": "672fe79cc7bacb5189ef835d7e7524022c143e47", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDI2NjU1Mg==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1184#discussion_r504266552", "bodyText": "Don't need to log the catch as it is expected to throw on older FireOS devices everytime.\nLogging ADMLatestAvailable after words as DEBUG would be a good idea though.", "author": "jkasten2", "createdAt": "2020-10-13T21:23:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDIyODIwNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDIzMTIxNA==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1184#discussion_r504231214", "bodyText": "if the number is the job id, can you make it a constant? usually, ids started with a number to identify the job type, for example for intents we use 100x, 200x, or 10x, 20x, for this ADM we could use 3000? just to have a convention regarding all ADM to start with 300.", "author": "Jeasmine", "createdAt": "2020-10-13T20:18:42Z", "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/ADMMessageHandler.java", "diffHunk": "@@ -43,6 +44,18 @@\n    public static class Receiver extends ADMMessageReceiver {\n       public Receiver() {\n          super(ADMMessageHandler.class);\n+         boolean ADMLatestAvailable = false;\n+         try{\n+            Class.forName( \"com.amazon.device.messaging.ADMMessageHandlerJobBase\" );\n+            ADMLatestAvailable = true ;\n+         }\n+         catch (ClassNotFoundException e)\n+         {\n+            // Handle the exception.\n+         }\n+         if (ADMLatestAvailable) {\n+            registerJobServiceClass(ADMMessageHandlerJob.class, 123891);", "originalCommit": "672fe79cc7bacb5189ef835d7e7524022c143e47", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDI2NzMxMg==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1184#discussion_r504267312", "bodyText": "I agree on making this a constant.\nWe don't want to use something like 3000 as this is something an app developer might pick for something else. The value 123891 is fine, we want to make sure it is unique.", "author": "jkasten2", "createdAt": "2020-10-13T21:24:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDIzMTIxNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDIzMTQyNA==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1184#discussion_r504231424", "bodyText": "remove extra enter", "author": "Jeasmine", "createdAt": "2020-10-13T20:18:55Z", "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/ADMMessageHandlerJob.kt", "diffHunk": "@@ -0,0 +1,46 @@\n+package com.onesignal\n+", "originalCommit": "672fe79cc7bacb5189ef835d7e7524022c143e47", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDIzMjE3Ng==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1184#discussion_r504232176", "bodyText": "shouldn't all this configuration go under the OneSignal SDK manifest?", "author": "Jeasmine", "createdAt": "2020-10-13T20:19:38Z", "path": "Examples/OneSignalDemo/app/src/main/AndroidManifest.xml", "diffHunk": "@@ -1,13 +1,24 @@\n <?xml version=\"1.0\" encoding=\"utf-8\"?>\n <manifest xmlns:android=\"http://schemas.android.com/apk/res/android\"\n     xmlns:tools=\"http://schemas.android.com/tools\"\n+    xmlns:amazon=\"http://schemas.amazon.com/apk/res/android\"", "originalCommit": "672fe79cc7bacb5189ef835d7e7524022c143e47", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDI2OTM4Ng==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1184#discussion_r504269386", "bodyText": "@Jeasmine No since we don't want to add Amazon by default for everyone.\nWe could in the future however make a new module to do this for them though", "author": "jkasten2", "createdAt": "2020-10-13T21:29:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDIzMjE3Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDk1MTk3NA==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1184#discussion_r504951974", "bodyText": "a new module sounds good!", "author": "Jeasmine", "createdAt": "2020-10-14T20:26:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDIzMjE3Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDIzMzg5Mg==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1184#discussion_r504233892", "bodyText": "we shouldn't use force unwrap, always try to treat optional with null safety methods", "author": "Jeasmine", "createdAt": "2020-10-13T20:21:15Z", "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/ADMMessageHandlerJob.kt", "diffHunk": "@@ -0,0 +1,46 @@\n+package com.onesignal\n+\n+\n+import android.content.Context\n+import android.content.Intent\n+import com.amazon.device.messaging.ADMMessageHandlerJobBase\n+\n+class ADMMessageHandlerJob : ADMMessageHandlerJobBase() {\n+\n+    override fun onMessage(context: Context?, intent: Intent?) {\n+        val bundle = intent!!.extras", "originalCommit": "672fe79cc7bacb5189ef835d7e7524022c143e47", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDIzNTI3OQ==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1184#discussion_r504235279", "bodyText": "given that this file is on kotlin, can you use the apply block for building the object? apply block is the code style that we are following for \"builder pattern\"", "author": "Jeasmine", "createdAt": "2020-10-13T20:22:39Z", "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/ADMMessageHandlerJob.kt", "diffHunk": "@@ -0,0 +1,46 @@\n+package com.onesignal\n+\n+\n+import android.content.Context\n+import android.content.Intent\n+import com.amazon.device.messaging.ADMMessageHandlerJobBase\n+\n+class ADMMessageHandlerJob : ADMMessageHandlerJobBase() {\n+\n+    override fun onMessage(context: Context?, intent: Intent?) {\n+        val bundle = intent!!.extras\n+\n+        val processedResult = NotificationBundleProcessor.processBundleFromReceiver(context, bundle)\n+        // TODO: Figure out the correct replacement or usage of completeWakefulIntent method\n+//      FCMBroadcastReceiver.completeWakefulIntent(intent);\n+\n+        // TODO: Figure out the correct replacement or usage of completeWakefulIntent method\n+//      FCMBroadcastReceiver.completeWakefulIntent(intent);\n+        if (processedResult.processed()) return\n+\n+        val payload = NotificationBundleProcessor.bundleAsJSONObject(bundle)\n+        val notification = OSNotification(payload)\n+\n+        val notificationJob = OSNotificationGenerationJob(context)", "originalCommit": "672fe79cc7bacb5189ef835d7e7524022c143e47", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDI2Nzg5Ng==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1184#discussion_r504267896", "bodyText": "These comments are repeated twice", "author": "jkasten2", "createdAt": "2020-10-13T21:25:54Z", "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/ADMMessageHandlerJob.kt", "diffHunk": "@@ -0,0 +1,46 @@\n+package com.onesignal\n+\n+\n+import android.content.Context\n+import android.content.Intent\n+import com.amazon.device.messaging.ADMMessageHandlerJobBase\n+\n+class ADMMessageHandlerJob : ADMMessageHandlerJobBase() {\n+\n+    override fun onMessage(context: Context?, intent: Intent?) {\n+        val bundle = intent!!.extras\n+\n+        val processedResult = NotificationBundleProcessor.processBundleFromReceiver(context, bundle)\n+        // TODO: Figure out the correct replacement or usage of completeWakefulIntent method\n+//      FCMBroadcastReceiver.completeWakefulIntent(intent);\n+\n+        // TODO: Figure out the correct replacement or usage of completeWakefulIntent method\n+//      FCMBroadcastReceiver.completeWakefulIntent(intent);", "originalCommit": "672fe79cc7bacb5189ef835d7e7524022c143e47", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDI3MDIxNA==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1184#discussion_r504270214", "bodyText": "I believe Android Studio uses all the these as defaults automatically so we don't need to add these here.", "author": "jkasten2", "createdAt": "2020-10-13T21:30:45Z", "path": "Examples/OneSignalDemo/app/build.gradle", "diffHunk": "@@ -3,6 +3,14 @@ apply plugin: 'com.onesignal.androidsdk.onesignal-gradle-plugin'\n apply plugin: 'com.android.application'\n \n android {\n+    signingConfigs {\n+        debug {\n+            storeFile file('/Users/elliotmawby/.android/debug.keystore')", "originalCommit": "672fe79cc7bacb5189ef835d7e7524022c143e47", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDk1MjU1NA==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1184#discussion_r504952554", "bodyText": "yeah, but If @emawby is building the apk from console it might be asking him to have this configured on the file.", "author": "Jeasmine", "createdAt": "2020-10-14T20:27:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDI3MDIxNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDI5MTg5OA==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1184#discussion_r504291898", "bodyText": "Add this class to the consumer-proguard-rules.pro. See comment in this file\nhttps://github.com/OneSignal/OneSignal-Android-SDK/blob/master/OneSignalSDK/onesignal/consumer-proguard-rules.pro#L56", "author": "jkasten2", "createdAt": "2020-10-13T22:21:07Z", "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/ADMMessageHandlerJob.kt", "diffHunk": "@@ -0,0 +1,46 @@\n+package com.onesignal\n+\n+\n+import android.content.Context\n+import android.content.Intent\n+import com.amazon.device.messaging.ADMMessageHandlerJobBase\n+\n+class ADMMessageHandlerJob : ADMMessageHandlerJobBase() {", "originalCommit": "672fe79cc7bacb5189ef835d7e7524022c143e47", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "ef9ae8db3c4ba8c986b03a24b79c25f744b324f7", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/ef9ae8db3c4ba8c986b03a24b79c25f744b324f7", "message": "remove api key", "committedDate": "2020-10-14T21:03:00Z", "type": "commit"}, {"oid": "bc3b3dc2ce917c36da3885d9bc8e7b202ee098d1", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/bc3b3dc2ce917c36da3885d9bc8e7b202ee098d1", "message": "remove app changes", "committedDate": "2020-10-14T21:04:16Z", "type": "commit"}, {"oid": "ee3914049a97657a495f1c401a6ca5a421169516", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/ee3914049a97657a495f1c401a6ca5a421169516", "message": "logging adm latest available and code style changes", "committedDate": "2020-10-14T21:17:08Z", "type": "commit"}, {"oid": "516648a23acaf588354688ece26bb6928d2ed02b", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/516648a23acaf588354688ece26bb6928d2ed02b", "message": "code style changes", "committedDate": "2020-10-14T21:17:21Z", "type": "commit"}, {"oid": "7143c42b5fb5d2b71e56378f119449db8284c964", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/7143c42b5fb5d2b71e56378f119449db8284c964", "message": "adding ADMMessageHandlerJob to proguard rules", "committedDate": "2020-10-14T21:20:47Z", "type": "commit"}]}