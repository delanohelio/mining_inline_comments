{"pr_number": 974, "pr_title": "Add new features to IAM preview ", "pr_createdAt": "2020-03-20T22:42:23Z", "pr_url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/974", "timeline": [{"oid": "91b556e07c6555391402b110033a70f7b7b69459", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/91b556e07c6555391402b110033a70f7b7b69459", "message": "Add new features to IAM preview\n\n   * Add prompt to IAM preview\n   * Add logs for tags and outcomes\n   * Redisplay, tags, outcomes, impression should not be included on IAM preview", "committedDate": "2020-03-20T22:43:01Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjEyNjAwMQ==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/974#discussion_r396126001", "bodyText": "Don't make it specific to tags and outcomes we might have more things added here eventually\nChange name from fireTagsAndOutcomeLogs to\nlogInAppMessagePreviewActions or\nlogIamPreviewActions?", "author": "mikechoch", "createdAt": "2020-03-22T18:31:01Z", "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java", "diffHunk": "@@ -284,19 +285,57 @@ void onMessageActionOccurredOnPreview(@NonNull final OSInAppMessage message, @No\n         action.firstClick = message.takeActionAsUnique();\n \n         firePublicClickHandler(action);\n+        showPrompts(message, action.prompts);\n         fireClickAction(action);\n+        fireTagsAndOutcomeLogs(action);\n     }\n \n-    private void firePrompt(OSInAppMessage message, final List<OSInAppMessagePrompt> prompts) {\n-        for (OSInAppMessagePrompt prompt : prompts) {\n+    private void fireTagsAndOutcomeLogs(final OSInAppMessageAction action) {", "originalCommit": "91b556e07c6555391402b110033a70f7b7b69459", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjEyNjY4MA==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/974#discussion_r396126680", "bodyText": "way too much extra code here, tags and outcomes are JSONObjects so just call tags.toString() and print that\nwith a single log about the tags\nSame exact thing for outcomes, outcomes.toString() with a log\nex.\nprivate void fireTagsAndOutcomeLogs(final OSInAppMessageAction action) {\n@mikechoch\nmikechoch Member Pending\nDon't make it specific to tags and outcomes we might have more things added here eventually\nChange name from fireTagsAndOutcomeLogs to\nlogInAppMessagePreviewActions or\nlogIamPreviewActions?\nprivate void logInAppMessagePreviewActions(final OSInAppMessageAction action) {\n    JSONObject tags = action.tags;\n    if (tags != null)\n        OneSignal.onesignalLog(OneSignal.LOG_LEVEL.DEBUG, \"Tags detected inside of the action click payload, ignoring because action came from IAM preview: \" + tags.toString());\n   \n    JSONObject outcomes = action.outcomes;\n    if (outcomes != null)\n        OneSignal.onesignalLog(OneSignal.LOG_LEVEL.DEBUG, \"Outcomes detected inside of the action click payload, ignoring because action came from IAM preview: \" + outcomes.toString());\n\n    // TODO: Add more action payload preview logs here in future\n}", "author": "mikechoch", "createdAt": "2020-03-22T18:38:26Z", "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java", "diffHunk": "@@ -284,19 +285,57 @@ void onMessageActionOccurredOnPreview(@NonNull final OSInAppMessage message, @No\n         action.firstClick = message.takeActionAsUnique();\n \n         firePublicClickHandler(action);\n+        showPrompts(message, action.prompts);\n         fireClickAction(action);\n+        fireTagsAndOutcomeLogs(action);\n     }\n \n-    private void firePrompt(OSInAppMessage message, final List<OSInAppMessagePrompt> prompts) {\n-        for (OSInAppMessagePrompt prompt : prompts) {\n+    private void fireTagsAndOutcomeLogs(final OSInAppMessageAction action) {\n+        if (action.tags != null) {\n+            OSInAppMessageTag tags = action.tags;\n+            if (tags.getTagsToAdd() != null)\n+                OneSignal.onesignalLog(OneSignal.LOG_LEVEL.DEBUG, \"Tags to add detected inside of the action click payload, ignoring because action came from IAM preview:: \" + tags.getTagsToAdd());\n+            if (tags.getTagsToRemove() != null)\n+                OneSignal.onesignalLog(OneSignal.LOG_LEVEL.DEBUG, \"Tags to remove detected inside of the action click payload, ignoring because action came from IAM preview: \" + tags.getTagsToRemove());\n+        }\n+\n+        for (OSInAppMessageOutcome outcome : action.outcomes) {\n+            OneSignal.onesignalLog(OneSignal.LOG_LEVEL.DEBUG, \"Outcome detected inside of the action click payload, ignoring because action came from IAM preview: \" + outcome.toString());\n+        }\n+    }", "originalCommit": "91b556e07c6555391402b110033a70f7b7b69459", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjEyNzIzMw==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/974#discussion_r396127233", "bodyText": "rename to beginProcessingPrompts that way the next calls make more sense.", "author": "mikechoch", "createdAt": "2020-03-22T18:44:41Z", "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java", "diffHunk": "@@ -284,19 +285,57 @@ void onMessageActionOccurredOnPreview(@NonNull final OSInAppMessage message, @No\n         action.firstClick = message.takeActionAsUnique();\n \n         firePublicClickHandler(action);\n+        showPrompts(message, action.prompts);\n         fireClickAction(action);\n+        fireTagsAndOutcomeLogs(action);\n     }\n \n-    private void firePrompt(OSInAppMessage message, final List<OSInAppMessagePrompt> prompts) {\n-        for (OSInAppMessagePrompt prompt : prompts) {\n+    private void fireTagsAndOutcomeLogs(final OSInAppMessageAction action) {\n+        if (action.tags != null) {\n+            OSInAppMessageTag tags = action.tags;\n+            if (tags.getTagsToAdd() != null)\n+                OneSignal.onesignalLog(OneSignal.LOG_LEVEL.DEBUG, \"Tags to add detected inside of the action click payload, ignoring because action came from IAM preview:: \" + tags.getTagsToAdd());\n+            if (tags.getTagsToRemove() != null)\n+                OneSignal.onesignalLog(OneSignal.LOG_LEVEL.DEBUG, \"Tags to remove detected inside of the action click payload, ignoring because action came from IAM preview: \" + tags.getTagsToRemove());\n+        }\n+\n+        for (OSInAppMessageOutcome outcome : action.outcomes) {\n+            OneSignal.onesignalLog(OneSignal.LOG_LEVEL.DEBUG, \"Outcome detected inside of the action click payload, ignoring because action came from IAM preview: \" + outcome.toString());\n+        }\n+    }\n+\n+    private void showPrompts(OSInAppMessage message, final List<OSInAppMessagePrompt> prompts) {", "originalCommit": "91b556e07c6555391402b110033a70f7b7b69459", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjEyNzIzNQ==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/974#discussion_r396127235", "bodyText": "Rename to showMultiplePrompts", "author": "mikechoch", "createdAt": "2020-03-22T18:44:42Z", "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java", "diffHunk": "@@ -284,19 +285,57 @@ void onMessageActionOccurredOnPreview(@NonNull final OSInAppMessage message, @No\n         action.firstClick = message.takeActionAsUnique();\n \n         firePublicClickHandler(action);\n+        showPrompts(message, action.prompts);\n         fireClickAction(action);\n+        fireTagsAndOutcomeLogs(action);\n     }\n \n-    private void firePrompt(OSInAppMessage message, final List<OSInAppMessagePrompt> prompts) {\n-        for (OSInAppMessagePrompt prompt : prompts) {\n+    private void fireTagsAndOutcomeLogs(final OSInAppMessageAction action) {\n+        if (action.tags != null) {\n+            OSInAppMessageTag tags = action.tags;\n+            if (tags.getTagsToAdd() != null)\n+                OneSignal.onesignalLog(OneSignal.LOG_LEVEL.DEBUG, \"Tags to add detected inside of the action click payload, ignoring because action came from IAM preview:: \" + tags.getTagsToAdd());\n+            if (tags.getTagsToRemove() != null)\n+                OneSignal.onesignalLog(OneSignal.LOG_LEVEL.DEBUG, \"Tags to remove detected inside of the action click payload, ignoring because action came from IAM preview: \" + tags.getTagsToRemove());\n+        }\n+\n+        for (OSInAppMessageOutcome outcome : action.outcomes) {\n+            OneSignal.onesignalLog(OneSignal.LOG_LEVEL.DEBUG, \"Outcome detected inside of the action click payload, ignoring because action came from IAM preview: \" + outcome.toString());\n+        }\n+    }\n+\n+    private void showPrompts(OSInAppMessage message, final List<OSInAppMessagePrompt> prompts) {\n+        if (prompts.size() > 0) {\n+            OneSignal.onesignalLog(OneSignal.LOG_LEVEL.DEBUG, \"IAM showing prompts from IAM: \" + message.toString());\n             // TODO until we don't fix the activity going forward or back dismissing the IAM, we need to auto dismiss\n-            messageWasDismissed(message);\n-            prompt.handlePrompt(new OneSignal.OperationCompletedCallback() {\n+            WebViewManager.dismissCurrentIAM();\n+            handleMultiplePrompts(message, prompts);\n+        }\n+    }\n+\n+    private void handleMultiplePrompts(final OSInAppMessage message, final List<OSInAppMessagePrompt> prompts) {", "originalCommit": "91b556e07c6555391402b110033a70f7b7b69459", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "0d451efd6cb66bf95e33d1bca754987dae13b062", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/0d451efd6cb66bf95e33d1bca754987dae13b062", "message": "Add new features to IAM preview\n\n   * Add prompt to IAM preview\n   * Add logs for tags and outcomes\n   * Redisplay, tags, outcomes, impression should not be included on IAM preview", "committedDate": "2020-03-23T19:35:40Z", "type": "commit"}, {"oid": "0d451efd6cb66bf95e33d1bca754987dae13b062", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/0d451efd6cb66bf95e33d1bca754987dae13b062", "message": "Add new features to IAM preview\n\n   * Add prompt to IAM preview\n   * Add logs for tags and outcomes\n   * Redisplay, tags, outcomes, impression should not be included on IAM preview", "committedDate": "2020-03-23T19:35:40Z", "type": "forcePushed"}]}