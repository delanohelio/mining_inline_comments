{"pr_number": 942, "pr_title": "IAM still show form the queue when IAM is pasued (Reported from Unity)", "pr_createdAt": "2020-01-30T22:21:29Z", "pr_url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/942", "timeline": [{"oid": "ee3abceffdd970ab3eb9f2d7ebb7babd547a35fe", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/ee3abceffdd970ab3eb9f2d7ebb7babd547a35fe", "message": "Changes to the aim controller to fix a bug reported from Unity\n* IAM will show form the queue even when IAM is paused\n* Must wrap the check around the display action not the action to add to the queue\n* When IAM is paused adding to the queue works now and displaying will be prevented instead", "committedDate": "2020-01-30T22:20:27Z", "type": "commit"}, {"oid": "788dc752715c293d81f760ecbdc53112e9f5e9ab", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/788dc752715c293d81f760ecbdc53112e9f5e9ab", "message": "Modified more triggeredMessages old code\n* Now we call them dismissedMessages, as triggered is confusing and sounds like it refers to IAM triggers added from the dashboard\n* `tempTriggeredSet` is now `tempDismissedSet` when get persisted IAMs", "committedDate": "2020-01-30T22:24:57Z", "type": "commit"}, {"oid": "b6e809a13acf1b4edfd7d1abdc2207f12e434994", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/b6e809a13acf1b4edfd7d1abdc2207f12e434994", "message": "Updates to fix unit tests related to IAM functionality\n* Removed the `ShadowOSInAppMessageController.java`, this was duplicate logic not necessary to test in app messaging\n* Instead of Shadow for IAM controller, the `OneSignalPackagePrivateHelper.java` was given some helpers to access the current `OSInAppMessageController.java`\n* `messageDisplayQueue` can accumulate as many IAMs as it would like, but the `inAppMessagingEnabled` flag will control whether or not anything IAMs will show from the queue\n* `inAppMessageShowing` flag determines if an IAM is actually on the screen or not", "committedDate": "2020-01-31T00:32:56Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzI5MjE1MA==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/942#discussion_r373292150", "bodyText": "This isn't needed here.", "author": "jkasten2", "createdAt": "2020-01-31T02:33:39Z", "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java", "diffHunk": "@@ -378,11 +379,14 @@ public void displayMessage(@NonNull final OSInAppMessage message) {\n         OneSignalRestClient.getSync(htmlPath, new ResponseHandler() {\n             @Override\n             void onFailure(int statusCode, String response, Throwable throwable) {\n+                inAppMessageShowing = false;\n+                evaluateInAppMessages();\n                 printHttpErrorForInAppMessageRequest(\"html\", statusCode, response);\n             }\n \n             @Override\n             void onSuccess(String response) {\n+                inAppMessageShowing = true;", "originalCommit": "b6e809a13acf1b4edfd7d1abdc2207f12e434994", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzYyMjM5NA==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/942#discussion_r373622394", "bodyText": "Removing", "author": "mikechoch", "createdAt": "2020-01-31T18:32:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzI5MjE1MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzI5MjY2OQ==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/942#discussion_r373292669", "bodyText": "Need to check we don't add the same message more than once", "author": "jkasten2", "createdAt": "2020-01-31T02:36:04Z", "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java", "diffHunk": "@@ -303,63 +308,42 @@ void onFailure(int statusCode, String response, Throwable throwable) {\n         }\n     }\n \n-    private void messageCanBeDisplayed(@NonNull OSInAppMessage message) {\n-        if (!inAppMessagingEnabled)\n-            return;\n-\n-        if (triggeredMessages.contains(message.messageId) &&\n-            !message.isPreview) {\n-            OneSignal.Log(\n-               OneSignal.LOG_LEVEL.ERROR,\n-               \"In-App message with id '\" +\n-                  message.messageId +\n-                  \"' already displayed or is already preparing to be display!\");\n-            return;\n-        }\n-\n-        queueMessageForDisplay(message);\n-    }\n-\n     // Message has passed triggers and de-duplication logic.\n     // Display message now or add it to the queue to be displayed.\n     private void queueMessageForDisplay(@NonNull OSInAppMessage message) {\n         synchronized (messageDisplayQueue) {\n             messageDisplayQueue.add(message);", "originalCommit": "b6e809a13acf1b4edfd7d1abdc2207f12e434994", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzYyMjM0NA==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/942#discussion_r373622344", "bodyText": "Got it", "author": "mikechoch", "createdAt": "2020-01-31T18:32:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzI5MjY2OQ=="}], "type": "inlineReview"}, {"oid": "c159daae15b8a77287203f60f9ee7b817ce19816", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/c159daae15b8a77287203f60f9ee7b817ce19816", "message": "Updates from comments on last PR review\n* `messageDisplayQueue` never gets duplicates of the same IAM\n* Handle failure case for pulling down all of the HTML for an IAM messageId\n  * Decided to create a list (401 to 404, 410) in OSUtils and a helper to verify whether or not to reattempt a network request based on the status code in the response\n  * Added a constant to represent a max retry count, 3, for now until other cases arise\n* Make sure when removing, the messageDisplayQueue is not empty'\n* Dismiss preview IAMs with failed html request\n* Split logic for dismissing IAM by things we need for all IAMs and non-preview IAMs", "committedDate": "2020-01-31T20:19:19Z", "type": "commit"}, {"oid": "6e9490a031231a2cc6b9b63124bf05bb5aa7af57", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/6e9490a031231a2cc6b9b63124bf05bb5aa7af57", "message": "Broke a unit test for IAM removing `inAppMessageShowing = false;`\n* Called in 3 spots, did not account for the 3rd and it broke a unit test, now fixed by adding it back", "committedDate": "2020-01-31T20:45:22Z", "type": "commit"}]}