{"pr_number": 1042, "pr_title": "Refactor Outcome module to Kotlin", "pr_createdAt": "2020-06-02T19:57:07Z", "pr_url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1042", "timeline": [{"oid": "a95e27bb47d93f996fdd300cfb5989997bbb5497", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/a95e27bb47d93f996fdd300cfb5989997bbb5497", "message": "Refactor Outcome module to Kotlin\n\n   * Change outcome module classes from java to kotlin", "committedDate": "2020-06-02T20:29:07Z", "type": "forcePushed"}, {"oid": "5c923b8f665dc00b6d9a47ce2786bdf8f3aa5985", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/5c923b8f665dc00b6d9a47ce2786bdf8f3aa5985", "message": "Refactor Outcome module to Kotlin\n\n   * Change outcome module classes from java to kotlin", "committedDate": "2020-06-03T18:29:34Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTIyMTI1NA==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1042#discussion_r459221254", "bodyText": "Might be better to use just object so there isn't a companion object under the hood.\nhttps://stackoverflow.com/a/50520935\n@Jeasmine Thoughts on this?", "author": "jkasten2", "createdAt": "2020-07-23T05:27:36Z", "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/outcomes/OSOutcomeEventsV1Repository.kt", "diffHunk": "@@ -0,0 +1,69 @@\n+package com.onesignal.outcomes\n+\n+import com.onesignal.OSLogger\n+import com.onesignal.OneSignalApiResponseHandler\n+import com.onesignal.OutcomeEvent\n+import com.onesignal.influence.model.OSInfluenceType\n+import com.onesignal.outcomes.domain.OutcomeEventsService\n+import com.onesignal.outcomes.model.OSOutcomeEventParams\n+import org.json.JSONException\n+\n+internal class OSOutcomeEventsV1Repository(logger: OSLogger,\n+                                           outcomeEventsCache: OSOutcomeEventsCache,\n+                                           outcomeEventsService: OutcomeEventsService) : OSOutcomeEventsRepository(logger, outcomeEventsCache, outcomeEventsService) {\n+    override fun requestMeasureOutcomeEvent(appId: String, deviceType: Int, eventParams: OSOutcomeEventParams, responseHandler: OneSignalApiResponseHandler) {\n+        val event = OutcomeEvent.fromOutcomeEventParamsV2toOutcomeEventV1(eventParams)\n+        when (event.session) {\n+            OSInfluenceType.DIRECT -> requestMeasureDirectOutcomeEvent(appId, deviceType, event, responseHandler)\n+            OSInfluenceType.INDIRECT -> requestMeasureIndirectOutcomeEvent(appId, deviceType, event, responseHandler)\n+            OSInfluenceType.UNATTRIBUTED -> requestMeasureUnattributedOutcomeEvent(appId, deviceType, event, responseHandler)\n+            else -> {\n+            }\n+        }\n+    }\n+\n+    private fun requestMeasureDirectOutcomeEvent(appId: String, deviceType: Int, event: OutcomeEvent, responseHandler: OneSignalApiResponseHandler) {\n+        try {\n+            event.toJSONObjectForMeasure()\n+                    .put(APP_ID, appId)\n+                    .put(DEVICE_TYPE, deviceType)\n+                    .put(DIRECT, true)\n+                    .also { jsonObject ->\n+                        outcomeEventsService.sendOutcomeEvent(jsonObject, responseHandler)\n+                    }\n+        } catch (e: JSONException) {\n+            logger.error(\"Generating direct outcome:JSON Failed.\", e)\n+        }\n+    }\n+\n+    private fun requestMeasureIndirectOutcomeEvent(appId: String, deviceType: Int, event: OutcomeEvent, responseHandler: OneSignalApiResponseHandler) {\n+        try {\n+            event.toJSONObjectForMeasure()\n+                    .put(APP_ID, appId)\n+                    .put(DEVICE_TYPE, deviceType)\n+                    .put(DIRECT, false)\n+                    .also { jsonObject ->\n+                        outcomeEventsService.sendOutcomeEvent(jsonObject, responseHandler)\n+                    }\n+        } catch (e: JSONException) {\n+            logger.error(\"Generating indirect outcome:JSON Failed.\", e)\n+        }\n+    }\n+\n+    private fun requestMeasureUnattributedOutcomeEvent(appId: String, deviceType: Int, event: OutcomeEvent, responseHandler: OneSignalApiResponseHandler) {\n+        try {\n+            event.toJSONObjectForMeasure()\n+                    .put(APP_ID, appId)\n+                    .put(DEVICE_TYPE, deviceType)\n+                    .also { jsonObject ->\n+                        outcomeEventsService.sendOutcomeEvent(jsonObject, responseHandler)\n+                    }\n+        } catch (e: JSONException) {\n+            logger.error(\"Generating unattributed outcome:JSON Failed.\", e)\n+        }\n+    }\n+\n+    companion object {\n+        private const val DIRECT = \"direct\"", "originalCommit": "5c923b8f665dc00b6d9a47ce2786bdf8f3aa5985", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTE3NTc5OA==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1042#discussion_r461175798", "bodyText": "Agree, still need to fix the companion for DB, but I need to rebase first due to some changes on that classes, I need them in order to don't do too much re-work", "author": "Jeasmine", "createdAt": "2020-07-27T21:17:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTIyMTI1NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTM0NzEyNg==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1042#discussion_r465347126", "bodyText": "\ud83d\udc4d I see this is now cleaned up\nhttps://github.com/OneSignal/OneSignal-Android-SDK/pull/1042/files#diff-ebb1a5f7f3ff02ae231e90aa99ed7818R3", "author": "jkasten2", "createdAt": "2020-08-04T21:43:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTIyMTI1NA=="}], "type": "inlineReview"}, {"oid": "6a6962070f5b07f7bf324ba1ad78fa1f961683f4", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/6a6962070f5b07f7bf324ba1ad78fa1f961683f4", "message": "Refactor Outcome module to Kotlin\n\n   * Change outcome module classes from java to kotlin", "committedDate": "2020-07-27T21:16:03Z", "type": "forcePushed"}, {"oid": "ced5c337e2f5b6b5c946c652e4fb8ca43aba889a", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/ced5c337e2f5b6b5c946c652e4fb8ca43aba889a", "message": "Refactor Outcome module to Kotlin\n\n   * Change outcome module classes from java to kotlin", "committedDate": "2020-07-29T00:15:10Z", "type": "forcePushed"}, {"oid": "5793adb452c4be22a2625a8604ceabb6f853109b", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/5793adb452c4be22a2625a8604ceabb6f853109b", "message": "Refactor Outcome module to Kotlin\n\n   * Change outcome module classes from java to kotlin", "committedDate": "2020-07-29T00:27:41Z", "type": "forcePushed"}, {"oid": "fcac3551abc103dd77ae4d9fef572d50272df855", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/fcac3551abc103dd77ae4d9fef572d50272df855", "message": "Refactor Outcome module to Kotlin\n\n   * Change outcome module classes from java to kotlin", "committedDate": "2020-07-29T00:35:06Z", "type": "commit"}, {"oid": "fcac3551abc103dd77ae4d9fef572d50272df855", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/fcac3551abc103dd77ae4d9fef572d50272df855", "message": "Refactor Outcome module to Kotlin\n\n   * Change outcome module classes from java to kotlin", "committedDate": "2020-07-29T00:35:06Z", "type": "forcePushed"}]}