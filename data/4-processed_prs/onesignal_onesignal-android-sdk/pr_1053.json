{"pr_number": 1053, "pr_title": "Fix Outcomes tables DB migrations", "pr_createdAt": "2020-06-10T16:03:31Z", "pr_url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1053", "timeline": [{"oid": "f519c02fac286dcddc175b78ee3c7505f7cd7185", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/f519c02fac286dcddc175b78ee3c7505f7cd7185", "message": "Fix IAM tracking DB migration\n\n   * Fix migration from 4 to 5, keep old SQL query to continue with v8 migration correctly", "committedDate": "2020-06-10T16:04:49Z", "type": "forcePushed"}, {"oid": "d437ed2ccaab42b3ac240a54c4595dc8ccbed895", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/d437ed2ccaab42b3ac240a54c4595dc8ccbed895", "message": "Fix IAM tracking DB migration\n\n   * Fix migration from 4 to 5, keep old SQL query to continue with v8 migration correctly", "committedDate": "2020-06-10T17:36:57Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODI3MjExOA==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1053#discussion_r438272118", "bodyText": "Change // Old table name to OneSignal SDK version that used this so we know.\nex.\n// Table name VX.X.X\nThis should maybe be done for all cases of Old", "author": "mikechoch", "createdAt": "2020-06-10T16:54:28Z", "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/outcomes/OSOutcomesDbContract.java", "diffHunk": "@@ -17,11 +17,12 @@\n         static final String COLUMN_NAME_NAME = \"name\";\n         static final String COLUMN_NAME_WEIGHT = \"weight\";\n         static final String COLUMN_NAME_TIMESTAMP = \"timestamp\";\n+        static final String COLUMN_NAME_PARAMS = \"params\";\n     }\n \n     static class CachedUniqueOutcomeTable implements BaseColumns {\n-        static final String OLD_TABLE_NAME = \"cached_unique_outcome_notification\"; // Old table name\n-        static final String TABLE_NAME = \"cached_unique_outcome\";\n+        static final String TABLE_NAME_V1 = \"cached_unique_outcome_notification\"; // Old table name", "originalCommit": "f519c02fac286dcddc175b78ee3c7505f7cd7185", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODI3NDQ4Mg==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1053#discussion_r438274482", "bodyText": "OLD_TABLE_NAME should match version of table name\nTABLE_NAME_V1", "author": "mikechoch", "createdAt": "2020-06-10T16:58:17Z", "path": "OneSignalSDK/unittest/src/test/java/com/onesignal/outcomes/MockOSCachedUniqueOutcomeTable.java", "diffHunk": "@@ -2,8 +2,8 @@\n \n public class MockOSCachedUniqueOutcomeTable extends OSOutcomesDbContract.CachedUniqueOutcomeTable {\n \n-    public static final String OLD_TABLE_NAME = OSOutcomesDbContract.CachedUniqueOutcomeTable.OLD_TABLE_NAME;\n-    public static final String TABLE_NAME = OSOutcomesDbContract.CachedUniqueOutcomeTable.TABLE_NAME;\n+    public static final String OLD_TABLE_NAME = OSOutcomesDbContract.CachedUniqueOutcomeTable.TABLE_NAME_V1;", "originalCommit": "f519c02fac286dcddc175b78ee3c7505f7cd7185", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODI3NDU4Mw==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1053#discussion_r438274583", "bodyText": "TABLE_NAME should match version of table name\nTABLE_NAME_V2", "author": "mikechoch", "createdAt": "2020-06-10T16:58:27Z", "path": "OneSignalSDK/unittest/src/test/java/com/onesignal/outcomes/MockOSCachedUniqueOutcomeTable.java", "diffHunk": "@@ -2,8 +2,8 @@\n \n public class MockOSCachedUniqueOutcomeTable extends OSOutcomesDbContract.CachedUniqueOutcomeTable {\n \n-    public static final String OLD_TABLE_NAME = OSOutcomesDbContract.CachedUniqueOutcomeTable.OLD_TABLE_NAME;\n-    public static final String TABLE_NAME = OSOutcomesDbContract.CachedUniqueOutcomeTable.TABLE_NAME;\n+    public static final String OLD_TABLE_NAME = OSOutcomesDbContract.CachedUniqueOutcomeTable.TABLE_NAME_V1;\n+    public static final String TABLE_NAME = OSOutcomesDbContract.CachedUniqueOutcomeTable.TABLE_NAME_V2;", "originalCommit": "f519c02fac286dcddc175b78ee3c7505f7cd7185", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODI3NDk2NQ==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1053#discussion_r438274965", "bodyText": "Old should be replaced with SDK version that used it", "author": "mikechoch", "createdAt": "2020-06-10T16:59:07Z", "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/outcomes/OSOutcomesDbContract.java", "diffHunk": "@@ -17,11 +17,12 @@\n         static final String COLUMN_NAME_NAME = \"name\";\n         static final String COLUMN_NAME_WEIGHT = \"weight\";\n         static final String COLUMN_NAME_TIMESTAMP = \"timestamp\";\n+        static final String COLUMN_NAME_PARAMS = \"params\";\n     }\n \n     static class CachedUniqueOutcomeTable implements BaseColumns {\n-        static final String OLD_TABLE_NAME = \"cached_unique_outcome_notification\"; // Old table name\n-        static final String TABLE_NAME = \"cached_unique_outcome\";\n+        static final String TABLE_NAME_V1 = \"cached_unique_outcome_notification\"; // Old table name\n+        static final String TABLE_NAME_V2 = \"cached_unique_outcome\";\n         static final String COLUMN_NAME_NOTIFICATION_ID = \"notification_id\"; // Old column name", "originalCommit": "f519c02fac286dcddc175b78ee3c7505f7cd7185", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODI3OTM1OA==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1053#discussion_r438279358", "bodyText": "Maybe do the commonColumns same way you did in upgradeOutcomeTableRevision2To3 for consistency?\nNot a big deal just one way or the other so that they match.", "author": "mikechoch", "createdAt": "2020-06-10T17:06:30Z", "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/outcomes/OSOutcomeTableProvider.java", "diffHunk": "@@ -33,14 +55,50 @@\n                     OutcomeEventsTable.COLUMN_NAME_WEIGHT + FLOAT_TYPE + // New in v5, missing migration added in v6\n                     \");\";\n \n-    private static final String SQL_CREATE_UNIQUE_OUTCOME_ENTRIES =\n-            \"CREATE TABLE \" + CachedUniqueOutcomeTable.TABLE_NAME + \" (\" +\n+    private static final String SQL_CREATE_UNIQUE_OUTCOME_ENTRIES_V1 =\n+            \"CREATE TABLE \" + CachedUniqueOutcomeTable.TABLE_NAME_V1 + \" (\" +\n+                    CachedUniqueOutcomeTable._ID + INTEGER_PRIMARY_KEY_TYPE + \",\" +\n+                    CachedUniqueOutcomeTable.COLUMN_NAME_NOTIFICATION_ID + TEXT_TYPE + \",\" +\n+                    CachedUniqueOutcomeTable.COLUMN_NAME_NAME + TEXT_TYPE +\n+                    \");\";\n+\n+\n+    private static final String SQL_CREATE_UNIQUE_OUTCOME_ENTRIES_V2 =\n+            \"CREATE TABLE \" + CachedUniqueOutcomeTable.TABLE_NAME_V2 + \" (\" +\n                     CachedUniqueOutcomeTable._ID + INTEGER_PRIMARY_KEY_TYPE + \",\" +\n                     CachedUniqueOutcomeTable.COLUMN_CHANNEL_INFLUENCE_ID + TEXT_TYPE + \",\" +\n                     CachedUniqueOutcomeTable.COLUMN_CHANNEL_TYPE + TEXT_TYPE + \",\" +\n                     CachedUniqueOutcomeTable.COLUMN_NAME_NAME + TEXT_TYPE +\n                     \");\";\n \n+    /**\n+     * On the outcome table this adds the new weight column and drops params column.\n+     */\n+    public void upgradeOutcomeTableRevision1To2(SQLiteDatabase db) {\n+        String commonColumns = \"_id,session,notification_ids,name,timestamp\";", "originalCommit": "f519c02fac286dcddc175b78ee3c7505f7cd7185", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODI5NTU5MA==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1053#discussion_r438295590", "bodyText": "Added on to comment for clarity // 4. Opening the DB will auto trigger the update to DB version 8", "author": "mikechoch", "createdAt": "2020-06-10T17:33:54Z", "path": "OneSignalSDK/unittest/src/test/java/com/test/onesignal/DatabaseRunner.java", "diffHunk": "@@ -483,4 +466,199 @@ public void shouldUpgradeDbFromV7ToV8OutcomesTable() throws JSONException {\n         assertEquals(new JSONArray(), outcomeSaved.getIamIds());\n         assertEquals(OSInfluenceType.UNATTRIBUTED, outcomeSaved.getIamInfluenceType());\n     }\n+\n+    @Test\n+    public void shouldUpgradeDbFromV3ToV8UniqueOutcomeTable() {\n+        // 1. Init DB as version 3\n+        ShadowOneSignalDbHelper.DATABASE_VERSION = 3;\n+        SQLiteDatabase writableDatabase = dbHelper.getSQLiteDatabaseWithRetries();\n+\n+        Cursor cursor = writableDatabase.rawQuery(\"SELECT name FROM sqlite_master WHERE type ='table' AND name='\" + MockOSCachedUniqueOutcomeTable.TABLE_NAME + \"'\", null);\n+\n+        boolean exist = false;\n+        if (cursor != null) {\n+            exist = cursor.getCount() > 0;\n+            cursor.close();\n+        }\n+        // 2. Table must not exist\n+        assertFalse(exist);\n+        writableDatabase.setVersion(3);\n+        writableDatabase.close();\n+\n+        // 3. Clear the cache of the DB so it reloads the file.\n+        ShadowOneSignalDbHelper.restSetStaticFields();\n+\n+        outcomeTableProvider = new OSOutcomeTableProvider();\n+        dbHelper.setOutcomeTableProvider(outcomeTableProvider);\n+        // 4. Opening the DB will auto trigger the update.\n+        writableDatabase = dbHelper.getSQLiteDatabaseWithRetries();\n+\n+        OSCachedUniqueOutcomeName uniqueOutcomeName = new OSCachedUniqueOutcomeName(\"outcome\", \"notificationId\", OSInfluenceChannel.NOTIFICATION);\n+        ContentValues uniqueOutcomeValues = new ContentValues();\n+        uniqueOutcomeValues.put(MockOSCachedUniqueOutcomeTable.COLUMN_CHANNEL_INFLUENCE_ID, uniqueOutcomeName.getInfluenceId());\n+        uniqueOutcomeValues.put(MockOSCachedUniqueOutcomeTable.COLUMN_CHANNEL_TYPE, uniqueOutcomeName.getChannel().toString());\n+        uniqueOutcomeValues.put(MockOSCachedUniqueOutcomeTable.COLUMN_NAME_NAME, uniqueOutcomeName.getName());\n+\n+        writableDatabase.insert(MockOSCachedUniqueOutcomeTable.TABLE_NAME, null, uniqueOutcomeValues);\n+\n+        List<OSCachedUniqueOutcomeName> uniqueOutcomeNotifications = getAllUniqueOutcomeNotificationRecordsDB(dbHelper);\n+        assertEquals(1, uniqueOutcomeNotifications.size());\n+        assertEquals(uniqueOutcomeName.getInfluenceId(), uniqueOutcomeNotifications.get(0).getInfluenceId());\n+        assertEquals(uniqueOutcomeName.getChannel(), uniqueOutcomeNotifications.get(0).getChannel());\n+        assertEquals(uniqueOutcomeName.getName(), uniqueOutcomeNotifications.get(0).getName());\n+    }\n+\n+    @Test\n+    public void shouldUpgradeDbFromV3ToV8OutcomeTable() {\n+        // 1. Init DB as version 3\n+        ShadowOneSignalDbHelper.DATABASE_VERSION = 3;\n+        SQLiteDatabase writableDatabase = dbHelper.getSQLiteDatabaseWithRetries();\n+\n+        Cursor cursor = writableDatabase.rawQuery(\"SELECT name FROM sqlite_master WHERE type ='table' AND name='\" + MockOSOutcomeEventsTable.TABLE_NAME + \"'\", null);\n+\n+        boolean exist = false;\n+        if (cursor != null) {\n+            exist = cursor.getCount() > 0;\n+            cursor.close();\n+        }\n+        // 2. Table must not exist\n+        assertFalse(exist);\n+        writableDatabase.setVersion(3);\n+        writableDatabase.close();\n+\n+        // 3. Clear the cache of the DB so it reloads the file.\n+        ShadowOneSignalDbHelper.restSetStaticFields();\n+\n+        outcomeTableProvider = new OSOutcomeTableProvider();\n+        dbHelper.setOutcomeTableProvider(outcomeTableProvider);\n+        // 4. Opening the DB will auto trigger the update.\n+        writableDatabase = dbHelper.getSQLiteDatabaseWithRetries();", "originalCommit": "f519c02fac286dcddc175b78ee3c7505f7cd7185", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODI5NTc1NQ==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1053#discussion_r438295755", "bodyText": "Added on to comment for clarity // 4. Opening the DB will auto trigger the update to DB version 8", "author": "mikechoch", "createdAt": "2020-06-10T17:34:15Z", "path": "OneSignalSDK/unittest/src/test/java/com/test/onesignal/DatabaseRunner.java", "diffHunk": "@@ -483,4 +466,199 @@ public void shouldUpgradeDbFromV7ToV8OutcomesTable() throws JSONException {\n         assertEquals(new JSONArray(), outcomeSaved.getIamIds());\n         assertEquals(OSInfluenceType.UNATTRIBUTED, outcomeSaved.getIamInfluenceType());\n     }\n+\n+    @Test\n+    public void shouldUpgradeDbFromV3ToV8UniqueOutcomeTable() {\n+        // 1. Init DB as version 3\n+        ShadowOneSignalDbHelper.DATABASE_VERSION = 3;\n+        SQLiteDatabase writableDatabase = dbHelper.getSQLiteDatabaseWithRetries();\n+\n+        Cursor cursor = writableDatabase.rawQuery(\"SELECT name FROM sqlite_master WHERE type ='table' AND name='\" + MockOSCachedUniqueOutcomeTable.TABLE_NAME + \"'\", null);\n+\n+        boolean exist = false;\n+        if (cursor != null) {\n+            exist = cursor.getCount() > 0;\n+            cursor.close();\n+        }\n+        // 2. Table must not exist\n+        assertFalse(exist);\n+        writableDatabase.setVersion(3);\n+        writableDatabase.close();\n+\n+        // 3. Clear the cache of the DB so it reloads the file.\n+        ShadowOneSignalDbHelper.restSetStaticFields();\n+\n+        outcomeTableProvider = new OSOutcomeTableProvider();\n+        dbHelper.setOutcomeTableProvider(outcomeTableProvider);\n+        // 4. Opening the DB will auto trigger the update.", "originalCommit": "f519c02fac286dcddc175b78ee3c7505f7cd7185", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODI5NTk2NA==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1053#discussion_r438295964", "bodyText": "Added on to comment for clarity // 4. Opening the DB will auto trigger the update to DB version 8", "author": "mikechoch", "createdAt": "2020-06-10T17:34:37Z", "path": "OneSignalSDK/unittest/src/test/java/com/test/onesignal/DatabaseRunner.java", "diffHunk": "@@ -483,4 +466,199 @@ public void shouldUpgradeDbFromV7ToV8OutcomesTable() throws JSONException {\n         assertEquals(new JSONArray(), outcomeSaved.getIamIds());\n         assertEquals(OSInfluenceType.UNATTRIBUTED, outcomeSaved.getIamInfluenceType());\n     }\n+\n+    @Test\n+    public void shouldUpgradeDbFromV3ToV8UniqueOutcomeTable() {\n+        // 1. Init DB as version 3\n+        ShadowOneSignalDbHelper.DATABASE_VERSION = 3;\n+        SQLiteDatabase writableDatabase = dbHelper.getSQLiteDatabaseWithRetries();\n+\n+        Cursor cursor = writableDatabase.rawQuery(\"SELECT name FROM sqlite_master WHERE type ='table' AND name='\" + MockOSCachedUniqueOutcomeTable.TABLE_NAME + \"'\", null);\n+\n+        boolean exist = false;\n+        if (cursor != null) {\n+            exist = cursor.getCount() > 0;\n+            cursor.close();\n+        }\n+        // 2. Table must not exist\n+        assertFalse(exist);\n+        writableDatabase.setVersion(3);\n+        writableDatabase.close();\n+\n+        // 3. Clear the cache of the DB so it reloads the file.\n+        ShadowOneSignalDbHelper.restSetStaticFields();\n+\n+        outcomeTableProvider = new OSOutcomeTableProvider();\n+        dbHelper.setOutcomeTableProvider(outcomeTableProvider);\n+        // 4. Opening the DB will auto trigger the update.\n+        writableDatabase = dbHelper.getSQLiteDatabaseWithRetries();\n+\n+        OSCachedUniqueOutcomeName uniqueOutcomeName = new OSCachedUniqueOutcomeName(\"outcome\", \"notificationId\", OSInfluenceChannel.NOTIFICATION);\n+        ContentValues uniqueOutcomeValues = new ContentValues();\n+        uniqueOutcomeValues.put(MockOSCachedUniqueOutcomeTable.COLUMN_CHANNEL_INFLUENCE_ID, uniqueOutcomeName.getInfluenceId());\n+        uniqueOutcomeValues.put(MockOSCachedUniqueOutcomeTable.COLUMN_CHANNEL_TYPE, uniqueOutcomeName.getChannel().toString());\n+        uniqueOutcomeValues.put(MockOSCachedUniqueOutcomeTable.COLUMN_NAME_NAME, uniqueOutcomeName.getName());\n+\n+        writableDatabase.insert(MockOSCachedUniqueOutcomeTable.TABLE_NAME, null, uniqueOutcomeValues);\n+\n+        List<OSCachedUniqueOutcomeName> uniqueOutcomeNotifications = getAllUniqueOutcomeNotificationRecordsDB(dbHelper);\n+        assertEquals(1, uniqueOutcomeNotifications.size());\n+        assertEquals(uniqueOutcomeName.getInfluenceId(), uniqueOutcomeNotifications.get(0).getInfluenceId());\n+        assertEquals(uniqueOutcomeName.getChannel(), uniqueOutcomeNotifications.get(0).getChannel());\n+        assertEquals(uniqueOutcomeName.getName(), uniqueOutcomeNotifications.get(0).getName());\n+    }\n+\n+    @Test\n+    public void shouldUpgradeDbFromV3ToV8OutcomeTable() {\n+        // 1. Init DB as version 3\n+        ShadowOneSignalDbHelper.DATABASE_VERSION = 3;\n+        SQLiteDatabase writableDatabase = dbHelper.getSQLiteDatabaseWithRetries();\n+\n+        Cursor cursor = writableDatabase.rawQuery(\"SELECT name FROM sqlite_master WHERE type ='table' AND name='\" + MockOSOutcomeEventsTable.TABLE_NAME + \"'\", null);\n+\n+        boolean exist = false;\n+        if (cursor != null) {\n+            exist = cursor.getCount() > 0;\n+            cursor.close();\n+        }\n+        // 2. Table must not exist\n+        assertFalse(exist);\n+        writableDatabase.setVersion(3);\n+        writableDatabase.close();\n+\n+        // 3. Clear the cache of the DB so it reloads the file.\n+        ShadowOneSignalDbHelper.restSetStaticFields();\n+\n+        outcomeTableProvider = new OSOutcomeTableProvider();\n+        dbHelper.setOutcomeTableProvider(outcomeTableProvider);\n+        // 4. Opening the DB will auto trigger the update.\n+        writableDatabase = dbHelper.getSQLiteDatabaseWithRetries();\n+\n+        OSOutcomeEventDB outcomeEventDB = new OSOutcomeEventDB(OSInfluenceType.DIRECT, OSInfluenceType.INDIRECT,\n+                \"iam_id\", \"notificationId\", \"outcome_outcome\", 1234, (float) 1234);\n+\n+        ContentValues outcomeValues = new ContentValues();\n+        outcomeValues.put(MockOSOutcomeEventsTable.COLUMN_NAME_NOTIFICATION_IDS, outcomeEventDB.getNotificationIds().toString());\n+        outcomeValues.put(MockOSOutcomeEventsTable.COLUMN_NAME_IAM_IDS, outcomeEventDB.getIamIds().toString());\n+        outcomeValues.put(MockOSOutcomeEventsTable.COLUMN_NAME_NOTIFICATION_INFLUENCE_TYPE, outcomeEventDB.getNotificationInfluenceType().toString());\n+        outcomeValues.put(MockOSOutcomeEventsTable.COLUMN_NAME_IAM_INFLUENCE_TYPE, outcomeEventDB.getIamInfluenceType().toString());\n+        outcomeValues.put(MockOSOutcomeEventsTable.COLUMN_NAME_NAME, outcomeEventDB.getName());\n+        outcomeValues.put(MockOSOutcomeEventsTable.COLUMN_NAME_WEIGHT, outcomeEventDB.getWeight());\n+        outcomeValues.put(MockOSOutcomeEventsTable.COLUMN_NAME_TIMESTAMP, outcomeEventDB.getTimestamp());\n+\n+        writableDatabase.insert(MockOSOutcomeEventsTable.TABLE_NAME, null, outcomeValues);\n+\n+        List<OSOutcomeEventDB> outcomesSaved = getAllOutcomesRecords(dbHelper);\n+        assertEquals(1, outcomesSaved.size());\n+        OSOutcomeEventDB outcomeSaved = outcomesSaved.get(0);\n+\n+        assertEquals(outcomeEventDB.getName(), outcomeSaved.getName());\n+        assertEquals(outcomeEventDB.getWeight(), outcomeSaved.getWeight());\n+        assertEquals(outcomeEventDB.getTimestamp(), outcomeSaved.getTimestamp());\n+        assertEquals(outcomeEventDB.getNotificationIds(), outcomeSaved.getNotificationIds());\n+        assertEquals(outcomeEventDB.getNotificationInfluenceType(), outcomeSaved.getNotificationInfluenceType());\n+        assertEquals(outcomeEventDB.getIamIds(), outcomeSaved.getIamIds());\n+        assertEquals(outcomeEventDB.getIamInfluenceType(), outcomeSaved.getIamInfluenceType());\n+    }\n+\n+    @Test\n+    public void shouldUpgradeDbFromV4ToV8UniqueOutcomeTable() {\n+        // 1. Init DB as version 4\n+        ShadowOneSignalDbHelper.DATABASE_VERSION = 4;\n+        SQLiteDatabase writableDatabase = dbHelper.getSQLiteDatabaseWithRetries();\n+\n+        // Create table with the schema we had in DB v4\n+        writableDatabase.execSQL(SQL_CREATE_OUTCOME_REVISION2_ENTRIES);\n+\n+        Cursor cursor = writableDatabase.rawQuery(\"SELECT name FROM sqlite_master WHERE type ='table' AND name='\" + MockOSCachedUniqueOutcomeTable.TABLE_NAME + \"'\", null);\n+\n+        boolean exist = false;\n+        if (cursor != null) {\n+            exist = cursor.getCount() > 0;\n+            cursor.close();\n+        }\n+        // 2. Table must not exist\n+        assertFalse(exist);\n+        writableDatabase.setVersion(4);\n+        writableDatabase.close();\n+\n+        // 3. Clear the cache of the DB so it reloads the file.\n+        ShadowOneSignalDbHelper.restSetStaticFields();\n+\n+        outcomeTableProvider = new OSOutcomeTableProvider();\n+        dbHelper.setOutcomeTableProvider(outcomeTableProvider);\n+        // 4. Opening the DB will auto trigger the update.", "originalCommit": "f519c02fac286dcddc175b78ee3c7505f7cd7185", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODI5NjA2NA==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1053#discussion_r438296064", "bodyText": "Added on to comment for clarity // 4. Opening the DB will auto trigger the update to DB version 8", "author": "mikechoch", "createdAt": "2020-06-10T17:34:46Z", "path": "OneSignalSDK/unittest/src/test/java/com/test/onesignal/DatabaseRunner.java", "diffHunk": "@@ -483,4 +466,199 @@ public void shouldUpgradeDbFromV7ToV8OutcomesTable() throws JSONException {\n         assertEquals(new JSONArray(), outcomeSaved.getIamIds());\n         assertEquals(OSInfluenceType.UNATTRIBUTED, outcomeSaved.getIamInfluenceType());\n     }\n+\n+    @Test\n+    public void shouldUpgradeDbFromV3ToV8UniqueOutcomeTable() {\n+        // 1. Init DB as version 3\n+        ShadowOneSignalDbHelper.DATABASE_VERSION = 3;\n+        SQLiteDatabase writableDatabase = dbHelper.getSQLiteDatabaseWithRetries();\n+\n+        Cursor cursor = writableDatabase.rawQuery(\"SELECT name FROM sqlite_master WHERE type ='table' AND name='\" + MockOSCachedUniqueOutcomeTable.TABLE_NAME + \"'\", null);\n+\n+        boolean exist = false;\n+        if (cursor != null) {\n+            exist = cursor.getCount() > 0;\n+            cursor.close();\n+        }\n+        // 2. Table must not exist\n+        assertFalse(exist);\n+        writableDatabase.setVersion(3);\n+        writableDatabase.close();\n+\n+        // 3. Clear the cache of the DB so it reloads the file.\n+        ShadowOneSignalDbHelper.restSetStaticFields();\n+\n+        outcomeTableProvider = new OSOutcomeTableProvider();\n+        dbHelper.setOutcomeTableProvider(outcomeTableProvider);\n+        // 4. Opening the DB will auto trigger the update.\n+        writableDatabase = dbHelper.getSQLiteDatabaseWithRetries();\n+\n+        OSCachedUniqueOutcomeName uniqueOutcomeName = new OSCachedUniqueOutcomeName(\"outcome\", \"notificationId\", OSInfluenceChannel.NOTIFICATION);\n+        ContentValues uniqueOutcomeValues = new ContentValues();\n+        uniqueOutcomeValues.put(MockOSCachedUniqueOutcomeTable.COLUMN_CHANNEL_INFLUENCE_ID, uniqueOutcomeName.getInfluenceId());\n+        uniqueOutcomeValues.put(MockOSCachedUniqueOutcomeTable.COLUMN_CHANNEL_TYPE, uniqueOutcomeName.getChannel().toString());\n+        uniqueOutcomeValues.put(MockOSCachedUniqueOutcomeTable.COLUMN_NAME_NAME, uniqueOutcomeName.getName());\n+\n+        writableDatabase.insert(MockOSCachedUniqueOutcomeTable.TABLE_NAME, null, uniqueOutcomeValues);\n+\n+        List<OSCachedUniqueOutcomeName> uniqueOutcomeNotifications = getAllUniqueOutcomeNotificationRecordsDB(dbHelper);\n+        assertEquals(1, uniqueOutcomeNotifications.size());\n+        assertEquals(uniqueOutcomeName.getInfluenceId(), uniqueOutcomeNotifications.get(0).getInfluenceId());\n+        assertEquals(uniqueOutcomeName.getChannel(), uniqueOutcomeNotifications.get(0).getChannel());\n+        assertEquals(uniqueOutcomeName.getName(), uniqueOutcomeNotifications.get(0).getName());\n+    }\n+\n+    @Test\n+    public void shouldUpgradeDbFromV3ToV8OutcomeTable() {\n+        // 1. Init DB as version 3\n+        ShadowOneSignalDbHelper.DATABASE_VERSION = 3;\n+        SQLiteDatabase writableDatabase = dbHelper.getSQLiteDatabaseWithRetries();\n+\n+        Cursor cursor = writableDatabase.rawQuery(\"SELECT name FROM sqlite_master WHERE type ='table' AND name='\" + MockOSOutcomeEventsTable.TABLE_NAME + \"'\", null);\n+\n+        boolean exist = false;\n+        if (cursor != null) {\n+            exist = cursor.getCount() > 0;\n+            cursor.close();\n+        }\n+        // 2. Table must not exist\n+        assertFalse(exist);\n+        writableDatabase.setVersion(3);\n+        writableDatabase.close();\n+\n+        // 3. Clear the cache of the DB so it reloads the file.\n+        ShadowOneSignalDbHelper.restSetStaticFields();\n+\n+        outcomeTableProvider = new OSOutcomeTableProvider();\n+        dbHelper.setOutcomeTableProvider(outcomeTableProvider);\n+        // 4. Opening the DB will auto trigger the update.\n+        writableDatabase = dbHelper.getSQLiteDatabaseWithRetries();\n+\n+        OSOutcomeEventDB outcomeEventDB = new OSOutcomeEventDB(OSInfluenceType.DIRECT, OSInfluenceType.INDIRECT,\n+                \"iam_id\", \"notificationId\", \"outcome_outcome\", 1234, (float) 1234);\n+\n+        ContentValues outcomeValues = new ContentValues();\n+        outcomeValues.put(MockOSOutcomeEventsTable.COLUMN_NAME_NOTIFICATION_IDS, outcomeEventDB.getNotificationIds().toString());\n+        outcomeValues.put(MockOSOutcomeEventsTable.COLUMN_NAME_IAM_IDS, outcomeEventDB.getIamIds().toString());\n+        outcomeValues.put(MockOSOutcomeEventsTable.COLUMN_NAME_NOTIFICATION_INFLUENCE_TYPE, outcomeEventDB.getNotificationInfluenceType().toString());\n+        outcomeValues.put(MockOSOutcomeEventsTable.COLUMN_NAME_IAM_INFLUENCE_TYPE, outcomeEventDB.getIamInfluenceType().toString());\n+        outcomeValues.put(MockOSOutcomeEventsTable.COLUMN_NAME_NAME, outcomeEventDB.getName());\n+        outcomeValues.put(MockOSOutcomeEventsTable.COLUMN_NAME_WEIGHT, outcomeEventDB.getWeight());\n+        outcomeValues.put(MockOSOutcomeEventsTable.COLUMN_NAME_TIMESTAMP, outcomeEventDB.getTimestamp());\n+\n+        writableDatabase.insert(MockOSOutcomeEventsTable.TABLE_NAME, null, outcomeValues);\n+\n+        List<OSOutcomeEventDB> outcomesSaved = getAllOutcomesRecords(dbHelper);\n+        assertEquals(1, outcomesSaved.size());\n+        OSOutcomeEventDB outcomeSaved = outcomesSaved.get(0);\n+\n+        assertEquals(outcomeEventDB.getName(), outcomeSaved.getName());\n+        assertEquals(outcomeEventDB.getWeight(), outcomeSaved.getWeight());\n+        assertEquals(outcomeEventDB.getTimestamp(), outcomeSaved.getTimestamp());\n+        assertEquals(outcomeEventDB.getNotificationIds(), outcomeSaved.getNotificationIds());\n+        assertEquals(outcomeEventDB.getNotificationInfluenceType(), outcomeSaved.getNotificationInfluenceType());\n+        assertEquals(outcomeEventDB.getIamIds(), outcomeSaved.getIamIds());\n+        assertEquals(outcomeEventDB.getIamInfluenceType(), outcomeSaved.getIamInfluenceType());\n+    }\n+\n+    @Test\n+    public void shouldUpgradeDbFromV4ToV8UniqueOutcomeTable() {\n+        // 1. Init DB as version 4\n+        ShadowOneSignalDbHelper.DATABASE_VERSION = 4;\n+        SQLiteDatabase writableDatabase = dbHelper.getSQLiteDatabaseWithRetries();\n+\n+        // Create table with the schema we had in DB v4\n+        writableDatabase.execSQL(SQL_CREATE_OUTCOME_REVISION2_ENTRIES);\n+\n+        Cursor cursor = writableDatabase.rawQuery(\"SELECT name FROM sqlite_master WHERE type ='table' AND name='\" + MockOSCachedUniqueOutcomeTable.TABLE_NAME + \"'\", null);\n+\n+        boolean exist = false;\n+        if (cursor != null) {\n+            exist = cursor.getCount() > 0;\n+            cursor.close();\n+        }\n+        // 2. Table must not exist\n+        assertFalse(exist);\n+        writableDatabase.setVersion(4);\n+        writableDatabase.close();\n+\n+        // 3. Clear the cache of the DB so it reloads the file.\n+        ShadowOneSignalDbHelper.restSetStaticFields();\n+\n+        outcomeTableProvider = new OSOutcomeTableProvider();\n+        dbHelper.setOutcomeTableProvider(outcomeTableProvider);\n+        // 4. Opening the DB will auto trigger the update.\n+        writableDatabase = dbHelper.getSQLiteDatabaseWithRetries();\n+\n+        OSCachedUniqueOutcomeName uniqueOutcomeName = new OSCachedUniqueOutcomeName(\"outcome\", \"notificationId\", OSInfluenceChannel.NOTIFICATION);\n+        ContentValues uniqueOutcomeValues = new ContentValues();\n+        uniqueOutcomeValues.put(MockOSCachedUniqueOutcomeTable.COLUMN_CHANNEL_INFLUENCE_ID, uniqueOutcomeName.getInfluenceId());\n+        uniqueOutcomeValues.put(MockOSCachedUniqueOutcomeTable.COLUMN_CHANNEL_TYPE, uniqueOutcomeName.getChannel().toString());\n+        uniqueOutcomeValues.put(MockOSCachedUniqueOutcomeTable.COLUMN_NAME_NAME, uniqueOutcomeName.getName());\n+\n+        writableDatabase.insert(MockOSCachedUniqueOutcomeTable.TABLE_NAME, null, uniqueOutcomeValues);\n+\n+        List<OSCachedUniqueOutcomeName> uniqueOutcomeNotifications = getAllUniqueOutcomeNotificationRecordsDB(dbHelper);\n+        assertEquals(1, uniqueOutcomeNotifications.size());\n+        assertEquals(uniqueOutcomeName.getInfluenceId(), uniqueOutcomeNotifications.get(0).getInfluenceId());\n+        assertEquals(uniqueOutcomeName.getChannel(), uniqueOutcomeNotifications.get(0).getChannel());\n+        assertEquals(uniqueOutcomeName.getName(), uniqueOutcomeNotifications.get(0).getName());\n+    }\n+\n+    @Test\n+    public void shouldUpgradeDbFromV4ToV8OutcomeTable() {\n+        // 1. Init DB as version 4\n+        ShadowOneSignalDbHelper.DATABASE_VERSION = 4;\n+        SQLiteDatabase writableDatabase = dbHelper.getSQLiteDatabaseWithRetries();\n+\n+        // Create table with the schema we had in DB v4\n+        writableDatabase.execSQL(SQL_CREATE_OUTCOME_REVISION1_ENTRIES);\n+        Cursor cursor = writableDatabase.query(MockOSOutcomeEventsTable.TABLE_NAME, null, null, null, null, null, null);\n+\n+        boolean exist = false;\n+        if (cursor != null) {\n+            String[] columns = cursor.getColumnNames();\n+            exist = columns.length == 6;\n+            cursor.close();\n+        }\n+        // 2. Table must not exist\n+        assertTrue(exist);\n+        writableDatabase.setVersion(4);\n+        writableDatabase.close();\n+\n+        // 3. Clear the cache of the DB so it reloads the file.\n+        ShadowOneSignalDbHelper.restSetStaticFields();\n+\n+        outcomeTableProvider = new OSOutcomeTableProvider();\n+        dbHelper.setOutcomeTableProvider(outcomeTableProvider);\n+        // 4. Opening the DB will auto trigger the update.", "originalCommit": "f519c02fac286dcddc175b78ee3c7505f7cd7185", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODI5NjUwMA==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1053#discussion_r438296500", "bodyText": "Where does the V8 update happen?", "author": "mikechoch", "createdAt": "2020-06-10T17:35:24Z", "path": "OneSignalSDK/unittest/src/test/java/com/test/onesignal/DatabaseRunner.java", "diffHunk": "@@ -419,15 +406,11 @@ public void shouldUpgradeDbFromV7ToV8CacheUniqueOutcomeTable() throws JSONExcept\n     }\n \n     @Test\n-    public void shouldUpgradeDbFromV7ToV8OutcomesTable() throws JSONException {\n+    public void shouldUpgradeDbFromV7ToV8OutcomesTable() {", "originalCommit": "f519c02fac286dcddc175b78ee3c7505f7cd7185", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODI5NzM5MA==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1053#discussion_r438297390", "bodyText": "Just want to make sure its clear when the update occurs and this should probably be marked as a step for other UnitTests that it is not very clear.", "author": "mikechoch", "createdAt": "2020-06-10T17:36:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODI5NjUwMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODMwNzI3NA==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1053#discussion_r438307274", "bodyText": "do you mean the comment change?", "author": "Jeasmine", "createdAt": "2020-06-10T17:53:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODI5NjUwMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODM0OTQxMA==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1053#discussion_r438349410", "bodyText": "I see that V7 is set for the DB version, but when does it transition to the V8 DB version in this UnitTest?", "author": "mikechoch", "createdAt": "2020-06-10T19:10:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODI5NjUwMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODM3OTUxOA==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1053#discussion_r438379518", "bodyText": "Same, but I think restSetStaticFields will put it back to latest. Think it should be setting ShadowOneSignalDbHelper.DATABASE_VERSION = 8; instead", "author": "jkasten2", "createdAt": "2020-06-10T20:08:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODI5NjUwMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODQyNDY2MQ==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1053#discussion_r438424661", "bodyText": "yeah the restSetStaticFields will make the DB version to the original and when we call writeDatabase the update is being made", "author": "Jeasmine", "createdAt": "2020-06-10T21:42:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODI5NjUwMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODI5NjcwNw==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1053#discussion_r438296707", "bodyText": "Where does the V8 update happen?", "author": "mikechoch", "createdAt": "2020-06-10T17:35:44Z", "path": "OneSignalSDK/unittest/src/test/java/com/test/onesignal/DatabaseRunner.java", "diffHunk": "@@ -362,12 +353,8 @@ public void shouldUpgradeDbFromV6ToV7() throws JSONException {\n     public void shouldUpgradeDbFromV7ToV8CacheUniqueOutcomeTable() throws JSONException {", "originalCommit": "f519c02fac286dcddc175b78ee3c7505f7cd7185", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODMwNzA4NQ==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1053#discussion_r438307085", "bodyText": "not sure what do you mean", "author": "Jeasmine", "createdAt": "2020-06-10T17:53:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODI5NjcwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODM0OTY4Mw==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1053#discussion_r438349683", "bodyText": "I see that V7 is set for the DB version, but when does it transition to the V8 DB version in this UnitTest?", "author": "mikechoch", "createdAt": "2020-06-10T19:10:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODI5NjcwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODM3ODI1Mw==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1053#discussion_r438378253", "bodyText": "I think this part triggers the v8 upgrade.\nhttps://github.com/OneSignal/OneSignal-Android-SDK/pull/1053/files#diff-82b04d6862599af0e5c771f74cc112f2R395-R399", "author": "jkasten2", "createdAt": "2020-06-10T20:06:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODI5NjcwNw=="}], "type": "inlineReview"}, {"oid": "640114b1bbf1bfd93f8b9629a71c387d7d99707a", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/640114b1bbf1bfd93f8b9629a71c387d7d99707a", "message": "Fix IAM tracking DB migration\n\n   * Fix migration from 4 to 5, keep old SQL query to continue with v8 migration correctly", "committedDate": "2020-06-10T17:39:34Z", "type": "forcePushed"}, {"oid": "91ee414832a1e8eb851d3ca2d5483331fd44e674", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/91ee414832a1e8eb851d3ca2d5483331fd44e674", "message": "Fix IAM tracking DB migration\n\n   * Fix migration from 4 to 5, keep old SQL query to continue with v8 migration correctly", "committedDate": "2020-06-10T17:54:07Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODM0MjUxMQ==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1053#discussion_r438342511", "bodyText": "OutcomeEventsTable.COLUMN_NAME_SESSION+ needs a space\nOutcomeEventsTable.COLUMN_NAME_SESSION +", "author": "mikechoch", "createdAt": "2020-06-10T18:56:54Z", "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/outcomes/OSOutcomeTableProvider.java", "diffHunk": "@@ -33,14 +55,54 @@\n                     OutcomeEventsTable.COLUMN_NAME_WEIGHT + FLOAT_TYPE + // New in v5, missing migration added in v6\n                     \");\";\n \n-    private static final String SQL_CREATE_UNIQUE_OUTCOME_ENTRIES =\n-            \"CREATE TABLE \" + CachedUniqueOutcomeTable.TABLE_NAME + \" (\" +\n+    public static final String SQL_CREATE_UNIQUE_OUTCOME_ENTRIES_V1 =\n+            \"CREATE TABLE \" + CachedUniqueOutcomeTable.TABLE_NAME_V1 + \" (\" +\n+                    CachedUniqueOutcomeTable._ID + INTEGER_PRIMARY_KEY_TYPE + \",\" +\n+                    CachedUniqueOutcomeTable.COLUMN_NAME_NOTIFICATION_ID + TEXT_TYPE + \",\" +\n+                    CachedUniqueOutcomeTable.COLUMN_NAME_NAME + TEXT_TYPE +\n+                    \");\";\n+\n+\n+    public static final String SQL_CREATE_UNIQUE_OUTCOME_ENTRIES_V2 =\n+            \"CREATE TABLE \" + CachedUniqueOutcomeTable.TABLE_NAME_V2 + \" (\" +\n                     CachedUniqueOutcomeTable._ID + INTEGER_PRIMARY_KEY_TYPE + \",\" +\n                     CachedUniqueOutcomeTable.COLUMN_CHANNEL_INFLUENCE_ID + TEXT_TYPE + \",\" +\n                     CachedUniqueOutcomeTable.COLUMN_CHANNEL_TYPE + TEXT_TYPE + \",\" +\n                     CachedUniqueOutcomeTable.COLUMN_NAME_NAME + TEXT_TYPE +\n                     \");\";\n \n+    /**\n+     * On the outcome table this adds the new weight column and drops params column.\n+     */\n+    public void upgradeOutcomeTableRevision1To2(SQLiteDatabase db) {\n+        String commonColumns = OutcomeEventsTable._ID + \",\" +\n+                OutcomeEventsTable.COLUMN_NAME_SESSION+ \",\" +", "originalCommit": "91ee414832a1e8eb851d3ca2d5483331fd44e674", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODM1MjEwNg==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1053#discussion_r438352106", "bodyText": "You fixed this in #1055, no worries", "author": "mikechoch", "createdAt": "2020-06-10T19:15:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODM0MjUxMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODM3MDMwMg==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1053#discussion_r438370302", "bodyText": "Keep version 8 for this PR.", "author": "jkasten2", "createdAt": "2020-06-10T19:50:43Z", "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OneSignalDbHelper.java", "diffHunk": "@@ -43,8 +43,13 @@\n import java.util.ArrayList;\n import java.util.List;\n \n+import static com.onesignal.outcomes.OSOutcomeTableProvider.SQL_CREATE_OUTCOME_ENTRIES_V1;\n+import static com.onesignal.outcomes.OSOutcomeTableProvider.SQL_CREATE_OUTCOME_ENTRIES_V3;\n+import static com.onesignal.outcomes.OSOutcomeTableProvider.SQL_CREATE_UNIQUE_OUTCOME_ENTRIES_V1;\n+import static com.onesignal.outcomes.OSOutcomeTableProvider.SQL_CREATE_UNIQUE_OUTCOME_ENTRIES_V2;\n+\n class OneSignalDbHelper extends SQLiteOpenHelper implements OneSignalDb {\n-   static final int DATABASE_VERSION = 8;\n+   static final int DATABASE_VERSION = 9;", "originalCommit": "91ee414832a1e8eb851d3ca2d5483331fd44e674", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODM3MzI4Ng==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1053#discussion_r438373286", "bodyText": "Let's add a line after this one with:\nstatic final String TABLE_NAME  = TABLE_NAME_V2\nThis way any non-migration code can just refer to TABLE_NAME and don't have to think about V2 for coding read / writing to the table.", "author": "jkasten2", "createdAt": "2020-06-10T19:56:22Z", "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/outcomes/OSOutcomesDbContract.java", "diffHunk": "@@ -5,26 +5,27 @@\n class OSOutcomesDbContract {\n \n     public static class OutcomeEventsTable implements BaseColumns {\n-        static final String TABLE_NAME = \"outcome\";\n+        static final String TABLE_NAME = \"outcome\"; // Added on DB v4 SDK v3.12.0\n         // Influence ids\n-        static final String COLUMN_NAME_NOTIFICATION_IDS = \"notification_ids\"; // OneSignal Notification Ids\n-        static final String COLUMN_NAME_IAM_IDS = \"iam_ids\"; // OneSignal iam Ids\n+        static final String COLUMN_NAME_NOTIFICATION_IDS = \"notification_ids\"; // Added on DB v4 SDK v3.12.0\n+        static final String COLUMN_NAME_IAM_IDS = \"iam_ids\"; // Added on DB v8 SDK v3.14.0\n         // Influence type\n-        static final String COLUMN_NAME_SESSION = \"session\"; // Old column name\n-        static final String COLUMN_NAME_NOTIFICATION_INFLUENCE_TYPE = \"notification_influence_type\";\n-        static final String COLUMN_NAME_IAM_INFLUENCE_TYPE = \"iam_influence_type\";\n+        static final String COLUMN_NAME_SESSION = \"session\"; // Added on DB v4 SDK v3.12.0 replaced with notification_influence_type on DB v8 SDK v3.14.0\n+        static final String COLUMN_NAME_NOTIFICATION_INFLUENCE_TYPE = \"notification_influence_type\"; // Added on DB v8 SDK v3.14.0\n+        static final String COLUMN_NAME_IAM_INFLUENCE_TYPE = \"iam_influence_type\"; // Added on DB v8 SDK v3.14.0\n         // Outcome data\n-        static final String COLUMN_NAME_NAME = \"name\";\n-        static final String COLUMN_NAME_WEIGHT = \"weight\";\n-        static final String COLUMN_NAME_TIMESTAMP = \"timestamp\";\n+        static final String COLUMN_NAME_NAME = \"name\"; // Added on DB v4 SDK v3.12.0\n+        static final String COLUMN_NAME_WEIGHT = \"weight\"; // Added on DB v5 SDK v3.12.1, migration added on DB v6 SDK v3.12.2\n+        static final String COLUMN_NAME_TIMESTAMP = \"timestamp\"; // Added on DB v4 SDK v3.12.0\n+        static final String COLUMN_NAME_PARAMS = \"params\"; // Added on DB v4 SDK v3.12.0 replaced with weight on DB v5 SDK v3.12.1, migration added on DB v6 SDK v3.12.2\n     }\n \n     static class CachedUniqueOutcomeTable implements BaseColumns {\n-        static final String OLD_TABLE_NAME = \"cached_unique_outcome_notification\"; // Old table name\n-        static final String TABLE_NAME = \"cached_unique_outcome\";\n-        static final String COLUMN_NAME_NOTIFICATION_ID = \"notification_id\"; // Old column name\n-        static final String COLUMN_CHANNEL_INFLUENCE_ID = \"channel_influence_id\"; // OneSignal Channel influence Id\n-        static final String COLUMN_CHANNEL_TYPE = \"channel_type\"; // OneSignal Channel Type\n-        static final String COLUMN_NAME_NAME = \"name\";\n+        static final String TABLE_NAME_V1 = \"cached_unique_outcome_notification\"; // Added on DB v5 SDK v3.12.1 until DB v8 renamed with cached_unique_outcome SDK v3.14.0\n+        static final String TABLE_NAME_V2 = \"cached_unique_outcome\"; // Added on DB v8 SDK v3.14.0", "originalCommit": "91ee414832a1e8eb851d3ca2d5483331fd44e674", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODQxMTc1OA==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1053#discussion_r438411758", "bodyText": "good one!", "author": "Jeasmine", "createdAt": "2020-06-10T21:13:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODM3MzI4Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODM3NTExMA==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1053#discussion_r438375110", "bodyText": "\ud83d\udc4d This is way better than my original idea of using V3 here as using V1! As this means we won't have to put early returns in upgradeOutcomeTableRevision1To2 checking for state or specific oldVersion numbers.", "author": "jkasten2", "createdAt": "2020-06-10T19:59:49Z", "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OneSignalDbHelper.java", "diffHunk": "@@ -235,21 +240,21 @@ private static void upgradeToV3(SQLiteDatabase db) {\n    }\n \n    private static void upgradeToV4(SQLiteDatabase db) {\n-      safeExecSQL(db, outcomeTableProvider.getSqlCreateOutcomeEntries());\n+      safeExecSQL(db, SQL_CREATE_OUTCOME_ENTRIES_V1);", "originalCommit": "91ee414832a1e8eb851d3ca2d5483331fd44e674", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "82bb35362af25c19265a0a0a920404447700df9a", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/82bb35362af25c19265a0a0a920404447700df9a", "message": "Fix IAM tracking DB migration\n\n   * Fix migration from 4 to 5, keep old SQL query to continue with v8 migration correctly", "committedDate": "2020-06-10T21:51:08Z", "type": "forcePushed"}, {"oid": "19bf0a1d58de435be7f2eacf794a938eee37d67a", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/19bf0a1d58de435be7f2eacf794a938eee37d67a", "message": "Fix IAM tracking DB migration\n\n   * Fix migration from 4 to 5, keep old SQL query to continue with v8 migration correctly", "committedDate": "2020-06-10T23:21:37Z", "type": "commit"}, {"oid": "19bf0a1d58de435be7f2eacf794a938eee37d67a", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/19bf0a1d58de435be7f2eacf794a938eee37d67a", "message": "Fix IAM tracking DB migration\n\n   * Fix migration from 4 to 5, keep old SQL query to continue with v8 migration correctly", "committedDate": "2020-06-10T23:21:37Z", "type": "forcePushed"}]}