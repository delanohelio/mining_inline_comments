{"pr_number": 862, "pr_title": "RDM-7373 Lower severity of CaseValidationException", "pr_createdAt": "2020-03-25T09:39:04Z", "pr_url": "https://github.com/hmcts/ccd-data-store-api/pull/862", "timeline": [{"oid": "6aba7fbaa36e20f8f3e04641e83419916c0a482c", "url": "https://github.com/hmcts/ccd-data-store-api/commit/6aba7fbaa36e20f8f3e04641e83419916c0a482c", "message": "RDM-7373 Lower severity of CaseValidationException\n\n   [RDM-7373](https://tools.hmcts.net/jira/browse/RDM-7373)\n\n**Logger calls**\n* Merge validation results log entry with exception log entry.\n* Use the lower severity (`Warn`).\n* Log field names only to prevent user data being sent to logs.\n\n**Application Insights telemetry**\n* Add some validation result information to the exception telemetry.\n* Set a lower severity level on the exception (`Warning`).", "committedDate": "2020-03-25T09:34:54Z", "type": "commit"}, {"oid": "1e1d0fd1cebdf6811ea961cfab5c071c9fe587f8", "url": "https://github.com/hmcts/ccd-data-store-api/commit/1e1d0fd1cebdf6811ea961cfab5c071c9fe587f8", "message": "Merge remote-tracking branch 'origin/develop' into RDM-7373", "committedDate": "2020-03-25T15:32:57Z", "type": "commit"}, {"oid": "207c0413a0cf3c017952e83d492b540786411614", "url": "https://github.com/hmcts/ccd-data-store-api/commit/207c0413a0cf3c017952e83d492b540786411614", "message": "RDM-7373 Parse status code in RestExceptionHandler\n\n   [RDM-7373](https://tools.hmcts.net/jira/browse/RDM-7373)\n\nTry to avoid SonarQube 'javasecurity:S5131' when building ResponseEntity", "committedDate": "2020-03-25T16:05:10Z", "type": "commit"}, {"oid": "406ab8b68db4a20763441ece83290a13f6553f82", "url": "https://github.com/hmcts/ccd-data-store-api/commit/406ab8b68db4a20763441ece83290a13f6553f82", "message": "Revert \"RDM-7373 Parse status code in RestExceptionHandler\"\n\nThis reverts commit 207c0413a0cf3c017952e83d492b540786411614.", "committedDate": "2020-03-26T14:39:56Z", "type": "commit"}, {"oid": "3593ce7ccc8725fd65fcb6bee854a64f54ad3dd0", "url": "https://github.com/hmcts/ccd-data-store-api/commit/3593ce7ccc8725fd65fcb6bee854a64f54ad3dd0", "message": "Merge remote-tracking branch 'origin/develop' into RDM-7373", "committedDate": "2020-03-27T11:02:24Z", "type": "commit"}, {"oid": "102cc4431f81d03570b9a5f5e92a4709aa9d6916", "url": "https://github.com/hmcts/ccd-data-store-api/commit/102cc4431f81d03570b9a5f5e92a4709aa9d6916", "message": "RDM-7373 Encode requestURI when creating HttpError\n\n   [RDM-7373](https://tools.hmcts.net/jira/browse/RDM-7373)\n\nTry to avoid SonarQube 'javasecurity:S5131' when returning HttpError as\na ResponseEntity in the RestExceptionHandler.", "committedDate": "2020-03-27T17:51:32Z", "type": "commit"}, {"oid": "7ec3982a4fd5c729f7ccdf2b0c850a9a1f7203bc", "url": "https://github.com/hmcts/ccd-data-store-api/commit/7ec3982a4fd5c729f7ccdf2b0c850a9a1f7203bc", "message": "RDM-7373 Tests for RestExceptionHandler changes\n\n   [RDM-7373](https://tools.hmcts.net/jira/browse/RDM-7373)\n\nTests for:-\n* uk.gov.hmcts.ccd.AppInsights\n* uk.gov.hmcts.ccd.domain.model.common.HttpError (updated)\n* uk.gov.hmcts.ccd.endpoint.exceptionsRestExceptionHandler", "committedDate": "2020-03-31T15:42:02Z", "type": "commit"}, {"oid": "bde615334706819bf03f90f50e4d926f1ba0aeb6", "url": "https://github.com/hmcts/ccd-data-store-api/commit/bde615334706819bf03f90f50e4d926f1ba0aeb6", "message": "Merge remote-tracking branch 'origin/develop' into RDM-7373", "committedDate": "2020-03-31T15:44:28Z", "type": "commit"}, {"oid": "d06fed24b95c74d3f16be8be73221e7bcef69e7b", "url": "https://github.com/hmcts/ccd-data-store-api/commit/d06fed24b95c74d3f16be8be73221e7bcef69e7b", "message": "RDM-7373 Refactor RestExceptionHandler tests\n\n   [RDM-7373](https://tools.hmcts.net/jira/browse/RDM-7373)\n\nTests for:-\n* uk.gov.hmcts.ccd.endpoint.exceptions.RestExceptionHandler", "committedDate": "2020-04-01T08:50:12Z", "type": "commit"}, {"oid": "29da58d8958ff0fcc61af615e67e7d076a7a981c", "url": "https://github.com/hmcts/ccd-data-store-api/commit/29da58d8958ff0fcc61af615e67e7d076a7a981c", "message": "Merge remote-tracking branch 'origin/develop' into RDM-7373", "committedDate": "2020-04-01T11:53:53Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjI2MDQ3NQ==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/862#discussion_r402260475", "bodyText": "I was wondering whether it makes sense to not log the stacktrace for the the validation errors. What do you think @mattnayler?", "author": "mario-paniccia", "createdAt": "2020-04-02T12:05:08Z", "path": "src/main/java/uk/gov/hmcts/ccd/endpoint/exceptions/RestExceptionHandler.java", "diffHunk": "@@ -50,6 +60,29 @@ public RestExceptionHandler(AppInsights appInsights) {\n                 .body(error);\n     }\n \n+    @ExceptionHandler(CaseValidationException.class)\n+    @ResponseBody\n+    public ResponseEntity<HttpError> handleCaseValidationException(HttpServletRequest request, CaseValidationException exception) {\n+\n+        // read field IDs from CaseValidationException.details (i.e. avoid using full error details as this may contain user data)\n+        List<String> fieldIds = new ArrayList<>();\n+        if (exception.getDetails() != null) {\n+            String detailsJson = this.objectMapperService.convertObjectToString(exception.getDetails());\n+            fieldIds = JsonPath.read(detailsJson, \"$..field_errors[*].id\");\n+        }\n+\n+        Map<String, String> customProperties = new HashMap<>();\n+        customProperties.put(\"CaseValidationError field IDs\", Arrays.toString(fieldIds.toArray()));\n+\n+        LOG.warn(\"{}: The following list of fields are in an error state: {}\", exception.getMessage(), fieldIds, exception);", "originalCommit": "29da58d8958ff0fcc61af615e67e7d076a7a981c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjMwNjA3Mg==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/862#discussion_r402306072", "bodyText": "The same field level validation routines may be triggered in three separate places for a single UI call:\n\nInitial event data submission\nAfter callback has returned new data\nAfter data has been merged with existing unchanged case details (i.e. before case event is saved)\n\nSo whilst the data submitted to AppInsights will always contain the full stack details it may still be useful for a dev to see their stack trace is different to the one they are investigating (i.e. it was for me during RDM-7840).  So I am currently tempted to leave it but also happy to be overruled, @mario-paniccia?", "author": "mattnayler", "createdAt": "2020-04-02T13:20:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjI2MDQ3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjMxMTY1NQ==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/862#discussion_r402311655", "bodyText": "right, good point. Let's leave it then cheers", "author": "mario-paniccia", "createdAt": "2020-04-02T13:27:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjI2MDQ3NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjI2MDczNA==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/862#discussion_r402260734", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    LOG.warn(\"{}: The following list of fields are in an error state: {}\", exception.getMessage(), fieldIds, exception);\n          \n          \n            \n                    LOG.warn(\"{}: The following list of fields are in an invalid state: {}\", exception.getMessage(), fieldIds, exception);", "author": "mario-paniccia", "createdAt": "2020-04-02T12:05:39Z", "path": "src/main/java/uk/gov/hmcts/ccd/endpoint/exceptions/RestExceptionHandler.java", "diffHunk": "@@ -50,6 +60,29 @@ public RestExceptionHandler(AppInsights appInsights) {\n                 .body(error);\n     }\n \n+    @ExceptionHandler(CaseValidationException.class)\n+    @ResponseBody\n+    public ResponseEntity<HttpError> handleCaseValidationException(HttpServletRequest request, CaseValidationException exception) {\n+\n+        // read field IDs from CaseValidationException.details (i.e. avoid using full error details as this may contain user data)\n+        List<String> fieldIds = new ArrayList<>();\n+        if (exception.getDetails() != null) {\n+            String detailsJson = this.objectMapperService.convertObjectToString(exception.getDetails());\n+            fieldIds = JsonPath.read(detailsJson, \"$..field_errors[*].id\");\n+        }\n+\n+        Map<String, String> customProperties = new HashMap<>();\n+        customProperties.put(\"CaseValidationError field IDs\", Arrays.toString(fieldIds.toArray()));\n+\n+        LOG.warn(\"{}: The following list of fields are in an error state: {}\", exception.getMessage(), fieldIds, exception);", "originalCommit": "29da58d8958ff0fcc61af615e67e7d076a7a981c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjg0NzI2OQ==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/862#discussion_r402847269", "bodyText": "Thanks that sounds much cleaner. Updated in next push.", "author": "mattnayler", "createdAt": "2020-04-03T08:47:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjI2MDczNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjI2NDA4Ng==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/862#discussion_r402264086", "bodyText": "wonder whether we can enhance CaseValidationException with a property that stores fields with validation error so that here rather than manipulating JSON we could just call: exception.getFields() and we get back a list of field ids", "author": "mario-paniccia", "createdAt": "2020-04-02T12:11:48Z", "path": "src/main/java/uk/gov/hmcts/ccd/endpoint/exceptions/RestExceptionHandler.java", "diffHunk": "@@ -50,6 +60,29 @@ public RestExceptionHandler(AppInsights appInsights) {\n                 .body(error);\n     }\n \n+    @ExceptionHandler(CaseValidationException.class)\n+    @ResponseBody\n+    public ResponseEntity<HttpError> handleCaseValidationException(HttpServletRequest request, CaseValidationException exception) {\n+\n+        // read field IDs from CaseValidationException.details (i.e. avoid using full error details as this may contain user data)\n+        List<String> fieldIds = new ArrayList<>();\n+        if (exception.getDetails() != null) {\n+            String detailsJson = this.objectMapperService.convertObjectToString(exception.getDetails());\n+            fieldIds = JsonPath.read(detailsJson, \"$..field_errors[*].id\");\n+        }", "originalCommit": "29da58d8958ff0fcc61af615e67e7d076a7a981c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjg0ODU3NA==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/862#discussion_r402848574", "bodyText": "Thanks, I have now refactored CaseValidationException constructor to populate both the ApiException.details property and new CaseValidationException.fields property.", "author": "mattnayler", "createdAt": "2020-04-03T08:49:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjI2NDA4Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjI2NTAzMA==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/862#discussion_r402265030", "bodyText": "mind adding a javadoc explaining the usage of custom properties", "author": "mario-paniccia", "createdAt": "2020-04-02T12:13:33Z", "path": "src/main/java/uk/gov/hmcts/ccd/AppInsights.java", "diffHunk": "@@ -33,6 +37,20 @@ public void trackException(Exception e) {\n         telemetry.trackException(e);\n     }\n \n+    public void trackException(Exception e, Map<String, String> customProperties, SeverityLevel severityLevel) {", "originalCommit": "29da58d8958ff0fcc61af615e67e7d076a7a981c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjg0OTg2MA==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/862#discussion_r402849860", "bodyText": "Updated to mirror the javadoc comments used in the wrapped Microsoft components.", "author": "mattnayler", "createdAt": "2020-04-03T08:50:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjI2NTAzMA=="}], "type": "inlineReview"}, {"oid": "412e35bb69a2a25bda3730b593c53b5cf2efe5c5", "url": "https://github.com/hmcts/ccd-data-store-api/commit/412e35bb69a2a25bda3730b593c53b5cf2efe5c5", "message": "RDM-7373 Refactor CaseValidationException\n\n   [RDM-7373](https://tools.hmcts.net/jira/browse/RDM-7373)", "committedDate": "2020-04-03T08:31:58Z", "type": "commit"}, {"oid": "19a1705d3fb5570dde74bd38a2c0f916c61b6389", "url": "https://github.com/hmcts/ccd-data-store-api/commit/19a1705d3fb5570dde74bd38a2c0f916c61b6389", "message": "Merge remote-tracking branch 'origin/develop' into RDM-7373", "committedDate": "2020-04-03T08:33:24Z", "type": "commit"}, {"oid": "3a29b059c9351ed1cc01ce75a29f2c91833d79a5", "url": "https://github.com/hmcts/ccd-data-store-api/commit/3a29b059c9351ed1cc01ce75a29f2c91833d79a5", "message": "RDM-7373 CheckStyle update to CaseTypeService\n\n   [RDM-7373](https://tools.hmcts.net/jira/browse/RDM-7373)", "committedDate": "2020-04-03T09:54:15Z", "type": "commit"}, {"oid": "e8b24643a020dba5759e774ff791f333ab5bcd50", "url": "https://github.com/hmcts/ccd-data-store-api/commit/e8b24643a020dba5759e774ff791f333ab5bcd50", "message": "RDM-7373 Refactor CaseValidationException\n\n   [RDM-7373](https://tools.hmcts.net/jira/browse/RDM-7373)", "committedDate": "2020-04-03T11:13:10Z", "type": "commit"}, {"oid": "11b852c7e21af1364e2f0bb73efd18d92dd17f02", "url": "https://github.com/hmcts/ccd-data-store-api/commit/11b852c7e21af1364e2f0bb73efd18d92dd17f02", "message": "RDM-7373 Refactor CaseValidationException\n\n   [RDM-7373](https://tools.hmcts.net/jira/browse/RDM-7373)", "committedDate": "2020-04-03T11:16:46Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjk3ODczOQ==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/862#discussion_r402978739", "bodyText": "don't think this null check and empty check is really needed", "author": "mario-paniccia", "createdAt": "2020-04-03T12:45:27Z", "path": "src/main/java/uk/gov/hmcts/ccd/endpoint/exceptions/CaseValidationException.java", "diffHunk": "@@ -2,11 +2,36 @@\n \n import org.springframework.http.HttpStatus;\n import org.springframework.web.bind.annotation.ResponseStatus;\n+import uk.gov.hmcts.ccd.domain.model.std.CaseFieldValidationError;\n+import uk.gov.hmcts.ccd.domain.model.std.CaseValidationError;\n+\n+import java.util.List;\n \n @ResponseStatus(code = HttpStatus.UNPROCESSABLE_ENTITY)\n public class CaseValidationException extends ValidationException {\n \n-    public CaseValidationException() {\n+    private final String[] fields;\n+\n+    public CaseValidationException(List<CaseFieldValidationError> fieldErrors) {\n         super(\"Case data validation failed\");\n+\n+        String[] fieldIds = new String[0];\n+\n+        if (fieldErrors != null && !fieldErrors.isEmpty()) {", "originalCommit": "11b852c7e21af1364e2f0bb73efd18d92dd17f02", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjk3OTMxNw==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/862#discussion_r402979317", "bodyText": "I'd recommend to prefer List than Array in Java. The perf gain of using Array is almost 0 but the boilerplate in the code is much higher because working with arrays in Java is very cumbersome", "author": "mario-paniccia", "createdAt": "2020-04-03T12:46:26Z", "path": "src/main/java/uk/gov/hmcts/ccd/endpoint/exceptions/CaseValidationException.java", "diffHunk": "@@ -2,11 +2,36 @@\n \n import org.springframework.http.HttpStatus;\n import org.springframework.web.bind.annotation.ResponseStatus;\n+import uk.gov.hmcts.ccd.domain.model.std.CaseFieldValidationError;\n+import uk.gov.hmcts.ccd.domain.model.std.CaseValidationError;\n+\n+import java.util.List;\n \n @ResponseStatus(code = HttpStatus.UNPROCESSABLE_ENTITY)\n public class CaseValidationException extends ValidationException {\n \n-    public CaseValidationException() {\n+    private final String[] fields;\n+\n+    public CaseValidationException(List<CaseFieldValidationError> fieldErrors) {\n         super(\"Case data validation failed\");\n+\n+        String[] fieldIds = new String[0];", "originalCommit": "11b852c7e21af1364e2f0bb73efd18d92dd17f02", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "a92f16a513dfd504d5dfbaf9207fd5c431a4f3dc", "url": "https://github.com/hmcts/ccd-data-store-api/commit/a92f16a513dfd504d5dfbaf9207fd5c431a4f3dc", "message": "RDM-7373 Refactor CaseValidationException\n\n   [RDM-7373](https://tools.hmcts.net/jira/browse/RDM-7373)", "committedDate": "2020-04-03T14:06:27Z", "type": "commit"}, {"oid": "c1b45d5a8a3836517009640f8d99cf1565ed198f", "url": "https://github.com/hmcts/ccd-data-store-api/commit/c1b45d5a8a3836517009640f8d99cf1565ed198f", "message": "resolve confilcts on CaseTypeDefinitionServiceTest", "committedDate": "2020-07-16T13:18:37Z", "type": "commit"}, {"oid": "0e3271bda86b0d04cfa676332fd54da52348df24", "url": "https://github.com/hmcts/ccd-data-store-api/commit/0e3271bda86b0d04cfa676332fd54da52348df24", "message": "Merge branch 'develop' into RDM-7373", "committedDate": "2020-07-16T13:20:30Z", "type": "commit"}, {"oid": "0bc0c589161c5739f42bad6dcb079fefe137c162", "url": "https://github.com/hmcts/ccd-data-store-api/commit/0bc0c589161c5739f42bad6dcb079fefe137c162", "message": "RDM-7373 Resolve conflicts on CaseTypeServiceTest\n\n   [RDM-7373](https://tools.hmcts.net/jira/browse/RDM-7373)\n   [RDM-8217](https://tools.hmcts.net/jira/browse/RDM-8217)\n\nUpdated to reflect class renames in RDM-8217.\nRenamed test class to reflect test subject.", "committedDate": "2020-07-16T14:33:00Z", "type": "commit"}, {"oid": "a860fbbfc34e012b63aa66d8630ccd0b69bfeb1f", "url": "https://github.com/hmcts/ccd-data-store-api/commit/a860fbbfc34e012b63aa66d8630ccd0b69bfeb1f", "message": "Merge branch 'develop' into RDM-7373", "committedDate": "2020-07-20T10:26:52Z", "type": "commit"}, {"oid": "7f72bb305430f3f0e5c918cea2296588817de0ae", "url": "https://github.com/hmcts/ccd-data-store-api/commit/7f72bb305430f3f0e5c918cea2296588817de0ae", "message": "Empty commit to trigger build", "committedDate": "2020-09-02T08:26:56Z", "type": "commit"}]}