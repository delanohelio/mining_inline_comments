{"pr_number": 869, "pr_title": "RDM-6916 Create indexes for CaseEvent table", "pr_createdAt": "2020-03-26T14:22:36Z", "pr_url": "https://github.com/hmcts/ccd-data-store-api/pull/869", "timeline": [{"oid": "e6dc0fabc1ca291b848727bca7a4cf43032653cf", "url": "https://github.com/hmcts/ccd-data-store-api/commit/e6dc0fabc1ca291b848727bca7a4cf43032653cf", "message": "RDM-6916 Create indexes for CaseEvent table\n\n  [RDM-6916] (https://tools.hmcts.net/jira/browse/RDM-6916)\n\nCreate indexes for CaseEvent table to improve query performance:\n* Conditional DROP followed by CREATE of idx_case_event_created_date.\n* Creation new indexes for:\n  * case_type_id\n  * event_id, state_id", "committedDate": "2020-03-26T14:18:10Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODY4ODk4NA==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/869#discussion_r398688984", "bodyText": "Suggest you use Postgres' CONCURRENTLY modifier when creating these indexes; standard index creation will lock the case_event table for writes until the indexes are built, which could take time since it's a big table. You'd probably need to write a liquibase sql tag, don't think liquibase supports the concurrently flag. https://www.postgresql.org/docs/9.6/sql-createindex.html", "author": "banderous", "createdAt": "2020-03-26T15:59:22Z", "path": "src/main/resources/db/changelog/db.changelog-RDM-6916.xml", "diffHunk": "@@ -0,0 +1,43 @@\n+<databaseChangeLog xmlns=\"http://www.liquibase.org/xml/ns/dbchangelog\"\n+                   xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n+                   xsi:schemaLocation=\"http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd\">\n+\n+\n+    <!-- conditional drop to remove index manually created in some environments -->\n+    <changeSet id=\"rdm-6916-drop\" author=\"matt.nayler@hmcts.net\">\n+        <preConditions onFail=\"MARK_RAN\">\n+            <indexExists indexName=\"idx_case_event_created_date\"\n+                   schemaName=\"public\"\n+                   tableName=\"case_event\" />\n+        </preConditions>\n+        <dropIndex indexName=\"idx_case_event_created_date\"\n+                   schemaName=\"public\"\n+                   tableName=\"case_event\" />\n+    </changeSet>\n+\n+\n+    <changeSet id=\"rdm-6916\" author=\"matt.nayler@hmcts.net\">\n+\n+        <createIndex indexName=\"idx_case_event_created_date\"", "originalCommit": "e6dc0fabc1ca291b848727bca7a4cf43032653cf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTcyMzk1NQ==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/869#discussion_r401723955", "bodyText": "Many thanks for your comment.  Some timing details from a series of test runs have been added to the Jira ticket associated to this PR and will be used during the review and checkpoint process to decide the way forward.\nNB: A separate set of scripts implementing the CONCURRENTLY modifier as you have recommended have been prepared in advance if the change is required.", "author": "mattnayler", "createdAt": "2020-04-01T15:54:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODY4ODk4NA=="}], "type": "inlineReview"}, {"oid": "e8c3f420da5d4e99b105ef0a9a656806f13028d9", "url": "https://github.com/hmcts/ccd-data-store-api/commit/e8c3f420da5d4e99b105ef0a9a656806f13028d9", "message": "RDM-6916 Create indexes for CaseEvent table\n\n  [RDM-6916](https://tools.hmcts.net/jira/browse/RDM-6916)\n\nSwitch build script to use separate SQL statements using IF NOT EXISTS.\n\nCreates new indexes for:\n* created_date\n* case_type_id\n* event_id, state_id", "committedDate": "2020-04-09T13:30:17Z", "type": "commit"}, {"oid": "22c9154800c98c141c1ab5e851c194fdb73a4ec3", "url": "https://github.com/hmcts/ccd-data-store-api/commit/22c9154800c98c141c1ab5e851c194fdb73a4ec3", "message": "Merge remote-tracking branch 'origin/develop' into RDM-6916", "committedDate": "2020-04-09T13:37:56Z", "type": "commit"}, {"oid": "25a0f87ab9b6a58ba11afa4e91e05a3c58e5bb02", "url": "https://github.com/hmcts/ccd-data-store-api/commit/25a0f87ab9b6a58ba11afa4e91e05a3c58e5bb02", "message": "Merge branch 'develop' into RDM-6916", "committedDate": "2020-07-14T09:09:42Z", "type": "commit"}]}