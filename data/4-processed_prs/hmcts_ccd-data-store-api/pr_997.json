{"pr_number": 997, "pr_title": "RDM-8750: Introduce endpoint for updating case supplementary data", "pr_createdAt": "2020-06-29T22:48:33Z", "pr_url": "https://github.com/hmcts/ccd-data-store-api/pull/997", "timeline": [{"oid": "b399c60636be5c374c738b595a4de15612ef6eb5", "url": "https://github.com/hmcts/ccd-data-store-api/commit/b399c60636be5c374c738b595a4de15612ef6eb5", "message": "RDM-8750: Supplementary Data update changes", "committedDate": "2020-06-22T10:42:03Z", "type": "commit"}, {"oid": "169126842169012372ce3be6ed43e824d6f7c45c", "url": "https://github.com/hmcts/ccd-data-store-api/commit/169126842169012372ce3be6ed43e824d6f7c45c", "message": "RDM-8750: Supplementary Data update changes", "committedDate": "2020-06-22T12:21:39Z", "type": "commit"}, {"oid": "8f555d78945b3ae456a285694216bfc6bc7814ee", "url": "https://github.com/hmcts/ccd-data-store-api/commit/8f555d78945b3ae456a285694216bfc6bc7814ee", "message": "RDM-8750: Supplementary Data update changes new data mapper added", "committedDate": "2020-06-23T09:02:34Z", "type": "commit"}, {"oid": "d195feb7c63b68503b6844a68eb4ae6cbac2751c", "url": "https://github.com/hmcts/ccd-data-store-api/commit/d195feb7c63b68503b6844a68eb4ae6cbac2751c", "message": "Merge remote-tracking branch 'origin/RDM-8747' into RDM-8750", "committedDate": "2020-06-23T09:03:36Z", "type": "commit"}, {"oid": "c2d145b949c50b5434e66eb9de55c55efdef2b42", "url": "https://github.com/hmcts/ccd-data-store-api/commit/c2d145b949c50b5434e66eb9de55c55efdef2b42", "message": "RDM-8750: Supplementary Data update changes new data mapper added", "committedDate": "2020-06-25T12:21:39Z", "type": "commit"}, {"oid": "35a3d1184f4283bde1ab67922e4d601258f783a6", "url": "https://github.com/hmcts/ccd-data-store-api/commit/35a3d1184f4283bde1ab67922e4d601258f783a6", "message": "RDM-8750: Supplementary Data Query Builders added", "committedDate": "2020-06-29T22:41:09Z", "type": "commit"}, {"oid": "8fd13ed8a8f8073296dbbae11cee91ceb86fab1a", "url": "https://github.com/hmcts/ccd-data-store-api/commit/8fd13ed8a8f8073296dbbae11cee91ceb86fab1a", "message": "Merge branch 'develop' into RDM-8750", "committedDate": "2020-06-29T22:49:58Z", "type": "commit"}, {"oid": "4b1f491e76722711ddeb36e1ad0674b554d69d78", "url": "https://github.com/hmcts/ccd-data-store-api/commit/4b1f491e76722711ddeb36e1ad0674b554d69d78", "message": "RDM-8750: Fixed loading SupplementaryDataRepository", "committedDate": "2020-06-29T23:37:21Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzQ2OTI3Nw==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/997#discussion_r447469277", "bodyText": "There is a JacksonUtils which helps to reduce code duplication.", "author": "Thor-tech-of-metal", "createdAt": "2020-06-30T07:29:23Z", "path": "src/main/java/uk/gov/hmcts/ccd/config/JacksonUtils.java", "diffHunk": "@@ -42,4 +42,9 @@ public static JsonNode convertValueJsonNode(Object from) {\n         return new TypeReference<HashMap<String, JsonNode>>() {\n         };\n     }\n+\n+    public static HashMap<String, Object> convertJsonNode(Object from) {\n+        return MAPPER.convertValue(from, new TypeReference<HashMap<String, Object>>() {\n+        });\n+    }", "originalCommit": "4b1f491e76722711ddeb36e1ad0674b554d69d78", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzQ4NDgyMA==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/997#discussion_r447484820", "bodyText": "Can queryList.size be 0 ?", "author": "Thor-tech-of-metal", "createdAt": "2020-06-30T07:55:20Z", "path": "src/main/java/uk/gov/hmcts/ccd/data/casedetails/supplementarydata/DefaultSupplementaryDataRepository.java", "diffHunk": "@@ -0,0 +1,65 @@\n+package uk.gov.hmcts.ccd.data.casedetails.supplementarydata;\n+\n+import com.fasterxml.jackson.databind.JsonNode;\n+import java.util.List;\n+import java.util.Map;\n+import javax.inject.Singleton;\n+import javax.persistence.EntityManager;\n+import javax.persistence.PersistenceContext;\n+import javax.persistence.Query;\n+import javax.transaction.Transactional;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.beans.factory.annotation.Qualifier;\n+import org.springframework.stereotype.Service;\n+import uk.gov.hmcts.ccd.config.JacksonUtils;\n+import uk.gov.hmcts.ccd.domain.model.std.SupplementaryData;\n+\n+@Service\n+@Qualifier(\"default\")\n+@Singleton\n+@Transactional\n+public class DefaultSupplementaryDataRepository implements SupplementaryDataRepository {\n+\n+    private static final Logger LOG = LoggerFactory.getLogger(DefaultSupplementaryDataRepository.class);\n+\n+    @PersistenceContext\n+    private EntityManager em;\n+\n+    private List<SupplementaryDataQueryBuilder> queryBuilders;\n+\n+    @Autowired\n+    public DefaultSupplementaryDataRepository(final List<SupplementaryDataQueryBuilder> queryBuilders) {\n+        this.queryBuilders = queryBuilders;\n+    }\n+\n+    @Override\n+    public void setSupplementaryData(final String caseReference, final Map<String, Object> supplementaryData) {\n+        LOG.debug(\"Set supplementary data\");\n+        List<Query> queryList = getQueryBuilder(Operation.SET).buildQueries(em, caseReference, supplementaryData);\n+        queryList.stream().forEach(query -> query.executeUpdate());\n+    }\n+\n+    @Override\n+    public void incrementSupplementaryData(final String caseReference, final Map<String, Object> supplementaryData) {\n+        LOG.debug(\"Insert supplementary data\");\n+        List<Query> queryList = getQueryBuilder(Operation.INC).buildQueries(em, caseReference, supplementaryData);\n+        queryList.stream().forEach(query -> query.executeUpdate());\n+    }\n+\n+    @Override\n+    public SupplementaryData findSupplementaryData(final String caseReference) {\n+        LOG.debug(\"Find supplementary data\");\n+        List<Query> queryList = getQueryBuilder(Operation.FIND).buildQueries(em, caseReference, null);\n+        JsonNode result = (JsonNode) queryList.get(0).getSingleResult();", "originalCommit": "4b1f491e76722711ddeb36e1ad0674b554d69d78", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzUwMjUxOQ==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/997#discussion_r447502519", "bodyText": "No, It will return at least one query", "author": "kiran-yenigala-hmcts", "createdAt": "2020-06-30T08:23:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzQ4NDgyMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzQ4NjU2Nw==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/997#discussion_r447486567", "bodyText": "Can we LOG the error ? It will be easier for tracking.", "author": "Thor-tech-of-metal", "createdAt": "2020-06-30T07:58:12Z", "path": "src/main/java/uk/gov/hmcts/ccd/data/casedetails/supplementarydata/SupplementaryDataQueryBuilder.java", "diffHunk": "@@ -0,0 +1,45 @@\n+package uk.gov.hmcts.ccd.data.casedetails.supplementarydata;\n+\n+import com.fasterxml.jackson.core.JsonProcessingException;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.vladmihalcea.hibernate.type.json.JsonNodeBinaryType;\n+import java.time.LocalDateTime;\n+import java.time.ZoneOffset;\n+import java.util.List;\n+import java.util.Map;\n+import javax.persistence.EntityManager;\n+import javax.persistence.Query;\n+import org.hibernate.query.NativeQuery;\n+\n+public interface SupplementaryDataQueryBuilder {\n+\n+    ObjectMapper mapper = new ObjectMapper();\n+\n+    SupplementaryDataProcessor dataProcessor = new SupplementaryDataProcessor();\n+\n+    List<Query> buildQueries(EntityManager entityManager, String caseReference, Map<String, Object> requestData);\n+\n+    Operation operationType();\n+\n+    default String requestJson(Object supplementaryData) {\n+        try {\n+            return mapper.writeValueAsString(supplementaryData);\n+        } catch (JsonProcessingException e) {\n+            return \"\";", "originalCommit": "4b1f491e76722711ddeb36e1ad0674b554d69d78", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODI3OTY5NQ==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/997#discussion_r448279695", "bodyText": "or throw a RuntimeException. The request will fail later on anyway right? So better fail fast here with a nice descriptive error message. Or even better,\nfail even before at the level of the Controller, as soon as the request comes we verify is a valid JSON otherwise throw back a BadRequest exception", "author": "mario-paniccia", "createdAt": "2020-07-01T10:48:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzQ4NjU2Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY3NDg0OQ==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/997#discussion_r448674849", "bodyText": "Used DefaultObjectMapperService instead of toJson(..) method", "author": "kiran-yenigala-hmcts", "createdAt": "2020-07-01T23:55:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzQ4NjU2Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzQ4NzgzMQ==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/997#discussion_r447487831", "bodyText": "No required ., but may be we can use Optinal to be null safe .", "author": "Thor-tech-of-metal", "createdAt": "2020-06-30T08:00:04Z", "path": "src/main/java/uk/gov/hmcts/ccd/data/casedetails/supplementarydata/SupplementaryDataProcessor.java", "diffHunk": "@@ -0,0 +1,55 @@\n+package uk.gov.hmcts.ccd.data.casedetails.supplementarydata;\n+\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import java.util.HashMap;\n+import java.util.Iterator;\n+import java.util.Map;\n+import java.util.Map.Entry;\n+\n+public class SupplementaryDataProcessor {\n+\n+    private final ObjectMapper objectMapper = new ObjectMapper();\n+\n+    public Map<String, Object> accessLeafNodes(Map<String, Object> supplementaryData) {\n+        Map<String, Object> leafNodePathsAndValues = new HashMap<>();\n+        if (supplementaryData != null && supplementaryData.size() > 0) {\n+            JsonNode root = objectMapper.valueToTree(supplementaryData);\n+            processNode(root, new StringBuilder(\"\"), leafNodePathsAndValues);\n+        }\n+        return leafNodePathsAndValues;\n+    }\n+\n+    private Object getValue(JsonNode jsonNode) {\n+        if (jsonNode.isValueNode()) {\n+            if (jsonNode.isInt()) {\n+                return jsonNode.intValue();\n+            } else if (jsonNode.isBoolean()) {\n+                return jsonNode.booleanValue();\n+            } else {\n+                return jsonNode.textValue();\n+            }\n+        }\n+        return null;", "originalCommit": "4b1f491e76722711ddeb36e1ad0674b554d69d78", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "e6b024f1b1f1a12e0a0c92f0d4aeeb5506688855", "url": "https://github.com/hmcts/ccd-data-store-api/commit/e6b024f1b1f1a12e0a0c92f0d4aeeb5506688855", "message": "RDM-8750: Fixed smoke test failures", "committedDate": "2020-06-30T08:27:19Z", "type": "commit"}, {"oid": "bc08a7e8b49734e77159b53f6754da2ed87f907c", "url": "https://github.com/hmcts/ccd-data-store-api/commit/bc08a7e8b49734e77159b53f6754da2ed87f907c", "message": "Merge remote-tracking branch 'origin/RDM-8747' into RDM-8750", "committedDate": "2020-06-30T08:56:48Z", "type": "commit"}, {"oid": "4a0bb8806f8c7211a95686337db6844bb466fea0", "url": "https://github.com/hmcts/ccd-data-store-api/commit/4a0bb8806f8c7211a95686337db6844bb466fea0", "message": "RDM-8750: Revert changes after RDM-8474 is merged", "committedDate": "2020-06-30T08:58:55Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzcyNjEzOA==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/997#discussion_r447726138", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            public class SupplementaryDataRequest {\n          \n          \n            \n            public class SupplementaryDataUpdateRequest {", "author": "mario-paniccia", "createdAt": "2020-06-30T14:26:44Z", "path": "src/main/java/uk/gov/hmcts/ccd/domain/model/std/SupplementaryDataRequest.java", "diffHunk": "@@ -0,0 +1,16 @@\n+package uk.gov.hmcts.ccd.domain.model.std;\n+\n+import java.util.Map;\n+import lombok.AllArgsConstructor;\n+import lombok.Getter;\n+import lombok.NoArgsConstructor;\n+import lombok.ToString;\n+\n+@ToString\n+@AllArgsConstructor\n+@NoArgsConstructor\n+@Getter\n+public class SupplementaryDataRequest {", "originalCommit": "4a0bb8806f8c7211a95686337db6844bb466fea0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzc5NDg1Mg==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/997#discussion_r447794852", "bodyText": "Renamed", "author": "kiran-yenigala-hmcts", "createdAt": "2020-06-30T15:56:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzcyNjEzOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzcyNzQ4MQ==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/997#discussion_r447727481", "bodyText": "we no longer need to do HATEOAS so in theory we could remove this", "author": "mario-paniccia", "createdAt": "2020-06-30T14:28:30Z", "path": "src/main/java/uk/gov/hmcts/ccd/v2/external/resource/SupplementaryDataResource.java", "diffHunk": "@@ -0,0 +1,29 @@\n+package uk.gov.hmcts.ccd.v2.external.resource;\n+\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+import lombok.Data;\n+import lombok.EqualsAndHashCode;\n+import lombok.NoArgsConstructor;\n+import org.springframework.hateoas.RepresentationModel;\n+import uk.gov.hmcts.ccd.domain.model.std.SupplementaryData;\n+import uk.gov.hmcts.ccd.domain.model.std.SupplementaryDataRequest;\n+import uk.gov.hmcts.ccd.v2.external.controller.CaseController;\n+\n+import static org.springframework.hateoas.server.mvc.WebMvcLinkBuilder.linkTo;\n+import static org.springframework.hateoas.server.mvc.WebMvcLinkBuilder.methodOn;\n+\n+@Data\n+@EqualsAndHashCode(callSuper = true)\n+@NoArgsConstructor\n+public class SupplementaryDataResource extends RepresentationModel<RepresentationModel<?>> {", "originalCommit": "4a0bb8806f8c7211a95686337db6844bb466fea0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzc5NDc3Mg==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/997#discussion_r447794772", "bodyText": "Done", "author": "kiran-yenigala-hmcts", "createdAt": "2020-06-30T15:56:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzcyNzQ4MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzczMTEzOQ==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/997#discussion_r447731139", "bodyText": "for performance reasons it would be better to check first if user has explicit access, and only if yes retrieve the case", "author": "mario-paniccia", "createdAt": "2020-06-30T14:32:56Z", "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/supplementarydata/AuthorisedSupplementaryDataOperation.java", "diffHunk": "@@ -0,0 +1,47 @@\n+package uk.gov.hmcts.ccd.domain.service.supplementarydata;\n+\n+import java.util.Optional;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.beans.factory.annotation.Qualifier;\n+import org.springframework.stereotype.Service;\n+import uk.gov.hmcts.ccd.data.casedetails.CachedCaseDetailsRepository;\n+import uk.gov.hmcts.ccd.data.casedetails.CaseDetailsRepository;\n+import uk.gov.hmcts.ccd.domain.model.definition.CaseDetails;\n+import uk.gov.hmcts.ccd.domain.model.std.SupplementaryData;\n+import uk.gov.hmcts.ccd.domain.model.std.SupplementaryDataRequest;\n+import uk.gov.hmcts.ccd.domain.service.getcase.CaseNotFoundException;\n+import uk.gov.hmcts.ccd.domain.service.supplementarydata.rolevalidator.UserRoleValidator;\n+import uk.gov.hmcts.ccd.endpoint.exceptions.CaseRoleAccessException;\n+import uk.gov.hmcts.ccd.v2.V2;\n+\n+@Service\n+@Qualifier(\"authorised\")\n+public class AuthorisedSupplementaryDataOperation implements SupplementaryDataOperation {\n+\n+    private SupplementaryDataOperation supplementaryDataOperation;\n+\n+    private UserRoleValidator roleValidator;\n+\n+    private final CaseDetailsRepository caseDetailsRepository;\n+\n+    @Autowired\n+    public AuthorisedSupplementaryDataOperation(final @Qualifier(\"default\") SupplementaryDataOperation supplementaryDataOperation,\n+                                                final @Qualifier(CachedCaseDetailsRepository.QUALIFIER) CaseDetailsRepository caseDetailsRepository,\n+                                                final @Qualifier(\"default\") UserRoleValidator roleValidator) {\n+        this.supplementaryDataOperation = supplementaryDataOperation;\n+        this.roleValidator = roleValidator;\n+        this.caseDetailsRepository = caseDetailsRepository;\n+    }\n+\n+    @Override\n+    public SupplementaryData updateSupplementaryData(String caseReference, SupplementaryDataRequest supplementaryData) {\n+        Optional<CaseDetails> caseDetails = this.caseDetailsRepository.findByReference(caseReference);", "originalCommit": "4a0bb8806f8c7211a95686337db6844bb466fea0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzc0MTc5OA==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/997#discussion_r447741798", "bodyText": "for future reusability, I think it's better if we delegate this check to the CaseAccessService by introducing a dedicated method isJurisdictionAccessAllowed that can be reused by future endpoints with the same requirement. Therefore:\nreturn canAccess || this.caseAccessService.isJurisdictionAccessAllowed()", "author": "mario-paniccia", "createdAt": "2020-06-30T14:46:33Z", "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/supplementarydata/rolevalidator/DefaultUserRoleValidator.java", "diffHunk": "@@ -0,0 +1,43 @@\n+package uk.gov.hmcts.ccd.domain.service.supplementarydata.rolevalidator;\n+\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.beans.factory.annotation.Qualifier;\n+import org.springframework.stereotype.Service;\n+import uk.gov.hmcts.ccd.data.user.CachedUserRepository;\n+import uk.gov.hmcts.ccd.data.user.IdamJurisdictionsResolver;\n+import uk.gov.hmcts.ccd.data.user.JurisdictionsResolver;\n+import uk.gov.hmcts.ccd.data.user.UserRepository;\n+import uk.gov.hmcts.ccd.domain.model.definition.CaseDetails;\n+import uk.gov.hmcts.ccd.domain.service.common.CaseAccessService;\n+\n+@Service\n+@Qualifier(\"default\")\n+public class DefaultUserRoleValidator implements UserRoleValidator {\n+\n+    private static final String ROLE_CASE_WORKER_CAA = \"caseworker-caa\";\n+\n+    private final UserRepository userRepository;\n+    private final JurisdictionsResolver jurisdictionsResolver;\n+    private final CaseAccessService caseAccessService;\n+\n+    @Autowired\n+    public DefaultUserRoleValidator(final @Qualifier(CachedUserRepository.QUALIFIER) UserRepository userRepository,\n+                                    final @Qualifier(IdamJurisdictionsResolver.QUALIFIER) JurisdictionsResolver jurisdictionsResolver,\n+                                    final CaseAccessService caseAccessService) {\n+        this.userRepository = userRepository;\n+        this.jurisdictionsResolver = jurisdictionsResolver;\n+        this.caseAccessService = caseAccessService;\n+    }\n+\n+    @Override\n+    public boolean canUpdateSupplementaryData(CaseDetails caseDetails) {\n+        boolean canAccess = this.userRepository.getUserRoles().contains(ROLE_CASE_WORKER_CAA);\n+\n+        canAccess = canAccess || this.caseAccessService.canUserAccess(caseDetails);\n+\n+        return canAccess || this.jurisdictionsResolver\n+            .getJurisdictions()\n+            .stream()\n+            .anyMatch(caseDetails.getJurisdiction()::equalsIgnoreCase);", "originalCommit": "4a0bb8806f8c7211a95686337db6844bb466fea0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzgwMTU0Nw==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/997#discussion_r447801547", "bodyText": "moved to caseAccessService", "author": "kiran-yenigala-hmcts", "createdAt": "2020-06-30T16:06:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzc0MTc5OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzc0Mzg4NQ==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/997#discussion_r447743885", "bodyText": "minor: I'd suggest using a more standard if else if construct. A bit simpler to follow", "author": "mario-paniccia", "createdAt": "2020-06-30T14:49:18Z", "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/supplementarydata/rolevalidator/DefaultUserRoleValidator.java", "diffHunk": "@@ -0,0 +1,43 @@\n+package uk.gov.hmcts.ccd.domain.service.supplementarydata.rolevalidator;\n+\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.beans.factory.annotation.Qualifier;\n+import org.springframework.stereotype.Service;\n+import uk.gov.hmcts.ccd.data.user.CachedUserRepository;\n+import uk.gov.hmcts.ccd.data.user.IdamJurisdictionsResolver;\n+import uk.gov.hmcts.ccd.data.user.JurisdictionsResolver;\n+import uk.gov.hmcts.ccd.data.user.UserRepository;\n+import uk.gov.hmcts.ccd.domain.model.definition.CaseDetails;\n+import uk.gov.hmcts.ccd.domain.service.common.CaseAccessService;\n+\n+@Service\n+@Qualifier(\"default\")\n+public class DefaultUserRoleValidator implements UserRoleValidator {\n+\n+    private static final String ROLE_CASE_WORKER_CAA = \"caseworker-caa\";\n+\n+    private final UserRepository userRepository;\n+    private final JurisdictionsResolver jurisdictionsResolver;\n+    private final CaseAccessService caseAccessService;\n+\n+    @Autowired\n+    public DefaultUserRoleValidator(final @Qualifier(CachedUserRepository.QUALIFIER) UserRepository userRepository,\n+                                    final @Qualifier(IdamJurisdictionsResolver.QUALIFIER) JurisdictionsResolver jurisdictionsResolver,\n+                                    final CaseAccessService caseAccessService) {\n+        this.userRepository = userRepository;\n+        this.jurisdictionsResolver = jurisdictionsResolver;\n+        this.caseAccessService = caseAccessService;\n+    }\n+\n+    @Override\n+    public boolean canUpdateSupplementaryData(CaseDetails caseDetails) {\n+        boolean canAccess = this.userRepository.getUserRoles().contains(ROLE_CASE_WORKER_CAA);\n+\n+        canAccess = canAccess || this.caseAccessService.canUserAccess(caseDetails);", "originalCommit": "4a0bb8806f8c7211a95686337db6844bb466fea0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzk2NTk5Mw==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/997#discussion_r447965993", "bodyText": "Changed to if and else please check the logic again", "author": "kiran-yenigala-hmcts", "createdAt": "2020-06-30T20:41:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzc0Mzg4NQ=="}], "type": "inlineReview"}, {"oid": "22590b9d89b98f10f63f1662f913e125c61e19f4", "url": "https://github.com/hmcts/ccd-data-store-api/commit/22590b9d89b98f10f63f1662f913e125c61e19f4", "message": "RDM-8750: Code Review Comments addressed", "committedDate": "2020-06-30T20:44:05Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODE5ODM4MQ==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/997#discussion_r448198381", "bodyText": "this class could be renamed to be more generic so we can reuse it for other endpoints with similar access requirements. We could call it for example EndpointAuthorisationService with a method isAccessAllowed. Or something similar", "author": "mario-paniccia", "createdAt": "2020-07-01T08:21:24Z", "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/supplementarydata/rolevalidator/DefaultUserRoleValidator.java", "diffHunk": "@@ -0,0 +1,41 @@\n+package uk.gov.hmcts.ccd.domain.service.supplementarydata.rolevalidator;\n+\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.beans.factory.annotation.Qualifier;\n+import org.springframework.stereotype.Service;\n+import uk.gov.hmcts.ccd.data.user.CachedUserRepository;\n+import uk.gov.hmcts.ccd.data.user.UserRepository;\n+import uk.gov.hmcts.ccd.domain.model.definition.CaseDetails;\n+import uk.gov.hmcts.ccd.domain.service.common.CaseAccessService;\n+\n+@Service\n+@Qualifier(\"default\")\n+public class DefaultUserRoleValidator implements UserRoleValidator {", "originalCommit": "22590b9d89b98f10f63f1662f913e125c61e19f4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODIxNzY0OQ==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/997#discussion_r448217649", "bodyText": "Renamed", "author": "kiran-yenigala-hmcts", "createdAt": "2020-07-01T08:54:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODE5ODM4MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODE5ODkwNA==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/997#discussion_r448198904", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public boolean canUpdateSupplementaryData(CaseDetails caseDetails) {\n          \n          \n            \n                public boolean isAccessAllowed(CaseDetails caseDetails) {", "author": "mario-paniccia", "createdAt": "2020-07-01T08:22:17Z", "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/supplementarydata/rolevalidator/DefaultUserRoleValidator.java", "diffHunk": "@@ -0,0 +1,41 @@\n+package uk.gov.hmcts.ccd.domain.service.supplementarydata.rolevalidator;\n+\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.beans.factory.annotation.Qualifier;\n+import org.springframework.stereotype.Service;\n+import uk.gov.hmcts.ccd.data.user.CachedUserRepository;\n+import uk.gov.hmcts.ccd.data.user.UserRepository;\n+import uk.gov.hmcts.ccd.domain.model.definition.CaseDetails;\n+import uk.gov.hmcts.ccd.domain.service.common.CaseAccessService;\n+\n+@Service\n+@Qualifier(\"default\")\n+public class DefaultUserRoleValidator implements UserRoleValidator {\n+\n+    private static final String ROLE_CASE_WORKER_CAA = \"caseworker-caa\";\n+\n+    private final UserRepository userRepository;\n+    private final CaseAccessService caseAccessService;\n+\n+    @Autowired\n+    public DefaultUserRoleValidator(final @Qualifier(CachedUserRepository.QUALIFIER) UserRepository userRepository,\n+                                    final CaseAccessService caseAccessService) {\n+        this.userRepository = userRepository;\n+        this.caseAccessService = caseAccessService;\n+    }\n+\n+    @Override\n+    public boolean canUpdateSupplementaryData(CaseDetails caseDetails) {", "originalCommit": "22590b9d89b98f10f63f1662f913e125c61e19f4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODIxNzgyOA==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/997#discussion_r448217828", "bodyText": "Renamed", "author": "kiran-yenigala-hmcts", "createdAt": "2020-07-01T08:54:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODE5ODkwNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODIwMjE5MQ==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/997#discussion_r448202191", "bodyText": "we could make things a bit more flexible by having this class store a map of functions, with the map key being the operation identifier, e.g. $inc.\nWe could then loop through the supplementaryData keys and get and execute the corresponding function", "author": "mario-paniccia", "createdAt": "2020-07-01T08:27:29Z", "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/supplementarydata/DefaultSupplementaryDataOperation.java", "diffHunk": "@@ -0,0 +1,43 @@\n+package uk.gov.hmcts.ccd.domain.service.supplementarydata;\n+\n+import java.util.Map;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.beans.factory.annotation.Qualifier;\n+import org.springframework.stereotype.Service;\n+import uk.gov.hmcts.ccd.data.casedetails.supplementarydata.Operation;\n+import uk.gov.hmcts.ccd.data.casedetails.supplementarydata.SupplementaryDataRepository;\n+import uk.gov.hmcts.ccd.domain.model.std.SupplementaryData;\n+import uk.gov.hmcts.ccd.domain.model.std.SupplementaryDataUpdateRequest;\n+\n+@Service\n+@Qualifier(\"default\")\n+public class DefaultSupplementaryDataOperation implements SupplementaryDataOperation {\n+\n+    private final SupplementaryDataRepository supplementaryDataRepository;\n+\n+    @Autowired\n+    public DefaultSupplementaryDataOperation(final @Qualifier(\"default\") SupplementaryDataRepository supplementaryDataRepository) {\n+        this.supplementaryDataRepository = supplementaryDataRepository;\n+    }\n+\n+    @Override\n+    public SupplementaryData updateSupplementaryData(String caseReference, SupplementaryDataUpdateRequest supplementaryData) {\n+        incrementData(caseReference, supplementaryData);\n+        setData(caseReference, supplementaryData);", "originalCommit": "22590b9d89b98f10f63f1662f913e125c61e19f4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODMwMjcyOQ==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/997#discussion_r448302729", "bodyText": "created map with functions!!", "author": "kiran-yenigala-hmcts", "createdAt": "2020-07-01T11:36:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODIwMjE5MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODIwNjU5Ng==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/997#discussion_r448206596", "bodyText": "supplementaryData.getRequestData().get --> can we provide on supplementaryData itself a method like Optional<> getOperation(Operation.INC) and move this logic there? it would reduce duplication", "author": "mario-paniccia", "createdAt": "2020-07-01T08:34:47Z", "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/supplementarydata/DefaultSupplementaryDataOperation.java", "diffHunk": "@@ -0,0 +1,43 @@\n+package uk.gov.hmcts.ccd.domain.service.supplementarydata;\n+\n+import java.util.Map;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.beans.factory.annotation.Qualifier;\n+import org.springframework.stereotype.Service;\n+import uk.gov.hmcts.ccd.data.casedetails.supplementarydata.Operation;\n+import uk.gov.hmcts.ccd.data.casedetails.supplementarydata.SupplementaryDataRepository;\n+import uk.gov.hmcts.ccd.domain.model.std.SupplementaryData;\n+import uk.gov.hmcts.ccd.domain.model.std.SupplementaryDataUpdateRequest;\n+\n+@Service\n+@Qualifier(\"default\")\n+public class DefaultSupplementaryDataOperation implements SupplementaryDataOperation {\n+\n+    private final SupplementaryDataRepository supplementaryDataRepository;\n+\n+    @Autowired\n+    public DefaultSupplementaryDataOperation(final @Qualifier(\"default\") SupplementaryDataRepository supplementaryDataRepository) {\n+        this.supplementaryDataRepository = supplementaryDataRepository;\n+    }\n+\n+    @Override\n+    public SupplementaryData updateSupplementaryData(String caseReference, SupplementaryDataUpdateRequest supplementaryData) {\n+        incrementData(caseReference, supplementaryData);\n+        setData(caseReference, supplementaryData);\n+        return this.supplementaryDataRepository.findSupplementaryData(caseReference);\n+    }\n+\n+    private void incrementData(String caseReference, SupplementaryDataUpdateRequest supplementaryData) {\n+        Map<String, Object> incrementRequest = supplementaryData.getRequestData().get(Operation.INC.getOperationName());", "originalCommit": "22590b9d89b98f10f63f1662f913e125c61e19f4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODIyNzA5OQ==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/997#discussion_r448227099", "bodyText": "Moved to SupplementaryDataRequest", "author": "kiran-yenigala-hmcts", "createdAt": "2020-07-01T09:10:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODIwNjU5Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODIxMTk0Nw==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/997#discussion_r448211947", "bodyText": "are we returning the whole supplementary data here? we should return only the updated properties", "author": "mario-paniccia", "createdAt": "2020-07-01T08:44:27Z", "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/supplementarydata/DefaultSupplementaryDataOperation.java", "diffHunk": "@@ -0,0 +1,43 @@\n+package uk.gov.hmcts.ccd.domain.service.supplementarydata;\n+\n+import java.util.Map;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.beans.factory.annotation.Qualifier;\n+import org.springframework.stereotype.Service;\n+import uk.gov.hmcts.ccd.data.casedetails.supplementarydata.Operation;\n+import uk.gov.hmcts.ccd.data.casedetails.supplementarydata.SupplementaryDataRepository;\n+import uk.gov.hmcts.ccd.domain.model.std.SupplementaryData;\n+import uk.gov.hmcts.ccd.domain.model.std.SupplementaryDataUpdateRequest;\n+\n+@Service\n+@Qualifier(\"default\")\n+public class DefaultSupplementaryDataOperation implements SupplementaryDataOperation {\n+\n+    private final SupplementaryDataRepository supplementaryDataRepository;\n+\n+    @Autowired\n+    public DefaultSupplementaryDataOperation(final @Qualifier(\"default\") SupplementaryDataRepository supplementaryDataRepository) {\n+        this.supplementaryDataRepository = supplementaryDataRepository;\n+    }\n+\n+    @Override\n+    public SupplementaryData updateSupplementaryData(String caseReference, SupplementaryDataUpdateRequest supplementaryData) {\n+        incrementData(caseReference, supplementaryData);\n+        setData(caseReference, supplementaryData);\n+        return this.supplementaryDataRepository.findSupplementaryData(caseReference);", "originalCommit": "22590b9d89b98f10f63f1662f913e125c61e19f4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODMwMjU3Ng==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/997#discussion_r448302576", "bodyText": "Yes, we are returning whole supplementary data.. just had a chat with Dil on this.. he said whole supplementary data", "author": "kiran-yenigala-hmcts", "createdAt": "2020-07-01T11:36:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODIxMTk0Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODI0MDI3OQ==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/997#discussion_r448240279", "bodyText": "mmm we use a query builder in setSupplementaryData and incrementSupplementaryData. Are increment and set operations a query? strictly speaking they are updates so I find it slightly confusing. I would leave the query builder only for the find operations.", "author": "mario-paniccia", "createdAt": "2020-07-01T09:34:04Z", "path": "src/main/java/uk/gov/hmcts/ccd/data/casedetails/supplementarydata/DefaultSupplementaryDataRepository.java", "diffHunk": "@@ -0,0 +1,65 @@\n+package uk.gov.hmcts.ccd.data.casedetails.supplementarydata;\n+\n+import com.fasterxml.jackson.databind.JsonNode;\n+import java.util.List;\n+import java.util.Map;\n+import javax.inject.Singleton;\n+import javax.persistence.EntityManager;\n+import javax.persistence.PersistenceContext;\n+import javax.persistence.Query;\n+import javax.transaction.Transactional;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.beans.factory.annotation.Qualifier;\n+import org.springframework.stereotype.Service;\n+import uk.gov.hmcts.ccd.config.JacksonUtils;\n+import uk.gov.hmcts.ccd.domain.model.std.SupplementaryData;\n+\n+@Service\n+@Qualifier(\"default\")\n+@Singleton\n+@Transactional\n+public class DefaultSupplementaryDataRepository implements SupplementaryDataRepository {\n+\n+    private static final Logger LOG = LoggerFactory.getLogger(DefaultSupplementaryDataRepository.class);\n+\n+    @PersistenceContext\n+    private EntityManager em;\n+\n+    private List<SupplementaryDataQueryBuilder> queryBuilders;\n+\n+    @Autowired\n+    public DefaultSupplementaryDataRepository(final List<SupplementaryDataQueryBuilder> queryBuilders) {\n+        this.queryBuilders = queryBuilders;\n+    }\n+\n+    @Override\n+    public void setSupplementaryData(final String caseReference, final Map<String, Object> supplementaryData) {\n+        LOG.debug(\"Set supplementary data\");\n+        List<Query> queryList = getQueryBuilder(Operation.SET).buildQueries(em, caseReference, supplementaryData);\n+        queryList.stream().forEach(query -> query.executeUpdate());\n+    }\n+\n+    @Override\n+    public void incrementSupplementaryData(final String caseReference, final Map<String, Object> supplementaryData) {\n+        LOG.debug(\"Insert supplementary data\");\n+        List<Query> queryList = getQueryBuilder(Operation.INC).buildQueries(em, caseReference, supplementaryData);", "originalCommit": "22590b9d89b98f10f63f1662f913e125c61e19f4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODI2ODMxOQ==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/997#discussion_r448268319", "bodyText": "what if we moved this method inside the SupplementaryDataRequest itself? the idea being the SupplementaryDataRequest encapsulates the requested data, and provides utility methods to access it. For example to retrieve the leaf node and much more. And we pass the request down rather than a simple Map", "author": "mario-paniccia", "createdAt": "2020-07-01T10:25:40Z", "path": "src/main/java/uk/gov/hmcts/ccd/data/casedetails/supplementarydata/IncrementSupplementaryDataQueryBuilder.java", "diffHunk": "@@ -0,0 +1,45 @@\n+package uk.gov.hmcts.ccd.data.casedetails.supplementarydata;\n+\n+import java.util.Arrays;\n+import java.util.LinkedList;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.stream.Collectors;\n+import javax.persistence.EntityManager;\n+import javax.persistence.Query;\n+import org.springframework.beans.factory.annotation.Qualifier;\n+import org.springframework.stereotype.Component;\n+\n+@Component\n+@Qualifier(\"increment\")\n+public class IncrementSupplementaryDataQueryBuilder implements SupplementaryDataQueryBuilder {\n+\n+    private static final String INC_UPDATE_QUERY = \"UPDATE case_data SET \"\n+        + \"supplementary_data= (CASE\"\n+        + \"        WHEN COALESCE(supplementary_data, '{}') = '{}' \"\n+        + \"        THEN COALESCE(supplementary_data, '{}') || :json_value\\\\:\\\\:jsonb\"\n+        + \"        WHEN jsonb_extract_path_text(COALESCE(supplementary_data, '{}'), :node_path) IS NULL \"\n+        + \"        THEN jsonb_set(COALESCE(supplementary_data, '{}'), :leaf_node_key, :value\\\\:\\\\:TEXT\\\\:\\\\:jsonb)\"\n+        + \"        WHEN jsonb_extract_path_text(COALESCE(supplementary_data, '{}'), :node_path) IS NOT NULL\"\n+        + \"        THEN jsonb_set(COALESCE(supplementary_data, '{}'), :leaf_node_key,\"\n+        + \"             GREATEST((jsonb_extract_path_text(supplementary_data, :node_path)\\\\:\\\\:INT + :value), 0) \\\\:\\\\:TEXT\\\\:\\\\:jsonb, false)\"\n+        + \"    END), \"\n+        + \"supplementary_data_last_modified = :current_time \"\n+        + \"WHERE reference = :reference\";\n+\n+    @Override\n+    public List<Query> buildQueries(EntityManager entityManager, String caseReference, Map<String, Object> requestData) {\n+        Map<String, Object> leafNodes = dataProcessor.accessLeafNodes(requestData);", "originalCommit": "22590b9d89b98f10f63f1662f913e125c61e19f4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODI3NjU4OQ==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/997#discussion_r448276589", "bodyText": "we could add a constructor in SupplementaryData that gets a JsonNode and does the conversion", "author": "mario-paniccia", "createdAt": "2020-07-01T10:42:38Z", "path": "src/main/java/uk/gov/hmcts/ccd/data/casedetails/supplementarydata/DefaultSupplementaryDataRepository.java", "diffHunk": "@@ -0,0 +1,65 @@\n+package uk.gov.hmcts.ccd.data.casedetails.supplementarydata;\n+\n+import com.fasterxml.jackson.databind.JsonNode;\n+import java.util.List;\n+import java.util.Map;\n+import javax.inject.Singleton;\n+import javax.persistence.EntityManager;\n+import javax.persistence.PersistenceContext;\n+import javax.persistence.Query;\n+import javax.transaction.Transactional;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.beans.factory.annotation.Qualifier;\n+import org.springframework.stereotype.Service;\n+import uk.gov.hmcts.ccd.config.JacksonUtils;\n+import uk.gov.hmcts.ccd.domain.model.std.SupplementaryData;\n+\n+@Service\n+@Qualifier(\"default\")\n+@Singleton\n+@Transactional\n+public class DefaultSupplementaryDataRepository implements SupplementaryDataRepository {\n+\n+    private static final Logger LOG = LoggerFactory.getLogger(DefaultSupplementaryDataRepository.class);\n+\n+    @PersistenceContext\n+    private EntityManager em;\n+\n+    private List<SupplementaryDataQueryBuilder> queryBuilders;\n+\n+    @Autowired\n+    public DefaultSupplementaryDataRepository(final List<SupplementaryDataQueryBuilder> queryBuilders) {\n+        this.queryBuilders = queryBuilders;\n+    }\n+\n+    @Override\n+    public void setSupplementaryData(final String caseReference, final Map<String, Object> supplementaryData) {\n+        LOG.debug(\"Set supplementary data\");\n+        List<Query> queryList = getQueryBuilder(Operation.SET).buildQueries(em, caseReference, supplementaryData);\n+        queryList.stream().forEach(query -> query.executeUpdate());\n+    }\n+\n+    @Override\n+    public void incrementSupplementaryData(final String caseReference, final Map<String, Object> supplementaryData) {\n+        LOG.debug(\"Insert supplementary data\");\n+        List<Query> queryList = getQueryBuilder(Operation.INC).buildQueries(em, caseReference, supplementaryData);\n+        queryList.stream().forEach(query -> query.executeUpdate());\n+    }\n+\n+    @Override\n+    public SupplementaryData findSupplementaryData(final String caseReference) {\n+        LOG.debug(\"Find supplementary data\");\n+        List<Query> queryList = getQueryBuilder(Operation.FIND).buildQueries(em, caseReference, null);\n+        JsonNode result = (JsonNode) queryList.get(0).getSingleResult();\n+        return new SupplementaryData(JacksonUtils.convertJsonNode(result));", "originalCommit": "22590b9d89b98f10f63f1662f913e125c61e19f4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODMwNjY1Mg==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/997#discussion_r448306652", "bodyText": "Done", "author": "kiran-yenigala-hmcts", "createdAt": "2020-07-01T11:44:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODI3NjU4OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODI3NzMyOQ==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/997#discussion_r448277329", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    List<Query> queryList = getQueryBuilder(Operation.SET).buildQueries(em, caseReference, supplementaryData);\n          \n          \n            \n                    List<Query> queryList = getQueryBuilder(Operation.SET).buildQueryForEachSupplementaryDataProperty(em, caseReference, supplementaryData);", "author": "mario-paniccia", "createdAt": "2020-07-01T10:44:03Z", "path": "src/main/java/uk/gov/hmcts/ccd/data/casedetails/supplementarydata/DefaultSupplementaryDataRepository.java", "diffHunk": "@@ -0,0 +1,65 @@\n+package uk.gov.hmcts.ccd.data.casedetails.supplementarydata;\n+\n+import com.fasterxml.jackson.databind.JsonNode;\n+import java.util.List;\n+import java.util.Map;\n+import javax.inject.Singleton;\n+import javax.persistence.EntityManager;\n+import javax.persistence.PersistenceContext;\n+import javax.persistence.Query;\n+import javax.transaction.Transactional;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.beans.factory.annotation.Qualifier;\n+import org.springframework.stereotype.Service;\n+import uk.gov.hmcts.ccd.config.JacksonUtils;\n+import uk.gov.hmcts.ccd.domain.model.std.SupplementaryData;\n+\n+@Service\n+@Qualifier(\"default\")\n+@Singleton\n+@Transactional\n+public class DefaultSupplementaryDataRepository implements SupplementaryDataRepository {\n+\n+    private static final Logger LOG = LoggerFactory.getLogger(DefaultSupplementaryDataRepository.class);\n+\n+    @PersistenceContext\n+    private EntityManager em;\n+\n+    private List<SupplementaryDataQueryBuilder> queryBuilders;\n+\n+    @Autowired\n+    public DefaultSupplementaryDataRepository(final List<SupplementaryDataQueryBuilder> queryBuilders) {\n+        this.queryBuilders = queryBuilders;\n+    }\n+\n+    @Override\n+    public void setSupplementaryData(final String caseReference, final Map<String, Object> supplementaryData) {\n+        LOG.debug(\"Set supplementary data\");\n+        List<Query> queryList = getQueryBuilder(Operation.SET).buildQueries(em, caseReference, supplementaryData);", "originalCommit": "22590b9d89b98f10f63f1662f913e125c61e19f4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODMwNTAwNw==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/997#discussion_r448305007", "bodyText": "renamed", "author": "kiran-yenigala-hmcts", "createdAt": "2020-07-01T11:41:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODI3NzMyOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODI3ODczNg==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/997#discussion_r448278736", "bodyText": "I think this could be a .toJson() method on the SupplementaryDataRequest", "author": "mario-paniccia", "createdAt": "2020-07-01T10:46:57Z", "path": "src/main/java/uk/gov/hmcts/ccd/data/casedetails/supplementarydata/SupplementaryDataQueryBuilder.java", "diffHunk": "@@ -0,0 +1,45 @@\n+package uk.gov.hmcts.ccd.data.casedetails.supplementarydata;\n+\n+import com.fasterxml.jackson.core.JsonProcessingException;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.vladmihalcea.hibernate.type.json.JsonNodeBinaryType;\n+import java.time.LocalDateTime;\n+import java.time.ZoneOffset;\n+import java.util.List;\n+import java.util.Map;\n+import javax.persistence.EntityManager;\n+import javax.persistence.Query;\n+import org.hibernate.query.NativeQuery;\n+\n+public interface SupplementaryDataQueryBuilder {\n+\n+    ObjectMapper mapper = new ObjectMapper();\n+\n+    SupplementaryDataProcessor dataProcessor = new SupplementaryDataProcessor();\n+\n+    List<Query> buildQueries(EntityManager entityManager, String caseReference, Map<String, Object> requestData);\n+\n+    Operation operationType();\n+\n+    default String requestJson(Object supplementaryData) {", "originalCommit": "22590b9d89b98f10f63f1662f913e125c61e19f4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODMwNjQ4MA==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/997#discussion_r448306480", "bodyText": "renamed", "author": "kiran-yenigala-hmcts", "createdAt": "2020-07-01T11:44:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODI3ODczNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODI4MjU5NQ==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/997#discussion_r448282595", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            public enum Operation {\n          \n          \n            \n            public enum SupplementaryDataOperation {", "author": "mario-paniccia", "createdAt": "2020-07-01T10:54:50Z", "path": "src/main/java/uk/gov/hmcts/ccd/data/casedetails/supplementarydata/Operation.java", "diffHunk": "@@ -0,0 +1,17 @@\n+package uk.gov.hmcts.ccd.data.casedetails.supplementarydata;\n+\n+public enum Operation {", "originalCommit": "22590b9d89b98f10f63f1662f913e125c61e19f4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODMwNjUzNw==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/997#discussion_r448306537", "bodyText": "renamed", "author": "kiran-yenigala-hmcts", "createdAt": "2020-07-01T11:44:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODI4MjU5NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODMwNzc4OQ==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/997#discussion_r448307789", "bodyText": "suggestion: can we use a less generic name? like getProperties or sim?", "author": "mario-paniccia", "createdAt": "2020-07-01T11:47:11Z", "path": "src/main/java/uk/gov/hmcts/ccd/data/casedetails/supplementarydata/SupplementaryDataProcessor.java", "diffHunk": "@@ -0,0 +1,55 @@\n+package uk.gov.hmcts.ccd.data.casedetails.supplementarydata;\n+\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import java.util.HashMap;\n+import java.util.Iterator;\n+import java.util.Map;\n+import java.util.Map.Entry;\n+\n+public class SupplementaryDataProcessor {\n+\n+    private final ObjectMapper objectMapper = new ObjectMapper();\n+\n+    public Map<String, Object> accessLeafNodes(Map<String, Object> supplementaryData) {", "originalCommit": "22590b9d89b98f10f63f1662f913e125c61e19f4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "0214b70bc0be93ba7447f3a952aa6b3c03d04698", "url": "https://github.com/hmcts/ccd-data-store-api/commit/0214b70bc0be93ba7447f3a952aa6b3c03d04698", "message": "RDM-8750: Code Review Comments addressed", "committedDate": "2020-07-01T23:58:00Z", "type": "commit"}, {"oid": "3babc91ce8da0849f3346653646e457adff5e4e9", "url": "https://github.com/hmcts/ccd-data-store-api/commit/3babc91ce8da0849f3346653646e457adff5e4e9", "message": "RDM-8750: Test coverage", "committedDate": "2020-07-02T00:27:16Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODkxMjcxOA==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/997#discussion_r448912718", "bodyText": "is it possible to provide an example of the request in Swagger?", "author": "mario-paniccia", "createdAt": "2020-07-02T10:43:06Z", "path": "src/main/java/uk/gov/hmcts/ccd/v2/external/controller/CaseController.java", "diffHunk": "@@ -267,4 +281,54 @@ public CaseController(\n \n         return ResponseEntity.ok(new CaseEventsResource(caseId, auditEvents));\n     }\n+\n+\n+    @Transactional\n+    @PostMapping(\n+        path = \"/cases/{caseId}/supplementary-data\"\n+    )\n+    @ApiOperation(\n+        value = \"Update Case Supplementary Data\"\n+    )\n+    @ApiResponses({\n+        @ApiResponse(\n+            code = 200,\n+            message = \"Updated\",\n+            response = SupplementaryDataResource.class\n+        ),\n+        @ApiResponse(\n+            code = 400,\n+            message = V2.Error.CASE_ID_INVALID\n+        ),\n+        @ApiResponse(\n+            code = 400,\n+            message = V2.Error.SUPPLEMENTARY_DATA_INVALID\n+        ),\n+        @ApiResponse(\n+            code = 404,\n+            message = V2.Error.CASE_NOT_FOUND\n+        ),\n+        @ApiResponse(\n+            code = 403,\n+            message = V2.Error.NOT_AUTHORISED_UPDATE_SUPPLEMENTARY_DATA\n+        )\n+    })\n+    public ResponseEntity<SupplementaryDataResource> updateCaseSupplementaryData(@PathVariable(\"caseId\") String caseId,\n+                                                                                 @RequestBody final SupplementaryDataUpdateRequest supplementaryData) {", "originalCommit": "3babc91ce8da0849f3346653646e457adff5e4e9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "9107a6e893b91269d33f4d1d56ac82b497930496", "url": "https://github.com/hmcts/ccd-data-store-api/commit/9107a6e893b91269d33f4d1d56ac82b497930496", "message": "RDM-8750: Code Review Comments Addressed", "committedDate": "2020-07-02T22:11:19Z", "type": "commit"}, {"oid": "313c8f038470695d1d77f64563de3c5227a4c75c", "url": "https://github.com/hmcts/ccd-data-store-api/commit/313c8f038470695d1d77f64563de3c5227a4c75c", "message": "RDM-8750: Code Review Comments Addressed", "committedDate": "2020-07-03T00:45:43Z", "type": "commit"}, {"oid": "b8b7b89762b543a4bd5a58681963fecbe6a713d2", "url": "https://github.com/hmcts/ccd-data-store-api/commit/b8b7b89762b543a4bd5a58681963fecbe6a713d2", "message": "refactor 'canUserAccess' method to improve code readability", "committedDate": "2020-07-03T09:45:21Z", "type": "commit"}, {"oid": "fa739adae283b8265c3a27b3ee6c3278629bd377", "url": "https://github.com/hmcts/ccd-data-store-api/commit/fa739adae283b8265c3a27b3ee6c3278629bd377", "message": "updated access control rules for the EndpointAuthorisationService", "committedDate": "2020-07-03T11:05:24Z", "type": "commit"}, {"oid": "c793bf76f6c46aa605c860d21c9add09ef027f21", "url": "https://github.com/hmcts/ccd-data-store-api/commit/c793bf76f6c46aa605c860d21c9add09ef027f21", "message": "updated access control rules for the EndpointAuthorisationService", "committedDate": "2020-07-03T11:10:44Z", "type": "commit"}, {"oid": "f69551f5a2f833764f05e603a91671bb7049a9a5", "url": "https://github.com/hmcts/ccd-data-store-api/commit/f69551f5a2f833764f05e603a91671bb7049a9a5", "message": "RDM-8750: Fixed Failure test cases", "committedDate": "2020-07-03T11:44:34Z", "type": "commit"}, {"oid": "b2a208e797108ccc923b43f731c2d862ddaeb79e", "url": "https://github.com/hmcts/ccd-data-store-api/commit/b2a208e797108ccc923b43f731c2d862ddaeb79e", "message": "Merge remote-tracking branch 'origin/RDM-8750' into RDM-8750", "committedDate": "2020-07-03T11:44:45Z", "type": "commit"}, {"oid": "d8e0361d78e36bfa05a7c206d5d24c24ed2b4de9", "url": "https://github.com/hmcts/ccd-data-store-api/commit/d8e0361d78e36bfa05a7c206d5d24c24ed2b4de9", "message": "RDM-8750: Addressed code review comments", "committedDate": "2020-07-04T22:05:28Z", "type": "commit"}, {"oid": "6fe5d363ae587b40bd5ce76b612e1a4a9d2fa3b9", "url": "https://github.com/hmcts/ccd-data-store-api/commit/6fe5d363ae587b40bd5ce76b612e1a4a9d2fa3b9", "message": "RDM-8750: CVE-2020-11996 issue, tomcat version upgraded", "committedDate": "2020-07-06T00:55:36Z", "type": "commit"}, {"oid": "342f1d30039a1e8676a7e96edca5707135484226", "url": "https://github.com/hmcts/ccd-data-store-api/commit/342f1d30039a1e8676a7e96edca5707135484226", "message": "RDM-8750: SupplementaryDataUpdateRequestValidator introduced", "committedDate": "2020-07-06T09:48:04Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDEyNDEwOA==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/997#discussion_r450124108", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    Query query = queryBuilder(SupplementaryDataOperation.SET).buildQueryForEachSupplementaryDataProperty(em,\n          \n          \n            \n                    Query query = queryBuilder(SupplementaryDataOperation.SET).build(em,", "author": "mario-paniccia", "createdAt": "2020-07-06T10:15:48Z", "path": "src/main/java/uk/gov/hmcts/ccd/data/casedetails/supplementarydata/DefaultSupplementaryDataRepository.java", "diffHunk": "@@ -0,0 +1,78 @@\n+package uk.gov.hmcts.ccd.data.casedetails.supplementarydata;\n+\n+import com.fasterxml.jackson.databind.JsonNode;\n+import java.util.List;\n+import java.util.Set;\n+import javax.inject.Singleton;\n+import javax.persistence.EntityManager;\n+import javax.persistence.PersistenceContext;\n+import javax.persistence.Query;\n+import javax.transaction.Transactional;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.beans.factory.annotation.Qualifier;\n+import org.springframework.stereotype.Service;\n+import uk.gov.hmcts.ccd.domain.model.std.SupplementaryData;\n+\n+@Service\n+@Qualifier(\"default\")\n+@Singleton\n+@Transactional\n+public class DefaultSupplementaryDataRepository implements SupplementaryDataRepository {\n+\n+    private static final Logger LOG = LoggerFactory.getLogger(DefaultSupplementaryDataRepository.class);\n+\n+    @PersistenceContext\n+    private EntityManager em;\n+\n+    private List<SupplementaryDataQueryBuilder> queryBuilders;\n+\n+\n+    @Autowired\n+    public DefaultSupplementaryDataRepository(final List<SupplementaryDataQueryBuilder> queryBuilders) {\n+        this.queryBuilders = queryBuilders;\n+    }\n+\n+    @Override\n+    public void setSupplementaryData(final String caseReference,\n+                                     String fieldPath,\n+                                     Object fieldValue) {\n+        LOG.debug(\"Set supplementary data\");\n+        Query query = queryBuilder(SupplementaryDataOperation.SET).buildQueryForEachSupplementaryDataProperty(em,", "originalCommit": "342f1d30039a1e8676a7e96edca5707135484226", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDEyNjU3Ng==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/997#discussion_r450126576", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    public static final String MORE_THAN_ONE_NESTED_LEVEL = \"More than one nested level is not allowed\";\n          \n          \n            \n                    public static final String MORE_THAN_ONE_NESTED_LEVEL = \"Supplementary data properties with more than one nested level are currently not supported\";", "author": "mario-paniccia", "createdAt": "2020-07-06T10:20:44Z", "path": "src/main/java/uk/gov/hmcts/ccd/v2/V2.java", "diffHunk": "@@ -75,6 +75,9 @@ private Error() {}\n         public static final String USER_ID_INVALID = \"User ID is not valid\";\n         public static final String EMPTY_CASE_USER_ROLE_LIST = \"Case user roles list is empty\";\n         public static final String OTHER_USER_CASE_ROLE_ACCESS_NOT_GRANTED = \"Access to other user's case role assignments not granted\";\n+        public static final String NOT_AUTHORISED_UPDATE_SUPPLEMENTARY_DATA = \"Not authorised to update case supplementary data\";\n         public static final String CLIENT_SERVICE_NOT_AUTHORISED_FOR_OPERATION = \"Client service not authorised to perform operation\";\n+        public static final String SUPPLEMENTARY_DATA_INVALID = \"Supplementary Data Invalid\";\n+        public static final String MORE_THAN_ONE_NESTED_LEVEL = \"More than one nested level is not allowed\";", "originalCommit": "342f1d30039a1e8676a7e96edca5707135484226", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDEyNzA5Mw==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/997#discussion_r450127093", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    allowedNestedLevels(supplementaryData);\n          \n          \n            \n                    validateAtMostOneLevelOfNesting(supplementaryData);", "author": "mario-paniccia", "createdAt": "2020-07-06T10:21:49Z", "path": "src/main/java/uk/gov/hmcts/ccd/domain/model/std/validator/SupplementaryDataUpdateRequestValidator.java", "diffHunk": "@@ -0,0 +1,41 @@\n+package uk.gov.hmcts.ccd.domain.model.std.validator;\n+\n+import java.util.Map;\n+import java.util.regex.Pattern;\n+import javax.inject.Named;\n+import javax.inject.Singleton;\n+import uk.gov.hmcts.ccd.domain.model.std.SupplementaryDataUpdateRequest;\n+import uk.gov.hmcts.ccd.endpoint.exceptions.BadRequestException;\n+\n+import static uk.gov.hmcts.ccd.v2.V2.Error.MORE_THAN_ONE_NESTED_LEVEL;\n+import static uk.gov.hmcts.ccd.v2.V2.Error.SUPPLEMENTARY_DATA_INVALID;\n+\n+@Named\n+@Singleton\n+public class SupplementaryDataUpdateRequestValidator {\n+\n+    public void validate(SupplementaryDataUpdateRequest supplementaryData) {\n+        if (supplementaryData == null\n+            || supplementaryData.getRequestData() == null\n+            || supplementaryData.getRequestData().size() == 0) {\n+            throw new BadRequestException(SUPPLEMENTARY_DATA_INVALID);\n+        }\n+        allowedNestedLevels(supplementaryData);", "originalCommit": "342f1d30039a1e8676a7e96edca5707135484226", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDEyOTIxNA==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/997#discussion_r450129214", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public Set<String> getRequestDataKeys() {\n          \n          \n            \n                public Set<String> getPropertiesNames() {", "author": "mario-paniccia", "createdAt": "2020-07-06T10:26:04Z", "path": "src/main/java/uk/gov/hmcts/ccd/domain/model/std/SupplementaryDataUpdateRequest.java", "diffHunk": "@@ -0,0 +1,39 @@\n+package uk.gov.hmcts.ccd.domain.model.std;\n+\n+import com.fasterxml.jackson.annotation.JsonIgnore;\n+import java.util.HashMap;\n+import java.util.HashSet;\n+import java.util.Map;\n+import java.util.Set;\n+import lombok.AllArgsConstructor;\n+import lombok.Getter;\n+import lombok.NoArgsConstructor;\n+import lombok.ToString;\n+import uk.gov.hmcts.ccd.data.casedetails.supplementarydata.SupplementaryDataOperation;\n+\n+@ToString\n+@AllArgsConstructor\n+@NoArgsConstructor\n+@Getter\n+public class SupplementaryDataUpdateRequest {\n+\n+    private Map<String, Map<String, Object>> requestData;\n+\n+    @JsonIgnore\n+    public Map<String, Object> getOperationProperties(SupplementaryDataOperation operation) {\n+        return this.requestData.getOrDefault(operation.getOperationName(), new HashMap<>());\n+    }\n+\n+    @JsonIgnore\n+    public Set<String> getRequestDataKeys() {", "originalCommit": "342f1d30039a1e8676a7e96edca5707135484226", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "bbf5bbda5b76dd41d4869c88c9321da74cbe7f85", "url": "https://github.com/hmcts/ccd-data-store-api/commit/bbf5bbda5b76dd41d4869c88c9321da74cbe7f85", "message": "RDM-8750: Review Comments addressed", "committedDate": "2020-07-06T11:06:05Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDE1MzUyMw==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/997#discussion_r450153523", "bodyText": "Is it possible we have a race condition here when there are many concurrent updates?\nImagine update 1 updates propertyA: 5, then the thread stops just before line 60. At the same time update 2 updates propertyA: 10 and completes. Then update1 resumes and does the find, which will return propertyA: 10 rather than propertyA: 5.\nI think you mentioned the operations are transactional, but I can see those are transactional at the level of the Repository. Not at the level of the controller. So it's possible that update1 sees the changes introduced by update2 transaction here and returns a wrong response?", "author": "mario-paniccia", "createdAt": "2020-07-06T11:18:48Z", "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/supplementarydata/DefaultSupplementaryDataUpdateOperation.java", "diffHunk": "@@ -0,0 +1,62 @@\n+package uk.gov.hmcts.ccd.domain.service.supplementarydata;\n+\n+import java.util.EnumMap;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.function.BiConsumer;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.beans.factory.annotation.Qualifier;\n+import org.springframework.stereotype.Service;\n+import uk.gov.hmcts.ccd.data.casedetails.supplementarydata.SupplementaryDataOperation;\n+import uk.gov.hmcts.ccd.data.casedetails.supplementarydata.SupplementaryDataRepository;\n+import uk.gov.hmcts.ccd.domain.model.std.SupplementaryData;\n+import uk.gov.hmcts.ccd.domain.model.std.SupplementaryDataUpdateRequest;\n+\n+import static uk.gov.hmcts.ccd.data.casedetails.supplementarydata.SupplementaryDataOperation.INC;\n+import static uk.gov.hmcts.ccd.data.casedetails.supplementarydata.SupplementaryDataOperation.SET;\n+\n+@Service\n+@Qualifier(\"default\")\n+public class DefaultSupplementaryDataUpdateOperation implements SupplementaryDataUpdateOperation {\n+\n+    private final SupplementaryDataRepository supplementaryDataRepository;\n+\n+    private EnumMap<SupplementaryDataOperation, BiConsumer<String, SupplementaryDataUpdateRequest>> supplementaryFunctions =\n+        new EnumMap<>(SupplementaryDataOperation.class);\n+\n+    @Autowired\n+    public DefaultSupplementaryDataUpdateOperation(final @Qualifier(\"default\") SupplementaryDataRepository supplementaryDataRepository) {\n+        this.supplementaryDataRepository = supplementaryDataRepository;\n+        supplementaryFunctions.put(SET, (caseReference, updateRequest) -> {\n+            Map<String, Object> requestedData = updateRequest.getOperationProperties(SET);\n+            requestedData\n+                .entrySet()\n+                .stream()\n+                .forEach(entry -> this.supplementaryDataRepository.setSupplementaryData(caseReference,\n+                    entry.getKey(),\n+                    entry.getValue()));\n+        });\n+        supplementaryFunctions.put(INC, (caseReference, updateRequest) -> {\n+            Map<String, Object> requestedData = updateRequest.getOperationProperties(INC);\n+            requestedData\n+                .entrySet()\n+                .stream()\n+                .forEach(entry -> this.supplementaryDataRepository.incrementSupplementaryData(caseReference,\n+                    entry.getKey(),\n+                    entry.getValue()));\n+        });\n+    }\n+\n+    @Override\n+    public SupplementaryData updateSupplementaryData(String caseReference, SupplementaryDataUpdateRequest supplementaryData) {\n+        supplementaryData.getRequestData().keySet().forEach(key -> {\n+            Optional<SupplementaryDataOperation> operation = SupplementaryDataOperation.getOperation(key);\n+            if (operation.isPresent()) {\n+                supplementaryFunctions\n+                    .get(operation.get())\n+                    .accept(caseReference, supplementaryData);\n+            }\n+        });\n+        return this.supplementaryDataRepository.findSupplementaryData(caseReference, supplementaryData.getRequestDataKeys());", "originalCommit": "342f1d30039a1e8676a7e96edca5707135484226", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDE1NDQyMA==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/997#discussion_r450154420", "bodyText": "probably better to have the repository method itself, the set, increment etch... do a find and return the updated property value. Rather than the operation.\nOr move the transactionality at the level of the controller?", "author": "mario-paniccia", "createdAt": "2020-07-06T11:21:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDE1MzUyMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDE1NTA5NA==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/997#discussion_r450155094", "bodyText": "@transactional is at the controller as well!!!", "author": "kiran-yenigala-hmcts", "createdAt": "2020-07-06T11:22:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDE1MzUyMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDE1NjQ0MA==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/997#discussion_r450156440", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                SupplementaryData findSupplementaryData(String caseReference, Set<String> filterFieldPaths);\n          \n          \n            \n                SupplementaryData findSupplementaryData(String caseReference, Set<String> requestedProperties);", "author": "mario-paniccia", "createdAt": "2020-07-06T11:25:27Z", "path": "src/main/java/uk/gov/hmcts/ccd/data/casedetails/supplementarydata/SupplementaryDataRepository.java", "diffHunk": "@@ -0,0 +1,13 @@\n+package uk.gov.hmcts.ccd.data.casedetails.supplementarydata;\n+\n+import java.util.Set;\n+import uk.gov.hmcts.ccd.domain.model.std.SupplementaryData;\n+\n+public interface SupplementaryDataRepository {\n+\n+    void setSupplementaryData(String caseReference, String fieldPath, Object fieldValue);\n+\n+    void incrementSupplementaryData(String caseReference, String fieldPath, Object fieldValue);\n+\n+    SupplementaryData findSupplementaryData(String caseReference, Set<String> filterFieldPaths);", "originalCommit": "342f1d30039a1e8676a7e96edca5707135484226", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDE1ODY5Nw==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/997#discussion_r450158697", "bodyText": "Done", "author": "kiran-yenigala-hmcts", "createdAt": "2020-07-06T11:30:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDE1NjQ0MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDE1NjU1NQ==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/997#discussion_r450156555", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public SupplementaryData findSupplementaryData(final String caseReference, Set<String> filterFieldPaths) {\n          \n          \n            \n                public SupplementaryData findSupplementaryData(final String caseReference, Set<String> requestedProperties) {", "author": "mario-paniccia", "createdAt": "2020-07-06T11:25:43Z", "path": "src/main/java/uk/gov/hmcts/ccd/data/casedetails/supplementarydata/DefaultSupplementaryDataRepository.java", "diffHunk": "@@ -0,0 +1,78 @@\n+package uk.gov.hmcts.ccd.data.casedetails.supplementarydata;\n+\n+import com.fasterxml.jackson.databind.JsonNode;\n+import java.util.List;\n+import java.util.Set;\n+import javax.inject.Singleton;\n+import javax.persistence.EntityManager;\n+import javax.persistence.PersistenceContext;\n+import javax.persistence.Query;\n+import javax.transaction.Transactional;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.beans.factory.annotation.Qualifier;\n+import org.springframework.stereotype.Service;\n+import uk.gov.hmcts.ccd.domain.model.std.SupplementaryData;\n+\n+@Service\n+@Qualifier(\"default\")\n+@Singleton\n+@Transactional\n+public class DefaultSupplementaryDataRepository implements SupplementaryDataRepository {\n+\n+    private static final Logger LOG = LoggerFactory.getLogger(DefaultSupplementaryDataRepository.class);\n+\n+    @PersistenceContext\n+    private EntityManager em;\n+\n+    private List<SupplementaryDataQueryBuilder> queryBuilders;\n+\n+\n+    @Autowired\n+    public DefaultSupplementaryDataRepository(final List<SupplementaryDataQueryBuilder> queryBuilders) {\n+        this.queryBuilders = queryBuilders;\n+    }\n+\n+    @Override\n+    public void setSupplementaryData(final String caseReference,\n+                                     String fieldPath,\n+                                     Object fieldValue) {\n+        LOG.debug(\"Set supplementary data\");\n+        Query query = queryBuilder(SupplementaryDataOperation.SET).buildQueryForEachSupplementaryDataProperty(em,\n+            caseReference,\n+            fieldPath,\n+            fieldValue);\n+        query.executeUpdate();\n+    }\n+\n+    @Override\n+    public void incrementSupplementaryData(final String caseReference,\n+                                           String fieldPath,\n+                                           Object fieldValue) {\n+        LOG.debug(\"Insert supplementary data\");\n+        Query query = queryBuilder(SupplementaryDataOperation.INC).buildQueryForEachSupplementaryDataProperty(em,\n+            caseReference,\n+            fieldPath,\n+            fieldValue);\n+        query.executeUpdate();\n+    }\n+\n+    @Override\n+    public SupplementaryData findSupplementaryData(final String caseReference, Set<String> filterFieldPaths) {", "originalCommit": "342f1d30039a1e8676a7e96edca5707135484226", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDE1NzI2NQ==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/997#discussion_r450157265", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private EnumMap<SupplementaryDataOperation, BiConsumer<String, SupplementaryDataUpdateRequest>> supplementaryFunctions =\n          \n          \n            \n                private EnumMap<SupplementaryDataOperation, BiConsumer<String, SupplementaryDataUpdateRequest>> supplementaryDataFunctions =", "author": "mario-paniccia", "createdAt": "2020-07-06T11:27:21Z", "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/supplementarydata/DefaultSupplementaryDataUpdateOperation.java", "diffHunk": "@@ -0,0 +1,62 @@\n+package uk.gov.hmcts.ccd.domain.service.supplementarydata;\n+\n+import java.util.EnumMap;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.function.BiConsumer;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.beans.factory.annotation.Qualifier;\n+import org.springframework.stereotype.Service;\n+import uk.gov.hmcts.ccd.data.casedetails.supplementarydata.SupplementaryDataOperation;\n+import uk.gov.hmcts.ccd.data.casedetails.supplementarydata.SupplementaryDataRepository;\n+import uk.gov.hmcts.ccd.domain.model.std.SupplementaryData;\n+import uk.gov.hmcts.ccd.domain.model.std.SupplementaryDataUpdateRequest;\n+\n+import static uk.gov.hmcts.ccd.data.casedetails.supplementarydata.SupplementaryDataOperation.INC;\n+import static uk.gov.hmcts.ccd.data.casedetails.supplementarydata.SupplementaryDataOperation.SET;\n+\n+@Service\n+@Qualifier(\"default\")\n+public class DefaultSupplementaryDataUpdateOperation implements SupplementaryDataUpdateOperation {\n+\n+    private final SupplementaryDataRepository supplementaryDataRepository;\n+\n+    private EnumMap<SupplementaryDataOperation, BiConsumer<String, SupplementaryDataUpdateRequest>> supplementaryFunctions =", "originalCommit": "342f1d30039a1e8676a7e96edca5707135484226", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDE1ODc1MQ==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/997#discussion_r450158751", "bodyText": "done", "author": "kiran-yenigala-hmcts", "createdAt": "2020-07-06T11:30:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDE1NzI2NQ=="}], "type": "inlineReview"}, {"oid": "076da07dfa2fd4ecd99bfc805dfa0087af2b90d2", "url": "https://github.com/hmcts/ccd-data-store-api/commit/076da07dfa2fd4ecd99bfc805dfa0087af2b90d2", "message": "RDM-8750: Swagger documentation with Example supplementary data request added\nAnd Review comments addressed", "committedDate": "2020-07-06T11:32:07Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDE2MTgzMQ==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/997#discussion_r450161831", "bodyText": "I would remove direct access in supplementary data to the request data, to avoid boilerplate code like:\ngetRequestData().keySet().forEach\nBetter introduce proper utility methods with self explanatory names to SupplementaryDataUpdateRequest instead.\nIn this case:\ngetSupplementaryDataOperations, which will pair nicely with the already introduced getSupplementaryDataProperties", "author": "mario-paniccia", "createdAt": "2020-07-06T11:37:28Z", "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/supplementarydata/DefaultSupplementaryDataUpdateOperation.java", "diffHunk": "@@ -0,0 +1,62 @@\n+package uk.gov.hmcts.ccd.domain.service.supplementarydata;\n+\n+import java.util.EnumMap;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.function.BiConsumer;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.beans.factory.annotation.Qualifier;\n+import org.springframework.stereotype.Service;\n+import uk.gov.hmcts.ccd.data.casedetails.supplementarydata.SupplementaryDataOperation;\n+import uk.gov.hmcts.ccd.data.casedetails.supplementarydata.SupplementaryDataRepository;\n+import uk.gov.hmcts.ccd.domain.model.std.SupplementaryData;\n+import uk.gov.hmcts.ccd.domain.model.std.SupplementaryDataUpdateRequest;\n+\n+import static uk.gov.hmcts.ccd.data.casedetails.supplementarydata.SupplementaryDataOperation.INC;\n+import static uk.gov.hmcts.ccd.data.casedetails.supplementarydata.SupplementaryDataOperation.SET;\n+\n+@Service\n+@Qualifier(\"default\")\n+public class DefaultSupplementaryDataUpdateOperation implements SupplementaryDataUpdateOperation {\n+\n+    private final SupplementaryDataRepository supplementaryDataRepository;\n+\n+    private EnumMap<SupplementaryDataOperation, BiConsumer<String, SupplementaryDataUpdateRequest>> supplementaryFunctions =\n+        new EnumMap<>(SupplementaryDataOperation.class);\n+\n+    @Autowired\n+    public DefaultSupplementaryDataUpdateOperation(final @Qualifier(\"default\") SupplementaryDataRepository supplementaryDataRepository) {\n+        this.supplementaryDataRepository = supplementaryDataRepository;\n+        supplementaryFunctions.put(SET, (caseReference, updateRequest) -> {\n+            Map<String, Object> requestedData = updateRequest.getOperationProperties(SET);\n+            requestedData\n+                .entrySet()\n+                .stream()\n+                .forEach(entry -> this.supplementaryDataRepository.setSupplementaryData(caseReference,\n+                    entry.getKey(),\n+                    entry.getValue()));\n+        });\n+        supplementaryFunctions.put(INC, (caseReference, updateRequest) -> {\n+            Map<String, Object> requestedData = updateRequest.getOperationProperties(INC);\n+            requestedData\n+                .entrySet()\n+                .stream()\n+                .forEach(entry -> this.supplementaryDataRepository.incrementSupplementaryData(caseReference,\n+                    entry.getKey(),\n+                    entry.getValue()));\n+        });\n+    }\n+\n+    @Override\n+    public SupplementaryData updateSupplementaryData(String caseReference, SupplementaryDataUpdateRequest supplementaryData) {\n+        supplementaryData.getRequestData().keySet().forEach(key -> {", "originalCommit": "342f1d30039a1e8676a7e96edca5707135484226", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "3d811538e50548c7cb5a7d8e46eea7e4b376014e", "url": "https://github.com/hmcts/ccd-data-store-api/commit/3d811538e50548c7cb5a7d8e46eea7e4b376014e", "message": "RDM-8750: Swagger documentation with Example supplementary data request added", "committedDate": "2020-07-06T11:46:50Z", "type": "commit"}, {"oid": "53988db869a982f16d03b8244ce2bd00857a0a5a", "url": "https://github.com/hmcts/ccd-data-store-api/commit/53988db869a982f16d03b8244ce2bd00857a0a5a", "message": "RDM-8750: Review comments addressed", "committedDate": "2020-07-06T12:03:53Z", "type": "commit"}, {"oid": "70bd1716cd931db4f5e6b72ebcdb2ac7f045a7dc", "url": "https://github.com/hmcts/ccd-data-store-api/commit/70bd1716cd931db4f5e6b72ebcdb2ac7f045a7dc", "message": "RDM-8750: check style issues fixed", "committedDate": "2020-07-06T12:06:03Z", "type": "commit"}, {"oid": "09231e4af0f683295222edb25c4679626224fc42", "url": "https://github.com/hmcts/ccd-data-store-api/commit/09231e4af0f683295222edb25c4679626224fc42", "message": "reused existing method getPropertiesNames()", "committedDate": "2020-07-06T15:26:13Z", "type": "commit"}, {"oid": "58ee2744d386a39b32d8e1359b96e49090d48584", "url": "https://github.com/hmcts/ccd-data-store-api/commit/58ee2744d386a39b32d8e1359b96e49090d48584", "message": "refactoring", "committedDate": "2020-07-06T15:31:17Z", "type": "commit"}, {"oid": "09a1cb3131a9f32cd76b49b0d1082896def5fb7c", "url": "https://github.com/hmcts/ccd-data-store-api/commit/09a1cb3131a9f32cd76b49b0d1082896def5fb7c", "message": "refactoring", "committedDate": "2020-07-06T15:43:52Z", "type": "commit"}, {"oid": "1f77d752f1617863563bfb1958daab3cbdce7d20", "url": "https://github.com/hmcts/ccd-data-store-api/commit/1f77d752f1617863563bfb1958daab3cbdce7d20", "message": "refactoring", "committedDate": "2020-07-06T15:45:26Z", "type": "commit"}, {"oid": "be8091dc455a96e9895b7f488ad909630cea8f1a", "url": "https://github.com/hmcts/ccd-data-store-api/commit/be8091dc455a96e9895b7f488ad909630cea8f1a", "message": "fixed wrong refactoring", "committedDate": "2020-07-06T15:48:51Z", "type": "commit"}, {"oid": "4c24887769e23a4abe7d69e6213b74fa591f5575", "url": "https://github.com/hmcts/ccd-data-store-api/commit/4c24887769e23a4abe7d69e6213b74fa591f5575", "message": "refactoring, added unit test", "committedDate": "2020-07-06T16:03:13Z", "type": "commit"}, {"oid": "78a7a73a9a6810ce76dc80c2afafa76243b03507", "url": "https://github.com/hmcts/ccd-data-store-api/commit/78a7a73a9a6810ce76dc80c2afafa76243b03507", "message": "added unit tests", "committedDate": "2020-07-06T16:06:53Z", "type": "commit"}, {"oid": "16065c5db4f1ba277ba3a46c9f12d5a8b44e9ad3", "url": "https://github.com/hmcts/ccd-data-store-api/commit/16065c5db4f1ba277ba3a46c9f12d5a8b44e9ad3", "message": "rename", "committedDate": "2020-07-06T16:12:00Z", "type": "commit"}, {"oid": "221f73e621fe904b2408057e9447451834f4c462", "url": "https://github.com/hmcts/ccd-data-store-api/commit/221f73e621fe904b2408057e9447451834f4c462", "message": "refactoring", "committedDate": "2020-07-06T16:12:52Z", "type": "commit"}, {"oid": "b01a8d1cab7879e9f507cb5050322c4dfbe1e284", "url": "https://github.com/hmcts/ccd-data-store-api/commit/b01a8d1cab7879e9f507cb5050322c4dfbe1e284", "message": "RDM-8868: Removed Unused imports", "committedDate": "2020-07-06T19:39:05Z", "type": "commit"}, {"oid": "0c76fbf1e44304b059d46da7e9c669f6047210da", "url": "https://github.com/hmcts/ccd-data-store-api/commit/0c76fbf1e44304b059d46da7e9c669f6047210da", "message": "updated", "committedDate": "2020-07-07T11:09:33Z", "type": "commit"}, {"oid": "e5a2d186e7505aae95c73eddade81944ac137a30", "url": "https://github.com/hmcts/ccd-data-store-api/commit/e5a2d186e7505aae95c73eddade81944ac137a30", "message": "Merge branch 'develop' into RDM-8750", "committedDate": "2020-07-07T12:57:32Z", "type": "commit"}, {"oid": "064e4af9fc5c734c93c86fdd5afb3e482b043683", "url": "https://github.com/hmcts/ccd-data-store-api/commit/064e4af9fc5c734c93c86fdd5afb3e482b043683", "message": "RDM-8750: Checkpoint comments addressed", "committedDate": "2020-07-08T16:16:39Z", "type": "commit"}, {"oid": "11385c9a3a49b32221d7e878737889e519094f4d", "url": "https://github.com/hmcts/ccd-data-store-api/commit/11385c9a3a49b32221d7e878737889e519094f4d", "message": "RDM-8750: Checkpoint comments addressed", "committedDate": "2020-07-08T16:52:00Z", "type": "commit"}, {"oid": "e69c6934ab7be039cd116071a167a932cbbf1cd9", "url": "https://github.com/hmcts/ccd-data-store-api/commit/e69c6934ab7be039cd116071a167a932cbbf1cd9", "message": "RDM-8750: Checkpoint comments addressed", "committedDate": "2020-07-09T09:29:20Z", "type": "commit"}, {"oid": "5a4fa03c9a7952af20e740929ec4097bc7617b40", "url": "https://github.com/hmcts/ccd-data-store-api/commit/5a4fa03c9a7952af20e740929ec4097bc7617b40", "message": "RDM-8750: Duplicate Key Detection in JSON", "committedDate": "2020-07-09T10:01:27Z", "type": "commit"}]}