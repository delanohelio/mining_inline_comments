{"pr_number": 1121, "pr_title": "RDM 9505", "pr_createdAt": "2020-09-17T13:13:31Z", "pr_url": "https://github.com/hmcts/ccd-data-store-api/pull/1121", "timeline": [{"oid": "3bef6725a1420b645021de5104aca75d87311cdf", "url": "https://github.com/hmcts/ccd-data-store-api/commit/3bef6725a1420b645021de5104aca75d87311cdf", "message": "RDM-9505: Remove unused indexes and add new indexes", "committedDate": "2020-09-17T13:12:26Z", "type": "commit"}, {"oid": "c8ebd7d95f4450ff305b45d5269ccd796df17649", "url": "https://github.com/hmcts/ccd-data-store-api/commit/c8ebd7d95f4450ff305b45d5269ccd796df17649", "message": "RDM-9505: Alter create query to only create if not exists", "committedDate": "2020-09-17T13:35:58Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDI1MzE2Ng==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1121#discussion_r490253166", "bodyText": "Dropping these indexes with liquibase may later on cause an issue should the same indexes are re-created for some reason and liquibase scripts are not aligned yet. I'd suggest removing these lines and manually dropping these and all other unused indexes, say, not scanned for the last 3 months. We need to also make sure these indexes are not getting created by other liquibase change sets. If they are, we need to remove basically any references to these indexes.", "author": "MSancaktutar", "createdAt": "2020-09-17T13:38:27Z", "path": "src/main/resources/db/changelog/db.changelog-RDM-9505.xml", "diffHunk": "@@ -0,0 +1,25 @@\n+<databaseChangeLog xmlns=\"http://www.liquibase.org/xml/ns/dbchangelog\"\n+                   xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n+                   xsi:schemaLocation=\"http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd\">\n+\n+\n+    <changeSet id=\"rdm-9505\" author=\"thomas.elliot@hmcts.net\">\n+        <sql dbms=\"postgresql\"\n+             endDelimiter=\"\\nGO\"\n+             splitStatements=\"true\"\n+             stripComments=\"true\">\n+            DROP INDEX idx_case_data__generated_dob;\n+            DROP INDEX idx_case_data_generatedemail;", "originalCommit": "3bef6725a1420b645021de5104aca75d87311cdf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDI1Njk2MA==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1121#discussion_r490256960", "bodyText": "@MSancaktutar We can't remove references from previous Liquibase migrations (and these indexes are in previous ones) otherwise the Liquibase checksum validation will error. These have already been dropped in prod so this will correctly align us, and if they need to be created again in future then a future migration that does it wouldn't cause an issue.", "author": "danlysiak", "createdAt": "2020-09-17T13:43:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDI1MzE2Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDI1ODM3NQ==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1121#discussion_r490258375", "bodyText": "Since the scripts are executed sequentially if someone adds them in a later script the drop being here won't cause an issue.", "author": "tomxelliott", "createdAt": "2020-09-17T13:45:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDI1MzE2Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDI2MzgxOA==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1121#discussion_r490263818", "bodyText": "Although that being said if you would prefer I remove the 2 drop statements, happy to do so \ud83d\udc4d", "author": "tomxelliott", "createdAt": "2020-09-17T13:53:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDI1MzE2Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDI4MTI4NQ==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1121#discussion_r490281285", "bodyText": "Well, of course later scripts to create these are fully safe from a drop statement like above.\nBut they can still drop indexes that may be manually created in order to, say, intervene a production performance issue.\n@danlysiak  - I understand Liquibase will not let us arbitrarily edit past scripts, as they are supposed to create or update the database structure always to a consistent and safe state. However, when a series of changes contain a zero-net-structural-effect type of do/undo things, and if such do/undo statements brings unacceptible side effect of, say, re-constructing an index everytime after a deployment (causing full table scans, dropping database performance beyond just a few seconds during releases), then I'm pretty sure Liquibase also provides a due process and technique to eliminate such no effect changes. On the other hand, Liquibase may also be smart enough to first process the mathematical equivalent of the full series of changes and only after that execute the net mathematical equivalent, then things may be a lot easier to manage. Let's discuss on an interactive call, please.\n@danlysiak @tomxelliott", "author": "MSancaktutar", "createdAt": "2020-09-17T14:14:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDI1MzE2Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDMwNzYxMw==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1121#discussion_r490307613", "bodyText": "Considering the fact that only the incremental delta will be executed in any next round, I'm in full peace of mind with the way index objects are removed. Many thanks Dan & Tom.", "author": "MSancaktutar", "createdAt": "2020-09-17T14:45:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDI1MzE2Ng=="}], "type": "inlineReview"}, {"oid": "15187e4aeb33f19eb3a7e5d0610edc1d0b301d25", "url": "https://github.com/hmcts/ccd-data-store-api/commit/15187e4aeb33f19eb3a7e5d0610edc1d0b301d25", "message": "RDM-9505: Delete indexes only if they exist", "committedDate": "2020-09-17T13:39:33Z", "type": "commit"}, {"oid": "aad01be6a6b24e53bedcc51500e28b6a417211b1", "url": "https://github.com/hmcts/ccd-data-store-api/commit/aad01be6a6b24e53bedcc51500e28b6a417211b1", "message": "Merge branch 'develop' into RDM-9505", "committedDate": "2020-09-18T08:58:33Z", "type": "commit"}, {"oid": "80dbe563ac6b996c9ee81229156d91fd050a189c", "url": "https://github.com/hmcts/ccd-data-store-api/commit/80dbe563ac6b996c9ee81229156d91fd050a189c", "message": "RDM-9505: Create indexes concurrently to ensure the DB is not locked for too long", "committedDate": "2020-09-21T09:39:47Z", "type": "commit"}, {"oid": "cf6d7aca788f87afa14e7289ad9046dade1146ee", "url": "https://github.com/hmcts/ccd-data-store-api/commit/cf6d7aca788f87afa14e7289ad9046dade1146ee", "message": "Merge branch 'RDM-9505' of github.com:hmcts/ccd-data-store-api into RDM-9505", "committedDate": "2020-09-21T09:42:17Z", "type": "commit"}, {"oid": "7171b978bf6a94bc7d8a17d9ec39349e0adaed53", "url": "https://github.com/hmcts/ccd-data-store-api/commit/7171b978bf6a94bc7d8a17d9ec39349e0adaed53", "message": "RDM-9505: Add flag for runInTransaction as is required for concurrent index creation", "committedDate": "2020-09-21T10:52:12Z", "type": "commit"}]}