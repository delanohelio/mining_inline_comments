{"pr_number": 2827, "pr_title": "New module for virtual attribute adDisplayName:o365mu", "pr_createdAt": "2020-07-30T12:49:16Z", "pr_url": "https://github.com/CESNET/perun/pull/2827", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDM0MzQ2OA==", "url": "https://github.com/CESNET/perun/pull/2827#discussion_r464343468", "bodyText": "This is just a performance-related question, but wouldn't it be better to check the nullity of the cispr right away? This way, if the cispr is null, the other attribute is read and not used at all.", "author": "Vojtech-Sassmann", "createdAt": "2020-08-03T11:02:02Z", "path": "perun-core/src/main/java/cz/metacentrum/perun/core/impl/modules/attributes/urn_perun_group_attribute_def_virt_adDisplayName_o365mu.java", "diffHunk": "@@ -0,0 +1,166 @@\n+package cz.metacentrum.perun.core.impl.modules.attributes;\n+\n+import cz.metacentrum.perun.core.api.Attribute;\n+import cz.metacentrum.perun.core.api.AttributeDefinition;\n+import cz.metacentrum.perun.core.api.AttributesManager;\n+import cz.metacentrum.perun.core.api.Group;\n+import cz.metacentrum.perun.core.api.exceptions.AttributeNotExistsException;\n+import cz.metacentrum.perun.core.api.exceptions.InternalErrorException;\n+import cz.metacentrum.perun.core.api.exceptions.ParentGroupNotExistsException;\n+import cz.metacentrum.perun.core.api.exceptions.WrongAttributeAssignmentException;\n+import cz.metacentrum.perun.core.impl.PerunSessionImpl;\n+import cz.metacentrum.perun.core.implApi.modules.attributes.GroupVirtualAttributesModuleAbstract;\n+import cz.metacentrum.perun.core.implApi.modules.attributes.GroupVirtualAttributesModuleImplApi;\n+import cz.metacentrum.perun.core.implApi.modules.attributes.SkipValueCheckDuringDependencyCheck;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.util.regex.Matcher;\n+import java.util.regex.Pattern;\n+\n+/**\n+ * Module for ad DisplayName defines way how to count a final value for display name of group in o365mu from existing attributes.\n+ * It expects existence of some attributes and hierarchy of groups.\n+ *\n+ * @author Michal Stava <stavamichal@gmail.com>\n+ */\n+@SkipValueCheckDuringDependencyCheck\n+public class urn_perun_group_attribute_def_virt_adDisplayName_o365mu extends GroupVirtualAttributesModuleAbstract implements GroupVirtualAttributesModuleImplApi {\n+\n+\tprivate final static Logger log = LoggerFactory.getLogger(urn_perun_group_attribute_def_virt_adDisplayName_o365mu.class);\n+\n+\tprivate static final String A_G_D_AD_DISPLAY_NAME_O365MU = AttributesManager.NS_GROUP_ATTR_DEF + \":adDisplayName:o365mu\";\n+\tprivate static final String A_G_D_INET_CISPR = AttributesManager.NS_GROUP_ATTR_DEF + \":inetCispr\";\n+\tprivate static final String A_G_D_INET_GROUP_NAME_CS = AttributesManager.NS_GROUP_ATTR_DEF + \":inetGroupNameCS\";\n+\tprivate static final String A_G_D_INET_GROUP_NAME_ABB_EN = AttributesManager.NS_GROUP_ATTR_DEF + \":inetGroupNameAbbEN\";\n+\tprivate static final String A_G_D_INET_WORKPLACES_TYPE_CS = AttributesManager.NS_GROUP_ATTR_DEF + \":inetWorkplacesTypeCS\";\n+\n+\tprivate static final Pattern partOfUniversityPattern = Pattern.compile(\"^[1-9][1-9][0]{4}$\");\n+\tprivate static final Pattern otherWorkplacesPattern = Pattern.compile(\"^[1-9][0-9]{5}$\");\n+\n+\tprivate static final String TOP_LEVEL_GROUP_CISPR = \"000000\";\n+\tprivate static final String TOP_LEVEL_PREFIX = \"MUNI\";\n+\n+\t@Override\n+\tpublic Attribute getAttributeValue(PerunSessionImpl sess, Group group, AttributeDefinition attributeDefinition) {\n+\t\tAttribute attribute = new Attribute(attributeDefinition);\n+\n+\t\tString defaultAdDisplayName = getStringValueOfGroupAttribute(sess, group, A_G_D_AD_DISPLAY_NAME_O365MU);;\n+\t\tif(defaultAdDisplayName != null) {\n+\t\t\t//there is a default value and we can take it\n+\t\t\tattribute.setValue(defaultAdDisplayName);\n+\t\t\treturn attribute;\n+\t\t}\n+\n+\t\t//If there is no way to take default value, count a new one from other attributes (if possible)\n+\t\tString cispr = getStringValueOfGroupAttribute(sess, group, A_G_D_INET_CISPR);\n+\t\tString typeOfWorkplaces = getStringValueOfGroupAttribute(sess, group, A_G_D_INET_WORKPLACES_TYPE_CS);\n+\t\t//if any of these values are null, return empty attribute instead\n+\t\tif(cispr == null || typeOfWorkplaces == null) return attribute;", "originalCommit": "4132b1056b0d7ff289d15c91e7986175e25ba553", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDQxMDAxOA==", "url": "https://github.com/CESNET/perun/pull/2827#discussion_r464410018", "bodyText": "You are right, changed.", "author": "stavamichal", "createdAt": "2020-08-03T13:23:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDM0MzQ2OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDM1MTk3NA==", "url": "https://github.com/CESNET/perun/pull/2827#discussion_r464351974", "bodyText": "We probably don't want wildcard imports.", "author": "Vojtech-Sassmann", "createdAt": "2020-08-03T11:22:38Z", "path": "perun-core/src/test/java/cz/metacentrum/perun/core/impl/modules/attributes/urn_perun_group_attribute_def_virt_adDisplayName_o365muTest.java", "diffHunk": "@@ -0,0 +1,153 @@\n+package cz.metacentrum.perun.core.impl.modules.attributes;\n+\n+import cz.metacentrum.perun.core.api.Attribute;\n+import cz.metacentrum.perun.core.api.AttributeDefinition;\n+import cz.metacentrum.perun.core.api.AttributesManager;\n+import cz.metacentrum.perun.core.api.Group;\n+import cz.metacentrum.perun.core.api.exceptions.AttributeNotExistsException;\n+import cz.metacentrum.perun.core.bl.AttributesManagerBl;\n+import cz.metacentrum.perun.core.bl.GroupsManagerBl;\n+import cz.metacentrum.perun.core.bl.PerunBl;\n+import cz.metacentrum.perun.core.impl.PerunSessionImpl;\n+import org.junit.Before;\n+import org.junit.Test;\n+\n+import static org.junit.Assert.*;\n+import static org.mockito.Mockito.*;", "originalCommit": "4132b1056b0d7ff289d15c91e7986175e25ba553", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDQxMDA4Ng==", "url": "https://github.com/CESNET/perun/pull/2827#discussion_r464410086", "bodyText": "Changed.", "author": "stavamichal", "createdAt": "2020-08-03T13:23:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDM1MTk3NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDM1MjgxOQ==", "url": "https://github.com/CESNET/perun/pull/2827#discussion_r464352819", "bodyText": "It would be nice to have the when and .then calls on separate lines, so it is easier to distinguish between those two parts.", "author": "Vojtech-Sassmann", "createdAt": "2020-08-03T11:24:45Z", "path": "perun-core/src/test/java/cz/metacentrum/perun/core/impl/modules/attributes/urn_perun_group_attribute_def_virt_adDisplayName_o365muTest.java", "diffHunk": "@@ -0,0 +1,153 @@\n+package cz.metacentrum.perun.core.impl.modules.attributes;\n+\n+import cz.metacentrum.perun.core.api.Attribute;\n+import cz.metacentrum.perun.core.api.AttributeDefinition;\n+import cz.metacentrum.perun.core.api.AttributesManager;\n+import cz.metacentrum.perun.core.api.Group;\n+import cz.metacentrum.perun.core.api.exceptions.AttributeNotExistsException;\n+import cz.metacentrum.perun.core.bl.AttributesManagerBl;\n+import cz.metacentrum.perun.core.bl.GroupsManagerBl;\n+import cz.metacentrum.perun.core.bl.PerunBl;\n+import cz.metacentrum.perun.core.impl.PerunSessionImpl;\n+import org.junit.Before;\n+import org.junit.Test;\n+\n+import static org.junit.Assert.*;\n+import static org.mockito.Mockito.*;\n+\n+/**\n+ * @author Michal Stava stavamichal@gmail.com\n+ */\n+public class urn_perun_group_attribute_def_virt_adDisplayName_o365muTest {\n+\n+\tprivate final urn_perun_group_attribute_def_virt_adDisplayName_o365mu classInstance = new urn_perun_group_attribute_def_virt_adDisplayName_o365mu();\n+\tprivate final AttributeDefinition adDisplayNameO365MuAttrDef = classInstance.getAttributeDefinition();\n+\n+\tprivate final Group groupA = setUpGroup(1, null, \"groupA\", \"A\");\n+\tprivate final Group groupB = setUpGroup(2, 1, \"groupB\", \"B\");\n+\tprivate final Group groupC = setUpGroup(3, 2, \"groupC\", \"C\");\n+\tprivate final Group groupD = setUpGroup(4, 3, \"groupD\", \"D\");\n+\tprivate final Group groupE = setUpGroup(5, 4, \"groupE\", \"E\");\n+\tprivate final Group groupWithoutAttributes = setUpGroup(6, null, \"groupWithoutAttributes\", \"groupWithoutAttributes\");\n+\n+\tprivate final AttributeDefinition defaultAdDisplayNameAttrDef = setUpGroupAttributeDefinition(1, \"adDisplayName:o365mu\", String.class.getName());\n+\tprivate final AttributeDefinition inetCisprAttrDef = setUpGroupAttributeDefinition(2, \"inetCispr\", String.class.getName());\n+\tprivate final AttributeDefinition inetGroupNameCSAttrDef = setUpGroupAttributeDefinition(3, \"inetGroupNameCS\", String.class.getName());\n+\tprivate final AttributeDefinition inetGroupNameAbbENAttrDef = setUpGroupAttributeDefinition(4, \"inetGroupNameAbbEN\", String.class.getName());\n+\tprivate final AttributeDefinition inetWorkplacesTypeCSAttrDef = setUpGroupAttributeDefinition(5, \"inetWorkplacesTypeCS\", String.class.getName());\n+\n+\tprivate final String typeOfWorkplacesA = \"typeA\";\n+\tprivate final String typeOfWorkplacesB = \"typeB\";\n+\tprivate final String typeOfWorkplacesC = \"typeC\";\n+\tprivate final String predefinedDisplayName = \"specialTestingPredefinedDisplayName\";\n+\n+\tprivate PerunSessionImpl sess;\n+\n+\t@Before\n+\tpublic void setUp() throws Exception {\n+\t\t//prepare mocks\n+\t\tsess = mock(PerunSessionImpl.class);\n+\t\tPerunBl perunBl = mock(PerunBl.class);\n+\t\tAttributesManagerBl am = mock(AttributesManagerBl.class);\n+\t\tGroupsManagerBl gm = mock(GroupsManagerBl.class);\n+\t\twhen(sess.getPerunBl()).thenReturn(perunBl);\n+\t\twhen(perunBl.getAttributesManagerBl()).thenReturn(am);\n+\t\twhen(perunBl.getGroupsManagerBl()).thenReturn(gm);\n+\n+\t\twhen(sess.getPerunBl().getGroupsManagerBl().getParentGroup(sess, groupB)).thenReturn(groupA);\n+\t\twhen(sess.getPerunBl().getGroupsManagerBl().getParentGroup(sess, groupC)).thenReturn(groupB);\n+\t\twhen(sess.getPerunBl().getGroupsManagerBl().getParentGroup(sess, groupD)).thenReturn(groupC);\n+\t\twhen(sess.getPerunBl().getGroupsManagerBl().getParentGroup(sess, groupE)).thenReturn(groupD);\n+\n+\t\t//group A is the main group with cispr 000000, it has no default display name\n+\t\tsetWhenClauseByParametersForGroup(sess, groupA, null, \"000000\", groupA.getName(), groupA.getDescription(), typeOfWorkplacesA);\n+\t\t//group B is special group which should return null on display name\n+\t\tsetWhenClauseByParametersForGroup(sess, groupB, null, \"000001\", groupB.getName(), groupB.getDescription(), typeOfWorkplacesA);\n+\t\t//group C is other part of university, it has no default display name\n+\t\tsetWhenClauseByParametersForGroup(sess, groupC, null, \"110000\", groupC.getName(), groupC.getDescription(), typeOfWorkplacesB);\n+\t\t//group D is special group with predefined display name\n+\t\tsetWhenClauseByParametersForGroup(sess, groupD, predefinedDisplayName, null, null, null, null);\n+\t\t//group E is other type of group, it has no default display name\n+\t\tsetWhenClauseByParametersForGroup(sess, groupE, null, \"123456\", groupE.getName(), groupE.getDescription(), typeOfWorkplacesC);\n+\n+\t\twhen(sess.getPerunBl().getAttributesManagerBl().getAttribute(sess, groupWithoutAttributes, defaultAdDisplayNameAttrDef.getName())).thenThrow(AttributeNotExistsException.class);\n+\t\twhen(sess.getPerunBl().getAttributesManagerBl().getAttribute(sess, groupWithoutAttributes, inetCisprAttrDef.getName())).thenThrow(AttributeNotExistsException.class);\n+\t\twhen(sess.getPerunBl().getAttributesManagerBl().getAttribute(sess, groupWithoutAttributes, inetWorkplacesTypeCSAttrDef.getName())).thenThrow(AttributeNotExistsException.class);", "originalCommit": "4132b1056b0d7ff289d15c91e7986175e25ba553", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDQxMDEzOA==", "url": "https://github.com/CESNET/perun/pull/2827#discussion_r464410138", "bodyText": "Changed.", "author": "stavamichal", "createdAt": "2020-08-03T13:23:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDM1MjgxOQ=="}], "type": "inlineReview"}, {"oid": "48aa11732f60a7c7ae56b1a685df6fbc0d7eec8a", "url": "https://github.com/CESNET/perun/commit/48aa11732f60a7c7ae56b1a685df6fbc0d7eec8a", "message": "New module for virtual attribute adDisplayName:o365mu\n\n - module will count display name by predefined rules\n - there is also simple test for module", "committedDate": "2020-08-03T13:23:13Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTU0NjkwMw==", "url": "https://github.com/CESNET/perun/pull/2827#discussion_r465546903", "bodyText": "Double semicolon ;;", "author": "zlamalp", "createdAt": "2020-08-05T08:03:19Z", "path": "perun-core/src/main/java/cz/metacentrum/perun/core/impl/modules/attributes/urn_perun_group_attribute_def_virt_adDisplayName_o365mu.java", "diffHunk": "@@ -0,0 +1,167 @@\n+package cz.metacentrum.perun.core.impl.modules.attributes;\n+\n+import cz.metacentrum.perun.core.api.Attribute;\n+import cz.metacentrum.perun.core.api.AttributeDefinition;\n+import cz.metacentrum.perun.core.api.AttributesManager;\n+import cz.metacentrum.perun.core.api.Group;\n+import cz.metacentrum.perun.core.api.exceptions.AttributeNotExistsException;\n+import cz.metacentrum.perun.core.api.exceptions.InternalErrorException;\n+import cz.metacentrum.perun.core.api.exceptions.ParentGroupNotExistsException;\n+import cz.metacentrum.perun.core.api.exceptions.WrongAttributeAssignmentException;\n+import cz.metacentrum.perun.core.impl.PerunSessionImpl;\n+import cz.metacentrum.perun.core.implApi.modules.attributes.GroupVirtualAttributesModuleAbstract;\n+import cz.metacentrum.perun.core.implApi.modules.attributes.GroupVirtualAttributesModuleImplApi;\n+import cz.metacentrum.perun.core.implApi.modules.attributes.SkipValueCheckDuringDependencyCheck;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.util.regex.Matcher;\n+import java.util.regex.Pattern;\n+\n+/**\n+ * Module for ad DisplayName defines way how to count a final value for display name of group in o365mu from existing attributes.\n+ * It expects existence of some attributes and hierarchy of groups.\n+ *\n+ * @author Michal Stava <stavamichal@gmail.com>\n+ */\n+@SkipValueCheckDuringDependencyCheck\n+public class urn_perun_group_attribute_def_virt_adDisplayName_o365mu extends GroupVirtualAttributesModuleAbstract implements GroupVirtualAttributesModuleImplApi {\n+\n+\tprivate final static Logger log = LoggerFactory.getLogger(urn_perun_group_attribute_def_virt_adDisplayName_o365mu.class);\n+\n+\tprivate static final String A_G_D_AD_DISPLAY_NAME_O365MU = AttributesManager.NS_GROUP_ATTR_DEF + \":adDisplayName:o365mu\";\n+\tprivate static final String A_G_D_INET_CISPR = AttributesManager.NS_GROUP_ATTR_DEF + \":inetCispr\";\n+\tprivate static final String A_G_D_INET_GROUP_NAME_CS = AttributesManager.NS_GROUP_ATTR_DEF + \":inetGroupNameCS\";\n+\tprivate static final String A_G_D_INET_GROUP_NAME_ABB_EN = AttributesManager.NS_GROUP_ATTR_DEF + \":inetGroupNameAbbEN\";\n+\tprivate static final String A_G_D_INET_WORKPLACES_TYPE_CS = AttributesManager.NS_GROUP_ATTR_DEF + \":inetWorkplacesTypeCS\";\n+\n+\tprivate static final Pattern partOfUniversityPattern = Pattern.compile(\"^[1-9][1-9][0]{4}$\");\n+\tprivate static final Pattern otherWorkplacesPattern = Pattern.compile(\"^[1-9][0-9]{5}$\");\n+\n+\tprivate static final String TOP_LEVEL_GROUP_CISPR = \"000000\";\n+\tprivate static final String TOP_LEVEL_PREFIX = \"MUNI\";\n+\n+\t@Override\n+\tpublic Attribute getAttributeValue(PerunSessionImpl sess, Group group, AttributeDefinition attributeDefinition) {\n+\t\tAttribute attribute = new Attribute(attributeDefinition);\n+\n+\t\tString defaultAdDisplayName = getStringValueOfGroupAttribute(sess, group, A_G_D_AD_DISPLAY_NAME_O365MU);;", "originalCommit": "48aa11732f60a7c7ae56b1a685df6fbc0d7eec8a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTU1NzQwMQ==", "url": "https://github.com/CESNET/perun/pull/2827#discussion_r465557401", "bodyText": "Fixed", "author": "stavamichal", "createdAt": "2020-08-05T08:22:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTU0NjkwMw=="}], "type": "inlineReview"}, {"oid": "1083c4cc4f6a122f8e955d4d46f3e9b0c9693612", "url": "https://github.com/CESNET/perun/commit/1083c4cc4f6a122f8e955d4d46f3e9b0c9693612", "message": "New module for virtual attribute adDisplayName:o365mu\n\n - module will count display name by predefined rules\n - there is also simple test for module", "committedDate": "2020-08-05T08:21:54Z", "type": "commit"}, {"oid": "1083c4cc4f6a122f8e955d4d46f3e9b0c9693612", "url": "https://github.com/CESNET/perun/commit/1083c4cc4f6a122f8e955d4d46f3e9b0c9693612", "message": "New module for virtual attribute adDisplayName:o365mu\n\n - module will count display name by predefined rules\n - there is also simple test for module", "committedDate": "2020-08-05T08:21:54Z", "type": "forcePushed"}]}