{"pr_number": 2912, "pr_title": "Script for finding groups inconsistencies", "pr_createdAt": "2020-09-25T07:25:35Z", "pr_url": "https://github.com/CESNET/perun/pull/2912", "timeline": [{"oid": "190ba5287e5a354516b87df46da5bde3af831d60", "url": "https://github.com/CESNET/perun/commit/190ba5287e5a354516b87df46da5bde3af831d60", "message": "Script for finding groups inconsistencies\n\n- In perun db was created new script find_groups_inconsistencies,\n  which checks wheter there are groups with some relationship where\n  subgroup contains a member which does not exists in the parent group as\n  Indirect.", "committedDate": "2020-10-02T10:27:15Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDkxMzIxNQ==", "url": "https://github.com/CESNET/perun/pull/2912#discussion_r494913215", "bodyText": "Wrong indentation.", "author": "stavamichal", "createdAt": "2020-09-25T11:04:00Z", "path": "perun-db/find_group_inconsistencies", "diffHunk": "@@ -0,0 +1,111 @@\n+#!/usr/bin/perl -w\n+use strict;\n+use warnings FATAL => 'all';\n+\n+use DBI;\n+use POSIX qw(:errno_h);\n+use Getopt::Long qw(:config no_ignore_case);\n+no if $] >= 5.017011, warnings => 'experimental::smartmatch';\n+\n+sub help {\n+\treturn qq{\n+        Find all groups' members inconsistencies.\n+        --------------------------------------\n+        Available options:\n+\n+        --vo        | -v Vo id in which inconsistencies will be looking for (optional)\n+        --user      | -u Username for Postgre DB (required)\n+        --password  | -p Password for Postgre DB (required)\n+        };\n+}\n+\n+my ($user, $pwd, $input_vo);\n+my @already_processed_groups = ();\n+\n+GetOptions (\"help|h\" => sub { print help(); exit 0;}, \"vo|v=s\" => \\$input_vo,\"user|u=s\" => \\$user, \"password|w=s\" => \\$pwd) || die help();\n+\n+if (!defined $pwd) { print \"[ERROR] Password for Postgre DB is required! Use --help | -h to print help.\\n\"; exit 1; }\n+if (!defined $user) { print \"[ERROR] Username for Postgre DB is required! Use --help | -h to print help.\\n\"; exit 1; }\n+\n+my $dbh = DBI->connect('dbi:Pg:dbname=perun',$user,$pwd,{RaiseError=>1,AutoCommit=>0,pg_enable_utf8=>1}) or die EPERM,\" Connect\";\n+\n+my $sth_vos = $dbh->prepare(q{\n+\tselect id from vos;\n+});\n+\n+my $sth_root_groups = $dbh->prepare(q{\n+\tselect id from groups where vo_id = ? and parent_group_id is null and id not in (select operand_gid from groups_groups) and name != 'members';\n+});\n+\n+my $sth_child_groups = $dbh->prepare(q{\n+\tselect operand_gid from groups_groups where result_gid = ?\n+});\n+\n+my $sth_indirect_group_members = $dbh->prepare(q{\n+\tselect member_id from groups_members where group_id = ? and membership_type = 2\n+});\n+\n+my $sth_group_members = $dbh->prepare(q{\n+\tselect distinct member_id from groups_members where group_id = ?\n+});\n+\n+if (defined $input_vo) {\n+\tfind_inconsistencies_in_vo($input_vo);\n+} else {\n+\t$sth_vos->execute();\n+\twhile (my ($selected_vo) = $sth_vos->fetchrow_array()) {\n+\t\tfind_inconsistencies_in_vo($selected_vo);\n+\t}\n+}\n+disconnect $dbh;\n+\n+#\n+# Find group inconsistencies in specific vo\n+#\n+sub find_inconsistencies_in_vo {\n+\tmy $vo = shift;", "originalCommit": "cd4ad9051371fe7c23200ed8599898cafbcbd465", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjI2MzI4Mw==", "url": "https://github.com/CESNET/perun/pull/2912#discussion_r502263283", "bodyText": "Fixed", "author": "balcirakpeter", "createdAt": "2020-10-09T08:15:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDkxMzIxNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDg2OTUxNg==", "url": "https://github.com/CESNET/perun/pull/2912#discussion_r500869516", "bodyText": "Please add documentation of this function.", "author": "stavamichal", "createdAt": "2020-10-07T09:29:02Z", "path": "perun-db/find_group_inconsistencies", "diffHunk": "@@ -0,0 +1,120 @@\n+#!/usr/bin/perl -w\n+use strict;\n+use warnings FATAL => 'all';\n+\n+use DBI;\n+use POSIX qw(:errno_h);\n+use Getopt::Long qw(:config no_ignore_case);\n+no if $] >= 5.017011, warnings => 'experimental::smartmatch';\n+\n+sub help {\n+\treturn qq{\n+        Find all groups' members inconsistencies.\n+        --------------------------------------\n+        Available options:\n+\n+        --vo        | -v Vo id in which inconsistencies will be looking for (optional)\n+        --user      | -u Username for Postgre DB (required)\n+        --password  | -p Password for Postgre DB (required)\n+        };\n+}\n+\n+my ($user, $pwd, $input_vo);\n+my @already_processed_groups = ();\n+\n+GetOptions (\"help|h\" => sub { print help(); exit 0;}, \"vo|v=s\" => \\$input_vo,\"user|u=s\" => \\$user, \"password|w=s\" => \\$pwd) || die help();\n+\n+if (!defined $pwd) { print \"[ERROR] Password for Postgre DB is required! Use --help | -h to print help.\\n\"; exit 1; }\n+if (!defined $user) { print \"[ERROR] Username for Postgre DB is required! Use --help | -h to print help.\\n\"; exit 1; }\n+\n+my $dbh = DBI->connect('dbi:Pg:dbname=perun',$user,$pwd,{RaiseError=>1,AutoCommit=>0,pg_enable_utf8=>1}) or die EPERM,\" Connect\";\n+\n+my $sth_vos = $dbh->prepare(q{\n+\tselect id from vos;\n+});\n+\n+my $sth_root_groups = $dbh->prepare(q{\n+\tselect id from groups where vo_id = ? and parent_group_id is null and id not in (select operand_gid from groups_groups) and name != 'members';\n+});\n+\n+my $sth_child_groups = $dbh->prepare(q{\n+\tselect operand_gid from groups_groups where result_gid = ?\n+});\n+\n+my $sth_indirect_group_members = $dbh->prepare(q{\n+\tselect member_id, source_group_id from groups_members where group_id = ? and membership_type = 2\n+});\n+\n+my $sth_group_members = $dbh->prepare(q{\n+\tselect distinct member_id from groups_members where group_id = ?\n+});\n+\n+if (defined $input_vo) {\n+\tfind_inconsistencies_in_vo($input_vo);\n+} else {\n+\t$sth_vos->execute();\n+\twhile (my ($selected_vo) = $sth_vos->fetchrow_array()) {\n+\t\tfind_inconsistencies_in_vo($selected_vo);\n+\t}\n+}\n+disconnect $dbh;\n+\n+#\n+# Find group inconsistencies in specific vo\n+#\n+sub find_inconsistencies_in_vo {\n+\tmy $vo = shift;\n+\n+        print(\"Process of finding group inconsistencies in vo:$vo has started.\\n\");\n+\n+        my $root_groups = $dbh->selectcol_arrayref($sth_root_groups, {}, ($vo));\n+        my $root_indirect_members = prepare_structure_of_indirect_members($root_groups);\n+        check_against_next_group_level($root_indirect_members);\n+\n+        print(\"Process of finding group inconsistencies in vo:$vo has finished.\\n\");\n+}\n+\n+#\n+# Recursively check current level of groups against their child groups (unions included).\n+#\n+sub check_against_next_group_level {\n+\tmy $current_indirect_members = shift;\n+\treturn unless (%$current_indirect_members);\n+\n+\tmy @all_sub_groups = ();\n+\n+\tforeach my $parent_group (sort keys %$current_indirect_members) {\n+\t\tnext if($parent_group ~~ @already_processed_groups);\n+\t\tmy @sub_groups = @{$dbh->selectcol_arrayref($sth_child_groups, {}, ($parent_group))};\n+\t\tforeach my $sub_group (@sub_groups) {\n+\t\t\tmy @all_sub_group_members = @{$dbh->selectcol_arrayref($sth_group_members, {}, ($sub_group))};\n+\t\t\tforeach my $sub_group_member (@all_sub_group_members) {\n+\t\t\t\tunless ($sub_group_member ~~ @{$current_indirect_members->{$parent_group}->{$sub_group}}) {\n+\t\t\t\t\tprint(\"Inconsistency found. Member $sub_group_member should exists as Indirect in parent group $parent_group of group $sub_group.\\n\");\n+\t\t\t\t}\n+\t\t\t}\n+\t\t\tpush(@all_sub_groups, $sub_group);\n+\t\t}\n+\t}\n+\tmy $next_indirect_members = prepare_structure_of_indirect_members(\\@all_sub_groups);\n+\tpush(@already_processed_groups, keys %$current_indirect_members);\n+\tcheck_against_next_group_level($next_indirect_members);\n+}\n+\n+sub prepare_structure_of_indirect_members {", "originalCommit": "190ba5287e5a354516b87df46da5bde3af831d60", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjI2MzM2NA==", "url": "https://github.com/CESNET/perun/pull/2912#discussion_r502263364", "bodyText": "Added", "author": "balcirakpeter", "createdAt": "2020-10-09T08:15:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDg2OTUxNg=="}], "type": "inlineReview"}, {"oid": "28b4275c927279b9c2f6982edfedf611713ef9a3", "url": "https://github.com/CESNET/perun/commit/28b4275c927279b9c2f6982edfedf611713ef9a3", "message": "Script for finding groups inconsistencies\n\n- In perun db was created new script find_groups_inconsistencies,\n  which checks wheter there are groups with some relationship where\n  subgroup contains a member which does not exists in the parent group as\n  Indirect.", "committedDate": "2020-10-09T08:13:59Z", "type": "forcePushed"}, {"oid": "2402ba4f03b1c06dcd3fb9d3a3c2097489197a12", "url": "https://github.com/CESNET/perun/commit/2402ba4f03b1c06dcd3fb9d3a3c2097489197a12", "message": "Script for finding groups inconsistencies\n\n- In perun db was created new script find_groups_inconsistencies,\n  which checks wheter there are groups with some relationship where\n  subgroup contains a member which does not exists in the parent group as\n  Indirect.\n- In order to use the scrip, following commnads need to be executed on\n  machine:\n  apt install libdbi-perl\n  apt install libdbd-pg-perl", "committedDate": "2020-10-13T14:05:24Z", "type": "commit"}, {"oid": "2402ba4f03b1c06dcd3fb9d3a3c2097489197a12", "url": "https://github.com/CESNET/perun/commit/2402ba4f03b1c06dcd3fb9d3a3c2097489197a12", "message": "Script for finding groups inconsistencies\n\n- In perun db was created new script find_groups_inconsistencies,\n  which checks wheter there are groups with some relationship where\n  subgroup contains a member which does not exists in the parent group as\n  Indirect.\n- In order to use the scrip, following commnads need to be executed on\n  machine:\n  apt install libdbi-perl\n  apt install libdbd-pg-perl", "committedDate": "2020-10-13T14:05:24Z", "type": "forcePushed"}]}