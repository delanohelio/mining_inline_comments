{"pr_number": 2979, "pr_title": "add new JSONLITE serializer to rpc", "pr_createdAt": "2020-11-10T14:10:51Z", "pr_url": "https://github.com/CESNET/perun/pull/2979", "timeline": [{"oid": "e3c1dc622f9de7d7a11269e629b573741a580034", "url": "https://github.com/CESNET/perun/commit/e3c1dc622f9de7d7a11269e629b573741a580034", "message": "add new JSONLITE serializer to rpc", "committedDate": "2020-11-10T13:41:46Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDY0ODc5Mg==", "url": "https://github.com/CESNET/perun/pull/2979#discussion_r520648792", "bodyText": "I know it is a copy, but we should use English here.", "author": "stavamichal", "createdAt": "2020-11-10T15:25:22Z", "path": "perun-base/src/main/java/cz/metacentrum/perun/rpc/serializer/JsonSerializerJSONLITE.java", "diffHunk": "@@ -0,0 +1,234 @@\n+package cz.metacentrum.perun.rpc.serializer;\n+\n+import com.fasterxml.jackson.annotation.JsonIgnore;\n+import com.fasterxml.jackson.annotation.JsonIgnoreProperties;\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+import com.fasterxml.jackson.core.JsonEncoding;\n+import com.fasterxml.jackson.core.JsonFactory;\n+import com.fasterxml.jackson.core.JsonGenerator;\n+import com.fasterxml.jackson.core.JsonProcessingException;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.fasterxml.jackson.databind.annotation.JsonSerialize;\n+import cz.metacentrum.perun.cabinet.model.Author;\n+import cz.metacentrum.perun.cabinet.model.Authorship;\n+import cz.metacentrum.perun.cabinet.model.Category;\n+import cz.metacentrum.perun.cabinet.model.Publication;\n+import cz.metacentrum.perun.cabinet.model.Thanks;\n+import cz.metacentrum.perun.core.api.*;\n+import cz.metacentrum.perun.core.api.exceptions.PerunException;\n+import cz.metacentrum.perun.core.api.exceptions.rt.PerunRuntimeException;\n+import cz.metacentrum.perun.core.api.exceptions.RpcException;\n+import cz.metacentrum.perun.taskslib.model.Task;\n+\n+import java.io.IOException;\n+import java.io.OutputStream;\n+import java.time.LocalDateTime;\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+/**\n+ * JSON lite serializer which strips auditing data from Perun beans.\n+ *\n+ * @author Pavel Zl\u00e1mal <zlamal@cesnet.cz>\n+ * @author Michal Voc\u016f <vocu@cesnet.cz>\n+ */\n+public final class JsonSerializerJSONLITE implements Serializer {\n+\n+\t@JsonIgnoreProperties({\n+\t\t\"createdAt\", \"createdBy\", \"modifiedAt\", \"modifiedBy\", \n+\t\t\"createdByUid\",\t\"modifiedByUid\", \n+\t\t\"valueCreatedAt\", \"valueCreatedBy\", \"valueModifiedAt\", \"valueModifiedBy\", \n+\t\t\"beanName\"\n+\t\t})\n+\tprivate interface AttributeMixIn {\n+\t}\n+\n+\t@JsonIgnoreProperties({\n+\t\t\"createdAt\", \"createdBy\", \"modifiedAt\", \"modifiedBy\", \n+\t\t\"createdByUid\",\t\"modifiedByUid\", \n+\t\t\"beanName\" \n+\t\t})\n+\tprivate interface AttributeDefinitionMixIn {\n+\t}\n+\n+\t@JsonIgnoreProperties({\n+\t\t\"createdAt\", \"createdBy\", \"modifiedAt\", \"modifiedBy\",\n+\t\t\"createdByUid\", \"modifiedByUid\", \n+\t\t\"beanName\"\n+\t\t})\n+\tprivate interface UserMixIn {\n+\t}\n+\n+\t@JsonIgnoreProperties({\"beanName\"})\n+\tprivate interface ExceptionMixIn {\n+\t}\n+\n+\t@JsonIgnoreProperties({\"beanName\"})\n+\tprivate interface CandidateMixIn {\n+\t}\n+\n+\t@JsonIgnoreProperties({\n+\t\t\"createdAt\", \"createdBy\", \"modifiedAt\", \"modifiedBy\", \n+\t\t\"createdByUid\", \"modifiedByUid\", \n+\t\t\"beanName\"\n+\t\t})\n+\tprivate interface PerunBeanMixIn {\n+\t}\n+\n+\t@JsonIgnoreProperties({\"beanName\"})\n+\tprivate interface PerunRequestMixIn {\n+\t}\n+\n+\t/* FOR Cabinet PerunBeans we need createdBy etc. data */\n+\t@JsonIgnoreProperties({})\n+\tprivate interface CabinetMixIn {\n+\t}\n+\n+\t@SuppressWarnings(\"unused\")\n+\tprivate interface TaskMixIn {\n+\t\t@JsonSerialize\n+\t\t@JsonProperty(value = \"startTime\")\n+\t\tLong getStartTimeAsLong();\n+\n+\t\t@JsonIgnore\n+\t\tLocalDateTime getStartTime();\n+\n+\t\t@JsonSerialize\n+\t\t@JsonProperty(value = \"schedule\")\n+\t\tLong getScheduleAsLong();\n+\n+\t\t@JsonIgnore\n+\t\tLocalDateTime getSchedule();\n+\n+\t\t@JsonSerialize\n+\t\t@JsonProperty(value = \"genEndTime\")\n+\t\tLong getGenEndTimeAsLong();\n+\n+\t\t@JsonIgnore\n+\t\tLocalDateTime getGenEndTime();\n+\n+\t\t@JsonSerialize\n+\t\t@JsonProperty(value = \"sendEndTime\")\n+\t\tLong getSendEndTimeAsLong();\n+\n+\t\t@JsonIgnore\n+\t\tLocalDateTime getSendEndTime();\n+\n+\t\t@JsonSerialize\n+\t\t@JsonProperty(value = \"sendStartTime\")\n+\t\tLong getSendStartTimeAsLong();\n+\n+\t\t@JsonIgnore\n+\t\tLocalDateTime getSendStartTime();\n+\n+\t\t@JsonSerialize\n+\t\t@JsonProperty(value = \"genStartTime\")\n+\t\tLong getGenStartTimeAsLong();\n+\n+\t\t@JsonIgnore\n+\t\tLocalDateTime getGenStartTime();\n+\n+\t\t@JsonSerialize\n+\t\t@JsonProperty(value = \"sentToEngine\")\n+\t\tLong getSentToEngineAsLong();\n+\n+\t\t@JsonIgnore\n+\t\tLocalDateTime getSentToEngine();\n+\n+\t\t@JsonSerialize\n+\t\t@JsonProperty(value = \"endTime\")\n+\t\tLong getEndTimeAsLong();\n+\n+\t\t@JsonIgnore\n+\t\tLocalDateTime getEndTime();\n+\t}\n+\n+\tpublic static final String CONTENT_TYPE = \"application/json; charset=utf-8\";\n+\tprivate static final ObjectMapper mapper = new ObjectMapper();\n+\tprivate static final Map<Class<?>,Class<?>> mixinMap = new HashMap<>();\n+\n+\tstatic {\n+\t\tmixinMap.put(Attribute.class, AttributeMixIn.class);\n+\t\tmixinMap.put(AttributeDefinition.class, AttributeDefinitionMixIn.class);\n+\t\tmixinMap.put(User.class, UserMixIn.class);\n+\t\tmixinMap.put(Candidate.class, CandidateMixIn.class);\n+\t\tmixinMap.put(PerunException.class, ExceptionMixIn.class);\n+\t\tmixinMap.put(PerunRuntimeException.class, ExceptionMixIn.class);\n+\t\tmixinMap.put(PerunBean.class, PerunBeanMixIn.class);\n+\t\tmixinMap.put(PerunRequest.class, PerunRequestMixIn.class);\n+\t\tmixinMap.put(Authorship.class, CabinetMixIn.class);\n+\t\tmixinMap.put(Author.class, CabinetMixIn.class);\n+\t\tmixinMap.put(Category.class, CabinetMixIn.class);\n+\t\tmixinMap.put(Publication.class, CabinetMixIn.class);\n+\t\tmixinMap.put(Thanks.class, CabinetMixIn.class);\n+\t\tmixinMap.put(Task.class, TaskMixIn.class);\n+\n+\t\tmapper.setMixIns(mixinMap);\n+\t}\n+\n+\tprivate static final JsonFactory jsonFactory = new JsonFactory();\n+\n+\tstatic {\n+\t\t//FIXME odstraneno disable(JsonGenerator.Feature.FLUSH_PASSED_TO_STREAM)", "originalCommit": "e3c1dc622f9de7d7a11269e629b573741a580034", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTI3MTc0OA==", "url": "https://github.com/CESNET/perun/pull/2979#discussion_r521271748", "bodyText": "Updated.", "author": "mvocu", "createdAt": "2020-11-11T10:47:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDY0ODc5Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDY1MDU0MA==", "url": "https://github.com/CESNET/perun/pull/2979#discussion_r520650540", "bodyText": "Method \"jsonFactory.createJsonGenerator()\" is deprecated. Is there any chance to change that without great effort?", "author": "stavamichal", "createdAt": "2020-11-10T15:27:32Z", "path": "perun-base/src/main/java/cz/metacentrum/perun/rpc/serializer/JsonSerializerJSONLITE.java", "diffHunk": "@@ -0,0 +1,234 @@\n+package cz.metacentrum.perun.rpc.serializer;\n+\n+import com.fasterxml.jackson.annotation.JsonIgnore;\n+import com.fasterxml.jackson.annotation.JsonIgnoreProperties;\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+import com.fasterxml.jackson.core.JsonEncoding;\n+import com.fasterxml.jackson.core.JsonFactory;\n+import com.fasterxml.jackson.core.JsonGenerator;\n+import com.fasterxml.jackson.core.JsonProcessingException;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.fasterxml.jackson.databind.annotation.JsonSerialize;\n+import cz.metacentrum.perun.cabinet.model.Author;\n+import cz.metacentrum.perun.cabinet.model.Authorship;\n+import cz.metacentrum.perun.cabinet.model.Category;\n+import cz.metacentrum.perun.cabinet.model.Publication;\n+import cz.metacentrum.perun.cabinet.model.Thanks;\n+import cz.metacentrum.perun.core.api.*;\n+import cz.metacentrum.perun.core.api.exceptions.PerunException;\n+import cz.metacentrum.perun.core.api.exceptions.rt.PerunRuntimeException;\n+import cz.metacentrum.perun.core.api.exceptions.RpcException;\n+import cz.metacentrum.perun.taskslib.model.Task;\n+\n+import java.io.IOException;\n+import java.io.OutputStream;\n+import java.time.LocalDateTime;\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+/**\n+ * JSON lite serializer which strips auditing data from Perun beans.\n+ *\n+ * @author Pavel Zl\u00e1mal <zlamal@cesnet.cz>\n+ * @author Michal Voc\u016f <vocu@cesnet.cz>\n+ */\n+public final class JsonSerializerJSONLITE implements Serializer {\n+\n+\t@JsonIgnoreProperties({\n+\t\t\"createdAt\", \"createdBy\", \"modifiedAt\", \"modifiedBy\", \n+\t\t\"createdByUid\",\t\"modifiedByUid\", \n+\t\t\"valueCreatedAt\", \"valueCreatedBy\", \"valueModifiedAt\", \"valueModifiedBy\", \n+\t\t\"beanName\"\n+\t\t})\n+\tprivate interface AttributeMixIn {\n+\t}\n+\n+\t@JsonIgnoreProperties({\n+\t\t\"createdAt\", \"createdBy\", \"modifiedAt\", \"modifiedBy\", \n+\t\t\"createdByUid\",\t\"modifiedByUid\", \n+\t\t\"beanName\" \n+\t\t})\n+\tprivate interface AttributeDefinitionMixIn {\n+\t}\n+\n+\t@JsonIgnoreProperties({\n+\t\t\"createdAt\", \"createdBy\", \"modifiedAt\", \"modifiedBy\",\n+\t\t\"createdByUid\", \"modifiedByUid\", \n+\t\t\"beanName\"\n+\t\t})\n+\tprivate interface UserMixIn {\n+\t}\n+\n+\t@JsonIgnoreProperties({\"beanName\"})\n+\tprivate interface ExceptionMixIn {\n+\t}\n+\n+\t@JsonIgnoreProperties({\"beanName\"})\n+\tprivate interface CandidateMixIn {\n+\t}\n+\n+\t@JsonIgnoreProperties({\n+\t\t\"createdAt\", \"createdBy\", \"modifiedAt\", \"modifiedBy\", \n+\t\t\"createdByUid\", \"modifiedByUid\", \n+\t\t\"beanName\"\n+\t\t})\n+\tprivate interface PerunBeanMixIn {\n+\t}\n+\n+\t@JsonIgnoreProperties({\"beanName\"})\n+\tprivate interface PerunRequestMixIn {\n+\t}\n+\n+\t/* FOR Cabinet PerunBeans we need createdBy etc. data */\n+\t@JsonIgnoreProperties({})\n+\tprivate interface CabinetMixIn {\n+\t}\n+\n+\t@SuppressWarnings(\"unused\")\n+\tprivate interface TaskMixIn {\n+\t\t@JsonSerialize\n+\t\t@JsonProperty(value = \"startTime\")\n+\t\tLong getStartTimeAsLong();\n+\n+\t\t@JsonIgnore\n+\t\tLocalDateTime getStartTime();\n+\n+\t\t@JsonSerialize\n+\t\t@JsonProperty(value = \"schedule\")\n+\t\tLong getScheduleAsLong();\n+\n+\t\t@JsonIgnore\n+\t\tLocalDateTime getSchedule();\n+\n+\t\t@JsonSerialize\n+\t\t@JsonProperty(value = \"genEndTime\")\n+\t\tLong getGenEndTimeAsLong();\n+\n+\t\t@JsonIgnore\n+\t\tLocalDateTime getGenEndTime();\n+\n+\t\t@JsonSerialize\n+\t\t@JsonProperty(value = \"sendEndTime\")\n+\t\tLong getSendEndTimeAsLong();\n+\n+\t\t@JsonIgnore\n+\t\tLocalDateTime getSendEndTime();\n+\n+\t\t@JsonSerialize\n+\t\t@JsonProperty(value = \"sendStartTime\")\n+\t\tLong getSendStartTimeAsLong();\n+\n+\t\t@JsonIgnore\n+\t\tLocalDateTime getSendStartTime();\n+\n+\t\t@JsonSerialize\n+\t\t@JsonProperty(value = \"genStartTime\")\n+\t\tLong getGenStartTimeAsLong();\n+\n+\t\t@JsonIgnore\n+\t\tLocalDateTime getGenStartTime();\n+\n+\t\t@JsonSerialize\n+\t\t@JsonProperty(value = \"sentToEngine\")\n+\t\tLong getSentToEngineAsLong();\n+\n+\t\t@JsonIgnore\n+\t\tLocalDateTime getSentToEngine();\n+\n+\t\t@JsonSerialize\n+\t\t@JsonProperty(value = \"endTime\")\n+\t\tLong getEndTimeAsLong();\n+\n+\t\t@JsonIgnore\n+\t\tLocalDateTime getEndTime();\n+\t}\n+\n+\tpublic static final String CONTENT_TYPE = \"application/json; charset=utf-8\";\n+\tprivate static final ObjectMapper mapper = new ObjectMapper();\n+\tprivate static final Map<Class<?>,Class<?>> mixinMap = new HashMap<>();\n+\n+\tstatic {\n+\t\tmixinMap.put(Attribute.class, AttributeMixIn.class);\n+\t\tmixinMap.put(AttributeDefinition.class, AttributeDefinitionMixIn.class);\n+\t\tmixinMap.put(User.class, UserMixIn.class);\n+\t\tmixinMap.put(Candidate.class, CandidateMixIn.class);\n+\t\tmixinMap.put(PerunException.class, ExceptionMixIn.class);\n+\t\tmixinMap.put(PerunRuntimeException.class, ExceptionMixIn.class);\n+\t\tmixinMap.put(PerunBean.class, PerunBeanMixIn.class);\n+\t\tmixinMap.put(PerunRequest.class, PerunRequestMixIn.class);\n+\t\tmixinMap.put(Authorship.class, CabinetMixIn.class);\n+\t\tmixinMap.put(Author.class, CabinetMixIn.class);\n+\t\tmixinMap.put(Category.class, CabinetMixIn.class);\n+\t\tmixinMap.put(Publication.class, CabinetMixIn.class);\n+\t\tmixinMap.put(Thanks.class, CabinetMixIn.class);\n+\t\tmixinMap.put(Task.class, TaskMixIn.class);\n+\n+\t\tmapper.setMixIns(mixinMap);\n+\t}\n+\n+\tprivate static final JsonFactory jsonFactory = new JsonFactory();\n+\n+\tstatic {\n+\t\t//FIXME odstraneno disable(JsonGenerator.Feature.FLUSH_PASSED_TO_STREAM)\n+\t\tjsonFactory\n+\t\t\t.disable(JsonGenerator.Feature.AUTO_CLOSE_TARGET)\n+\t\t\t.disable(JsonGenerator.Feature.AUTO_CLOSE_JSON_CONTENT)\n+\t\t\t.setCodec(mapper);\n+\t}\n+\n+\tprivate OutputStream out;\n+\n+\t/**\n+\t * @param out {@code OutputStream} to output serialized data\n+\t * @throws IOException if an IO error occurs\n+\t */\n+\tpublic JsonSerializerJSONLITE(OutputStream out) throws IOException {\n+\t\tthis.out = out;\n+\t}\n+\n+\t@Override\n+\tpublic String getContentType() {\n+\t\treturn CONTENT_TYPE;\n+\t}\n+\n+\t@Override\n+\tpublic void write(Object object) throws IOException {\n+\t\tJsonGenerator gen = jsonFactory.createJsonGenerator(out, JsonEncoding.UTF8);", "originalCommit": "e3c1dc622f9de7d7a11269e629b573741a580034", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTI4MTE4Mw==", "url": "https://github.com/CESNET/perun/pull/2979#discussion_r521281183", "bodyText": "Done.", "author": "mvocu", "createdAt": "2020-11-11T11:04:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDY1MDU0MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDc2MDQ2Mg==", "url": "https://github.com/CESNET/perun/pull/2979#discussion_r520760462", "bodyText": "We should probably keep standard ignored properties from JsonSerializer and only add newly requested ignores.\n\t@JsonIgnoreProperties({\"name\"})\n\tprivate interface AttributeMixIn {\n\t}\n\n\t@JsonIgnoreProperties({\"name\"})\n\tprivate interface AttributeDefinitionMixIn {\n\t}\n\n\t@JsonIgnoreProperties({\"commonName\", \"displayName\"})\n\tprivate interface UserMixIn {\n\t}\n\n\t@JsonIgnoreProperties({\"userExtSources\"})\n\tprivate interface CandidateMixIn {\n\t}\n\n\t@JsonIgnoreProperties({\"cause\", \"localizedMessage\", \"stackTrace\"})\n\tprivate interface PerunExceptionMixIn {\n\t}", "author": "zlamalp", "createdAt": "2020-11-10T17:57:58Z", "path": "perun-base/src/main/java/cz/metacentrum/perun/rpc/serializer/JsonSerializerJSONLITE.java", "diffHunk": "@@ -0,0 +1,234 @@\n+package cz.metacentrum.perun.rpc.serializer;\n+\n+import com.fasterxml.jackson.annotation.JsonIgnore;\n+import com.fasterxml.jackson.annotation.JsonIgnoreProperties;\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+import com.fasterxml.jackson.core.JsonEncoding;\n+import com.fasterxml.jackson.core.JsonFactory;\n+import com.fasterxml.jackson.core.JsonGenerator;\n+import com.fasterxml.jackson.core.JsonProcessingException;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.fasterxml.jackson.databind.annotation.JsonSerialize;\n+import cz.metacentrum.perun.cabinet.model.Author;\n+import cz.metacentrum.perun.cabinet.model.Authorship;\n+import cz.metacentrum.perun.cabinet.model.Category;\n+import cz.metacentrum.perun.cabinet.model.Publication;\n+import cz.metacentrum.perun.cabinet.model.Thanks;\n+import cz.metacentrum.perun.core.api.*;\n+import cz.metacentrum.perun.core.api.exceptions.PerunException;\n+import cz.metacentrum.perun.core.api.exceptions.rt.PerunRuntimeException;\n+import cz.metacentrum.perun.core.api.exceptions.RpcException;\n+import cz.metacentrum.perun.taskslib.model.Task;\n+\n+import java.io.IOException;\n+import java.io.OutputStream;\n+import java.time.LocalDateTime;\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+/**\n+ * JSON lite serializer which strips auditing data from Perun beans.\n+ *\n+ * @author Pavel Zl\u00e1mal <zlamal@cesnet.cz>\n+ * @author Michal Voc\u016f <vocu@cesnet.cz>\n+ */\n+public final class JsonSerializerJSONLITE implements Serializer {\n+\n+\t@JsonIgnoreProperties({", "originalCommit": "e3c1dc622f9de7d7a11269e629b573741a580034", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTI3MTUyMw==", "url": "https://github.com/CESNET/perun/pull/2979#discussion_r521271523", "bodyText": "Added.", "author": "mvocu", "createdAt": "2020-11-11T10:46:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDc2MDQ2Mg=="}], "type": "inlineReview"}, {"oid": "32cec1f098bccea9aedc955a9ab44539284a4fa4", "url": "https://github.com/CESNET/perun/commit/32cec1f098bccea9aedc955a9ab44539284a4fa4", "message": "add standard ignores from JsonSerializer", "committedDate": "2020-11-11T10:41:31Z", "type": "commit"}, {"oid": "07dfd039a239b24b29c849578fd9f845b1555f7a", "url": "https://github.com/CESNET/perun/commit/07dfd039a239b24b29c849578fd9f845b1555f7a", "message": "replace deprecated method calls according to Jackson Javadocs", "committedDate": "2020-11-11T11:03:40Z", "type": "commit"}]}