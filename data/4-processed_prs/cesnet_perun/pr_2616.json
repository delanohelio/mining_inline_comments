{"pr_number": 2616, "pr_title": "New authorization in GroupsManagerEntry", "pr_createdAt": "2020-03-10T12:46:44Z", "pr_url": "https://github.com/CESNET/perun/pull/2616", "timeline": [{"oid": "d076c5bdac313f2989d10b13ce60fd5508d5ef87", "url": "https://github.com/CESNET/perun/commit/d076c5bdac313f2989d10b13ce60fd5508d5ef87", "message": "New authorization in GroupsManagerEntry\n\n- In GroupsManagerEntry was completely replaced the old authorization.\n- For that purpose was updated also perun-roles.yml file with the\n  policies used in the GroupsManagerEntry.\n- All PerunBeans which are passed to the methods and already exist in\n  Perun are passed also to the authorization, even when a policy does not\n  need them for now. It does not have any effect on the policy evaluation.\n  It erase the necessity to change these methods if the policy will change\n  in the future.", "committedDate": "2020-03-10T12:50:06Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzA0OTY0MA==", "url": "https://github.com/CESNET/perun/pull/2616#discussion_r393049640", "bodyText": "There should be \"removeMember\".", "author": "stavamichal", "createdAt": "2020-03-16T14:11:10Z", "path": "perun-core/src/main/java/cz/metacentrum/perun/core/entry/GroupsManagerEntry.java", "diffHunk": "@@ -454,6 +441,14 @@ public void removeMember(PerunSession sess, Member member, List<Group> groups) t\n \t\t\t}\n \t\t}\n \t\tgetPerunBl().getMembersManagerBl().checkMemberExists(sess, member);\n+\n+\t\t// Authorization\n+\t\tList<PerunBean> beans = new ArrayList<>(groups);\n+\t\tbeans.add(member);\n+\t\tif (!AuthzResolver.authorizedInternal(sess, \"removeMember_Member_List<Group>_policy\", beans)) {\n+\t\t\tthrow new PrivilegeException(sess, \"addMember\");", "originalCommit": "d076c5bdac313f2989d10b13ce60fd5508d5ef87", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTUzOTYyNw==", "url": "https://github.com/CESNET/perun/pull/2616#discussion_r395539627", "bodyText": "Fixed", "author": "balcirakpeter", "createdAt": "2020-03-20T10:08:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzA0OTY0MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzA3Njc3Ng==", "url": "https://github.com/CESNET/perun/pull/2616#discussion_r393076776", "bodyText": "There is something missing, right?", "author": "stavamichal", "createdAt": "2020-03-16T14:42:24Z", "path": "perun-core/src/main/java/cz/metacentrum/perun/core/entry/GroupsManagerEntry.java", "diffHunk": "@@ -881,37 +823,16 @@ public void removeAdmin(PerunSession sess, Group group, Group authorizedGroup) t\n \n \t\tList<Group> groups = getGroupsManagerBl().getAllGroups(sess, vo);\n \n-\t\t// Return all groups for VOADMIN and PERUNADMIN\n-\t\tif (AuthzResolver.isAuthorized(sess, Role.VOADMIN, vo)\n-\t\t\t\t|| AuthzResolver.isAuthorized(sess, Role.VOOBSERVER, vo)\n-\t\t\t\t|| AuthzResolver.hasRole(sess.getPerunPrincipal(), Role.PERUNADMIN)) {\n-\t\t\treturn groups;\n-\t\t\t\t}\n-\n-\t\t// Check access rights for each group for GROUPADMIN\n-\t\tif (AuthzResolver.hasRole(sess.getPerunPrincipal(), Role.GROUPADMIN)) {\n-\t\t\tIterator<Group> eachGroup = groups.iterator();\n-\t\t\twhile (eachGroup.hasNext()) {\n-\t\t\t\tif (!AuthzResolver.isAuthorized(sess, Role.GROUPADMIN, eachGroup.next())) {\n-\t\t\t\t\teachGroup.remove();\n-\t\t\t\t}\n-\t\t\t}\n-\t\t\treturn groups;\n-\t\t}\n-\n-\t\t// This shouldn't happen\n-\t\tthrow new PrivilegeException(sess, \"getAllGroups\");\n+\t\tgroups.removeIf(group -> !AuthzResolver.authorizedInternal(sess, \"filter-getAllGroups_Vo_policy\", Collections.singletonList(group)));\n+\t\treturn groups;\n \t}\n \n \t@Override\n \tpublic Map<Group, Object> getAllGroupsWithHierarchy(PerunSession sess, Vo vo) throws InternalErrorException, PrivilegeException, VoNotExistsException {\n \t\tUtils.checkPerunSession(sess);\n \n \t\t// Authorization\n-\t\tif (!AuthzResolver.isAuthorized(sess, Role.VOADMIN, vo) &&\n-\t\t\t\t!AuthzResolver.isAuthorized(sess, Role.VOOBSERVER, vo) &&\n-\t\t\t\t!AuthzResolver.isAuthorized(sess, Role.GROUPADMIN) &&\n-\t\t\t\t!AuthzResolver.isAuthorized(sess, Role.PERUNOBSERVER)) {\n+\t\tif (!AuthzResolver.authorizedInternal(sess, \"\", Collections.singletonList(vo))) {", "originalCommit": "d076c5bdac313f2989d10b13ce60fd5508d5ef87", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTUzOTY4MQ==", "url": "https://github.com/CESNET/perun/pull/2616#discussion_r395539681", "bodyText": "Fixed", "author": "balcirakpeter", "createdAt": "2020-03-20T10:09:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzA3Njc3Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzA4NTQ0OQ==", "url": "https://github.com/CESNET/perun/pull/2616#discussion_r393085449", "bodyText": "Missing policy name.", "author": "stavamichal", "createdAt": "2020-03-16T14:54:24Z", "path": "perun-core/src/main/java/cz/metacentrum/perun/core/entry/GroupsManagerEntry.java", "diffHunk": "@@ -1390,27 +1205,13 @@ public void synchronizeGroupsStructures(PerunSession sess) throws InternalErrorE\n \t\tVo vo = getPerunBl().getMembersManagerBl().getMemberVo(sess, member);\n \n \t\t// Authorization\n-\t\tif (!AuthzResolver.isAuthorized(sess, Role.VOADMIN, vo)\n-\t\t\t&& !AuthzResolver.isAuthorized(sess, Role.VOOBSERVER, vo)\n-\t\t\t&& !AuthzResolver.isAuthorized(sess, Role.GROUPADMIN, vo)\n-\t\t\t&& !AuthzResolver.isAuthorized(sess, Role.PERUNOBSERVER)) {\n+\t\tif (!AuthzResolver.authorizedInternal(sess, \"\", Collections.singletonList(member))) {", "originalCommit": "d076c5bdac313f2989d10b13ce60fd5508d5ef87", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTUzOTc1OQ==", "url": "https://github.com/CESNET/perun/pull/2616#discussion_r395539759", "bodyText": "Fixed", "author": "balcirakpeter", "createdAt": "2020-03-20T10:09:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzA4NTQ0OQ=="}], "type": "inlineReview"}, {"oid": "14a00280e42c73be1109dffd8ef59fe2dd44daf7", "url": "https://github.com/CESNET/perun/commit/14a00280e42c73be1109dffd8ef59fe2dd44daf7", "message": "New authorization in GroupsManagerEntry\n\n- In GroupsManagerEntry was completely replaced the old authorization.\n- For that purpose was updated also perun-roles.yml file with the\n  policies used in the GroupsManagerEntry.\n- All PerunBeans which are passed to the methods and already exist in\n  Perun are passed also to the authorization, even when a policy does not\n  need them for now. It does not have any effect on the policy evaluation.\n  It erase the necessity to change these methods if the policy will change\n  in the future.\n- Entity existence checks moved before authorization and added missing checks.", "committedDate": "2020-03-20T10:05:29Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjQ3MTU2Nw==", "url": "https://github.com/CESNET/perun/pull/2616#discussion_r416471567", "bodyText": "It should be possible to merge these two calls into a single one.", "author": "Vojtech-Sassmann", "createdAt": "2020-04-28T09:34:38Z", "path": "perun-core/src/main/java/cz/metacentrum/perun/core/entry/GroupsManagerEntry.java", "diffHunk": "@@ -1535,8 +1283,8 @@ public Group createGroupUnion(PerunSession sess, Group resultGroup, Group operan\n \t\t}\n \n \t\t// Authorization\n-\t\tif ((!AuthzResolver.isAuthorized(sess, Role.VOADMIN, resultGroup) && !AuthzResolver.isAuthorized(sess, Role.GROUPADMIN, resultGroup)) ||\n-\t\t\t\t(!AuthzResolver.isAuthorized(sess, Role.VOADMIN, operandGroup) && !AuthzResolver.isAuthorized(sess, Role.GROUPADMIN, operandGroup))) {\n+\t\tif ((!AuthzResolver.authorizedInternal(sess, \"createGroupUnion_Group_Group_policy\", Collections.singletonList(resultGroup))) ||\n+\t\t\t\t(!AuthzResolver.authorizedInternal(sess, \"createGroupUnion_Group_Group_policy\", Collections.singletonList(operandGroup)))) {", "originalCommit": "14a00280e42c73be1109dffd8ef59fe2dd44daf7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzU4NTA1MA==", "url": "https://github.com/CESNET/perun/pull/2616#discussion_r453585050", "bodyText": "Done", "author": "balcirakpeter", "createdAt": "2020-07-13T11:32:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjQ3MTU2Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjQ3MTc1Mw==", "url": "https://github.com/CESNET/perun/pull/2616#discussion_r416471753", "bodyText": "Same here.", "author": "Vojtech-Sassmann", "createdAt": "2020-04-28T09:34:57Z", "path": "perun-core/src/main/java/cz/metacentrum/perun/core/entry/GroupsManagerEntry.java", "diffHunk": "@@ -1554,8 +1302,8 @@ public void removeGroupUnion(PerunSession sess, Group resultGroup, Group operand\n \t\t}\n \n \t\t// Authorization\n-\t\tif ( (!AuthzResolver.isAuthorized(sess, Role.VOADMIN, resultGroup) && !AuthzResolver.isAuthorized(sess, Role.GROUPADMIN, resultGroup)) ||\n-\t\t\t\t(!AuthzResolver.isAuthorized(sess, Role.VOADMIN, operandGroup) && !AuthzResolver.isAuthorized(sess, Role.GROUPADMIN, operandGroup)) ) {\n+\t\tif ( (!AuthzResolver.authorizedInternal(sess, \"removeGroupUnion_Group_Group_policy\", Collections.singletonList(resultGroup))) ||\n+\t\t\t(!AuthzResolver.authorizedInternal(sess, \"removeGroupUnion_Group_Group_policy\", Collections.singletonList(operandGroup)))) {", "originalCommit": "14a00280e42c73be1109dffd8ef59fe2dd44daf7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzU4NTExMQ==", "url": "https://github.com/CESNET/perun/pull/2616#discussion_r453585111", "bodyText": "Done", "author": "balcirakpeter", "createdAt": "2020-07-13T11:32:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjQ3MTc1Mw=="}], "type": "inlineReview"}, {"oid": "9f6752ea09f2283a0db9f6ee56da46c14236a8c4", "url": "https://github.com/CESNET/perun/commit/9f6752ea09f2283a0db9f6ee56da46c14236a8c4", "message": "New authorization in GroupsManagerEntry\n\n- In GroupsManagerEntry was completely replaced the old authorization.\n- For that purpose was updated also perun-roles.yml file with the\n  policies used in the GroupsManagerEntry.\n- All PerunBeans which are passed to the methods and already exist in\n  Perun are passed also to the authorization, even when a policy does not\n  need them for now. It does not have any effect on the policy evaluation.\n  It erase the necessity to change these methods if the policy will change\n  in the future.\n- Entity existence checks moved before authorization and added missing checks.", "committedDate": "2020-07-13T11:26:49Z", "type": "forcePushed"}, {"oid": "97d5fcd6eef6981fd164300a051b50d4995b6743", "url": "https://github.com/CESNET/perun/commit/97d5fcd6eef6981fd164300a051b50d4995b6743", "message": "New authorization in GroupsManagerEntry\n\n- In GroupsManagerEntry was completely replaced the old authorization.\n- For that purpose was updated also perun-roles.yml file with the\n  policies used in the GroupsManagerEntry.\n- All PerunBeans which are passed to the methods and already exist in\n  Perun are passed also to the authorization, even when a policy does not\n  need them for now. It does not have any effect on the policy evaluation.\n  It erase the necessity to change these methods if the policy will change\n  in the future.\n- Entity existence checks moved before authorization and added missing checks.", "committedDate": "2020-07-13T11:58:01Z", "type": "commit"}, {"oid": "97d5fcd6eef6981fd164300a051b50d4995b6743", "url": "https://github.com/CESNET/perun/commit/97d5fcd6eef6981fd164300a051b50d4995b6743", "message": "New authorization in GroupsManagerEntry\n\n- In GroupsManagerEntry was completely replaced the old authorization.\n- For that purpose was updated also perun-roles.yml file with the\n  policies used in the GroupsManagerEntry.\n- All PerunBeans which are passed to the methods and already exist in\n  Perun are passed also to the authorization, even when a policy does not\n  need them for now. It does not have any effect on the policy evaluation.\n  It erase the necessity to change these methods if the policy will change\n  in the future.\n- Entity existence checks moved before authorization and added missing checks.", "committedDate": "2020-07-13T11:58:01Z", "type": "forcePushed"}]}