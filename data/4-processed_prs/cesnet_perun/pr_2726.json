{"pr_number": 2726, "pr_title": "Added new object EnrichedHost and new method getEnrichedHosts", "pr_createdAt": "2020-06-03T12:22:29Z", "pr_url": "https://github.com/CESNET/perun/pull/2726", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDU2MTI0MQ==", "url": "https://github.com/CESNET/perun/pull/2726#discussion_r434561241", "bodyText": "Add information to javadoc, that empty list will return no attributes. In some specific cases we have exactly different behavior (where empty means all). Same for other layers (impl, api, rpc).", "author": "stavamichal", "createdAt": "2020-06-03T13:21:45Z", "path": "perun-core/src/main/java/cz/metacentrum/perun/core/bl/AttributesManagerBl.java", "diffHunk": "@@ -491,6 +491,18 @@\n \t */\n \tList<Attribute> getAttributes(PerunSession sess, Host host) throws InternalErrorException;\n \n+\t/**\n+\t * Get all attributes associated with the host which have name in list attrNames (empty and virtual too).\n+\t *", "originalCommit": "b351f6070635efe396e76279aa595f5df432c9d1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDU2MTY2Ng==", "url": "https://github.com/CESNET/perun/pull/2726#discussion_r434561666", "bodyText": "'to get attributes for' Same for other layers (impl, api, rpc).", "author": "stavamichal", "createdAt": "2020-06-03T13:22:25Z", "path": "perun-core/src/main/java/cz/metacentrum/perun/core/bl/AttributesManagerBl.java", "diffHunk": "@@ -491,6 +491,18 @@\n \t */\n \tList<Attribute> getAttributes(PerunSession sess, Host host) throws InternalErrorException;\n \n+\t/**\n+\t * Get all attributes associated with the host which have name in list attrNames (empty and virtual too).\n+\t *\n+\t * @param sess perun session\n+\t * @param host host to get attributes from", "originalCommit": "b351f6070635efe396e76279aa595f5df432c9d1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDU2MzgxMg==", "url": "https://github.com/CESNET/perun/pull/2726#discussion_r434563812", "bodyText": "You are not checking rights to get hosts for facility. You need to check it there or call method from api to correctly check rights.", "author": "stavamichal", "createdAt": "2020-06-03T13:25:32Z", "path": "perun-core/src/main/java/cz/metacentrum/perun/core/entry/FacilitiesManagerEntry.java", "diffHunk": "@@ -660,6 +662,30 @@ public void setPerunBl(PerunBl perunBl) {\n \t\treturn getFacilitiesManagerBl().getHosts(sess, facility);\n \t}\n \n+\t@Override\n+\tpublic List<EnrichedHost> getEnrichedHosts(PerunSession sess, Facility facility, List<String> attrNames) throws AttributeNotExistsException, FacilityNotExistsException {\n+\t\tUtils.checkPerunSession(sess);\n+\t\tgetFacilitiesManagerBl().checkFacilityExists(sess, facility);\n+\n+\t\tList<Host> hosts = getFacilitiesManagerBl().getHosts(sess, facility);", "originalCommit": "b351f6070635efe396e76279aa595f5df432c9d1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDU2NDEyMQ==", "url": "https://github.com/CESNET/perun/pull/2726#discussion_r434564121", "bodyText": "This could lead to null pointer exception if no hosts is on facility.", "author": "stavamichal", "createdAt": "2020-06-03T13:25:58Z", "path": "perun-core/src/main/java/cz/metacentrum/perun/core/entry/FacilitiesManagerEntry.java", "diffHunk": "@@ -660,6 +662,30 @@ public void setPerunBl(PerunBl perunBl) {\n \t\treturn getFacilitiesManagerBl().getHosts(sess, facility);\n \t}\n \n+\t@Override\n+\tpublic List<EnrichedHost> getEnrichedHosts(PerunSession sess, Facility facility, List<String> attrNames) throws AttributeNotExistsException, FacilityNotExistsException {\n+\t\tUtils.checkPerunSession(sess);\n+\t\tgetFacilitiesManagerBl().checkFacilityExists(sess, facility);\n+\n+\t\tList<Host> hosts = getFacilitiesManagerBl().getHosts(sess, facility);\n+\t\tHost host1 = hosts.get(0);", "originalCommit": "b351f6070635efe396e76279aa595f5df432c9d1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDU2NTAxNg==", "url": "https://github.com/CESNET/perun/pull/2726#discussion_r434565016", "bodyText": "Probably missing privileged exception and testing of rights for a user.", "author": "stavamichal", "createdAt": "2020-06-03T13:27:17Z", "path": "perun-core/src/main/java/cz/metacentrum/perun/core/api/FacilitiesManager.java", "diffHunk": "@@ -276,6 +276,19 @@\n \t */\n \tList<Host> getHosts(PerunSession sess, Facility facility) throws FacilityNotExistsException, InternalErrorException;\n \n+\t/**\n+\t * Return all EnrichedHosts of given facility. That is host with attributes given by attrNames.\n+\t *\n+\t * @param sess perun session\n+\t * @param facility facility\n+\t * @param attrNames attribute names\n+\t * @return list of enriched hosts\n+\t *\n+\t * @throws AttributeNotExistsException if some attribute does not exist\n+\t * @throws FacilityNotExistsException if facility does not exist\n+\t */\n+\tList<EnrichedHost> getEnrichedHosts(PerunSession sess, Facility facility, List<String> attrNames) throws AttributeNotExistsException, FacilityNotExistsException;", "originalCommit": "b351f6070635efe396e76279aa595f5df432c9d1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDYwMTg4Mw==", "url": "https://github.com/CESNET/perun/pull/2726#discussion_r434601883", "bodyText": "We have discussed this with @stavamichal, and we don't want to compare enriched hosts based on their attributes. We want to say that two enriched hosts are equal if they represent the same host. There are specific scenarios where also comparing attributes could lead to some troubles.", "author": "Vojtech-Sassmann", "createdAt": "2020-06-03T14:16:51Z", "path": "perun-base/src/main/java/cz/metacentrum/perun/core/api/EnrichedHost.java", "diffHunk": "@@ -0,0 +1,70 @@\n+package cz.metacentrum.perun.core.api;\n+\n+import java.util.Collections;\n+import java.util.List;\n+\n+/**\n+ * Host with list of all its attributes\n+ * @author Metodej Klang <metodej.klang@gmail.com>\n+ */\n+public class EnrichedHost {\n+\n+\tprivate Host host;\n+\tprivate List<Attribute> hostAttributes;\n+\n+\tpublic EnrichedHost(){\n+\t}\n+\n+\tpublic EnrichedHost(Host host, List<Attribute> hostAttributes) {\n+\t\tthis.host = host;\n+\t\tthis.hostAttributes = hostAttributes;\n+\t}\n+\n+\tpublic Host getHost() {\n+\t\treturn host;\n+\t}\n+\n+\tpublic List<Attribute> getHostAttributes() {\n+\t\treturn hostAttributes;\n+\t}\n+\n+\tpublic void setHost(Host host) {\n+\t\tthis.host = host;\n+\t}\n+\n+\tpublic void setHostAttributes(List<Attribute> hostAttributes) {\n+\t\tthis.hostAttributes = hostAttributes;\n+\t}\n+\n+\t@Override\n+\tpublic String toString() {\n+\t\tStringBuilder str = new StringBuilder();\n+\n+\t\treturn str.append(\"EnrichedHost:[host='\").append(host.toString()).append(\"', hostAttributes='\").append(hostAttributes).append(\"']\").toString();\n+\t}\n+\n+\t@Override\n+\tpublic boolean equals(Object obj) {\n+\t\tif (this == obj)\n+\t\t\treturn true;\n+\t\tif (obj == null)\n+\t\t\treturn false;\n+\t\tif (!(obj instanceof EnrichedHost))\n+\t\t\treturn false;\n+\t\tEnrichedHost other = (EnrichedHost) obj;\n+\t\tif (host == null) {\n+\t\t\tif (other.host != null)\n+\t\t\t\treturn false;\n+\t\t} else if (!host.equals(other.host))\n+\t\t\treturn false;\n+\t\tif (hostAttributes == null && other.getHostAttributes() == null)\n+\t\t\treturn true;\n+\t\tif (hostAttributes == null\n+\t\t\t|| other.getHostAttributes() == null\n+\t\t\t|| hostAttributes.size() != other.getHostAttributes().size())\n+\t\t\treturn false;\n+\t\tCollections.sort(hostAttributes);\n+\t\tCollections.sort(other.getHostAttributes());", "originalCommit": "b351f6070635efe396e76279aa595f5df432c9d1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTE2Mjg2OQ==", "url": "https://github.com/CESNET/perun/pull/2726#discussion_r435162869", "bodyText": "You have changed the logic. So now you need to check if there are expected attributes manually.", "author": "stavamichal", "createdAt": "2020-06-04T10:48:12Z", "path": "perun-core/src/test/java/cz/metacentrum/perun/core/entry/FacilitiesManagerEntryIntegrationTest.java", "diffHunk": "@@ -825,6 +826,35 @@ public void getHostsWhenFacilityNotExists()throws Exception{\n \n \t}\n \n+\t@Test\n+\tpublic void getEnrichedHosts() throws Exception {\n+\t\tSystem.out.println(CLASS_NAME + \"getEnrichedHosts\");\n+\n+\t\tcreatedHost = facilitiesManagerEntry.addHosts(sess, hosts, facility).get(0);\n+\t\t// set this host for deletion - host is created after adding to facility !!\n+\t\thostsForDeletion.add(hosts.get(0));\n+\n+\t\tAttribute attr = new Attribute();\n+\t\tattr.setNamespace(\"urn:perun:host:attribute-def:opt\");\n+\t\tattr.setFriendlyName(\"host-test-for-list-of-names-attribute\");\n+\t\tattr.setType(String.class.getName());\n+\t\tattr.setValue(\"HostAttributeForList\");\n+\t\tperun.getAttributesManagerBl().createAttribute(sess, attr);\n+\t\tperun.getAttributesManagerBl().setAttribute(sess, createdHost, attr);\n+\n+\t\tList<String> attrNames = new ArrayList<>();\n+\t\tattrNames.add(attr.getName());\n+\n+\t\tList<Attribute> hostAttributes = new ArrayList<>();\n+\t\thostAttributes.add(attr);\n+\t\tEnrichedHost actualEnrichedHost = new EnrichedHost(createdHost, hostAttributes);\n+\n+\t\tList<EnrichedHost> expectedEnrichedHosts = facilitiesManagerEntry.getEnrichedHosts(sess, facility, attrNames);\n+\t\tEnrichedHost expectedHost = expectedEnrichedHosts.get(0);\n+\n+\t\tassertEquals(\"Created and returned enrichedHost should be the same\", expectedHost, actualEnrichedHost);", "originalCommit": "72511db3310e4af8dd0168dbbd3e783cf73b1871", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTE3MzAwMg==", "url": "https://github.com/CESNET/perun/pull/2726#discussion_r435173002", "bodyText": "Yes, it should be fixed now as well.", "author": "metodej", "createdAt": "2020-06-04T11:07:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTE2Mjg2OQ=="}], "type": "inlineReview"}, {"oid": "efe697f85ab67b8f6c1960c1ed97f5dc8b9c26f8", "url": "https://github.com/CESNET/perun/commit/efe697f85ab67b8f6c1960c1ed97f5dc8b9c26f8", "message": "Fixes based on review to tests\n\n- fixed test to check attributes of enrichedHost", "committedDate": "2020-06-28T11:12:43Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDI0MzA2MA==", "url": "https://github.com/CESNET/perun/pull/2726#discussion_r454243060", "bodyText": "We have recently agreed on removing the cache completely. So please, remove this code as well.", "author": "Vojtech-Sassmann", "createdAt": "2020-07-14T09:58:32Z", "path": "perun-core/src/main/java/cz/metacentrum/perun/core/impl/AttributesManagerImpl.java", "diffHunk": "@@ -1064,6 +1064,40 @@ public Object mapRow(ResultSet rs, int i) throws SQLException {\n \t\t}\n \t}\n \n+\t@Override\n+\tpublic List<Attribute> getAttributes(PerunSession sess, Host host, List<String> attrNames) {\n+\t\tif(!CacheManager.isCacheDisabled()) {\n+\t\t\tList<String> controlledAttrNames = new ArrayList<>();\n+\n+\t\t\tfor(String attributeName: attrNames) {\n+\t\t\t\t//check namespace\n+\t\t\t\tif(attributeName.startsWith(AttributesManager.NS_HOST_ATTR)) controlledAttrNames.add(attributeName);\n+\t\t\t}\n+\n+\t\t\tList<Attribute> attrs = perun.getCacheManager().getAttributesByNames(controlledAttrNames, new Holder(host.getId(), Holder.HolderType.HOST), null);\n+\t\t\treturn this.setValuesOfAttributes(sess, attrs, host, null);\n+\t\t}", "originalCommit": "efe697f85ab67b8f6c1960c1ed97f5dc8b9c26f8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDg0OTcyOA==", "url": "https://github.com/CESNET/perun/pull/2726#discussion_r454849728", "bodyText": "Ok, removed.", "author": "metodej", "createdAt": "2020-07-15T07:31:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDI0MzA2MA=="}], "type": "inlineReview"}, {"oid": "fb2f2f14beeaef70a4dfe4552d3dc78498fd17e2", "url": "https://github.com/CESNET/perun/commit/fb2f2f14beeaef70a4dfe4552d3dc78498fd17e2", "message": "Added getAttributes by names for host\n\n- added method to get attributes selected by list of attribute names for host\n- also added test for this method", "committedDate": "2020-07-15T07:12:30Z", "type": "commit"}, {"oid": "84d999ff7dbc85d81577f7281b05d7934b053f8d", "url": "https://github.com/CESNET/perun/commit/84d999ff7dbc85d81577f7281b05d7934b053f8d", "message": "Added new object EnrichedHost and new method getEnrichedHosts\n\n- added new object EnrichedHost which contains host and its attributes\n- added new method to FacilitiesManager getEnrichedHosts which returns all enrichedHosts from given facility (attributes in object are filtered by rights)\n- also added test for this method", "committedDate": "2020-07-15T07:12:30Z", "type": "commit"}, {"oid": "69ed753dd7dd1ecdc2eda90768ca67313c8f2a5f", "url": "https://github.com/CESNET/perun/commit/69ed753dd7dd1ecdc2eda90768ca67313c8f2a5f", "message": "Fixes based on review\n\n- fixed javadocs\n- added rights to getHosts\n- changed EnrichedHost.equals to compare only hosts", "committedDate": "2020-07-15T07:12:30Z", "type": "commit"}, {"oid": "29fdfa53c2699f693e89307ffa6e2c376238bb11", "url": "https://github.com/CESNET/perun/commit/29fdfa53c2699f693e89307ffa6e2c376238bb11", "message": "Fixes based on review to tests\n\n- fixed test to check attributes of enrichedHost", "committedDate": "2020-07-15T07:12:30Z", "type": "commit"}, {"oid": "2aab054caa026a109ffcf0f415038cd27b5b07a1", "url": "https://github.com/CESNET/perun/commit/2aab054caa026a109ffcf0f415038cd27b5b07a1", "message": "Fixes based on review\n\n- removed usage of attribute cache", "committedDate": "2020-07-15T07:19:34Z", "type": "commit"}, {"oid": "2aab054caa026a109ffcf0f415038cd27b5b07a1", "url": "https://github.com/CESNET/perun/commit/2aab054caa026a109ffcf0f415038cd27b5b07a1", "message": "Fixes based on review\n\n- removed usage of attribute cache", "committedDate": "2020-07-15T07:19:34Z", "type": "forcePushed"}]}