{"pr_number": 2848, "pr_title": "Perun core - removed SUSPEND status", "pr_createdAt": "2020-08-11T13:55:29Z", "pr_url": "https://github.com/CESNET/perun/pull/2848", "timeline": [{"oid": "50b1cd341c2d88feff8e72e19fa607cb847783c1", "url": "https://github.com/CESNET/perun/commit/50b1cd341c2d88feff8e72e19fa607cb847783c1", "message": "Perun core - removed SUSPEND status\n\n* With the old implemetation of the member suspension it was difficult\nto determine in which state the object was before.\n* SUSPEND status has been completely removed and it has been replaced\nwith new implementation of VoBans.\n* The old method `suspendMemberTo` now creates ban objects.", "committedDate": "2020-08-12T14:34:50Z", "type": "forcePushed"}, {"oid": "34ac4311461ae8de4443791694e4869c25b8b3f1", "url": "https://github.com/CESNET/perun/commit/34ac4311461ae8de4443791694e4869c25b8b3f1", "message": "Perun core - removed SUSPEND status\n\n* With the old implemetation of the member suspension it was difficult\nto determine in which state the object was before. It wasn't also\npossible to specify a reason why the member has been suspended.\nTherefore, a new implementation using bans has been created.\n* SUSPEND status has been completely removed and it has been replaced\nwith new implementation of VoBans.\n* The old method `suspendMemberTo` now creates ban objects, but it has\nbeen marked as deprecated and one should use the newly created methods\nthat work directly with bans.\n* Updated isSuspended attribute's module to read the information from\nbans.\n* Created new methods that work with vo bans.\n* New methods added to the OpenApi.", "committedDate": "2020-08-13T08:01:45Z", "type": "forcePushed"}, {"oid": "4c2728cd77d6b9e29135546212262a4dc497731d", "url": "https://github.com/CESNET/perun/commit/4c2728cd77d6b9e29135546212262a4dc497731d", "message": "Perun core - removed SUSPEND status\n\n* With the old implemetation of the member suspension it was difficult\nto determine in which state the object was before. It wasn't also\npossible to specify a reason why the member has been suspended.\nTherefore, a new implementation using bans has been created.\n* SUSPEND status has been completely removed and it has been replaced\nwith new implementation of VoBans.\n* The old method `suspendMemberTo` now creates ban objects, but it has\nbeen marked as deprecated and one should use the newly created methods\nthat work directly with bans.\n* Updated isSuspended attribute's module to read the information from\nbans.\n* Created new methods that work with vo bans.\n* New methods added to the OpenApi.", "committedDate": "2020-08-13T08:18:50Z", "type": "forcePushed"}, {"oid": "deb961a4baa29513a4234e95d6fe6b357a5ceba4", "url": "https://github.com/CESNET/perun/commit/deb961a4baa29513a4234e95d6fe6b357a5ceba4", "message": "Perun core - removed SUSPEND status\n\n* With the old implemetation of the member suspension it was difficult\nto determine in which state the object was before. It wasn't also\npossible to specify a reason why the member has been suspended.\nTherefore, a new implementation using bans has been created.\n* SUSPEND status has been completely removed and it has been replaced\nwith new implementation of VoBans.\n* The old method `suspendMemberTo` now creates ban objects, but it has\nbeen marked as deprecated and one should use the newly created methods\nthat work directly with bans.\n* Updated isSuspended attribute's module to read the information from\nbans.\n* Created new methods that work with vo bans.\n* New methods added to the OpenApi.", "committedDate": "2020-08-13T10:42:50Z", "type": "forcePushed"}, {"oid": "9312aacd8fe5a610ae163e4a192dbda32547d0e6", "url": "https://github.com/CESNET/perun/commit/9312aacd8fe5a610ae163e4a192dbda32547d0e6", "message": "Perun core - removed SUSPEND status\n\n* With the old implemetation of the member suspension it was difficult\nto determine in which state the object was before. It wasn't also\npossible to specify a reason why the member has been suspended.\nTherefore, a new implementation using bans has been created.\n* SUSPEND status has been completely removed and it has been replaced\nwith new implementation of VoBans.\n* The old method `suspendMemberTo` now creates ban objects, but it has\nbeen marked as deprecated and one should use the newly created methods\nthat work directly with bans.\n* Updated isSuspended attribute's module to read the information from\nbans.\n* Created new methods that work with vo bans.\n* New methods added to the OpenApi.", "committedDate": "2020-08-13T10:45:20Z", "type": "forcePushed"}, {"oid": "50692ccea54bc110ddcc4982c30a70b21487dc25", "url": "https://github.com/CESNET/perun/commit/50692ccea54bc110ddcc4982c30a70b21487dc25", "message": "Perun core - removed SUSPEND status\n\n* With the old implemetation of the member suspension it was difficult\nto determine in which state the object was before. It wasn't also\npossible to specify a reason why the member has been suspended.\nTherefore, a new implementation using bans has been created.\n* SUSPEND status has been completely removed and it has been replaced\nwith new implementation of VoBans.\n* The old method `suspendMemberTo` now creates ban objects, but it has\nbeen marked as deprecated and one should use the newly created methods\nthat work directly with bans.\n* Updated isSuspended attribute's module to read the information from\nbans.\n* Created new methods that work with vo bans.\n* New methods added to the OpenApi.", "committedDate": "2020-08-13T10:51:15Z", "type": "forcePushed"}, {"oid": "a853399ee9ba46df1bfc938b32b392ebe8bcb936", "url": "https://github.com/CESNET/perun/commit/a853399ee9ba46df1bfc938b32b392ebe8bcb936", "message": "Perun core - removed SUSPEND status\n\n* With the old implemetation of the member suspension it was difficult\nto determine in which state the object was before. It wasn't also\npossible to specify a reason why the member has been suspended.\nTherefore, a new implementation using bans has been created.\n* SUSPEND status has been completely removed and it has been replaced\nwith new implementation of VoBans.\n* The old method `suspendMemberTo` now creates ban objects, but it has\nbeen marked as deprecated and one should use the newly created methods\nthat work directly with bans.\n* Updated isSuspended attribute's module to read the information from\nbans.\n* Created new methods that work with vo bans.\n* New methods added to the OpenApi.", "committedDate": "2020-08-13T11:01:01Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDQ1MzI2MQ==", "url": "https://github.com/CESNET/perun/pull/2848#discussion_r470453261", "bodyText": "Please change also DB version i this file.", "author": "stavamichal", "createdAt": "2020-08-14T07:20:02Z", "path": "perun-base/src/test/resources/test-schema.sql", "diffHunk": "@@ -1314,6 +1314,24 @@ create table blacklists (\n \tconstraint bllist_user_fk foreign key (user_id) references users(id)\n );\n \n+create table vos_bans (\n+\tid integer not null,\n+\tmember_id integer not null,\n+\tvo_id integer not null,\n+\tdescription longvarchar,\n+\tbanned_to timestamp not null,\n+\tcreated_at timestamp default current_date not null,\n+\tcreated_by longvarchar default user not null,\n+\tmodified_at timestamp default current_date not null,\n+\tmodified_by longvarchar default user not null,\n+\tcreated_by_uid integer,\n+\tmodified_by_uid integer,\n+\tconstraint vos_bans_pk primary key (id),\n+\tconstraint vos_bans_u unique (member_id),\n+\tconstraint vos_bans_mem_fk foreign key (member_id) references members (id),\n+\tconstraint vos_bans_vo_fk foreign key (vo_id) references vos (id)\n+);\n+", "originalCommit": "a853399ee9ba46df1bfc938b32b392ebe8bcb936", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDUwMDgyNA==", "url": "https://github.com/CESNET/perun/pull/2848#discussion_r470500824", "bodyText": "Done.", "author": "Vojtech-Sassmann", "createdAt": "2020-08-14T08:58:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDQ1MzI2MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDQ3NzQxNQ==", "url": "https://github.com/CESNET/perun/pull/2848#discussion_r470477415", "bodyText": "You should also remove \"suspendedTo\" from members table.", "author": "stavamichal", "createdAt": "2020-08-14T08:14:04Z", "path": "perun-db/postgres.sql", "diffHunk": "@@ -1,4 +1,4 @@\n--- database version 3.1.65 (don't forget to update insert statement at the end of file)\n+-- database version 3.1.66 (don't forget to update insert statement at the end of file)", "originalCommit": "a853399ee9ba46df1bfc938b32b392ebe8bcb936", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDUwMTIyOQ==", "url": "https://github.com/CESNET/perun/pull/2848#discussion_r470501229", "bodyText": "Done.", "author": "Vojtech-Sassmann", "createdAt": "2020-08-14T08:59:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDQ3NzQxNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDQ3NzU1Ng==", "url": "https://github.com/CESNET/perun/pull/2848#discussion_r470477556", "bodyText": "You should also remove \"suspendedTo\" from members table.", "author": "stavamichal", "createdAt": "2020-08-14T08:14:21Z", "path": "perun-base/src/test/resources/test-schema.sql", "diffHunk": "@@ -1314,6 +1314,24 @@ create table blacklists (\n \tconstraint bllist_user_fk foreign key (user_id) references users(id)\n );\n \n+create table vos_bans (\n+\tid integer not null,\n+\tmember_id integer not null,\n+\tvo_id integer not null,\n+\tdescription longvarchar,\n+\tbanned_to timestamp not null,\n+\tcreated_at timestamp default current_date not null,\n+\tcreated_by longvarchar default user not null,\n+\tmodified_at timestamp default current_date not null,\n+\tmodified_by longvarchar default user not null,\n+\tcreated_by_uid integer,\n+\tmodified_by_uid integer,\n+\tconstraint vos_bans_pk primary key (id),\n+\tconstraint vos_bans_u unique (member_id),\n+\tconstraint vos_bans_mem_fk foreign key (member_id) references members (id),\n+\tconstraint vos_bans_vo_fk foreign key (vo_id) references vos (id)\n+);\n+", "originalCommit": "a853399ee9ba46df1bfc938b32b392ebe8bcb936", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDUwMTM1Nw==", "url": "https://github.com/CESNET/perun/pull/2848#discussion_r470501357", "bodyText": "done", "author": "Vojtech-Sassmann", "createdAt": "2020-08-14T08:59:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDQ3NzU1Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDQ3ODE0NA==", "url": "https://github.com/CESNET/perun/pull/2848#discussion_r470478144", "bodyText": "What about records where suspended_to is null? Do you have a default in the new table? In code you are working with date in the far future.", "author": "stavamichal", "createdAt": "2020-08-14T08:15:36Z", "path": "perun-core/src/main/resources/postgresChangelog.txt", "diffHunk": "@@ -6,6 +6,17 @@\n -- Directly under version number should be version commands. They will be executed in the order they are written here.\n -- Comments are prefixed with -- and can be written only between version blocks, that means not in the lines with commands. They have to be at the start of the line.\n \n+3.1.66\n+CREATE TABLE vos_bans (id integer not null, member_id integer not null, vo_id integer not null, description varchar, banned_to timestamp not null, created_at timestamp default statement_timestamp() not null, created_by varchar default user not null, modified_at timestamp default statement_timestamp() not null, modified_by varchar default user not null, created_by_uid integer, modified_by_uid integer, constraint vos_bans_pk primary key (id), constraint vos_bans_u unique (member_id), constraint vos_bans_mem_fk foreign key (member_id) references members (id), constraint vos_bans_vo_fk foreign key (vo_id) references vos (id));\n+CREATE SEQUENCE \"vos_bans_id_seq\";\n+CREATE INDEX idx_fk_vos_ban_member ON vos_bans (member_id);\n+CREATE INDEX idx_fk_vos_ban_vos ON vos_bans (vo_id);\n+GRANT ALL ON vos_bans TO perun;\n+INSERT INTO vos_bans (id, description, banned_to, member_id, vo_id) SELECT nextval('vos_bans_id_seq'), 'AUTO CREATED FROM SUSPEND STATUS', members.suspended_to, members.id, members.vo_id FROM members WHERE status = 2;", "originalCommit": "a853399ee9ba46df1bfc938b32b392ebe8bcb936", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDUwOTEwNg==", "url": "https://github.com/CESNET/perun/pull/2848#discussion_r470509106", "bodyText": "That's a good point. I have added a default value for the table.", "author": "Vojtech-Sassmann", "createdAt": "2020-08-14T09:15:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDQ3ODE0NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDQ4MzkyMw==", "url": "https://github.com/CESNET/perun/pull/2848#discussion_r470483923", "bodyText": "Shouldn't you also set \"created_by\" and \"created_at\"?", "author": "stavamichal", "createdAt": "2020-08-14T08:27:53Z", "path": "perun-core/src/main/java/cz/metacentrum/perun/core/impl/VosManagerImpl.java", "diffHunk": "@@ -358,5 +384,124 @@ public int getVosCount(PerunSession sess) {\n \t\t}\n \t}\n \n+\t@Override\n+\tpublic BanOnVo setBan(PerunSession sess, BanOnVo banOnVo) {\n+\t\tUtils.notNull(banOnVo.getValidityTo(), \"banOnVo.getValidityTo\");\n+\t\ttry {\n+\t\t\tint newId = Utils.getNewId(jdbc, \"vos_bans_id_seq\");\n+\n+\t\t\tjdbc.update(\"insert into vos_bans(\" +\n+\t\t\t\t\t\t\t\"id, \" +\n+\t\t\t\t\t\t\t\"description, \" +\n+\t\t\t\t\t\t\t\"banned_to, \" +\n+\t\t\t\t\t\t\t\"member_id, \" +\n+\t\t\t\t\t\t\t\"vo_id, \" +\n+\t\t\t\t\t\t\t\"modified_by, \" +\n+\t\t\t\t\t\t\t\"modified_at, \" +", "originalCommit": "a853399ee9ba46df1bfc938b32b392ebe8bcb936", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDUwMjQyNQ==", "url": "https://github.com/CESNET/perun/pull/2848#discussion_r470502425", "bodyText": "Yes, I should add the created_by, but the created_at and modified_at are not needed because they will have a default value set in DB. I have added the created_by and removed modified_at.", "author": "Vojtech-Sassmann", "createdAt": "2020-08-14T09:02:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDQ4MzkyMw=="}], "type": "inlineReview"}, {"oid": "b18a8a920d0e6beb01ac9b40ef0332c4f5812729", "url": "https://github.com/CESNET/perun/commit/b18a8a920d0e6beb01ac9b40ef0332c4f5812729", "message": "Perun core - removed SUSPEND status\n\n* With the old implemetation of the member suspension it was difficult\nto determine in which state the object was before. It wasn't also\npossible to specify a reason why the member has been suspended.\nTherefore, a new implementation using bans has been created.\n* SUSPEND status has been completely removed and it has been replaced\nwith new implementation of VoBans.\n* The old method `suspendMemberTo` now creates ban objects, but it has\nbeen marked as deprecated and one should use the newly created methods\nthat work directly with bans.\n* Updated isSuspended attribute's module to read the information from\nbans.\n* Created new methods that work with vo bans.\n* New methods added to the OpenApi.", "committedDate": "2020-08-14T08:58:28Z", "type": "forcePushed"}, {"oid": "1fd95ffd404e9953558fda1890161ece688d3e52", "url": "https://github.com/CESNET/perun/commit/1fd95ffd404e9953558fda1890161ece688d3e52", "message": "Perun core - removed SUSPEND status\n\n* With the old implemetation of the member suspension it was difficult\nto determine in which state the object was before. It wasn't also\npossible to specify a reason why the member has been suspended.\nTherefore, a new implementation using bans has been created.\n* SUSPEND status has been completely removed and it has been replaced\nwith new implementation of VoBans.\n* The old method `suspendMemberTo` now creates ban objects, but it has\nbeen marked as deprecated and one should use the newly created methods\nthat work directly with bans.\n* Updated isSuspended attribute's module to read the information from\nbans.\n* Created new methods that work with vo bans.\n* New methods added to the OpenApi.", "committedDate": "2020-08-14T08:59:18Z", "type": "forcePushed"}, {"oid": "ae26618b3bf550d17bde5abc53389cf00664dba4", "url": "https://github.com/CESNET/perun/commit/ae26618b3bf550d17bde5abc53389cf00664dba4", "message": "Perun core - removed SUSPEND status\n\n* With the old implemetation of the member suspension it was difficult\nto determine in which state the object was before. It wasn't also\npossible to specify a reason why the member has been suspended.\nTherefore, a new implementation using bans has been created.\n* SUSPEND status has been completely removed and it has been replaced\nwith new implementation of VoBans.\n* The old method `suspendMemberTo` now creates ban objects, but it has\nbeen marked as deprecated and one should use the newly created methods\nthat work directly with bans.\n* Updated isSuspended attribute's module to read the information from\nbans.\n* Created new methods that work with vo bans.\n* New methods added to the OpenApi.", "committedDate": "2020-08-14T09:15:01Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDUxNTMzNA==", "url": "https://github.com/CESNET/perun/pull/2848#discussion_r470515334", "bodyText": "The default value of banned_to is missing here.", "author": "stavamichal", "createdAt": "2020-08-14T09:28:14Z", "path": "perun-core/src/main/resources/postgresChangelog.txt", "diffHunk": "@@ -6,6 +6,17 @@\n -- Directly under version number should be version commands. They will be executed in the order they are written here.\n -- Comments are prefixed with -- and can be written only between version blocks, that means not in the lines with commands. They have to be at the start of the line.\n \n+3.1.66\n+CREATE TABLE vos_bans (id integer not null, member_id integer not null, vo_id integer not null, description varchar, banned_to timestamp not null, created_at timestamp default statement_timestamp() not null, created_by varchar default user not null, modified_at timestamp default statement_timestamp() not null, modified_by varchar default user not null, created_by_uid integer, modified_by_uid integer, constraint vos_bans_pk primary key (id), constraint vos_bans_u unique (member_id), constraint vos_bans_mem_fk foreign key (member_id) references members (id), constraint vos_bans_vo_fk foreign key (vo_id) references vos (id));", "originalCommit": "ae26618b3bf550d17bde5abc53389cf00664dba4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDU1OTQyNA==", "url": "https://github.com/CESNET/perun/pull/2848#discussion_r470559424", "bodyText": "Fixed.", "author": "Vojtech-Sassmann", "createdAt": "2020-08-14T11:05:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDUxNTMzNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDUxNTg3NA==", "url": "https://github.com/CESNET/perun/pull/2848#discussion_r470515874", "bodyText": "Why is this change in this PR?", "author": "stavamichal", "createdAt": "2020-08-14T09:29:14Z", "path": "perun-rpc/src/main/java/cz/metacentrum/perun/rpc/methods/GroupsManagerMethod.java", "diffHunk": "@@ -1573,7 +1573,7 @@ public RichGroup call(ApiCaller ac, Deserializer parms) throws PerunException {\n \n \t\t\treturn ac.getGroupsManager().getRichGroupByIdWithAttributesByNames(ac.getSession(),\n \t\t\t\t\tparms.readInt(\"groupId\"),\n-\t\t\t\t\tparms.readList(\"attrNames\", String.class));\n+\t\t\t\t\tnull);", "originalCommit": "ae26618b3bf550d17bde5abc53389cf00664dba4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDU1OTM0OQ==", "url": "https://github.com/CESNET/perun/pull/2848#discussion_r470559349", "bodyText": "I added this by accident. I have removed it.", "author": "Vojtech-Sassmann", "createdAt": "2020-08-14T11:05:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDUxNTg3NA=="}], "type": "inlineReview"}, {"oid": "ca29bdb158c75fc07bf8d4ac966bae12932332ac", "url": "https://github.com/CESNET/perun/commit/ca29bdb158c75fc07bf8d4ac966bae12932332ac", "message": "Perun core - removed SUSPEND status\n\n* With the old implemetation of the member suspension it was difficult\nto determine in which state the object was before. It wasn't also\npossible to specify a reason why the member has been suspended.\nTherefore, a new implementation using bans has been created.\n* SUSPEND status has been completely removed and it has been replaced\nwith new implementation of VoBans.\n* The old method `suspendMemberTo` now creates ban objects, but it has\nbeen marked as deprecated and one should use the newly created methods\nthat work directly with bans.\n* Updated isSuspended attribute's module to read the information from\nbans.\n* Created new methods that work with vo bans.\n* New methods added to the OpenApi.", "committedDate": "2020-08-14T11:02:28Z", "type": "forcePushed"}, {"oid": "b2b0eab087255beb8c9fa80775d04f16fee96983", "url": "https://github.com/CESNET/perun/commit/b2b0eab087255beb8c9fa80775d04f16fee96983", "message": "Perun core - removed SUSPEND status\n\n* With the old implemetation of the member suspension it was difficult\nto determine in which state the object was before. It wasn't also\npossible to specify a reason why the member has been suspended.\nTherefore, a new implementation using bans has been created.\n* SUSPEND status has been completely removed and it has been replaced\nwith new implementation of VoBans.\n* The old method `suspendMemberTo` now creates ban objects, but it has\nbeen marked as deprecated and one should use the newly created methods\nthat work directly with bans.\n* Updated isSuspended attribute's module to read the information from\nbans.\n* Created new methods that work with vo bans.\n* New methods added to the OpenApi.", "committedDate": "2020-08-14T11:04:33Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjE2MDM3MQ==", "url": "https://github.com/CESNET/perun/pull/2848#discussion_r472160371", "bodyText": "Policies for \"get\" methods should contain also PERUNOBSERVER role.", "author": "balcirakpeter", "createdAt": "2020-08-18T12:52:31Z", "path": "perun-base/src/main/resources/perun-roles.yml", "diffHunk": "@@ -4386,6 +4386,47 @@ perun_policies:\n     include_policies:\n       - default_policy\n \n+  setBan_BanOnVo_policy:\n+    policy_roles:\n+      - VOADMIN: Vo\n+    include_policies:\n+      - default_policy\n+\n+  vo-removeBan_int_policy:\n+    policy_roles:\n+      - VOADMIN: Vo\n+    include_policies:\n+      - default_policy\n+\n+  vo-removeBanForMember_member_policy:\n+    policy_roles:\n+      - VOADMIN: Vo\n+    include_policies:\n+      - default_policy\n+\n+  vo-getBanById_int_policy:", "originalCommit": "b2b0eab087255beb8c9fa80775d04f16fee96983", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mjg0ODg5MQ==", "url": "https://github.com/CESNET/perun/pull/2848#discussion_r472848891", "bodyText": "Done.", "author": "Vojtech-Sassmann", "createdAt": "2020-08-19T08:19:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjE2MDM3MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjE4NjIwNw==", "url": "https://github.com/CESNET/perun/pull/2848#discussion_r472186207", "bodyText": "Please add check if a member exists.", "author": "balcirakpeter", "createdAt": "2020-08-18T13:18:41Z", "path": "perun-core/src/main/java/cz/metacentrum/perun/core/entry/VosManagerEntry.java", "diffHunk": "@@ -594,6 +595,96 @@ public void removeSponsorRole(PerunSession sess, Vo vo, Group group) throws Grou\n \t\tAuthzResolverBlImpl.unsetRole(sess, group, vo, Role.SPONSOR);\n \t}\n \n+\t@Override\n+\tpublic BanOnVo setBan(PerunSession sess, BanOnVo ban) throws PrivilegeException, MemberNotExistsException {\n+\t\tUtils.checkPerunSession(sess);\n+\n+\t\t// We have to fetch the member object from DB because of authorization. The given ban object might contain\n+\t\t// invalid combination of voId and memberId\n+\t\tMember member = perunBl.getMembersManagerBl().getMemberById(sess, ban.getMemberId());\n+\n+\t\t// Authorization\n+\t\tif (!AuthzResolver.authorizedInternal(sess, \"setBan_BanOnVo_policy\", Collections.singletonList(member))) {\n+\t\t\tthrow new PrivilegeException(\"setBan\");\n+\t\t}\n+\n+\t\treturn vosManagerBl.setBan(sess, ban);\n+\t}\n+\n+\t@Override\n+\tpublic void removeBan(PerunSession sess, int banId) throws PrivilegeException, BanNotExistsException {\n+\t\tUtils.checkPerunSession(sess);\n+\n+\t\tBanOnVo banOnVo = perunBl.getVosManagerBl().getBanById(sess, banId);\n+\n+\t\t// Authorization\n+\t\tif (!AuthzResolver.authorizedInternal(sess, \"vo-removeBan_int_policy\", Collections.singletonList(banOnVo))) {\n+\t\t\tthrow new PrivilegeException(\"removeBan\");\n+\t\t}\n+\n+\t\tvosManagerBl.removeBan(sess, banId);\n+\t}\n+\n+\t@Override\n+\tpublic void removeBanForMember(PerunSession sess, Member member) throws PrivilegeException, BanNotExistsException {\n+\t\tUtils.checkPerunSession(sess);\n+\n+\t\t// Authorization\n+\t\tif (!AuthzResolver.authorizedInternal(sess, \"vo-removeBanForMember_member_policy\", Collections.singletonList(member))) {", "originalCommit": "b2b0eab087255beb8c9fa80775d04f16fee96983", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mjg0OTAxMA==", "url": "https://github.com/CESNET/perun/pull/2848#discussion_r472849010", "bodyText": "Done.", "author": "Vojtech-Sassmann", "createdAt": "2020-08-19T08:19:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjE4NjIwNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjE4NzgwOA==", "url": "https://github.com/CESNET/perun/pull/2848#discussion_r472187808", "bodyText": "You don't have to use a singleton list.", "author": "balcirakpeter", "createdAt": "2020-08-18T13:20:19Z", "path": "perun-core/src/main/java/cz/metacentrum/perun/core/entry/VosManagerEntry.java", "diffHunk": "@@ -594,6 +595,96 @@ public void removeSponsorRole(PerunSession sess, Vo vo, Group group) throws Grou\n \t\tAuthzResolverBlImpl.unsetRole(sess, group, vo, Role.SPONSOR);\n \t}\n \n+\t@Override\n+\tpublic BanOnVo setBan(PerunSession sess, BanOnVo ban) throws PrivilegeException, MemberNotExistsException {\n+\t\tUtils.checkPerunSession(sess);\n+\n+\t\t// We have to fetch the member object from DB because of authorization. The given ban object might contain\n+\t\t// invalid combination of voId and memberId\n+\t\tMember member = perunBl.getMembersManagerBl().getMemberById(sess, ban.getMemberId());\n+\n+\t\t// Authorization\n+\t\tif (!AuthzResolver.authorizedInternal(sess, \"setBan_BanOnVo_policy\", Collections.singletonList(member))) {\n+\t\t\tthrow new PrivilegeException(\"setBan\");\n+\t\t}\n+\n+\t\treturn vosManagerBl.setBan(sess, ban);\n+\t}\n+\n+\t@Override\n+\tpublic void removeBan(PerunSession sess, int banId) throws PrivilegeException, BanNotExistsException {\n+\t\tUtils.checkPerunSession(sess);\n+\n+\t\tBanOnVo banOnVo = perunBl.getVosManagerBl().getBanById(sess, banId);\n+\n+\t\t// Authorization\n+\t\tif (!AuthzResolver.authorizedInternal(sess, \"vo-removeBan_int_policy\", Collections.singletonList(banOnVo))) {\n+\t\t\tthrow new PrivilegeException(\"removeBan\");\n+\t\t}\n+\n+\t\tvosManagerBl.removeBan(sess, banId);\n+\t}\n+\n+\t@Override\n+\tpublic void removeBanForMember(PerunSession sess, Member member) throws PrivilegeException, BanNotExistsException {\n+\t\tUtils.checkPerunSession(sess);\n+\n+\t\t// Authorization\n+\t\tif (!AuthzResolver.authorizedInternal(sess, \"vo-removeBanForMember_member_policy\", Collections.singletonList(member))) {\n+\t\t\tthrow new PrivilegeException(\"removeBanForMember\");\n+\t\t}\n+\n+\t\tOptional<BanOnVo> banOnVo = perunBl.getVosManagerBl().getBanForMember(sess, member.getId());\n+\n+\t\tif (!banOnVo.isPresent()) {\n+\t\t\tthrow new BanNotExistsException(\"Given member is not banned.\");\n+\t\t}\n+\n+\t\tvosManagerBl.removeBanForMember(sess, member.getId());\n+\t}\n+\n+\t@Override\n+\tpublic BanOnVo getBanById(PerunSession sess, int banId) throws BanNotExistsException, PrivilegeException {\n+\t\tUtils.checkPerunSession(sess);\n+\n+\t\tBanOnVo ban = vosManagerBl.getBanById(sess, banId);\n+\n+\t\t// Authorization\n+\t\tif (!AuthzResolver.authorizedInternal(sess, \"vo-getBanById_int_policy\", Collections.singletonList(ban))) {\n+\t\t\tthrow new PrivilegeException(\"getBanById\");\n+\t\t}\n+\n+\t\treturn ban;\n+\t}\n+\n+\t@Override\n+\tpublic BanOnVo getBanForMember(PerunSession sess, Member member) throws PrivilegeException {\n+\t\tUtils.checkPerunSession(sess);\n+\n+\t\tOptional<BanOnVo> ban = vosManagerBl.getBanForMember(sess, member.getId());\n+\n+\t\t// Authorization\n+\t\tif (!AuthzResolver.authorizedInternal(sess, \"vo-getBanForMember_member_policy\", Collections.singletonList(member))) {\n+\t\t\tthrow new PrivilegeException(\"getBanForMember\");\n+\t\t}\n+\n+\t\treturn ban.orElse(null);\n+\t}\n+\n+\t@Override\n+\tpublic List<BanOnVo> getBansForVo(PerunSession sess, int voId) throws PrivilegeException, VoNotExistsException {\n+\t\tUtils.checkPerunSession(sess);\n+\n+\t\tVo vo = vosManagerBl.getVoById(sess, voId);\n+\n+\t\t// Authorization\n+\t\tif (!AuthzResolver.authorizedInternal(sess, \"getBansForVo_int_policy\", Collections.singletonList(vo))) {", "originalCommit": "b2b0eab087255beb8c9fa80775d04f16fee96983", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mjg0OTE1OQ==", "url": "https://github.com/CESNET/perun/pull/2848#discussion_r472849159", "bodyText": "Yes, I have removed it.", "author": "Vojtech-Sassmann", "createdAt": "2020-08-19T08:19:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjE4NzgwOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjE5MTc5OA==", "url": "https://github.com/CESNET/perun/pull/2848#discussion_r472191798", "bodyText": "Consider adding GROUPADMIN privileges for get methods.", "author": "balcirakpeter", "createdAt": "2020-08-18T13:24:04Z", "path": "perun-core/src/main/java/cz/metacentrum/perun/core/entry/VosManagerEntry.java", "diffHunk": "@@ -594,6 +595,96 @@ public void removeSponsorRole(PerunSession sess, Vo vo, Group group) throws Grou\n \t\tAuthzResolverBlImpl.unsetRole(sess, group, vo, Role.SPONSOR);\n \t}\n \n+\t@Override\n+\tpublic BanOnVo setBan(PerunSession sess, BanOnVo ban) throws PrivilegeException, MemberNotExistsException {\n+\t\tUtils.checkPerunSession(sess);\n+\n+\t\t// We have to fetch the member object from DB because of authorization. The given ban object might contain\n+\t\t// invalid combination of voId and memberId\n+\t\tMember member = perunBl.getMembersManagerBl().getMemberById(sess, ban.getMemberId());\n+\n+\t\t// Authorization\n+\t\tif (!AuthzResolver.authorizedInternal(sess, \"setBan_BanOnVo_policy\", Collections.singletonList(member))) {\n+\t\t\tthrow new PrivilegeException(\"setBan\");\n+\t\t}\n+\n+\t\treturn vosManagerBl.setBan(sess, ban);\n+\t}\n+\n+\t@Override\n+\tpublic void removeBan(PerunSession sess, int banId) throws PrivilegeException, BanNotExistsException {\n+\t\tUtils.checkPerunSession(sess);\n+\n+\t\tBanOnVo banOnVo = perunBl.getVosManagerBl().getBanById(sess, banId);\n+\n+\t\t// Authorization\n+\t\tif (!AuthzResolver.authorizedInternal(sess, \"vo-removeBan_int_policy\", Collections.singletonList(banOnVo))) {\n+\t\t\tthrow new PrivilegeException(\"removeBan\");\n+\t\t}\n+\n+\t\tvosManagerBl.removeBan(sess, banId);\n+\t}\n+\n+\t@Override\n+\tpublic void removeBanForMember(PerunSession sess, Member member) throws PrivilegeException, BanNotExistsException {\n+\t\tUtils.checkPerunSession(sess);\n+\n+\t\t// Authorization\n+\t\tif (!AuthzResolver.authorizedInternal(sess, \"vo-removeBanForMember_member_policy\", Collections.singletonList(member))) {\n+\t\t\tthrow new PrivilegeException(\"removeBanForMember\");\n+\t\t}\n+\n+\t\tOptional<BanOnVo> banOnVo = perunBl.getVosManagerBl().getBanForMember(sess, member.getId());\n+\n+\t\tif (!banOnVo.isPresent()) {\n+\t\t\tthrow new BanNotExistsException(\"Given member is not banned.\");\n+\t\t}\n+\n+\t\tvosManagerBl.removeBanForMember(sess, member.getId());\n+\t}\n+\n+\t@Override\n+\tpublic BanOnVo getBanById(PerunSession sess, int banId) throws BanNotExistsException, PrivilegeException {\n+\t\tUtils.checkPerunSession(sess);\n+\n+\t\tBanOnVo ban = vosManagerBl.getBanById(sess, banId);\n+\n+\t\t// Authorization\n+\t\tif (!AuthzResolver.authorizedInternal(sess, \"vo-getBanById_int_policy\", Collections.singletonList(ban))) {\n+\t\t\tthrow new PrivilegeException(\"getBanById\");\n+\t\t}\n+\n+\t\treturn ban;\n+\t}\n+\n+\t@Override\n+\tpublic BanOnVo getBanForMember(PerunSession sess, Member member) throws PrivilegeException {", "originalCommit": "b2b0eab087255beb8c9fa80775d04f16fee96983", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mjg0OTU2NQ==", "url": "https://github.com/CESNET/perun/pull/2848#discussion_r472849565", "bodyText": "I have added GROUPADMIN to all policies for getting vobans.", "author": "Vojtech-Sassmann", "createdAt": "2020-08-19T08:19:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjE5MTc5OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjE5NDcwNw==", "url": "https://github.com/CESNET/perun/pull/2848#discussion_r472194707", "bodyText": "Query does not throw EmptyResultDataAccessException.", "author": "balcirakpeter", "createdAt": "2020-08-18T13:26:45Z", "path": "perun-core/src/main/java/cz/metacentrum/perun/core/impl/VosManagerImpl.java", "diffHunk": "@@ -358,5 +384,125 @@ public int getVosCount(PerunSession sess) {\n \t\t}\n \t}\n \n+\t@Override\n+\tpublic BanOnVo setBan(PerunSession sess, BanOnVo banOnVo) {\n+\t\tUtils.notNull(banOnVo.getValidityTo(), \"banOnVo.getValidityTo\");\n+\t\ttry {\n+\t\t\tint newId = Utils.getNewId(jdbc, \"vos_bans_id_seq\");\n+\n+\t\t\tjdbc.update(\"insert into vos_bans(\" +\n+\t\t\t\t\t\t\t\"id, \" +\n+\t\t\t\t\t\t\t\"description, \" +\n+\t\t\t\t\t\t\t\"banned_to, \" +\n+\t\t\t\t\t\t\t\"member_id, \" +\n+\t\t\t\t\t\t\t\"vo_id, \" +\n+\t\t\t\t\t\t\t\"modified_by, \" +\n+\t\t\t\t\t\t\t\"created_by, \" +\n+\t\t\t\t\t\t\t\"created_by_uid, \" +\n+\t\t\t\t\t\t\t\"modified_by_uid) values (?,?,?,?,?,?,?,?,?)\",\n+\t\t\t\t\tnewId,\n+\t\t\t\t\tbanOnVo.getDescription(),\n+\t\t\t\t\tCompatibility.getDate(banOnVo.getValidityTo().getTime()),\n+\t\t\t\t\tbanOnVo.getMemberId(),\n+\t\t\t\t\tbanOnVo.getVoId(),\n+\t\t\t\t\tsess.getPerunPrincipal().getActor(),\n+\t\t\t\t\tsess.getPerunPrincipal().getActor(),\n+\t\t\t\t\tsess.getPerunPrincipal().getUserId(),\n+\t\t\t\t\tsess.getPerunPrincipal().getUserId()\n+\t\t\t);\n+\n+\t\t\tbanOnVo.setId(newId);\n+\n+\t\t\treturn banOnVo;\n+\t\t} catch(RuntimeException ex) {\n+\t\t\tthrow new InternalErrorException(ex);\n+\t\t}\n+\t}\n+\n+\t@Override\n+\tpublic BanOnVo getBanById(PerunSession sess, int banId) throws BanNotExistsException {\n+\t\ttry {\n+\t\t\treturn jdbc.queryForObject(\"select \" + banOnVoMappingSelectQuery + \" from vos_bans where id=? \",\n+\t\t\t\t\tBAN_ON_VO_MAPPER, banId);\n+\t\t} catch (EmptyResultDataAccessException ex) {\n+\t\t\tthrow new BanNotExistsException(\"Ban with id \" + banId + \" not exists for any vo.\");\n+\t\t} catch (RuntimeException ex) {\n+\t\t\tthrow new InternalErrorException(ex);\n+\t\t}\n+\t}\n+\n+\t@Override\n+\tpublic List<BanOnVo> getBansForVo(PerunSession sess, int voId) {\n+\t\ttry {\n+\t\t\treturn jdbc.query(\"select \" + banOnVoMappingSelectQuery + \" from vos_bans where vo_id=?\",\n+\t\t\t\t\tBAN_ON_VO_MAPPER, voId);\n+\t\t} catch (EmptyResultDataAccessException ex) {", "originalCommit": "b2b0eab087255beb8c9fa80775d04f16fee96983", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mjg0OTgxOQ==", "url": "https://github.com/CESNET/perun/pull/2848#discussion_r472849819", "bodyText": "Removed catch.", "author": "Vojtech-Sassmann", "createdAt": "2020-08-19T08:20:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjE5NDcwNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjIwMDE2MA==", "url": "https://github.com/CESNET/perun/pull/2848#discussion_r472200160", "bodyText": "This check is unnecessary.", "author": "balcirakpeter", "createdAt": "2020-08-18T13:33:39Z", "path": "perun-core/src/main/java/cz/metacentrum/perun/core/impl/VosManagerImpl.java", "diffHunk": "@@ -358,5 +384,125 @@ public int getVosCount(PerunSession sess) {\n \t\t}\n \t}\n \n+\t@Override\n+\tpublic BanOnVo setBan(PerunSession sess, BanOnVo banOnVo) {\n+\t\tUtils.notNull(banOnVo.getValidityTo(), \"banOnVo.getValidityTo\");\n+\t\ttry {\n+\t\t\tint newId = Utils.getNewId(jdbc, \"vos_bans_id_seq\");\n+\n+\t\t\tjdbc.update(\"insert into vos_bans(\" +\n+\t\t\t\t\t\t\t\"id, \" +\n+\t\t\t\t\t\t\t\"description, \" +\n+\t\t\t\t\t\t\t\"banned_to, \" +\n+\t\t\t\t\t\t\t\"member_id, \" +\n+\t\t\t\t\t\t\t\"vo_id, \" +\n+\t\t\t\t\t\t\t\"modified_by, \" +\n+\t\t\t\t\t\t\t\"created_by, \" +\n+\t\t\t\t\t\t\t\"created_by_uid, \" +\n+\t\t\t\t\t\t\t\"modified_by_uid) values (?,?,?,?,?,?,?,?,?)\",\n+\t\t\t\t\tnewId,\n+\t\t\t\t\tbanOnVo.getDescription(),\n+\t\t\t\t\tCompatibility.getDate(banOnVo.getValidityTo().getTime()),\n+\t\t\t\t\tbanOnVo.getMemberId(),\n+\t\t\t\t\tbanOnVo.getVoId(),\n+\t\t\t\t\tsess.getPerunPrincipal().getActor(),\n+\t\t\t\t\tsess.getPerunPrincipal().getActor(),\n+\t\t\t\t\tsess.getPerunPrincipal().getUserId(),\n+\t\t\t\t\tsess.getPerunPrincipal().getUserId()\n+\t\t\t);\n+\n+\t\t\tbanOnVo.setId(newId);\n+\n+\t\t\treturn banOnVo;\n+\t\t} catch(RuntimeException ex) {\n+\t\t\tthrow new InternalErrorException(ex);\n+\t\t}\n+\t}\n+\n+\t@Override\n+\tpublic BanOnVo getBanById(PerunSession sess, int banId) throws BanNotExistsException {\n+\t\ttry {\n+\t\t\treturn jdbc.queryForObject(\"select \" + banOnVoMappingSelectQuery + \" from vos_bans where id=? \",\n+\t\t\t\t\tBAN_ON_VO_MAPPER, banId);\n+\t\t} catch (EmptyResultDataAccessException ex) {\n+\t\t\tthrow new BanNotExistsException(\"Ban with id \" + banId + \" not exists for any vo.\");\n+\t\t} catch (RuntimeException ex) {\n+\t\t\tthrow new InternalErrorException(ex);\n+\t\t}\n+\t}\n+\n+\t@Override\n+\tpublic List<BanOnVo> getBansForVo(PerunSession sess, int voId) {\n+\t\ttry {\n+\t\t\treturn jdbc.query(\"select \" + banOnVoMappingSelectQuery + \" from vos_bans where vo_id=?\",\n+\t\t\t\t\tBAN_ON_VO_MAPPER, voId);\n+\t\t} catch (EmptyResultDataAccessException ex) {\n+\t\t\treturn new ArrayList<>();\n+\t\t} catch (RuntimeException ex) {\n+\t\t\tthrow new InternalErrorException(ex);\n+\t\t}\n+\t}\n+\n+\t@Override\n+\tpublic BanOnVo getBanForMember(PerunSession sess, int memberId) throws BanNotExistsException {\n+\t\ttry {\n+\t\t\treturn jdbc.queryForObject(\"select \" + banOnVoMappingSelectQuery + \" from vos_bans where member_id=? \",\n+\t\t\t\t\tBAN_ON_VO_MAPPER, memberId);\n+\t\t} catch (EmptyResultDataAccessException ex) {\n+\t\t\tthrow new BanNotExistsException(\"Ban for member with id \" + memberId + \" does not exist.\");\n+\t\t} catch (RuntimeException ex) {\n+\t\t\tthrow new InternalErrorException(ex);\n+\t\t}\n+\t}\n+\n+\t@Override\n+\tpublic BanOnVo updateBan(PerunSession sess, BanOnVo banOnVo) {\n+\t\ttry {\n+\t\t\tjdbc.update(\"UPDATE vos_bans SET \" +\n+\t\t\t\t\t\t\t\"description=?, \" +\n+\t\t\t\t\t\t\t\"banned_to=?, \" +\n+\t\t\t\t\t\t\t\"modified_by=?, \" +\n+\t\t\t\t\t\t\t\"modified_by_uid=?, \" +\n+\t\t\t\t\t\t\t\"modified_at= \"+ Compatibility.getSysdate() +\n+\t\t\t\t\t\t\t\" WHERE id=?\",\n+\t\t\t\t\tbanOnVo.getDescription(),\n+\t\t\t\t\tCompatibility.getDate(banOnVo.getValidityTo().getTime()),\n+\t\t\t\t\tsess.getPerunPrincipal().getActor(),\n+\t\t\t\t\tsess.getPerunPrincipal().getUserId(),\n+\t\t\t\t\tbanOnVo.getId());\n+\t\t} catch (RuntimeException e) {\n+\t\t\tthrow new InternalErrorException(e);\n+\t\t}\n+\n+\t\treturn banOnVo;\n+\t}\n \n+\t@Override\n+\tpublic void removeBan(PerunSession sess, int banId) throws BanNotExistsException {\n+\t\ttry {\n+\t\t\tint numAffected = jdbc.update(\"delete from vos_bans where id=?\", banId);\n+\t\t\tif (numAffected != 1) {\n+\t\t\t\tthrow new BanNotExistsException(\"Ban with id \" + banId + \" can't be remove, because not exists yet.\");\n+\t\t\t}\n+\t\t} catch (RuntimeException ex) {\n+\t\t\tthrow new InternalErrorException(ex);\n+\t\t}\n+\t}\n+\n+\t@Override\n+\tpublic boolean isMemberBanned(PerunSession sess, int memberId) {\n+\t\ttry {\n+\t\t\tint numberOfExistences = jdbc.queryForInt(\"select count(1) from vos_bans where member_id=?\", memberId);\n+\t\t\tif (numberOfExistences == 1) {\n+\t\t\t\treturn true;\n+\t\t\t} else if (numberOfExistences > 1) {\n+\t\t\t\tthrow new ConsistencyErrorException(\"Ban on member with ID=\" + memberId + \" exists more than once.\");\n+\t\t\t}\n+\t\t\treturn false;\n+\t\t} catch(EmptyResultDataAccessException ex) {", "originalCommit": "b2b0eab087255beb8c9fa80775d04f16fee96983", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mjg0OTkxNQ==", "url": "https://github.com/CESNET/perun/pull/2848#discussion_r472849915", "bodyText": "Removed.", "author": "Vojtech-Sassmann", "createdAt": "2020-08-19T08:20:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjIwMDE2MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjIwMzgzNQ==", "url": "https://github.com/CESNET/perun/pull/2848#discussion_r472203835", "bodyText": "I think this operationId is wrong", "author": "balcirakpeter", "createdAt": "2020-08-18T13:38:36Z", "path": "perun-openapi/openapi.yml", "diffHunk": "@@ -11309,6 +11342,103 @@ paths:\n         default:\n           $ref: '#/components/responses/ExceptionResponse'\n \n+  /json/vosManager/setBan:\n+    post:\n+      tags:\n+        - VosManager\n+      operationId: getBanById", "originalCommit": "b2b0eab087255beb8c9fa80775d04f16fee96983", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mjg1MDA2OA==", "url": "https://github.com/CESNET/perun/pull/2848#discussion_r472850068", "bodyText": "Yes, I have changed it.", "author": "Vojtech-Sassmann", "createdAt": "2020-08-19T08:20:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjIwMzgzNQ=="}], "type": "inlineReview"}, {"oid": "945aee52e911ee12146961f13984adb580623358", "url": "https://github.com/CESNET/perun/commit/945aee52e911ee12146961f13984adb580623358", "message": "Perun core - removed SUSPEND status\n\n* With the old implemetation of the member suspension it was difficult\nto determine in which state the object was before. It wasn't also\npossible to specify a reason why the member has been suspended.\nTherefore, a new implementation using bans has been created.\n* SUSPEND status has been completely removed and it has been replaced\nwith new implementation of VoBans.\n* The old method `suspendMemberTo` now creates ban objects, but it has\nbeen marked as deprecated and one should use the newly created methods\nthat work directly with bans.\n* Updated isSuspended attribute's module to read the information from\nbans.\n* Created new methods that work with vo bans.\n* New methods added to the OpenApi.", "committedDate": "2020-08-19T08:16:38Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjgzNjE1Ng==", "url": "https://github.com/CESNET/perun/pull/2848#discussion_r482836156", "bodyText": "We no longer recognize force engine events by the keyword forceit in the message, but rather by the object own interface EngineForceEvent. Please remove it from this message and also from MemberSuspended message. Constant from the Auditer class can be removed too. Also please update regex pattern in perun-ldapc.xml accordingly:\nfrom:\n<property name=\"pattern\" value=\"expired.$|disabled.$|invalidated.$|suspended #\"/>\nto:\n<property name=\"pattern\" value=\"expired.$|disabled.$|invalidated.$|suspended.$\"/>", "author": "zlamalp", "createdAt": "2020-09-03T09:23:24Z", "path": "perun-base/src/main/java/cz/metacentrum/perun/audit/events/MembersManagerEvents/MemberUnsuspended.java", "diffHunk": "@@ -0,0 +1,43 @@\n+package cz.metacentrum.perun.audit.events.MembersManagerEvents;\n+\n+import cz.metacentrum.perun.audit.events.AuditEvent;\n+import cz.metacentrum.perun.audit.events.EngineForceEvent;\n+import cz.metacentrum.perun.core.api.Member;\n+\n+\n+/**\n+ * @author Vojtech Sassmann <vojtech.sassmann@gmail.com>\n+ */\n+public class MemberUnsuspended extends AuditEvent implements EngineForceEvent {\n+\n+\tprivate Member member;\n+\tprivate String engineForceKeyword;\n+\tprivate String message;\n+\n+\t@SuppressWarnings(\"unused\") // used by jackson mapper\n+\tpublic MemberUnsuspended() { }\n+\n+\tpublic MemberUnsuspended(Member member, String engineForceKeyword) {\n+\t\tthis.member = member;\n+\t\tthis.engineForceKeyword = engineForceKeyword;\n+\t\tthis.message = formatMessage(\"%s unsuspended #%s.\", member, engineForceKeyword);", "originalCommit": "945aee52e911ee12146961f13984adb580623358", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mjg3Nzg4Mg==", "url": "https://github.com/CESNET/perun/pull/2848#discussion_r482877882", "bodyText": "I wonder, if this grant shouldn't be part of the changelog, but we never did this and never encountered any problem. So it question its own presence in the DB definition file.", "author": "zlamalp", "createdAt": "2020-09-03T10:34:06Z", "path": "perun-db/postgres.sql", "diffHunk": "@@ -1706,13 +1726,14 @@ grant all on security_teams_facilities to perun;\n grant all on blacklists to perun;\n grant all on resources_bans to perun;\n grant all on facilities_bans to perun;\n+grant all on vos_bans to perun;", "originalCommit": "945aee52e911ee12146961f13984adb580623358", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mjg4MDExNA==", "url": "https://github.com/CESNET/perun/pull/2848#discussion_r482880114", "bodyText": "I think, that also unsuspendMember below should be marked as deprecated, since we should be managing Bans instead of member suspension now.", "author": "zlamalp", "createdAt": "2020-09-03T10:38:48Z", "path": "perun-rpc/src/main/java/cz/metacentrum/perun/rpc/methods/MembersManagerMethod.java", "diffHunk": "@@ -1154,6 +1154,7 @@ public Member call(ApiCaller ac, Deserializer parms) throws PerunException {\n \t *\n \t * For almost unlimited time please use time in the far future.\n \t *\n+\t * @deprecated use vosManager setBan", "originalCommit": "945aee52e911ee12146961f13984adb580623358", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mjg5MTEyOA==", "url": "https://github.com/CESNET/perun/pull/2848#discussion_r482891128", "bodyText": "Please update RPC javadoc of setStatus method, since it mentions SUSPENDED as one of possible statuses to be sent to the API.", "author": "zlamalp", "createdAt": "2020-09-03T10:58:51Z", "path": "perun-core/src/main/java/cz/metacentrum/perun/core/blImpl/MembersManagerBlImpl.java", "diffHunk": "@@ -1425,9 +1436,6 @@ public Member setStatus(PerunSession sess, Member member, Status status) throws\n \t\t\tcase INVALID:\n \t\t\t\treturn invalidateMember(sess, member);\n \t\t\t//break;\n-\t\t\tcase SUSPENDED:", "originalCommit": "945aee52e911ee12146961f13984adb580623358", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mjg5NjE0Nw==", "url": "https://github.com/CESNET/perun/pull/2848#discussion_r482896147", "bodyText": "This probably applies to the other methods from the members manager too, like getCompleteRichMembers etc.", "author": "zlamalp", "createdAt": "2020-09-03T11:08:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mjg5MTEyOA=="}], "type": "inlineReview"}, {"oid": "643fe79ff47ca08dc4ad94ad0c5f106c50ddc1cc", "url": "https://github.com/CESNET/perun/commit/643fe79ff47ca08dc4ad94ad0c5f106c50ddc1cc", "message": "Perun core - removed SUSPEND status\n\n* With the old implemetation of the member suspension it was difficult\nto determine in which state the object was before. It wasn't also\npossible to specify a reason why the member has been suspended.\nTherefore, a new implementation using bans has been created.\n* SUSPEND status has been completely removed and it has been replaced\nwith new implementation of VoBans.\n* The old method `suspendMemberTo` now creates ban objects, but it has\nbeen marked as deprecated and one should use the newly created methods\nthat work directly with bans.\n* Updated isSuspended attribute's module to read the information from\nbans.\n* Created new methods that work with vo bans.\n* New methods added to the OpenApi.\n* In the old gui it is not possible to set the suspend status anymore.\n* In CLI, removed suspension info from member and adjusted comments.", "committedDate": "2020-09-07T10:11:08Z", "type": "forcePushed"}, {"oid": "70dfc99bc770ce653973bc900caba70117543689", "url": "https://github.com/CESNET/perun/commit/70dfc99bc770ce653973bc900caba70117543689", "message": "Perun core - removed SUSPEND status\n\n* With the old implemetation of the member suspension it was difficult\nto determine in which state the object was before. It wasn't also\npossible to specify a reason why the member has been suspended.\nTherefore, a new implementation using bans has been created.\n* SUSPEND status has been completely removed and it has been replaced\nwith new implementation of VoBans.\n* The old method `suspendMemberTo` now creates ban objects, but it has\nbeen marked as deprecated and one should use the newly created methods\nthat work directly with bans.\n* Updated isSuspended attribute's module to read the information from\nbans.\n* Created new methods that work with vo bans.\n* New methods added to the OpenApi.\n* In the old gui it is not possible to set the suspend status anymore.\n* In CLI, removed suspension info from member and adjusted comments.", "committedDate": "2020-09-07T10:39:19Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDU0MjU2NA==", "url": "https://github.com/CESNET/perun/pull/2848#discussion_r484542564", "bodyText": "If setStatus() method version with message param was removed, we should remove its docs completely.", "author": "zlamalp", "createdAt": "2020-09-07T18:36:49Z", "path": "perun-rpc/src/main/java/cz/metacentrum/perun/rpc/methods/MembersManagerMethod.java", "diffHunk": "@@ -1122,18 +1122,20 @@ public Void call(ApiCaller ac, Deserializer parms) throws PerunException {\n \t/*#\n \t * Set membership status of a member.\n \t *\n+\t * @deprecated use vosManager setBan to suspend a member\n+\t *\n \t * @param member int Member <code>id</code>\n-\t * @param status String VALID | INVALID | SUSPENDED | EXPIRED | DISABLED\n-\t * @exampleParam status \"SUSPENDED\"\n+\t * @param status String VALID | INVALID | EXPIRED | DISABLED\n+\t * @exampleParam status \"VALID\"\n \t * @param message String reason for suspension", "originalCommit": "70dfc99bc770ce653973bc900caba70117543689", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTUxNjc4OQ==", "url": "https://github.com/CESNET/perun/pull/2848#discussion_r485516789", "bodyText": "removed", "author": "Vojtech-Sassmann", "createdAt": "2020-09-09T10:47:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDU0MjU2NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDU0MzQyMQ==", "url": "https://github.com/CESNET/perun/pull/2848#discussion_r484543421", "bodyText": "We can also remove whole usage of messageArea, since no other status change takes a message. Consequently we can simplify json/membersManager/SetStatus.java and remove message param from that callback (constructor, variable etc.).", "author": "zlamalp", "createdAt": "2020-09-07T18:41:55Z", "path": "perun-web-gui/src/main/java/cz/metacentrum/perun/webgui/tabs/memberstabs/ChangeStatusTabItem.java", "diffHunk": "@@ -90,7 +90,6 @@ public Widget draw() {\n \t\tfinal ListBox lb = new ListBox(false);\n \t\tlb.addItem(\"VALID\", \"VALID\");\n \t\tlb.addItem(\"INVALID\", \"INVALID\");\n-\t\tlb.addItem(\"SUSPENDED\", \"SUSPENDED\");", "originalCommit": "70dfc99bc770ce653973bc900caba70117543689", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTUxNjg0OQ==", "url": "https://github.com/CESNET/perun/pull/2848#discussion_r485516849", "bodyText": "removed", "author": "Vojtech-Sassmann", "createdAt": "2020-09-09T10:47:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDU0MzQyMQ=="}], "type": "inlineReview"}, {"oid": "ed6511a03e6c94c88ae6eb2a76728c7c9bcfcfb6", "url": "https://github.com/CESNET/perun/commit/ed6511a03e6c94c88ae6eb2a76728c7c9bcfcfb6", "message": "Perun core - removed SUSPEND status\n\n* With the old implemetation of the member suspension it was difficult\nto determine in which state the object was before. It wasn't also\npossible to specify a reason why the member has been suspended.\nTherefore, a new implementation using bans has been created.\n* SUSPEND status has been completely removed and it has been replaced\nwith new implementation of VoBans.\n* The old method `suspendMemberTo` now creates ban objects, but it has\nbeen marked as deprecated and one should use the newly created methods\nthat work directly with bans.\n* Updated isSuspended attribute's module to read the information from\nbans.\n* Created new methods that work with vo bans.\n* New methods added to the OpenApi.\n* In the old gui it is not possible to set the suspend status anymore.\n* In CLI, removed suspension info from member and adjusted comments.", "committedDate": "2020-09-09T10:46:19Z", "type": "forcePushed"}, {"oid": "0ccc5dd253f89f9f504428d4da2c2dec85b6c966", "url": "https://github.com/CESNET/perun/commit/0ccc5dd253f89f9f504428d4da2c2dec85b6c966", "message": "Perun core - removed SUSPEND status\n\n* With the old implemetation of the member suspension it was difficult\nto determine in which state the object was before. It wasn't also\npossible to specify a reason why the member has been suspended.\nTherefore, a new implementation using bans has been created.\n* SUSPEND status has been completely removed and it has been replaced\nwith new implementation of VoBans.\n* The old method `suspendMemberTo` now creates ban objects, but it has\nbeen marked as deprecated and one should use the newly created methods\nthat work directly with bans.\n* Updated isSuspended attribute's module to read the information from\nbans.\n* Created new methods that work with vo bans.\n* New methods added to the OpenApi.\n* In the old gui it is not possible to set the suspend status anymore.\n* In CLI, removed suspension info from member and adjusted comments.", "committedDate": "2020-09-18T08:33:44Z", "type": "forcePushed"}, {"oid": "a684ed6ae423b35741fb07258f55846da07aa3d9", "url": "https://github.com/CESNET/perun/commit/a684ed6ae423b35741fb07258f55846da07aa3d9", "message": "Perun core - removed SUSPEND status\n\n* With the old implemetation of the member suspension it was difficult\nto determine in which state the object was before. It wasn't also\npossible to specify a reason why the member has been suspended.\nTherefore, a new implementation using bans has been created.\n* SUSPEND status has been completely removed and it has been replaced\nwith new implementation of VoBans.\n* The old method `suspendMemberTo` now creates ban objects, but it has\nbeen marked as deprecated and one should use the newly created methods\nthat work directly with bans.\n* Updated isSuspended attribute's module to read the information from\nbans.\n* Created new methods that work with vo bans.\n* New methods added to the OpenApi.\n* In the old gui it is not possible to set the suspend status anymore.\n* In CLI, removed suspension info from member and adjusted comments.", "committedDate": "2020-09-18T08:36:55Z", "type": "commit"}, {"oid": "a684ed6ae423b35741fb07258f55846da07aa3d9", "url": "https://github.com/CESNET/perun/commit/a684ed6ae423b35741fb07258f55846da07aa3d9", "message": "Perun core - removed SUSPEND status\n\n* With the old implemetation of the member suspension it was difficult\nto determine in which state the object was before. It wasn't also\npossible to specify a reason why the member has been suspended.\nTherefore, a new implementation using bans has been created.\n* SUSPEND status has been completely removed and it has been replaced\nwith new implementation of VoBans.\n* The old method `suspendMemberTo` now creates ban objects, but it has\nbeen marked as deprecated and one should use the newly created methods\nthat work directly with bans.\n* Updated isSuspended attribute's module to read the information from\nbans.\n* Created new methods that work with vo bans.\n* New methods added to the OpenApi.\n* In the old gui it is not possible to set the suspend status anymore.\n* In CLI, removed suspension info from member and adjusted comments.", "committedDate": "2020-09-18T08:36:55Z", "type": "forcePushed"}]}