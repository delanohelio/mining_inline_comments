{"pr_number": 3020, "pr_title": "Unifying methods for password validation", "pr_createdAt": "2020-12-01T14:49:08Z", "pr_url": "https://github.com/CESNET/perun/pull/3020", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzUwMTcxMA==", "url": "https://github.com/CESNET/perun/pull/3020#discussion_r533501710", "bodyText": "I would create some new testing login namespace instead of using 'einfra' which may not exists.", "author": "stavamichal", "createdAt": "2020-12-01T15:28:39Z", "path": "perun-core/src/test/java/cz/metacentrum/perun/core/entry/ModulesUtilsEntryIntegrationTest.java", "diffHunk": "@@ -792,6 +794,31 @@ public void countUserFacilityQuotas() throws Exception {\n \t\tassertEquals(expectedResult, result);\n \t}\n \n+\t@Test\n+\tpublic void getUserByLoginInNamespace() throws Exception {\n+\t\tSystem.out.println(CLASS_NAME + \"getUserByLoginInNamespace\");\n+\n+\t\t// create user\n+\t\tUser user = new User();\n+\t\tuser.setFirstName(\"Firstname\");\n+\t\tuser.setLastName(\"Lastname\");\n+\t\tuser = perun.getUsersManagerBl().createUser(sess, user);\n+\t\tassertNotNull(user);\n+\n+\t\tUser userByLogin = perun.getModulesUtilsBl().getUserByLoginInNamespace(sess, \"testlogin\", \"einfra\");\n+\t\tassertNull(\"No user should be found.\", userByLogin);\n+\n+\t\t// create login in einfra namespace\n+\t\tString attrName = AttributesManager.NS_USER_ATTR_DEF + \":\" + AttributesManager.LOGIN_NAMESPACE + \":einfra\";", "originalCommit": "84325f16c4e1152c297ee98e55bfd0e355a83928", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzcwMzI2OA==", "url": "https://github.com/CESNET/perun/pull/3020#discussion_r533703268", "bodyText": "We have \"dummy\" login namespace / module for the purpose of the tests.", "author": "zlamalp", "createdAt": "2020-12-01T20:33:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzUwMTcxMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDA0MzY1Mg==", "url": "https://github.com/CESNET/perun/pull/3020#discussion_r534043652", "bodyText": "Done, I create \"dummy\" login namespace attribute, if it is not already created.", "author": "cuadradek", "createdAt": "2020-12-02T10:06:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzUwMTcxMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzU0MzE3Mw==", "url": "https://github.com/CESNET/perun/pull/3020#discussion_r533543173", "bodyText": "I would perform check, that there is a single result and throw ConsistencyErrorException otherwise.", "author": "zlamalp", "createdAt": "2020-12-01T16:20:49Z", "path": "perun-core/src/main/java/cz/metacentrum/perun/core/blImpl/ModulesUtilsBlImpl.java", "diffHunk": "@@ -1183,6 +1184,18 @@ public User getUserFromMessage(PerunSessionImpl sess, String message) {\n \t\treturn convertedRanges;\n \t}\n \n+\t@Override\n+\tpublic User getUserByLoginInNamespace(PerunSession sess, String login, String namespace) {\n+\t\tString attrName = AttributesManager.NS_USER_ATTR_DEF + \":\" + AttributesManager.LOGIN_NAMESPACE + \":\" + namespace;\n+\t\tList<User> usersByLoginInNamespace = getPerunBl().getUsersManagerBl().getUsersByAttributeValue(sess, attrName, login);\n+\n+\t\tif (usersByLoginInNamespace.isEmpty()) {\n+\t\t\treturn null;\n+\t\t} else {\n+\t\t\treturn usersByLoginInNamespace.get(0);", "originalCommit": "84325f16c4e1152c297ee98e55bfd0e355a83928", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDA0MTk2OA==", "url": "https://github.com/CESNET/perun/pull/3020#discussion_r534041968", "bodyText": "Done", "author": "cuadradek", "createdAt": "2020-12-02T10:04:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzU0MzE3Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzY5MTc0NQ==", "url": "https://github.com/CESNET/perun/pull/3020#discussion_r533691745", "bodyText": "Since you are extending GenericPasswordManagerModule you should re-define constructor and set proper values to some variables. See EinfraPasswordManagerModule.", "author": "zlamalp", "createdAt": "2020-12-01T20:12:07Z", "path": "perun-core/src/main/java/cz/metacentrum/perun/core/impl/modules/pwdmgr/EgiuiPasswordManagerModule.java", "diffHunk": "@@ -0,0 +1,73 @@\n+package cz.metacentrum.perun.core.impl.modules.pwdmgr;\n+\n+import cz.metacentrum.perun.core.api.Attribute;\n+import cz.metacentrum.perun.core.api.AttributesManager;\n+import cz.metacentrum.perun.core.api.ExtSource;\n+import cz.metacentrum.perun.core.api.PerunSession;\n+import cz.metacentrum.perun.core.api.User;\n+import cz.metacentrum.perun.core.api.UserExtSource;\n+import cz.metacentrum.perun.core.api.exceptions.AttributeNotExistsException;\n+import cz.metacentrum.perun.core.api.exceptions.ExtSourceNotExistsException;\n+import cz.metacentrum.perun.core.api.exceptions.InternalErrorException;\n+import cz.metacentrum.perun.core.api.exceptions.InvalidLoginException;\n+import cz.metacentrum.perun.core.api.exceptions.UserExtSourceExistsException;\n+import cz.metacentrum.perun.core.api.exceptions.WrongAttributeAssignmentException;\n+import cz.metacentrum.perun.core.api.exceptions.WrongAttributeValueException;\n+import cz.metacentrum.perun.core.api.exceptions.WrongReferenceAttributeValueException;\n+import cz.metacentrum.perun.core.bl.PerunBl;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+/**\n+ * Password manager for EGI-UI login-namespace.\n+ */\n+public class EgiuiPasswordManagerModule extends GenericPasswordManagerModule {", "originalCommit": "84325f16c4e1152c297ee98e55bfd0e355a83928", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDA0MjA3MA==", "url": "https://github.com/CESNET/perun/pull/3020#discussion_r534042070", "bodyText": "Done", "author": "cuadradek", "createdAt": "2020-12-02T10:04:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzY5MTc0NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzcwMTEzOA==", "url": "https://github.com/CESNET/perun/pull/3020#discussion_r533701138", "bodyText": "Please add some message, so its more like @deprecated see validatePassword()", "author": "zlamalp", "createdAt": "2020-12-01T20:29:15Z", "path": "perun-rpc/src/main/java/cz/metacentrum/perun/rpc/methods/UsersManagerMethod.java", "diffHunk": "@@ -1158,6 +1158,7 @@ public Void call(ApiCaller ac, Deserializer parms) throws PerunException {\n \t * Validates password for a user in specified login-namespace. After that, user should be able to log-in\n \t * in external authz system using his credentials. It also creates UserExtSource and sets some required attributes.\n \t *\n+\t * @deprecated", "originalCommit": "84325f16c4e1152c297ee98e55bfd0e355a83928", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDA0MjE2NA==", "url": "https://github.com/CESNET/perun/pull/3020#discussion_r534042164", "bodyText": "Done", "author": "cuadradek", "createdAt": "2020-12-02T10:04:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzcwMTEzOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzcwNDc1OA==", "url": "https://github.com/CESNET/perun/pull/3020#discussion_r533704758", "bodyText": "I would prefer covering those new exceptions in InternalErrorException as did the original method validatePasswordAndSetExtSources(), since they are not relevant to the caller and are expected to never happen in correctly configured instance. Please update the modules and method hierarchy accordingly. Thank you.", "author": "zlamalp", "createdAt": "2020-12-01T20:35:46Z", "path": "perun-core/src/main/java/cz/metacentrum/perun/core/implApi/modules/pwdmgr/PasswordManagerModule.java", "diffHunk": "@@ -40,7 +43,7 @@\n \n \tvoid changePassword(PerunSession sess, String userLogin, String newPassword) throws InvalidLoginException, PasswordStrengthException;\n \n-\tvoid validatePassword(PerunSession sess, String userLogin) throws InvalidLoginException;\n+\tvoid validatePassword(PerunSession sess, String userLogin, User user) throws InvalidLoginException, ExtSourceNotExistsException, WrongReferenceAttributeValueException, WrongAttributeValueException;", "originalCommit": "84325f16c4e1152c297ee98e55bfd0e355a83928", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDA0MjM3OQ==", "url": "https://github.com/CESNET/perun/pull/3020#discussion_r534042379", "bodyText": "Done", "author": "cuadradek", "createdAt": "2020-12-02T10:04:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzcwNDc1OA=="}], "type": "inlineReview"}, {"oid": "a37335e772c73b92a59c0503ec6f8b49d20f8a59", "url": "https://github.com/CESNET/perun/commit/a37335e772c73b92a59c0503ec6f8b49d20f8a59", "message": "Unifying methods for password validation\n\n- There were 2 core methods for password validation - validatePassword() and\nvalidatePasswordAndSetExtSources().\n- Method validatePasswordAndSetExtSources() was removed from UsersManager, in RPC\nit is now marked as deprecated and calls validatePassword().\n- Creation of UserExtSources and related attributes was moved to password managers\nmodules.\n- Deleted method was used in Registrar, so it was replaced by validatePassword().\nThe deprecated RPC method was only used in old GUI (and wasn't used in WUI, new\nGUI and OpenAPI), where it was replaced by RPC method validatePassword.", "committedDate": "2020-12-02T10:02:45Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDA0NTA1Ng==", "url": "https://github.com/CESNET/perun/pull/3020#discussion_r534045056", "bodyText": "It is 2 or more (size could be bigger than 2).", "author": "stavamichal", "createdAt": "2020-12-02T10:09:06Z", "path": "perun-core/src/main/java/cz/metacentrum/perun/core/blImpl/ModulesUtilsBlImpl.java", "diffHunk": "@@ -1183,6 +1184,18 @@ public User getUserFromMessage(PerunSessionImpl sess, String message) {\n \t\treturn convertedRanges;\n \t}\n \n+\t@Override\n+\tpublic User getUserByLoginInNamespace(PerunSession sess, String login, String namespace) {\n+\t\tString attrName = AttributesManager.NS_USER_ATTR_DEF + \":\" + AttributesManager.LOGIN_NAMESPACE + \":\" + namespace;\n+\t\tList<User> usersByLoginInNamespace = getPerunBl().getUsersManagerBl().getUsersByAttributeValue(sess, attrName, login);\n+\n+\t\tif (usersByLoginInNamespace.isEmpty()) {\n+\t\t\treturn null;\n+\t\t} else if (usersByLoginInNamespace.size() == 1) {\n+\t\t\treturn usersByLoginInNamespace.get(0);\n+\t\t} else throw new ConsistencyErrorException(\"There are 2 same logins '\" + login + \"' in namespace \" + namespace + \".\");", "originalCommit": "a37335e772c73b92a59c0503ec6f8b49d20f8a59", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDA4MjkzOQ==", "url": "https://github.com/CESNET/perun/pull/3020#discussion_r534082939", "bodyText": "Fixed", "author": "cuadradek", "createdAt": "2020-12-02T11:07:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDA0NTA1Ng=="}], "type": "inlineReview"}, {"oid": "657aa2eef2b52fb1f94f5497d4441e202adf073f", "url": "https://github.com/CESNET/perun/commit/657aa2eef2b52fb1f94f5497d4441e202adf073f", "message": "Unifying methods for password validation\n\n- There were 2 core methods for password validation - validatePassword() and\nvalidatePasswordAndSetExtSources().\n- Method validatePasswordAndSetExtSources() was removed from UsersManager, in RPC\nit is now marked as deprecated and calls validatePassword().\n- Creation of UserExtSources and related attributes was moved to password managers\nmodules.\n- Deleted method was used in Registrar, so it was replaced by validatePassword().\nThe deprecated RPC method was only used in old GUI (and wasn't used in WUI, new\nGUI and OpenAPI), where it was replaced by RPC method validatePassword.", "committedDate": "2020-12-02T11:05:37Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDA5ODgzNg==", "url": "https://github.com/CESNET/perun/pull/3020#discussion_r534098836", "bodyText": "Can you please put it between curly brackets, like: } else { throw .... }. Thank you.", "author": "zlamalp", "createdAt": "2020-12-02T11:34:36Z", "path": "perun-core/src/main/java/cz/metacentrum/perun/core/blImpl/ModulesUtilsBlImpl.java", "diffHunk": "@@ -1183,6 +1184,18 @@ public User getUserFromMessage(PerunSessionImpl sess, String message) {\n \t\treturn convertedRanges;\n \t}\n \n+\t@Override\n+\tpublic User getUserByLoginInNamespace(PerunSession sess, String login, String namespace) {\n+\t\tString attrName = AttributesManager.NS_USER_ATTR_DEF + \":\" + AttributesManager.LOGIN_NAMESPACE + \":\" + namespace;\n+\t\tList<User> usersByLoginInNamespace = getPerunBl().getUsersManagerBl().getUsersByAttributeValue(sess, attrName, login);\n+\n+\t\tif (usersByLoginInNamespace.isEmpty()) {\n+\t\t\treturn null;\n+\t\t} else if (usersByLoginInNamespace.size() == 1) {\n+\t\t\treturn usersByLoginInNamespace.get(0);\n+\t\t} else throw new ConsistencyErrorException(\"There is more than 1 login '\" + login + \"' in namespace \" + namespace + \".\");", "originalCommit": "657aa2eef2b52fb1f94f5497d4441e202adf073f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDEwODc3MQ==", "url": "https://github.com/CESNET/perun/pull/3020#discussion_r534108771", "bodyText": "Done", "author": "cuadradek", "createdAt": "2020-12-02T11:52:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDA5ODgzNg=="}], "type": "inlineReview"}, {"oid": "1f541c98f5b0ba9f04a1bd8c3455e853077629d1", "url": "https://github.com/CESNET/perun/commit/1f541c98f5b0ba9f04a1bd8c3455e853077629d1", "message": "Unifying methods for password validation\n\n- There were 2 core methods for password validation - validatePassword() and\nvalidatePasswordAndSetExtSources().\n- Method validatePasswordAndSetExtSources() was removed from UsersManager, in RPC\nit is now marked as deprecated and calls validatePassword().\n- Creation of UserExtSources and related attributes was moved to password managers\nmodules.\n- Deleted method was used in Registrar, so it was replaced by validatePassword().\nThe deprecated RPC method was only used in old GUI (and wasn't used in WUI, new\nGUI and OpenAPI), where it was replaced by RPC method validatePassword.", "committedDate": "2020-12-02T11:51:33Z", "type": "commit"}, {"oid": "1f541c98f5b0ba9f04a1bd8c3455e853077629d1", "url": "https://github.com/CESNET/perun/commit/1f541c98f5b0ba9f04a1bd8c3455e853077629d1", "message": "Unifying methods for password validation\n\n- There were 2 core methods for password validation - validatePassword() and\nvalidatePasswordAndSetExtSources().\n- Method validatePasswordAndSetExtSources() was removed from UsersManager, in RPC\nit is now marked as deprecated and calls validatePassword().\n- Creation of UserExtSources and related attributes was moved to password managers\nmodules.\n- Deleted method was used in Registrar, so it was replaced by validatePassword().\nThe deprecated RPC method was only used in old GUI (and wasn't used in WUI, new\nGUI and OpenAPI), where it was replaced by RPC method validatePassword.", "committedDate": "2020-12-02T11:51:33Z", "type": "forcePushed"}]}