{"pr_number": 2677, "pr_title": "Rework findMembers logic", "pr_createdAt": "2020-04-27T10:57:42Z", "pr_url": "https://github.com/CESNET/perun/pull/2677", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjQyOTQ1Nw==", "url": "https://github.com/CESNET/perun/pull/2677#discussion_r416429457", "bodyText": "You don't need to explicitly declare InternalErrorException, because it is RuntimeException.", "author": "balcirakpeter", "createdAt": "2020-04-28T08:30:14Z", "path": "perun-core/src/main/java/cz/metacentrum/perun/core/implApi/MembersManagerImplApi.java", "diffHunk": "@@ -340,4 +340,18 @@\n \t */\n \tMemberGroupStatus getUnifiedMemberGroupStatus(PerunSession sess, User user, Facility facility) throws InternalErrorException;\n \n+\t/**\n+\t * Return list of members by specific string.\n+\t * Looking for searchString in member mail, user preferredMail, logins, name and IDs (user and member).\n+\t * If parameter onlySponsored is true, it will return only sponsored members by searchString.\n+\t * If vo is null, looking for any members in whole Perun. If vo is not null, looking only in specific VO.\n+\t *\n+\t * @param sess\n+\t * @param vo for which searching will be filtered, if null there is no filter for vo\n+\t * @param searchString it will be looking for this search string in the specific parameters in DB\n+\t * @param onlySponsored it will return only sponsored members in vo\n+\t * @return all members from specific VO by specific string\n+\t * @throws InternalErrorException\n+\t */\n+\tList<Member> findMembers(PerunSession sess, Vo vo, String searchString, boolean onlySponsored) throws InternalErrorException;", "originalCommit": "e888ae7ddd930f48c27ecee409e73c0fc87908e5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzA5NTUwOA==", "url": "https://github.com/CESNET/perun/pull/2677#discussion_r417095508", "bodyText": "Done.", "author": "stavamichal", "createdAt": "2020-04-29T06:38:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjQyOTQ1Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjQyOTYwMA==", "url": "https://github.com/CESNET/perun/pull/2677#discussion_r416429600", "bodyText": "You don't need to explicitly declare InternalErrorException, because it is RuntimeException.", "author": "balcirakpeter", "createdAt": "2020-04-28T08:30:27Z", "path": "perun-core/src/main/java/cz/metacentrum/perun/core/impl/MembersManagerImpl.java", "diffHunk": "@@ -490,4 +490,76 @@ public MemberGroupStatus getUnifiedMemberGroupStatus(PerunSession sess, User use\n \n \t}\n \n+\t@Override\n+\tpublic List<Member> findMembers(PerunSession sess, Vo vo, String searchString, boolean onlySponsored) throws InternalErrorException {", "originalCommit": "e888ae7ddd930f48c27ecee409e73c0fc87908e5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzA5NTQ5Ng==", "url": "https://github.com/CESNET/perun/pull/2677#discussion_r417095496", "bodyText": "Done.", "author": "stavamichal", "createdAt": "2020-04-29T06:38:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjQyOTYwMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjQyOTc3NQ==", "url": "https://github.com/CESNET/perun/pull/2677#discussion_r416429775", "bodyText": "You don't need to explicitly declare InternalErrorException, because it is RuntimeException.", "author": "balcirakpeter", "createdAt": "2020-04-28T08:30:43Z", "path": "perun-core/src/main/java/cz/metacentrum/perun/core/blImpl/MembersManagerBlImpl.java", "diffHunk": "@@ -2508,6 +2494,11 @@ public MemberGroupStatus getUnifiedMemberGroupStatus(PerunSession sess, User use\n \t\treturn getMembersManagerImpl().getUnifiedMemberGroupStatus(sess, user, facility);\n \t}\n \n+\t@Override\n+\tpublic List<Member> findMembers(PerunSession sess, Vo vo, String searchString, boolean onlySponsored) throws InternalErrorException {", "originalCommit": "e888ae7ddd930f48c27ecee409e73c0fc87908e5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzA5NTQ3NA==", "url": "https://github.com/CESNET/perun/pull/2677#discussion_r417095474", "bodyText": "Done.", "author": "stavamichal", "createdAt": "2020-04-29T06:38:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjQyOTc3NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjQ5MjgxMA==", "url": "https://github.com/CESNET/perun/pull/2677#discussion_r416492810", "bodyText": "NIT: You don't have to initialize it with an empty string.", "author": "balcirakpeter", "createdAt": "2020-04-28T10:08:37Z", "path": "perun-core/src/main/java/cz/metacentrum/perun/core/impl/MembersManagerImpl.java", "diffHunk": "@@ -490,4 +490,76 @@ public MemberGroupStatus getUnifiedMemberGroupStatus(PerunSession sess, User use\n \n \t}\n \n+\t@Override\n+\tpublic List<Member> findMembers(PerunSession sess, Vo vo, String searchString, boolean onlySponsored) throws InternalErrorException {\n+\t\tSet<Member> members = new HashSet<>();\n+\n+\t\tString voIdQueryString = \"\";\n+\t\tif(vo != null) {\n+\t\t\tvoIdQueryString = \" members.vo_id=\" + vo.getId() + \" and \";\n+\t\t}\n+\n+\t\tString sponsoredQueryString = \"\";\n+\t\tif(onlySponsored) {\n+\t\t\t//only sponsored members\n+\t\t\tsponsoredQueryString+=\" members.sponsored=1 and \";\n+\t\t}\n+\n+\t\tString userNameQueryString = \"\";", "originalCommit": "e888ae7ddd930f48c27ecee409e73c0fc87908e5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzA5NTQzMQ==", "url": "https://github.com/CESNET/perun/pull/2677#discussion_r417095431", "bodyText": "Removed.", "author": "stavamichal", "createdAt": "2020-04-29T06:38:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjQ5MjgxMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjQ5MzM5OA==", "url": "https://github.com/CESNET/perun/pull/2677#discussion_r416493398", "bodyText": "NIT: If it is possible, the name of the attributes could be defined in separate variables.", "author": "balcirakpeter", "createdAt": "2020-04-28T10:09:33Z", "path": "perun-core/src/main/java/cz/metacentrum/perun/core/impl/MembersManagerImpl.java", "diffHunk": "@@ -490,4 +490,76 @@ public MemberGroupStatus getUnifiedMemberGroupStatus(PerunSession sess, User use\n \n \t}\n \n+\t@Override\n+\tpublic List<Member> findMembers(PerunSession sess, Vo vo, String searchString, boolean onlySponsored) throws InternalErrorException {\n+\t\tSet<Member> members = new HashSet<>();\n+\n+\t\tString voIdQueryString = \"\";\n+\t\tif(vo != null) {\n+\t\t\tvoIdQueryString = \" members.vo_id=\" + vo.getId() + \" and \";\n+\t\t}\n+\n+\t\tString sponsoredQueryString = \"\";\n+\t\tif(onlySponsored) {\n+\t\t\t//only sponsored members\n+\t\t\tsponsoredQueryString+=\" members.sponsored=1 and \";\n+\t\t}\n+\n+\t\tString userNameQueryString = \"\";\n+\t\tif (Compatibility.isOracle()) {\n+\t\t\tuserNameQueryString = \" lower(\"+Compatibility.convertToAscii(\"u.first_name || u.middle_name || u.last_name\")+\") like '%' || ? || '%' \";\n+\t\t} else if (Compatibility.isPostgreSql()) {\n+\t\t\tuserNameQueryString= \" strpos(lower(\"+Compatibility.convertToAscii(\"COALESCE(u.first_name,'') || COALESCE(u.middle_name,'') || COALESCE(u.last_name,'')\")+\"),?) > 0 \";\n+\t\t} else if (Compatibility.isHSQLDB()) {\n+\t\t\tuserNameQueryString=\" lower(\"+Compatibility.convertToAscii(\"COALESCE(u.first_name,'') || COALESCE(u.middle_name,'') || COALESCE(u.last_name,'')\")+\") like '%' || ? || '%' \";\n+\t\t} else {\n+\t\t\tthrow new InternalErrorException(\"Unsupported db type\");\n+\t\t}\n+\n+\t\tString idQueryString = \"\";\n+\t\ttry {\n+\t\t\tint id = Integer.parseInt(searchString);\n+\t\t\tidQueryString = \" members.user_id=\" + id + \" or members.id=\" + id + \" or \";\n+\t\t} catch (NumberFormatException e) {\n+\t\t\t// IGNORE wrong format of ID\n+\t\t}\n+\n+\t\tString lowercaseSearchString = searchString.toLowerCase();\n+\n+\t\t//searching by member mail\n+\t\t//searching by user preferredMail\n+\t\t//searching by login in userExtSources\n+\t\t//searching by login in logins (all namespaces)\n+\t\t//searching by name for user\n+\t\t//searching by user and member id\n+\t\tmembers.addAll(jdbc.query(\"select distinct \" + memberMappingSelectQuery +\n+\t\t\t\t\" from members \" +\n+\t\t\t\t\" left join users u on members.user_id=u.id \" +\n+\t\t\t\t\" left join member_attr_values mav1 on members.id=mav1.member_id and mav1.attr_id in (select id from attr_names where attr_name='urn:perun:member:attribute-def:def:mail') \" +", "originalCommit": "e888ae7ddd930f48c27ecee409e73c0fc87908e5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzA5NTQwMA==", "url": "https://github.com/CESNET/perun/pull/2677#discussion_r417095400", "bodyText": "Done.", "author": "stavamichal", "createdAt": "2020-04-29T06:37:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjQ5MzM5OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjQ5NTUwMg==", "url": "https://github.com/CESNET/perun/pull/2677#discussion_r416495502", "bodyText": "Is this Javadoc necessary? It could be at least written as a normal comment so there will be no warnings about dangling Javadoc.", "author": "balcirakpeter", "createdAt": "2020-04-28T10:13:04Z", "path": "perun-core/src/main/java/cz/metacentrum/perun/core/impl/MembersManagerImpl.java", "diffHunk": "@@ -490,4 +490,76 @@ public MemberGroupStatus getUnifiedMemberGroupStatus(PerunSession sess, User use\n \n \t}\n \n+\t@Override\n+\tpublic List<Member> findMembers(PerunSession sess, Vo vo, String searchString, boolean onlySponsored) throws InternalErrorException {\n+\t\tSet<Member> members = new HashSet<>();\n+\n+\t\tString voIdQueryString = \"\";\n+\t\tif(vo != null) {\n+\t\t\tvoIdQueryString = \" members.vo_id=\" + vo.getId() + \" and \";\n+\t\t}\n+\n+\t\tString sponsoredQueryString = \"\";\n+\t\tif(onlySponsored) {\n+\t\t\t//only sponsored members\n+\t\t\tsponsoredQueryString+=\" members.sponsored=1 and \";\n+\t\t}\n+\n+\t\tString userNameQueryString = \"\";\n+\t\tif (Compatibility.isOracle()) {\n+\t\t\tuserNameQueryString = \" lower(\"+Compatibility.convertToAscii(\"u.first_name || u.middle_name || u.last_name\")+\") like '%' || ? || '%' \";\n+\t\t} else if (Compatibility.isPostgreSql()) {\n+\t\t\tuserNameQueryString= \" strpos(lower(\"+Compatibility.convertToAscii(\"COALESCE(u.first_name,'') || COALESCE(u.middle_name,'') || COALESCE(u.last_name,'')\")+\"),?) > 0 \";\n+\t\t} else if (Compatibility.isHSQLDB()) {\n+\t\t\tuserNameQueryString=\" lower(\"+Compatibility.convertToAscii(\"COALESCE(u.first_name,'') || COALESCE(u.middle_name,'') || COALESCE(u.last_name,'')\")+\") like '%' || ? || '%' \";\n+\t\t} else {\n+\t\t\tthrow new InternalErrorException(\"Unsupported db type\");\n+\t\t}\n+\n+\t\tString idQueryString = \"\";\n+\t\ttry {\n+\t\t\tint id = Integer.parseInt(searchString);\n+\t\t\tidQueryString = \" members.user_id=\" + id + \" or members.id=\" + id + \" or \";\n+\t\t} catch (NumberFormatException e) {\n+\t\t\t// IGNORE wrong format of ID\n+\t\t}\n+\n+\t\tString lowercaseSearchString = searchString.toLowerCase();\n+\n+\t\t//searching by member mail\n+\t\t//searching by user preferredMail\n+\t\t//searching by login in userExtSources\n+\t\t//searching by login in logins (all namespaces)\n+\t\t//searching by name for user\n+\t\t//searching by user and member id\n+\t\tmembers.addAll(jdbc.query(\"select distinct \" + memberMappingSelectQuery +\n+\t\t\t\t\" from members \" +\n+\t\t\t\t\" left join users u on members.user_id=u.id \" +\n+\t\t\t\t\" left join member_attr_values mav1 on members.id=mav1.member_id and mav1.attr_id in (select id from attr_names where attr_name='urn:perun:member:attribute-def:def:mail') \" +\n+\t\t\t\t\" left join user_attr_values uav1 on u.id=uav1.user_id and uav1.attr_id in (select id from attr_names where attr_name='urn:perun:user:attribute-def:def:preferredMail') \" +\n+\t\t\t\t\" left join user_attr_values uav2 on u.id=uav2.user_id and uav2.attr_id in (select id from attr_names where friendly_name like 'login-namespace:%') \" +\n+\t\t\t\t\" left join user_ext_sources ues on ues.user_id=u.id \" +\n+\t\t\t\t\" where \" +\n+\t\t\t\tvoIdQueryString +\n+\t\t\t\tsponsoredQueryString +\n+\t\t\t\t\" ( \" +\n+\t\t\t\t\" lower(mav1.attr_value)=lower(?) or \" +\n+\t\t\t\t\" lower(uav1.attr_value)=lower(?) or \" +\n+\t\t\t\t\" lower(uav2.attr_value)=lower(?) or \" +\n+\t\t\t\t\" lower(ues.login_ext)=lower(?) or \" +\n+\t\t\t\tidQueryString +\n+\t\t\t\tuserNameQueryString +\n+\t\t\t\t\" ) \", MEMBER_MAPPER, lowercaseSearchString, lowercaseSearchString, lowercaseSearchString, lowercaseSearchString, lowercaseSearchString));\n+\n+\t\t/**", "originalCommit": "e888ae7ddd930f48c27ecee409e73c0fc87908e5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzA5Mjk0Nw==", "url": "https://github.com/CESNET/perun/pull/2677#discussion_r417092947", "bodyText": "Removed.", "author": "stavamichal", "createdAt": "2020-04-29T06:31:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjQ5NTUwMg=="}], "type": "inlineReview"}, {"oid": "52c656542a36713b551d0961853b069dca21092e", "url": "https://github.com/CESNET/perun/commit/52c656542a36713b551d0961853b069dca21092e", "message": "Rework findMembers logic\n\n - logic about looking for members was done by looking for users and\n then filtering, now it is one separate sql query with the same meaning\n - we can specify vo (to filter only vo members) or not\n - we can specify if only sponsored users should be returned\n - all methods in MembersManager now using this logic\n - using filtering of sponsored accounts was added to one of existing\n methods and rpc was changed by that too\n - some basic tests were added", "committedDate": "2020-04-29T06:30:51Z", "type": "forcePushed"}, {"oid": "7787226044642a3da19f2a5016bba9ff61c35e4d", "url": "https://github.com/CESNET/perun/commit/7787226044642a3da19f2a5016bba9ff61c35e4d", "message": "Rework findMembers logic\n\n - logic about looking for members was done by looking for users and\n then filtering, now it is one separate sql query with the same meaning\n - we can specify vo (to filter only vo members) or not\n - we can specify if only sponsored users should be returned\n - all methods in MembersManager now using this logic\n - using filtering of sponsored accounts was added to one of existing\n methods and rpc was changed by that too\n - some basic tests were added", "committedDate": "2020-04-29T06:37:31Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzE2Mzc1MQ==", "url": "https://github.com/CESNET/perun/pull/2677#discussion_r417163751", "bodyText": "You should split existing rpc docs for this branch (I believe it`s second doc) and add version with new param onlySponsored.\nAlso it should be added to OpenApi, but I'm not sure, if we have this part  of API already done. If not, then its not necessary to add it right now, as it will be done by someone later.", "author": "zlamalp", "createdAt": "2020-04-29T08:54:28Z", "path": "perun-rpc/src/main/java/cz/metacentrum/perun/rpc/methods/MembersManagerMethod.java", "diffHunk": "@@ -1074,10 +1074,13 @@ public Void call(ApiCaller ac, Deserializer parms) throws PerunException {\n \t\t\t\t\t\t\tparms.readList(\"allowedStatuses\", String.class),\n \t\t\t\t\t\t\tparms.readString(\"searchString\"));\n \t\t\t\t} else {\n+\t\t\t\t\tboolean onlySponsored = false;\n+\t\t\t\t\tif(parms.contains(\"onlySponsored\")) onlySponsored = parms.readBoolean(\"onlySponsored\");\n \t\t\t\t\treturn ac.getMembersManager().findCompleteRichMembers(ac.getSession(),\n \t\t\t\t\t\t\tac.getVoById(parms.readInt(\"vo\")),\n \t\t\t\t\t\t\tparms.readList(\"attrsNames\", String.class),\n-\t\t\t\t\t\t\tparms.readString(\"searchString\"));", "originalCommit": "7787226044642a3da19f2a5016bba9ff61c35e4d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzE2OTUyNA==", "url": "https://github.com/CESNET/perun/pull/2677#discussion_r417169524", "bodyText": "RPC javadoc was added. There is missing findComplete* methods in openapi so I will skip it now too.", "author": "stavamichal", "createdAt": "2020-04-29T09:04:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzE2Mzc1MQ=="}], "type": "inlineReview"}, {"oid": "6ef36ba816564fdecd7e83f35e46ab166eea59f0", "url": "https://github.com/CESNET/perun/commit/6ef36ba816564fdecd7e83f35e46ab166eea59f0", "message": "Rework findMembers logic\n\n - logic about looking for members was done by looking for users and\n then filtering, now it is one separate sql query with the same meaning\n - we can specify vo (to filter only vo members) or not\n - we can specify if only sponsored users should be returned\n - all methods in MembersManager now using this logic\n - using filtering of sponsored accounts was added to one of existing\n methods and rpc was changed by that too\n - some basic tests were added", "committedDate": "2020-04-29T09:02:01Z", "type": "commit"}, {"oid": "6ef36ba816564fdecd7e83f35e46ab166eea59f0", "url": "https://github.com/CESNET/perun/commit/6ef36ba816564fdecd7e83f35e46ab166eea59f0", "message": "Rework findMembers logic\n\n - logic about looking for members was done by looking for users and\n then filtering, now it is one separate sql query with the same meaning\n - we can specify vo (to filter only vo members) or not\n - we can specify if only sponsored users should be returned\n - all methods in MembersManager now using this logic\n - using filtering of sponsored accounts was added to one of existing\n methods and rpc was changed by that too\n - some basic tests were added", "committedDate": "2020-04-29T09:02:01Z", "type": "forcePushed"}]}