{"pr_number": 2954, "pr_title": "Application auto rejection", "pr_createdAt": "2020-10-28T13:44:16Z", "pr_url": "https://github.com/CESNET/perun/pull/2954", "timeline": [{"oid": "bb03b6eae65efbd1139da0aa927d2b538d4f3018", "url": "https://github.com/CESNET/perun/commit/bb03b6eae65efbd1139da0aa927d2b538d4f3018", "message": "Application auto rejection\n\n* TODO", "committedDate": "2020-10-28T15:32:33Z", "type": "forcePushed"}, {"oid": "aacb76f2d3e1bf1484dc8ea6a19fbe7029f49665", "url": "https://github.com/CESNET/perun/commit/aacb76f2d3e1bf1484dc8ea6a19fbe7029f49665", "message": "Application auto rejection\n\n* I created two expiration attributes - one for group and one for VO.\n* I also created methods for auto rejection of expired applications.\n* Now is posible to set number of days to expiration of applications in each group and VO. If application is expired, then will be auto rejected.", "committedDate": "2020-10-28T19:07:41Z", "type": "forcePushed"}, {"oid": "882c6c35ed697736bf388c18b079204074f40cb7", "url": "https://github.com/CESNET/perun/commit/882c6c35ed697736bf388c18b079204074f40cb7", "message": "Application auto rejection\n\n* I created two expiration attributes - one for group and one for VO.\n* I also created methods for auto rejection of expired applications.\n* Now is posible to set number of days to expiration of applications in each group and VO. If application is expired, then will be auto rejected.", "committedDate": "2020-10-28T19:23:04Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDA4ODU5MQ==", "url": "https://github.com/CESNET/perun/pull/2954#discussion_r514088591", "bodyText": "I would also add here rights for the vo admin:\nrights.add(new AttributeRights(-1, Role.VOADMIN, Arrays.asList(ActionType.READ, ActionType.WRITE)));", "author": "Vojtech-Sassmann", "createdAt": "2020-10-29T08:42:10Z", "path": "perun-core/src/main/java/cz/metacentrum/perun/core/blImpl/AttributesManagerBlImpl.java", "diffHunk": "@@ -7229,6 +7229,30 @@ protected void initialize() {\n \t\trights.add(new AttributeRights(-1, Role.VOADMIN, Arrays.asList(ActionType.READ, ActionType.WRITE)));\n \t\tattributes.put(attr, rights);\n \n+\t\t//urn:perun:vo:attribute-def:def:applicationExpirationRules\n+\t\tattr = new AttributeDefinition();\n+\t\tattr.setDisplayName(\"Application expiration rules\");\n+\t\tattr.setFriendlyName(\"applicationExpirationRules\");\n+\t\tattr.setNamespace(AttributesManager.NS_VO_ATTR_DEF);\n+\t\tattr.setDescription(\"Set of rules to determine date of application (to vo) expiration. If not set, application will not be auto rejected.\");\n+\t\tattr.setType(LinkedHashMap.class.getName());\n+\t\t//set attribute rights (with dummy id of attribute - not known yet)\n+\t\trights = new ArrayList<>();\n+\t\trights.add(new AttributeRights(-1, Role.VOADMIN, Arrays.asList(ActionType.READ, ActionType.WRITE)));\n+\t\tattributes.put(attr, rights);\n+\n+\t\t//urn:perun:group:attribute-def:def:applicationExpirationRules\n+\t\tattr = new AttributeDefinition();\n+\t\tattr.setDisplayName(\"Application expiration rules\");\n+\t\tattr.setFriendlyName(\"applicationExpirationRules\");\n+\t\tattr.setNamespace(AttributesManager.NS_GROUP_ATTR_DEF);\n+\t\tattr.setDescription(\"Set of rules to determine date of application (to group) expiration. If not set, application will not be auto rejected.\");\n+\t\tattr.setType(LinkedHashMap.class.getName());\n+\t\t//set attribute rights (with dummy id of attribute - not known yet)\n+\t\trights = new ArrayList<>();\n+\t\trights.add(new AttributeRights(-1, Role.GROUPADMIN, Arrays.asList(ActionType.READ, ActionType.WRITE)));", "originalCommit": "882c6c35ed697736bf388c18b079204074f40cb7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDE4ODY1OA==", "url": "https://github.com/CESNET/perun/pull/2954#discussion_r514188658", "bodyText": "Rights have been added", "author": "HejdaJakub", "createdAt": "2020-10-29T11:30:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDA4ODU5MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDA5NDEzOQ==", "url": "https://github.com/CESNET/perun/pull/2954#discussion_r514094139", "bodyText": "This name should match the name of the module.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t\tattr.setFriendlyName(\"groupApplicationAutoExpirationRules\");\n          \n          \n            \n            \t\tattr.setFriendlyName(\"applicationExpirationRules\");", "author": "Vojtech-Sassmann", "createdAt": "2020-10-29T08:51:32Z", "path": "perun-core/src/main/java/cz/metacentrum/perun/core/impl/modules/attributes/urn_perun_group_attribute_def_def_applicationExpirationRules.java", "diffHunk": "@@ -0,0 +1,50 @@\n+package cz.metacentrum.perun.core.impl.modules.attributes;\n+\n+import cz.metacentrum.perun.core.api.Attribute;\n+import cz.metacentrum.perun.core.api.AttributeDefinition;\n+import cz.metacentrum.perun.core.api.AttributesManager;\n+import cz.metacentrum.perun.core.api.Group;\n+import cz.metacentrum.perun.core.api.exceptions.WrongAttributeAssignmentException;\n+import cz.metacentrum.perun.core.api.exceptions.WrongAttributeValueException;\n+import cz.metacentrum.perun.core.api.exceptions.WrongReferenceAttributeValueException;\n+import cz.metacentrum.perun.core.impl.PerunSessionImpl;\n+import cz.metacentrum.perun.core.implApi.modules.attributes.AbstractApplicationExpirationRulesModule;\n+import cz.metacentrum.perun.core.implApi.modules.attributes.GroupAttributesModuleImplApi;\n+\n+import java.util.LinkedHashMap;\n+\n+/**\n+ * @author Jakub Hejda <Jakub.Hejda@cesnet.cz>\n+ */\n+public class urn_perun_group_attribute_def_def_applicationExpirationRules extends AbstractApplicationExpirationRulesModule<Group> implements GroupAttributesModuleImplApi {\n+\t@Override\n+\tpublic Attribute fillAttribute(PerunSessionImpl perunSession, Group group, AttributeDefinition attribute) throws WrongAttributeAssignmentException {\n+\t\treturn new Attribute(attribute);\n+\t}\n+\n+\t@Override\n+\tpublic void checkAttributeSyntax(PerunSessionImpl perunSession, Group group, Attribute attribute) throws WrongAttributeValueException {\n+\t\tsuper.checkAttributeSyntax(perunSession, group, attribute);\n+\t}\n+\n+\t@Override\n+\tpublic void checkAttributeSemantics(PerunSessionImpl perunSession, Group group, Attribute attribute) throws WrongAttributeAssignmentException, WrongReferenceAttributeValueException {\n+\n+\t}\n+\n+\t@Override\n+\tpublic void changedAttributeHook(PerunSessionImpl session, Group group, Attribute attribute) throws WrongReferenceAttributeValueException {\n+\n+\t}\n+\n+\t@Override\n+\tpublic AttributeDefinition getAttributeDefinition() {\n+\t\tAttributeDefinition attr = new AttributeDefinition();\n+\t\tattr.setNamespace(AttributesManager.NS_GROUP_ATTR_DEF);\n+\t\tattr.setFriendlyName(\"groupApplicationAutoExpirationRules\");", "originalCommit": "882c6c35ed697736bf388c18b079204074f40cb7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDE5MjUxMA==", "url": "https://github.com/CESNET/perun/pull/2954#discussion_r514192510", "bodyText": "Changed", "author": "HejdaJakub", "createdAt": "2020-10-29T11:37:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDA5NDEzOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDA5NDc0NA==", "url": "https://github.com/CESNET/perun/pull/2954#discussion_r514094744", "bodyText": "You can remove this if you don't use it.", "author": "Vojtech-Sassmann", "createdAt": "2020-10-29T08:52:30Z", "path": "perun-core/src/main/java/cz/metacentrum/perun/core/impl/modules/attributes/urn_perun_vo_attribute_def_def_applicationExpirationRules.java", "diffHunk": "@@ -0,0 +1,52 @@\n+package cz.metacentrum.perun.core.impl.modules.attributes;\n+\n+import cz.metacentrum.perun.core.api.Attribute;\n+import cz.metacentrum.perun.core.api.AttributeDefinition;\n+import cz.metacentrum.perun.core.api.AttributesManager;\n+import cz.metacentrum.perun.core.api.Vo;\n+import cz.metacentrum.perun.core.api.exceptions.WrongAttributeValueException;\n+import cz.metacentrum.perun.core.api.exceptions.WrongReferenceAttributeValueException;\n+import cz.metacentrum.perun.core.impl.PerunSessionImpl;\n+import cz.metacentrum.perun.core.implApi.modules.attributes.AbstractApplicationExpirationRulesModule;\n+import cz.metacentrum.perun.core.implApi.modules.attributes.VoAttributesModuleImplApi;\n+\n+import java.util.LinkedHashMap;\n+\n+/**\n+ * @author Jakub Hejda <Jakub.Hejda@cesnet.cz>\n+ */\n+public class urn_perun_vo_attribute_def_def_applicationExpirationRules extends AbstractApplicationExpirationRulesModule<Vo> implements VoAttributesModuleImplApi {\n+\n+\t//public static final String VO_APPLICATION_AUTO_EXPIRATION_RULES_ATTR = AttributesManager.NS_VO_ATTR_DEF + \":applicationAutoExpirationRules\";", "originalCommit": "882c6c35ed697736bf388c18b079204074f40cb7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDE5MzAxMw==", "url": "https://github.com/CESNET/perun/pull/2954#discussion_r514193013", "bodyText": "Comment has been removed", "author": "HejdaJakub", "createdAt": "2020-10-29T11:38:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDA5NDc0NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDA5NDg2Ng==", "url": "https://github.com/CESNET/perun/pull/2954#discussion_r514094866", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t\tattr.setFriendlyName(\"voApplicationExpirationRules\");\n          \n          \n            \n            \t\tattr.setFriendlyName(\"applicationExpirationRules\");", "author": "Vojtech-Sassmann", "createdAt": "2020-10-29T08:52:43Z", "path": "perun-core/src/main/java/cz/metacentrum/perun/core/impl/modules/attributes/urn_perun_vo_attribute_def_def_applicationExpirationRules.java", "diffHunk": "@@ -0,0 +1,52 @@\n+package cz.metacentrum.perun.core.impl.modules.attributes;\n+\n+import cz.metacentrum.perun.core.api.Attribute;\n+import cz.metacentrum.perun.core.api.AttributeDefinition;\n+import cz.metacentrum.perun.core.api.AttributesManager;\n+import cz.metacentrum.perun.core.api.Vo;\n+import cz.metacentrum.perun.core.api.exceptions.WrongAttributeValueException;\n+import cz.metacentrum.perun.core.api.exceptions.WrongReferenceAttributeValueException;\n+import cz.metacentrum.perun.core.impl.PerunSessionImpl;\n+import cz.metacentrum.perun.core.implApi.modules.attributes.AbstractApplicationExpirationRulesModule;\n+import cz.metacentrum.perun.core.implApi.modules.attributes.VoAttributesModuleImplApi;\n+\n+import java.util.LinkedHashMap;\n+\n+/**\n+ * @author Jakub Hejda <Jakub.Hejda@cesnet.cz>\n+ */\n+public class urn_perun_vo_attribute_def_def_applicationExpirationRules extends AbstractApplicationExpirationRulesModule<Vo> implements VoAttributesModuleImplApi {\n+\n+\t//public static final String VO_APPLICATION_AUTO_EXPIRATION_RULES_ATTR = AttributesManager.NS_VO_ATTR_DEF + \":applicationAutoExpirationRules\";\n+\n+\t@Override\n+\tpublic Attribute fillAttribute(PerunSessionImpl perunSession, Vo vo, AttributeDefinition attribute) {\n+\t\treturn new Attribute(attribute);\n+\t}\n+\n+\t@Override\n+\tpublic void checkAttributeSyntax(PerunSessionImpl perunSession, Vo vo, Attribute attribute) throws WrongAttributeValueException {\n+\t\tsuper.checkAttributeSyntax(perunSession, vo, attribute);\n+\t}\n+\n+\t@Override\n+\tpublic void checkAttributeSemantics(PerunSessionImpl perunSession, Vo vo, Attribute attribute) throws WrongReferenceAttributeValueException {\n+\n+\t}\n+\n+\t@Override\n+\tpublic void changedAttributeHook(PerunSessionImpl session, Vo vo, Attribute attribute) {\n+\n+\t}\n+\n+\t@Override\n+\tpublic AttributeDefinition getAttributeDefinition() {\n+\t\tAttributeDefinition attr = new AttributeDefinition();\n+\t\tattr.setNamespace(AttributesManager.NS_VO_ATTR_DEF);\n+\t\tattr.setFriendlyName(\"voApplicationExpirationRules\");", "originalCommit": "882c6c35ed697736bf388c18b079204074f40cb7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDE5MjU4Ng==", "url": "https://github.com/CESNET/perun/pull/2954#discussion_r514192586", "bodyText": "Changed", "author": "HejdaJakub", "createdAt": "2020-10-29T11:38:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDA5NDg2Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDEwNDc1NQ==", "url": "https://github.com/CESNET/perun/pull/2954#discussion_r514104755", "bodyText": "I think the attribute will always be not null. You should instead check its value:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t\t\tif (expiration != null) {\n          \n          \n            \n            \t\t\tif (expiration.getValue() != null) {", "author": "Vojtech-Sassmann", "createdAt": "2020-10-29T09:09:07Z", "path": "perun-registrar-lib/src/main/java/cz/metacentrum/perun/registrar/impl/ExpirationNotifScheduler.java", "diffHunk": "@@ -357,6 +378,82 @@ private void checkVoMembersState(List<Vo> vos) throws WrongAttributeAssignmentEx\n \t\texpireSponsorships();\n \t}\n \n+\t/**\n+\t * Checks all applications for given vos and if some application is expired (according to expiration rules set by\n+\t * VO Manager), then rejects this application.\n+\t *\n+\t * @param vos virtual organizations\n+\t * @throws PerunException\n+\t */\n+\tprivate void voApplicationsAutoRejection(List<Vo> vos) throws PerunException {\n+\t\tList<String> states = new ArrayList<>();\n+\t\tstates.add(\"NEW\");\n+\t\tstates.add(\"VERIFIED\");\n+\n+\t\tfor (Vo vo : vos) {\n+\t\t\tAttribute expiration = perun.getAttributesManagerBl().getAttribute(sess, vo, A_VO_APP_EXP_RULES);\n+\t\t\tif (expiration != null) {", "originalCommit": "882c6c35ed697736bf388c18b079204074f40cb7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDI4OTEzMw==", "url": "https://github.com/CESNET/perun/pull/2954#discussion_r514289133", "bodyText": "Changed", "author": "HejdaJakub", "createdAt": "2020-10-29T14:11:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDEwNDc1NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDEwNjI4Mw==", "url": "https://github.com/CESNET/perun/pull/2954#discussion_r514106283", "bodyText": "Same here:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t\t\tif (expiration != null) {\n          \n          \n            \n            \t\t\tif (expiration.getValue() != null) {", "author": "Vojtech-Sassmann", "createdAt": "2020-10-29T09:11:34Z", "path": "perun-registrar-lib/src/main/java/cz/metacentrum/perun/registrar/impl/ExpirationNotifScheduler.java", "diffHunk": "@@ -357,6 +378,82 @@ private void checkVoMembersState(List<Vo> vos) throws WrongAttributeAssignmentEx\n \t\texpireSponsorships();\n \t}\n \n+\t/**\n+\t * Checks all applications for given vos and if some application is expired (according to expiration rules set by\n+\t * VO Manager), then rejects this application.\n+\t *\n+\t * @param vos virtual organizations\n+\t * @throws PerunException\n+\t */\n+\tprivate void voApplicationsAutoRejection(List<Vo> vos) throws PerunException {\n+\t\tList<String> states = new ArrayList<>();\n+\t\tstates.add(\"NEW\");\n+\t\tstates.add(\"VERIFIED\");\n+\n+\t\tfor (Vo vo : vos) {\n+\t\t\tAttribute expiration = perun.getAttributesManagerBl().getAttribute(sess, vo, A_VO_APP_EXP_RULES);\n+\t\t\tif (expiration != null) {\n+\t\t\t\tList<Application> applications = registrarManager.getApplicationsForVo(sess, vo, states);\n+\t\t\t\trejectExpiredApplications(applications, expiration);\n+\t\t\t}\n+\t\t}\n+\t}\n+\n+\t/**\n+\t * Gets all existing groups and then checks all applications for this groups and if some application is expired\n+\t * (according to expiration rules set by VO Manager), then rejects this application.\n+\t *\n+\t * @param vos virtual organizations\n+\t * @throws PerunException\n+\t */\n+\tprivate void groupApplicationsAutoRejection(List<Vo> vos) throws PerunException {\n+\t\tList<String> states = new ArrayList<>();\n+\t\tstates.add(\"NEW\");\n+\t\tstates.add(\"VERIFIED\");\n+\n+\t\tList<Group> groups = new ArrayList<>();\n+\t\tfor (Vo vo : vos) {\n+\t\t\tgroups.addAll(perun.getGroupsManagerBl().getGroups(sess, vo));\n+\t\t}\n+\n+\t\tfor (Group group : groups) {\n+\t\t\tAttribute expiration = perun.getAttributesManagerBl().getAttribute(sess, group, A_GROUP_APP_EXP_RULES);\n+\t\t\tif (expiration != null) {", "originalCommit": "882c6c35ed697736bf388c18b079204074f40cb7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDEwNzMwMg==", "url": "https://github.com/CESNET/perun/pull/2954#discussion_r514107302", "bodyText": "For enums, you can compare values directly:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t\t\tif (application.getState().toString().equals(\"NEW\")) {\n          \n          \n            \n            \t\t\tif (application.getState() == AppState.NEW)) {", "author": "Vojtech-Sassmann", "createdAt": "2020-10-29T09:13:11Z", "path": "perun-registrar-lib/src/main/java/cz/metacentrum/perun/registrar/impl/ExpirationNotifScheduler.java", "diffHunk": "@@ -357,6 +378,82 @@ private void checkVoMembersState(List<Vo> vos) throws WrongAttributeAssignmentEx\n \t\texpireSponsorships();\n \t}\n \n+\t/**\n+\t * Checks all applications for given vos and if some application is expired (according to expiration rules set by\n+\t * VO Manager), then rejects this application.\n+\t *\n+\t * @param vos virtual organizations\n+\t * @throws PerunException\n+\t */\n+\tprivate void voApplicationsAutoRejection(List<Vo> vos) throws PerunException {\n+\t\tList<String> states = new ArrayList<>();\n+\t\tstates.add(\"NEW\");\n+\t\tstates.add(\"VERIFIED\");\n+\n+\t\tfor (Vo vo : vos) {\n+\t\t\tAttribute expiration = perun.getAttributesManagerBl().getAttribute(sess, vo, A_VO_APP_EXP_RULES);\n+\t\t\tif (expiration != null) {\n+\t\t\t\tList<Application> applications = registrarManager.getApplicationsForVo(sess, vo, states);\n+\t\t\t\trejectExpiredApplications(applications, expiration);\n+\t\t\t}\n+\t\t}\n+\t}\n+\n+\t/**\n+\t * Gets all existing groups and then checks all applications for this groups and if some application is expired\n+\t * (according to expiration rules set by VO Manager), then rejects this application.\n+\t *\n+\t * @param vos virtual organizations\n+\t * @throws PerunException\n+\t */\n+\tprivate void groupApplicationsAutoRejection(List<Vo> vos) throws PerunException {\n+\t\tList<String> states = new ArrayList<>();\n+\t\tstates.add(\"NEW\");\n+\t\tstates.add(\"VERIFIED\");\n+\n+\t\tList<Group> groups = new ArrayList<>();\n+\t\tfor (Vo vo : vos) {\n+\t\t\tgroups.addAll(perun.getGroupsManagerBl().getGroups(sess, vo));\n+\t\t}\n+\n+\t\tfor (Group group : groups) {\n+\t\t\tAttribute expiration = perun.getAttributesManagerBl().getAttribute(sess, group, A_GROUP_APP_EXP_RULES);\n+\t\t\tif (expiration != null) {\n+\t\t\t\tList<Application> applications = registrarManager.getApplicationsForGroup(sess, group, states);\n+\t\t\t\trejectExpiredApplications(applications, expiration);\n+\t\t\t}\n+\t\t}\n+\t}\n+\n+\t/**\n+\t * Compares creation day of application to values in expiration attribute and if find expired application, then\n+\t * reject it.\n+\t *\n+\t * @param applications applications\n+\t * @param expiration attribute with number of days to application expiration\n+\t * @throws PerunException\n+\t */\n+\tprivate void rejectExpiredApplications (List<Application> applications, Attribute expiration) throws PerunException {\n+\t\tMap<String, String> attrValue = expiration.valueAsMap();\n+\t\tfor(Application application : applications) {\n+\t\t\tString date = application.getCreatedAt();\n+\t\t\tLocalDate createdAt = LocalDate.parse(date.substring(0, 10));\n+\t\t\tLocalDate now = getCurrentLocalDate();\n+\t\t\tif (application.getState().toString().equals(\"NEW\")) {", "originalCommit": "882c6c35ed697736bf388c18b079204074f40cb7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDI4OTU1OQ==", "url": "https://github.com/CESNET/perun/pull/2954#discussion_r514289559", "bodyText": "Changed", "author": "HejdaJakub", "createdAt": "2020-10-29T14:12:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDEwNzMwMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDEwODQ1NA==", "url": "https://github.com/CESNET/perun/pull/2954#discussion_r514108454", "bodyText": "I think there might be a problem with the localization of the message. Some applications support also the Czech language. But I am not sure how to exactly solve this. @zlamalp any ideas?", "author": "Vojtech-Sassmann", "createdAt": "2020-10-29T09:15:00Z", "path": "perun-registrar-lib/src/main/java/cz/metacentrum/perun/registrar/impl/ExpirationNotifScheduler.java", "diffHunk": "@@ -357,6 +378,82 @@ private void checkVoMembersState(List<Vo> vos) throws WrongAttributeAssignmentEx\n \t\texpireSponsorships();\n \t}\n \n+\t/**\n+\t * Checks all applications for given vos and if some application is expired (according to expiration rules set by\n+\t * VO Manager), then rejects this application.\n+\t *\n+\t * @param vos virtual organizations\n+\t * @throws PerunException\n+\t */\n+\tprivate void voApplicationsAutoRejection(List<Vo> vos) throws PerunException {\n+\t\tList<String> states = new ArrayList<>();\n+\t\tstates.add(\"NEW\");\n+\t\tstates.add(\"VERIFIED\");\n+\n+\t\tfor (Vo vo : vos) {\n+\t\t\tAttribute expiration = perun.getAttributesManagerBl().getAttribute(sess, vo, A_VO_APP_EXP_RULES);\n+\t\t\tif (expiration != null) {\n+\t\t\t\tList<Application> applications = registrarManager.getApplicationsForVo(sess, vo, states);\n+\t\t\t\trejectExpiredApplications(applications, expiration);\n+\t\t\t}\n+\t\t}\n+\t}\n+\n+\t/**\n+\t * Gets all existing groups and then checks all applications for this groups and if some application is expired\n+\t * (according to expiration rules set by VO Manager), then rejects this application.\n+\t *\n+\t * @param vos virtual organizations\n+\t * @throws PerunException\n+\t */\n+\tprivate void groupApplicationsAutoRejection(List<Vo> vos) throws PerunException {\n+\t\tList<String> states = new ArrayList<>();\n+\t\tstates.add(\"NEW\");\n+\t\tstates.add(\"VERIFIED\");\n+\n+\t\tList<Group> groups = new ArrayList<>();\n+\t\tfor (Vo vo : vos) {\n+\t\t\tgroups.addAll(perun.getGroupsManagerBl().getGroups(sess, vo));\n+\t\t}\n+\n+\t\tfor (Group group : groups) {\n+\t\t\tAttribute expiration = perun.getAttributesManagerBl().getAttribute(sess, group, A_GROUP_APP_EXP_RULES);\n+\t\t\tif (expiration != null) {\n+\t\t\t\tList<Application> applications = registrarManager.getApplicationsForGroup(sess, group, states);\n+\t\t\t\trejectExpiredApplications(applications, expiration);\n+\t\t\t}\n+\t\t}\n+\t}\n+\n+\t/**\n+\t * Compares creation day of application to values in expiration attribute and if find expired application, then\n+\t * reject it.\n+\t *\n+\t * @param applications applications\n+\t * @param expiration attribute with number of days to application expiration\n+\t * @throws PerunException\n+\t */\n+\tprivate void rejectExpiredApplications (List<Application> applications, Attribute expiration) throws PerunException {\n+\t\tMap<String, String> attrValue = expiration.valueAsMap();\n+\t\tfor(Application application : applications) {\n+\t\t\tString date = application.getCreatedAt();\n+\t\t\tLocalDate createdAt = LocalDate.parse(date.substring(0, 10));\n+\t\t\tLocalDate now = getCurrentLocalDate();\n+\t\t\tif (application.getState().toString().equals(\"NEW\")) {\n+\t\t\t\tint expirationAppWaitingForEmail = Integer.parseInt(attrValue.get(\"emailVerification\"));\n+\t\t\t\tif (now.minusDays(expirationAppWaitingForEmail).isAfter(createdAt)) {\n+\t\t\t\t\tregistrarManager.rejectApplication(sess, application.getId(), \"Application with id \" +", "originalCommit": "882c6c35ed697736bf388c18b079204074f40cb7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDMzMjI4OQ==", "url": "https://github.com/CESNET/perun/pull/2954#discussion_r514332289", "bodyText": "You would have to resolve preferred language of the user (if it is available) or from the application form data. Otherwise we should fallback to the english. Its done for registrar mails in MailManagerImpl.", "author": "zlamalp", "createdAt": "2020-10-29T15:06:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDEwODQ1NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDEwOTY4Mg==", "url": "https://github.com/CESNET/perun/pull/2954#discussion_r514109682", "bodyText": "I think you should put this in an else branch for the if checking the application state.", "author": "Vojtech-Sassmann", "createdAt": "2020-10-29T09:16:56Z", "path": "perun-registrar-lib/src/main/java/cz/metacentrum/perun/registrar/impl/ExpirationNotifScheduler.java", "diffHunk": "@@ -357,6 +378,82 @@ private void checkVoMembersState(List<Vo> vos) throws WrongAttributeAssignmentEx\n \t\texpireSponsorships();\n \t}\n \n+\t/**\n+\t * Checks all applications for given vos and if some application is expired (according to expiration rules set by\n+\t * VO Manager), then rejects this application.\n+\t *\n+\t * @param vos virtual organizations\n+\t * @throws PerunException\n+\t */\n+\tprivate void voApplicationsAutoRejection(List<Vo> vos) throws PerunException {\n+\t\tList<String> states = new ArrayList<>();\n+\t\tstates.add(\"NEW\");\n+\t\tstates.add(\"VERIFIED\");\n+\n+\t\tfor (Vo vo : vos) {\n+\t\t\tAttribute expiration = perun.getAttributesManagerBl().getAttribute(sess, vo, A_VO_APP_EXP_RULES);\n+\t\t\tif (expiration != null) {\n+\t\t\t\tList<Application> applications = registrarManager.getApplicationsForVo(sess, vo, states);\n+\t\t\t\trejectExpiredApplications(applications, expiration);\n+\t\t\t}\n+\t\t}\n+\t}\n+\n+\t/**\n+\t * Gets all existing groups and then checks all applications for this groups and if some application is expired\n+\t * (according to expiration rules set by VO Manager), then rejects this application.\n+\t *\n+\t * @param vos virtual organizations\n+\t * @throws PerunException\n+\t */\n+\tprivate void groupApplicationsAutoRejection(List<Vo> vos) throws PerunException {\n+\t\tList<String> states = new ArrayList<>();\n+\t\tstates.add(\"NEW\");\n+\t\tstates.add(\"VERIFIED\");\n+\n+\t\tList<Group> groups = new ArrayList<>();\n+\t\tfor (Vo vo : vos) {\n+\t\t\tgroups.addAll(perun.getGroupsManagerBl().getGroups(sess, vo));\n+\t\t}\n+\n+\t\tfor (Group group : groups) {\n+\t\t\tAttribute expiration = perun.getAttributesManagerBl().getAttribute(sess, group, A_GROUP_APP_EXP_RULES);\n+\t\t\tif (expiration != null) {\n+\t\t\t\tList<Application> applications = registrarManager.getApplicationsForGroup(sess, group, states);\n+\t\t\t\trejectExpiredApplications(applications, expiration);\n+\t\t\t}\n+\t\t}\n+\t}\n+\n+\t/**\n+\t * Compares creation day of application to values in expiration attribute and if find expired application, then\n+\t * reject it.\n+\t *\n+\t * @param applications applications\n+\t * @param expiration attribute with number of days to application expiration\n+\t * @throws PerunException\n+\t */\n+\tprivate void rejectExpiredApplications (List<Application> applications, Attribute expiration) throws PerunException {\n+\t\tMap<String, String> attrValue = expiration.valueAsMap();\n+\t\tfor(Application application : applications) {\n+\t\t\tString date = application.getCreatedAt();\n+\t\t\tLocalDate createdAt = LocalDate.parse(date.substring(0, 10));\n+\t\t\tLocalDate now = getCurrentLocalDate();\n+\t\t\tif (application.getState().toString().equals(\"NEW\")) {\n+\t\t\t\tint expirationAppWaitingForEmail = Integer.parseInt(attrValue.get(\"emailVerification\"));\n+\t\t\t\tif (now.minusDays(expirationAppWaitingForEmail).isAfter(createdAt)) {\n+\t\t\t\t\tregistrarManager.rejectApplication(sess, application.getId(), \"Application with id \" +\n+\t\t\t\t\t\tapplication.getId() + \" was auto rejected because of expiration rules set for Vo.\");\n+\t\t\t\t}\n+\t\t\t}\n+\t\t\tint expirationAppIgnoredByAdmin = Integer.parseInt(attrValue.get(\"ignoredByAdmin\"));\n+\t\t\tif (now.minusDays(expirationAppIgnoredByAdmin).isAfter(createdAt)) {\n+\t\t\t\tregistrarManager.rejectApplication(sess ,application.getId(), \"Application with id \" +\n+\t\t\t\t\tapplication.getId() + \" was auto rejected because of expiration rules set for Vo.\");\n+\t\t\t}", "originalCommit": "882c6c35ed697736bf388c18b079204074f40cb7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDIwNjAxNg==", "url": "https://github.com/CESNET/perun/pull/2954#discussion_r514206016", "bodyText": "But I think that the second parameter of attribute shouldn't depend on application state. So I think that should be possible to set only second value of attribute and then we couldn't check it only in else branch.", "author": "HejdaJakub", "createdAt": "2020-10-29T12:03:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDEwOTY4Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDIyNjQ4NQ==", "url": "https://github.com/CESNET/perun/pull/2954#discussion_r514226485", "bodyText": "You are right, I forget that we want this for all states.", "author": "Vojtech-Sassmann", "createdAt": "2020-10-29T12:40:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDEwOTY4Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDExMDMzMA==", "url": "https://github.com/CESNET/perun/pull/2954#discussion_r514110330", "bodyText": "You are missing here a comment about what the method does.", "author": "Vojtech-Sassmann", "createdAt": "2020-10-29T09:18:06Z", "path": "perun-registrar-lib/src/test/java/cz/metacentrum/perun/registrar/ExpirationNotifSchedulerTest.java", "diffHunk": "@@ -686,4 +757,62 @@ private AttributeDefinition setUpGroupMembershipExpirationAttribute() throws Exc\n \n \t\treturn perun.getAttributesManager().createAttribute(session, attr);\n \t}\n+\n+\t/**\n+\t * Converts object ApplicationFormItemWithPrefillValue to ApplicationFormItemData\n+\t *\n+\t * @param object ApplicationFormItemWithPrefilledValue to convert\n+\t * @return converted object ApplicationFormItemData\n+\t */\n+\tprivate ApplicationFormItemData convertAppFormItemWithPrefValToAppFormItemData(ApplicationFormItemWithPrefilledValue object) {\n+\t\treturn new ApplicationFormItemData(object.getFormItem(), object.getFormItem().getShortname(), \"\", \"0\");\n+\t}\n+\n+\t/**\n+\t *", "originalCommit": "882c6c35ed697736bf388c18b079204074f40cb7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDI5MDY1MA==", "url": "https://github.com/CESNET/perun/pull/2954#discussion_r514290650", "bodyText": "Comment has been added", "author": "HejdaJakub", "createdAt": "2020-10-29T14:13:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDExMDMzMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDExMTMzMg==", "url": "https://github.com/CESNET/perun/pull/2954#discussion_r514111332", "bodyText": "This deserves comment on why you have to do it.", "author": "Vojtech-Sassmann", "createdAt": "2020-10-29T09:19:39Z", "path": "perun-registrar-lib/src/test/java/cz/metacentrum/perun/registrar/ExpirationNotifSchedulerTest.java", "diffHunk": "@@ -232,6 +239,70 @@ public void checkMembersState() throws Exception {\n \n \t}\n \n+\t@Test\n+\tpublic void checkVoApplicationShouldBeAutoRejected() throws Exception {\n+\t\tSystem.out.println(CLASS_NAME + \"checkVoApplicationShouldBeAutoRejected\");\n+\n+\t\tApplication submitApp = setUpAndSubmitAppForPotentialAutoRejection(70, null, VO_APP_EXP_RULES);\n+\n+\t\tReflectionTestUtils.invokeMethod(spyScheduler, \"voApplicationsAutoRejection\", perun.getVosManagerBl().getVos(session));\n+\n+\t\t// check results\n+\t\tApplication returnedApp = registrarManager.getApplicationById(session, submitApp.getId());\n+\t\tassertEquals(\"Application should be rejected.\", returnedApp.getState(), Application.AppState.REJECTED);\n+\t}\n+\n+\t@Test\n+\tpublic void checkVoApplicationShouldNotBeAutoRejected() throws Exception {\n+\t\tSystem.out.println(CLASS_NAME + \"checkVoApplicationShouldNotBeAutoRejected\");\n+\n+\t\tApplication submitApp = setUpAndSubmitAppForPotentialAutoRejection(50, null, VO_APP_EXP_RULES);\n+\n+\t\tReflectionTestUtils.invokeMethod(spyScheduler, \"voApplicationsAutoRejection\", perun.getVosManagerBl().getVos(session));\n+\n+\t\t// check results\n+\t\tApplication returnedApp = registrarManager.getApplicationById(session, submitApp.getId());\n+\t\tassertEquals(\"Application shouldn't be rejected.\", returnedApp.getState(), Application.AppState.VERIFIED);\n+\t}\n+\n+\t@Test\n+\tpublic void checkGroupApplicationShouldBeAutoRejected() throws Exception {\n+\t\tSystem.out.println(CLASS_NAME + \"checkGroupApplicationAutoRejection\");\n+\n+\t\tjdbc.update(\"DELETE from application_form WHERE vo_id = ?\", vo.getId());\n+\n+\t\tGroup group = new Group();\n+\t\tgroup.setName(\"Group for apply\");\n+\t\tperun.getGroupsManagerBl().createGroup(session, vo, group);\n+\n+\t\tApplication submitApp = setUpAndSubmitAppForPotentialAutoRejection(70, group, GROUP_APP_EXP_RULES);\n+\n+\t\tReflectionTestUtils.invokeMethod(spyScheduler, \"groupApplicationsAutoRejection\", perun.getVosManagerBl().getVos(session));\n+\n+\t\t// check results\n+\t\tApplication returnedApp = registrarManager.getApplicationById(session, submitApp.getId());\n+\t\tassertEquals(\"Application should be rejected.\", returnedApp.getState(), Application.AppState.REJECTED);\n+\t}\n+\t@Test\n+\tpublic void checkGroupApplicationShouldNotBeAutoRejected() throws Exception {\n+\t\tSystem.out.println(CLASS_NAME + \"checkGroupApplicationAutoRejection\");\n+\n+\t\tjdbc.update(\"DELETE from application_form WHERE vo_id = ?\", vo.getId());", "originalCommit": "882c6c35ed697736bf388c18b079204074f40cb7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDI5MjcyNg==", "url": "https://github.com/CESNET/perun/pull/2954#discussion_r514292726", "bodyText": "Comment has been added (and also removed with group creating to private method )", "author": "HejdaJakub", "createdAt": "2020-10-29T14:16:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDExMTMzMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDA4MDgyNA==", "url": "https://github.com/CESNET/perun/pull/2954#discussion_r514080824", "bodyText": "You should add VOADMIN too.", "author": "zlamalp", "createdAt": "2020-10-29T08:28:28Z", "path": "perun-core/src/main/java/cz/metacentrum/perun/core/blImpl/AttributesManagerBlImpl.java", "diffHunk": "@@ -7229,6 +7229,30 @@ protected void initialize() {\n \t\trights.add(new AttributeRights(-1, Role.VOADMIN, Arrays.asList(ActionType.READ, ActionType.WRITE)));\n \t\tattributes.put(attr, rights);\n \n+\t\t//urn:perun:vo:attribute-def:def:applicationExpirationRules\n+\t\tattr = new AttributeDefinition();\n+\t\tattr.setDisplayName(\"Application expiration rules\");\n+\t\tattr.setFriendlyName(\"applicationExpirationRules\");\n+\t\tattr.setNamespace(AttributesManager.NS_VO_ATTR_DEF);\n+\t\tattr.setDescription(\"Set of rules to determine date of application (to vo) expiration. If not set, application will not be auto rejected.\");\n+\t\tattr.setType(LinkedHashMap.class.getName());\n+\t\t//set attribute rights (with dummy id of attribute - not known yet)\n+\t\trights = new ArrayList<>();\n+\t\trights.add(new AttributeRights(-1, Role.VOADMIN, Arrays.asList(ActionType.READ, ActionType.WRITE)));\n+\t\tattributes.put(attr, rights);\n+\n+\t\t//urn:perun:group:attribute-def:def:applicationExpirationRules\n+\t\tattr = new AttributeDefinition();\n+\t\tattr.setDisplayName(\"Application expiration rules\");\n+\t\tattr.setFriendlyName(\"applicationExpirationRules\");\n+\t\tattr.setNamespace(AttributesManager.NS_GROUP_ATTR_DEF);\n+\t\tattr.setDescription(\"Set of rules to determine date of application (to group) expiration. If not set, application will not be auto rejected.\");\n+\t\tattr.setType(LinkedHashMap.class.getName());\n+\t\t//set attribute rights (with dummy id of attribute - not known yet)\n+\t\trights = new ArrayList<>();\n+\t\trights.add(new AttributeRights(-1, Role.GROUPADMIN, Arrays.asList(ActionType.READ, ActionType.WRITE)));", "originalCommit": "882c6c35ed697736bf388c18b079204074f40cb7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDI5MzYyNg==", "url": "https://github.com/CESNET/perun/pull/2954#discussion_r514293626", "bodyText": "Done", "author": "HejdaJakub", "createdAt": "2020-10-29T14:17:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDA4MDgyNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDE2ODc1MA==", "url": "https://github.com/CESNET/perun/pull/2954#discussion_r514168750", "bodyText": "I would remove \"Group\" and use only \"Application auto expiration rules\", same for the VO attribute, since those attributes won't be shown together in GUI and will be related only to the displayed/managed entity. Also you have without it in AttributesManagerBlImpl init method.", "author": "zlamalp", "createdAt": "2020-10-29T10:53:54Z", "path": "perun-core/src/main/java/cz/metacentrum/perun/core/impl/modules/attributes/urn_perun_group_attribute_def_def_applicationExpirationRules.java", "diffHunk": "@@ -0,0 +1,50 @@\n+package cz.metacentrum.perun.core.impl.modules.attributes;\n+\n+import cz.metacentrum.perun.core.api.Attribute;\n+import cz.metacentrum.perun.core.api.AttributeDefinition;\n+import cz.metacentrum.perun.core.api.AttributesManager;\n+import cz.metacentrum.perun.core.api.Group;\n+import cz.metacentrum.perun.core.api.exceptions.WrongAttributeAssignmentException;\n+import cz.metacentrum.perun.core.api.exceptions.WrongAttributeValueException;\n+import cz.metacentrum.perun.core.api.exceptions.WrongReferenceAttributeValueException;\n+import cz.metacentrum.perun.core.impl.PerunSessionImpl;\n+import cz.metacentrum.perun.core.implApi.modules.attributes.AbstractApplicationExpirationRulesModule;\n+import cz.metacentrum.perun.core.implApi.modules.attributes.GroupAttributesModuleImplApi;\n+\n+import java.util.LinkedHashMap;\n+\n+/**\n+ * @author Jakub Hejda <Jakub.Hejda@cesnet.cz>\n+ */\n+public class urn_perun_group_attribute_def_def_applicationExpirationRules extends AbstractApplicationExpirationRulesModule<Group> implements GroupAttributesModuleImplApi {\n+\t@Override\n+\tpublic Attribute fillAttribute(PerunSessionImpl perunSession, Group group, AttributeDefinition attribute) throws WrongAttributeAssignmentException {\n+\t\treturn new Attribute(attribute);\n+\t}\n+\n+\t@Override\n+\tpublic void checkAttributeSyntax(PerunSessionImpl perunSession, Group group, Attribute attribute) throws WrongAttributeValueException {\n+\t\tsuper.checkAttributeSyntax(perunSession, group, attribute);\n+\t}\n+\n+\t@Override\n+\tpublic void checkAttributeSemantics(PerunSessionImpl perunSession, Group group, Attribute attribute) throws WrongAttributeAssignmentException, WrongReferenceAttributeValueException {\n+\n+\t}\n+\n+\t@Override\n+\tpublic void changedAttributeHook(PerunSessionImpl session, Group group, Attribute attribute) throws WrongReferenceAttributeValueException {\n+\n+\t}\n+\n+\t@Override\n+\tpublic AttributeDefinition getAttributeDefinition() {\n+\t\tAttributeDefinition attr = new AttributeDefinition();\n+\t\tattr.setNamespace(AttributesManager.NS_GROUP_ATTR_DEF);\n+\t\tattr.setFriendlyName(\"groupApplicationAutoExpirationRules\");\n+\t\tattr.setDisplayName(\"Group application auto expiration rules\");", "originalCommit": "882c6c35ed697736bf388c18b079204074f40cb7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDI5Mzg5MA==", "url": "https://github.com/CESNET/perun/pull/2954#discussion_r514293890", "bodyText": "Done", "author": "HejdaJakub", "createdAt": "2020-10-29T14:18:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDE2ODc1MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDE3MjMzOQ==", "url": "https://github.com/CESNET/perun/pull/2954#discussion_r514172339", "bodyText": "I believe attribute.valueAsMap() wouldn't throw a null pointer, since you can cast null to any type. You could simplify it like this:\nMap<String, String> attrValue = attribute.valueAsMap();\n\nif (attrValue == null || attrValue.isEmpty()) return;", "author": "zlamalp", "createdAt": "2020-10-29T11:00:09Z", "path": "perun-core/src/main/java/cz/metacentrum/perun/core/implApi/modules/attributes/AbstractApplicationExpirationRulesModule.java", "diffHunk": "@@ -0,0 +1,54 @@\n+package cz.metacentrum.perun.core.implApi.modules.attributes;\n+\n+import cz.metacentrum.perun.core.api.Attribute;\n+import cz.metacentrum.perun.core.api.PerunBean;\n+import cz.metacentrum.perun.core.api.exceptions.WrongAttributeValueException;\n+import cz.metacentrum.perun.core.impl.PerunSessionImpl;\n+\n+import java.util.Map;\n+import java.util.regex.Matcher;\n+import java.util.regex.Pattern;\n+\n+/**\n+ * @author Jakub Hejda <Jakub.Hejda@cesnet.cz>\n+ */\n+public abstract class AbstractApplicationExpirationRulesModule<T extends PerunBean> extends AttributesModuleAbstract implements AttributesModuleImplApi {\n+\tpublic static final String applicationWaitingForEmailVerificationKeyName = \"emailVerification\";\n+\tpublic static final String applicationIgnoredByAdminKeyName = \"ignoredByAdmin\";\n+\tprivate static final Pattern daysToExpirationPattern = Pattern.compile(\"^\\\\d+$\");\n+\n+\tpublic void checkAttributeSyntax(PerunSessionImpl sess, T entity, Attribute attribute) throws WrongAttributeValueException {\n+\n+\t\tMap<String, String> attrValue;\n+\n+\t\t//For no value is correct (it means no rules)\n+\t\tif (attribute.getValue() == null) return;\n+\n+\t\t//save value to map attrValue\n+\t\tattrValue = attribute.valueAsMap();\n+\n+\t\t//Same for empty HashList\n+\t\tif (attrValue.isEmpty()) return;", "originalCommit": "882c6c35ed697736bf388c18b079204074f40cb7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDI5NDc4Mg==", "url": "https://github.com/CESNET/perun/pull/2954#discussion_r514294782", "bodyText": "Simplified", "author": "HejdaJakub", "createdAt": "2020-10-29T14:19:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDE3MjMzOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDE3Njc1Mw==", "url": "https://github.com/CESNET/perun/pull/2954#discussion_r514176753", "bodyText": "I would prefer having getter/setter and put @Autowired above the setter. Also please specify it in perun-registrar-lib.xml in bean definition.", "author": "zlamalp", "createdAt": "2020-10-29T11:07:58Z", "path": "perun-registrar-lib/src/main/java/cz/metacentrum/perun/registrar/impl/ExpirationNotifScheduler.java", "diffHunk": "@@ -102,6 +106,9 @@ public void setPerun(PerunBl perun) {\n \tpublic ExpirationNotifScheduler() {\n \t}\n \n+\t@Autowired\n+\tprivate RegistrarManager registrarManager;", "originalCommit": "882c6c35ed697736bf388c18b079204074f40cb7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDI5NjcwNA==", "url": "https://github.com/CESNET/perun/pull/2954#discussion_r514296704", "bodyText": "Ok, I changed it like you write above", "author": "HejdaJakub", "createdAt": "2020-10-29T14:21:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDE3Njc1Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDE3OTE5Mw==", "url": "https://github.com/CESNET/perun/pull/2954#discussion_r514179193", "bodyText": "Generally it would be better to try/catch exceptions on each application rejection rather than the bulk of them or all vos. Like this, one exception will discard processing of all other applications, vos and groups.", "author": "zlamalp", "createdAt": "2020-10-29T11:12:21Z", "path": "perun-registrar-lib/src/main/java/cz/metacentrum/perun/registrar/impl/ExpirationNotifScheduler.java", "diffHunk": "@@ -357,6 +378,82 @@ private void checkVoMembersState(List<Vo> vos) throws WrongAttributeAssignmentEx\n \t\texpireSponsorships();\n \t}\n \n+\t/**\n+\t * Checks all applications for given vos and if some application is expired (according to expiration rules set by\n+\t * VO Manager), then rejects this application.\n+\t *\n+\t * @param vos virtual organizations\n+\t * @throws PerunException\n+\t */\n+\tprivate void voApplicationsAutoRejection(List<Vo> vos) throws PerunException {", "originalCommit": "882c6c35ed697736bf388c18b079204074f40cb7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDMwMDQyNA==", "url": "https://github.com/CESNET/perun/pull/2954#discussion_r514300424", "bodyText": "The rejection process is in method rejectExpiredApplications so I added try/catch block here. Is it what you meant?", "author": "HejdaJakub", "createdAt": "2020-10-29T14:26:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDE3OTE5Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDMyODI1Mw==", "url": "https://github.com/CESNET/perun/pull/2954#discussion_r514328253", "bodyText": "Yes, thank you.", "author": "zlamalp", "createdAt": "2020-10-29T15:01:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDE3OTE5Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDE4Mzk3Ng==", "url": "https://github.com/CESNET/perun/pull/2954#discussion_r514183976", "bodyText": "You seem to provide the same rejection message ending (rejected because of expiration rules set for Vo.) for both VO and Group use-case. You can get Vo and Group objects from the Application (group is null for vo applications) and eg. provide entity name in the message, since application ID is generally meaningless to the user, who might even forgot he registered somewhere.\nYou should also state for the user, if it was rejected, because admin didn't do it in the timely manner, or it was users fault, he forgot to verify his mail address.", "author": "zlamalp", "createdAt": "2020-10-29T11:21:29Z", "path": "perun-registrar-lib/src/main/java/cz/metacentrum/perun/registrar/impl/ExpirationNotifScheduler.java", "diffHunk": "@@ -357,6 +378,82 @@ private void checkVoMembersState(List<Vo> vos) throws WrongAttributeAssignmentEx\n \t\texpireSponsorships();\n \t}\n \n+\t/**\n+\t * Checks all applications for given vos and if some application is expired (according to expiration rules set by\n+\t * VO Manager), then rejects this application.\n+\t *\n+\t * @param vos virtual organizations\n+\t * @throws PerunException\n+\t */\n+\tprivate void voApplicationsAutoRejection(List<Vo> vos) throws PerunException {\n+\t\tList<String> states = new ArrayList<>();\n+\t\tstates.add(\"NEW\");\n+\t\tstates.add(\"VERIFIED\");\n+\n+\t\tfor (Vo vo : vos) {\n+\t\t\tAttribute expiration = perun.getAttributesManagerBl().getAttribute(sess, vo, A_VO_APP_EXP_RULES);\n+\t\t\tif (expiration != null) {\n+\t\t\t\tList<Application> applications = registrarManager.getApplicationsForVo(sess, vo, states);\n+\t\t\t\trejectExpiredApplications(applications, expiration);\n+\t\t\t}\n+\t\t}\n+\t}\n+\n+\t/**\n+\t * Gets all existing groups and then checks all applications for this groups and if some application is expired\n+\t * (according to expiration rules set by VO Manager), then rejects this application.\n+\t *\n+\t * @param vos virtual organizations\n+\t * @throws PerunException\n+\t */\n+\tprivate void groupApplicationsAutoRejection(List<Vo> vos) throws PerunException {\n+\t\tList<String> states = new ArrayList<>();\n+\t\tstates.add(\"NEW\");\n+\t\tstates.add(\"VERIFIED\");\n+\n+\t\tList<Group> groups = new ArrayList<>();\n+\t\tfor (Vo vo : vos) {\n+\t\t\tgroups.addAll(perun.getGroupsManagerBl().getGroups(sess, vo));\n+\t\t}\n+\n+\t\tfor (Group group : groups) {\n+\t\t\tAttribute expiration = perun.getAttributesManagerBl().getAttribute(sess, group, A_GROUP_APP_EXP_RULES);\n+\t\t\tif (expiration != null) {\n+\t\t\t\tList<Application> applications = registrarManager.getApplicationsForGroup(sess, group, states);\n+\t\t\t\trejectExpiredApplications(applications, expiration);\n+\t\t\t}\n+\t\t}\n+\t}\n+\n+\t/**\n+\t * Compares creation day of application to values in expiration attribute and if find expired application, then\n+\t * reject it.\n+\t *\n+\t * @param applications applications\n+\t * @param expiration attribute with number of days to application expiration\n+\t * @throws PerunException\n+\t */\n+\tprivate void rejectExpiredApplications (List<Application> applications, Attribute expiration) throws PerunException {\n+\t\tMap<String, String> attrValue = expiration.valueAsMap();\n+\t\tfor(Application application : applications) {\n+\t\t\tString date = application.getCreatedAt();\n+\t\t\tLocalDate createdAt = LocalDate.parse(date.substring(0, 10));\n+\t\t\tLocalDate now = getCurrentLocalDate();\n+\t\t\tif (application.getState().toString().equals(\"NEW\")) {\n+\t\t\t\tint expirationAppWaitingForEmail = Integer.parseInt(attrValue.get(\"emailVerification\"));\n+\t\t\t\tif (now.minusDays(expirationAppWaitingForEmail).isAfter(createdAt)) {\n+\t\t\t\t\tregistrarManager.rejectApplication(sess, application.getId(), \"Application with id \" +", "originalCommit": "882c6c35ed697736bf388c18b079204074f40cb7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDMwMzY4Mw==", "url": "https://github.com/CESNET/perun/pull/2954#discussion_r514303683", "bodyText": "Yes, I forgot about it. Thanks! Now it should be ok.", "author": "HejdaJakub", "createdAt": "2020-10-29T14:30:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDE4Mzk3Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDE4ODExMA==", "url": "https://github.com/CESNET/perun/pull/2954#discussion_r514188110", "bodyText": "You should \"continue\" in the cycle after first rejection above, since code here and below might be applied to the same application object you already processed and would fail on \"already rejected\" kind of exception.", "author": "zlamalp", "createdAt": "2020-10-29T11:29:28Z", "path": "perun-registrar-lib/src/main/java/cz/metacentrum/perun/registrar/impl/ExpirationNotifScheduler.java", "diffHunk": "@@ -357,6 +378,82 @@ private void checkVoMembersState(List<Vo> vos) throws WrongAttributeAssignmentEx\n \t\texpireSponsorships();\n \t}\n \n+\t/**\n+\t * Checks all applications for given vos and if some application is expired (according to expiration rules set by\n+\t * VO Manager), then rejects this application.\n+\t *\n+\t * @param vos virtual organizations\n+\t * @throws PerunException\n+\t */\n+\tprivate void voApplicationsAutoRejection(List<Vo> vos) throws PerunException {\n+\t\tList<String> states = new ArrayList<>();\n+\t\tstates.add(\"NEW\");\n+\t\tstates.add(\"VERIFIED\");\n+\n+\t\tfor (Vo vo : vos) {\n+\t\t\tAttribute expiration = perun.getAttributesManagerBl().getAttribute(sess, vo, A_VO_APP_EXP_RULES);\n+\t\t\tif (expiration != null) {\n+\t\t\t\tList<Application> applications = registrarManager.getApplicationsForVo(sess, vo, states);\n+\t\t\t\trejectExpiredApplications(applications, expiration);\n+\t\t\t}\n+\t\t}\n+\t}\n+\n+\t/**\n+\t * Gets all existing groups and then checks all applications for this groups and if some application is expired\n+\t * (according to expiration rules set by VO Manager), then rejects this application.\n+\t *\n+\t * @param vos virtual organizations\n+\t * @throws PerunException\n+\t */\n+\tprivate void groupApplicationsAutoRejection(List<Vo> vos) throws PerunException {\n+\t\tList<String> states = new ArrayList<>();\n+\t\tstates.add(\"NEW\");\n+\t\tstates.add(\"VERIFIED\");\n+\n+\t\tList<Group> groups = new ArrayList<>();\n+\t\tfor (Vo vo : vos) {\n+\t\t\tgroups.addAll(perun.getGroupsManagerBl().getGroups(sess, vo));\n+\t\t}\n+\n+\t\tfor (Group group : groups) {\n+\t\t\tAttribute expiration = perun.getAttributesManagerBl().getAttribute(sess, group, A_GROUP_APP_EXP_RULES);\n+\t\t\tif (expiration != null) {\n+\t\t\t\tList<Application> applications = registrarManager.getApplicationsForGroup(sess, group, states);\n+\t\t\t\trejectExpiredApplications(applications, expiration);\n+\t\t\t}\n+\t\t}\n+\t}\n+\n+\t/**\n+\t * Compares creation day of application to values in expiration attribute and if find expired application, then\n+\t * reject it.\n+\t *\n+\t * @param applications applications\n+\t * @param expiration attribute with number of days to application expiration\n+\t * @throws PerunException\n+\t */\n+\tprivate void rejectExpiredApplications (List<Application> applications, Attribute expiration) throws PerunException {\n+\t\tMap<String, String> attrValue = expiration.valueAsMap();\n+\t\tfor(Application application : applications) {\n+\t\t\tString date = application.getCreatedAt();\n+\t\t\tLocalDate createdAt = LocalDate.parse(date.substring(0, 10));\n+\t\t\tLocalDate now = getCurrentLocalDate();\n+\t\t\tif (application.getState().toString().equals(\"NEW\")) {\n+\t\t\t\tint expirationAppWaitingForEmail = Integer.parseInt(attrValue.get(\"emailVerification\"));\n+\t\t\t\tif (now.minusDays(expirationAppWaitingForEmail).isAfter(createdAt)) {\n+\t\t\t\t\tregistrarManager.rejectApplication(sess, application.getId(), \"Application with id \" +\n+\t\t\t\t\t\tapplication.getId() + \" was auto rejected because of expiration rules set for Vo.\");\n+\t\t\t\t}\n+\t\t\t}\n+\t\t\tint expirationAppIgnoredByAdmin = Integer.parseInt(attrValue.get(\"ignoredByAdmin\"));", "originalCommit": "882c6c35ed697736bf388c18b079204074f40cb7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDM2MTc0OQ==", "url": "https://github.com/CESNET/perun/pull/2954#discussion_r514361749", "bodyText": "Done", "author": "HejdaJakub", "createdAt": "2020-10-29T15:42:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDE4ODExMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDE4ODkzNA==", "url": "https://github.com/CESNET/perun/pull/2954#discussion_r514188934", "bodyText": "We might want to compute the time against modified_at in this case, since created_at is about NEW applications, and vo manager can't even approve such applications.\nExpected time for admin reaction/approval would be shortened like this by the time it took the user to verify his application.", "author": "zlamalp", "createdAt": "2020-10-29T11:31:05Z", "path": "perun-registrar-lib/src/main/java/cz/metacentrum/perun/registrar/impl/ExpirationNotifScheduler.java", "diffHunk": "@@ -357,6 +378,82 @@ private void checkVoMembersState(List<Vo> vos) throws WrongAttributeAssignmentEx\n \t\texpireSponsorships();\n \t}\n \n+\t/**\n+\t * Checks all applications for given vos and if some application is expired (according to expiration rules set by\n+\t * VO Manager), then rejects this application.\n+\t *\n+\t * @param vos virtual organizations\n+\t * @throws PerunException\n+\t */\n+\tprivate void voApplicationsAutoRejection(List<Vo> vos) throws PerunException {\n+\t\tList<String> states = new ArrayList<>();\n+\t\tstates.add(\"NEW\");\n+\t\tstates.add(\"VERIFIED\");\n+\n+\t\tfor (Vo vo : vos) {\n+\t\t\tAttribute expiration = perun.getAttributesManagerBl().getAttribute(sess, vo, A_VO_APP_EXP_RULES);\n+\t\t\tif (expiration != null) {\n+\t\t\t\tList<Application> applications = registrarManager.getApplicationsForVo(sess, vo, states);\n+\t\t\t\trejectExpiredApplications(applications, expiration);\n+\t\t\t}\n+\t\t}\n+\t}\n+\n+\t/**\n+\t * Gets all existing groups and then checks all applications for this groups and if some application is expired\n+\t * (according to expiration rules set by VO Manager), then rejects this application.\n+\t *\n+\t * @param vos virtual organizations\n+\t * @throws PerunException\n+\t */\n+\tprivate void groupApplicationsAutoRejection(List<Vo> vos) throws PerunException {\n+\t\tList<String> states = new ArrayList<>();\n+\t\tstates.add(\"NEW\");\n+\t\tstates.add(\"VERIFIED\");\n+\n+\t\tList<Group> groups = new ArrayList<>();\n+\t\tfor (Vo vo : vos) {\n+\t\t\tgroups.addAll(perun.getGroupsManagerBl().getGroups(sess, vo));\n+\t\t}\n+\n+\t\tfor (Group group : groups) {\n+\t\t\tAttribute expiration = perun.getAttributesManagerBl().getAttribute(sess, group, A_GROUP_APP_EXP_RULES);\n+\t\t\tif (expiration != null) {\n+\t\t\t\tList<Application> applications = registrarManager.getApplicationsForGroup(sess, group, states);\n+\t\t\t\trejectExpiredApplications(applications, expiration);\n+\t\t\t}\n+\t\t}\n+\t}\n+\n+\t/**\n+\t * Compares creation day of application to values in expiration attribute and if find expired application, then\n+\t * reject it.\n+\t *\n+\t * @param applications applications\n+\t * @param expiration attribute with number of days to application expiration\n+\t * @throws PerunException\n+\t */\n+\tprivate void rejectExpiredApplications (List<Application> applications, Attribute expiration) throws PerunException {\n+\t\tMap<String, String> attrValue = expiration.valueAsMap();\n+\t\tfor(Application application : applications) {\n+\t\t\tString date = application.getCreatedAt();\n+\t\t\tLocalDate createdAt = LocalDate.parse(date.substring(0, 10));\n+\t\t\tLocalDate now = getCurrentLocalDate();\n+\t\t\tif (application.getState().toString().equals(\"NEW\")) {\n+\t\t\t\tint expirationAppWaitingForEmail = Integer.parseInt(attrValue.get(\"emailVerification\"));\n+\t\t\t\tif (now.minusDays(expirationAppWaitingForEmail).isAfter(createdAt)) {\n+\t\t\t\t\tregistrarManager.rejectApplication(sess, application.getId(), \"Application with id \" +\n+\t\t\t\t\t\tapplication.getId() + \" was auto rejected because of expiration rules set for Vo.\");\n+\t\t\t\t}\n+\t\t\t}\n+\t\t\tint expirationAppIgnoredByAdmin = Integer.parseInt(attrValue.get(\"ignoredByAdmin\"));\n+\t\t\tif (now.minusDays(expirationAppIgnoredByAdmin).isAfter(createdAt)) {", "originalCommit": "882c6c35ed697736bf388c18b079204074f40cb7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDMwNDE5Mg==", "url": "https://github.com/CESNET/perun/pull/2954#discussion_r514304192", "bodyText": "Changed", "author": "HejdaJakub", "createdAt": "2020-10-29T14:31:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDE4ODkzNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDE5Mjc1MA==", "url": "https://github.com/CESNET/perun/pull/2954#discussion_r514192750", "bodyText": "I don't get that. This deletes all vo and group applications of that VO. Shouldn't each test have own rollbacked transaction? Why do you do this?", "author": "zlamalp", "createdAt": "2020-10-29T11:38:26Z", "path": "perun-registrar-lib/src/test/java/cz/metacentrum/perun/registrar/ExpirationNotifSchedulerTest.java", "diffHunk": "@@ -232,6 +239,70 @@ public void checkMembersState() throws Exception {\n \n \t}\n \n+\t@Test\n+\tpublic void checkVoApplicationShouldBeAutoRejected() throws Exception {\n+\t\tSystem.out.println(CLASS_NAME + \"checkVoApplicationShouldBeAutoRejected\");\n+\n+\t\tApplication submitApp = setUpAndSubmitAppForPotentialAutoRejection(70, null, VO_APP_EXP_RULES);\n+\n+\t\tReflectionTestUtils.invokeMethod(spyScheduler, \"voApplicationsAutoRejection\", perun.getVosManagerBl().getVos(session));\n+\n+\t\t// check results\n+\t\tApplication returnedApp = registrarManager.getApplicationById(session, submitApp.getId());\n+\t\tassertEquals(\"Application should be rejected.\", returnedApp.getState(), Application.AppState.REJECTED);\n+\t}\n+\n+\t@Test\n+\tpublic void checkVoApplicationShouldNotBeAutoRejected() throws Exception {\n+\t\tSystem.out.println(CLASS_NAME + \"checkVoApplicationShouldNotBeAutoRejected\");\n+\n+\t\tApplication submitApp = setUpAndSubmitAppForPotentialAutoRejection(50, null, VO_APP_EXP_RULES);\n+\n+\t\tReflectionTestUtils.invokeMethod(spyScheduler, \"voApplicationsAutoRejection\", perun.getVosManagerBl().getVos(session));\n+\n+\t\t// check results\n+\t\tApplication returnedApp = registrarManager.getApplicationById(session, submitApp.getId());\n+\t\tassertEquals(\"Application shouldn't be rejected.\", returnedApp.getState(), Application.AppState.VERIFIED);\n+\t}\n+\n+\t@Test\n+\tpublic void checkGroupApplicationShouldBeAutoRejected() throws Exception {\n+\t\tSystem.out.println(CLASS_NAME + \"checkGroupApplicationAutoRejection\");\n+\n+\t\tjdbc.update(\"DELETE from application_form WHERE vo_id = ?\", vo.getId());", "originalCommit": "882c6c35ed697736bf388c18b079204074f40cb7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDIwMjU2Mg==", "url": "https://github.com/CESNET/perun/pull/2954#discussion_r514202562", "bodyText": "This is actually necessary because the HSQLDB has a slightly different schema. In the regular postgres.sql we have:\ncreate unique index applform_u1 on application_form (vo_id) where group_id is null;\ncreate unique index applform_u2 on application_form (vo_id, group_id) where group_id is not null;\n\nBut in the test-schema.sql:\ncreate unique index applform_u1 on application_form (vo_id);\ncreate unique index applform_u2 on application_form (vo_id, group_id);\n\nIt seems that HSQLDB doesn't support the where condition. Because of that, in tests, there can be only a single application form across the whole Vo and its groups.\nSo, to create an application form in a group, you have to delete the form for its vo.", "author": "Vojtech-Sassmann", "createdAt": "2020-10-29T11:57:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDE5Mjc1MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDIwMjk4Ng==", "url": "https://github.com/CESNET/perun/pull/2954#discussion_r514202986", "bodyText": "I couldn't figure out a better solution, so I suggested this workaround for now.", "author": "Vojtech-Sassmann", "createdAt": "2020-10-29T11:57:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDE5Mjc1MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDMyNjQxMw==", "url": "https://github.com/CESNET/perun/pull/2954#discussion_r514326413", "bodyText": "Wow, didn't know that. Maybe this note should be in the test method and it should be called only for HSQLDB, since we sometime run tests against real DB, where this condition doesn't apply.", "author": "zlamalp", "createdAt": "2020-10-29T14:58:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDE5Mjc1MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDE5MzQxOA==", "url": "https://github.com/CESNET/perun/pull/2954#discussion_r514193418", "bodyText": "I would prefer only passing expected VO in the list. Otherwise it would process all VOs in the DB. We sometimes run tests against non-empty devel DB.", "author": "zlamalp", "createdAt": "2020-10-29T11:39:44Z", "path": "perun-registrar-lib/src/test/java/cz/metacentrum/perun/registrar/ExpirationNotifSchedulerTest.java", "diffHunk": "@@ -232,6 +239,70 @@ public void checkMembersState() throws Exception {\n \n \t}\n \n+\t@Test\n+\tpublic void checkVoApplicationShouldBeAutoRejected() throws Exception {\n+\t\tSystem.out.println(CLASS_NAME + \"checkVoApplicationShouldBeAutoRejected\");\n+\n+\t\tApplication submitApp = setUpAndSubmitAppForPotentialAutoRejection(70, null, VO_APP_EXP_RULES);\n+\n+\t\tReflectionTestUtils.invokeMethod(spyScheduler, \"voApplicationsAutoRejection\", perun.getVosManagerBl().getVos(session));\n+\n+\t\t// check results\n+\t\tApplication returnedApp = registrarManager.getApplicationById(session, submitApp.getId());\n+\t\tassertEquals(\"Application should be rejected.\", returnedApp.getState(), Application.AppState.REJECTED);\n+\t}\n+\n+\t@Test\n+\tpublic void checkVoApplicationShouldNotBeAutoRejected() throws Exception {\n+\t\tSystem.out.println(CLASS_NAME + \"checkVoApplicationShouldNotBeAutoRejected\");\n+\n+\t\tApplication submitApp = setUpAndSubmitAppForPotentialAutoRejection(50, null, VO_APP_EXP_RULES);\n+\n+\t\tReflectionTestUtils.invokeMethod(spyScheduler, \"voApplicationsAutoRejection\", perun.getVosManagerBl().getVos(session));\n+\n+\t\t// check results\n+\t\tApplication returnedApp = registrarManager.getApplicationById(session, submitApp.getId());\n+\t\tassertEquals(\"Application shouldn't be rejected.\", returnedApp.getState(), Application.AppState.VERIFIED);\n+\t}\n+\n+\t@Test\n+\tpublic void checkGroupApplicationShouldBeAutoRejected() throws Exception {\n+\t\tSystem.out.println(CLASS_NAME + \"checkGroupApplicationAutoRejection\");\n+\n+\t\tjdbc.update(\"DELETE from application_form WHERE vo_id = ?\", vo.getId());\n+\n+\t\tGroup group = new Group();\n+\t\tgroup.setName(\"Group for apply\");\n+\t\tperun.getGroupsManagerBl().createGroup(session, vo, group);\n+\n+\t\tApplication submitApp = setUpAndSubmitAppForPotentialAutoRejection(70, group, GROUP_APP_EXP_RULES);\n+\n+\t\tReflectionTestUtils.invokeMethod(spyScheduler, \"groupApplicationsAutoRejection\", perun.getVosManagerBl().getVos(session));\n+\n+\t\t// check results\n+\t\tApplication returnedApp = registrarManager.getApplicationById(session, submitApp.getId());\n+\t\tassertEquals(\"Application should be rejected.\", returnedApp.getState(), Application.AppState.REJECTED);\n+\t}\n+\t@Test\n+\tpublic void checkGroupApplicationShouldNotBeAutoRejected() throws Exception {\n+\t\tSystem.out.println(CLASS_NAME + \"checkGroupApplicationAutoRejection\");\n+\n+\t\tjdbc.update(\"DELETE from application_form WHERE vo_id = ?\", vo.getId());\n+\n+\t\tGroup group = new Group();\n+\t\tgroup.setName(\"Group for apply\");\n+\t\tperun.getGroupsManagerBl().createGroup(session, vo, group);\n+\n+\t\tApplication submitApp = setUpAndSubmitAppForPotentialAutoRejection(50, group, GROUP_APP_EXP_RULES);\n+\n+\t\tReflectionTestUtils.invokeMethod(spyScheduler, \"groupApplicationsAutoRejection\", perun.getVosManagerBl().getVos(session));", "originalCommit": "882c6c35ed697736bf388c18b079204074f40cb7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDMwNTU2Mg==", "url": "https://github.com/CESNET/perun/pull/2954#discussion_r514305562", "bodyText": "Changed to singleton list of expected vo", "author": "HejdaJakub", "createdAt": "2020-10-29T14:33:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDE5MzQxOA=="}], "type": "inlineReview"}, {"oid": "641bcf85d6d9ac1937c2a1884cc71054f5195930", "url": "https://github.com/CESNET/perun/commit/641bcf85d6d9ac1937c2a1884cc71054f5195930", "message": "Application auto rejection\n\n* I created two expiration attributes - one for group and one for VO.\n* I also created methods for auto rejection of expired applications.\n* Now is posible to set number of days to expiration of applications in each group and VO. If application is expired, then will be auto rejected.", "committedDate": "2020-10-29T14:09:51Z", "type": "forcePushed"}, {"oid": "507591da4ab569e42d0f3aea2fc9c9b2db256379", "url": "https://github.com/CESNET/perun/commit/507591da4ab569e42d0f3aea2fc9c9b2db256379", "message": "Application auto rejection\n\n* I created two expiration attributes - one for group and one for VO.\n* I also created methods for auto rejection of expired applications.\n* Now is posible to set number of days to expiration of applications in each group and VO. If application is expired, then will be auto rejected.", "committedDate": "2020-10-29T14:29:56Z", "type": "forcePushed"}, {"oid": "c1c8fb87a8204ccae6bcaf5adc4b11f690534331", "url": "https://github.com/CESNET/perun/commit/c1c8fb87a8204ccae6bcaf5adc4b11f690534331", "message": "Application auto rejection\n\n* I created two expiration attributes - one for group and one for VO.\n* I also created methods for auto rejection of expired applications.\n* Now is posible to set number of days to expiration of applications in each group and VO. If application is expired, then will be auto rejected.", "committedDate": "2020-10-29T15:40:11Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDU0MDQ1NQ==", "url": "https://github.com/CESNET/perun/pull/2954#discussion_r514540455", "bodyText": "We no longer throw PerunException.", "author": "zlamalp", "createdAt": "2020-10-29T20:17:26Z", "path": "perun-registrar-lib/src/main/java/cz/metacentrum/perun/registrar/impl/ExpirationNotifScheduler.java", "diffHunk": "@@ -357,6 +382,102 @@ private void checkVoMembersState(List<Vo> vos) throws WrongAttributeAssignmentEx\n \t\texpireSponsorships();\n \t}\n \n+\t/**\n+\t * Checks all applications for given vos and if some application is expired (according to expiration rules set by\n+\t * VO Manager), then rejects this application.\n+\t *\n+\t * @param vos virtual organizations\n+\t * @throws PerunException\n+\t */\n+\tprivate void voApplicationsAutoRejection(List<Vo> vos) throws PerunException {\n+\t\tList<String> states = new ArrayList<>();\n+\t\tstates.add(\"NEW\");\n+\t\tstates.add(\"VERIFIED\");\n+\n+\t\tfor (Vo vo : vos) {\n+\t\t\tAttribute expiration = perun.getAttributesManagerBl().getAttribute(sess, vo, A_VO_APP_EXP_RULES);\n+\t\t\tif (expiration.getValue() != null) {\n+\t\t\t\tList<Application> applications = registrarManager.getApplicationsForVo(sess, vo, states);\n+\t\t\t\trejectExpiredApplications(applications, expiration);\n+\t\t\t}\n+\t\t}\n+\t}\n+\n+\t/**\n+\t * Gets all existing groups and then checks all applications for this groups and if some application is expired\n+\t * (according to expiration rules set by VO Manager), then rejects this application.\n+\t *\n+\t * @param vos virtual organizations\n+\t * @throws PerunException\n+\t */\n+\tprivate void groupApplicationsAutoRejection(List<Vo> vos) throws PerunException {\n+\t\tList<String> states = new ArrayList<>();\n+\t\tstates.add(\"NEW\");\n+\t\tstates.add(\"VERIFIED\");\n+\n+\t\tList<Group> groups = new ArrayList<>();\n+\t\tfor (Vo vo : vos) {\n+\t\t\tgroups.addAll(perun.getGroupsManagerBl().getGroups(sess, vo));\n+\t\t}\n+\n+\t\tfor (Group group : groups) {\n+\t\t\tAttribute expiration = perun.getAttributesManagerBl().getAttribute(sess, group, A_GROUP_APP_EXP_RULES);\n+\t\t\tif (expiration.getValue() != null) {\n+\t\t\t\tList<Application> applications = registrarManager.getApplicationsForGroup(sess, group, states);\n+\t\t\t\trejectExpiredApplications(applications, expiration);\n+\t\t\t}\n+\t\t}\n+\t}\n+\n+\t/**\n+\t * Compares creation day of application to values in expiration attribute and if find expired application, then\n+\t * reject it.\n+\t *\n+\t * @param applications applications\n+\t * @param expiration attribute with number of days to application expiration\n+\t * @throws PerunException", "originalCommit": "c1c8fb87a8204ccae6bcaf5adc4b11f690534331", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDkwNDkyNA==", "url": "https://github.com/CESNET/perun/pull/2954#discussion_r514904924", "bodyText": "Javadoc has been edited", "author": "HejdaJakub", "createdAt": "2020-10-30T07:03:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDU0MDQ1NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDU0MDk2OA==", "url": "https://github.com/CESNET/perun/pull/2954#discussion_r514540968", "bodyText": "We now check against last modification timestamp, not creation day of application. Only for NEW applications, modified_at and created_at should be equal.", "author": "zlamalp", "createdAt": "2020-10-29T20:18:29Z", "path": "perun-registrar-lib/src/main/java/cz/metacentrum/perun/registrar/impl/ExpirationNotifScheduler.java", "diffHunk": "@@ -357,6 +382,102 @@ private void checkVoMembersState(List<Vo> vos) throws WrongAttributeAssignmentEx\n \t\texpireSponsorships();\n \t}\n \n+\t/**\n+\t * Checks all applications for given vos and if some application is expired (according to expiration rules set by\n+\t * VO Manager), then rejects this application.\n+\t *\n+\t * @param vos virtual organizations\n+\t * @throws PerunException\n+\t */\n+\tprivate void voApplicationsAutoRejection(List<Vo> vos) throws PerunException {\n+\t\tList<String> states = new ArrayList<>();\n+\t\tstates.add(\"NEW\");\n+\t\tstates.add(\"VERIFIED\");\n+\n+\t\tfor (Vo vo : vos) {\n+\t\t\tAttribute expiration = perun.getAttributesManagerBl().getAttribute(sess, vo, A_VO_APP_EXP_RULES);\n+\t\t\tif (expiration.getValue() != null) {\n+\t\t\t\tList<Application> applications = registrarManager.getApplicationsForVo(sess, vo, states);\n+\t\t\t\trejectExpiredApplications(applications, expiration);\n+\t\t\t}\n+\t\t}\n+\t}\n+\n+\t/**\n+\t * Gets all existing groups and then checks all applications for this groups and if some application is expired\n+\t * (according to expiration rules set by VO Manager), then rejects this application.\n+\t *\n+\t * @param vos virtual organizations\n+\t * @throws PerunException\n+\t */\n+\tprivate void groupApplicationsAutoRejection(List<Vo> vos) throws PerunException {\n+\t\tList<String> states = new ArrayList<>();\n+\t\tstates.add(\"NEW\");\n+\t\tstates.add(\"VERIFIED\");\n+\n+\t\tList<Group> groups = new ArrayList<>();\n+\t\tfor (Vo vo : vos) {\n+\t\t\tgroups.addAll(perun.getGroupsManagerBl().getGroups(sess, vo));\n+\t\t}\n+\n+\t\tfor (Group group : groups) {\n+\t\t\tAttribute expiration = perun.getAttributesManagerBl().getAttribute(sess, group, A_GROUP_APP_EXP_RULES);\n+\t\t\tif (expiration.getValue() != null) {\n+\t\t\t\tList<Application> applications = registrarManager.getApplicationsForGroup(sess, group, states);\n+\t\t\t\trejectExpiredApplications(applications, expiration);\n+\t\t\t}\n+\t\t}\n+\t}\n+\n+\t/**\n+\t * Compares creation day of application to values in expiration attribute and if find expired application, then", "originalCommit": "c1c8fb87a8204ccae6bcaf5adc4b11f690534331", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDkwNTEzMQ==", "url": "https://github.com/CESNET/perun/pull/2954#discussion_r514905131", "bodyText": "Also edited", "author": "HejdaJakub", "createdAt": "2020-10-30T07:04:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDU0MDk2OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDU0MjgyMw==", "url": "https://github.com/CESNET/perun/pull/2954#discussion_r514542823", "bodyText": "Probably not as a part of this pull-request, but we should really implement specific methods to get only such VOs and Groups, where there are expiration rules defined and which have some unprocessed applications.\nLike this we are checking too much vos/group (like on BBMRI there is cca 6000 groups, but only a few have applications).\nAlso I feel like we should split this. We can have own class for application expiration and trigger it separately from the member expiration logic.", "author": "zlamalp", "createdAt": "2020-10-29T20:22:07Z", "path": "perun-registrar-lib/src/main/java/cz/metacentrum/perun/registrar/impl/ExpirationNotifScheduler.java", "diffHunk": "@@ -321,6 +332,20 @@ public void checkMembersState() {\n \t\t\tlog.error(\"Synchronizer: checkMembersState, attribute name is from wrong namespace.\", e);\n \t\t}\n \n+\t\t// check applications expiration in vos\n+\t\ttry {\n+\t\t\tvoApplicationsAutoRejection(vos);", "originalCommit": "c1c8fb87a8204ccae6bcaf5adc4b11f690534331", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDU0ODE1Nw==", "url": "https://github.com/CESNET/perun/pull/2954#discussion_r514548157", "bodyText": "I agree with both. But I am not sure we can now get attributes for entites where the attribute is set(at least I dont know about such metod?).\nAlso, there is a lot of things happenening in this class and it would be definitely worth splitting it up.", "author": "Vojtech-Sassmann", "createdAt": "2020-10-29T20:31:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDU0MjgyMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDU1NDkxNA==", "url": "https://github.com/CESNET/perun/pull/2954#discussion_r514554914", "bodyText": "There isn't such generic method, but if we split this logic, we can simply add new specific query method to get us just what we want - like when we get only members with expiration relative to passed date in the membership expiration logic.", "author": "zlamalp", "createdAt": "2020-10-29T20:44:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDU0MjgyMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDU0NjA5Mw==", "url": "https://github.com/CESNET/perun/pull/2954#discussion_r514546093", "bodyText": "I forgot to mention, that you should call this only for HSQLDB, since it doesn't apply to the Postgres DB. See Compatibility.isHSQLDB().", "author": "zlamalp", "createdAt": "2020-10-29T20:28:16Z", "path": "perun-registrar-lib/src/test/java/cz/metacentrum/perun/registrar/ExpirationNotifSchedulerTest.java", "diffHunk": "@@ -686,4 +751,81 @@ private AttributeDefinition setUpGroupMembershipExpirationAttribute() throws Exc\n \n \t\treturn perun.getAttributesManager().createAttribute(session, attr);\n \t}\n+\n+\t/**\n+\t * In test DB in application_form is created unique index for vo_id without dependency on group_id, so if you\n+\t * want to create application form for group, firstly you have to delete automatically created form for Vo.\n+\t * Then method creates new group.\n+\t *\n+\t * @return created group\n+\t * @throws GroupExistsException\n+\t */\n+\tprivate Group deleteApplicationFormAndCreateGroup() throws GroupExistsException {\n+\t\t// delete automatically created form for Vo\n+\t\tjdbc.update(\"DELETE from application_form WHERE vo_id = ?\", vo.getId());", "originalCommit": "c1c8fb87a8204ccae6bcaf5adc4b11f690534331", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDkwNjQ4NQ==", "url": "https://github.com/CESNET/perun/pull/2954#discussion_r514906485", "bodyText": "It's true! So edited", "author": "HejdaJakub", "createdAt": "2020-10-30T07:08:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDU0NjA5Mw=="}], "type": "inlineReview"}, {"oid": "01748ece49e002c2abe9877c69a86fdf08f7e85e", "url": "https://github.com/CESNET/perun/commit/01748ece49e002c2abe9877c69a86fdf08f7e85e", "message": "Application auto rejection\n\n* I created two expiration attributes - one for group and one for VO.\n* I also created methods for auto rejection of expired applications.\n* Now is posible to set number of days to expiration of applications in each group and VO. If application is expired, then will be auto rejected.", "committedDate": "2020-10-30T07:00:54Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDk3ODIxMg==", "url": "https://github.com/CESNET/perun/pull/2954#discussion_r514978212", "bodyText": "This doesn't have to be part of this PR, but this method would deserve to be split into multiple methods. With so many indentations, it isn't easy to navigate in it.", "author": "Vojtech-Sassmann", "createdAt": "2020-10-30T09:46:22Z", "path": "perun-registrar-lib/src/main/java/cz/metacentrum/perun/registrar/impl/ExpirationNotifScheduler.java", "diffHunk": "@@ -357,6 +382,101 @@ private void checkVoMembersState(List<Vo> vos) throws WrongAttributeAssignmentEx\n \t\texpireSponsorships();\n \t}\n \n+\t/**\n+\t * Checks all applications for given vos and if some application is expired (according to expiration rules set by\n+\t * VO Manager), then rejects this application.\n+\t *\n+\t * @param vos virtual organizations\n+\t * @throws PerunException\n+\t */\n+\tprivate void voApplicationsAutoRejection(List<Vo> vos) throws PerunException {\n+\t\tList<String> states = new ArrayList<>();\n+\t\tstates.add(\"NEW\");\n+\t\tstates.add(\"VERIFIED\");\n+\n+\t\tfor (Vo vo : vos) {\n+\t\t\tAttribute expiration = perun.getAttributesManagerBl().getAttribute(sess, vo, A_VO_APP_EXP_RULES);\n+\t\t\tif (expiration.getValue() != null) {\n+\t\t\t\tList<Application> applications = registrarManager.getApplicationsForVo(sess, vo, states);\n+\t\t\t\trejectExpiredApplications(applications, expiration);\n+\t\t\t}\n+\t\t}\n+\t}\n+\n+\t/**\n+\t * Gets all existing groups and then checks all applications for this groups and if some application is expired\n+\t * (according to expiration rules set by VO Manager), then rejects this application.\n+\t *\n+\t * @param vos virtual organizations\n+\t * @throws PerunException\n+\t */\n+\tprivate void groupApplicationsAutoRejection(List<Vo> vos) throws PerunException {\n+\t\tList<String> states = new ArrayList<>();\n+\t\tstates.add(\"NEW\");\n+\t\tstates.add(\"VERIFIED\");\n+\n+\t\tList<Group> groups = new ArrayList<>();\n+\t\tfor (Vo vo : vos) {\n+\t\t\tgroups.addAll(perun.getGroupsManagerBl().getGroups(sess, vo));\n+\t\t}\n+\n+\t\tfor (Group group : groups) {\n+\t\t\tAttribute expiration = perun.getAttributesManagerBl().getAttribute(sess, group, A_GROUP_APP_EXP_RULES);\n+\t\t\tif (expiration.getValue() != null) {\n+\t\t\t\tList<Application> applications = registrarManager.getApplicationsForGroup(sess, group, states);\n+\t\t\t\trejectExpiredApplications(applications, expiration);\n+\t\t\t}\n+\t\t}\n+\t}\n+\n+\t/**\n+\t * Compares date of last modification of application to values in expiration attribute and if finds expired application, then\n+\t * rejects it.\n+\t *\n+\t * @param applications applications\n+\t * @param expiration attribute with number of days to application expiration\n+\t */\n+\tprivate void rejectExpiredApplications (List<Application> applications, Attribute expiration) {", "originalCommit": "01748ece49e002c2abe9877c69a86fdf08f7e85e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDk3OTI5OQ==", "url": "https://github.com/CESNET/perun/pull/2954#discussion_r514979299", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t\tSystem.out.println(CLASS_NAME + \"checkGroupApplicationAutoRejection\");\n          \n          \n            \n            \t\tSystem.out.println(CLASS_NAME + \"checkGroupApplicationShouldNotBeAutoRejected\");", "author": "Vojtech-Sassmann", "createdAt": "2020-10-30T09:48:14Z", "path": "perun-registrar-lib/src/test/java/cz/metacentrum/perun/registrar/ExpirationNotifSchedulerTest.java", "diffHunk": "@@ -232,6 +242,62 @@ public void checkMembersState() throws Exception {\n \n \t}\n \n+\t@Test\n+\tpublic void checkVoApplicationShouldBeAutoRejected() throws Exception {\n+\t\tSystem.out.println(CLASS_NAME + \"checkVoApplicationShouldBeAutoRejected\");\n+\n+\t\tApplication submitApp = setUpAndSubmitAppForPotentialAutoRejection(70, null, VO_APP_EXP_RULES);\n+\n+\t\tReflectionTestUtils.invokeMethod(spyScheduler, \"voApplicationsAutoRejection\", Collections.singletonList(vo));\n+\n+\t\t// check results\n+\t\tApplication returnedApp = registrarManager.getApplicationById(session, submitApp.getId());\n+\t\tassertEquals(\"Application should be rejected.\", returnedApp.getState(), Application.AppState.REJECTED);\n+\t}\n+\n+\t@Test\n+\tpublic void checkVoApplicationShouldNotBeAutoRejected() throws Exception {\n+\t\tSystem.out.println(CLASS_NAME + \"checkVoApplicationShouldNotBeAutoRejected\");\n+\n+\t\tApplication submitApp = setUpAndSubmitAppForPotentialAutoRejection(50, null, VO_APP_EXP_RULES);\n+\n+\t\tReflectionTestUtils.invokeMethod(spyScheduler, \"voApplicationsAutoRejection\", Collections.singletonList(vo));\n+\n+\t\t// check results\n+\t\tApplication returnedApp = registrarManager.getApplicationById(session, submitApp.getId());\n+\t\tassertEquals(\"Application shouldn't be rejected.\", returnedApp.getState(), Application.AppState.VERIFIED);\n+\t}\n+\n+\t@Test\n+\tpublic void checkGroupApplicationShouldBeAutoRejected() throws Exception {\n+\t\tSystem.out.println(CLASS_NAME + \"checkGroupApplicationAutoRejection\");\n+\n+\t\tGroup group = deleteApplicationFormAndCreateGroup();\n+\n+\t\tApplication submitApp = setUpAndSubmitAppForPotentialAutoRejection(70, group, GROUP_APP_EXP_RULES);\n+\n+\t\tReflectionTestUtils.invokeMethod(spyScheduler, \"groupApplicationsAutoRejection\", Collections.singletonList(vo));\n+\n+\t\t// check results\n+\t\tApplication returnedApp = registrarManager.getApplicationById(session, submitApp.getId());\n+\t\tassertEquals(\"Application should be rejected.\", returnedApp.getState(), Application.AppState.REJECTED);\n+\t}\n+\t@Test\n+\tpublic void checkGroupApplicationShouldNotBeAutoRejected() throws Exception {\n+\t\tSystem.out.println(CLASS_NAME + \"checkGroupApplicationAutoRejection\");", "originalCommit": "01748ece49e002c2abe9877c69a86fdf08f7e85e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDk5MTg2Mg==", "url": "https://github.com/CESNET/perun/pull/2954#discussion_r514991862", "bodyText": "Done", "author": "HejdaJakub", "createdAt": "2020-10-30T10:11:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDk3OTI5OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDk3OTM4Nw==", "url": "https://github.com/CESNET/perun/pull/2954#discussion_r514979387", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t\tSystem.out.println(CLASS_NAME + \"checkGroupApplicationAutoRejection\");\n          \n          \n            \n            \t\tSystem.out.println(CLASS_NAME + \"checkGroupApplicationShouldBeAutoRejected\");", "author": "Vojtech-Sassmann", "createdAt": "2020-10-30T09:48:23Z", "path": "perun-registrar-lib/src/test/java/cz/metacentrum/perun/registrar/ExpirationNotifSchedulerTest.java", "diffHunk": "@@ -232,6 +242,62 @@ public void checkMembersState() throws Exception {\n \n \t}\n \n+\t@Test\n+\tpublic void checkVoApplicationShouldBeAutoRejected() throws Exception {\n+\t\tSystem.out.println(CLASS_NAME + \"checkVoApplicationShouldBeAutoRejected\");\n+\n+\t\tApplication submitApp = setUpAndSubmitAppForPotentialAutoRejection(70, null, VO_APP_EXP_RULES);\n+\n+\t\tReflectionTestUtils.invokeMethod(spyScheduler, \"voApplicationsAutoRejection\", Collections.singletonList(vo));\n+\n+\t\t// check results\n+\t\tApplication returnedApp = registrarManager.getApplicationById(session, submitApp.getId());\n+\t\tassertEquals(\"Application should be rejected.\", returnedApp.getState(), Application.AppState.REJECTED);\n+\t}\n+\n+\t@Test\n+\tpublic void checkVoApplicationShouldNotBeAutoRejected() throws Exception {\n+\t\tSystem.out.println(CLASS_NAME + \"checkVoApplicationShouldNotBeAutoRejected\");\n+\n+\t\tApplication submitApp = setUpAndSubmitAppForPotentialAutoRejection(50, null, VO_APP_EXP_RULES);\n+\n+\t\tReflectionTestUtils.invokeMethod(spyScheduler, \"voApplicationsAutoRejection\", Collections.singletonList(vo));\n+\n+\t\t// check results\n+\t\tApplication returnedApp = registrarManager.getApplicationById(session, submitApp.getId());\n+\t\tassertEquals(\"Application shouldn't be rejected.\", returnedApp.getState(), Application.AppState.VERIFIED);\n+\t}\n+\n+\t@Test\n+\tpublic void checkGroupApplicationShouldBeAutoRejected() throws Exception {\n+\t\tSystem.out.println(CLASS_NAME + \"checkGroupApplicationAutoRejection\");", "originalCommit": "01748ece49e002c2abe9877c69a86fdf08f7e85e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDk5MTkxNA==", "url": "https://github.com/CESNET/perun/pull/2954#discussion_r514991914", "bodyText": "Done", "author": "HejdaJakub", "createdAt": "2020-10-30T10:11:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDk3OTM4Nw=="}], "type": "inlineReview"}, {"oid": "f5a1bddd5911e7a3cd31d64ad756561c7ab0a0ee", "url": "https://github.com/CESNET/perun/commit/f5a1bddd5911e7a3cd31d64ad756561c7ab0a0ee", "message": "Application auto rejection\n\n* I created two expiration attributes - one for group and one for VO.\n* I also created methods for auto rejection of expired applications.\n* Now is posible to set number of days to expiration of applications in each group and VO. If application is expired, then will be auto rejected.", "committedDate": "2020-10-30T10:09:48Z", "type": "commit"}, {"oid": "f5a1bddd5911e7a3cd31d64ad756561c7ab0a0ee", "url": "https://github.com/CESNET/perun/commit/f5a1bddd5911e7a3cd31d64ad756561c7ab0a0ee", "message": "Application auto rejection\n\n* I created two expiration attributes - one for group and one for VO.\n* I also created methods for auto rejection of expired applications.\n* Now is posible to set number of days to expiration of applications in each group and VO. If application is expired, then will be auto rejected.", "committedDate": "2020-10-30T10:09:48Z", "type": "forcePushed"}]}