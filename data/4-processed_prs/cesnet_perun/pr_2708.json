{"pr_number": 2708, "pr_title": "CORE: Optimized and cleaned-up getAllowed/Assigned() methods", "pr_createdAt": "2020-05-19T07:31:04Z", "pr_url": "https://github.com/CESNET/perun/pull/2708", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzA5MjE0MQ==", "url": "https://github.com/CESNET/perun/pull/2708#discussion_r427092141", "bodyText": "I am afraid this is little confusing. There is no object Group so from the name, you can't say what does it mean. It is not really \"not expired in any group\". Probably more accurate is \"it is expired in all assigned groups\". Maybe \"NotExpiredOnResource\" would be better, but I am not sure.", "author": "stavamichal", "createdAt": "2020-05-19T07:39:33Z", "path": "perun-core/src/main/java/cz/metacentrum/perun/core/bl/FacilitiesManagerBl.java", "diffHunk": "@@ -272,7 +272,7 @@\n \t * @return list of users\n \t * @throws InternalErrorException\n \t */\n-\tList<User> getAllowedUsersNotExpired(PerunSession sess, Facility facility, Vo specificVo, Service specificService) throws InternalErrorException;\n+\tList<User> getAllowedUsersNotExpiredInGroup(PerunSession sess, Facility facility, Vo specificVo, Service specificService) throws InternalErrorException;", "originalCommit": "554814f244d40e7bdbf56eca2c344e66021eece9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzE0MDU0Ng==", "url": "https://github.com/CESNET/perun/pull/2708#discussion_r427140546", "bodyText": "Well, we have only two expirations, in the Vo and the Group. If we state only \"NotExpired\", I expect it to be VO expiration, since its historically more used, but its not the case of this method.\nWe do not expire on the Resource or Facility. I'm not aware we are using this term anywhere else. Also Resource is not between method params either.\nThe correct version seems to be rather long, since you have to specify, that by expired you mean group expiration and that you return all users, which are connected/assigned through at least one group, in which they are not expired and that the member as a whole is allowed.\nHow about getAllowedUsersWithoutExpiredIn(Assigned)Groups or getAllowedUsersOnlyForValidGroups or getAllowedUsers(Throught/Of)NotExpiredGroups ?\nGenerally, I don't think that we can always match all conditions to the method name for every method. When in doubt, user should read the javadoc, which is more explanatory.", "author": "zlamalp", "createdAt": "2020-05-19T08:56:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzA5MjE0MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzE1NDQwOQ==", "url": "https://github.com/CESNET/perun/pull/2708#discussion_r427154409", "bodyText": "We should probably create a new way how to say:\n\nallowed in VO\nvalid in group\n\nSomething like we said in user life cycle - Active. For now we can let it this way, but in the future, we should consider something like getActiveUsers instead of this.", "author": "stavamichal", "createdAt": "2020-05-19T09:17:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzA5MjE0MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzE1NjAxNw==", "url": "https://github.com/CESNET/perun/pull/2708#discussion_r427156017", "bodyText": "You are definitely right on that, but we are not there yet with the user life-cycle :-(", "author": "zlamalp", "createdAt": "2020-05-19T09:20:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzA5MjE0MQ=="}], "type": "inlineReview"}, {"oid": "6825588b0823208dd5521472a6bc48a75ffe6493", "url": "https://github.com/CESNET/perun/commit/6825588b0823208dd5521472a6bc48a75ffe6493", "message": "CORE: Optimized and cleaned-up getAllowed/Assigned() methods\n\n- Aligned SQL, so that \"join\" and \"where\" keywords start\n  on the new line (its more readable).\n- Removed unnecessary \"inner\" from some \"inner join\" statements.\n- In getAllowedResources(facility,user) in ResourcesManagerImpl\n  removed unnecessary \"left outer\" from the \"join\" since we\n  want explicit connection anyway. No other sql on the same\n  tables returning allowed entities uses \"left outer\".\n  Also removed join with facilities table, since we can filter\n  by facility_id in resources table directly.\n- Renamed getAllowed(Users/Members)NotExpired() to\n  getAllowed(Users/Members)NotExpiredInGroup() since its more\n  explanatory, if expired is referring to vo or group status.\n  Also propagate this change to the Bl, where its used.\n- Removed VO param from getAssignedResources(sess, vo, group)\n  in ResourceManagerImpl, since it was not used in SQL.\n- Added getAllowedUsers(sess, facility) to the FacilitiesMangerImpl,\n  so we perform direct select rather than iterate over all resources.\n- Updated javadoc for some methods.", "committedDate": "2020-05-19T11:04:41Z", "type": "commit"}, {"oid": "2f15067601ac70f2ed18ee56ad4217361ec0d5e6", "url": "https://github.com/CESNET/perun/commit/2f15067601ac70f2ed18ee56ad4217361ec0d5e6", "message": "CORE: Added tests and fixes for changed SQLs of assigned/allowed\n\n- Added getAssignedUsers(resource) in ResourcesManagerBl.\n- Changed implementation of isUserAllowed(user, resource)\n  in ResourcesManagerBl, iteration replaced with exact query.\n  Also allowed condition was wrong here.\n- Added \"distinct\" to prevent duplicates in FacilitiesManagerImpl\n  for getAssignedUsers(facility) and  getAssignedUsers(facility,service).\n\n- Added tests for various existing/new getAssigned/Allowed() methods\n  from Users/Resource/Facilities managers. Some methods were\n  already tested from Entry (integrations) tests, so only a few is\n  tested explicitly in BlImpl tests.", "committedDate": "2020-05-20T06:50:45Z", "type": "commit"}, {"oid": "92315326fbb749935e6882d77fee4555e0b4496a", "url": "https://github.com/CESNET/perun/commit/92315326fbb749935e6882d77fee4555e0b4496a", "message": "CORE: Added \"distinct\" to some SQLs for allowed/assigned\n\n- Added \"distinct\" for some getAssigned/Allowed() methods.\n  It makes sure we have unique results, it is not necessary,\n  if only two tables are joined.\n- Aligned SQL in getAssignedRichResources().", "committedDate": "2020-05-20T07:00:57Z", "type": "commit"}, {"oid": "92315326fbb749935e6882d77fee4555e0b4496a", "url": "https://github.com/CESNET/perun/commit/92315326fbb749935e6882d77fee4555e0b4496a", "message": "CORE: Added \"distinct\" to some SQLs for allowed/assigned\n\n- Added \"distinct\" for some getAssigned/Allowed() methods.\n  It makes sure we have unique results, it is not necessary,\n  if only two tables are joined.\n- Aligned SQL in getAssignedRichResources().", "committedDate": "2020-05-20T07:00:57Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzc4ODY1MA==", "url": "https://github.com/CESNET/perun/pull/2708#discussion_r427788650", "bodyText": "Peter B. said in different commit  #2702 that this exception is not thrown for jdbc.query and you said he is right. So there is probably the same problem in every method with jdbc.query.", "author": "stavamichal", "createdAt": "2020-05-20T07:12:50Z", "path": "perun-core/src/main/java/cz/metacentrum/perun/core/impl/UsersManagerImpl.java", "diffHunk": "@@ -1378,4 +1387,73 @@ public void deleteSponsorLinks(PerunSession sess, User sponsor) throws InternalE\n \t\t}\n \n \t}\n+\n+\t@Override\n+\tpublic List<Resource> getAssignedResources(PerunSession sess, User user) throws InternalErrorException {\n+\t\ttry  {\n+\t\t\treturn jdbc.query(\"select distinct \" + resourceMappingSelectQuery + \" from resources join groups_resources on resources.id=groups_resources.resource_id \" +\n+\t\t\t\t\t\" join groups on groups_resources.group_id=groups.id\" +\n+\t\t\t\t\t\" join groups_members on groups.id=groups_members.group_id \" +\n+\t\t\t\t\t\" join members on groups_members.member_id=members.id \" +\n+\t\t\t\t\t\" where members.user_id=?\", RESOURCE_MAPPER, user.getId());\n+\t\t} catch (EmptyResultDataAccessException e) {", "originalCommit": "92315326fbb749935e6882d77fee4555e0b4496a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzc5Nzg2MQ==", "url": "https://github.com/CESNET/perun/pull/2708#discussion_r427797861", "bodyText": "I have big cleanup planned for the whole impl layer, but you are right. I removed this catch branch from the newly added methods, including throws declaration for the InternalErrorException, which is runtime for some time.", "author": "zlamalp", "createdAt": "2020-05-20T07:30:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzc4ODY1MA=="}], "type": "inlineReview"}, {"oid": "0f8a1f54c81b3ccfec63ee36941d87c15643e8b7", "url": "https://github.com/CESNET/perun/commit/0f8a1f54c81b3ccfec63ee36941d87c15643e8b7", "message": "CORE: Removed catching EmptyDataAccessException\n\n- Generic query shouldn't throw EmptyDataAccessException, so\n  its catch branch was removed from the newly added methods.\n- Also InternalErrorException is RuntimeException for some time,\n  so we don't have to explicitly mention it in the API. It was\n  removed from newly added methods hierarchy.", "committedDate": "2020-05-20T07:27:09Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTE1MzE5NQ==", "url": "https://github.com/CESNET/perun/pull/2708#discussion_r429153195", "bodyText": "I prefer name getAllowedUsersNotExpiredInGroups since the user cannot be expired in any of the groups as it is stated in the Javadoc.", "author": "balcirakpeter", "createdAt": "2020-05-22T09:52:54Z", "path": "perun-core/src/main/java/cz/metacentrum/perun/core/bl/FacilitiesManagerBl.java", "diffHunk": "@@ -268,7 +267,7 @@\n \t * @return list of users\n \t * @throws InternalErrorException\n \t */\n-\tList<User> getAllowedUsersNotExpired(PerunSession sess, Facility facility, Vo specificVo, Service specificService) throws InternalErrorException;\n+\tList<User> getAllowedUsersNotExpiredInGroup(PerunSession sess, Facility facility, Vo specificVo, Service specificService) throws InternalErrorException;", "originalCommit": "0f8a1f54c81b3ccfec63ee36941d87c15643e8b7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTE5NzQ4MA==", "url": "https://github.com/CESNET/perun/pull/2708#discussion_r429197480", "bodyText": "I renamed the method here and also both methods in ResourcesManager.", "author": "zlamalp", "createdAt": "2020-05-22T11:40:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTE1MzE5NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTE1NDA0Mg==", "url": "https://github.com/CESNET/perun/pull/2708#discussion_r429154042", "bodyText": "Signature of InternalErrorException is not necessary :)", "author": "balcirakpeter", "createdAt": "2020-05-22T09:54:44Z", "path": "perun-core/src/main/java/cz/metacentrum/perun/core/bl/ResourcesManagerBl.java", "diffHunk": "@@ -335,6 +335,17 @@\n \t */\n \tvoid removeGroupFromResources(PerunSession perunSession, Group group, List<Resource> resources) throws InternalErrorException, GroupNotDefinedOnResourceException, GroupAlreadyRemovedFromResourceException;\n \n+\t/**\n+\t * Returns all users assigned to the resource.\n+\t *\n+\t * @param perunSession\n+\t * @param resource\n+\t * @return list of users assigned to the resource\n+\t *\n+\t * @throws InternalErrorException\n+\t */\n+\tList<User> getAssignedUsers(PerunSession perunSession, Resource resource) throws InternalErrorException;", "originalCommit": "0f8a1f54c81b3ccfec63ee36941d87c15643e8b7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTE5Nzc4Nw==", "url": "https://github.com/CESNET/perun/pull/2708#discussion_r429197787", "bodyText": "I know, but I will clean up the whole Impl layer in own pull-request some times later.", "author": "zlamalp", "createdAt": "2020-05-22T11:41:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTE1NDA0Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTE2NDUzNQ==", "url": "https://github.com/CESNET/perun/pull/2708#discussion_r429164535", "bodyText": "It would be more readable if the first line was also split into more separate lines.", "author": "balcirakpeter", "createdAt": "2020-05-22T10:18:52Z", "path": "perun-core/src/main/java/cz/metacentrum/perun/core/impl/UsersManagerImpl.java", "diffHunk": "@@ -1378,4 +1387,65 @@ public void deleteSponsorLinks(PerunSession sess, User sponsor) throws InternalE\n \t\t}\n \n \t}\n+\n+\t@Override\n+\tpublic List<Resource> getAssignedResources(PerunSession sess, User user) {\n+\t\ttry  {\n+\t\t\treturn jdbc.query(\"select distinct \" + resourceMappingSelectQuery + \" from resources join groups_resources on resources.id=groups_resources.resource_id \" +", "originalCommit": "0f8a1f54c81b3ccfec63ee36941d87c15643e8b7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTE5Nzg5Nw==", "url": "https://github.com/CESNET/perun/pull/2708#discussion_r429197897", "bodyText": "It was forgotten, now fixed.", "author": "zlamalp", "createdAt": "2020-05-22T11:41:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTE2NDUzNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTE2NTE0Nw==", "url": "https://github.com/CESNET/perun/pull/2708#discussion_r429165147", "bodyText": "Nit: you are adding extra space on each line break (it is happening also in another selects).", "author": "balcirakpeter", "createdAt": "2020-05-22T10:20:15Z", "path": "perun-core/src/main/java/cz/metacentrum/perun/core/impl/UsersManagerImpl.java", "diffHunk": "@@ -1378,4 +1387,65 @@ public void deleteSponsorLinks(PerunSession sess, User sponsor) throws InternalE\n \t\t}\n \n \t}\n+\n+\t@Override\n+\tpublic List<Resource> getAssignedResources(PerunSession sess, User user) {\n+\t\ttry  {\n+\t\t\treturn jdbc.query(\"select distinct \" + resourceMappingSelectQuery + \" from resources join groups_resources on resources.id=groups_resources.resource_id \" +\n+\t\t\t\t\t\" join groups on groups_resources.group_id=groups.id\" +\n+\t\t\t\t\t\" join groups_members on groups.id=groups_members.group_id \" +\n+\t\t\t\t\t\" join members on groups_members.member_id=members.id \" +\n+\t\t\t\t\t\" where members.user_id=?\", RESOURCE_MAPPER, user.getId());\n+\t\t} catch (RuntimeException e) {\n+\t\t\tthrow new InternalErrorException(e);\n+\t\t}\n+\t}\n+\n+\t@Override\n+\tpublic List<Resource> getAllowedResources(PerunSession sess, User user) {\n+\t\ttry  {\n+\t\t\treturn jdbc.query(\"select distinct \" + resourceMappingSelectQuery + \" from resources join groups_resources on resources.id=groups_resources.resource_id \" +\n+\t\t\t\t\t\" join groups on groups_resources.group_id=groups.id\" +\n+\t\t\t\t\t\" join groups_members on groups.id=groups_members.group_id \" +\n+\t\t\t\t\t\" join members on groups_members.member_id=members.id \" +\n+\t\t\t\t\t\" where members.user_id=? and members.status!=? and members.status!=?\",\n+\t\t\t\t\tRESOURCE_MAPPER, user.getId(), String.valueOf(Status.INVALID.getCode()), String.valueOf(Status.DISABLED.getCode()));\n+\t\t} catch (RuntimeException e) {\n+\t\t\tthrow new InternalErrorException(e);\n+\t\t}\n+\t}\n+\n+\t@Override\n+\tpublic List<Resource> getAssignedResources(PerunSession sess, Facility facility, User user) {\n+\t\ttry {\n+\t\t\treturn jdbc.query(\"select distinct \" + ResourcesManagerImpl.resourceMappingSelectQuery + \" from resources \"+\n+\t\t\t\t\t\t\t\" join groups_resources on groups_resources.resource_id=resources.id\" +\n+\t\t\t\t\t\t\t\" join groups_members on groups_members.group_id=groups_resources.group_id\" +\n+\t\t\t\t\t\t\t\" join members on members.id=groups_members.member_id\" +\n+\t\t\t\t\t\t\t\" where resources.facility_id=? and members.user_id=?\",\n+\t\t\t\t\tRESOURCE_MAPPER, facility.getId(), user.getId());\n+\t\t} catch (RuntimeException e) {\n+\t\t\tthrow new InternalErrorException(e);\n+\t\t}\n+\t}\n+\n+\t@Override\n+\tpublic List<RichResource> getAssignedRichResources(PerunSession sess, User user) {\n+\t\ttry  {\n+\t\t\treturn jdbc.query(\"select distinct \" + resourceMappingSelectQuery + \", \" + VosManagerImpl.voMappingSelectQuery + \", \" +\n+\t\t\t\t\tFacilitiesManagerImpl.facilityMappingSelectQuery + \", \"+resourceTagMappingSelectQuery+\" from resources\" +\n+\t\t\t\t\t\" join vos on resources.vo_id=vos.id \" +", "originalCommit": "0f8a1f54c81b3ccfec63ee36941d87c15643e8b7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTE5OTAyNw==", "url": "https://github.com/CESNET/perun/pull/2708#discussion_r429199027", "bodyText": "I prefer it before leaving space at the each line end, as we previously did. Its more visible and prevents modifying SQL the way it would fail (having no space between keywords).", "author": "zlamalp", "createdAt": "2020-05-22T11:44:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTE2NTE0Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTE4NjA5Mg==", "url": "https://github.com/CESNET/perun/pull/2708#discussion_r429186092", "bodyText": "The formating of the SQL commands in the whole PR is much better than the previous, but I have some comments which you may consider if you like.\n\nIt would be better to make the indentation the same in each SQL command. For example, some of the indents after the first line have two extra tabs and some don't. Or some of the mappers start on a separate line and some don't.\nI would consider putting the \"from\"  clause on the separate line, because of the readability.\nMaybe even putting the \"select\" clause on the second line would help to align the indentation better, but I am not sure in this one.", "author": "balcirakpeter", "createdAt": "2020-05-22T11:11:00Z", "path": "perun-core/src/main/java/cz/metacentrum/perun/core/impl/FacilitiesManagerImpl.java", "diffHunk": "@@ -511,8 +534,9 @@ public void removeOwner(PerunSession sess, Facility facility, Owner owner) throw\n \n \t\t\t} else if (specificService != null) {\n \n-\t\t\t\treturn jdbc.query(\"select \" + ResourcesManagerImpl.resourceMappingSelectQuery + \" from resource_services join resources on \" +\n-\t\t\t\t\t\t\"resource_services.resource_id=resources.id where facility_id=? and service_id=?\",\n+\t\t\t\treturn jdbc.query(\"select \" + ResourcesManagerImpl.resourceMappingSelectQuery + \" from resource_services\" +", "originalCommit": "0f8a1f54c81b3ccfec63ee36941d87c15643e8b7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTIwMTY1OA==", "url": "https://github.com/CESNET/perun/pull/2708#discussion_r429201658", "bodyText": "Thanks for the suggestions. We should agree on some kind of standard within our code for SQL queries in the core team. I would prefer cleaning up those SQL afterwards.\nI just want really simple queries to stay simple (eg. single line) and not to take 4-5 lines. For complex SQLs, more lines is better. I'm in favor of having \"from\" at the newline to.\nMoving \"select\" to the next line causes just more indentation to apply. We generally do not have newlines between braces.", "author": "zlamalp", "createdAt": "2020-05-22T11:50:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTE4NjA5Mg=="}], "type": "inlineReview"}, {"oid": "879ea3551a632133b9b494c67203368623258086", "url": "https://github.com/CESNET/perun/commit/879ea3551a632133b9b494c67203368623258086", "message": "CORE: Cleanup fixes\n\n- Use plural for Groups in getAllowedUsers/MembersNotExpiredInGroup().\n  It better describe the fact, that user must not be expired in\n  such groups.\n- Fixed sql alignment where forgotten or wrong.", "committedDate": "2020-05-22T11:39:42Z", "type": "commit"}]}