{"pr_number": 2802, "pr_title": "CORE: All attribute tables now have single attr_value column", "pr_createdAt": "2020-07-21T12:48:37Z", "pr_url": "https://github.com/CESNET/perun/pull/2802", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODA4ODUxNA==", "url": "https://github.com/CESNET/perun/pull/2802#discussion_r458088514", "bodyText": "There is nothing like large objects anymore, so can't we remove these special parts too?", "author": "stavamichal", "createdAt": "2020-07-21T13:18:25Z", "path": "perun-core/src/main/java/cz/metacentrum/perun/core/impl/SearcherImpl.java", "diffHunk": "@@ -186,62 +183,37 @@ private void insertWhereClausesAndQueryParametersFromAttributes(StringBuilder qu\n \t\t\tquery.append(\"left join attr_names nam\").append(counter).append(\" on val\").append(counter).append(\".attr_id=nam\").append(counter).append(\".id \");\n \n \t\t\tif (value == null || value.isEmpty()) {\n-\t\t\t\tif(key.getType().equals(LinkedHashMap.class.getName()) ||\n-\t\t\t\t\t\tkey.getType().equals(BeansUtils.largeStringClassName) ||\n-\t\t\t\t\t\tkey.getType().equals(BeansUtils.largeArrayListClassName)) {\n-\t\t\t\t\twhereClauses.add(\"val\" + counter + \".attr_value_text IS NULL \");\n-\t\t\t\t} else {\n-\t\t\t\t\twhereClauses.add(\"val\" + counter + \".attr_value IS NULL \");\n-\t\t\t\t}\n+\t\t\t\twhereClauses.add(\"val\" + counter + \".attr_value IS NULL \");\n \t\t\t} else {\n \t\t\t\tif (key.getType().equals(Integer.class.getName())) {\n \t\t\t\t\tkey.setValue(Integer.valueOf(value));\n \t\t\t\t\twhereClauses.add(\"val\" + counter + \".attr_value=:v\" + counter + \" \");\n \t\t\t\t\twhereClauses.add(\"nam\" + counter + \".type=:n\" + counter + \" \");\n \t\t\t\t\tparameters.addValue(\"n\" + counter, Integer.class.getName());\n \t\t\t\t\tparameters.addValue(\"v\" + counter, BeansUtils.attributeValueToString(key));\n-\t\t\t\t} else if (key.getType().equals(String.class.getName())) {\n+\t\t\t\t} else if (key.getType().equals(String.class.getName()) || key.getType().equals(BeansUtils.largeStringClassName)) {", "originalCommit": "6c8e7105be9feeb3adafbc9089b4cccefa682bc8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODI4NDU1Ng==", "url": "https://github.com/CESNET/perun/pull/2802#discussion_r458284556", "bodyText": "I'd like to, but for now we have existing attributes with these types and I'm not sure, that nobody has that harcoded when calling API. But If we agree and let others know, we can convert all such attributes to their default type using DB changelog and then it can be removed from everywhere (gui/cli/core).", "author": "zlamalp", "createdAt": "2020-07-21T17:56:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODA4ODUxNA=="}], "type": "inlineReview"}, {"oid": "7303bb40b840d7017f5dd373a27b58d8132485e7", "url": "https://github.com/CESNET/perun/commit/7303bb40b840d7017f5dd373a27b58d8132485e7", "message": "CORE: Allow large attributes to be converted to unique\n\n- Revert changes from pull-request: #2245 where we prevented large\n  attributes to be converted to unique. Now all attribute value columns\n  are of \"text\" type, hence they can contain large values.", "committedDate": "2020-07-22T11:20:13Z", "type": "forcePushed"}, {"oid": "1a0dd2fe84e1b163297af4432f7f810d9df29732", "url": "https://github.com/CESNET/perun/commit/1a0dd2fe84e1b163297af4432f7f810d9df29732", "message": "CORE: All attribute tables now have single attr_value column\n\n- All values of large attributes from \"attr_value_text\" column\n  were moved to the standard \"attr_value\" column.\n  Default column type changed to \"text\" to contain large values.\n- Updated DB schema and changelog 3.1.65.\n- Simplified attribute value reading where possible.\n\n- We expect to remove \"large\" attribute types from the API/logic\n  in the future.", "committedDate": "2020-07-30T06:59:12Z", "type": "commit"}, {"oid": "9d26041ab3480e620831815baa08ad93fea70af3", "url": "https://github.com/CESNET/perun/commit/9d26041ab3480e620831815baa08ad93fea70af3", "message": "CORE: Allow large attributes to be converted to unique\n\n- Revert changes from pull-request: #2245 where we prevented large\n  attributes to be converted to unique. Now all attribute value columns\n  are of \"text\" type, hence they can contain large values.", "committedDate": "2020-07-30T06:59:12Z", "type": "commit"}, {"oid": "f477e1480c080d03fea4f34fbb8913677a553007", "url": "https://github.com/CESNET/perun/commit/f477e1480c080d03fea4f34fbb8913677a553007", "message": "DB: Fixed wrong attr_value type in host_attr_values table\n\n- We must use \"text\" as attr_value column type.", "committedDate": "2020-07-30T07:05:12Z", "type": "commit"}, {"oid": "f477e1480c080d03fea4f34fbb8913677a553007", "url": "https://github.com/CESNET/perun/commit/f477e1480c080d03fea4f34fbb8913677a553007", "message": "DB: Fixed wrong attr_value type in host_attr_values table\n\n- We must use \"text\" as attr_value column type.", "committedDate": "2020-07-30T07:05:12Z", "type": "forcePushed"}, {"oid": "fdd5cd195ea6e84f9b2a7d7462d65e5d2c1514d1", "url": "https://github.com/CESNET/perun/commit/fdd5cd195ea6e84f9b2a7d7462d65e5d2c1514d1", "message": "CORE: Removed unused isLargeAttribute() in AttributesManagerImpl", "committedDate": "2020-07-30T09:28:16Z", "type": "commit"}]}