{"pr_number": 2947, "pr_title": "Rewrite isCesnetEligibleLastSeen to user attribute", "pr_createdAt": "2020-10-26T18:39:33Z", "pr_url": "https://github.com/CESNET/perun/pull/2947", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjQ1NTc1NA==", "url": "https://github.com/CESNET/perun/pull/2947#discussion_r512455754", "bodyText": "You can use the constant instead of composing the attribute name again.", "author": "balcirakpeter", "createdAt": "2020-10-27T07:04:51Z", "path": "perun-core/src/main/java/cz/metacentrum/perun/core/impl/modules/attributes/urn_perun_ues_attribute_def_def_isCesnetEligibleLastSeen.java", "diffHunk": "@@ -0,0 +1,84 @@\n+package cz.metacentrum.perun.core.impl.modules.attributes;\n+\n+import cz.metacentrum.perun.core.api.Attribute;\n+import cz.metacentrum.perun.core.api.AttributeDefinition;\n+import cz.metacentrum.perun.core.api.AttributesManager;\n+import cz.metacentrum.perun.core.api.User;\n+import cz.metacentrum.perun.core.api.UserExtSource;\n+import cz.metacentrum.perun.core.api.exceptions.AttributeNotExistsException;\n+import cz.metacentrum.perun.core.api.exceptions.ConsistencyErrorException;\n+import cz.metacentrum.perun.core.api.exceptions.InternalErrorException;\n+import cz.metacentrum.perun.core.api.exceptions.UserNotExistsException;\n+import cz.metacentrum.perun.core.api.exceptions.WrongAttributeAssignmentException;\n+import cz.metacentrum.perun.core.api.exceptions.WrongAttributeValueException;\n+import cz.metacentrum.perun.core.api.exceptions.WrongReferenceAttributeValueException;\n+import cz.metacentrum.perun.core.impl.PerunSessionImpl;\n+import cz.metacentrum.perun.core.implApi.modules.attributes.UserExtSourceAttributesModuleAbstract;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.sql.Timestamp;\n+\n+/**\n+ * Attribute module for isCesnetEligibleLastSeen, value is String representing timestamp.\n+ *\n+ * @author Radoslav \u010cerh\u00e1k <r.cerhak@gmail.com>\n+ */\n+public class urn_perun_ues_attribute_def_def_isCesnetEligibleLastSeen extends UserExtSourceAttributesModuleAbstract {\n+\n+\tprivate static final String A_USER_DEF_IS_CESNET_ELIGIBLE_LAST_SEEN = AttributesManager.NS_USER_ATTR_DEF + \":isCesnetEligibleLastSeen\";\n+\tprivate static final Logger log = LoggerFactory.getLogger(urn_perun_ues_attribute_def_def_isCesnetEligibleLastSeen.class);\n+\n+\t/**\n+\t * When isCesnetEligibleLastSeen of a user's ext source is set, check if it is\n+\t * more recent than the user's current isCesnetEligibleLastSeen. If so, update it.\n+\t *\n+\t * @param session\n+\t * @param ues\n+\t * @param attribute\n+\t */\n+\t@Override\n+\tpublic void changedAttributeHook(PerunSessionImpl session, UserExtSource ues, Attribute attribute) {\n+\t\tif (attribute.getValue() == null) return;\n+\n+\t\tUser user;\n+\t\ttry {\n+\t\t\tuser = session.getPerunBl().getUsersManagerBl().getUserById(session, ues.getUserId());\n+\t\t} catch (UserNotExistsException ex) {\n+\t\t\tthrow new ConsistencyErrorException(ex);\n+\t\t}\n+\n+\t\tAttribute userIsCesnetEligible;\n+\t\ttry {\n+\t\t\tuserIsCesnetEligible = session.getPerunBl().getAttributesManagerBl().getAttribute(session, user, AttributesManager.NS_USER_ATTR_DEF + \":isCesnetEligibleLastSeen\");", "originalCommit": "12132ba9dd2b8d57b8b5b3f19619559d917b135f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjQ1NzI2Mw==", "url": "https://github.com/CESNET/perun/pull/2947#discussion_r512457263", "bodyText": "Are we sure that the ues attribute will always contain the correct timestamp? Maybe we should create method checkAttributeSyntax which ensures that there is not some random string. What do you think @zlamalp ?", "author": "balcirakpeter", "createdAt": "2020-10-27T07:09:04Z", "path": "perun-core/src/main/java/cz/metacentrum/perun/core/impl/modules/attributes/urn_perun_ues_attribute_def_def_isCesnetEligibleLastSeen.java", "diffHunk": "@@ -0,0 +1,84 @@\n+package cz.metacentrum.perun.core.impl.modules.attributes;\n+\n+import cz.metacentrum.perun.core.api.Attribute;\n+import cz.metacentrum.perun.core.api.AttributeDefinition;\n+import cz.metacentrum.perun.core.api.AttributesManager;\n+import cz.metacentrum.perun.core.api.User;\n+import cz.metacentrum.perun.core.api.UserExtSource;\n+import cz.metacentrum.perun.core.api.exceptions.AttributeNotExistsException;\n+import cz.metacentrum.perun.core.api.exceptions.ConsistencyErrorException;\n+import cz.metacentrum.perun.core.api.exceptions.InternalErrorException;\n+import cz.metacentrum.perun.core.api.exceptions.UserNotExistsException;\n+import cz.metacentrum.perun.core.api.exceptions.WrongAttributeAssignmentException;\n+import cz.metacentrum.perun.core.api.exceptions.WrongAttributeValueException;\n+import cz.metacentrum.perun.core.api.exceptions.WrongReferenceAttributeValueException;\n+import cz.metacentrum.perun.core.impl.PerunSessionImpl;\n+import cz.metacentrum.perun.core.implApi.modules.attributes.UserExtSourceAttributesModuleAbstract;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.sql.Timestamp;\n+\n+/**\n+ * Attribute module for isCesnetEligibleLastSeen, value is String representing timestamp.\n+ *\n+ * @author Radoslav \u010cerh\u00e1k <r.cerhak@gmail.com>\n+ */\n+public class urn_perun_ues_attribute_def_def_isCesnetEligibleLastSeen extends UserExtSourceAttributesModuleAbstract {\n+\n+\tprivate static final String A_USER_DEF_IS_CESNET_ELIGIBLE_LAST_SEEN = AttributesManager.NS_USER_ATTR_DEF + \":isCesnetEligibleLastSeen\";\n+\tprivate static final Logger log = LoggerFactory.getLogger(urn_perun_ues_attribute_def_def_isCesnetEligibleLastSeen.class);\n+\n+\t/**\n+\t * When isCesnetEligibleLastSeen of a user's ext source is set, check if it is\n+\t * more recent than the user's current isCesnetEligibleLastSeen. If so, update it.\n+\t *\n+\t * @param session\n+\t * @param ues\n+\t * @param attribute\n+\t */\n+\t@Override\n+\tpublic void changedAttributeHook(PerunSessionImpl session, UserExtSource ues, Attribute attribute) {\n+\t\tif (attribute.getValue() == null) return;\n+\n+\t\tUser user;\n+\t\ttry {\n+\t\t\tuser = session.getPerunBl().getUsersManagerBl().getUserById(session, ues.getUserId());\n+\t\t} catch (UserNotExistsException ex) {\n+\t\t\tthrow new ConsistencyErrorException(ex);\n+\t\t}\n+\n+\t\tAttribute userIsCesnetEligible;\n+\t\ttry {\n+\t\t\tuserIsCesnetEligible = session.getPerunBl().getAttributesManagerBl().getAttribute(session, user, AttributesManager.NS_USER_ATTR_DEF + \":isCesnetEligibleLastSeen\");\n+\t\t} catch (AttributeNotExistsException ex) {\n+\t\t\tlog.warn(\"Attribute {} doesn't exist.\", A_USER_DEF_IS_CESNET_ELIGIBLE_LAST_SEEN);\n+\t\t\treturn;\n+\t\t} catch (WrongAttributeAssignmentException ex) {\n+\t\t\tthrow new InternalErrorException(ex);\n+\t\t}\n+\n+\t\tTimestamp uesTimestamp = Timestamp.valueOf(attribute.valueAsString());", "originalCommit": "12132ba9dd2b8d57b8b5b3f19619559d917b135f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjQ5NDgyNw==", "url": "https://github.com/CESNET/perun/pull/2947#discussion_r512494827", "bodyText": "Good point @balcirakpeter, we should have syntax check method and same should be done for user version of attribute.", "author": "zlamalp", "createdAt": "2020-10-27T08:25:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjQ1NzI2Mw=="}], "type": "inlineReview"}, {"oid": "bb0378e418445b1cc1c5522950b0da5b613acf83", "url": "https://github.com/CESNET/perun/commit/bb0378e418445b1cc1c5522950b0da5b613acf83", "message": "Rewrite isCesnetEligibleLastSeen to user attribute\n\n- Attribute ues:def:isCesnetEligibleLastSeen has String value representing\ntimestamp. When the value is set, user version of this attribute should be\nupdated if ues attribute\u2019s value is more recent timestamp.\n- Created module ues:def:isCesnetEligibleLastSeen and implemented its methods\nchangedAttributeHook and checkAttributeSyntax.\n- Created module user:def:isCesnetEligibleLastSeen and implemented its method\ncheckAttributeSyntax.", "committedDate": "2020-10-27T11:33:48Z", "type": "commit"}, {"oid": "bb0378e418445b1cc1c5522950b0da5b613acf83", "url": "https://github.com/CESNET/perun/commit/bb0378e418445b1cc1c5522950b0da5b613acf83", "message": "Rewrite isCesnetEligibleLastSeen to user attribute\n\n- Attribute ues:def:isCesnetEligibleLastSeen has String value representing\ntimestamp. When the value is set, user version of this attribute should be\nupdated if ues attribute\u2019s value is more recent timestamp.\n- Created module ues:def:isCesnetEligibleLastSeen and implemented its methods\nchangedAttributeHook and checkAttributeSyntax.\n- Created module user:def:isCesnetEligibleLastSeen and implemented its method\ncheckAttributeSyntax.", "committedDate": "2020-10-27T11:33:48Z", "type": "forcePushed"}]}