{"pr_number": 2620, "pr_title": "New login attribute for SURF RAM", "pr_createdAt": "2020-03-13T21:16:34Z", "pr_url": "https://github.com/CESNET/perun/pull/2620", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjgyMTE3Nw==", "url": "https://github.com/CESNET/perun/pull/2620#discussion_r392821177", "bodyText": "Probably should be SURF RAM login, same for description.", "author": "zlamalp", "createdAt": "2020-03-16T07:08:29Z", "path": "perun-core/src/main/java/cz/metacentrum/perun/core/impl/modules/attributes/urn_perun_user_attribute_def_def_login_namespace_surf_ram_persistent_shadow.java", "diffHunk": "@@ -0,0 +1,92 @@\n+package cz.metacentrum.perun.core.impl.modules.attributes;\n+\n+import cz.metacentrum.perun.core.api.Attribute;\n+import cz.metacentrum.perun.core.api.AttributeDefinition;\n+import cz.metacentrum.perun.core.api.AttributesManager;\n+import cz.metacentrum.perun.core.api.ExtSource;\n+import cz.metacentrum.perun.core.api.User;\n+import cz.metacentrum.perun.core.api.UserExtSource;\n+import cz.metacentrum.perun.core.api.exceptions.ExtSourceNotExistsException;\n+import cz.metacentrum.perun.core.api.exceptions.InternalErrorException;\n+import cz.metacentrum.perun.core.api.exceptions.UserExtSourceExistsException;\n+import cz.metacentrum.perun.core.impl.PerunSessionImpl;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * Class for checking logins uniqueness in the namespace and filling surf-ram-persistent id.\n+ * It is only storage! Use module login surf_ram_persistent for access the value.\n+ *\n+ */\n+public class urn_perun_user_attribute_def_def_login_namespace_surf_ram_persistent_shadow extends urn_perun_user_attribute_def_def_login_namespace {\n+\n+\tprivate final static Logger log = LoggerFactory.getLogger(urn_perun_user_attribute_def_def_login_namespace_surf_ram_persistent_shadow.class);\n+\tprivate final static String extSourceNameSurfRam = \"https://proxy.acc.surf-ram.eduteams.org/proxy\";\n+\tprivate final static String domainNameSurfRam = \"@acc.surf-ram.eduteams.org\";\n+\tprivate final static String attrNameSurfRam = \"login-namespace:surf-ram-persistent-shadow\";\n+\n+\t/**\n+\t * Filling implemented for login:namespace:surf-ram-persistent attribute\n+\t * Format is: \"[hash]@domainNameSurfRam\" where [hash] represents sha1hash counted from user's id and perun instance id a login-namespace name\n+\t *\n+\t * @param perunSession PerunSession\n+\t * @param user User to fill attribute for\n+\t * @param attribute Attribute to fill value to\n+\t * @return Filled attribute\n+\t * @throws InternalErrorException\n+\t */\n+\t@Override\n+\tpublic Attribute fillAttribute(PerunSessionImpl perunSession, User user, AttributeDefinition attribute) throws InternalErrorException {\n+\n+\t\tAttribute filledAttribute = new Attribute(attribute);\n+\n+\t\tif (attribute.getFriendlyName().equals(attrNameSurfRam)) {\n+\t\t\tfilledAttribute.setValue(sha1HashCount(user, domainNameSurfRam).toString() + domainNameSurfRam);\n+\t\t\treturn filledAttribute;\n+\t\t} else {\n+\t\t\t// without value\n+\t\t\treturn filledAttribute;\n+\t\t}\n+\t}\n+\n+\t/**\n+\t * ChangedAttributeHook() sets UserExtSource with following properties:\n+\t *  - extSourceType is IdP\n+\t *  - extSourceName is stored in extSourceNameSurfRam\n+\t *  - user's extSource login is the same as his surf-ram-persistent attribute\n+\t *\n+\t * @param session PerunSession\n+\t * @param user User to set UserExtSource for\n+\t * @param attribute Attribute containing SURF RAM ID\n+\t * @throws cz.metacentrum.perun.core.api.exceptions.InternalErrorException\n+\t */\n+\t@Override\n+\tpublic void changedAttributeHook(PerunSessionImpl session, User user, Attribute attribute) throws InternalErrorException {\n+\t\ttry {\n+\t\t\tString userNamespace = attribute.getFriendlyNameParameter();\n+\n+\t\t\tif(userNamespace.equals(\"surf-ram-persistent-shadow\") && attribute.getValue() != null){\n+\t\t\t\tExtSource extSource = session.getPerunBl().getExtSourcesManagerBl().getExtSourceByName(session, extSourceNameSurfRam);\n+\t\t\t\tUserExtSource userExtSource = new UserExtSource(extSource, 0, attribute.getValue().toString());\n+\n+\t\t\t\tsession.getPerunBl().getUsersManagerBl().addUserExtSource(session, user, userExtSource);\n+\t\t\t}\n+\t\t} catch (UserExtSourceExistsException ex) {\n+\t\t\tlog.warn(\"SurfRam IdP external source already exists for the user.\", ex);\n+\t\t} catch (ExtSourceNotExistsException ex) {\n+\t\t\tthrow new InternalErrorException(\"IdP external source for SURF RAM doesn't exist.\", ex);\n+\t\t}\n+\t}\n+\n+\tpublic AttributeDefinition getAttributeDefinition() {\n+\t\tAttributeDefinition attr = new AttributeDefinition();\n+\t\tattr.setNamespace(AttributesManager.NS_USER_ATTR_DEF);\n+\t\tattr.setFriendlyName(\"login-namespace:surf-ram-persistent-shadow\");\n+\t\tattr.setDisplayName(\"FENIX login\");", "originalCommit": "dc2c07c156f815de56b1a453d00f12494eaef6b7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mjg2Njk4Mw==", "url": "https://github.com/CESNET/perun/pull/2620#discussion_r392866983", "bodyText": "Cup&paste error. Thanks for spotting it.", "author": "licehammer", "createdAt": "2020-03-16T08:59:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjgyMTE3Nw=="}], "type": "inlineReview"}, {"oid": "84ca90fc3576e0a693b08d6b41d34f64981885e0", "url": "https://github.com/CESNET/perun/commit/84ca90fc3576e0a693b08d6b41d34f64981885e0", "message": "New login attribute for SURF RAM", "committedDate": "2020-03-16T08:58:35Z", "type": "commit"}, {"oid": "84ca90fc3576e0a693b08d6b41d34f64981885e0", "url": "https://github.com/CESNET/perun/commit/84ca90fc3576e0a693b08d6b41d34f64981885e0", "message": "New login attribute for SURF RAM", "committedDate": "2020-03-16T08:58:35Z", "type": "forcePushed"}]}