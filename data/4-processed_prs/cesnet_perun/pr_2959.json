{"pr_number": 2959, "pr_title": "Exceptions for invalid password reset request", "pr_createdAt": "2020-10-29T09:50:28Z", "pr_url": "https://github.com/CESNET/perun/pull/2959", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDI4MjgwMQ==", "url": "https://github.com/CESNET/perun/pull/2959#discussion_r514282801", "bodyText": "Please, if it is not too much work, rename these two variables to some meaningful names in both methods checkPasswordResetRequestIsValid and changeNonAuthzPassword.", "author": "balcirakpeter", "createdAt": "2020-10-29T14:03:39Z", "path": "perun-core/src/main/java/cz/metacentrum/perun/core/api/UsersManager.java", "diffHunk": "@@ -798,6 +800,18 @@ void changePassword(PerunSession sess, String login, String loginNamespace, Stri\n \tvoid changePassword(PerunSession sess, User user, String loginNamespace, String oldPassword, String newPassword, boolean checkOldPassword)\n \t\t\tthrows PrivilegeException, UserNotExistsException, LoginNotExistsException, PasswordDoesntMatchException, PasswordChangeFailedException, PasswordOperationTimeoutException, PasswordStrengthFailedException, InvalidLoginException, PasswordStrengthException;\n \n+\t/**\n+\t * Checks if the password reset request based on encrypted parameters is valid.\n+\t *\n+\t * @param sess\n+\t * @param i encrypted user id", "originalCommit": "4292469d469359b60767b4ee8e9b7c5ce56294ec", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDM0MDEwMg==", "url": "https://github.com/CESNET/perun/pull/2959#discussion_r514340102", "bodyText": "They supposed to be meaningless - not to give hints in mails, and also it shortens the URL itself. Generally I would do this in new issue, if you want it. We wanted to check request presence, not to break outer API.", "author": "zlamalp", "createdAt": "2020-10-29T15:16:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDI4MjgwMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDk3NDQyOQ==", "url": "https://github.com/CESNET/perun/pull/2959#discussion_r514974429", "bodyText": "ok", "author": "balcirakpeter", "createdAt": "2020-10-30T09:39:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDI4MjgwMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDI5NzI0NA==", "url": "https://github.com/CESNET/perun/pull/2959#discussion_r514297244", "bodyText": "I think we could add authorization to this method, allowing only SELF and PERUNADMIN to perform the operation. However, I am not sure if it is needed. What do you think @zlamalp ?", "author": "balcirakpeter", "createdAt": "2020-10-29T14:22:36Z", "path": "perun-core/src/main/java/cz/metacentrum/perun/core/entry/UsersManagerEntry.java", "diffHunk": "@@ -1269,7 +1271,18 @@ public String validatePreferredEmailChange(PerunSession sess, User user, String\n \t}\n \n \t@Override\n-\tpublic void changeNonAuthzPassword(PerunSession sess, String i, String m, String password, String lang) throws UserNotExistsException, LoginNotExistsException, PasswordChangeFailedException, PasswordOperationTimeoutException, PasswordStrengthFailedException, InvalidLoginException, PasswordStrengthException {\n+\tpublic void checkPasswordResetRequestIsValid(PerunSession sess, String i, String m) throws UserNotExistsException, PasswordResetLinkExpiredException, PasswordResetLinkNotValidException {", "originalCommit": "4292469d469359b60767b4ee8e9b7c5ce56294ec", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDUyNjAwMQ==", "url": "https://github.com/CESNET/perun/pull/2959#discussion_r514526001", "bodyText": "This will be called by non-authorized user, so we can't check the caller against the user inside the request. For now it has to be without authorization.", "author": "zlamalp", "createdAt": "2020-10-29T19:55:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDI5NzI0NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDk3NDQ4Nw==", "url": "https://github.com/CESNET/perun/pull/2959#discussion_r514974487", "bodyText": "ok", "author": "balcirakpeter", "createdAt": "2020-10-30T09:39:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDI5NzI0NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDUyNjgyMQ==", "url": "https://github.com/CESNET/perun/pull/2959#discussion_r514526821", "bodyText": "You shouldn't mention empty return in javadoc.", "author": "zlamalp", "createdAt": "2020-10-29T19:56:30Z", "path": "perun-core/src/main/java/cz/metacentrum/perun/core/bl/UsersManagerBl.java", "diffHunk": "@@ -1300,6 +1302,19 @@ void deletePassword(PerunSession sess, String userLogin, String loginNamespace)\n \t */\n \tUser convertUserEmptyStringsInObjectAttributesIntoNull(User user);\n \n+\t/**\n+\t * Checks if the password reset request link is valid. The request is valid, if it\n+\t * was created, never used and hasn't expired yet.\n+\t *\n+\t * @param sess PerunSession\n+\t * @param user user to check request for\n+\t * @param m encrypted request id\n+\t * @return", "originalCommit": "4292469d469359b60767b4ee8e9b7c5ce56294ec", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDUyOTQ0OA==", "url": "https://github.com/CESNET/perun/pull/2959#discussion_r514529448", "bodyText": "You should use getUsersManagerImpl() method, so that Spring will use its proxy class and respect transaction config. It would probably worked here, since you only read, but we should be consistent in getting manager classes.", "author": "zlamalp", "createdAt": "2020-10-29T20:00:14Z", "path": "perun-core/src/main/java/cz/metacentrum/perun/core/blImpl/UsersManagerBlImpl.java", "diffHunk": "@@ -1918,14 +1920,17 @@ public User convertUserEmptyStringsInObjectAttributesIntoNull(User user) {\n \t}\n \n \t@Override\n-\tpublic void changeNonAuthzPassword(PerunSession sess, User user, String m, String password, String lang) throws LoginNotExistsException, PasswordChangeFailedException, PasswordOperationTimeoutException, PasswordStrengthFailedException, InvalidLoginException, PasswordStrengthException {\n+\tpublic void checkPasswordResetRequestIsValid(PerunSession sess, User user, String m) throws PasswordResetLinkExpiredException, PasswordResetLinkNotValidException {\n+\t\tint requestId = Integer.parseInt(Utils.cipherInput(m, true));\n \n-\t\tString requestId = Utils.cipherInput(m, true);\n-\t\tPair<String,String> resetRequest = getUsersManagerImpl().loadPasswordResetRequest(user, Integer.parseInt(requestId));\n+\t\tusersManagerImpl.checkPasswordResetRequestIsValid(sess, user, requestId);", "originalCommit": "4292469d469359b60767b4ee8e9b7c5ce56294ec", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDUzMjYxOA==", "url": "https://github.com/CESNET/perun/pull/2959#discussion_r514532618", "bodyText": "I would omit user: from exception message, since user.toString() prints also object name. Same for the exception thrown below and at the end.", "author": "zlamalp", "createdAt": "2020-10-29T20:04:26Z", "path": "perun-core/src/main/java/cz/metacentrum/perun/core/impl/UsersManagerImpl.java", "diffHunk": "@@ -1246,30 +1248,49 @@ public void removeAllPreferredEmailChangeRequests(PerunSession sess, User user)\n \t}\n \n \t@Override\n-\tpublic Pair<String,String> loadPasswordResetRequest(User user, int requestId) {\n-\n-\t\tint validWindow = BeansUtils.getCoreConfig().getPwdresetValidationWindow();\n+\tpublic void checkPasswordResetRequestIsValid(PerunSession sess, User user, int requestId) throws PasswordResetLinkExpiredException, PasswordResetLinkNotValidException {\n+\t\tthis.checkAndGetPasswordResetRequest(user, requestId);\n+\t}\n \n+\tprivate Pair<String, String> checkAndGetPasswordResetRequest(User user, int requestId) throws PasswordResetLinkExpiredException, PasswordResetLinkNotValidException {\n \t\ttry {\n+\t\t\tint numberOfRequests = jdbc.queryForInt(\"select count(1) from pwdreset where user_id=? and id=?\", user.getId(), requestId);\n+\t\t\tif (numberOfRequests == 0) {\n+\t\t\t\tthrow new PasswordResetLinkNotValidException(\"Password request \" + requestId + \" doesn't exist for user: \" + user);", "originalCommit": "4292469d469359b60767b4ee8e9b7c5ce56294ec", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDUzNDE4Ng==", "url": "https://github.com/CESNET/perun/pull/2959#discussion_r514534186", "bodyText": "You shouldn't mention empty @return.", "author": "zlamalp", "createdAt": "2020-10-29T20:06:16Z", "path": "perun-core/src/main/java/cz/metacentrum/perun/core/implApi/UsersManagerImplApi.java", "diffHunk": "@@ -691,17 +693,33 @@\n \t */\n \tList<String> getPendingPreferredEmailChanges(PerunSession sess, User user);\n \n+\t/**\n+\t * Checks if the password reset request link is valid. The request is valid, if it\n+\t * was created, never used and hasn't expired yet.\n+\t *\n+\t * @param sess PerunSession\n+\t * @param user user to check request for\n+\t * @param requestId request id to check\n+\t * @return", "originalCommit": "4292469d469359b60767b4ee8e9b7c5ce56294ec", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDUzNjc2Mw==", "url": "https://github.com/CESNET/perun/pull/2959#discussion_r514536763", "bodyText": "Typo: ecnrypted -> encrypted.", "author": "zlamalp", "createdAt": "2020-10-29T20:10:28Z", "path": "perun-openapi/openapi.yml", "diffHunk": "@@ -7712,6 +7712,46 @@ paths:\n                 candidate: { $ref: '#/components/schemas/Candidate' }\n                 specificUserOwners: { type: array, items: { $ref: \"#/components/schemas/User\" } }\n \n+  /json/usersManager/checkPasswordResetRequestIsValid:\n+    get:\n+      tags:\n+        - UsersManager\n+      operationId: checkPasswordResetRequestIsValid\n+      summary: Checks if the password reset request based on ecnrypted input parameters is valid.", "originalCommit": "4292469d469359b60767b4ee8e9b7c5ce56294ec", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "59896deb1f811d0f065645597d3e07d822c1ad6c", "url": "https://github.com/CESNET/perun/commit/59896deb1f811d0f065645597d3e07d822c1ad6c", "message": "Exceptions for invalid password reset request\n\n- Method changeNonAuthzPassword() threw InternalErrorExceptions when the\npassword reset request link has expired or when it never existed.\n- Created new exceptions PasswordResetLinkExpired and PasswordResetLinkNotValid\nto distuinguish between these two cases.\n- Created new method checkPasswordResetRequestIsValid() to check for validity\nof the given password reset request, that should be called from GUI before\nsubmitting a new password.", "committedDate": "2020-10-30T07:46:39Z", "type": "commit"}, {"oid": "59896deb1f811d0f065645597d3e07d822c1ad6c", "url": "https://github.com/CESNET/perun/commit/59896deb1f811d0f065645597d3e07d822c1ad6c", "message": "Exceptions for invalid password reset request\n\n- Method changeNonAuthzPassword() threw InternalErrorExceptions when the\npassword reset request link has expired or when it never existed.\n- Created new exceptions PasswordResetLinkExpired and PasswordResetLinkNotValid\nto distuinguish between these two cases.\n- Created new method checkPasswordResetRequestIsValid() to check for validity\nof the given password reset request, that should be called from GUI before\nsubmitting a new password.", "committedDate": "2020-10-30T07:46:39Z", "type": "forcePushed"}]}