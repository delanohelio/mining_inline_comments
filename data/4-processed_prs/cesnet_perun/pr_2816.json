{"pr_number": 2816, "pr_title": "Roles - default politics file", "pr_createdAt": "2020-07-24T14:25:16Z", "pr_url": "https://github.com/CESNET/perun/pull/2816", "timeline": [{"oid": "acad23ccf27e5d8296ac535e770680174916c21e", "url": "https://github.com/CESNET/perun/commit/acad23ccf27e5d8296ac535e770680174916c21e", "message": "Roles - default politics file\n\n* With the old implementation, it was difficult to release new versions\nof perun with new policits. All configurations would have to be changed\nand there was a lot of places to do a manual error. Even right now, we\ndon't plan to have different politics on different instances.\n* Created a default politics cofiguration file\n`perun-base/src/main/resources/perun-roles.yml` which is packed into the\nwar archive and will be used in production and even in tests.\n* Created a test configuration file `test-roles.yml` which contains\npolitics specially created for tests.\n* Changed behaviour of loading of the politics. On production, the\ndefault politics configuration is used and also, the configuration file\nat `/etc/perun/perun-roles.yml` can be used to override some politics.\nThis file is ignored during tests.", "committedDate": "2020-07-24T15:14:10Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDA5NjA3Mg==", "url": "https://github.com/CESNET/perun/pull/2816#discussion_r460096072", "bodyText": "Typo", "author": "balcirakpeter", "createdAt": "2020-07-24T14:41:19Z", "path": "perun-core/src/main/java/cz/metacentrum/perun/core/impl/PerunRolesLoader.java", "diffHunk": "@@ -116,36 +107,52 @@ public void loadPerunRoles(JdbcPerunTemplate jdbc) {\n \t\tMap<String, RoleManagementRules> rolesManagementRules = new HashMap<>();\n \n \t\ttry {\n-\t\t\tJsonNode rootNode = loadConfigurationFile();\n-\t\t\t//Fetch all policies from the configuration file\n-\t\t\tJsonNode rolesNodes = rootNode.get(\"perun_roles_management\");\n-\n-\t\t\t// For each role node construct RoleManagementRules and add it to the map\n-\t\t\tIterator<String> roleNames = rolesNodes.fieldNames();\n-\t\t\twhile (roleNames.hasNext()) {\n-\t\t\t\tString roleName = roleNames.next();\n-\t\t\t\tJsonNode roleNode = rolesNodes.get(roleName);\n-\t\t\t\tList<Map<String, String>> privilegedRoles = new ArrayList<>();\n-\t\t\t\tJsonNode privilegedRolesNode = roleNode.get(\"privileged_roles\");\n-\n-\t\t\t\t//Field privileged_roles is saved as List of maps in the for loop\n-\t\t\t\tfor (JsonNode privilegedRoleNode : privilegedRolesNode) {\n-\t\t\t\t\tMap<String, String> innerRoleMap = createmapFromJsonNode(privilegedRoleNode);\n-\t\t\t\t\tprivilegedRoles.add(innerRoleMap);\n-\t\t\t\t}\n-\n-\t\t\t\tMap<String, String> entitiesToManage = createmapFromJsonNode(roleNode.get(\"entities_to_manage\"));\n-\t\t\t\tMap<String, String> objectsToAssign = createmapFromJsonNode(roleNode.get(\"assign_to_objects\"));\n-\n-\t\t\t\trolesManagementRules.put(roleName, new RoleManagementRules(roleName, privilegedRoles, entitiesToManage, objectsToAssign));\n+\t\t\tJsonNode rootNode = loadConfigurationFile(configurationPath);\n+\t\t\tloadPerunRolesManagementGromJsonNode(rootNode)\n+\t\t\t\t\t.forEach(rule -> rolesManagementRules.put(rule.getRoleName(), rule));\n+\n+\t\t\tif (secondaryConfigurationPath != null) {\n+\t\t\t\trootNode = loadConfigurationFile(secondaryConfigurationPath);\n+\t\t\t\tloadPerunRolesManagementGromJsonNode(rootNode)\n+\t\t\t\t\t\t.forEach(rule -> rolesManagementRules.put(rule.getRoleName(), rule));\n \t\t\t}\n \t\t} catch(RuntimeException e) {\n-\t\t\tthrow new InternalErrorException(\"The configuration file \" + configurationPath.getFilename() + \" has invalid syntax.\", e);\n+\t\t\tthrow new InternalErrorException(\"One of the roles configuration file has invalid syntax. Configuration files: \" +\n+\t\t\t\t\tconfigurationPath.getFilename() +\n+\t\t\t\t\t(secondaryConfigurationPath == null ? \"not defined\" : secondaryConfigurationPath.getFilename()), e);\n \t\t}\n \n \t\treturn rolesManagementRules;\n \t}\n \n+\tprivate Set<RoleManagementRules> loadPerunRolesManagementGromJsonNode(JsonNode rootNode) {", "originalCommit": "dff994f84905e5b29abb6155ac5c6e8f83318df6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDc2OTE0OQ==", "url": "https://github.com/CESNET/perun/pull/2816#discussion_r460769149", "bodyText": "fixed", "author": "Vojtech-Sassmann", "createdAt": "2020-07-27T09:39:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDA5NjA3Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDY2MjQwMg==", "url": "https://github.com/CESNET/perun/pull/2816#discussion_r460662402", "bodyText": "Shouldn't we first load normal configuration and then overwrite it with secondary config (as we do in loadPerunRolesManagement())?", "author": "zlamalp", "createdAt": "2020-07-27T05:58:38Z", "path": "perun-core/src/main/java/cz/metacentrum/perun/core/impl/PerunRolesLoader.java", "diffHunk": "@@ -71,36 +77,22 @@ public void loadPerunRoles(JdbcPerunTemplate jdbc) {\n \t *\n \t * @return list of PerunPolicies\n \t */\n-\tpublic List<PerunPolicy> loadPerunPolicies() {\n-\t\tList<PerunPolicy> policies = new ArrayList<>();\n+\tpublic Set<PerunPolicy> loadPerunPolicies() {\n+\t\tSet<PerunPolicy> policies = new HashSet<>();\n \n \t\ttry {\n-\t\t\tJsonNode rootNode = loadConfigurationFile();\n-\t\t\t//Fetch all policies from the configuration file\n-\t\t\tJsonNode policiesNode = rootNode.get(\"perun_policies\");\n-\n-\t\t\t// For each policy node construct PerunPolicy and add it to the list\n-\t\t\tIterator<String> policyNames = policiesNode.fieldNames();\n-\t\t\twhile(policyNames.hasNext()) {\n-\t\t\t\tString policyName = policyNames.next();\n-\t\t\t\tJsonNode policyNode = policiesNode.get(policyName);\n-\t\t\t\tList<Map<String, String>> perunRoles = new ArrayList<>();\n-\t\t\t\tJsonNode perunRolesNode = policyNode.get(\"policy_roles\");\n-\n-\t\t\t\t//Field policy_roles is saved as List of maps in the for loop\n-\t\t\t\tfor (JsonNode perunRoleNode : perunRolesNode) {\n-\t\t\t\t\tMap<String, String> innerRoleMap = createmapFromJsonNode(perunRoleNode);\n-\t\t\t\t\tperunRoles.add(innerRoleMap);\n-\t\t\t\t}\n-\n-\t\t\t\t//Field include_policies is saved as List of Strings.\n-\t\t\t\tList<String> includePolicies = new ArrayList<>(objectMapper.convertValue(policyNode.get(\"include_policies\"), new TypeReference<List<String>>() {\n-\t\t\t\t}));\n-\n-\t\t\t\tpolicies.add(new PerunPolicy(policyName, perunRoles, includePolicies));\n+\t\t\tJsonNode rootNode;\n+\t\t\tif (secondaryConfigurationPath != null) {\n+\t\t\t\trootNode = loadConfigurationFile(secondaryConfigurationPath);\n+\t\t\t\tpolicies.addAll(loadPoliciesFromJsonNode(rootNode));\n \t\t\t}\n+\t\t\trootNode = loadConfigurationFile(configurationPath);", "originalCommit": "acad23ccf27e5d8296ac535e770680174916c21e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDY5Njc4Mw==", "url": "https://github.com/CESNET/perun/pull/2816#discussion_r460696783", "bodyText": "Ok, @balcirakpeter corrected me, that its on purpose, because of behavior of adding policies method.", "author": "zlamalp", "createdAt": "2020-07-27T07:29:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDY2MjQwMg=="}], "type": "inlineReview"}, {"oid": "162b66945b318d14cfcf15834dc9a51bfaddb8a1", "url": "https://github.com/CESNET/perun/commit/162b66945b318d14cfcf15834dc9a51bfaddb8a1", "message": "Roles - default politics file\n\n* With the old implementation, it was difficult to release new versions\nof perun with new policits. All configurations would have to be changed\nand there was a lot of places to do a manual error. Even right now, we\ndon't plan to have different politics on different instances.\n* Created a default politics cofiguration file\n`perun-base/src/main/resources/perun-roles.yml` which is packed into the\nwar archive and will be used in production and even in tests.\n* Created a test configuration file `test-roles.yml` which contains\npolitics specially created for tests.\n* Changed behaviour of loading of the politics. On production, the\ndefault politics configuration is used and also, the configuration file\nat `/etc/perun/perun-roles.yml` can be used to override some politics.\nThis file is ignored during tests.", "committedDate": "2020-07-27T09:38:42Z", "type": "commit"}, {"oid": "162b66945b318d14cfcf15834dc9a51bfaddb8a1", "url": "https://github.com/CESNET/perun/commit/162b66945b318d14cfcf15834dc9a51bfaddb8a1", "message": "Roles - default politics file\n\n* With the old implementation, it was difficult to release new versions\nof perun with new policits. All configurations would have to be changed\nand there was a lot of places to do a manual error. Even right now, we\ndon't plan to have different politics on different instances.\n* Created a default politics cofiguration file\n`perun-base/src/main/resources/perun-roles.yml` which is packed into the\nwar archive and will be used in production and even in tests.\n* Created a test configuration file `test-roles.yml` which contains\npolitics specially created for tests.\n* Changed behaviour of loading of the politics. On production, the\ndefault politics configuration is used and also, the configuration file\nat `/etc/perun/perun-roles.yml` can be used to override some politics.\nThis file is ignored during tests.", "committedDate": "2020-07-27T09:38:42Z", "type": "forcePushed"}]}