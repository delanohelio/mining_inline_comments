{"pr_number": 2737, "pr_title": "CORE,GUI: Login / password checks for einfra", "pr_createdAt": "2020-06-11T12:21:58Z", "pr_url": "https://github.com/CESNET/perun/pull/2737", "timeline": [{"oid": "ae2e265acf92d65caa2343e05bdc786fb2cacb52", "url": "https://github.com/CESNET/perun/commit/ae2e265acf92d65caa2343e05bdc786fb2cacb52", "message": "CORE: Fixed mocks in tests of login-namespace attributes\n\n- We must mock results of new methods used in login-namespace module.", "committedDate": "2020-06-12T09:46:28Z", "type": "forcePushed"}, {"oid": "17a523c89b707199af615c2acff18e5de87016ba", "url": "https://github.com/CESNET/perun/commit/17a523c89b707199af615c2acff18e5de87016ba", "message": "GUI: Implemented login/password checks for einfra\n\n- Check for login availability can handle InvalidLoginException.\n- Show einfra specific help and perform checks on password.", "committedDate": "2020-06-12T10:21:33Z", "type": "commit"}, {"oid": "81b1487d45376b73fbf608af80a1af35adda18ec", "url": "https://github.com/CESNET/perun/commit/81b1487d45376b73fbf608af80a1af35adda18ec", "message": "GUI: Fixed conditions on password check\n\n- Fixed wrong condition on password input box validator results.\n- InvalidLoginException will be checked type, hence we must compare\n  exception name and not type.\n- Show proper help also on create service member.", "committedDate": "2020-06-12T10:21:34Z", "type": "commit"}, {"oid": "9211d17bcc18ea4207d7b8e6f6380a96e748f6c6", "url": "https://github.com/CESNET/perun/commit/9211d17bcc18ea4207d7b8e6f6380a96e748f6c6", "message": "CORE: Support login/password checks by password manager modules\n\n- Logic of attribute checks for login syntax was moved into\n  tha password manager modules.\n- Helping methods in ModulesUtilsBl were updated to work just with\n  login and namespace (without Attribute object).\n- New configuration option \"login-namespace:[namespace]:allowedExceptions\"\n  in /etc/perun/perun-namespaces.properties can be used to allow\n  otherwise invalid logins (syntactically or unpermitted).\n  This is necessary to enforce correct checks on new logins, but\n  leave out currently existing invalid logins.\n- Added checked InvalidLoginException, which is thrown if login\n  is invalid by syntax or is not permitted.\n- isLoginAvailable() now also checks if login is syntactically\n  correct and allowed within namespace before returning info about\n  availability. This allows us to have input check in current\n  forms.\n- Updated generic user:def:login-namespace attribute module to wrap\n  new logic and throw WrongAttributeValue as expected.\n\n- Implemented password strength check in password manager modules.\n- GenericPasswordManagerModule checks only emptiness, to conform\n  previous behavior.\n  EinfraPasswordManagerModule checks various password properties\n  and its logic will be extended later. It is also applied to\n  SambaduPasswordManagerModule.\n\n- Various generic methods working with login/password now throws those\n  two new exceptions, and usually also methods using them.\n  Core and RPC javadoc for such methods was updated.\n\nWe will have to cleanup various password manager exceptions, they are now\nkept for the purpose of compatibility with currently deployed scripts.\n\nIMPORTANT: On deployment, existing \"invalid\" logins must be set between\n           allowed exceptions. This is relevant for \"einfra\", since it\n           now implement non-generic check.", "committedDate": "2020-06-12T10:21:34Z", "type": "commit"}, {"oid": "9451bbb9d7994080e9fa1e81567a477343358469", "url": "https://github.com/CESNET/perun/commit/9451bbb9d7994080e9fa1e81567a477343358469", "message": "CORE: Fixed password manager script path for samba\n\n- Since we extend Einfra password manager module, which modifies\n  basic paths, we must re-init them.", "committedDate": "2020-06-12T10:21:34Z", "type": "commit"}, {"oid": "e46cbdf5599f9e04139056d86cf9fe3a3d5e47e1", "url": "https://github.com/CESNET/perun/commit/e46cbdf5599f9e04139056d86cf9fe3a3d5e47e1", "message": "CORE: Fixed mocks in tests of login-namespace attributes\n\n- We must mock results of new methods used in login-namespace module.", "committedDate": "2020-06-12T10:21:35Z", "type": "forcePushed"}, {"oid": "eb28bc5e523d6260a35a673a29f7018b6da26aa7", "url": "https://github.com/CESNET/perun/commit/eb28bc5e523d6260a35a673a29f7018b6da26aa7", "message": "CORE: Fixed mocks in tests of login-namespace attributes\n\n- We must mock results of new methods used in login-namespace module.", "committedDate": "2020-06-15T07:40:40Z", "type": "commit"}, {"oid": "eb28bc5e523d6260a35a673a29f7018b6da26aa7", "url": "https://github.com/CESNET/perun/commit/eb28bc5e523d6260a35a673a29f7018b6da26aa7", "message": "CORE: Fixed mocks in tests of login-namespace attributes\n\n- We must mock results of new methods used in login-namespace module.", "committedDate": "2020-06-15T07:40:40Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDY2MzEwOQ==", "url": "https://github.com/CESNET/perun/pull/2737#discussion_r440663109", "bodyText": "The name of this method is misleading. It sounds like the login could be a java Exception. I would change that for something like 'isLoginExceptionallyAllowed' or something like that.", "author": "stavamichal", "createdAt": "2020-06-16T08:06:03Z", "path": "perun-core/src/main/java/cz/metacentrum/perun/core/bl/ModulesUtilsBl.java", "diffHunk": "@@ -236,17 +237,50 @@\n \tvoid checkReservedUnixGroupNames(Attribute groupNameAttribute) throws WrongAttributeValueException;\n \n \t/**\n-\t * Check if value of login attribute is unpermitted.\n-\t * If not, its ok.\n-\t * If yes, throw WrongAttributeValueException.\n-\t * If attribute is null, then it's ok.\n-\t * For unpermitted user logins this method firstly tries to read perun-namespaces.properties file.\n-\t * If there is no property in this file, it reads the default hardcoded values.\n+\t * Check login value against regex defined for login-namespace.\n+\t * It throws InvalidLoginException if matching fails.\n+\t *\n+\t * Regex for each namespace can be defined in /etc/perun/perun-namespaces.properties\n+\t * You can define login exceptions, which override these syntactically wrong login names in the same file.\n+\t * It is to support historically wrong values or specific exception within existing namespaces.\n+\t * @see #isLoginException(String, String)\n+\t *\n+\t * @param namespace Namespace to perform check in\n+\t * @param login Login to check\n+\t * @param defaultRegex Default regex can be used if namespace doesn't define own.\n+\t * @throws InvalidLoginException If login value doesn't matches the regex\n+\t */\n+\tvoid checkLoginNamespaceRegex(String namespace, String login, Pattern defaultRegex) throws InvalidLoginException;\n+\n+\t/**\n+\t * Check if value of login is permitted within the namespace.\n+\t * Returns FALSE, if login value is not permitted within the namespace (eg. matches system user)\n \t *\n-\t * @param loginAttribute login-namespace\n-\t * @throws WrongAttributeValueException\n+\t * Reserved login names can be defined for each namespace in /etc/perun/perun-namespaces.properties\n+\t * If property for namespace is not found, then check is done against hardcoded defaults.\n+\t *\n+\t * You can define login exceptions, which override these reserved login names in the same file.\n+\t * This method returns TRUE for such exceptions.\n+\t * It is to support historically wrong values or specific exception within existing namespaces.\n+\t * @see #isLoginException(String, String)\n+\t *\n+\t * @param namespace Namespace to perform check in\n+\t * @param login Login to check\n+\t * @return TRUE if login value is permitted within the namespace / FALSE otherwise\n+\t */\n+\tboolean checkIfUserLoginIsPermitted(String namespace, String login);\n+\n+\t/**\n+\t * Return true, if login value is \"exception\" within its namespace rules.\n+\t * Eg. when syntax check normally doesn't allow such value, but its manually allowed here\n+\t * in order to support already existing (historic) wrong values.\n+\t * It can be defined for each namespace in /etc/perun/perun-namespaces.properties\n+\t *\n+\t * @param namespace Namespace to perform check in\n+\t * @param login Login to check\n+\t * @return TRUE if login value is within exceptions / FALSE otherwise\n \t */\n-\tvoid checkUnpermittedUserLogins(Attribute loginAttribute) throws WrongAttributeValueException;\n+\tboolean isLoginException(String namespace, String login);", "originalCommit": "eb28bc5e523d6260a35a673a29f7018b6da26aa7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDc0NTEyNQ==", "url": "https://github.com/CESNET/perun/pull/2737#discussion_r440745125", "bodyText": "Renamed to suggested name. I have no better.", "author": "zlamalp", "createdAt": "2020-06-16T10:21:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDY2MzEwOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDY3MjU2Mw==", "url": "https://github.com/CESNET/perun/pull/2737#discussion_r440672563", "bodyText": "I was thinking about this method and also there would be better name something like \"isUserLoginPermitted\", because it returns true or false. Check is more like OK or Exception in our code.", "author": "stavamichal", "createdAt": "2020-06-16T08:21:46Z", "path": "perun-core/src/main/java/cz/metacentrum/perun/core/blImpl/ModulesUtilsBlImpl.java", "diffHunk": "@@ -539,20 +540,66 @@ public void checkReservedUnixGroupNames(Attribute groupNameAttribute) throws Wro\n \t}\n \n \t@Override\n-\tpublic void checkUnpermittedUserLogins(Attribute loginAttribute) throws WrongAttributeValueException {\n-\t\tif(loginAttribute == null) return;\n+\tpublic void checkLoginNamespaceRegex(String namespace, String login, Pattern defaultRegex) throws InvalidLoginException {\n+\t\tUtils.notNull(namespace, \"namespace to check login syntax\");\n+\t\tUtils.notNull(login, \"login to check syntax for\");\n+\n \t\tcheckPerunNamespacesMap();\n \n-\t\tString unpermittedNames = perunNamespaces.get(loginAttribute.getFriendlyName() + \":reservedNames\");\n-\t\tif (unpermittedNames != null) {\n-\t\t\tList<String> unpermittedNamesList = Arrays.asList(unpermittedNames.split(\"\\\\s*,\\\\s*\"));\n-\t\t\tif (unpermittedNamesList.contains(loginAttribute.valueAsString()))\n-\t\t\t\tthrow new WrongAttributeValueException(loginAttribute, \"This login is not permitted.\");\n+\t\tString regex = perunNamespaces.get(\"login-namespace:\"+namespace+\":regex\");\n+\t\tif (regex != null) {\n+\t\t\t//Check if regex is valid\n+\t\t\ttry {\n+\t\t\t\tPattern.compile(regex);\n+\t\t\t} catch (PatternSyntaxException e) {\n+\t\t\t\tlog.error(\"Regex pattern \\\"{}\\\" from \\\"login-namespace:{}:regex\\\" property of perun-namespaces.properties file is invalid.\", regex, namespace);\n+\t\t\t\tthrow new InternalErrorException(\"Regex pattern \\\"\"+regex+\"\\\" from \\\"login-namespace:\"+namespace+\":regex\\\" property of perun-namespaces.properties file is invalid.\");\n+\t\t\t}\n+\t\t\t// check syntax or if its between exceptions\n+\t\t\tif(!login.matches(regex) && !isLoginException(namespace, login)) {\n+\t\t\t\tlog.warn(\"Login '{}' in {} namespace doesn't match regex: {}\", login, namespace, regex);\n+\t\t\t\tthrow new InvalidLoginException(\"Login doesn't matches expected regex: \\\"\" + regex +\"\\\"\");\n+\t\t\t}\n+\t\t} else {\n+\t\t\t// Regex property not found in our attribute map, so use the default hardcoded regex\n+\t\t\t// check syntax or if its between exceptions\n+\t\t\tif (!defaultRegex.matcher(login).matches() && !isLoginException(namespace, login)) {\n+\t\t\t\tlog.warn(\"Login '{}' in {} namespace doesn't match regex: {}\", login, namespace, regex);\n+\t\t\t\tthrow new InvalidLoginException(\"Login doesn't matches expected regex: \\\"\" + defaultRegex +\"\\\"\");\n+\t\t\t}\n+\t\t}\n+\t}\n+\n+\t@Override\n+\tpublic boolean checkIfUserLoginIsPermitted(String namespace, String login) {", "originalCommit": "eb28bc5e523d6260a35a673a29f7018b6da26aa7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDc0NTIyNw==", "url": "https://github.com/CESNET/perun/pull/2737#discussion_r440745227", "bodyText": "Renamed, makes sense.", "author": "zlamalp", "createdAt": "2020-06-16T10:21:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDY3MjU2Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDY3NDAzNA==", "url": "https://github.com/CESNET/perun/pull/2737#discussion_r440674034", "bodyText": "Why is this exception alone on the line?", "author": "stavamichal", "createdAt": "2020-06-16T08:24:13Z", "path": "perun-core/src/main/java/cz/metacentrum/perun/core/entry/MembersManagerEntry.java", "diffHunk": "@@ -1292,8 +1294,8 @@ public void sendPasswordResetLinkEmail(PerunSession sess, Member member, String\n \tpublic RichMember createSponsoredMember(PerunSession session, Vo vo, String namespace, Map<String, String> name, String password, User sponsor)\n \t\t\tthrows InternalErrorException, PrivilegeException, AlreadyMemberException,\n \t\t\tLoginNotExistsException, PasswordCreationFailedException,\n-\t\tExtendMembershipException,\n-\t\t\tWrongAttributeValueException, ExtSourceNotExistsException, WrongReferenceAttributeValueException, UserNotInRoleException {\n+\t\t\tExtendMembershipException,", "originalCommit": "eb28bc5e523d6260a35a673a29f7018b6da26aa7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDc0NDkyNA==", "url": "https://github.com/CESNET/perun/pull/2737#discussion_r440744924", "bodyText": "I aligned all exceptions in three rows.", "author": "zlamalp", "createdAt": "2020-06-16T10:20:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDY3NDAzNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDY4MTQ1Mg==", "url": "https://github.com/CESNET/perun/pull/2737#discussion_r440681452", "bodyText": "Typo 'adn'.", "author": "stavamichal", "createdAt": "2020-06-16T08:35:56Z", "path": "perun-core/src/main/java/cz/metacentrum/perun/core/impl/modules/pwdmgr/EinfraPasswordManagerModule.java", "diffHunk": "@@ -19,10 +20,11 @@\n \n import java.io.IOException;\n import java.util.Map;\n+import java.util.regex.Pattern;\n \n /**\n- * Password manager for EINFRA login-namespace. It performs custom checks\n- * on password strength and login format.\n+ * Password manager for EINFRA login-namespace. It provides custom checks on login format\n+ * adn password strength. Also implementation for alternative passwords is customized.", "originalCommit": "eb28bc5e523d6260a35a673a29f7018b6da26aa7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDc0NDc1OA==", "url": "https://github.com/CESNET/perun/pull/2737#discussion_r440744758", "bodyText": "Fixed", "author": "zlamalp", "createdAt": "2020-06-16T10:20:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDY4MTQ1Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDY4NzI4OQ==", "url": "https://github.com/CESNET/perun/pull/2737#discussion_r440687289", "bodyText": "I am not sure what does this comment mean.", "author": "stavamichal", "createdAt": "2020-06-16T08:45:08Z", "path": "perun-core/src/main/java/cz/metacentrum/perun/core/impl/modules/pwdmgr/GenericPasswordManagerModule.java", "diffHunk": "@@ -55,64 +64,65 @@ public void setActualLoginNamespace(String actualLoginNamespace) {\n \t}\n \n \t@Override\n-\tpublic Map<String, String> generateAccount(PerunSession session, Map<String, String> parameters) throws InternalErrorException {\n+\tpublic Map<String, String> generateAccount(PerunSession sess, Map<String, String> parameters) {\n \t\t// account generation is not supported\n \t\treturn null;\n \t}\n \n \t@Override\n-\tpublic void reservePassword(PerunSession session, String userLogin, String password) throws InternalErrorException {\n-\t\tif (StringUtils.isBlank(password)) {\n-\t\t\tthrow new EmptyPasswordRuntimeException(\"Password for \" + actualLoginNamespace + \":\" + userLogin + \" cannot be empty.\");\n-\t\t}\n+\tpublic void reservePassword(PerunSession sess, String userLogin, String password) throws InvalidLoginException, PasswordStrengthException {\n+\t\tcheckLoginFormat(sess, userLogin);\n+\t\tcheckPasswordStrength(sess, userLogin, password);\n \t\tProcess process = createPwdManagerProcess(PASSWORD_RESERVE, actualLoginNamespace, userLogin);\n \t\tsendPassword(process, password);\n \t\thandleExit(process, actualLoginNamespace, userLogin);\n \t}\n \n \t@Override\n-\tpublic void reserveRandomPassword(PerunSession session, String userLogin) throws InternalErrorException {\n+\tpublic void reserveRandomPassword(PerunSession sess, String userLogin) throws InvalidLoginException {\n+\t\tcheckLoginFormat(sess, userLogin);\n \t\tProcess process = createPwdManagerProcess(PASSWORD_RESERVE_RANDOM, actualLoginNamespace, userLogin);\n \t\thandleExit(process, actualLoginNamespace, userLogin);\n \t}\n \n \t@Override\n \tpublic void checkPassword(PerunSession sess, String userLogin, String password) {\n+\t\t// use custom check instead of strength, since this is about empty input", "originalCommit": "eb28bc5e523d6260a35a673a29f7018b6da26aa7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDc0NjEyNw==", "url": "https://github.com/CESNET/perun/pull/2737#discussion_r440746127", "bodyText": "I rephrase that. Basically we must not check password strength here, since we check \"old\" possibly weaker password. We just must make sure, that input is not empty.", "author": "zlamalp", "createdAt": "2020-06-16T10:23:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDY4NzI4OQ=="}], "type": "inlineReview"}, {"oid": "20534ba82c91cb62f1cc61e45822a29933113084", "url": "https://github.com/CESNET/perun/commit/20534ba82c91cb62f1cc61e45822a29933113084", "message": "CORE: Renamed methods, fixed typos\n\n- Renamed checkIfUserLoginIsPermitted() and isLoginException() methods\n  in ModulesUtilsBl to isUserLoginPermitted() and isLoginExceptionallyAllowed().\n- Aligned thrown exceptions in MembersManagerEntry.\n- Fixed typos and comments in password manager modules.", "committedDate": "2020-06-16T10:19:49Z", "type": "commit"}, {"oid": "20534ba82c91cb62f1cc61e45822a29933113084", "url": "https://github.com/CESNET/perun/commit/20534ba82c91cb62f1cc61e45822a29933113084", "message": "CORE: Renamed methods, fixed typos\n\n- Renamed checkIfUserLoginIsPermitted() and isLoginException() methods\n  in ModulesUtilsBl to isUserLoginPermitted() and isLoginExceptionallyAllowed().\n- Aligned thrown exceptions in MembersManagerEntry.\n- Fixed typos and comments in password manager modules.", "committedDate": "2020-06-16T10:19:49Z", "type": "forcePushed"}]}