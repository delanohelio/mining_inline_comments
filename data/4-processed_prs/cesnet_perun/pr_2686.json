{"pr_number": 2686, "pr_title": "New module for user virt attribute tcsMails", "pr_createdAt": "2020-05-05T09:39:50Z", "pr_url": "https://github.com/CESNET/perun/pull/2686", "timeline": [{"oid": "466174b2d418e623baba2dd6547d32d2a1b4beb0", "url": "https://github.com/CESNET/perun/commit/466174b2d418e623baba2dd6547d32d2a1b4beb0", "message": "New module for user virt attribute tcsMails\n\n - it will compute values from different email attributes (affected) to one.\n This value then will be used for purpose of TCS\n - it also reacts on messages with changes in affected attributes\n - tests for modules were added", "committedDate": "2020-05-05T10:04:30Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTk5NTQzOA==", "url": "https://github.com/CESNET/perun/pull/2686#discussion_r419995438", "bodyText": "Since you end each branch with single return true; you can probably remove else from all branches and simply return false at the end if no previous if was true.", "author": "zlamalp", "createdAt": "2020-05-05T10:00:52Z", "path": "perun-core/src/main/java/cz/metacentrum/perun/core/impl/modules/attributes/urn_perun_user_attribute_def_virt_tcsMails.java", "diffHunk": "@@ -0,0 +1,161 @@\n+package cz.metacentrum.perun.core.impl.modules.attributes;\n+\n+import cz.metacentrum.perun.audit.events.AttributesManagerEvents.AllAttributesRemovedForUser;\n+import cz.metacentrum.perun.audit.events.AttributesManagerEvents.AttributeChangedForUser;\n+import cz.metacentrum.perun.audit.events.AttributesManagerEvents.AttributeRemovedForUser;\n+import cz.metacentrum.perun.audit.events.AttributesManagerEvents.AttributeSetForUser;\n+import cz.metacentrum.perun.audit.events.AuditEvent;\n+import cz.metacentrum.perun.core.api.Attribute;\n+import cz.metacentrum.perun.core.api.AttributeDefinition;\n+import cz.metacentrum.perun.core.api.AttributesManager;\n+import cz.metacentrum.perun.core.api.User;\n+import cz.metacentrum.perun.core.api.exceptions.AttributeNotExistsException;\n+import cz.metacentrum.perun.core.api.exceptions.InternalErrorException;\n+import cz.metacentrum.perun.core.api.exceptions.WrongAttributeAssignmentException;\n+import cz.metacentrum.perun.core.api.exceptions.WrongReferenceAttributeValueException;\n+import cz.metacentrum.perun.core.impl.PerunSessionImpl;\n+import cz.metacentrum.perun.core.implApi.modules.attributes.SkipValueCheckDuringDependencyCheck;\n+import cz.metacentrum.perun.core.implApi.modules.attributes.UserVirtualAttributesModuleAbstract;\n+import cz.metacentrum.perun.core.implApi.modules.attributes.UserVirtualAttributesModuleImplApi;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.util.ArrayList;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Set;\n+\n+/**\n+ * Get all emails from Perun for purpose of TCS.\n+ *\n+ * @author Michal Stava stavamichal@gmail.com\n+ */\n+@SkipValueCheckDuringDependencyCheck\n+public class urn_perun_user_attribute_def_virt_tcsMails extends UserVirtualAttributesModuleAbstract implements UserVirtualAttributesModuleImplApi {\n+\n+\tprivate static final String preferredMailFriendlyName = \"preferredMail\";\n+\tprivate static final String isMailFriendlyName = \"ISMail\";\n+\tprivate static final String publicMailsFriendlyName = \"publicAliasMails\";\n+\tprivate static final String privateMailsFriendlyName = \"privateAliasMails\";\n+\tprivate static final String o365MailsFriendlyName = \"o365EmailAddresses:mu\";\n+\n+\tprivate static final String A_U_D_preferredMail = AttributesManager.NS_USER_ATTR_DEF + \":\" + preferredMailFriendlyName;\n+\tprivate static final String A_U_D_ISMail = AttributesManager.NS_USER_ATTR_DEF + \":\" + isMailFriendlyName;\n+\tprivate static final String A_U_D_publicAliasMails = AttributesManager.NS_USER_ATTR_DEF + \":\" + publicMailsFriendlyName;\n+\tprivate static final String A_U_D_privateAliasMails = AttributesManager.NS_USER_ATTR_DEF + \":\" + privateMailsFriendlyName;\n+\tprivate static final String A_U_D_o365EmailAddressesMU = AttributesManager.NS_USER_ATTR_DEF + \":\" + o365MailsFriendlyName;\n+\n+\tprivate final static Logger log = LoggerFactory.getLogger(urn_perun_user_attribute_def_virt_tcsMails.class);\n+\n+\t@Override\n+\tpublic Attribute getAttributeValue(PerunSessionImpl sess, User user, AttributeDefinition attributeDefinition) throws InternalErrorException {\n+\n+\t\tAttribute attribute = new Attribute(attributeDefinition);\n+\t\tSet<String> tcsMailsValue = new HashSet<>();\n+\n+\t\ttcsMailsValue.addAll(getEmailValues(sess, user, A_U_D_preferredMail));\n+\t\ttcsMailsValue.addAll(getEmailValues(sess, user, A_U_D_ISMail));\n+\t\ttcsMailsValue.addAll(getEmailValues(sess, user, A_U_D_publicAliasMails));\n+\t\ttcsMailsValue.addAll(getEmailValues(sess, user, A_U_D_privateAliasMails));\n+\t\ttcsMailsValue.addAll(getEmailValues(sess, user, A_U_D_o365EmailAddressesMU));\n+\n+\t\tattribute.setValue(new ArrayList(tcsMailsValue));\n+\n+\t\treturn attribute;\n+\t}\n+\n+\t@Override\n+\tpublic List<AuditEvent> resolveVirtualAttributeValueChange(PerunSessionImpl perunSession, AuditEvent message) throws InternalErrorException, WrongReferenceAttributeValueException, AttributeNotExistsException, WrongAttributeAssignmentException {\n+\t\tList<AuditEvent> resolvingMessages = new ArrayList<>();\n+\n+\t\t// handle source user attributes changes\n+\t\tif (message instanceof AttributeSetForUser && isAffectedAttribute(((AttributeSetForUser) message).getAttribute().getFriendlyName())) {\n+\t\t\tAttributeDefinition attributeDefinition = perunSession.getPerunBl().getAttributesManagerBl().getAttributeDefinition(perunSession, this.getAttributeDefinition().getName());\n+\t\t\tresolvingMessages.add(new AttributeChangedForUser(new Attribute(attributeDefinition), ((AttributeSetForUser) message).getUser()));\n+\n+\t\t} else if (message instanceof AttributeRemovedForUser && isAffectedAttribute(((AttributeRemovedForUser) message).getAttribute().getFriendlyName())) {\n+\t\t\tAttributeDefinition attributeDefinition = perunSession.getPerunBl().getAttributesManagerBl().getAttributeDefinition(perunSession, this.getAttributeDefinition().getName());\n+\t\t\tresolvingMessages.add(new AttributeChangedForUser(new Attribute(attributeDefinition), ((AttributeRemovedForUser) message).getUser()));\n+\n+\t\t} else if (message instanceof AllAttributesRemovedForUser) {\n+\t\t\tAttributeDefinition attributeDefinition = perunSession.getPerunBl().getAttributesManagerBl().getAttributeDefinition(perunSession, this.getAttributeDefinition().getName());\n+\t\t\tresolvingMessages.add(new AttributeChangedForUser(new Attribute(attributeDefinition), ((AllAttributesRemovedForUser) message).getUser()));\n+\n+\t\t}\n+\n+\t\treturn resolvingMessages;\n+\t}\n+\n+\t/**\n+\t * Return true if attribute name is one of affected attributes in this virtual module.\n+\t *\n+\t * @param nameOfAttribute name of attribute to check\n+\t * @return true if attribute is one of affected, false otherwise\n+\t */\n+\tprivate boolean isAffectedAttribute(String nameOfAttribute) {\n+\t\tif(preferredMailFriendlyName.equals(nameOfAttribute)) return true;\n+\t\telse if(isMailFriendlyName.equals(nameOfAttribute)) return true;", "originalCommit": "a8c9083d8d1dab4f928a3f84c14dd9c4d5355646", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDAxMTgyOA==", "url": "https://github.com/CESNET/perun/pull/2686#discussion_r420011828", "bodyText": "Changed.", "author": "stavamichal", "createdAt": "2020-05-05T10:32:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTk5NTQzOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTk5OTM3Ng==", "url": "https://github.com/CESNET/perun/pull/2686#discussion_r419999376", "bodyText": "I would probably prefer more MU specific attribute name or usage of namespace, since request for TCS mails attribute might be required by others, but they will require own source attributes (different implementation). But for now, there is nobody else requiring it, so its just suggestion.", "author": "zlamalp", "createdAt": "2020-05-05T10:08:19Z", "path": "perun-core/src/main/java/cz/metacentrum/perun/core/impl/modules/attributes/urn_perun_user_attribute_def_virt_tcsMails.java", "diffHunk": "@@ -0,0 +1,161 @@\n+package cz.metacentrum.perun.core.impl.modules.attributes;\n+\n+import cz.metacentrum.perun.audit.events.AttributesManagerEvents.AllAttributesRemovedForUser;\n+import cz.metacentrum.perun.audit.events.AttributesManagerEvents.AttributeChangedForUser;\n+import cz.metacentrum.perun.audit.events.AttributesManagerEvents.AttributeRemovedForUser;\n+import cz.metacentrum.perun.audit.events.AttributesManagerEvents.AttributeSetForUser;\n+import cz.metacentrum.perun.audit.events.AuditEvent;\n+import cz.metacentrum.perun.core.api.Attribute;\n+import cz.metacentrum.perun.core.api.AttributeDefinition;\n+import cz.metacentrum.perun.core.api.AttributesManager;\n+import cz.metacentrum.perun.core.api.User;\n+import cz.metacentrum.perun.core.api.exceptions.AttributeNotExistsException;\n+import cz.metacentrum.perun.core.api.exceptions.InternalErrorException;\n+import cz.metacentrum.perun.core.api.exceptions.WrongAttributeAssignmentException;\n+import cz.metacentrum.perun.core.api.exceptions.WrongReferenceAttributeValueException;\n+import cz.metacentrum.perun.core.impl.PerunSessionImpl;\n+import cz.metacentrum.perun.core.implApi.modules.attributes.SkipValueCheckDuringDependencyCheck;\n+import cz.metacentrum.perun.core.implApi.modules.attributes.UserVirtualAttributesModuleAbstract;\n+import cz.metacentrum.perun.core.implApi.modules.attributes.UserVirtualAttributesModuleImplApi;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.SortedSet;\n+import java.util.TreeSet;\n+\n+/**\n+ * Get all emails from Perun for purpose of TCS.\n+ *\n+ * @author Michal Stava stavamichal@gmail.com\n+ */\n+@SkipValueCheckDuringDependencyCheck\n+public class urn_perun_user_attribute_def_virt_tcsMails extends UserVirtualAttributesModuleAbstract implements UserVirtualAttributesModuleImplApi {", "originalCommit": "466174b2d418e623baba2dd6547d32d2a1b4beb0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDAyMDk3Nw==", "url": "https://github.com/CESNET/perun/pull/2686#discussion_r420020977", "bodyText": "Name was changed to have namespace mu in it.", "author": "stavamichal", "createdAt": "2020-05-05T10:50:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTk5OTM3Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDAwNjg5NA==", "url": "https://github.com/CESNET/perun/pull/2686#discussion_r420006894", "bodyText": "when(perunBl.getModulesUtilsBl()).thenReturn(mu);\nwhen(mu.getUserFromMessage(eq(sess), any(String.class))).thenReturn(user);\n\nYou don't seem to be using above two methods, hence no need to mock them.", "author": "zlamalp", "createdAt": "2020-05-05T10:23:10Z", "path": "perun-core/src/test/java/cz/metacentrum/perun/core/impl/modules/attributes/urn_perun_user_attribute_def_virt_tcsMailsTest.java", "diffHunk": "@@ -0,0 +1,195 @@\n+package cz.metacentrum.perun.core.impl.modules.attributes;\n+\n+import cz.metacentrum.perun.audit.events.AttributesManagerEvents.AllAttributesRemovedForUser;\n+import cz.metacentrum.perun.audit.events.AttributesManagerEvents.AttributeRemovedForUser;\n+import cz.metacentrum.perun.audit.events.AttributesManagerEvents.AttributeSetForUser;\n+import cz.metacentrum.perun.audit.events.AuditEvent;\n+import cz.metacentrum.perun.core.api.Attribute;\n+import cz.metacentrum.perun.core.api.AttributeDefinition;\n+import cz.metacentrum.perun.core.api.AttributesManager;\n+import cz.metacentrum.perun.core.api.User;\n+import cz.metacentrum.perun.core.bl.AttributesManagerBl;\n+import cz.metacentrum.perun.core.bl.ModulesUtilsBl;\n+import cz.metacentrum.perun.core.bl.PerunBl;\n+import cz.metacentrum.perun.core.bl.UsersManagerBl;\n+import cz.metacentrum.perun.core.impl.PerunSessionImpl;\n+import org.hamcrest.CoreMatchers;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.List;\n+\n+import static org.hamcrest.CoreMatchers.is;\n+import static org.hamcrest.CoreMatchers.notNullValue;\n+import static org.junit.Assert.assertThat;\n+import static org.junit.Assert.assertTrue;\n+import static org.mockito.ArgumentMatchers.any;\n+import static org.mockito.ArgumentMatchers.eq;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.when;\n+\n+/**\n+ * @author Michal Stava stavamichal@gmail.com\n+ */\n+public class urn_perun_user_attribute_def_virt_tcsMailsTest {\n+\n+\tprivate final static Logger log = LoggerFactory.getLogger(urn_perun_user_attribute_def_virt_tcsMailsTest.class);\n+\n+\tprivate final urn_perun_user_attribute_def_virt_tcsMails classInstance = new urn_perun_user_attribute_def_virt_tcsMails();\n+\tprivate final AttributeDefinition tcsMailsAttrDef = classInstance.getAttributeDefinition();\n+\n+\tprivate final User user = new User(10, \"Joe\", \"Doe\", \"W.\", \"\", \"\");\n+\n+\tprivate final String email1 = \"email1@mail.cz\";\n+\tprivate final String email2 = \"email2@mail.cz\";\n+\tprivate final String email3 = \"email3@mail.cz\";\n+\tprivate final String email4 = \"email4@mail.cz\";\n+\tprivate final String email5 = \"email5@mail.cz\";\n+\n+\tAttribute preferredMailAttr = setUpUserAttribute(1, \"preferredMail\", String.class.getName(), email1);\n+\tAttribute isMailAttr = setUpUserAttribute(2, \"ISMail\", String.class.getName(), email2);\n+\tAttribute publicMailsAttr = setUpUserAttribute(3, \"publicAliasMails\", ArrayList.class.getName(), new ArrayList(Arrays.asList(email3, email4)));\n+\tAttribute privateMailsAttr = setUpUserAttribute(4, \"privateAliasMails\", ArrayList.class.getName(), new ArrayList(Arrays.asList(email4, email5)));\n+\tAttribute o365MailsAttr = setUpUserAttribute(5, \"o365EmailAddresses:mu\", ArrayList.class.getName(), new ArrayList(Arrays.asList(email1, email3, email5)));\n+\n+\tprivate PerunSessionImpl sess;\n+\n+\t@Before\n+\tpublic void setUp() throws Exception {\n+\t\ttcsMailsAttrDef.setId(100);\n+\t\t//prepare mocks\n+\t\tsess = mock(PerunSessionImpl.class);\n+\t\tPerunBl perunBl = mock(PerunBl.class);\n+\t\tAttributesManagerBl am = mock(AttributesManagerBl.class);\n+\t\tUsersManagerBl um = mock(UsersManagerBl.class);\n+\t\tModulesUtilsBl mu = mock(ModulesUtilsBl.class);\n+\t\twhen(sess.getPerunBl()).thenReturn(perunBl);\n+\t\twhen(perunBl.getAttributesManagerBl()).thenReturn(am);\n+\t\twhen(perunBl.getUsersManagerBl()).thenReturn(um);\n+\t\twhen(perunBl.getModulesUtilsBl()).thenReturn(mu);\n+\t\twhen(mu.getUserFromMessage(eq(sess), any(String.class))).thenReturn(user);", "originalCommit": "466174b2d418e623baba2dd6547d32d2a1b4beb0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDAxMjYyMQ==", "url": "https://github.com/CESNET/perun/pull/2686#discussion_r420012621", "bodyText": "Removed.", "author": "stavamichal", "createdAt": "2020-05-05T10:34:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDAwNjg5NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDAwNzk5Nw==", "url": "https://github.com/CESNET/perun/pull/2686#discussion_r420007997", "bodyText": "You have this unused variable countries in all tests. Why?", "author": "zlamalp", "createdAt": "2020-05-05T10:25:27Z", "path": "perun-core/src/test/java/cz/metacentrum/perun/core/impl/modules/attributes/urn_perun_user_attribute_def_virt_tcsMailsTest.java", "diffHunk": "@@ -0,0 +1,195 @@\n+package cz.metacentrum.perun.core.impl.modules.attributes;\n+\n+import cz.metacentrum.perun.audit.events.AttributesManagerEvents.AllAttributesRemovedForUser;\n+import cz.metacentrum.perun.audit.events.AttributesManagerEvents.AttributeRemovedForUser;\n+import cz.metacentrum.perun.audit.events.AttributesManagerEvents.AttributeSetForUser;\n+import cz.metacentrum.perun.audit.events.AuditEvent;\n+import cz.metacentrum.perun.core.api.Attribute;\n+import cz.metacentrum.perun.core.api.AttributeDefinition;\n+import cz.metacentrum.perun.core.api.AttributesManager;\n+import cz.metacentrum.perun.core.api.User;\n+import cz.metacentrum.perun.core.bl.AttributesManagerBl;\n+import cz.metacentrum.perun.core.bl.ModulesUtilsBl;\n+import cz.metacentrum.perun.core.bl.PerunBl;\n+import cz.metacentrum.perun.core.bl.UsersManagerBl;\n+import cz.metacentrum.perun.core.impl.PerunSessionImpl;\n+import org.hamcrest.CoreMatchers;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.List;\n+\n+import static org.hamcrest.CoreMatchers.is;\n+import static org.hamcrest.CoreMatchers.notNullValue;\n+import static org.junit.Assert.assertThat;\n+import static org.junit.Assert.assertTrue;\n+import static org.mockito.ArgumentMatchers.any;\n+import static org.mockito.ArgumentMatchers.eq;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.when;\n+\n+/**\n+ * @author Michal Stava stavamichal@gmail.com\n+ */\n+public class urn_perun_user_attribute_def_virt_tcsMailsTest {\n+\n+\tprivate final static Logger log = LoggerFactory.getLogger(urn_perun_user_attribute_def_virt_tcsMailsTest.class);\n+\n+\tprivate final urn_perun_user_attribute_def_virt_tcsMails classInstance = new urn_perun_user_attribute_def_virt_tcsMails();\n+\tprivate final AttributeDefinition tcsMailsAttrDef = classInstance.getAttributeDefinition();\n+\n+\tprivate final User user = new User(10, \"Joe\", \"Doe\", \"W.\", \"\", \"\");\n+\n+\tprivate final String email1 = \"email1@mail.cz\";\n+\tprivate final String email2 = \"email2@mail.cz\";\n+\tprivate final String email3 = \"email3@mail.cz\";\n+\tprivate final String email4 = \"email4@mail.cz\";\n+\tprivate final String email5 = \"email5@mail.cz\";\n+\n+\tAttribute preferredMailAttr = setUpUserAttribute(1, \"preferredMail\", String.class.getName(), email1);\n+\tAttribute isMailAttr = setUpUserAttribute(2, \"ISMail\", String.class.getName(), email2);\n+\tAttribute publicMailsAttr = setUpUserAttribute(3, \"publicAliasMails\", ArrayList.class.getName(), new ArrayList(Arrays.asList(email3, email4)));\n+\tAttribute privateMailsAttr = setUpUserAttribute(4, \"privateAliasMails\", ArrayList.class.getName(), new ArrayList(Arrays.asList(email4, email5)));\n+\tAttribute o365MailsAttr = setUpUserAttribute(5, \"o365EmailAddresses:mu\", ArrayList.class.getName(), new ArrayList(Arrays.asList(email1, email3, email5)));\n+\n+\tprivate PerunSessionImpl sess;\n+\n+\t@Before\n+\tpublic void setUp() throws Exception {\n+\t\ttcsMailsAttrDef.setId(100);\n+\t\t//prepare mocks\n+\t\tsess = mock(PerunSessionImpl.class);\n+\t\tPerunBl perunBl = mock(PerunBl.class);\n+\t\tAttributesManagerBl am = mock(AttributesManagerBl.class);\n+\t\tUsersManagerBl um = mock(UsersManagerBl.class);\n+\t\tModulesUtilsBl mu = mock(ModulesUtilsBl.class);\n+\t\twhen(sess.getPerunBl()).thenReturn(perunBl);\n+\t\twhen(perunBl.getAttributesManagerBl()).thenReturn(am);\n+\t\twhen(perunBl.getUsersManagerBl()).thenReturn(um);\n+\t\twhen(perunBl.getModulesUtilsBl()).thenReturn(mu);\n+\t\twhen(mu.getUserFromMessage(eq(sess), any(String.class))).thenReturn(user);\n+\t\twhen(sess.getPerunBl().getAttributesManagerBl().getAttribute(sess, user, preferredMailAttr.getName())).thenReturn(preferredMailAttr);\n+\t\twhen(sess.getPerunBl().getAttributesManagerBl().getAttribute(sess, user, isMailAttr.getName())).thenReturn(isMailAttr);\n+\t\twhen(sess.getPerunBl().getAttributesManagerBl().getAttribute(sess, user, publicMailsAttr.getName())).thenReturn(publicMailsAttr);\n+\t\twhen(sess.getPerunBl().getAttributesManagerBl().getAttribute(sess, user, privateMailsAttr.getName())).thenReturn(privateMailsAttr);\n+\t\twhen(sess.getPerunBl().getAttributesManagerBl().getAttribute(sess, user, o365MailsAttr.getName())).thenReturn(o365MailsAttr);\n+\t\twhen(sess.getPerunBl().getAttributesManagerBl().getAttributeDefinition(sess, tcsMailsAttrDef.getName())).thenReturn(tcsMailsAttrDef);\n+\t}\n+\n+\tprivate Attribute setUpUserAttribute(int id, String friendlyName, String type, Object value) {\n+\t\tAttributeDefinition attrDef = new AttributeDefinition();\n+\t\tattrDef.setId(id);\n+\t\tattrDef.setFriendlyName(friendlyName);\n+\t\tattrDef.setNamespace(AttributesManager.NS_USER_ATTR_DEF);\n+\t\tattrDef.setType(type);\n+\t\tAttribute attr = new Attribute(attrDef);\n+\t\tattr.setValue(value);\n+\t\treturn attr;\n+\t}\n+\n+\t@Test\n+\tpublic void getAttributeValue() throws Exception {\n+\t\t@SuppressWarnings(\"unchecked\") ArrayList<String> attributeValue = classInstance.getAttributeValue(sess, user, tcsMailsAttrDef).valueAsList();\n+\t\tassertThat(attributeValue, is(notNullValue()));\n+\t\t//we want to be sure, that preferredEmail is first (defined by sorting in module)\n+\t\tassertTrue(attributeValue.get(0).equals(email1));\n+\t\tassertThat(attributeValue, CoreMatchers.hasItem(email1));\n+\t\tassertThat(attributeValue, CoreMatchers.hasItem(email2));\n+\t\tassertThat(attributeValue, CoreMatchers.hasItem(email3));\n+\t\tassertThat(attributeValue, CoreMatchers.hasItem(email4));\n+\t\tassertThat(attributeValue, CoreMatchers.hasItem(email5));\n+\t\tassertThat(attributeValue.size(), is(5));\n+\t}\n+\n+\t@Test\n+\tpublic void resolveVirtualAttributeValueChangeSet1() throws Exception {\n+\t\tAttributeDefinition countries = classInstance.getAttributeDefinition();", "originalCommit": "466174b2d418e623baba2dd6547d32d2a1b4beb0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDAxMTk0Ng==", "url": "https://github.com/CESNET/perun/pull/2686#discussion_r420011946", "bodyText": "Copy & paste. Removed.", "author": "stavamichal", "createdAt": "2020-05-05T10:33:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDAwNzk5Nw=="}], "type": "inlineReview"}, {"oid": "4cce017d3a759bc46499e70ed05824387cf4b661", "url": "https://github.com/CESNET/perun/commit/4cce017d3a759bc46499e70ed05824387cf4b661", "message": "New module for user virt attribute tcsMails\n\n - it will compute values from different email attributes (affected) to one.\n This value then will be used for purpose of TCS\n - it also reacts on messages with changes in affected attributes\n - tests for modules were added", "committedDate": "2020-05-05T10:29:44Z", "type": "forcePushed"}, {"oid": "1f1324b1d3f7d6fd4bd99417ffe9a7770e842642", "url": "https://github.com/CESNET/perun/commit/1f1324b1d3f7d6fd4bd99417ffe9a7770e842642", "message": "New module for user virt attribute tcsMails\n\n - it will compute values from different email attributes (affected) to one.\n This value then will be used for purpose of TCS\n - it also reacts on messages with changes in affected attributes\n - tests for modules were added", "committedDate": "2020-05-05T10:32:40Z", "type": "forcePushed"}, {"oid": "cd0f48f202d9bc22c303c732f13d7649d7d1440f", "url": "https://github.com/CESNET/perun/commit/cd0f48f202d9bc22c303c732f13d7649d7d1440f", "message": "New module for user virt attribute tcsMails\n\n - it will compute values from different email attributes (affected) to one.\n This value then will be used for purpose of TCS\n - it also reacts on messages with changes in affected attributes\n - tests for modules were added", "committedDate": "2020-05-05T10:34:21Z", "type": "forcePushed"}, {"oid": "cf3d54b0a56504b66cd1130f5e2a444e454d75da", "url": "https://github.com/CESNET/perun/commit/cf3d54b0a56504b66cd1130f5e2a444e454d75da", "message": "New module for user virt attribute tcsMails\n\n - it will compute values from different email attributes (affected) to one.\n This value then will be used for purpose of TCS\n - it also reacts on messages with changes in affected attributes\n - tests for modules were added", "committedDate": "2020-05-05T10:38:57Z", "type": "forcePushed"}, {"oid": "704dc30152d5b96c0891d181ba4061d16b489754", "url": "https://github.com/CESNET/perun/commit/704dc30152d5b96c0891d181ba4061d16b489754", "message": "New module for user virt attribute tcsMails\n\n - it will compute values from different email attributes (affected) to one.\n This value then will be used for purpose of TCS\n - it also reacts on messages with changes in affected attributes\n - tests for modules were added", "committedDate": "2020-05-05T10:47:14Z", "type": "forcePushed"}, {"oid": "ac1c312fe445c2cac297d13a435d62e61270defd", "url": "https://github.com/CESNET/perun/commit/ac1c312fe445c2cac297d13a435d62e61270defd", "message": "New module for user virt attribute tcsMails\n\n - it will compute values from different email attributes (affected) to one.\n This value then will be used for purpose of TCS\n - it also reacts on messages with changes in affected attributes\n - tests for modules were added", "committedDate": "2020-05-05T10:49:53Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDA4MDUxOA==", "url": "https://github.com/CESNET/perun/pull/2686#discussion_r420080518", "bodyText": "You don't have to throw InternalErrorException in any of these methods :)", "author": "balcirakpeter", "createdAt": "2020-05-05T12:46:24Z", "path": "perun-core/src/main/java/cz/metacentrum/perun/core/impl/modules/attributes/urn_perun_user_attribute_def_virt_tcsMails_mu.java", "diffHunk": "@@ -0,0 +1,162 @@\n+package cz.metacentrum.perun.core.impl.modules.attributes;\n+\n+import cz.metacentrum.perun.audit.events.AttributesManagerEvents.AllAttributesRemovedForUser;\n+import cz.metacentrum.perun.audit.events.AttributesManagerEvents.AttributeChangedForUser;\n+import cz.metacentrum.perun.audit.events.AttributesManagerEvents.AttributeRemovedForUser;\n+import cz.metacentrum.perun.audit.events.AttributesManagerEvents.AttributeSetForUser;\n+import cz.metacentrum.perun.audit.events.AuditEvent;\n+import cz.metacentrum.perun.core.api.Attribute;\n+import cz.metacentrum.perun.core.api.AttributeDefinition;\n+import cz.metacentrum.perun.core.api.AttributesManager;\n+import cz.metacentrum.perun.core.api.User;\n+import cz.metacentrum.perun.core.api.exceptions.AttributeNotExistsException;\n+import cz.metacentrum.perun.core.api.exceptions.InternalErrorException;\n+import cz.metacentrum.perun.core.api.exceptions.WrongAttributeAssignmentException;\n+import cz.metacentrum.perun.core.api.exceptions.WrongReferenceAttributeValueException;\n+import cz.metacentrum.perun.core.impl.PerunSessionImpl;\n+import cz.metacentrum.perun.core.implApi.modules.attributes.SkipValueCheckDuringDependencyCheck;\n+import cz.metacentrum.perun.core.implApi.modules.attributes.UserVirtualAttributesModuleAbstract;\n+import cz.metacentrum.perun.core.implApi.modules.attributes.UserVirtualAttributesModuleImplApi;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.SortedSet;\n+import java.util.TreeSet;\n+\n+/**\n+ * Get all emails from Perun for purpose of TCS.\n+ *\n+ * @author Michal Stava stavamichal@gmail.com\n+ */\n+@SkipValueCheckDuringDependencyCheck\n+public class urn_perun_user_attribute_def_virt_tcsMails_mu extends UserVirtualAttributesModuleAbstract implements UserVirtualAttributesModuleImplApi {\n+\n+\tprivate static final String preferredMailFriendlyName = \"preferredMail\";\n+\tprivate static final String isMailFriendlyName = \"ISMail\";\n+\tprivate static final String publicMailsFriendlyName = \"publicAliasMails\";\n+\tprivate static final String privateMailsFriendlyName = \"privateAliasMails\";\n+\tprivate static final String o365MailsFriendlyName = \"o365EmailAddresses:mu\";\n+\n+\tprivate static final String A_U_D_preferredMail = AttributesManager.NS_USER_ATTR_DEF + \":\" + preferredMailFriendlyName;\n+\tprivate static final String A_U_D_ISMail = AttributesManager.NS_USER_ATTR_DEF + \":\" + isMailFriendlyName;\n+\tprivate static final String A_U_D_publicAliasMails = AttributesManager.NS_USER_ATTR_DEF + \":\" + publicMailsFriendlyName;\n+\tprivate static final String A_U_D_privateAliasMails = AttributesManager.NS_USER_ATTR_DEF + \":\" + privateMailsFriendlyName;\n+\tprivate static final String A_U_D_o365EmailAddressesMU = AttributesManager.NS_USER_ATTR_DEF + \":\" + o365MailsFriendlyName;\n+\n+\tprivate final static Logger log = LoggerFactory.getLogger(urn_perun_user_attribute_def_virt_tcsMails_mu.class);\n+\n+\t@Override\n+\tpublic Attribute getAttributeValue(PerunSessionImpl sess, User user, AttributeDefinition attributeDefinition) throws InternalErrorException {", "originalCommit": "ac1c312fe445c2cac297d13a435d62e61270defd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDc5MjQxMQ==", "url": "https://github.com/CESNET/perun/pull/2686#discussion_r420792411", "bodyText": "Fixed.", "author": "stavamichal", "createdAt": "2020-05-06T13:32:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDA4MDUxOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDA5NDAyNw==", "url": "https://github.com/CESNET/perun/pull/2686#discussion_r420094027", "bodyText": "Exceptions WrongReferenceAttributeValueException and WrongAttributeAssignmentException are not thrown in this method.", "author": "balcirakpeter", "createdAt": "2020-05-05T13:07:55Z", "path": "perun-core/src/main/java/cz/metacentrum/perun/core/impl/modules/attributes/urn_perun_user_attribute_def_virt_tcsMails_mu.java", "diffHunk": "@@ -0,0 +1,162 @@\n+package cz.metacentrum.perun.core.impl.modules.attributes;\n+\n+import cz.metacentrum.perun.audit.events.AttributesManagerEvents.AllAttributesRemovedForUser;\n+import cz.metacentrum.perun.audit.events.AttributesManagerEvents.AttributeChangedForUser;\n+import cz.metacentrum.perun.audit.events.AttributesManagerEvents.AttributeRemovedForUser;\n+import cz.metacentrum.perun.audit.events.AttributesManagerEvents.AttributeSetForUser;\n+import cz.metacentrum.perun.audit.events.AuditEvent;\n+import cz.metacentrum.perun.core.api.Attribute;\n+import cz.metacentrum.perun.core.api.AttributeDefinition;\n+import cz.metacentrum.perun.core.api.AttributesManager;\n+import cz.metacentrum.perun.core.api.User;\n+import cz.metacentrum.perun.core.api.exceptions.AttributeNotExistsException;\n+import cz.metacentrum.perun.core.api.exceptions.InternalErrorException;\n+import cz.metacentrum.perun.core.api.exceptions.WrongAttributeAssignmentException;\n+import cz.metacentrum.perun.core.api.exceptions.WrongReferenceAttributeValueException;\n+import cz.metacentrum.perun.core.impl.PerunSessionImpl;\n+import cz.metacentrum.perun.core.implApi.modules.attributes.SkipValueCheckDuringDependencyCheck;\n+import cz.metacentrum.perun.core.implApi.modules.attributes.UserVirtualAttributesModuleAbstract;\n+import cz.metacentrum.perun.core.implApi.modules.attributes.UserVirtualAttributesModuleImplApi;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.SortedSet;\n+import java.util.TreeSet;\n+\n+/**\n+ * Get all emails from Perun for purpose of TCS.\n+ *\n+ * @author Michal Stava stavamichal@gmail.com\n+ */\n+@SkipValueCheckDuringDependencyCheck\n+public class urn_perun_user_attribute_def_virt_tcsMails_mu extends UserVirtualAttributesModuleAbstract implements UserVirtualAttributesModuleImplApi {\n+\n+\tprivate static final String preferredMailFriendlyName = \"preferredMail\";\n+\tprivate static final String isMailFriendlyName = \"ISMail\";\n+\tprivate static final String publicMailsFriendlyName = \"publicAliasMails\";\n+\tprivate static final String privateMailsFriendlyName = \"privateAliasMails\";\n+\tprivate static final String o365MailsFriendlyName = \"o365EmailAddresses:mu\";\n+\n+\tprivate static final String A_U_D_preferredMail = AttributesManager.NS_USER_ATTR_DEF + \":\" + preferredMailFriendlyName;\n+\tprivate static final String A_U_D_ISMail = AttributesManager.NS_USER_ATTR_DEF + \":\" + isMailFriendlyName;\n+\tprivate static final String A_U_D_publicAliasMails = AttributesManager.NS_USER_ATTR_DEF + \":\" + publicMailsFriendlyName;\n+\tprivate static final String A_U_D_privateAliasMails = AttributesManager.NS_USER_ATTR_DEF + \":\" + privateMailsFriendlyName;\n+\tprivate static final String A_U_D_o365EmailAddressesMU = AttributesManager.NS_USER_ATTR_DEF + \":\" + o365MailsFriendlyName;\n+\n+\tprivate final static Logger log = LoggerFactory.getLogger(urn_perun_user_attribute_def_virt_tcsMails_mu.class);\n+\n+\t@Override\n+\tpublic Attribute getAttributeValue(PerunSessionImpl sess, User user, AttributeDefinition attributeDefinition) throws InternalErrorException {\n+\n+\t\tAttribute attribute = new Attribute(attributeDefinition);\n+\t\tSortedSet<String> tcsMailsValue = new TreeSet<>();\n+\n+\t\ttcsMailsValue.addAll(getEmailValues(sess, user, A_U_D_preferredMail));\n+\t\ttcsMailsValue.addAll(getEmailValues(sess, user, A_U_D_ISMail));\n+\t\ttcsMailsValue.addAll(getEmailValues(sess, user, A_U_D_o365EmailAddressesMU));\n+\t\ttcsMailsValue.addAll(getEmailValues(sess, user, A_U_D_publicAliasMails));\n+\t\ttcsMailsValue.addAll(getEmailValues(sess, user, A_U_D_privateAliasMails));\n+\n+\t\tattribute.setValue(new ArrayList(tcsMailsValue));\n+\n+\t\treturn attribute;\n+\t}\n+\n+\t@Override\n+\tpublic List<AuditEvent> resolveVirtualAttributeValueChange(PerunSessionImpl perunSession, AuditEvent message) throws InternalErrorException, WrongReferenceAttributeValueException, AttributeNotExistsException, WrongAttributeAssignmentException {", "originalCommit": "ac1c312fe445c2cac297d13a435d62e61270defd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDc5MjM1NA==", "url": "https://github.com/CESNET/perun/pull/2686#discussion_r420792354", "bodyText": "Removed.", "author": "stavamichal", "createdAt": "2020-05-06T13:32:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDA5NDAyNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDA5OTA5MA==", "url": "https://github.com/CESNET/perun/pull/2686#discussion_r420099090", "bodyText": "Use new ArrayList<>(tcsMailsValue) to prevent Unchecked call warning.", "author": "balcirakpeter", "createdAt": "2020-05-05T13:15:25Z", "path": "perun-core/src/main/java/cz/metacentrum/perun/core/impl/modules/attributes/urn_perun_user_attribute_def_virt_tcsMails_mu.java", "diffHunk": "@@ -0,0 +1,162 @@\n+package cz.metacentrum.perun.core.impl.modules.attributes;\n+\n+import cz.metacentrum.perun.audit.events.AttributesManagerEvents.AllAttributesRemovedForUser;\n+import cz.metacentrum.perun.audit.events.AttributesManagerEvents.AttributeChangedForUser;\n+import cz.metacentrum.perun.audit.events.AttributesManagerEvents.AttributeRemovedForUser;\n+import cz.metacentrum.perun.audit.events.AttributesManagerEvents.AttributeSetForUser;\n+import cz.metacentrum.perun.audit.events.AuditEvent;\n+import cz.metacentrum.perun.core.api.Attribute;\n+import cz.metacentrum.perun.core.api.AttributeDefinition;\n+import cz.metacentrum.perun.core.api.AttributesManager;\n+import cz.metacentrum.perun.core.api.User;\n+import cz.metacentrum.perun.core.api.exceptions.AttributeNotExistsException;\n+import cz.metacentrum.perun.core.api.exceptions.InternalErrorException;\n+import cz.metacentrum.perun.core.api.exceptions.WrongAttributeAssignmentException;\n+import cz.metacentrum.perun.core.api.exceptions.WrongReferenceAttributeValueException;\n+import cz.metacentrum.perun.core.impl.PerunSessionImpl;\n+import cz.metacentrum.perun.core.implApi.modules.attributes.SkipValueCheckDuringDependencyCheck;\n+import cz.metacentrum.perun.core.implApi.modules.attributes.UserVirtualAttributesModuleAbstract;\n+import cz.metacentrum.perun.core.implApi.modules.attributes.UserVirtualAttributesModuleImplApi;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.SortedSet;\n+import java.util.TreeSet;\n+\n+/**\n+ * Get all emails from Perun for purpose of TCS.\n+ *\n+ * @author Michal Stava stavamichal@gmail.com\n+ */\n+@SkipValueCheckDuringDependencyCheck\n+public class urn_perun_user_attribute_def_virt_tcsMails_mu extends UserVirtualAttributesModuleAbstract implements UserVirtualAttributesModuleImplApi {\n+\n+\tprivate static final String preferredMailFriendlyName = \"preferredMail\";\n+\tprivate static final String isMailFriendlyName = \"ISMail\";\n+\tprivate static final String publicMailsFriendlyName = \"publicAliasMails\";\n+\tprivate static final String privateMailsFriendlyName = \"privateAliasMails\";\n+\tprivate static final String o365MailsFriendlyName = \"o365EmailAddresses:mu\";\n+\n+\tprivate static final String A_U_D_preferredMail = AttributesManager.NS_USER_ATTR_DEF + \":\" + preferredMailFriendlyName;\n+\tprivate static final String A_U_D_ISMail = AttributesManager.NS_USER_ATTR_DEF + \":\" + isMailFriendlyName;\n+\tprivate static final String A_U_D_publicAliasMails = AttributesManager.NS_USER_ATTR_DEF + \":\" + publicMailsFriendlyName;\n+\tprivate static final String A_U_D_privateAliasMails = AttributesManager.NS_USER_ATTR_DEF + \":\" + privateMailsFriendlyName;\n+\tprivate static final String A_U_D_o365EmailAddressesMU = AttributesManager.NS_USER_ATTR_DEF + \":\" + o365MailsFriendlyName;\n+\n+\tprivate final static Logger log = LoggerFactory.getLogger(urn_perun_user_attribute_def_virt_tcsMails_mu.class);\n+\n+\t@Override\n+\tpublic Attribute getAttributeValue(PerunSessionImpl sess, User user, AttributeDefinition attributeDefinition) throws InternalErrorException {\n+\n+\t\tAttribute attribute = new Attribute(attributeDefinition);\n+\t\tSortedSet<String> tcsMailsValue = new TreeSet<>();\n+\n+\t\ttcsMailsValue.addAll(getEmailValues(sess, user, A_U_D_preferredMail));\n+\t\ttcsMailsValue.addAll(getEmailValues(sess, user, A_U_D_ISMail));\n+\t\ttcsMailsValue.addAll(getEmailValues(sess, user, A_U_D_o365EmailAddressesMU));\n+\t\ttcsMailsValue.addAll(getEmailValues(sess, user, A_U_D_publicAliasMails));\n+\t\ttcsMailsValue.addAll(getEmailValues(sess, user, A_U_D_privateAliasMails));\n+\n+\t\tattribute.setValue(new ArrayList(tcsMailsValue));", "originalCommit": "ac1c312fe445c2cac297d13a435d62e61270defd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDc5MjI3OQ==", "url": "https://github.com/CESNET/perun/pull/2686#discussion_r420792279", "bodyText": "Changed.", "author": "stavamichal", "createdAt": "2020-05-06T13:32:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDA5OTA5MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDEwNzM1OQ==", "url": "https://github.com/CESNET/perun/pull/2686#discussion_r420107359", "bodyText": "This code is duplicate. Moreover, repeated \"add\" operations are not necessary.\nYou can use something like this:\n\t\treturn Arrays.asList(\n\t\t\tA_U_D_preferredMail, \n\t\t\tA_U_D_ISMail, \n\t\t\tA_U_D_publicAliasMails, \n\t\t\tA_U_D_privateAliasMails, \n\t\t\tA_U_D_o365EmailAddressesMU);", "author": "balcirakpeter", "createdAt": "2020-05-05T13:27:15Z", "path": "perun-core/src/main/java/cz/metacentrum/perun/core/impl/modules/attributes/urn_perun_user_attribute_def_virt_tcsMails_mu.java", "diffHunk": "@@ -0,0 +1,162 @@\n+package cz.metacentrum.perun.core.impl.modules.attributes;\n+\n+import cz.metacentrum.perun.audit.events.AttributesManagerEvents.AllAttributesRemovedForUser;\n+import cz.metacentrum.perun.audit.events.AttributesManagerEvents.AttributeChangedForUser;\n+import cz.metacentrum.perun.audit.events.AttributesManagerEvents.AttributeRemovedForUser;\n+import cz.metacentrum.perun.audit.events.AttributesManagerEvents.AttributeSetForUser;\n+import cz.metacentrum.perun.audit.events.AuditEvent;\n+import cz.metacentrum.perun.core.api.Attribute;\n+import cz.metacentrum.perun.core.api.AttributeDefinition;\n+import cz.metacentrum.perun.core.api.AttributesManager;\n+import cz.metacentrum.perun.core.api.User;\n+import cz.metacentrum.perun.core.api.exceptions.AttributeNotExistsException;\n+import cz.metacentrum.perun.core.api.exceptions.InternalErrorException;\n+import cz.metacentrum.perun.core.api.exceptions.WrongAttributeAssignmentException;\n+import cz.metacentrum.perun.core.api.exceptions.WrongReferenceAttributeValueException;\n+import cz.metacentrum.perun.core.impl.PerunSessionImpl;\n+import cz.metacentrum.perun.core.implApi.modules.attributes.SkipValueCheckDuringDependencyCheck;\n+import cz.metacentrum.perun.core.implApi.modules.attributes.UserVirtualAttributesModuleAbstract;\n+import cz.metacentrum.perun.core.implApi.modules.attributes.UserVirtualAttributesModuleImplApi;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.SortedSet;\n+import java.util.TreeSet;\n+\n+/**\n+ * Get all emails from Perun for purpose of TCS.\n+ *\n+ * @author Michal Stava stavamichal@gmail.com\n+ */\n+@SkipValueCheckDuringDependencyCheck\n+public class urn_perun_user_attribute_def_virt_tcsMails_mu extends UserVirtualAttributesModuleAbstract implements UserVirtualAttributesModuleImplApi {\n+\n+\tprivate static final String preferredMailFriendlyName = \"preferredMail\";\n+\tprivate static final String isMailFriendlyName = \"ISMail\";\n+\tprivate static final String publicMailsFriendlyName = \"publicAliasMails\";\n+\tprivate static final String privateMailsFriendlyName = \"privateAliasMails\";\n+\tprivate static final String o365MailsFriendlyName = \"o365EmailAddresses:mu\";\n+\n+\tprivate static final String A_U_D_preferredMail = AttributesManager.NS_USER_ATTR_DEF + \":\" + preferredMailFriendlyName;\n+\tprivate static final String A_U_D_ISMail = AttributesManager.NS_USER_ATTR_DEF + \":\" + isMailFriendlyName;\n+\tprivate static final String A_U_D_publicAliasMails = AttributesManager.NS_USER_ATTR_DEF + \":\" + publicMailsFriendlyName;\n+\tprivate static final String A_U_D_privateAliasMails = AttributesManager.NS_USER_ATTR_DEF + \":\" + privateMailsFriendlyName;\n+\tprivate static final String A_U_D_o365EmailAddressesMU = AttributesManager.NS_USER_ATTR_DEF + \":\" + o365MailsFriendlyName;\n+\n+\tprivate final static Logger log = LoggerFactory.getLogger(urn_perun_user_attribute_def_virt_tcsMails_mu.class);\n+\n+\t@Override\n+\tpublic Attribute getAttributeValue(PerunSessionImpl sess, User user, AttributeDefinition attributeDefinition) throws InternalErrorException {\n+\n+\t\tAttribute attribute = new Attribute(attributeDefinition);\n+\t\tSortedSet<String> tcsMailsValue = new TreeSet<>();\n+\n+\t\ttcsMailsValue.addAll(getEmailValues(sess, user, A_U_D_preferredMail));\n+\t\ttcsMailsValue.addAll(getEmailValues(sess, user, A_U_D_ISMail));\n+\t\ttcsMailsValue.addAll(getEmailValues(sess, user, A_U_D_o365EmailAddressesMU));\n+\t\ttcsMailsValue.addAll(getEmailValues(sess, user, A_U_D_publicAliasMails));\n+\t\ttcsMailsValue.addAll(getEmailValues(sess, user, A_U_D_privateAliasMails));\n+\n+\t\tattribute.setValue(new ArrayList(tcsMailsValue));\n+\n+\t\treturn attribute;\n+\t}\n+\n+\t@Override\n+\tpublic List<AuditEvent> resolveVirtualAttributeValueChange(PerunSessionImpl perunSession, AuditEvent message) throws InternalErrorException, WrongReferenceAttributeValueException, AttributeNotExistsException, WrongAttributeAssignmentException {\n+\t\tList<AuditEvent> resolvingMessages = new ArrayList<>();\n+\n+\t\t// handle source user attributes changes\n+\t\tif (message instanceof AttributeSetForUser && isAffectedAttribute(((AttributeSetForUser) message).getAttribute().getFriendlyName())) {\n+\t\t\tAttributeDefinition attributeDefinition = perunSession.getPerunBl().getAttributesManagerBl().getAttributeDefinition(perunSession, this.getAttributeDefinition().getName());\n+\t\t\tresolvingMessages.add(new AttributeChangedForUser(new Attribute(attributeDefinition), ((AttributeSetForUser) message).getUser()));\n+\n+\t\t} else if (message instanceof AttributeRemovedForUser && isAffectedAttribute(((AttributeRemovedForUser) message).getAttribute().getFriendlyName())) {\n+\t\t\tAttributeDefinition attributeDefinition = perunSession.getPerunBl().getAttributesManagerBl().getAttributeDefinition(perunSession, this.getAttributeDefinition().getName());\n+\t\t\tresolvingMessages.add(new AttributeChangedForUser(new Attribute(attributeDefinition), ((AttributeRemovedForUser) message).getUser()));\n+\n+\t\t} else if (message instanceof AllAttributesRemovedForUser) {\n+\t\t\tAttributeDefinition attributeDefinition = perunSession.getPerunBl().getAttributesManagerBl().getAttributeDefinition(perunSession, this.getAttributeDefinition().getName());\n+\t\t\tresolvingMessages.add(new AttributeChangedForUser(new Attribute(attributeDefinition), ((AllAttributesRemovedForUser) message).getUser()));\n+\n+\t\t}\n+\n+\t\treturn resolvingMessages;\n+\t}\n+\n+\t/**\n+\t * Return true if attribute name is one of affected attributes in this virtual module.\n+\t *\n+\t * @param nameOfAttribute name of attribute to check\n+\t * @return true if attribute is one of affected, false otherwise\n+\t */\n+\tprivate boolean isAffectedAttribute(String nameOfAttribute) {\n+\t\tif(preferredMailFriendlyName.equals(nameOfAttribute)) return true;\n+\t\telse if(isMailFriendlyName.equals(nameOfAttribute)) return true;\n+\t\telse if(o365MailsFriendlyName.equals(nameOfAttribute)) return true;\n+\t\telse if(publicMailsFriendlyName.equals(nameOfAttribute)) return true;\n+\t\telse if(privateMailsFriendlyName.equals(nameOfAttribute)) return true;\n+\n+\t\treturn false;\n+\t}\n+\n+\t/**\n+\t * Return email values as sorted set from attribute by name.\n+\t *\n+\t * It works only for String and List attributes. If attribute has different type of value, it will be logged and skipped.\n+\t * If attribute has empty value, it will return empty set.\n+\t * If attribute not exists, it will be logged and skipped.\n+\t *\n+\t * @param sess perun session\n+\t * @param user user to get values for\n+\t * @param nameOfAttribute name of attribute for which values should be returned\n+\t *\n+\t * @return sorted set of values of attribute defined by name\n+\t */\n+\tprivate SortedSet<String> getEmailValues(PerunSessionImpl sess, User user, String nameOfAttribute) {\n+\t\tSortedSet<String> valuesToAdd = new TreeSet<>();\n+\t\ttry {\n+\t\t\tAttribute sourceAttribute = sess.getPerunBl().getAttributesManagerBl().getAttribute(sess, user, nameOfAttribute);\n+\t\t\tif (sourceAttribute.getType().equals(String.class.getName())) {\n+\t\t\t\tif (sourceAttribute.getValue() != null) valuesToAdd.add(sourceAttribute.valueAsString());\n+\t\t\t} else if (sourceAttribute.getType().equals(ArrayList.class.getName())) {\n+\t\t\t\tif (sourceAttribute.getValue() != null) valuesToAdd.addAll(sourceAttribute.valueAsList());\n+\t\t\t} else {\n+\t\t\t\t//unexpected type of value, log it and skip the attribute\n+\t\t\t\tlog.error(\"Unexpected type of attribute (should be String or ArrayList) {}. It will be skipped.\", sourceAttribute);\n+\t\t\t}\n+\t\t} catch (AttributeNotExistsException ex) {\n+\t\t\t//we can log this situation and skip the attribute from computing\n+\t\t\tlog.warn(\"When counting value of attribute {} we are missing source attribute {}. Exception: {}. It will be skipped.\", this.getAttributeDefinition(), nameOfAttribute, ex);\n+\t\t} catch (WrongAttributeAssignmentException ex) {\n+\t\t\tthrow new InternalErrorException(ex);\n+\t\t}\n+\n+\t\treturn valuesToAdd;\n+\t}\n+\n+\t@Override\n+\tpublic List<String> getStrongDependencies() {\n+\t\tList<String> strongDependencies = new ArrayList<>();\n+\t\tstrongDependencies.add(A_U_D_preferredMail);", "originalCommit": "ac1c312fe445c2cac297d13a435d62e61270defd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDc5MjIzNw==", "url": "https://github.com/CESNET/perun/pull/2686#discussion_r420792237", "bodyText": "Changed.", "author": "stavamichal", "createdAt": "2020-05-06T13:32:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDEwNzM1OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDEwODgyMg==", "url": "https://github.com/CESNET/perun/pull/2686#discussion_r420108822", "bodyText": "You can change the last \"else if\" to:\nreturn (privateMailsFriendlyName.equals(nameOfAttribute));\n\nTherefore, you do not have to have that extra code at the end of the method.", "author": "balcirakpeter", "createdAt": "2020-05-05T13:29:15Z", "path": "perun-core/src/main/java/cz/metacentrum/perun/core/impl/modules/attributes/urn_perun_user_attribute_def_virt_tcsMails_mu.java", "diffHunk": "@@ -0,0 +1,162 @@\n+package cz.metacentrum.perun.core.impl.modules.attributes;\n+\n+import cz.metacentrum.perun.audit.events.AttributesManagerEvents.AllAttributesRemovedForUser;\n+import cz.metacentrum.perun.audit.events.AttributesManagerEvents.AttributeChangedForUser;\n+import cz.metacentrum.perun.audit.events.AttributesManagerEvents.AttributeRemovedForUser;\n+import cz.metacentrum.perun.audit.events.AttributesManagerEvents.AttributeSetForUser;\n+import cz.metacentrum.perun.audit.events.AuditEvent;\n+import cz.metacentrum.perun.core.api.Attribute;\n+import cz.metacentrum.perun.core.api.AttributeDefinition;\n+import cz.metacentrum.perun.core.api.AttributesManager;\n+import cz.metacentrum.perun.core.api.User;\n+import cz.metacentrum.perun.core.api.exceptions.AttributeNotExistsException;\n+import cz.metacentrum.perun.core.api.exceptions.InternalErrorException;\n+import cz.metacentrum.perun.core.api.exceptions.WrongAttributeAssignmentException;\n+import cz.metacentrum.perun.core.api.exceptions.WrongReferenceAttributeValueException;\n+import cz.metacentrum.perun.core.impl.PerunSessionImpl;\n+import cz.metacentrum.perun.core.implApi.modules.attributes.SkipValueCheckDuringDependencyCheck;\n+import cz.metacentrum.perun.core.implApi.modules.attributes.UserVirtualAttributesModuleAbstract;\n+import cz.metacentrum.perun.core.implApi.modules.attributes.UserVirtualAttributesModuleImplApi;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.SortedSet;\n+import java.util.TreeSet;\n+\n+/**\n+ * Get all emails from Perun for purpose of TCS.\n+ *\n+ * @author Michal Stava stavamichal@gmail.com\n+ */\n+@SkipValueCheckDuringDependencyCheck\n+public class urn_perun_user_attribute_def_virt_tcsMails_mu extends UserVirtualAttributesModuleAbstract implements UserVirtualAttributesModuleImplApi {\n+\n+\tprivate static final String preferredMailFriendlyName = \"preferredMail\";\n+\tprivate static final String isMailFriendlyName = \"ISMail\";\n+\tprivate static final String publicMailsFriendlyName = \"publicAliasMails\";\n+\tprivate static final String privateMailsFriendlyName = \"privateAliasMails\";\n+\tprivate static final String o365MailsFriendlyName = \"o365EmailAddresses:mu\";\n+\n+\tprivate static final String A_U_D_preferredMail = AttributesManager.NS_USER_ATTR_DEF + \":\" + preferredMailFriendlyName;\n+\tprivate static final String A_U_D_ISMail = AttributesManager.NS_USER_ATTR_DEF + \":\" + isMailFriendlyName;\n+\tprivate static final String A_U_D_publicAliasMails = AttributesManager.NS_USER_ATTR_DEF + \":\" + publicMailsFriendlyName;\n+\tprivate static final String A_U_D_privateAliasMails = AttributesManager.NS_USER_ATTR_DEF + \":\" + privateMailsFriendlyName;\n+\tprivate static final String A_U_D_o365EmailAddressesMU = AttributesManager.NS_USER_ATTR_DEF + \":\" + o365MailsFriendlyName;\n+\n+\tprivate final static Logger log = LoggerFactory.getLogger(urn_perun_user_attribute_def_virt_tcsMails_mu.class);\n+\n+\t@Override\n+\tpublic Attribute getAttributeValue(PerunSessionImpl sess, User user, AttributeDefinition attributeDefinition) throws InternalErrorException {\n+\n+\t\tAttribute attribute = new Attribute(attributeDefinition);\n+\t\tSortedSet<String> tcsMailsValue = new TreeSet<>();\n+\n+\t\ttcsMailsValue.addAll(getEmailValues(sess, user, A_U_D_preferredMail));\n+\t\ttcsMailsValue.addAll(getEmailValues(sess, user, A_U_D_ISMail));\n+\t\ttcsMailsValue.addAll(getEmailValues(sess, user, A_U_D_o365EmailAddressesMU));\n+\t\ttcsMailsValue.addAll(getEmailValues(sess, user, A_U_D_publicAliasMails));\n+\t\ttcsMailsValue.addAll(getEmailValues(sess, user, A_U_D_privateAliasMails));\n+\n+\t\tattribute.setValue(new ArrayList(tcsMailsValue));\n+\n+\t\treturn attribute;\n+\t}\n+\n+\t@Override\n+\tpublic List<AuditEvent> resolveVirtualAttributeValueChange(PerunSessionImpl perunSession, AuditEvent message) throws InternalErrorException, WrongReferenceAttributeValueException, AttributeNotExistsException, WrongAttributeAssignmentException {\n+\t\tList<AuditEvent> resolvingMessages = new ArrayList<>();\n+\n+\t\t// handle source user attributes changes\n+\t\tif (message instanceof AttributeSetForUser && isAffectedAttribute(((AttributeSetForUser) message).getAttribute().getFriendlyName())) {\n+\t\t\tAttributeDefinition attributeDefinition = perunSession.getPerunBl().getAttributesManagerBl().getAttributeDefinition(perunSession, this.getAttributeDefinition().getName());\n+\t\t\tresolvingMessages.add(new AttributeChangedForUser(new Attribute(attributeDefinition), ((AttributeSetForUser) message).getUser()));\n+\n+\t\t} else if (message instanceof AttributeRemovedForUser && isAffectedAttribute(((AttributeRemovedForUser) message).getAttribute().getFriendlyName())) {\n+\t\t\tAttributeDefinition attributeDefinition = perunSession.getPerunBl().getAttributesManagerBl().getAttributeDefinition(perunSession, this.getAttributeDefinition().getName());\n+\t\t\tresolvingMessages.add(new AttributeChangedForUser(new Attribute(attributeDefinition), ((AttributeRemovedForUser) message).getUser()));\n+\n+\t\t} else if (message instanceof AllAttributesRemovedForUser) {\n+\t\t\tAttributeDefinition attributeDefinition = perunSession.getPerunBl().getAttributesManagerBl().getAttributeDefinition(perunSession, this.getAttributeDefinition().getName());\n+\t\t\tresolvingMessages.add(new AttributeChangedForUser(new Attribute(attributeDefinition), ((AllAttributesRemovedForUser) message).getUser()));\n+\n+\t\t}\n+\n+\t\treturn resolvingMessages;\n+\t}\n+\n+\t/**\n+\t * Return true if attribute name is one of affected attributes in this virtual module.\n+\t *\n+\t * @param nameOfAttribute name of attribute to check\n+\t * @return true if attribute is one of affected, false otherwise\n+\t */\n+\tprivate boolean isAffectedAttribute(String nameOfAttribute) {\n+\t\tif(preferredMailFriendlyName.equals(nameOfAttribute)) return true;\n+\t\telse if(isMailFriendlyName.equals(nameOfAttribute)) return true;\n+\t\telse if(o365MailsFriendlyName.equals(nameOfAttribute)) return true;\n+\t\telse if(publicMailsFriendlyName.equals(nameOfAttribute)) return true;\n+\t\telse if(privateMailsFriendlyName.equals(nameOfAttribute)) return true;", "originalCommit": "ac1c312fe445c2cac297d13a435d62e61270defd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDc5MjIwMg==", "url": "https://github.com/CESNET/perun/pull/2686#discussion_r420792202", "bodyText": "I don't think it is necessary and it is easier to read the simple version than the shorter one.", "author": "stavamichal", "createdAt": "2020-05-06T13:32:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDEwODgyMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTI4NTIxMA==", "url": "https://github.com/CESNET/perun/pull/2686#discussion_r421285210", "bodyText": "Ok :)", "author": "balcirakpeter", "createdAt": "2020-05-07T07:09:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDEwODgyMg=="}], "type": "inlineReview"}, {"oid": "95b7430e08f263b93b4313059ce09d3772435815", "url": "https://github.com/CESNET/perun/commit/95b7430e08f263b93b4313059ce09d3772435815", "message": "New module for user virt attribute tcsMails\n\n - it will compute values from different email attributes (affected) to one.\n This value then will be used for purpose of TCS\n - it also reacts on messages with changes in affected attributes\n - tests for modules were added", "committedDate": "2020-05-06T13:31:45Z", "type": "commit"}, {"oid": "95b7430e08f263b93b4313059ce09d3772435815", "url": "https://github.com/CESNET/perun/commit/95b7430e08f263b93b4313059ce09d3772435815", "message": "New module for user virt attribute tcsMails\n\n - it will compute values from different email attributes (affected) to one.\n This value then will be used for purpose of TCS\n - it also reacts on messages with changes in affected attributes\n - tests for modules were added", "committedDate": "2020-05-06T13:31:45Z", "type": "forcePushed"}]}