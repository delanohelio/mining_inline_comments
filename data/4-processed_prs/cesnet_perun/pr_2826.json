{"pr_number": 2826, "pr_title": "Change of lightweightSynchronization to not add members not in Perun", "pr_createdAt": "2020-07-30T10:43:07Z", "pr_url": "https://github.com/CESNET/perun/pull/2826", "timeline": [{"oid": "d1def4ae4788e8aa6aa0255a781e1b0ad3feaa1a", "url": "https://github.com/CESNET/perun/commit/d1def4ae4788e8aa6aa0255a781e1b0ad3feaa1a", "message": "Change of lightweightSynchronization to not add members not in Perun\n\n- now if synchronization is lightweight, it does not add new members unless they are already in Perun, instead it just skips them and logs them\n- change also reflected in javadoc", "committedDate": "2020-07-30T10:41:51Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjkyMzU1NA==", "url": "https://github.com/CESNET/perun/pull/2826#discussion_r462923554", "bodyText": "Add also information about group (for which synchronization was running).", "author": "stavamichal", "createdAt": "2020-07-30T11:11:55Z", "path": "perun-core/src/main/java/cz/metacentrum/perun/core/blImpl/GroupsManagerBlImpl.java", "diffHunk": "@@ -2926,19 +2926,14 @@ private void categorizeMembersForLightweightSynchronization(PerunSession sess, G\n \t\t\t\t}\n \t\t\t}\n \n+\t\t\t// If user not found in perun, skip him and log it\n \t\t\tif (user == null) {\n-\t\t\t\t//If not find, get more information about him from member extSource\n-\t\t\t\tList<Map<String, String>> subjectToConvert = Collections.singletonList(subjectFromLoginSource);\n-\t\t\t\tList<Candidate> convertedCandidatesList = convertSubjectsToCandidates(sess, subjectToConvert, memberSource, loginSource, groupMembers, skippedMembers);\n-\t\t\t\t//Empty means not found (skipped)\n-\t\t\t\tif(!convertedCandidatesList.isEmpty()) {\n-\t\t\t\t\t//We add one subject so we take the one converted candidate\n-\t\t\t\t\tcandidate = convertedCandidatesList.get(0);\n-\t\t\t\t}\n+\t\t\t\tlog.debug(\"Subject {} with login {} was skipped during lightweight synchronization because he is not in perun yet.\", subjectFromLoginSource, login);", "originalCommit": "d1def4ae4788e8aa6aa0255a781e1b0ad3feaa1a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDk0MzcwOQ==", "url": "https://github.com/CESNET/perun/pull/2826#discussion_r464943709", "bodyText": "Added.", "author": "metodej", "createdAt": "2020-08-04T10:07:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjkyMzU1NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mjk5NjYyMg==", "url": "https://github.com/CESNET/perun/pull/2826#discussion_r462996622", "bodyText": "This is now much harder to read so we probably need to change the code a little.\nI would suggest defining all possible situations we can reach:\n\nThe user was found by extSource or additional user extSource => user is not null, need to process more\nThe user wasn't found => user is null, the situation will be logged and skipped\n\nAnd you can say that there are only 2 possible ways how to process the situation 1:\n\nthe user is already a member of the group =>just revalidate him if possible and remove him from the list idsOfUsersInGroup\nthe user is not yet a member of the group => create a candidate, add him to candidatesToAdd\n\nWhat do you think? In my opinion, this way it will be much easier for reading.", "author": "stavamichal", "createdAt": "2020-07-30T13:29:59Z", "path": "perun-core/src/main/java/cz/metacentrum/perun/core/blImpl/GroupsManagerBlImpl.java", "diffHunk": "@@ -2951,11 +2946,8 @@ private void categorizeMembersForLightweightSynchronization(PerunSession sess, G\n \t\t\t\t\t\t}\n \t\t\t\t}\n \t\t\t\tidsOfUsersInGroup.remove(user.getId());\n-\t\t\t} else if (candidate != null) {\n-\t\t\t\tcandidatesToAdd.add(candidate);\n \t\t\t} else {\n-\t\t\t\t//Both null means that we can't find subject by login in extSource at all (will be in skipped members)\n-\t\t\t\tlog.debug(\"Subject with login {} was skipped because can't be found in extSource {}.\", login, memberSource);\n+\t\t\t\tcandidatesToAdd.add(candidate);\n \t\t\t}", "originalCommit": "d1def4ae4788e8aa6aa0255a781e1b0ad3feaa1a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzAyMDQ4NA==", "url": "https://github.com/CESNET/perun/pull/2826#discussion_r463020484", "bodyText": "I agree that the current state is difficult to understand, the suggested change looks good.", "author": "balcirakpeter", "createdAt": "2020-07-30T14:04:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mjk5NjYyMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDk0MzkwOQ==", "url": "https://github.com/CESNET/perun/pull/2826#discussion_r464943909", "bodyText": "I hope it's better now.", "author": "metodej", "createdAt": "2020-08-04T10:07:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mjk5NjYyMg=="}], "type": "inlineReview"}, {"oid": "02b9fd117b17f3d870e566a2f4221a4fa1c259a9", "url": "https://github.com/CESNET/perun/commit/02b9fd117b17f3d870e566a2f4221a4fa1c259a9", "message": "Fixes based of review\n\n- categorizeMembersForLightweightSynchronization was restructured for better readibility\n- lightweight synchronization adds new members only if they are already in vo of the group, otherwise skips and logs them\n- also updated javadoc of the method", "committedDate": "2020-08-04T10:05:00Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTU0MzQ3MA==", "url": "https://github.com/CESNET/perun/pull/2826#discussion_r465543470", "bodyText": "Call users manager in Bl instead in Entry. This will prevent throwing a privilege exception.", "author": "stavamichal", "createdAt": "2020-08-05T07:57:19Z", "path": "perun-core/src/main/java/cz/metacentrum/perun/core/blImpl/GroupsManagerBlImpl.java", "diffHunk": "@@ -2910,52 +2909,45 @@ private void categorizeMembersForLightweightSynchronization(PerunSession sess, G\n \t\t\t} catch (UserExtSourceNotExistsException e) {\n \t\t\t\t//skipping, this extSource does not exist and thus won't be in the list\n \t\t\t}\n+\t\t\tVo groupVo = getVo(sess, group);\n \t\t\tList<UserExtSource> additionalUserExtSources = Utils.extractAdditionalUserExtSources(sess, subjectFromLoginSource);\n \t\t\tuserExtSources.addAll(additionalUserExtSources);\n \t\t\tfor (UserExtSource source : userExtSources) {\n \t\t\t\ttry {\n \t\t\t\t\tuser = getPerunBl().getUsersManagerBl().getUserByUserExtSource(sess, source);\n-\t\t\t\t\tif(!idsOfUsersInGroup.containsKey(user.getId())) {\n-\t\t\t\t\t\tcandidate = new Candidate(user, source);\n-\t\t\t\t\t\t//for lightweight synchronization we want to skip all update of attributes\n-\t\t\t\t\t\tcandidate.setAttributes(new HashMap<>());\n+\t\t\t\t\t// check if user is already member of group's vo\n+\t\t\t\t\tif (sess.getPerun().getUsersManager().getVosWhereUserIsMember(sess, user).contains(groupVo)) {", "originalCommit": "02b9fd117b17f3d870e566a2f4221a4fa1c259a9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTU5OTE4NA==", "url": "https://github.com/CESNET/perun/pull/2826#discussion_r465599184", "bodyText": "Fixed.", "author": "metodej", "createdAt": "2020-08-05T09:34:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTU0MzQ3MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTU0Mzc3NA==", "url": "https://github.com/CESNET/perun/pull/2826#discussion_r465543774", "bodyText": "This is definitely not needed, privilege exception is wrong in Bl layer.", "author": "stavamichal", "createdAt": "2020-08-05T07:57:53Z", "path": "perun-core/src/main/java/cz/metacentrum/perun/core/blImpl/GroupsManagerBlImpl.java", "diffHunk": "@@ -2910,52 +2909,45 @@ private void categorizeMembersForLightweightSynchronization(PerunSession sess, G\n \t\t\t} catch (UserExtSourceNotExistsException e) {\n \t\t\t\t//skipping, this extSource does not exist and thus won't be in the list\n \t\t\t}\n+\t\t\tVo groupVo = getVo(sess, group);\n \t\t\tList<UserExtSource> additionalUserExtSources = Utils.extractAdditionalUserExtSources(sess, subjectFromLoginSource);\n \t\t\tuserExtSources.addAll(additionalUserExtSources);\n \t\t\tfor (UserExtSource source : userExtSources) {\n \t\t\t\ttry {\n \t\t\t\t\tuser = getPerunBl().getUsersManagerBl().getUserByUserExtSource(sess, source);\n-\t\t\t\t\tif(!idsOfUsersInGroup.containsKey(user.getId())) {\n-\t\t\t\t\t\tcandidate = new Candidate(user, source);\n-\t\t\t\t\t\t//for lightweight synchronization we want to skip all update of attributes\n-\t\t\t\t\t\tcandidate.setAttributes(new HashMap<>());\n+\t\t\t\t\t// check if user is already member of group's vo\n+\t\t\t\t\tif (sess.getPerun().getUsersManager().getVosWhereUserIsMember(sess, user).contains(groupVo)) {\n+\t\t\t\t\t\tif (idsOfUsersInGroup.containsKey(user.getId())) {\n+\t\t\t\t\t\t\t//we can skip this one, because he is already in group, and remove him from the map\n+\t\t\t\t\t\t\t//but first we need to also validate him if he was disabled before (invalidate and then validate)\n+\t\t\t\t\t\t\tRichMember richMember = idsOfUsersInGroup.get(user.getId());\n+\t\t\t\t\t\t\tif (richMember != null && Status.DISABLED.equals(richMember.getStatus())) {\n+\t\t\t\t\t\t\t\tgetPerunBl().getMembersManagerBl().invalidateMember(sess, richMember);\n+\t\t\t\t\t\t\t\ttry {\n+\t\t\t\t\t\t\t\t\tgetPerunBl().getMembersManagerBl().validateMember(sess, richMember);\n+\t\t\t\t\t\t\t\t} catch (WrongAttributeValueException | WrongReferenceAttributeValueException e) {\n+\t\t\t\t\t\t\t\t\tlog.info(\"Switching member id {} into INVALID state from DISABLED, because there was problem with attributes {}.\", richMember.getId(), e);\n+\t\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t\tidsOfUsersInGroup.remove(user.getId());\n+\t\t\t\t\t\t} else {\n+\t\t\t\t\t\t\t//he is not yet in group, so we need to create a candidate\n+\t\t\t\t\t\t\tCandidate candidate = new Candidate(user, source);\n+\t\t\t\t\t\t\t//for lightweight synchronization we want to skip all update of attributes\n+\t\t\t\t\t\t\tcandidate.setAttributes(new HashMap<>());\n+\t\t\t\t\t\t\tcandidatesToAdd.add(candidate);\n+\t\t\t\t\t\t}\n+\t\t\t\t\t\tbreak;\n \t\t\t\t\t}\n-\t\t\t\t\tbreak;\n-\t\t\t\t} catch(UserNotExistsException e) {\n+\t\t\t\t} catch(UserNotExistsException | PrivilegeException e) {\n \t\t\t\t\t//skip because the user from this ExtSource does not exist so we can continue\n+\t\t\t\t\t//skip because we do not have privilege to get vos of this user", "originalCommit": "02b9fd117b17f3d870e566a2f4221a4fa1c259a9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTU5OTI1NA==", "url": "https://github.com/CESNET/perun/pull/2826#discussion_r465599254", "bodyText": "Removed.", "author": "metodej", "createdAt": "2020-08-05T09:34:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTU0Mzc3NA=="}], "type": "inlineReview"}, {"oid": "8389f51cf70a522ef0a277016efd8e8fa9650610", "url": "https://github.com/CESNET/perun/commit/8389f51cf70a522ef0a277016efd8e8fa9650610", "message": "Fixes based on review\n\n- fixed call of userManager in categorizeMembersForLightweightSynchronization to use Bl layer instead of entry", "committedDate": "2020-08-05T09:28:52Z", "type": "commit"}]}