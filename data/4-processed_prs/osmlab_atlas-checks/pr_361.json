{"pr_number": 361, "pr_title": "CheckFlag Fix Suggestions", "pr_createdAt": "2020-09-16T22:38:27Z", "pr_url": "https://github.com/osmlab/atlas-checks/pull/361", "timeline": [{"oid": "d14753ddb614c57621993c7232c212debcad4444", "url": "https://github.com/osmlab/atlas-checks/commit/d14753ddb614c57621993c7232c212debcad4444", "message": "fix suggestions", "committedDate": "2020-09-16T21:44:30Z", "type": "commit"}, {"oid": "b039b39a1e4a6204bceebc573342abf86e82e931", "url": "https://github.com/osmlab/atlas-checks/commit/b039b39a1e4a6204bceebc573342abf86e82e931", "message": "fix tag", "committedDate": "2020-09-16T22:25:05Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjIyMzcxMw==", "url": "https://github.com/osmlab/atlas-checks/pull/361#discussion_r492223713", "bodyText": "This can be a constant", "author": "danielduhh", "createdAt": "2020-09-21T17:20:35Z", "path": "src/main/java/org/openstreetmap/atlas/checks/event/CheckFlagEvent.java", "diffHunk": "@@ -149,6 +151,7 @@ else if (flaggedRelations.size() != 1 && !feature.has(GEOMETRY))\n         flagProperties.add(\"feature_osmids\", uniqueFeatureOsmIds);\n         flagProperties.addProperty(\"feature_count\", featureProperties.size());\n         flagProperties.add(IDENTIFIERS, GSON.toJsonTree(flag.getUniqueIdentifiers()));\n+        flagProperties.add(\"fix_suggestions\", getFixSuggestionDescriptions(flag));", "originalCommit": "b039b39a1e4a6204bceebc573342abf86e82e931", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjIyNzU0NA==", "url": "https://github.com/osmlab/atlas-checks/pull/361#discussion_r492227544", "bodyText": "Would this make more sense as a json array?\nfix_suggestions: [\n {\n  identifier: \"Edge1212121\",\n  type: \"update\",\n  descriptors: []\n\n }\n]\n\nAlso, should we add the osm id here as well for ease of access?", "author": "danielduhh", "createdAt": "2020-09-21T17:27:04Z", "path": "src/main/java/org/openstreetmap/atlas/checks/event/CheckFlagEvent.java", "diffHunk": "@@ -235,6 +242,17 @@ public static JsonObject flagToJson(final CheckFlag flag,\n                 .map(tag -> String.format(\"%s=%s\", HighwayTag.KEY, tag.getTagValue()));\n     }\n \n+    private static JsonObject getFixSuggestionDescriptions(final CheckFlag flag)\n+    {\n+        final JsonObject fixSuggestionObject = new JsonObject();", "originalCommit": "b039b39a1e4a6204bceebc573342abf86e82e931", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mjg3NDgwNA==", "url": "https://github.com/osmlab/atlas-checks/pull/361#discussion_r492874804", "bodyText": "I thought it might be more convenient as an object, so that it would be easy to look up suggestions for the flagged object and you can still easily loop through it.\nAs for the OSM ID, we could add it if it seems like that would really be helpful. However, it is quite a simple calculation to get it from the Atlas ID, and realistically it should exist in the properties of one of the flagged objects.", "author": "Bentleysb", "createdAt": "2020-09-22T16:29:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjIyNzU0NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzAyNzYwMw==", "url": "https://github.com/osmlab/atlas-checks/pull/361#discussion_r493027603", "bodyText": "Yeah, I can see how that would be helpful for looks ups. My only concern is that it wouldn't follow the convention for all other collection type objects we store in JSON.\nAlso.. I think it would be useful if he added it to the \"properties\", since we're already use that object for parsing other metadata", "author": "danielduhh", "createdAt": "2020-09-22T20:54:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjIyNzU0NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzcyMTk3OQ==", "url": "https://github.com/osmlab/atlas-checks/pull/361#discussion_r493721979", "bodyText": "I would argue we don't have much of a convention for storing collections in JSON. The only other things we store are the Atlas Objects and the flag properties. The Atlas Objects have to be in GeoJson convention. The properties we keep in as JSON objects as it fits well with the data being named fields in the flag. An important part of the suggestions is being able to pair them with a flagged object by the atlas id and item type, so I think it makes sense to gave it in an object with that identifier as the key. It also as close as you can get to a set in JSON because duplicate keys are not allowed.\nI did think about adding it to the properties, but thought it was distinct enough from the flag meta data. I also thought it might be easy for human reading if it was separate and not bloating the properties. However, I don't think this is a big deal either way, and in fact the geojson output has it in the feature properties. So if that is the place we think it fits best then I am happy to move it.", "author": "Bentleysb", "createdAt": "2020-09-23T16:18:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjIyNzU0NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzcyNDY2Ng==", "url": "https://github.com/osmlab/atlas-checks/pull/361#discussion_r493724666", "bodyText": "One other option I considered was requiring a suggestion to have an associated flagged object and placing the suggestion in the features properties. This approach does not require the extra identifier, as it is already in the feature properties. I did not go with this because I wanted to keep the suggestions unrestricted for now, and I though it may cause issues with how we currently use the feature properties in post processing tools.", "author": "Bentleysb", "createdAt": "2020-09-23T16:22:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjIyNzU0NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzg1NzU1Ng==", "url": "https://github.com/osmlab/atlas-checks/pull/361#discussion_r493857556", "bodyText": "In the case where we have a flag holding multiple osm objects (e.g. way 1, way 2.... picked up by a walker) wouldn't we want some sort of separation for the fix suggestions, as they only apply to distinct objects? Maybe an array might work better in this case, or some sort of suggestion merging during flag deduplication. Or your last idea might address this", "author": "seancoulter", "createdAt": "2020-09-23T19:55:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjIyNzU0NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzg2MjMyMg==", "url": "https://github.com/osmlab/atlas-checks/pull/361#discussion_r493862322", "bodyText": "@seancoulter, this is exactly the case in the AreasWithHighwayTagCheck example included with this PR. My thought was that as we are flagging each edge we should have a suggestion for each edge, marked by the atlas ID. We are planning on handling the merging of the edges back into a way as part of the deserialization and MR upload process.", "author": "Bentleysb", "createdAt": "2020-09-23T20:04:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjIyNzU0NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzg2ODc0Mw==", "url": "https://github.com/osmlab/atlas-checks/pull/361#discussion_r493868743", "bodyText": "Nice, sounds good", "author": "seancoulter", "createdAt": "2020-09-23T20:16:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjIyNzU0NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjIyODc1Mg==", "url": "https://github.com/osmlab/atlas-checks/pull/361#discussion_r492228752", "bodyText": "Should we also add constructors for creating a CheckFlag without Locations?", "author": "danielduhh", "createdAt": "2020-09-21T17:29:05Z", "path": "src/main/java/org/openstreetmap/atlas/checks/flag/CheckFlag.java", "diffHunk": "@@ -105,11 +109,65 @@ public CheckFlag(final String identifier, final Set<? extends AtlasObject> objec\n      */\n     public CheckFlag(final String identifier, final Set<? extends AtlasObject> objects,\n             final List<String> instructions, final List<Location> points)\n+    {\n+        this(identifier, objects, instructions, points, new HashSet<>());\n+    }\n+\n+    /**\n+     * Creates a {@link CheckFlag} with the addition of a list of {@code point} {@link Location}s\n+     * that highlight specific points in the geometry that caused the rule violation\n+     *\n+     * @param identifier\n+     *            the identifying value to flag\n+     * @param objects\n+     *            {@link AtlasObject}s to flag\n+     * @param instructions\n+     *            a list of free form instructions\n+     * @param points\n+     *            {@code point} {@link Location}s to highlight\n+     * @param fixSuggestions\n+     *            {@link Set} of {@link FeatureChange}s representing suggested fixes for flagged\n+     *            features\n+     */\n+    public CheckFlag(final String identifier, final Set<? extends AtlasObject> objects,", "originalCommit": "b039b39a1e4a6204bceebc573342abf86e82e931", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mjg3NzY1Mg==", "url": "https://github.com/osmlab/atlas-checks/pull/361#discussion_r492877652", "bodyText": "I wanted to avoid adding constructors and instead use setters for this, as we already have a lot of CheckFlag constructors and methods that call those constructors in BaseCheck. I had to add this constructor, though, to maintain the serializability of the class.", "author": "Bentleysb", "createdAt": "2020-09-22T16:34:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjIyODc1Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjI4OTExNA==", "url": "https://github.com/osmlab/atlas-checks/pull/361#discussion_r492289114", "bodyText": "Nice usage here \ud83d\udc4d", "author": "danielduhh", "createdAt": "2020-09-21T19:15:33Z", "path": "src/main/java/org/openstreetmap/atlas/checks/validation/areas/AreasWithHighwayTagCheck.java", "diffHunk": "@@ -71,33 +73,41 @@ public boolean validCheckForObject(final AtlasObject object)\n                 // If the tag isn't one of the VALID_HIGHWAY_TAGS, we want to flag it.\n                 .filter(tag -> isUnacceptableAreaHighwayTagCombination(object, tag)).map(tag ->\n                 {\n-                    final String instruction;\n+                    this.markAsFlagged(object.getOsmIdentifier());\n+\n                     if (tag.equals(HighwayTag.FOOTWAY))\n                     {\n-                        instruction = this.getLocalizedInstruction(0, object.getOsmIdentifier(),\n-                                tag, HighwayTag.PEDESTRIAN);\n-                    }\n-                    else\n-                    {\n-                        instruction = this.getLocalizedInstruction(1, object.getOsmIdentifier(),\n-                                tag.getTagValue());\n-                    }\n-                    final Set<AtlasObject> results;\n-                    if (object instanceof Edge)\n-                    {\n-                        final EdgeWalker walker = new AreasWithHighwayTagCheckWalker((Edge) object);\n-                        final Set<Edge> connectedBadEdges = walker.collectEdges().stream()\n-                                .filter(Edge::isMainEdge).collect(Collectors.toSet());\n-                        connectedBadEdges\n-                                .forEach(badEdge -> this.markAsFlagged(badEdge.getOsmIdentifier()));\n-                        results = new HashSet<>(connectedBadEdges);\n-                    }\n-                    else\n-                    {\n-                        results = Collections.singleton(object);\n-                        this.markAsFlagged(object.getOsmIdentifier());\n+                        final Set<AtlasObject> objectsToFlag = this.getObjectsToFlag(object);\n+                        return this\n+                                .createFlag(objectsToFlag,\n+                                        this.getLocalizedInstruction(0, object.getOsmIdentifier(),\n+                                                tag, HighwayTag.PEDESTRIAN))\n+                                .addFixSuggestions(objectsToFlag.stream()", "originalCommit": "b039b39a1e4a6204bceebc573342abf86e82e931", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjI4OTU5MA==", "url": "https://github.com/osmlab/atlas-checks/pull/361#discussion_r492289590", "bodyText": "Do you mind adding a note about FeatureChanges?", "author": "danielduhh", "createdAt": "2020-09-21T19:16:24Z", "path": "src/main/java/org/openstreetmap/atlas/checks/flag/CheckFlag.java", "diffHunk": "@@ -105,11 +109,65 @@ public CheckFlag(final String identifier, final Set<? extends AtlasObject> objec\n      */\n     public CheckFlag(final String identifier, final Set<? extends AtlasObject> objects,\n             final List<String> instructions, final List<Location> points)\n+    {\n+        this(identifier, objects, instructions, points, new HashSet<>());\n+    }\n+\n+    /**\n+     * Creates a {@link CheckFlag} with the addition of a list of {@code point} {@link Location}s\n+     * that highlight specific points in the geometry that caused the rule violation", "originalCommit": "b039b39a1e4a6204bceebc573342abf86e82e931", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "8cbd933a72d914f2f4981e31151604f2ae59b5bd", "url": "https://github.com/osmlab/atlas-checks/commit/8cbd933a72d914f2f4981e31151604f2ae59b5bd", "message": "merge latest", "committedDate": "2020-09-22T16:08:52Z", "type": "commit"}, {"oid": "9a636a0e393621961cea02cc686981cfee8bb648", "url": "https://github.com/osmlab/atlas-checks/commit/9a636a0e393621961cea02cc686981cfee8bb648", "message": "comment and constant", "committedDate": "2020-09-22T16:20:38Z", "type": "commit"}, {"oid": "028217c02f27457ab17c0d559f845ba3e9d6fb6d", "url": "https://github.com/osmlab/atlas-checks/commit/028217c02f27457ab17c0d559f845ba3e9d6fb6d", "message": "comment and constant", "committedDate": "2020-09-22T16:22:20Z", "type": "commit"}, {"oid": "028217c02f27457ab17c0d559f845ba3e9d6fb6d", "url": "https://github.com/osmlab/atlas-checks/commit/028217c02f27457ab17c0d559f845ba3e9d6fb6d", "message": "comment and constant", "committedDate": "2020-09-22T16:22:20Z", "type": "forcePushed"}]}