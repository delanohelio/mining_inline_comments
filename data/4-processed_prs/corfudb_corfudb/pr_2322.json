{"pr_number": 2322, "pr_title": "CorfuStore: Record if table is opened as disk based", "pr_createdAt": "2020-01-23T02:27:00Z", "pr_url": "https://github.com/CorfuDB/CorfuDB/pull/2322", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDQxMjA0Mg==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2322#discussion_r370412042", "bodyText": "The metadata is for a distributed object, but the path of is local information. Does it make sense to store it in this registry ?", "author": "Maithem", "createdAt": "2020-01-23T23:40:14Z", "path": "runtime/proto/corfu_store_metadata.proto", "diffHunk": "@@ -30,8 +30,12 @@ message TableMetadata {\n     TableName table_name = 1;\n     // True if the CorfuStore is disk based and False if it can be contained in memory.\n     bool disk_based = 2;\n+\n+    // Full path to disk based location if this table is disk based\n+    string disk_based_path = 3;", "originalCommit": "787a9603f8047796abf42d73528dc0dc281e6832", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDkxMDI4NQ==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2322#discussion_r370910285", "bodyText": "Technically true, but in practice all distributed clients pass the same path.\nIn any way we require a way to communicate the location of the disk path from the client's table to the checkpointer so the latter can use the exact same path as a prefix, otherwise we risk in IO overload if the disk path points to a separate disk.", "author": "hisundar", "createdAt": "2020-01-25T03:11:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDQxMjA0Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTA4NjA3MA==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2322#discussion_r371086070", "bodyText": "I see.\nBut what happens if the client and the checkpointer run on the same machine. Wouldn't they both point to the same path?\nSince during open the DB in the destination path is destroyed https://github.com/CorfuDB/CorfuDB/blob/master/runtime/src/main/java/org/corfudb/runtime/collections/PersistedStreamingMap.java#L54 , this will crash one of the clients.", "author": "Maithem", "createdAt": "2020-01-27T07:08:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDQxMjA0Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTQ2Nzc5MQ==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2322#discussion_r371467791", "bodyText": "This path location added in this PR is info-only. It is up to the clients to ensure that they do not pass conflicting paths and open the same table from multiple clients. For example the checkpointer client will suffix the table with a subfolder like _compactor_tablename/ to ensure that it does not conflict. We can at best add a few comments explaining this.", "author": "hisundar", "createdAt": "2020-01-27T20:34:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDQxMjA0Mg=="}], "type": "inlineReview"}, {"oid": "cf0b4c0dfd01c6998d0c8d2ed4601101ce761587", "url": "https://github.com/CorfuDB/CorfuDB/commit/cf0b4c0dfd01c6998d0c8d2ed4601101ce761587", "message": "CorfuStore: Record if table is opened as disk based\n\nThis is needed for the checkpointer to make sure that\na disk based table is opened as a disk based table and\nnot an in-memory table.", "committedDate": "2020-01-24T01:51:33Z", "type": "forcePushed"}, {"oid": "3aef40b07d4c3524fea95f5a72fde0cbc8311a32", "url": "https://github.com/CorfuDB/CorfuDB/commit/3aef40b07d4c3524fea95f5a72fde0cbc8311a32", "message": "CorfuStore: Record if table is opened as disk based\n\nThis is needed for the checkpointer to make sure that\na disk based table is opened as a disk based table and\nnot an in-memory table.", "committedDate": "2020-01-27T23:45:20Z", "type": "forcePushed"}, {"oid": "f5ebad053575ab72fe9fd8eff76cb52bd96ba2c4", "url": "https://github.com/CorfuDB/CorfuDB/commit/f5ebad053575ab72fe9fd8eff76cb52bd96ba2c4", "message": "CorfuStore: Add test to checkpoint & Trim disk based CorfuStore table", "committedDate": "2020-02-04T01:17:26Z", "type": "forcePushed"}, {"oid": "c65ee77870dad55d02b35fedbda59c4c173304ab", "url": "https://github.com/CorfuDB/CorfuDB/commit/c65ee77870dad55d02b35fedbda59c4c173304ab", "message": "CorfuBrowser: Add support for disk tables", "committedDate": "2020-02-05T02:47:52Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjU4NjE5NQ==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2322#discussion_r376586195", "bodyText": "I know you are just using the provided API, but we really need to clean this interface. Creating a disk back CorfuTable should be as easy as creating an in-memory table.", "author": "Maithem", "createdAt": "2020-02-07T20:13:47Z", "path": "test/src/test/java/org/corfudb/integration/CorfuStoreIT.java", "diffHunk": "@@ -232,4 +244,122 @@ public void readDataWithDynamicMessages() throws Exception {\n \n         assertThat(shutdownCorfuServer(corfuServer)).isTrue();\n     }\n+\n+    public Token checkpointAndTrimCorfuStore(CorfuRuntime runtimeC, boolean skipTrim, String tempDiskPath) {\n+\n+        TableRegistry tableRegistry = runtimeC.getTableRegistry();\n+        CorfuTable<CorfuStoreMetadata.TableName,\n+                CorfuRecord<CorfuStoreMetadata.TableDescriptors,\n+                        CorfuStoreMetadata.TableMetadata>>\n+                        tableRegistryCT = tableRegistry.getRegistryTable();\n+\n+        // Save the regular serializer first..\n+        ISerializer protobufSerializer = Serializers.getSerializer(ProtobufSerializer.PROTOBUF_SERIALIZER_CODE);\n+\n+        // Must register dynamicProtobufSerializer *AFTER* the getTableRegistry() call to ensure that\n+        // the serializer does not go back to the regular ProtobufSerializer\n+        ISerializer dynamicProtobufSerializer = new DynamicProtobufSerializer(runtimeC);\n+        Serializers.registerSerializer(dynamicProtobufSerializer);\n+\n+        // First checkpoint the TableRegistry system table\n+        MultiCheckpointWriter<CorfuTable> mcw = new MultiCheckpointWriter<>();\n+\n+        Token trimToken = new Token(Token.UNINITIALIZED.getEpoch(), Token.UNINITIALIZED.getSequence());\n+        for (CorfuStoreMetadata.TableName tableName : tableRegistry.listTables(null)) {\n+            String fullTableName = TableRegistry.getFullyQualifiedTableName(\n+                    tableName.getNamespace(), tableName.getTableName()\n+                    );\n+            SMRObject.Builder<CorfuTable<CorfuDynamicKey, CorfuDynamicRecord>> corfuTableBuilder = runtimeC.getObjectsView().build()\n+                    .setTypeToken(new TypeToken<CorfuTable<CorfuDynamicKey, CorfuDynamicRecord>>() {})\n+                    .setStreamName(fullTableName)\n+                    .setSerializer(dynamicProtobufSerializer);\n+\n+            // Find out if a table needs to be backed up by disk path to even checkpoint\n+            boolean diskBased = tableRegistryCT.get(tableName).getMetadata().getDiskBased();\n+            if (diskBased) {\n+                final Path persistedCacheLocation = Paths.get(tempDiskPath + tableName.getTableName());\n+                final Options options = new Options().setCreateIfMissing(true);\n+                final Supplier<StreamingMap<CorfuDynamicKey, CorfuDynamicRecord>> mapSupplier = () -> new PersistedStreamingMap<>(\n+                        persistedCacheLocation, options,\n+                        dynamicProtobufSerializer, runtimeC);\n+                corfuTableBuilder.setArguments(mapSupplier, ICorfuVersionPolicy.MONOTONIC);\n+            }\n+", "originalCommit": "c65ee77870dad55d02b35fedbda59c4c173304ab", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTYwNjcxNw==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2322#discussion_r379606717", "bodyText": "I completely agree. The api is super messy right now.", "author": "hisundar", "createdAt": "2020-02-14T19:30:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjU4NjE5NQ=="}], "type": "inlineReview"}, {"oid": "cf5da3b9d6b1c3eecbfae55b3bf23fff6fcc1ff9", "url": "https://github.com/CorfuDB/CorfuDB/commit/cf5da3b9d6b1c3eecbfae55b3bf23fff6fcc1ff9", "message": "CorfuStore: Record if table is opened as disk based\n\nThis is needed for checkpointer so it can do the same.\n\nCorfuBrowser: Add support for disk tables\nWithout it browser can't open large tables.\n\nCorfuStore: Add test to checkpoint & Trim disk based CorfuStore table\nWithout this bugs are only discovered when deployed in scale setups.", "committedDate": "2020-02-13T22:37:14Z", "type": "forcePushed"}, {"oid": "bd54f95249fc0ad4e3e5f4797be083515b3a6253", "url": "https://github.com/CorfuDB/CorfuDB/commit/bd54f95249fc0ad4e3e5f4797be083515b3a6253", "message": "CorfuBrowser: add support for diskPath to open large tables\n\nIf a table is too large to fit in memory then user can\npass a --diskPath and let that table be opened\nas an in-memory table.", "committedDate": "2020-02-14T04:01:29Z", "type": "forcePushed"}, {"oid": "ae123965e512acfc540bb1e7f35f3803b958553d", "url": "https://github.com/CorfuDB/CorfuDB/commit/ae123965e512acfc540bb1e7f35f3803b958553d", "message": "CorfuStore: Record if table is opened as disk based\n\nThis is needed for checkpointer so it can do the same.\n\nCorfuBrowser: Add support for disk tables\nWithout it browser can't open large tables.\nIf a table is too large to fit in memory then user can\npass a --diskPath and let that table be\nopened as an in-memory table.\n\nCorfuStore: Add test to checkpoint & Trim disk based\nCorfuStore table Without this bugs are only\ndiscovered when deployed in scale setups.", "committedDate": "2020-02-21T19:44:31Z", "type": "forcePushed"}, {"oid": "530d9c07e2c9ec8ad944789842357b81824441a7", "url": "https://github.com/CorfuDB/CorfuDB/commit/530d9c07e2c9ec8ad944789842357b81824441a7", "message": "CorfuStore: Record if table is opened as disk based\n\nThis is needed for checkpointer so it can do the same.\n\nCorfuBrowser: Add support for disk tables\nWithout it browser can't open large tables.\nIf a table is too large to fit in memory then user can\npass a --diskPath and let that table be\nopened as an in-memory table.\n\nCorfuStore: Add test to checkpoint & Trim disk based\nCorfuStore table Without this bugs are only\ndiscovered when deployed in scale setups.", "committedDate": "2020-02-21T21:13:44Z", "type": "commit"}, {"oid": "530d9c07e2c9ec8ad944789842357b81824441a7", "url": "https://github.com/CorfuDB/CorfuDB/commit/530d9c07e2c9ec8ad944789842357b81824441a7", "message": "CorfuStore: Record if table is opened as disk based\n\nThis is needed for checkpointer so it can do the same.\n\nCorfuBrowser: Add support for disk tables\nWithout it browser can't open large tables.\nIf a table is too large to fit in memory then user can\npass a --diskPath and let that table be\nopened as an in-memory table.\n\nCorfuStore: Add test to checkpoint & Trim disk based\nCorfuStore table Without this bugs are only\ndiscovered when deployed in scale setups.", "committedDate": "2020-02-21T21:13:44Z", "type": "forcePushed"}]}