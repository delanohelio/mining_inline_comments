{"pr_number": 2709, "pr_title": "Force Snapshot Full Sync Implementation.", "pr_createdAt": "2020-08-13T17:16:51Z", "pr_url": "https://github.com/CorfuDB/CorfuDB/pull/2709", "timeline": [{"oid": "dc6529dd25c6a196ae6f0fbb659698c7da37ab71", "url": "https://github.com/CorfuDB/CorfuDB/commit/dc6529dd25c6a196ae6f0fbb659698c7da37ab71", "message": "Add force snapshot full sync API.", "committedDate": "2020-08-13T17:12:28Z", "type": "commit"}, {"oid": "b3d8d884263e5e8c642678d9e921c22998d56f92", "url": "https://github.com/CorfuDB/CorfuDB/commit/b3d8d884263e5e8c642678d9e921c22998d56f92", "message": "Fix some compiling errors.", "committedDate": "2020-08-13T17:12:28Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDM4MDYwOA==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2709#discussion_r470380608", "bodyText": "We could hit a NPE here. We should check replicationManager is not null, as the request might come when no valid standby is present in the Topology provided by SM so we haven't started replication yet.", "author": "annym", "createdAt": "2020-08-14T02:49:29Z", "path": "infrastructure/src/main/java/org/corfudb/infrastructure/logreplication/infrastructure/CorfuReplicationDiscoveryService.java", "diffHunk": "@@ -675,6 +679,14 @@ private void processUpgrade(DiscoveryServiceEvent event) {\n         }\n     }\n \n+    /**\n+     * Enforce a snapshot full sync for the specified standby site.\n+     * @param event\n+     */\n+    private void processEnforceSnapshotFullSync(DiscoveryServiceEvent event) {\n+        replicationManager.enforceSnapshotFullSync(event.getRemoteSiteInfo().getClusterId());", "originalCommit": "b3d8d884263e5e8c642678d9e921c22998d56f92", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDM4MDk3NQ==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2709#discussion_r470380975", "bodyText": "Can we rename remoteSiteInfo to remoteClusterInfo? to be consistent.", "author": "annym", "createdAt": "2020-08-14T02:51:05Z", "path": "infrastructure/src/main/java/org/corfudb/infrastructure/logreplication/infrastructure/DiscoveryServiceEvent.java", "diffHunk": "@@ -24,10 +25,16 @@ public DiscoveryServiceEvent(DiscoveryServiceEventType type, TopologyConfigurati\n         this.topologyConfig = topologyConfigMsg;\n     }\n \n+    public DiscoveryServiceEvent(DiscoveryServiceEventType type, String clusterId) {\n+        this.type = type;\n+        this.remoteSiteInfo = new ClusterDescriptor(clusterId, LogReplicationClusterInfo.ClusterRole.STANDBY);", "originalCommit": "b3d8d884263e5e8c642678d9e921c22998d56f92", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDM4MTA4OQ==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2709#discussion_r470381089", "bodyText": "Missing description", "author": "annym", "createdAt": "2020-08-14T02:51:35Z", "path": "infrastructure/src/main/java/org/corfudb/infrastructure/logreplication/infrastructure/plugins/CorfuReplicationClusterManagerAdapter.java", "diffHunk": "@@ -58,4 +58,10 @@\n      * @return\n      */\n     Map<String, LogReplicationMetadata.ReplicationStatusVal> queryReplicationStatus();\n+\n+    /**\n+     *", "originalCommit": "b3d8d884263e5e8c642678d9e921c22998d56f92", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDM4MTgxNg==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2709#discussion_r470381816", "bodyText": "nit -> and ?", "author": "annym", "createdAt": "2020-08-14T02:54:54Z", "path": "infrastructure/src/main/java/org/corfudb/infrastructure/logreplication/infrastructure/CorfuReplicationManager.java", "diffHunk": "@@ -204,4 +204,19 @@ public void processStandbyChange(TopologyDescriptor newConfig) {\n             }\n         }\n     }\n+\n+    /**\n+     * Given a clusterId, stop the current log replication event and", "originalCommit": "b3d8d884263e5e8c642678d9e921c22998d56f92", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDM4MjgzNA==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2709#discussion_r470382834", "bodyText": "For debugging it could be good idea to print the snapshot sync request Id returned by this call, stating that this is the Id of the forced snapshot sync. So we can correlate on the receiver.", "author": "annym", "createdAt": "2020-08-14T02:59:24Z", "path": "infrastructure/src/main/java/org/corfudb/infrastructure/logreplication/infrastructure/CorfuReplicationManager.java", "diffHunk": "@@ -204,4 +204,19 @@ public void processStandbyChange(TopologyDescriptor newConfig) {\n             }\n         }\n     }\n+\n+    /**\n+     * Given a clusterId, stop the current log replication event and\n+     * @param clusterID\n+     */\n+    public void enforceSnapshotFullSync(String clusterID) {\n+        CorfuLogReplicationRuntime replicationRuntime = runtimeToRemoteCluster.get(clusterID);\n+        if (replicationRuntime == null) {\n+            log.error(\"There are no replicationRuntime in the map for clusterID {}\", clusterID);\n+            return;\n+        }\n+\n+        replicationRuntime.getSourceManager().stopLogReplication();\n+        replicationRuntime.getSourceManager().startSnapshotSync();", "originalCommit": "b3d8d884263e5e8c642678d9e921c22998d56f92", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDM4MzI1NA==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2709#discussion_r470383254", "bodyText": "Can we have a test to validate force Snapshot Sync works?", "author": "annym", "createdAt": "2020-08-14T03:01:07Z", "path": "infrastructure/src/main/java/org/corfudb/infrastructure/logreplication/infrastructure/CorfuReplicationManager.java", "diffHunk": "@@ -204,4 +204,19 @@ public void processStandbyChange(TopologyDescriptor newConfig) {\n             }\n         }\n     }\n+\n+    /**\n+     * Given a clusterId, stop the current log replication event and\n+     * @param clusterID\n+     */\n+    public void enforceSnapshotFullSync(String clusterID) {", "originalCommit": "b3d8d884263e5e8c642678d9e921c22998d56f92", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjQyMzcwOA==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2709#discussion_r472423708", "bodyText": "Is this event only handled by the leader node? Or it is a broadcast?", "author": "zhangn49", "createdAt": "2020-08-18T19:17:23Z", "path": "infrastructure/src/main/java/org/corfudb/infrastructure/logreplication/infrastructure/CorfuReplicationDiscoveryService.java", "diffHunk": "@@ -222,6 +222,10 @@ public void processEvent(DiscoveryServiceEvent event) {\n                 processUpgrade(event);\n                 break;\n \n+            case ENFORCE_SNAPSHOT_FULL_SYNC:", "originalCommit": "b3d8d884263e5e8c642678d9e921c22998d56f92", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjU2MjY3Mg==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2709#discussion_r472562672", "bodyText": "Only leader node.", "author": "xiaoqin2012", "createdAt": "2020-08-19T00:16:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjQyMzcwOA=="}], "type": "inlineReview"}, {"oid": "f65aa28da207592ac8c2551fa63a990a671e0595", "url": "https://github.com/CorfuDB/CorfuDB/commit/f65aa28da207592ac8c2551fa63a990a671e0595", "message": "Implement enforce full snapshot sync for all standbys.\n   * Add a testcase for full snapshot sync API.", "committedDate": "2020-08-19T00:12:28Z", "type": "commit"}, {"oid": "e98c82791e9dcae28e6f477f9020caae69a596d8", "url": "https://github.com/CorfuDB/CorfuDB/commit/e98c82791e9dcae28e6f477f9020caae69a596d8", "message": "Some cleanup.", "committedDate": "2020-08-19T00:30:38Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjU3MjcxNg==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2709#discussion_r472572716", "bodyText": "Comment is not completed yet.", "author": "zhangn49", "createdAt": "2020-08-19T00:52:49Z", "path": "infrastructure/src/main/java/org/corfudb/infrastructure/logreplication/replication/fsm/LogReplicationFSM.java", "diffHunk": "@@ -181,6 +183,13 @@\n     @Getter\n     private final LogReplicationAckReader ackReader;\n \n+    /**\n+     * When a snapshot full sync request is enqueue in the FSM, it will reset the CF,\n+     * When a snapshot full sync request is processed, the CF will", "originalCommit": "e98c82791e9dcae28e6f477f9020caae69a596d8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjU3NTEwNw==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2709#discussion_r472575107", "bodyText": "This list is unused.", "author": "zhangn49", "createdAt": "2020-08-19T01:01:30Z", "path": "infrastructure/src/main/java/org/corfudb/infrastructure/logreplication/infrastructure/CorfuReplicationManager.java", "diffHunk": "@@ -204,4 +208,34 @@ public void processStandbyChange(TopologyDescriptor newConfig) {\n             }\n         }\n     }\n+\n+    /**\n+     * Stop the current log replication event and start a full snapshot sync for all standby clusters\n+     */\n+    public void enforceSnapshotFullSync() {\n+        List<UUID> snapshotIds = new ArrayList<>();", "originalCommit": "e98c82791e9dcae28e6f477f9020caae69a596d8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjU4MTQzMw==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2709#discussion_r472581433", "bodyText": "It might be good to print some warning so we know the enforce snapshot sync was not executed but received, if it hits these conditions.", "author": "annym", "createdAt": "2020-08-19T01:24:59Z", "path": "infrastructure/src/main/java/org/corfudb/infrastructure/logreplication/infrastructure/CorfuReplicationDiscoveryService.java", "diffHunk": "@@ -671,8 +675,18 @@ private void updateReplicationManagerTopology(TopologyDescriptor newConfig) {\n     private void processUpgrade(DiscoveryServiceEvent event) {\n         if (localClusterDescriptor.getRole() == ClusterRole.ACTIVE) {\n             // TODO pankti: is this correct?\n-            replicationManager.restart(event.getRemoteSiteInfo());\n+            replicationManager.restart(event.getRemoteClusterInfo());\n+        }\n+    }\n+\n+    /**\n+     * Enforce a snapshot full sync for all standbys if the current node is a leader node\n+     */\n+    private void processEnforceSnapshotFullSync() {\n+        if (replicationManager == null || isLeader.get() == false) {\n+            return;", "originalCommit": "e98c82791e9dcae28e6f477f9020caae69a596d8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjU4MTc4MA==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2709#discussion_r472581780", "bodyText": "Just to confirm, are we sure they would trigger the force Snapshot sync on all LR nodes? or could it be that they trigger only on their lead node?", "author": "annym", "createdAt": "2020-08-19T01:26:10Z", "path": "infrastructure/src/main/java/org/corfudb/infrastructure/logreplication/infrastructure/CorfuReplicationDiscoveryService.java", "diffHunk": "@@ -671,8 +675,18 @@ private void updateReplicationManagerTopology(TopologyDescriptor newConfig) {\n     private void processUpgrade(DiscoveryServiceEvent event) {\n         if (localClusterDescriptor.getRole() == ClusterRole.ACTIVE) {\n             // TODO pankti: is this correct?\n-            replicationManager.restart(event.getRemoteSiteInfo());\n+            replicationManager.restart(event.getRemoteClusterInfo());\n+        }\n+    }\n+\n+    /**\n+     * Enforce a snapshot full sync for all standbys if the current node is a leader node\n+     */\n+    private void processEnforceSnapshotFullSync() {\n+        if (replicationManager == null || isLeader.get() == false) {", "originalCommit": "e98c82791e9dcae28e6f477f9020caae69a596d8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTk1MDI5OQ==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2709#discussion_r475950299", "bodyText": "Wait for their reply. It is supposed that it is called on all nodes in the cluster.", "author": "xiaoqin2012", "createdAt": "2020-08-24T23:17:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjU4MTc4MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjU4MzA1NA==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2709#discussion_r472583054", "bodyText": "for consistency can we replace all occurrences of snapshotFullSync to snapshotSync?", "author": "annym", "createdAt": "2020-08-19T01:30:42Z", "path": "infrastructure/src/main/java/org/corfudb/infrastructure/logreplication/infrastructure/plugins/CorfuReplicationClusterManagerBaseAdapter.java", "diffHunk": "@@ -44,11 +44,17 @@ public synchronized void updateTopologyConfig(TopologyConfigurationMsg newTopolo\n         }\n     }\n \n+    @Override\n     public void prepareToBecomeStandby() {\n         corfuReplicationDiscoveryService.prepareToBecomeStandby();\n     }\n \n     public Map<String, LogReplicationMetadata.ReplicationStatusVal> queryReplicationStatus() {\n         return corfuReplicationDiscoveryService.queryReplicationStatus();\n     }\n+\n+    @Override\n+    public void forceSnapshotFullSync() {", "originalCommit": "e98c82791e9dcae28e6f477f9020caae69a596d8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjU5NzA2OQ==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2709#discussion_r472597069", "bodyText": "I think this logic should be in the onEntry of the SnapshotSyncState, otherwise we're mixing the transition with specific state logic. I believe you do have access to the FSM from the state itself so we could do:\nfsm.updateSnapshotSyncId();", "author": "annym", "createdAt": "2020-08-19T02:19:12Z", "path": "infrastructure/src/main/java/org/corfudb/infrastructure/logreplication/replication/fsm/LogReplicationFSM.java", "diffHunk": "@@ -323,6 +339,9 @@ private void consume() {\n                     LogReplicationState newState = state.processEvent(event);\n                     log.trace(\"Transition from {} to {}\", state, newState);\n                     transition(state, newState);\n+                    if (event.getType() == LogReplicationEventType.SNAPSHOT_SYNC_REQUEST) {", "originalCommit": "e98c82791e9dcae28e6f477f9020caae69a596d8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjU5NzM4Mw==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2709#discussion_r472597383", "bodyText": "nit -> clusterId", "author": "annym", "createdAt": "2020-08-19T02:19:43Z", "path": "infrastructure/src/main/java/org/corfudb/infrastructure/logreplication/replication/receive/LogReplicationMetadataManager.java", "diffHunk": "@@ -417,8 +417,8 @@ public String toString() {\n         return builder.toString();\n     }\n \n-    public static String getPersistedWriterMetadataTableName(String localClusterId) {\n-        return METADATA_TABLE_PREFIX_NAME + localClusterId;\n+    public static String getPersistedWriterMetadataTableName(String clusteId) {", "originalCommit": "e98c82791e9dcae28e6f477f9020caae69a596d8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjYyMDUzNQ==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2709#discussion_r472620535", "bodyText": "Is think this line 631 might be left from something else?", "author": "annym", "createdAt": "2020-08-19T02:56:05Z", "path": "test/src/test/java/org/corfudb/integration/CorfuReplicationClusterConfigIT.java", "diffHunk": "@@ -597,6 +604,130 @@ public void testNewConfigWithInvalidClusters() throws Exception {\n         assertThat(mapStandby.size()).isEqualTo(thirdBatch);\n     }\n \n+    private Table<LogReplicationMetadataKey, LogReplicationMetadataVal, LogReplicationMetadataVal> getMetadataTable(CorfuRuntime runtime) throws NoSuchMethodException, IllegalAccessException, InvocationTargetException {\n+        CorfuStore corfuStore = new CorfuStore(runtime);\n+        CorfuStoreMetadata.TableName metadataTableName = null;\n+        Table<LogReplicationMetadataKey, LogReplicationMetadataVal, LogReplicationMetadataVal> metadataTable = null;\n+\n+        for (CorfuStoreMetadata.TableName name : corfuStore.listTables(LogReplicationMetadataManager.NAMESPACE)){\n+            if(name.getTableName().contains(LogReplicationMetadataManager.METADATA_TABLE_PREFIX_NAME)) {\n+                metadataTableName = name;\n+            }\n+        }\n+\n+        metadataTable = corfuStore.openTable(\n+                    LogReplicationMetadataManager.NAMESPACE,\n+                    metadataTableName.getTableName(),\n+                    LogReplicationMetadataKey.class,\n+                    LogReplicationMetadataVal.class,\n+                    null,\n+                    TableOptions.builder().build());\n+\n+        return metadataTable;\n+    }\n+\n+\n+    /**\n+     * This test verifies config change with one active and one invalid", "originalCommit": "e98c82791e9dcae28e6f477f9020caae69a596d8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjYzODA0Nw==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2709#discussion_r472638047", "bodyText": "what happens if we have two standbys, we block on the first one (but the second one is completed) we would stay here indefinitely?", "author": "annym", "createdAt": "2020-08-19T03:24:12Z", "path": "infrastructure/src/main/java/org/corfudb/infrastructure/logreplication/infrastructure/CorfuReplicationManager.java", "diffHunk": "@@ -204,4 +208,34 @@ public void processStandbyChange(TopologyDescriptor newConfig) {\n             }\n         }\n     }\n+\n+    /**\n+     * Stop the current log replication event and start a full snapshot sync for all standby clusters\n+     */\n+    public void enforceSnapshotFullSync() {\n+        List<UUID> snapshotIds = new ArrayList<>();\n+        for (CorfuLogReplicationRuntime standbyRuntime : runtimeToRemoteCluster.values()) {\n+            standbyRuntime.getSourceManager().stopLogReplication();\n+            UUID snapshotUUID = standbyRuntime.getSourceManager().startSnapshotSync();\n+            snapshotIds.add(snapshotUUID);\n+            log.info(\"Enforce Start full snapshot sync for cluster {} with uuid {}\", standbyRuntime.getRemoteClusterId(), snapshotUUID);\n+        }\n+\n+        // Block until the full snapshot sync has been started on all the standby clusters.\n+        for (CorfuLogReplicationRuntime standbyRuntime : runtimeToRemoteCluster.values()) {\n+            UUID snapshotUUID = null;\n+            String clusterId = null;\n+\n+            try {\n+                snapshotUUID = standbyRuntime.getSourceManager().getLogReplicationFSM().getSnapshotFullSyncUUID().get();", "originalCommit": "e98c82791e9dcae28e6f477f9020caae69a596d8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjYzOTIzMw==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2709#discussion_r472639233", "bodyText": "Question, what is the idea of blocking? initially it was thought as to not return until it has started, but the forceSnapshotSync from the caller is async and returns right away. I'm not sure I understand how this could help us.", "author": "annym", "createdAt": "2020-08-19T03:26:03Z", "path": "infrastructure/src/main/java/org/corfudb/infrastructure/logreplication/infrastructure/CorfuReplicationManager.java", "diffHunk": "@@ -204,4 +208,34 @@ public void processStandbyChange(TopologyDescriptor newConfig) {\n             }\n         }\n     }\n+\n+    /**\n+     * Stop the current log replication event and start a full snapshot sync for all standby clusters\n+     */\n+    public void enforceSnapshotFullSync() {\n+        List<UUID> snapshotIds = new ArrayList<>();\n+        for (CorfuLogReplicationRuntime standbyRuntime : runtimeToRemoteCluster.values()) {\n+            standbyRuntime.getSourceManager().stopLogReplication();\n+            UUID snapshotUUID = standbyRuntime.getSourceManager().startSnapshotSync();\n+            snapshotIds.add(snapshotUUID);\n+            log.info(\"Enforce Start full snapshot sync for cluster {} with uuid {}\", standbyRuntime.getRemoteClusterId(), snapshotUUID);\n+        }\n+\n+        // Block until the full snapshot sync has been started on all the standby clusters.", "originalCommit": "e98c82791e9dcae28e6f477f9020caae69a596d8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjY0MDk5NQ==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2709#discussion_r472640995", "bodyText": "the getSnapshotFullSyncUUID can happen before the SnapshotSyncRequest from line 219 is actually processed (as that just enqueues an event in the FSM). We could be holding on a previous CF which is not the one being instantiated in L290 of LogReplicationFSM.", "author": "annym", "createdAt": "2020-08-19T03:29:02Z", "path": "infrastructure/src/main/java/org/corfudb/infrastructure/logreplication/infrastructure/CorfuReplicationManager.java", "diffHunk": "@@ -204,4 +208,34 @@ public void processStandbyChange(TopologyDescriptor newConfig) {\n             }\n         }\n     }\n+\n+    /**\n+     * Stop the current log replication event and start a full snapshot sync for all standby clusters\n+     */\n+    public void enforceSnapshotFullSync() {\n+        List<UUID> snapshotIds = new ArrayList<>();\n+        for (CorfuLogReplicationRuntime standbyRuntime : runtimeToRemoteCluster.values()) {\n+            standbyRuntime.getSourceManager().stopLogReplication();\n+            UUID snapshotUUID = standbyRuntime.getSourceManager().startSnapshotSync();\n+            snapshotIds.add(snapshotUUID);\n+            log.info(\"Enforce Start full snapshot sync for cluster {} with uuid {}\", standbyRuntime.getRemoteClusterId(), snapshotUUID);\n+        }\n+\n+        // Block until the full snapshot sync has been started on all the standby clusters.\n+        for (CorfuLogReplicationRuntime standbyRuntime : runtimeToRemoteCluster.values()) {\n+            UUID snapshotUUID = null;\n+            String clusterId = null;\n+\n+            try {\n+                snapshotUUID = standbyRuntime.getSourceManager().getLogReplicationFSM().getSnapshotFullSyncUUID().get();", "originalCommit": "e98c82791e9dcae28e6f477f9020caae69a596d8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjY0MTUxMg==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2709#discussion_r472641512", "bodyText": "where is this ever completed exceptionally?", "author": "annym", "createdAt": "2020-08-19T03:29:53Z", "path": "infrastructure/src/main/java/org/corfudb/infrastructure/logreplication/replication/fsm/LogReplicationFSM.java", "diffHunk": "@@ -257,6 +266,10 @@ private void initializeStates(SnapshotSender snapshotSender, LogEntrySender logE\n         states.put(LogReplicationStateType.STOPPED, new StoppedState());\n     }\n \n+    private synchronized void updateSnapshotFullSyncUUID(UUID uuid) {\n+            snapshotFullSyncUUID.complete(uuid);", "originalCommit": "e98c82791e9dcae28e6f477f9020caae69a596d8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "920ceedb5243df60dba7ff76bfbe87bced2cc62e", "url": "https://github.com/CorfuDB/CorfuDB/commit/920ceedb5243df60dba7ff76bfbe87bced2cc62e", "message": "Make forced snapshot sync API return a boolean.", "committedDate": "2020-08-24T23:15:09Z", "type": "commit"}, {"oid": "26a196017f1bccb1ea4a2aaf8b00ab63badad9dc", "url": "https://github.com/CorfuDB/CorfuDB/commit/26a196017f1bccb1ea4a2aaf8b00ab63badad9dc", "message": "Merge branch 'master' into xq/0813_snapshot_full_sync_01", "committedDate": "2020-08-24T23:16:30Z", "type": "commit"}, {"oid": "aeb85cba111b40140f9eec1db85e57c7df82c674", "url": "https://github.com/CorfuDB/CorfuDB/commit/aeb85cba111b40140f9eec1db85e57c7df82c674", "message": "Some cleanup.", "committedDate": "2020-08-24T23:34:04Z", "type": "commit"}, {"oid": "62f7673555c968c80ef2510e25b0297346f62445", "url": "https://github.com/CorfuDB/CorfuDB/commit/62f7673555c968c80ef2510e25b0297346f62445", "message": "Some cleanup.", "committedDate": "2020-08-25T00:01:34Z", "type": "commit"}, {"oid": "b868deed5264f24c3bc7b3456d556451d880bfba", "url": "https://github.com/CorfuDB/CorfuDB/commit/b868deed5264f24c3bc7b3456d556451d880bfba", "message": "Merge branch 'xq/0813_snapshot_full_sync_01' of https://github.com/CorfuDB/CorfuDB into xq/0813_snapshot_full_sync_01", "committedDate": "2020-08-25T00:03:25Z", "type": "commit"}, {"oid": "57d905de8ca435ad9c9bc6e21ac51e22068e9a5a", "url": "https://github.com/CorfuDB/CorfuDB/commit/57d905de8ca435ad9c9bc6e21ac51e22068e9a5a", "message": "Fix codacy complain.", "committedDate": "2020-08-25T00:13:22Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzQ4MDMzNA==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2709#discussion_r477480334", "bodyText": "private & final? And let's use the same comment format as other static values below..", "author": "zhangn49", "createdAt": "2020-08-26T17:49:16Z", "path": "infrastructure/src/main/java/org/corfudb/infrastructure/logreplication/infrastructure/CorfuReplicationDiscoveryService.java", "diffHunk": "@@ -48,6 +51,8 @@\n  */\n @Slf4j\n public class CorfuReplicationDiscoveryService implements Runnable, CorfuReplicationDiscoveryServiceAdapter {\n+    // Time to wait the forced snapshot sync to start in milliseconds.\n+    public static long WAIT_COMMAND_TIMEOUT = 1000;", "originalCommit": "57d905de8ca435ad9c9bc6e21ac51e22068e9a5a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzQ4MjU2NA==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2709#discussion_r477482564", "bodyText": "Unused Getter?", "author": "zhangn49", "createdAt": "2020-08-26T17:53:17Z", "path": "infrastructure/src/main/java/org/corfudb/infrastructure/logreplication/infrastructure/CorfuReplicationManager.java", "diffHunk": "@@ -26,6 +26,7 @@\n \n     // Keep map of remote cluster ID and the associated log replication runtime (an abstract\n     // client to that cluster)\n+    @Getter", "originalCommit": "57d905de8ca435ad9c9bc6e21ac51e22068e9a5a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzQ4ODQ5OQ==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2709#discussion_r477488499", "bodyText": "A specific name would be better, and looks like CompletableFuture<Void> is enough here.", "author": "zhangn49", "createdAt": "2020-08-26T18:03:19Z", "path": "infrastructure/src/main/java/org/corfudb/infrastructure/logreplication/infrastructure/DiscoveryServiceEvent.java", "diffHunk": "@@ -5,20 +5,37 @@\n \n import org.corfudb.infrastructure.logreplication.proto.LogReplicationClusterInfo.TopologyConfigurationMsg;\n \n+import java.util.UUID;\n+import java.util.concurrent.CompletableFuture;\n+\n public class DiscoveryServiceEvent {\n     DiscoveryServiceEventType type;\n \n+    // Used by enforcing snapshot sync event\n+    @Getter\n+    private UUID eventUUID;\n+\n+    // Used by enforcing snapshot sync event\n+    @Getter\n+    CompletableFuture<UUID> cf;", "originalCommit": "57d905de8ca435ad9c9bc6e21ac51e22068e9a5a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzQ5MDU2NA==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2709#discussion_r477490564", "bodyText": "I think the logic here is not correct.\nAssuming caller sends enforce request to all 3 nodes, and current node is non leader.\nSo processEnforceSnapshotSync is done here, but public boolean forceSnapshotSync() is still blocking until timeout.\nMaybe we can completeExceptionally the cf with an Illegal State Exception. So we will see ExecutionException and you already have the log.", "author": "zhangn49", "createdAt": "2020-08-26T18:06:57Z", "path": "infrastructure/src/main/java/org/corfudb/infrastructure/logreplication/infrastructure/CorfuReplicationDiscoveryService.java", "diffHunk": "@@ -677,8 +686,19 @@ private void updateReplicationManagerTopology(TopologyDescriptor newConfig) {\n     private void processUpgrade(DiscoveryServiceEvent event) {\n         if (localClusterDescriptor.getRole() == ClusterRole.ACTIVE) {\n             // TODO pankti: is this correct?\n-            replicationManager.restart(event.getRemoteSiteInfo());\n+            replicationManager.restart(event.getRemoteClusterInfo());\n+        }\n+    }\n+\n+    /**\n+     * Enforce a snapshot full sync for all standbys if the current node is a leader node\n+     */\n+    private void processEnforceSnapshotSync(DiscoveryServiceEvent event) {\n+        if (replicationManager == null || !isLeader.get()) {\n+            return;\n         }\n+\n+        replicationManager.enforceSnapshotSync(event);", "originalCommit": "57d905de8ca435ad9c9bc6e21ac51e22068e9a5a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzQ5MjY5OA==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2709#discussion_r477492698", "bodyText": "I think here is input(event), otherwise we will always hit TimeoutException", "author": "zhangn49", "createdAt": "2020-08-26T18:10:35Z", "path": "infrastructure/src/main/java/org/corfudb/infrastructure/logreplication/infrastructure/CorfuReplicationDiscoveryService.java", "diffHunk": "@@ -708,6 +728,33 @@ public void updateTopology(LogReplicationClusterInfo.TopologyConfigurationMsg to\n         return null;\n     }\n \n+    @Override\n+    public boolean forceSnapshotSync() {\n+        if (localClusterDescriptor.getRole() == ClusterRole.STANDBY) {\n+            log.error(\"This forceSnapshotSync command is not supported on standby cluster.\");\n+            return false;\n+        }\n+\n+        DiscoveryServiceEvent event = new DiscoveryServiceEvent(DiscoveryServiceEventType.ENFORCE_SNAPSHOT_SYNC, UUID.randomUUID());\n+        input(new DiscoveryServiceEvent(DiscoveryServiceEventType.ENFORCE_SNAPSHOT_SYNC, UUID.randomUUID()));", "originalCommit": "57d905de8ca435ad9c9bc6e21ac51e22068e9a5a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzQ5NDI4OQ==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2709#discussion_r477494289", "bodyText": "I think we can not guarantee that all sync have been started... We can only guarantee that all sync start event have been added to the queue...", "author": "zhangn49", "createdAt": "2020-08-26T18:13:24Z", "path": "infrastructure/src/main/java/org/corfudb/infrastructure/logreplication/infrastructure/CorfuReplicationDiscoveryService.java", "diffHunk": "@@ -708,6 +728,33 @@ public void updateTopology(LogReplicationClusterInfo.TopologyConfigurationMsg to\n         return null;\n     }\n \n+    @Override\n+    public boolean forceSnapshotSync() {\n+        if (localClusterDescriptor.getRole() == ClusterRole.STANDBY) {\n+            log.error(\"This forceSnapshotSync command is not supported on standby cluster.\");\n+            return false;\n+        }\n+\n+        DiscoveryServiceEvent event = new DiscoveryServiceEvent(DiscoveryServiceEventType.ENFORCE_SNAPSHOT_SYNC, UUID.randomUUID());\n+        input(new DiscoveryServiceEvent(DiscoveryServiceEventType.ENFORCE_SNAPSHOT_SYNC, UUID.randomUUID()));\n+\n+        // Block until the full snapshot sync has been started on all the standby clusters.", "originalCommit": "57d905de8ca435ad9c9bc6e21ac51e22068e9a5a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzQ5NzM2MQ==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2709#discussion_r477497361", "bodyText": "If runtimeToRemoteCluster is empty here, I think we won't have any log to see if we received the request or not...\nIt will be good to have a debug level log before this for loop to print eventId and runtimeToRemoteCluster size.", "author": "zhangn49", "createdAt": "2020-08-26T18:19:13Z", "path": "infrastructure/src/main/java/org/corfudb/infrastructure/logreplication/infrastructure/CorfuReplicationManager.java", "diffHunk": "@@ -204,4 +205,17 @@ public void processStandbyChange(TopologyDescriptor newConfig) {\n             }\n         }\n     }\n+\n+    /**\n+     * Stop the current log replication event and start a full snapshot sync for all standby clusters\n+     */\n+    public void enforceSnapshotSync(DiscoveryServiceEvent event) {\n+        for (CorfuLogReplicationRuntime standbyRuntime : runtimeToRemoteCluster.values()) {", "originalCommit": "57d905de8ca435ad9c9bc6e21ac51e22068e9a5a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "518bf6f5fc94e10c515dec63bd695dfef951956f", "url": "https://github.com/CorfuDB/CorfuDB/commit/518bf6f5fc94e10c515dec63bd695dfef951956f", "message": "Address some comments.", "committedDate": "2020-08-26T21:46:13Z", "type": "commit"}, {"oid": "4f18ae396ae1a9539e27d1e0300f6e05ae2512e3", "url": "https://github.com/CorfuDB/CorfuDB/commit/4f18ae396ae1a9539e27d1e0300f6e05ae2512e3", "message": "Implement a listener API for enforceSnapshotSync.", "committedDate": "2020-09-01T04:44:36Z", "type": "commit"}, {"oid": "2e5a1639bd14e1241ec3741200741ed205d6774c", "url": "https://github.com/CorfuDB/CorfuDB/commit/2e5a1639bd14e1241ec3741200741ed205d6774c", "message": "Fix compiling issues.", "committedDate": "2020-09-01T20:21:16Z", "type": "commit"}, {"oid": "6ecb55e4862062225a54df359e9e9be8f103a682", "url": "https://github.com/CorfuDB/CorfuDB/commit/6ecb55e4862062225a54df359e9e9be8f103a682", "message": "Fix codacy complains.", "committedDate": "2020-09-01T22:16:36Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTQzNjE1OQ==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2709#discussion_r481436159", "bodyText": "Can we add a comment on why we need this listener, for other developers future reference.", "author": "annym", "createdAt": "2020-09-01T21:15:35Z", "path": "infrastructure/src/main/java/org/corfudb/infrastructure/logreplication/infrastructure/CorfuReplicationDiscoveryService.java", "diffHunk": "@@ -155,6 +159,9 @@\n      */\n     private boolean serverStarted = false;\n \n+    private LogReplicationEventListener logReplicationEventListener;", "originalCommit": "2e5a1639bd14e1241ec3741200741ed205d6774c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTQ0NTE1MQ==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2709#discussion_r481445151", "bodyText": "nit -> to the event to the event.", "author": "annym", "createdAt": "2020-09-01T21:34:38Z", "path": "infrastructure/src/main/java/org/corfudb/infrastructure/logreplication/infrastructure/CorfuReplicationDiscoveryService.java", "diffHunk": "@@ -708,7 +733,29 @@ public void updateTopology(LogReplicationClusterInfo.TopologyConfigurationMsg to\n         return null;\n     }\n \n+    @Override\n+    public void forceSnapshotSync(String clusterId) {\n+        if (localClusterDescriptor.getRole() == ClusterRole.STANDBY) {\n+            String errorStr = \"The forceSnapshotSync command is not supported on standby cluster: \" + localNodeDescriptor;\n+            log.error(errorStr);\n+            throw new RuntimeException(errorStr);\n+        }\n+\n+        log.info(\"Received the forceSnapshotSync command at node {} and will write to the replicationTable.\", localNodeDescriptor);\n+\n+        /**\n+         * write to the event to the event corfu table", "originalCommit": "2e5a1639bd14e1241ec3741200741ed205d6774c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTQ2ODcyNA==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2709#discussion_r481468724", "bodyText": "I think this is not thread safe. We could have issues if a new configuration comes in (which writes to this object) while this is being used/read by the listener?", "author": "annym", "createdAt": "2020-09-01T22:32:46Z", "path": "infrastructure/src/main/java/org/corfudb/infrastructure/logreplication/infrastructure/CorfuReplicationDiscoveryService.java", "diffHunk": "@@ -101,6 +102,7 @@\n     /**\n      * Defines the cluster to which this node belongs to.\n      */\n+    @Getter", "originalCommit": "6ecb55e4862062225a54df359e9e9be8f103a682", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTgzMzE4Nw==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2709#discussion_r485833187", "bodyText": "+1. Looks like we need to make forceSnapshotSync synchronized.", "author": "zhangn49", "createdAt": "2020-09-09T18:38:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTQ2ODcyNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTg0MTc4MQ==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2709#discussion_r485841781", "bodyText": "The processEvent is synchronized already.", "author": "xiaoqin2012", "createdAt": "2020-09-09T18:55:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTQ2ODcyNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTQ3NTk4MA==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2709#discussion_r481475980", "bodyText": "you can call getLocalClusterRoleType", "author": "annym", "createdAt": "2020-09-01T22:54:11Z", "path": "infrastructure/src/main/java/org/corfudb/infrastructure/logreplication/infrastructure/CorfuReplicationDiscoveryService.java", "diffHunk": "@@ -708,7 +733,34 @@ public void updateTopology(LogReplicationClusterInfo.TopologyConfigurationMsg to\n         return null;\n     }\n \n+    @Override\n+    public void forceSnapshotSync(String clusterId) {\n+        if (localClusterDescriptor.getRole() == ClusterRole.STANDBY) {", "originalCommit": "6ecb55e4862062225a54df359e9e9be8f103a682", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTQ3NjM3Mw==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2709#discussion_r481476373", "bodyText": "I think this getter is not used", "author": "annym", "createdAt": "2020-09-01T22:55:18Z", "path": "infrastructure/src/main/java/org/corfudb/infrastructure/logreplication/infrastructure/CorfuReplicationManager.java", "diffHunk": "@@ -38,6 +38,7 @@\n \n     private final CorfuRuntime corfuRuntime;\n \n+    @Getter", "originalCommit": "6ecb55e4862062225a54df359e9e9be8f103a682", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTUwMDg4Ng==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2709#discussion_r481500886", "bodyText": "We can make this log message shorter for readability, anyways it will only show on the node which received it (no need to specify the localNodeDescriptor). Received forceSnapshotSync", "author": "annym", "createdAt": "2020-09-02T00:14:49Z", "path": "infrastructure/src/main/java/org/corfudb/infrastructure/logreplication/infrastructure/CorfuReplicationDiscoveryService.java", "diffHunk": "@@ -708,7 +733,34 @@ public void updateTopology(LogReplicationClusterInfo.TopologyConfigurationMsg to\n         return null;\n     }\n \n+    @Override\n+    public void forceSnapshotSync(String clusterId) {\n+        if (localClusterDescriptor.getRole() == ClusterRole.STANDBY) {\n+            String errorStr = \"The forceSnapshotSync command is not supported on standby cluster: \" + localNodeDescriptor;\n+            log.error(errorStr);\n+            throw new RuntimeException(errorStr);\n+        }\n+\n+        log.info(\"Received the forceSnapshotSync command at node {} and will write to the replicationTable.\", localNodeDescriptor);", "originalCommit": "6ecb55e4862062225a54df359e9e9be8f103a682", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTUwMTc2OA==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2709#discussion_r481501768", "bodyText": "standbyRuntime is null it will throw a NPE", "author": "annym", "createdAt": "2020-09-02T00:17:39Z", "path": "infrastructure/src/main/java/org/corfudb/infrastructure/logreplication/infrastructure/CorfuReplicationManager.java", "diffHunk": "@@ -204,4 +205,19 @@ public void processStandbyChange(TopologyDescriptor newConfig) {\n             }\n         }\n     }\n+\n+    /**\n+     * Stop the current log replication event and start a full snapshot sync for all standby clusters\n+     */\n+    public void enforceSnapshotSync(DiscoveryServiceEvent event) {\n+        CorfuLogReplicationRuntime standbyRuntime = runtimeToRemoteCluster.get(event.getRemoteClusterInfo().getClusterId());\n+        if (standbyRuntime == null) {\n+            log.warn(\"Failed to start enforceSnapshotSync for cluster {} as it is not on the standby list.\",\n+                    standbyRuntime.getRemoteClusterId());", "originalCommit": "6ecb55e4862062225a54df359e9e9be8f103a682", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTUwMjc2OA==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2709#discussion_r481502768", "bodyText": "should we have a forceSnapshotSync API that forces snapshot sync to all standbys?", "author": "annym", "createdAt": "2020-09-02T00:20:31Z", "path": "infrastructure/src/main/java/org/corfudb/infrastructure/logreplication/infrastructure/CorfuReplicationDiscoveryService.java", "diffHunk": "@@ -708,7 +733,34 @@ public void updateTopology(LogReplicationClusterInfo.TopologyConfigurationMsg to\n         return null;\n     }\n \n+    @Override\n+    public void forceSnapshotSync(String clusterId) {", "originalCommit": "6ecb55e4862062225a54df359e9e9be8f103a682", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjQ3NzY2Mw==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2709#discussion_r482477663", "bodyText": "This is no requirement for this.", "author": "xiaoqin2012", "createdAt": "2020-09-02T21:13:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTUwMjc2OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTUwMzE3NQ==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2709#discussion_r481503175", "bodyText": "nit -> not on all standby clusters, right? only on the specified clusterId", "author": "annym", "createdAt": "2020-09-02T00:22:03Z", "path": "infrastructure/src/main/java/org/corfudb/infrastructure/logreplication/infrastructure/plugins/CorfuReplicationClusterManagerAdapter.java", "diffHunk": "@@ -49,4 +49,12 @@\n      * @return\n      */\n     Map<String, LogReplicationMetadata.ReplicationStatusVal> queryReplicationStatus();\n+\n+    /**\n+     * This API enforce a full snapshot sync on all standby clusters at best effort.", "originalCommit": "6ecb55e4862062225a54df359e9e9be8f103a682", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTUwNTU4OA==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2709#discussion_r481505588", "bodyText": "final", "author": "annym", "createdAt": "2020-09-02T00:30:46Z", "path": "infrastructure/src/main/java/org/corfudb/infrastructure/logreplication/infrastructure/LogReplicationEventListener.java", "diffHunk": "@@ -0,0 +1,58 @@\n+package org.corfudb.infrastructure.logreplication.infrastructure;\n+\n+import lombok.extern.slf4j.Slf4j;\n+import org.corfudb.infrastructure.logreplication.proto.LogReplicationMetadata.ReplicationEvent;\n+\n+import org.corfudb.runtime.collections.CorfuStreamEntries;\n+import org.corfudb.runtime.collections.CorfuStreamEntry;\n+import org.corfudb.runtime.collections.StreamListener;\n+\n+import java.util.List;\n+\n+@Slf4j\n+public class LogReplicationEventListener implements StreamListener {\n+    private CorfuReplicationDiscoveryService discoveryService;", "originalCommit": "6ecb55e4862062225a54df359e9e9be8f103a682", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTUwNTgwMw==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2709#discussion_r481505803", "bodyText": "nit -> ServeiceLisener -> ServiceListener", "author": "annym", "createdAt": "2020-09-02T00:31:38Z", "path": "infrastructure/src/main/java/org/corfudb/infrastructure/logreplication/infrastructure/LogReplicationEventListener.java", "diffHunk": "@@ -0,0 +1,58 @@\n+package org.corfudb.infrastructure.logreplication.infrastructure;\n+\n+import lombok.extern.slf4j.Slf4j;\n+import org.corfudb.infrastructure.logreplication.proto.LogReplicationMetadata.ReplicationEvent;\n+\n+import org.corfudb.runtime.collections.CorfuStreamEntries;\n+import org.corfudb.runtime.collections.CorfuStreamEntry;\n+import org.corfudb.runtime.collections.StreamListener;\n+\n+import java.util.List;\n+\n+@Slf4j\n+public class LogReplicationEventListener implements StreamListener {\n+    private CorfuReplicationDiscoveryService discoveryService;\n+\n+    public  LogReplicationEventListener(CorfuReplicationDiscoveryService discoveryService) {\n+        this.discoveryService = discoveryService;\n+    }\n+\n+    public void start() {\n+        discoveryService.getLogReplicationMetadataManager().subscribeReplicationEventTable(this);\n+    }\n+\n+    public void stop() {\n+        discoveryService.getLogReplicationMetadataManager().unsubscribeReplicationEventTable(this);\n+    }\n+\n+    @Override\n+    public void onNext(CorfuStreamEntries results) {\n+        /**\n+         * If the current node is not a leader, ignore the notifications.\n+         */\n+        if (!discoveryService.getIsLeader().get()) {\n+            log.info(\"The onNext call with {} will be skipped as the current node {}  in the cluster {} is not the leader.\",\n+                    results, discoveryService.getLocalNodeDescriptor(), discoveryService.getLocalClusterDescriptor());\n+            return;\n+        }\n+\n+        log.info(\"LogReplicationEventListener onNext {} will be processed at node {} in the cluster {}\",\n+                results, discoveryService.getLocalNodeDescriptor(), discoveryService.getLocalClusterDescriptor());\n+\n+        /**\n+         * If the current node is the leader, it generates a discovery event and put it into the discovery service event queue.\n+         */\n+        for (List<CorfuStreamEntry> entryList : results.getEntries().values()) {\n+            for (CorfuStreamEntry entry : entryList) {\n+                ReplicationEvent event = (ReplicationEvent) entry.getPayload();\n+                log.info(\"ReplicationEventListener at node {} put an event {} to its local discoveryServiceQueue\", discoveryService.getLocalNodeDescriptor(), event);\n+                discoveryService.input(new DiscoveryServiceEvent(DiscoveryServiceEvent.DiscoveryServiceEventType.ENFORCE_SNAPSHOT_SYNC, event.getClusterId()));\n+            }\n+        }\n+    }\n+\n+    @Override\n+    public void onError(Throwable throwable) {\n+        log.error(\"onError for CorfuReplicationDiscoveryServeiceLisener\");", "originalCommit": "6ecb55e4862062225a54df359e9e9be8f103a682", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTUwNjEzMw==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2709#discussion_r481506133", "bodyText": "can we print the throwable?", "author": "annym", "createdAt": "2020-09-02T00:32:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTUwNTgwMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTUwNzYwMw==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2709#discussion_r481507603", "bodyText": "Is it worth to subscribe every node to listen to the enforce event? if anyways only the leader would take action... in which case maybe it would be better to subscribe onLockAcquire? and unsubscribe onLockRelease... anyways a node that is not a leader even if it listens it won't do anything...", "author": "annym", "createdAt": "2020-09-02T00:38:50Z", "path": "infrastructure/src/main/java/org/corfudb/infrastructure/logreplication/infrastructure/CorfuReplicationDiscoveryService.java", "diffHunk": "@@ -300,6 +311,8 @@ private void bootstrapLogReplicationService() {\n         // Unblock server initialization & register to Log Replication Lock, to attempt lock / leadership acquisition\n         serverCallback.complete(interClusterReplicationService);\n \n+        logReplicationEventListener = new LogReplicationEventListener(this);", "originalCommit": "6ecb55e4862062225a54df359e9e9be8f103a682", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjQ4MTMzNg==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2709#discussion_r482481336", "bodyText": "I thought about that but I don't see the point to complicate the logic.", "author": "xiaoqin2012", "createdAt": "2020-09-02T21:17:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTUwNzYwMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTUwODI5NA==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2709#discussion_r481508294", "bodyText": "this message will be printed as a huge blob and anyways it will only be printed on the corfu.logs of the node receiving it, we can likely remove the localNodeDescriptor and localClusterDescriptor", "author": "annym", "createdAt": "2020-09-02T00:41:31Z", "path": "infrastructure/src/main/java/org/corfudb/infrastructure/logreplication/infrastructure/LogReplicationEventListener.java", "diffHunk": "@@ -0,0 +1,58 @@\n+package org.corfudb.infrastructure.logreplication.infrastructure;\n+\n+import lombok.extern.slf4j.Slf4j;\n+import org.corfudb.infrastructure.logreplication.proto.LogReplicationMetadata.ReplicationEvent;\n+\n+import org.corfudb.runtime.collections.CorfuStreamEntries;\n+import org.corfudb.runtime.collections.CorfuStreamEntry;\n+import org.corfudb.runtime.collections.StreamListener;\n+\n+import java.util.List;\n+\n+@Slf4j\n+public class LogReplicationEventListener implements StreamListener {\n+    private CorfuReplicationDiscoveryService discoveryService;\n+\n+    public  LogReplicationEventListener(CorfuReplicationDiscoveryService discoveryService) {\n+        this.discoveryService = discoveryService;\n+    }\n+\n+    public void start() {\n+        discoveryService.getLogReplicationMetadataManager().subscribeReplicationEventTable(this);\n+    }\n+\n+    public void stop() {\n+        discoveryService.getLogReplicationMetadataManager().unsubscribeReplicationEventTable(this);\n+    }\n+\n+    @Override\n+    public void onNext(CorfuStreamEntries results) {\n+        /**\n+         * If the current node is not a leader, ignore the notifications.\n+         */\n+        if (!discoveryService.getIsLeader().get()) {\n+            log.info(\"The onNext call with {} will be skipped as the current node {}  in the cluster {} is not the leader.\",\n+                    results, discoveryService.getLocalNodeDescriptor(), discoveryService.getLocalClusterDescriptor());\n+            return;\n+        }\n+\n+        log.info(\"LogReplicationEventListener onNext {} will be processed at node {} in the cluster {}\",", "originalCommit": "6ecb55e4862062225a54df359e9e9be8f103a682", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "bb69bcc620455ab04ae701943a222bfe454df459", "url": "https://github.com/CorfuDB/CorfuDB/commit/bb69bcc620455ab04ae701943a222bfe454df459", "message": "Address some comments.", "committedDate": "2020-09-02T22:02:01Z", "type": "commit"}, {"oid": "e36909f5334e917129b2fed83df27945e32505fa", "url": "https://github.com/CorfuDB/CorfuDB/commit/e36909f5334e917129b2fed83df27945e32505fa", "message": "Merge branch 'master' into xq/0813_snapshot_full_sync_01", "committedDate": "2020-09-08T18:59:23Z", "type": "commit"}, {"oid": "97de6aefb6d00aac4553d1b7f732fe363993f3bb", "url": "https://github.com/CorfuDB/CorfuDB/commit/97de6aefb6d00aac4553d1b7f732fe363993f3bb", "message": "Fix codacy complains.", "committedDate": "2020-09-14T21:42:48Z", "type": "commit"}, {"oid": "5bd3cedef1cb6d15f1837689743c622e5bc3ef42", "url": "https://github.com/CorfuDB/CorfuDB/commit/5bd3cedef1cb6d15f1837689743c622e5bc3ef42", "message": "Fixing Codacy complains.", "committedDate": "2020-09-14T22:07:29Z", "type": "commit"}, {"oid": "20fb06e1f5a1194b04978396642b71a353d3fca8", "url": "https://github.com/CorfuDB/CorfuDB/commit/20fb06e1f5a1194b04978396642b71a353d3fca8", "message": "Merge branch 'master' into xq/0813_snapshot_full_sync_01", "committedDate": "2020-09-16T01:19:07Z", "type": "commit"}, {"oid": "62d33c6ad813ab2563fe0a67fa1034f6f9bcf405", "url": "https://github.com/CorfuDB/CorfuDB/commit/62d33c6ad813ab2563fe0a67fa1034f6f9bcf405", "message": "Merge branch 'master' into xq/0813_snapshot_full_sync_01", "committedDate": "2020-09-16T17:20:38Z", "type": "commit"}]}