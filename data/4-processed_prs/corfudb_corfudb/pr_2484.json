{"pr_number": 2484, "pr_title": "Layout and ClusterId Validation for the Server Router", "pr_createdAt": "2020-03-19T17:44:04Z", "pr_url": "https://github.com/CorfuDB/CorfuDB/pull/2484", "timeline": [{"oid": "eeb04025cb26f75a8b8ae61fb84b03f79941801e", "url": "https://github.com/CorfuDB/CorfuDB/commit/eeb04025cb26f75a8b8ae61fb84b03f79941801e", "message": "Introduce clusterId and layout validation for server router", "committedDate": "2020-03-19T17:51:17Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTM2NDY0NQ==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2484#discussion_r395364645", "bodyText": "I feel this could have an issue. Think about this case:\n\nthe client connects to A, B, C\nC joined new cluster\nthe client runtime is invalidated, and when it tries to fetch layout, the layout servers it tries to connect is still A, B, C becuase this is based on last layout.\nC responded with a new layout and new cluster id. The client will take this layout as in the current CorfuRuntime, it only needs to successfuly fetch from one layout server.\nthe client connects to the new cluster, which is not intended because client may wants to stay in the old cluster.\n\nCan you think about this case and see if it's true?", "author": "WenbinZhu", "createdAt": "2020-03-19T22:56:31Z", "path": "runtime/src/main/java/org/corfudb/runtime/CorfuRuntime.java", "diffHunk": "@@ -887,11 +887,13 @@ private void checkClusterId(@Nonnull Layout layout) {\n         if (clusterId == null) {\n             clusterId = layout.getClusterId();\n             if (clusterId != null) {\n-                log.info(\"Connected to new cluster {}\", UuidUtils.asBase64(clusterId));\n+                log.info(\"Connected to a new cluster {}\", UuidUtils.asBase64(clusterId));\n             }\n-        } else if (!clusterId.equals(layout.getClusterId())) {\n-            // We connected but got a cluster id we didn't expect.\n-            throw new WrongClusterException(clusterId, layout.getClusterId());\n+            // ClusterId has changed, connect to a new cluster.\n+        } else if (!clusterId.equals(layout.getClusterId()) && layout.getClusterId() != null) {\n+            log.warn(\"Connecting to a new cluster {}. Previous cluster was: {}\",\n+                    UuidUtils.asBase64(layout.getClusterId()), UuidUtils.asBase64(clusterId));\n+            clusterId = layout.getClusterId();", "originalCommit": "a73aad3b7817f6c7052a5e6ae3508a1dcc23bb68", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODc5ODMyMA==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2484#discussion_r398798320", "bodyText": "I'll remove this, as the prod issues were not attributed to this change.", "author": "PavelZaytsev", "createdAt": "2020-03-26T18:27:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTM2NDY0NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODc5OTE3Nw==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2484#discussion_r398799177", "bodyText": "sounds good!", "author": "achinmishra", "createdAt": "2020-03-26T18:28:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTM2NDY0NQ=="}], "type": "inlineReview"}, {"oid": "a0c65b6b09a9bc1bc2bed5de6ff3ecc4c836118f", "url": "https://github.com/CorfuDB/CorfuDB/commit/a0c65b6b09a9bc1bc2bed5de6ff3ecc4c836118f", "message": "Introduce clusterId and layout validation on the server router level", "committedDate": "2020-03-19T23:51:29Z", "type": "forcePushed"}, {"oid": "b514e9bd2ec30228b50470ba7087508437bf7e57", "url": "https://github.com/CorfuDB/CorfuDB/commit/b514e9bd2ec30228b50470ba7087508437bf7e57", "message": "Introduce clusterId and layout validation on the server router level", "committedDate": "2020-03-26T18:37:36Z", "type": "commit"}, {"oid": "b514e9bd2ec30228b50470ba7087508437bf7e57", "url": "https://github.com/CorfuDB/CorfuDB/commit/b514e9bd2ec30228b50470ba7087508437bf7e57", "message": "Introduce clusterId and layout validation on the server router level", "committedDate": "2020-03-26T18:37:36Z", "type": "forcePushed"}]}