{"pr_number": 2827, "pr_title": "Protobuf Management RPCs", "pr_createdAt": "2020-11-22T00:55:26Z", "pr_url": "https://github.com/CorfuDB/CorfuDB/pull/2827", "timeline": [{"oid": "e1281ba4884a63fb9319c249af144f908e304040", "url": "https://github.com/CorfuDB/CorfuDB/commit/e1281ba4884a63fb9319c249af144f908e304040", "message": "Add Implementation of Management RPCs using Protobuf\n\nProvides routing support for Protobuf messages and an implementation of Management\nRPCs using Protobuf messages. Done as part of an effort to support rolling upgrades.", "committedDate": "2020-11-22T02:05:17Z", "type": "forcePushed"}, {"oid": "1bec6144ef1460e12544d58f9b52cf7a97fab8e6", "url": "https://github.com/CorfuDB/CorfuDB/commit/1bec6144ef1460e12544d58f9b52cf7a97fab8e6", "message": "Add Implementation of Management RPCs using Protobuf\n\nProvides routing support for Protobuf messages and an implementation of Management\nRPCs using Protobuf messages. Done as part of an effort to support rolling upgrades.", "committedDate": "2020-11-22T18:17:33Z", "type": "forcePushed"}, {"oid": "29e33208a49001da8c053a2f64bf710605892298", "url": "https://github.com/CorfuDB/CorfuDB/commit/29e33208a49001da8c053a2f64bf710605892298", "message": "Add Implementation of Management RPCs using Protobuf\n\nProvides routing support for Protobuf messages and an implementation of Management\nRPCs using Protobuf messages. Done as part of an effort to support rolling upgrades.", "committedDate": "2020-11-22T22:54:57Z", "type": "forcePushed"}, {"oid": "e5dd4e71a127855393ea60aab8b79237e6b14882", "url": "https://github.com/CorfuDB/CorfuDB/commit/e5dd4e71a127855393ea60aab8b79237e6b14882", "message": "Add Implementation of Management RPCs using Protobuf\n\nProvides routing support for Protobuf messages and an implementation of Management\nRPCs using Protobuf messages. Done as part of an effort to support rolling upgrades.", "committedDate": "2020-11-23T00:28:58Z", "type": "forcePushed"}, {"oid": "b1f40e160d037304789104e7313a8c9504888022", "url": "https://github.com/CorfuDB/CorfuDB/commit/b1f40e160d037304789104e7313a8c9504888022", "message": "Add Implementation of Management RPCs using Protobuf\n\nProvides routing support for Protobuf messages and an implementation of Management\nRPCs using Protobuf messages. Done as part of an effort to support rolling upgrades.", "committedDate": "2020-11-24T17:56:28Z", "type": "forcePushed"}, {"oid": "ea8e2a8f3c7cd827159a6d0063a7c256750f72a1", "url": "https://github.com/CorfuDB/CorfuDB/commit/ea8e2a8f3c7cd827159a6d0063a7c256750f72a1", "message": "Add Implementation of Management RPCs using Protobuf\n\nProvides routing support for Protobuf messages and an implementation of Management\nRPCs using Protobuf messages. Done as part of an effort to support rolling upgrades.", "committedDate": "2020-11-26T23:13:38Z", "type": "forcePushed"}, {"oid": "17dd4f05ec3801d7cf26ab2ac054759cd2129ce8", "url": "https://github.com/CorfuDB/CorfuDB/commit/17dd4f05ec3801d7cf26ab2ac054759cd2129ce8", "message": "Add Implementation of Management RPCs using Protobuf\n\nProvides routing support for Protobuf messages and an implementation of Management\nRPCs using Protobuf messages. Done as part of an effort to support rolling upgrades.", "committedDate": "2020-11-30T01:14:31Z", "type": "forcePushed"}, {"oid": "8748f25a6d6b767da2334879b93a15e79867edfb", "url": "https://github.com/CorfuDB/CorfuDB/commit/8748f25a6d6b767da2334879b93a15e79867edfb", "message": "Add Implementation of Management RPCs using Protobuf\n\nProvides routing support for Protobuf messages and an implementation of Management\nRPCs using Protobuf messages. Done as part of an effort to support rolling upgrades.", "committedDate": "2020-11-30T17:05:35Z", "type": "forcePushed"}, {"oid": "a77e5667d1865c9e7711537764c3df76d6293990", "url": "https://github.com/CorfuDB/CorfuDB/commit/a77e5667d1865c9e7711537764c3df76d6293990", "message": "Add Implementation of Management RPCs using Protobuf\n\nProvides routing support for Protobuf messages and an implementation of Management\nRPCs using Protobuf messages. Done as part of an effort to support rolling upgrades.", "committedDate": "2020-11-30T19:04:23Z", "type": "forcePushed"}, {"oid": "e05955b8590de6f77f53a512b373c9f45aad3761", "url": "https://github.com/CorfuDB/CorfuDB/commit/e05955b8590de6f77f53a512b373c9f45aad3761", "message": "Add Implementation of Management RPCs using Protobuf\n\nProvides routing support for Protobuf messages and an implementation of Management\nRPCs using Protobuf messages. Done as part of an effort to support rolling upgrades.", "committedDate": "2020-11-30T19:43:46Z", "type": "forcePushed"}, {"oid": "426596757878ab669d4715863c1621f267974808", "url": "https://github.com/CorfuDB/CorfuDB/commit/426596757878ab669d4715863c1621f267974808", "message": "Add Implementation of Management RPCs using Protobuf\n\nProvides routing support for Protobuf messages and an implementation of Management\nRPCs using Protobuf messages. Done as part of an effort to support rolling upgrades.", "committedDate": "2020-11-30T21:31:15Z", "type": "forcePushed"}, {"oid": "8dda0236a13380c66b04b6caa14743d2a388c115", "url": "https://github.com/CorfuDB/CorfuDB/commit/8dda0236a13380c66b04b6caa14743d2a388c115", "message": "Add Implementation of Management RPCs using Protobuf\n\nProvides routing support for Protobuf messages and an implementation of Management\nRPCs using Protobuf messages. Done as part of an effort to support rolling upgrades.", "committedDate": "2020-11-30T23:15:17Z", "type": "forcePushed"}, {"oid": "9b57ee6e9db2e751de642d841c515dbcb12c0dc5", "url": "https://github.com/CorfuDB/CorfuDB/commit/9b57ee6e9db2e751de642d841c515dbcb12c0dc5", "message": "Add Implementation of Management RPCs using Protobuf\n\nProvides routing support for Protobuf messages and an implementation of Management\nRPCs using Protobuf messages. Done as part of an effort to support rolling upgrades.", "committedDate": "2020-12-01T22:04:03Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDY1MzU3OA==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2827#discussion_r534653578", "bodyText": "I just noticed some old RPC handlers have Nonnull constraint of their arguments (but some don't, also for other servers...), will it be better if we add Nonnull consistently to all the arguments?\nCurrently I cannot image any case where the argument is null but this might be helpful for debugging sometime in the future?", "author": "xcchang", "createdAt": "2020-12-03T04:09:29Z", "path": "infrastructure/src/main/java/org/corfudb/infrastructure/ManagementServer.java", "diffHunk": "@@ -203,109 +172,117 @@ private CorfuRuntime getNewCorfuRuntime() {\n         return runtime;\n     }\n \n-    private boolean isBootstrapped(CorfuMsg msg) {\n+    private boolean isBootstrapped(RequestMsg req) {\n         if (serverContext.getManagementLayout() == null) {\n-            log.warn(\"Received message but not bootstrapped! Message={}\", msg);\n+            log.warn(\"Received message but not bootstrapped! Message={}\", req.getHeader());\n             return false;\n         }\n+\n         return true;\n     }\n \n     /**\n      * Forward an orchestrator request to the orchestrator service.\n      *\n-     * @param msg corfu message containing ORCHESTRATOR_REQUEST\n-     * @param ctx netty ChannelHandlerContext\n-     * @param r   server router\n+     * @param req  a message containing an ORCHESTRATOR request\n+     * @param ctx  the netty ChannelHandlerContext\n+     * @param r    the server router\n      */\n-    @ServerHandler(type = CorfuMsgType.ORCHESTRATOR_REQUEST)\n-    public synchronized void handleOrchestratorMsg(@Nonnull CorfuPayloadMsg<OrchestratorMsg> msg,\n-                                                   @Nonnull ChannelHandlerContext ctx,\n-                                                   @Nonnull IServerRouter r) {\n-        log.debug(\"Received an orchestrator message {}\", msg);\n-        orchestrator.handle(msg, ctx, r);\n+    @RequestHandler(type = PayloadCase.ORCHESTRATOR_REQUEST)\n+    public synchronized void handleOrchestratorMsg(RequestMsg req, ChannelHandlerContext ctx, IServerRouter r) {\n+        log.debug(\"handleOrchestratorMsg: message:{}\", req.getPayload().getOrchestratorRequest());\n+        orchestrator.handle(req, ctx, r);", "originalCommit": "9b57ee6e9db2e751de642d841c515dbcb12c0dc5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTUzOTE1OQ==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2827#discussion_r535539159", "bodyText": "Those annotation can improve code inspection for inferring nullity\ufeff", "author": "Maithem", "createdAt": "2020-12-03T19:51:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDY1MzU3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTcwMjkwOA==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2827#discussion_r535702908", "bodyText": "Done. Added the @nonnull annotations to the handler methods.", "author": "zfrenette", "createdAt": "2020-12-03T22:50:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDY1MzU3OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDY1NTE1NQ==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2827#discussion_r534655155", "bodyText": "Is there any specific criteria that some handlers are set to synchronized but some are not? It looks to me that the operations upon shared resources have been synchronized in a lower level, (i.e. methods in servercontext, some concurrenthashmap, etc), and all the synchronized signature could be removed?", "author": "xcchang", "createdAt": "2020-12-03T04:14:43Z", "path": "infrastructure/src/main/java/org/corfudb/infrastructure/ManagementServer.java", "diffHunk": "@@ -203,109 +172,117 @@ private CorfuRuntime getNewCorfuRuntime() {\n         return runtime;\n     }\n \n-    private boolean isBootstrapped(CorfuMsg msg) {\n+    private boolean isBootstrapped(RequestMsg req) {\n         if (serverContext.getManagementLayout() == null) {\n-            log.warn(\"Received message but not bootstrapped! Message={}\", msg);\n+            log.warn(\"Received message but not bootstrapped! Message={}\", req.getHeader());\n             return false;\n         }\n+\n         return true;\n     }\n \n     /**\n      * Forward an orchestrator request to the orchestrator service.\n      *\n-     * @param msg corfu message containing ORCHESTRATOR_REQUEST\n-     * @param ctx netty ChannelHandlerContext\n-     * @param r   server router\n+     * @param req  a message containing an ORCHESTRATOR request\n+     * @param ctx  the netty ChannelHandlerContext\n+     * @param r    the server router\n      */\n-    @ServerHandler(type = CorfuMsgType.ORCHESTRATOR_REQUEST)\n-    public synchronized void handleOrchestratorMsg(@Nonnull CorfuPayloadMsg<OrchestratorMsg> msg,\n-                                                   @Nonnull ChannelHandlerContext ctx,\n-                                                   @Nonnull IServerRouter r) {\n-        log.debug(\"Received an orchestrator message {}\", msg);\n-        orchestrator.handle(msg, ctx, r);\n+    @RequestHandler(type = PayloadCase.ORCHESTRATOR_REQUEST)\n+    public synchronized void handleOrchestratorMsg(RequestMsg req, ChannelHandlerContext ctx, IServerRouter r) {\n+        log.debug(\"handleOrchestratorMsg: message:{}\", req.getPayload().getOrchestratorRequest());\n+        orchestrator.handle(req, ctx, r);\n     }\n \n     /**\n      * Bootstraps the management server.\n-     * The msg contains the layout to be bootstrapped.\n+     * The msg contains the Layout to be bootstrapped with.\n      *\n-     * @param msg corfu message containing MANAGEMENT_BOOTSTRAP_REQUEST\n-     * @param ctx netty ChannelHandlerContext\n-     * @param r   server router\n+     * @param req  a message containing a BOOTSTRAP_MANAGEMENT request\n+     * @param ctx  the netty ChannelHandlerContext\n+     * @param r    the server router\n      */\n-    @ServerHandler(type = CorfuMsgType.MANAGEMENT_BOOTSTRAP_REQUEST)\n-    public synchronized void handleManagementBootstrap(CorfuPayloadMsg<Layout> msg,\n-                                                       ChannelHandlerContext ctx, IServerRouter r) {\n-        if (serverContext.getManagementLayout() != null) {\n-            // We are already bootstrapped, bootstrap again is not allowed.\n-            log.warn(\"handleManagementBootstrap: Got a request to bootstrap a server \" +\n-                    \"with {} which is already bootstrapped, rejecting!\", msg.getPayload());\n-            r.sendResponse(ctx, msg, new CorfuMsg(CorfuMsgType.MANAGEMENT_ALREADY_BOOTSTRAP_ERROR));\n+    @RequestHandler(type = PayloadCase.BOOTSTRAP_MANAGEMENT_REQUEST)\n+    public synchronized void handleBootstrapManagement(RequestMsg req, ChannelHandlerContext ctx, IServerRouter r) {", "originalCommit": "9b57ee6e9db2e751de642d841c515dbcb12c0dc5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTQzMjkwNw==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2827#discussion_r535432907", "bodyText": "I am not sure if it's correct, but this is my reasoning. It does not always suffice to consider that the shared resources are themselves synchronized, but one also needs to look at the interaction between them. Consider the following scenario. The management server receives a BOOTSTRAP_MANAGEMENT request with Layout A. Since it isn't bootstrapped yet, the call to getManagementLayout will return null and the thread will enter the else clause. Now, before the thread has a chance to call setManagementLayout, it goes to sleep. Now the ManagementServer receives another BOOTSTRAP_MANAGEMENT request with Layout B. Since the first request did not complete, this thread will also get null from the call to getManagementLayout and enter the else clause. Now we are in the state where there are two bootstrap requests with different layouts calling setManagementLayout. If my understanding it correct, then this is problematic and leaving the synchronized keyword here will prevent such an issue.", "author": "zfrenette", "createdAt": "2020-12-03T17:23:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDY1NTE1NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTU0NzE0Ng==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2827#discussion_r535547146", "bodyText": "Good point, this was actually a production bug at some point.\nSometimes you need a bigger lock to protect against interleaving with other \"synchronized APIs\". For example, think about the local data store where put/get are individually synchronized, but there are some code paths that do something like:\nval = datastore.get(key)\n// some computation on val\nval2 = someFunction(val)\ndatastore.put(key, val2)\nThis is a read-modify-write cycle where interleaving with another thread between the get and put can cause some inconsistency. Notice that this consistency can happen despite each API being thread-safe individually.\nAlthough this style of synchronization can be safe when implemented carefully, its usually fragile. Ideally, the datastore should expose an interface for some notion of a transaction, where multiple operations can be executed as a single atomic unit.", "author": "Maithem", "createdAt": "2020-12-03T20:02:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDY1NTE1NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDY1NjEzMw==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2827#discussion_r534656133", "bodyText": "Is the exception expected to be thrown when getHandledTypes() returns empty set? I thought it might be better if we explicitly check if (client.getHandledTypes().isEmpty()) and log the warn/info. I'm not 100% sure that will it throw an exception or just pass silently if the streaming collection is empty", "author": "xcchang", "createdAt": "2020-12-03T04:17:39Z", "path": "infrastructure/src/main/java/org/corfudb/infrastructure/logreplication/runtime/LogReplicationClientRouter.java", "diffHunk": "@@ -144,11 +144,15 @@ public IClientRouter addClient(IClient client) {\n         client.setRouter(this);\n \n         // Iterate through all types of CorfuMsgType, registering the handler\n-        client.getHandledTypes().stream()\n-                .forEach(x -> {\n-                    handlerMap.put(x, client);\n-                    log.info(\"Registered client to handle messages of type {}\", x);\n-                });\n+        try {\n+            client.getHandledTypes().stream()\n+                    .forEach(x -> {\n+                        handlerMap.put(x, client);\n+                        log.info(\"Registered client to handle messages of type {}\", x);\n+                    });\n+        } catch (Exception ex) {\n+            // No Legacy getHandledTypes - Ignore\n+        }", "originalCommit": "9b57ee6e9db2e751de642d841c515dbcb12c0dc5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTMyNDU5Ng==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2827#discussion_r535324596", "bodyText": "Not an empty set, but when it is simply called with no implementation.  If the clients don't provide a legacy message handler explicitly, then the underlying call to getMsgHandler throws an UnsupportedOperation exception. A set of size zero would cause no exception.", "author": "zfrenette", "createdAt": "2020-12-03T15:21:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDY1NjEzMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTU0OTQ0Nw==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2827#discussion_r535549447", "bodyText": "Can we improve the logging message here, maybe just \"handleBootstrapManagement[{}]: incomplete layout {}\" would suffice.", "author": "Maithem", "createdAt": "2020-12-03T20:06:50Z", "path": "infrastructure/src/main/java/org/corfudb/infrastructure/ManagementServer.java", "diffHunk": "@@ -203,109 +172,117 @@ private CorfuRuntime getNewCorfuRuntime() {\n         return runtime;\n     }\n \n-    private boolean isBootstrapped(CorfuMsg msg) {\n+    private boolean isBootstrapped(RequestMsg req) {\n         if (serverContext.getManagementLayout() == null) {\n-            log.warn(\"Received message but not bootstrapped! Message={}\", msg);\n+            log.warn(\"Received message but not bootstrapped! Message={}\", req.getHeader());\n             return false;\n         }\n+\n         return true;\n     }\n \n     /**\n      * Forward an orchestrator request to the orchestrator service.\n      *\n-     * @param msg corfu message containing ORCHESTRATOR_REQUEST\n-     * @param ctx netty ChannelHandlerContext\n-     * @param r   server router\n+     * @param req  a message containing an ORCHESTRATOR request\n+     * @param ctx  the netty ChannelHandlerContext\n+     * @param r    the server router\n      */\n-    @ServerHandler(type = CorfuMsgType.ORCHESTRATOR_REQUEST)\n-    public synchronized void handleOrchestratorMsg(@Nonnull CorfuPayloadMsg<OrchestratorMsg> msg,\n-                                                   @Nonnull ChannelHandlerContext ctx,\n-                                                   @Nonnull IServerRouter r) {\n-        log.debug(\"Received an orchestrator message {}\", msg);\n-        orchestrator.handle(msg, ctx, r);\n+    @RequestHandler(type = PayloadCase.ORCHESTRATOR_REQUEST)\n+    public synchronized void handleOrchestratorMsg(RequestMsg req, ChannelHandlerContext ctx, IServerRouter r) {\n+        log.debug(\"handleOrchestratorMsg: message:{}\", req.getPayload().getOrchestratorRequest());\n+        orchestrator.handle(req, ctx, r);\n     }\n \n     /**\n      * Bootstraps the management server.\n-     * The msg contains the layout to be bootstrapped.\n+     * The msg contains the Layout to be bootstrapped with.\n      *\n-     * @param msg corfu message containing MANAGEMENT_BOOTSTRAP_REQUEST\n-     * @param ctx netty ChannelHandlerContext\n-     * @param r   server router\n+     * @param req  a message containing a BOOTSTRAP_MANAGEMENT request\n+     * @param ctx  the netty ChannelHandlerContext\n+     * @param r    the server router\n      */\n-    @ServerHandler(type = CorfuMsgType.MANAGEMENT_BOOTSTRAP_REQUEST)\n-    public synchronized void handleManagementBootstrap(CorfuPayloadMsg<Layout> msg,\n-                                                       ChannelHandlerContext ctx, IServerRouter r) {\n-        if (serverContext.getManagementLayout() != null) {\n-            // We are already bootstrapped, bootstrap again is not allowed.\n-            log.warn(\"handleManagementBootstrap: Got a request to bootstrap a server \" +\n-                    \"with {} which is already bootstrapped, rejecting!\", msg.getPayload());\n-            r.sendResponse(ctx, msg, new CorfuMsg(CorfuMsgType.MANAGEMENT_ALREADY_BOOTSTRAP_ERROR));\n+    @RequestHandler(type = PayloadCase.BOOTSTRAP_MANAGEMENT_REQUEST)\n+    public synchronized void handleBootstrapManagement(RequestMsg req, ChannelHandlerContext ctx, IServerRouter r) {\n+        final Layout layout = getLayout(req.getPayload().getBootstrapManagementRequest().getLayout());\n+        HeaderMsg responseHeader;\n+        ResponseMsg response;\n+\n+        if (layout == null || layout.getClusterId() == null) {\n+            log.warn(\"handleBootstrapManagement[{}]: Got a request to bootstrap a server with \" +", "originalCommit": "9b57ee6e9db2e751de642d841c515dbcb12c0dc5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTU0OTcyMg==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2827#discussion_r535549722", "bodyText": "Also, the log level should be log.error", "author": "Maithem", "createdAt": "2020-12-03T20:07:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTU0OTQ0Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTcwMzE3OA==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2827#discussion_r535703178", "bodyText": "Done.", "author": "zfrenette", "createdAt": "2020-12-03T22:50:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTU0OTQ0Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTU1MDI5Nw==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2827#discussion_r535550297", "bodyText": "\"handleBootstrapManagement[{}]: already bootstrapped with {}, rejecting {}\"", "author": "Maithem", "createdAt": "2020-12-03T20:08:23Z", "path": "infrastructure/src/main/java/org/corfudb/infrastructure/ManagementServer.java", "diffHunk": "@@ -203,109 +172,117 @@ private CorfuRuntime getNewCorfuRuntime() {\n         return runtime;\n     }\n \n-    private boolean isBootstrapped(CorfuMsg msg) {\n+    private boolean isBootstrapped(RequestMsg req) {\n         if (serverContext.getManagementLayout() == null) {\n-            log.warn(\"Received message but not bootstrapped! Message={}\", msg);\n+            log.warn(\"Received message but not bootstrapped! Message={}\", req.getHeader());\n             return false;\n         }\n+\n         return true;\n     }\n \n     /**\n      * Forward an orchestrator request to the orchestrator service.\n      *\n-     * @param msg corfu message containing ORCHESTRATOR_REQUEST\n-     * @param ctx netty ChannelHandlerContext\n-     * @param r   server router\n+     * @param req  a message containing an ORCHESTRATOR request\n+     * @param ctx  the netty ChannelHandlerContext\n+     * @param r    the server router\n      */\n-    @ServerHandler(type = CorfuMsgType.ORCHESTRATOR_REQUEST)\n-    public synchronized void handleOrchestratorMsg(@Nonnull CorfuPayloadMsg<OrchestratorMsg> msg,\n-                                                   @Nonnull ChannelHandlerContext ctx,\n-                                                   @Nonnull IServerRouter r) {\n-        log.debug(\"Received an orchestrator message {}\", msg);\n-        orchestrator.handle(msg, ctx, r);\n+    @RequestHandler(type = PayloadCase.ORCHESTRATOR_REQUEST)\n+    public synchronized void handleOrchestratorMsg(RequestMsg req, ChannelHandlerContext ctx, IServerRouter r) {\n+        log.debug(\"handleOrchestratorMsg: message:{}\", req.getPayload().getOrchestratorRequest());\n+        orchestrator.handle(req, ctx, r);\n     }\n \n     /**\n      * Bootstraps the management server.\n-     * The msg contains the layout to be bootstrapped.\n+     * The msg contains the Layout to be bootstrapped with.\n      *\n-     * @param msg corfu message containing MANAGEMENT_BOOTSTRAP_REQUEST\n-     * @param ctx netty ChannelHandlerContext\n-     * @param r   server router\n+     * @param req  a message containing a BOOTSTRAP_MANAGEMENT request\n+     * @param ctx  the netty ChannelHandlerContext\n+     * @param r    the server router\n      */\n-    @ServerHandler(type = CorfuMsgType.MANAGEMENT_BOOTSTRAP_REQUEST)\n-    public synchronized void handleManagementBootstrap(CorfuPayloadMsg<Layout> msg,\n-                                                       ChannelHandlerContext ctx, IServerRouter r) {\n-        if (serverContext.getManagementLayout() != null) {\n-            // We are already bootstrapped, bootstrap again is not allowed.\n-            log.warn(\"handleManagementBootstrap: Got a request to bootstrap a server \" +\n-                    \"with {} which is already bootstrapped, rejecting!\", msg.getPayload());\n-            r.sendResponse(ctx, msg, new CorfuMsg(CorfuMsgType.MANAGEMENT_ALREADY_BOOTSTRAP_ERROR));\n+    @RequestHandler(type = PayloadCase.BOOTSTRAP_MANAGEMENT_REQUEST)\n+    public synchronized void handleBootstrapManagement(RequestMsg req, ChannelHandlerContext ctx, IServerRouter r) {\n+        final Layout layout = getLayout(req.getPayload().getBootstrapManagementRequest().getLayout());\n+        HeaderMsg responseHeader;\n+        ResponseMsg response;\n+\n+        if (layout == null || layout.getClusterId() == null) {\n+            log.warn(\"handleBootstrapManagement[{}]: Got a request to bootstrap a server with \" +\n+                    \"incomplete layout {}\", req.getHeader().getRequestId(), layout);\n+\n+            responseHeader = getHeaderMsg(req.getHeader(), false, false);\n+            response = getResponseMsg(responseHeader, getBootstrapManagementResponseMsg(false));\n+        } else if (serverContext.getManagementLayout() != null) {\n+            log.warn(\"handleBootstrapManagement[{}]: Got a request to bootstrap a server, with layout \" +", "originalCommit": "9b57ee6e9db2e751de642d841c515dbcb12c0dc5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTcwMzI5NQ==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2827#discussion_r535703295", "bodyText": "Done.", "author": "zfrenette", "createdAt": "2020-12-03T22:50:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTU1MDI5Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTU3MTE3Mg==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2827#discussion_r535571172", "bodyText": "Do we need to differentiate between a management server no bootstrap error and a non-management server bootstrap error? it seems like we used to have two different errors, but they were essentially the same.", "author": "Maithem", "createdAt": "2020-12-03T20:27:54Z", "path": "infrastructure/src/main/java/org/corfudb/infrastructure/ManagementServer.java", "diffHunk": "@@ -203,109 +172,117 @@ private CorfuRuntime getNewCorfuRuntime() {\n         return runtime;\n     }\n \n-    private boolean isBootstrapped(CorfuMsg msg) {\n+    private boolean isBootstrapped(RequestMsg req) {\n         if (serverContext.getManagementLayout() == null) {\n-            log.warn(\"Received message but not bootstrapped! Message={}\", msg);\n+            log.warn(\"Received message but not bootstrapped! Message={}\", req.getHeader());\n             return false;\n         }\n+\n         return true;\n     }\n \n     /**\n      * Forward an orchestrator request to the orchestrator service.\n      *\n-     * @param msg corfu message containing ORCHESTRATOR_REQUEST\n-     * @param ctx netty ChannelHandlerContext\n-     * @param r   server router\n+     * @param req  a message containing an ORCHESTRATOR request\n+     * @param ctx  the netty ChannelHandlerContext\n+     * @param r    the server router\n      */\n-    @ServerHandler(type = CorfuMsgType.ORCHESTRATOR_REQUEST)\n-    public synchronized void handleOrchestratorMsg(@Nonnull CorfuPayloadMsg<OrchestratorMsg> msg,\n-                                                   @Nonnull ChannelHandlerContext ctx,\n-                                                   @Nonnull IServerRouter r) {\n-        log.debug(\"Received an orchestrator message {}\", msg);\n-        orchestrator.handle(msg, ctx, r);\n+    @RequestHandler(type = PayloadCase.ORCHESTRATOR_REQUEST)\n+    public synchronized void handleOrchestratorMsg(RequestMsg req, ChannelHandlerContext ctx, IServerRouter r) {\n+        log.debug(\"handleOrchestratorMsg: message:{}\", req.getPayload().getOrchestratorRequest());\n+        orchestrator.handle(req, ctx, r);\n     }\n \n     /**\n      * Bootstraps the management server.\n-     * The msg contains the layout to be bootstrapped.\n+     * The msg contains the Layout to be bootstrapped with.\n      *\n-     * @param msg corfu message containing MANAGEMENT_BOOTSTRAP_REQUEST\n-     * @param ctx netty ChannelHandlerContext\n-     * @param r   server router\n+     * @param req  a message containing a BOOTSTRAP_MANAGEMENT request\n+     * @param ctx  the netty ChannelHandlerContext\n+     * @param r    the server router\n      */\n-    @ServerHandler(type = CorfuMsgType.MANAGEMENT_BOOTSTRAP_REQUEST)\n-    public synchronized void handleManagementBootstrap(CorfuPayloadMsg<Layout> msg,\n-                                                       ChannelHandlerContext ctx, IServerRouter r) {\n-        if (serverContext.getManagementLayout() != null) {\n-            // We are already bootstrapped, bootstrap again is not allowed.\n-            log.warn(\"handleManagementBootstrap: Got a request to bootstrap a server \" +\n-                    \"with {} which is already bootstrapped, rejecting!\", msg.getPayload());\n-            r.sendResponse(ctx, msg, new CorfuMsg(CorfuMsgType.MANAGEMENT_ALREADY_BOOTSTRAP_ERROR));\n+    @RequestHandler(type = PayloadCase.BOOTSTRAP_MANAGEMENT_REQUEST)\n+    public synchronized void handleBootstrapManagement(RequestMsg req, ChannelHandlerContext ctx, IServerRouter r) {\n+        final Layout layout = getLayout(req.getPayload().getBootstrapManagementRequest().getLayout());\n+        HeaderMsg responseHeader;\n+        ResponseMsg response;\n+\n+        if (layout == null || layout.getClusterId() == null) {\n+            log.warn(\"handleBootstrapManagement[{}]: Got a request to bootstrap a server with \" +\n+                    \"incomplete layout {}\", req.getHeader().getRequestId(), layout);\n+\n+            responseHeader = getHeaderMsg(req.getHeader(), false, false);\n+            response = getResponseMsg(responseHeader, getBootstrapManagementResponseMsg(false));\n+        } else if (serverContext.getManagementLayout() != null) {\n+            log.warn(\"handleBootstrapManagement[{}]: Got a request to bootstrap a server, with layout \" +\n+                    \"{}, which is already bootstrapped... Rejecting!\", req.getHeader().getRequestId(), layout);\n+\n+            responseHeader = getHeaderMsg(req.getHeader(), false, true);\n+            response = getResponseMsg(responseHeader, getBootstrappedErrorMsg());\n         } else {\n-            Layout layout = msg.getPayload();\n-            log.info(\"handleManagementBootstrap: received bootstrap layout : {}\", layout);\n-            if(layout.getClusterId() == null){\n-                log.warn(\"handleManagementBootstrap: clusterId for the layout {} is not present.\",\n-                        layout.getClusterId());\n-                r.sendResponse(ctx, msg, new CorfuMsg(CorfuMsgType.NACK));\n-            }\n-            else{\n-                serverContext.saveManagementLayout(layout);\n-                r.sendResponse(ctx, msg, new CorfuMsg(CorfuMsgType.ACK));\n-            }\n+            log.info(\"handleBootstrapManagement[{}]: Received bootstrap \" +\n+                    \"layout {}\", req.getHeader().getRequestId(), layout);\n+\n+            serverContext.saveManagementLayout(layout);\n+            responseHeader = getHeaderMsg(req.getHeader(), false, true);\n+            response = getResponseMsg(responseHeader, getBootstrapManagementResponseMsg(true));\n         }\n+\n+        r.sendResponse(response, ctx);\n     }\n \n     /**\n      * Triggers the failure handler.\n      * The msg contains the failed/defected nodes.\n      *\n-     * @param msg corfu message containing MANAGEMENT_FAILURE_DETECTED\n-     * @param ctx netty ChannelHandlerContext\n-     * @param r   server router\n+     * @param req  a message containing a REPORT_FAILURE request\n+     * @param ctx  the netty ChannelHandlerContext\n+     * @param r    the server router\n      */\n-    @ServerHandler(type = CorfuMsgType.MANAGEMENT_FAILURE_DETECTED)\n-    public void handleFailureDetectedMsg(CorfuPayloadMsg<DetectorMsg> msg,\n-                                         ChannelHandlerContext ctx, IServerRouter r) {\n-\n-        // This server has not been bootstrapped yet, ignore all requests.\n-        if (!isBootstrapped(msg)) {\n-            r.sendResponse(ctx, msg, new CorfuMsg(CorfuMsgType.MANAGEMENT_NOBOOTSTRAP_ERROR));\n+    @RequestHandler(type = PayloadCase.REPORT_FAILURE_REQUEST)\n+    public void handleReportFailure(RequestMsg req, ChannelHandlerContext ctx, IServerRouter r) {\n+        // If the server isn't bootstrapped yet, ignore the request\n+        if (!isBootstrapped(req)) {\n+            r.sendNoBootstrapError(req.getHeader(), ctx);", "originalCommit": "9b57ee6e9db2e751de642d841c515dbcb12c0dc5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTU4Nzc5Mw==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2827#discussion_r535587793", "bodyText": "I haven't seen a need to. The same exception was thrown in both cases. The only difference now is that this is handled by BaseHandler.", "author": "zfrenette", "createdAt": "2020-12-03T20:42:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTU3MTE3Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTU4MTM5OQ==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2827#discussion_r535581399", "bodyText": "Why is this missing from the PR?", "author": "Maithem", "createdAt": "2020-12-03T20:37:15Z", "path": "infrastructure/src/main/java/org/corfudb/infrastructure/ManagementServer.java", "diffHunk": "@@ -411,23 +399,19 @@ public void handleHealingDetectedMsg(CorfuPayloadMsg<DetectorMsg> msg,\n      * Default NodeState has been providing unless the node is not bootstrapped.\n      * Failure detector updates ClusterNodeState by current state then current NodeState can be provided to other nodes.\n      *\n-     * @param msg corfu message containing NODE_STATE_REQUEST\n-     * @param ctx netty ChannelHandlerContext\n-     * @param r server router\n+     * @param req  a message containing a QUERY_NODE request\n+     * @param ctx  the netty ChannelHandlerContext\n+     * @param r    the server router\n      */\n-    @ServerHandler(type = CorfuMsgType.NODE_STATE_REQUEST)\n-    public void handleNodeStateRequest(CorfuMsg msg, ChannelHandlerContext ctx, IServerRouter r) {\n+    @RequestHandler(type = PayloadCase.QUERY_NODE_REQUEST)\n+    public void handleQueryNode(RequestMsg req, ChannelHandlerContext ctx, IServerRouter r) {\n         NodeState nodeState = clusterContext.getClusterView()\n                 .getNode(serverContext.getLocalEndpoint())\n                 .orElseGet(this::buildDefaultNodeState);\n \n-        r.sendResponse(ctx, msg, CorfuMsgType.NODE_STATE_RESPONSE.payloadMsg(nodeState));\n-    }\n-\n-    @ServerHandler(type = CorfuMsgType.FAILURE_DETECTOR_METRICS_REQUEST)\n-    public void handleFailureDetectorMetricsRequest(CorfuMsg msg, ChannelHandlerContext ctx, IServerRouter r) {\n-        FailureDetectorMetrics metrics = serverContext.getFailureDetectorMetrics();\n-        r.sendResponse(ctx, msg, CorfuMsgType.FAILURE_DETECTOR_METRICS_RESPONSE.payloadMsg(metrics));", "originalCommit": "9b57ee6e9db2e751de642d841c515dbcb12c0dc5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTU4MzY0MA==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2827#discussion_r535583640", "bodyText": "It isn't currently being used anywhere and hasn't been enabled in a year. I spoke with @xnull and it seems fine to remove.", "author": "zfrenette", "createdAt": "2020-12-03T20:39:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTU4MTM5OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTU4OTcxOA==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2827#discussion_r535589718", "bodyText": "Why can't we explicitly fail this, or log?\nAlso, what if the thread was interrupted, swallowing all exceptions might cause problems, like \"hanging\".", "author": "Maithem", "createdAt": "2020-12-03T20:44:43Z", "path": "infrastructure/src/main/java/org/corfudb/infrastructure/logreplication/runtime/LogReplicationClientRouter.java", "diffHunk": "@@ -144,11 +144,15 @@ public IClientRouter addClient(IClient client) {\n         client.setRouter(this);\n \n         // Iterate through all types of CorfuMsgType, registering the handler\n-        client.getHandledTypes().stream()\n-                .forEach(x -> {\n-                    handlerMap.put(x, client);\n-                    log.info(\"Registered client to handle messages of type {}\", x);\n-                });\n+        try {\n+            client.getHandledTypes().stream()\n+                    .forEach(x -> {\n+                        handlerMap.put(x, client);\n+                        log.info(\"Registered client to handle messages of type {}\", x);\n+                    });\n+        } catch (Exception ex) {\n+            // No Legacy getHandledTypes - Ignore", "originalCommit": "9b57ee6e9db2e751de642d841c515dbcb12c0dc5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTU5NDE2MQ==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2827#discussion_r535594161", "bodyText": "We don't want to fail the creation of the router just because a particular client (or server in the case of a server-side router) doesn't implement a legacy message handler. If it doesn't, we simply want to continue on since it isn't a sign that something has gone wrong. I can add a log message saying that a particular client or server doesn't support the handling of old messages.", "author": "zfrenette", "createdAt": "2020-12-03T20:48:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTU4OTcxOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTcwMzYyNw==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2827#discussion_r535703627", "bodyText": "Added the appropriate logging statement.", "author": "zfrenette", "createdAt": "2020-12-03T22:50:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTU4OTcxOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTU5MjU5NQ==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2827#discussion_r535592595", "bodyText": "This can be replaced with the getExecutor helper methods in server context, right?", "author": "Maithem", "createdAt": "2020-12-03T20:47:21Z", "path": "infrastructure/src/main/java/org/corfudb/infrastructure/orchestrator/Orchestrator.java", "diffHunk": "@@ -69,70 +75,73 @@\n \n     final ExecutorService executor;\n \n+    final WorkflowFactory workflowFactory;\n+\n     public Orchestrator(@Nonnull SingletonResource<CorfuRuntime> runtime,\n-                        @Nonnull ServerContext serverContext) {\n+                        @Nonnull ServerContext serverContext,\n+                        @Nonnull WorkflowFactory workflowFactory) {\n         this.serverContext = serverContext;\n-        this.getRuntime = runtime;\n-\n-        executor = Executors.newFixedThreadPool(Runtime.getRuntime()\n-                .availableProcessors(), new ThreadFactory() {\n-\n-            final AtomicInteger threadNumber = new AtomicInteger(0);\n-\n-            @Override\n-            public Thread newThread(Runnable r) {\n-                Thread thread = new Thread(r);\n-                thread.setDaemon(true);\n-                String threadName = serverContext.getThreadPrefix() + \"orchestrator-\"\n-                        + threadNumber.getAndIncrement();\n-                thread.setName(threadName);\n-                thread.setUncaughtExceptionHandler(this::handleUncaughtException);\n-                return thread;\n-            }\n+        this.workflowFactory = workflowFactory;\n+        getRuntime = runtime;\n \n-            void handleUncaughtException(Thread t, @Nonnull Throwable e) {\n-                log.error(\"handleUncaughtException[{}]: Uncaught {}:{}\",\n-                        t.getName(),\n-                        e.getClass().getSimpleName(),\n-                        e.getMessage(),\n-                        e);\n-            }\n-        });\n-    }\n+        executor = serverContext.getExecutorService(Runtime.getRuntime().availableProcessors(),\n+                new ThreadFactory() {\n+\n+                    final AtomicInteger threadNumber = new AtomicInteger(0);\n \n-    public void handle(@Nonnull CorfuPayloadMsg<OrchestratorMsg> msg,\n-                       @Nonnull ChannelHandlerContext ctx,\n-                       @Nonnull IServerRouter r) {\n+                    @Override\n+                    public Thread newThread(Runnable r) {\n+                        Thread thread = new Thread(r);\n+                        thread.setDaemon(true);\n+                        String threadName = serverContext.getThreadPrefix() + \"orchestrator-\"\n+                                + threadNumber.getAndIncrement();\n+                        thread.setName(threadName);\n+                        thread.setUncaughtExceptionHandler(this::handleUncaughtException);\n+                        return thread;\n+                    }\n+\n+                    void handleUncaughtException(Thread t, @Nonnull Throwable e) {", "originalCommit": "9b57ee6e9db2e751de642d841c515dbcb12c0dc5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTU5NjY4Mg==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2827#discussion_r535596682", "bodyText": "Can you clarify? The getExecutor helper method is indeed being called on line 87.", "author": "zfrenette", "createdAt": "2020-12-03T20:51:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTU5MjU5NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTU5NDU2Mw==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2827#discussion_r535594563", "bodyText": "Danger. Always use curly braces.\nhttps://www.imperialviolet.org/2014/02/22/applebug.html", "author": "Maithem", "createdAt": "2020-12-03T20:49:09Z", "path": "infrastructure/src/main/java/org/corfudb/infrastructure/orchestrator/Orchestrator.java", "diffHunk": "@@ -142,24 +151,22 @@ public void handle(@Nonnull CorfuPayloadMsg<OrchestratorMsg> msg,\n      * Queries a workflow id and returns true if this orchestrator is still\n      * executing the workflow, otherwise return false.\n      *\n-     * @param msg corfu message containing the query request\n-     * @param ctx netty ChannelHandlerContext\n-     * @param r   server router\n+     * @param req  a message containing the query request\n+     * @param ctx  the netty ChannelHandlerContext\n+     * @param r    the server router\n      */\n-    void query(CorfuPayloadMsg<OrchestratorMsg> msg, ChannelHandlerContext ctx, IServerRouter r) {\n-        QueryRequest req = (QueryRequest) msg.getPayload().getRequest();\n+    void handleQuery(@Nonnull RequestMsg req, @Nonnull ChannelHandlerContext ctx, @Nonnull IServerRouter r) {\n+        final UUID workflowId = getUUID(req.getPayload().getOrchestratorRequest().getQuery().getWorkflowId());\n+        boolean isActive = false;\n \n-        Response resp;\n-        if (activeWorkflows.containsKey(req.getId())) {\n-            resp = new QueryResponse(true);\n-            log.trace(\"handleQuery: returning active for id {}\", req.getId());\n-        } else {\n-            resp = new QueryResponse(false);\n-            log.trace(\"handleQuery: returning not active for id {}\", req.getId());\n-        }\n+        if (activeWorkflows.containsKey(workflowId)) isActive = true;", "originalCommit": "9b57ee6e9db2e751de642d841c515dbcb12c0dc5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTcwMzg4OA==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2827#discussion_r535703888", "bodyText": "Fixed.", "author": "zfrenette", "createdAt": "2020-12-03T22:51:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTU5NDU2Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTU5ODI0MA==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2827#discussion_r535598240", "bodyText": "Can we drop the \"Corfu\" prefix from the naming convention here, I feel like its superfluous.  Why don't you just replace the tests in ManagementServerTest?", "author": "Maithem", "createdAt": "2020-12-03T20:52:25Z", "path": "infrastructure/src/test/java/org/corfudb/infrastructure/CorfuManagementServerTest.java", "diffHunk": "@@ -0,0 +1,645 @@\n+package org.corfudb.infrastructure;\n+\n+import com.google.common.util.concurrent.MoreExecutors;", "originalCommit": "9b57ee6e9db2e751de642d841c515dbcb12c0dc5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTcwNDQzMQ==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2827#discussion_r535704431", "bodyText": "I removed the \"Corfu\" prefix from our tests, but prefer to also leave the old tests there for the time being.", "author": "zfrenette", "createdAt": "2020-12-03T22:51:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTU5ODI0MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTYwNzkyOQ==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2827#discussion_r535607929", "bodyText": "Is it possible to collapse the CreateRequest and Request interfaces?", "author": "Maithem", "createdAt": "2020-12-03T20:59:17Z", "path": "runtime/src/main/java/org/corfudb/protocols/wireprotocol/orchestrator/HealNodeRequest.java", "diffHunk": "@@ -1,14 +1,8 @@\n package org.corfudb.protocols.wireprotocol.orchestrator;\n \n-import static org.corfudb.protocols.wireprotocol.orchestrator.OrchestratorRequestType.HEAL_NODE;\n-\n-import java.nio.charset.StandardCharsets;\n-import java.util.HashMap;\n-import java.util.Map;\n-\n import lombok.Getter;\n \n-import org.corfudb.util.JsonUtils;\n+import static org.corfudb.protocols.wireprotocol.orchestrator.OrchestratorRequestType.HEAL_NODE;", "originalCommit": "9b57ee6e9db2e751de642d841c515dbcb12c0dc5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTcwNDUzOQ==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2827#discussion_r535704539", "bodyText": "Done!", "author": "zfrenette", "createdAt": "2020-12-03T22:52:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTYwNzkyOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTYzMTQwOQ==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2827#discussion_r535631409", "bodyText": "instead catching all exceptions can you just ignore unsupported operation and log it?\nAlso, why was this not an issue when we pushed in the new BaseServer changes?", "author": "Maithem", "createdAt": "2020-12-03T21:19:05Z", "path": "runtime/src/main/java/org/corfudb/runtime/clients/NettyClientRouter.java", "diffHunk": "@@ -284,11 +284,15 @@ public IClientRouter addClient(IClient client) {\n         client.setRouter(this);\n \n         // Iterate through all types of CorfuMsgType, registering the handler\n-        client.getHandledTypes()\n-                .forEach(x -> {\n-                    handlerMap.put(x, client);\n-                    log.trace(\"Registered {} to handle messages of type {}\", client, x);\n-                });\n+        try {\n+            client.getHandledTypes()\n+                    .forEach(x -> {\n+                        handlerMap.put(x, client);\n+                        log.trace(\"Registered {} to handle messages of type {}\", client, x);\n+                    });\n+        } catch (Exception ex) {\n+            // No Legacy getHandledTypes - Ignore\n+        }", "originalCommit": "9b57ee6e9db2e751de642d841c515dbcb12c0dc5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTYzMzQ1NA==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2827#discussion_r535633454", "bodyText": "Will log and catch UnsupportedOperation. It was an issue for the BaseServer, but not for the BaseHandler because there were still some old CorfuMsg types that needed to be handled by it. Since it wasn't removed, no exception was thrown.", "author": "zfrenette", "createdAt": "2020-12-03T21:21:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTYzMTQwOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTcwNTg1OQ==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2827#discussion_r535705859", "bodyText": "Fixed. Only catching UnsupportedOperation and logging accordingly.", "author": "zfrenette", "createdAt": "2020-12-03T22:53:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTYzMTQwOQ=="}], "type": "inlineReview"}, {"oid": "bf4eee30f4245b8005c018c733f126e482a074b7", "url": "https://github.com/CorfuDB/CorfuDB/commit/bf4eee30f4245b8005c018c733f126e482a074b7", "message": "Add Implementation of Management RPCs using Protobuf\n\nProvides routing support for Protobuf messages and an implementation of Management\nRPCs using Protobuf messages. Done as part of an effort to support rolling upgrades.", "committedDate": "2020-12-03T22:47:55Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTg5NTc2MA==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2827#discussion_r535895760", "bodyText": "log.error() with the exception too? This might be one of the things we would need to handle for rolling upgrade in the future, if a client message arrives that does not have any registered handler right, so perhaps a comment or TODO for the same?", "author": "hisundar", "createdAt": "2020-12-04T07:41:28Z", "path": "infrastructure/src/main/java/org/corfudb/infrastructure/logreplication/runtime/LogReplicationClientRouter.java", "diffHunk": "@@ -144,11 +144,15 @@ public IClientRouter addClient(IClient client) {\n         client.setRouter(this);\n \n         // Iterate through all types of CorfuMsgType, registering the handler\n-        client.getHandledTypes().stream()\n-                .forEach(x -> {\n-                    handlerMap.put(x, client);\n-                    log.info(\"Registered client to handle messages of type {}\", x);\n-                });\n+        try {\n+            client.getHandledTypes().stream()\n+                    .forEach(x -> {\n+                        handlerMap.put(x, client);\n+                        log.info(\"Registered client to handle messages of type {}\", x);\n+                    });\n+        } catch (UnsupportedOperationException ex) {\n+            log.warn(\"No registered CorfuMsg handler for client {}\", client);", "originalCommit": "bf4eee30f4245b8005c018c733f126e482a074b7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjEyMTgyMw==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2827#discussion_r536121823", "bodyText": "I have adjusted the logging as suggested, but I want to point out that this is for legacy CorfuMsg handlers. The default behavior of these legacy methods is to throw an exception when invoked but not implemented, and will be cleaned up in the last PR once all RPCs are done over Protobuf.", "author": "zfrenette", "createdAt": "2020-12-04T14:04:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTg5NTc2MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjMwODkyMA==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2827#discussion_r536308920", "bodyText": "sounds good", "author": "hisundar", "createdAt": "2020-12-04T18:53:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTg5NTc2MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTg5NTk1Mw==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2827#discussion_r535895953", "bodyText": "log.error with the exception perhaps?", "author": "hisundar", "createdAt": "2020-12-04T07:41:51Z", "path": "infrastructure/src/main/java/org/corfudb/infrastructure/logreplication/runtime/LogReplicationServerRouter.java", "diffHunk": "@@ -71,7 +71,7 @@ public LogReplicationServerRouter(List<AbstractServer> servers) {\n             try {\n                 server.getHandler().getHandledTypes().forEach(x -> handlerMap.put(x, server));\n             } catch (UnsupportedOperationException ex) {\n-                // Ignore\n+                log.warn(\"No registered CorfuMsg handler for server {}\", server);", "originalCommit": "bf4eee30f4245b8005c018c733f126e482a074b7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjEyMjA0Nw==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2827#discussion_r536122047", "bodyText": "Done!", "author": "zfrenette", "createdAt": "2020-12-04T14:04:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTg5NTk1Mw=="}], "type": "inlineReview"}, {"oid": "555130b064a8a3b62ccfcc22139aafa7ebdaae59", "url": "https://github.com/CorfuDB/CorfuDB/commit/555130b064a8a3b62ccfcc22139aafa7ebdaae59", "message": "Add Implementation of Management RPCs using Protobuf\n\nProvides routing support for Protobuf messages and an implementation of Management\nRPCs using Protobuf messages. Done as part of an effort to support rolling upgrades.", "committedDate": "2020-12-04T14:00:07Z", "type": "commit"}, {"oid": "555130b064a8a3b62ccfcc22139aafa7ebdaae59", "url": "https://github.com/CorfuDB/CorfuDB/commit/555130b064a8a3b62ccfcc22139aafa7ebdaae59", "message": "Add Implementation of Management RPCs using Protobuf\n\nProvides routing support for Protobuf messages and an implementation of Management\nRPCs using Protobuf messages. Done as part of an effort to support rolling upgrades.", "committedDate": "2020-12-04T14:00:07Z", "type": "forcePushed"}]}