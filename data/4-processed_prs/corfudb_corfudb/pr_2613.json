{"pr_number": 2613, "pr_title": "Flush Async Logger on Exit", "pr_createdAt": "2020-07-10T08:18:25Z", "pr_url": "https://github.com/CorfuDB/CorfuDB/pull/2613", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDUwMDg4OQ==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2613#discussion_r454500889", "bodyText": "Why do you need a local variable for this?", "author": "xiaoqin2012", "createdAt": "2020-07-14T16:53:27Z", "path": "infrastructure/src/main/java/org/corfudb/infrastructure/CorfuServer.java", "diffHunk": "@@ -346,7 +347,18 @@ static void restartServer(boolean resetData) {\n     private static void cleanShutdown() {\n         log.info(\"CleanShutdown: Starting Cleanup.\");\n         shutdownServer = true;\n-        activeServer.close();\n+        try {\n+            CorfuServerNode current = activeServer;", "originalCommit": "95e7e150cfab0df62b25eb3912206dc43bd2933c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDUzNzc1Nw==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2613#discussion_r454537757", "bodyText": "activeServer is a volatile and can be re-assigned by multiple threads.", "author": "Maithem", "createdAt": "2020-07-14T17:53:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDUwMDg4OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDU3NjI5NQ==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2613#discussion_r454576295", "bodyText": "This doesn't help at all, I suspect it can even cause loss of the logs.\nLogback already have solved the problem, and we have it enabled \n  \n    \n      CorfuDB/infrastructure/src/main/resources/logback.prod.xml\n    \n    \n         Line 5\n      in\n      30c8d15\n    \n    \n    \n    \n\n        \n          \n           <shutdownHook/>", "author": "xnull", "createdAt": "2020-07-14T18:59:12Z", "path": "infrastructure/src/main/java/org/corfudb/infrastructure/CorfuServer.java", "diffHunk": "@@ -346,7 +347,18 @@ static void restartServer(boolean resetData) {\n     private static void cleanShutdown() {\n         log.info(\"CleanShutdown: Starting Cleanup.\");\n         shutdownServer = true;\n-        activeServer.close();\n+        try {\n+            CorfuServerNode current = activeServer;\n+            if (current != null) {\n+                activeServer.close();\n+            }\n+        } catch (Throwable th) {\n+            log.error(\"cleanShutdown: failed during shutdown\", th);\n+        }\n+\n+        // Flush the async appender before exiting to prevent the loss of logs\n+        LoggerContext loggerContext = (LoggerContext) LoggerFactory.getILoggerFactory();", "originalCommit": "95e7e150cfab0df62b25eb3912206dc43bd2933c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDcwODA5Mw==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2613#discussion_r454708093", "bodyText": "This is not the Matrix, but things are not what they seem to be.\nThe shutdown hook configuration added in #2049 is malformed and actually doesn't register a hook that stops the logger's context on shutdown. This is true despite what logback's documentation says, it might be outdated, there might be a bug, or it might just be inaccurate. At least for version 1.2.3 it doesn't work.\nFor a shutdown hook to be called, a shutdown thread must be registered with Runtime.getRuntime().addShutdownHook for it to be executed. If you run the server and collect a heap dump, you can inspect all the shutdown hooks registered and you won't see any hooks registered by logback. This means that the logger context is not being stopped properly on shutdown, which explains some of the log loss I've seen debugging a couple of bugs.\nNow even if that configuration works, its not the best way of implementing \"shutdown\" logic for a logger because there is no order on shutdown hooks. This means that logging statements produced during the execution of the shutdown hook can be lost this is due to an undefined execution order of the hooks. If the logback shutdown hook is executed first  then subsequent logs will be lost from other hooks.\nIf you are not convinced, then you can inspect logback's source code here: https://github.com/qos-ch/logback/blob/a154cd1b564d436c90a26b8cb1a2e8ffff0a4a47/logback-core/src/main/java/ch/qos/logback/core/joran/action/ShutdownHookAction.java#L46\nIf you inspect the code snippet I linked you'll see that it tries to find a class attribute, but fails to do so (because it doesn't exist). This means that even the \"default\" hook isn't being registered.\nFurthermore, the documentation you link about the default hook is incorrect, if you checkout logback's code base version 1.2.3 you'll see that a DefaultShutdownHook type doesn't even exist.\nFinally, to fix the configuration bug introduced in #2049  the class and full type path must be supplied. For example, the correct configuration for installing a default hook would be\n<shutdownHook class=\"ch.qos.logback.core.hook.DelayingShutdownHook\"/>\nAnyways, I think this PR fixes an existing problem on master and improves logging in general (via explicit shutdown ordering) and I think we should go forward with it.", "author": "Maithem", "createdAt": "2020-07-14T23:45:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDU3NjI5NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDcyMjM1Mg==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2613#discussion_r454722352", "bodyText": "So,\n\nlet's add DelayingShutdownHook or any other class that is required to the shutdownHook?\nwhat I see from source code is all the hooks are run in parallel, which means no hooks wait for each other. If you do not shutdown JVM then no reason for shutting down the logger. If the JVM gonna fail you will lose your logs, either way, it doesn't matter if you shutdown it by a hook or explicitly in your code, the effect will be the same.\n\nI still don't see the motivation for adding the code that shouldn't be added. because we have a solution provided by the library of the box.\nThat's great if you found a misconfiguration bug in the config, let's fix the config?", "author": "xnull", "createdAt": "2020-07-15T00:36:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDU3NjI5NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDczMTAzMw==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2613#discussion_r454731033", "bodyText": "I still don't see the motivation for adding the code that shouldn't be added\n\nPlease read my response again.\nEven if you ignore the logback bug, the PR doesn't re-implement the \"out-of-box\" behavior. This PR adds execution order which I already describe in detail.\n\nhooks are run in parallel, which means no hooks wait for each other.\n\nI never claimed that. I explicitly mention undefined execution order , which is the whole point of having one hook and having serial order, as opposed to having two hooks and no order.", "author": "Maithem", "createdAt": "2020-07-15T01:09:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDU3NjI5NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDczNDYzOA==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2613#discussion_r454734638", "bodyText": "Ok, I see your point", "author": "xnull", "createdAt": "2020-07-15T01:21:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDU3NjI5NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDcyNzc4Nw==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2613#discussion_r454727787", "bodyText": "it has to be current  instead of activeServer", "author": "xnull", "createdAt": "2020-07-15T00:56:46Z", "path": "infrastructure/src/main/java/org/corfudb/infrastructure/CorfuServer.java", "diffHunk": "@@ -346,7 +347,18 @@ static void restartServer(boolean resetData) {\n     private static void cleanShutdown() {\n         log.info(\"CleanShutdown: Starting Cleanup.\");\n         shutdownServer = true;\n-        activeServer.close();\n+        try {\n+            CorfuServerNode current = activeServer;\n+            if (current != null) {\n+                activeServer.close();", "originalCommit": "95e7e150cfab0df62b25eb3912206dc43bd2933c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDg0MTE2NQ==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2613#discussion_r454841165", "bodyText": "Yep.", "author": "Maithem", "createdAt": "2020-07-15T07:15:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDcyNzc4Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDcyODQ2NA==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2613#discussion_r454728464", "bodyText": "what about - replace volatile by AtomicReference? Then your code will be cleaner, no need for checking for null and bringing additional mental complexity to the code?", "author": "xnull", "createdAt": "2020-07-15T00:59:20Z", "path": "infrastructure/src/main/java/org/corfudb/infrastructure/CorfuServer.java", "diffHunk": "@@ -346,7 +347,18 @@ static void restartServer(boolean resetData) {\n     private static void cleanShutdown() {\n         log.info(\"CleanShutdown: Starting Cleanup.\");\n         shutdownServer = true;\n-        activeServer.close();\n+        try {\n+            CorfuServerNode current = activeServer;", "originalCommit": "95e7e150cfab0df62b25eb3912206dc43bd2933c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDcyOTY4MA==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2613#discussion_r454729680", "bodyText": "Ok, looks like AtomicReference doesn't have good API for that. Nevermind", "author": "xnull", "createdAt": "2020-07-15T01:03:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDcyODQ2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDg0MTM5Nw==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2613#discussion_r454841397", "bodyText": "Ok.", "author": "Maithem", "createdAt": "2020-07-15T07:15:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDcyODQ2NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDczNzgxOA==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2613#discussion_r454737818", "bodyText": "Should we remove this line: https://github.com/CorfuDB/CorfuDB/blob/master/infrastructure/src/main/resources/logback.prod.xml#L5 , since we are doing it elsewhere and it's missing class name as well?", "author": "WenbinZhu", "createdAt": "2020-07-15T01:33:41Z", "path": "infrastructure/src/main/resources/logback.prod.xml", "diffHunk": "@@ -27,6 +27,7 @@\n     <appender name=\"async_file\" class=\"ch.qos.logback.classic.AsyncAppender\">\n         <appender-ref ref=\"file\" />\n         <queueSize>1024</queueSize>\n+        <maxFlushTime>5000</maxFlushTime>", "originalCommit": "95e7e150cfab0df62b25eb3912206dc43bd2933c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDg0MDUwNg==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2613#discussion_r454840506", "bodyText": "Yep, I think we should keep maxFlushTime", "author": "Maithem", "createdAt": "2020-07-15T07:13:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDczNzgxOA=="}], "type": "inlineReview"}, {"oid": "ad3026b915e39d6d20363d99d88800f0fec2f2aa", "url": "https://github.com/CorfuDB/CorfuDB/commit/ad3026b915e39d6d20363d99d88800f0fec2f2aa", "message": "Flush Async Logger on Exit\n\nIf not flushed, some crucial logs can be lost. This patch\nintroduces an explicit flush that will be called during\nthe execution of the shutdown hook.", "committedDate": "2020-07-15T07:16:36Z", "type": "commit"}, {"oid": "ad3026b915e39d6d20363d99d88800f0fec2f2aa", "url": "https://github.com/CorfuDB/CorfuDB/commit/ad3026b915e39d6d20363d99d88800f0fec2f2aa", "message": "Flush Async Logger on Exit\n\nIf not flushed, some crucial logs can be lost. This patch\nintroduces an explicit flush that will be called during\nthe execution of the shutdown hook.", "committedDate": "2020-07-15T07:16:36Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTQ1MTEyNw==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2613#discussion_r455451127", "bodyText": "In the best case would be great to get rid of a volatile variable completely. Probably next time", "author": "xnull", "createdAt": "2020-07-16T01:09:01Z", "path": "infrastructure/src/main/java/org/corfudb/infrastructure/CorfuServer.java", "diffHunk": "@@ -346,7 +347,18 @@ static void restartServer(boolean resetData) {\n     private static void cleanShutdown() {\n         log.info(\"CleanShutdown: Starting Cleanup.\");\n         shutdownServer = true;\n-        activeServer.close();\n+        try {\n+            CorfuServerNode current = activeServer;\n+            if (current != null) {\n+                current.close();", "originalCommit": "ad3026b915e39d6d20363d99d88800f0fec2f2aa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTQ1MjIyNw==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2613#discussion_r455452227", "bodyText": "I'm planning to get rid of CorfuServerNode its unnecessarily complex, with that the volatile will disappear.", "author": "Maithem", "createdAt": "2020-07-16T01:13:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTQ1MTEyNw=="}], "type": "inlineReview"}]}