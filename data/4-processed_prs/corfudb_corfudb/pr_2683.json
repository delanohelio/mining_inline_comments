{"pr_number": 2683, "pr_title": "Standby Connection Loss Fix", "pr_createdAt": "2020-08-05T21:43:50Z", "pr_url": "https://github.com/CorfuDB/CorfuDB/pull/2683", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjAzMzY0OQ==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2683#discussion_r466033649", "bodyText": "What is the original value? The monitoring can be smaller so that when the lease expires, the other waiters can get hold of the lease quickly.", "author": "xiaoqin2012", "createdAt": "2020-08-05T22:13:10Z", "path": "utils/src/main/java/org/corfudb/utils/lock/LockClient.java", "diffHunk": "@@ -48,9 +48,13 @@\n     // single threaded scheduler to monitor locks\n     private final ScheduledExecutorService lockMonitorScheduler;\n \n+    private final ScheduledExecutorService taskScheduler;\n+\n+    private final ExecutorService lockListenerExecutor;\n+\n     // duration between monitoring runs\n     @Setter\n-    private static int DurationBetweenLockMonitorRuns = 60;\n+    private static int DurationBetweenLockMonitorRuns = 30;", "originalCommit": "381e320c2747d07a1b890e41e1c90cad8f4e1738", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjA0OTEyNA==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2683#discussion_r466049124", "bodyText": "The original lease value is 60seconds, to 10 maybe?", "author": "annym", "createdAt": "2020-08-05T22:57:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjAzMzY0OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjAzNjg4Mg==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2683#discussion_r466036882", "bodyText": "Can we make the monitor fraction bigger such as 10 or 20, so that the lease acquire/release can happen with smaller delay?", "author": "xiaoqin2012", "createdAt": "2020-08-05T22:22:09Z", "path": "infrastructure/src/main/java/org/corfudb/infrastructure/logreplication/infrastructure/CorfuReplicationDiscoveryService.java", "diffHunk": "@@ -52,6 +54,16 @@\n      */\n     private static final int FETCH_THRESHOLD = 300;\n \n+    /**\n+     * Fraction of Lease Duration for Lease Renewal\n+     */\n+    private static final int RENEWAL_LEASE_FRACTION = 4;\n+\n+    /**\n+     * Fraction of Lease Duration for Lease Monitoring\n+     */\n+    private static final int MONITOR_LEASE_FRACTION = 2;\n+", "originalCommit": "381e320c2747d07a1b890e41e1c90cad8f4e1738", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjAzNzA2MA==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2683#discussion_r466037060", "bodyText": "is it better to rename to lockClient?", "author": "pankti-m", "createdAt": "2020-08-05T22:22:40Z", "path": "infrastructure/src/main/java/org/corfudb/infrastructure/logreplication/infrastructure/CorfuReplicationDiscoveryService.java", "diffHunk": "@@ -131,6 +143,8 @@\n \n     private LogReplicationServer logReplicationServerHandler;\n \n+    private LockClient lock;", "originalCommit": "381e320c2747d07a1b890e41e1c90cad8f4e1738", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjAzNzYzNA==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2683#discussion_r466037634", "bodyText": "Will it cleaner to call lock.shutdown in the server shutdown call?", "author": "xiaoqin2012", "createdAt": "2020-08-05T22:24:14Z", "path": "infrastructure/src/main/java/org/corfudb/infrastructure/logreplication/infrastructure/CorfuReplicationDiscoveryService.java", "diffHunk": "@@ -704,6 +720,10 @@ public void shutdown() {\n         if(clusterManagerAdapter != null) {\n             clusterManagerAdapter.shutdown();\n         }\n+\n+        if (lock != null) {", "originalCommit": "381e320c2747d07a1b890e41e1c90cad8f4e1738", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjA1MDc3OQ==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2683#discussion_r466050779", "bodyText": "That would mean exposing it. And the lock is really created by the Discovery Service, I think keeping it to the DiscoveryService scope is fine.", "author": "annym", "createdAt": "2020-08-05T23:02:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjAzNzYzNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjA0NDM5NA==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2683#discussion_r466044394", "bodyText": "When will this callback be called? Which component detects the connection down?", "author": "xiaoqin2012", "createdAt": "2020-08-05T22:43:55Z", "path": "infrastructure/src/main/java/org/corfudb/infrastructure/logreplication/runtime/LogReplicationClientRouter.java", "diffHunk": "@@ -413,7 +413,8 @@ public synchronized void onConnectionUp(String endpoint) {\n      */", "originalCommit": "381e320c2747d07a1b890e41e1c90cad8f4e1738", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjA1MDkyOQ==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2683#discussion_r466050929", "bodyText": "The Transport Plugin is the one detecting connections coming up or down.", "author": "annym", "createdAt": "2020-08-05T23:03:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjA0NDM5NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjA1MzczNg==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2683#discussion_r466053736", "bodyText": "I am just wondering what happen to the snapshot sender/log entry sender  when there is a connection loss and what happen to the fsm state machine.", "author": "xiaoqin2012", "createdAt": "2020-08-05T23:11:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjA0NDM5NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjA2MjQ2OQ==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2683#discussion_r466062469", "bodyText": "Currently, what happens is that if connection is lost to the remote leader we move to verify remote leader state (if any other connection is still up) or to wait for connections (if no connection is available). But we don't do anything to the snapshot/log entry senders. So good point, this is something we should add. I'm adding that we stop log replication, can you help confirm if that does the correct configuration of the snapshot/log entry sender? or if something else is needed...", "author": "annym", "createdAt": "2020-08-05T23:38:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjA0NDM5NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjA2NTk0OQ==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2683#discussion_r466065949", "bodyText": "I saw that the sender catch all exceptions and called cancel.  There are two options:\n\nthe sender identify the exception type and generate stop event instead of cancel.\nwhen the replication state machine detects the current leader connection loss, put a stop event for FSM.", "author": "xiaoqin2012", "createdAt": "2020-08-05T23:50:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjA0NDM5NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjA2NjAzOQ==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2683#discussion_r466066039", "bodyText": "We can do in another PR ...", "author": "xiaoqin2012", "createdAt": "2020-08-05T23:50:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjA0NDM5NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjA2ODU4MA==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2683#discussion_r466068580", "bodyText": "I did the option 2.", "author": "annym", "createdAt": "2020-08-05T23:59:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjA0NDM5NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjA3MDkzNA==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2683#discussion_r466070934", "bodyText": "We need to add try and catch for processReads to catch the exceptions.", "author": "xiaoqin2012", "createdAt": "2020-08-06T00:08:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjA0NDM5NA=="}], "type": "inlineReview"}, {"oid": "ba26d6dabfc6f3c4e044d03483fa7459dec91581", "url": "https://github.com/CorfuDB/CorfuDB/commit/ba26d6dabfc6f3c4e044d03483fa7459dec91581", "message": "Standby Connection Loss Fix\n\n1. Fix Issue when Standby connection is lost\n2. Fix replication server graceful shutdown\n3. Add logging\n4. Adjust default and configurable lock values: monitor, renewal, lease duration and lease check", "committedDate": "2020-08-05T23:05:18Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjAzODA4Nw==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2683#discussion_r466038087", "bodyText": "..fraction of lease duration after which lease renewal thread will run?", "author": "pankti-m", "createdAt": "2020-08-05T22:25:28Z", "path": "infrastructure/src/main/java/org/corfudb/infrastructure/logreplication/infrastructure/CorfuReplicationDiscoveryService.java", "diffHunk": "@@ -52,6 +54,16 @@\n      */\n     private static final int FETCH_THRESHOLD = 300;\n \n+    /**\n+     * Fraction of Lease Duration for Lease Renewal", "originalCommit": "381e320c2747d07a1b890e41e1c90cad8f4e1738", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjA0MDI1MA==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2683#discussion_r466040250", "bodyText": "does it need to be concurrent?", "author": "pankti-m", "createdAt": "2020-08-05T22:31:27Z", "path": "infrastructure/src/main/java/org/corfudb/infrastructure/logreplication/runtime/CorfuLogReplicationRuntime.java", "diffHunk": "@@ -158,6 +159,7 @@ public CorfuLogReplicationRuntime(LogReplicationRuntimeParameters parameters, Lo\n         this.router.addClient(new LogReplicationHandler());\n         this.sourceManager = new LogReplicationSourceManager(parameters, new LogReplicationClient(router, remoteClusterId),\n             metadataManager);\n+        this.connectedEndpoints = new HashSet<>();", "originalCommit": "381e320c2747d07a1b890e41e1c90cad8f4e1738", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjA2NzIyNw==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2683#discussion_r466067227", "bodyText": "I removed that as all the methods that modify or access this object are synchronized.", "author": "annym", "createdAt": "2020-08-05T23:55:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjA0MDI1MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjA0MjAwNQ==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2683#discussion_r466042005", "bodyText": "Can you add a comment saying what these tests do?", "author": "pankti-m", "createdAt": "2020-08-05T22:36:35Z", "path": "test/src/test/java/org/corfudb/integration/CorfuReplicationReconfigurationIT.java", "diffHunk": "@@ -0,0 +1,100 @@\n+package org.corfudb.integration;\n+\n+import org.corfudb.util.Sleep;\n+import org.junit.Before;\n+import org.junit.Test;\n+\n+import java.io.File;\n+import java.time.Duration;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.Executors;\n+\n+public class CorfuReplicationReconfigurationIT extends LogReplicationAbstractIT {", "originalCommit": "381e320c2747d07a1b890e41e1c90cad8f4e1738", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjA0NDUyNg==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2683#discussion_r466044526", "bodyText": "pn -> on", "author": "pankti-m", "createdAt": "2020-08-05T22:44:19Z", "path": "test/src/test/java/org/corfudb/integration/CorfuReplicationReconfigurationIT.java", "diffHunk": "@@ -0,0 +1,100 @@\n+package org.corfudb.integration;\n+\n+import org.corfudb.util.Sleep;\n+import org.junit.Before;\n+import org.junit.Test;\n+\n+import java.io.File;\n+import java.time.Duration;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.Executors;\n+\n+public class CorfuReplicationReconfigurationIT extends LogReplicationAbstractIT {\n+\n+    private static final int SLEEP_DURATION = 5;\n+\n+    /**\n+     * Sets the plugin path before starting any test\n+     *\n+     * @throws Exception\n+     */\n+    @Before\n+    public void setupPluginPath() {\n+        if(runProcess) {\n+            File f = new File(nettyConfig);\n+            this.pluginConfigFilePath = f.getAbsolutePath();\n+        } else {\n+            this.pluginConfigFilePath = nettyConfig;\n+        }\n+    }\n+\n+    /**\n+     * Test the case where Standby leader node is restarted during log entry sync.\n+     *\n+     * The expectation is that replication should resume.\n+     */\n+    @Test\n+    public void testStandbyClusterReset() throws Exception {\n+        // (1) Snapshot and Log Entry Sync\n+        System.out.println(\">>> (1) Start Snapshot and Log Entry Sync\");\n+        testEndToEndSnapshotAndLogEntrySync();\n+\n+        ExecutorService writerService = Executors.newSingleThreadExecutor();\n+\n+        // (2) Stop Standby Log Replicator Server\n+        System.out.println(\">>> (2) Stop Standby Node\");\n+        stopStandbyLogReplicator();\n+\n+        // (3) Start daemon thread writing data to active\n+        System.out.println(\">>> (3) Start daemon writer service\");\n+        // Since step (1) wrote numWrites for snapshotSync and numWrites/2 in logEntrySync, continue from this starting point\n+        writerService.submit(() -> writeToActive((numWrites + numWrites/2), numWrites));\n+\n+        // (4) Sleep Interval so writes keep going through, while standby is down\n+        System.out.println(\">>> (4) Wait for some time\");\n+        Sleep.sleepUninterruptibly(Duration.ofSeconds(SLEEP_DURATION));\n+\n+        // (5) Restart Standby Log Replicator\n+        System.out.println(\">>> (5) Restart Standby Node\");\n+        startStandbyLogReplicator();\n+\n+        // (6) Verify Data pn Standby after Restart", "originalCommit": "381e320c2747d07a1b890e41e1c90cad8f4e1738", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "7e97622b592e3ba8ac668bd2a6ed66117986e041", "url": "https://github.com/CorfuDB/CorfuDB/commit/7e97622b592e3ba8ac668bd2a6ed66117986e041", "message": "Standby Connection Loss Fix\n\n1. Fix Issue when Standby connection is lost\n2. Fix replication server graceful shutdown\n3. Add logging\n4. Adjust default and configurable lock values: monitor, renewal, lease duration and lease check", "committedDate": "2020-08-05T23:55:37Z", "type": "forcePushed"}, {"oid": "c8044ffca76ab3ffa2792f76f85fad3f73655ba8", "url": "https://github.com/CorfuDB/CorfuDB/commit/c8044ffca76ab3ffa2792f76f85fad3f73655ba8", "message": "Standby Connection Loss Fix\n\n1. Fix Issue when Standby connection is lost\n2. Fix replication server graceful shutdown\n3. Add logging\n4. Adjust default and configurable lock values: monitor, renewal, lease duration and lease check", "committedDate": "2020-08-06T01:35:00Z", "type": "forcePushed"}, {"oid": "d4e5bafa0dfd4101e02400ef325a32189715b302", "url": "https://github.com/CorfuDB/CorfuDB/commit/d4e5bafa0dfd4101e02400ef325a32189715b302", "message": "Standby Connection Loss Fix\n\n1. Fix Issue when Standby connection is lost\n2. Fix replication server graceful shutdown\n3. Add logging\n4. Adjust default and configurable lock values: monitor, renewal, lease duration and lease check", "committedDate": "2020-08-06T01:55:20Z", "type": "forcePushed"}, {"oid": "9bd5aae60ce995a47bf8dc9fdab84db36b28521c", "url": "https://github.com/CorfuDB/CorfuDB/commit/9bd5aae60ce995a47bf8dc9fdab84db36b28521c", "message": "Standby Connection Loss Fix\n\n1. Fix Issue when Standby connection is lost\n2. Fix replication server graceful shutdown\n3. Add logging\n4. Adjust default and configurable lock values: monitor, renewal, lease duration and lease check", "committedDate": "2020-08-06T02:46:28Z", "type": "commit"}, {"oid": "9bd5aae60ce995a47bf8dc9fdab84db36b28521c", "url": "https://github.com/CorfuDB/CorfuDB/commit/9bd5aae60ce995a47bf8dc9fdab84db36b28521c", "message": "Standby Connection Loss Fix\n\n1. Fix Issue when Standby connection is lost\n2. Fix replication server graceful shutdown\n3. Add logging\n4. Adjust default and configurable lock values: monitor, renewal, lease duration and lease check", "committedDate": "2020-08-06T02:46:28Z", "type": "forcePushed"}]}