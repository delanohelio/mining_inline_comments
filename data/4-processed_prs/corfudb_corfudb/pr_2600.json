{"pr_number": 2600, "pr_title": "Startup TopologyConfigId Fix Receiver", "pr_createdAt": "2020-07-07T03:06:59Z", "pr_url": "https://github.com/CorfuDB/CorfuDB/pull/2600", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDU4NzA3OQ==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2600#discussion_r450587079", "bodyText": "I have a test to verify this fix. It will come as part of another PR as it has refactored the CorfuLogReplicationE2ETest to make the methods as utils for other tests.", "author": "annym", "createdAt": "2020-07-07T03:08:57Z", "path": "infrastructure/src/main/java/org/corfudb/infrastructure/logreplication/replication/receive/LogReplicationSinkManager.java", "diffHunk": "@@ -113,6 +108,7 @@ public LogReplicationSinkManager(String localCorfuEndpoint, LogReplicationConfig\n          */\n         this.rxState = RxState.LOG_ENTRY_SYNC;\n         this.config = config;\n+        this.topologyConfigId = topologyConfigId;", "originalCommit": "778677bdea92618d952e4c7ff6f94d0bbd359641", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDU5NDk5OA==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2600#discussion_r450594998", "bodyText": "The clusterManager does update the persisted topologyConfigId. But within the LogReplicationSinkManager we use the cached value (see for instance the receive method). This cached value is updated on processTopologyConfigChange but not in the initial path (when there is no change but we're starting)... So topologyConfigId on the first run is always 0 instead of the one received by the ClusterManager... We're ok on the update path but fail to set it on the start path...", "author": "annym", "createdAt": "2020-07-07T03:44:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDU4NzA3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDU5NTk2MQ==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2600#discussion_r450595961", "bodyText": "Then it is better that sinkManager doesn't cache the configureID. If the sinkManager needs the configID, it just queries the metadata table to get the most recent one.", "author": "xiaoqin2012", "createdAt": "2020-07-07T03:48:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDU4NzA3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDYwMjEwOA==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2600#discussion_r450602108", "bodyText": "For every received message we verify it is intended for us on that 'epoch'. That would mean accessing the database for every received message.", "author": "annym", "createdAt": "2020-07-07T04:18:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDU4NzA3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDYxMjM5Ng==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2600#discussion_r450612396", "bodyText": "The data is at runtime, it is a in-memory database, the accessing should be fast. Just one scenario: a node missed the notification of the clusterConfig change due to network partition, this node join the cluster again with the old config and becomes the leader later, will its cached configID be out of date?", "author": "xiaoqin2012", "createdAt": "2020-07-07T05:03:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDU4NzA3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDYzNTc2Ng==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2600#discussion_r450635766", "bodyText": "One question, why is it an in-memory database? Isn't the metadata table manager doing an access to Corfu itself? which is not running in-memory and which could be doing an RPC call by reading from the tail.\nMaybe this scenario that you're highlighting is an indicative that on leadership (lock acquisition) we should re-fetch the topology, cause what if all 3 nodes missed the notification? even if we read from the datastore it is going to rely on an old config. Maybe that's the second change that we should do.", "author": "annym", "createdAt": "2020-07-07T06:23:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDU4NzA3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDk1OTI1OA==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2600#discussion_r450959258", "bodyText": "If performance is the concern, we can remove the epoch and epoch check at SinkManager, the snapshotWriter/logEntryWriter will do the check anyway. The checking at sinkManager just brings more complexity. It is nice to pass the epoch down at the startup to the metadata manager.", "author": "xiaoqin2012", "createdAt": "2020-07-07T15:37:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDU4NzA3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTA2Mzk4OA==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2600#discussion_r451063988", "bodyText": "But that is just moving the problem one layer up, right? cause still we process every message, so for every message we would be accessing the database.\nI would say that maybe we should keep the topologyConfigId cached and it is refreshed on two events:\n\nOn lock acquisition (we need to add this, to avoid the scenario of all nodes missing notification)\nOn topology change notification", "author": "annym", "createdAt": "2020-07-07T18:32:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDU4NzA3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTA2OTU2MQ==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2600#discussion_r451069561", "bodyText": "The out-of-sync configID is not a common case. The writers always do the check no matter what. One hint we can use is that if the message's configID is smaller, it should drop them anyway. If the message's configID is bigger, the current node should go to state that keeps polling clusterManager to get the desired configID that should not smaller then the message's configID.", "author": "xiaoqin2012", "createdAt": "2020-07-07T18:42:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDU4NzA3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTA4NzE4NA==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2600#discussion_r451087184", "bodyText": "But it is a possible case. The writers can continue to do the check always, that is not in question. I'm just concerned of having to access the database on every apply (every message) to check the topologyConfigId. TopologyConfigId changes anyways always come from the discovery service, either because:\n(1) the lock was acquired and we check what is the recent topology  (to be added), or\n(2) because a changeOfTopologyNotification came in\nIn this sense, we can always push this value down. Anyways reading from the DB is because we persisted it from the discovery service on (1) or (2) and instead of pushing the new topologyConfigId down, down there we read it from the database. There is where I don't think we need to be doing RPC calls for every received message if we can have it locally by being pushed by the Discovery Service.", "author": "annym", "createdAt": "2020-07-07T19:16:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDU4NzA3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTA5NTgyNw==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2600#discussion_r451095827", "bodyText": "I think adding a checking at SinkManager is ok. Just when the message has a higher topology epoch, the current node should send an alarm to DiscoveryService to get the most recent topology information etc. We can address that in another PR.", "author": "xiaoqin2012", "createdAt": "2020-07-07T19:33:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDU4NzA3OQ=="}], "type": "inlineReview"}, {"oid": "2acff5cab97f61758ca51823f8284661965d44b2", "url": "https://github.com/CorfuDB/CorfuDB/commit/2acff5cab97f61758ca51823f8284661965d44b2", "message": "Startup TopologyConfigId Fix Receiver\n\nOn receiver startup the topologyConfigId needs to be initialized\nor received messages will be filtered out due to different topology\nconfig id when compared to the one in the message.", "committedDate": "2020-07-08T04:12:28Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTczMTc4Mw==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2600#discussion_r451731783", "bodyText": "Just doing updateTopologyConfigID is not enough. While process a topology change event, the discovery service does more work refer to processTopologyChangeNotification.\nWhile combining two events topology change and leadership change together, it is a bit complex.\nWould suggest to not call the fetchTopologyFromClusterManager.  First, the topology change is a notification API from clusterManager. Even with this call, it will fetch the cached value from clusterManagerAdapter. Second, it just add more complexity and doesn't completely solve the problem.", "author": "xiaoqin2012", "createdAt": "2020-07-08T18:04:58Z", "path": "infrastructure/src/main/java/org/corfudb/infrastructure/logreplication/infrastructure/CorfuReplicationDiscoveryService.java", "diffHunk": "@@ -396,9 +419,28 @@ private void stopLogReplication() {\n     public void processLockAcquire() {\n         log.debug(\"Process lock acquire event\");\n         isLeader = true;\n+\n+        // Regardless of the role of this node, on leadership acquisition\n+        // we shall query the topology provider to get the most up to date\n+        // topologyConfigId, which might have changed during our time as non-leaders\n+        // and for which we might have missed the change notification and update it on\n+        // the sink manager so the value is cached to filter messages upon receive.\n+        fetchTopologyFromClusterManager();\n+        updateTopologyConfigId(topologyDescriptor.getTopologyConfigId());", "originalCommit": "2acff5cab97f61758ca51823f8284661965d44b2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTc4MTE3MA==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2600#discussion_r451781170", "bodyText": "I think we missed 'logReplicationServerHandler.setActive' after updating localTopology.", "author": "zhangn49", "createdAt": "2020-07-08T19:37:13Z", "path": "infrastructure/src/main/java/org/corfudb/infrastructure/logreplication/infrastructure/CorfuReplicationDiscoveryService.java", "diffHunk": "@@ -396,9 +419,28 @@ private void stopLogReplication() {\n     public void processLockAcquire() {\n         log.debug(\"Process lock acquire event\");\n         isLeader = true;\n+\n+        // Regardless of the role of this node, on leadership acquisition\n+        // we shall query the topology provider to get the most up to date\n+        // topologyConfigId, which might have changed during our time as non-leaders\n+        // and for which we might have missed the change notification and update it on\n+        // the sink manager so the value is cached to filter messages upon receive.\n+        fetchTopologyFromClusterManager();", "originalCommit": "2acff5cab97f61758ca51823f8284661965d44b2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjQ0OTA0NQ==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2600#discussion_r452449045", "bodyText": "you're right! So, to avoid this being loose and in different places, I refactored a bit as for updates to always happen when verifying if the cluster belongs to the retrieved topology.", "author": "annym", "createdAt": "2020-07-09T19:43:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTc4MTE3MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTc4MzY0OA==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2600#discussion_r451783648", "bodyText": "One more thought is when we process config change event notification, we are using the config from that notification message, which might be delayed/outdated. I was wondering if we can fetch latest one to skip those outdated ones?", "author": "zhangn49", "createdAt": "2020-07-08T19:42:12Z", "path": "infrastructure/src/main/java/org/corfudb/infrastructure/logreplication/infrastructure/CorfuReplicationDiscoveryService.java", "diffHunk": "@@ -370,6 +370,29 @@ private void onLeadershipAcquire() {\n         }\n     }\n \n+    /**", "originalCommit": "2acff5cab97f61758ca51823f8284661965d44b2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjQzNzU4Nw==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2600#discussion_r452437587", "bodyText": "mmm but that would be really complex right, the same argument could be thought for the one being fetched (that it could be delayed/outdated). Anyways, if it is delayed or outdated we'll soon receive another notification.", "author": "annym", "createdAt": "2020-07-09T19:20:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTc4MzY0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjU3MzQ4MA==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2600#discussion_r452573480", "bodyText": "While processing a topology event, it is an optimization we can do to query the most recent topology. But while there is a leadership change, there is no need to query the topology to complicate the scenario.", "author": "xiaoqin2012", "createdAt": "2020-07-10T01:23:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTc4MzY0OA=="}], "type": "inlineReview"}, {"oid": "dea3a003a338449e6838c96328b0be479d1b12aa", "url": "https://github.com/CorfuDB/CorfuDB/commit/dea3a003a338449e6838c96328b0be479d1b12aa", "message": "Startup TopologyConfigId Fix Receiver\n\n- On receiver startup the topologyConfigId needs to be initialized\nor received messages will be filtered out due to different topology\nconfig id when compared to the one in the message.\n- Allow clusters to be onboarded later to ClusterManager without stopping LR completely.\n- Cluster Role Change or Addition/Removal of standby clusters is determined by analyzing\nTopologyDescriptors and not relying on topologyConfigId.", "committedDate": "2020-07-11T00:09:22Z", "type": "forcePushed"}, {"oid": "68a146cf0e049df9a19a59cd0f32db2cf10bca4b", "url": "https://github.com/CorfuDB/CorfuDB/commit/68a146cf0e049df9a19a59cd0f32db2cf10bca4b", "message": "Startup TopologyConfigId Fix Receiver\n\n- On receiver startup the topologyConfigId needs to be initialized\nor received messages will be filtered out due to different topology\nconfig id when compared to the one in the message.\n- Allow clusters to be onboarded later to ClusterManager without stopping LR completely.\n- Cluster Role Change or Addition/Removal of standby clusters is determined by analyzing\nTopologyDescriptors and not relying on topologyConfigId.", "committedDate": "2020-07-11T01:02:07Z", "type": "forcePushed"}, {"oid": "eafd53f303baeb060b5d436e412cf8c860e1f81d", "url": "https://github.com/CorfuDB/CorfuDB/commit/eafd53f303baeb060b5d436e412cf8c860e1f81d", "message": "TopologyConfigId Update + Cluster Manager Support\n\n- On receiver startup the topologyConfigId needs to be initialized\nor received messages will be filtered out due to different topology\nconfig id when compared to the one in the message.\n- Allow clusters to be onboarded later to ClusterManager without stopping LR completely.\n- Cluster Role Change or Addition/Removal of standby clusters is determined by analyzing\nTopologyDescriptors and not relying on topologyConfigId.", "committedDate": "2020-07-11T02:18:23Z", "type": "commit"}, {"oid": "eafd53f303baeb060b5d436e412cf8c860e1f81d", "url": "https://github.com/CorfuDB/CorfuDB/commit/eafd53f303baeb060b5d436e412cf8c860e1f81d", "message": "TopologyConfigId Update + Cluster Manager Support\n\n- On receiver startup the topologyConfigId needs to be initialized\nor received messages will be filtered out due to different topology\nconfig id when compared to the one in the message.\n- Allow clusters to be onboarded later to ClusterManager without stopping LR completely.\n- Cluster Role Change or Addition/Removal of standby clusters is determined by analyzing\nTopologyDescriptors and not relying on topologyConfigId.", "committedDate": "2020-07-11T02:18:23Z", "type": "forcePushed"}]}