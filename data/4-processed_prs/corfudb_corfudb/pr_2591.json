{"pr_number": 2591, "pr_title": "Fix topology config change logic", "pr_createdAt": "2020-06-30T09:53:23Z", "pr_url": "https://github.com/CorfuDB/CorfuDB/pull/2591", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzc5NzA2OQ==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2591#discussion_r447797069", "bodyText": "May add log.warn that this call should not be called on non active site. Also why replicationManager can be null?", "author": "xiaoqin2012", "createdAt": "2020-06-30T15:59:25Z", "path": "infrastructure/src/main/java/org/corfudb/infrastructure/logreplication/infrastructure/CorfuReplicationDiscoveryService.java", "diffHunk": "@@ -497,7 +514,9 @@ public void updateSiteConfig(LogReplicationClusterInfo.TopologyConfigurationMsg\n      */\n     @Override\n     public void prepareSiteRoleChange() {\n-        replicationManager.prepareSiteRoleChange();\n+        if (localClusterDescriptor.getRole() == ClusterRole.ACTIVE && replicationManager != null) {", "originalCommit": "123615707a508a648d7c4ac4cfc8392c0a7f7166", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzk2MDQ4OA==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2591#discussion_r447960488", "bodyText": "Added. If the replication manager is not initialized yet, it will be null. It happens when the cluster role is standby.", "author": "zhangn49", "createdAt": "2020-06-30T20:30:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzc5NzA2OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzc5NzM5NA==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2591#discussion_r447797394", "bodyText": "Add log.warn if the roletype is not active.", "author": "xiaoqin2012", "createdAt": "2020-06-30T15:59:56Z", "path": "infrastructure/src/main/java/org/corfudb/infrastructure/logreplication/infrastructure/CorfuReplicationDiscoveryService.java", "diffHunk": "@@ -506,7 +525,15 @@ public void prepareSiteRoleChange() {\n      */\n     @Override\n     public int queryReplicationStatus() {\n-        return replicationManager.queryReplicationStatus();\n+        if (localClusterDescriptor.getRole() == ClusterRole.ACTIVE) {", "originalCommit": "123615707a508a648d7c4ac4cfc8392c0a7f7166", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzk2MTkyOQ==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2591#discussion_r447961929", "bodyText": "Yeah, I think I need some clarifications for this function.\nCase 1: if the role is standby, what is the expected return value?\nCase 2: if the role is active, but somehow replication is not initialized, like have not got the lock. What is the expected value?\nWill add log.warn", "author": "zhangn49", "createdAt": "2020-06-30T20:33:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzc5NzM5NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzk2NzUzNg==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2591#discussion_r447967536", "bodyText": "Case 1, this should not be called on the standby side. As standby side doesn't know the active log tail information.\nBut for snapshot sync scenario during applying phase, the active can query standby querySnapshotProcessStatus(), the standby side reply how much data has been appied. This can be done at phase II implementation.\nCase 2, do you mean the active is not the leader node? For now, we can consider it should be called on  the leader node only. We need to talk to the other group and get their finalized API and implement the complete solution.", "author": "xiaoqin2012", "createdAt": "2020-06-30T20:44:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzc5NzM5NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODAzNTEyNw==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2591#discussion_r448035127", "bodyText": "Yeah, I understand both cases should not happen right now, and just to avoid NPE. I have added warning logs for both cases.", "author": "zhangn49", "createdAt": "2020-06-30T23:31:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzc5NzM5NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODAwOTI4Ng==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2591#discussion_r448009286", "bodyText": "Let's rename processSiteFlip -> processClusterRoleChange", "author": "annym", "createdAt": "2020-06-30T22:14:13Z", "path": "infrastructure/src/main/java/org/corfudb/infrastructure/logreplication/infrastructure/CorfuReplicationDiscoveryService.java", "diffHunk": "@@ -391,32 +390,50 @@ public void processLockRelease() {\n \n         interClusterReplicationService.getLogReplicationServer().setLeadership(false);\n \n-        if (localNodeDescriptor.isLeader()) {\n+        if (isLeader) {\n             stopLogReplication();\n-            localNodeDescriptor.setLeader(false);\n+            isLeader = false;\n         }\n     }\n \n     public void processSiteFlip(TopologyDescriptor newConfig) {", "originalCommit": "d050e6debd7f26b0a5cfd9b7c7b3d7f9b1fe8748", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODAwOTU1NQ==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2591#discussion_r448009555", "bodyText": "Same here -> processClusterRoleChangeNotification", "author": "annym", "createdAt": "2020-06-30T22:14:58Z", "path": "infrastructure/src/main/java/org/corfudb/infrastructure/logreplication/infrastructure/CorfuReplicationDiscoveryService.java", "diffHunk": "@@ -391,32 +390,50 @@ public void processLockRelease() {\n \n         interClusterReplicationService.getLogReplicationServer().setLeadership(false);\n \n-        if (localNodeDescriptor.isLeader()) {\n+        if (isLeader) {\n             stopLogReplication();\n-            localNodeDescriptor.setLeader(false);\n+            isLeader = false;\n         }\n     }\n \n     public void processSiteFlip(TopologyDescriptor newConfig) {\n-        // TODO(Nan): Check standby to active and active to standby...\n+        // stop ongoing replication, stopLogReplication() checks leadership and active\n         stopLogReplication();\n+\n         //TODO pankti: read the configuration again and refresh the LogReplicationConfig object\n-        replicationManager.setTopologyDescriptor(newConfig);\n-        boolean activeCluster = localNodeDescriptor.getRoleType() == ClusterRole.ACTIVE;\n-        updateTopologyConfigId(activeCluster);\n+\n+        // update local topology descriptor\n+        topologyDescriptor = newConfig;\n+\n+        // update local cluster descriptor\n+        localClusterDescriptor = topologyDescriptor.getClusterDescriptor(localEndpoint);\n+\n+        // update local node descriptor\n+        localNodeDescriptor = localClusterDescriptor.getNode(localEndpoint);\n+\n+        // update config id in metadata manager\n+        interClusterReplicationService.getLogReplicationServer().getSinkManager()\n+                .updateTopologyConfigId(topologyDescriptor.getTopologyConfigId());\n+        log.debug(\"Persist new topologyConfigId {}, status={}\", topologyDescriptor.getTopologyConfigId(),\n+                localClusterDescriptor.getRole());\n+\n+        logReplicationServerHandler.setActive(localClusterDescriptor.getRole().equals(ClusterRole.ACTIVE));\n+\n+        // we do not need to update replication manager's config, since it will be initialized again\n+\n         startLogReplication();\n     }\n \n     public void processSiteChangeNotification(DiscoveryServiceEvent event) {\n         // Stale notification, skip", "originalCommit": "d050e6debd7f26b0a5cfd9b7c7b3d7f9b1fe8748", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODAxMDQzMA==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2591#discussion_r448010430", "bodyText": "let's rename -> setTopologyConfigId", "author": "annym", "createdAt": "2020-06-30T22:17:09Z", "path": "infrastructure/src/main/java/org/corfudb/infrastructure/logreplication/replication/LogReplicationSourceManager.java", "diffHunk": "@@ -173,6 +173,7 @@ public LogReplicationSourceManager(CorfuRuntime runtime,\n \n         this.logReplicationFSM = new LogReplicationFSM(this.runtime, config, params.getRemoteClusterDescriptor(),\n                 dataSender, readProcessor, logReplicationFSMWorkers);\n+        this.logReplicationFSM.setSiteConfigID(params.getTopologyConfigId());", "originalCommit": "d050e6debd7f26b0a5cfd9b7c7b3d7f9b1fe8748", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODAxMDU5NA==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2591#discussion_r448010594", "bodyText": "typo -> manage -> manager", "author": "annym", "createdAt": "2020-06-30T22:17:35Z", "path": "infrastructure/src/main/java/org/corfudb/infrastructure/logreplication/replication/receive/LogReplicationSinkManager.java", "diffHunk": "@@ -196,6 +196,8 @@ public LogReplicationEntry receive(LogReplicationEntry message) {\n          // It could be caused by an out-of-date sender or the local node hasn't done the site discovery yet.\n          // If there is a siteConfig change, the discovery service will detect it and reset the state.\n         if (message.getMetadata().getTopologyConfigId() != siteConfigID) {\n+            log.trace(\"Sink manage with config id {} ignored msg id {}\", siteConfigID,", "originalCommit": "d050e6debd7f26b0a5cfd9b7c7b3d7f9b1fe8748", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODAxMDkwNA==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2591#discussion_r448010904", "bodyText": "Is this required but still not working? or old code we can remove?", "author": "annym", "createdAt": "2020-06-30T22:18:27Z", "path": "test/src/test/java/org/corfudb/integration/CorfuReplicationSiteConfigIT.java", "diffHunk": "@@ -342,11 +343,11 @@ public void runSiteSwitch() throws Exception {\n             sleep(sleepInterval);\n \n             siteManager.prepareSiteRoleChange();\n-            while (replicationStatus != CorfuReplicationManager.PERCENTAGE_BASE) {\n-                replicationStatus = siteManager.queryReplicationStatus();\n-                System.out.print(\"\\nreplication percentage done \" + replicationStatus);\n-                sleep(sleepInterval);\n-            }\n+//            while (replicationStatus != CorfuReplicationManager.PERCENTAGE_BASE) {\n+//                replicationStatus = siteManager.queryReplicationStatus();", "originalCommit": "d050e6debd7f26b0a5cfd9b7c7b3d7f9b1fe8748", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODAzMTQ5OA==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2591#discussion_r448031498", "bodyText": "It's working. Brought back.", "author": "zhangn49", "createdAt": "2020-06-30T23:19:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODAxMDkwNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODAxMTUyNw==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2591#discussion_r448011527", "bodyText": "Let's group these three into, updateTopology()", "author": "annym", "createdAt": "2020-06-30T22:20:08Z", "path": "infrastructure/src/main/java/org/corfudb/infrastructure/logreplication/infrastructure/CorfuReplicationDiscoveryService.java", "diffHunk": "@@ -391,32 +390,50 @@ public void processLockRelease() {\n \n         interClusterReplicationService.getLogReplicationServer().setLeadership(false);\n \n-        if (localNodeDescriptor.isLeader()) {\n+        if (isLeader) {\n             stopLogReplication();\n-            localNodeDescriptor.setLeader(false);\n+            isLeader = false;\n         }\n     }\n \n     public void processSiteFlip(TopologyDescriptor newConfig) {\n-        // TODO(Nan): Check standby to active and active to standby...\n+        // stop ongoing replication, stopLogReplication() checks leadership and active\n         stopLogReplication();\n+\n         //TODO pankti: read the configuration again and refresh the LogReplicationConfig object\n-        replicationManager.setTopologyDescriptor(newConfig);\n-        boolean activeCluster = localNodeDescriptor.getRoleType() == ClusterRole.ACTIVE;\n-        updateTopologyConfigId(activeCluster);\n+\n+        // update local topology descriptor\n+        topologyDescriptor = newConfig;", "originalCommit": "d050e6debd7f26b0a5cfd9b7c7b3d7f9b1fe8748", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODAxMjAyMA==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2591#discussion_r448012020", "bodyText": "Let's rename -> prepareClusterRoleChange", "author": "annym", "createdAt": "2020-06-30T22:21:36Z", "path": "infrastructure/src/main/java/org/corfudb/infrastructure/logreplication/infrastructure/CorfuReplicationDiscoveryService.java", "diffHunk": "@@ -497,7 +514,12 @@ public void updateSiteConfig(LogReplicationClusterInfo.TopologyConfigurationMsg\n      */\n     @Override\n     public void prepareSiteRoleChange() {", "originalCommit": "d050e6debd7f26b0a5cfd9b7c7b3d7f9b1fe8748", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODAxMjM0OA==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2591#discussion_r448012348", "bodyText": "same here... in ReplicationManager let's rename for consistency to prepareClusterRoleChange", "author": "annym", "createdAt": "2020-06-30T22:22:27Z", "path": "infrastructure/src/main/java/org/corfudb/infrastructure/logreplication/infrastructure/CorfuReplicationDiscoveryService.java", "diffHunk": "@@ -497,7 +514,12 @@ public void updateSiteConfig(LogReplicationClusterInfo.TopologyConfigurationMsg\n      */\n     @Override\n     public void prepareSiteRoleChange() {\n-        replicationManager.prepareSiteRoleChange();\n+        if (localClusterDescriptor.getRole() == ClusterRole.ACTIVE && replicationManager != null) {\n+            replicationManager.prepareSiteRoleChange();", "originalCommit": "d050e6debd7f26b0a5cfd9b7c7b3d7f9b1fe8748", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODAxNDAyMg==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2591#discussion_r448014022", "bodyText": "Does this calculate how much is pending or how much is done? Can we fix the method description and rename accordingly.", "author": "annym", "createdAt": "2020-06-30T22:27:03Z", "path": "infrastructure/src/main/java/org/corfudb/infrastructure/logreplication/infrastructure/CorfuReplicationDiscoveryService.java", "diffHunk": "@@ -506,7 +528,17 @@ public void prepareSiteRoleChange() {\n      */\n     @Override\n     public int queryReplicationStatus() {\n-        return replicationManager.queryReplicationStatus();\n+        if (localClusterDescriptor.getRole() == ClusterRole.ACTIVE) {", "originalCommit": "d050e6debd7f26b0a5cfd9b7c7b3d7f9b1fe8748", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODAzMjY4OQ==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2591#discussion_r448032689", "bodyText": "I think it calculates how much is pending and have put some comments... I think it would be better to get addressed by another PR.", "author": "zhangn49", "createdAt": "2020-06-30T23:24:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODAxNDAyMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY3NjI3Mg==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2591#discussion_r448676272", "bodyText": "Can you add a TODO in the code please so we don't miss this whenever we decide to merge into master.", "author": "annym", "createdAt": "2020-07-02T00:01:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODAxNDAyMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODAxNDI5NA==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2591#discussion_r448014294", "bodyText": "can we add some logging warning, before this return 0. Cause then we don't know if it means that 0 is pending as it all was transferred or the replication never started so 0 is pending.", "author": "annym", "createdAt": "2020-06-30T22:27:49Z", "path": "infrastructure/src/main/java/org/corfudb/infrastructure/logreplication/infrastructure/CorfuReplicationDiscoveryService.java", "diffHunk": "@@ -506,7 +528,17 @@ public void prepareSiteRoleChange() {\n      */\n     @Override\n     public int queryReplicationStatus() {\n-        return replicationManager.queryReplicationStatus();\n+        if (localClusterDescriptor.getRole() == ClusterRole.ACTIVE) {\n+            // If not leader, replication manager might be null\n+            if (replicationManager != null) {\n+                return replicationManager.queryReplicationStatus();\n+            }\n+            return 0;", "originalCommit": "d050e6debd7f26b0a5cfd9b7c7b3d7f9b1fe8748", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODAxNDYxMg==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2591#discussion_r448014612", "bodyText": "Can we make -1 a final static variable INVALID_REPLICATION_STATUS.", "author": "annym", "createdAt": "2020-06-30T22:28:36Z", "path": "infrastructure/src/main/java/org/corfudb/infrastructure/logreplication/infrastructure/CorfuReplicationDiscoveryService.java", "diffHunk": "@@ -506,7 +528,17 @@ public void prepareSiteRoleChange() {\n      */\n     @Override\n     public int queryReplicationStatus() {\n-        return replicationManager.queryReplicationStatus();\n+        if (localClusterDescriptor.getRole() == ClusterRole.ACTIVE) {\n+            // If not leader, replication manager might be null\n+            if (replicationManager != null) {\n+                return replicationManager.queryReplicationStatus();\n+            }\n+            return 0;\n+        } else {\n+            log.warn(\"Illegal queryReplicationStatus when cluster{} with role {}\",\n+                    localClusterDescriptor.getClusterId(), localClusterDescriptor.getRole());\n+            return -1;", "originalCommit": "d050e6debd7f26b0a5cfd9b7c7b3d7f9b1fe8748", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODAxNDc4MA==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2591#discussion_r448014780", "bodyText": "Can we rename PRIMARY_SITE_NAME -> ACTIVE_CLUSTER_NAME", "author": "annym", "createdAt": "2020-06-30T22:29:05Z", "path": "infrastructure/src/main/java/org/corfudb/infrastructure/logreplication/infrastructure/plugins/DefaultClusterManager.java", "diffHunk": "@@ -134,7 +134,7 @@ public static TopologyDescriptor readConfig() throws IOException {\n         for (int i = 0; i < primaryNodeNames.size(); i++) {\n             log.info(\"Primary Site Name {}, IpAddress {}\", primaryNodeNames.get(i), primaryIpAddresses.get(i));\n             NodeDescriptor nodeInfo = new NodeDescriptor(primaryIpAddresses.get(i),\n-                    activeLogReplicationPort, ClusterRole.ACTIVE, PRIMARY_SITE_NAME, UUID.fromString(primaryNodeIds.get(i)));\n+                    activeLogReplicationPort, PRIMARY_SITE_NAME, UUID.fromString(primaryNodeIds.get(i)));", "originalCommit": "d050e6debd7f26b0a5cfd9b7c7b3d7f9b1fe8748", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODAxNDg0NA==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2591#discussion_r448014844", "bodyText": "site -> cluster", "author": "annym", "createdAt": "2020-06-30T22:29:16Z", "path": "infrastructure/src/main/java/org/corfudb/infrastructure/logreplication/infrastructure/plugins/DefaultClusterManager.java", "diffHunk": "@@ -145,7 +145,7 @@ public static TopologyDescriptor readConfig() throws IOException {\n         for (int i = 0; i < standbyNodeNames.size(); i++) {\n             log.info(\"Standby Site Name {}, IpAddress {}\", standbyNodeNames.get(i), standbyIpAddresses.get(i));\n             NodeDescriptor nodeInfo = new NodeDescriptor(standbyIpAddresses.get(i),\n-                    standbyLogReplicationPort, ClusterRole.STANDBY, STANDBY_SITE_NAME, UUID.fromString(standbyNodeIds.get(i)));\n+                    standbyLogReplicationPort, STANDBY_SITE_NAME, UUID.fromString(standbyNodeIds.get(i)));", "originalCommit": "d050e6debd7f26b0a5cfd9b7c7b3d7f9b1fe8748", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODAxNTA2Mw==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2591#discussion_r448015063", "bodyText": "siteConfigID -> topologyConfigId (in the argument)", "author": "annym", "createdAt": "2020-06-30T22:29:51Z", "path": "infrastructure/src/main/java/org/corfudb/infrastructure/logreplication/replication/receive/LogReplicationSinkManager.java", "diffHunk": "@@ -363,10 +365,9 @@ private boolean receivedValidMessage(LogReplicationEntry message) {\n      * 1. update the metadata store with the most recent topologyConfigId\n      * 2. reset snapshotWriter and logEntryWriter state\n      * 3. reset buffer logEntryBuffer state.\n-     * @param active\n      * @param siteConfigID\n      */\n-    public void updateTopologyConfigId(boolean active, long siteConfigID) {\n+    public void updateTopologyConfigId(long siteConfigID) {", "originalCommit": "d050e6debd7f26b0a5cfd9b7c7b3d7f9b1fe8748", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "58465e8965ba084ef7056a94d1aebbb2e068f70e", "url": "https://github.com/CorfuDB/CorfuDB/commit/58465e8965ba084ef7056a94d1aebbb2e068f70e", "message": "Address comment", "committedDate": "2020-06-30T23:24:27Z", "type": "forcePushed"}, {"oid": "fd313da4ce1065e4e85472cbfedd8ed3865da907", "url": "https://github.com/CorfuDB/CorfuDB/commit/fd313da4ce1065e4e85472cbfedd8ed3865da907", "message": "Fix site change\n\nAddress comment", "committedDate": "2020-07-01T18:34:14Z", "type": "forcePushed"}, {"oid": "d22aecb8c791ebb9adafe10e354857e1a601e53a", "url": "https://github.com/CorfuDB/CorfuDB/commit/d22aecb8c791ebb9adafe10e354857e1a601e53a", "message": "Fix site change\n\nAddress comment", "committedDate": "2020-07-01T18:37:55Z", "type": "commit"}, {"oid": "d22aecb8c791ebb9adafe10e354857e1a601e53a", "url": "https://github.com/CorfuDB/CorfuDB/commit/d22aecb8c791ebb9adafe10e354857e1a601e53a", "message": "Fix site change\n\nAddress comment", "committedDate": "2020-07-01T18:37:55Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODU1MTA2OQ==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2591#discussion_r448551069", "bodyText": "I see the point that only the leader should do replication related jobs.\nBut discovery service does not only have topologyConfig, it also has cluster, node... etc.\nSo we need to make sure all fields get updated, and once any node gets a lock, it has updated configs...", "author": "zhangn49", "createdAt": "2020-07-01T18:43:54Z", "path": "infrastructure/src/main/java/org/corfudb/infrastructure/logreplication/infrastructure/CorfuReplicationDiscoveryService.java", "diffHunk": "@@ -436,40 +445,51 @@ public void processClusterRoleChange(TopologyDescriptor newTopology) {\n      *\n      * @param event discovery event\n      */\n-    private void processTopologyChangeNotification(DiscoveryServiceEvent event) {\n+    public void processTopologyChangeNotification(DiscoveryServiceEvent event) {\n         // Stale notification, skip\n-        if (event.getTopologyConfig().getTopologyConfigID() < getReplicationManager().getTopology().getTopologyConfigId()) {\n-            log.debug(\"Stale Topology Change Notification, current={}, received={}\", topologyDescriptor.getTopologyConfigId(),\n-                    event.getTopologyConfig());\n+        if (event.getTopologyConfig().getTopologyConfigID() < topologyDescriptor.getTopologyConfigId()) {\n+            log.debug(\"Stale Topology Change Notification, current={}, received={}\",\n+                    topologyDescriptor.getTopologyConfigId(), event.getTopologyConfig());\n             return;\n         }\n \n         TopologyDescriptor newConfig = new TopologyDescriptor(event.getTopologyConfig());\n-        topologyDescriptor = newConfig;\n \n-        //On topology change notification, store latest topology and only process if current node is the leader\n-        if (isLeader) {\n-            if (newConfig.getTopologyConfigId() == getReplicationManager().getTopology().getTopologyConfigId()) {\n-                if (localNodeDescriptor.getRoleType() == ClusterRole.STANDBY) {\n-                    return;\n-                }\n+        // Note: should not update topology here. Otherwise, below check is always true.\n+        if (newConfig.getTopologyConfigId() == topologyDescriptor.getTopologyConfigId()) {\n+            if (localClusterDescriptor.getRole() == ClusterRole.STANDBY) {\n+                return;\n+            }\n \n-                // If the current node is active, compare with the current topologyConfig, see if there are additional or\n-                // removed standbys\n-                getReplicationManager().processStandbyChange(newConfig);\n-            } else {\n-                // TODO: Are we sure that when there is a topologyConfigId change it implies a role change\n-                //  and not a new standby added??\n-                processClusterRoleChange(newConfig);\n+            // If the current node is active, compare with the current topologyConfig, see if there are additional or\n+            // removed standbys\n+            if (replicationManager != null && isLeader) {\n+                replicationManager.processStandbyChange(newConfig);", "originalCommit": "d22aecb8c791ebb9adafe10e354857e1a601e53a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODU1NzU2NA==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2591#discussion_r448557564", "bodyText": "Good catch! This bug is introduced by Anny's new change. The new topology information should be updated on all the nodes, not just the leader.", "author": "xiaoqin2012", "createdAt": "2020-07-01T18:57:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODU1MTA2OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODU2NTk5NA==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2591#discussion_r448565994", "bodyText": "Correct, so one question. When a DISCOVERED_TOPOLOGY comes in (change in the topology) we come in this method processTopologyChangeNotification, only if it is stale we can ignore that incoming topology, otherwise, shouldn't the first thing we do is call your updateLocalTopology() to update all local objects? and maybe you can store the old topology in a temp for the further comparisons.", "author": "annym", "createdAt": "2020-07-01T19:15:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODU1MTA2OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODYwNjgxNQ==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2591#discussion_r448606815", "bodyText": "Yeah, it is cleaner. Besides call updateLocalTopology(), I also need to update other components' config. Like logReplicationServerHandler.setActive", "author": "zhangn49", "createdAt": "2020-07-01T20:45:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODU1MTA2OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY0MjkwMQ==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2591#discussion_r448642901", "bodyText": "@annym  @xiaoqin2012  I realized that updateLocalTopology() is dependent on config id change.\n\n\nsame config id -> add/remove standby, no role change. Process standby first then update configs\n\n\nhigher config id -> might have a role change. Need to stop all replications, which will use current status(role, config)\nSo we can not pdateLocalTopology() until we stop all replications... Besides, notify the metadata manager that we have a higher config id, update sink manager, and update server's role.", "author": "zhangn49", "createdAt": "2020-07-01T22:12:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODU1MTA2OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODU2MDYzNw==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2591#discussion_r448560637", "bodyText": "I think updateTopologyConfigId is not the correct naming in the SinkManager, right? Cause that method has added functionality and is really doing much more than that... maybe processClusterRoleChange or resetOnClusterRoleChange?", "author": "annym", "createdAt": "2020-07-01T19:03:54Z", "path": "infrastructure/src/main/java/org/corfudb/infrastructure/logreplication/infrastructure/CorfuReplicationDiscoveryService.java", "diffHunk": "@@ -419,11 +418,21 @@ public void processLockRelease() {\n      * @param newTopology new discovered topology\n      */\n     public void processClusterRoleChange(TopologyDescriptor newTopology) {\n+        // stop ongoing replication, stopLogReplication() checks leadership and active\n         stopLogReplication();\n+\n         //TODO pankti: read the configuration again and refresh the LogReplicationConfig object\n-        replicationManager.setTopology(newTopology);\n-        boolean activeCluster = localNodeDescriptor.getRoleType() == ClusterRole.ACTIVE;\n-        updateTopologyConfigId(activeCluster);\n+\n+        // update topology, cluster, and node configs\n+        updateLocalTopology(newTopology);\n+\n+        // update config id in metadata manager\n+        interClusterReplicationService.getLogReplicationServer().getSinkManager()\n+                .updateTopologyConfigId(topologyDescriptor.getTopologyConfigId());", "originalCommit": "d22aecb8c791ebb9adafe10e354857e1a601e53a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODU2MTg5Ng==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2591#discussion_r448561896", "bodyText": "Also, similar to stop log replication isn't this dependent of the fact that you are currently a standby?... In such case, it might be a good idea to put this statement in the stopLogReplication method in the case STANDBY, right?", "author": "annym", "createdAt": "2020-07-01T19:06:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODU2MDYzNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODU5NjEzMQ==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2591#discussion_r448596131", "bodyText": "The function of updateTopologyCongId will update the metadata and sinkManager related information. It should be called on all the type of nodes.", "author": "xiaoqin2012", "createdAt": "2020-07-01T20:21:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODU2MDYzNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY0Mzc0OQ==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2591#discussion_r448643749", "bodyText": "But only the metadata, right? however, not the snapshotWriter/logEntryWriter.\nThose actually have logic that include calls to the database which are not required if you're not the lead standby, as a non-lead is not really doing anything. There is access to the logReplicationMedataManager at the DiscoveryService level, we can remove the updateTopologyConfigId on the logReplicationMetadata from the sink so it applies to all nodes, and the reset of the writers only if you're the leader, or is there something else that is generic to leaders and non-leaders?", "author": "annym", "createdAt": "2020-07-01T22:15:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODU2MDYzNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY1NTMzMQ==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2591#discussion_r448655331", "bodyText": "For all the nodes, it needs to update the metadata if config changes. As the metadata is protected by the transaction, at each site, only one node will succeed.\nThe related writer state should be updated too. As the configuration changes, a new full snapshot full sync will be needed. This is to reset the writer state. It is safer to reset writer state at all nodes as the leadership can change at anytime. In my local PR, I am trying to make the writer stateless and only using the persistent metadata.", "author": "xiaoqin2012", "createdAt": "2020-07-01T22:49:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODU2MDYzNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY3MzkxOQ==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2591#discussion_r448673919", "bodyText": "Questions:\n\nBut aren't they all writing to the same CorfuStore? the metadata is shared through the datastore.\nI do agree its needed for the node that is currently receiving data. But, those that are not should access it in a shared store as they are not really having activity. If you are pushing it as part of another PR that would address this.", "author": "annym", "createdAt": "2020-07-01T23:52:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODU2MDYzNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY3OTY1OQ==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2591#discussion_r448679659", "bodyText": "Assume the case that, there is a leadership change from node1 to node2. The leadership acquire event is on the queue for node2's discovery service to process, so node2 think it is not leader. Node1 has got the notification of leadership loss and has processed it and node1 think it is not leader either. There are some intermittent time, there is no node that consider it is the  leader and we don't want to lose the update of the metadata with the new config.", "author": "xiaoqin2012", "createdAt": "2020-07-02T00:14:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODU2MDYzNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY4MTA1NQ==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2591#discussion_r448681055", "bodyText": "Ok ok, yes in that case even though it is redundant it will protect us in these cases.", "author": "annym", "createdAt": "2020-07-02T00:19:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODU2MDYzNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODU3MTUzMQ==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2591#discussion_r448571531", "bodyText": "I see we have a processClusterRoleChange which comes as part of a DISCOVERED_TOPOLOGY event, but who can directly act upon the discovery service to forcefully prepare for Cluster Role Change? Is this some testing API? we should mark it as such and document it if it's the case.", "author": "annym", "createdAt": "2020-07-01T19:27:17Z", "path": "infrastructure/src/main/java/org/corfudb/infrastructure/logreplication/infrastructure/CorfuReplicationDiscoveryService.java", "diffHunk": "@@ -517,18 +537,35 @@ public void updateTopology(LogReplicationClusterInfo.TopologyConfigurationMsg to\n      * msg needs to send out.\n      */\n     @Override\n-    public void prepareSiteRoleChange() {\n-        replicationManager.prepareSiteRoleChange();\n+    public void prepareClusterRoleChange() {", "originalCommit": "d22aecb8c791ebb9adafe10e354857e1a601e53a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODU5NzI4NQ==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2591#discussion_r448597285", "bodyText": "This is an API we talked about that the upper layer like site manager can call us to prepare a site role change. Now seems that it may not be required. We can get rid of it or just keep it for our testing or warning purpose. The goal of this API is that after this call, the tables that should be replicated should not be changed any more. This hook can tell if the data has been changed or not.", "author": "xiaoqin2012", "createdAt": "2020-07-01T20:24:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODU3MTUzMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODU3MTgxMw==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2591#discussion_r448571813", "bodyText": "prepareSiteRoleChange -> prepareClusterRoleChange in the log comment.", "author": "annym", "createdAt": "2020-07-01T19:27:56Z", "path": "infrastructure/src/main/java/org/corfudb/infrastructure/logreplication/infrastructure/CorfuReplicationDiscoveryService.java", "diffHunk": "@@ -517,18 +537,35 @@ public void updateTopology(LogReplicationClusterInfo.TopologyConfigurationMsg to\n      * msg needs to send out.\n      */\n     @Override\n-    public void prepareSiteRoleChange() {\n-        replicationManager.prepareSiteRoleChange();\n+    public void prepareClusterRoleChange() {\n+        if (localClusterDescriptor.getRole() == ClusterRole.ACTIVE && replicationManager != null) {\n+            replicationManager.prepareClusterRoleChange();\n+        } else {\n+            log.warn(\"Illegal prepareSiteRoleChange when cluster{} with role {}\",", "originalCommit": "d22aecb8c791ebb9adafe10e354857e1a601e53a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODU3MjA2Nw==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2591#discussion_r448572067", "bodyText": "Can't there be a role change from standby to active?", "author": "annym", "createdAt": "2020-07-01T19:28:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODU3MTgxMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODYxNjAxNA==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2591#discussion_r448616014", "bodyText": "Typo fixed.\nYeah, it can be a role change from standby to active. I think it depends on how the cluster manager uses it...\nI don't want to touch prepareClusterRoleChange() and queryReplicationStatus()'s functionality in this PR. I just added some logs and make it a little robust. It is better to have a new PR about those two functions.", "author": "zhangn49", "createdAt": "2020-07-01T21:06:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODU3MTgxMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY3NzUzMg==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2591#discussion_r448677532", "bodyText": "ok, let's leave it for another PR, but we should revisit this.", "author": "annym", "createdAt": "2020-07-02T00:06:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODU3MTgxMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODU3Njg0Ng==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2591#discussion_r448576846", "bodyText": "You can remove the first TODO in this method as that you addressed.", "author": "annym", "createdAt": "2020-07-01T19:39:00Z", "path": "infrastructure/src/main/java/org/corfudb/infrastructure/logreplication/infrastructure/CorfuReplicationDiscoveryService.java", "diffHunk": "@@ -517,18 +537,35 @@ public void updateTopology(LogReplicationClusterInfo.TopologyConfigurationMsg to\n      * msg needs to send out.\n      */\n     @Override\n-    public void prepareSiteRoleChange() {\n-        replicationManager.prepareSiteRoleChange();\n+    public void prepareClusterRoleChange() {\n+        if (localClusterDescriptor.getRole() == ClusterRole.ACTIVE && replicationManager != null) {\n+            replicationManager.prepareClusterRoleChange();\n+        } else {\n+            log.warn(\"Illegal prepareSiteRoleChange when cluster{} with role {}\",\n+                    localClusterDescriptor.getClusterId(), localClusterDescriptor.getRole());\n+        }\n     }\n \n     /**\n-     * Query all replicated stream log tails and calculate the number of messages to be sent.\n-     * If the max tail has changed, return 0%.\n+     * Query the current all replication stream log tail and calculate the number of messages to be sent.\n+     * If the max tail has changed, give 0%.\n      */\n     @Override\n     public int queryReplicationStatus() {\n         // TODO (maxi): address Nan's comments\n-        return replicationManager.queryReplicationStatus();\n+        if (localClusterDescriptor.getRole() == ClusterRole.ACTIVE) {", "originalCommit": "d22aecb8c791ebb9adafe10e354857e1a601e53a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODU3Nzk4NQ==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2591#discussion_r448577985", "bodyText": "I think we should only reply if we are the leader. Cause from their point of view most likely we'll tell them to query all nodes in the cluster and they'll pick the max of these 3 values, otherwise, they won't know who is the leader right now as the lock is something internal.", "author": "annym", "createdAt": "2020-07-01T19:41:25Z", "path": "infrastructure/src/main/java/org/corfudb/infrastructure/logreplication/infrastructure/CorfuReplicationDiscoveryService.java", "diffHunk": "@@ -517,18 +537,35 @@ public void updateTopology(LogReplicationClusterInfo.TopologyConfigurationMsg to\n      * msg needs to send out.\n      */\n     @Override\n-    public void prepareSiteRoleChange() {\n-        replicationManager.prepareSiteRoleChange();\n+    public void prepareClusterRoleChange() {\n+        if (localClusterDescriptor.getRole() == ClusterRole.ACTIVE && replicationManager != null) {\n+            replicationManager.prepareClusterRoleChange();\n+        } else {\n+            log.warn(\"Illegal prepareSiteRoleChange when cluster{} with role {}\",\n+                    localClusterDescriptor.getClusterId(), localClusterDescriptor.getRole());\n+        }\n     }\n \n     /**\n-     * Query all replicated stream log tails and calculate the number of messages to be sent.\n-     * If the max tail has changed, return 0%.\n+     * Query the current all replication stream log tail and calculate the number of messages to be sent.\n+     * If the max tail has changed, give 0%.\n      */\n     @Override\n     public int queryReplicationStatus() {\n         // TODO (maxi): address Nan's comments\n-        return replicationManager.queryReplicationStatus();\n+        if (localClusterDescriptor.getRole() == ClusterRole.ACTIVE) {\n+            // If not leader, replication manager might be null\n+            if (replicationManager != null) {", "originalCommit": "d22aecb8c791ebb9adafe10e354857e1a601e53a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODYzOTI5MQ==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2591#discussion_r448639291", "bodyText": "Added check and logs", "author": "zhangn49", "createdAt": "2020-07-01T22:02:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODU3Nzk4NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODU3OTk3OA==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2591#discussion_r448579978", "bodyText": "I think we have something loose in this API. It does not restrict ClusterRole change from standby -> active or active->standby however, our underlying only process one type. Maybe it's the naming? or revising the actual functionality?", "author": "annym", "createdAt": "2020-07-01T19:45:57Z", "path": "infrastructure/src/main/java/org/corfudb/infrastructure/logreplication/infrastructure/plugins/CorfuReplicationClusterManagerAdapter.java", "diffHunk": "@@ -35,7 +35,7 @@ public synchronized void updateTopologyConfig(TopologyConfigurationMsg newTopolo\n     }\n \n     public void prepareSiteRoleChange() {\n-        corfuReplicationDiscoveryService.prepareSiteRoleChange();\n+        corfuReplicationDiscoveryService.prepareClusterRoleChange();", "originalCommit": "d22aecb8c791ebb9adafe10e354857e1a601e53a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODU4MDg1NQ==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2591#discussion_r448580855", "bodyText": "now that you are unifying the topologyConfigId, please change it also on. the snapshot and logEntry reader to setTopologyConfigId.", "author": "annym", "createdAt": "2020-07-01T19:47:49Z", "path": "infrastructure/src/main/java/org/corfudb/infrastructure/logreplication/replication/fsm/LogReplicationFSM.java", "diffHunk": "@@ -349,7 +349,7 @@ void transition(LogReplicationState from, LogReplicationState to) {\n         to.onEntry(from);\n     }\n \n-    public void setSiteConfigID(long siteConfigID) {\n+    public void setTopologyConfigId(long siteConfigID) {\n         this.siteConfigID = siteConfigID;\n         snapshotReader.setSiteEpoch(siteConfigID);", "originalCommit": "d22aecb8c791ebb9adafe10e354857e1a601e53a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODYxOTY2Nw==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2591#discussion_r448619667", "bodyText": "Done.", "author": "zhangn49", "createdAt": "2020-07-01T21:14:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODU4MDg1NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODU4MTc3MA==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2591#discussion_r448581770", "bodyText": "this is the method I mentioned up in another comment that we might change the name as it is overloaded with other functionalities.", "author": "annym", "createdAt": "2020-07-01T19:49:53Z", "path": "infrastructure/src/main/java/org/corfudb/infrastructure/logreplication/replication/receive/LogReplicationSinkManager.java", "diffHunk": "@@ -363,14 +365,13 @@ private boolean receivedValidMessage(LogReplicationEntry message) {\n      * 1. update the metadata store with the most recent topologyConfigId\n      * 2. reset snapshotWriter and logEntryWriter state\n      * 3. reset buffer logEntryBuffer state.\n-     * @param active\n-     * @param siteConfigID\n+     * @param topologyConfigId\n      */\n-    public void updateTopologyConfigId(boolean active, long siteConfigID) {\n-        this.siteConfigID = siteConfigID;\n+    public void updateTopologyConfigId(long topologyConfigId) {", "originalCommit": "d22aecb8c791ebb9adafe10e354857e1a601e53a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODYzOTE1OA==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2591#discussion_r448639158", "bodyText": "Moved metadata manager update to discovery service.", "author": "zhangn49", "createdAt": "2020-07-01T22:01:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODU4MTc3MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODU4MzM4Ng==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2591#discussion_r448583386", "bodyText": "Nan would you mind adding a brief description on what this test does. So when someone wants to look at it they know in plain English what it is doing. Maybe something in the line: Bring up an active and standby Log Replication Server, start replication. Initiate a cluster role switch in the middle of (snapshot/log entry) sync, while data is still being persisted into the active datastore (or do you stop the writing before the switch).. is the replication still going on when asked to switch or did it finish already? something in that line so we can easily detect which tests we need to add.", "author": "annym", "createdAt": "2020-07-01T19:53:22Z", "path": "test/src/test/java/org/corfudb/integration/CorfuReplicationSiteConfigIT.java", "diffHunk": "@@ -18,6 +18,7 @@\n public class CorfuReplicationSiteConfigIT extends AbstractIT {\n     final static int MAX_RETRY = 10;\n     final static long sleepInterval = 10000;\n+    private final String pluginConfigFilePath = \"src/test/resources/transport/nettyConfig.properties\";", "originalCommit": "d22aecb8c791ebb9adafe10e354857e1a601e53a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODYxMTUwNA==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2591#discussion_r448611504", "bodyText": "Yeah, we definitely need a description. I will add descriptions for new tests.\nNow any IT run replication as a thread will fail in Travis CI, and the current default cluster manager is not able to change the topology config unless running as a thread.\nSo I am introducing a new test cluster manager that subscribes a stream and updates config onNext(). In this way, we can easily control config change in test, and new cluster config IT can run as a process and pass Travis build.\nI keep this one to verify config change logic, and will remove it after my new cluster config complete.", "author": "zhangn49", "createdAt": "2020-07-01T20:55:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODU4MzM4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY3ODE4NQ==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2591#discussion_r448678185", "bodyText": "ok, yes I was thinking on this test and I have some thoughts on how to run it in processes. I'll share it with you offline I think it will let us model several scenarios very quickly.", "author": "annym", "createdAt": "2020-07-02T00:08:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODU4MzM4Ng=="}], "type": "inlineReview"}, {"oid": "1e9d7d1f1d3419fbc200f50563b8e994d9aeb9e1", "url": "https://github.com/CorfuDB/CorfuDB/commit/1e9d7d1f1d3419fbc200f50563b8e994d9aeb9e1", "message": "Address comments", "committedDate": "2020-07-01T22:05:44Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY2OTE3MA==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2591#discussion_r448669170", "bodyText": "typo -> lof -> log", "author": "annym", "createdAt": "2020-07-01T23:35:50Z", "path": "infrastructure/src/main/java/org/corfudb/infrastructure/logreplication/infrastructure/CorfuReplicationDiscoveryService.java", "diffHunk": "@@ -358,35 +365,27 @@ private void onLeadershipAcquire() {\n                 break;\n             default:\n                 log.error(\"Log Replication not started on this cluster. Leader node {} belongs to cluster with {} role.\",\n-                            localEndpoint, localNodeDescriptor.getRoleType());\n+                            localEndpoint, localClusterDescriptor.getRole());\n                 break;\n         }\n     }\n \n-    private void updateTopologyConfigId(boolean active) {\n-        // Required only on topology changes\n-        interClusterReplicationService.getLogReplicationServer().getSinkManager().updateTopologyConfigId(active, topologyDescriptor.getTopologyConfigId());\n-\n-        log.debug(\"Persist new topologyConfigId {}, status={}\", topologyDescriptor.getTopologyConfigId(),\n-                localNodeDescriptor.getRoleType());\n-    }\n-\n     /**\n      * Stop Log Replication\n      */\n     private void stopLogReplication() {\n-        switch(localNodeDescriptor.getRoleType()) {\n+        switch(localClusterDescriptor.getRole()) {\n             case ACTIVE:\n-                log.info(\"This cluster has lost leadership. Stopping lof replication, according to role {}\", localNodeDescriptor.getRoleType());\n+                log.info(\"This cluster has lost leadership. Stopping lof replication, according to role {}\", localClusterDescriptor.getRole());", "originalCommit": "1e9d7d1f1d3419fbc200f50563b8e994d9aeb9e1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY2OTk1NA==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2591#discussion_r448669954", "bodyText": "typo -> lof -> log", "author": "annym", "createdAt": "2020-07-01T23:38:31Z", "path": "infrastructure/src/main/java/org/corfudb/infrastructure/logreplication/infrastructure/CorfuReplicationDiscoveryService.java", "diffHunk": "@@ -358,35 +365,27 @@ private void onLeadershipAcquire() {\n                 break;\n             default:\n                 log.error(\"Log Replication not started on this cluster. Leader node {} belongs to cluster with {} role.\",\n-                            localEndpoint, localNodeDescriptor.getRoleType());\n+                            localEndpoint, localClusterDescriptor.getRole());\n                 break;\n         }\n     }\n \n-    private void updateTopologyConfigId(boolean active) {\n-        // Required only on topology changes\n-        interClusterReplicationService.getLogReplicationServer().getSinkManager().updateTopologyConfigId(active, topologyDescriptor.getTopologyConfigId());\n-\n-        log.debug(\"Persist new topologyConfigId {}, status={}\", topologyDescriptor.getTopologyConfigId(),\n-                localNodeDescriptor.getRoleType());\n-    }\n-\n     /**\n      * Stop Log Replication\n      */\n     private void stopLogReplication() {\n-        switch(localNodeDescriptor.getRoleType()) {\n+        switch(localClusterDescriptor.getRole()) {\n             case ACTIVE:\n-                log.info(\"This cluster has lost leadership. Stopping lof replication, according to role {}\", localNodeDescriptor.getRoleType());\n+                log.info(\"This cluster has lost leadership. Stopping lof replication, according to role {}\", localClusterDescriptor.getRole());\n                 replicationManager.stop();\n                 break;\n             case STANDBY:\n-                log.info(\"This cluster has lost leadership. Stopping lof replication, according to role {}\", localNodeDescriptor.getRoleType());\n+                log.info(\"This cluster has lost leadership. Stopping lof replication, according to role {}\", localClusterDescriptor.getRole());", "originalCommit": "1e9d7d1f1d3419fbc200f50563b8e994d9aeb9e1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY3NTMwMw==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2591#discussion_r448675303", "bodyText": "Let's remove this TODO and please add a note that this is under the assumption that changes in the topology config Id imply a change of cluster role.", "author": "annym", "createdAt": "2020-07-01T23:57:38Z", "path": "infrastructure/src/main/java/org/corfudb/infrastructure/logreplication/infrastructure/CorfuReplicationDiscoveryService.java", "diffHunk": "@@ -436,40 +450,58 @@ public void processClusterRoleChange(TopologyDescriptor newTopology) {\n      *\n      * @param event discovery event\n      */\n-    private void processTopologyChangeNotification(DiscoveryServiceEvent event) {\n-        // Stale notification, skip\n-        if (event.getTopologyConfig().getTopologyConfigID() < getReplicationManager().getTopology().getTopologyConfigId()) {\n-            log.debug(\"Stale Topology Change Notification, current={}, received={}\", topologyDescriptor.getTopologyConfigId(),\n-                    event.getTopologyConfig());\n+    public void processTopologyChangeNotification(DiscoveryServiceEvent event) {\n+        // Skip stale notification\n+        if (event.getTopologyConfig().getTopologyConfigID() < topologyDescriptor.getTopologyConfigId()) {\n+            log.debug(\"Stale Topology Change Notification, current={}, received={}\",\n+                    topologyDescriptor.getTopologyConfigId(), event.getTopologyConfig());\n             return;\n         }\n \n-        TopologyDescriptor newConfig = new TopologyDescriptor(event.getTopologyConfig());\n-        topologyDescriptor = newConfig;\n-\n-        //On topology change notification, store latest topology and only process if current node is the leader\n-        if (isLeader) {\n-            if (newConfig.getTopologyConfigId() == getReplicationManager().getTopology().getTopologyConfigId()) {\n-                if (localNodeDescriptor.getRoleType() == ClusterRole.STANDBY) {\n-                    return;\n-                }\n+        TopologyDescriptor newTopology = new TopologyDescriptor(event.getTopologyConfig());\n+        // Process standby add/remove, which will not increment config id\n+        // We won't stop ongoing replications in this case\n+        if (newTopology.getTopologyConfigId() == topologyDescriptor.getTopologyConfigId()) {\n+            log.debug(\"Processing a new topology with the same config id, previous topology\" +\n+                    \" is {}, and new topology is {}\", topologyDescriptor, newTopology);\n+            if (localClusterDescriptor.getRole() == ClusterRole.STANDBY) {\n+                return;\n+            }\n \n-                // If the current node is active, compare with the current topologyConfig, see if there are additional or\n-                // removed standbys\n-                getReplicationManager().processStandbyChange(newConfig);\n-            } else {\n-                // TODO: Are we sure that when there is a topologyConfigId change it implies a role change\n-                //  and not a new standby added??\n-                processClusterRoleChange(newConfig);\n+            // If the current node is active, compare with the current topologyConfig, see if there\n+            // are additional or removed standbys\n+            if (replicationManager != null && isLeader) {\n+                replicationManager.processStandbyChange(newTopology);\n             }\n+\n+            // After processing standby change, update local topology\n+            updateLocalTopology(newTopology);\n+            return;\n         }\n+\n+        // TODO: Are we sure that when there is a topologyConfigId change it implies a role change", "originalCommit": "1e9d7d1f1d3419fbc200f50563b8e994d9aeb9e1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY3NTk1NA==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2591#discussion_r448675954", "bodyText": "typo -> Query all current replication streams log tails ...", "author": "annym", "createdAt": "2020-07-02T00:00:07Z", "path": "infrastructure/src/main/java/org/corfudb/infrastructure/logreplication/infrastructure/CorfuReplicationDiscoveryService.java", "diffHunk": "@@ -517,18 +549,40 @@ public void updateTopology(LogReplicationClusterInfo.TopologyConfigurationMsg to\n      * msg needs to send out.\n      */\n     @Override\n-    public void prepareSiteRoleChange() {\n-        replicationManager.prepareSiteRoleChange();\n+    public void prepareClusterRoleChange() {\n+        if (localClusterDescriptor.getRole() == ClusterRole.ACTIVE && replicationManager != null) {\n+            replicationManager.prepareClusterRoleChange();\n+        } else {\n+            log.warn(\"Illegal prepareClusterRoleChange when cluster{} with role {}\",\n+                    localClusterDescriptor.getClusterId(), localClusterDescriptor.getRole());\n+        }\n     }\n \n     /**\n-     * Query all replicated stream log tails and calculate the number of messages to be sent.\n-     * If the max tail has changed, return 0%.\n+     * Query the current all replication stream log tail and calculate the number of messages to be sent.", "originalCommit": "1e9d7d1f1d3419fbc200f50563b8e994d9aeb9e1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "1b48d91a680de6798710ffd753f2098f976e4dd3", "url": "https://github.com/CorfuDB/CorfuDB/commit/1b48d91a680de6798710ffd753f2098f976e4dd3", "message": "Fix typo", "committedDate": "2020-07-02T01:12:16Z", "type": "commit"}]}