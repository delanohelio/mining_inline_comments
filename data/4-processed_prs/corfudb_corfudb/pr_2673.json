{"pr_number": 2673, "pr_title": "Add option to load data into corfu table", "pr_createdAt": "2020-07-30T00:31:25Z", "pr_url": "https://github.com/CorfuDB/CorfuDB/pull/2673", "timeline": [{"oid": "8e2cf9aa9f3d80dfe1859ec9a366e5882f644b69", "url": "https://github.com/CorfuDB/CorfuDB/commit/8e2cf9aa9f3d80dfe1859ec9a366e5882f644b69", "message": "CorfuStoreBrowser: add option to load data into a table\n\nthis is useful for testing checkpoint issues in live setups.", "committedDate": "2020-07-30T01:35:17Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjY5NTQxMw==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2673#discussion_r462695413", "bodyText": "Probably it should be (int)Math.ceil((double)numItems/batchSize);\nImagine 10 entries, in batches of 8, it would return 1, instead of 2.", "author": "annym", "createdAt": "2020-07-30T02:21:45Z", "path": "corfudb-tools/src/main/java/org/corfudb/browser/CorfuStoreBrowser.java", "diffHunk": "@@ -203,4 +206,45 @@ public int dropTable(String namespace, String tablename) {\n         log.info(\"\\n======================\\n\");\n         return tableSize;\n     }\n+\n+    /**\n+     * Loads the table with random data\n+     * @param namespace - the namespace where the table belongs\n+     * @param tablename - table name without the namespace\n+     * @param numItems - total number of items to load\n+     * @param batchSize - number of items in each transaction\n+     * @return - number of entries in the table\n+     */\n+    public int loadTable(String namespace, String tablename, int numItems, int batchSize) {\n+        verifyNamespaceAndTablename(namespace, tablename);\n+        CorfuStore store = new CorfuStore(runtime);\n+        try {\n+            TableOptions.TableOptionsBuilder<Object, Object> optionsBuilder = TableOptions.builder();\n+            if (diskPath != null) {\n+                optionsBuilder.persistentDataPath(Paths.get(diskPath));\n+            }\n+            store.openTable(namespace, tablename,\n+                    TableName.getDefaultInstance().getClass(),\n+                    TableName.getDefaultInstance().getClass(),\n+                    TableName.getDefaultInstance().getClass(),\n+                    optionsBuilder.build());\n+\n+            TableName dummyVal = TableName.newBuilder().setNamespace(namespace).setTableName(tablename).build();\n+            log.info(\"Loading {} items in {} batchSized transactions into {}${}\",\n+                    numItems, batchSize, namespace, tablename);\n+            while (numItems > 0) {\n+                log.info(\"loadTable: Items left {}\", numItems);\n+                TxBuilder tx = store.tx(namespace);\n+                for (int j = batchSize; j > 0 && numItems > 0; j--, numItems--) {\n+                    TableName dummyKey = TableName.newBuilder().setNamespace(Integer.toString(numItems))\n+                            .setTableName(Integer.toString(j)).build();\n+                    tx.update(tablename, dummyKey, dummyVal, dummyVal);\n+                }\n+                tx.commit();\n+            }\n+        } catch (Exception e) {\n+            log.error(\"loadTable: {} {} {} {} failed.\", namespace, tablename, numItems, batchSize, e);\n+        }\n+        return numItems/batchSize;", "originalCommit": "8e2cf9aa9f3d80dfe1859ec9a366e5882f644b69", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzMzODc4OQ==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2673#discussion_r463338789", "bodyText": "done. thanks", "author": "hisundar", "createdAt": "2020-07-31T00:13:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjY5NTQxMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjY5NjAxMA==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2673#discussion_r462696010", "bodyText": "In line with the above comment probably we should explicitly expect numItems/batchSize (in case someone changes numItems)... or use non-divisible numbers for test completeness.", "author": "annym", "createdAt": "2020-07-30T02:23:59Z", "path": "test/src/test/java/org/corfudb/integration/CorfuStoreBrowserIT.java", "diffHunk": "@@ -132,6 +132,26 @@ public void browserTest() throws\n         Assert.assertEquals(browser.printTableInfo(namespace, tableName), 0);\n     }\n \n+    /**\n+     * Create a table and add data to it using the loadTable command.\n+     * @throws IOException\n+     */\n+    @Test\n+    public void loaderTest() throws IOException {\n+        final String namespace = \"namespace\";\n+        final String tableName = \"table\";\n+        runSinglePersistentServer(corfuSingleNodeHost,\n+                corfuStringNodePort);\n+\n+        // Start a Corfu runtime\n+        runtime = createRuntime(singleNodeEndpoint);\n+        final int numItems = 100;\n+        final int batchSize = 10;\n+\n+        CorfuStoreBrowser browser = new CorfuStoreBrowser(runtime);\n+        Assert.assertEquals(browser.loadTable(namespace, tableName, numItems, batchSize), batchSize);", "originalCommit": "8e2cf9aa9f3d80dfe1859ec9a366e5882f644b69", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzMzODkyMQ==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2673#discussion_r463338921", "bodyText": "the return type is purely for testing - no one using the browser will see it.\nthanks", "author": "hisundar", "createdAt": "2020-07-31T00:14:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjY5NjAxMA=="}], "type": "inlineReview"}, {"oid": "b753a1c37760e2c904b77b0e204103868e873cf7", "url": "https://github.com/CorfuDB/CorfuDB/commit/b753a1c37760e2c904b77b0e204103868e873cf7", "message": "CorfuStoreBrowser: add option to load data into a table\n\nthis is useful for testing checkpoint issues in live setups.", "committedDate": "2020-07-31T18:28:47Z", "type": "forcePushed"}, {"oid": "6238336345f671eb7efdf8c5123a66ba2e7deb00", "url": "https://github.com/CorfuDB/CorfuDB/commit/6238336345f671eb7efdf8c5123a66ba2e7deb00", "message": "CorfuStoreBrowser: add option to load data into a table\n\nthis is useful for testing checkpoint issues in live setups.", "committedDate": "2020-07-31T22:30:55Z", "type": "forcePushed"}, {"oid": "af11f7a8a5192b1caf5cacde2f04f5449235a988", "url": "https://github.com/CorfuDB/CorfuDB/commit/af11f7a8a5192b1caf5cacde2f04f5449235a988", "message": "CorfuStoreBrowser: add option to load data into a table\n\nthis is useful for testing checkpoint issues in live setups.", "committedDate": "2020-07-31T23:02:42Z", "type": "commit"}, {"oid": "af11f7a8a5192b1caf5cacde2f04f5449235a988", "url": "https://github.com/CorfuDB/CorfuDB/commit/af11f7a8a5192b1caf5cacde2f04f5449235a988", "message": "CorfuStoreBrowser: add option to load data into a table\n\nthis is useful for testing checkpoint issues in live setups.", "committedDate": "2020-07-31T23:02:42Z", "type": "forcePushed"}]}