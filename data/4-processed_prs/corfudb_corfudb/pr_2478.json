{"pr_number": 2478, "pr_title": "Propagate exceptions when bootstrapping a management server during the AddNode workflow.", "pr_createdAt": "2020-03-12T20:46:07Z", "pr_url": "https://github.com/CorfuDB/CorfuDB/pull/2478", "timeline": [{"oid": "87692b05695eabfc40a0913fe3c37bb326a1e54b", "url": "https://github.com/CorfuDB/CorfuDB/commit/87692b05695eabfc40a0913fe3c37bb326a1e54b", "message": "Handle timeouts when bootstrapping management or a layout server", "committedDate": "2020-03-12T20:43:30Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTkxMjUzMw==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2478#discussion_r391912533", "bodyText": "shouldnt timeoutException thrown from bootstrapManagementServer be caught here?", "author": "pankti-m", "createdAt": "2020-03-12T21:37:27Z", "path": "runtime/src/main/java/org/corfudb/runtime/view/workflows/AddNode.java", "diffHunk": "@@ -46,7 +46,12 @@ public AddNode(@NonNull String endpointToAdd, @NonNull CorfuRuntime runtime,\n     protected UUID sendRequest(@NonNull ManagementClient managementClient) throws TimeoutException {\n         // Bootstrap a management server first.\n         Layout layout = new Layout(runtime.getLayoutView().getLayout());\n-        runtime.getManagementView().bootstrapManagementServer(nodeForWorkflow, layout).join();\n+        boolean bootstrapped =\n+                runtime.getManagementView().bootstrapManagementServer(nodeForWorkflow, layout);", "originalCommit": "b8141034d92ca89d7390692f81ba8adea24268b0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTk0MDY2Mg==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2478#discussion_r391940662", "bodyText": "Outdated", "author": "PavelZaytsev", "createdAt": "2020-03-12T22:32:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTkxMjUzMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTkyNzI4Nw==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2478#discussion_r391927287", "bodyText": "you can change the test comments to reflect this new behaviour", "author": "pankti-m", "createdAt": "2020-03-12T21:56:43Z", "path": "test/src/test/java/org/corfudb/runtime/view/ManagementViewTest.java", "diffHunk": "@@ -1640,7 +1640,7 @@ public void testPartialBootstrapNodeSuccess() throws ExecutionException, Interru\n         corfuRuntime.getLayoutView().getRuntimeLayout().getLayoutClient(SERVERS.ENDPOINT_1).bootstrapLayout(layout);\n         // Attempt bootstrapping the node. The node should attempt bootstrapping both the components Layout Server and\n         // Management Server.\n-        assertThat(corfuRuntime.getLayoutManagementView().bootstrapNewNode(SERVERS.ENDPOINT_1).get()).isTrue();\n+        assertThat(corfuRuntime.getLayoutManagementView().bootstrapNewNode(SERVERS.ENDPOINT_1).get()).isFalse();", "originalCommit": "b8141034d92ca89d7390692f81ba8adea24268b0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTk0MDcwNQ==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2478#discussion_r391940705", "bodyText": "Outdated", "author": "PavelZaytsev", "createdAt": "2020-03-12T22:32:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTkyNzI4Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTkyODc3Nw==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2478#discussion_r391928777", "bodyText": "minor - the variable name bootstrapped is confusing here.  If the server is bootstrapped, we log the warning.  But the check appears to be doing the opposite.  You can change the name to something else.", "author": "pankti-m", "createdAt": "2020-03-12T21:58:36Z", "path": "runtime/src/main/java/org/corfudb/runtime/view/workflows/AddNode.java", "diffHunk": "@@ -46,7 +46,12 @@ public AddNode(@NonNull String endpointToAdd, @NonNull CorfuRuntime runtime,\n     protected UUID sendRequest(@NonNull ManagementClient managementClient) throws TimeoutException {\n         // Bootstrap a management server first.\n         Layout layout = new Layout(runtime.getLayoutView().getLayout());\n-        runtime.getManagementView().bootstrapManagementServer(nodeForWorkflow, layout).join();\n+        boolean bootstrapped =\n+                runtime.getManagementView().bootstrapManagementServer(nodeForWorkflow, layout);\n+\n+        if (!bootstrapped) {", "originalCommit": "b8141034d92ca89d7390692f81ba8adea24268b0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTk0MDc1MQ==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2478#discussion_r391940751", "bodyText": "Outdated", "author": "PavelZaytsev", "createdAt": "2020-03-12T22:32:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTkyODc3Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTkxMDczNA==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2478#discussion_r391910734", "bodyText": "This seems hacky, and besides why this is needed?  bootstrapLayoutServer has an exceptionally block:\n.exceptionally(throwable -> {\n        try {\n                CFUtils.unwrap(throwable, AlreadyBootstrappedException.class);\n        } catch (AlreadyBootstrappedException e) {\n                log.info(\"bootstrapLayoutServer: Layout Server {} already bootstrapped.\", endpoint);\n        }\n        return true;\n})\nNotice this CFUtils.unwrap(throwable, AlreadyBootstrappedException.class); It will throw a RutimeException in case of exceptions other than AlreadyBootstrappedException, which makes the returned future exceptionally completed . Thus in this bootstrapNewNode method you will get a exceptionally completed future of RutimeException with a TimeoutException wrapped inside.", "author": "WenbinZhu", "createdAt": "2020-03-12T21:35:13Z", "path": "runtime/src/main/java/org/corfudb/runtime/view/LayoutManagementView.java", "diffHunk": "@@ -99,17 +100,26 @@ public void handleFailure(IReconfigurationHandlerPolicy failureHandlerPolicy,\n      * This bootstraps the Layout server with the existing layout.\n      *\n      * @param endpoint New node endpoint.\n-     * @return Completable Future which completes when the node's layout is bootstrapped.\n+     * @return Completable Future which completes with true if the node's layout is bootstrapped,\n+     * false if it has already been bootstrapped. The future completes exceptionally if a time out\n+     * has occurred.\n      */\n     public CompletableFuture<Boolean> bootstrapNewNode(String endpoint) {\n \n         // Bootstrap the to-be added node with the old layout.\n         Layout layout = new Layout(runtime.getLayoutView().getLayout());\n-        return runtime.getLayoutView().bootstrapLayoutServer(endpoint, layout)\n-                .thenApply(result -> {\n-                    log.info(\"bootstrapNewNode: New node {} bootstrapped.\", endpoint);\n-                    return true;\n-                });\n+\n+        CompletableFuture<Boolean> future = new CompletableFuture<>();\n+\n+        try {\n+            boolean bootstrapped = runtime.getLayoutView().bootstrapLayoutServer(endpoint, layout);\n+            future.complete(bootstrapped);\n+            return future;\n+        }\n+        catch (TimeoutException toe){\n+            future.completeExceptionally(toe);\n+            return future;\n+        }", "originalCommit": "b8141034d92ca89d7390692f81ba8adea24268b0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTkxOTkxNQ==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2478#discussion_r391919915", "bodyText": "I don't understand why we need to explicitly handle TimeoutException here. What about NetworkExceptions and other exceptions? Besides, the caller of this, namely BootstrapUtil.bootstrap() already logs and handles all exceptions: https://github.com/CorfuDB/CorfuDB/blob/master/runtime/src/main/java/org/corfudb/runtime/BootstrapUtil.java#L128-L134", "author": "WenbinZhu", "createdAt": "2020-03-12T21:47:28Z", "path": "runtime/src/main/java/org/corfudb/runtime/BootstrapUtil.java", "diffHunk": "@@ -54,18 +55,22 @@ public static void bootstrap(@NonNull Layout layout,\n      * @param layout Layout to bootstrap with\n      */\n     private static void bootstrapLayoutServer(IClientRouter router, Layout layout)\n-            throws ExecutionException, InterruptedException, AlreadyBootstrappedException {\n+            throws ExecutionException, InterruptedException, AlreadyBootstrappedException, TimeoutException {\n         LayoutClient layoutClient = new LayoutClient(router, layout.getEpoch());\n \n         try {\n             CFUtils.getUninterruptibly(layoutClient.bootstrapLayout(layout),\n-                    AlreadyBootstrappedException.class);\n+                    AlreadyBootstrappedException.class, TimeoutException.class);\n         } catch (AlreadyBootstrappedException abe) {\n             if (!layoutClient.getLayout().get().equals(layout)) {\n                 log.error(\"BootstrapUtil: Layout Server {}:{} already bootstrapped with different \"\n                         + \"layout.\", router.getHost(), router.getPort());\n                 throw abe;\n             }\n+        } catch (TimeoutException toe){\n+            log.error(\"BootstrapUtil: Layout Server {}:{} timeout occurred.\",\n+                    router.getHost(), router.getPort());\n+            throw toe;", "originalCommit": "b8141034d92ca89d7390692f81ba8adea24268b0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTkyODE0NA==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2478#discussion_r391928144", "bodyText": "Why specifically handling TimeoutException, there are other exceptions like NetworkException right? As explained in previous comment, the existing bootstrapLayoutServer implementation does return an exceptionally completed future due to CFUtil.unwrap(), I think the problem might not be here.", "author": "WenbinZhu", "createdAt": "2020-03-12T21:57:48Z", "path": "runtime/src/main/java/org/corfudb/runtime/view/LayoutView.java", "diffHunk": "@@ -319,21 +319,26 @@ public void committed(long epoch, Layout layout, boolean force)\n      *\n      * @param endpoint Endpoint to bootstrap.\n      * @param layout   Layout to bootstrap with.\n-     * @return Completable Future which completes with True when the layout server is bootstrapped.\n+     * @return True when the layout server is bootstrapped, false otherwise.\n+     * @throws TimeoutException If a timeout has occurred.\n      */\n-    CompletableFuture<Boolean> bootstrapLayoutServer(@Nonnull String endpoint, @Nonnull Layout layout) {\n-        return getRuntimeLayout(layout).getLayoutClient(endpoint).bootstrapLayout(layout)\n-                .exceptionally(throwable -> {\n-                    try {\n-                        CFUtils.unwrap(throwable, AlreadyBootstrappedException.class);\n-                    } catch (AlreadyBootstrappedException e) {\n-                        log.info(\"bootstrapLayoutServer: Layout Server {} already bootstrapped.\", endpoint);\n-                    }\n-                    return true;\n-                })\n-                .thenApply(result -> {\n-                    log.info(\"bootstrapLayoutServer: Layout Server {} bootstrap successful\", endpoint);\n-                    return true;\n-                });\n+    boolean bootstrapLayoutServer(@Nonnull String endpoint, @Nonnull Layout layout) throws TimeoutException {\n+        try {\n+            CFUtils.getUninterruptibly(getRuntimeLayout(layout)\n+                    .getLayoutClient(endpoint)\n+                    .bootstrapLayout(layout),\n+                    AlreadyBootstrappedException.class,\n+                    TimeoutException.class);\n+            log.info(\"bootstrapLayoutServer: Layout Server {} bootstrap successful.\",\n+                    endpoint);\n+            return true;\n+        } catch (AlreadyBootstrappedException abe) {\n+            log.warn(\"bootstrapLayoutServer: Layout Server {} already bootstrapped.\",\n+                    endpoint);\n+            return false;\n+        } catch (TimeoutException te) {\n+            log.error(\"bootstrapLayoutServer: Timeout occurred.\");\n+            throw te;", "originalCommit": "b8141034d92ca89d7390692f81ba8adea24268b0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTkzNTU5Ng==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2478#discussion_r391935596", "bodyText": "Ok, I see. I won't touch it then. I'll leave management and layout views as is but will unwrap the exception in the AddNode sendRequest I guess.", "author": "PavelZaytsev", "createdAt": "2020-03-12T22:17:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTkyODE0NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTk0NDI4OQ==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2478#discussion_r391944289", "bodyText": "I don't think swallowing all exceptions is a good idea. The retry only needs to happen on timeout and network exceptions.", "author": "Maithem", "createdAt": "2020-03-12T22:43:54Z", "path": "runtime/src/main/java/org/corfudb/runtime/view/workflows/WorkflowRequest.java", "diffHunk": "@@ -141,7 +141,7 @@ public void invoke() {\n                     throw new IllegalStateException(\"Orchestrator can not be selected\");\n                 }\n \n-            } catch (NetworkException | TimeoutException | IllegalStateException e) {\n+            } catch (Exception e) {", "originalCommit": "d4617805572ab12b609c0746e3dfcb124ba2280d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTk0NDc2MQ==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2478#discussion_r391944761", "bodyText": "Also, if this thread is interrupted, the interrupt flag isn't restored.", "author": "Maithem", "createdAt": "2020-03-12T22:45:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTk0NDI4OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTk0NjM5Nw==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2478#discussion_r391946397", "bodyText": "Ok, I'll bring it back in.", "author": "PavelZaytsev", "createdAt": "2020-03-12T22:50:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTk0NDI4OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTk0NDQ2MA==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2478#discussion_r391944460", "bodyText": "You can pass Network/Timeout exceptions types.", "author": "Maithem", "createdAt": "2020-03-12T22:44:32Z", "path": "runtime/src/main/java/org/corfudb/runtime/view/workflows/AddNode.java", "diffHunk": "@@ -46,7 +47,7 @@ public AddNode(@NonNull String endpointToAdd, @NonNull CorfuRuntime runtime,\n     protected UUID sendRequest(@NonNull ManagementClient managementClient) throws TimeoutException {\n         // Bootstrap a management server first.\n         Layout layout = new Layout(runtime.getLayoutView().getLayout());\n-        runtime.getManagementView().bootstrapManagementServer(nodeForWorkflow, layout).join();\n+        CFUtils.getUninterruptibly(runtime.getManagementView().bootstrapManagementServer(nodeForWorkflow, layout));", "originalCommit": "d4617805572ab12b609c0746e3dfcb124ba2280d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTk0NTM1MQ==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2478#discussion_r391945351", "bodyText": "Ok, I see. I'll pass the Network and TimeOut types here and return the 3 exceptions.", "author": "PavelZaytsev", "createdAt": "2020-03-12T22:47:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTk0NDQ2MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTk2NjgxNA==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2478#discussion_r391966814", "bodyText": "I think later on there should a cleanup patch on all the inherited children of sendRequest because others are not taking care of NetworkException, and the signature suggests it only throws TimeoutException.", "author": "WenbinZhu", "createdAt": "2020-03-13T00:05:27Z", "path": "runtime/src/main/java/org/corfudb/runtime/view/workflows/AddNode.java", "diffHunk": "@@ -44,9 +46,12 @@ public AddNode(@NonNull String endpointToAdd, @NonNull CorfuRuntime runtime,\n \n     @Override\n     protected UUID sendRequest(@NonNull ManagementClient managementClient) throws TimeoutException {", "originalCommit": "f691d6e25c41f4eb6c38c167634cb43deaa0b940", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTk2NzcxNQ==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2478#discussion_r391967715", "bodyText": "Sounds good.", "author": "PavelZaytsev", "createdAt": "2020-03-13T00:09:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTk2NjgxNA=="}], "type": "inlineReview"}, {"oid": "e208497639144f840edbd91eee343a10885ebd23", "url": "https://github.com/CorfuDB/CorfuDB/commit/e208497639144f840edbd91eee343a10885ebd23", "message": "Propagate exceptions when bootstrapping a management server during the AddNode workflow", "committedDate": "2020-03-13T00:14:19Z", "type": "commit"}, {"oid": "e208497639144f840edbd91eee343a10885ebd23", "url": "https://github.com/CorfuDB/CorfuDB/commit/e208497639144f840edbd91eee343a10885ebd23", "message": "Propagate exceptions when bootstrapping a management server during the AddNode workflow", "committedDate": "2020-03-13T00:14:19Z", "type": "forcePushed"}]}