{"pr_number": 2317, "pr_title": "PersistedStreamingMap SIGSEGV Fix", "pr_createdAt": "2020-01-21T21:46:16Z", "pr_url": "https://github.com/CorfuDB/CorfuDB/pull/2317", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTI2NjU2Mw==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2317#discussion_r369266563", "bodyText": "Can you make all these parameters configurable?\nAt least pass Options as a parameter in the constructor?\nOr any other way that helps make all the parameters configurable", "author": "xnull", "createdAt": "2020-01-21T22:01:01Z", "path": "runtime/src/main/java/org/corfudb/runtime/collections/PersistedStreamingMap.java", "diffHunk": "@@ -40,6 +45,37 @@\n         RocksDB.loadLibrary();\n     }\n \n+    /**\n+     * A set of options defined for disk-backed {@link CorfuTable}.\n+     *\n+     * For a set of options that dictate RocksDB memory usage can be found here:\n+     * https://github.com/facebook/rocksdb/wiki/Memory-usage-in-RocksDB\n+     *\n+     * Block Cache:  Which can be set via Options::setTableFormatConfig.\n+     *               Out of box, RocksDB will use LRU-based block cache\n+     *               implementation with 8MB capacity.\n+     * Index/Filter: Is a function of the block cache. Generally it infates\n+     *               the block cache by about 50%. The exact number can be\n+     *               retrieved via \"rocksdb.estimate-table-readers-mem\"\n+     *               property.\n+     * Write Buffer: Also known as memtable is defined by the ColumnFamilyOptions\n+     *               option. The default is 64 MB.\n+     */\n+    public static Options getPersistedStreamingMapOptions() {", "originalCommit": "ea4899da1add50a83c212c9bb4ab6009c77a00ca", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTI3NTk3Mw==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2317#discussion_r369275973", "bodyText": "Ok.", "author": "Maithem", "createdAt": "2020-01-21T22:24:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTI2NjU2Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDg2MjcyNw==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2317#discussion_r370862727", "bodyText": "Its kind of messy, because its passed to the constructor through a supplier. CorfuTable can be refactored in a different patch.", "author": "Maithem", "createdAt": "2020-01-24T22:03:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTI2NjU2Mw=="}], "type": "inlineReview"}, {"oid": "29d02da5da53f58d7542863b8a4ff04145246b9c", "url": "https://github.com/CorfuDB/CorfuDB/commit/29d02da5da53f58d7542863b8a4ff04145246b9c", "message": "PersistedStreamingMap SIGSEGV Fix\n\nThis patch fixes a bug where the iterator is accessed after it\nhas been closed, which ends up causing a segfault.", "committedDate": "2020-01-21T22:27:22Z", "type": "forcePushed"}, {"oid": "9c46cecf21f81db9f10e4417d5a766f6ab2fae32", "url": "https://github.com/CorfuDB/CorfuDB/commit/9c46cecf21f81db9f10e4417d5a766f6ab2fae32", "message": "PersistedStreamingMap SIGSEGV Fix\n\nThis patch fixes a bug where the iterator is accessed after it\nhas been closed, which ends up causing a segfault.", "committedDate": "2020-01-22T06:38:48Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDM0NDQ0NQ==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2317#discussion_r370344445", "bodyText": "should the iterator be closed in case of an exception?", "author": "hisundar", "createdAt": "2020-01-23T20:43:49Z", "path": "runtime/src/main/java/org/corfudb/runtime/collections/RocksDbEntryIterator.java", "diffHunk": "@@ -0,0 +1,84 @@\n+package org.corfudb.runtime.collections;\n+\n+import io.netty.buffer.Unpooled;\n+import org.corfudb.runtime.exceptions.unrecoverable.UnrecoverableCorfuError;\n+import org.corfudb.util.serializer.ISerializer;\n+import org.rocksdb.RocksDBException;\n+import org.rocksdb.RocksIterator;\n+\n+import java.util.AbstractMap;\n+import java.util.Iterator;\n+import java.util.Map;\n+import java.util.NoSuchElementException;\n+\n+/**\n+ *\n+ * Created by Maithem on 1/21/20.\n+ */\n+\n+public class RocksDbEntryIterator<K, V> implements Iterator<Map.Entry<K, V>>, AutoCloseable {\n+\n+    final private RocksIterator iterator;\n+    final private ISerializer serializer;\n+    private Map.Entry<K, V> next;\n+    public RocksDbEntryIterator(RocksIterator iterator, ISerializer serializer) {\n+        this.iterator = iterator;\n+        this.serializer = serializer;\n+        iterator.seekToFirst();\n+        checkInvariants();\n+    }\n+\n+    /**\n+     * {@inheritDoc}\n+     */\n+    @Override\n+    public boolean hasNext() {\n+        while (next == null && iterator.isValid()) {\n+            // Go ahead and cache that entry.\n+            next = new AbstractMap.SimpleEntry(\n+                    serializer.deserialize(Unpooled.wrappedBuffer(iterator.key()), null),\n+                    serializer.deserialize(Unpooled.wrappedBuffer(iterator.value()), null));\n+            // Advance the underlying iterator.\n+            iterator.next();\n+            checkInvariants();\n+        }\n+        return next != null;\n+    }\n+\n+    /**\n+     * {@inheritDoc}\n+     */\n+    @Override\n+    public Map.Entry<K, V> next() {\n+        if (hasNext()) {\n+            Map.Entry res = next;\n+            next = null;\n+            return res;\n+        } else {\n+            throw new NoSuchElementException();\n+        }\n+    }\n+\n+    /**\n+     * Ensure that this iterator is still valid.\n+     */\n+    private void checkInvariants() {\n+        try {\n+            iterator.status();\n+        } catch (RocksDBException e) {\n+            throw new UnrecoverableCorfuError(\"There was an error reading the persisted map.\", e);", "originalCommit": "9c46cecf21f81db9f10e4417d5a766f6ab2fae32", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDQzNjAyMw==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2317#discussion_r370436023", "bodyText": "It doesn't matter because that exception should crash the process. On exit the resources should be cleaned.", "author": "Maithem", "createdAt": "2020-01-24T01:18:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDM0NDQ0NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDQzNjE4MA==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2317#discussion_r370436180", "bodyText": "Stream consumers should use try-resource to invoke the close method.", "author": "Maithem", "createdAt": "2020-01-24T01:18:42Z", "path": "runtime/src/main/java/org/corfudb/runtime/collections/PersistedStreamingMap.java", "diffHunk": "@@ -318,9 +281,11 @@ public void clear() {\n         // If it is nullptr, the iterator will read from an implicit snapshot as of the time the\n         // iterator is created. The implicit snapshot is preserved by pinning resource.\n         readOptions.setSnapshot(null);\n-        final RocksIterator rocksIterator = rocksDb.newIterator(readOptions);\n-        rocksIterator.seekToFirst();\n-        return Streams.stream(new RocksDbIterator(rocksIterator));\n+        final RocksDbEntryIterator entryIterator = new RocksDbEntryIterator(rocksDb.newIterator(readOptions), serializer);\n+        Stream<Entry<K, V>> resStream = StreamSupport.stream(\n+                Spliterators.spliteratorUnknownSize(entryIterator, Spliterator.ORDERED), false);\n+        resStream.onClose(entryIterator::close);", "originalCommit": "9c46cecf21f81db9f10e4417d5a766f6ab2fae32", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDQ0NTgwMA==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2317#discussion_r370445800", "bodyText": "Disk-backed CorfuTable == PersistedStreamingMap, right? (This is unrelated) but can we add a comment to the description of this class making reference to this same name, so it's clear for any new reader and we can further on use it interchangeably.", "author": "annym", "createdAt": "2020-01-24T02:01:52Z", "path": "runtime/src/main/java/org/corfudb/runtime/collections/PersistedStreamingMap.java", "diffHunk": "@@ -40,6 +45,37 @@\n         RocksDB.loadLibrary();\n     }\n \n+    /**\n+     * A set of options defined for disk-backed {@link CorfuTable}.", "originalCommit": "d2489f00a3489a9487d447eaa7ed227025e7d377", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDg2MTQ4Nw==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2317#discussion_r370861487", "bodyText": "Yes.", "author": "Maithem", "createdAt": "2020-01-24T21:59:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDQ0NTgwMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDg2MTc5OQ==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2317#discussion_r370861799", "bodyText": "Changed.", "author": "Maithem", "createdAt": "2020-01-24T22:00:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDQ0NTgwMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDQ1NTQwOQ==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2317#discussion_r370455409", "bodyText": "Should we move this to a dedicated class, so it's obvious in the future that we need more tests for Persisted Corfu Table?", "author": "annym", "createdAt": "2020-01-24T02:56:05Z", "path": "test/src/test/java/org/corfudb/runtime/collections/CorfuTableTest.java", "diffHunk": "@@ -245,4 +255,47 @@ public void snapshotInvariant() {\n         final Stream<Map.Entry<Integer, Integer>> result = map.entryStream();\n         result.forEach(e -> map.put(new Random().nextInt(), 0));\n     }\n+\n+    @Test\n+    public void PersistedCorfuTableTests() {", "originalCommit": "d2489f00a3489a9487d447eaa7ed227025e7d377", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDg5MTE3MA==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2317#discussion_r370891170", "bodyText": "Done.", "author": "Maithem", "createdAt": "2020-01-24T23:58:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDQ1NTQwOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDQ1NTQ4OA==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2317#discussion_r370455488", "bodyText": "Can we add a test description?", "author": "annym", "createdAt": "2020-01-24T02:56:28Z", "path": "test/src/test/java/org/corfudb/runtime/collections/CorfuTableTest.java", "diffHunk": "@@ -245,4 +255,47 @@ public void snapshotInvariant() {\n         final Stream<Map.Entry<Integer, Integer>> result = map.entryStream();\n         result.forEach(e -> map.put(new Random().nextInt(), 0));\n     }\n+\n+    @Test", "originalCommit": "d2489f00a3489a9487d447eaa7ed227025e7d377", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDQ1NjA5MA==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2317#discussion_r370456090", "bodyText": "result.get? instead?", "author": "annym", "createdAt": "2020-01-24T02:59:59Z", "path": "test/src/test/java/org/corfudb/runtime/collections/CorfuTableTest.java", "diffHunk": "@@ -245,4 +255,47 @@ public void snapshotInvariant() {\n         final Stream<Map.Entry<Integer, Integer>> result = map.entryStream();\n         result.forEach(e -> map.put(new Random().nextInt(), 0));\n     }\n+\n+    @Test\n+    public void PersistedCorfuTableTests() {\n+        String path = PARAMETERS.TEST_TEMP_DIR;\n+\n+        CorfuRuntime rt = getDefaultRuntime();\n+\n+        UUID tableId = UUID.randomUUID();\n+        Supplier<StreamingMap<String, String>> mapSupplier = () ->\n+                new PersistedStreamingMap<>(Paths.get(path + tableId),\n+                        PersistedStreamingMap.getPersistedStreamingMapOptions(),\n+                        Serializers.JSON, rt);\n+\n+        CorfuTable<String, String> diskBackedMap = rt.getObjectsView()\n+                .build()\n+                .setTypeToken(new TypeToken<CorfuTable<String, String>>() {})\n+                .streamID(tableId)\n+                .setSerializer(Serializers.JSON)\n+                .setArguments(mapSupplier, ICorfuVersionPolicy.MONOTONIC)\n+                .open();\n+\n+        final int numKeys = 1002;\n+        for (int x = 0; x < numKeys; x++) {\n+            diskBackedMap.put(String.valueOf(x), \"payload\" + x);\n+        }\n+\n+        Map<String, String> result = new HashMap<>(numKeys);\n+\n+        Stream<Map.Entry<String, String>> stream = diskBackedMap.entryStream();\n+        final Iterable<List<Map.Entry<String, String>>> partitions = Iterables.partition(stream::iterator, 50);\n+\n+        for (List<Map.Entry<String, String>> partition : partitions) {\n+            for (Map.Entry<String, String> entry : partition) {\n+                result.put(entry.getKey(), entry.getValue());\n+            }\n+        }\n+\n+        assertThat(diskBackedMap.size()).isEqualTo(numKeys);\n+        assertThat(result.size()).isEqualTo(numKeys);\n+        for (Map.Entry<String, String> entry : result.entrySet()) {\n+            assertThat(diskBackedMap.get(entry.getKey())).isEqualTo(diskBackedMap.get(entry.getKey()));", "originalCommit": "d2489f00a3489a9487d447eaa7ed227025e7d377", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDg5MjEzNw==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2317#discussion_r370892137", "bodyText": "Good catch.", "author": "Maithem", "createdAt": "2020-01-25T00:04:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDQ1NjA5MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDc5MTM2Nw==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2317#discussion_r370791367", "bodyText": "What is the point of using Spliterator?", "author": "vjeko", "createdAt": "2020-01-24T18:59:16Z", "path": "runtime/src/main/java/org/corfudb/runtime/collections/PersistedStreamingMap.java", "diffHunk": "@@ -318,9 +281,11 @@ public void clear() {\n         // If it is nullptr, the iterator will read from an implicit snapshot as of the time the\n         // iterator is created. The implicit snapshot is preserved by pinning resource.\n         readOptions.setSnapshot(null);\n-        final RocksIterator rocksIterator = rocksDb.newIterator(readOptions);\n-        rocksIterator.seekToFirst();\n-        return Streams.stream(new RocksDbIterator(rocksIterator));\n+        final RocksDbEntryIterator entryIterator = new RocksDbEntryIterator(rocksDb.newIterator(readOptions), serializer);\n+        Stream<Entry<K, V>> resStream = StreamSupport.stream(\n+                Spliterators.spliteratorUnknownSize(entryIterator, Spliterator.ORDERED), false);", "originalCommit": "d2489f00a3489a9487d447eaa7ed227025e7d377", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDg3NTgwMA==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2317#discussion_r370875800", "bodyText": "Not needed.", "author": "Maithem", "createdAt": "2020-01-24T22:48:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDc5MTM2Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDc5MTY3Mg==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2317#discussion_r370791672", "bodyText": "Please remove this and add a proper JavaDoc comment.", "author": "vjeko", "createdAt": "2020-01-24T19:00:00Z", "path": "runtime/src/main/java/org/corfudb/runtime/collections/RocksDbEntryIterator.java", "diffHunk": "@@ -0,0 +1,84 @@\n+package org.corfudb.runtime.collections;\n+\n+import io.netty.buffer.Unpooled;\n+import org.corfudb.runtime.exceptions.unrecoverable.UnrecoverableCorfuError;\n+import org.corfudb.util.serializer.ISerializer;\n+import org.rocksdb.RocksDBException;\n+import org.rocksdb.RocksIterator;\n+\n+import java.util.AbstractMap;\n+import java.util.Iterator;\n+import java.util.Map;\n+import java.util.NoSuchElementException;\n+\n+/**\n+ *\n+ * Created by Maithem on 1/21/20.\n+ */\n+", "originalCommit": "d2489f00a3489a9487d447eaa7ed227025e7d377", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDg3NTg1Mg==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2317#discussion_r370875852", "bodyText": "Done.", "author": "Maithem", "createdAt": "2020-01-24T22:48:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDc5MTY3Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDc5NTMxNw==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2317#discussion_r370795317", "bodyText": "Why are you looping here? Can you give a use-case?", "author": "vjeko", "createdAt": "2020-01-24T19:08:38Z", "path": "runtime/src/main/java/org/corfudb/runtime/collections/RocksDbEntryIterator.java", "diffHunk": "@@ -0,0 +1,84 @@\n+package org.corfudb.runtime.collections;\n+\n+import io.netty.buffer.Unpooled;\n+import org.corfudb.runtime.exceptions.unrecoverable.UnrecoverableCorfuError;\n+import org.corfudb.util.serializer.ISerializer;\n+import org.rocksdb.RocksDBException;\n+import org.rocksdb.RocksIterator;\n+\n+import java.util.AbstractMap;\n+import java.util.Iterator;\n+import java.util.Map;\n+import java.util.NoSuchElementException;\n+\n+/**\n+ *\n+ * Created by Maithem on 1/21/20.\n+ */\n+\n+public class RocksDbEntryIterator<K, V> implements Iterator<Map.Entry<K, V>>, AutoCloseable {\n+\n+    final private RocksIterator iterator;\n+    final private ISerializer serializer;\n+    private Map.Entry<K, V> next;\n+    public RocksDbEntryIterator(RocksIterator iterator, ISerializer serializer) {\n+        this.iterator = iterator;\n+        this.serializer = serializer;\n+        iterator.seekToFirst();\n+        checkInvariants();\n+    }\n+\n+    /**\n+     * {@inheritDoc}\n+     */\n+    @Override\n+    public boolean hasNext() {\n+        while (next == null && iterator.isValid()) {", "originalCommit": "be38526c64596abaec44b1a9c8354d8e0fe7ad42", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDc5NzMyNg==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2317#discussion_r370797326", "bodyText": "close() should be idempotent and an extra check can be done here to see if the iterator has been closed before. From the documentation:\n     * However, implementers of this interface are strongly encouraged\n     * to make their {@code close} methods idempotent.", "author": "vjeko", "createdAt": "2020-01-24T19:13:29Z", "path": "runtime/src/main/java/org/corfudb/runtime/collections/RocksDbEntryIterator.java", "diffHunk": "@@ -0,0 +1,84 @@\n+package org.corfudb.runtime.collections;\n+\n+import io.netty.buffer.Unpooled;\n+import org.corfudb.runtime.exceptions.unrecoverable.UnrecoverableCorfuError;\n+import org.corfudb.util.serializer.ISerializer;\n+import org.rocksdb.RocksDBException;\n+import org.rocksdb.RocksIterator;\n+\n+import java.util.AbstractMap;\n+import java.util.Iterator;\n+import java.util.Map;\n+import java.util.NoSuchElementException;\n+\n+/**\n+ *\n+ * Created by Maithem on 1/21/20.\n+ */\n+\n+public class RocksDbEntryIterator<K, V> implements Iterator<Map.Entry<K, V>>, AutoCloseable {\n+\n+    final private RocksIterator iterator;\n+    final private ISerializer serializer;\n+    private Map.Entry<K, V> next;\n+    public RocksDbEntryIterator(RocksIterator iterator, ISerializer serializer) {\n+        this.iterator = iterator;\n+        this.serializer = serializer;\n+        iterator.seekToFirst();\n+        checkInvariants();\n+    }\n+\n+    /**\n+     * {@inheritDoc}\n+     */\n+    @Override\n+    public boolean hasNext() {\n+        while (next == null && iterator.isValid()) {\n+            // Go ahead and cache that entry.\n+            next = new AbstractMap.SimpleEntry(\n+                    serializer.deserialize(Unpooled.wrappedBuffer(iterator.key()), null),\n+                    serializer.deserialize(Unpooled.wrappedBuffer(iterator.value()), null));\n+            // Advance the underlying iterator.\n+            iterator.next();\n+            checkInvariants();\n+        }\n+        return next != null;\n+    }\n+\n+    /**\n+     * {@inheritDoc}\n+     */\n+    @Override\n+    public Map.Entry<K, V> next() {\n+        if (hasNext()) {\n+            Map.Entry res = next;\n+            next = null;\n+            return res;\n+        } else {\n+            throw new NoSuchElementException();\n+        }\n+    }\n+\n+    /**\n+     * Ensure that this iterator is still valid.\n+     */\n+    private void checkInvariants() {\n+        try {\n+            iterator.status();\n+        } catch (RocksDBException e) {\n+            throw new UnrecoverableCorfuError(\"There was an error reading the persisted map.\", e);\n+        }\n+    }\n+\n+    /**\n+     * {@inheritDoc}\n+     */\n+    @Override\n+    public void close() {\n+        // Release the underlying RocksDB resources\n+        if (!iterator.isOwningHandle()) {", "originalCommit": "be38526c64596abaec44b1a9c8354d8e0fe7ad42", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDg5MDE0OQ==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2317#discussion_r370890149", "bodyText": "It is\n    public void close() {\n        if (this.owningHandle_.compareAndSet(true, false)) {\n            this.disposeInternal();\n        }\n\n    }", "author": "Maithem", "createdAt": "2020-01-24T23:53:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDc5NzMyNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDgwNDk1Ng==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2317#discussion_r370804956", "bodyText": "All methods should check for multi-threaded access.  Also, this method should be executed on every API call.", "author": "vjeko", "createdAt": "2020-01-24T19:30:22Z", "path": "runtime/src/main/java/org/corfudb/runtime/collections/RocksDbEntryIterator.java", "diffHunk": "@@ -0,0 +1,84 @@\n+package org.corfudb.runtime.collections;\n+\n+import io.netty.buffer.Unpooled;\n+import org.corfudb.runtime.exceptions.unrecoverable.UnrecoverableCorfuError;\n+import org.corfudb.util.serializer.ISerializer;\n+import org.rocksdb.RocksDBException;\n+import org.rocksdb.RocksIterator;\n+\n+import java.util.AbstractMap;\n+import java.util.Iterator;\n+import java.util.Map;\n+import java.util.NoSuchElementException;\n+\n+/**\n+ *\n+ * Created by Maithem on 1/21/20.\n+ */\n+\n+public class RocksDbEntryIterator<K, V> implements Iterator<Map.Entry<K, V>>, AutoCloseable {\n+\n+    final private RocksIterator iterator;\n+    final private ISerializer serializer;\n+    private Map.Entry<K, V> next;\n+    public RocksDbEntryIterator(RocksIterator iterator, ISerializer serializer) {\n+        this.iterator = iterator;\n+        this.serializer = serializer;\n+        iterator.seekToFirst();\n+        checkInvariants();\n+    }\n+\n+    /**\n+     * {@inheritDoc}\n+     */\n+    @Override\n+    public boolean hasNext() {\n+        while (next == null && iterator.isValid()) {\n+            // Go ahead and cache that entry.\n+            next = new AbstractMap.SimpleEntry(\n+                    serializer.deserialize(Unpooled.wrappedBuffer(iterator.key()), null),\n+                    serializer.deserialize(Unpooled.wrappedBuffer(iterator.value()), null));\n+            // Advance the underlying iterator.\n+            iterator.next();\n+            checkInvariants();\n+        }\n+        return next != null;\n+    }\n+\n+    /**\n+     * {@inheritDoc}\n+     */\n+    @Override\n+    public Map.Entry<K, V> next() {\n+        if (hasNext()) {\n+            Map.Entry res = next;\n+            next = null;\n+            return res;\n+        } else {\n+            throw new NoSuchElementException();\n+        }\n+    }\n+\n+    /**\n+     * Ensure that this iterator is still valid.\n+     */\n+    private void checkInvariants() {", "originalCommit": "be38526c64596abaec44b1a9c8354d8e0fe7ad42", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDg4OTg4Ng==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2317#discussion_r370889886", "bodyText": "Done.", "author": "Maithem", "createdAt": "2020-01-24T23:51:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDgwNDk1Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDgwOTIyOQ==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2317#discussion_r370809229", "bodyText": "This test is using checkpointer specific logic, so it should be moved to CheckpointTest. A unit test should be checking for more specific functionality -- for example -- calling hasNext() on a closed iterator behaves as expected.", "author": "vjeko", "createdAt": "2020-01-24T19:40:19Z", "path": "test/src/test/java/org/corfudb/runtime/collections/CorfuTableTest.java", "diffHunk": "@@ -245,4 +255,47 @@ public void snapshotInvariant() {\n         final Stream<Map.Entry<Integer, Integer>> result = map.entryStream();\n         result.forEach(e -> map.put(new Random().nextInt(), 0));\n     }\n+\n+    @Test\n+    public void PersistedCorfuTableTests() {", "originalCommit": "be38526c64596abaec44b1a9c8354d8e0fe7ad42", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDg5MTU4Nw==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2317#discussion_r370891587", "bodyText": "Its not checkpoint specific, although the checkpointer uses this, the API, a CorfuTable method that doesn't work.", "author": "Maithem", "createdAt": "2020-01-25T00:01:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDgwOTIyOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDg5ODU1Mg==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2317#discussion_r370898552", "bodyText": "This code was pretty much copied from CheckpointWriter::appendObjectState. Can you please add proper unit tests? Both positive and negative tests. You can add them to DiskBackedCorfuClientTest.", "author": "vjeko", "createdAt": "2020-01-25T00:46:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDgwOTIyOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzE5NjMyNg==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2317#discussion_r373196326", "bodyText": "This test belongs to CheckpointTest. Also, added more tests.", "author": "Maithem", "createdAt": "2020-01-30T21:13:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDgwOTIyOQ=="}], "type": "inlineReview"}, {"oid": "175d40521fc0e9fa0248da6f8e4e52caa03b531a", "url": "https://github.com/CorfuDB/CorfuDB/commit/175d40521fc0e9fa0248da6f8e4e52caa03b531a", "message": "PersistedStreamingMap SIGSEGV Fix\n\nThis patch fixes a bug where the iterator is accessed after it\nhas been closed, which ends up causing a segfault.", "committedDate": "2020-01-25T00:07:44Z", "type": "forcePushed"}, {"oid": "e3f98a688607183d2b00c80b8542bdc75a92f56d", "url": "https://github.com/CorfuDB/CorfuDB/commit/e3f98a688607183d2b00c80b8542bdc75a92f56d", "message": "PersistedStreamingMap SIGSEGV Fix\n\nThis patch fixes a bug where the iterator is accessed after it\nhas been closed, which ends up causing a segfault.", "committedDate": "2020-01-25T00:11:21Z", "type": "forcePushed"}, {"oid": "e34d1a00cffcf59cee327054764cdddde64985c7", "url": "https://github.com/CorfuDB/CorfuDB/commit/e34d1a00cffcf59cee327054764cdddde64985c7", "message": "PersistedStreamingMap SIGSEGV Fix\n\nThis patch fixes a bug where the iterator is accessed after it\nhas been closed, which ends up causing a segfault.", "committedDate": "2020-01-25T00:36:41Z", "type": "forcePushed"}, {"oid": "69c7e137c29bfbe030c05d9892e0b0cbbef60f08", "url": "https://github.com/CorfuDB/CorfuDB/commit/69c7e137c29bfbe030c05d9892e0b0cbbef60f08", "message": "PersistedStreamingMap SIGSEGV Fix\n\nThis patch fixes a bug where the iterator is accessed after it\nhas been closed, which ends up causing a segfault.", "committedDate": "2020-01-25T00:44:48Z", "type": "forcePushed"}, {"oid": "492590e02c607e173e8a4af7325b54bc153a91f7", "url": "https://github.com/CorfuDB/CorfuDB/commit/492590e02c607e173e8a4af7325b54bc153a91f7", "message": "PersistedStreamingMap SIGSEGV Fix\n\nThis patch fixes a bug where the iterator is accessed after it\nhas been closed, which ends up causing a segfault.", "committedDate": "2020-01-25T22:24:05Z", "type": "forcePushed"}, {"oid": "d69cd0407c5094769865e0e055a7272cb32205df", "url": "https://github.com/CorfuDB/CorfuDB/commit/d69cd0407c5094769865e0e055a7272cb32205df", "message": "PersistedStreamingMap SIGSEGV Fix\n\nThis patch fixes a bug where the iterator is accessed after it\nhas been closed, which ends up causing a segfault.", "committedDate": "2020-01-26T01:19:50Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTYzMDMxOA==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2317#discussion_r371630318", "bodyText": "Can we have more descriptive exception message here?", "author": "WenbinZhu", "createdAt": "2020-01-28T06:41:47Z", "path": "runtime/src/main/java/org/corfudb/runtime/collections/CheckedRocksIterator.java", "diffHunk": "@@ -0,0 +1,139 @@\n+package org.corfudb.runtime.collections;\n+\n+import org.corfudb.runtime.exceptions.unrecoverable.UnrecoverableCorfuError;\n+import org.rocksdb.RocksDBException;\n+import org.rocksdb.RocksIterator;\n+import org.rocksdb.RocksIteratorInterface;\n+\n+/**\n+ *\n+ * A wrapper class that makes a access to the RocksIterator safe: the rocks library does some checks but they\n+ * are enforced via assert, but assert checking is disabled on many jvms by default, hence the explicit checking.\n+ *\n+ * Created by Maithem on 1/24/20.\n+ */\n+public class CheckedRocksIterator implements RocksIteratorInterface {\n+\n+    private final RocksIterator iterator;\n+    public CheckedRocksIterator(RocksIterator iterator) {\n+        this.iterator = iterator;\n+    }\n+\n+    private void checkHandle() {\n+        if (!iterator.isOwningHandle()) {\n+            throw new IllegalStateException(\"Handle is invalid\");", "originalCommit": "9815e327dd6c2266023273f0ef28f1259ff759cc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzEyNjI1NQ==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2317#discussion_r373126255", "bodyText": "Done.", "author": "Maithem", "createdAt": "2020-01-30T18:45:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTYzMDMxOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzE0NTQxMg==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2317#discussion_r373145412", "bodyText": "The only reason why this exception will be thrown is because the current thread does not own the handle, so the message should reflect that.  More specifically, the handle can be invalid either due to:\n\nMulti threaded access.\nThe iterator has been previously closed.", "author": "vjeko", "createdAt": "2020-01-30T19:23:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTYzMDMxOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTYzMjYzNA==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2317#discussion_r371632634", "bodyText": "Typo: infates -> inflates", "author": "WenbinZhu", "createdAt": "2020-01-28T06:52:25Z", "path": "runtime/src/main/java/org/corfudb/runtime/collections/PersistedStreamingMap.java", "diffHunk": "@@ -40,6 +38,37 @@\n         RocksDB.loadLibrary();\n     }\n \n+    /**\n+     * A set of options defined for disk-backed {@link PersistedStreamingMap}.\n+     *\n+     * For a set of options that dictate RocksDB memory usage can be found here:\n+     * https://github.com/facebook/rocksdb/wiki/Memory-usage-in-RocksDB\n+     *\n+     * Block Cache:  Which can be set via Options::setTableFormatConfig.\n+     *               Out of box, RocksDB will use LRU-based block cache\n+     *               implementation with 8MB capacity.\n+     * Index/Filter: Is a function of the block cache. Generally it infates", "originalCommit": "9815e327dd6c2266023273f0ef28f1259ff759cc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTYzNzY5OQ==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2317#discussion_r371637699", "bodyText": "According to this: https://github.com/facebook/rocksdb/blob/master/java/src/main/java/org/rocksdb/ReadOptions.java#L11\nI think we need to call readOptions.close() before returning to prevent memory leak. (dispose is deprecated, so using close())", "author": "WenbinZhu", "createdAt": "2020-01-28T07:12:26Z", "path": "runtime/src/main/java/org/corfudb/runtime/collections/PersistedStreamingMap.java", "diffHunk": "@@ -318,9 +274,13 @@ public void clear() {\n         // If it is nullptr, the iterator will read from an implicit snapshot as of the time the\n         // iterator is created. The implicit snapshot is preserved by pinning resource.\n         readOptions.setSnapshot(null);\n-        final RocksIterator rocksIterator = rocksDb.newIterator(readOptions);\n-        rocksIterator.seekToFirst();\n-        return Streams.stream(new RocksDbIterator(rocksIterator));\n+        final RocksDbEntryIterator entryIterator =\n+                new RocksDbEntryIterator(rocksDb.newIterator(readOptions), serializer);\n+        // It's necessary to use the RocksDbEntryIterator as try-with resource to ensure\n+        // the iterator is close, otherwise underlying RocksDB resources can leak\n+        Stream<Entry<K, V>> resStream = Streams.stream(entryIterator);\n+        resStream.onClose(entryIterator::close);", "originalCommit": "9815e327dd6c2266023273f0ef28f1259ff759cc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzEyNzg5NA==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2317#discussion_r373127894", "bodyText": "Didn't know about this. Thanks!\nIt will get released through finalized, but we shouldn't relay on that.", "author": "Maithem", "createdAt": "2020-01-30T18:48:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTYzNzY5OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzEyODA0MA==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2317#discussion_r373128040", "bodyText": "Done.", "author": "Maithem", "createdAt": "2020-01-30T18:49:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTYzNzY5OQ=="}], "type": "inlineReview"}, {"oid": "9332c2d6a693d92417958d897c0043af7868f939", "url": "https://github.com/CorfuDB/CorfuDB/commit/9332c2d6a693d92417958d897c0043af7868f939", "message": "PersistedStreamingMap Iterator Bug\n\nThis patch fixes a bug where the iterator is accessed after it\nhas been closed, which ends up causing a segfault.", "committedDate": "2020-01-30T21:11:07Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzE0NjkxNA==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2317#discussion_r373146914", "bodyText": "You should explain what constitutes a valid or invalid iterator.", "author": "vjeko", "createdAt": "2020-01-30T19:25:52Z", "path": "runtime/src/main/java/org/corfudb/runtime/collections/CheckedRocksIterator.java", "diffHunk": "@@ -0,0 +1,139 @@\n+package org.corfudb.runtime.collections;\n+\n+import org.corfudb.runtime.exceptions.unrecoverable.UnrecoverableCorfuError;\n+import org.rocksdb.RocksDBException;\n+import org.rocksdb.RocksIterator;\n+import org.rocksdb.RocksIteratorInterface;\n+\n+/**\n+ *\n+ * A wrapper class that makes a access to the RocksIterator safe: the rocks library does some checks but they\n+ * are enforced via assert, but assert checking is disabled on many jvms by default, hence the explicit checking.\n+ *\n+ * Created by Maithem on 1/24/20.\n+ */\n+public class CheckedRocksIterator implements RocksIteratorInterface {\n+\n+    private final RocksIterator iterator;\n+    public CheckedRocksIterator(RocksIterator iterator) {\n+        this.iterator = iterator;\n+    }\n+\n+    private void checkHandle() {\n+        if (!iterator.isOwningHandle()) {\n+            throw new IllegalStateException(\"Handle is invalid\");\n+        }\n+    }\n+\n+    /**\n+     * {@inheritDoc}\n+     */\n+    @Override\n+    public boolean isValid() {\n+        checkHandle();\n+        boolean res =  iterator.isValid();\n+        checkStatus();\n+        return res;\n+    }\n+\n+    /**\n+     * {@inheritDoc}\n+     */\n+    @Override\n+    public void seekToFirst() {\n+        checkHandle();\n+        iterator.seekToFirst();\n+        checkStatus();\n+    }\n+\n+    /**\n+     * {@inheritDoc}\n+     */\n+    @Override\n+    public void seekToLast() {\n+        throw new UnsupportedOperationException(\"seekToLast\");\n+    }\n+\n+    /**\n+     * {@inheritDoc}\n+     */\n+    @Override\n+    public void seek(byte[] target) {\n+        throw new UnsupportedOperationException(\"seek\");\n+    }\n+\n+\n+    /**\n+     * {@inheritDoc}\n+     */\n+    @Override\n+    public void seekForPrev(byte[] target){\n+        throw new UnsupportedOperationException(\"seekForPrev\");\n+    }\n+\n+\n+    /**\n+     * {@inheritDoc}\n+     */\n+    @Override\n+    public void next() {\n+       checkHandle();\n+       iterator.next();\n+       checkStatus();\n+    }\n+\n+    /**\n+     * {@inheritDoc}\n+     */\n+    @Override\n+    public void prev() {\n+        throw new UnsupportedOperationException(\"prev\");\n+    }\n+\n+    /**\n+     * Returns the key of the current position of the iterator.\n+     */\n+    public byte[] key() {\n+        checkHandle();\n+        byte[] res = iterator.key();\n+        checkStatus();\n+        return res;\n+    }\n+\n+    /**\n+     * Returns the value of the current position of the iterator.\n+     */\n+    public byte[] value() {\n+        checkHandle();\n+        byte[] res = iterator.value();\n+        checkStatus();\n+        return res;\n+    }\n+\n+\n+    /**\n+     * {@inheritDoc}\n+     */\n+    @Override\n+    public void status() throws RocksDBException {\n+        throw new UnsupportedOperationException(\"status\");\n+    }\n+\n+    /**\n+     * Verifies that the iterator is in a valid state.\n+     */", "originalCommit": "9815e327dd6c2266023273f0ef28f1259ff759cc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzE4MDgyMQ==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2317#discussion_r373180821", "bodyText": "There is really no good reason for this class to live outside of PersistedStreamingMap -- both the ISerializer as well as the generic parameters are already tied to to encompassing class. We should avoid unnecessary bloat.", "author": "vjeko", "createdAt": "2020-01-30T20:37:49Z", "path": "runtime/src/main/java/org/corfudb/runtime/collections/RocksDbEntryIterator.java", "diffHunk": "@@ -0,0 +1,83 @@\n+package org.corfudb.runtime.collections;\n+\n+import io.netty.buffer.Unpooled;\n+import org.corfudb.runtime.exceptions.unrecoverable.UnrecoverableCorfuError;\n+import org.corfudb.util.serializer.ISerializer;\n+import org.rocksdb.RocksDBException;\n+import org.rocksdb.RocksIterator;\n+\n+import javax.annotation.concurrent.NotThreadSafe;\n+import java.util.AbstractMap;\n+import java.util.Iterator;\n+import java.util.Map;\n+import java.util.NoSuchElementException;\n+\n+/**\n+ *\n+ * A wrapper class that makes a RocksIterator compatible with Java {@link Iterator}.\n+ *\n+ * Created by Maithem on 1/21/20.\n+ */\n+@NotThreadSafe", "originalCommit": "9815e327dd6c2266023273f0ef28f1259ff759cc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzE5NDE2Mw==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2317#discussion_r373194163", "bodyText": "If we detect that the iterator has reached the end, we should go ahead and relinquish the resources immediately, rather than relying on try-with-resource or GC. This is a more robust solution since it is not guaranteed that the client will use try-with-resource.", "author": "vjeko", "createdAt": "2020-01-30T21:08:13Z", "path": "runtime/src/main/java/org/corfudb/runtime/collections/RocksDbEntryIterator.java", "diffHunk": "@@ -0,0 +1,83 @@\n+package org.corfudb.runtime.collections;\n+\n+import io.netty.buffer.Unpooled;\n+import org.corfudb.runtime.exceptions.unrecoverable.UnrecoverableCorfuError;\n+import org.corfudb.util.serializer.ISerializer;\n+import org.rocksdb.RocksDBException;\n+import org.rocksdb.RocksIterator;\n+\n+import javax.annotation.concurrent.NotThreadSafe;\n+import java.util.AbstractMap;\n+import java.util.Iterator;\n+import java.util.Map;\n+import java.util.NoSuchElementException;\n+\n+/**\n+ *\n+ * A wrapper class that makes a RocksIterator compatible with Java {@link Iterator}.\n+ *\n+ * Created by Maithem on 1/21/20.\n+ */\n+@NotThreadSafe\n+public class RocksDbEntryIterator<K, V> implements Iterator<Map.Entry<K, V>>, AutoCloseable {\n+\n+    /**\n+     * A reference to the underlying rocksdb iterator\n+     */\n+    final private CheckedRocksIterator checkedIterator;\n+\n+    /**\n+     * Serializer to serialize/deserialize the key/values\n+     */\n+    final private ISerializer serializer;\n+\n+    /**\n+     * place holder for the current value\n+     */\n+    private Map.Entry<K, V> next;\n+\n+    public RocksDbEntryIterator(RocksIterator iterator, ISerializer serializer) {\n+        this.checkedIterator = new CheckedRocksIterator(iterator);\n+        this.serializer = serializer;\n+        iterator.seekToFirst();\n+    }\n+\n+    /**\n+     * {@inheritDoc}\n+     */\n+    @Override\n+    public boolean hasNext() {\n+        if (next == null && checkedIterator.isValid()) {", "originalCommit": "9815e327dd6c2266023273f0ef28f1259ff759cc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzIzNzQ0NQ==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2317#discussion_r373237445", "bodyText": "Not really, that assumes all stream consumers have to consume the full stream, which is an incorrect assumption. Consumers have to the stream whether explicitly or with try-with-resources", "author": "Maithem", "createdAt": "2020-01-30T22:53:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzE5NDE2Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzE5OTcxNw==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2317#discussion_r373199717", "bodyText": "This message should be more descriptive. The only was for the handle to be invalid is either if:\n\nThere is some other thread trying to access the iterator.\nThe iterator has been previously closed.\n\nThe message should reflect the above conditions.", "author": "vjeko", "createdAt": "2020-01-30T21:20:59Z", "path": "runtime/src/main/java/org/corfudb/runtime/collections/WrappedRocksIterator.java", "diffHunk": "@@ -0,0 +1,143 @@\n+package org.corfudb.runtime.collections;\n+\n+import org.corfudb.runtime.exceptions.unrecoverable.UnrecoverableCorfuError;\n+import org.rocksdb.RocksDBException;\n+import org.rocksdb.RocksIterator;\n+import org.rocksdb.RocksIteratorInterface;\n+\n+/**\n+ *\n+ * A wrapper class that makes a access to the RocksIterator safe: the rocks library does some checks but they\n+ * are enforced via assert, but assert checking is disabled on many jvms by default, hence the explicit checking.\n+ *\n+ * Created by Maithem on 1/24/20.\n+ */\n+public class WrappedRocksIterator implements RocksIteratorInterface {\n+\n+    private final RocksIterator iterator;\n+    public WrappedRocksIterator(RocksIterator iterator) {\n+        this.iterator = iterator;\n+    }\n+\n+    /**\n+     * A helper method that is called before accessing the iterator.\n+     * This is necessary to make sure that access happens on an owned handle.\n+     */\n+    private void checkHandle() {\n+        if (!iterator.isOwningHandle()) {\n+            throw new IllegalStateException(\"RocksIterator handle is not valid\");\n+        }", "originalCommit": "9332c2d6a693d92417958d897c0043af7868f939", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzIwNTc2NA==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2317#discussion_r373205764", "bodyText": "checkStatus() and status() should behave the same. The implementation of this interface can be less restrictive, thus you are not required to throw RocksDBException, allowing you to merge these two methods.", "author": "vjeko", "createdAt": "2020-01-30T21:35:12Z", "path": "runtime/src/main/java/org/corfudb/runtime/collections/WrappedRocksIterator.java", "diffHunk": "@@ -0,0 +1,143 @@\n+package org.corfudb.runtime.collections;\n+\n+import org.corfudb.runtime.exceptions.unrecoverable.UnrecoverableCorfuError;\n+import org.rocksdb.RocksDBException;\n+import org.rocksdb.RocksIterator;\n+import org.rocksdb.RocksIteratorInterface;\n+\n+/**\n+ *\n+ * A wrapper class that makes a access to the RocksIterator safe: the rocks library does some checks but they\n+ * are enforced via assert, but assert checking is disabled on many jvms by default, hence the explicit checking.\n+ *\n+ * Created by Maithem on 1/24/20.\n+ */\n+public class WrappedRocksIterator implements RocksIteratorInterface {\n+\n+    private final RocksIterator iterator;\n+    public WrappedRocksIterator(RocksIterator iterator) {\n+        this.iterator = iterator;\n+    }\n+\n+    /**\n+     * A helper method that is called before accessing the iterator.\n+     * This is necessary to make sure that access happens on an owned handle.\n+     */\n+    private void checkHandle() {\n+        if (!iterator.isOwningHandle()) {\n+            throw new IllegalStateException(\"RocksIterator handle is not valid\");\n+        }\n+    }\n+\n+    /**\n+     * {@inheritDoc}\n+     */\n+    @Override\n+    public boolean isValid() {\n+        checkHandle();\n+        boolean res =  iterator.isValid();\n+        checkStatus();\n+        return res;\n+    }\n+\n+    /**\n+     * {@inheritDoc}\n+     */\n+    @Override\n+    public void seekToFirst() {\n+        checkHandle();\n+        iterator.seekToFirst();\n+        checkStatus();\n+    }\n+\n+    /**\n+     * {@inheritDoc}\n+     */\n+    @Override\n+    public void seekToLast() {\n+        throw new UnsupportedOperationException(\"seekToLast\");\n+    }\n+\n+    /**\n+     * {@inheritDoc}\n+     */\n+    @Override\n+    public void seek(byte[] target) {\n+        throw new UnsupportedOperationException(\"seek\");\n+    }\n+\n+\n+    /**\n+     * {@inheritDoc}\n+     */\n+    @Override\n+    public void seekForPrev(byte[] target){\n+        throw new UnsupportedOperationException(\"seekForPrev\");\n+    }\n+\n+\n+    /**\n+     * {@inheritDoc}\n+     */\n+    @Override\n+    public void next() {\n+       checkHandle();\n+       iterator.next();\n+       checkStatus();\n+    }\n+\n+    /**\n+     * {@inheritDoc}\n+     */\n+    @Override\n+    public void prev() {\n+        throw new UnsupportedOperationException(\"prev\");\n+    }\n+\n+    /**\n+     * Returns the key of the current position of the iterator.\n+     */\n+    public byte[] key() {\n+        checkHandle();\n+        byte[] res = iterator.key();\n+        checkStatus();\n+        return res;\n+    }\n+\n+    /**\n+     * Returns the value of the current position of the iterator.\n+     */\n+    public byte[] value() {\n+        checkHandle();\n+        byte[] res = iterator.value();\n+        checkStatus();\n+        return res;\n+    }\n+\n+\n+    /**\n+     * {@inheritDoc}\n+     */\n+    @Override\n+    public void status() throws RocksDBException {\n+        throw new UnsupportedOperationException(\"status\");", "originalCommit": "9332c2d6a693d92417958d897c0043af7868f939", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzIwNzM5OQ==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2317#discussion_r373207399", "bodyText": "You should document what constitutes a valid status. You can take a look at:\nhttps://github.com/facebook/rocksdb/wiki/Iterator\nAnd reference some parts of the Error Handling section.", "author": "vjeko", "createdAt": "2020-01-30T21:38:56Z", "path": "runtime/src/main/java/org/corfudb/runtime/collections/WrappedRocksIterator.java", "diffHunk": "@@ -0,0 +1,143 @@\n+package org.corfudb.runtime.collections;\n+\n+import org.corfudb.runtime.exceptions.unrecoverable.UnrecoverableCorfuError;\n+import org.rocksdb.RocksDBException;\n+import org.rocksdb.RocksIterator;\n+import org.rocksdb.RocksIteratorInterface;\n+\n+/**\n+ *\n+ * A wrapper class that makes a access to the RocksIterator safe: the rocks library does some checks but they\n+ * are enforced via assert, but assert checking is disabled on many jvms by default, hence the explicit checking.\n+ *\n+ * Created by Maithem on 1/24/20.\n+ */\n+public class WrappedRocksIterator implements RocksIteratorInterface {\n+\n+    private final RocksIterator iterator;\n+    public WrappedRocksIterator(RocksIterator iterator) {\n+        this.iterator = iterator;\n+    }\n+\n+    /**\n+     * A helper method that is called before accessing the iterator.\n+     * This is necessary to make sure that access happens on an owned handle.\n+     */\n+    private void checkHandle() {\n+        if (!iterator.isOwningHandle()) {\n+            throw new IllegalStateException(\"RocksIterator handle is not valid\");\n+        }\n+    }\n+\n+    /**\n+     * {@inheritDoc}\n+     */\n+    @Override\n+    public boolean isValid() {\n+        checkHandle();\n+        boolean res =  iterator.isValid();\n+        checkStatus();\n+        return res;\n+    }\n+\n+    /**\n+     * {@inheritDoc}\n+     */\n+    @Override\n+    public void seekToFirst() {\n+        checkHandle();\n+        iterator.seekToFirst();\n+        checkStatus();\n+    }\n+\n+    /**\n+     * {@inheritDoc}\n+     */\n+    @Override\n+    public void seekToLast() {\n+        throw new UnsupportedOperationException(\"seekToLast\");\n+    }\n+\n+    /**\n+     * {@inheritDoc}\n+     */\n+    @Override\n+    public void seek(byte[] target) {\n+        throw new UnsupportedOperationException(\"seek\");\n+    }\n+\n+\n+    /**\n+     * {@inheritDoc}\n+     */\n+    @Override\n+    public void seekForPrev(byte[] target){\n+        throw new UnsupportedOperationException(\"seekForPrev\");\n+    }\n+\n+\n+    /**\n+     * {@inheritDoc}\n+     */\n+    @Override\n+    public void next() {\n+       checkHandle();\n+       iterator.next();\n+       checkStatus();\n+    }\n+\n+    /**\n+     * {@inheritDoc}\n+     */\n+    @Override\n+    public void prev() {\n+        throw new UnsupportedOperationException(\"prev\");\n+    }\n+\n+    /**\n+     * Returns the key of the current position of the iterator.\n+     */\n+    public byte[] key() {\n+        checkHandle();\n+        byte[] res = iterator.key();\n+        checkStatus();\n+        return res;\n+    }\n+\n+    /**\n+     * Returns the value of the current position of the iterator.\n+     */\n+    public byte[] value() {\n+        checkHandle();\n+        byte[] res = iterator.value();\n+        checkStatus();\n+        return res;\n+    }\n+\n+\n+    /**\n+     * {@inheritDoc}\n+     */\n+    @Override\n+    public void status() throws RocksDBException {\n+        throw new UnsupportedOperationException(\"status\");\n+    }\n+\n+    /**\n+     * Verifies that the iterator is in a valid state.\n+     */\n+    private void checkStatus() {\n+        try {\n+            iterator.status();", "originalCommit": "9332c2d6a693d92417958d897c0043af7868f939", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzIwODAyNw==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2317#discussion_r373208027", "bodyText": "None of these changes are necessary.", "author": "vjeko", "createdAt": "2020-01-30T21:40:26Z", "path": "test/src/test/java/org/corfudb/runtime/collections/CorfuTableTest.java", "diffHunk": "@@ -1,21 +1,31 @@\n package org.corfudb.runtime.collections;\n \n import static org.assertj.core.api.Assertions.assertThat;\n+\n+import com.google.common.collect.Iterables;\n import com.google.common.reflect.TypeToken;\n \n+import java.nio.file.Paths;\n import java.util.ArrayList;\n import java.util.Collection;\n import java.util.ConcurrentModificationException;\n+import java.util.HashMap;\n+import java.util.List;\n import java.util.Map;\n import java.util.Random;\n+import java.util.UUID;\n+import java.util.function.Supplier;\n import java.util.stream.Collectors;\n import java.util.stream.IntStream;\n import java.util.stream.Stream;\n \n import org.assertj.core.api.Assertions;\n import org.assertj.core.data.MapEntry;\n+import org.corfudb.runtime.CorfuRuntime;\n import org.corfudb.runtime.exceptions.unrecoverable.UnrecoverableCorfuError;\n+import org.corfudb.runtime.object.ICorfuVersionPolicy;\n import org.corfudb.runtime.view.AbstractViewTest;\n+import org.corfudb.util.serializer.Serializers;", "originalCommit": "9332c2d6a693d92417958d897c0043af7868f939", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "b5a327f0349c6d6cc73e2b148f60a126e38dfa85", "url": "https://github.com/CorfuDB/CorfuDB/commit/b5a327f0349c6d6cc73e2b148f60a126e38dfa85", "message": "PersistedStreamingMap Iterator Bug\n\nThis patch fixes a bug where the iterator is accessed after it\nhas been closed, which ends up causing a segfault.", "committedDate": "2020-01-30T22:26:19Z", "type": "forcePushed"}, {"oid": "5d16dca93a14272c50e3d18b1011da93c5d46d3f", "url": "https://github.com/CorfuDB/CorfuDB/commit/5d16dca93a14272c50e3d18b1011da93c5d46d3f", "message": "PersistedStreamingMap Iterator Bug\n\nThis patch fixes a bug where the iterator is accessed after it\nhas been closed, which ends up causing a segfault.", "committedDate": "2020-01-30T23:01:50Z", "type": "forcePushed"}, {"oid": "8d596bdce45f29b6af9b73326360c7f988c23d4c", "url": "https://github.com/CorfuDB/CorfuDB/commit/8d596bdce45f29b6af9b73326360c7f988c23d4c", "message": "PersistedStreamingMap Iterator Bug\n\nThis patch fixes a bug where the iterator is accessed after it\nhas been closed, which ends up causing a segfault.", "committedDate": "2020-01-30T23:05:05Z", "type": "commit"}, {"oid": "8d596bdce45f29b6af9b73326360c7f988c23d4c", "url": "https://github.com/CorfuDB/CorfuDB/commit/8d596bdce45f29b6af9b73326360c7f988c23d4c", "message": "PersistedStreamingMap Iterator Bug\n\nThis patch fixes a bug where the iterator is accessed after it\nhas been closed, which ends up causing a segfault.", "committedDate": "2020-01-30T23:05:05Z", "type": "forcePushed"}]}