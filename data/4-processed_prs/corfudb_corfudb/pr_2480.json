{"pr_number": 2480, "pr_title": "Fix LogData lastKnownSize which is inaccurate and inconsistent.", "pr_createdAt": "2020-03-14T02:09:30Z", "pr_url": "https://github.com/CorfuDB/CorfuDB/pull/2480", "timeline": [{"oid": "592d91925f3b7667e7d3cc5fa90560dbc84403f1", "url": "https://github.com/CorfuDB/CorfuDB/commit/592d91925f3b7667e7d3cc5fa90560dbc84403f1", "message": "Fix LogData lastKnownSize which is inaccurate and inconsistent.\n\nWhen set during serialization and deserialization, the LogData\nlastKnownSize is set to different values. It is also inaccurate\nas it is set to ByteBuf's internal array length during serialization,\nwhich is usually larger the actually (it is dynamically resized and\nusually 2x of previous size). It needs to be set to the payload's\nserialized size.", "committedDate": "2020-03-14T02:11:57Z", "type": "forcePushed"}, {"oid": "942961936f219b6e12c55d3a546e10cdd5c4b1ca", "url": "https://github.com/CorfuDB/CorfuDB/commit/942961936f219b6e12c55d3a546e10cdd5c4b1ca", "message": "Fix LogData lastKnownSize which is inaccurate and inconsistent.\n\n- When set during serialization and deserialization, the LogData\nlastKnownSize is set to different values. It is also inaccurate\nas it is set to ByteBuf's internal array length during serialization,\nwhich is usually larger the actually (it is dynamically resized and\nusually 2x of previous size). It needs to be set to the payload's\nserialized size. This incorrect behavior affects transaction size\nlimit calculation, which results in unnecessary WriteSizeException.\n\n- Also fixed a test where compression should be ruled out.", "committedDate": "2020-03-14T02:15:03Z", "type": "commit"}, {"oid": "942961936f219b6e12c55d3a546e10cdd5c4b1ca", "url": "https://github.com/CorfuDB/CorfuDB/commit/942961936f219b6e12c55d3a546e10cdd5c4b1ca", "message": "Fix LogData lastKnownSize which is inaccurate and inconsistent.\n\n- When set during serialization and deserialization, the LogData\nlastKnownSize is set to different values. It is also inaccurate\nas it is set to ByteBuf's internal array length during serialization,\nwhich is usually larger the actually (it is dynamically resized and\nusually 2x of previous size). It needs to be set to the payload's\nserialized size. This incorrect behavior affects transaction size\nlimit calculation, which results in unnecessary WriteSizeException.\n\n- Also fixed a test where compression should be ruled out.", "committedDate": "2020-03-14T02:15:03Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDY3NjQxMQ==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2480#discussion_r394676411", "bodyText": "can't you just set lastKnownSize = buf.readableBytes() on acquireBuffer  instead of setting it twice in doSerializeInternal ?", "author": "Maithem", "createdAt": "2020-03-18T22:29:39Z", "path": "runtime/src/main/java/org/corfudb/protocols/wireprotocol/LogData.java", "diffHunk": "@@ -129,7 +129,6 @@ public synchronized void acquireBuffer() {\n         if (serializedCache == null) {\n             serializedCache = Unpooled.buffer();\n             doSerializeInternal(serializedCache);\n-            lastKnownSize = serializedCache.array().length;", "originalCommit": "942961936f219b6e12c55d3a546e10cdd5c4b1ca", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDY3NzczMg==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2480#discussion_r394677732", "bodyText": "That's what I initially did, but later I realized that that way the lastKnownSize will include the metadata map, but when deserializing, it does include metadata.", "author": "WenbinZhu", "createdAt": "2020-03-18T22:33:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDY3NjQxMQ=="}], "type": "inlineReview"}, {"oid": "c9816117783c9417a4857137bda8d748942af922", "url": "https://github.com/CorfuDB/CorfuDB/commit/c9816117783c9417a4857137bda8d748942af922", "message": "Merge branch 'master' into fix_logdata_size", "committedDate": "2020-03-30T20:48:15Z", "type": "commit"}]}