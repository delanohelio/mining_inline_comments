{"pr_number": 2701, "pr_title": "CorfuStoreBrowser: variable size records for loading data", "pr_createdAt": "2020-08-11T22:29:36Z", "pr_url": "https://github.com/CorfuDB/CorfuDB/pull/2701", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODk0MzU2Nw==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2701#discussion_r468943567", "bodyText": "why we need this?", "author": "xnull", "createdAt": "2020-08-12T00:51:26Z", "path": "corfudb-tools/src/main/java/org/corfudb/browser/CorfuStoreBrowser.java", "diffHunk": "@@ -225,9 +238,12 @@ public int loadTable(String namespace, String tablename, int numItems, int batch\n                     TableName.getDefaultInstance().getClass(),\n                     optionsBuilder.build());\n \n-            TableName dummyVal = TableName.newBuilder().setNamespace(namespace).setTableName(tablename).build();\n-            log.info(\"Loading {} items in {} batchSized transactions into {}${}\",\n-                    numItems, batchSize, namespace, tablename);\n+            byte[] array = new byte[itemSize];\n+            new Random().nextBytes(array);", "originalCommit": "585b42086a276ed007f2d5d0b60be3a5c66595b8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTUwNjc3Mw==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2701#discussion_r469506773", "bodyText": "if we don't throw in random bytes, the compression reduces the actual payload size making it hard to test things like disk full", "author": "hisundar", "createdAt": "2020-08-12T20:00:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODk0MzU2Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDIwNjQ0MQ==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2701#discussion_r470206441", "bodyText": "how does adding random bytes solve it?  can we add a comment about this?", "author": "pankti-m", "createdAt": "2020-08-13T19:47:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODk0MzU2Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDM5MDgzMw==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2701#discussion_r470390833", "bodyText": "adding random bytes prevents compression from reducing the size of the written value. random bytes don't compress well.", "author": "hisundar", "createdAt": "2020-08-14T03:33:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODk0MzU2Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTc1MTIzMg==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2701#discussion_r485751232", "bodyText": "comments added.", "author": "hisundar", "createdAt": "2020-09-09T16:28:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODk0MzU2Nw=="}], "type": "inlineReview"}, {"oid": "0c07eec1c21c6d648e5dba2e63b5e812b6fb56dd", "url": "https://github.com/CorfuDB/CorfuDB/commit/0c07eec1c21c6d648e5dba2e63b5e812b6fb56dd", "message": "CorfuStoreBrowser: variable size records for loading data\n\nUse JsonFormat to display for future editing", "committedDate": "2020-08-13T07:04:11Z", "type": "forcePushed"}, {"oid": "186b43ae2fc74c962d52fbbcace68e11bdde0f97", "url": "https://github.com/CorfuDB/CorfuDB/commit/186b43ae2fc74c962d52fbbcace68e11bdde0f97", "message": "CorfuStoreBrowser: variable size records for loading data\n\nUse JsonFormat to display for future editing", "committedDate": "2020-08-13T19:09:26Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDIwMjk4Mw==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2701#discussion_r470202983", "bodyText": "can we print the protobuf type which caused the exception?", "author": "pankti-m", "createdAt": "2020-08-13T19:40:33Z", "path": "corfudb-tools/src/main/java/org/corfudb/browser/CorfuStoreBrowser.java", "diffHunk": "@@ -133,11 +138,18 @@ public int printTable(String namespace, String tablename) {\n                 Iterables.partition(entryStream::iterator, batchSize);\n         for (List<Map.Entry<CorfuDynamicKey, CorfuDynamicRecord>> partition : partitions) {\n             for (Map.Entry<CorfuDynamicKey, CorfuDynamicRecord> entry : partition) {\n-                builder = new StringBuilder(\"\\nKey:\\n\" + entry.getKey().getKey())\n-                        .append(\"\\nPayload:\\n\").append(entry.getValue().getPayload())\n-                        .append(\"\\nMetadata:\\n\").append(entry.getValue().getMetadata())\n-                        .append(\"\\n====================\\n\");\n-                log.info(builder.toString());\n+                try {\n+                    builder = new StringBuilder(\"\\nKey:\\n\")\n+                            .append(JsonFormat.printer().print(entry.getKey().getKey()))\n+                            .append(\"\\nPayload:\\n\")\n+                            .append(JsonFormat.printer().print(entry.getValue().getPayload()))\n+                            .append(\"\\nMetadata:\\n\")\n+                            .append(JsonFormat.printer().print(entry.getValue().getMetadata()))\n+                            .append(\"\\n====================\\n\");\n+                    log.info(builder.toString());\n+                } catch (InvalidProtocolBufferException e) {\n+                    log.error(\"invalid protobuf: \", e);", "originalCommit": "186b43ae2fc74c962d52fbbcace68e11bdde0f97", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDM5MDcwNA==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2701#discussion_r470390704", "bodyText": "in this case there is only one protobuf - the TableName, also I think the error would carry the line where it failed. if it does.", "author": "hisundar", "createdAt": "2020-08-14T03:33:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDIwMjk4Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTE0NTU4Nw==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2701#discussion_r471145587", "bodyText": "sorry, but arent the keys and values the protobufs?", "author": "pankti-m", "createdAt": "2020-08-16T18:50:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDIwMjk4Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTc1MTEzMA==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2701#discussion_r485751130", "bodyText": "yes same protobuf TableName is being used as key and also as value", "author": "hisundar", "createdAt": "2020-09-09T16:28:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDIwMjk4Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDIwOTM4MQ==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2701#discussion_r470209381", "bodyText": "I did not realize earlier, but in this operation we allow data to be loaded only in the schema of dummyKey and dummyVal, but the clients table can have a different schema, right?  Wont the load operation fail?", "author": "pankti-m", "createdAt": "2020-08-13T19:53:20Z", "path": "corfudb-tools/src/main/java/org/corfudb/browser/CorfuStoreBrowser.java", "diffHunk": "@@ -209,9 +221,10 @@ public int dropTable(String namespace, String tablename) {\n      * @param tablename - table name without the namespace\n      * @param numItems - total number of items to load\n      * @param batchSize - number of items in each transaction\n+     * @param itemSize - size of each item - a random string array\n      * @return - number of entries in the table\n      */\n-    public int loadTable(String namespace, String tablename, int numItems, int batchSize) {\n+    public int loadTable(String namespace, String tablename, int numItems, int batchSize, int itemSize) {", "originalCommit": "186b43ae2fc74c962d52fbbcace68e11bdde0f97", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDM5MDU1Mg==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2701#discussion_r470390552", "bodyText": "this is not meant to load data into client tables - if they do that they are intentionally corrupting data. This tool is just to load specific data into corfu.", "author": "hisundar", "createdAt": "2020-08-14T03:32:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDIwOTM4MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTE0NjIyOA==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2701#discussion_r471146228", "bodyText": "I see, ok.  what is the use case of this operation?  is it for testing disk full like you mentioned in another comment?  Should we add it in the comments section for this method?\nAlso, if accidentally, this is called for a client table, the operation will fail with incompatible schema, right?  If not, is it better to control from Corfu itself which table the data gets loaded into?  It can be a fixed table inside CorfuSystem or something.", "author": "pankti-m", "createdAt": "2020-08-16T18:57:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDIwOTM4MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODM5ODU5Ng==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2701#discussion_r488398596", "bodyText": "its for disk full and load testing. added comments to state the same.", "author": "hisundar", "createdAt": "2020-09-15T05:41:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDIwOTM4MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODg3OTYzMw==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2701#discussion_r488879633", "bodyText": "dint find the comments...", "author": "pankti-m", "createdAt": "2020-09-15T18:33:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDIwOTM4MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDIwOTkxNg==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2701#discussion_r470209916", "bodyText": "why namespace+tablename?", "author": "pankti-m", "createdAt": "2020-08-13T19:54:12Z", "path": "corfudb-tools/src/main/java/org/corfudb/browser/CorfuStoreBrowser.java", "diffHunk": "@@ -225,9 +238,12 @@ public int loadTable(String namespace, String tablename, int numItems, int batch\n                     TableName.getDefaultInstance().getClass(),\n                     optionsBuilder.build());\n \n-            TableName dummyVal = TableName.newBuilder().setNamespace(namespace).setTableName(tablename).build();\n-            log.info(\"Loading {} items in {} batchSized transactions into {}${}\",\n-                    numItems, batchSize, namespace, tablename);\n+            byte[] array = new byte[itemSize];\n+            new Random().nextBytes(array);\n+            TableName dummyVal = TableName.newBuilder().setNamespace(namespace+tablename)", "originalCommit": "186b43ae2fc74c962d52fbbcace68e11bdde0f97", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDM5MDM0OA==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2701#discussion_r470390348", "bodyText": "just to display something meaningful in case someone is silly enough to dump the dummy table :)", "author": "hisundar", "createdAt": "2020-08-14T03:31:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDIwOTkxNg=="}], "type": "inlineReview"}, {"oid": "cdfe8b18997300e4687e5564928027e0696280ea", "url": "https://github.com/CorfuDB/CorfuDB/commit/cdfe8b18997300e4687e5564928027e0696280ea", "message": "CorfuStoreBrowser: variable size records for loading data\n\nUse JsonFormat to display for future editing", "committedDate": "2020-09-09T16:28:36Z", "type": "forcePushed"}, {"oid": "210f1f30ddf5beda2c102042cff28fa7f8bb39c9", "url": "https://github.com/CorfuDB/CorfuDB/commit/210f1f30ddf5beda2c102042cff28fa7f8bb39c9", "message": "CorfuStoreBrowser: variable size records for loading data\n\nUse JsonFormat to display for future editing", "committedDate": "2020-09-09T16:34:53Z", "type": "forcePushed"}, {"oid": "92a6bbdb6b48b941efe3544eebb1e06653709832", "url": "https://github.com/CorfuDB/CorfuDB/commit/92a6bbdb6b48b941efe3544eebb1e06653709832", "message": "CorfuStoreBrowser: variable size records for loading data\n\nUse JsonFormat to display for future editing", "committedDate": "2020-09-15T05:40:44Z", "type": "commit"}, {"oid": "92a6bbdb6b48b941efe3544eebb1e06653709832", "url": "https://github.com/CorfuDB/CorfuDB/commit/92a6bbdb6b48b941efe3544eebb1e06653709832", "message": "CorfuStoreBrowser: variable size records for loading data\n\nUse JsonFormat to display for future editing", "committedDate": "2020-09-15T05:40:44Z", "type": "forcePushed"}]}