{"pr_number": 1403, "pr_title": "Fix | Connection pool proxy with delayLoadingLobs", "pr_createdAt": "2020-08-06T16:46:34Z", "pr_url": "https://github.com/microsoft/mssql-jdbc/pull/1403", "timeline": [{"oid": "7c9d4e0f02673ac072132cdf3472a743d64839e1", "url": "https://github.com/microsoft/mssql-jdbc/commit/7c9d4e0f02673ac072132cdf3472a743d64839e1", "message": "check exp", "committedDate": "2020-07-15T18:21:34Z", "type": "commit"}, {"oid": "0c88dabd961a6b7af59ee009e0ba684974b53cdd", "url": "https://github.com/microsoft/mssql-jdbc/commit/0c88dabd961a6b7af59ee009e0ba684974b53cdd", "message": "Change \"0\" to \"\"", "committedDate": "2020-07-20T21:45:34Z", "type": "commit"}, {"oid": "562a5bd2a3d820eb836a8cc52b6fe51e211e41af", "url": "https://github.com/microsoft/mssql-jdbc/commit/562a5bd2a3d820eb836a8cc52b6fe51e211e41af", "message": "Remove AE cert", "committedDate": "2020-07-27T21:46:48Z", "type": "commit"}, {"oid": "f274639a795a9d40ebdef98d820c14d8cacc3a71", "url": "https://github.com/microsoft/mssql-jdbc/commit/f274639a795a9d40ebdef98d820c14d8cacc3a71", "message": "Merge branch 'dev' of https://github.com/microsoft/mssql-jdbc into checkHash", "committedDate": "2020-07-27T21:47:03Z", "type": "commit"}, {"oid": "864596489210eada5c046878aedd8def98ee8228", "url": "https://github.com/microsoft/mssql-jdbc/commit/864596489210eada5c046878aedd8def98ee8228", "message": "Remove cert check in KeystoreCommon", "committedDate": "2020-07-28T17:31:35Z", "type": "commit"}, {"oid": "f534eb260cacbc95f3508744d6f80b0c8690cd03", "url": "https://github.com/microsoft/mssql-jdbc/commit/f534eb260cacbc95f3508744d6f80b0c8690cd03", "message": "Fix comment grammar", "committedDate": "2020-07-28T17:32:54Z", "type": "commit"}, {"oid": "abffa058ec58eb89b74d0a3f6a16fde5194caad7", "url": "https://github.com/microsoft/mssql-jdbc/commit/abffa058ec58eb89b74d0a3f6a16fde5194caad7", "message": "changes for connecitonpoolproxy", "committedDate": "2020-08-05T17:05:40Z", "type": "commit"}, {"oid": "bd35d5df622f2cd231384974d65e879ab2b8a559", "url": "https://github.com/microsoft/mssql-jdbc/commit/bd35d5df622f2cd231384974d65e879ab2b8a559", "message": "Merge branch 'dev' of https://github.com/microsoft/mssql-jdbc into checkHash\n\n# Conflicts:\n#\tsrc/main/java/com/microsoft/sqlserver/jdbc/IOBuffer.java", "committedDate": "2020-08-05T17:08:32Z", "type": "commit"}, {"oid": "992c515b283ad61afaa7196e37b0307ffa54e63d", "url": "https://github.com/microsoft/mssql-jdbc/commit/992c515b283ad61afaa7196e37b0307ffa54e63d", "message": "Merge branch 'checkHash' of https://github.com/rene-ye/mssql-jdbc into checkHash", "committedDate": "2020-08-05T17:08:37Z", "type": "commit"}, {"oid": "72a31510d608372e4385877c103813fb8ea89255", "url": "https://github.com/microsoft/mssql-jdbc/commit/72a31510d608372e4385877c103813fb8ea89255", "message": "Add test", "committedDate": "2020-08-05T17:20:16Z", "type": "commit"}, {"oid": "a1e8291b4bbf42f2a0e22bdf419f4ba2db001dc6", "url": "https://github.com/microsoft/mssql-jdbc/commit/a1e8291b4bbf42f2a0e22bdf419f4ba2db001dc6", "message": "Remove displayname", "committedDate": "2020-08-05T17:22:00Z", "type": "commit"}, {"oid": "469d6182fc0f57884d84fff9129ba859343ee44d", "url": "https://github.com/microsoft/mssql-jdbc/commit/469d6182fc0f57884d84fff9129ba859343ee44d", "message": "Add new public methods to requestBoundaryTest", "committedDate": "2020-08-06T20:45:50Z", "type": "commit"}, {"oid": "8499a7ca79c1d1373ac9faead5e9e8cd8315cae2", "url": "https://github.com/microsoft/mssql-jdbc/commit/8499a7ca79c1d1373ac9faead5e9e8cd8315cae2", "message": "Merge branch 'connectionPoolProxy' of https://github.com/rene-ye/mssql-jdbc into connectionPoolProxy", "committedDate": "2020-08-06T20:46:02Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTA0NDQzNg==", "url": "https://github.com/microsoft/mssql-jdbc/pull/1403#discussion_r469044436", "bodyText": "public methods should have description header", "author": "lilgreenbird", "createdAt": "2020-08-12T06:56:27Z", "path": "src/main/java/com/microsoft/sqlserver/jdbc/SQLServerConnection.java", "diffHunk": "@@ -702,9 +702,13 @@ byte getServerSupportedDataClassificationVersion() {\n     // Boolean that indicates whether LOB objects created by this connection should be loaded into memory\n     private boolean delayLoadingLobs = SQLServerDriverBooleanProperty.DELAY_LOADING_LOBS.getDefaultValue();\n \n-    boolean getDelayLoadingLobs() {\n+    public boolean getDelayLoadingLobs() {", "originalCommit": "8499a7ca79c1d1373ac9faead5e9e8cd8315cae2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTU3NzU3MA==", "url": "https://github.com/microsoft/mssql-jdbc/pull/1403#discussion_r469577570", "bodyText": "Shouldn't you override here?", "author": "ulvii", "createdAt": "2020-08-12T22:16:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTA0NDQzNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDA3NTE3NQ==", "url": "https://github.com/microsoft/mssql-jdbc/pull/1403#discussion_r470075175", "bodyText": "Well there's no inherited implementation to get confused about, so the only reason to do it would be for \"commenting\".", "author": "rene-ye", "createdAt": "2020-08-13T16:27:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTA0NDQzNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTA0NDUyNw==", "url": "https://github.com/microsoft/mssql-jdbc/pull/1403#discussion_r469044527", "bodyText": "header", "author": "lilgreenbird", "createdAt": "2020-08-12T06:56:36Z", "path": "src/main/java/com/microsoft/sqlserver/jdbc/SQLServerConnection.java", "diffHunk": "@@ -702,9 +702,13 @@ byte getServerSupportedDataClassificationVersion() {\n     // Boolean that indicates whether LOB objects created by this connection should be loaded into memory\n     private boolean delayLoadingLobs = SQLServerDriverBooleanProperty.DELAY_LOADING_LOBS.getDefaultValue();\n \n-    boolean getDelayLoadingLobs() {\n+    public boolean getDelayLoadingLobs() {\n         return delayLoadingLobs;\n     }\n+    \n+    public void setDelayLoadingLobs(boolean b) {", "originalCommit": "8499a7ca79c1d1373ac9faead5e9e8cd8315cae2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTA0NTU5NQ==", "url": "https://github.com/microsoft/mssql-jdbc/pull/1403#discussion_r469045595", "bodyText": "is there a tab here?? (same in line 575)", "author": "lilgreenbird", "createdAt": "2020-08-12T06:59:04Z", "path": "src/test/java/com/microsoft/sqlserver/jdbc/SQLServerConnectionTest.java", "diffHunk": "@@ -434,7 +437,7 @@ public void testClosedConnection() throws SQLException {\n         } catch (SQLServerException e) {\r\n             assertEquals(e.getMessage(), TestResource.getResource(\"R_connectionIsClosed\"),\r\n                     TestResource.getResource(\"R_wrongExceptionMessage\"));\r\n-          assertEquals(\"08S01\", e.getSQLState(), TestResource.getResource(\"R_wrongSqlState\"));\r\n+            assertEquals(\"08S01\", e.getSQLState(), TestResource.getResource(\"R_wrongSqlState\"));\r", "originalCommit": "8499a7ca79c1d1373ac9faead5e9e8cd8315cae2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTU1NDI5OA==", "url": "https://github.com/microsoft/mssql-jdbc/pull/1403#discussion_r469554298", "bodyText": "It wasn't formatted properly, it was off by 2 spaces.", "author": "rene-ye", "createdAt": "2020-08-12T21:21:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTA0NTU5NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTA0NzUxOQ==", "url": "https://github.com/microsoft/mssql-jdbc/pull/1403#discussion_r469047519", "bodyText": "expected is 1st param", "author": "lilgreenbird", "createdAt": "2020-08-12T07:03:26Z", "path": "src/test/java/com/microsoft/sqlserver/jdbc/SQLServerConnectionTest.java", "diffHunk": "@@ -569,7 +572,7 @@ public void testClientConnectionId() throws Exception {\n             } catch (SQLException e) {\r\n                 assertEquals(e.getMessage(), TestResource.getResource(\"R_connectionIsClosed\"),\r", "originalCommit": "8499a7ca79c1d1373ac9faead5e9e8cd8315cae2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTU1NDM0Nw==", "url": "https://github.com/microsoft/mssql-jdbc/pull/1403#discussion_r469554347", "bodyText": "Not a part of this PR.", "author": "rene-ye", "createdAt": "2020-08-12T21:21:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTA0NzUxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDI0NzQ2OA==", "url": "https://github.com/microsoft/mssql-jdbc/pull/1403#discussion_r470247468", "bodyText": "yeah, but it's in the same place, why not fix?", "author": "lilgreenbird", "createdAt": "2020-08-13T21:04:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTA0NzUxOQ=="}], "type": "inlineReview"}, {"oid": "7056c6038f873256f9286c4133f77dd0848d052a", "url": "https://github.com/microsoft/mssql-jdbc/commit/7056c6038f873256f9286c4133f77dd0848d052a", "message": "change default", "committedDate": "2020-08-12T17:49:33Z", "type": "commit"}, {"oid": "ed66b63204feab0243bbe6ed92ba7e6f51f47024", "url": "https://github.com/microsoft/mssql-jdbc/commit/ed66b63204feab0243bbe6ed92ba7e6f51f47024", "message": "add delayLoadingLobs to req boundary methods", "committedDate": "2020-08-12T17:51:46Z", "type": "commit"}, {"oid": "67592f21ba914be30c330d571fa714b93241c740", "url": "https://github.com/microsoft/mssql-jdbc/commit/67592f21ba914be30c330d571fa714b93241c740", "message": "test fix", "committedDate": "2020-08-12T21:24:07Z", "type": "commit"}, {"oid": "56d779a55d09670f400f07769f0a380706ce73b3", "url": "https://github.com/microsoft/mssql-jdbc/commit/56d779a55d09670f400f07769f0a380706ce73b3", "message": "Merge branch 'connectionPoolProxy' of https://github.com/rene-ye/mssql-jdbc into connectionPoolProxy", "committedDate": "2020-08-12T21:24:28Z", "type": "commit"}, {"oid": "171f564ce211f2930699ff84de03893865a49287", "url": "https://github.com/microsoft/mssql-jdbc/commit/171f564ce211f2930699ff84de03893865a49287", "message": "wrong function name", "committedDate": "2020-08-12T21:26:29Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTU4MDU2MA==", "url": "https://github.com/microsoft/mssql-jdbc/pull/1403#discussion_r469580560", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            assertEquals(e.getMessage(), TestResource.getResource(\"R_connectionIsClosed\"),\n          \n          \n            \n                            assertEquals(TestResource.getResource(\"R_connectionIsClosed\"), e.getMessage(),", "author": "ulvii", "createdAt": "2020-08-12T22:24:37Z", "path": "src/test/java/com/microsoft/sqlserver/jdbc/SQLServerConnectionTest.java", "diffHunk": "@@ -569,7 +572,7 @@ public void testClientConnectionId() throws Exception {\n             } catch (SQLException e) {\r\n                 assertEquals(e.getMessage(), TestResource.getResource(\"R_connectionIsClosed\"),\r", "originalCommit": "171f564ce211f2930699ff84de03893865a49287", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTU5NDg4NA==", "url": "https://github.com/microsoft/mssql-jdbc/pull/1403#discussion_r469594884", "bodyText": "Wouldn't this be a breaking change? Since we're adding new methods to a public interface, any user who has been using ISQLServerConnection to implement their own connection class would be getting a compilation error now.", "author": "peterbae", "createdAt": "2020-08-12T23:04:56Z", "path": "src/main/java/com/microsoft/sqlserver/jdbc/ISQLServerConnection.java", "diffHunk": "@@ -358,4 +358,19 @@ CallableStatement prepareCall(String sql, int nType, int nConcur, int nHold,\n      *        boolean value for 'useFmtOnly'.\r\n      */\r\n     void setUseFmtOnly(boolean useFmtOnly);\r\n+    \r\n+    /**\r\n+     * Returns the current flag value for delayLoadingLobs.\r\n+     *\r\n+     * @return 'delayLoadingLobs' property value.\r\n+     */\r\n+    boolean getDelayLoadingLobs();\r", "originalCommit": "171f564ce211f2930699ff84de03893865a49287", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDA3NjE2Mg==", "url": "https://github.com/microsoft/mssql-jdbc/pull/1403#discussion_r470076162", "bodyText": "Technically I guess, I'm not sure if anyone actually implements our interfaces.", "author": "rene-ye", "createdAt": "2020-08-13T16:28:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTU5NDg4NA=="}], "type": "inlineReview"}, {"oid": "946cabbceb641cfc6881df875e1619d856c0916e", "url": "https://github.com/microsoft/mssql-jdbc/commit/946cabbceb641cfc6881df875e1619d856c0916e", "message": "Update src/test/java/com/microsoft/sqlserver/jdbc/SQLServerConnectionTest.java\n\nCo-authored-by: ulvii <v-ulibra@microsoft.com>", "committedDate": "2020-08-13T16:27:53Z", "type": "commit"}, {"oid": "fc5f700386c8383772b0ebde97dd15d392e20a12", "url": "https://github.com/microsoft/mssql-jdbc/commit/fc5f700386c8383772b0ebde97dd15d392e20a12", "message": "comments", "committedDate": "2020-08-14T16:53:45Z", "type": "commit"}, {"oid": "20b67d434f21f431097a6f7c8f4072f9483bf064", "url": "https://github.com/microsoft/mssql-jdbc/commit/20b67d434f21f431097a6f7c8f4072f9483bf064", "message": "Fix for null column", "committedDate": "2020-08-18T17:47:57Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDk0MzY2NQ==", "url": "https://github.com/microsoft/mssql-jdbc/pull/1403#discussion_r474943665", "bodyText": "The javadoc in the interface will be applied to this method too, you can remove these.", "author": "ulvii", "createdAt": "2020-08-21T20:31:54Z", "path": "src/main/java/com/microsoft/sqlserver/jdbc/SQLServerConnection.java", "diffHunk": "@@ -702,10 +702,27 @@ byte getServerSupportedDataClassificationVersion() {\n     // Boolean that indicates whether LOB objects created by this connection should be loaded into memory\n     private boolean delayLoadingLobs = SQLServerDriverBooleanProperty.DELAY_LOADING_LOBS.getDefaultValue();\n \n-    boolean getDelayLoadingLobs() {\n+    /**\n+     * Returns the current state of the delayLoadingLobs flag.", "originalCommit": "20b67d434f21f431097a6f7c8f4072f9483bf064", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDk0NzE4Ng==", "url": "https://github.com/microsoft/mssql-jdbc/pull/1403#discussion_r474947186", "bodyText": "same here", "author": "ulvii", "createdAt": "2020-08-21T20:36:18Z", "path": "src/main/java/com/microsoft/sqlserver/jdbc/SQLServerConnection.java", "diffHunk": "@@ -702,10 +702,27 @@ byte getServerSupportedDataClassificationVersion() {\n     // Boolean that indicates whether LOB objects created by this connection should be loaded into memory\n     private boolean delayLoadingLobs = SQLServerDriverBooleanProperty.DELAY_LOADING_LOBS.getDefaultValue();\n \n-    boolean getDelayLoadingLobs() {\n+    /**\n+     * Returns the current state of the delayLoadingLobs flag.\n+     * \n+     * @return delayLoadingLobs indicates whether LOB objects will be immediately loaded into memory or not.\n+     */\n+    @Override\n+    public boolean getDelayLoadingLobs() {\n         return delayLoadingLobs;\n     }\n \n+    /**", "originalCommit": "20b67d434f21f431097a6f7c8f4072f9483bf064", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDk4NTE3Mg==", "url": "https://github.com/microsoft/mssql-jdbc/pull/1403#discussion_r474985172", "bodyText": "for debugging purpose if this fails, it would be helpful to add received as message param. (same in line 860)", "author": "lilgreenbird", "createdAt": "2020-08-21T21:51:05Z", "path": "src/test/java/com/microsoft/sqlserver/jdbc/SQLServerConnectionTest.java", "diffHunk": "@@ -803,4 +807,57 @@ public void testRedirectedError() {\n             fail(TestResource.getResource(\"R_unexpectedErrorMessage\") + e.getMessage());\r\n         }\r\n     }\r\n+\r\n+    /*\r\n+     * Basic test to make sure lobs work with ConnectionPoolProxy as well\r\n+     */\r\n+    @Test\r\n+    public void testConnectionPoolProxyWithLobs() throws SQLException, IOException {\r\n+        String cString = getConnectionString() + \";delayLoadingLobs=false;\";\r\n+        String data = \"testConnectionPoolProxyWithLobs\";\r\n+        Clob c = null;\r\n+        try (Connection conn = PrepUtil.getConnection(cString);\r\n+                SQLServerConnectionPoolProxy proxy = new SQLServerConnectionPoolProxy((SQLServerConnection) conn)) {\r\n+            try (Statement stmt = proxy.createStatement()) {\r\n+                String tableName = RandomUtil.getIdentifier(\"streamingTest\");\r\n+                stmt.execute(\r\n+                        \"CREATE TABLE \" + AbstractSQLGenerator.escapeIdentifier(tableName) + \" (lob varchar(max))\");\r\n+                stmt.execute(\r\n+                        \"INSERT INTO \" + AbstractSQLGenerator.escapeIdentifier(tableName) + \" VALUES ('\" + data + \"')\");\r\n+                try (ResultSet rs = stmt\r\n+                        .executeQuery(\"SELECT * FROM \" + AbstractSQLGenerator.escapeIdentifier(tableName))) {\r\n+                    while (rs.next()) {\r\n+                        c = rs.getClob(1);\r\n+                        try (Reader r = c.getCharacterStream()) {\r\n+                            long clobLength = c.length();\r\n+                            // read the Reader contents into a buffer and return the complete string\r\n+                            final StringBuilder stringBuilder = new StringBuilder((int) clobLength);\r\n+                            char[] buffer = new char[(int) clobLength];\r\n+                            int amountRead = -1;\r\n+                            while ((amountRead = r.read(buffer, 0, (int) clobLength)) != -1) {\r\n+                                stringBuilder.append(buffer, 0, amountRead);\r\n+                            }\r\n+                            String received = stringBuilder.toString();\r\n+                            assertEquals(data, received);\r", "originalCommit": "20b67d434f21f431097a6f7c8f4072f9483bf064", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "325321a3d3207a4192ee842215033468d5ad31bb", "url": "https://github.com/microsoft/mssql-jdbc/commit/325321a3d3207a4192ee842215033468d5ad31bb", "message": "Address comments", "committedDate": "2020-08-21T22:37:46Z", "type": "commit"}, {"oid": "e5b166db5dd3012704871678be0f104fca02c56b", "url": "https://github.com/microsoft/mssql-jdbc/commit/e5b166db5dd3012704871678be0f104fca02c56b", "message": "remove comments", "committedDate": "2020-08-24T18:05:33Z", "type": "commit"}]}