{"pr_number": 2680, "pr_title": "[M] Added support for JAAS in the embedded ActiveMQ broker (ENT-2154)", "pr_createdAt": "2020-04-13T17:57:28Z", "pr_url": "https://github.com/candlepin/candlepin/pull/2680", "timeline": [{"oid": "fab00f366621afc3002758de604478d03b6f75e6", "url": "https://github.com/candlepin/candlepin/commit/fab00f366621afc3002758de604478d03b6f75e6", "message": "Added support for JAAS in the embedded ActiveMQ broker\n\n- Added support for the using the ActiveMQJAASSecurityManager when\n  creating the embedded ActiveMQ broker\n- Added new configurations for modifying which entries are used\n  in a JAAS config file\n- Updated the broker.xml with details about using external\n  connections to the embedded Artemis instance", "committedDate": "2020-04-13T18:11:32Z", "type": "forcePushed"}, {"oid": "a01f7e4b5a48ff060884fc1dab565c2b1f52467f", "url": "https://github.com/candlepin/candlepin/commit/a01f7e4b5a48ff060884fc1dab565c2b1f52467f", "message": "Added support for JAAS in the embedded ActiveMQ broker\n\n- Added support for the using the ActiveMQJAASSecurityManager when\n  creating the embedded ActiveMQ broker\n- Added new configurations for modifying which entries are used\n  in a JAAS config file\n- Updated the broker.xml with details about using external\n  connections to the embedded Artemis instance", "committedDate": "2020-04-13T19:02:37Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzcyMjgxNg==", "url": "https://github.com/candlepin/candlepin/pull/2680#discussion_r407722816", "bodyText": "Maybe the default should be \"InVmLogin\" or \"GuestLogin\" to be more precise since we're not actually using the PropertiesLogin module", "author": "jturel", "createdAt": "2020-04-13T21:09:22Z", "path": "server/src/main/java/org/candlepin/config/ConfigProperties.java", "diffHunk": "@@ -362,9 +369,19 @@ public static String jobConfig(String jobKey, String cfgName) {\n             this.put(CPM_PROVIDER, \"artemis\");\n \n             this.put(ACTIVEMQ_ENABLED, \"true\");\n+\n             this.put(ACTIVEMQ_EMBEDDED, \"true\");\n+\n+            // TODO: Delete the above configuration and only use EMBEDDED_BROKER going forward.\n+            // This is currently blocked by complexity in supporting moving configuration paths,\n+            // and should coincide with an update to the Configuration object\n+            this.put(ACTIVEMQ_EMBEDDED_BROKER, \"true\");\n+            this.put(ACTIVEMQ_JAAS_PROPERTIES_LOGIN_NAME, \"PropertiesLogin\");", "originalCommit": "a01f7e4b5a48ff060884fc1dab565c2b1f52467f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzczNzEyOA==", "url": "https://github.com/candlepin/candlepin/pull/2680#discussion_r407737128", "bodyText": "Ahh, I thought that was the convention for the first config name in the JAAS module, but I was mistaken. I've updated this to use InVMLogin as suggested.", "author": "Ceiu", "createdAt": "2020-04-13T21:39:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzcyMjgxNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzcyNTM1NQ==", "url": "https://github.com/candlepin/candlepin/pull/2680#discussion_r407725355", "bodyText": "I have a suspicion that these permissions are broader than what's actually needed. I experimented with this, and it seems to work but it's likely that i'm not testing all the execution paths:\n                <security-setting match=\"job.jobs\">\n                        <permission type=\"createDurableQueue\" roles=\"invm-role\"/>\n                        <permission type=\"deleteDurableQueue\" roles=\"invm-role\"/>\n                        <permission type=\"send\" roles=\"invm-role\"/>\n                        <permission type=\"consume\" roles=\"invm-role\"/>\n                </security-setting>\n                <security-setting match=\"event.default.#\">\n                        <permission type=\"createDurableQueue\" roles=\"invm-role\"/>\n                        <permission type=\"deleteDurableQueue\" roles=\"invm-role\"/>\n                        <permission type=\"send\" roles=\"invm-role\"/>\n                        <permission type=\"consume\" roles=\"invm-role\"/>\n                </security-setting>", "author": "jturel", "createdAt": "2020-04-13T21:14:29Z", "path": "server/src/main/resources/broker.xml", "diffHunk": "@@ -19,16 +19,88 @@\n                xsi:schemaLocation=\"urn:activemq /schema/artemis-configuration.xsd\">\n \n     <core xmlns=\"urn:activemq:core\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n-          xsi:schemaLocation=\"urn:activemq:core \">\n-\n+        xsi:schemaLocation=\"urn:activemq:core \">\n+\n+        <!--\n+            By default, Candlepin only enables the in-vm connection with no security manager, but\n+            supports adding additional acceptors which can then be secured using JAAS modules.\n+\n+            Below is a commented-out example acceptor that accepts clients using the STOMP protocol,\n+            over an SSL connection. In addition to the acceptor, the remaining JAAS configuration\n+            needs to be added, such as the login.config file loaded with the Java runtime.\n+\n+            When configuring the login.config, Candlepin uses two sections for certificate-based\n+            and non-certificate logins attempts. By default, these are named \"CertificateLogin\" and\n+            \"PropertiesLogin\" respectively, but can be modified in candlepin.conf if necessary [1].\n+\n+            As Candlepin's in-vm connection does not provide any credentials, it is imperative that\n+            the guest login module is present in the non-certificate login section when using the\n+            embedded broker. Omitting or misconfiguring this module will prevent Candlepin from\n+            communicating with its own broker, leading to an inability to operate normally and being\n+            permanently stuck in suspend mode, or not starting at all.\n+\n+            An example of a login.config configured for Candlepin's embedded broker to allow both\n+            external SSL connections and Candlepin's own in-vm connection is given below [2].\n+\n+            Beyond this, the security settings will need to be configured to allow the various users\n+            to actually use the broker. Again, when using the embedded broker, Candlepin's in-vm\n+            connection should be configured to perform any action to prevent operation failure. The\n+            security settings section below has a commented-out block for the in-vm role to perform\n+            any operation on any address/queue.\n+\n+            [1] candlepin.conf properties renaming:\n+                - \"candlepin.messaging.activemq.embedded.jaas_properties_login_name\"\n+                - \"candlepin.messaging.activemq.embedded.jaas_certificate_login_name\"\n+\n+            [2] Example login.config for an embedded broker with external clients:\n+                CertificateLogin {\n+                    org.apache.activemq.artemis.spi.core.security.jaas.TextFileCertificateLoginModule required\n+                        debug=true\n+                        org.apache.activemq.jaas.textfiledn.user=\"cert-users.properties\"\n+                        org.apache.activemq.jaas.textfiledn.role=\"cert-roles.properties\";\n+                };\n+\n+                PropertiesLogin {\n+                    org.apache.activemq.artemis.spi.core.security.jaas.GuestLoginModule required\n+                        debug=true\n+                        credentialsInvalidate=true\n+                        org.apache.activemq.jaas.guest.user=\"invm-user\"\n+                        org.apache.activemq.jaas.guest.role=\"invm-role\";\n+                };\n+        -->\n \n         <acceptors>\n             <acceptor name=\"in-vm\">vm://0</acceptor>\n-            <!-- <acceptor name=\"netty\">tcp://localhost:61617?sslEnabled=true;keyStorePath=${artemis.instance}/certs/artemis-server.ks;keyStorePassword=securepassword;needClientAuth=true;trustStorePath=${artemis.instance}/certs/artemis-server.ts;trustStorePassword=securepassword</acceptor> -->\n+\n+            <!-- <acceptor name=\"netty\">\n+                tcp://localhost:61613?protocols=STOMP;needClientAuth=true;sslEnabled=true;keyStorePath=${artemis.instance}/certs/server-side-keystore.jks;keyStorePassword=changeme;trustStorePath=${artemis.instance}/certs/server-side-truststore.jks;trustStorePassword=changeme\n+            </acceptor> -->\n         </acceptors>\n \n+        <!-- set this to true if using external clients -->\n         <security-enabled>false</security-enabled>\n \n+        <security-settings>\n+            <!--\n+                Enable this when using the embedded broker with the security manager enabled.\n+                Remember sure to update the role name to match the role given to the \"guest\"\n+                in-vm user, following the login details provided above.\n+\n+            <security-setting match=\"#\">", "originalCommit": "a01f7e4b5a48ff060884fc1dab565c2b1f52467f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzczNjg0NA==", "url": "https://github.com/candlepin/candlepin/pull/2680#discussion_r407736844", "bodyText": "It's definitely a sledgehammer, but I don't want to limit or break in-vm functionality every time we add something going forward. I'm pretty sure we need the manage side of things today, and if not, it'll be coming soon with the rework of the status monitor.\nI'm somewhat torn here in that I understand the concern for security, but I also feel that the connection Candlepin makes to its own embedded broker shouldn't be encumbered at all. That it even is subject to the security manager seems somewhat silly.\nIn any event, what is the update flow look like from your end if we have to update the permissions on a release?", "author": "Ceiu", "createdAt": "2020-04-13T21:38:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzcyNTM1NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzc5NjkzMA==", "url": "https://github.com/candlepin/candlepin/pull/2680#discussion_r407796930", "bodyText": "That's fair to say w.r.t limiting or breaking functionality. Something like that could go easily missed on our side, too. We'd need to update our installer where we will have the broker.xml puppetized. Let's leave it as you have it.", "author": "jturel", "createdAt": "2020-04-14T00:33:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzcyNTM1NQ=="}], "type": "inlineReview"}, {"oid": "adbe55fd1f4d3aae909723225a2f2ec0ee9fec5b", "url": "https://github.com/candlepin/candlepin/commit/adbe55fd1f4d3aae909723225a2f2ec0ee9fec5b", "message": "Added support for JAAS in the embedded ActiveMQ broker\n\n- Added support for the using the ActiveMQJAASSecurityManager when\n  creating the embedded ActiveMQ broker\n- Added new configurations for modifying which entries are used\n  in a JAAS config file\n- Updated the broker.xml with details about using external\n  connections to the embedded Artemis instance", "committedDate": "2020-04-13T21:50:22Z", "type": "forcePushed"}, {"oid": "e401d351ad7512eb0d9cd659e31656b056fb6c03", "url": "https://github.com/candlepin/candlepin/commit/e401d351ad7512eb0d9cd659e31656b056fb6c03", "message": "Added support for JAAS in the embedded ActiveMQ broker\n\n- Added support for the using the ActiveMQJAASSecurityManager when\n  creating the embedded ActiveMQ broker\n- Added new configurations for modifying which entries are used\n  in a JAAS config file\n- Updated the broker.xml with details about using external\n  connections to the embedded Artemis instance", "committedDate": "2020-04-13T21:51:48Z", "type": "commit"}, {"oid": "e401d351ad7512eb0d9cd659e31656b056fb6c03", "url": "https://github.com/candlepin/candlepin/commit/e401d351ad7512eb0d9cd659e31656b056fb6c03", "message": "Added support for JAAS in the embedded ActiveMQ broker\n\n- Added support for the using the ActiveMQJAASSecurityManager when\n  creating the embedded ActiveMQ broker\n- Added new configurations for modifying which entries are used\n  in a JAAS config file\n- Updated the broker.xml with details about using external\n  connections to the embedded Artemis instance", "committedDate": "2020-04-13T21:51:48Z", "type": "forcePushed"}]}