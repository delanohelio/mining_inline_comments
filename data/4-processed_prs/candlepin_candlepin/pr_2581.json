{"pr_number": 2581, "pr_title": "[F] Convert StatusResource to the OpenAPI specification (ENT-1884)", "pr_createdAt": "2020-01-23T11:01:31Z", "pr_url": "https://github.com/candlepin/candlepin/pull/2581", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDE4OTU4MA==", "url": "https://github.com/candlepin/candlepin/pull/2581#discussion_r370189580", "bodyText": "Something of note here: when we added the keycloak bits, we didn't want the values to be present in status if it was disabled (which it would be in most places); hence the separated DTOs. We should probably retain that.", "author": "Ceiu", "createdAt": "2020-01-23T15:33:27Z", "path": "api/candlepin-api-spec.yaml", "diffHunk": "@@ -22,6 +42,44 @@ components:\n         requestUuid:\n           type: string\n \n+    StatusDTO:\n+      description: Represents a deleted consumer\n+      properties:\n+        mode:\n+          type: string\n+        modeReason:\n+          type: string\n+        modeChangeTime:\n+          type: string\n+          format: date-time\n+        result:\n+          type: boolean\n+          example: true\n+        version:\n+          type: string\n+          example: 0.9.10\n+        release:\n+          type: string\n+        standalone:\n+          type: boolean\n+        timeUTC:\n+          type: string\n+          format: date-time\n+        rulesSource:\n+          type: string\n+        rulesVersion:\n+          type: string\n+          example: 5.8\n+        capabilities:\n+          type: array\n+          items:\n+            type: string\n+        keycloakRealm:", "originalCommit": "3fa826abdf6d0a7ad4e30e5f904ad5732eed1a3a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDIwNjAyNg==", "url": "https://github.com/candlepin/candlepin/pull/2581#discussion_r370206026", "bodyText": "@Ceiu\nAre you suggesting separated DTO with just keycloak fields or with status DTO fields plus keycloak fields?", "author": "abhiskum", "createdAt": "2020-01-23T16:00:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDE4OTU4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDM1ODUyMg==", "url": "https://github.com/candlepin/candlepin/pull/2581#discussion_r370358522", "bodyText": "An extension of StatusDTO like we had when it was manual. allOf with an inline object should work here.", "author": "Ceiu", "createdAt": "2020-01-23T21:16:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDE4OTU4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDYzNDgyMg==", "url": "https://github.com/candlepin/candlepin/pull/2581#discussion_r370634822", "bodyText": "@Ceiu\nI was under the impression that 'allOf' will generate different classes instead of inheritance. However, after exploring open API documentation, It appears we can generate inheritance using 'discriminator'.  I have updated to code to generate StatusDTO and KeycloakStatusDTO classes. However, after adding this, one additional property (discriminator property value)  coming in the response. I need to explore to avoid this additional property in the response.", "author": "abhiskum", "createdAt": "2020-01-24T13:33:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDE4OTU4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDc4NjM3Mg==", "url": "https://github.com/candlepin/candlepin/pull/2581#discussion_r370786372", "bodyText": "Disregard my request here. As you noted, what we should be doing is not possible with OpenAPI short of making substantial modifications to it.\nWhat you have here that combines the DTOs is what we're going to be doing going forward.", "author": "Ceiu", "createdAt": "2020-01-24T18:48:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDE4OTU4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTA1NjQ0OQ==", "url": "https://github.com/candlepin/candlepin/pull/2581#discussion_r371056449", "bodyText": "@Ceiu\nI had one additional query, I have already made changes to create separate DTOs using \u2018discriminator\u2019 and pushed in this PR.\nTo clarify, Is your approval for combining both StatusDTO and KeycloakStatusDTO into one or for separate DTOs using \u2018discriminator\u2019?", "author": "abhiskum", "createdAt": "2020-01-27T03:34:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDE4OTU4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTc4Nzg0Nw==", "url": "https://github.com/candlepin/candlepin/pull/2581#discussion_r371787847", "bodyText": "Combined until we find something better.", "author": "Ceiu", "createdAt": "2020-01-28T13:02:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDE4OTU4MA=="}], "type": "inlineReview"}, {"oid": "487efd189a12c1cb8f88e5fe1a81556a302eb8e5", "url": "https://github.com/candlepin/candlepin/commit/487efd189a12c1cb8f88e5fe1a81556a302eb8e5", "message": "Convert StatusResource to the OpenAPI specification\n   - Created new specifications for the status resource and status DTO\n   - Updated StatusResource to implement the generated API specification\n   - Deleted existing StatusDTO and KeycloakStatusDTO\n   - Deleted existing StatusDTOTest test\n   - Merge keycloak status fields into status DTO\n   - Updated StatusCache to use new DTO", "committedDate": "2020-01-24T06:07:17Z", "type": "forcePushed"}, {"oid": "fcc8ebd632a5763c662734312f2b288dfc97753c", "url": "https://github.com/candlepin/candlepin/commit/fcc8ebd632a5763c662734312f2b288dfc97753c", "message": "Convert StatusResource to the OpenAPI specification\n   - Created new specifications for the status resource and status DTO\n   - Updated StatusResource to implement the generated API specification\n   - Deleted existing StatusDTO and KeycloakStatusDTO\n   - Deleted existing StatusDTOTest test\n   - Updated StatusCache to use new DTO", "committedDate": "2020-01-24T06:10:40Z", "type": "forcePushed"}, {"oid": "5795a66ec8193cda916c2276b6c4208c72adb0e1", "url": "https://github.com/candlepin/candlepin/commit/5795a66ec8193cda916c2276b6c4208c72adb0e1", "message": "Convert StatusResource to the OpenAPI specification\n   - Created new specifications for the status resource and status DTO\n   - Updated StatusResource to implement the generated API specification\n   - Deleted existing StatusDTO and KeycloakStatusDTO\n   - Deleted existing StatusDTOTest test\n   - Updated StatusCache to use new DTO", "committedDate": "2020-01-24T06:57:28Z", "type": "forcePushed"}, {"oid": "f4122c8298ef76478e106e64ca8996cebbafa556", "url": "https://github.com/candlepin/candlepin/commit/f4122c8298ef76478e106e64ca8996cebbafa556", "message": "Convert StatusResource to the OpenAPI specification\n   - Created new specifications for the status resource and status DTO\n   - Updated StatusResource to implement the generated API specification\n   - Deleted existing StatusDTO and KeycloakStatusDTO\n   - Deleted existing StatusDTOTest test\n   - Updated StatusCache to use new DTO", "committedDate": "2020-01-24T11:12:10Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDgxNjM5NQ==", "url": "https://github.com/candlepin/candlepin/pull/2581#discussion_r370816395", "bodyText": "Depending on where we land with the other date things, these may need to become a date format.", "author": "Ceiu", "createdAt": "2020-01-24T19:57:20Z", "path": "api/candlepin-api-spec.yaml", "diffHunk": "@@ -22,6 +42,53 @@ components:\n         requestUuid:\n           type: string\n \n+    StatusDTO:\n+      description: Version and Status information about running Candlepin server\n+      discriminator:\n+        propertyName: type\n+      properties:\n+        mode:\n+          type: string\n+        modeReason:\n+          type: string\n+        modeChangeTime:\n+          type: string\n+          format: date-time", "originalCommit": "f4122c8298ef76478e106e64ca8996cebbafa556", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjQyNjgyNA==", "url": "https://github.com/candlepin/candlepin/pull/2581#discussion_r372426824", "bodyText": "I believe we're keeping date-time, as per the update in #2584 (comment). That PR has been updated with proper custom (de)serialization for OffsetDateTime.", "author": "nikosmoum", "createdAt": "2020-01-29T14:50:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDgxNjM5NQ=="}], "type": "inlineReview"}, {"oid": "ebc07a0a2d69967a96069c4033d003ed46bca500", "url": "https://github.com/candlepin/candlepin/commit/ebc07a0a2d69967a96069c4033d003ed46bca500", "message": "Convert StatusResource to the OpenAPI specification\n   - Created new specifications for the status resource and status DTO\n   - Updated StatusResource to implement the generated API specification\n   - Deleted existing StatusDTO and KeycloakStatusDTO\n   - Deleted existing StatusDTOTest test\n   - Updated StatusCache to use new DTO", "committedDate": "2020-01-26T11:25:08Z", "type": "forcePushed"}, {"oid": "8f68576ff859e50f9a4df99be4c58d0c4d89b05b", "url": "https://github.com/candlepin/candlepin/commit/8f68576ff859e50f9a4df99be4c58d0c4d89b05b", "message": "Convert StatusResource to the OpenAPI specification\n   - Created new specifications for the status resource and status DTO\n   - Updated StatusResource to implement the generated API specification\n   - Deleted existing StatusDTO and KeycloakStatusDTO\n   - Deleted existing StatusDTOTest test\n   - Updated StatusCache to use new DTO", "committedDate": "2020-01-28T13:15:48Z", "type": "forcePushed"}, {"oid": "3a1d133878c57af397af0034eaed6f02f2d5cb22", "url": "https://github.com/candlepin/candlepin/commit/3a1d133878c57af397af0034eaed6f02f2d5cb22", "message": "Convert StatusResource to the OpenAPI specification\n   - Created new specifications for the status resource and status DTO\n   - Updated StatusResource to implement the generated API specification\n   - Deleted existing StatusDTO and KeycloakStatusDTO\n   - Deleted existing StatusDTOTest test\n   - Updated StatusCache to use new DTO", "committedDate": "2020-01-29T00:10:40Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjQzOTkzMg==", "url": "https://github.com/candlepin/candlepin/pull/2581#discussion_r372439932", "bodyText": "There is no need to create a Date instance first and then convert it to OffsetDateTime here. OffsetDateTime.now() will do.", "author": "nikosmoum", "createdAt": "2020-01-29T15:10:24Z", "path": "server/src/main/java/org/candlepin/resource/StatusResource.java", "diffHunk": "@@ -157,30 +146,26 @@ public StatusDTO status() {\n \n         good = good && (mode == Mode.NORMAL);\n \n-        StatusDTO status;\n+        StatusDTO status = new StatusDTO()\n+            .result(good)\n+            .version(version)\n+            .release(release)\n+            .standalone(standalone)\n+            .rulesVersion(jsProvider.getRulesVersion())\n+            .rulesSource(rulesSource != null ? rulesSource.toString() : null)\n+            .mode(mode != null ? mode.toString() : null)\n+            .modeReason(mcr != null ? mcr.toString() : null)\n+            .modeChangeTime(mcr != null ? mcr.getTime().toInstant().atOffset(ZoneOffset.UTC) : null)\n+            .managerCapabilities(caps.stream().collect(Collectors.toList()))\n+            .timeUTC(new Date().toInstant().atOffset(ZoneOffset.UTC));", "originalCommit": "3a1d133878c57af397af0034eaed6f02f2d5cb22", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjcwMDYzMA==", "url": "https://github.com/candlepin/candlepin/pull/2581#discussion_r372700630", "bodyText": "Done.", "author": "abhiskum", "createdAt": "2020-01-30T00:13:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjQzOTkzMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjQ0MTQ3NQ==", "url": "https://github.com/candlepin/candlepin/pull/2581#discussion_r372441475", "bodyText": "Same for all the changes in this file, just use OffsetDateTime.now() directly.", "author": "nikosmoum", "createdAt": "2020-01-29T15:12:34Z", "path": "server/src/test/java/org/candlepin/cache/StatusCacheTest.java", "diffHunk": "@@ -46,8 +47,8 @@ public void setAndGet() {\n         StatusCache cache = new StatusCache();\n \n         StatusDTO status = new StatusDTO()\n-            .setResult(true)\n-            .setTimeUTC(new Date());\n+            .result(true)\n+            .timeUTC(new Date().toInstant().atOffset(ZoneOffset.UTC));", "originalCommit": "3a1d133878c57af397af0034eaed6f02f2d5cb22", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjcwMDY5Ng==", "url": "https://github.com/candlepin/candlepin/pull/2581#discussion_r372700696", "bodyText": "Done.", "author": "abhiskum", "createdAt": "2020-01-30T00:14:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjQ0MTQ3NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjU2MTM0MQ==", "url": "https://github.com/candlepin/candlepin/pull/2581#discussion_r372561341", "bodyText": "Please remove this line", "author": "kahowell", "createdAt": "2020-01-29T18:41:29Z", "path": "api/candlepin-api-spec.yaml", "diffHunk": "@@ -193,6 +193,27 @@ paths:\n               schema:\n                 $ref: '#/components/schemas/ExceptionMessage'\n \n+  /status:\n+    get:\n+      description: Returns status of the server\n+      tags:\n+        - Status\n+      operationId: status\n+      security: []\n+      responses:\n+        200:\n+          description: ''", "originalCommit": "3a1d133878c57af397af0034eaed6f02f2d5cb22", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjcwMTU2Ng==", "url": "https://github.com/candlepin/candlepin/pull/2581#discussion_r372701566", "bodyText": "@kahowell\nI am getting the following error after removing description from response section.\n`Execution failed for task ':api:openApiGenerate'.\n\nThere were issues with the specification. The option can be disabled via validateSpec (Maven/Gradle) or --skip-validate-spec (CLI).\n| Error count: 1, Warning count: 0\nErrors:\n-attribute paths.'/status'(get).responses.200.description is missing\n`", "author": "abhiskum", "createdAt": "2020-01-30T00:16:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjU2MTM0MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDE4NTQ0NA==", "url": "https://github.com/candlepin/candlepin/pull/2581#discussion_r374185444", "bodyText": "Ah, I should have looked closer! We'll need to fill in something for description to make the spec valid as you already figured out.", "author": "kahowell", "createdAt": "2020-02-03T15:57:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjU2MTM0MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDE4NjUwOQ==", "url": "https://github.com/candlepin/candlepin/pull/2581#discussion_r374186509", "bodyText": "For a 200, a simple description of \"OK\" would be fine.", "author": "kahowell", "createdAt": "2020-02-03T15:59:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjU2MTM0MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDE4ODM3Nw==", "url": "https://github.com/candlepin/candlepin/pull/2581#discussion_r374188377", "bodyText": "After some discussion, it would be better to include some description (here and in other PRs with empty descriptions like #2577) so that we can use this as an opportunity to improve our API documentation.\nIt doesn't have to be a lot, a verbose to-the-point description will do. This document has some nice guidelines/examples: https://swagger.io/docs/specification/describing-responses/", "author": "nikosmoum", "createdAt": "2020-02-03T16:02:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjU2MTM0MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDQ2NTIxNA==", "url": "https://github.com/candlepin/candlepin/pull/2581#discussion_r374465214", "bodyText": "@kahowell @nikosmoum\nAdded description value in the spec. Please re-review.", "author": "abhiskum", "createdAt": "2020-02-04T04:06:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjU2MTM0MQ=="}], "type": "inlineReview"}, {"oid": "934511256f65aa70595ab1c7ff17db499b5ce2d0", "url": "https://github.com/candlepin/candlepin/commit/934511256f65aa70595ab1c7ff17db499b5ce2d0", "message": "Convert StatusResource to the OpenAPI specification\n   - Created new specifications for the status resource and status DTO\n   - Updated StatusResource to implement the generated API specification\n   - Deleted existing StatusDTO and KeycloakStatusDTO\n   - Deleted existing StatusDTOTest test\n   - Updated StatusCache to use new DTO", "committedDate": "2020-01-30T00:12:31Z", "type": "forcePushed"}, {"oid": "d4f5181f296946066189fd5bbe48ecacc2cf17fe", "url": "https://github.com/candlepin/candlepin/commit/d4f5181f296946066189fd5bbe48ecacc2cf17fe", "message": "Convert StatusResource to the OpenAPI specification\n   - Created new specifications for the status resource and status DTO\n   - Updated StatusResource to implement the generated API specification\n   - Deleted existing StatusDTO and KeycloakStatusDTO\n   - Deleted existing StatusDTOTest test\n   - Updated StatusCache to use new DTO", "committedDate": "2020-02-03T03:39:26Z", "type": "forcePushed"}, {"oid": "ca317d18aea70e72d8c763ab612c9f911a155bbe", "url": "https://github.com/candlepin/candlepin/commit/ca317d18aea70e72d8c763ab612c9f911a155bbe", "message": "Convert StatusResource to the OpenAPI specification\n   - Created new specifications for the status resource and status DTO\n   - Updated StatusResource to implement the generated API specification\n   - Deleted existing StatusDTO and KeycloakStatusDTO\n   - Deleted existing StatusDTOTest test\n   - Updated StatusCache to use new DTO", "committedDate": "2020-02-04T04:02:37Z", "type": "forcePushed"}, {"oid": "9a780b988a40e3c0371e437fc534b5c6c981b555", "url": "https://github.com/candlepin/candlepin/commit/9a780b988a40e3c0371e437fc534b5c6c981b555", "message": "Convert StatusResource to the OpenAPI specification\n   - Created new specifications for the status resource and status DTO\n   - Updated StatusResource to implement the generated API specification\n   - Deleted existing StatusDTO and KeycloakStatusDTO\n   - Deleted existing StatusDTOTest test\n   - Updated StatusCache to use new DTO", "committedDate": "2020-02-06T17:39:52Z", "type": "forcePushed"}, {"oid": "bfd2c78149078f10c0df338b173d20c289fe665e", "url": "https://github.com/candlepin/candlepin/commit/bfd2c78149078f10c0df338b173d20c289fe665e", "message": "Convert StatusResource to the OpenAPI specification\n   - Created new specifications for the status resource and status DTO\n   - Updated StatusResource to implement the generated API specification\n   - Deleted existing StatusDTO and KeycloakStatusDTO\n   - Deleted existing StatusDTOTest test\n   - Updated StatusCache to use new DTO", "committedDate": "2020-02-12T06:00:22Z", "type": "commit"}, {"oid": "bfd2c78149078f10c0df338b173d20c289fe665e", "url": "https://github.com/candlepin/candlepin/commit/bfd2c78149078f10c0df338b173d20c289fe665e", "message": "Convert StatusResource to the OpenAPI specification\n   - Created new specifications for the status resource and status DTO\n   - Updated StatusResource to implement the generated API specification\n   - Deleted existing StatusDTO and KeycloakStatusDTO\n   - Deleted existing StatusDTOTest test\n   - Updated StatusCache to use new DTO", "committedDate": "2020-02-12T06:00:22Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODEwNjUwNQ==", "url": "https://github.com/candlepin/candlepin/pull/2581#discussion_r378106505", "bodyText": "With the latest rebase, the description got accidentally reverted back to an empty string it seems. Once it's added back it should be good to merge", "author": "nikosmoum", "createdAt": "2020-02-12T08:42:53Z", "path": "api/candlepin-api-spec.yaml", "diffHunk": "@@ -236,6 +236,27 @@ paths:\n               schema:\n                 $ref: '#/components/schemas/ExceptionMessage'\n \n+  /status:\n+    get:\n+      description: Returns status of the server\n+      tags:\n+        - Status\n+      operationId: status\n+      security: []\n+      responses:\n+        200:\n+          description: ''", "originalCommit": "bfd2c78149078f10c0df338b173d20c289fe665e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}