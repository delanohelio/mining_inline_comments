{"pr_number": 2614, "pr_title": "[M] ENT-2107: Make jobs run in parallel", "pr_createdAt": "2020-02-14T14:36:51Z", "pr_url": "https://github.com/candlepin/candlepin/pull/2614", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTk3NDYxNQ==", "url": "https://github.com/candlepin/candlepin/pull/2614#discussion_r379974615", "bodyText": "@nikosmoum\nIf the same JobManager instance shared with multiple Artemis threads and\u00a0the intention is to run queueJob and executeJob methods in parallel then synchronized (this) will not help here as both blocks are synchronized over this.\nI would recommend using 2 different locks in these methods. You can try using 2 different ReentrantLock here. \u00a0\nAlso, I did not get how the synchronized block will help to run jobs in parallel.\u00a0", "author": "abhiskum", "createdAt": "2020-02-17T03:44:49Z", "path": "server/src/main/java/org/candlepin/async/JobManager.java", "diffHunk": "@@ -982,19 +982,20 @@ public AsyncJobStatus findJob(String jobId) {\n      *  an AsyncJobStatus instance representing the queued job's status, or the status of the\n      *  existing job if it already exists\n      */\n-    public synchronized AsyncJobStatus queueJob(JobConfig config) throws JobException {\n-\n-        ManagerState state = this.getManagerState();\n-        if (state != ManagerState.RUNNING) {\n-            // Check if we're paused. If so, and if the \"queue while paused\" config is not set,\n-            // throw our usual ISE\n-            if (state != ManagerState.SUSPENDED ||\n-                !this.configuration.getBoolean(ConfigProperties.ASYNC_JOBS_QUEUE_WHILE_SUSPENDED)) {\n-\n-                String msg = String.format(\"Jobs cannot be queued while the manager is in the %s state\",\n-                    state);\n-\n-                throw new IllegalStateException(msg);\n+    public AsyncJobStatus queueJob(JobConfig config) throws JobException {\n+        synchronized (this) {", "originalCommit": "2da0d7f8d299fdaa36ee1e5545aff13dc2818eae", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDAzNjYwMA==", "url": "https://github.com/candlepin/candlepin/pull/2614#discussion_r380036600", "bodyText": "@Ceiu The synchronized (this) block does not span the whole queueJob and executeJob methods. That would be pointless because it would be the same as leaving the synchronized keyword on the method signature itself. It only synchronizes the little bit of code that checks the manager state. when they get to the result = job.execute(status); bit, there is no synchronization. But now I realize that the getManagerState() itself is synchronized, so there is no point in even doing that.\n@abhiskum I am aware that they will be synchronized over the same object, and it does make sense in this case. Instead of synchronizing the whole method, only this small bit that checks the manager state is now synchronized (and we want it to be synchronized over the same object, because we're checking the state of the JobManager, which is a Singleton), not the whole of execute and queue methods. But as I said before, I realize this is pointless because that method we're calling is already synchronized, so I'll remove this.", "author": "nikosmoum", "createdAt": "2020-02-17T08:22:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTk3NDYxNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDQ0NjcyMA==", "url": "https://github.com/candlepin/candlepin/pull/2614#discussion_r380446720", "bodyText": "Thank you, @nikosmoum for details.", "author": "abhiskum", "createdAt": "2020-02-18T04:10:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTk3NDYxNQ=="}], "type": "inlineReview"}, {"oid": "463f8499d24b20a83be8cd55a418496034c649b7", "url": "https://github.com/candlepin/candlepin/commit/463f8499d24b20a83be8cd55a418496034c649b7", "message": "ENT-2107: Make jobs run in parallel\n\n- Currently, jobs cannot run in parallel because we synchronize on\n  the JobManager singleton object on the execute method.\n  Once an artemis thread starts running a job, no other job can run\n  in parallel because the other artemis threads are waiting for the\n  lock. Not only that, but we also can't queue jobs at the same\n  time that a job is running, because the queue method also\n  is also synchronized. This fix removes synchronization from\n  these 2 methods (and a couple more that don't need it).", "committedDate": "2020-02-17T08:29:20Z", "type": "forcePushed"}, {"oid": "cc4e1ee3086274c2e5270a065bbb1735b81e3f81", "url": "https://github.com/candlepin/candlepin/commit/cc4e1ee3086274c2e5270a065bbb1735b81e3f81", "message": "ENT-2107: Make jobs run in parallel\n\n- Currently, jobs cannot run in parallel because we synchronize on\n  the JobManager singleton object on the execute method.\n  Once an artemis thread starts running a job, no other job can run\n  in parallel because the other artemis threads are waiting for the\n  lock. Not only that, but we also can't queue jobs at the same\n  time that a job is running, because the queue method is also\n  synchronized. This fix removes synchronization from these two\n  methods (and a couple more that don't need it).\n- Added synchronization on the JobMessageDispatcher to avoid an\n  artemis client warning when we try to queue jobs (AMQ212051:\n  Invalid concurrent session usage. Sessions are not supposed to be\n  used by more than one thread concurrently). This appeared once\n  the queueJob method stopped being synchronized.", "committedDate": "2020-02-17T15:51:23Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDM1MzMxNA==", "url": "https://github.com/candlepin/candlepin/pull/2614#discussion_r380353314", "bodyText": "Since this is a restriction of Artemis, and not something we care about at this level, we should try adding the synchronized flag onto the Artemis implementations of the messaging system. In this case, ArtemisProducer.send, ArtemisSession.commit and .rollback (probably .close, too)", "author": "Ceiu", "createdAt": "2020-02-17T20:19:04Z", "path": "server/src/main/java/org/candlepin/async/JobMessageDispatcher.java", "diffHunk": "@@ -138,7 +138,7 @@ private synchronized CPMProducer getProducer() throws CPMException {\n      * @throws JobMessageDispatchException\n      *  if the message cannot be posted for any reason\n      */\n-    public void postJobMessage(JobMessage jobMessage) throws JobMessageDispatchException {\n+    public synchronized void postJobMessage(JobMessage jobMessage) throws JobMessageDispatchException {", "originalCommit": "cc4e1ee3086274c2e5270a065bbb1735b81e3f81", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDYxNzI4MA==", "url": "https://github.com/candlepin/candlepin/pull/2614#discussion_r380617280", "bodyText": "Done", "author": "nikosmoum", "createdAt": "2020-02-18T11:34:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDM1MzMxNA=="}], "type": "inlineReview"}, {"oid": "a612e862c1e83679ba1224f374ac3750b5ecc3f4", "url": "https://github.com/candlepin/candlepin/commit/a612e862c1e83679ba1224f374ac3750b5ecc3f4", "message": "ENT-2107: Make jobs run in parallel\n\n- Currently, jobs cannot run in parallel because we synchronize on\n  the JobManager singleton object on the execute method.\n  Once an artemis thread starts running a job, no other job can run\n  in parallel because the other artemis threads are waiting for the\n  lock. Not only that, but we also can't queue jobs at the same\n  time that a job is running, because the queue method is also\n  synchronized. This fix removes synchronization from these two\n  methods (and a couple more that don't need it).\n- Added synchronization on ArtemisProducer & ArtemisSession to avoid\n  an artemis client warning when we try to queue jobs (AMQ212051:\n  Invalid concurrent session usage. Sessions are not supposed to be\n  used by more than one thread concurrently). This appeared once\n  the queueJob method stopped being synchronized.", "committedDate": "2020-02-18T11:32:51Z", "type": "commit"}, {"oid": "a612e862c1e83679ba1224f374ac3750b5ecc3f4", "url": "https://github.com/candlepin/candlepin/commit/a612e862c1e83679ba1224f374ac3750b5ecc3f4", "message": "ENT-2107: Make jobs run in parallel\n\n- Currently, jobs cannot run in parallel because we synchronize on\n  the JobManager singleton object on the execute method.\n  Once an artemis thread starts running a job, no other job can run\n  in parallel because the other artemis threads are waiting for the\n  lock. Not only that, but we also can't queue jobs at the same\n  time that a job is running, because the queue method is also\n  synchronized. This fix removes synchronization from these two\n  methods (and a couple more that don't need it).\n- Added synchronization on ArtemisProducer & ArtemisSession to avoid\n  an artemis client warning when we try to queue jobs (AMQ212051:\n  Invalid concurrent session usage. Sessions are not supposed to be\n  used by more than one thread concurrently). This appeared once\n  the queueJob method stopped being synchronized.", "committedDate": "2020-02-18T11:32:51Z", "type": "forcePushed"}]}