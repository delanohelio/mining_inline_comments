{"pr_number": 2693, "pr_title": "ENT-1885: Port RoleResource to spec-first", "pr_createdAt": "2020-04-30T06:47:21Z", "pr_url": "https://github.com/candlepin/candlepin/pull/2693", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzg4MjIwNA==", "url": "https://github.com/candlepin/candlepin/pull/2693#discussion_r417882204", "bodyText": "Not part of your changes but ownerCurator and permissionCurator are not used anymore so we could get rid of them.", "author": "Januson", "createdAt": "2020-04-30T09:35:58Z", "path": "server/src/main/java/org/candlepin/resource/RoleResource.java", "diffHunk": "@@ -30,38 +30,16 @@\n \n import com.google.inject.Inject;\n \n-import io.swagger.annotations.Api;\n-import io.swagger.annotations.ApiOperation;\n-import io.swagger.annotations.ApiParam;\n-import io.swagger.annotations.ApiResponse;\n-import io.swagger.annotations.ApiResponses;\n-import io.swagger.annotations.Authorization;\n-\n-import org.jboss.resteasy.annotations.providers.jaxb.Wrapped;\n import org.jboss.resteasy.spi.BadRequestException;\n import org.xnap.commons.i18n.I18n;\n \n import java.util.Collection;\n-import java.util.stream.Stream;\n-\n-import javax.ws.rs.Consumes;\n-import javax.ws.rs.DELETE;\n-import javax.ws.rs.GET;\n-import javax.ws.rs.POST;\n-import javax.ws.rs.PUT;\n-import javax.ws.rs.Path;\n-import javax.ws.rs.PathParam;\n-import javax.ws.rs.Produces;\n-import javax.ws.rs.core.MediaType;\n-\n-\n+import java.util.stream.Collectors;\n \n /**\n- *\n+ * API implementation for Role operations\n  */\n-@Path(\"/roles\")\n-@Api(value = \"roles\", authorizations = { @Authorization(\"basic\") })\n-public class RoleResource {\n+public class RoleResource implements RolesApi {\n \n     private UserServiceAdapter userService;\n     private OwnerCurator ownerCurator;", "originalCommit": "02f115d098a694539a83a1ac3d2eee3e6d66de52", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzkxMTYwMw==", "url": "https://github.com/candlepin/candlepin/pull/2693#discussion_r417911603", "bodyText": "Fixed it.", "author": "wolfdale", "createdAt": "2020-04-30T10:28:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzg4MjIwNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzg5MDI4Nw==", "url": "https://github.com/candlepin/candlepin/pull/2693#discussion_r417890287", "bodyText": "We should return 204 as we are not returning any data.", "author": "Januson", "createdAt": "2020-04-30T09:49:54Z", "path": "api/candlepin-api-spec.yaml", "diffHunk": "@@ -1124,6 +1124,390 @@ paths:\n         default:\n           $ref: '#/components/responses/default'\n \n+  /roles:\n+    get:\n+      description: Retrieves a list of Roles\n+      tags:\n+        - Roles\n+      operationId: getRoles\n+      x-java-response:\n+        type: Iterable\n+        isContainer: true\n+      security: []\n+      responses:\n+        200:\n+          description: A list of roles\n+          content:\n+            application/json:\n+              schema:\n+                type: array\n+                items:\n+                  $ref: '#/components/schemas/RoleDTO'\n+        default:\n+          $ref: '#/components/responses/default'\n+\n+    post:\n+      tags:\n+        - Roles\n+      description: Creates a Role\n+      operationId: createRole\n+      security: []\n+      requestBody:\n+        description: A role to be created\n+        required: true\n+        content:\n+          application/json:\n+            schema:\n+              $ref: '#/components/schemas/RoleDTO'\n+      responses:\n+        200:\n+          description: Role successfully created.\n+          content:\n+            application/json:\n+              schema:\n+                $ref: '#/components/schemas/RoleDTO'\n+        400:\n+          description: Role is null or empty or role name not specified\n+          content:\n+            application/json:\n+              schema:\n+                $ref: '#/components/schemas/ExceptionMessage'\n+              example:\n+                displayMessage: Role is null or empty or role name not specified\n+                requestUuid: c4347004-8792-41fe-a4d8-fccaa0d3898a\n+        409:\n+          description: Role already exists\n+          content:\n+            application/json:\n+              schema:\n+                $ref: '#/components/schemas/ExceptionMessage'\n+              example:\n+                displayMessage: Role already exists\n+                requestUuid: c4347004-8792-41fe-a4d8-fccaa0d3898a\n+        default:\n+          $ref: '#/components/responses/default'\n+\n+  /roles/{role_name}:\n+    get:\n+      description: Retrieves a single role by its name.\n+      tags:\n+        - Roles\n+      operationId: getRoleByName\n+      parameters:\n+        - in: path\n+          name: role_name\n+          description: Role name\n+          required: true\n+          schema:\n+            type: string\n+      security: []\n+      responses:\n+        200:\n+          description: Returns a role\n+          content:\n+            application/json:\n+              schema:\n+                $ref: '#/components/schemas/RoleDTO'\n+        400:\n+          description: Role name is null or empty\n+          content:\n+            application/json:\n+              schema:\n+                $ref: '#/components/schemas/ExceptionMessage'\n+              example:\n+                displayMessage: Role name is null or empty\n+                requestUuid: c4347004-8792-41fe-a4d8-fccaa0d3898a\n+        404:\n+          description: Role not found\n+          content:\n+            application/json:\n+              schema:\n+                $ref: '#/components/schemas/ExceptionMessage'\n+              example:\n+                displayMessage: Role not found\n+                requestUuid: c4347004-8792-41fe-a4d8-fccaa0d3898a\n+        default:\n+          $ref: '#/components/responses/default'\n+\n+    put:\n+      description: Updates Role. To avoid race conditions, we do not support updating the user or permission\n+        collections. Currently this call will only update the role name. See the specific nested POST/DELETE\n+        calls for modifying users and permissions.\n+      tags:\n+        - Roles\n+      operationId: updateRole\n+      security: []\n+      parameters:\n+        - name: role_name\n+          in: path\n+          description: Role name\n+          required: true\n+          schema:\n+            type: string\n+      requestBody:\n+        description: Role\n+        required: true\n+        content:\n+          application/json:\n+            schema:\n+              $ref: '#/components/schemas/RoleDTO'\n+      responses:\n+        200:\n+          description: Returns updated role\n+          content:\n+            application/json:\n+              schema:\n+                $ref: '#/components/schemas/RoleDTO'\n+        400:\n+          description: Role name is null or empty\n+          content:\n+            application/json:\n+              schema:\n+                $ref: '#/components/schemas/ExceptionMessage'\n+              example:\n+                displayMessage: Role name is null or empty\n+                requestUuid: c4347004-8792-41fe-a4d8-fccaa0d3898a\n+        404:\n+          description: Role not found\n+          content:\n+            application/json:\n+              schema:\n+                $ref: '#/components/schemas/ExceptionMessage'\n+              example:\n+                displayMessage: Role not found\n+                requestUuid: c4347004-8792-41fe-a4d8-fccaa0d3898a\n+        default:\n+          $ref: '#/components/responses/default'\n+\n+    delete:\n+      description: Removes a Role\n+      tags:\n+        - Roles\n+      operationId: deleteRoleByName\n+      parameters:\n+        - in: path\n+          name: role_name\n+          description: Role name\n+          required: true\n+          schema:\n+            type: string\n+      security: []\n+      responses:\n+        200:", "originalCommit": "02f115d098a694539a83a1ac3d2eee3e6d66de52", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzkxMTM3Nw==", "url": "https://github.com/candlepin/candlepin/pull/2693#discussion_r417911377", "bodyText": "Corrected.", "author": "wolfdale", "createdAt": "2020-04-30T10:28:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzg5MDI4Nw=="}], "type": "inlineReview"}, {"oid": "72fecd242196b5604766e956629a2c92909d191e", "url": "https://github.com/candlepin/candlepin/commit/72fecd242196b5604766e956629a2c92909d191e", "message": "ENT-1885: Port RoleResource to spec-first", "committedDate": "2020-04-30T10:25:25Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTUzMTcyMw==", "url": "https://github.com/candlepin/candlepin/pull/2693#discussion_r421531723", "bodyText": "There is one more reason that this could return a 400: when the role_name is null or empty, so this could be: Access type NONE not supported, or role name is null or empty", "author": "nikosmoum", "createdAt": "2020-05-07T14:06:43Z", "path": "api/candlepin-api-spec.yaml", "diffHunk": "@@ -1124,6 +1124,390 @@ paths:\n         default:\n           $ref: '#/components/responses/default'\n \n+  /roles:\n+    get:\n+      description: Retrieves a list of Roles\n+      tags:\n+        - Roles\n+      operationId: getRoles\n+      x-java-response:\n+        type: Iterable\n+        isContainer: true\n+      security: []\n+      responses:\n+        200:\n+          description: A list of roles\n+          content:\n+            application/json:\n+              schema:\n+                type: array\n+                items:\n+                  $ref: '#/components/schemas/RoleDTO'\n+        default:\n+          $ref: '#/components/responses/default'\n+\n+    post:\n+      tags:\n+        - Roles\n+      description: Creates a Role\n+      operationId: createRole\n+      security: []\n+      requestBody:\n+        description: A role to be created\n+        required: true\n+        content:\n+          application/json:\n+            schema:\n+              $ref: '#/components/schemas/RoleDTO'\n+      responses:\n+        200:\n+          description: Role successfully created.\n+          content:\n+            application/json:\n+              schema:\n+                $ref: '#/components/schemas/RoleDTO'\n+        400:\n+          description: Role is null or empty or role name not specified\n+          content:\n+            application/json:\n+              schema:\n+                $ref: '#/components/schemas/ExceptionMessage'\n+              example:\n+                displayMessage: Role is null or empty or role name not specified\n+                requestUuid: c4347004-8792-41fe-a4d8-fccaa0d3898a\n+        409:\n+          description: Role already exists\n+          content:\n+            application/json:\n+              schema:\n+                $ref: '#/components/schemas/ExceptionMessage'\n+              example:\n+                displayMessage: Role already exists\n+                requestUuid: c4347004-8792-41fe-a4d8-fccaa0d3898a\n+        default:\n+          $ref: '#/components/responses/default'\n+\n+  /roles/{role_name}:\n+    get:\n+      description: Retrieves a single role by its name.\n+      tags:\n+        - Roles\n+      operationId: getRoleByName\n+      parameters:\n+        - in: path\n+          name: role_name\n+          description: Role name\n+          required: true\n+          schema:\n+            type: string\n+      security: []\n+      responses:\n+        200:\n+          description: Returns a role\n+          content:\n+            application/json:\n+              schema:\n+                $ref: '#/components/schemas/RoleDTO'\n+        400:\n+          description: Role name is null or empty\n+          content:\n+            application/json:\n+              schema:\n+                $ref: '#/components/schemas/ExceptionMessage'\n+              example:\n+                displayMessage: Role name is null or empty\n+                requestUuid: c4347004-8792-41fe-a4d8-fccaa0d3898a\n+        404:\n+          description: Role not found\n+          content:\n+            application/json:\n+              schema:\n+                $ref: '#/components/schemas/ExceptionMessage'\n+              example:\n+                displayMessage: Role not found\n+                requestUuid: c4347004-8792-41fe-a4d8-fccaa0d3898a\n+        default:\n+          $ref: '#/components/responses/default'\n+\n+    put:\n+      description: Updates Role. To avoid race conditions, we do not support updating the user or permission\n+        collections. Currently this call will only update the role name. See the specific nested POST/DELETE\n+        calls for modifying users and permissions.\n+      tags:\n+        - Roles\n+      operationId: updateRole\n+      security: []\n+      parameters:\n+        - name: role_name\n+          in: path\n+          description: Role name\n+          required: true\n+          schema:\n+            type: string\n+      requestBody:\n+        description: Role\n+        required: true\n+        content:\n+          application/json:\n+            schema:\n+              $ref: '#/components/schemas/RoleDTO'\n+      responses:\n+        200:\n+          description: Returns updated role\n+          content:\n+            application/json:\n+              schema:\n+                $ref: '#/components/schemas/RoleDTO'\n+        400:\n+          description: Role name is null or empty\n+          content:\n+            application/json:\n+              schema:\n+                $ref: '#/components/schemas/ExceptionMessage'\n+              example:\n+                displayMessage: Role name is null or empty\n+                requestUuid: c4347004-8792-41fe-a4d8-fccaa0d3898a\n+        404:\n+          description: Role not found\n+          content:\n+            application/json:\n+              schema:\n+                $ref: '#/components/schemas/ExceptionMessage'\n+              example:\n+                displayMessage: Role not found\n+                requestUuid: c4347004-8792-41fe-a4d8-fccaa0d3898a\n+        default:\n+          $ref: '#/components/responses/default'\n+\n+    delete:\n+      description: Removes a Role\n+      tags:\n+        - Roles\n+      operationId: deleteRoleByName\n+      parameters:\n+        - in: path\n+          name: role_name\n+          description: Role name\n+          required: true\n+          schema:\n+            type: string\n+      security: []\n+      responses:\n+        204:\n+          description: Role successfully deleted.\n+        400:\n+          description: Role name is null or empty\n+          content:\n+            application/json:\n+              schema:\n+                $ref: '#/components/schemas/ExceptionMessage'\n+              example:\n+                displayMessage: Role name is null or empty\n+                requestUuid: c4347004-8792-41fe-a4d8-fccaa0d3898a\n+        404:\n+          description: Role not found\n+          content:\n+            application/json:\n+              schema:\n+                $ref: '#/components/schemas/ExceptionMessage'\n+              example:\n+                displayMessage: Role not found\n+                requestUuid: c4347004-8792-41fe-a4d8-fccaa0d3898a\n+        default:\n+          $ref: '#/components/responses/default'\n+\n+  /roles/{role_name}/users/{username}:\n+    post:\n+      tags:\n+        - Roles\n+      description: Adds a User to a Role\n+      operationId: addUserToRole\n+      security: []\n+      parameters:\n+        - in: path\n+          name: role_name\n+          description: Role name\n+          required: true\n+          schema:\n+            type: string\n+        - in: path\n+          name: username\n+          description: User name\n+          required: true\n+          schema:\n+            type: string\n+      responses:\n+        200:\n+          description: User added to the role\n+          content:\n+            application/json:\n+              schema:\n+                $ref: '#/components/schemas/RoleDTO'\n+        400:\n+          description: Either role or username is null or empty\n+          content:\n+            application/json:\n+              schema:\n+                $ref: '#/components/schemas/ExceptionMessage'\n+              example:\n+                displayMessage: Either role or username is null or empty\n+                requestUuid: c4347004-8792-41fe-a4d8-fccaa0d3898a\n+        404:\n+          description: Role or Username not found\n+          content:\n+            application/json:\n+              schema:\n+                $ref: '#/components/schemas/ExceptionMessage'\n+              example:\n+                displayMessage: Role or Username not found\n+                requestUuid: c4347004-8792-41fe-a4d8-fccaa0d3898a\n+        default:\n+          $ref: '#/components/responses/default'\n+\n+    delete:\n+      description: Removes a User from a Role\n+      tags:\n+        - Roles\n+      operationId: deleteUserFromRole\n+      parameters:\n+        - in: path\n+          name: role_name\n+          description: Role name\n+          required: true\n+          schema:\n+            type: string\n+        - in: path\n+          name: username\n+          description: User name\n+          required: true\n+          schema:\n+            type: string\n+      security: []\n+      responses:\n+        200:\n+          description: User from a role is removed\n+          content:\n+            application/json:\n+              schema:\n+                $ref: '#/components/schemas/RoleDTO'\n+        400:\n+          description: Either role or username is null or empty\n+          content:\n+            application/json:\n+              schema:\n+                $ref: '#/components/schemas/ExceptionMessage'\n+              example:\n+                displayMessage: Either role or username is null or empty\n+                requestUuid: c4347004-8792-41fe-a4d8-fccaa0d3898a\n+        404:\n+          description: Role or Username not found\n+          content:\n+            application/json:\n+              schema:\n+                $ref: '#/components/schemas/ExceptionMessage'\n+              example:\n+                displayMessage: Role or Username not found\n+                requestUuid: c4347004-8792-41fe-a4d8-fccaa0d3898a\n+        default:\n+          $ref: '#/components/responses/default'\n+\n+  /roles/{role_name}/permissions:\n+    post:\n+      tags:\n+        - Roles\n+      description: Adds a Permission to a Role\n+      operationId: addRolePermission\n+      security: []\n+      parameters:\n+        - in: path\n+          name: role_name\n+          description: Role name\n+          required: true\n+          schema:\n+            type: string\n+      requestBody:\n+        description: Permission Blueprint\n+        required: true\n+        content:\n+          application/json:\n+            schema:\n+              $ref: '#/components/schemas/PermissionBlueprintDTO'\n+      responses:\n+        200:\n+          description: Permission to a Role is added\n+          content:\n+            application/json:\n+              schema:\n+                $ref: '#/components/schemas/RoleDTO'\n+        400:\n+          description: Access type NONE not supported", "originalCommit": "72fecd242196b5604766e956629a2c92909d191e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTkyNDY4Mw==", "url": "https://github.com/candlepin/candlepin/pull/2693#discussion_r421924683", "bodyText": "Done.", "author": "wolfdale", "createdAt": "2020-05-08T04:03:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTUzMTcyMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTUzODI0MQ==", "url": "https://github.com/candlepin/candlepin/pull/2693#discussion_r421538241", "bodyText": "There's no reason to change this into returning a Set. We can still return a Stream here, by the x-java-response: type: to java.util.stream.Stream from Iterable (check other examples in the spec file)", "author": "nikosmoum", "createdAt": "2020-05-07T14:15:20Z", "path": "server/src/main/java/org/candlepin/resource/RoleResource.java", "diffHunk": "@@ -283,14 +239,15 @@ public RoleDTO deleteUserFromRole(@PathParam(\"role_name\") String roleName,\n         return this.modelTranslator.translate(role, RoleDTO.class);\n     }\n \n-    @ApiOperation(notes = \"Retrieves a list of Roles\", value = \"getRoles\")\n-    @GET\n-    @Produces(MediaType.APPLICATION_JSON)\n-    @Wrapped(element = \"roles\")\n-    public Stream<RoleDTO> getRoles() {\n+    /**\n+     * {@InheritDoc}\n+     */\n+    @Override\n+    public Iterable<RoleDTO> getRoles() {\n         // TODO: Add in filter options\n \n         Collection<? extends RoleInfo> roles = this.userService.listRoles();\n-        return roles.stream().map(this.modelTranslator.getStreamMapper(RoleInfo.class, RoleDTO.class));\n+        return roles.stream().map(this.modelTranslator.getStreamMapper(RoleInfo.class, RoleDTO.class))\n+            .collect(Collectors.toSet());", "originalCommit": "72fecd242196b5604766e956629a2c92909d191e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTkyNDY2NQ==", "url": "https://github.com/candlepin/candlepin/pull/2693#discussion_r421924665", "bodyText": "Fixed it.", "author": "wolfdale", "createdAt": "2020-05-08T04:03:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTUzODI0MQ=="}], "type": "inlineReview"}, {"oid": "8d15b7065d6d519147feb58b6359a70ee7aaa689", "url": "https://github.com/candlepin/candlepin/commit/8d15b7065d6d519147feb58b6359a70ee7aaa689", "message": "ENT-1885: Port RoleResource to spec-first", "committedDate": "2020-05-08T03:41:12Z", "type": "commit"}, {"oid": "8d15b7065d6d519147feb58b6359a70ee7aaa689", "url": "https://github.com/candlepin/candlepin/commit/8d15b7065d6d519147feb58b6359a70ee7aaa689", "message": "ENT-1885: Port RoleResource to spec-first", "committedDate": "2020-05-08T03:41:12Z", "type": "forcePushed"}]}