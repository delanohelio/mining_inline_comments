{"pr_number": 2579, "pr_title": "Improve docker images & fix distribution", "pr_createdAt": "2020-02-10T20:32:07Z", "pr_url": "https://github.com/odpi/egeria/pull/2579", "timeline": [{"oid": "23ee795646fbbac0bae3f6b080f4c68a4ef944cb", "url": "https://github.com/odpi/egeria/commit/23ee795646fbbac0bae3f6b080f4c68a4ef944cb", "message": "#2375 Build egeria docker image with full egeria distro\n\nSigned-off-by: Nigel Jones <nigel.l.jones+git@gmail.com>", "committedDate": "2020-02-10T16:16:29Z", "type": "commit"}, {"oid": "271ff14a1f9c3d92c601fa06ef6acd95d45d12cc", "url": "https://github.com/odpi/egeria/commit/271ff14a1f9c3d92c601fa06ef6acd95d45d12cc", "message": "#2215 Add UI into assembly\n\nSigned-off-by: Nigel Jones <nigel.l.jones+git@gmail.com>", "committedDate": "2020-02-10T16:42:30Z", "type": "commit"}, {"oid": "cd555205e711ab70efbd4af7df956a19350e46c2", "url": "https://github.com/odpi/egeria/commit/cd555205e711ab70efbd4af7df956a19350e46c2", "message": "#2375 Add Janus OLS connector to assembly to replace download\n\nSigned-off-by: Nigel Jones <nigel.l.jones+git@gmail.com>", "committedDate": "2020-02-10T16:50:18Z", "type": "commit"}, {"oid": "095c9727f7d4d3b2da10c69768b01c511bb07213", "url": "https://github.com/odpi/egeria/commit/095c9727f7d4d3b2da10c69768b01c511bb07213", "message": "#2375 Add extended metadata tags to aid in querying image at runtime\n\nSigned-off-by: Nigel Jones <nigel.l.jones+git@gmail.com>", "committedDate": "2020-02-10T19:23:14Z", "type": "commit"}, {"oid": "8194ef530dd84418baffd380d18aad27c8442b8b", "url": "https://github.com/odpi/egeria/commit/8194ef530dd84418baffd380d18aad27c8442b8b", "message": "#2375 Switch Egeria image to opencontainers spec for metadata labelling\n\nSigned-off-by: Nigel Jones <nigel.l.jones+git@gmail.com>", "committedDate": "2020-02-10T19:32:23Z", "type": "commit"}, {"oid": "badb08d0ea27e6fedc38ce681cf72f125fd5cf74", "url": "https://github.com/odpi/egeria/commit/badb08d0ea27e6fedc38ce681cf72f125fd5cf74", "message": "#2375 move tagging of latest to optional profile -Ptaglatest\n\nSigned-off-by: Nigel Jones <nigel.l.jones+git@gmail.com>", "committedDate": "2020-02-10T20:00:03Z", "type": "commit"}, {"oid": "480e507370ac8283bbb2c8087f5f67e0beb1be36", "url": "https://github.com/odpi/egeria/commit/480e507370ac8283bbb2c8087f5f67e0beb1be36", "message": "#2375 Update lab compose environment to be compatible with new docker images\n\nSigned-off-by: Nigel Jones <nigel.l.jones+git@gmail.com>", "committedDate": "2020-02-10T22:05:00Z", "type": "commit"}, {"oid": "fb1a6e33f33d7aa6cca9bb708dd49e3d879298b1", "url": "https://github.com/odpi/egeria/commit/fb1a6e33f33d7aa6cca9bb708dd49e3d879298b1", "message": "#2375 Update lab helm chart for new docker images\n\nSigned-off-by: Nigel Jones <nigel.l.jones+git@gmail.com>", "committedDate": "2020-02-11T16:03:01Z", "type": "commit"}, {"oid": "6f9455addbe54fda23c64bb30c7e82a17b2d1499", "url": "https://github.com/odpi/egeria/commit/6f9455addbe54fda23c64bb30c7e82a17b2d1499", "message": "#2574 rename egeriaversion -> egeria.version\n\nSigned-off-by: Nigel Jones <nigel.l.jones+git@gmail.com>", "committedDate": "2020-02-11T16:10:24Z", "type": "commit"}, {"oid": "6a827cb6c00bf86a92b60530fdea4cf6d49ebccc", "url": "https://github.com/odpi/egeria/commit/6a827cb6c00bf86a92b60530fdea4cf6d49ebccc", "message": "#2574 Update vdc chart to be compatible with new docker egeria image\n\nSigned-off-by: Nigel Jones <nigel.l.jones+git@gmail.com>", "committedDate": "2020-02-11T16:19:10Z", "type": "commit"}, {"oid": "0a110ea9296b2f203041095c56ab2e59c8392418", "url": "https://github.com/odpi/egeria/commit/0a110ea9296b2f203041095c56ab2e59c8392418", "message": "#2574 Update egeria-configure docker image to same as that used for core image\n\nSigned-off-by: Nigel Jones <nigel.l.jones+git@gmail.com>", "committedDate": "2020-02-11T16:35:12Z", "type": "commit"}, {"oid": "5916058dd510de07248018a2bd0333ae0b2f7a1e", "url": "https://github.com/odpi/egeria/commit/5916058dd510de07248018a2bd0333ae0b2f7a1e", "message": "#2574 Update vdc/lab helm charts to use new configure image\n\nSigned-off-by: Nigel Jones <nigel.l.jones+git@gmail.com>", "committedDate": "2020-02-11T17:54:51Z", "type": "commit"}, {"oid": "1e93abf494c835c62bb647e6b83ffdb5b3ada060", "url": "https://github.com/odpi/egeria/commit/1e93abf494c835c62bb647e6b83ffdb5b3ada060", "message": "#2574 remove omrsmonitor from vdc chart\n\nSigned-off-by: Nigel Jones <nigel.l.jones+git@gmail.com>", "committedDate": "2020-02-11T18:35:54Z", "type": "commit"}, {"oid": "8af97239c85bba903f40d3121723c01f80eb3bcc", "url": "https://github.com/odpi/egeria/commit/8af97239c85bba903f40d3121723c01f80eb3bcc", "message": "#2574 Add profiles to allow selection of base vs extended docker image (for build integration)\n\nSigned-off-by: Nigel Jones <nigel.l.jones+git@gmail.com>", "committedDate": "2020-02-11T18:55:30Z", "type": "commit"}, {"oid": "02e64e78001a48c73b780651c554b83c735af73f", "url": "https://github.com/odpi/egeria/commit/02e64e78001a48c73b780651c554b83c735af73f", "message": "#2574 move egeria/configure docker build to standard merge build. others remain daily\n\nSigned-off-by: Nigel Jones <nigel.l.jones+git@gmail.com>", "committedDate": "2020-02-11T19:02:29Z", "type": "commit"}, {"oid": "651c96e347343ea865aff9aa3e46babcc354afb4", "url": "https://github.com/odpi/egeria/commit/651c96e347343ea865aff9aa3e46babcc354afb4", "message": "Merge branch 'master' of https://github.com/odpi/egeria into issue2375a", "committedDate": "2020-02-11T19:08:07Z", "type": "commit"}, {"oid": "98e02d760530a6ec2ef386657ec0b898f3840bb0", "url": "https://github.com/odpi/egeria/commit/98e02d760530a6ec2ef386657ec0b898f3840bb0", "message": "#2574 ensure latest tag for current builds (master)\n\nSigned-off-by: Nigel Jones <nigel.l.jones+git@gmail.com>", "committedDate": "2020-02-11T19:22:38Z", "type": "commit"}, {"oid": "ca60d3b8baf71837e42c31af8245adbb5143f41d", "url": "https://github.com/odpi/egeria/commit/ca60d3b8baf71837e42c31af8245adbb5143f41d", "message": "Merge branch 'master' into issue2375a", "committedDate": "2020-02-12T12:06:13Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODIwOTI2NA==", "url": "https://github.com/odpi/egeria/pull/2579#discussion_r378209264", "bodyText": "Is this the right way around?  I would expect to take .Values.image.egeria.version and only if that is empty to default to the default tag (which I would expect would always be latest)...\nEven then, though, we need to be careful here keeping in mind the specific semantics of latest and the pull policy (ie. this makes it further critical that the default pull policy remains Always so that non-latest images will be forcibly replaced by k8s and it won't leave stale / old x.x-SNAPSHOT images around)...", "author": "cmgrote", "createdAt": "2020-02-12T12:02:57Z", "path": "open-metadata-resources/open-metadata-deployment/charts/odpi-egeria-lab/templates/egeria-core.yaml", "diffHunk": "@@ -57,7 +57,7 @@ spec:\n           image: \"{{ if (.Values.image.egeria.registry | default .Values.imageDefaults.registry) }}{{ .Values.image.egeria.registry | default .Values.imageDefaults.registry }}/{{ end }}\\\n                   {{ if (.Values.image.egeria.namespace | default .Values.imageDefaults.namespace) }}{{ .Values.image.egeria.namespace | default .Values.imageDefaults.namespace }}/{{ end }}\\\n                   {{ .Values.image.egeria.name }}\\\n-                  :{{ .Values.image.egeria.tag | default .Values.imageDefaults.tag }}\"\n+                  :{{ .Values.image.egeria.tag | default .Values.egeria.version }}\"", "originalCommit": "98e02d760530a6ec2ef386657ec0b898f3840bb0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODMxMDIwMA==", "url": "https://github.com/odpi/egeria/pull/2579#discussion_r378310200", "bodyText": "On the version choice:\nIt was my intent to do it this way around.\nMy reasoning - it is generally sensible only to use the image version that is the same as that of the chart. We ship that as 1.5-SNAPSHOT. Since we're moving to a more release-specific model I do not believe 'latest' makes so much sense. This is why the expression no longer uses the imageDefaults for the tag.  However I still wanted to allow the specific image version to be overriden on demand which can optionally be set.", "author": "planetf1", "createdAt": "2020-02-12T15:07:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODIwOTI2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODMxMzkxNQ==", "url": "https://github.com/odpi/egeria/pull/2579#discussion_r378313915", "bodyText": "I did anticipate the second part -- the vdc chart does now use 'Always' as the default setting for exactly that reason.\nI did consider whether to add an expression to use 'Always' for snapshots and 'ifNotPresent' for release, but was keen to make significant steps forward in the general aspects around release specific images, whilst maintaining compatability with our existing charts - even though vdc for example, is somewhat superceeded by events and will be reworked around the 1.8 time so wanted to move forward. We can refine the setting of that value through an additional issue/PR if you feel it would be helpful?\nThe whole intent of this change is to make -SNAPSHOT something only us devs on the team use, whilst the 'masses' use specific released versions.\nAs a mitigation we could change the flag in values as the point we cut a release ? That vaguely crossed my mind.", "author": "planetf1", "createdAt": "2020-02-12T15:13:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODIwOTI2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODM1MjMzMg==", "url": "https://github.com/odpi/egeria/pull/2579#discussion_r378352332", "bodyText": "Fine for now, just need to keep in mind for down the road...", "author": "cmgrote", "createdAt": "2020-02-12T16:09:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODIwOTI2NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODIxNDU1MA==", "url": "https://github.com/odpi/egeria/pull/2579#discussion_r378214550", "bodyText": "One example (others in solr, egeria, ibm-igc, and the init jobs) -- for consistency this needs to be .Values.image.egeria.tag rather than .Values.image.configure.tag (to pickup the singular Egeria version rather than a configure-specific tag); though see previous comments about whether this condition is not backwards at the moment...", "author": "cmgrote", "createdAt": "2020-02-12T12:15:16Z", "path": "open-metadata-resources/open-metadata-deployment/charts/odpi-egeria-vdc/templates/apache-ranger-admin.yaml", "diffHunk": "@@ -74,7 +74,7 @@ spec:\n           image: \"{{ if (.Values.image.configure.registry | default .Values.imageDefaults.registry) }}{{ .Values.image.configure.registry | default .Values.imageDefaults.registry }}/{{ end }}\\\n                   {{ if (.Values.image.configure.namespace | default .Values.imageDefaults.namespace) }}{{ .Values.image.configure.namespace | default .Values.imageDefaults.namespace }}/{{ end }}\\\n                   {{ .Values.image.configure.name }}\\\n-                  :{{ .Values.image.configure.tag | default .Values.imageDefaults.tag }}\"\n+                  :{{ .Values.image.configure.tag | default .Values.egeria.version }}\"", "originalCommit": "ca60d3b8baf71837e42c31af8245adbb5143f41d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODMxNzA2Mg==", "url": "https://github.com/odpi/egeria/pull/2579#discussion_r378317062", "bodyText": "Actually this was my intent - to allow the configure image tag to be overriden if required, but generally to default to the release version, as encoded by default in values.yaml.\nSo normally the 1.5-SNAPSHOT chart will be using the 1.5-SNAPSHOT docker image (which itself is made available very soon after merge - if the PR works!)\nSo it's not consistent with ranger, atlas - but intentionally so. The versioning of those images may need further work, but there's not an immediate pressure as we aren't really revisiting that scenario until 1.8 - of course that may change, but if so will revisit them then.\nFor now the old versioning and build process remains in place... and when we change it will be more radical than just a version change, I think we'll pull the build etc completely out into a seperarate third party repo.", "author": "planetf1", "createdAt": "2020-02-12T15:18:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODIxNDU1MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODM1NTM4Mg==", "url": "https://github.com/odpi/egeria/pull/2579#discussion_r378355382", "bodyText": "I'm not sure I follow...  This would mean that within the same chart we'll end up with different versions of the configure image being deployed into different pods, which I think is confusing (and potentially error-prone, ie. if we delete a particular version or fix a bug in a particular version but there is then a mix of versions deployed)?  These aren't the versions of the ranger, atlas, solr etc images themselves -- just the configure image that contains various utilities (curl, etc) used for running setup / initialization.\nI would suggest we keep the same version of this configure image across everything.  This would also mean that as we upgrade that image with new base images (alpine) or other fixes to eg. vulnerabilities that we gain those fixes across all places configure is used rather than just the core Egeria ones.\n(Even if we break these other images out into their own repo, they'd still need such a configure image to do their configuration, which I'd suggest re-using from Egeria core rather than creating a side version of.)", "author": "cmgrote", "createdAt": "2020-02-12T16:14:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODIxNDU1MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODM3MzYxOA==", "url": "https://github.com/odpi/egeria/pull/2579#discussion_r378373618", "bodyText": "I agree we wouldn't want mixed versions of a specific image in a deployment\nI've gone through all the yaml's again.\nEach time we use the egeria image I use the form\n:{{ .Values.image.egeria.tag | default .Values.egeria.version }}\n\nEach time I use the configure image I use:\n:{{ .Values.image.configure.tag | default .Values.egeria.version }}\n\nMy build changes have changed/improved the build of these two images - configure & egeria. They are built after merge. Both are built with the version of egeria they are built with (this can be overriden, they are also tagged as latest for master only)\nThe default values.yaml sets 'egeria.version=1.5-SNAPSHOT', which is aligned with the release currently in master.\nThus we will use this version for both egeria and configure across both charts & all jobs/pods.\nThe user may also set either, or both of\nimage.configure.tag\nimage.egeria.tag\nIf set these override the 'inherited' egeria.version set above (I name it like this to be very clear it's a common setting not image specific). They can be different, but each time configure is used it will always be the same. Ditto for egeria.\nThere's no change to the way our other images are used (though I do plan to change notebooks in the near future)\nDid I miss an update?\nHave I interpreted the golang expression wrongly?", "author": "planetf1", "createdAt": "2020-02-12T16:41:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODIxNDU1MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODM4MjkzNA==", "url": "https://github.com/odpi/egeria/pull/2579#discussion_r378382934", "bodyText": "Each time I use the configure image I use:  :{{ .Values.image.configure.tag | default .Values.egeria.version }}\n\nI think I misinterpreted which was correct, then -- there are a few places where you're setting up the configure image differently than this (see example in comment below on the apache-atlas template)", "author": "cmgrote", "createdAt": "2020-02-12T16:56:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODIxNDU1MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODM5MTEzMg==", "url": "https://github.com/odpi/egeria/pull/2579#discussion_r378391132", "bodyText": "I think it was just one? Should now be corrected.", "author": "planetf1", "createdAt": "2020-02-12T17:10:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODIxNDU1MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODM5MzU4MA==", "url": "https://github.com/odpi/egeria/pull/2579#discussion_r378393580", "bodyText": "I went back to double-check and couldn't find another, so I think you're right!", "author": "cmgrote", "createdAt": "2020-02-12T17:14:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODIxNDU1MA=="}], "type": "inlineReview"}, {"oid": "9fc734064ecff1d44aaff38d2b3382bd24bc60d0", "url": "https://github.com/odpi/egeria/commit/9fc734064ecff1d44aaff38d2b3382bd24bc60d0", "message": "Merge branch 'master' of https://github.com/odpi/egeria into issue2375a", "committedDate": "2020-02-12T16:24:33Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODM4MTYwOA==", "url": "https://github.com/odpi/egeria/pull/2579#discussion_r378381608", "bodyText": "This value is different from the others -- there were one or two other spots with this setup, too.  Here you have:\n:{{ .Values.image.egeria.tag | default .Values.egeria.version }}\n\nwhereas elsewhere you have:\n:{{ .Values.image.configure.tag | default .Values.egeria.version }}\n\nI had assumed you meant to use the former everywhere (having a single tag for all Egeria images: both the Egeria core and the configure image), but perhaps it's these few places with the first setup that were a mistake (?)", "author": "cmgrote", "createdAt": "2020-02-12T16:54:03Z", "path": "open-metadata-resources/open-metadata-deployment/charts/odpi-egeria-vdc/templates/apache-atlas.yaml", "diffHunk": "@@ -76,7 +76,7 @@ spec:\n           image: \"{{ if (.Values.image.configure.registry | default .Values.imageDefaults.registry) }}{{ .Values.image.configure.registry | default .Values.imageDefaults.registry }}/{{ end }}\\\n                   {{ if (.Values.image.configure.namespace | default .Values.imageDefaults.namespace) }}{{ .Values.image.configure.namespace | default .Values.imageDefaults.namespace }}/{{ end }}\\\n                   {{ .Values.image.configure.name }}\\\n-                  :{{ .Values.image.configure.tag | default .Values.imageDefaults.tag }}\"\n+                  :{{ .Values.image.egeria.tag | default .Values.egeria.version }}\"", "originalCommit": "ca60d3b8baf71837e42c31af8245adbb5143f41d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODM5MDU2Mg==", "url": "https://github.com/odpi/egeria/pull/2579#discussion_r378390562", "bodyText": "Thanks for clarifying. You are correct - I did have an error in that specific atlas file - but it seems the only one.\nBut I had intended to allow override on the two images independently, so the first example you list above is used for egeria, the second for configure. Both default to the egeria version\nI've just added the additional commit", "author": "planetf1", "createdAt": "2020-02-12T17:08:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODM4MTYwOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODM5Mjg0Mw==", "url": "https://github.com/odpi/egeria/pull/2579#discussion_r378392843", "bodyText": "Leave it to me to find the one that is wrong and assume it is correct and that all the others are incorrect \ud83d\ude1d", "author": "cmgrote", "createdAt": "2020-02-12T17:13:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODM4MTYwOA=="}], "type": "inlineReview"}, {"oid": "d176763d339bcd4106127dae2adb0c401b96ec8e", "url": "https://github.com/odpi/egeria/commit/d176763d339bcd4106127dae2adb0c401b96ec8e", "message": "Correct tag used for configure image in atlas deployment (vdc)\n\nSigned-off-by: Nigel Jones <nigel.l.jones+git@gmail.com>", "committedDate": "2020-02-12T17:07:44Z", "type": "commit"}, {"oid": "048a695b35a00b1a886cfe52d8cd8a95fa453817", "url": "https://github.com/odpi/egeria/commit/048a695b35a00b1a886cfe52d8cd8a95fa453817", "message": "Merge branch 'issue2375a' of https://github.com/planetf1/egeria into issue2375a", "committedDate": "2020-02-12T17:08:28Z", "type": "commit"}]}