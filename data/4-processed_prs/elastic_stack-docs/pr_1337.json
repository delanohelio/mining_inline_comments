{"pr_number": 1337, "pr_title": "[DOCS] Adds ML troubleshooting for upgrade", "pr_createdAt": "2020-08-18T01:22:38Z", "pr_url": "https://github.com/elastic/stack-docs/pull/1337", "timeline": [{"oid": "98b1fd82f2ae0673f23b5099cabb46d57d90b22e", "url": "https://github.com/elastic/stack-docs/commit/98b1fd82f2ae0673f23b5099cabb46d57d90b22e", "message": "[DOCS] Adds ML troubleshooting for upgrade", "committedDate": "2020-08-18T01:21:16Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjA3OTQ2NA==", "url": "https://github.com/elastic/stack-docs/pull/1337#discussion_r472079464", "bodyText": "The mapping additions for the config index are in elastic/elasticsearch#61157 (comment)\nPUT .ml-config/_mapping\n{\n  \"properties\": {\n    \"analysis_config\": {\n      \"properties\": {\n        \"per_partition_categorization\" : {\n          \"properties\" : {\n            \"enabled\" : {\n              \"type\" : \"boolean\"\n            },\n            \"stop_on_warn\" : {\n              \"type\" : \"boolean\"\n            }\n          }\n        }\n      }\n    },\n    \"max_num_threads\" : {\n      \"type\" : \"integer\"\n    },\n    \"model_plot_config\" : {\n      \"properties\" : {\n        \"annotations_enabled\" : {\n          \"type\" : \"boolean\"\n        }\n      }\n    }\n  }\n}", "author": "droberts195", "createdAt": "2020-08-18T10:32:34Z", "path": "docs/en/stack/ml/anomaly-detection/ml-troubleshooting.asciidoc", "diffHunk": "@@ -1,118 +1,154 @@\n [role=\"xpack\"]\n [[ml-troubleshooting]]\n-= Troubleshooting {ml} {anomaly-detect}\n+= Troubleshooting {anomaly-detect}\n ++++\n <titleabbrev>Troubleshooting</titleabbrev>\n ++++\n \n-Use the information in this section to troubleshoot common problems and find\n-answers for frequently asked questions.\n+Use the information in this section to troubleshoot common problems and known\n+issues.\n \n-* <<ml-rollingupgrade>>\n-* <<ml-mappingclash>>\n-* <<ml-jobnames>>\n-* <<ml-upgradedf>>\n+[discrete]\n+[ml-troubleshooting-mappings]\n+== Upgrade to 7.9.0 causes incorrect mappings\n \n-include::{stack-repo-dir}/help.asciidoc[tag=get-help]\n-\n-[[ml-rollingupgrade]]\n-== Machine learning features unavailable after rolling upgrade\n-\n-This problem occurs after you upgrade all of the nodes in your cluster to\n-{version} by using rolling upgrades. When you try to use {ml-features} for\n-the first time, all attempts fail, though `GET _xpack` and `GET _xpack/usage`\n-indicate that {xpack} is enabled.\n-\n-*Symptoms:*\n-\n-* Errors when you click *Machine Learning* in {kib}.\n-For example: `Jobs list could not be created` and `An internal server error occurred`.\n-* Null pointer and remote transport exceptions when you run {ml} APIs such as\n-`GET _ml/anomaly_detectors` and `GET _ml/datafeeds`.\n-* Errors in the log files on the master nodes.\n-For example: `unable to install ml metadata upon startup`\n-\n-*Resolution:*\n-\n-After you upgrade all master-eligible nodes to {es} {version}, restart the\n-current master node, which triggers the {ml-features} to re-initialize.\n-\n-For more information, see {ref}/rolling-upgrades.html[Rolling upgrades].\n-\n-[[ml-mappingclash]]\n-== Job creation failure due to mapping clash\n-\n-This problem occurs when you try to create an {anomaly-job}.\n-\n-*Symptoms:*\n-\n-* Illegal argument exception occurs when you click *Create Job* in {kib} or run\n-the create job API. For example:\n-`Save failed: [status_exception] This job would cause a mapping clash\n-with existing field [field_name] - avoid the clash by assigning a dedicated\n-results index` or `Save failed: [illegal_argument_exception] Can't merge a non\n-object mapping [field_name] with an object mapping [field_name]`.\n-\n-*Resolution:*\n-\n-This issue typically occurs when two or more jobs store their results in the\n-same index and the results contain fields with the same name but different\n-data types or different `fields` settings.\n-\n-By default, {ml} results are stored in the `.ml-anomalies-shared` index in {es}.\n-To resolve this issue, click *Advanced > Use dedicated index* when you create\n-the job in {kib}. If you are using the create {anomaly-job} job API, specify an\n-index name in the `results_index_name` property.\n-\n-[[ml-jobnames]]\n-== {kib} cannot display jobs with invalid characters in their name\n-\n-This problem occurs when you create an {anomaly-job} by using the\n-{ref}/ml-put-job.html[Create {anomaly-jobs} API] then try to view that job in\n-{kib}. In particular, the problem occurs when you use a period(.) in the job\n-identifier.\n+This problem occurs when you upgrade to 7.9.0 and incorrect mappings are\n+added to the {ml} annotations index or the {ml} config index.\n \n *Symptoms:*\n \n-* When you try to open a job (named, for example, `job.test` in the\n-**Anomaly Explorer** or the **Single Metric Viewer**, the job name is split and\n-the text after the period is assumed to be the job name. If a job does not exist\n-with that abbreviated name, an error occurs. For example:\n-`Warning Requested job test does not exist`. If a job exists with that\n-abbreviated name, it is displayed.\n+* Some pages in the {ml-app} UI do not display correctly. For example, the\n+*Anomaly Explorer* fails to load.\n+* The following error occurs in {kib} when you try to view annotations for\n+{anomaly-jobs}: `Error loading the list of annotations for this job`\n+* Cannot create or update any {ml} jobs. The error messages in this case are\n+illegal argument exceptions like `mapper [model_plot_config.annotations_enabled]\n+cannot be changed from type [keyword] to [boolean]`. This problem is most likely\n+to occur if after upgrading you open an existing {anomaly-job} in 7.9.0 before\n+you create or update a job. \n \n *Resolution:*\n \n-Create {anomaly-jobs} in {kib} or ensure that you create {anomaly-jobs} with\n-valid identifiers when you use the APIs. For more information about valid\n-identifiers, see\n-{ref}/ml-put-job.html[Create {anomaly-jobs} API].\n-\n-[[ml-upgradedf]]\n-== Upgraded nodes fail to start due to {dfeed} issues\n-\n-This problem occurs when you have a {dfeed} that contains search or query\n-domain specific language (DSL) that was discontinued. For example, if you\n-created a {dfeed} query in 5.x using search syntax that was deprecated in 5.x\n-and removed in 6.0, you must fix the {dfeed} before you upgrade to 6.0.\n-\n-*Symptoms:*\n-\n-* If {ref}/logging.html#deprecation-logging[deprecation logging] is enabled\n-before the upgrade, deprecation messages are generated when the {dfeeds} attempt\n-to retrieve data.\n-* After the upgrade, nodes fail to start and the error indicates that they\n-failed to read the local state.\n-\n-*Resolution:*\n-\n-Before you upgrade, identify the problematic search or query DSL. In 5.6.5 and\n-later, the Upgrade Assistant detects these scenarios. If you cannot fix the DSL\n-before the upgrade, you must delete the {dfeed} then re-create it with valid DSL\n-after the upgrade.\n-\n-If you do not fix or delete the {dfeed} before the upgrade, in order to successfully\n-start the failing nodes you must downgrade the nodes then fix the problem per\n-above.\n-\n-See also {stack-ref}/upgrading-elastic-stack.html[Upgrading the Elastic Stack].\n\\ No newline at end of file\n+To avoid this problem, manually update the mappings on the {ml} annotations and\n+config indices in your old {es} version before you upgrade to 7.9.0. For example:\n+\n+[source,console]\n+--------------------------------------------------\n+PUT .ml-annotations-6/_mapping\n+{\n+  \"properties\": {\n+    \"event\" : {\n+      \"type\" : \"keyword\"\n+    },\n+    \"detector_index\" : {\n+      \"type\" : \"integer\"\n+    },\n+    \"partition_field_name\" : {\n+      \"type\" : \"keyword\"\n+    },\n+    \"partition_field_value\" : {\n+      \"type\" : \"keyword\"\n+    },\n+    \"over_field_name\" : {\n+      \"type\" : \"keyword\"\n+    },\n+    \"over_field_value\" : {\n+      \"type\" : \"keyword\"\n+    },\n+    \"by_field_name\" : {\n+      \"type\" : \"keyword\"\n+    },\n+    \"by_field_value\" : {\n+      \"type\" : \"keyword\"\n+    }\n+  }\n+}\n+--------------------------------------------------\n+// TEST[skip:TBD]\n+\n+//TBD: Are the same mappings required for the .ml-config index?", "originalCommit": "98b1fd82f2ae0673f23b5099cabb46d57d90b22e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjA4MDQwNQ==", "url": "https://github.com/elastic/stack-docs/pull/1337#discussion_r472080405", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            # 2. . Create a temporary index \n          \n          \n            \n            # 2. Create a temporary index", "author": "droberts195", "createdAt": "2020-08-18T10:34:26Z", "path": "docs/en/stack/ml/anomaly-detection/ml-troubleshooting.asciidoc", "diffHunk": "@@ -1,118 +1,154 @@\n [role=\"xpack\"]\n [[ml-troubleshooting]]\n-= Troubleshooting {ml} {anomaly-detect}\n+= Troubleshooting {anomaly-detect}\n ++++\n <titleabbrev>Troubleshooting</titleabbrev>\n ++++\n \n-Use the information in this section to troubleshoot common problems and find\n-answers for frequently asked questions.\n+Use the information in this section to troubleshoot common problems and known\n+issues.\n \n-* <<ml-rollingupgrade>>\n-* <<ml-mappingclash>>\n-* <<ml-jobnames>>\n-* <<ml-upgradedf>>\n+[discrete]\n+[ml-troubleshooting-mappings]\n+== Upgrade to 7.9.0 causes incorrect mappings\n \n-include::{stack-repo-dir}/help.asciidoc[tag=get-help]\n-\n-[[ml-rollingupgrade]]\n-== Machine learning features unavailable after rolling upgrade\n-\n-This problem occurs after you upgrade all of the nodes in your cluster to\n-{version} by using rolling upgrades. When you try to use {ml-features} for\n-the first time, all attempts fail, though `GET _xpack` and `GET _xpack/usage`\n-indicate that {xpack} is enabled.\n-\n-*Symptoms:*\n-\n-* Errors when you click *Machine Learning* in {kib}.\n-For example: `Jobs list could not be created` and `An internal server error occurred`.\n-* Null pointer and remote transport exceptions when you run {ml} APIs such as\n-`GET _ml/anomaly_detectors` and `GET _ml/datafeeds`.\n-* Errors in the log files on the master nodes.\n-For example: `unable to install ml metadata upon startup`\n-\n-*Resolution:*\n-\n-After you upgrade all master-eligible nodes to {es} {version}, restart the\n-current master node, which triggers the {ml-features} to re-initialize.\n-\n-For more information, see {ref}/rolling-upgrades.html[Rolling upgrades].\n-\n-[[ml-mappingclash]]\n-== Job creation failure due to mapping clash\n-\n-This problem occurs when you try to create an {anomaly-job}.\n-\n-*Symptoms:*\n-\n-* Illegal argument exception occurs when you click *Create Job* in {kib} or run\n-the create job API. For example:\n-`Save failed: [status_exception] This job would cause a mapping clash\n-with existing field [field_name] - avoid the clash by assigning a dedicated\n-results index` or `Save failed: [illegal_argument_exception] Can't merge a non\n-object mapping [field_name] with an object mapping [field_name]`.\n-\n-*Resolution:*\n-\n-This issue typically occurs when two or more jobs store their results in the\n-same index and the results contain fields with the same name but different\n-data types or different `fields` settings.\n-\n-By default, {ml} results are stored in the `.ml-anomalies-shared` index in {es}.\n-To resolve this issue, click *Advanced > Use dedicated index* when you create\n-the job in {kib}. If you are using the create {anomaly-job} job API, specify an\n-index name in the `results_index_name` property.\n-\n-[[ml-jobnames]]\n-== {kib} cannot display jobs with invalid characters in their name\n-\n-This problem occurs when you create an {anomaly-job} by using the\n-{ref}/ml-put-job.html[Create {anomaly-jobs} API] then try to view that job in\n-{kib}. In particular, the problem occurs when you use a period(.) in the job\n-identifier.\n+This problem occurs when you upgrade to 7.9.0 and incorrect mappings are\n+added to the {ml} annotations index or the {ml} config index.\n \n *Symptoms:*\n \n-* When you try to open a job (named, for example, `job.test` in the\n-**Anomaly Explorer** or the **Single Metric Viewer**, the job name is split and\n-the text after the period is assumed to be the job name. If a job does not exist\n-with that abbreviated name, an error occurs. For example:\n-`Warning Requested job test does not exist`. If a job exists with that\n-abbreviated name, it is displayed.\n+* Some pages in the {ml-app} UI do not display correctly. For example, the\n+*Anomaly Explorer* fails to load.\n+* The following error occurs in {kib} when you try to view annotations for\n+{anomaly-jobs}: `Error loading the list of annotations for this job`\n+* Cannot create or update any {ml} jobs. The error messages in this case are\n+illegal argument exceptions like `mapper [model_plot_config.annotations_enabled]\n+cannot be changed from type [keyword] to [boolean]`. This problem is most likely\n+to occur if after upgrading you open an existing {anomaly-job} in 7.9.0 before\n+you create or update a job. \n \n *Resolution:*\n \n-Create {anomaly-jobs} in {kib} or ensure that you create {anomaly-jobs} with\n-valid identifiers when you use the APIs. For more information about valid\n-identifiers, see\n-{ref}/ml-put-job.html[Create {anomaly-jobs} API].\n-\n-[[ml-upgradedf]]\n-== Upgraded nodes fail to start due to {dfeed} issues\n-\n-This problem occurs when you have a {dfeed} that contains search or query\n-domain specific language (DSL) that was discontinued. For example, if you\n-created a {dfeed} query in 5.x using search syntax that was deprecated in 5.x\n-and removed in 6.0, you must fix the {dfeed} before you upgrade to 6.0.\n-\n-*Symptoms:*\n-\n-* If {ref}/logging.html#deprecation-logging[deprecation logging] is enabled\n-before the upgrade, deprecation messages are generated when the {dfeeds} attempt\n-to retrieve data.\n-* After the upgrade, nodes fail to start and the error indicates that they\n-failed to read the local state.\n-\n-*Resolution:*\n-\n-Before you upgrade, identify the problematic search or query DSL. In 5.6.5 and\n-later, the Upgrade Assistant detects these scenarios. If you cannot fix the DSL\n-before the upgrade, you must delete the {dfeed} then re-create it with valid DSL\n-after the upgrade.\n-\n-If you do not fix or delete the {dfeed} before the upgrade, in order to successfully\n-start the failing nodes you must downgrade the nodes then fix the problem per\n-above.\n-\n-See also {stack-ref}/upgrading-elastic-stack.html[Upgrading the Elastic Stack].\n\\ No newline at end of file\n+To avoid this problem, manually update the mappings on the {ml} annotations and\n+config indices in your old {es} version before you upgrade to 7.9.0. For example:\n+\n+[source,console]\n+--------------------------------------------------\n+PUT .ml-annotations-6/_mapping\n+{\n+  \"properties\": {\n+    \"event\" : {\n+      \"type\" : \"keyword\"\n+    },\n+    \"detector_index\" : {\n+      \"type\" : \"integer\"\n+    },\n+    \"partition_field_name\" : {\n+      \"type\" : \"keyword\"\n+    },\n+    \"partition_field_value\" : {\n+      \"type\" : \"keyword\"\n+    },\n+    \"over_field_name\" : {\n+      \"type\" : \"keyword\"\n+    },\n+    \"over_field_value\" : {\n+      \"type\" : \"keyword\"\n+    },\n+    \"by_field_name\" : {\n+      \"type\" : \"keyword\"\n+    },\n+    \"by_field_value\" : {\n+      \"type\" : \"keyword\"\n+    }\n+  }\n+}\n+--------------------------------------------------\n+// TEST[skip:TBD]\n+\n+//TBD: Are the same mappings required for the .ml-config index?\n+\n+If the problem exists in your {ml} annotations index after you upgrade, you must\n+reindex it. For example:\n+\n+[source,console]\n+--------------------------------------------------\n+# 1. Enable upgrade mode\n+POST _ml/set_upgrade_mode?enabled=true&timeout=10m\n+\n+# 2. . Create a temporary index ", "originalCommit": "98b1fd82f2ae0673f23b5099cabb46d57d90b22e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjA4MDkzOA==", "url": "https://github.com/elastic/stack-docs/pull/1337#discussion_r472080938", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            #8. Delete the temporary index\n          \n          \n            \n            # 8. Delete the temporary index", "author": "droberts195", "createdAt": "2020-08-18T10:35:23Z", "path": "docs/en/stack/ml/anomaly-detection/ml-troubleshooting.asciidoc", "diffHunk": "@@ -1,118 +1,154 @@\n [role=\"xpack\"]\n [[ml-troubleshooting]]\n-= Troubleshooting {ml} {anomaly-detect}\n+= Troubleshooting {anomaly-detect}\n ++++\n <titleabbrev>Troubleshooting</titleabbrev>\n ++++\n \n-Use the information in this section to troubleshoot common problems and find\n-answers for frequently asked questions.\n+Use the information in this section to troubleshoot common problems and known\n+issues.\n \n-* <<ml-rollingupgrade>>\n-* <<ml-mappingclash>>\n-* <<ml-jobnames>>\n-* <<ml-upgradedf>>\n+[discrete]\n+[ml-troubleshooting-mappings]\n+== Upgrade to 7.9.0 causes incorrect mappings\n \n-include::{stack-repo-dir}/help.asciidoc[tag=get-help]\n-\n-[[ml-rollingupgrade]]\n-== Machine learning features unavailable after rolling upgrade\n-\n-This problem occurs after you upgrade all of the nodes in your cluster to\n-{version} by using rolling upgrades. When you try to use {ml-features} for\n-the first time, all attempts fail, though `GET _xpack` and `GET _xpack/usage`\n-indicate that {xpack} is enabled.\n-\n-*Symptoms:*\n-\n-* Errors when you click *Machine Learning* in {kib}.\n-For example: `Jobs list could not be created` and `An internal server error occurred`.\n-* Null pointer and remote transport exceptions when you run {ml} APIs such as\n-`GET _ml/anomaly_detectors` and `GET _ml/datafeeds`.\n-* Errors in the log files on the master nodes.\n-For example: `unable to install ml metadata upon startup`\n-\n-*Resolution:*\n-\n-After you upgrade all master-eligible nodes to {es} {version}, restart the\n-current master node, which triggers the {ml-features} to re-initialize.\n-\n-For more information, see {ref}/rolling-upgrades.html[Rolling upgrades].\n-\n-[[ml-mappingclash]]\n-== Job creation failure due to mapping clash\n-\n-This problem occurs when you try to create an {anomaly-job}.\n-\n-*Symptoms:*\n-\n-* Illegal argument exception occurs when you click *Create Job* in {kib} or run\n-the create job API. For example:\n-`Save failed: [status_exception] This job would cause a mapping clash\n-with existing field [field_name] - avoid the clash by assigning a dedicated\n-results index` or `Save failed: [illegal_argument_exception] Can't merge a non\n-object mapping [field_name] with an object mapping [field_name]`.\n-\n-*Resolution:*\n-\n-This issue typically occurs when two or more jobs store their results in the\n-same index and the results contain fields with the same name but different\n-data types or different `fields` settings.\n-\n-By default, {ml} results are stored in the `.ml-anomalies-shared` index in {es}.\n-To resolve this issue, click *Advanced > Use dedicated index* when you create\n-the job in {kib}. If you are using the create {anomaly-job} job API, specify an\n-index name in the `results_index_name` property.\n-\n-[[ml-jobnames]]\n-== {kib} cannot display jobs with invalid characters in their name\n-\n-This problem occurs when you create an {anomaly-job} by using the\n-{ref}/ml-put-job.html[Create {anomaly-jobs} API] then try to view that job in\n-{kib}. In particular, the problem occurs when you use a period(.) in the job\n-identifier.\n+This problem occurs when you upgrade to 7.9.0 and incorrect mappings are\n+added to the {ml} annotations index or the {ml} config index.\n \n *Symptoms:*\n \n-* When you try to open a job (named, for example, `job.test` in the\n-**Anomaly Explorer** or the **Single Metric Viewer**, the job name is split and\n-the text after the period is assumed to be the job name. If a job does not exist\n-with that abbreviated name, an error occurs. For example:\n-`Warning Requested job test does not exist`. If a job exists with that\n-abbreviated name, it is displayed.\n+* Some pages in the {ml-app} UI do not display correctly. For example, the\n+*Anomaly Explorer* fails to load.\n+* The following error occurs in {kib} when you try to view annotations for\n+{anomaly-jobs}: `Error loading the list of annotations for this job`\n+* Cannot create or update any {ml} jobs. The error messages in this case are\n+illegal argument exceptions like `mapper [model_plot_config.annotations_enabled]\n+cannot be changed from type [keyword] to [boolean]`. This problem is most likely\n+to occur if after upgrading you open an existing {anomaly-job} in 7.9.0 before\n+you create or update a job. \n \n *Resolution:*\n \n-Create {anomaly-jobs} in {kib} or ensure that you create {anomaly-jobs} with\n-valid identifiers when you use the APIs. For more information about valid\n-identifiers, see\n-{ref}/ml-put-job.html[Create {anomaly-jobs} API].\n-\n-[[ml-upgradedf]]\n-== Upgraded nodes fail to start due to {dfeed} issues\n-\n-This problem occurs when you have a {dfeed} that contains search or query\n-domain specific language (DSL) that was discontinued. For example, if you\n-created a {dfeed} query in 5.x using search syntax that was deprecated in 5.x\n-and removed in 6.0, you must fix the {dfeed} before you upgrade to 6.0.\n-\n-*Symptoms:*\n-\n-* If {ref}/logging.html#deprecation-logging[deprecation logging] is enabled\n-before the upgrade, deprecation messages are generated when the {dfeeds} attempt\n-to retrieve data.\n-* After the upgrade, nodes fail to start and the error indicates that they\n-failed to read the local state.\n-\n-*Resolution:*\n-\n-Before you upgrade, identify the problematic search or query DSL. In 5.6.5 and\n-later, the Upgrade Assistant detects these scenarios. If you cannot fix the DSL\n-before the upgrade, you must delete the {dfeed} then re-create it with valid DSL\n-after the upgrade.\n-\n-If you do not fix or delete the {dfeed} before the upgrade, in order to successfully\n-start the failing nodes you must downgrade the nodes then fix the problem per\n-above.\n-\n-See also {stack-ref}/upgrading-elastic-stack.html[Upgrading the Elastic Stack].\n\\ No newline at end of file\n+To avoid this problem, manually update the mappings on the {ml} annotations and\n+config indices in your old {es} version before you upgrade to 7.9.0. For example:\n+\n+[source,console]\n+--------------------------------------------------\n+PUT .ml-annotations-6/_mapping\n+{\n+  \"properties\": {\n+    \"event\" : {\n+      \"type\" : \"keyword\"\n+    },\n+    \"detector_index\" : {\n+      \"type\" : \"integer\"\n+    },\n+    \"partition_field_name\" : {\n+      \"type\" : \"keyword\"\n+    },\n+    \"partition_field_value\" : {\n+      \"type\" : \"keyword\"\n+    },\n+    \"over_field_name\" : {\n+      \"type\" : \"keyword\"\n+    },\n+    \"over_field_value\" : {\n+      \"type\" : \"keyword\"\n+    },\n+    \"by_field_name\" : {\n+      \"type\" : \"keyword\"\n+    },\n+    \"by_field_value\" : {\n+      \"type\" : \"keyword\"\n+    }\n+  }\n+}\n+--------------------------------------------------\n+// TEST[skip:TBD]\n+\n+//TBD: Are the same mappings required for the .ml-config index?\n+\n+If the problem exists in your {ml} annotations index after you upgrade, you must\n+reindex it. For example:\n+\n+[source,console]\n+--------------------------------------------------\n+# 1. Enable upgrade mode\n+POST _ml/set_upgrade_mode?enabled=true&timeout=10m\n+\n+# 2. . Create a temporary index \n+PUT temp_ml_annotations\n+\n+# 3. Reindex the `.ml-annotations-6` index into the temporary index\n+POST _reindex\n+{\n+  \"source\": { \"index\": \".ml-annotations-6\" }, \n+  \"dest\": { \"index\": \"temp_ml_annotations\" }\n+}\n+\n+# 4. Delete the .ml-annotations-6 index\n+DELETE .ml-annotations-6\n+\n+# 5. Wait for .ml-annotations-6 to be recreated\n+\n+# 6. Reindex the temporary index into the .ml-annotations-6 index\n+POST _reindex\n+{\n+  \"source\": { \"index\": \"temp_ml_annotations\" }, \n+  \"dest\": { \"index\": \".ml-annotations-6\" }\n+}\n+\n+# 7. Disable upgrade mode\n+POST _ml/set_upgrade_mode?enabled=false&timeout=10m\n+\n+#8. Delete the temporary index\n+DELETE temp_ml_annotations\n+--------------------------------------------------\n+// TEST[skip:TBD]\n+\n+If the problem exists in your {ml} config index after you upgrade, you have two\n+options. If you discover this problem after you upgrade but before you open an\n+{anomaly-job}, you can apply the mappings manually. If the incorrect mappings\n+have already been applied, you must reindex to recover. For example:\n+\n+[source,console]\n+--------------------------------------------------\n+# 1. Enable upgrade mode\n+POST _ml/set_upgrade_mode?enabled=true&timeout=10m\n+\n+# 2. Create a temporary index\n+PUT temp_ml_config\n+\n+# 3. Reindex the .ml-config index into the temporary index\n+POST _reindex\n+{\n+  \"source\": { \"index\": \".ml-config\" }, \n+  \"dest\": { \"index\": \"temp_ml_config\" }\n+}\n+\n+# 4. Delete the .ml-config index\n+DELETE .ml-config\n+\n+# 5. Create the .ml-config index \n+PUT .ml-config\n+{\n+  \"settings\": { \"auto_expand_replicas\": \"0-1\"}\n+}\n+\n+# 6. Reindex the temporary index into the .ml-config index\n+POST _reindex\n+{\n+  \"source\": { \"index\": \"temp_ml_config\" }, \n+  \"dest\": { \"index\": \".ml-config\" }\n+}\n+\n+# 7. Disable upgrade mode\n+POST _ml/set_upgrade_mode?enabled=false&timeout=10m\n+\n+#8. Delete the temporary index", "originalCommit": "98b1fd82f2ae0673f23b5099cabb46d57d90b22e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjA4MTE1OA==", "url": "https://github.com/elastic/stack-docs/pull/1337#discussion_r472081158", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            #8. Delete the temporary index\n          \n          \n            \n            # 8. Delete the temporary index", "author": "droberts195", "createdAt": "2020-08-18T10:35:52Z", "path": "docs/en/stack/ml/anomaly-detection/ml-troubleshooting.asciidoc", "diffHunk": "@@ -1,118 +1,154 @@\n [role=\"xpack\"]\n [[ml-troubleshooting]]\n-= Troubleshooting {ml} {anomaly-detect}\n+= Troubleshooting {anomaly-detect}\n ++++\n <titleabbrev>Troubleshooting</titleabbrev>\n ++++\n \n-Use the information in this section to troubleshoot common problems and find\n-answers for frequently asked questions.\n+Use the information in this section to troubleshoot common problems and known\n+issues.\n \n-* <<ml-rollingupgrade>>\n-* <<ml-mappingclash>>\n-* <<ml-jobnames>>\n-* <<ml-upgradedf>>\n+[discrete]\n+[ml-troubleshooting-mappings]\n+== Upgrade to 7.9.0 causes incorrect mappings\n \n-include::{stack-repo-dir}/help.asciidoc[tag=get-help]\n-\n-[[ml-rollingupgrade]]\n-== Machine learning features unavailable after rolling upgrade\n-\n-This problem occurs after you upgrade all of the nodes in your cluster to\n-{version} by using rolling upgrades. When you try to use {ml-features} for\n-the first time, all attempts fail, though `GET _xpack` and `GET _xpack/usage`\n-indicate that {xpack} is enabled.\n-\n-*Symptoms:*\n-\n-* Errors when you click *Machine Learning* in {kib}.\n-For example: `Jobs list could not be created` and `An internal server error occurred`.\n-* Null pointer and remote transport exceptions when you run {ml} APIs such as\n-`GET _ml/anomaly_detectors` and `GET _ml/datafeeds`.\n-* Errors in the log files on the master nodes.\n-For example: `unable to install ml metadata upon startup`\n-\n-*Resolution:*\n-\n-After you upgrade all master-eligible nodes to {es} {version}, restart the\n-current master node, which triggers the {ml-features} to re-initialize.\n-\n-For more information, see {ref}/rolling-upgrades.html[Rolling upgrades].\n-\n-[[ml-mappingclash]]\n-== Job creation failure due to mapping clash\n-\n-This problem occurs when you try to create an {anomaly-job}.\n-\n-*Symptoms:*\n-\n-* Illegal argument exception occurs when you click *Create Job* in {kib} or run\n-the create job API. For example:\n-`Save failed: [status_exception] This job would cause a mapping clash\n-with existing field [field_name] - avoid the clash by assigning a dedicated\n-results index` or `Save failed: [illegal_argument_exception] Can't merge a non\n-object mapping [field_name] with an object mapping [field_name]`.\n-\n-*Resolution:*\n-\n-This issue typically occurs when two or more jobs store their results in the\n-same index and the results contain fields with the same name but different\n-data types or different `fields` settings.\n-\n-By default, {ml} results are stored in the `.ml-anomalies-shared` index in {es}.\n-To resolve this issue, click *Advanced > Use dedicated index* when you create\n-the job in {kib}. If you are using the create {anomaly-job} job API, specify an\n-index name in the `results_index_name` property.\n-\n-[[ml-jobnames]]\n-== {kib} cannot display jobs with invalid characters in their name\n-\n-This problem occurs when you create an {anomaly-job} by using the\n-{ref}/ml-put-job.html[Create {anomaly-jobs} API] then try to view that job in\n-{kib}. In particular, the problem occurs when you use a period(.) in the job\n-identifier.\n+This problem occurs when you upgrade to 7.9.0 and incorrect mappings are\n+added to the {ml} annotations index or the {ml} config index.\n \n *Symptoms:*\n \n-* When you try to open a job (named, for example, `job.test` in the\n-**Anomaly Explorer** or the **Single Metric Viewer**, the job name is split and\n-the text after the period is assumed to be the job name. If a job does not exist\n-with that abbreviated name, an error occurs. For example:\n-`Warning Requested job test does not exist`. If a job exists with that\n-abbreviated name, it is displayed.\n+* Some pages in the {ml-app} UI do not display correctly. For example, the\n+*Anomaly Explorer* fails to load.\n+* The following error occurs in {kib} when you try to view annotations for\n+{anomaly-jobs}: `Error loading the list of annotations for this job`\n+* Cannot create or update any {ml} jobs. The error messages in this case are\n+illegal argument exceptions like `mapper [model_plot_config.annotations_enabled]\n+cannot be changed from type [keyword] to [boolean]`. This problem is most likely\n+to occur if after upgrading you open an existing {anomaly-job} in 7.9.0 before\n+you create or update a job. \n \n *Resolution:*\n \n-Create {anomaly-jobs} in {kib} or ensure that you create {anomaly-jobs} with\n-valid identifiers when you use the APIs. For more information about valid\n-identifiers, see\n-{ref}/ml-put-job.html[Create {anomaly-jobs} API].\n-\n-[[ml-upgradedf]]\n-== Upgraded nodes fail to start due to {dfeed} issues\n-\n-This problem occurs when you have a {dfeed} that contains search or query\n-domain specific language (DSL) that was discontinued. For example, if you\n-created a {dfeed} query in 5.x using search syntax that was deprecated in 5.x\n-and removed in 6.0, you must fix the {dfeed} before you upgrade to 6.0.\n-\n-*Symptoms:*\n-\n-* If {ref}/logging.html#deprecation-logging[deprecation logging] is enabled\n-before the upgrade, deprecation messages are generated when the {dfeeds} attempt\n-to retrieve data.\n-* After the upgrade, nodes fail to start and the error indicates that they\n-failed to read the local state.\n-\n-*Resolution:*\n-\n-Before you upgrade, identify the problematic search or query DSL. In 5.6.5 and\n-later, the Upgrade Assistant detects these scenarios. If you cannot fix the DSL\n-before the upgrade, you must delete the {dfeed} then re-create it with valid DSL\n-after the upgrade.\n-\n-If you do not fix or delete the {dfeed} before the upgrade, in order to successfully\n-start the failing nodes you must downgrade the nodes then fix the problem per\n-above.\n-\n-See also {stack-ref}/upgrading-elastic-stack.html[Upgrading the Elastic Stack].\n\\ No newline at end of file\n+To avoid this problem, manually update the mappings on the {ml} annotations and\n+config indices in your old {es} version before you upgrade to 7.9.0. For example:\n+\n+[source,console]\n+--------------------------------------------------\n+PUT .ml-annotations-6/_mapping\n+{\n+  \"properties\": {\n+    \"event\" : {\n+      \"type\" : \"keyword\"\n+    },\n+    \"detector_index\" : {\n+      \"type\" : \"integer\"\n+    },\n+    \"partition_field_name\" : {\n+      \"type\" : \"keyword\"\n+    },\n+    \"partition_field_value\" : {\n+      \"type\" : \"keyword\"\n+    },\n+    \"over_field_name\" : {\n+      \"type\" : \"keyword\"\n+    },\n+    \"over_field_value\" : {\n+      \"type\" : \"keyword\"\n+    },\n+    \"by_field_name\" : {\n+      \"type\" : \"keyword\"\n+    },\n+    \"by_field_value\" : {\n+      \"type\" : \"keyword\"\n+    }\n+  }\n+}\n+--------------------------------------------------\n+// TEST[skip:TBD]\n+\n+//TBD: Are the same mappings required for the .ml-config index?\n+\n+If the problem exists in your {ml} annotations index after you upgrade, you must\n+reindex it. For example:\n+\n+[source,console]\n+--------------------------------------------------\n+# 1. Enable upgrade mode\n+POST _ml/set_upgrade_mode?enabled=true&timeout=10m\n+\n+# 2. . Create a temporary index \n+PUT temp_ml_annotations\n+\n+# 3. Reindex the `.ml-annotations-6` index into the temporary index\n+POST _reindex\n+{\n+  \"source\": { \"index\": \".ml-annotations-6\" }, \n+  \"dest\": { \"index\": \"temp_ml_annotations\" }\n+}\n+\n+# 4. Delete the .ml-annotations-6 index\n+DELETE .ml-annotations-6\n+\n+# 5. Wait for .ml-annotations-6 to be recreated\n+\n+# 6. Reindex the temporary index into the .ml-annotations-6 index\n+POST _reindex\n+{\n+  \"source\": { \"index\": \"temp_ml_annotations\" }, \n+  \"dest\": { \"index\": \".ml-annotations-6\" }\n+}\n+\n+# 7. Disable upgrade mode\n+POST _ml/set_upgrade_mode?enabled=false&timeout=10m\n+\n+#8. Delete the temporary index", "originalCommit": "98b1fd82f2ae0673f23b5099cabb46d57d90b22e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjA4MjM3MA==", "url": "https://github.com/elastic/stack-docs/pull/1337#discussion_r472082370", "bodyText": "It would be best to move this between current steps 4 and 5, i.e. 7 -> 5, 5 -> 6, 6 -> 7.", "author": "droberts195", "createdAt": "2020-08-18T10:38:06Z", "path": "docs/en/stack/ml/anomaly-detection/ml-troubleshooting.asciidoc", "diffHunk": "@@ -1,118 +1,154 @@\n [role=\"xpack\"]\n [[ml-troubleshooting]]\n-= Troubleshooting {ml} {anomaly-detect}\n+= Troubleshooting {anomaly-detect}\n ++++\n <titleabbrev>Troubleshooting</titleabbrev>\n ++++\n \n-Use the information in this section to troubleshoot common problems and find\n-answers for frequently asked questions.\n+Use the information in this section to troubleshoot common problems and known\n+issues.\n \n-* <<ml-rollingupgrade>>\n-* <<ml-mappingclash>>\n-* <<ml-jobnames>>\n-* <<ml-upgradedf>>\n+[discrete]\n+[ml-troubleshooting-mappings]\n+== Upgrade to 7.9.0 causes incorrect mappings\n \n-include::{stack-repo-dir}/help.asciidoc[tag=get-help]\n-\n-[[ml-rollingupgrade]]\n-== Machine learning features unavailable after rolling upgrade\n-\n-This problem occurs after you upgrade all of the nodes in your cluster to\n-{version} by using rolling upgrades. When you try to use {ml-features} for\n-the first time, all attempts fail, though `GET _xpack` and `GET _xpack/usage`\n-indicate that {xpack} is enabled.\n-\n-*Symptoms:*\n-\n-* Errors when you click *Machine Learning* in {kib}.\n-For example: `Jobs list could not be created` and `An internal server error occurred`.\n-* Null pointer and remote transport exceptions when you run {ml} APIs such as\n-`GET _ml/anomaly_detectors` and `GET _ml/datafeeds`.\n-* Errors in the log files on the master nodes.\n-For example: `unable to install ml metadata upon startup`\n-\n-*Resolution:*\n-\n-After you upgrade all master-eligible nodes to {es} {version}, restart the\n-current master node, which triggers the {ml-features} to re-initialize.\n-\n-For more information, see {ref}/rolling-upgrades.html[Rolling upgrades].\n-\n-[[ml-mappingclash]]\n-== Job creation failure due to mapping clash\n-\n-This problem occurs when you try to create an {anomaly-job}.\n-\n-*Symptoms:*\n-\n-* Illegal argument exception occurs when you click *Create Job* in {kib} or run\n-the create job API. For example:\n-`Save failed: [status_exception] This job would cause a mapping clash\n-with existing field [field_name] - avoid the clash by assigning a dedicated\n-results index` or `Save failed: [illegal_argument_exception] Can't merge a non\n-object mapping [field_name] with an object mapping [field_name]`.\n-\n-*Resolution:*\n-\n-This issue typically occurs when two or more jobs store their results in the\n-same index and the results contain fields with the same name but different\n-data types or different `fields` settings.\n-\n-By default, {ml} results are stored in the `.ml-anomalies-shared` index in {es}.\n-To resolve this issue, click *Advanced > Use dedicated index* when you create\n-the job in {kib}. If you are using the create {anomaly-job} job API, specify an\n-index name in the `results_index_name` property.\n-\n-[[ml-jobnames]]\n-== {kib} cannot display jobs with invalid characters in their name\n-\n-This problem occurs when you create an {anomaly-job} by using the\n-{ref}/ml-put-job.html[Create {anomaly-jobs} API] then try to view that job in\n-{kib}. In particular, the problem occurs when you use a period(.) in the job\n-identifier.\n+This problem occurs when you upgrade to 7.9.0 and incorrect mappings are\n+added to the {ml} annotations index or the {ml} config index.\n \n *Symptoms:*\n \n-* When you try to open a job (named, for example, `job.test` in the\n-**Anomaly Explorer** or the **Single Metric Viewer**, the job name is split and\n-the text after the period is assumed to be the job name. If a job does not exist\n-with that abbreviated name, an error occurs. For example:\n-`Warning Requested job test does not exist`. If a job exists with that\n-abbreviated name, it is displayed.\n+* Some pages in the {ml-app} UI do not display correctly. For example, the\n+*Anomaly Explorer* fails to load.\n+* The following error occurs in {kib} when you try to view annotations for\n+{anomaly-jobs}: `Error loading the list of annotations for this job`\n+* Cannot create or update any {ml} jobs. The error messages in this case are\n+illegal argument exceptions like `mapper [model_plot_config.annotations_enabled]\n+cannot be changed from type [keyword] to [boolean]`. This problem is most likely\n+to occur if after upgrading you open an existing {anomaly-job} in 7.9.0 before\n+you create or update a job. \n \n *Resolution:*\n \n-Create {anomaly-jobs} in {kib} or ensure that you create {anomaly-jobs} with\n-valid identifiers when you use the APIs. For more information about valid\n-identifiers, see\n-{ref}/ml-put-job.html[Create {anomaly-jobs} API].\n-\n-[[ml-upgradedf]]\n-== Upgraded nodes fail to start due to {dfeed} issues\n-\n-This problem occurs when you have a {dfeed} that contains search or query\n-domain specific language (DSL) that was discontinued. For example, if you\n-created a {dfeed} query in 5.x using search syntax that was deprecated in 5.x\n-and removed in 6.0, you must fix the {dfeed} before you upgrade to 6.0.\n-\n-*Symptoms:*\n-\n-* If {ref}/logging.html#deprecation-logging[deprecation logging] is enabled\n-before the upgrade, deprecation messages are generated when the {dfeeds} attempt\n-to retrieve data.\n-* After the upgrade, nodes fail to start and the error indicates that they\n-failed to read the local state.\n-\n-*Resolution:*\n-\n-Before you upgrade, identify the problematic search or query DSL. In 5.6.5 and\n-later, the Upgrade Assistant detects these scenarios. If you cannot fix the DSL\n-before the upgrade, you must delete the {dfeed} then re-create it with valid DSL\n-after the upgrade.\n-\n-If you do not fix or delete the {dfeed} before the upgrade, in order to successfully\n-start the failing nodes you must downgrade the nodes then fix the problem per\n-above.\n-\n-See also {stack-ref}/upgrading-elastic-stack.html[Upgrading the Elastic Stack].\n\\ No newline at end of file\n+To avoid this problem, manually update the mappings on the {ml} annotations and\n+config indices in your old {es} version before you upgrade to 7.9.0. For example:\n+\n+[source,console]\n+--------------------------------------------------\n+PUT .ml-annotations-6/_mapping\n+{\n+  \"properties\": {\n+    \"event\" : {\n+      \"type\" : \"keyword\"\n+    },\n+    \"detector_index\" : {\n+      \"type\" : \"integer\"\n+    },\n+    \"partition_field_name\" : {\n+      \"type\" : \"keyword\"\n+    },\n+    \"partition_field_value\" : {\n+      \"type\" : \"keyword\"\n+    },\n+    \"over_field_name\" : {\n+      \"type\" : \"keyword\"\n+    },\n+    \"over_field_value\" : {\n+      \"type\" : \"keyword\"\n+    },\n+    \"by_field_name\" : {\n+      \"type\" : \"keyword\"\n+    },\n+    \"by_field_value\" : {\n+      \"type\" : \"keyword\"\n+    }\n+  }\n+}\n+--------------------------------------------------\n+// TEST[skip:TBD]\n+\n+//TBD: Are the same mappings required for the .ml-config index?\n+\n+If the problem exists in your {ml} annotations index after you upgrade, you must\n+reindex it. For example:\n+\n+[source,console]\n+--------------------------------------------------\n+# 1. Enable upgrade mode\n+POST _ml/set_upgrade_mode?enabled=true&timeout=10m\n+\n+# 2. . Create a temporary index \n+PUT temp_ml_annotations\n+\n+# 3. Reindex the `.ml-annotations-6` index into the temporary index\n+POST _reindex\n+{\n+  \"source\": { \"index\": \".ml-annotations-6\" }, \n+  \"dest\": { \"index\": \"temp_ml_annotations\" }\n+}\n+\n+# 4. Delete the .ml-annotations-6 index\n+DELETE .ml-annotations-6\n+\n+# 5. Wait for .ml-annotations-6 to be recreated\n+\n+# 6. Reindex the temporary index into the .ml-annotations-6 index\n+POST _reindex\n+{\n+  \"source\": { \"index\": \"temp_ml_annotations\" }, \n+  \"dest\": { \"index\": \".ml-annotations-6\" }\n+}\n+\n+# 7. Disable upgrade mode\n+POST _ml/set_upgrade_mode?enabled=false&timeout=10m", "originalCommit": "98b1fd82f2ae0673f23b5099cabb46d57d90b22e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjI5MjAzMw==", "url": "https://github.com/elastic/stack-docs/pull/1337#discussion_r472292033", "bodyText": "Thanks, I've made the same change in the second set of resolution steps too.", "author": "lcawl", "createdAt": "2020-08-18T15:38:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjA4MjM3MA=="}], "type": "inlineReview"}, {"oid": "4f9fae2f3b5403a40034ca57b1a35510726963a7", "url": "https://github.com/elastic/stack-docs/commit/4f9fae2f3b5403a40034ca57b1a35510726963a7", "message": "Update docs/en/stack/ml/anomaly-detection/ml-troubleshooting.asciidoc\n\nCo-authored-by: David Roberts <dave.roberts@elastic.co>", "committedDate": "2020-08-18T15:13:03Z", "type": "commit"}, {"oid": "811a3a4e07c45561c6f86a8a1a4dc4b12d5703f0", "url": "https://github.com/elastic/stack-docs/commit/811a3a4e07c45561c6f86a8a1a4dc4b12d5703f0", "message": "Update docs/en/stack/ml/anomaly-detection/ml-troubleshooting.asciidoc\n\nCo-authored-by: David Roberts <dave.roberts@elastic.co>", "committedDate": "2020-08-18T15:13:46Z", "type": "commit"}, {"oid": "858f4e3a78c3acea970cb243f62316f545c47bbb", "url": "https://github.com/elastic/stack-docs/commit/858f4e3a78c3acea970cb243f62316f545c47bbb", "message": "Update docs/en/stack/ml/anomaly-detection/ml-troubleshooting.asciidoc\n\nCo-authored-by: David Roberts <dave.roberts@elastic.co>", "committedDate": "2020-08-18T15:14:06Z", "type": "commit"}, {"oid": "b7f98974e36ad4184ff29cb778630869f37c30a6", "url": "https://github.com/elastic/stack-docs/commit/b7f98974e36ad4184ff29cb778630869f37c30a6", "message": "[DOCS] Fixes order of resolution steps", "committedDate": "2020-08-18T15:22:13Z", "type": "commit"}, {"oid": "42386839570aa46971ad5581e20f46436a479248", "url": "https://github.com/elastic/stack-docs/commit/42386839570aa46971ad5581e20f46436a479248", "message": "[DOCS] Fixes typo", "committedDate": "2020-08-18T15:25:00Z", "type": "commit"}, {"oid": "abbaa7d9e4c482c3a407994611c8c22a160a30b2", "url": "https://github.com/elastic/stack-docs/commit/abbaa7d9e4c482c3a407994611c8c22a160a30b2", "message": "[DOCS] Updates the resolution steps", "committedDate": "2020-08-18T15:37:44Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjMwMDg0NA==", "url": "https://github.com/elastic/stack-docs/pull/1337#discussion_r472300844", "bodyText": "For the config index upgrade mode should stay in force until after reindex.  It's different for the annotations index as they're used at different times and created in different ways.", "author": "droberts195", "createdAt": "2020-08-18T15:51:14Z", "path": "docs/en/stack/ml/anomaly-detection/ml-troubleshooting.asciidoc", "diffHunk": "@@ -164,20 +167,17 @@ PUT .ml-config\n   \"settings\": { \"auto_expand_replicas\": \"0-1\"}\n }\n \n-# 6. Reindex the temporary index into the .ml-config index\n+# 6. Disable upgrade mode\n+POST _ml/set_upgrade_mode?enabled=false&timeout=10m", "originalCommit": "abbaa7d9e4c482c3a407994611c8c22a160a30b2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjMwOTU2NQ==", "url": "https://github.com/elastic/stack-docs/pull/1337#discussion_r472309565", "bodyText": "Done, thanks!", "author": "lcawl", "createdAt": "2020-08-18T16:03:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjMwMDg0NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjMwMTM1Mw==", "url": "https://github.com/elastic/stack-docs/pull/1337#discussion_r472301353", "bodyText": "Suggested change", "author": "droberts195", "createdAt": "2020-08-18T15:51:46Z", "path": "docs/en/stack/ml/anomaly-detection/ml-troubleshooting.asciidoc", "diffHunk": "@@ -1,118 +1,183 @@\n [role=\"xpack\"]\n [[ml-troubleshooting]]\n-= Troubleshooting {ml} {anomaly-detect}\n+= Troubleshooting {anomaly-detect}\n ++++\n <titleabbrev>Troubleshooting</titleabbrev>\n ++++\n \n-Use the information in this section to troubleshoot common problems and find\n-answers for frequently asked questions.\n+Use the information in this section to troubleshoot common problems and known\n+issues.\n \n-* <<ml-rollingupgrade>>\n-* <<ml-mappingclash>>\n-* <<ml-jobnames>>\n-* <<ml-upgradedf>>\n+[discrete]\n+[[ml-troubleshooting-mappings]]\n+== Upgrade to 7.9.0 causes incorrect mappings\n \n-include::{stack-repo-dir}/help.asciidoc[tag=get-help]\n-\n-[[ml-rollingupgrade]]\n-== Machine learning features unavailable after rolling upgrade\n-\n-This problem occurs after you upgrade all of the nodes in your cluster to\n-{version} by using rolling upgrades. When you try to use {ml-features} for\n-the first time, all attempts fail, though `GET _xpack` and `GET _xpack/usage`\n-indicate that {xpack} is enabled.\n-\n-*Symptoms:*\n-\n-* Errors when you click *Machine Learning* in {kib}.\n-For example: `Jobs list could not be created` and `An internal server error occurred`.\n-* Null pointer and remote transport exceptions when you run {ml} APIs such as\n-`GET _ml/anomaly_detectors` and `GET _ml/datafeeds`.\n-* Errors in the log files on the master nodes.\n-For example: `unable to install ml metadata upon startup`\n-\n-*Resolution:*\n-\n-After you upgrade all master-eligible nodes to {es} {version}, restart the\n-current master node, which triggers the {ml-features} to re-initialize.\n-\n-For more information, see {ref}/rolling-upgrades.html[Rolling upgrades].\n-\n-[[ml-mappingclash]]\n-== Job creation failure due to mapping clash\n-\n-This problem occurs when you try to create an {anomaly-job}.\n-\n-*Symptoms:*\n-\n-* Illegal argument exception occurs when you click *Create Job* in {kib} or run\n-the create job API. For example:\n-`Save failed: [status_exception] This job would cause a mapping clash\n-with existing field [field_name] - avoid the clash by assigning a dedicated\n-results index` or `Save failed: [illegal_argument_exception] Can't merge a non\n-object mapping [field_name] with an object mapping [field_name]`.\n-\n-*Resolution:*\n-\n-This issue typically occurs when two or more jobs store their results in the\n-same index and the results contain fields with the same name but different\n-data types or different `fields` settings.\n-\n-By default, {ml} results are stored in the `.ml-anomalies-shared` index in {es}.\n-To resolve this issue, click *Advanced > Use dedicated index* when you create\n-the job in {kib}. If you are using the create {anomaly-job} job API, specify an\n-index name in the `results_index_name` property.\n-\n-[[ml-jobnames]]\n-== {kib} cannot display jobs with invalid characters in their name\n-\n-This problem occurs when you create an {anomaly-job} by using the\n-{ref}/ml-put-job.html[Create {anomaly-jobs} API] then try to view that job in\n-{kib}. In particular, the problem occurs when you use a period(.) in the job\n-identifier.\n+This problem occurs when you upgrade to 7.9.0 and incorrect mappings are\n+added to the {ml} annotations index or the {ml} config index.\n \n *Symptoms:*\n \n-* When you try to open a job (named, for example, `job.test` in the\n-**Anomaly Explorer** or the **Single Metric Viewer**, the job name is split and\n-the text after the period is assumed to be the job name. If a job does not exist\n-with that abbreviated name, an error occurs. For example:\n-`Warning Requested job test does not exist`. If a job exists with that\n-abbreviated name, it is displayed.\n+* Some pages in the {ml-app} UI do not display correctly. For example, the\n+*Anomaly Explorer* fails to load.\n+* The following error occurs in {kib} when you try to view annotations for\n+{anomaly-jobs}: `Error loading the list of annotations for this job`\n+* Cannot create or update any {ml} jobs. The error messages in this case are\n+illegal argument exceptions like `mapper [model_plot_config.annotations_enabled]\n+cannot be changed from type [keyword] to [boolean]`. This problem is most likely\n+to occur if after upgrading you open an existing {anomaly-job} in 7.9.0 before\n+you create or update a job. \n \n *Resolution:*\n \n-Create {anomaly-jobs} in {kib} or ensure that you create {anomaly-jobs} with\n-valid identifiers when you use the APIs. For more information about valid\n-identifiers, see\n-{ref}/ml-put-job.html[Create {anomaly-jobs} API].\n-\n-[[ml-upgradedf]]\n-== Upgraded nodes fail to start due to {dfeed} issues\n-\n-This problem occurs when you have a {dfeed} that contains search or query\n-domain specific language (DSL) that was discontinued. For example, if you\n-created a {dfeed} query in 5.x using search syntax that was deprecated in 5.x\n-and removed in 6.0, you must fix the {dfeed} before you upgrade to 6.0.\n-\n-*Symptoms:*\n-\n-* If {ref}/logging.html#deprecation-logging[deprecation logging] is enabled\n-before the upgrade, deprecation messages are generated when the {dfeeds} attempt\n-to retrieve data.\n-* After the upgrade, nodes fail to start and the error indicates that they\n-failed to read the local state.\n-\n-*Resolution:*\n-\n-Before you upgrade, identify the problematic search or query DSL. In 5.6.5 and\n-later, the Upgrade Assistant detects these scenarios. If you cannot fix the DSL\n-before the upgrade, you must delete the {dfeed} then re-create it with valid DSL\n-after the upgrade.\n-\n-If you do not fix or delete the {dfeed} before the upgrade, in order to successfully\n-start the failing nodes you must downgrade the nodes then fix the problem per\n-above.\n-\n-See also {stack-ref}/upgrading-elastic-stack.html[Upgrading the Elastic Stack].\n\\ No newline at end of file\n+To avoid this problem, manually update the mappings on the {ml} annotations and\n+config indices in your old {es} version before you upgrade to 7.9.0. For example:\n+\n+[source,console]\n+--------------------------------------------------\n+PUT .ml-annotations-6/_mapping\n+{\n+  \"properties\": {\n+    \"event\" : {\n+      \"type\" : \"keyword\"\n+    },\n+    \"detector_index\" : {\n+      \"type\" : \"integer\"\n+    },\n+    \"partition_field_name\" : {\n+      \"type\" : \"keyword\"\n+    },\n+    \"partition_field_value\" : {\n+      \"type\" : \"keyword\"\n+    },\n+    \"over_field_name\" : {\n+      \"type\" : \"keyword\"\n+    },\n+    \"over_field_value\" : {\n+      \"type\" : \"keyword\"\n+    },\n+    \"by_field_name\" : {\n+      \"type\" : \"keyword\"\n+    },\n+    \"by_field_value\" : {\n+      \"type\" : \"keyword\"\n+    }\n+  }\n+}\n+\n+PUT .ml-config/_mapping\n+{\n+  \"properties\": {\n+    \"analysis_config\": {\n+      \"properties\": {\n+        \"per_partition_categorization\" : {\n+          \"properties\" : {\n+            \"enabled\" : {\n+              \"type\" : \"boolean\"\n+            },\n+            \"stop_on_warn\" : {\n+              \"type\" : \"boolean\"\n+            }\n+          }\n+        }\n+      }\n+    },\n+    \"max_num_threads\" : {\n+      \"type\" : \"integer\"\n+    },\n+    \"model_plot_config\" : {\n+      \"properties\" : {\n+        \"annotations_enabled\" : {\n+          \"type\" : \"boolean\"\n+        }\n+      }\n+    }\n+  }\n+}\n+--------------------------------------------------\n+// TEST[skip:TBD]\n+\n+NOTE: If {security-features} are enabled, you must have the\n+{ref}/built-in-roles.html[`superuser` role] to alter the `.ml-config` index.\n+\n+If you did not manually update the mappings before the upgrade, you can\n+nonetheless try to do it after the upgrade. If either update fails, you must\n+reindex that index.\n+\n+For example, to reindex the {ml} annotations index, follow these steps:\n+\n+[source,console]\n+--------------------------------------------------\n+# 1. Enable upgrade mode\n+POST _ml/set_upgrade_mode?enabled=true&timeout=10m\n+\n+# 2. Create a temporary index \n+PUT temp_ml_annotations\n+\n+# 3. Reindex the `.ml-annotations-6` index into the temporary index\n+POST _reindex\n+{\n+  \"source\": { \"index\": \".ml-annotations-6\" }, \n+  \"dest\": { \"index\": \"temp_ml_annotations\" }\n+}\n+\n+# 4. Delete the .ml-annotations-6 index\n+DELETE .ml-annotations-6\n+\n+# 5. Disable upgrade mode\n+POST _ml/set_upgrade_mode?enabled=false&timeout=10m\n+\n+", "originalCommit": "abbaa7d9e4c482c3a407994611c8c22a160a30b2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "d6a1fb9f41ad22ab67f4fef14f72f7e2c51bd159", "url": "https://github.com/elastic/stack-docs/commit/d6a1fb9f41ad22ab67f4fef14f72f7e2c51bd159", "message": "Update docs/en/stack/ml/anomaly-detection/ml-troubleshooting.asciidoc\n\nCo-authored-by: David Roberts <dave.roberts@elastic.co>", "committedDate": "2020-08-18T16:02:21Z", "type": "commit"}, {"oid": "4b2bcbb23525ca3f49b9eb83761a192cf7c2bb22", "url": "https://github.com/elastic/stack-docs/commit/4b2bcbb23525ca3f49b9eb83761a192cf7c2bb22", "message": "[DOCS] Fix order of disabling upgrade mode", "committedDate": "2020-08-18T16:05:55Z", "type": "commit"}]}