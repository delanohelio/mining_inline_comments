{"pr_number": 2614, "pr_title": "Bugfix/search portlet do not support new search UI", "pr_createdAt": "2020-12-17T04:28:07Z", "pr_url": "https://github.com/openequella/openEQUELLA/pull/2614", "timeline": [{"oid": "fdda9876511271925bcf94971c0f7895601907d2", "url": "https://github.com/openequella/openEQUELLA/commit/fdda9876511271925bcf94971c0f7895601907d2", "message": "Support quick search portlet for new Search UI.", "committedDate": "2020-12-17T01:26:09Z", "type": "commit"}, {"oid": "4e55578829e609d5bfc0b6683145cd102233995c", "url": "https://github.com/openequella/openEQUELLA/commit/4e55578829e609d5bfc0b6683145cd102233995c", "message": "Support converting query strings to search options\nin Selection Session.", "committedDate": "2020-12-17T02:16:41Z", "type": "commit"}, {"oid": "ea13a660c7922a517f46765b8773a9b5f687df7b", "url": "https://github.com/openequella/openEQUELLA/commit/ea13a660c7922a517f46765b8773a9b5f687df7b", "message": "Don't convert query strings to search option\nif there is a search option in history.", "committedDate": "2020-12-17T03:50:19Z", "type": "commit"}, {"oid": "71cc4ce767494e3fc2235d38fe27d59d05b40ef6", "url": "https://github.com/openequella/openEQUELLA/commit/71cc4ce767494e3fc2235d38fe27d59d05b40ef6", "message": "Don't manipulate browser history for the initial search\nif the search option is the default one.", "committedDate": "2020-12-17T22:53:12Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTQ1ODcyNQ==", "url": "https://github.com/openequella/openEQUELLA/pull/2614#discussion_r545458725", "bodyText": "Without this library, TS complains that the function keys() does not exist in URLSearchParams.", "author": "PenghaiZhang", "createdAt": "2020-12-17T22:58:06Z", "path": "Source/Plugins/Core/com.equella.core/js/tsconfig.json", "diffHunk": "@@ -4,7 +4,7 @@\n     \"module\": \"CommonJS\",\n     \"esModuleInterop\": true,\n     \"target\": \"es5\",\n-    \"lib\": [\"es2020\", \"dom\"],\n+    \"lib\": [\"es2020\", \"dom\", \"dom.iterable\"],", "originalCommit": "71cc4ce767494e3fc2235d38fe27d59d05b40ef6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTQ1OTQ1Mg==", "url": "https://github.com/openequella/openEQUELLA/pull/2614#discussion_r545459452", "bodyText": "As I need to use the standard Array, I need to rename this Runtype Array.", "author": "PenghaiZhang", "createdAt": "2020-12-17T22:59:52Z", "path": "Source/Plugins/Core/com.equella.core/js/tsrc/modules/SearchModule.ts", "diffHunk": "@@ -20,7 +20,7 @@ import * as OEQ from \"@openequella/rest-api-client\";\n import { Location } from \"history\";\n import { pick } from \"lodash\";\n import {\n-  Array,\n+  Array as RuntypeArray,", "originalCommit": "71cc4ce767494e3fc2235d38fe27d59d05b40ef6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTQ2NzQxNQ==", "url": "https://github.com/openequella/openEQUELLA/pull/2614#discussion_r545467415", "bodyText": "do we know the state will be this shape for certain?\nWould a runtype make sense here?", "author": "ChristianMurphy", "createdAt": "2020-12-17T23:16:18Z", "path": "Source/Plugins/Core/com.equella.core/js/tsrc/search/SearchPage.tsx", "diffHunk": "@@ -121,15 +120,16 @@ const SearchPage = ({ updateTemplate }: TemplateUpdateProps) => {\n     searchPageOptions: defaultSearchPageOptions,\n     filterExpansion: false,\n   };\n-\n+  const searchPageHistoryState: SearchPageHistoryState | undefined = history\n+    .location.state as SearchPageHistoryState;", "originalCommit": "71cc4ce767494e3fc2235d38fe27d59d05b40ef6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTUwMzE2NQ==", "url": "https://github.com/openequella/openEQUELLA/pull/2614#discussion_r545503165", "bodyText": "Thanks Christian!\nLike your idea ! I have raised an Github issue  #2615 for this and do it in next release \ud83d\ude04", "author": "PenghaiZhang", "createdAt": "2020-12-18T00:55:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTQ2NzQxNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTQ4MjM2MQ==", "url": "https://github.com/openequella/openEQUELLA/pull/2614#discussion_r545482361", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  // If the search option already exists, don't do query string conversion.\n          \n          \n            \n                  // If the search options are available from browser history, ignore those in the query string", "author": "edalex-ian", "createdAt": "2020-12-17T23:54:27Z", "path": "Source/Plugins/Core/com.equella.core/js/tsrc/search/SearchPage.tsx", "diffHunk": "@@ -158,8 +158,8 @@ const SearchPage = ({ updateTemplate }: TemplateUpdateProps) => {\n \n     Promise.all([\n       getSearchSettingsFromServer(),\n-      // Do not convert query string params to search options in Selection Session.\n-      isSelectionSessionOpen()\n+      // If the search option already exists, don't do query string conversion.", "originalCommit": "71cc4ce767494e3fc2235d38fe27d59d05b40ef6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTQ4MzE1NA==", "url": "https://github.com/openequella/openEQUELLA/pull/2614#discussion_r545483154", "bodyText": "We have a few comments like this scattered around the place, what's really missing though is the why. Could you please add that here.", "author": "edalex-ian", "createdAt": "2020-12-17T23:56:33Z", "path": "Source/Plugins/Core/com.equella.core/js/tsrc/search/SearchPage.tsx", "diffHunk": "@@ -197,10 +197,16 @@ const SearchPage = ({ updateTemplate }: TemplateUpdateProps) => {\n   }, [searchPageOptions]);\n \n   useEffect(() => {\n-    history.replace({\n-      ...history.location,\n-      state: { searchPageOptions, filterExpansion },\n-    });\n+    // Don't manipulate the history for the initial search if the search\n+    // option is the default one.", "originalCommit": "71cc4ce767494e3fc2235d38fe27d59d05b40ef6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTQ4OTMwMw==", "url": "https://github.com/openequella/openEQUELLA/pull/2614#discussion_r545489303", "bodyText": "As discussed, probably want to rework to this rough idea - maybe need try/catch too.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                String basicUrl = info.getPublicBookmark().getHref();\n          \n          \n            \n            \n          \n          \n            \n                String queryString = ((InfoBookmark) info.getPublicBookmark()).getQuery();\n          \n          \n            \n                if (queryString.isEmpty()) {\n          \n          \n            \n                  basicUrl = basicUrl + \"?\";\n          \n          \n            \n                }\n          \n          \n            \n                from.forwardToUrl(basicUrl + \"&q=\" + query);\n          \n          \n            \n                URL basicUrl = new URL(info.getPublicBookmark().getHref());\n          \n          \n            \n                \n          \n          \n            \n                from.forwardToURL(\n          \n          \n            \n                  basicUrl.toString()\n          \n          \n            \n                  + (basicUrl.getQuery().isEmpty() ? \"?\" : \"&\")\n          \n          \n            \n                  + \"q=\" + query));", "author": "edalex-ian", "createdAt": "2020-12-18T00:14:08Z", "path": "Source/Plugins/Core/com.equella.core/src/com/tle/web/searching/section/SearchQuerySection.java", "diffHunk": "@@ -623,6 +623,22 @@ private void doBasicSearch(SectionInfo info, String query) {\n     searchResults.startSearch(info);\n   }\n \n+  public static void basicSearchForNewSearch(\n+      SectionInfo from, String query, boolean inSelectOrAdd) {\n+    // In selectOrAdd the endpoint is '/selectoradd/searching.do'.\n+    SectionInfo info =\n+        inSelectOrAdd\n+            ? from.createForward(SearchSelectable.NEW_FORWARD_PATH)\n+            : RootSearchSection.createForward(from);\n+    String basicUrl = info.getPublicBookmark().getHref();\n+\n+    String queryString = ((InfoBookmark) info.getPublicBookmark()).getQuery();\n+    if (queryString.isEmpty()) {\n+      basicUrl = basicUrl + \"?\";\n+    }\n+    from.forwardToUrl(basicUrl + \"&q=\" + query);", "originalCommit": "71cc4ce767494e3fc2235d38fe27d59d05b40ef6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTQ5MjUwNA==", "url": "https://github.com/openequella/openEQUELLA/pull/2614#discussion_r545492504", "bodyText": "Oops.... URL.getQuery() returns null if there is no query, so that should be basicUrl.getQuery() == null.", "author": "edalex-ian", "createdAt": "2020-12-18T00:23:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTQ4OTMwMw=="}], "type": "inlineReview"}, {"oid": "3bbe18b300292c0d1600f5ee7d583b583262d72b", "url": "https://github.com/openequella/openEQUELLA/commit/3bbe18b300292c0d1600f5ee7d583b583262d72b", "message": "Tidy up SearchPage comments.", "committedDate": "2020-12-18T00:46:37Z", "type": "commit"}, {"oid": "89cf9d94d0bc4332f0ce92f637dc4b448c488465", "url": "https://github.com/openequella/openEQUELLA/commit/89cf9d94d0bc4332f0ce92f637dc4b448c488465", "message": "Properly generate URL for endpoint '/selectoradd/searching.do'.", "committedDate": "2020-12-18T01:25:16Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTUxMzUwNg==", "url": "https://github.com/openequella/openEQUELLA/pull/2614#discussion_r545513506", "bodyText": "with the return, else is not needed\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  return;\n          \n          \n            \n                } else {\n          \n          \n            \n                  history.replace({\n          \n          \n            \n                    ...history.location,\n          \n          \n            \n                    state: { searchPageOptions, filterExpansion },\n          \n          \n            \n                  });\n          \n          \n            \n                }\n          \n          \n            \n                  return;\n          \n          \n            \n                }\n          \n          \n            \n                history.replace({\n          \n          \n            \n                  ...history.location,\n          \n          \n            \n                  state: { searchPageOptions, filterExpansion },\n          \n          \n            \n                });", "author": "ChristianMurphy", "createdAt": "2020-12-18T01:27:46Z", "path": "Source/Plugins/Core/com.equella.core/js/tsrc/search/SearchPage.tsx", "diffHunk": "@@ -197,10 +197,19 @@ const SearchPage = ({ updateTemplate }: TemplateUpdateProps) => {\n   }, [searchPageOptions]);\n \n   useEffect(() => {\n-    history.replace({\n-      ...history.location,\n-      state: { searchPageOptions, filterExpansion },\n-    });\n+    // If search page is open from a URL which has some query params, updating browser\n+    // history for the initial search will produce wrong search option for the second\n+    // render. This is because in the second render, we ignore the query param conversion\n+    // as the history data has higher priority. So the end result is wrong search options\n+    // are displayed in the page.\n+    if (isInitialSearch && searchPageOptions === defaultSearchPageOptions) {\n+      return;\n+    } else {\n+      history.replace({\n+        ...history.location,\n+        state: { searchPageOptions, filterExpansion },\n+      });\n+    }", "originalCommit": "89cf9d94d0bc4332f0ce92f637dc4b448c488465", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "afb39b65c3b4e2dd258c90f9542f6b4936afc101", "url": "https://github.com/openequella/openEQUELLA/commit/afb39b65c3b4e2dd258c90f9542f6b4936afc101", "message": "Remove unneeded else block for history update.\n\nCo-authored-by: Christian Murphy <christian.murphy.42@gmail.com>", "committedDate": "2020-12-18T02:08:13Z", "type": "commit"}]}