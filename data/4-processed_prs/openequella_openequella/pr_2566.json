{"pr_number": 2566, "pr_title": "Make sure that thumbnailing timeout kills both imagick and ghostscript", "pr_createdAt": "2020-11-29T22:14:00Z", "pr_url": "https://github.com/openequella/openEQUELLA/pull/2566", "timeline": [{"oid": "d417f1ba08745cec6f07d0ad85e20db588c6c403", "url": "https://github.com/openequella/openEQUELLA/commit/d417f1ba08745cec6f07d0ad85e20db588c6c403", "message": "Make sure that Timeout kills both imagick and ghostscript", "committedDate": "2020-11-29T22:11:30Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjMyNDY2MQ==", "url": "https://github.com/openequella/openEQUELLA/pull/2566#discussion_r532324661", "bodyText": "I gather this must be following an example, as there is no need for this setup here. It can just be a stand-alone static method like the others in this class. Probably with a signature like: public static void killLinuxProcessTree(int pid)", "author": "edalex-ian", "createdAt": "2020-11-30T03:06:44Z", "path": "Platform/Plugins/com.tle.platform.common/src/com/tle/common/util/ExecUtils.java", "diffHunk": "@@ -52,6 +55,71 @@\n     \"\", \".exe\", \".bat\"\n   }; //$NON-NLS-1$ //$NON-NLS-2$ //$NON-NLS-3$\n \n+  /**\n+   * Creates a process which will then kill a given process and it's child processes on Linux.\n+   * arg[0] should be the PID of the main process you want to terminate.\n+   */\n+  public static class LinuxKill {\n+    public static void main(String[] args) {", "originalCommit": "d417f1ba08745cec6f07d0ad85e20db588c6c403", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjMyNTIyMw==", "url": "https://github.com/openequella/openEQUELLA/pull/2566#discussion_r532325223", "bodyText": "Should you check first you're running on linux?", "author": "edalex-ian", "createdAt": "2020-11-30T03:09:25Z", "path": "Platform/Plugins/com.tle.platform.common/src/com/tle/common/util/ExecUtils.java", "diffHunk": "@@ -130,10 +198,12 @@ public static ExecResult execWithTimeLimit(\n           createProcess(cmdarray, additionalEnv, dir);\n       LOGGER.debug(\"Started timed process\");\n       final Process proc = cp.getFirst();\n+      String pid = Long.toString(getPidOfProcess(proc).orElse(0L));\n       final StreamReader stdOut = cp.getSecond();\n       final StreamReader stdErr = cp.getThird();\n       proc.waitFor(durationInSeconds, TimeUnit.SECONDS);\n       if (!stdErr.isFinished() || !stdOut.isFinished()) {\n+        LinuxKill.main(new String[] {pid});", "originalCommit": "d417f1ba08745cec6f07d0ad85e20db588c6c403", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjMyOTA2Nw==", "url": "https://github.com/openequella/openEQUELLA/pull/2566#discussion_r532329067", "bodyText": "Couple of things here.\n\nyou may wish to consider using CharStreams.copy(new InputStremReader(getChildPid.getInputStream(), childPid);; and\nWhat if you get multiple PIDs back? Are they find coming back with new lines and getting fed to the following exec?", "author": "edalex-ian", "createdAt": "2020-11-30T03:27:13Z", "path": "Platform/Plugins/com.tle.platform.common/src/com/tle/common/util/ExecUtils.java", "diffHunk": "@@ -52,6 +55,71 @@\n     \"\", \".exe\", \".bat\"\n   }; //$NON-NLS-1$ //$NON-NLS-2$ //$NON-NLS-3$\n \n+  /**\n+   * Creates a process which will then kill a given process and it's child processes on Linux.\n+   * arg[0] should be the PID of the main process you want to terminate.\n+   */\n+  public static class LinuxKill {\n+    public static void main(String[] args) {\n+      try {\n+        if (Integer.parseInt(args[0]) > 0) {\n+          // get child process PIDs as string\n+          Process getChildPid = Runtime.getRuntime().exec(\"pgrep -P \" + args[0]);\n+          getChildPid.waitFor();\n+          StringBuilder childPid = new StringBuilder();\n+          if (getChildPid.exitValue() == 0) {\n+            InputStream procIn = getChildPid.getInputStream();\n+            int c = 0;\n+            while ((c = procIn.read()) != -1) {\n+              childPid.append((char) c);\n+            }", "originalCommit": "d417f1ba08745cec6f07d0ad85e20db588c6c403", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjMyOTQzMg==", "url": "https://github.com/openequella/openEQUELLA/pull/2566#discussion_r532329432", "bodyText": "So if it returns non-zero, it won't throw an exception (I gather). So the catch block wont be triggered and nothing will be logged (or noted).", "author": "edalex-ian", "createdAt": "2020-11-30T03:28:53Z", "path": "Platform/Plugins/com.tle.platform.common/src/com/tle/common/util/ExecUtils.java", "diffHunk": "@@ -52,6 +55,71 @@\n     \"\", \".exe\", \".bat\"\n   }; //$NON-NLS-1$ //$NON-NLS-2$ //$NON-NLS-3$\n \n+  /**\n+   * Creates a process which will then kill a given process and it's child processes on Linux.\n+   * arg[0] should be the PID of the main process you want to terminate.\n+   */\n+  public static class LinuxKill {\n+    public static void main(String[] args) {\n+      try {\n+        if (Integer.parseInt(args[0]) > 0) {\n+          // get child process PIDs as string\n+          Process getChildPid = Runtime.getRuntime().exec(\"pgrep -P \" + args[0]);\n+          getChildPid.waitFor();\n+          StringBuilder childPid = new StringBuilder();\n+          if (getChildPid.exitValue() == 0) {\n+            InputStream procIn = getChildPid.getInputStream();\n+            int c = 0;\n+            while ((c = procIn.read()) != -1) {\n+              childPid.append((char) c);\n+            }\n+          }\n+\n+          // Kill child process(es)\n+          Process childKillProc = Runtime.getRuntime().exec(\"kill -9 \" + childPid);\n+          childKillProc.waitFor();\n+          if (childKillProc.exitValue() == 0) {\n+            LOGGER.debug(\"Child processes terminated: \" + childPid);\n+          }", "originalCommit": "d417f1ba08745cec6f07d0ad85e20db588c6c403", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjMzMDIyNQ==", "url": "https://github.com/openequella/openEQUELLA/pull/2566#discussion_r532330225", "bodyText": "Your comment is confusing me. Above you check to see that kill -9 returns zero. Then here you're saying it could return 1. Which is it?\nAlso, be good here to do the same as the above and check the result.\nAnd arguably this code is the same as the above and should be in it's own method, perhaps: static void int sendSigKill(int pid). Could encapsulate waiting and logging, but then ultimately still return the exit code.", "author": "edalex-ian", "createdAt": "2020-11-30T03:32:17Z", "path": "Platform/Plugins/com.tle.platform.common/src/com/tle/common/util/ExecUtils.java", "diffHunk": "@@ -52,6 +55,71 @@\n     \"\", \".exe\", \".bat\"\n   }; //$NON-NLS-1$ //$NON-NLS-2$ //$NON-NLS-3$\n \n+  /**\n+   * Creates a process which will then kill a given process and it's child processes on Linux.\n+   * arg[0] should be the PID of the main process you want to terminate.\n+   */\n+  public static class LinuxKill {\n+    public static void main(String[] args) {\n+      try {\n+        if (Integer.parseInt(args[0]) > 0) {\n+          // get child process PIDs as string\n+          Process getChildPid = Runtime.getRuntime().exec(\"pgrep -P \" + args[0]);\n+          getChildPid.waitFor();\n+          StringBuilder childPid = new StringBuilder();\n+          if (getChildPid.exitValue() == 0) {\n+            InputStream procIn = getChildPid.getInputStream();\n+            int c = 0;\n+            while ((c = procIn.read()) != -1) {\n+              childPid.append((char) c);\n+            }\n+          }\n+\n+          // Kill child process(es)\n+          Process childKillProc = Runtime.getRuntime().exec(\"kill -9 \" + childPid);\n+          childKillProc.waitFor();\n+          if (childKillProc.exitValue() == 0) {\n+            LOGGER.debug(\"Child processes terminated: \" + childPid);\n+          }\n+\n+          // kill process itself\n+          Process proc = Runtime.getRuntime().exec(\"kill -9 \" + args[0]);\n+          int exitVal = proc.waitFor();\n+          LOGGER.debug(\"Exit value: \" + exitVal); // often 1 under Ubuntu 12.10", "originalCommit": "d417f1ba08745cec6f07d0ad85e20db588c6c403", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzA1MjkzMA==", "url": "https://github.com/openequella/openEQUELLA/pull/2566#discussion_r533052930", "bodyText": "So that comment was left over from an example that I was editing to suit me. In my testing, it returns 0. But apparently it can return 1 according to the SO link, so I'm unsure.\nEither way I have refactored, and removed the comment.", "author": "SammyIsConfused", "createdAt": "2020-12-01T03:40:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjMzMDIyNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjMzMDU5Ng==", "url": "https://github.com/openequella/openEQUELLA/pull/2566#discussion_r532330596", "bodyText": "Be good to know why it failed. (Also, slight change in capitalisation.)\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    LOGGER.warn(\"Process Kill failed. Process may be left hanging\");\n          \n          \n            \n                    LOGGER.warn(\"Process kill failed. Process may be left hanging. \" + e.getMessage());", "author": "edalex-ian", "createdAt": "2020-11-30T03:33:59Z", "path": "Platform/Plugins/com.tle.platform.common/src/com/tle/common/util/ExecUtils.java", "diffHunk": "@@ -52,6 +55,71 @@\n     \"\", \".exe\", \".bat\"\n   }; //$NON-NLS-1$ //$NON-NLS-2$ //$NON-NLS-3$\n \n+  /**\n+   * Creates a process which will then kill a given process and it's child processes on Linux.\n+   * arg[0] should be the PID of the main process you want to terminate.\n+   */\n+  public static class LinuxKill {\n+    public static void main(String[] args) {\n+      try {\n+        if (Integer.parseInt(args[0]) > 0) {\n+          // get child process PIDs as string\n+          Process getChildPid = Runtime.getRuntime().exec(\"pgrep -P \" + args[0]);\n+          getChildPid.waitFor();\n+          StringBuilder childPid = new StringBuilder();\n+          if (getChildPid.exitValue() == 0) {\n+            InputStream procIn = getChildPid.getInputStream();\n+            int c = 0;\n+            while ((c = procIn.read()) != -1) {\n+              childPid.append((char) c);\n+            }\n+          }\n+\n+          // Kill child process(es)\n+          Process childKillProc = Runtime.getRuntime().exec(\"kill -9 \" + childPid);\n+          childKillProc.waitFor();\n+          if (childKillProc.exitValue() == 0) {\n+            LOGGER.debug(\"Child processes terminated: \" + childPid);\n+          }\n+\n+          // kill process itself\n+          Process proc = Runtime.getRuntime().exec(\"kill -9 \" + args[0]);\n+          int exitVal = proc.waitFor();\n+          LOGGER.debug(\"Exit value: \" + exitVal); // often 1 under Ubuntu 12.10\n+\n+          proc.destroy();\n+          childKillProc.destroy();\n+          getChildPid.destroy();\n+        }\n+      } catch (Exception e) {\n+        LOGGER.warn(\"Process Kill failed. Process may be left hanging\");", "originalCommit": "d417f1ba08745cec6f07d0ad85e20db588c6c403", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjMzMTMyMQ==", "url": "https://github.com/openequella/openEQUELLA/pull/2566#discussion_r532331321", "bodyText": "What exceptions get thrown here? Could be good to be more targetted, and to log what happened.", "author": "edalex-ian", "createdAt": "2020-11-30T03:37:11Z", "path": "Platform/Plugins/com.tle.platform.common/src/com/tle/common/util/ExecUtils.java", "diffHunk": "@@ -52,6 +55,71 @@\n     \"\", \".exe\", \".bat\"\n   }; //$NON-NLS-1$ //$NON-NLS-2$ //$NON-NLS-3$\n \n+  /**\n+   * Creates a process which will then kill a given process and it's child processes on Linux.\n+   * arg[0] should be the PID of the main process you want to terminate.\n+   */\n+  public static class LinuxKill {\n+    public static void main(String[] args) {\n+      try {\n+        if (Integer.parseInt(args[0]) > 0) {\n+          // get child process PIDs as string\n+          Process getChildPid = Runtime.getRuntime().exec(\"pgrep -P \" + args[0]);\n+          getChildPid.waitFor();\n+          StringBuilder childPid = new StringBuilder();\n+          if (getChildPid.exitValue() == 0) {\n+            InputStream procIn = getChildPid.getInputStream();\n+            int c = 0;\n+            while ((c = procIn.read()) != -1) {\n+              childPid.append((char) c);\n+            }\n+          }\n+\n+          // Kill child process(es)\n+          Process childKillProc = Runtime.getRuntime().exec(\"kill -9 \" + childPid);\n+          childKillProc.waitFor();\n+          if (childKillProc.exitValue() == 0) {\n+            LOGGER.debug(\"Child processes terminated: \" + childPid);\n+          }\n+\n+          // kill process itself\n+          Process proc = Runtime.getRuntime().exec(\"kill -9 \" + args[0]);\n+          int exitVal = proc.waitFor();\n+          LOGGER.debug(\"Exit value: \" + exitVal); // often 1 under Ubuntu 12.10\n+\n+          proc.destroy();\n+          childKillProc.destroy();\n+          getChildPid.destroy();\n+        }\n+      } catch (Exception e) {\n+        LOGGER.warn(\"Process Kill failed. Process may be left hanging\");\n+      }\n+    }\n+  }\n+\n+  /**\n+   * Gets the PID of a given process.\n+   *\n+   * @param p The Process of which to get the PID.\n+   * @return An Optional long. If not on Linux, or if the PID declared field is not available, the\n+   *     value will be empty.\n+   */\n+  public static synchronized Optional<Long> getPidOfProcess(Process p) {\n+    Optional<Long> pid = Optional.empty();\n+\n+    try {\n+      if (p.getClass().getName().equals(\"java.lang.UNIXProcess\")) {\n+        Field f = p.getClass().getDeclaredField(\"pid\");\n+        f.setAccessible(true);\n+        pid = Optional.of(f.getLong(p));\n+        f.setAccessible(false);\n+      }\n+    } catch (Exception e) {\n+      return pid;", "originalCommit": "d417f1ba08745cec6f07d0ad85e20db588c6c403", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjMzMTQxMw==", "url": "https://github.com/openequella/openEQUELLA/pull/2566#discussion_r532331413", "bodyText": "Seems awkward to have the two return statements right next to each other. Would a finally block perhaps be a better fit?", "author": "edalex-ian", "createdAt": "2020-11-30T03:37:41Z", "path": "Platform/Plugins/com.tle.platform.common/src/com/tle/common/util/ExecUtils.java", "diffHunk": "@@ -52,6 +55,71 @@\n     \"\", \".exe\", \".bat\"\n   }; //$NON-NLS-1$ //$NON-NLS-2$ //$NON-NLS-3$\n \n+  /**\n+   * Creates a process which will then kill a given process and it's child processes on Linux.\n+   * arg[0] should be the PID of the main process you want to terminate.\n+   */\n+  public static class LinuxKill {\n+    public static void main(String[] args) {\n+      try {\n+        if (Integer.parseInt(args[0]) > 0) {\n+          // get child process PIDs as string\n+          Process getChildPid = Runtime.getRuntime().exec(\"pgrep -P \" + args[0]);\n+          getChildPid.waitFor();\n+          StringBuilder childPid = new StringBuilder();\n+          if (getChildPid.exitValue() == 0) {\n+            InputStream procIn = getChildPid.getInputStream();\n+            int c = 0;\n+            while ((c = procIn.read()) != -1) {\n+              childPid.append((char) c);\n+            }\n+          }\n+\n+          // Kill child process(es)\n+          Process childKillProc = Runtime.getRuntime().exec(\"kill -9 \" + childPid);\n+          childKillProc.waitFor();\n+          if (childKillProc.exitValue() == 0) {\n+            LOGGER.debug(\"Child processes terminated: \" + childPid);\n+          }\n+\n+          // kill process itself\n+          Process proc = Runtime.getRuntime().exec(\"kill -9 \" + args[0]);\n+          int exitVal = proc.waitFor();\n+          LOGGER.debug(\"Exit value: \" + exitVal); // often 1 under Ubuntu 12.10\n+\n+          proc.destroy();\n+          childKillProc.destroy();\n+          getChildPid.destroy();\n+        }\n+      } catch (Exception e) {\n+        LOGGER.warn(\"Process Kill failed. Process may be left hanging\");\n+      }\n+    }\n+  }\n+\n+  /**\n+   * Gets the PID of a given process.\n+   *\n+   * @param p The Process of which to get the PID.\n+   * @return An Optional long. If not on Linux, or if the PID declared field is not available, the\n+   *     value will be empty.\n+   */\n+  public static synchronized Optional<Long> getPidOfProcess(Process p) {\n+    Optional<Long> pid = Optional.empty();\n+\n+    try {\n+      if (p.getClass().getName().equals(\"java.lang.UNIXProcess\")) {\n+        Field f = p.getClass().getDeclaredField(\"pid\");\n+        f.setAccessible(true);\n+        pid = Optional.of(f.getLong(p));\n+        f.setAccessible(false);\n+      }\n+    } catch (Exception e) {\n+      return pid;\n+    }\n+    return pid;", "originalCommit": "d417f1ba08745cec6f07d0ad85e20db588c6c403", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzAzNTIzNA==", "url": "https://github.com/openequella/openEQUELLA/pull/2566#discussion_r533035234", "bodyText": "I tried that, but apparently the inspector has a problem with having a return within a finally block.\n\n'return' inside 'finally' block\nInspection info: Reports return statements inside of finally blocks. While occasionally intended, such return statements may mask exceptions thrown, and tremendously complicate debugging.", "author": "SammyIsConfused", "createdAt": "2020-12-01T02:39:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjMzMTQxMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzA1Njg1OA==", "url": "https://github.com/openequella/openEQUELLA/pull/2566#discussion_r533056858", "bodyText": "I see it's now refactored to simply use the default return with pid. Much better.", "author": "edalex-ian", "createdAt": "2020-12-01T03:55:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjMzMTQxMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjMzMTYxNg==", "url": "https://github.com/openequella/openEQUELLA/pull/2566#discussion_r532331616", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n               * Gets the PID of a given process.\n          \n          \n            \n               * Gets the process ID (PID) of a given *nix process.", "author": "edalex-ian", "createdAt": "2020-11-30T03:38:48Z", "path": "Platform/Plugins/com.tle.platform.common/src/com/tle/common/util/ExecUtils.java", "diffHunk": "@@ -52,6 +55,71 @@\n     \"\", \".exe\", \".bat\"\n   }; //$NON-NLS-1$ //$NON-NLS-2$ //$NON-NLS-3$\n \n+  /**\n+   * Creates a process which will then kill a given process and it's child processes on Linux.\n+   * arg[0] should be the PID of the main process you want to terminate.\n+   */\n+  public static class LinuxKill {\n+    public static void main(String[] args) {\n+      try {\n+        if (Integer.parseInt(args[0]) > 0) {\n+          // get child process PIDs as string\n+          Process getChildPid = Runtime.getRuntime().exec(\"pgrep -P \" + args[0]);\n+          getChildPid.waitFor();\n+          StringBuilder childPid = new StringBuilder();\n+          if (getChildPid.exitValue() == 0) {\n+            InputStream procIn = getChildPid.getInputStream();\n+            int c = 0;\n+            while ((c = procIn.read()) != -1) {\n+              childPid.append((char) c);\n+            }\n+          }\n+\n+          // Kill child process(es)\n+          Process childKillProc = Runtime.getRuntime().exec(\"kill -9 \" + childPid);\n+          childKillProc.waitFor();\n+          if (childKillProc.exitValue() == 0) {\n+            LOGGER.debug(\"Child processes terminated: \" + childPid);\n+          }\n+\n+          // kill process itself\n+          Process proc = Runtime.getRuntime().exec(\"kill -9 \" + args[0]);\n+          int exitVal = proc.waitFor();\n+          LOGGER.debug(\"Exit value: \" + exitVal); // often 1 under Ubuntu 12.10\n+\n+          proc.destroy();\n+          childKillProc.destroy();\n+          getChildPid.destroy();\n+        }\n+      } catch (Exception e) {\n+        LOGGER.warn(\"Process Kill failed. Process may be left hanging\");\n+      }\n+    }\n+  }\n+\n+  /**\n+   * Gets the PID of a given process.", "originalCommit": "d417f1ba08745cec6f07d0ad85e20db588c6c403", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjMzMTc1MA==", "url": "https://github.com/openequella/openEQUELLA/pull/2566#discussion_r532331750", "bodyText": "What's the difference with say Windows? As those processes also have IDs, is it simply a case of a different name for the field?", "author": "edalex-ian", "createdAt": "2020-11-30T03:39:30Z", "path": "Platform/Plugins/com.tle.platform.common/src/com/tle/common/util/ExecUtils.java", "diffHunk": "@@ -52,6 +55,71 @@\n     \"\", \".exe\", \".bat\"\n   }; //$NON-NLS-1$ //$NON-NLS-2$ //$NON-NLS-3$\n \n+  /**\n+   * Creates a process which will then kill a given process and it's child processes on Linux.\n+   * arg[0] should be the PID of the main process you want to terminate.\n+   */\n+  public static class LinuxKill {\n+    public static void main(String[] args) {\n+      try {\n+        if (Integer.parseInt(args[0]) > 0) {\n+          // get child process PIDs as string\n+          Process getChildPid = Runtime.getRuntime().exec(\"pgrep -P \" + args[0]);\n+          getChildPid.waitFor();\n+          StringBuilder childPid = new StringBuilder();\n+          if (getChildPid.exitValue() == 0) {\n+            InputStream procIn = getChildPid.getInputStream();\n+            int c = 0;\n+            while ((c = procIn.read()) != -1) {\n+              childPid.append((char) c);\n+            }\n+          }\n+\n+          // Kill child process(es)\n+          Process childKillProc = Runtime.getRuntime().exec(\"kill -9 \" + childPid);\n+          childKillProc.waitFor();\n+          if (childKillProc.exitValue() == 0) {\n+            LOGGER.debug(\"Child processes terminated: \" + childPid);\n+          }\n+\n+          // kill process itself\n+          Process proc = Runtime.getRuntime().exec(\"kill -9 \" + args[0]);\n+          int exitVal = proc.waitFor();\n+          LOGGER.debug(\"Exit value: \" + exitVal); // often 1 under Ubuntu 12.10\n+\n+          proc.destroy();\n+          childKillProc.destroy();\n+          getChildPid.destroy();\n+        }\n+      } catch (Exception e) {\n+        LOGGER.warn(\"Process Kill failed. Process may be left hanging\");\n+      }\n+    }\n+  }\n+\n+  /**\n+   * Gets the PID of a given process.\n+   *\n+   * @param p The Process of which to get the PID.\n+   * @return An Optional long. If not on Linux, or if the PID declared field is not available, the\n+   *     value will be empty.\n+   */\n+  public static synchronized Optional<Long> getPidOfProcess(Process p) {\n+    Optional<Long> pid = Optional.empty();\n+\n+    try {\n+      if (p.getClass().getName().equals(\"java.lang.UNIXProcess\")) {\n+        Field f = p.getClass().getDeclaredField(\"pid\");", "originalCommit": "d417f1ba08745cec6f07d0ad85e20db588c6c403", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzAyNzI5OA==", "url": "https://github.com/openequella/openEQUELLA/pull/2566#discussion_r533027298", "bodyText": "No unfortunately, not with Java 8. With 9, you can just process.pid(); I've been looking into it, the ID is not a field in a Windows Process. Other solutions include:\n\nUsing JNA (com.sun.jna) https://stackoverflow.com/a/43426878 but that requires us to install new dependencies\nCalling tasklist (windows command to get all running process IDs) before starting the process and again after, and using the diff of the two to find the new PIDs (I don't like this idea, if another process just happened to start between the two checks that could be a false positive)\n\nOnce we have a Windows PID however, killing it and it's child processes is not too difficult with taskkill. But targeting the right process is where it gets tricky.\nAnother complication is that I have no dev environment for Windows (testing installers yes, but debugging a dev environment no).  So making it work for Windows would probably take too long (at least for 2020.2).", "author": "SammyIsConfused", "createdAt": "2020-12-01T02:13:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjMzMTc1MA=="}], "type": "inlineReview"}, {"oid": "5252221e279064e385826200b72fc4f6e2d1d8c9", "url": "https://github.com/openequella/openEQUELLA/commit/5252221e279064e385826200b72fc4f6e2d1d8c9", "message": "Use int for getPidOfProcess", "committedDate": "2020-12-01T01:26:28Z", "type": "commit"}, {"oid": "23bdc6f59fe4db89a72c71674f6e17029b43484f", "url": "https://github.com/openequella/openEQUELLA/commit/23bdc6f59fe4db89a72c71674f6e17029b43484f", "message": "Check platform before running kill function", "committedDate": "2020-12-01T01:27:09Z", "type": "commit"}, {"oid": "4ff980622c54182cdeac787bdf1706de002d3216", "url": "https://github.com/openequella/openEQUELLA/commit/4ff980622c54182cdeac787bdf1706de002d3216", "message": "Refactor LinuxKill into killLinuxProcessTree", "committedDate": "2020-12-01T01:27:54Z", "type": "commit"}, {"oid": "16da9dfd857cd8926b72131e6ba2c6603defad51", "url": "https://github.com/openequella/openEQUELLA/commit/16da9dfd857cd8926b72131e6ba2c6603defad51", "message": "Fix up whitespaces", "committedDate": "2020-12-01T02:28:12Z", "type": "commit"}, {"oid": "f7134e8424c3500b0cdc554d8afcaf8a1b384e7a", "url": "https://github.com/openequella/openEQUELLA/commit/f7134e8424c3500b0cdc554d8afcaf8a1b384e7a", "message": "Catch exceptions specifically", "committedDate": "2020-12-01T02:48:13Z", "type": "commit"}, {"oid": "5753354c4ce3676d36ce2efc1253b387ad48462e", "url": "https://github.com/openequella/openEQUELLA/commit/5753354c4ce3676d36ce2efc1253b387ad48462e", "message": "Update comment to be *nix specific\n\nCo-authored-by: edalex-ian <43919233+edalex-ian@users.noreply.github.com>", "committedDate": "2020-12-01T02:53:36Z", "type": "commit"}, {"oid": "d7b3b572e61c2f59c1c750bc526fe4d77cc6c653", "url": "https://github.com/openequella/openEQUELLA/commit/d7b3b572e61c2f59c1c750bc526fe4d77cc6c653", "message": "Capture and log output of finished processes", "committedDate": "2020-12-01T03:31:05Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzA1NzY0NQ==", "url": "https://github.com/openequella/openEQUELLA/pull/2566#discussion_r533057645", "bodyText": "Should that be:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  return childPid.toString().replaceAll(\"\\n\", \"\").split(\" \");\n          \n          \n            \n                  return childPid.toString().replaceAll(\"\\n\", \" \").split(\" \");", "author": "edalex-ian", "createdAt": "2020-12-01T03:57:57Z", "path": "Platform/Plugins/com.tle.platform.common/src/com/tle/common/util/ExecUtils.java", "diffHunk": "@@ -52,6 +54,104 @@\n     \"\", \".exe\", \".bat\"\n   }; //$NON-NLS-1$ //$NON-NLS-2$ //$NON-NLS-3$\n \n+  /**\n+   * For a given Process ID, kill any child processes and then kill the process. Works on Unix only,\n+   * as it leverages pgrep and kill commands.\n+   *\n+   * @param pid The Process for which to terminate including it's direct children.\n+   */\n+  public static void killLinuxProcessTree(int pid) {\n+    if (pid > 0) {\n+      // get child process PIDs as strings\n+      String[] children = getChildUnixProcessPids(pid);\n+      // Kill child process(es)\n+      for (String child : children) {\n+        sendSigKill(Integer.parseInt(child));\n+      }\n+      // kill process itself\n+      sendSigKill(pid);\n+    }\n+  }\n+\n+  /**\n+   * Runs pgrep -P for a given Process ID, to get a list of child processes as Process IDs.\n+   *\n+   * @param pid The parent process ID to check for child processes.\n+   * @return String[] An array of process IDs for the children of pid. Can be empty.\n+   */\n+  public static String[] getChildUnixProcessPids(int pid) {\n+    try {\n+      Process getChildPid = Runtime.getRuntime().exec(\"pgrep -P \" + pid);\n+      getChildPid.waitFor();\n+      StringBuilder childPid = new StringBuilder();\n+      if (getChildPid.exitValue() == 0) {\n+        CharStreams.copy(new InputStreamReader(getChildPid.getInputStream()), childPid);\n+      } else {\n+        StringBuilder errorOutput = new StringBuilder();\n+        CharStreams.copy(new InputStreamReader(getChildPid.getErrorStream()), errorOutput);\n+        LOGGER.debug(\"getChildPid function did not run properly.\\n\" + errorOutput);\n+      }\n+      getChildPid.destroy();\n+      return childPid.toString().replaceAll(\"\\n\", \"\").split(\" \");", "originalCommit": "d7b3b572e61c2f59c1c750bc526fe4d77cc6c653", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzA1ODQ3MQ==", "url": "https://github.com/openequella/openEQUELLA/pull/2566#discussion_r533058471", "bodyText": "Ah yup, you're right. I had assumed that it prints them all on one line space-separated and then ends with \\n. But testing it now I see that it has \\n after each one.", "author": "SammyIsConfused", "createdAt": "2020-12-01T04:01:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzA1NzY0NQ=="}], "type": "inlineReview"}, {"oid": "d010e0f40b672bae43756408420d8b234901acc1", "url": "https://github.com/openequella/openEQUELLA/commit/d010e0f40b672bae43756408420d8b234901acc1", "message": "Replace newlines with spaces\n\nCo-authored-by: edalex-ian <43919233+edalex-ian@users.noreply.github.com>", "committedDate": "2020-12-01T03:59:37Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzA1OTc3OQ==", "url": "https://github.com/openequella/openEQUELLA/pull/2566#discussion_r533059779", "bodyText": "Rather than silently doing nothing, how about invert this logic:\nif(pid < 1) {\n  throw new IllegalArgumentException(\"Process ID should be greater than 0\");\n}", "author": "edalex-ian", "createdAt": "2020-12-01T04:05:48Z", "path": "Platform/Plugins/com.tle.platform.common/src/com/tle/common/util/ExecUtils.java", "diffHunk": "@@ -52,6 +54,104 @@\n     \"\", \".exe\", \".bat\"\n   }; //$NON-NLS-1$ //$NON-NLS-2$ //$NON-NLS-3$\n \n+  /**\n+   * For a given Process ID, kill any child processes and then kill the process. Works on Unix only,\n+   * as it leverages pgrep and kill commands.\n+   *\n+   * @param pid The Process for which to terminate including it's direct children.\n+   */\n+  public static void killLinuxProcessTree(int pid) {\n+    if (pid > 0) {", "originalCommit": "d010e0f40b672bae43756408420d8b234901acc1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzA2MjA5Nw==", "url": "https://github.com/openequella/openEQUELLA/pull/2566#discussion_r533062097", "bodyText": "The way you're having to use this highlights a few issues with the below methods. Really, you'd expect the methods to support something like:\ngetChildUnixProcessPids(pid)\n  .ifPresent(pids ->\n    sendSigKill(pids));\nComments which follow have this in mind.", "author": "edalex-ian", "createdAt": "2020-12-01T04:15:32Z", "path": "Platform/Plugins/com.tle.platform.common/src/com/tle/common/util/ExecUtils.java", "diffHunk": "@@ -52,6 +54,104 @@\n     \"\", \".exe\", \".bat\"\n   }; //$NON-NLS-1$ //$NON-NLS-2$ //$NON-NLS-3$\n \n+  /**\n+   * For a given Process ID, kill any child processes and then kill the process. Works on Unix only,\n+   * as it leverages pgrep and kill commands.\n+   *\n+   * @param pid The Process for which to terminate including it's direct children.\n+   */\n+  public static void killLinuxProcessTree(int pid) {\n+    if (pid > 0) {\n+      // get child process PIDs as strings\n+      String[] children = getChildUnixProcessPids(pid);\n+      // Kill child process(es)\n+      for (String child : children) {\n+        sendSigKill(Integer.parseInt(child));\n+      }", "originalCommit": "d010e0f40b672bae43756408420d8b234901acc1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzA2MjMzNg==", "url": "https://github.com/openequella/openEQUELLA/pull/2566#discussion_r533062336", "bodyText": "If 'Can be empty' how about return an Optional? You'd then reap the benefits hoped for above, plus your method signature than flags this without the need for a comment.", "author": "edalex-ian", "createdAt": "2020-12-01T04:16:26Z", "path": "Platform/Plugins/com.tle.platform.common/src/com/tle/common/util/ExecUtils.java", "diffHunk": "@@ -52,6 +54,104 @@\n     \"\", \".exe\", \".bat\"\n   }; //$NON-NLS-1$ //$NON-NLS-2$ //$NON-NLS-3$\n \n+  /**\n+   * For a given Process ID, kill any child processes and then kill the process. Works on Unix only,\n+   * as it leverages pgrep and kill commands.\n+   *\n+   * @param pid The Process for which to terminate including it's direct children.\n+   */\n+  public static void killLinuxProcessTree(int pid) {\n+    if (pid > 0) {\n+      // get child process PIDs as strings\n+      String[] children = getChildUnixProcessPids(pid);\n+      // Kill child process(es)\n+      for (String child : children) {\n+        sendSigKill(Integer.parseInt(child));\n+      }\n+      // kill process itself\n+      sendSigKill(pid);\n+    }\n+  }\n+\n+  /**\n+   * Runs pgrep -P for a given Process ID, to get a list of child processes as Process IDs.\n+   *\n+   * @param pid The parent process ID to check for child processes.\n+   * @return String[] An array of process IDs for the children of pid. Can be empty.", "originalCommit": "d010e0f40b672bae43756408420d8b234901acc1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzA2OTM0NA==", "url": "https://github.com/openequella/openEQUELLA/pull/2566#discussion_r533069344", "bodyText": "It's expected that this method would return an array of numbers (PIDs) not strings. Keep in mind the above suggestion for an Optional it'd be good if you also streamed across the strings to transform them to Integers. Something like:\nArrays.stream(childPid...split(\" \"))\n  .stream()\n  .mapToInt(s -> Integer.parseInt(s))\n  .toArray();", "author": "edalex-ian", "createdAt": "2020-12-01T04:42:29Z", "path": "Platform/Plugins/com.tle.platform.common/src/com/tle/common/util/ExecUtils.java", "diffHunk": "@@ -52,6 +54,104 @@\n     \"\", \".exe\", \".bat\"\n   }; //$NON-NLS-1$ //$NON-NLS-2$ //$NON-NLS-3$\n \n+  /**\n+   * For a given Process ID, kill any child processes and then kill the process. Works on Unix only,\n+   * as it leverages pgrep and kill commands.\n+   *\n+   * @param pid The Process for which to terminate including it's direct children.\n+   */\n+  public static void killLinuxProcessTree(int pid) {\n+    if (pid > 0) {\n+      // get child process PIDs as strings\n+      String[] children = getChildUnixProcessPids(pid);\n+      // Kill child process(es)\n+      for (String child : children) {\n+        sendSigKill(Integer.parseInt(child));\n+      }\n+      // kill process itself\n+      sendSigKill(pid);\n+    }\n+  }\n+\n+  /**\n+   * Runs pgrep -P for a given Process ID, to get a list of child processes as Process IDs.\n+   *\n+   * @param pid The parent process ID to check for child processes.\n+   * @return String[] An array of process IDs for the children of pid. Can be empty.\n+   */\n+  public static String[] getChildUnixProcessPids(int pid) {\n+    try {\n+      Process getChildPid = Runtime.getRuntime().exec(\"pgrep -P \" + pid);\n+      getChildPid.waitFor();\n+      StringBuilder childPid = new StringBuilder();\n+      if (getChildPid.exitValue() == 0) {\n+        CharStreams.copy(new InputStreamReader(getChildPid.getInputStream()), childPid);\n+      } else {\n+        StringBuilder errorOutput = new StringBuilder();\n+        CharStreams.copy(new InputStreamReader(getChildPid.getErrorStream()), errorOutput);\n+        LOGGER.debug(\"getChildPid function did not run properly.\\n\" + errorOutput);\n+      }\n+      getChildPid.destroy();\n+      return childPid.toString().replaceAll(\"\\n\", \" \").split(\" \");", "originalCommit": "d010e0f40b672bae43756408420d8b234901acc1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzA3MDE3OA==", "url": "https://github.com/openequella/openEQUELLA/pull/2566#discussion_r533070178", "bodyText": "Seeing kill has a definition of:\nkill [options] <pid> [...]\n\nIt'd make sense to allow this to support a list of PIDs too:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              public static int sendSigKill(int pid) {\n          \n          \n            \n              public static int sendSigKill(int[] pid) {\n          \n      \n    \n    \n  \n\nThat also then supports your use case of killing potentially multiple PIDs. If you did also want to support the form of taking a single PID (which I'm not sure you have a use for here), then you could add an overload that does the transform simply to an array and chain to this method.", "author": "edalex-ian", "createdAt": "2020-12-01T04:45:44Z", "path": "Platform/Plugins/com.tle.platform.common/src/com/tle/common/util/ExecUtils.java", "diffHunk": "@@ -52,6 +54,104 @@\n     \"\", \".exe\", \".bat\"\n   }; //$NON-NLS-1$ //$NON-NLS-2$ //$NON-NLS-3$\n \n+  /**\n+   * For a given Process ID, kill any child processes and then kill the process. Works on Unix only,\n+   * as it leverages pgrep and kill commands.\n+   *\n+   * @param pid The Process for which to terminate including it's direct children.\n+   */\n+  public static void killLinuxProcessTree(int pid) {\n+    if (pid > 0) {\n+      // get child process PIDs as strings\n+      String[] children = getChildUnixProcessPids(pid);\n+      // Kill child process(es)\n+      for (String child : children) {\n+        sendSigKill(Integer.parseInt(child));\n+      }\n+      // kill process itself\n+      sendSigKill(pid);\n+    }\n+  }\n+\n+  /**\n+   * Runs pgrep -P for a given Process ID, to get a list of child processes as Process IDs.\n+   *\n+   * @param pid The parent process ID to check for child processes.\n+   * @return String[] An array of process IDs for the children of pid. Can be empty.\n+   */\n+  public static String[] getChildUnixProcessPids(int pid) {\n+    try {\n+      Process getChildPid = Runtime.getRuntime().exec(\"pgrep -P \" + pid);\n+      getChildPid.waitFor();\n+      StringBuilder childPid = new StringBuilder();\n+      if (getChildPid.exitValue() == 0) {\n+        CharStreams.copy(new InputStreamReader(getChildPid.getInputStream()), childPid);\n+      } else {\n+        StringBuilder errorOutput = new StringBuilder();\n+        CharStreams.copy(new InputStreamReader(getChildPid.getErrorStream()), errorOutput);\n+        LOGGER.debug(\"getChildPid function did not run properly.\\n\" + errorOutput);\n+      }\n+      getChildPid.destroy();\n+      return childPid.toString().replaceAll(\"\\n\", \" \").split(\" \");\n+    } catch (IOException | InterruptedException e) {\n+      LOGGER.error(\"Error getting child processes for: \" + pid, e);\n+    }\n+    return new String[] {};\n+  }\n+\n+  /**\n+   * Creates a process which then sends a SIGKILL signal to a given process.\n+   *\n+   * @param pid the Process ID of the process to kill.\n+   * @return the exitValue of the SIGKILL process (not the process being killed)\n+   */\n+  public static int sendSigKill(int pid) {", "originalCommit": "d010e0f40b672bae43756408420d8b234901acc1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzA3MDc1MA==", "url": "https://github.com/openequella/openEQUELLA/pull/2566#discussion_r533070750", "bodyText": "If you should get here, should you perhaps ensure that by adding a line to your above catch to throw or rethrow?", "author": "edalex-ian", "createdAt": "2020-12-01T04:48:06Z", "path": "Platform/Plugins/com.tle.platform.common/src/com/tle/common/util/ExecUtils.java", "diffHunk": "@@ -52,6 +54,104 @@\n     \"\", \".exe\", \".bat\"\n   }; //$NON-NLS-1$ //$NON-NLS-2$ //$NON-NLS-3$\n \n+  /**\n+   * For a given Process ID, kill any child processes and then kill the process. Works on Unix only,\n+   * as it leverages pgrep and kill commands.\n+   *\n+   * @param pid The Process for which to terminate including it's direct children.\n+   */\n+  public static void killLinuxProcessTree(int pid) {\n+    if (pid > 0) {\n+      // get child process PIDs as strings\n+      String[] children = getChildUnixProcessPids(pid);\n+      // Kill child process(es)\n+      for (String child : children) {\n+        sendSigKill(Integer.parseInt(child));\n+      }\n+      // kill process itself\n+      sendSigKill(pid);\n+    }\n+  }\n+\n+  /**\n+   * Runs pgrep -P for a given Process ID, to get a list of child processes as Process IDs.\n+   *\n+   * @param pid The parent process ID to check for child processes.\n+   * @return String[] An array of process IDs for the children of pid. Can be empty.\n+   */\n+  public static String[] getChildUnixProcessPids(int pid) {\n+    try {\n+      Process getChildPid = Runtime.getRuntime().exec(\"pgrep -P \" + pid);\n+      getChildPid.waitFor();\n+      StringBuilder childPid = new StringBuilder();\n+      if (getChildPid.exitValue() == 0) {\n+        CharStreams.copy(new InputStreamReader(getChildPid.getInputStream()), childPid);\n+      } else {\n+        StringBuilder errorOutput = new StringBuilder();\n+        CharStreams.copy(new InputStreamReader(getChildPid.getErrorStream()), errorOutput);\n+        LOGGER.debug(\"getChildPid function did not run properly.\\n\" + errorOutput);\n+      }\n+      getChildPid.destroy();\n+      return childPid.toString().replaceAll(\"\\n\", \" \").split(\" \");\n+    } catch (IOException | InterruptedException e) {\n+      LOGGER.error(\"Error getting child processes for: \" + pid, e);\n+    }\n+    return new String[] {};\n+  }\n+\n+  /**\n+   * Creates a process which then sends a SIGKILL signal to a given process.\n+   *\n+   * @param pid the Process ID of the process to kill.\n+   * @return the exitValue of the SIGKILL process (not the process being killed)\n+   */\n+  public static int sendSigKill(int pid) {\n+    try {\n+      Process sigKill = Runtime.getRuntime().exec(\"kill -9 \" + pid);\n+      sigKill.waitFor();\n+      int returnValue = sigKill.exitValue();\n+      if (sigKill.exitValue() == 0) {\n+        StringBuilder successOutput = new StringBuilder();\n+        CharStreams.copy(new InputStreamReader(sigKill.getInputStream()), successOutput);\n+        LOGGER.debug(\"Output of kill function: \" + successOutput);\n+      } else {\n+        StringBuilder errorOutput = new StringBuilder();\n+        CharStreams.copy(new InputStreamReader(sigKill.getErrorStream()), errorOutput);\n+        LOGGER.debug(\"kill function did not run properly.\\n\" + errorOutput);\n+      }\n+      sigKill.destroy();\n+      return returnValue;\n+    } catch (IOException | InterruptedException e) {\n+      LOGGER.error(\"killing process \" + pid + \" failed.\", e);\n+    }\n+    // shouldn't get here\n+    return -1;", "originalCommit": "d010e0f40b672bae43756408420d8b234901acc1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzA3MTUxMg==", "url": "https://github.com/openequella/openEQUELLA/pull/2566#discussion_r533071512", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                          \"Platform not yet supported for process tree kill. Processes may be left hanging\");\n          \n          \n            \n                          \"Platform (\" + platform + \") does not supported process tree kill. Processes may be left hanging.\");", "author": "edalex-ian", "createdAt": "2020-12-01T04:50:48Z", "path": "Platform/Plugins/com.tle.platform.common/src/com/tle/common/util/ExecUtils.java", "diffHunk": "@@ -130,10 +230,18 @@ public static ExecResult execWithTimeLimit(\n           createProcess(cmdarray, additionalEnv, dir);\n       LOGGER.debug(\"Started timed process\");\n       final Process proc = cp.getFirst();\n+      int pid = getPidOfProcess(proc).orElse(0);\n       final StreamReader stdOut = cp.getSecond();\n       final StreamReader stdErr = cp.getThird();\n       proc.waitFor(durationInSeconds, TimeUnit.SECONDS);\n       if (!stdErr.isFinished() || !stdOut.isFinished()) {\n+        String platform = determinePlatform();\n+        if (platform.equals(PLATFORM_LINUX) || platform.equals(PLATFORM_LINUX64)) {\n+          killLinuxProcessTree(pid);\n+        } else {\n+          LOGGER.debug(\n+              \"Platform not yet supported for process tree kill. Processes may be left hanging\");", "originalCommit": "d010e0f40b672bae43756408420d8b234901acc1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "5515a7e7162c58dc3ee69e7531008c08c15c8f6b", "url": "https://github.com/openequella/openEQUELLA/commit/5515a7e7162c58dc3ee69e7531008c08c15c8f6b", "message": "Handle pid of zero or less with IllegalArgumentException", "committedDate": "2020-12-01T05:08:06Z", "type": "commit"}, {"oid": "3cf0e4ddd0ee21e548cf0fa5fbacda0bb411c2b0", "url": "https://github.com/openequella/openEQUELLA/commit/3cf0e4ddd0ee21e548cf0fa5fbacda0bb411c2b0", "message": "Refactor to kill all child processes at once and then the parent", "committedDate": "2020-12-01T06:59:31Z", "type": "commit"}, {"oid": "efac1afbffd16498168aba0f9a001a0d5df6df43", "url": "https://github.com/openequella/openEQUELLA/commit/efac1afbffd16498168aba0f9a001a0d5df6df43", "message": "Reword comment to include platform", "committedDate": "2020-12-01T07:03:58Z", "type": "commit"}, {"oid": "35b24f0c978119b611aada781809e0e5cb26807c", "url": "https://github.com/openequella/openEQUELLA/commit/35b24f0c978119b611aada781809e0e5cb26807c", "message": "Rethrow exceptions from sendSigKill", "committedDate": "2020-12-01T07:07:37Z", "type": "commit"}, {"oid": "589b0c7e23e1cd7e61940f28cb460122dac51584", "url": "https://github.com/openequella/openEQUELLA/commit/589b0c7e23e1cd7e61940f28cb460122dac51584", "message": "Merge branch 'develop' into bugfix/ensure_gs_gets_terminated", "committedDate": "2020-12-01T07:11:39Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzc4NzYyMw==", "url": "https://github.com/openequella/openEQUELLA/pull/2566#discussion_r533787623", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n               * @return Optional<String[]> An array of process IDs for the children of pid.\n          \n          \n            \n               * @return Process IDs for the children of {@code pid}.", "author": "edalex-ian", "createdAt": "2020-12-01T23:18:27Z", "path": "Platform/Plugins/com.tle.platform.common/src/com/tle/common/util/ExecUtils.java", "diffHunk": "@@ -52,6 +54,125 @@\n     \"\", \".exe\", \".bat\"\n   }; //$NON-NLS-1$ //$NON-NLS-2$ //$NON-NLS-3$\n \n+  /**\n+   * For a given Process ID, kill any child processes and then kill the process. Works on Unix only,\n+   * as it leverages pgrep and kill commands.\n+   *\n+   * @param pid The Process for which to terminate including it's direct children.\n+   */\n+  public static void killLinuxProcessTree(int pid) {\n+    if (pid < 1) {\n+      throw new IllegalArgumentException(\"Process ID should be greater than 0\");\n+    }\n+    // get child process PIDs and kill them\n+    getChildUnixProcessPids(pid).ifPresent(ExecUtils::sendSigKill);\n+\n+    // kill process itself, after all the child processes have been terminated\n+    sendSigKill(pid);\n+  }\n+\n+  /**\n+   * Runs pgrep -P for a given Process ID, to get a list of child processes as Process IDs.\n+   *\n+   * @param pid The parent process ID to check for child processes.\n+   * @return Optional<String[]> An array of process IDs for the children of pid.", "originalCommit": "589b0c7e23e1cd7e61940f28cb460122dac51584", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzc5MDI4OQ==", "url": "https://github.com/openequella/openEQUELLA/pull/2566#discussion_r533790289", "bodyText": "Being an error level log message, would be good if it was a more useful error message for an administrator.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  LOGGER.error(\"Output of getChildPids command not parsable as integers\", e);\n          \n          \n            \n                  LOGGER.error(\"Unsupported output from 'pgrep -P'. Unable to terminate child processes.\");\n          \n          \n            \n                  LOGGER.error(\"'pgrep' output: \" + childPid.toString());\n          \n          \n            \n                  LOGGER.error(\"Parsing exception.\", e);", "author": "edalex-ian", "createdAt": "2020-12-01T23:24:50Z", "path": "Platform/Plugins/com.tle.platform.common/src/com/tle/common/util/ExecUtils.java", "diffHunk": "@@ -52,6 +54,125 @@\n     \"\", \".exe\", \".bat\"\n   }; //$NON-NLS-1$ //$NON-NLS-2$ //$NON-NLS-3$\n \n+  /**\n+   * For a given Process ID, kill any child processes and then kill the process. Works on Unix only,\n+   * as it leverages pgrep and kill commands.\n+   *\n+   * @param pid The Process for which to terminate including it's direct children.\n+   */\n+  public static void killLinuxProcessTree(int pid) {\n+    if (pid < 1) {\n+      throw new IllegalArgumentException(\"Process ID should be greater than 0\");\n+    }\n+    // get child process PIDs and kill them\n+    getChildUnixProcessPids(pid).ifPresent(ExecUtils::sendSigKill);\n+\n+    // kill process itself, after all the child processes have been terminated\n+    sendSigKill(pid);\n+  }\n+\n+  /**\n+   * Runs pgrep -P for a given Process ID, to get a list of child processes as Process IDs.\n+   *\n+   * @param pid The parent process ID to check for child processes.\n+   * @return Optional<String[]> An array of process IDs for the children of pid.\n+   */\n+  public static Optional<int[]> getChildUnixProcessPids(int pid) {\n+    Optional<int[]> pids = Optional.empty();\n+    try {\n+      Process getChildPid = Runtime.getRuntime().exec(\"pgrep -P \" + pid);\n+      getChildPid.waitFor();\n+      StringBuilder childPid = new StringBuilder();\n+      if (getChildPid.exitValue() == 0) {\n+        CharStreams.copy(new InputStreamReader(getChildPid.getInputStream()), childPid);\n+      } else {\n+        StringBuilder errorOutput = new StringBuilder();\n+        CharStreams.copy(new InputStreamReader(getChildPid.getErrorStream()), errorOutput);\n+        LOGGER.debug(\"getChildPid function did not run properly.\\n\" + errorOutput);\n+      }\n+      getChildPid.destroy();\n+      // convert string to array of ints\n+      pids =\n+          Optional.of(\n+              Arrays.stream(childPid.toString().replaceAll(\"\\n\", \" \").split(\" \"))\n+                  .mapToInt(Integer::parseInt)\n+                  .toArray());\n+    } catch (IOException | InterruptedException e) {\n+      LOGGER.error(\"Error getting child processes for: \" + pid, e);\n+    } catch (NumberFormatException e) {\n+      LOGGER.error(\"Output of getChildPids command not parsable as integers\", e);", "originalCommit": "589b0c7e23e1cd7e61940f28cb460122dac51584", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzc5MTUyNw==", "url": "https://github.com/openequella/openEQUELLA/pull/2566#discussion_r533791527", "bodyText": "Be useful for administrators to know when this kind of thing is not functioning correctly.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    LOGGER.debug(\"kill function did not run properly.\\n\" + errorOutput);\n          \n          \n            \n                    LOGGER.warn(\"Attempt to terminate processes failed (\" + command + \"):\\n\" + errorOutput);", "author": "edalex-ian", "createdAt": "2020-12-01T23:28:15Z", "path": "Platform/Plugins/com.tle.platform.common/src/com/tle/common/util/ExecUtils.java", "diffHunk": "@@ -52,6 +54,125 @@\n     \"\", \".exe\", \".bat\"\n   }; //$NON-NLS-1$ //$NON-NLS-2$ //$NON-NLS-3$\n \n+  /**\n+   * For a given Process ID, kill any child processes and then kill the process. Works on Unix only,\n+   * as it leverages pgrep and kill commands.\n+   *\n+   * @param pid The Process for which to terminate including it's direct children.\n+   */\n+  public static void killLinuxProcessTree(int pid) {\n+    if (pid < 1) {\n+      throw new IllegalArgumentException(\"Process ID should be greater than 0\");\n+    }\n+    // get child process PIDs and kill them\n+    getChildUnixProcessPids(pid).ifPresent(ExecUtils::sendSigKill);\n+\n+    // kill process itself, after all the child processes have been terminated\n+    sendSigKill(pid);\n+  }\n+\n+  /**\n+   * Runs pgrep -P for a given Process ID, to get a list of child processes as Process IDs.\n+   *\n+   * @param pid The parent process ID to check for child processes.\n+   * @return Optional<String[]> An array of process IDs for the children of pid.\n+   */\n+  public static Optional<int[]> getChildUnixProcessPids(int pid) {\n+    Optional<int[]> pids = Optional.empty();\n+    try {\n+      Process getChildPid = Runtime.getRuntime().exec(\"pgrep -P \" + pid);\n+      getChildPid.waitFor();\n+      StringBuilder childPid = new StringBuilder();\n+      if (getChildPid.exitValue() == 0) {\n+        CharStreams.copy(new InputStreamReader(getChildPid.getInputStream()), childPid);\n+      } else {\n+        StringBuilder errorOutput = new StringBuilder();\n+        CharStreams.copy(new InputStreamReader(getChildPid.getErrorStream()), errorOutput);\n+        LOGGER.debug(\"getChildPid function did not run properly.\\n\" + errorOutput);\n+      }\n+      getChildPid.destroy();\n+      // convert string to array of ints\n+      pids =\n+          Optional.of(\n+              Arrays.stream(childPid.toString().replaceAll(\"\\n\", \" \").split(\" \"))\n+                  .mapToInt(Integer::parseInt)\n+                  .toArray());\n+    } catch (IOException | InterruptedException e) {\n+      LOGGER.error(\"Error getting child processes for: \" + pid, e);\n+    } catch (NumberFormatException e) {\n+      LOGGER.error(\"Output of getChildPids command not parsable as integers\", e);\n+    }\n+    return pids;\n+  }\n+\n+  /**\n+   * Creates a process which then sends a SIGKILL signal to an array of given processes.\n+   *\n+   * @param pids the Process IDs of the processes to kill.\n+   * @return the exitValue of the SIGKILL process (not the process being killed)\n+   */\n+  public static int sendSigKill(int[] pids) {\n+    try {\n+      StringBuilder command = new StringBuilder(\"kill -9 \");\n+      for (int pid : pids) {\n+        command.append(pid).append(\" \");\n+      }\n+      LOGGER.debug(\"Running command: \" + command);\n+      Process sigKill = Runtime.getRuntime().exec(String.valueOf(command));\n+      sigKill.waitFor();\n+      int returnValue = sigKill.exitValue();\n+      if (sigKill.exitValue() == 0) {\n+        StringBuilder successOutput = new StringBuilder();\n+        CharStreams.copy(new InputStreamReader(sigKill.getInputStream()), successOutput);\n+        LOGGER.debug(\"Output of kill function: \" + successOutput);\n+      } else {\n+        StringBuilder errorOutput = new StringBuilder();\n+        CharStreams.copy(new InputStreamReader(sigKill.getErrorStream()), errorOutput);\n+        LOGGER.debug(\"kill function did not run properly.\\n\" + errorOutput);", "originalCommit": "589b0c7e23e1cd7e61940f28cb460122dac51584", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "4041db62d21980241a1031af895af73908a98ff9", "url": "https://github.com/openequella/openEQUELLA/commit/4041db62d21980241a1031af895af73908a98ff9", "message": "Reword error messages\n\nCo-authored-by: edalex-ian <43919233+edalex-ian@users.noreply.github.com>", "committedDate": "2020-12-01T23:42:23Z", "type": "commit"}, {"oid": "c85cad2e14716269605644551c140b1432d2f5c1", "url": "https://github.com/openequella/openEQUELLA/commit/c85cad2e14716269605644551c140b1432d2f5c1", "message": "Make sure childPid is accessible from error block", "committedDate": "2020-12-01T23:53:05Z", "type": "commit"}]}