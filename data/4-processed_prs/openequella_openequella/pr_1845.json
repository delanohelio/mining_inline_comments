{"pr_number": 1845, "pr_title": "feat(typings): strengthen type checks for axios instance", "pr_createdAt": "2020-06-17T13:45:19Z", "pr_url": "https://github.com/openequella/openEQUELLA/pull/1845", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTg4NDUwOQ==", "url": "https://github.com/openequella/openEQUELLA/pull/1845#discussion_r441884509", "bodyText": "Thanks @ChristianMurphy . So if I just want to search with a transformer, my intuition is I should do\nGET('path..', ()=>transform()) . However, the type of the second parameter is (data: unknown) => data is T which does not match the transformer passed in. And likewise, if I don't need a queryparam, I would doGET('path..', ()=>validate(), ()=>transform()) , but the third parameter is expected to be object.\nI found some people just simply use any as parameters types, or use union types. Is that what we also need to do ?\nTypescript's function overloading seems quite different with other languages that I can read. So please correct me if I am very wrong.", "author": "PenghaiZhang", "createdAt": "2020-06-17T23:19:31Z", "path": "oeq-ts-rest-api/src/AxiosInstance.ts", "diffHunk": "@@ -13,27 +13,45 @@ const catchHandler = (error: AxiosError | Error): never => {\n   throw repackageError(error);\n };\n \n-export const GET = <T>(\n+/**\n+ * Executes a HTTP GET for a given path.\n+ *\n+ * @param path The URL path for the target GET\n+ * @param validator A function to perform runtime type checking against the result - typically with typescript-is\n+ * @param queryParams The query parameters to send with the GET request\n+ * @param transformer A function which returns a copy of the raw data from the GET with any required values transformed - this should NOT mutate the input data (transforms should start on a copy/clone of the input)\n+ */\n+export function GET<T>(path: string): Promise<unknown>;\n+export function GET<T>(\n   path: string,\n-  validator?: (data: unknown) => boolean,\n+  validator: (data: unknown) => data is T,", "originalCommit": "28ad64e2de3a339245d8ce0153ce91b5c374ad1f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTk1MzM2OQ==", "url": "https://github.com/openequella/openEQUELLA/pull/1845#discussion_r441953369", "bodyText": "GET('path..', ()=>transform())\nGET('path..', ()=>validate(), ()=>transform())\n\nWe could support these with lots of overloads.\nI'm not sure this is the way we should approach it though.\nSee #1845 (comment) for alternatives.\n\nany\n\nany tells the compiler to skip type checking, while it is an option, it kinda defeats the purpose of using a typed language \ud83d\ude05", "author": "ChristianMurphy", "createdAt": "2020-06-18T03:52:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTg4NDUwOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTg4NTU3NQ==", "url": "https://github.com/openequella/openEQUELLA/pull/1845#discussion_r441885575", "bodyText": "Do we need a generic type if we just return unknown ?", "author": "PenghaiZhang", "createdAt": "2020-06-17T23:23:02Z", "path": "oeq-ts-rest-api/src/AxiosInstance.ts", "diffHunk": "@@ -13,27 +13,45 @@ const catchHandler = (error: AxiosError | Error): never => {\n   throw repackageError(error);\n };\n \n-export const GET = <T>(\n+/**\n+ * Executes a HTTP GET for a given path.\n+ *\n+ * @param path The URL path for the target GET\n+ * @param validator A function to perform runtime type checking against the result - typically with typescript-is\n+ * @param queryParams The query parameters to send with the GET request\n+ * @param transformer A function which returns a copy of the raw data from the GET with any required values transformed - this should NOT mutate the input data (transforms should start on a copy/clone of the input)\n+ */\n+export function GET<T>(path: string): Promise<unknown>;", "originalCommit": "28ad64e2de3a339245d8ce0153ce91b5c374ad1f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTk0NzQzOA==", "url": "https://github.com/openequella/openEQUELLA/pull/1845#discussion_r441947438", "bodyText": "It isn't needed, and may be updated in one of several ways based off the outcome of #1845 (comment)", "author": "ChristianMurphy", "createdAt": "2020-06-18T03:26:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTg4NTU3NQ=="}], "type": "inlineReview"}, {"oid": "f4747ff641d6cb52611d4d6a75cf9c430f48c42b", "url": "https://github.com/openequella/openEQUELLA/commit/f4747ff641d6cb52611d4d6a75cf9c430f48c42b", "message": "feat(typings): strengthen type checks for axios instance", "committedDate": "2020-06-18T04:51:19Z", "type": "forcePushed"}, {"oid": "f23953d973897bd33211afaa6fa5bb7c777f5dc9", "url": "https://github.com/openequella/openEQUELLA/commit/f23953d973897bd33211afaa6fa5bb7c777f5dc9", "message": "feat(typings): strengthen type checks for axios instance", "committedDate": "2020-06-18T04:54:41Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTk2Nzk5Mw==", "url": "https://github.com/openequella/openEQUELLA/pull/1845#discussion_r441967993", "bodyText": "this shifts the transform to after the GET", "author": "ChristianMurphy", "createdAt": "2020-06-18T04:56:05Z", "path": "oeq-ts-rest-api/src/Search.ts", "diffHunk": "@@ -193,11 +193,19 @@ const SEARCH2_API_PATH = '/search2';\n  * @param apiBasePath Base URI to the oEQ institution and API.\n  * @param params Query parameters as search criteria.\n  */\n-export const search = (apiBasePath: string, params?: SearchParams): Promise<Common.PagedResult<SearchResultItem>> => {\n+export const search = (\n+  apiBasePath: string,\n+  params?: SearchParams\n+): Promise<Common.PagedResult<SearchResultItem>> => {\n   return GET<Common.PagedResult<SearchResultItem>>(\n     apiBasePath + SEARCH2_API_PATH,\n-    (data) => is<Common.PagedResult<SearchResultItem>>(data),\n-    params,\n-    (data) => Utils.convertDateFields<Common.PagedResult<SearchResultItem>>(data, [\"createdDate\", \"modifiedDate\"] )\n+    (data): data is Common.PagedResult<SearchResultItem> =>\n+      is<Common.PagedResult<SearchResultItem>>(data),\n+    params\n+  ).then((data) =>\n+    Utils.convertDateFields<Common.PagedResult<SearchResultItem>>(data, [\n+      'createdDate',\n+      'modifiedDate',\n+    ])", "originalCommit": "f23953d973897bd33211afaa6fa5bb7c777f5dc9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTk3NDgzMw==", "url": "https://github.com/openequella/openEQUELLA/pull/1845#discussion_r441974833", "bodyText": "Except the validator will fail as SearchResultItem contains the Date fields which come back from the get requests as simple strings.", "author": "edalex-ian", "createdAt": "2020-06-18T05:23:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTk2Nzk5Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjIzMjM3OA==", "url": "https://github.com/openequella/openEQUELLA/pull/1845#discussion_r442232378", "bodyText": "walked this change back, see #1845 (comment)", "author": "ChristianMurphy", "createdAt": "2020-06-18T13:38:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTk2Nzk5Mw=="}], "type": "inlineReview"}, {"oid": "bf9b1c08c5dfcc1ff5bc4e2fb1f4deb38055fe14", "url": "https://github.com/openequella/openEQUELLA/commit/bf9b1c08c5dfcc1ff5bc4e2fb1f4deb38055fe14", "message": "feat(typings): strengthen type checks for axios instance", "committedDate": "2020-06-18T13:13:12Z", "type": "commit"}, {"oid": "bf9b1c08c5dfcc1ff5bc4e2fb1f4deb38055fe14", "url": "https://github.com/openequella/openEQUELLA/commit/bf9b1c08c5dfcc1ff5bc4e2fb1f4deb38055fe14", "message": "feat(typings): strengthen type checks for axios instance", "committedDate": "2020-06-18T13:13:12Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjI4NzY5Mg==", "url": "https://github.com/openequella/openEQUELLA/pull/1845#discussion_r442287692", "bodyText": "refined the error a bit, it is specifically a TypeErrorhttps://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/TypeError\nAnd including the url/path in the message for easier tracing.", "author": "ChristianMurphy", "createdAt": "2020-06-18T14:51:50Z", "path": "oeq-ts-rest-api/src/AxiosInstance.ts", "diffHunk": "@@ -24,17 +24,21 @@ const catchHandler = (error: AxiosError | Error): never => {\n  */\n export const GET = <T>(\n   path: string,\n-  validator?: (data: unknown) => boolean,\n-  queryParams?: object,\n-  transformer?: (data: unknown) => T,\n+  validator: (data: unknown) => data is T,\n+  queryParams?: Parameters<typeof stringify>[0],\n+  transformer?: (data: unknown) => T\n ): Promise<T> =>\n   axios\n-    .get(path, {params: queryParams, paramsSerializer: params => stringify(params)}, )\n-    .then((response: AxiosResponse) => {\n-      const data: any = transformer? transformer(response.data) : response.data;\n-      if (validator && !validator(data)) {\n-        // If a validator is provided, but it fails to validate the provided data...\n-        throw new Error('Data format mismatch with data received from server.');\n+    .get(path, {\n+      params: queryParams,\n+      paramsSerializer: (params) => stringify(params),\n+    })\n+    .then(({ data: rawData }: AxiosResponse<unknown>) => {\n+      const data = transformer ? transformer(rawData) : rawData;\n+      if (!validator(data)) {\n+        throw new TypeError(\n+          `Data format mismatch with data received from server, on request to: \"${path}\"`\n+        );", "originalCommit": "bf9b1c08c5dfcc1ff5bc4e2fb1f4deb38055fe14", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjU2ODY4Ng==", "url": "https://github.com/openequella/openEQUELLA/pull/1845#discussion_r442568686", "bodyText": "I like this. \ud83d\udc4d", "author": "PenghaiZhang", "createdAt": "2020-06-19T00:24:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjI4NzY5Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjI4ODU1Nw==", "url": "https://github.com/openequella/openEQUELLA/pull/1845#discussion_r442288557", "bodyText": "Since this type is passed directly to query-string, updated this to extract the exact typing the library uses.", "author": "ChristianMurphy", "createdAt": "2020-06-18T14:52:53Z", "path": "oeq-ts-rest-api/src/AxiosInstance.ts", "diffHunk": "@@ -24,17 +24,21 @@ const catchHandler = (error: AxiosError | Error): never => {\n  */\n export const GET = <T>(\n   path: string,\n-  validator?: (data: unknown) => boolean,\n-  queryParams?: object,\n-  transformer?: (data: unknown) => T,\n+  validator: (data: unknown) => data is T,\n+  queryParams?: Parameters<typeof stringify>[0],", "originalCommit": "bf9b1c08c5dfcc1ff5bc4e2fb1f4deb38055fe14", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjU2ODM0Nw==", "url": "https://github.com/openequella/openEQUELLA/pull/1845#discussion_r442568347", "bodyText": "THanks Christian. Parameters<F> looks very handy to help extract types of parameters.", "author": "PenghaiZhang", "createdAt": "2020-06-19T00:22:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjI4ODU1Nw=="}], "type": "inlineReview"}]}