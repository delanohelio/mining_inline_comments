{"pr_number": 2491, "pr_title": "Add steps to ci.yaml to build and artefact storybook", "pr_createdAt": "2020-11-05T02:52:24Z", "pr_url": "https://github.com/openequella/openEQUELLA/pull/2491", "timeline": [{"oid": "37bb9cc6852c451ef4ede4d8e2a2e9a419b12341", "url": "https://github.com/openequella/openEQUELLA/commit/37bb9cc6852c451ef4ede4d8e2a2e9a419b12341", "message": "Add steps to ci.yaml to build and artefact storybook\n\nAlso add storybook-static to gitignore.", "committedDate": "2020-11-05T02:49:42Z", "type": "commit"}, {"oid": "402fd57e7cc1f566dae2a1ae894d47df4e3550f2", "url": "https://github.com/openequella/openEQUELLA/commit/402fd57e7cc1f566dae2a1ae894d47df4e3550f2", "message": "Fix whitespace in ci.yaml", "committedDate": "2020-11-05T03:09:04Z", "type": "commit"}, {"oid": "18a26df45ee7ab7af3c0b190d7dc93ee4aa46802", "url": "https://github.com/openequella/openEQUELLA/commit/18a26df45ee7ab7af3c0b190d7dc93ee4aa46802", "message": "Remove storybook-static folder after it has been used", "committedDate": "2020-11-05T03:59:33Z", "type": "commit"}, {"oid": "d13b043d81a7c77bbff89843343c07ec761d82bc", "url": "https://github.com/openequella/openEQUELLA/commit/d13b043d81a7c77bbff89843343c07ec761d82bc", "message": "Remove leading slash from rm call", "committedDate": "2020-11-05T04:33:08Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODM5NTE1MA==", "url": "https://github.com/openequella/openEQUELLA/pull/2491#discussion_r518395150", "bodyText": "This seems like something which we may want to add to the eslint ignore or prettier ignore.\nIt will likely be an issue if the static storybook pages are built locally, could be nice to fix it for both cases.", "author": "ChristianMurphy", "createdAt": "2020-11-05T21:59:24Z", "path": ".github/workflows/ci.yaml", "diffHunk": "@@ -78,6 +78,28 @@ jobs:\n         run: |\n           npm ci\n \n+      - name: Generate Static Storybook instance\n+        working-directory: Source/Plugins/Core/com.equella.core/js\n+        run: |\n+          npm run build-storybook\n+\n+      - name: Package Static Storybook instance\n+        run: |\n+          tar cvf storybook.tar --transform='s/.\\+\\///' \\\n+          Source/Plugins/Core/com.equella.core/js/storybook-static\n+\n+      - name: Remove Storybook Folder After Packaging\n+        # We need this step so that storybook isn't included in the checks\n+        working-directory: Source/Plugins/Core/com.equella.core/js\n+        run: |\n+          rm -R storybook-static", "originalCommit": "d13b043d81a7c77bbff89843343c07ec761d82bc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "683ae556be84133878675cf23a37b0fc52880d9c", "url": "https://github.com/openequella/openEQUELLA/commit/683ae556be84133878675cf23a37b0fc52880d9c", "message": "Do all storybook actions from js folder", "committedDate": "2020-11-09T00:43:29Z", "type": "commit"}, {"oid": "4a876980e5af187070511fad97b74c5554371997", "url": "https://github.com/openequella/openEQUELLA/commit/4a876980e5af187070511fad97b74c5554371997", "message": "Add storybook-static to eslint ignore and typescript compile", "committedDate": "2020-11-09T01:07:12Z", "type": "commit"}, {"oid": "2c3d1068cd9dacd9707094bff93bae8000f15aa1", "url": "https://github.com/openequella/openEQUELLA/commit/2c3d1068cd9dacd9707094bff93bae8000f15aa1", "message": "Add a .prettierignore", "committedDate": "2020-11-09T01:12:45Z", "type": "commit"}, {"oid": "dc720368c69a148e06c9562703bdd7bd11b57f71", "url": "https://github.com/openequella/openEQUELLA/commit/dc720368c69a148e06c9562703bdd7bd11b57f71", "message": "Remove working-directory from Save Storybook step\n\nApparently using an action and setting a working-directory are mutually exclusive. So instead just set the path in the with block.", "committedDate": "2020-11-09T01:25:48Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDE5ODcwNg==", "url": "https://github.com/openequella/openEQUELLA/pull/2491#discussion_r520198706", "bodyText": "does this still need to be removed?\nNow that it is ignored by the linting and formatting tools?", "author": "ChristianMurphy", "createdAt": "2020-11-10T00:01:24Z", "path": ".github/workflows/ci.yaml", "diffHunk": "@@ -78,6 +78,27 @@ jobs:\n         run: |\n           npm ci\n \n+      - name: Generate Static Storybook instance\n+        working-directory: Source/Plugins/Core/com.equella.core/js\n+        run: |\n+          npm run build-storybook\n+\n+      - name: Package Static Storybook instance\n+        working-directory: Source/Plugins/Core/com.equella.core/js\n+        run: |\n+          tar cvf storybook.tar storybook-static\n+\n+      - name: Remove Storybook Folder After Packaging\n+        working-directory: Source/Plugins/Core/com.equella.core/js\n+        run: |\n+          rm -R storybook-static", "originalCommit": "dc720368c69a148e06c9562703bdd7bd11b57f71", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDIzODM2NA==", "url": "https://github.com/openequella/openEQUELLA/pull/2491#discussion_r520238364", "bodyText": "Not necessarily, but it just makes sure that the storybook steps clean up after themselves.", "author": "SammyIsConfused", "createdAt": "2020-11-10T02:03:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDE5ODcwNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDI3MDY5Nw==", "url": "https://github.com/openequella/openEQUELLA/pull/2491#discussion_r520270697", "bodyText": "Removed the step in 6dbd054.", "author": "SammyIsConfused", "createdAt": "2020-11-10T03:56:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDE5ODcwNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDE5ODk2Mw==", "url": "https://github.com/openequella/openEQUELLA/pull/2491#discussion_r520198963", "bodyText": "could these be combined into a single step?", "author": "ChristianMurphy", "createdAt": "2020-11-10T00:02:11Z", "path": ".github/workflows/ci.yaml", "diffHunk": "@@ -78,6 +78,27 @@ jobs:\n         run: |\n           npm ci\n \n+      - name: Generate Static Storybook instance\n+        working-directory: Source/Plugins/Core/com.equella.core/js\n+        run: |\n+          npm run build-storybook\n+\n+      - name: Package Static Storybook instance\n+        working-directory: Source/Plugins/Core/com.equella.core/js\n+        run: |\n+          tar cvf storybook.tar storybook-static", "originalCommit": "dc720368c69a148e06c9562703bdd7bd11b57f71", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDIzODA2NA==", "url": "https://github.com/openequella/openEQUELLA/pull/2491#discussion_r520238064", "bodyText": "As I said to Penghai above, the other steps that involve building, tarring and uploading artefacts are split into steps. It was a deliberate choice to stay separate in order to be consistent with the rest of the yaml. It also helps with diagnosing build issues to split into steps, as at-a-glance it tells us exactly where the issue arose.", "author": "SammyIsConfused", "createdAt": "2020-11-10T02:02:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDE5ODk2Mw=="}], "type": "inlineReview"}, {"oid": "6dbd054f35e05436d05604162572d025a9a39f2f", "url": "https://github.com/openequella/openEQUELLA/commit/6dbd054f35e05436d05604162572d025a9a39f2f", "message": "Move storybook steps to their own job", "committedDate": "2020-11-10T03:47:20Z", "type": "commit"}, {"oid": "46735b7d57338c6c6e7fb9dfe07e5687be8c6847", "url": "https://github.com/openequella/openEQUELLA/commit/46735b7d57338c6c6e7fb9dfe07e5687be8c6847", "message": "Remove unnecessary SBT and Ivy caches", "committedDate": "2020-11-10T22:10:33Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTA0MzY4Nw==", "url": "https://github.com/openequella/openEQUELLA/pull/2491#discussion_r521043687", "bodyText": "Is that required? AFAICT, everything done below is JS / Node.", "author": "edalex-ian", "createdAt": "2020-11-11T02:40:09Z", "path": ".github/workflows/ci.yaml", "diffHunk": "@@ -110,6 +110,56 @@ jobs:\n           name: Artefacts\n           path: artefacts.tar\n \n+  build_storybook:\n+    runs-on: ubuntu-latest\n+    steps:\n+      # Using v1 (rather than v2) through-out this workflow due to issue:\n+      # https://github.com/actions/checkout/issues/237\n+      - uses: actions/checkout@v1\n+\n+      - name: NPM Cache\n+        uses: actions/cache@v2\n+        with:\n+          path: ~/.npm\n+          key: ${{ runner.os }}-npm-${{ hashFiles('**/package-lock.json') }}\n+          restore-keys: |\n+            ${{ runner.os }}-npm-\n+\n+      - name: Read .nvmrc\n+        run: echo ::set-output name=NVMRC::$(cat .nvmrc)\n+        id: nvm\n+\n+      - name: Setup node\n+        uses: actions/setup-node@v1\n+        with:\n+          node-version: \"${{ steps.nvm.outputs.NVMRC }}\"\n+\n+      - name: Set up JDK 1.8\n+        uses: actions/setup-java@v1\n+        with:\n+          java-version: 1.8", "originalCommit": "46735b7d57338c6c6e7fb9dfe07e5687be8c6847", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTA0NDg2MA==", "url": "https://github.com/openequella/openEQUELLA/pull/2491#discussion_r521044860", "bodyText": "This should sit down with the code it belongs to: Source/Plugins/Core/com.equella.core/js/.gitignore", "author": "edalex-ian", "createdAt": "2020-11-11T02:42:17Z", "path": ".gitignore", "diffHunk": "@@ -17,4 +17,4 @@ generated.keystore\n Source/Plugins/Kaltura\n server.xml\n node_modules/\n-\n+storybook-static/", "originalCommit": "46735b7d57338c6c6e7fb9dfe07e5687be8c6847", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTA0ODM5NQ==", "url": "https://github.com/openequella/openEQUELLA/pull/2491#discussion_r521048395", "bodyText": "It would be prudent to have it's own cache for this me thinks.\nbe good to replace -npm- on lines 124 and 126:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                      key: ${{ runner.os }}-npm-${{ hashFiles('**/package-lock.json') }}\n          \n          \n            \n                      restore-keys: |\n          \n          \n            \n                        ${{ runner.os }}-npm-\n          \n          \n            \n                      key: ${{ runner.os }}-npm.storybook-${{ hashFiles('**/package-lock.json') }}\n          \n          \n            \n                      restore-keys: |\n          \n          \n            \n                        ${{ runner.os }}-npm.storybook-", "author": "edalex-ian", "createdAt": "2020-11-11T02:47:42Z", "path": ".github/workflows/ci.yaml", "diffHunk": "@@ -110,6 +110,56 @@ jobs:\n           name: Artefacts\n           path: artefacts.tar\n \n+  build_storybook:\n+    runs-on: ubuntu-latest\n+    steps:\n+      # Using v1 (rather than v2) through-out this workflow due to issue:\n+      # https://github.com/actions/checkout/issues/237\n+      - uses: actions/checkout@v1\n+\n+      - name: NPM Cache\n+        uses: actions/cache@v2\n+        with:\n+          path: ~/.npm\n+          key: ${{ runner.os }}-npm-${{ hashFiles('**/package-lock.json') }}\n+          restore-keys: |\n+            ${{ runner.os }}-npm-", "originalCommit": "46735b7d57338c6c6e7fb9dfe07e5687be8c6847", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "6664a2ef502c29cb2f61295826d6d202965ea6bc", "url": "https://github.com/openequella/openEQUELLA/commit/6664a2ef502c29cb2f61295826d6d202965ea6bc", "message": "Don't set up JDK during storybook, set up own NPM cache", "committedDate": "2020-11-11T05:37:11Z", "type": "commit"}]}