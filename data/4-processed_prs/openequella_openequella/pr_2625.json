{"pr_number": 2625, "pr_title": "Refactor the logic of converting query params to SearchOptions.", "pr_createdAt": "2020-12-22T06:25:12Z", "pr_url": "https://github.com/openequella/openEQUELLA/pull/2625", "timeline": [{"oid": "dd628d879902e74d8dfa42ab7479d89d51874177", "url": "https://github.com/openequella/openEQUELLA/commit/dd628d879902e74d8dfa42ab7479d89d51874177", "message": "Refactor the logic of converting query params to\nSearchOptions.", "committedDate": "2020-12-22T06:13:47Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzA5MjM5OQ==", "url": "https://github.com/openequella/openEQUELLA/pull/2625#discussion_r547092399", "bodyText": "location.pathname.endsWith(\"searching.do\") can't guarantee the shared link is generated from old UI now due to the support of Quick Search.", "author": "PenghaiZhang", "createdAt": "2020-12-22T06:26:49Z", "path": "Source/Plugins/Core/com.equella.core/js/tsrc/modules/SearchModule.ts", "diffHunk": "@@ -247,18 +247,23 @@ export const generateCategoryWhereQuery = (\n export const queryStringParamsToSearchOptions = async (\n   location: Location\n ): Promise<SearchOptions | undefined> => {\n-  if (!location.search) return undefined;\n-  const params = new URLSearchParams(location.search);\n-\n-  // If no query strings is of type LegacySearchParams, return undefined.\n-  if (!Array.from(params.keys()).some((key) => LegacySearchParams.guard(key))) {\n+  if (!location.search) {\n     return undefined;\n   }\n-\n-  if (location.pathname.endsWith(\"searching.do\")) {", "originalCommit": "dd628d879902e74d8dfa42ab7479d89d51874177", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzA5OTA4Mw==", "url": "https://github.com/openequella/openEQUELLA/pull/2625#discussion_r547099083", "bodyText": "Seems rather verbose, would it be fine to have:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              const params = new URLSearchParams(location.search);\n          \n          \n            \n              const searchOptions = params.get(\"searchOptions\");\n          \n          \n            \n              const searchOptions = new URLSearchParams(location.search).get(\"searchOptions\");", "author": "edalex-ian", "createdAt": "2020-12-22T06:48:25Z", "path": "Source/Plugins/Core/com.equella.core/js/tsrc/modules/SearchModule.ts", "diffHunk": "@@ -247,18 +247,23 @@ export const generateCategoryWhereQuery = (\n export const queryStringParamsToSearchOptions = async (\n   location: Location\n ): Promise<SearchOptions | undefined> => {\n-  if (!location.search) return undefined;\n-  const params = new URLSearchParams(location.search);\n-\n-  // If no query strings is of type LegacySearchParams, return undefined.\n-  if (!Array.from(params.keys()).some((key) => LegacySearchParams.guard(key))) {\n+  if (!location.search) {\n     return undefined;\n   }\n-\n-  if (location.pathname.endsWith(\"searching.do\")) {\n+  const params = new URLSearchParams(location.search);\n+  const searchOptions = params.get(\"searchOptions\");", "originalCommit": "dd628d879902e74d8dfa42ab7479d89d51874177", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzU0NTAwMQ==", "url": "https://github.com/openequella/openEQUELLA/pull/2625#discussion_r547545001", "bodyText": "Both params  and  searchOptions are needed in the below if block.", "author": "PenghaiZhang", "createdAt": "2020-12-22T22:51:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzA5OTA4Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzYwNjQxNg==", "url": "https://github.com/openequella/openEQUELLA/pull/2625#discussion_r547606416", "bodyText": "Aaaah yes, of course. I should've read ahead before commenting. ;)", "author": "edalex-ian", "createdAt": "2020-12-23T02:34:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzA5OTA4Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzEwMDY5OA==", "url": "https://github.com/openequella/openEQUELLA/pull/2625#discussion_r547100698", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              // If SearchOptions is in query string, convert the string to a SearchOptions.\n          \n          \n            \n              // Or, if query string contains 'LegacySearchParams', convert the string\n          \n          \n            \n              // to a SearchOptions.\n          \n          \n            \n              // Otherwise, return undefined.\n          \n          \n            \n              // If the query params contain `searchOptions` convert to `SearchOptions` with `newSearchQueryToSearchOptions`.\n          \n          \n            \n              // Else if the query params contain params from legacy `searching.do` (i.e. `LegacySearchParams`) then convert to\n          \n          \n            \n              //   `searchOptions` with `legacyQueryStringToSearchOptions`\n          \n          \n            \n              // For all else, return `undefined`.", "author": "edalex-ian", "createdAt": "2020-12-22T06:53:47Z", "path": "Source/Plugins/Core/com.equella.core/js/tsrc/modules/SearchModule.ts", "diffHunk": "@@ -247,18 +247,23 @@ export const generateCategoryWhereQuery = (\n export const queryStringParamsToSearchOptions = async (\n   location: Location\n ): Promise<SearchOptions | undefined> => {\n-  if (!location.search) return undefined;\n-  const params = new URLSearchParams(location.search);\n-\n-  // If no query strings is of type LegacySearchParams, return undefined.\n-  if (!Array.from(params.keys()).some((key) => LegacySearchParams.guard(key))) {\n+  if (!location.search) {\n     return undefined;\n   }\n-\n-  if (location.pathname.endsWith(\"searching.do\")) {\n+  const params = new URLSearchParams(location.search);\n+  const searchOptions = params.get(\"searchOptions\");\n+  // If SearchOptions is in query string, convert the string to a SearchOptions.\n+  // Or, if query string contains 'LegacySearchParams', convert the string\n+  // to a SearchOptions.\n+  // Otherwise, return undefined.", "originalCommit": "dd628d879902e74d8dfa42ab7479d89d51874177", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "4a358ee192f6fd5eca618345cbfdd011c61a1a41", "url": "https://github.com/openequella/openEQUELLA/commit/4a358ee192f6fd5eca618345cbfdd011c61a1a41", "message": "Reword comment for 'queryStringParamsToSearchOptions'.", "committedDate": "2020-12-22T22:54:39Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTYxODMyMg==", "url": "https://github.com/openequella/openEQUELLA/pull/2625#discussion_r551618322", "bodyText": "what does undefined do in this case?", "author": "ChristianMurphy", "createdAt": "2021-01-04T22:58:43Z", "path": "Source/Plugins/Core/com.equella.core/js/tsrc/modules/SearchModule.ts", "diffHunk": "@@ -247,18 +247,24 @@ export const generateCategoryWhereQuery = (\n export const queryStringParamsToSearchOptions = async (\n   location: Location\n ): Promise<SearchOptions | undefined> => {\n-  if (!location.search) return undefined;\n-  const params = new URLSearchParams(location.search);\n-\n-  // If no query strings is of type LegacySearchParams, return undefined.\n-  if (!Array.from(params.keys()).some((key) => LegacySearchParams.guard(key))) {\n+  if (!location.search) {\n     return undefined;\n   }\n-\n-  if (location.pathname.endsWith(\"searching.do\")) {\n+  const params = new URLSearchParams(location.search);\n+  const searchOptions = params.get(\"searchOptions\");\n+\n+  // If the query params contain `searchOptions` convert to `SearchOptions` with `newSearchQueryToSearchOptions`.\n+  // Else if the query params contain params from legacy `searching.do` (i.e. `LegacySearchParams`) then convert to\n+  // `searchOptions` with `legacyQueryStringToSearchOptions`.\n+  // For all else, return `undefined`.\n+  if (searchOptions) {\n+    return await newSearchQueryToSearchOptions(searchOptions);\n+  } else if (\n+    Array.from(params.keys()).some((key) => LegacySearchParams.guard(key))\n+  ) {\n     return await legacyQueryStringToSearchOptions(params);\n   }\n-  return await newSearchQueryToSearchOptions(params.get(\"searchOptions\") ?? \"\");\n+  return undefined;", "originalCommit": "4a358ee192f6fd5eca618345cbfdd011c61a1a41", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTYyOTkzNw==", "url": "https://github.com/openequella/openEQUELLA/pull/2625#discussion_r551629937", "bodyText": "If this function returns undefined, it means new search page will use the default search options rather than the one stored in browser history or the one converted from URL query params.\nYou can see this logic in SearchPage.tsx line 168 to 181.", "author": "PenghaiZhang", "createdAt": "2021-01-04T23:31:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTYxODMyMg=="}], "type": "inlineReview"}, {"oid": "158762427bc774a462db36cbfd958dc5ae1ef348", "url": "https://github.com/openequella/openEQUELLA/commit/158762427bc774a462db36cbfd958dc5ae1ef348", "message": "Merge branch 'develop' into bugfix/new-search-ui-shared-link-not-working", "committedDate": "2021-01-04T23:14:37Z", "type": "commit"}]}