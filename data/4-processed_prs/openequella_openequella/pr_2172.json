{"pr_number": 2172, "pr_title": "Refine Search - StatusSelector", "pr_createdAt": "2020-08-12T05:17:26Z", "pr_url": "https://github.com/openequella/openEQUELLA/pull/2172", "timeline": [{"oid": "c706ad317941f1fb62a511eeaf8e2babac091371", "url": "https://github.com/openequella/openEQUELLA/commit/c706ad317941f1fb62a511eeaf8e2babac091371", "message": "front-end: Setup IntelliJ to sort imports by modules", "committedDate": "2020-08-12T01:15:01Z", "type": "commit"}, {"oid": "8b38cc902d00d8c2794a0bd7caacce103de4ec16", "url": "https://github.com/openequella/openEQUELLA/commit/8b38cc902d00d8c2794a0bd7caacce103de4ec16", "message": "front-end: Sort searchPage language string groups\n\nSo as to make maintenance and searching easier.", "committedDate": "2020-08-12T01:21:50Z", "type": "commit"}, {"oid": "e1b13432a64dbf7c6538e923966030713dc2a939", "url": "https://github.com/openequella/openEQUELLA/commit/e1b13432a64dbf7c6538e923966030713dc2a939", "message": "front-end: Add Status refine search control", "committedDate": "2020-08-12T01:25:54Z", "type": "commit"}, {"oid": "176eb0d327b7a4a8a7d0653ae2747e288ab5c9d5", "url": "https://github.com/openequella/openEQUELLA/commit/176eb0d327b7a4a8a7d0653ae2747e288ab5c9d5", "message": "front-end: Change OEQ.Common.ItemStatus to a string literal union\n\nIt seems the enum is TS has issues in Jest land. And although it seems like a great language feature, it's really rather half baked - it's not a full enum as you'd find in any modern language.\n\nSo it seems that's why you see the string literal unions used in other TS/JS libraries; and it made sense for us to follow.\n\nHowever there was still a need to be able to iterate over the values of the resulting type, so also brought in runtypes to support this.", "committedDate": "2020-08-12T01:25:56Z", "type": "commit"}, {"oid": "1f54ae22fdc1df46fdfc5b7ab023ae1e4b801bd7", "url": "https://github.com/openequella/openEQUELLA/commit/1f54ae22fdc1df46fdfc5b7ab023ae1e4b801bd7", "message": "front-end: Rework language strings for new StatusSelector", "committedDate": "2020-08-12T02:47:26Z", "type": "commit"}, {"oid": "08119d5d40d01f0b567219529ee4b76623e196a9", "url": "https://github.com/openequella/openEQUELLA/commit/08119d5d40d01f0b567219529ee4b76623e196a9", "message": "front-end: Add tests for StatusSelector\n\nOnly integration tests with SearchPage, as the component itself is rather simple, and should get full coverage from these tests.", "committedDate": "2020-08-12T02:49:29Z", "type": "commit"}, {"oid": "a829f3ae75f900592949910a033743009e358963", "url": "https://github.com/openequella/openEQUELLA/commit/a829f3ae75f900592949910a033743009e358963", "message": "front-end: Tidy up JSDoc and describe clause in SearchPage.test.tsx", "committedDate": "2020-08-12T04:59:24Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTAzMDAzNw==", "url": "https://github.com/openequella/openEQUELLA/pull/2172#discussion_r469030037", "bodyText": "We have mixed use of  toHaveBeenCalledWith and toHaveBeenLastCalledWith ? Is it something we want to unify ?\nAlso I noted a small difference. This function checks mockSearch whereas others check SearchModule.searchItems, but I think the result is the same.", "author": "PenghaiZhang", "createdAt": "2020-08-12T06:21:44Z", "path": "Source/Plugins/Core/com.equella.core/js/__tests__/tsrc/search/SearchPage.test.tsx", "diffHunk": "@@ -75,36 +81,112 @@ const defaultSearchPageOptions: SearchPageOptions = {\n };\n const defaultCollectionPrivileges = [\"SEARCH_COLLECTION\"];\n \n+/**\n+ * Simple helper to wrap the process of waiting for the execution of a search based on checking the\n+ * `searchPromise`. Being that it is abstracted out, in the future could change as needed to be\n+ * something other than the `searchPromise`.\n+ */\n+const waitForSearch = async () =>\n+  await act(async () => {\n+    await searchPromise;\n+  });\n+\n+/**\n+ * Helper function for the initial render of the `<SearchPage>` for tests below. Also includes\n+ * the wait for the initial search call.\n+ *\n+ * @returns The RenderResult from the `render` of the `<SearchPage>`\n+ */\n+const renderSearchPage = async (): Promise<RenderResult> => {\n+  window.history.replaceState({}, \"Clean history state\");\n+  const page = render(\n+    <BrowserRouter>\n+      <SearchPage updateTemplate={jest.fn()} />{\" \"}\n+    </BrowserRouter>\n+  );\n+  // Wait for the first completion of initial search\n+  await waitForSearch();\n+\n+  return page;\n+};\n+\n+/**\n+ * Helper function to find individual Refine Search components based on the their `idSuffix`.\n+ *\n+ * @param container The root container to start the search from\n+ * @param componentSuffix Typically the `idSuffix` provided in `SearchPage.tsx`\n+ */\n+const getRefineSearchComponent = (\n+  container: Element,\n+  componentSuffix: string\n+) => {\n+  const id = `#RefineSearchPanel-${componentSuffix}`;\n+  const e = container.querySelector(id);\n+  if (!e) {\n+    throw new Error(`Failed to find ${id}`);\n+  }\n+\n+  return e as HTMLElement;\n+};\n+\n+describe(\"Refine search by status\", () => {\n+  const {\n+    live: liveButtonLabel,\n+    all: allButtonLabel,\n+  } = languageStrings.searchpage.statusSelector;\n+\n+  const expectSearchItemsCalledWithStatus = (status: OEQ.Common.ItemStatus[]) =>\n+    expect(mockSearch).toHaveBeenCalledWith({", "originalCommit": "a829f3ae75f900592949910a033743009e358963", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTA1NDYxNg==", "url": "https://github.com/openequella/openEQUELLA/pull/2172#discussion_r469054616", "bodyText": "I guess it depends on context. Here I'm not concerned with whether it was first, last or otherwise. Just that it was called with that value at one point.\nI decided to go with the mockSearch here as we do have that variable capturing the situation, and indeed it provides us an abstraction - should the search function used by SearchPage change later. I think arguably we should use these constants in place of the explicit function reference when we've mocked them out. Maybe as part of the refactor we standardise on that. Thoughts?", "author": "edalex-ian", "createdAt": "2020-08-12T07:18:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTAzMDAzNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTEzODUxMw==", "url": "https://github.com/openequella/openEQUELLA/pull/2172#discussion_r469138513", "bodyText": "Actually, I am concerned here that it was the last one, as due to all the effects I can't be sure. Fixed. \ud83d\udc4d", "author": "edalex-ian", "createdAt": "2020-08-12T09:44:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTAzMDAzNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTAzMTYxNg==", "url": "https://github.com/openequella/openEQUELLA/pull/2172#discussion_r469031616", "bodyText": "According to the doco of render, it might be good to call cleanup here.", "author": "PenghaiZhang", "createdAt": "2020-08-12T06:25:53Z", "path": "Source/Plugins/Core/com.equella.core/js/__tests__/tsrc/search/SearchPage.test.tsx", "diffHunk": "@@ -75,36 +81,112 @@ const defaultSearchPageOptions: SearchPageOptions = {\n };\n const defaultCollectionPrivileges = [\"SEARCH_COLLECTION\"];\n \n+/**\n+ * Simple helper to wrap the process of waiting for the execution of a search based on checking the\n+ * `searchPromise`. Being that it is abstracted out, in the future could change as needed to be\n+ * something other than the `searchPromise`.\n+ */\n+const waitForSearch = async () =>\n+  await act(async () => {\n+    await searchPromise;\n+  });\n+\n+/**\n+ * Helper function for the initial render of the `<SearchPage>` for tests below. Also includes\n+ * the wait for the initial search call.\n+ *\n+ * @returns The RenderResult from the `render` of the `<SearchPage>`\n+ */\n+const renderSearchPage = async (): Promise<RenderResult> => {\n+  window.history.replaceState({}, \"Clean history state\");\n+  const page = render(\n+    <BrowserRouter>\n+      <SearchPage updateTemplate={jest.fn()} />{\" \"}\n+    </BrowserRouter>\n+  );\n+  // Wait for the first completion of initial search\n+  await waitForSearch();\n+\n+  return page;\n+};\n+\n+/**\n+ * Helper function to find individual Refine Search components based on the their `idSuffix`.\n+ *\n+ * @param container The root container to start the search from\n+ * @param componentSuffix Typically the `idSuffix` provided in `SearchPage.tsx`\n+ */\n+const getRefineSearchComponent = (\n+  container: Element,\n+  componentSuffix: string\n+) => {\n+  const id = `#RefineSearchPanel-${componentSuffix}`;\n+  const e = container.querySelector(id);\n+  if (!e) {\n+    throw new Error(`Failed to find ${id}`);\n+  }\n+\n+  return e as HTMLElement;\n+};\n+\n+describe(\"Refine search by status\", () => {\n+  const {\n+    live: liveButtonLabel,\n+    all: allButtonLabel,\n+  } = languageStrings.searchpage.statusSelector;\n+\n+  const expectSearchItemsCalledWithStatus = (status: OEQ.Common.ItemStatus[]) =>\n+    expect(mockSearch).toHaveBeenCalledWith({\n+      ...defaultSearchPageOptions,\n+      status: status,\n+    });\n+\n+  const getStatusSelector = (container: Element): HTMLElement =>\n+    getRefineSearchComponent(container, \"StatusSelector\");\n+\n+  const selectStatus = (container: Element, status: string) =>\n+    fireEvent.click(getByText(getStatusSelector(container), status));\n+\n+  afterEach(() => {\n+    // Needed to keep Enzyme tests below happy", "originalCommit": "a829f3ae75f900592949910a033743009e358963", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTA1MzQ0Ng==", "url": "https://github.com/openequella/openEQUELLA/pull/2172#discussion_r469053446", "bodyText": "Heh, I don't know. Funny you mention it, as I queried it over in your PR:\n#2171 (comment)\nBe interested to hear your thoughts. \ud83e\udd14", "author": "edalex-ian", "createdAt": "2020-08-12T07:15:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTAzMTYxNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTAzODQ1Ng==", "url": "https://github.com/openequella/openEQUELLA/pull/2172#discussion_r469038456", "bodyText": "May I ask why we want a const representing non-live Statuses rather than all Statuses ? If we have something like allStatuses then we can skip some array concatenation.", "author": "PenghaiZhang", "createdAt": "2020-08-12T06:43:18Z", "path": "Source/Plugins/Core/com.equella.core/js/tsrc/modules/SearchModule.ts", "diffHunk": "@@ -22,11 +22,31 @@ import { Collection } from \"./CollectionsModule\";\n import { DateRange } from \"../components/DateRangeSelector\";\n import { getISODateString } from \"../util/Date\";\n \n+/**\n+ * List of status which are considered 'live'.\n+ */\n+export const liveStatuses: OEQ.Common.ItemStatus[] = [\"LIVE\", \"REVIEW\"];\n+\n+/**\n+ * Predicate for checking if a provided status is not one of `liveStatuses`.\n+ * @param status a status to check for liveliness\n+ */\n+export const nonLiveStatus = (status: OEQ.Common.ItemStatus): boolean =>\n+  !liveStatuses.find((liveStatus) => status === liveStatus);\n+\n+/**\n+ * List of statuses which are considered non-live.\n+ */\n+export const nonLiveStatuses: OEQ.Common.ItemStatus[] = OEQ.Common.ItemStatuses.alternatives", "originalCommit": "a829f3ae75f900592949910a033743009e358963", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTA1OTQ1Mw==", "url": "https://github.com/openequella/openEQUELLA/pull/2172#discussion_r469059453", "bodyText": "I was wondering if anyone would pick this up, as I'm not sure either way. But here goes my thinking...\nIf you have have one subset on hand, it'd be useful to have the complement too. As in this case now I can readily say here are the 'live' status, and here are the 'non-live' statuses for any business logic we need to implement. And then if we need all I can be explicit and say here are all the live and non-live statuses. (But I've probably over thought it at this point.)\nThen as an aside, we do now technically have all the status on hand thanks to runtypes - via OEQ.Common.ItemStatuses.alternatives.map( i => i.value).\nBut so that is the thinking. What do you think? Should I drop the nonLiveStatuses and just use the above code snippet where we need all?", "author": "edalex-ian", "createdAt": "2020-08-12T07:27:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTAzODQ1Ng=="}], "type": "inlineReview"}, {"oid": "e2d77f84c16aab9515d88c1814604098c4c14bab", "url": "https://github.com/openequella/openEQUELLA/commit/e2d77f84c16aab9515d88c1814604098c4c14bab", "message": "front-end: Use toHaveBeenLastCalledWith for Status tests", "committedDate": "2020-08-12T09:43:03Z", "type": "commit"}]}