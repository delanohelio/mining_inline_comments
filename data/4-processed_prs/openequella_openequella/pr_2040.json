{"pr_number": 2040, "pr_title": "Add \"Raw search\" mode to new search UI", "pr_createdAt": "2020-07-13T06:45:56Z", "pr_url": "https://github.com/openequella/openEQUELLA/pull/2040", "timeline": [{"oid": "69dde2e2729b935f4c797b85c73b2cb453694ca1", "url": "https://github.com/openequella/openEQUELLA/commit/69dde2e2729b935f4c797b85c73b2cb453694ca1", "message": "Add language strings for raw search", "committedDate": "2020-07-13T01:29:33Z", "type": "commit"}, {"oid": "2915e189cba7b4cb029edd51690bc8404736318e", "url": "https://github.com/openequella/openEQUELLA/commit/2915e189cba7b4cb029edd51690bc8404736318e", "message": "Add the switch to the search page", "committedDate": "2020-07-13T01:29:33Z", "type": "commit"}, {"oid": "a3053fcaa94106a24cdb78696bcd30510043ab4c", "url": "https://github.com/openequella/openEQUELLA/commit/a3053fcaa94106a24cdb78696bcd30510043ab4c", "message": "Handle raw search mode in Searchbar.tsx", "committedDate": "2020-07-13T01:29:33Z", "type": "commit"}, {"oid": "1f48a431fef533b4375dcd455ae625f936a9feed", "url": "https://github.com/openequella/openEQUELLA/commit/1f48a431fef533b4375dcd455ae625f936a9feed", "message": "Add jest tests for raw search toggle\n\nOne to assert that type-ahead and wildcard appending works in simple\nsearch mode, and one to assert that raw search queries are sent as-is and only\nafter hitting the Enter key.", "committedDate": "2020-07-13T03:44:08Z", "type": "commit"}, {"oid": "bc1a4d6a6de51372d7e8fb0a9927255b53d2b277", "url": "https://github.com/openequella/openEQUELLA/commit/bc1a4d6a6de51372d7e8fb0a9927255b53d2b277", "message": "Merge branch 'component/new-search-page' into feature/raw_search_toggle", "committedDate": "2020-07-13T06:12:50Z", "type": "commit"}, {"oid": "13e2b3b4a28182460f22d2adfec27b2fb91f75a5", "url": "https://github.com/openequella/openEQUELLA/commit/13e2b3b4a28182460f22d2adfec27b2fb91f75a5", "message": "use awaitAct for my tests", "committedDate": "2020-07-13T06:37:24Z", "type": "commit"}, {"oid": "5700cfe88f97cb8c2a6669b9a0389a2c27518306", "url": "https://github.com/openequella/openEQUELLA/commit/5700cfe88f97cb8c2a6669b9a0389a2c27518306", "message": "Remove unnecessary braces", "committedDate": "2020-07-13T23:51:09Z", "type": "commit"}, {"oid": "0afd432e2e490bb7beec4ea32612e883a2f78cf5", "url": "https://github.com/openequella/openEQUELLA/commit/0afd432e2e490bb7beec4ea32612e883a2f78cf5", "message": "Update story to include raw search mode", "committedDate": "2020-07-14T00:10:17Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDAzNDkxMg==", "url": "https://github.com/openequella/openEQUELLA/pull/2040#discussion_r454034912", "bodyText": "This seems to duplicate the above test.", "author": "edalex-ian", "createdAt": "2020-07-14T00:58:57Z", "path": "Source/Plugins/Core/com.equella.core/js/__tests__/tsrc/search/SearchPage.test.tsx", "diffHunk": "@@ -177,4 +177,43 @@ describe(\"<SearchPage/>\", () => {\n     component.update();\n     expect(component.find(CircularProgress)).toHaveLength(0);\n   });\n+\n+  it(\"should debounce and append an * when not in raw search mode\", async () => {\n+    await querySearch(\"new query\");\n+    expect(searchPromise).toHaveBeenLastCalledWith({\n+      ...defaultSearchOptions,\n+      query: \"new query*\",\n+    });\n+  });", "originalCommit": "0afd432e2e490bb7beec4ea32612e883a2f78cf5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDA1NTc0Nw==", "url": "https://github.com/openequella/openEQUELLA/pull/2040#discussion_r454055747", "bodyText": "Yup, so it does. Removed.", "author": "SammyIsConfused", "createdAt": "2020-07-14T02:11:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDAzNDkxMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDAzNjMwNg==", "url": "https://github.com/openequella/openEQUELLA/pull/2040#discussion_r454036306", "bodyText": "I wonder if we should start putting IDs on these controls we wish to use in tests. We're doing this a bit, but it seems fragile. Further, we also have a repetitions now with with the string on line 190.\nCould you perhaps add an ID for the raw mode switch, and push the duplicate string into a constant?", "author": "edalex-ian", "createdAt": "2020-07-14T01:03:58Z", "path": "Source/Plugins/Core/com.equella.core/js/__tests__/tsrc/search/SearchPage.test.tsx", "diffHunk": "@@ -177,4 +177,43 @@ describe(\"<SearchPage/>\", () => {\n     component.update();\n     expect(component.find(CircularProgress)).toHaveLength(0);\n   });\n+\n+  it(\"should debounce and append an * when not in raw search mode\", async () => {\n+    await querySearch(\"new query\");\n+    expect(searchPromise).toHaveBeenLastCalledWith({\n+      ...defaultSearchOptions,\n+      query: \"new query*\",\n+    });\n+  });\n+\n+  it(\"should not debounce and send query as-is when in raw search mode\", async () => {\n+    const input = component.find(\"input.MuiInputBase-input\");\n+    const rawModeSwitch = component.find(\"input[type='checkbox']\");", "originalCommit": "0afd432e2e490bb7beec4ea32612e883a2f78cf5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDA1NTk0NQ==", "url": "https://github.com/openequella/openEQUELLA/pull/2040#discussion_r454055945", "bodyText": "Done. I still need to refer to the tagname too as adding an ID to a MUI control makes some of it's wrappers share the ID.", "author": "SammyIsConfused", "createdAt": "2020-07-14T02:12:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDAzNjMwNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDAzODg5MQ==", "url": "https://github.com/openequella/openEQUELLA/pull/2040#discussion_r454038891", "bodyText": "Again, good to put magic numbers into constants.", "author": "edalex-ian", "createdAt": "2020-07-14T01:13:12Z", "path": "Source/Plugins/Core/com.equella.core/js/__tests__/tsrc/search/SearchPage.test.tsx", "diffHunk": "@@ -177,4 +177,43 @@ describe(\"<SearchPage/>\", () => {\n     component.update();\n     expect(component.find(CircularProgress)).toHaveLength(0);\n   });\n+\n+  it(\"should debounce and append an * when not in raw search mode\", async () => {\n+    await querySearch(\"new query\");\n+    expect(searchPromise).toHaveBeenLastCalledWith({\n+      ...defaultSearchOptions,\n+      query: \"new query*\",\n+    });\n+  });\n+\n+  it(\"should not debounce and send query as-is when in raw search mode\", async () => {\n+    const input = component.find(\"input.MuiInputBase-input\");\n+    const rawModeSwitch = component.find(\"input[type='checkbox']\");\n+    await awaitAct(() => {\n+      //turn raw search mode on, add a search query and hit enter\n+      rawModeSwitch.simulate(\"change\", { target: { checked: true } });\n+      jest.advanceTimersByTime(1000);\n+      querySearch(\"raw search test\");\n+      input.simulate(\"keyDown\", {\n+        keyCode: 13,", "originalCommit": "0afd432e2e490bb7beec4ea32612e883a2f78cf5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDA1NTk4MQ==", "url": "https://github.com/openequella/openEQUELLA/pull/2040#discussion_r454055981", "bodyText": "Fixed", "author": "SammyIsConfused", "createdAt": "2020-07-14T02:12:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDAzODg5MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDAzOTI4MA==", "url": "https://github.com/openequella/openEQUELLA/pull/2040#discussion_r454039280", "bodyText": "Being that these are mutually exclusive, we only need one.", "author": "edalex-ian", "createdAt": "2020-07-14T01:14:34Z", "path": "Source/Plugins/Core/com.equella.core/js/__tests__/tsrc/search/SearchPage.test.tsx", "diffHunk": "@@ -177,4 +177,43 @@ describe(\"<SearchPage/>\", () => {\n     component.update();\n     expect(component.find(CircularProgress)).toHaveLength(0);\n   });\n+\n+  it(\"should debounce and append an * when not in raw search mode\", async () => {\n+    await querySearch(\"new query\");\n+    expect(searchPromise).toHaveBeenLastCalledWith({\n+      ...defaultSearchOptions,\n+      query: \"new query*\",\n+    });\n+  });\n+\n+  it(\"should not debounce and send query as-is when in raw search mode\", async () => {\n+    const input = component.find(\"input.MuiInputBase-input\");\n+    const rawModeSwitch = component.find(\"input[type='checkbox']\");\n+    await awaitAct(() => {\n+      //turn raw search mode on, add a search query and hit enter\n+      rawModeSwitch.simulate(\"change\", { target: { checked: true } });\n+      jest.advanceTimersByTime(1000);\n+      querySearch(\"raw search test\");\n+      input.simulate(\"keyDown\", {\n+        keyCode: 13,\n+      });\n+      jest.advanceTimersByTime(1000);\n+    });\n+\n+    //assert that the simple search wildcard was not appended\n+    expect(searchPromise).not.toHaveBeenLastCalledWith({\n+      ...defaultSearchOptions,\n+      query: \"raw search test*\",\n+    });\n+    //assert that the query was passed in as-is\n+    expect(searchPromise).toHaveBeenLastCalledWith({\n+      ...defaultSearchOptions,\n+      query: \"raw search test\",\n+    });", "originalCommit": "0afd432e2e490bb7beec4ea32612e883a2f78cf5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDA1NjE1Mw==", "url": "https://github.com/openequella/openEQUELLA/pull/2040#discussion_r454056153", "bodyText": "Removed the .not call.", "author": "SammyIsConfused", "createdAt": "2020-07-14T02:13:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDAzOTI4MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDA0MzYyMA==", "url": "https://github.com/openequella/openEQUELLA/pull/2040#discussion_r454043620", "bodyText": "It'd be good to have this small bit of repeated logic centralised - seeing it's rather key to expected functionality. If there was a function like:\nconst callOnChange = (query: string) =>\n  onChange(query + (rawSearchMode ? \"\" : \"*\"));\n... then you could simply call that function in this case block, so:\ncase ENTER_KEY_CODE:\n   event.preventDefault();\n  callOnChange(query);\n... and obviously you'd use that same function up in your debounce call.", "author": "edalex-ian", "createdAt": "2020-07-14T01:29:16Z", "path": "Source/Plugins/Core/com.equella.core/js/tsrc/search/components/SearchBar.tsx", "diffHunk": "@@ -37,30 +46,44 @@ interface SearchBarProps {\n  * This component does not handle the API query itself,\n  * that should be done in the parent component with the onChange callback.\n  */\n-export default function SearchBar({ onChange }: SearchBarProps) {\n+export default function SearchBar({ onChange, rawSearchMode }: SearchBarProps) {\n   const [query, setQuery] = React.useState<string>(\"\");\n-\n+  const strings = languageStrings.searchpage;\n   /**\n    * uses lodash to debounce the search query by half a second\n    */\n   const delayedQuery = useCallback(\n-    debounce((query: string) => onChange(query), 500),\n+    debounce((query: string) => onChange(query + \"*\"), 500),\n     [onChange]\n   );\n \n+  const handleKeyDown = (event: React.KeyboardEvent<HTMLDivElement>) => {\n+    switch (event.keyCode) {\n+      case ESCAPE_KEY_CODE:\n+        event.preventDefault();\n+        handleQueryChange(\"\");\n+        break;\n+      case ENTER_KEY_CODE:\n+        event.preventDefault();\n+        if (rawSearchMode) {\n+          onChange(query);\n+        } else {\n+          onChange(query + \"*\");", "originalCommit": "0afd432e2e490bb7beec4ea32612e883a2f78cf5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDA1NjIxNg==", "url": "https://github.com/openequella/openEQUELLA/pull/2040#discussion_r454056216", "bodyText": "Fixed", "author": "SammyIsConfused", "createdAt": "2020-07-14T02:13:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDA0MzYyMA=="}], "type": "inlineReview"}, {"oid": "a55cbda0aff1b0121df2b81c4b031349e670235b", "url": "https://github.com/openequella/openEQUELLA/commit/a55cbda0aff1b0121df2b81c4b031349e670235b", "message": "Add IDs for testing and centralise callOnChange", "committedDate": "2020-07-14T02:08:53Z", "type": "commit"}, {"oid": "3d3668e9bacee7219ad9c9fd50c8c2a886a52d54", "url": "https://github.com/openequella/openEQUELLA/commit/3d3668e9bacee7219ad9c9fd50c8c2a886a52d54", "message": "Make IDs for tests constants and remove duplicate test", "committedDate": "2020-07-14T02:09:41Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDA0NDUwNQ==", "url": "https://github.com/openequella/openEQUELLA/pull/2040#discussion_r454044505", "bodyText": "I feel this expect is not needed because the expect below can ensure the query does not get a * appended.", "author": "PenghaiZhang", "createdAt": "2020-07-14T01:32:17Z", "path": "Source/Plugins/Core/com.equella.core/js/__tests__/tsrc/search/SearchPage.test.tsx", "diffHunk": "@@ -177,4 +177,43 @@ describe(\"<SearchPage/>\", () => {\n     component.update();\n     expect(component.find(CircularProgress)).toHaveLength(0);\n   });\n+\n+  it(\"should debounce and append an * when not in raw search mode\", async () => {\n+    await querySearch(\"new query\");\n+    expect(searchPromise).toHaveBeenLastCalledWith({\n+      ...defaultSearchOptions,\n+      query: \"new query*\",\n+    });\n+  });\n+\n+  it(\"should not debounce and send query as-is when in raw search mode\", async () => {\n+    const input = component.find(\"input.MuiInputBase-input\");\n+    const rawModeSwitch = component.find(\"input[type='checkbox']\");\n+    await awaitAct(() => {\n+      //turn raw search mode on, add a search query and hit enter\n+      rawModeSwitch.simulate(\"change\", { target: { checked: true } });\n+      jest.advanceTimersByTime(1000);\n+      querySearch(\"raw search test\");\n+      input.simulate(\"keyDown\", {\n+        keyCode: 13,\n+      });\n+      jest.advanceTimersByTime(1000);\n+    });\n+\n+    //assert that the simple search wildcard was not appended\n+    expect(searchPromise).not.toHaveBeenLastCalledWith({", "originalCommit": "0afd432e2e490bb7beec4ea32612e883a2f78cf5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDA0NTA0Mg==", "url": "https://github.com/openequella/openEQUELLA/pull/2040#discussion_r454045042", "bodyText": "I would expect function SearchModule.searchItems rather than mocked promise searchPromise to have been called here.", "author": "PenghaiZhang", "createdAt": "2020-07-14T01:34:20Z", "path": "Source/Plugins/Core/com.equella.core/js/__tests__/tsrc/search/SearchPage.test.tsx", "diffHunk": "@@ -177,4 +177,43 @@ describe(\"<SearchPage/>\", () => {\n     component.update();\n     expect(component.find(CircularProgress)).toHaveLength(0);\n   });\n+\n+  it(\"should debounce and append an * when not in raw search mode\", async () => {\n+    await querySearch(\"new query\");\n+    expect(searchPromise).toHaveBeenLastCalledWith({\n+      ...defaultSearchOptions,\n+      query: \"new query*\",\n+    });\n+  });\n+\n+  it(\"should not debounce and send query as-is when in raw search mode\", async () => {\n+    const input = component.find(\"input.MuiInputBase-input\");\n+    const rawModeSwitch = component.find(\"input[type='checkbox']\");\n+    await awaitAct(() => {\n+      //turn raw search mode on, add a search query and hit enter\n+      rawModeSwitch.simulate(\"change\", { target: { checked: true } });\n+      jest.advanceTimersByTime(1000);\n+      querySearch(\"raw search test\");\n+      input.simulate(\"keyDown\", {\n+        keyCode: 13,\n+      });\n+      jest.advanceTimersByTime(1000);\n+    });\n+\n+    //assert that the simple search wildcard was not appended\n+    expect(searchPromise).not.toHaveBeenLastCalledWith({\n+      ...defaultSearchOptions,\n+      query: \"raw search test*\",\n+    });\n+    //assert that the query was passed in as-is\n+    expect(searchPromise).toHaveBeenLastCalledWith({", "originalCommit": "0afd432e2e490bb7beec4ea32612e883a2f78cf5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDA0NTk5Mw==", "url": "https://github.com/openequella/openEQUELLA/pull/2040#discussion_r454045993", "bodyText": "This test case seems to be duplicated because debounce and append an * when not in raw search mode is the default behaviour so the test above already covers this.", "author": "PenghaiZhang", "createdAt": "2020-07-14T01:37:32Z", "path": "Source/Plugins/Core/com.equella.core/js/__tests__/tsrc/search/SearchPage.test.tsx", "diffHunk": "@@ -177,4 +177,43 @@ describe(\"<SearchPage/>\", () => {\n     component.update();\n     expect(component.find(CircularProgress)).toHaveLength(0);\n   });\n+\n+  it(\"should debounce and append an * when not in raw search mode\", async () => {", "originalCommit": "0afd432e2e490bb7beec4ea32612e883a2f78cf5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDA0NjMzOQ==", "url": "https://github.com/openequella/openEQUELLA/pull/2040#discussion_r454046339", "bodyText": "Interestingly, this test can pass when I ran the whole test, but failed if I only ran it.\nAlso, because we are not using the fake timer for this test, I doubt if advanceTimersByTime really works.\nIf raw search disregards debounce, we probably do not worry about timer.", "author": "PenghaiZhang", "createdAt": "2020-07-14T01:38:54Z", "path": "Source/Plugins/Core/com.equella.core/js/__tests__/tsrc/search/SearchPage.test.tsx", "diffHunk": "@@ -177,4 +177,43 @@ describe(\"<SearchPage/>\", () => {\n     component.update();\n     expect(component.find(CircularProgress)).toHaveLength(0);\n   });\n+\n+  it(\"should debounce and append an * when not in raw search mode\", async () => {\n+    await querySearch(\"new query\");\n+    expect(searchPromise).toHaveBeenLastCalledWith({\n+      ...defaultSearchOptions,\n+      query: \"new query*\",\n+    });\n+  });\n+\n+  it(\"should not debounce and send query as-is when in raw search mode\", async () => {\n+    const input = component.find(\"input.MuiInputBase-input\");\n+    const rawModeSwitch = component.find(\"input[type='checkbox']\");\n+    await awaitAct(() => {\n+      //turn raw search mode on, add a search query and hit enter\n+      rawModeSwitch.simulate(\"change\", { target: { checked: true } });\n+      jest.advanceTimersByTime(1000);", "originalCommit": "0afd432e2e490bb7beec4ea32612e883a2f78cf5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDA2MzMwNA==", "url": "https://github.com/openequella/openEQUELLA/pull/2040#discussion_r454063304", "bodyText": "It was because advanceTimersByTime had been called before useFakeTimers(\"modern\"). To fix this, I've simply put that line in the beforeEach and removed it from elsewhere in the test.", "author": "SammyIsConfused", "createdAt": "2020-07-14T02:39:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDA0NjMzOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDExMTA1OQ==", "url": "https://github.com/openequella/openEQUELLA/pull/2040#discussion_r454111059", "bodyText": "Sorry I still don't understand why we need fake timer for this one because debounce does not get involved in this use case. Once we turn on raw search, no search is triggered until enter is pressed.\nPlease correct me if I am wrong.\nWhat this test is supposed to do, in my mind, are:\n\nturn on the switch; and\nchange the query value; and\npress enter; and\nexpect.\n\nThe third point should be wrap inside a act because it updates Search page state.", "author": "PenghaiZhang", "createdAt": "2020-07-14T05:31:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDA0NjMzOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDExMzQwNg==", "url": "https://github.com/openequella/openEQUELLA/pull/2040#discussion_r454113406", "bodyText": "Without the waits the switch and change to the query value seem to be too close together - we still get the debounce call. We need the wait to ensure that state has been update and percolated through after turning on the switch.", "author": "SammyIsConfused", "createdAt": "2020-07-14T05:38:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDA0NjMzOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDEzMjA4Mg==", "url": "https://github.com/openequella/openEQUELLA/pull/2040#discussion_r454132082", "bodyText": "I have played with Ian this test and we think we can refactor this test a bit.\nWe just need to wait for these three actions without the use of fake timer.\nawait awaitAct( () => rawModeSwitch.simulate(\"change\", { target: { checked: true } }) );\nawait awaitAct( () => input.simulate(\"change\", { target: { value: \"raw search test\" } }));\nawait awaitAct( () => input.simulate(\"keyDown\", {\n  keyCode: ENTER_KEYCODE,\n}));", "author": "PenghaiZhang", "createdAt": "2020-07-14T06:31:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDA0NjMzOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDEzMzkzNw==", "url": "https://github.com/openequella/openEQUELLA/pull/2040#discussion_r454133937", "bodyText": "Oooh nice work that looks really good in comparison. I just tested it and it works great. Pushed.", "author": "SammyIsConfused", "createdAt": "2020-07-14T06:35:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDA0NjMzOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDA1MDQ1OQ==", "url": "https://github.com/openequella/openEQUELLA/pull/2040#discussion_r454050459", "bodyText": "I wonder if onChange will be called twice. If I am not in raw search mode and I press enter, onChange is called, and then after 500ms the debounced one is triggered.", "author": "PenghaiZhang", "createdAt": "2020-07-14T01:53:23Z", "path": "Source/Plugins/Core/com.equella.core/js/tsrc/search/components/SearchBar.tsx", "diffHunk": "@@ -37,30 +46,44 @@ interface SearchBarProps {\n  * This component does not handle the API query itself,\n  * that should be done in the parent component with the onChange callback.\n  */\n-export default function SearchBar({ onChange }: SearchBarProps) {\n+export default function SearchBar({ onChange, rawSearchMode }: SearchBarProps) {\n   const [query, setQuery] = React.useState<string>(\"\");\n-\n+  const strings = languageStrings.searchpage;\n   /**\n    * uses lodash to debounce the search query by half a second\n    */\n   const delayedQuery = useCallback(\n-    debounce((query: string) => onChange(query), 500),\n+    debounce((query: string) => onChange(query + \"*\"), 500),\n     [onChange]\n   );\n \n+  const handleKeyDown = (event: React.KeyboardEvent<HTMLDivElement>) => {\n+    switch (event.keyCode) {\n+      case ESCAPE_KEY_CODE:\n+        event.preventDefault();\n+        handleQueryChange(\"\");\n+        break;\n+      case ENTER_KEY_CODE:\n+        event.preventDefault();\n+        if (rawSearchMode) {\n+          onChange(query);\n+        } else {\n+          onChange(query + \"*\");", "originalCommit": "0afd432e2e490bb7beec4ea32612e883a2f78cf5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDA2NDI2Mw==", "url": "https://github.com/openequella/openEQUELLA/pull/2040#discussion_r454064263", "bodyText": "In simple search mode, this is what happens.\nType a query, 500ms delay, onChange called\nPress enter, onChange called\nNo call after this.", "author": "SammyIsConfused", "createdAt": "2020-07-14T02:42:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDA1MDQ1OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDA3OTkzOQ==", "url": "https://github.com/openequella/openEQUELLA/pull/2040#discussion_r454079939", "bodyText": "Type a query, 500ms delay, onChange called  seems not working.", "author": "PenghaiZhang", "createdAt": "2020-07-14T03:40:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDA1MDQ1OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDExMjE3OA==", "url": "https://github.com/openequella/openEQUELLA/pull/2040#discussion_r454112178", "bodyText": "It is? I just checked it.", "author": "SammyIsConfused", "createdAt": "2020-07-14T05:34:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDA1MDQ1OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDEyNDg0Mg==", "url": "https://github.com/openequella/openEQUELLA/pull/2040#discussion_r454124842", "bodyText": "No, I tried this when I thought simple search  = raw search.", "author": "PenghaiZhang", "createdAt": "2020-07-14T06:12:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDA1MDQ1OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDEzMDYzOA==", "url": "https://github.com/openequella/openEQUELLA/pull/2040#discussion_r454130638", "bodyText": "Ahh I getcha. Sorry for the confusion.\nRaw search on = raw search.\nRaw search off = simple search.", "author": "SammyIsConfused", "createdAt": "2020-07-14T06:27:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDA1MDQ1OQ=="}], "type": "inlineReview"}, {"oid": "e28791b40cea86eab8152883389a4d219d8f3078", "url": "https://github.com/openequella/openEQUELLA/commit/e28791b40cea86eab8152883389a4d219d8f3078", "message": "Put useFakeTimers in the beforeEach and refer to searchItems in tests\n\nAs opposed to the promise.", "committedDate": "2020-07-14T02:36:18Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDEwOTYzNA==", "url": "https://github.com/openequella/openEQUELLA/pull/2040#discussion_r454109634", "bodyText": "We don't really need this for each test. Only tests in relation to debounce search need it,", "author": "PenghaiZhang", "createdAt": "2020-07-14T05:26:37Z", "path": "Source/Plugins/Core/com.equella.core/js/__tests__/tsrc/search/SearchPage.test.tsx", "diffHunk": "@@ -56,6 +56,7 @@ describe(\"<SearchPage/>\", () => {\n   let component: ReactWrapper<any, Readonly<{}>, React.Component<{}, {}, any>>;\n \n   beforeEach(async () => {\n+    jest.useFakeTimers(\"modern\");", "originalCommit": "e28791b40cea86eab8152883389a4d219d8f3078", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDExMDc1Nw==", "url": "https://github.com/openequella/openEQUELLA/pull/2040#discussion_r454110757", "bodyText": "Surely it makes sense to put it in just one place though?\nThere will be more tests in here later on and they will need this too. And just having this option set doesn't negatively affect anything. It just means its set up for async testing if it comes up.", "author": "SammyIsConfused", "createdAt": "2020-07-14T05:30:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDEwOTYzNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDEzNDM0NQ==", "url": "https://github.com/openequella/openEQUELLA/pull/2040#discussion_r454134345", "bodyText": "I am not sure if we would have more features requiring debounce. If no, I suggest we put jest.useFakeTimers(\"modern\") back to querySearch so the fake timer is available for tests that check the debounce query search.", "author": "PenghaiZhang", "createdAt": "2020-07-14T06:36:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDEwOTYzNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDEzNTAyOA==", "url": "https://github.com/openequella/openEQUELLA/pull/2040#discussion_r454135028", "bodyText": "Yep, I agree. My previous comment was based upon the assumption we needed them for non-debounce - like the test that was fixed in 99640bc.", "author": "SammyIsConfused", "createdAt": "2020-07-14T06:38:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDEwOTYzNA=="}], "type": "inlineReview"}, {"oid": "99640bc66f276b8711765a50562668450c70cf9a", "url": "https://github.com/openequella/openEQUELLA/commit/99640bc66f276b8711765a50562668450c70cf9a", "message": "Refactor the raw search mode test so that it doesn't need timeouts", "committedDate": "2020-07-14T06:34:00Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDEyNDg0NQ==", "url": "https://github.com/openequella/openEQUELLA/pull/2040#discussion_r454124845", "bodyText": "Thanks for the tidy-up. Makes it nice and clear. \ud83d\udc4d\nBut I do now wonder if this should simply be calling delayedQuery() so as to avoid someone typing and then pressing enter resulting in two queries to the server. As each search results in an entry into the Audit Log in the DB, pressing enter could just spam the audit log.\nPlus if this is then done, things can be further changed, as the body of callOnChange could just be placed in delayedQuery.", "author": "edalex-ian", "createdAt": "2020-07-14T06:12:12Z", "path": "Source/Plugins/Core/com.equella.core/js/tsrc/search/components/SearchBar.tsx", "diffHunk": "@@ -37,30 +46,40 @@ interface SearchBarProps {\n  * This component does not handle the API query itself,\n  * that should be done in the parent component with the onChange callback.\n  */\n-export default function SearchBar({ onChange }: SearchBarProps) {\n+export default function SearchBar({ onChange, rawSearchMode }: SearchBarProps) {\n   const [query, setQuery] = React.useState<string>(\"\");\n-\n+  const strings = languageStrings.searchpage;\n+  const callOnChange = (query: string) =>\n+    onChange(query + (rawSearchMode ? \"\" : \"*\"));\n   /**\n    * uses lodash to debounce the search query by half a second\n    */\n-  const delayedQuery = useCallback(\n-    debounce((query: string) => onChange(query), 500),\n-    [onChange]\n-  );\n+  const delayedQuery = useCallback(debounce(callOnChange, 500), [onChange]);\n \n+  const handleKeyDown = (event: React.KeyboardEvent<HTMLDivElement>) => {\n+    switch (event.keyCode) {\n+      case ESCAPE_KEY_CODE:\n+        event.preventDefault();\n+        handleQueryChange(\"\");\n+        break;\n+      case ENTER_KEY_CODE:\n+        event.preventDefault();\n+        callOnChange(query);", "originalCommit": "e28791b40cea86eab8152883389a4d219d8f3078", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDE0MzMyMQ==", "url": "https://github.com/openequella/openEQUELLA/pull/2040#discussion_r454143321", "bodyText": "I like that idea, and it works too. I've fixed that up and updated the test.", "author": "SammyIsConfused", "createdAt": "2020-07-14T06:57:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDEyNDg0NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDEyNTA5MA==", "url": "https://github.com/openequella/openEQUELLA/pull/2040#discussion_r454125090", "bodyText": "As an aside, this name should probably be debouncedQuery. There is no delay.", "author": "edalex-ian", "createdAt": "2020-07-14T06:12:45Z", "path": "Source/Plugins/Core/com.equella.core/js/tsrc/search/components/SearchBar.tsx", "diffHunk": "@@ -37,30 +46,40 @@ interface SearchBarProps {\n  * This component does not handle the API query itself,\n  * that should be done in the parent component with the onChange callback.\n  */\n-export default function SearchBar({ onChange }: SearchBarProps) {\n+export default function SearchBar({ onChange, rawSearchMode }: SearchBarProps) {\n   const [query, setQuery] = React.useState<string>(\"\");\n-\n+  const strings = languageStrings.searchpage;\n+  const callOnChange = (query: string) =>\n+    onChange(query + (rawSearchMode ? \"\" : \"*\"));\n   /**\n    * uses lodash to debounce the search query by half a second\n    */\n-  const delayedQuery = useCallback(\n-    debounce((query: string) => onChange(query), 500),\n-    [onChange]\n-  );\n+  const delayedQuery = useCallback(debounce(callOnChange, 500), [onChange]);", "originalCommit": "e28791b40cea86eab8152883389a4d219d8f3078", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDE0MzE2MA==", "url": "https://github.com/openequella/openEQUELLA/pull/2040#discussion_r454143160", "bodyText": "Fixed", "author": "SammyIsConfused", "createdAt": "2020-07-14T06:56:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDEyNTA5MA=="}], "type": "inlineReview"}, {"oid": "2f1fb6e4fd064ddc5d9a5af993a323b6da82d35b", "url": "https://github.com/openequella/openEQUELLA/commit/2f1fb6e4fd064ddc5d9a5af993a323b6da82d35b", "message": "Put useFakeTimers back into querySearch method", "committedDate": "2020-07-14T06:39:14Z", "type": "commit"}, {"oid": "2f77ec6ce9c275dfb6a0e9b21708ac6130098dd3", "url": "https://github.com/openequella/openEQUELLA/commit/2f77ec6ce9c275dfb6a0e9b21708ac6130098dd3", "message": "Debounce Enter key presses as well as typeahead", "committedDate": "2020-07-14T06:51:30Z", "type": "commit"}, {"oid": "9a50a99bb83d5d1f542626176871cc1c5cb29869", "url": "https://github.com/openequella/openEQUELLA/commit/9a50a99bb83d5d1f542626176871cc1c5cb29869", "message": "Update test to account for change to Enter key debounce", "committedDate": "2020-07-14T06:53:36Z", "type": "commit"}, {"oid": "9a50a99bb83d5d1f542626176871cc1c5cb29869", "url": "https://github.com/openequella/openEQUELLA/commit/9a50a99bb83d5d1f542626176871cc1c5cb29869", "message": "Update test to account for change to Enter key debounce", "committedDate": "2020-07-14T06:53:36Z", "type": "forcePushed"}]}