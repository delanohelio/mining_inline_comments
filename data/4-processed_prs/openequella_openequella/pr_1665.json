{"pr_number": 1665, "pr_title": "Refactor commonality of search setting pages", "pr_createdAt": "2020-04-28T05:49:04Z", "pr_url": "https://github.com/openequella/openEQUELLA/pull/1665", "timeline": [{"oid": "a21cfdcbb0cbeb1bd77f5a43cc257afce5eb08b2", "url": "https://github.com/openequella/openEQUELLA/commit/a21cfdcbb0cbeb1bd77f5a43cc257afce5eb08b2", "message": "The confirm button text on 'ConfirmDialog' should not be limited to 'delete'\nso make the dialog accept a text from parent component.\n\nTo control navigation, add a new component 'NavigationGuard' which includes\na 'Prompt' component provided by react-router and 'ConfirmDialog'.", "committedDate": "2020-04-28T01:30:37Z", "type": "commit"}, {"oid": "6639eb72acef32a3819038190bb2908557b6f011", "url": "https://github.com/openequella/openEQUELLA/commit/6639eb72acef32a3819038190bb2908557b6f011", "message": "Create a top level component that provides a save button, a snack bar\nand a dialog that prevents navigation. Then we can put specific page\ncontent in this component as its children.", "committedDate": "2020-04-28T01:56:35Z", "type": "commit"}, {"oid": "ac85f85ea0004090f1bbffeda1df021dc527867c", "url": "https://github.com/openequella/openEQUELLA/commit/ac85f85ea0004090f1bbffeda1df021dc527867c", "message": "Update ConfirmDialog and tests using this dialog", "committedDate": "2020-04-28T04:44:55Z", "type": "commit"}, {"oid": "31fda33dc6ac0020417439f8f7f225547ca9730f", "url": "https://github.com/openequella/openEQUELLA/commit/31fda33dc6ac0020417439f8f7f225547ca9730f", "message": "Add a story for SettingPageTemplate", "committedDate": "2020-04-28T05:36:12Z", "type": "commit"}, {"oid": "663a9d3ae1e158b620d30a08e1e7400d6518c6ac", "url": "https://github.com/openequella/openEQUELLA/commit/663a9d3ae1e158b620d30a08e1e7400d6518c6ac", "message": "Move function 'blockNavigationWithBrowser' to 'NavigationGuard' as it\nshould not be bind to the high level template.\n\nAdd a jest test to check if a dialog is showed when route is changed.", "committedDate": "2020-04-29T00:47:21Z", "type": "commit"}, {"oid": "c6a0db7668c7901ae88afb5c39cd9ee26a56171d", "url": "https://github.com/openequella/openEQUELLA/commit/c6a0db7668c7901ae88afb5c39cd9ee26a56171d", "message": "Test if the ConfirmDialog is hidden when route is not changed.", "committedDate": "2020-04-29T00:53:28Z", "type": "commit"}, {"oid": "e81e7a8e04047f7063f236258deb2c0c3bf558ab", "url": "https://github.com/openequella/openEQUELLA/commit/e81e7a8e04047f7063f236258deb2c0c3bf558ab", "message": "Fix Prettier format issue", "committedDate": "2020-04-29T01:27:53Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzAxNTE1MQ==", "url": "https://github.com/openequella/openEQUELLA/pull/1665#discussion_r417015151", "bodyText": "It looks like the stories don't include a MUI theme provider (e.g. a global decorator in .storybook/preview.ts) so I'm not sure any of these stories include the oEQ MUI theme", "author": "edalex-tom", "createdAt": "2020-04-29T01:09:54Z", "path": "Source/Plugins/Core/com.equella.core/js/__stories__/components/ConfirmDialog.stories.tsx", "diffHunk": "@@ -5,7 +5,7 @@ import ConfirmDialog from \"../../tsrc/components/ConfirmDialog\";\n \n export default {", "originalCommit": "c6a0db7668c7901ae88afb5c39cd9ee26a56171d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzA1ODQzNg==", "url": "https://github.com/openequella/openEQUELLA/pull/1665#discussion_r417058436", "bodyText": "I don't think oEQ MUI theme is included.\nHi @edalex-ian , do we want to create a ticket for this?", "author": "PenghaiZhang", "createdAt": "2020-04-29T04:20:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzAxNTE1MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzAxNjM5Nw==", "url": "https://github.com/openequella/openEQUELLA/pull/1665#discussion_r417016397", "bodyText": "Recommend these be knobs to allow devs to interact with the story and see the effect without needing to change stories.", "author": "edalex-tom", "createdAt": "2020-04-29T01:14:48Z", "path": "Source/Plugins/Core/com.equella.core/js/__stories__/components/SettingPageTemplate.stories.tsx", "diffHunk": "@@ -0,0 +1,41 @@\n+import * as React from \"react\";\n+import { action } from \"@storybook/addon-actions\";\n+import SettingPageTemplate from \"../../tsrc/components/SettingPageTemplate\";\n+import { Card } from \"@material-ui/core\";\n+\n+export default {\n+  title: \"SettingPageTemplate\",\n+  component: SettingPageTemplate\n+};\n+\n+const onClose = action(\"Close snackbar\");\n+const onSave = action(\"save\");\n+const children = (\n+  <Card>\n+    <h3>SettingPageTemplate Story</h3>\n+  </Card>\n+);\n+\n+export const saveButtonEnabled = () => (\n+  <SettingPageTemplate\n+    onSave={onSave}\n+    saveButtonDisabled={false}\n+    snackbarOpen={false}\n+    preventNavigation", "originalCommit": "c6a0db7668c7901ae88afb5c39cd9ee26a56171d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzAxNjY5NQ==", "url": "https://github.com/openequella/openEQUELLA/pull/1665#discussion_r417016695", "bodyText": "module isn't a meaningful name", "author": "edalex-tom", "createdAt": "2020-04-29T01:16:18Z", "path": "Source/Plugins/Core/com.equella.core/js/__tests__/tsrc/components/NavigationGuard.test.tsx", "diffHunk": "@@ -0,0 +1,45 @@\n+import * as React from \"react\";\n+import { mount } from \"enzyme\";\n+import * as module from \"../../../tsrc/components/NavigationGuard\";", "originalCommit": "c6a0db7668c7901ae88afb5c39cd9ee26a56171d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzAxNzIwMg==", "url": "https://github.com/openequella/openEQUELLA/pull/1665#discussion_r417017202", "bodyText": "Recommend this be a function call, otherwise the same mounted component will be used by all the tests, which may cause confusion if one test changes the component state", "author": "edalex-tom", "createdAt": "2020-04-29T01:18:34Z", "path": "Source/Plugins/Core/com.equella.core/js/__tests__/tsrc/components/NavigationGuard.test.tsx", "diffHunk": "@@ -0,0 +1,45 @@\n+import * as React from \"react\";\n+import { mount } from \"enzyme\";\n+import * as module from \"../../../tsrc/components/NavigationGuard\";\n+import { Router } from \"react-router\";\n+import * as historyModule from \"history\";\n+import { act } from \"react-dom/test-utils\";\n+import ConfirmDialog from \"../../../tsrc/components/ConfirmDialog\";\n+\n+/**\n+ * Need to mock the react-router context and function 'push'.\n+ */\n+jest.mock(\"react-router-dom\", () => ({\n+  useHistory: () => ({\n+    push: jest.fn()\n+  })\n+}));\n+\n+describe(\"<NavigationGuard />\", () => {\n+  const history = historyModule.createMemoryHistory();\n+  const mockBlockNavigationWithBrowser = jest.spyOn(\n+    module,\n+    \"blockNavigationWithBrowser\"\n+  );\n+  const component = mount(\n+    <Router history={history}>\n+      <module.NavigationGuard when />\n+    </Router>\n+  );", "originalCommit": "c6a0db7668c7901ae88afb5c39cd9ee26a56171d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzAxNzM5OA==", "url": "https://github.com/openequella/openEQUELLA/pull/1665#discussion_r417017398", "bodyText": "May be better to group the mocks together for readability, there's a mock outside the describe and a spyOn inside the describe.", "author": "edalex-tom", "createdAt": "2020-04-29T01:19:25Z", "path": "Source/Plugins/Core/com.equella.core/js/__tests__/tsrc/components/NavigationGuard.test.tsx", "diffHunk": "@@ -0,0 +1,45 @@\n+import * as React from \"react\";\n+import { mount } from \"enzyme\";\n+import * as module from \"../../../tsrc/components/NavigationGuard\";\n+import { Router } from \"react-router\";\n+import * as historyModule from \"history\";\n+import { act } from \"react-dom/test-utils\";\n+import ConfirmDialog from \"../../../tsrc/components/ConfirmDialog\";\n+\n+/**\n+ * Need to mock the react-router context and function 'push'.\n+ */\n+jest.mock(\"react-router-dom\", () => ({\n+  useHistory: () => ({\n+    push: jest.fn()\n+  })\n+}));\n+\n+describe(\"<NavigationGuard />\", () => {\n+  const history = historyModule.createMemoryHistory();\n+  const mockBlockNavigationWithBrowser = jest.spyOn(\n+    module,\n+    \"blockNavigationWithBrowser\"\n+  );", "originalCommit": "c6a0db7668c7901ae88afb5c39cd9ee26a56171d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzAxNzc0OA==", "url": "https://github.com/openequella/openEQUELLA/pull/1665#discussion_r417017748", "bodyText": "This expect doesn't match the it block description, this looks like it belongs in the \"should show ConfirmDialog\" test.\nAnother test could be added to ensure the on unmount logic (window.onbeforeunload = null) is performed.", "author": "edalex-tom", "createdAt": "2020-04-29T01:20:55Z", "path": "Source/Plugins/Core/com.equella.core/js/__tests__/tsrc/components/NavigationGuard.test.tsx", "diffHunk": "@@ -0,0 +1,45 @@\n+import * as React from \"react\";\n+import { mount } from \"enzyme\";\n+import * as module from \"../../../tsrc/components/NavigationGuard\";\n+import { Router } from \"react-router\";\n+import * as historyModule from \"history\";\n+import { act } from \"react-dom/test-utils\";\n+import ConfirmDialog from \"../../../tsrc/components/ConfirmDialog\";\n+\n+/**\n+ * Need to mock the react-router context and function 'push'.\n+ */\n+jest.mock(\"react-router-dom\", () => ({\n+  useHistory: () => ({\n+    push: jest.fn()\n+  })\n+}));\n+\n+describe(\"<NavigationGuard />\", () => {\n+  const history = historyModule.createMemoryHistory();\n+  const mockBlockNavigationWithBrowser = jest.spyOn(\n+    module,\n+    \"blockNavigationWithBrowser\"\n+  );\n+  const component = mount(\n+    <Router history={history}>\n+      <module.NavigationGuard when />\n+    </Router>\n+  );\n+\n+  it(\"should call blockNavigationWithBrowser once in the useEffect\", () => {\n+    expect(component.find(ConfirmDialog)).toHaveLength(1);", "originalCommit": "c6a0db7668c7901ae88afb5c39cd9ee26a56171d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzAxODIzMA==", "url": "https://github.com/openequella/openEQUELLA/pull/1665#discussion_r417018230", "bodyText": "The comment doesn't match what the expect is doing, unless the lack of a h2 element indicates the dialog is closed?\nI'm not sure the not is adding anything here, it could also just be a .toBe(false) or .toBeFalsy()", "author": "edalex-tom", "createdAt": "2020-04-29T01:22:55Z", "path": "Source/Plugins/Core/com.equella.core/js/__tests__/tsrc/components/NavigationGuard.test.tsx", "diffHunk": "@@ -0,0 +1,45 @@\n+import * as React from \"react\";\n+import { mount } from \"enzyme\";\n+import * as module from \"../../../tsrc/components/NavigationGuard\";\n+import { Router } from \"react-router\";\n+import * as historyModule from \"history\";\n+import { act } from \"react-dom/test-utils\";\n+import ConfirmDialog from \"../../../tsrc/components/ConfirmDialog\";\n+\n+/**\n+ * Need to mock the react-router context and function 'push'.\n+ */\n+jest.mock(\"react-router-dom\", () => ({\n+  useHistory: () => ({\n+    push: jest.fn()\n+  })\n+}));\n+\n+describe(\"<NavigationGuard />\", () => {\n+  const history = historyModule.createMemoryHistory();\n+  const mockBlockNavigationWithBrowser = jest.spyOn(\n+    module,\n+    \"blockNavigationWithBrowser\"\n+  );\n+  const component = mount(\n+    <Router history={history}>\n+      <module.NavigationGuard when />\n+    </Router>\n+  );\n+\n+  it(\"should call blockNavigationWithBrowser once in the useEffect\", () => {\n+    expect(component.find(ConfirmDialog)).toHaveLength(1);\n+    expect(mockBlockNavigationWithBrowser).toHaveBeenCalledTimes(1);\n+  });\n+\n+  it(\"should show ConfirmDialog when route is going to change\", () => {\n+    // The dialog is closed.\n+    expect(component.exists(\"h2\")).not.toBe(true);", "originalCommit": "c6a0db7668c7901ae88afb5c39cd9ee26a56171d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzAxOTE1NQ==", "url": "https://github.com/openequella/openEQUELLA/pull/1665#discussion_r417019155", "bodyText": "Missing JS doc", "author": "edalex-tom", "createdAt": "2020-04-29T01:26:42Z", "path": "Source/Plugins/Core/com.equella.core/js/tsrc/components/ConfirmDialog.tsx", "diffHunk": "@@ -24,8 +25,9 @@ const ConfirmDialog: FunctionComponent<ConfirmDialogProps> = ({\n   children,\n   onCancel,\n   onConfirm,\n+  confirmButtonText", "originalCommit": "c6a0db7668c7901ae88afb5c39cd9ee26a56171d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzAxOTM5NA==", "url": "https://github.com/openequella/openEQUELLA/pull/1665#discussion_r417019394", "bodyText": "Missing JS doc", "author": "edalex-tom", "createdAt": "2020-04-29T01:27:50Z", "path": "Source/Plugins/Core/com.equella.core/js/tsrc/components/NavigationGuard.tsx", "diffHunk": "@@ -0,0 +1,92 @@\n+import * as React from \"react\";\n+import { useEffect, useState } from \"react\";\n+import { Prompt, useHistory } from \"react-router\";\n+import ConfirmDialog from \"./ConfirmDialog\";\n+import { Location } from \"history\";\n+import { commonString } from \"../util/commonstrings\";\n+import { languageStrings } from \"../util/langstrings\";\n+\n+/**\n+ * Prevent navigations triggered by Browsers' behaviours when this's required.\n+ */\n+export const blockNavigationWithBrowser = (preventNavigation: boolean) => {\n+  window.onbeforeunload = () => {\n+    if (preventNavigation) {\n+      return true;\n+    }\n+    return;\n+  };\n+};\n+\n+interface Props {\n+  /**\n+   * A condition when navigation should be prevented.\n+   */\n+  when: boolean;\n+}\n+\n+export const NavigationGuard = ({ when }: Props) => {", "originalCommit": "c6a0db7668c7901ae88afb5c39cd9ee26a56171d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzAyMDEwNg==", "url": "https://github.com/openequella/openEQUELLA/pull/1665#discussion_r417020106", "bodyText": "This save button and styling be better refactored out to a dedicated component, unless it's SettingsPage specific?", "author": "edalex-tom", "createdAt": "2020-04-29T01:30:54Z", "path": "Source/Plugins/Core/com.equella.core/js/tsrc/components/SettingPageTemplate.tsx", "diffHunk": "@@ -0,0 +1,94 @@\n+import * as React from \"react\";\n+import { ReactNode } from \"react\";\n+import { Button } from \"@material-ui/core\";\n+import { Save } from \"@material-ui/icons\";\n+import { commonString } from \"../util/commonstrings\";\n+import MessageInfo from \"./MessageInfo\";\n+import { makeStyles } from \"@material-ui/core/styles\";\n+import { NavigationGuard } from \"./NavigationGuard\";\n+\n+const useStyles = makeStyles({\n+  floatingButton: {\n+    position: \"fixed\",\n+    top: 0,\n+    right: 0,\n+    marginTop: \"80px\",\n+    marginRight: \"16px\",\n+    width: \"calc(25% - 112px)\"\n+  }\n+});", "originalCommit": "c6a0db7668c7901ae88afb5c39cd9ee26a56171d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzAyMDQ1OQ==", "url": "https://github.com/openequella/openEQUELLA/pull/1665#discussion_r417020459", "bodyText": "Spelling mistake for handle", "author": "edalex-tom", "createdAt": "2020-04-29T01:32:12Z", "path": "Source/Plugins/Core/com.equella.core/js/tsrc/components/NavigationGuard.tsx", "diffHunk": "@@ -0,0 +1,92 @@\n+import * as React from \"react\";\n+import { useEffect, useState } from \"react\";\n+import { Prompt, useHistory } from \"react-router\";\n+import ConfirmDialog from \"./ConfirmDialog\";\n+import { Location } from \"history\";\n+import { commonString } from \"../util/commonstrings\";\n+import { languageStrings } from \"../util/langstrings\";\n+\n+/**\n+ * Prevent navigations triggered by Browsers' behaviours when this's required.\n+ */\n+export const blockNavigationWithBrowser = (preventNavigation: boolean) => {\n+  window.onbeforeunload = () => {\n+    if (preventNavigation) {\n+      return true;\n+    }\n+    return;\n+  };\n+};\n+\n+interface Props {\n+  /**\n+   * A condition when navigation should be prevented.\n+   */\n+  when: boolean;\n+}\n+\n+export const NavigationGuard = ({ when }: Props) => {\n+  const history = useHistory();\n+  const { message, title } = languageStrings.navigationguard;\n+\n+  const [showPrompt, setShowPrompt] = useState(false);\n+  const [confirmedNavigation, setConfirmedNavigation] = useState(false);\n+  const [navigateTo, setNavigateTo] = useState<Location>();\n+\n+  /**\n+   * Navigate to other pages, depending on if user confirms and next location.\n+   */\n+  useEffect(() => {\n+    if (confirmedNavigation && navigateTo) {\n+      history.push(navigateTo.pathname);\n+    }\n+  }, [confirmedNavigation, navigateTo]);\n+\n+  /**\n+   * Handle 'beforeunload' event when preventing navigation is required.\n+   * Do not handel this event when this component will unmount.", "originalCommit": "c6a0db7668c7901ae88afb5c39cd9ee26a56171d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzAyMTA2MQ==", "url": "https://github.com/openequella/openEQUELLA/pull/1665#discussion_r417021061", "bodyText": "Mixing patterns, there's onClick handlers that have () =>  versus _ =>", "author": "edalex-tom", "createdAt": "2020-04-29T01:35:07Z", "path": "Source/Plugins/Core/com.equella.core/js/tsrc/cloudprovider/CloudProviderListPage.tsx", "diffHunk": "@@ -203,7 +204,7 @@ class CloudProviderListPage extends React.Component<\n                 {cloudProvider.description} -{\" \"}\n                 <a\n                   href=\"javascript:void\"\n-                  onClick={(_) => this.refreshProvider(cloudProvider)}\n+                  onClick={_ => this.refreshProvider(cloudProvider)}", "originalCommit": "c6a0db7668c7901ae88afb5c39cd9ee26a56171d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzAyMTgwNA==", "url": "https://github.com/openequella/openEQUELLA/pull/1665#discussion_r417021804", "bodyText": "Has there been any discussions about organising/grouping the components?", "author": "edalex-tom", "createdAt": "2020-04-29T01:38:27Z", "path": "Source/Plugins/Core/com.equella.core/js/tsrc/components/NavigationGuard.tsx", "diffHunk": "@@ -0,0 +1,92 @@\n+import * as React from \"react\";", "originalCommit": "e81e7a8e04047f7063f236258deb2c0c3bf558ab", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzEwNjMwMQ==", "url": "https://github.com/openequella/openEQUELLA/pull/1665#discussion_r417106301", "bodyText": "Nope, not yet. So far components pretty well holds all the general use ones, and then more specific ones are in related directories.", "author": "edalex-ian", "createdAt": "2020-04-29T07:04:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzAyMTgwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzExNDEzMA==", "url": "https://github.com/openequella/openEQUELLA/pull/1665#discussion_r417114130", "bodyText": "I have not got involved in any discussion about this. Maybe @edalex-ian  had?", "author": "PenghaiZhang", "createdAt": "2020-04-29T07:21:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzAyMTgwNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzAyMzc3Nw==", "url": "https://github.com/openequella/openEQUELLA/pull/1665#discussion_r417023777", "bodyText": "This may cause an exception if the h2 does not exist.\nI pulled down the repo and it doesn't look like this expect block is being evaluated (e.g. changed the toBe to be random text and test still passes).", "author": "edalex-tom", "createdAt": "2020-04-29T01:46:43Z", "path": "Source/Plugins/Core/com.equella.core/js/__tests__/tsrc/components/NavigationGuard.test.tsx", "diffHunk": "@@ -0,0 +1,45 @@\n+import * as React from \"react\";\n+import { mount } from \"enzyme\";\n+import * as module from \"../../../tsrc/components/NavigationGuard\";\n+import { Router } from \"react-router\";\n+import * as historyModule from \"history\";\n+import { act } from \"react-dom/test-utils\";\n+import ConfirmDialog from \"../../../tsrc/components/ConfirmDialog\";\n+\n+/**\n+ * Need to mock the react-router context and function 'push'.\n+ */\n+jest.mock(\"react-router-dom\", () => ({\n+  useHistory: () => ({\n+    push: jest.fn(),\n+  }),\n+}));\n+\n+describe(\"<NavigationGuard />\", () => {\n+  const history = historyModule.createMemoryHistory();\n+  const mockBlockNavigationWithBrowser = jest.spyOn(\n+    module,\n+    \"blockNavigationWithBrowser\"\n+  );\n+  const component = mount(\n+    <Router history={history}>\n+      <module.NavigationGuard when />\n+    </Router>\n+  );\n+\n+  it(\"should call blockNavigationWithBrowser once in the useEffect\", () => {\n+    expect(component.find(ConfirmDialog)).toHaveLength(1);\n+    expect(mockBlockNavigationWithBrowser).toHaveBeenCalledTimes(1);\n+  });\n+\n+  it(\"should show ConfirmDialog when route is going to change\", () => {\n+    // The dialog is closed.\n+    expect(component.exists(\"h2\")).not.toBe(true);\n+\n+    // The dialog is open when route change event is triggered.\n+    history.listen(() => {\n+      expect(component.find(\"h2\").text()).toBe(\"Close without saving?\");", "originalCommit": "e81e7a8e04047f7063f236258deb2c0c3bf558ab", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzAyMzg4Mg==", "url": "https://github.com/openequella/openEQUELLA/pull/1665#discussion_r417023882", "bodyText": "Missing JS docs", "author": "edalex-tom", "createdAt": "2020-04-29T01:47:05Z", "path": "Source/Plugins/Core/com.equella.core/js/tsrc/components/ConfirmDialog.tsx", "diffHunk": "@@ -16,6 +16,7 @@ interface ConfirmDialogProps {\n   children?: ReactNode;\n   onConfirm: () => void;\n   onCancel: () => void;\n+  confirmButtonText: string;\n }", "originalCommit": "e81e7a8e04047f7063f236258deb2c0c3bf558ab", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzAyNTE4NA==", "url": "https://github.com/openequella/openEQUELLA/pull/1665#discussion_r417025184", "bodyText": "I'm not seeing a huge value in these comments as the name of the component below provides a good name of what it is.  The usage of these comments are also inconsistent, occasionally they're not prevent (e.g. for the MessageDialog below this)", "author": "edalex-tom", "createdAt": "2020-04-29T01:52:42Z", "path": "Source/Plugins/Core/com.equella.core/js/tsrc/settings/Search/searchfilter/SearchFilterSettingsPage.tsx", "diffHunk": "@@ -354,7 +348,6 @@ const SearchFilterPage = ({ updateTemplate }: TemplateUpdateProps) => {\n           </IconButton>\n         </CardActions>\n       </Card>\n-\n       {/* MIME type filter dialog */}", "originalCommit": "e81e7a8e04047f7063f236258deb2c0c3bf558ab", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzAyNjY0Nw==", "url": "https://github.com/openequella/openEQUELLA/pull/1665#discussion_r417026647", "bodyText": "There are multiple useEffects, it may be better to phrase it once when the component first mounts", "author": "edalex-tom", "createdAt": "2020-04-29T01:59:02Z", "path": "Source/Plugins/Core/com.equella.core/js/__tests__/tsrc/components/NavigationGuard.test.tsx", "diffHunk": "@@ -0,0 +1,45 @@\n+import * as React from \"react\";\n+import { mount } from \"enzyme\";\n+import * as module from \"../../../tsrc/components/NavigationGuard\";\n+import { Router } from \"react-router\";\n+import * as historyModule from \"history\";\n+import { act } from \"react-dom/test-utils\";\n+import ConfirmDialog from \"../../../tsrc/components/ConfirmDialog\";\n+\n+/**\n+ * Need to mock the react-router context and function 'push'.\n+ */\n+jest.mock(\"react-router-dom\", () => ({\n+  useHistory: () => ({\n+    push: jest.fn(),\n+  }),\n+}));\n+\n+describe(\"<NavigationGuard />\", () => {\n+  const history = historyModule.createMemoryHistory();\n+  const mockBlockNavigationWithBrowser = jest.spyOn(\n+    module,\n+    \"blockNavigationWithBrowser\"\n+  );\n+  const component = mount(\n+    <Router history={history}>\n+      <module.NavigationGuard when />\n+    </Router>\n+  );\n+\n+  it(\"should call blockNavigationWithBrowser once in the useEffect\", () => {", "originalCommit": "e81e7a8e04047f7063f236258deb2c0c3bf558ab", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzAyNzQ5Mw==", "url": "https://github.com/openequella/openEQUELLA/pull/1665#discussion_r417027493", "bodyText": "There's no test for when is false?", "author": "edalex-tom", "createdAt": "2020-04-29T02:02:48Z", "path": "Source/Plugins/Core/com.equella.core/js/__tests__/tsrc/components/NavigationGuard.test.tsx", "diffHunk": "@@ -0,0 +1,45 @@\n+import * as React from \"react\";\n+import { mount } from \"enzyme\";\n+import * as module from \"../../../tsrc/components/NavigationGuard\";\n+import { Router } from \"react-router\";\n+import * as historyModule from \"history\";\n+import { act } from \"react-dom/test-utils\";\n+import ConfirmDialog from \"../../../tsrc/components/ConfirmDialog\";\n+\n+/**\n+ * Need to mock the react-router context and function 'push'.\n+ */\n+jest.mock(\"react-router-dom\", () => ({\n+  useHistory: () => ({\n+    push: jest.fn(),\n+  }),\n+}));\n+\n+describe(\"<NavigationGuard />\", () => {\n+  const history = historyModule.createMemoryHistory();\n+  const mockBlockNavigationWithBrowser = jest.spyOn(\n+    module,\n+    \"blockNavigationWithBrowser\"\n+  );\n+  const component = mount(\n+    <Router history={history}>\n+      <module.NavigationGuard when />", "originalCommit": "e81e7a8e04047f7063f236258deb2c0c3bf558ab", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "d63a3abc99493c4399cf49ab2a6bc7807974e2a0", "url": "https://github.com/openequella/openEQUELLA/commit/d63a3abc99493c4399cf49ab2a6bc7807974e2a0", "message": "Describe SettingPageTemplate story with Knobs", "committedDate": "2020-04-29T04:32:19Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzEwODYxMw==", "url": "https://github.com/openequella/openEQUELLA/pull/1665#discussion_r417108613", "bodyText": "The JS doc says 'a condition', but true/false doesn't seem to capture a condition to me - as I'd expect it to be somewhat dynamic. Down below I see this is being passed around as a Location... Something seems out of wack here.", "author": "edalex-ian", "createdAt": "2020-04-29T07:09:47Z", "path": "Source/Plugins/Core/com.equella.core/js/tsrc/components/NavigationGuard.tsx", "diffHunk": "@@ -0,0 +1,92 @@\n+import * as React from \"react\";\n+import { useEffect, useState } from \"react\";\n+import { Prompt, useHistory } from \"react-router\";\n+import ConfirmDialog from \"./ConfirmDialog\";\n+import { Location } from \"history\";\n+import { commonString } from \"../util/commonstrings\";\n+import { languageStrings } from \"../util/langstrings\";\n+\n+/**\n+ * Prevent navigations triggered by Browsers' behaviours when this's required.\n+ */\n+export const blockNavigationWithBrowser = (preventNavigation: boolean) => {\n+  window.onbeforeunload = () => {\n+    if (preventNavigation) {\n+      return true;\n+    }\n+    return;\n+  };\n+};\n+\n+interface Props {\n+  /**\n+   * A condition when navigation should be prevented.\n+   */\n+  when: boolean;", "originalCommit": "e81e7a8e04047f7063f236258deb2c0c3bf558ab", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "52efd1c525c75365dafd6b385833b8a16c2ebe91", "url": "https://github.com/openequella/openEQUELLA/commit/52efd1c525c75365dafd6b385833b8a16c2ebe91", "message": "Add JSDoc for ConfirmDialog;\n\nRemove useless comments from SearchFilterSettingsPage;", "committedDate": "2020-04-30T02:52:59Z", "type": "commit"}, {"oid": "67cf0b41fcacb139b85eb84586b287eeae38479e", "url": "https://github.com/openequella/openEQUELLA/commit/67cf0b41fcacb139b85eb84586b287eeae38479e", "message": "Create a dedicated component for the Save button and use it in the\nSettingPageTemplate;\n\nImprove the NavigationGuard test coverage by checking the value of\n'window.onbeforeunload' which is changed when the component unmounts.", "committedDate": "2020-04-30T03:02:04Z", "type": "commit"}, {"oid": "66f044f13ca4547a03317bd11e703a6a97778b65", "url": "https://github.com/openequella/openEQUELLA/commit/66f044f13ca4547a03317bd11e703a6a97778b65", "message": "Refactor 'SearchPageSettings', including:\n\nUse 'SettingPageTemplate' so remove the Save button and snackbar;\n\nAdd a new variable to indicate if any changes are not saved;\n\nLoad settings from the Server after saving changes.", "committedDate": "2020-04-30T06:50:20Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzc5OTUyNw==", "url": "https://github.com/openequella/openEQUELLA/pull/1665#discussion_r417799527", "bodyText": "I think shallowEqual is fine because the structure of SearchSettings is simple (no nested objects).", "author": "PenghaiZhang", "createdAt": "2020-04-30T07:08:40Z", "path": "Source/Plugins/Core/com.equella.core/js/tsrc/settings/Search/SearchPageSettings.tsx", "diffHunk": "@@ -48,27 +48,49 @@ function SearchPageSettings({ updateTemplate }: TemplateUpdateProps) {\n   const [cloudSettings, setCloudSettings] = React.useState<CloudSettings>({\n     disabled: false,\n   });\n+\n+  const [initialSearchSettings, setInitialSearchSettings] = React.useState<\n+    SearchSettings\n+  >(defaultSearchSettings);\n+  const [initialCloudSettings, setInitialCloudSettings] = React.useState<\n+    CloudSettings\n+  >({\n+    disabled: false,\n+  });\n+\n   const [showError, setShowError] = React.useState<boolean>(false);\n   const [showSuccess, setShowSuccess] = React.useState<boolean>(false);\n \n   const searchPageSettingsStrings =\n     languageStrings.settings.searching.searchPageSettings;\n   const classes = useStyles();\n \n+  const changesUnsaved =\n+    initialCloudSettings.disabled !== cloudSettings.disabled ||\n+    !shallowEqual(searchSettings, initialSearchSettings);", "originalCommit": "66f044f13ca4547a03317bd11e703a6a97778b65", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "94f28007a1f9f14ed9cff84ab7257ba3e25f535c", "url": "https://github.com/openequella/openEQUELLA/commit/94f28007a1f9f14ed9cff84ab7257ba3e25f535c", "message": "Fix SearchSettingsTest:\n\nAdd an ID to the Save button;\n\nChange the successful saving text expected in the test;\n\nRemove two unnecessary saves.", "committedDate": "2020-04-30T08:41:53Z", "type": "commit"}, {"oid": "83078b96a0e1f93c56a31d72cd4e4a2764132d24", "url": "https://github.com/openequella/openEQUELLA/commit/83078b96a0e1f93c56a31d72cd4e4a2764132d24", "message": "Merge branch 'component/search_configuration' into feature/refactor-commonality-of-search-setting-pages", "committedDate": "2020-04-30T23:25:37Z", "type": "commit"}, {"oid": "27fca1febdb5df6eaba56b5e34e976b8015f0890", "url": "https://github.com/openequella/openEQUELLA/commit/27fca1febdb5df6eaba56b5e34e976b8015f0890", "message": "Refactor ContentIndexSetting:\n\nUse SettingPageTemplate to wrap the main contents of this page;\n\nRemove the Save button and snackbar;\n\nAdd a variable to indicate if any change is not saved.", "committedDate": "2020-05-01T00:30:19Z", "type": "commit"}, {"oid": "40682b8948f35f5d982864f631401caaf6adb7d6", "url": "https://github.com/openequella/openEQUELLA/commit/40682b8948f35f5d982864f631401caaf6adb7d6", "message": "Ensure the ContentIndexSettings jest test is happy with SettingPageTemplate", "committedDate": "2020-05-01T02:29:15Z", "type": "commit"}, {"oid": "f1f182afe988639b971e66ba03d2b21ef5201918", "url": "https://github.com/openequella/openEQUELLA/commit/f1f182afe988639b971e66ba03d2b21ef5201918", "message": "Instead of mocking SettingPageTemplate, it's better to mock NavigationGuard\nbecause the test may need components included in SettingPageTemplate, such\nas the Save button.", "committedDate": "2020-05-01T04:17:28Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODQwNjQ3MQ==", "url": "https://github.com/openequella/openEQUELLA/pull/1665#discussion_r418406471", "bodyText": "A lot of these styles are dependent on where it's used. We can't really say this is a generic component if we put this in here. Maybe it's up to the parent to style it for that specific context. But at that point, do we need this as a common component?", "author": "edalex-ian", "createdAt": "2020-05-01T03:59:13Z", "path": "Source/Plugins/Core/com.equella.core/js/tsrc/components/SaveButton.tsx", "diffHunk": "@@ -0,0 +1,47 @@\n+import * as React from \"react\";\n+import { Button, makeStyles } from \"@material-ui/core\";\n+import { commonString } from \"../util/commonstrings\";\n+import { Save } from \"@material-ui/icons\";\n+\n+const useStyles = makeStyles({\n+  floatingButton: {\n+    position: \"fixed\",\n+    top: 0,\n+    right: 0,\n+    marginTop: \"80px\",\n+    marginRight: \"16px\",\n+    width: \"calc(25% - 112px)\",\n+  },\n+});", "originalCommit": "40682b8948f35f5d982864f631401caaf6adb7d6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "70b7d8be44488dd0909111fdf340e0269ea0140d", "url": "https://github.com/openequella/openEQUELLA/commit/70b7d8be44488dd0909111fdf340e0269ea0140d", "message": "Do not need a dedicated component for the Save button in Setting pages\nso remove it. Move the button back to SettingPageTemplate.", "committedDate": "2020-05-01T05:49:03Z", "type": "commit"}]}