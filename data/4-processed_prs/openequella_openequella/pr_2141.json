{"pr_number": 2141, "pr_title": "Update Schema module and Collection module", "pr_createdAt": "2020-08-05T06:02:43Z", "pr_url": "https://github.com/openequella/openEQUELLA/pull/2141", "timeline": [{"oid": "717658f041bc79033de6d581b4e02b8f26dae794", "url": "https://github.com/openequella/openEQUELLA/commit/717658f041bc79033de6d581b4e02b8f26dae794", "message": "Update Schema module and Collection module\n\n1. Create a new function to list BaseEntities by resumption tokens.\n2. Update Schema module and Collection module to use this new function.\n3. Rename ListCommonParams's field 'resumptionToken' to 'resumption'.\n4. Update mock data for tests.", "committedDate": "2020-08-05T05:54:16Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTUwMTMyNw==", "url": "https://github.com/openequella/openEQUELLA/pull/2141#discussion_r465501327", "bodyText": "Spare log.", "author": "SammyIsConfused", "createdAt": "2020-08-05T06:28:08Z", "path": "Source/Plugins/Core/com.equella.core/js/tsrc/modules/OEQHelpers.ts", "diffHunk": "@@ -24,11 +24,38 @@ import * as OEQ from \"@openequella/rest-api-client\";\n  *\n  * @param list A list most likely retrieved via a REST call in the REST Client library\n  */\n-export const summarisePagedBaseEntities = (\n-  list: OEQ.Common.PagedResult<OEQ.Common.BaseEntity>\n-) =>\n-  list.results.reduce(\n+export const summarisePagedBaseEntities = (list: OEQ.Common.BaseEntity[]) =>\n+  list.reduce(\n     (prev: Map<string, string>, curr: OEQ.Common.BaseEntity) =>\n       prev.set(curr.uuid, curr.name),\n     new Map<string, string>()\n   );\n+\n+const DEFAULT_RESUMPTION_TOKEN = \"0:10\";\n+\n+/**\n+ * Retrieve BaseEntities by resumption tokens.\n+ * If a resumption token is included in response, then send another request to retrieve\n+ * more entities, until no resumption token is returned.\n+ *\n+ * @param getData A function which takes a resumption token to retrieve specific entities\n+ *        such as schemas and collections.\n+ */\n+export const listEntities = <T extends OEQ.Common.BaseEntity>(\n+  getData: (resumptionToken: string) => Promise<OEQ.Common.PagedResult<T>>\n+): Promise<T[]> => {\n+  const entities: T[] = [];\n+  return getData(DEFAULT_RESUMPTION_TOKEN).then(async (pagedResult) => {\n+    console.log(pagedResult);", "originalCommit": "717658f041bc79033de6d581b4e02b8f26dae794", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTUwMjUxOA==", "url": "https://github.com/openequella/openEQUELLA/pull/2141#discussion_r465502518", "bodyText": "Ah thanks for reminding!", "author": "PenghaiZhang", "createdAt": "2020-08-05T06:31:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTUwMTMyNw=="}], "type": "inlineReview"}, {"oid": "1e70246a027a53fbdaac0e0458c11c20596192c5", "url": "https://github.com/openequella/openEQUELLA/commit/1e70246a027a53fbdaac0e0458c11c20596192c5", "message": "Remove a useless console log.", "committedDate": "2020-08-05T06:32:17Z", "type": "commit"}, {"oid": "0a17ce7d2153de2677e60bc1c1b05470d1d57295", "url": "https://github.com/openequella/openEQUELLA/commit/0a17ce7d2153de2677e60bc1c1b05470d1d57295", "message": "Tweak code in PagedResults.scala to follow Scala convention.", "committedDate": "2020-08-05T23:11:24Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjA5MjM4OQ==", "url": "https://github.com/openequella/openEQUELLA/pull/2141#discussion_r466092389", "bodyText": "A couple of things here:\n\nIf you make a recursive function, please put it in the JSDoc so it's immediately obvious to any consumers. This is important, as recursive functions can be a source of all kinds of wonderful issues. That leads to;\nAlthough I like you're thinking, using a recursive function to iteratively retrieve an unknown size of results from a server is dangerous! Here in Javascript land we don't have tail-recursion and so you easily run the risk of blowing the stack. this is a pretty simple case, so a while loop will be fine, or you want you could play with JS Iterators or Generators.\n\nSo, we need to rewrite this without the recursion.", "author": "edalex-ian", "createdAt": "2020-08-06T01:28:10Z", "path": "Source/Plugins/Core/com.equella.core/js/tsrc/modules/OEQHelpers.ts", "diffHunk": "@@ -24,11 +24,37 @@ import * as OEQ from \"@openequella/rest-api-client\";\n  *\n  * @param list A list most likely retrieved via a REST call in the REST Client library\n  */\n-export const summarisePagedBaseEntities = (\n-  list: OEQ.Common.PagedResult<OEQ.Common.BaseEntity>\n-) =>\n-  list.results.reduce(\n+export const summarisePagedBaseEntities = (list: OEQ.Common.BaseEntity[]) =>\n+  list.reduce(\n     (prev: Map<string, string>, curr: OEQ.Common.BaseEntity) =>\n       prev.set(curr.uuid, curr.name),\n     new Map<string, string>()\n   );\n+\n+const DEFAULT_RESUMPTION_TOKEN = \"0:10\";\n+\n+/**\n+ * Retrieve BaseEntities by resumption tokens.\n+ * If a resumption token is included in response, then send another request to retrieve\n+ * more entities, until no resumption token is returned.\n+ *\n+ * @param getData A function which takes a resumption token to retrieve specific entities\n+ *        such as schemas and collections.\n+ */\n+export const listEntities = <T extends OEQ.Common.BaseEntity>(\n+  getData: (resumptionToken: string) => Promise<OEQ.Common.PagedResult<T>>\n+): Promise<T[]> => {\n+  const entities: T[] = [];\n+  return getData(DEFAULT_RESUMPTION_TOKEN).then(async (pagedResult) => {\n+    entities.push(...pagedResult.results);\n+    // If a resumption token is returned, recursively call listEntities to retrieve more entities.", "originalCommit": "0a17ce7d2153de2677e60bc1c1b05470d1d57295", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "579f6e5022e9e67588d6975fb5ce883a814fa9c2", "url": "https://github.com/openequella/openEQUELLA/commit/579f6e5022e9e67588d6975fb5ce883a814fa9c2", "message": "Use a while loop rater than recursive calls to retrieve entities.", "committedDate": "2020-08-06T04:13:19Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjEzNzI0Mg==", "url": "https://github.com/openequella/openEQUELLA/pull/2141#discussion_r466137242", "bodyText": "If you're going to use await, wouldn't you just do:\n    const pagedResult = await getData(token);\n    entities.push(...pagedResult.results);\n    token = pagedResult.resumptionToken ?? \"\";\nOr are you doing it for the error handling?\nAlso, shouldn't it be fine for:\n    token = pagedResult.resumptionToken ?? \"\";\nJust to be:\n    token = pagedResult.resumptionToken;", "author": "edalex-ian", "createdAt": "2020-08-06T04:22:51Z", "path": "Source/Plugins/Core/com.equella.core/js/tsrc/modules/OEQHelpers.ts", "diffHunk": "@@ -24,11 +24,33 @@ import * as OEQ from \"@openequella/rest-api-client\";\n  *\n  * @param list A list most likely retrieved via a REST call in the REST Client library\n  */\n-export const summarisePagedBaseEntities = (\n-  list: OEQ.Common.PagedResult<OEQ.Common.BaseEntity>\n-) =>\n-  list.results.reduce(\n+export const summarisePagedBaseEntities = (list: OEQ.Common.BaseEntity[]) =>\n+  list.reduce(\n     (prev: Map<string, string>, curr: OEQ.Common.BaseEntity) =>\n       prev.set(curr.uuid, curr.name),\n     new Map<string, string>()\n   );\n+\n+const DEFAULT_RESUMPTION_TOKEN = \"0:10\";\n+\n+/**\n+ * Retrieve BaseEntities by resumption tokens.\n+ * If a resumption token is included in response, then send another request to retrieve\n+ * more entities, until no resumption token is returned.\n+ *\n+ * @param getData A function which takes a resumption token to retrieve specific entities\n+ *        such as schemas and collections.\n+ */\n+export const listEntities = async <T extends OEQ.Common.BaseEntity>(\n+  getData: (resumptionToken: string) => Promise<OEQ.Common.PagedResult<T>>\n+): Promise<T[]> => {\n+  const entities: T[] = [];\n+  let token: string = DEFAULT_RESUMPTION_TOKEN;\n+  while (token) {\n+    await getData(token).then((pagedResult) => {\n+      entities.push(...pagedResult.results);\n+      token = pagedResult.resumptionToken ?? \"\";\n+    });", "originalCommit": "579f6e5022e9e67588d6975fb5ce883a814fa9c2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "06e8f4a4e2c0f6691743c19f65dc0871b45b75ac", "url": "https://github.com/openequella/openEQUELLA/commit/06e8f4a4e2c0f6691743c19f65dc0871b45b75ac", "message": "Simplify function listEntities and improve its readability.", "committedDate": "2020-08-06T04:34:08Z", "type": "commit"}, {"oid": "869b28532fb94d4ecd8bd04970967de962de2e19", "url": "https://github.com/openequella/openEQUELLA/commit/869b28532fb94d4ecd8bd04970967de962de2e19", "message": "Merge branch 'component/new-search-page' into feature/update-schema-module-and-collection-module", "committedDate": "2020-08-09T22:59:46Z", "type": "commit"}]}