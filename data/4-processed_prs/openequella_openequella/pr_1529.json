{"pr_number": 1529, "pr_title": "test: add unit tests for typescript utils", "pr_createdAt": "2020-03-07T05:06:27Z", "pr_url": "https://github.com/openequella/openEQUELLA/pull/1529", "timeline": [{"oid": "fdc3e3f7255460d97cb0487d9e3efcfe2ce02d45", "url": "https://github.com/openequella/openEQUELLA/commit/fdc3e3f7255460d97cb0487d9e3efcfe2ce02d45", "message": "test: add unit tests for typescript utils\n\nalso adds support for writing tests in typescript\n\n```\n----------------|----------|----------|----------|----------|-------------------|\nFile            |  % Stmts | % Branch |  % Funcs |  % Lines | Uncovered Line #s |\n----------------|----------|----------|----------|----------|-------------------|\nAll files       |    97.83 |    88.89 |      100 |    97.67 |                   |\n encodequery.ts |      100 |       90 |      100 |      100 |                10 |\n langstrings.ts |       96 |    81.82 |      100 |    95.83 |                40 |\n validation.ts  |      100 |      100 |      100 |      100 |                   |\n----------------|----------|----------|----------|----------|-------------------|\n```", "committedDate": "2020-03-07T05:08:23Z", "type": "commit"}, {"oid": "fdc3e3f7255460d97cb0487d9e3efcfe2ce02d45", "url": "https://github.com/openequella/openEQUELLA/commit/fdc3e3f7255460d97cb0487d9e3efcfe2ce02d45", "message": "test: add unit tests for typescript utils\n\nalso adds support for writing tests in typescript\n\n```\n----------------|----------|----------|----------|----------|-------------------|\nFile            |  % Stmts | % Branch |  % Funcs |  % Lines | Uncovered Line #s |\n----------------|----------|----------|----------|----------|-------------------|\nAll files       |    97.83 |    88.89 |      100 |    97.67 |                   |\n encodequery.ts |      100 |       90 |      100 |      100 |                10 |\n langstrings.ts |       96 |    81.82 |      100 |    95.83 |                40 |\n validation.ts  |      100 |      100 |      100 |      100 |                   |\n----------------|----------|----------|----------|----------|-------------------|\n```", "committedDate": "2020-03-07T05:08:23Z", "type": "forcePushed"}, {"oid": "70f0033cbcb94fb7d29b563c99ebd6b8f7b6b9dd", "url": "https://github.com/openequella/openEQUELLA/commit/70f0033cbcb94fb7d29b563c99ebd6b8f7b6b9dd", "message": "test: add more util tests and add a mainui test\n\nuse ts-jest to validate typings on typescript tests.\nadd enzyme to add utilities for testing ui components.\nadd tsdoc comments to utils.", "committedDate": "2020-03-07T18:22:56Z", "type": "commit"}, {"oid": "70f0033cbcb94fb7d29b563c99ebd6b8f7b6b9dd", "url": "https://github.com/openequella/openEQUELLA/commit/70f0033cbcb94fb7d29b563c99ebd6b8f7b6b9dd", "message": "test: add more util tests and add a mainui test\n\nuse ts-jest to validate typings on typescript tests.\nadd enzyme to add utilities for testing ui components.\nadd tsdoc comments to utils.", "committedDate": "2020-03-07T18:22:56Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTMwMTg5OA==", "url": "https://github.com/openequella/openEQUELLA/pull/1529#discussion_r389301898", "bodyText": "open to a better description, it's not entirely clear from the code why this util exists.", "author": "ChristianMurphy", "createdAt": "2020-03-07T18:23:51Z", "path": "Source/Plugins/Core/com.equella.core/js/tsrc/util/actionutil.test.ts", "diffHunk": "@@ -0,0 +1,38 @@\n+import { actionCreator, wrapAsyncWorker } from \"./actionutil\";\n+\n+describe(\"actionutil\", () => {\n+  describe(\"actionCreator\", () => {\n+    it(\"should return a sync action\", () => {\n+      const actionFactory = actionCreator(\"example\");\n+      expect(typeof actionFactory).toBe(\"function\");\n+      const action = actionFactory();\n+      expect(action).toMatchObject({ type: \"example\", payload: undefined });\n+    });\n+\n+    it(\"should return an async action\", () => {\n+      const actionFactory = actionCreator.async(\"example\");\n+      expect(typeof actionFactory).toBe(\"object\");\n+\n+      const action = actionFactory.started(\"payload\");\n+      expect(action).toMatchObject({\n+        type: \"example_STARTED\",\n+        payload: \"payload\"\n+      });\n+    });\n+  });\n+\n+  describe(\"wrapAsyncWorker\", () => {\n+    it(\"should do something?\", async () => {", "originalCommit": "70f0033cbcb94fb7d29b563c99ebd6b8f7b6b9dd", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTMwMTk1Mw==", "url": "https://github.com/openequella/openEQUELLA/pull/1529#discussion_r389301953", "bodyText": "Note, when material ui styles on the page, use createMount to automatically setup the context providers.\nhttps://material-ui.com/guides/testing/", "author": "ChristianMurphy", "createdAt": "2020-03-07T18:25:07Z", "path": "Source/Plugins/Core/com.equella.core/js/tsrc/mainui/ErrorPage.test.tsx", "diffHunk": "@@ -0,0 +1,49 @@\n+import * as React from \"react\";\n+import { createMount } from \"@material-ui/core/test-utils\";\n+import ErrorPage from \"./ErrorPage\";\n+\n+jest.mock(\"@material-ui/styles\", () => ({\n+  makeStyles: () => () => ({ errorPage: \"mock-classname\" })\n+}));\n+\n+describe(\"<ErrorPage />\", () => {\n+  let mount: ReturnType<typeof createMount>;", "originalCommit": "70f0033cbcb94fb7d29b563c99ebd6b8f7b6b9dd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTMwMjcwOQ==", "url": "https://github.com/openequella/openEQUELLA/pull/1529#discussion_r389302709", "bodyText": "/cc @PenghaiZhang  re #1231 (comment)\nThis is an example of an inline interface that could not be easily reused.\nIn the material ui side the typing is:\nexport default function createMount(\n  options?: Partial<MountOptions>,\n): typeof mount & {\n  attachTo: HTMLElement;\n  cleanUp(): void;\n};\nbecause the return type interface was done inline, rather than through creating a new exported type or interface the only way to get proper typing in oEQ is to do type extraction ReturnType<typeof createMount>", "author": "ChristianMurphy", "createdAt": "2020-03-07T18:36:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTMwMTk1Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTk4MjQ5Mg==", "url": "https://github.com/openequella/openEQUELLA/pull/1529#discussion_r389982492", "bodyText": "Nice! We should probably raise a Issue to do that - especially as we move to the New UI in earnest.", "author": "edalex-ian", "createdAt": "2020-03-09T21:52:20Z", "path": "Source/Plugins/Core/com.equella.core/js/tsrc/util/langstrings.ts", "diffHunk": "@@ -7,8 +7,17 @@ export interface Sizes {\n   one: string;\n   more: string;\n }\n+\n+/**\n+ * Get appropriate language string based off size of value\n+ *\n+ * @param size size or count of value\n+ * @param strings language strings to choose from\n+ *\n+ * TODO: replace with https://github.com/formatjs/react-intl", "originalCommit": "70f0033cbcb94fb7d29b563c99ebd6b8f7b6b9dd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDA3NzQwNA==", "url": "https://github.com/openequella/openEQUELLA/pull/1529#discussion_r390077404", "bodyText": "Also be aware react-intl isn't the only option.\nthere is https://github.com/i18next/react-i18next which is also a good option.\nEither way I'd recommend using ICU format\n\nhttp://userguide.icu-project.org/formatparse/messages\nhttps://formatjs.io/guides/message-syntax\nhttps://react.i18next.com/misc/using-with-icu-format\n\nBecause it comes baked in with awareness of different languages' pluralization rules (through CLDR)\nhttp://www.unicode.org/cldr/charts/latest/supplemental/language_plural_rules.html is a nice reminder of the challenges it solves, Arabic and Czech are two languages which are prime examples of pluralization rules very different from English", "author": "ChristianMurphy", "createdAt": "2020-03-10T03:31:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTk4MjQ5Mg=="}], "type": "inlineReview"}, {"oid": "c650fd3a8cb56e3047864c2ea134bb2bffa1ffa2", "url": "https://github.com/openequella/openEQUELLA/commit/c650fd3a8cb56e3047864c2ea134bb2bffa1ffa2", "message": "test: refactor use __test__ folder, use describe blocks in versioncheck", "committedDate": "2020-03-12T16:17:42Z", "type": "commit"}, {"oid": "5a33aa18ae53874f8001b21036c9090aec11faff", "url": "https://github.com/openequella/openEQUELLA/commit/5a33aa18ae53874f8001b21036c9090aec11faff", "message": "test: migrate version check test to typescript, replace eval with rewire", "committedDate": "2020-03-12T17:30:57Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTc4MjQyNw==", "url": "https://github.com/openequella/openEQUELLA/pull/1529#discussion_r391782427", "bodyText": "rewire allows access to non-exported variables, without needing to run eval.\nhttps://github.com/jhnns/rewire", "author": "ChristianMurphy", "createdAt": "2020-03-12T17:34:32Z", "path": "Source/Plugins/Core/com.equella.core/js/__tests__/versioncheck.test.ts", "diffHunk": "@@ -1,12 +1,8 @@\n-// versioncheck.js is not processed by Parcel and it only serves to the browser.\n-// So here need to read the file and then evaluate its content\n-const mockData = require(\"../__mocks__/versioncheck_mock_data\");\n-const fs = require(\"fs\");\n-const version_check_js_file = fs.readFileSync(\n-  \"../resources/web/js/versioncheck.js\",\n-  \"utf8\"\n-);\n-eval(version_check_js_file);\n+import * as mockData from \"../__mocks__/versioncheck_mock_data\";\n+import rewire = require(\"rewire\");\n+\n+const versioncheck = rewire(\"../../resources/web/js/versioncheck.js\");\n+const createCheckResult = versioncheck.__get__(\"createCheckResult\");", "originalCommit": "5a33aa18ae53874f8001b21036c9090aec11faff", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "4b82f0cebfc47cd9f5143a5951c988e9ff799276", "url": "https://github.com/openequella/openEQUELLA/commit/4b82f0cebfc47cd9f5143a5951c988e9ff799276", "message": "Merge branch 'develop' into test/utils", "committedDate": "2020-03-12T23:06:38Z", "type": "commit"}]}