{"pr_number": 2245, "pr_title": "Facet Selector integration", "pr_createdAt": "2020-08-28T07:16:21Z", "pr_url": "https://github.com/openequella/openEQUELLA/pull/2245", "timeline": [{"oid": "941f48c2957726fc3b3affc413a8f6124598d91e", "url": "https://github.com/openequella/openEQUELLA/commit/941f48c2957726fc3b3affc413a8f6124598d91e", "message": "Remove the starting '/xml' from selected Schema node.", "committedDate": "2020-08-27T22:54:00Z", "type": "commit"}, {"oid": "e61ae410f4d5893a6dc1f0a3219e1fec38f60f39", "url": "https://github.com/openequella/openEQUELLA/commit/e61ae410f4d5893a6dc1f0a3219e1fec38f60f39", "message": "Add a function to transform standard Classifications to Search page\nClassifications.", "committedDate": "2020-08-27T22:54:00Z", "type": "commit"}, {"oid": "9a1761a2781d3315bb65acd81ea730a4c41494d0", "url": "https://github.com/openequella/openEQUELLA/commit/9a1761a2781d3315bb65acd81ea730a4c41494d0", "message": "Update SearchOption to use Map as the type of 'classificationTerms'.", "committedDate": "2020-08-27T22:54:00Z", "type": "commit"}, {"oid": "276e2a0af1eeca73ece4ffc182b243d7837f4d5f", "url": "https://github.com/openequella/openEQUELLA/commit/276e2a0af1eeca73ece4ffc182b243d7837f4d5f", "message": "Integrate Facet Selector with Search page.", "committedDate": "2020-08-27T22:54:01Z", "type": "commit"}, {"oid": "522408b6707a150943bb6efd090a9e92b87b005d", "url": "https://github.com/openequella/openEQUELLA/commit/522408b6707a150943bb6efd090a9e92b87b005d", "message": "Update the type of Classification term Map in SearchOption", "committedDate": "2020-08-27T22:54:01Z", "type": "commit"}, {"oid": "c2d6ff6bf04ef718e49adfda4c415fd6cba9b4f9", "url": "https://github.com/openequella/openEQUELLA/commit/c2d6ff6bf04ef718e49adfda4c415fd6cba9b4f9", "message": "Move Facet Selector from Refine search panel to its own Card.", "committedDate": "2020-08-27T22:54:01Z", "type": "commit"}, {"oid": "6e28ce73e3fc82ef66918360b6dd56aebfd5a4cb", "url": "https://github.com/openequella/openEQUELLA/commit/6e28ce73e3fc82ef66918360b6dd56aebfd5a4cb", "message": "Allow to show less categories for each Classification.", "committedDate": "2020-08-27T22:54:01Z", "type": "commit"}, {"oid": "29e1cf199bf9202e2670a1b19d993037f307536f", "url": "https://github.com/openequella/openEQUELLA/commit/29e1cf199bf9202e2670a1b19d993037f307536f", "message": "Don't include Collections in a Facet search if Collection list is empty.", "committedDate": "2020-08-27T22:54:01Z", "type": "commit"}, {"oid": "ddaf4917a43381514f832b4ea2e78c257567592f", "url": "https://github.com/openequella/openEQUELLA/commit/ddaf4917a43381514f832b4ea2e78c257567592f", "message": "Make Classification's field 'maxDisplay' not optional.\n\nThe value of 'maxDisplay' returned from server won't be undefined. It\ncan be 0 if it's left empty in the facet configuration dialog. So let\nit be 10 if it's 0.", "committedDate": "2020-08-27T22:54:01Z", "type": "commit"}, {"oid": "261b9a6a420350fae655a0ecb1a41555bf57f2b4", "url": "https://github.com/openequella/openEQUELLA/commit/261b9a6a420350fae655a0ecb1a41555bf57f2b4", "message": "Only show the 'Show more' button when there are more categories to show.", "committedDate": "2020-08-27T22:54:01Z", "type": "commit"}, {"oid": "db5081a3f19401d8e6b38a58ce2ff4a6eb4942df", "url": "https://github.com/openequella/openEQUELLA/commit/db5081a3f19401d8e6b38a58ce2ff4a6eb4942df", "message": "Move selected categories to the top of the list.", "committedDate": "2020-08-27T22:54:01Z", "type": "commit"}, {"oid": "63da5f8b6ca09922b7df297f8f13ed526ad12406", "url": "https://github.com/openequella/openEQUELLA/commit/63da5f8b6ca09922b7df297f8f13ed526ad12406", "message": "Search page significant changes\n\n1. Changing either Search options or selected Terms will\n   update the Classification list.\n2. Changing Search options also remove all selected terms.\n3. When a search is performed is now dependent on the change\n   of selected terms.", "committedDate": "2020-08-27T22:54:01Z", "type": "commit"}, {"oid": "17554fce40cd3ff33b74b2a0f6cf2dd0a026b288", "url": "https://github.com/openequella/openEQUELLA/commit/17554fce40cd3ff33b74b2a0f6cf2dd0a026b288", "message": "Allow Facet Selector to manage 'Show more' in its own state.\n\nBy doing this, Show more buttons are no longer coupled to the\nSearch page. And there is no need to remember the status of\nthese buttons in history.", "committedDate": "2020-08-27T22:54:01Z", "type": "commit"}, {"oid": "67c1455dad871a52da769fa9de95d8d8365301eb", "url": "https://github.com/openequella/openEQUELLA/commit/67c1455dad871a52da769fa9de95d8d8365301eb", "message": "More changes on Search page state for Classification terms\n\n1. In the end we no longer need a separate state for terms\n   selected and move them back to Search options. This\n   significantly reduce the complexity of doing a new Search\n   and going back to Search page.\n2. Classification list now can be updated in two ways. One is\n   changing the old Search options (e.g. query and Collections).\n   The other way is selecting different terms, which is still\n   basically changing Search option. And the terms will be processed\n   to be part of the query for retrieving Classification categories.", "committedDate": "2020-08-27T22:54:01Z", "type": "commit"}, {"oid": "07b37d95efa741b81a75bb667c16e00003400230", "url": "https://github.com/openequella/openEQUELLA/commit/07b37d95efa741b81a75bb667c16e00003400230", "message": "Place the MUI Card for Facet Selector Search page.", "committedDate": "2020-08-27T22:54:01Z", "type": "commit"}, {"oid": "54f9e2c1c35ba503c5dd35bc6c568b99f4121bdf", "url": "https://github.com/openequella/openEQUELLA/commit/54f9e2c1c35ba503c5dd35bc6c568b99f4121bdf", "message": "Don't append a '*' to the query for facet search.", "committedDate": "2020-08-27T22:54:01Z", "type": "commit"}, {"oid": "4fc1aa1db95ed9c5f044827cf52b919c994b6dbd", "url": "https://github.com/openequella/openEQUELLA/commit/4fc1aa1db95ed9c5f044827cf52b919c994b6dbd", "message": "Tidy ups for Search page.", "committedDate": "2020-08-27T22:54:01Z", "type": "commit"}, {"oid": "8660e25fd29260f868f61b616c5f542531b4b17a", "url": "https://github.com/openequella/openEQUELLA/commit/8660e25fd29260f868f61b616c5f542531b4b17a", "message": "Refactor Facet Selector test and Storybook.", "committedDate": "2020-08-27T22:54:01Z", "type": "commit"}, {"oid": "3fea866dd5c8cc694eadb56be29cfad16a3f41c9", "url": "https://github.com/openequella/openEQUELLA/commit/3fea866dd5c8cc694eadb56be29cfad16a3f41c9", "message": "Update Search module test and Search Facet module test.", "committedDate": "2020-08-27T22:54:01Z", "type": "commit"}, {"oid": "63b8e4b93b2976ebec4c8f3c03e31b9c53cf5f17", "url": "https://github.com/openequella/openEQUELLA/commit/63b8e4b93b2976ebec4c8f3c03e31b9c53cf5f17", "message": "Bring the onchange handler of the Schema node field in\nFacet dialog.", "committedDate": "2020-08-27T22:54:01Z", "type": "commit"}, {"oid": "155d4a63219685f8e07d1e010297c4bcb53605fe", "url": "https://github.com/openequella/openEQUELLA/commit/155d4a63219685f8e07d1e010297c4bcb53605fe", "message": "Mock function 'listClassifications' in Search page test.", "committedDate": "2020-08-27T22:57:49Z", "type": "commit"}, {"oid": "460675cc0e287b6bdfed78836950efc6f8b00f5f", "url": "https://github.com/openequella/openEQUELLA/commit/460675cc0e287b6bdfed78836950efc6f8b00f5f", "message": "The query for facet search should be consistent with raw mode", "committedDate": "2020-08-28T00:34:29Z", "type": "commit"}, {"oid": "7dcbce0e7ae164a94c97adfae97db28b788b8069", "url": "https://github.com/openequella/openEQUELLA/commit/7dcbce0e7ae164a94c97adfae97db28b788b8069", "message": "Filter out empty Classification terms.", "committedDate": "2020-08-28T00:35:01Z", "type": "commit"}, {"oid": "fa885c0ec7993805ddf1e85ce64210d7ee93c7e6", "url": "https://github.com/openequella/openEQUELLA/commit/fa885c0ec7993805ddf1e85ce64210d7ee93c7e6", "message": "Use 'AND' to concatenate Classification terms.", "committedDate": "2020-08-28T00:36:16Z", "type": "commit"}, {"oid": "5abe5ecf589555a01cd2984d7acd1d49afcce1c7", "url": "https://github.com/openequella/openEQUELLA/commit/5abe5ecf589555a01cd2984d7acd1d49afcce1c7", "message": "Update the expected queries for Search module and SearchFacet module tests.", "committedDate": "2020-08-28T00:39:15Z", "type": "commit"}, {"oid": "dbc4736321b630548e8684667a6a0ad0440abd4a", "url": "https://github.com/openequella/openEQUELLA/commit/dbc4736321b630548e8684667a6a0ad0440abd4a", "message": "Integration tests for Facet Selector and Search page.", "committedDate": "2020-08-28T01:18:50Z", "type": "commit"}, {"oid": "aab91ec5c1b4d99d995619d7d7ea697ccb5ccf9b", "url": "https://github.com/openequella/openEQUELLA/commit/aab91ec5c1b4d99d995619d7d7ea697ccb5ccf9b", "message": "Use Schema node and terms to generate Where clause for search.", "committedDate": "2020-08-28T06:31:48Z", "type": "commit"}, {"oid": "5a22b1c50e2af525e594f72d85ec59787d971642", "url": "https://github.com/openequella/openEQUELLA/commit/5a22b1c50e2af525e594f72d85ec59787d971642", "message": "Update Jest tests, Storybook and mock data for the Where clause of search.", "committedDate": "2020-08-28T07:05:00Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTgzNzc2Mg==", "url": "https://github.com/openequella/openEQUELLA/pull/2245#discussion_r479837762", "bodyText": "Now this is controlled by the component's state so we don't need these two stories (the remaining stories can also show/hide the buttons. I also did some research about how to directly modify state with Storybook to and this seems not to be encouraged (and well supported).", "author": "PenghaiZhang", "createdAt": "2020-08-31T00:37:57Z", "path": "Source/Plugins/Core/com.equella.core/js/__stories__/search/FacetSelector.stories.tsx", "diffHunk": "@@ -58,17 +54,3 @@ termsSelected.args = {\n   ...noTermsSelected.args,\n   selectedClassificationTerms: selectedClassificationTerms,\n };\n-\n-export const showMore: Story<FacetSelectorProps> = FacetSelectorTemplate.bind(", "originalCommit": "5a22b1c50e2af525e594f72d85ec59787d971642", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTg0NDAxNA==", "url": "https://github.com/openequella/openEQUELLA/pull/2245#discussion_r479844014", "bodyText": "Yeah it's interesting, as ideally you'd have a different story for each state. However here the state can not be externally triggered other than by interactions.\nWith the state being internally managed though, does that mean when you click show more/show less in storybook it is now actually properly itnteractive?", "author": "edalex-ian", "createdAt": "2020-08-31T01:18:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTgzNzc2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDgwNTQ5OA==", "url": "https://github.com/openequella/openEQUELLA/pull/2245#discussion_r480805498", "bodyText": "Yes, they are interactive in storybook now.", "author": "PenghaiZhang", "createdAt": "2020-09-01T04:54:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTgzNzc2Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTgzODM4MQ==", "url": "https://github.com/openequella/openEQUELLA/pull/2245#discussion_r479838381", "bodyText": "Do we want to move this function outside ?", "author": "PenghaiZhang", "createdAt": "2020-08-31T00:42:32Z", "path": "Source/Plugins/Core/com.equella.core/js/tsrc/modules/SearchModule.ts", "diffHunk": "@@ -116,40 +116,32 @@ export const defaultPagedSearchResult: OEQ.Common.PagedResult<OEQ.Search.SearchR\n  * @param query the intended search query to be sent to the API\n  * @param addWildcard whether a wildcard should be appended\n  */\n-const formatQuery = (query: string, addWildcard: boolean): string => {\n+export const formatQuery = (query: string, addWildcard: boolean): string => {\n   const trimmedQuery = query ? query.trim() : \"\";\n   const appendWildcard = addWildcard && trimmedQuery.length > 0;\n   return trimmedQuery + (appendWildcard ? \"*\" : \"\");\n };\n \n /**\n- * This function processes the query put in the SearchBar and terms selected from Classifications.\n- * It firstly formats the query based on whether raw mode is on or off.\n- * If there are no Classifications terms selected, it returns the formatted query.\n- * Otherwise, it consolidates all terms into one Lucene query by OR, and combines the two queries\n- * by AND, and return the combined one.\n+ * Generates a Where clause for search. Each condition is linked by a AND.\n  *\n- * @param query The query put in the SearchBar.\n- * @param rawMode Whether raw mode is on or off.\n  * @param classificationTerms A list of selected Classification terms.\n  */\n-const processQuery = (\n-  query: string | undefined,\n-  rawMode: boolean,\n-  classificationTerms?: string[]\n+export const generateWhereQuery = (\n+  classificationTerms?: Map<number, NodeAndTerms>\n ): string | undefined => {\n-  // If query is undefined, then we want to keep 'undefined'; but otherwise let's pre-process it.\n-  const textQuery = query ? formatQuery(query, !rawMode) : undefined;\n-\n-  if (!classificationTerms || classificationTerms.length === 0) {\n-    return textQuery;\n+  if (!classificationTerms) {\n+    return undefined;\n   }\n \n-  const or = \" OR \";\n+  // Append '/xml' back to the schema node and generate a search condition for each term.\n+  const processNodeTerms = ({ node, terms }: NodeAndTerms) =>", "originalCommit": "5a22b1c50e2af525e594f72d85ec59787d971642", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTg0Nzg2NA==", "url": "https://github.com/openequella/openEQUELLA/pull/2245#discussion_r479847864", "bodyText": "I don't see any need yet.", "author": "edalex-ian", "createdAt": "2020-08-31T01:39:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTgzODM4MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTgzODkxNw==", "url": "https://github.com/openequella/openEQUELLA/pull/2245#discussion_r479838917", "bodyText": "Separate the update of Classification list from the first useEffect to help understand the logic more easily.", "author": "PenghaiZhang", "createdAt": "2020-08-31T00:46:11Z", "path": "Source/Plugins/Core/com.equella.core/js/tsrc/search/SearchPage.tsx", "diffHunk": "@@ -115,6 +120,15 @@ const SearchPage = ({ updateTemplate }: TemplateUpdateProps) => {\n     }\n   }, [searchPageOptions]);\n \n+  // When Search options get changed, also update the Classification list.\n+  useEffect(() => {\n+    if (!isInitialSearch.current) {\n+      listClassifications(searchPageOptions).then((classifications) =>\n+        setClassifications(classifications)\n+      );\n+    }\n+  }, [searchPageOptions]);", "originalCommit": "5a22b1c50e2af525e594f72d85ec59787d971642", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTgzOTU0MA==", "url": "https://github.com/openequella/openEQUELLA/pull/2245#discussion_r479839540", "bodyText": "You will see more classificationTerms: undefined, below, but the benefit of doing this is we don't need to put  classificationTerms into state, which does not break 'New search' and 'Back to Search page'. So I feel the repeating is fine.", "author": "PenghaiZhang", "createdAt": "2020-08-31T00:50:27Z", "path": "Source/Plugins/Core/com.equella.core/js/tsrc/search/SearchPage.tsx", "diffHunk": "@@ -143,13 +157,15 @@ const SearchPage = ({ updateTemplate }: TemplateUpdateProps) => {\n       ...searchPageOptions,\n       query: query,\n       currentPage: 0,\n+      classificationTerms: undefined,", "originalCommit": "5a22b1c50e2af525e594f72d85ec59787d971642", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTg4Nzg1Nw==", "url": "https://github.com/openequella/openEQUELLA/pull/2245#discussion_r479887857", "bodyText": "These two language strings will likely be used throughout the app. They should probably go inside languageStrings.common.action", "author": "mrblippy", "createdAt": "2020-08-31T04:57:30Z", "path": "Source/Plugins/Core/com.equella.core/js/__tests__/tsrc/search/components/FacetSelector.test.tsx", "diffHunk": "@@ -41,16 +40,19 @@ describe(\"<FacetSelector />\", () => {\n   const COLOR = \"Color\";\n   // Mocked facet\n   const HOBART = \"Hobart\";\n-  const mockedSelectedTerms = new Map([[CITY_ID, [HOBART]]]);\n-  // The text of 'SHOW MORE' button\n+  const SCHEMA_NODE = \"item/city\";\n+  const mockedSelectedTerms = new Map([\n+    [CITY_ID, { node: SCHEMA_NODE, terms: [HOBART] }],\n+  ]);\n+  // The text of 'SHOW MORE' and 'SHOW LESS' buttons\n   const SHOW_MORE = languageStrings.searchpage.facetSelector.showMoreButton;\n+  const SHOW_LESS = languageStrings.searchpage.facetSelector.showLessButton;", "originalCommit": "5a22b1c50e2af525e594f72d85ec59787d971642", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTkxMDc2MQ==", "url": "https://github.com/openequella/openEQUELLA/pull/2245#discussion_r479910761", "bodyText": "I pondered this too. Then I was wondering... What if people do want to control the text differently specifically on these buttons (vs. other show more/less buttons). If we want to support that, we'd want to keep it specific like this.\nWhat do peeps think?", "author": "edalex-ian", "createdAt": "2020-08-31T06:00:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTg4Nzg1Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjY0NDQ0OQ==", "url": "https://github.com/openequella/openEQUELLA/pull/2245#discussion_r482644449", "bodyText": "I prefer they stay here \ud83d\ude04 , what about other peeps ?", "author": "PenghaiZhang", "createdAt": "2020-09-03T01:48:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTg4Nzg1Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjcwMjM0OQ==", "url": "https://github.com/openequella/openEQUELLA/pull/2245#discussion_r482702349", "bodyText": "I see @mrblippy changed them over in his PR. So I'll leave it for you guys to reach agreement. ;)", "author": "edalex-ian", "createdAt": "2020-09-03T04:51:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTg4Nzg1Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTg5MTgxOQ==", "url": "https://github.com/openequella/openEQUELLA/pull/2245#discussion_r479891819", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            import { Classification } from \"../tsrc/modules/SearchFacetsModule\";\n          \n          \n            \n            import type { Classification } from \"../tsrc/modules/SearchFacetsModule\";", "author": "SammyIsConfused", "createdAt": "2020-08-31T05:15:01Z", "path": "Source/Plugins/Core/com.equella.core/js/__mocks__/FacetSelector.mock.ts", "diffHunk": "@@ -15,9 +15,10 @@\n  * See the License for the specific language governing permissions and\n  * limitations under the License.\n  */\n-import type { SearchPageClassification } from \"../tsrc/search/components/FacetSelector\";\n \n-export const classifications: SearchPageClassification[] = [\n+import { Classification } from \"../tsrc/modules/SearchFacetsModule\";", "originalCommit": "5a22b1c50e2af525e594f72d85ec59787d971642", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDgwOTgyOQ==", "url": "https://github.com/openequella/openEQUELLA/pull/2245#discussion_r480809829", "bodyText": "Thanks Sam. I always forget this \ud83d\ude25", "author": "PenghaiZhang", "createdAt": "2020-09-01T04:59:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTg5MTgxOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTg5MjYxNQ==", "url": "https://github.com/openequella/openEQUELLA/pull/2245#discussion_r479892615", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n               * The configured Schema node of this classification.\n          \n          \n            \n               * The configured schema node of this classification.", "author": "SammyIsConfused", "createdAt": "2020-08-31T05:18:03Z", "path": "Source/Plugins/Core/com.equella.core/js/tsrc/modules/SearchFacetsModule.ts", "diffHunk": "@@ -49,6 +49,10 @@ export interface Classification {\n    * The configured order in which this classification should be displayed.\n    */\n   orderIndex: number;\n+  /**\n+   * The configured Schema node of this classification.", "originalCommit": "5a22b1c50e2af525e594f72d85ec59787d971642", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTg5MjgzNA==", "url": "https://github.com/openequella/openEQUELLA/pull/2245#discussion_r479892834", "bodyText": "I'd suggest you rename i to something more meaningful.", "author": "SammyIsConfused", "createdAt": "2020-08-31T05:19:08Z", "path": "Source/Plugins/Core/com.equella.core/js/tsrc/modules/SearchFacetsModule.ts", "diffHunk": "@@ -59,18 +63,36 @@ export interface Classification {\n const convertSearchOptions: (\n   options: SearchOptions\n ) => OEQ.SearchFacets.SearchFacetsParams = memoize(\n-  (options: SearchOptions): OEQ.SearchFacets.SearchFacetsParams => ({\n-    nodes: [],\n-    q: options.query,\n-    collections: options.collections?.map((c) => c.uuid),\n-    modifiedAfter: getISODateString(options.lastModifiedDateRange?.start),\n-    modifiedBefore: getISODateString(options.lastModifiedDateRange?.end),\n-    owner: options.owner?.id,\n-    showall: isEqual(\n-      options.status?.sort(),\n-      OEQ.Common.ItemStatuses.alternatives.map((i) => i.value).sort()\n-    ),\n-  })\n+  (options: SearchOptions): OEQ.SearchFacets.SearchFacetsParams => {\n+    const {\n+      query,\n+      collections,\n+      lastModifiedDateRange,\n+      owner,\n+      status,\n+      classificationTerms,\n+      rawMode,\n+    } = options;\n+    let searchFacetsParams: OEQ.SearchFacets.SearchFacetsParams = {\n+      nodes: [],\n+      q: query ? formatQuery(query, !rawMode) : undefined,\n+      modifiedAfter: getISODateString(lastModifiedDateRange?.start),\n+      modifiedBefore: getISODateString(lastModifiedDateRange?.end),\n+      owner: owner?.id,\n+      showall: isEqual(\n+        status?.sort(),\n+        OEQ.Common.ItemStatuses.alternatives.map((i) => i.value).sort()", "originalCommit": "5a22b1c50e2af525e594f72d85ec59787d971642", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTg5MjkxNg==", "url": "https://github.com/openequella/openEQUELLA/pull/2245#discussion_r479892916", "bodyText": "I'd suggest you rename c to something more meaningful.", "author": "SammyIsConfused", "createdAt": "2020-08-31T05:19:29Z", "path": "Source/Plugins/Core/com.equella.core/js/tsrc/modules/SearchFacetsModule.ts", "diffHunk": "@@ -59,18 +63,36 @@ export interface Classification {\n const convertSearchOptions: (\n   options: SearchOptions\n ) => OEQ.SearchFacets.SearchFacetsParams = memoize(\n-  (options: SearchOptions): OEQ.SearchFacets.SearchFacetsParams => ({\n-    nodes: [],\n-    q: options.query,\n-    collections: options.collections?.map((c) => c.uuid),\n-    modifiedAfter: getISODateString(options.lastModifiedDateRange?.start),\n-    modifiedBefore: getISODateString(options.lastModifiedDateRange?.end),\n-    owner: options.owner?.id,\n-    showall: isEqual(\n-      options.status?.sort(),\n-      OEQ.Common.ItemStatuses.alternatives.map((i) => i.value).sort()\n-    ),\n-  })\n+  (options: SearchOptions): OEQ.SearchFacets.SearchFacetsParams => {\n+    const {\n+      query,\n+      collections,\n+      lastModifiedDateRange,\n+      owner,\n+      status,\n+      classificationTerms,\n+      rawMode,\n+    } = options;\n+    let searchFacetsParams: OEQ.SearchFacets.SearchFacetsParams = {\n+      nodes: [],\n+      q: query ? formatQuery(query, !rawMode) : undefined,\n+      modifiedAfter: getISODateString(lastModifiedDateRange?.start),\n+      modifiedBefore: getISODateString(lastModifiedDateRange?.end),\n+      owner: owner?.id,\n+      showall: isEqual(\n+        status?.sort(),\n+        OEQ.Common.ItemStatuses.alternatives.map((i) => i.value).sort()\n+      ),\n+      where: generateWhereQuery(classificationTerms),\n+    };\n+    if (collections && collections.length > 0) {\n+      searchFacetsParams = {\n+        ...searchFacetsParams,\n+        collections: collections.map((c) => c.uuid),", "originalCommit": "5a22b1c50e2af525e594f72d85ec59787d971642", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTg5Nzc1MQ==", "url": "https://github.com/openequella/openEQUELLA/pull/2245#discussion_r479897751", "bodyText": "Single character is okay if it's in close context - like here and below in single use anonymous functions. So these are all good. \ud83d\udc4d", "author": "edalex-ian", "createdAt": "2020-08-31T05:37:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTg5MjkxNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTkyNzI5NQ==", "url": "https://github.com/openequella/openEQUELLA/pull/2245#discussion_r479927295", "bodyText": "Sure thing! I'll resolve them.", "author": "SammyIsConfused", "createdAt": "2020-08-31T06:45:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTg5MjkxNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTg5Mjk5MQ==", "url": "https://github.com/openequella/openEQUELLA/pull/2245#discussion_r479892991", "bodyText": "As above - single letter identifier.", "author": "SammyIsConfused", "createdAt": "2020-08-31T05:19:48Z", "path": "Source/Plugins/Core/com.equella.core/js/tsrc/modules/SearchFacetsModule.ts", "diffHunk": "@@ -81,7 +103,9 @@ const convertSearchOptions: (\n export const listCategories = async (\n   options: OEQ.SearchFacets.SearchFacetsParams\n ): Promise<OEQ.SearchFacets.Facet[]> =>\n-  (await OEQ.SearchFacets.searchFacets(API_BASE_URL, options)).results;\n+  (await OEQ.SearchFacets.searchFacets(API_BASE_URL, options)).results.filter(\n+    (r) => r.term", "originalCommit": "5a22b1c50e2af525e594f72d85ec59787d971642", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTg5MzI5Mg==", "url": "https://github.com/openequella/openEQUELLA/pull/2245#discussion_r479893292", "bodyText": "As above.", "author": "SammyIsConfused", "createdAt": "2020-08-31T05:21:09Z", "path": "Source/Plugins/Core/com.equella.core/js/tsrc/modules/SearchModule.ts", "diffHunk": "@@ -116,40 +116,32 @@ export const defaultPagedSearchResult: OEQ.Common.PagedResult<OEQ.Search.SearchR\n  * @param query the intended search query to be sent to the API\n  * @param addWildcard whether a wildcard should be appended\n  */\n-const formatQuery = (query: string, addWildcard: boolean): string => {\n+export const formatQuery = (query: string, addWildcard: boolean): string => {\n   const trimmedQuery = query ? query.trim() : \"\";\n   const appendWildcard = addWildcard && trimmedQuery.length > 0;\n   return trimmedQuery + (appendWildcard ? \"*\" : \"\");\n };\n \n /**\n- * This function processes the query put in the SearchBar and terms selected from Classifications.\n- * It firstly formats the query based on whether raw mode is on or off.\n- * If there are no Classifications terms selected, it returns the formatted query.\n- * Otherwise, it consolidates all terms into one Lucene query by OR, and combines the two queries\n- * by AND, and return the combined one.\n+ * Generates a Where clause for search. Each condition is linked by a AND.\n  *\n- * @param query The query put in the SearchBar.\n- * @param rawMode Whether raw mode is on or off.\n  * @param classificationTerms A list of selected Classification terms.\n  */\n-const processQuery = (\n-  query: string | undefined,\n-  rawMode: boolean,\n-  classificationTerms?: string[]\n+export const generateWhereQuery = (\n+  classificationTerms?: Map<number, NodeAndTerms>\n ): string | undefined => {\n-  // If query is undefined, then we want to keep 'undefined'; but otherwise let's pre-process it.\n-  const textQuery = query ? formatQuery(query, !rawMode) : undefined;\n-\n-  if (!classificationTerms || classificationTerms.length === 0) {\n-    return textQuery;\n+  if (!classificationTerms) {\n+    return undefined;\n   }\n \n-  const or = \" OR \";\n+  // Append '/xml' back to the schema node and generate a search condition for each term.\n+  const processNodeTerms = ({ node, terms }: NodeAndTerms) =>\n+    terms.map((t) => `/xml${node}='${t}'`);", "originalCommit": "5a22b1c50e2af525e594f72d85ec59787d971642", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTg5Mzk1Ng==", "url": "https://github.com/openequella/openEQUELLA/pull/2245#discussion_r479893956", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n               * Create a button to help show more/less categories for each Classification.\n          \n          \n            \n               * Create a button to show more/less categories for each Classification.", "author": "SammyIsConfused", "createdAt": "2020-08-31T05:23:49Z", "path": "Source/Plugins/Core/com.equella.core/js/tsrc/search/components/FacetSelector.tsx", "diffHunk": "@@ -39,78 +39,98 @@ const useStyles = makeStyles({\n });\n \n /**\n- * Represents a Classification that is specific to Search page.\n+ * Represent a schema node and a list of terms.\n  */\n-export interface SearchPageClassification extends Classification {\n+export interface NodeAndTerms {\n   /**\n-   * A boolean indicating if a classification has hidden categories to show.\n+   * One Schema node.\n    */\n-  showMore: boolean;\n+  node: string;\n+  /**\n+   * Terms related to this node.\n+   */\n+  terms: string[];\n }\n \n export interface FacetSelectorProps {\n   /**\n    * A list of Classifications.\n    */\n-  classifications: SearchPageClassification[];\n+  classifications: Classification[];\n   /**\n    * A map where the key is a Classification's ID and value is\n    * a list of terms.\n    */\n-  selectedClassificationTerms?: Map<number, string[]>;\n+  selectedClassificationTerms?: Map<number, NodeAndTerms>;\n   /**\n    * Handler for selecting/deselecting Classification terms.\n    * @param terms A list of currently selected terms.\n    */\n-  onSelectTermsChange: (terms: Map<number, string[]>) => void;\n-  /**\n-   * Handler for clicking a 'SHOW MORE' button.\n-   * @param classificationName The name of a Classification.\n-   */\n-  onShowMore: (classificationID: number) => void;\n+  onSelectTermsChange: (terms: Map<number, NodeAndTerms>) => void;\n }\n \n export const FacetSelector = ({\n   classifications,\n   selectedClassificationTerms,\n   onSelectTermsChange,\n-  onShowMore,\n }: FacetSelectorProps) => {\n   const classes = useStyles();\n+  const [showMoreMap, setShowMoreMap] = useState<Map<number, boolean>>(\n+    new Map(classifications.map((classification) => [classification.id, true]))\n+  );\n \n+  const onShowMore = (classificationID: number, showMore: boolean) => {\n+    const copiedMap = new Map(showMoreMap);\n+    copiedMap.set(classificationID, showMore);\n+    setShowMoreMap(copiedMap);\n+  };\n   /**\n    * Updates the list of selected Classification terms. If the term exists then remove it\n    * from the list. Add it to the list otherwise.\n    * A copy of the map and a copy of the array of terms are created internally\n    * to avoid mutating parent component's state.\n    *\n    * @param classificationID The ID of a Classification\n+   * @param schemaNode The Schema node of a Classification\n    * @param term The selected or unselected term\n    */\n-  const handleSelectTerms = (classificationID: number, term: string) => {\n-    const terms = selectedClassificationTerms?.get(classificationID);\n-    const copiedTerms = terms ? [...terms] : [];\n+  const handleSelectTerms = (\n+    classificationID: number,\n+    schemaNode: string,\n+    term: string\n+  ) => {\n+    const nodeAndTerms = selectedClassificationTerms?.get(classificationID);\n+    const copiedTerms = nodeAndTerms ? [...nodeAndTerms.terms] : [];\n     const termIndex = copiedTerms.indexOf(term);\n     if (termIndex === -1) {\n       copiedTerms.push(term);\n     } else {\n       copiedTerms.splice(termIndex, 1);\n     }\n     const copiedMap = new Map(selectedClassificationTerms ?? []);\n-    copiedMap.set(classificationID, copiedTerms);\n+    copiedMap.set(classificationID, { node: schemaNode, terms: copiedTerms });\n     onSelectTermsChange(copiedMap);\n   };\n \n   /**\n-   * Render a 'SHOW MORE' button for each Classification.\n+   * Create a button to help show more/less categories for each Classification.", "originalCommit": "5a22b1c50e2af525e594f72d85ec59787d971642", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTg5NDA4Nw==", "url": "https://github.com/openequella/openEQUELLA/pull/2245#discussion_r479894087", "bodyText": "As above.", "author": "SammyIsConfused", "createdAt": "2020-08-31T05:24:23Z", "path": "Source/Plugins/Core/com.equella.core/js/tsrc/search/components/FacetSelector.tsx", "diffHunk": "@@ -171,19 +195,27 @@ export const FacetSelector = ({\n    *\n    * @param id The ID of a Classification\n    * @param categories A list of terms to build into a list\n-   * @param showMore Whether to show more facets or not\n+   * @param schemaNode The Schema node of a Classification\n    * @param maxDisplay Default maximum number of displayed facets\n+   * @param showMore Whether to show more facets or not\n    */\n-  const listCategories = ({\n-    id,\n-    categories,\n-    showMore,\n-    maxDisplay,\n-  }: SearchPageClassification): ReactElement[] =>\n-    categories\n+  const listCategories = (\n+    { id, categories, schemaNode, maxDisplay }: Classification,\n+    showMore: boolean\n+  ): ReactElement[] => {\n+    const selectedTerms = selectedClassificationTerms?.get(id)?.terms ?? [];\n+    const selectedCategories = categories.filter((c) =>", "originalCommit": "5a22b1c50e2af525e594f72d85ec59787d971642", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTg5NDE1Mw==", "url": "https://github.com/openequella/openEQUELLA/pull/2245#discussion_r479894153", "bodyText": "As above.", "author": "SammyIsConfused", "createdAt": "2020-08-31T05:24:37Z", "path": "Source/Plugins/Core/com.equella.core/js/tsrc/search/components/FacetSelector.tsx", "diffHunk": "@@ -171,19 +195,27 @@ export const FacetSelector = ({\n    *\n    * @param id The ID of a Classification\n    * @param categories A list of terms to build into a list\n-   * @param showMore Whether to show more facets or not\n+   * @param schemaNode The Schema node of a Classification\n    * @param maxDisplay Default maximum number of displayed facets\n+   * @param showMore Whether to show more facets or not\n    */\n-  const listCategories = ({\n-    id,\n-    categories,\n-    showMore,\n-    maxDisplay,\n-  }: SearchPageClassification): ReactElement[] =>\n-    categories\n+  const listCategories = (\n+    { id, categories, schemaNode, maxDisplay }: Classification,\n+    showMore: boolean\n+  ): ReactElement[] => {\n+    const selectedTerms = selectedClassificationTerms?.get(id)?.terms ?? [];\n+    const selectedCategories = categories.filter((c) =>\n+      selectedTerms.includes(c.term)\n+    );\n+    const unselectedCategories = categories.filter(\n+      (c) => !selectedTerms.includes(c.term)", "originalCommit": "5a22b1c50e2af525e594f72d85ec59787d971642", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTg5NDI4Mw==", "url": "https://github.com/openequella/openEQUELLA/pull/2245#discussion_r479894283", "bodyText": "These should probably be common strings.", "author": "SammyIsConfused", "createdAt": "2020-08-31T05:25:04Z", "path": "Source/Plugins/Core/com.equella.core/js/tsrc/util/langstrings.ts", "diffHunk": "@@ -339,7 +339,9 @@ export const languageStrings = {\n       day: \"Day\",\n     },\n     facetSelector: {\n+      title: \"Classifications\",\n       showMoreButton: \"Show more\",\n+      showLessButton: \"Show less\",", "originalCommit": "5a22b1c50e2af525e594f72d85ec59787d971642", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTg0NDI5Mg==", "url": "https://github.com/openequella/openEQUELLA/pull/2245#discussion_r479844292", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              it(\"should generate a Where clause for schema node and terms\", () => {\n          \n          \n            \n              it(\"should generate a where clause for schema node and terms\", () => {\n          \n      \n    \n    \n  \n\n.... Actually.... This test sits weird. Let's look at the bigger picture of SearchModule.test.ts....\nWe have a single describe block of describe( \"SearchModule\" ) where all the tests have mainly been about calling the primary function of searchItems. However, now that we have an additional function maybe we need to rework the structure here to make sense. For example:\n\n\ndescribe: searchItems\n\nit: lists items\nit: will not do a wildcard search if the query is empty\nit: does a wildcard search if the query is non-empty and rawMode is false\nit: will not do a wildcard search when rawMode is true\n\n\n\ndescribe: generateWhereQuery\n\nit: returns a where query built from supplied schema nodes and terms\n\n\n\n(One thing that then jumps out at me, is the naming of that new function is probably too abstract - as it only generates a rather specific type of where query. I'll try to comment on that again where the new function is.)", "author": "edalex-ian", "createdAt": "2020-08-31T01:20:10Z", "path": "Source/Plugins/Core/com.equella.core/js/__tests__/tsrc/modules/SearchModule.test.ts", "diffHunk": "@@ -69,28 +70,14 @@ describe(\"SearchModule\", () => {\n     validateSearchQuery(`${queryTerm}`);\n   });\n \n-  it(\"should append Classification terms to query if one or more Classifications are selected\", async () => {\n+  it(\"should generate a Where clause for schema node and terms\", () => {", "originalCommit": "5a22b1c50e2af525e594f72d85ec59787d971642", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTg0NDg4MQ==", "url": "https://github.com/openequella/openEQUELLA/pull/2245#discussion_r479844881", "bodyText": "Should just use the below wildcard import and then call SearchModule.generateWhereQuery().", "author": "edalex-ian", "createdAt": "2020-08-31T01:23:11Z", "path": "Source/Plugins/Core/com.equella.core/js/__tests__/tsrc/modules/SearchModule.test.ts", "diffHunk": "@@ -16,6 +16,7 @@\n  * limitations under the License.\n  */\n import * as OEQ from \"@openequella/rest-api-client\";\n+import { generateWhereQuery } from \"../../../tsrc/modules/SearchModule\";", "originalCommit": "5a22b1c50e2af525e594f72d85ec59787d971642", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTg0NzIwNA==", "url": "https://github.com/openequella/openEQUELLA/pull/2245#discussion_r479847204", "bodyText": "Oooh, this is not ideal is it. We're setting up rather tight coupling here between our business logic layers and our presentation layers. NodeAndTerms should probably belong here if we need them here, or at least be broken out from a UI component. (And I note the same for the general DateRange below.)", "author": "edalex-ian", "createdAt": "2020-08-31T01:35:35Z", "path": "Source/Plugins/Core/com.equella.core/js/tsrc/modules/SearchModule.ts", "diffHunk": "@@ -17,6 +17,7 @@\n  */\n import * as OEQ from \"@openequella/rest-api-client\";\n import { API_BASE_URL } from \"../config\";\n+import { NodeAndTerms } from \"../search/components/FacetSelector\";", "originalCommit": "5a22b1c50e2af525e594f72d85ec59787d971642", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjY4OTg1Mg==", "url": "https://github.com/openequella/openEQUELLA/pull/2245#discussion_r482689852", "bodyText": "I agree. I also feel DateRange should be sitting in a utility module because it's not specific to Search page.", "author": "PenghaiZhang", "createdAt": "2020-09-03T04:02:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTg0NzIwNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTg0NzM3Ng==", "url": "https://github.com/openequella/openEQUELLA/pull/2245#discussion_r479847376", "bodyText": "It would be worthwhile highlighting what the number (i.e. key) value is representing.", "author": "edalex-ian", "createdAt": "2020-08-31T01:36:17Z", "path": "Source/Plugins/Core/com.equella.core/js/tsrc/modules/SearchModule.ts", "diffHunk": "@@ -64,10 +65,9 @@ export interface SearchOptions {\n    */\n   status?: OEQ.Common.ItemStatus[];\n   /**\n-   * A list of classification terms. (Typically a subset of those generated by\n-   * Search Facets.)\n+   * A map of selected Classifications and their terms.", "originalCommit": "5a22b1c50e2af525e594f72d85ec59787d971642", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTg0ODA5Mw==", "url": "https://github.com/openequella/openEQUELLA/pull/2245#discussion_r479848093", "bodyText": "Should add a test for this. There's currently only the positive test. (Oh, actually I think there's only a test for when there are multiple queries. Ideally there should be a test which covers none, one and greater than one.)", "author": "edalex-ian", "createdAt": "2020-08-31T01:40:12Z", "path": "Source/Plugins/Core/com.equella.core/js/tsrc/modules/SearchModule.ts", "diffHunk": "@@ -116,40 +116,32 @@ export const defaultPagedSearchResult: OEQ.Common.PagedResult<OEQ.Search.SearchR\n  * @param query the intended search query to be sent to the API\n  * @param addWildcard whether a wildcard should be appended\n  */\n-const formatQuery = (query: string, addWildcard: boolean): string => {\n+export const formatQuery = (query: string, addWildcard: boolean): string => {\n   const trimmedQuery = query ? query.trim() : \"\";\n   const appendWildcard = addWildcard && trimmedQuery.length > 0;\n   return trimmedQuery + (appendWildcard ? \"*\" : \"\");\n };\n \n /**\n- * This function processes the query put in the SearchBar and terms selected from Classifications.\n- * It firstly formats the query based on whether raw mode is on or off.\n- * If there are no Classifications terms selected, it returns the formatted query.\n- * Otherwise, it consolidates all terms into one Lucene query by OR, and combines the two queries\n- * by AND, and return the combined one.\n+ * Generates a Where clause for search. Each condition is linked by a AND.\n  *\n- * @param query The query put in the SearchBar.\n- * @param rawMode Whether raw mode is on or off.\n  * @param classificationTerms A list of selected Classification terms.\n  */\n-const processQuery = (\n-  query: string | undefined,\n-  rawMode: boolean,\n-  classificationTerms?: string[]\n+export const generateWhereQuery = (\n+  classificationTerms?: Map<number, NodeAndTerms>\n ): string | undefined => {\n-  // If query is undefined, then we want to keep 'undefined'; but otherwise let's pre-process it.\n-  const textQuery = query ? formatQuery(query, !rawMode) : undefined;\n-\n-  if (!classificationTerms || classificationTerms.length === 0) {\n-    return textQuery;\n+  if (!classificationTerms) {\n+    return undefined;\n   }", "originalCommit": "5a22b1c50e2af525e594f72d85ec59787d971642", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTg0ODY2NA==", "url": "https://github.com/openequella/openEQUELLA/pull/2245#discussion_r479848664", "bodyText": "This needs a more specific name - as it's not a generic where clause builder. It also contains logic specific to how we want to query with selected facets/categories.\nMaybe:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            export const generateWhereQuery = (\n          \n          \n            \n            export const generateFacetedWhereQuery = (", "author": "edalex-ian", "createdAt": "2020-08-31T01:43:32Z", "path": "Source/Plugins/Core/com.equella.core/js/tsrc/modules/SearchModule.ts", "diffHunk": "@@ -116,40 +116,32 @@ export const defaultPagedSearchResult: OEQ.Common.PagedResult<OEQ.Search.SearchR\n  * @param query the intended search query to be sent to the API\n  * @param addWildcard whether a wildcard should be appended\n  */\n-const formatQuery = (query: string, addWildcard: boolean): string => {\n+export const formatQuery = (query: string, addWildcard: boolean): string => {\n   const trimmedQuery = query ? query.trim() : \"\";\n   const appendWildcard = addWildcard && trimmedQuery.length > 0;\n   return trimmedQuery + (appendWildcard ? \"*\" : \"\");\n };\n \n /**\n- * This function processes the query put in the SearchBar and terms selected from Classifications.\n- * It firstly formats the query based on whether raw mode is on or off.\n- * If there are no Classifications terms selected, it returns the formatted query.\n- * Otherwise, it consolidates all terms into one Lucene query by OR, and combines the two queries\n- * by AND, and return the combined one.\n+ * Generates a Where clause for search. Each condition is linked by a AND.\n  *\n- * @param query The query put in the SearchBar.\n- * @param rawMode Whether raw mode is on or off.\n  * @param classificationTerms A list of selected Classification terms.\n  */\n-const processQuery = (\n-  query: string | undefined,\n-  rawMode: boolean,\n-  classificationTerms?: string[]\n+export const generateWhereQuery = (", "originalCommit": "5a22b1c50e2af525e594f72d85ec59787d971642", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTg0ODgzMQ==", "url": "https://github.com/openequella/openEQUELLA/pull/2245#discussion_r479848831", "bodyText": "This method does not really care about the key for this map, so should it just be:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              classificationTerms?: Map<number, NodeAndTerms>\n          \n          \n            \n              classificationTerms?: NodeAndTerms[]", "author": "edalex-ian", "createdAt": "2020-08-31T01:44:34Z", "path": "Source/Plugins/Core/com.equella.core/js/tsrc/modules/SearchModule.ts", "diffHunk": "@@ -116,40 +116,32 @@ export const defaultPagedSearchResult: OEQ.Common.PagedResult<OEQ.Search.SearchR\n  * @param query the intended search query to be sent to the API\n  * @param addWildcard whether a wildcard should be appended\n  */\n-const formatQuery = (query: string, addWildcard: boolean): string => {\n+export const formatQuery = (query: string, addWildcard: boolean): string => {\n   const trimmedQuery = query ? query.trim() : \"\";\n   const appendWildcard = addWildcard && trimmedQuery.length > 0;\n   return trimmedQuery + (appendWildcard ? \"*\" : \"\");\n };\n \n /**\n- * This function processes the query put in the SearchBar and terms selected from Classifications.\n- * It firstly formats the query based on whether raw mode is on or off.\n- * If there are no Classifications terms selected, it returns the formatted query.\n- * Otherwise, it consolidates all terms into one Lucene query by OR, and combines the two queries\n- * by AND, and return the combined one.\n+ * Generates a Where clause for search. Each condition is linked by a AND.\n  *\n- * @param query The query put in the SearchBar.\n- * @param rawMode Whether raw mode is on or off.\n  * @param classificationTerms A list of selected Classification terms.\n  */\n-const processQuery = (\n-  query: string | undefined,\n-  rawMode: boolean,\n-  classificationTerms?: string[]\n+export const generateWhereQuery = (\n+  classificationTerms?: Map<number, NodeAndTerms>", "originalCommit": "5a22b1c50e2af525e594f72d85ec59787d971642", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTg0OTUwOA==", "url": "https://github.com/openequella/openEQUELLA/pull/2245#discussion_r479849508", "bodyText": "For readability, could you please type this Map. I think it's:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                const terms = new Map([\n          \n          \n            \n                const terms = new Map<number, NodeAndTerms>([", "author": "edalex-ian", "createdAt": "2020-08-31T01:48:19Z", "path": "Source/Plugins/Core/com.equella.core/js/__tests__/tsrc/modules/SearchModule.test.ts", "diffHunk": "@@ -69,28 +70,14 @@ describe(\"SearchModule\", () => {\n     validateSearchQuery(`${queryTerm}`);\n   });\n \n-  it(\"should append Classification terms to query if one or more Classifications are selected\", async () => {\n+  it(\"should generate a Where clause for schema node and terms\", () => {\n     mockedSearch.mockReset();\n-    const query = \"technology\";\n-    const terms = [\"Java\", \"Scala\", \"SBT\"];\n-    await SearchModule.searchItems({\n-      ...SearchModule.defaultSearchOptions,\n-      query: query,\n-      rawMode: false,\n-      classificationTerms: terms,\n-    });\n-    validateSearchQuery(`${query}* AND (Java OR Scala OR SBT)`);\n-  });\n-\n-  it(\"should just send terms to server if query is empty\", async () => {\n-    mockedSearch.mockReset();\n-    const terms = [\"Java\", \"Scala\"];\n-    await SearchModule.searchItems({\n-      ...SearchModule.defaultSearchOptions,\n-      query: undefined,\n-      rawMode: false,\n-      classificationTerms: terms,\n-    });\n-    validateSearchQuery(\"(Java OR Scala)\");\n+    const terms = new Map([", "originalCommit": "5a22b1c50e2af525e594f72d85ec59787d971642", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTg0OTc1MA==", "url": "https://github.com/openequella/openEQUELLA/pull/2245#discussion_r479849750", "bodyText": "If this is only used in one describe block (as it is), then best to just scope it into that block.\nAlso, the CLASSIFICATION_ID and SCHEMA_NODE variables seem largely redundant. And again, please type this map for readability.", "author": "edalex-ian", "createdAt": "2020-08-31T01:49:43Z", "path": "Source/Plugins/Core/com.equella.core/js/__tests__/tsrc/search/SearchPage.test.tsx", "diffHunk": "@@ -77,6 +84,12 @@ const defaultSearchPageOptions: SearchPageOptions = {\n const defaultCollectionPrivileges = [\"SEARCH_COLLECTION\"];\n \n const SORTORDER_SELECT_ID = \"#sort-order-select\";\n+const JAVA_TERM = \"java\";\n+const CLASSIFICATION_ID = 766942;\n+const SCHEMA_NODE = \"item/language\";\n+const termsMap = new Map([\n+  [CLASSIFICATION_ID, { node: SCHEMA_NODE, terms: [JAVA_TERM] }],\n+]);", "originalCommit": "5a22b1c50e2af525e594f72d85ec59787d971642", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTg1MDIxNA==", "url": "https://github.com/openequella/openEQUELLA/pull/2245#discussion_r479850214", "bodyText": "Seeing this is global, and 'term' is rather generic, you may want to go with a more specific name:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            const selectTerm = (container: HTMLElement, term: string) => {\n          \n          \n            \n            const selectCategory = (container: HTMLElement, term: string) => {\n          \n      \n    \n    \n  \n\nAlso (similar to changeQuery), there could be value in asserting that it has now checked the box. Otherwise this function is really just clickCategory - it's not really concerned with selecting.", "author": "edalex-ian", "createdAt": "2020-08-31T01:52:03Z", "path": "Source/Plugins/Core/com.equella.core/js/__tests__/tsrc/search/SearchPage.test.tsx", "diffHunk": "@@ -185,6 +198,10 @@ const changeQuery = async (\n   });\n };\n \n+const selectTerm = (container: HTMLElement, term: string) => {", "originalCommit": "5a22b1c50e2af525e594f72d85ec59787d971642", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjY2MTY3OQ==", "url": "https://github.com/openequella/openEQUELLA/pull/2245#discussion_r482661679", "bodyText": "I prefer change the name to clickCategory because we use MUI FormControlLabel which should ensure clicking the label will tick the box.", "author": "PenghaiZhang", "createdAt": "2020-09-03T02:27:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTg1MDIxNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTg1MDQ0Mg==", "url": "https://github.com/openequella/openEQUELLA/pull/2245#discussion_r479850442", "bodyText": "Hmmmm, here's this untyped map again. I look forward to when I find the source of this.", "author": "edalex-ian", "createdAt": "2020-08-31T01:53:20Z", "path": "Source/Plugins/Core/com.equella.core/js/__tests__/tsrc/search/components/FacetSelector.test.tsx", "diffHunk": "@@ -41,16 +40,19 @@ describe(\"<FacetSelector />\", () => {\n   const COLOR = \"Color\";\n   // Mocked facet\n   const HOBART = \"Hobart\";\n-  const mockedSelectedTerms = new Map([[CITY_ID, [HOBART]]]);\n-  // The text of 'SHOW MORE' button\n+  const SCHEMA_NODE = \"item/city\";\n+  const mockedSelectedTerms = new Map([", "originalCommit": "5a22b1c50e2af525e594f72d85ec59787d971642", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTg1MDY5NA==", "url": "https://github.com/openequella/openEQUELLA/pull/2245#discussion_r479850694", "bodyText": "I wonder how this relates to the button query in MuiQueries. If it's the same, we should use that. If not, we should look at moving this there perhaps?", "author": "edalex-ian", "createdAt": "2020-08-31T01:54:41Z", "path": "Source/Plugins/Core/com.equella.core/js/__tests__/tsrc/search/components/FacetSelector.test.tsx", "diffHunk": "@@ -67,16 +69,17 @@ describe(\"<FacetSelector />\", () => {\n     return classification;\n   };\n \n-  // Return a Classification's 'SHOW MORE' button.\n-  const queryShowMoreButton = (\n+  // Return a Classification's 'SHOW MORE'/'SHOW LESS' button.\n+  const queryButton = (", "originalCommit": "5a22b1c50e2af525e594f72d85ec59787d971642", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTg1MTY3NQ==", "url": "https://github.com/openequella/openEQUELLA/pull/2245#discussion_r479851675", "bodyText": "Can't this just be:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                if (collections && collections.length > 0) {\n          \n          \n            \n                if (collections?.length > 0) {\n          \n      \n    \n    \n  \n\n?\nBut overall it'd be nice if we can keep it declarative inline with the above structure. Maybe we could have in the above block:\ncollections: collections?.length > 0 ? collections.map((c) => c.uuid) | undefined", "author": "edalex-ian", "createdAt": "2020-08-31T01:59:47Z", "path": "Source/Plugins/Core/com.equella.core/js/tsrc/modules/SearchFacetsModule.ts", "diffHunk": "@@ -59,18 +63,36 @@ export interface Classification {\n const convertSearchOptions: (\n   options: SearchOptions\n ) => OEQ.SearchFacets.SearchFacetsParams = memoize(\n-  (options: SearchOptions): OEQ.SearchFacets.SearchFacetsParams => ({\n-    nodes: [],\n-    q: options.query,\n-    collections: options.collections?.map((c) => c.uuid),\n-    modifiedAfter: getISODateString(options.lastModifiedDateRange?.start),\n-    modifiedBefore: getISODateString(options.lastModifiedDateRange?.end),\n-    owner: options.owner?.id,\n-    showall: isEqual(\n-      options.status?.sort(),\n-      OEQ.Common.ItemStatuses.alternatives.map((i) => i.value).sort()\n-    ),\n-  })\n+  (options: SearchOptions): OEQ.SearchFacets.SearchFacetsParams => {\n+    const {\n+      query,\n+      collections,\n+      lastModifiedDateRange,\n+      owner,\n+      status,\n+      classificationTerms,\n+      rawMode,\n+    } = options;\n+    let searchFacetsParams: OEQ.SearchFacets.SearchFacetsParams = {\n+      nodes: [],\n+      q: query ? formatQuery(query, !rawMode) : undefined,\n+      modifiedAfter: getISODateString(lastModifiedDateRange?.start),\n+      modifiedBefore: getISODateString(lastModifiedDateRange?.end),\n+      owner: owner?.id,\n+      showall: isEqual(\n+        status?.sort(),\n+        OEQ.Common.ItemStatuses.alternatives.map((i) => i.value).sort()\n+      ),\n+      where: generateWhereQuery(classificationTerms),\n+    };\n+    if (collections && collections.length > 0) {", "originalCommit": "5a22b1c50e2af525e594f72d85ec59787d971642", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjYzNzU1NQ==", "url": "https://github.com/openequella/openEQUELLA/pull/2245#discussion_r482637555", "bodyText": "The reason for dong this is to make sure collections is not included in the search params when it's undefined or it is empty.  If we pass undefined or an empty collections to the facet search api, we will get nothing returned. (but we can  make some changes on the api side to make it happy with undefined or an empty collections)", "author": "PenghaiZhang", "createdAt": "2020-09-03T01:23:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTg1MTY3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjYzNzkxMA==", "url": "https://github.com/openequella/openEQUELLA/pull/2245#discussion_r482637910", "bodyText": "And Typescript is not happy with if (collections?.length > 0) because collections?.length can be undefined. So we can do if (collections?.length ?? 0 > 0) instead.", "author": "PenghaiZhang", "createdAt": "2020-09-03T01:24:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTg1MTY3NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTg1NDM3MQ==", "url": "https://github.com/openequella/openEQUELLA/pull/2245#discussion_r479854371", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              ); // Filter out empty terms\n          \n          \n            \n              ); // Filter out empty terms, as although the server generates them, sending them back will generate a 500", "author": "edalex-ian", "createdAt": "2020-08-31T02:14:12Z", "path": "Source/Plugins/Core/com.equella.core/js/tsrc/modules/SearchFacetsModule.ts", "diffHunk": "@@ -81,7 +103,9 @@ const convertSearchOptions: (\n export const listCategories = async (\n   options: OEQ.SearchFacets.SearchFacetsParams\n ): Promise<OEQ.SearchFacets.Facet[]> =>\n-  (await OEQ.SearchFacets.searchFacets(API_BASE_URL, options)).results;\n+  (await OEQ.SearchFacets.searchFacets(API_BASE_URL, options)).results.filter(\n+    (r) => r.term\n+  ); // Filter out empty terms", "originalCommit": "5a22b1c50e2af525e594f72d85ec59787d971642", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTg4MTc4Ng==", "url": "https://github.com/openequella/openEQUELLA/pull/2245#discussion_r479881786", "bodyText": "hmmm, I enjoy Maps for their ease of use and overhead. But I must admit this one is becoming some prolific it seems it should be a type. Maybe it'd be fine to simply use a type alias.", "author": "edalex-ian", "createdAt": "2020-08-31T04:29:34Z", "path": "Source/Plugins/Core/com.equella.core/js/tsrc/modules/SearchModule.ts", "diffHunk": "@@ -64,10 +65,9 @@ export interface SearchOptions {\n    */\n   status?: OEQ.Common.ItemStatus[];\n   /**\n-   * A list of classification terms. (Typically a subset of those generated by\n-   * Search Facets.)\n+   * A map of selected Classifications and their terms.\n    */\n-  classificationTerms?: string[];\n+  classificationTerms?: Map<number, NodeAndTerms>;", "originalCommit": "5a22b1c50e2af525e594f72d85ec59787d971642", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTg4MzY3MQ==", "url": "https://github.com/openequella/openEQUELLA/pull/2245#discussion_r479883671", "bodyText": "As mentioned elsewhere I believe this should be defined in one of the lower modules - not the presentation layer.\nThere's also some kind of relationship between this, SearchFacetsModule.Classification and OEQ.SearchFacets.Facet. It would be effort well spent to see how this can be harmonized over in SearchFacetsModule. That work may actually also align with sorting out the Map<number, NodeAndTerms> as that seems like a sub class of SearchFacetsModule.Classification.", "author": "edalex-ian", "createdAt": "2020-08-31T04:38:43Z", "path": "Source/Plugins/Core/com.equella.core/js/tsrc/search/components/FacetSelector.tsx", "diffHunk": "@@ -39,78 +39,98 @@ const useStyles = makeStyles({\n });\n \n /**\n- * Represents a Classification that is specific to Search page.\n+ * Represent a schema node and a list of terms.\n  */\n-export interface SearchPageClassification extends Classification {\n+export interface NodeAndTerms {", "originalCommit": "5a22b1c50e2af525e594f72d85ec59787d971642", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTg4NDkwNA==", "url": "https://github.com/openequella/openEQUELLA/pull/2245#discussion_r479884904", "bodyText": "Can we tweak this while here. This currently states the obvious (due to the types). But what is the purpose of this list?\nMaybe:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n               * A list of Classifications.\n          \n          \n            \n               * A list of Classifications which will be rendered to sections for each Classifications under which will be the\n          \n          \n            \n               * categories as clickable checkboxes.", "author": "edalex-ian", "createdAt": "2020-08-31T04:44:24Z", "path": "Source/Plugins/Core/com.equella.core/js/tsrc/search/components/FacetSelector.tsx", "diffHunk": "@@ -39,78 +39,98 @@ const useStyles = makeStyles({\n });\n \n /**\n- * Represents a Classification that is specific to Search page.\n+ * Represent a schema node and a list of terms.\n  */\n-export interface SearchPageClassification extends Classification {\n+export interface NodeAndTerms {\n   /**\n-   * A boolean indicating if a classification has hidden categories to show.\n+   * One Schema node.\n    */\n-  showMore: boolean;\n+  node: string;\n+  /**\n+   * Terms related to this node.\n+   */\n+  terms: string[];\n }\n \n export interface FacetSelectorProps {\n   /**\n    * A list of Classifications.", "originalCommit": "5a22b1c50e2af525e594f72d85ec59787d971642", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTg4NTc3Nw==", "url": "https://github.com/openequella/openEQUELLA/pull/2245#discussion_r479885777", "bodyText": "What about this for the var name:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              const [showMoreMap, setShowMoreMap] = useState<Map<number, boolean>>(\n          \n          \n            \n              const [collapsedClassifications, setCollapsedClassifications] = useState<Map<number, boolean>>(\n          \n      \n    \n    \n  \n\n(Alternatively I feel [expandedClassifications, setExpandedClassifications] reads slightly better, but you'd have to rework all your logic.)", "author": "edalex-ian", "createdAt": "2020-08-31T04:48:24Z", "path": "Source/Plugins/Core/com.equella.core/js/tsrc/search/components/FacetSelector.tsx", "diffHunk": "@@ -39,78 +39,98 @@ const useStyles = makeStyles({\n });\n \n /**\n- * Represents a Classification that is specific to Search page.\n+ * Represent a schema node and a list of terms.\n  */\n-export interface SearchPageClassification extends Classification {\n+export interface NodeAndTerms {\n   /**\n-   * A boolean indicating if a classification has hidden categories to show.\n+   * One Schema node.\n    */\n-  showMore: boolean;\n+  node: string;\n+  /**\n+   * Terms related to this node.\n+   */\n+  terms: string[];\n }\n \n export interface FacetSelectorProps {\n   /**\n    * A list of Classifications.\n    */\n-  classifications: SearchPageClassification[];\n+  classifications: Classification[];\n   /**\n    * A map where the key is a Classification's ID and value is\n    * a list of terms.\n    */\n-  selectedClassificationTerms?: Map<number, string[]>;\n+  selectedClassificationTerms?: Map<number, NodeAndTerms>;\n   /**\n    * Handler for selecting/deselecting Classification terms.\n    * @param terms A list of currently selected terms.\n    */\n-  onSelectTermsChange: (terms: Map<number, string[]>) => void;\n-  /**\n-   * Handler for clicking a 'SHOW MORE' button.\n-   * @param classificationName The name of a Classification.\n-   */\n-  onShowMore: (classificationID: number) => void;\n+  onSelectTermsChange: (terms: Map<number, NodeAndTerms>) => void;\n }\n \n export const FacetSelector = ({\n   classifications,\n   selectedClassificationTerms,\n   onSelectTermsChange,\n-  onShowMore,\n }: FacetSelectorProps) => {\n   const classes = useStyles();\n+  const [showMoreMap, setShowMoreMap] = useState<Map<number, boolean>>(", "originalCommit": "5a22b1c50e2af525e594f72d85ec59787d971642", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTg4NjQ1MA==", "url": "https://github.com/openequella/openEQUELLA/pull/2245#discussion_r479886450", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n               * @param classificationID The name of a Classification\n          \n          \n            \n               * @param classificationID The ID of a Classification", "author": "edalex-ian", "createdAt": "2020-08-31T04:51:17Z", "path": "Source/Plugins/Core/com.equella.core/js/tsrc/search/components/FacetSelector.tsx", "diffHunk": "@@ -139,10 +159,12 @@ export const FacetSelector = ({\n   /**\n    * Build a ListItem consisting of a MUI Checkbox and a Label for a facet.\n    * @param classificationID The name of a Classification", "originalCommit": "5a22b1c50e2af525e594f72d85ec59787d971642", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTg4NzA4Ng==", "url": "https://github.com/openequella/openEQUELLA/pull/2245#discussion_r479887086", "bodyText": "Seems unnecessary for you to be managing the schemaNode here - you have the more specific Classification ID which can be used for those purposes. This could lead to odd issues if they get out of wack.", "author": "edalex-ian", "createdAt": "2020-08-31T04:54:10Z", "path": "Source/Plugins/Core/com.equella.core/js/tsrc/search/components/FacetSelector.tsx", "diffHunk": "@@ -39,78 +39,98 @@ const useStyles = makeStyles({\n });\n \n /**\n- * Represents a Classification that is specific to Search page.\n+ * Represent a schema node and a list of terms.\n  */\n-export interface SearchPageClassification extends Classification {\n+export interface NodeAndTerms {\n   /**\n-   * A boolean indicating if a classification has hidden categories to show.\n+   * One Schema node.\n    */\n-  showMore: boolean;\n+  node: string;\n+  /**\n+   * Terms related to this node.\n+   */\n+  terms: string[];\n }\n \n export interface FacetSelectorProps {\n   /**\n    * A list of Classifications.\n    */\n-  classifications: SearchPageClassification[];\n+  classifications: Classification[];\n   /**\n    * A map where the key is a Classification's ID and value is\n    * a list of terms.\n    */\n-  selectedClassificationTerms?: Map<number, string[]>;\n+  selectedClassificationTerms?: Map<number, NodeAndTerms>;\n   /**\n    * Handler for selecting/deselecting Classification terms.\n    * @param terms A list of currently selected terms.\n    */\n-  onSelectTermsChange: (terms: Map<number, string[]>) => void;\n-  /**\n-   * Handler for clicking a 'SHOW MORE' button.\n-   * @param classificationName The name of a Classification.\n-   */\n-  onShowMore: (classificationID: number) => void;\n+  onSelectTermsChange: (terms: Map<number, NodeAndTerms>) => void;\n }\n \n export const FacetSelector = ({\n   classifications,\n   selectedClassificationTerms,\n   onSelectTermsChange,\n-  onShowMore,\n }: FacetSelectorProps) => {\n   const classes = useStyles();\n+  const [showMoreMap, setShowMoreMap] = useState<Map<number, boolean>>(\n+    new Map(classifications.map((classification) => [classification.id, true]))\n+  );\n \n+  const onShowMore = (classificationID: number, showMore: boolean) => {\n+    const copiedMap = new Map(showMoreMap);\n+    copiedMap.set(classificationID, showMore);\n+    setShowMoreMap(copiedMap);\n+  };\n   /**\n    * Updates the list of selected Classification terms. If the term exists then remove it\n    * from the list. Add it to the list otherwise.\n    * A copy of the map and a copy of the array of terms are created internally\n    * to avoid mutating parent component's state.\n    *\n    * @param classificationID The ID of a Classification\n+   * @param schemaNode The Schema node of a Classification\n    * @param term The selected or unselected term\n    */\n-  const handleSelectTerms = (classificationID: number, term: string) => {\n-    const terms = selectedClassificationTerms?.get(classificationID);\n-    const copiedTerms = terms ? [...terms] : [];\n+  const handleSelectTerms = (\n+    classificationID: number,\n+    schemaNode: string,", "originalCommit": "5a22b1c50e2af525e594f72d85ec59787d971642", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTg4OTU1MA==", "url": "https://github.com/openequella/openEQUELLA/pull/2245#discussion_r479889550", "bodyText": "Can we reworking the naming here? It was confusing down below when reviewing listCategories() where you then start using the agreed terminology of 'categories' (rather than the server side, 'terms').\n/**\n * The currently selected categories, where the key of the map is the ID of\n * the `Classification` they below to.\n */\nselectedCategories?: Map<number, NodeAndTerms>;\nHmmm, I wonder why you even need NodeAndTerms here. I mention this further down, I think you should only need the Classification ID and the string array of terms. \ud83e\udd14", "author": "edalex-ian", "createdAt": "2020-08-31T05:05:16Z", "path": "Source/Plugins/Core/com.equella.core/js/tsrc/search/components/FacetSelector.tsx", "diffHunk": "@@ -39,78 +39,98 @@ const useStyles = makeStyles({\n });\n \n /**\n- * Represents a Classification that is specific to Search page.\n+ * Represent a schema node and a list of terms.\n  */\n-export interface SearchPageClassification extends Classification {\n+export interface NodeAndTerms {\n   /**\n-   * A boolean indicating if a classification has hidden categories to show.\n+   * One Schema node.\n    */\n-  showMore: boolean;\n+  node: string;\n+  /**\n+   * Terms related to this node.\n+   */\n+  terms: string[];\n }\n \n export interface FacetSelectorProps {\n   /**\n    * A list of Classifications.\n    */\n-  classifications: SearchPageClassification[];\n+  classifications: Classification[];\n   /**\n    * A map where the key is a Classification's ID and value is\n    * a list of terms.\n    */\n-  selectedClassificationTerms?: Map<number, string[]>;\n+  selectedClassificationTerms?: Map<number, NodeAndTerms>;", "originalCommit": "5a22b1c50e2af525e594f72d85ec59787d971642", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTg5MTM1Ng==", "url": "https://github.com/openequella/openEQUELLA/pull/2245#discussion_r479891356", "bodyText": "As mentioned above on selectedClassificationTerms, let's normalise on our terminology.\nBut... Is this even all required? Doesn't selectedClassificationTerms already hold all this value... Maybe it's because you need it in a different shape for TS, in which case maybe all you need is a .map over it. \ud83e\udd14", "author": "edalex-ian", "createdAt": "2020-08-31T05:13:01Z", "path": "Source/Plugins/Core/com.equella.core/js/tsrc/search/components/FacetSelector.tsx", "diffHunk": "@@ -171,19 +195,27 @@ export const FacetSelector = ({\n    *\n    * @param id The ID of a Classification\n    * @param categories A list of terms to build into a list\n-   * @param showMore Whether to show more facets or not\n+   * @param schemaNode The Schema node of a Classification\n    * @param maxDisplay Default maximum number of displayed facets\n+   * @param showMore Whether to show more facets or not\n    */\n-  const listCategories = ({\n-    id,\n-    categories,\n-    showMore,\n-    maxDisplay,\n-  }: SearchPageClassification): ReactElement[] =>\n-    categories\n+  const listCategories = (\n+    { id, categories, schemaNode, maxDisplay }: Classification,\n+    showMore: boolean\n+  ): ReactElement[] => {\n+    const selectedTerms = selectedClassificationTerms?.get(id)?.terms ?? [];\n+    const selectedCategories = categories.filter((c) =>\n+      selectedTerms.includes(c.term)\n+    );", "originalCommit": "5a22b1c50e2af525e594f72d85ec59787d971642", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjY0NDI0OA==", "url": "https://github.com/openequella/openEQUELLA/pull/2245#discussion_r482644248", "bodyText": "I think we may need because generating each category's label text needs full information of a facet (term and count) , but selectedClassificationTerms only knows the term.", "author": "PenghaiZhang", "createdAt": "2020-09-03T01:47:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTg5MTM1Ng=="}], "type": "inlineReview"}, {"oid": "8323c4515b67366409a12c5d932c48990c5a34f4", "url": "https://github.com/openequella/openEQUELLA/commit/8323c4515b67366409a12c5d932c48990c5a34f4", "message": "Just import the type of Classification in mock data and update some JSDoc.", "committedDate": "2020-09-01T05:03:10Z", "type": "commit"}, {"oid": "fb96883355f0b6af18cd5befb651766791a59b8f", "url": "https://github.com/openequella/openEQUELLA/commit/fb96883355f0b6af18cd5befb651766791a59b8f", "message": "Create a new type for selected categories.", "committedDate": "2020-09-02T23:49:52Z", "type": "commit"}, {"oid": "f589592aed082e8a1d52581befbfc3f25749970a", "url": "https://github.com/openequella/openEQUELLA/commit/f589592aed082e8a1d52581befbfc3f25749970a", "message": "Refactor Facet Selector\n\n1. Remove 'NodeAndTerms' and use the new interface\n   'SelectedCategories';\n2. Change the type of selected categories from Map\n   to an array;\n3. Update functions's signature to remove 'schemaNode';\n4. Update functions and variables' names and JSDoc to\n   reduce confusion.", "committedDate": "2020-09-02T23:54:40Z", "type": "commit"}, {"oid": "d1e7d7c47153592819206567ea99d5fa541b3a9a", "url": "https://github.com/openequella/openEQUELLA/commit/d1e7d7c47153592819206567ea99d5fa541b3a9a", "message": "Updates for SearchModule, include\n1. rename SearchOption's field 'classificationTerms' to\n   'selectedCategories' and change its type to Array;\n2. Refactor and rename function 'generateWhereQuery'.", "committedDate": "2020-09-03T00:27:11Z", "type": "commit"}, {"oid": "e4afeeb893699c1bcd823c4ba7ed7dde0a7aaf1a", "url": "https://github.com/openequella/openEQUELLA/commit/e4afeeb893699c1bcd823c4ba7ed7dde0a7aaf1a", "message": "Update SearchFacetsModule due to Search Module's changes.", "committedDate": "2020-09-03T00:30:20Z", "type": "commit"}, {"oid": "197f0192aa5b609f629df8c1008d3a7fb1eb3d13", "url": "https://github.com/openequella/openEQUELLA/commit/197f0192aa5b609f629df8c1008d3a7fb1eb3d13", "message": "Update Search page to properly integrate Facet Selector.\n\nThe handler for selecting categories adds 'schema node' to\neach category group because the module needs schema node to\ngenerate a correct where clause.", "committedDate": "2020-09-03T00:34:58Z", "type": "commit"}, {"oid": "369a3604ab6c67ca924938d168f78ca09df6b6a8", "url": "https://github.com/openequella/openEQUELLA/commit/369a3604ab6c67ca924938d168f78ca09df6b6a8", "message": "Update tests, storybook and mock data for Facet Selector.", "committedDate": "2020-09-03T00:56:40Z", "type": "commit"}, {"oid": "dd4e624713357158f83c2c0e3d66c2fea0652c33", "url": "https://github.com/openequella/openEQUELLA/commit/dd4e624713357158f83c2c0e3d66c2fea0652c33", "message": "More tweaks for Facet Selector, including:\n1. Rename variable 'showMoreMap' to 'expandedClassifications'\n   and modify the logic accordingly.\n2. Update function's signature to use proper parameter names.\n3. Update some JSDoc.", "committedDate": "2020-09-03T01:54:37Z", "type": "commit"}, {"oid": "2128ddf0328948708c99c2a4ee091bb54f2a64b1", "url": "https://github.com/openequella/openEQUELLA/commit/2128ddf0328948708c99c2a4ee091bb54f2a64b1", "message": "Updates for SearchModule, including:\n1. Add two test cases for function 'generateFacetWhereQuery';\n2. Separate test cases to two describe blocks. One for 'searchItem'\n   and the other one for 'generateFacetWhereQuery';\n3. Remove the redundant import of 'generateFacetWhereQuery'.", "committedDate": "2020-09-03T02:18:35Z", "type": "commit"}, {"oid": "648ec2fd37a804dae2b3a706748e527a050ba6cc", "url": "https://github.com/openequella/openEQUELLA/commit/648ec2fd37a804dae2b3a706748e527a050ba6cc", "message": "Tidy ups for Search page test.", "committedDate": "2020-09-03T02:29:26Z", "type": "commit"}, {"oid": "e881b91619c2c9f819c15d695d45cd2ac6aed053", "url": "https://github.com/openequella/openEQUELLA/commit/e881b91619c2c9f819c15d695d45cd2ac6aed053", "message": "Reuse 'queryMuiButtonByText' in Facet Selector test.", "committedDate": "2020-09-03T03:57:21Z", "type": "commit"}, {"oid": "81ff6ecee853642678148f8945c13af03900db10", "url": "https://github.com/openequella/openEQUELLA/commit/81ff6ecee853642678148f8945c13af03900db10", "message": "Rename FacetSelector to CategorySelector and standardise\nthe terminology used in tests, storybooks and modules.", "committedDate": "2020-09-03T04:23:29Z", "type": "commit"}, {"oid": "5c9248f13487fdaca77030068272458dcc6492e3", "url": "https://github.com/openequella/openEQUELLA/commit/5c9248f13487fdaca77030068272458dcc6492e3", "message": "Rename the storybook of CategorySelector.", "committedDate": "2020-09-03T05:38:40Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjcwMzk1Mg==", "url": "https://github.com/openequella/openEQUELLA/pull/2245#discussion_r482703952", "bodyText": "Whoops! Typo.\nAnd please make sure we have white space between definitions of interfaces, classes and funcs at the top level.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            export interface GategorySelectorProps {\n          \n          \n            \n            \n          \n          \n            \n            export interface CategorySelectorProps {", "author": "edalex-ian", "createdAt": "2020-09-03T04:56:34Z", "path": "Source/Plugins/Core/com.equella.core/js/tsrc/search/components/CategorySelector.tsx", "diffHunk": "@@ -0,0 +1,266 @@\n+/*\n+ * Licensed to The Apereo Foundation under one or more contributor license\n+ * agreements. See the NOTICE file distributed with this work for additional\n+ * information regarding copyright ownership.\n+ *\n+ * The Apereo Foundation licenses this file to you under the Apache License,\n+ * Version 2.0, (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+import {\n+  Button,\n+  Checkbox,\n+  FormControlLabel,\n+  Grid,\n+  List,\n+  ListItem,\n+  Typography,\n+} from \"@material-ui/core\";\n+import { makeStyles } from \"@material-ui/core/styles\";\n+import { ReactElement, useState } from \"react\";\n+import * as React from \"react\";\n+import * as OEQ from \"@openequella/rest-api-client\";\n+import {\n+  Classification,\n+  SelectedCategories,\n+} from \"../../modules/SearchFacetsModule\";\n+import { languageStrings } from \"../../util/langstrings\";\n+\n+const useStyles = makeStyles({\n+  classificationList: {\n+    maxHeight: 500,\n+    overflow: \"auto\",\n+  },\n+});\n+export interface GategorySelectorProps {", "originalCommit": "81ff6ecee853642678148f8945c13af03900db10", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjcwNDAxMw==", "url": "https://github.com/openequella/openEQUELLA/pull/2245#discussion_r482704013", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            export const CategorySelector = ({\n          \n          \n            \n            \n          \n          \n            \n            export const CategorySelector = ({", "author": "edalex-ian", "createdAt": "2020-09-03T04:56:46Z", "path": "Source/Plugins/Core/com.equella.core/js/tsrc/search/components/CategorySelector.tsx", "diffHunk": "@@ -0,0 +1,266 @@\n+/*\n+ * Licensed to The Apereo Foundation under one or more contributor license\n+ * agreements. See the NOTICE file distributed with this work for additional\n+ * information regarding copyright ownership.\n+ *\n+ * The Apereo Foundation licenses this file to you under the Apache License,\n+ * Version 2.0, (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+import {\n+  Button,\n+  Checkbox,\n+  FormControlLabel,\n+  Grid,\n+  List,\n+  ListItem,\n+  Typography,\n+} from \"@material-ui/core\";\n+import { makeStyles } from \"@material-ui/core/styles\";\n+import { ReactElement, useState } from \"react\";\n+import * as React from \"react\";\n+import * as OEQ from \"@openequella/rest-api-client\";\n+import {\n+  Classification,\n+  SelectedCategories,\n+} from \"../../modules/SearchFacetsModule\";\n+import { languageStrings } from \"../../util/langstrings\";\n+\n+const useStyles = makeStyles({\n+  classificationList: {\n+    maxHeight: 500,\n+    overflow: \"auto\",\n+  },\n+});\n+export interface GategorySelectorProps {\n+  /**\n+   * A list of Classifications which will be rendered to sections for each\n+   * Classifications under which will be the categories as clickable checkboxes.\n+   */\n+  classifications: Classification[];\n+  /**\n+   * A list of selected categories which are grouped by their Classification ID.\n+   */\n+  selectedCategories?: SelectedCategories[];\n+  /**\n+   * Handler for selecting/deselecting categories.\n+   * @param terms A list of currently selected terms.\n+   */\n+  onSelectedCategoriesChange: (categories: SelectedCategories[]) => void;\n+}\n+export const CategorySelector = ({", "originalCommit": "81ff6ecee853642678148f8945c13af03900db10", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjcwNTM1Mw==", "url": "https://github.com/openequella/openEQUELLA/pull/2245#discussion_r482705353", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              /**\n          \n          \n            \n            \n          \n          \n            \n              /**", "author": "edalex-ian", "createdAt": "2020-09-03T05:01:48Z", "path": "Source/Plugins/Core/com.equella.core/js/tsrc/search/components/CategorySelector.tsx", "diffHunk": "@@ -0,0 +1,266 @@\n+/*\n+ * Licensed to The Apereo Foundation under one or more contributor license\n+ * agreements. See the NOTICE file distributed with this work for additional\n+ * information regarding copyright ownership.\n+ *\n+ * The Apereo Foundation licenses this file to you under the Apache License,\n+ * Version 2.0, (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+import {\n+  Button,\n+  Checkbox,\n+  FormControlLabel,\n+  Grid,\n+  List,\n+  ListItem,\n+  Typography,\n+} from \"@material-ui/core\";\n+import { makeStyles } from \"@material-ui/core/styles\";\n+import { ReactElement, useState } from \"react\";\n+import * as React from \"react\";\n+import * as OEQ from \"@openequella/rest-api-client\";\n+import {\n+  Classification,\n+  SelectedCategories,\n+} from \"../../modules/SearchFacetsModule\";\n+import { languageStrings } from \"../../util/langstrings\";\n+\n+const useStyles = makeStyles({\n+  classificationList: {\n+    maxHeight: 500,\n+    overflow: \"auto\",\n+  },\n+});\n+export interface GategorySelectorProps {\n+  /**\n+   * A list of Classifications which will be rendered to sections for each\n+   * Classifications under which will be the categories as clickable checkboxes.\n+   */\n+  classifications: Classification[];\n+  /**\n+   * A list of selected categories which are grouped by their Classification ID.\n+   */\n+  selectedCategories?: SelectedCategories[];\n+  /**\n+   * Handler for selecting/deselecting categories.\n+   * @param terms A list of currently selected terms.\n+   */\n+  onSelectedCategoriesChange: (categories: SelectedCategories[]) => void;\n+}\n+export const CategorySelector = ({\n+  classifications,\n+  selectedCategories = [],\n+  onSelectedCategoriesChange,\n+}: GategorySelectorProps) => {\n+  const classes = useStyles();\n+  const [expandedClassifications, setExpandedClassifications] = useState<\n+    Map<number, boolean>\n+  >(\n+    new Map(classifications.map((classification) => [classification.id, false]))\n+  );\n+\n+  /**\n+   * Handler for clicking the 'SHOW MORE' and 'SHOW LESS' buttons.\n+   * @param classificationID The ID of a Classification whose SHOW MORE' and 'SHOW LESS' buttons is clicked.\n+   * @param expanded Whether the section of this Classification is expanded or not.\n+   */\n+  const onShowMore = (classificationID: number, expanded: boolean) => {\n+    const copiedMap = new Map(expandedClassifications);\n+    copiedMap.set(classificationID, expanded);\n+    setExpandedClassifications(copiedMap);\n+  };\n+  /**", "originalCommit": "81ff6ecee853642678148f8945c13af03900db10", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjcwNzUxMg==", "url": "https://github.com/openequella/openEQUELLA/pull/2245#discussion_r482707512", "bodyText": "Nit: Could be good to rename this too - and then update the JSDoc.", "author": "edalex-ian", "createdAt": "2020-09-03T05:09:40Z", "path": "Source/Plugins/Core/com.equella.core/js/tsrc/search/components/CategorySelector.tsx", "diffHunk": "@@ -0,0 +1,266 @@\n+/*\n+ * Licensed to The Apereo Foundation under one or more contributor license\n+ * agreements. See the NOTICE file distributed with this work for additional\n+ * information regarding copyright ownership.\n+ *\n+ * The Apereo Foundation licenses this file to you under the Apache License,\n+ * Version 2.0, (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+import {\n+  Button,\n+  Checkbox,\n+  FormControlLabel,\n+  Grid,\n+  List,\n+  ListItem,\n+  Typography,\n+} from \"@material-ui/core\";\n+import { makeStyles } from \"@material-ui/core/styles\";\n+import { ReactElement, useState } from \"react\";\n+import * as React from \"react\";\n+import * as OEQ from \"@openequella/rest-api-client\";\n+import {\n+  Classification,\n+  SelectedCategories,\n+} from \"../../modules/SearchFacetsModule\";\n+import { languageStrings } from \"../../util/langstrings\";\n+\n+const useStyles = makeStyles({\n+  classificationList: {\n+    maxHeight: 500,\n+    overflow: \"auto\",\n+  },\n+});\n+export interface GategorySelectorProps {\n+  /**\n+   * A list of Classifications which will be rendered to sections for each\n+   * Classifications under which will be the categories as clickable checkboxes.\n+   */\n+  classifications: Classification[];\n+  /**\n+   * A list of selected categories which are grouped by their Classification ID.\n+   */\n+  selectedCategories?: SelectedCategories[];\n+  /**\n+   * Handler for selecting/deselecting categories.\n+   * @param terms A list of currently selected terms.\n+   */\n+  onSelectedCategoriesChange: (categories: SelectedCategories[]) => void;\n+}\n+export const CategorySelector = ({\n+  classifications,\n+  selectedCategories = [],\n+  onSelectedCategoriesChange,\n+}: GategorySelectorProps) => {\n+  const classes = useStyles();\n+  const [expandedClassifications, setExpandedClassifications] = useState<\n+    Map<number, boolean>\n+  >(\n+    new Map(classifications.map((classification) => [classification.id, false]))\n+  );\n+\n+  /**\n+   * Handler for clicking the 'SHOW MORE' and 'SHOW LESS' buttons.\n+   * @param classificationID The ID of a Classification whose SHOW MORE' and 'SHOW LESS' buttons is clicked.\n+   * @param expanded Whether the section of this Classification is expanded or not.\n+   */\n+  const onShowMore = (classificationID: number, expanded: boolean) => {\n+    const copiedMap = new Map(expandedClassifications);\n+    copiedMap.set(classificationID, expanded);\n+    setExpandedClassifications(copiedMap);\n+  };\n+  /**\n+   * The list of selected categories are grouped by Classification ID.\n+   * If there is a group matching the ID, then update this group's selected categories,\n+   * and otherwise add a new group for the ID and its firstly selected category.\n+   *\n+   * @param classificationID The ID of a Classification\n+   * @param category The selected or unselected category\n+   */\n+  const handleSelectCategories = (\n+    classificationID: number,\n+    category: string\n+  ) => {\n+    const categoryGroupIndex = selectedCategories.findIndex(\n+      (c) => c.id === classificationID\n+    );\n+    const copiedCategoryGroups = [...selectedCategories];\n+\n+    // If there is no group for this category then add a new group,\n+    // and otherwise update the category list of this group.\n+    if (categoryGroupIndex === -1) {\n+      copiedCategoryGroups.push({\n+        id: classificationID,\n+        categories: [category],\n+      });\n+    } else {\n+      const copiedSelectedCategories = [\n+        ...selectedCategories[categoryGroupIndex].categories,\n+      ];\n+      const categoryIndex = copiedSelectedCategories.indexOf(category);\n+      if (categoryIndex === -1) {\n+        copiedSelectedCategories.push(category);\n+      } else {\n+        copiedSelectedCategories.splice(categoryIndex, 1);\n+      }\n+      copiedCategoryGroups.splice(categoryGroupIndex, 1, {\n+        id: classificationID,\n+        categories: copiedSelectedCategories,\n+      });\n+    }\n+\n+    onSelectedCategoriesChange(copiedCategoryGroups);\n+  };\n+\n+  /**\n+   * Create a button to show more/less categories for each Classification.\n+   * @param classificationID The ID of a Classification.\n+   * @param expanded Whether the section of a Classification has been expanded or not.\n+   */\n+  const showMoreButton = (\n+    classificationID: number,\n+    expanded: boolean\n+  ): ReactElement => (\n+    <ListItem>\n+      <Grid container justify=\"center\">\n+        <Grid item>\n+          <Button\n+            variant=\"text\"\n+            onClick={() => onShowMore(classificationID, !expanded)}\n+          >\n+            {expanded\n+              ? languageStrings.searchpage.categorySelector.showLessButton\n+              : languageStrings.searchpage.categorySelector.showMoreButton}\n+          </Button>\n+        </Grid>\n+      </Grid>\n+    </ListItem>\n+  );\n+\n+  /**\n+   * Generate texts in the format of 'term (count)' for displaying a Category.\n+   * @param term The term of a category\n+   * @param count The count of a category\n+   */\n+  const categoryLabel = ({\n+    term,", "originalCommit": "81ff6ecee853642678148f8945c13af03900db10", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mjc3NTI4OA==", "url": "https://github.com/openequella/openEQUELLA/pull/2245#discussion_r482775288", "bodyText": "As discussed, I'm finding this one a little tricky to read. Seems mainly due to variable names, and variable shadowing, but I think also compounded by the imperative nature of it.\nI've come up with this alternative more declarative implementation:\n  const listCategories = (\n    { id, categories, maxDisplay }: Classification,\n    expanded: boolean\n  ): ReactElement[] => {\n    const selectedTerms: string[] =\n      selectedCategories?.find((c) => c.id === id)?.categories ?? [];\n    const selectedFacets: OEQ.SearchFacets.Facet[] = selectedTerms.map((selectedTerm) => {\n      const facet = categories.find((c) => selectedTerm === c.term);\n      if (!facet) {\n        throw new Error(\n          \"Data integrity issue, we're unable to match a selected term.\"\n        );\n      }\n\n      return facet;\n    });\n    const orderedFacets = selectedFacets.concat(\n      categories.filter((c) => !selectedFacets.includes(c))\n    );\n\n    return orderedFacets\n      .slice(0, expanded ? undefined : maxDisplay)\n      .map((facet) => categoryListItem(id, facet));\n  };\nTwo things interesting here:\n\nAlthough it should never happen, this showed the potential for a data integrity issue that would be glossed over; and\nAgainst my own advice I've been drawn into having to use Categories, Terms and Facets in the one function. But this was to align with data types and existing variable names. So, I dunno. \ud83e\udd37\n\n(Also, because this is declarative it highlights the data linkages/flow. I could've chained all this together, but I erred on the side of readability. \ud83d\ude09  )", "author": "edalex-ian", "createdAt": "2020-09-03T07:46:12Z", "path": "Source/Plugins/Core/com.equella.core/js/tsrc/search/components/CategorySelector.tsx", "diffHunk": "@@ -0,0 +1,266 @@\n+/*\n+ * Licensed to The Apereo Foundation under one or more contributor license\n+ * agreements. See the NOTICE file distributed with this work for additional\n+ * information regarding copyright ownership.\n+ *\n+ * The Apereo Foundation licenses this file to you under the Apache License,\n+ * Version 2.0, (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+import {\n+  Button,\n+  Checkbox,\n+  FormControlLabel,\n+  Grid,\n+  List,\n+  ListItem,\n+  Typography,\n+} from \"@material-ui/core\";\n+import { makeStyles } from \"@material-ui/core/styles\";\n+import { ReactElement, useState } from \"react\";\n+import * as React from \"react\";\n+import * as OEQ from \"@openequella/rest-api-client\";\n+import {\n+  Classification,\n+  SelectedCategories,\n+} from \"../../modules/SearchFacetsModule\";\n+import { languageStrings } from \"../../util/langstrings\";\n+\n+const useStyles = makeStyles({\n+  classificationList: {\n+    maxHeight: 500,\n+    overflow: \"auto\",\n+  },\n+});\n+export interface GategorySelectorProps {\n+  /**\n+   * A list of Classifications which will be rendered to sections for each\n+   * Classifications under which will be the categories as clickable checkboxes.\n+   */\n+  classifications: Classification[];\n+  /**\n+   * A list of selected categories which are grouped by their Classification ID.\n+   */\n+  selectedCategories?: SelectedCategories[];\n+  /**\n+   * Handler for selecting/deselecting categories.\n+   * @param terms A list of currently selected terms.\n+   */\n+  onSelectedCategoriesChange: (categories: SelectedCategories[]) => void;\n+}\n+export const CategorySelector = ({\n+  classifications,\n+  selectedCategories = [],\n+  onSelectedCategoriesChange,\n+}: GategorySelectorProps) => {\n+  const classes = useStyles();\n+  const [expandedClassifications, setExpandedClassifications] = useState<\n+    Map<number, boolean>\n+  >(\n+    new Map(classifications.map((classification) => [classification.id, false]))\n+  );\n+\n+  /**\n+   * Handler for clicking the 'SHOW MORE' and 'SHOW LESS' buttons.\n+   * @param classificationID The ID of a Classification whose SHOW MORE' and 'SHOW LESS' buttons is clicked.\n+   * @param expanded Whether the section of this Classification is expanded or not.\n+   */\n+  const onShowMore = (classificationID: number, expanded: boolean) => {\n+    const copiedMap = new Map(expandedClassifications);\n+    copiedMap.set(classificationID, expanded);\n+    setExpandedClassifications(copiedMap);\n+  };\n+  /**\n+   * The list of selected categories are grouped by Classification ID.\n+   * If there is a group matching the ID, then update this group's selected categories,\n+   * and otherwise add a new group for the ID and its firstly selected category.\n+   *\n+   * @param classificationID The ID of a Classification\n+   * @param category The selected or unselected category\n+   */\n+  const handleSelectCategories = (\n+    classificationID: number,\n+    category: string\n+  ) => {\n+    const categoryGroupIndex = selectedCategories.findIndex(\n+      (c) => c.id === classificationID\n+    );\n+    const copiedCategoryGroups = [...selectedCategories];\n+\n+    // If there is no group for this category then add a new group,\n+    // and otherwise update the category list of this group.\n+    if (categoryGroupIndex === -1) {\n+      copiedCategoryGroups.push({\n+        id: classificationID,\n+        categories: [category],\n+      });\n+    } else {\n+      const copiedSelectedCategories = [\n+        ...selectedCategories[categoryGroupIndex].categories,\n+      ];\n+      const categoryIndex = copiedSelectedCategories.indexOf(category);\n+      if (categoryIndex === -1) {\n+        copiedSelectedCategories.push(category);\n+      } else {\n+        copiedSelectedCategories.splice(categoryIndex, 1);\n+      }\n+      copiedCategoryGroups.splice(categoryGroupIndex, 1, {\n+        id: classificationID,\n+        categories: copiedSelectedCategories,\n+      });\n+    }\n+\n+    onSelectedCategoriesChange(copiedCategoryGroups);\n+  };\n+\n+  /**\n+   * Create a button to show more/less categories for each Classification.\n+   * @param classificationID The ID of a Classification.\n+   * @param expanded Whether the section of a Classification has been expanded or not.\n+   */\n+  const showMoreButton = (\n+    classificationID: number,\n+    expanded: boolean\n+  ): ReactElement => (\n+    <ListItem>\n+      <Grid container justify=\"center\">\n+        <Grid item>\n+          <Button\n+            variant=\"text\"\n+            onClick={() => onShowMore(classificationID, !expanded)}\n+          >\n+            {expanded\n+              ? languageStrings.searchpage.categorySelector.showLessButton\n+              : languageStrings.searchpage.categorySelector.showMoreButton}\n+          </Button>\n+        </Grid>\n+      </Grid>\n+    </ListItem>\n+  );\n+\n+  /**\n+   * Generate texts in the format of 'term (count)' for displaying a Category.\n+   * @param term The term of a category\n+   * @param count The count of a category\n+   */\n+  const categoryLabel = ({\n+    term,\n+    count,\n+  }: OEQ.SearchFacets.Facet): ReactElement => (\n+    <Grid container spacing={1}>\n+      <Grid item>\n+        <Typography>{term}</Typography>\n+      </Grid>\n+      <Grid item>\n+        <Typography color=\"textSecondary\">{`(${count})`}</Typography>\n+      </Grid>\n+    </Grid>\n+  );\n+\n+  /**\n+   * Build a ListItem consisting of a MUI Checkbox and a Label for a category.\n+   * @param classificationID The ID of a Classification\n+   * @param category A category to be displayed\n+   */\n+  const categoryListItem = (\n+    classificationID: number,\n+    category: OEQ.SearchFacets.Facet\n+  ): ReactElement => {\n+    const { term } = category;\n+    return (\n+      <ListItem key={`${classificationID}:${term}`} style={{ padding: 0 }}>\n+        <FormControlLabel\n+          control={\n+            <Checkbox\n+              checked={\n+                selectedCategories\n+                  ?.find((c) => c.id === classificationID)\n+                  ?.categories?.includes(term) ?? false\n+              }\n+              onChange={() => handleSelectCategories(classificationID, term)}\n+            />\n+          }\n+          label={categoryLabel(category)}\n+        />\n+      </ListItem>\n+    );\n+  };\n+\n+  /**\n+   * Build a list for a Classification's categories. Some categories may have facets\n+   * not displayed due to the configured maximum display number.\n+   *\n+   * @param id The ID of a Classification\n+   * @param categories A list of terms to build into a list\n+   * @param maxDisplay Default maximum number of displayed facets\n+   * @param expanded Whether to show more categories or not\n+   */\n+  const listCategories = (", "originalCommit": "5c9248f13487fdaca77030068272458dcc6492e3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mjc3NjE5Mw==", "url": "https://github.com/openequella/openEQUELLA/pull/2245#discussion_r482776193", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              title: \"Search/FacetSelector\",\n          \n          \n            \n              title: \"Search/CategorySelector\",", "author": "edalex-ian", "createdAt": "2020-09-03T07:47:34Z", "path": "Source/Plugins/Core/com.equella.core/js/__stories__/search/CategorySelector.stories.tsx", "diffHunk": "@@ -0,0 +1,56 @@\n+/*\n+ * Licensed to The Apereo Foundation under one or more contributor license\n+ * agreements. See the NOTICE file distributed with this work for additional\n+ * information regarding copyright ownership.\n+ *\n+ * The Apereo Foundation licenses this file to you under the Apache License,\n+ * Version 2.0, (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+import * as React from \"react\";\n+import { SelectedCategories } from \"../../tsrc/modules/SearchFacetsModule\";\n+import {\n+  CategorySelector,\n+  GategorySelectorProps,\n+} from \"../../tsrc/search/components/CategorySelector\";\n+import * as CategorySelectorMock from \"../../__mocks__/CategorySelector.mock\";\n+import type { Meta, Story } from \"@storybook/react\";\n+\n+export default {\n+  title: \"Search/FacetSelector\",", "originalCommit": "5c9248f13487fdaca77030068272458dcc6492e3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mjc3NjY3OQ==", "url": "https://github.com/openequella/openEQUELLA/pull/2245#discussion_r482776679", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            const FacetSelectorTemplate = (args: GategorySelectorProps) => (\n          \n          \n            \n            const CategorySelectorTemplate = (args: GategorySelectorProps) => (", "author": "edalex-ian", "createdAt": "2020-09-03T07:48:25Z", "path": "Source/Plugins/Core/com.equella.core/js/__stories__/search/CategorySelector.stories.tsx", "diffHunk": "@@ -0,0 +1,56 @@\n+/*\n+ * Licensed to The Apereo Foundation under one or more contributor license\n+ * agreements. See the NOTICE file distributed with this work for additional\n+ * information regarding copyright ownership.\n+ *\n+ * The Apereo Foundation licenses this file to you under the Apache License,\n+ * Version 2.0, (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+import * as React from \"react\";\n+import { SelectedCategories } from \"../../tsrc/modules/SearchFacetsModule\";\n+import {\n+  CategorySelector,\n+  GategorySelectorProps,\n+} from \"../../tsrc/search/components/CategorySelector\";\n+import * as CategorySelectorMock from \"../../__mocks__/CategorySelector.mock\";\n+import type { Meta, Story } from \"@storybook/react\";\n+\n+export default {\n+  title: \"Search/FacetSelector\",\n+  component: CategorySelector,\n+  argType: {\n+    onSelectedCategoriesChange: { action: \"on select categories\" },\n+  },\n+} as Meta<GategorySelectorProps>;\n+\n+const FacetSelectorTemplate = (args: GategorySelectorProps) => (", "originalCommit": "5c9248f13487fdaca77030068272458dcc6492e3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mjc3NzA4NQ==", "url": "https://github.com/openequella/openEQUELLA/pull/2245#discussion_r482777085", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                it(\"should provide an list of items\", async () => {\n          \n          \n            \n                it(\"should provide a list of items\", async () => {", "author": "edalex-ian", "createdAt": "2020-09-03T07:49:05Z", "path": "Source/Plugins/Core/com.equella.core/js/__tests__/tsrc/modules/SearchModule.test.ts", "diffHunk": "@@ -25,72 +26,81 @@ const mockedSearch = (OEQ.Search.search as jest.Mock<\n >).mockResolvedValue(getSearchResult);\n \n describe(\"SearchModule\", () => {\n-  it(\"should provide an list of items\", async () => {\n-    const searchResult = await SearchModule.searchItems(\n-      SearchModule.defaultSearchOptions\n-    );\n-    expect(searchResult.available).toBe(12);\n-    expect(searchResult.results).toHaveLength(12);\n-  });\n+  describe(\"searchItems\", () => {\n+    it(\"should provide an list of items\", async () => {", "originalCommit": "5c9248f13487fdaca77030068272458dcc6492e3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mjc3OTA1NQ==", "url": "https://github.com/openequella/openEQUELLA/pull/2245#discussion_r482779055", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                it(\"should generate a where clause for one category\", () => {\n          \n          \n            \n            \n          \n          \n            \n                it(\"should generate a where clause for one category\", () => {", "author": "edalex-ian", "createdAt": "2020-09-03T07:52:15Z", "path": "Source/Plugins/Core/com.equella.core/js/__tests__/tsrc/modules/SearchModule.test.ts", "diffHunk": "@@ -25,72 +26,81 @@ const mockedSearch = (OEQ.Search.search as jest.Mock<\n >).mockResolvedValue(getSearchResult);\n \n describe(\"SearchModule\", () => {\n-  it(\"should provide an list of items\", async () => {\n-    const searchResult = await SearchModule.searchItems(\n-      SearchModule.defaultSearchOptions\n-    );\n-    expect(searchResult.available).toBe(12);\n-    expect(searchResult.results).toHaveLength(12);\n-  });\n+  describe(\"searchItems\", () => {\n+    it(\"should provide an list of items\", async () => {\n+      const searchResult = await SearchModule.searchItems(\n+        SearchModule.defaultSearchOptions\n+      );\n+      expect(searchResult.available).toBe(12);\n+      expect(searchResult.results).toHaveLength(12);\n+    });\n \n-  const validateSearchQuery = (expectedQuery: string) => {\n-    const calls = mockedSearch.mock.calls;\n-    const params = calls[0][1]; // Second parameter of the call is the 'params'\n-    expect(params.query).toEqual(expectedQuery);\n-  };\n+    const validateSearchQuery = (expectedQuery: string) => {\n+      const calls = mockedSearch.mock.calls;\n+      const params = calls[0][1]; // Second parameter of the call is the 'params'\n+      expect(params.query).toEqual(expectedQuery);\n+    };\n \n-  it(\"should not append a wildcard for a search which is empty when trimmed\", async () => {\n-    mockedSearch.mockReset();\n-    await SearchModule.searchItems({\n-      ...SearchModule.defaultSearchOptions,\n-      query: \"   \",\n+    it(\"should not append a wildcard for a search which is empty when trimmed\", async () => {\n+      mockedSearch.mockReset();\n+      await SearchModule.searchItems({\n+        ...SearchModule.defaultSearchOptions,\n+        query: \"   \",\n+      });\n+      validateSearchQuery(\"\");\n     });\n-    validateSearchQuery(\"\");\n-  });\n \n-  it(\"should append a wildcard for a search non-rawMode, non-empty query\", async () => {\n-    mockedSearch.mockReset();\n-    const queryTerm = \"non RAW\";\n-    await SearchModule.searchItems({\n-      ...SearchModule.defaultSearchOptions,\n-      query: queryTerm,\n+    it(\"should append a wildcard for a search non-rawMode, non-empty query\", async () => {\n+      mockedSearch.mockReset();\n+      const queryTerm = \"non RAW\";\n+      await SearchModule.searchItems({\n+        ...SearchModule.defaultSearchOptions,\n+        query: queryTerm,\n+      });\n+      validateSearchQuery(`${queryTerm}*`);\n     });\n-    validateSearchQuery(`${queryTerm}*`);\n-  });\n \n-  it(\"should NOT append a wildcard for a rawMode search with a non-empty query\", async () => {\n-    mockedSearch.mockReset();\n-    const queryTerm = \"RAW mode!\";\n-    await SearchModule.searchItems({\n-      ...SearchModule.defaultSearchOptions,\n-      query: queryTerm,\n-      rawMode: true,\n+    it(\"should NOT append a wildcard for a rawMode search with a non-empty query\", async () => {\n+      mockedSearch.mockReset();\n+      const queryTerm = \"RAW mode!\";\n+      await SearchModule.searchItems({\n+        ...SearchModule.defaultSearchOptions,\n+        query: queryTerm,\n+        rawMode: true,\n+      });\n+      validateSearchQuery(`${queryTerm}`);\n     });\n-    validateSearchQuery(`${queryTerm}`);\n   });\n \n-  it(\"should append Classification terms to query if one or more Classifications are selected\", async () => {\n-    mockedSearch.mockReset();\n-    const query = \"technology\";\n-    const terms = [\"Java\", \"Scala\", \"SBT\"];\n-    await SearchModule.searchItems({\n-      ...SearchModule.defaultSearchOptions,\n-      query: query,\n-      rawMode: false,\n-      classificationTerms: terms,\n+  describe(\"generateCategoryWhereQuery\", () => {\n+    const selectedCategories: SelectedCategories[] = [\n+      {\n+        id: 766942,\n+        schemaNode: \"/item/language\",\n+        categories: [\"Java\", \"Scala\"],\n+      },\n+      {\n+        id: 766943,\n+        schemaNode: \"/item/city\",\n+        categories: [\"Hobart\"],\n+      },\n+    ];\n+    it(\"should generate a where clause for one category\", () => {", "originalCommit": "5c9248f13487fdaca77030068272458dcc6492e3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "4c1793992dc3acd2cd6a39e48d5ceb5cc28e709a", "url": "https://github.com/openequella/openEQUELLA/commit/4c1793992dc3acd2cd6a39e48d5ceb5cc28e709a", "message": "Fix some typo, naming and formatting issues for Category Selector.", "committedDate": "2020-09-04T05:26:30Z", "type": "commit"}, {"oid": "f844d1dde524328bac65794627b547ae549b26e5", "url": "https://github.com/openequella/openEQUELLA/commit/f844d1dde524328bac65794627b547ae549b26e5", "message": "Improve the readability of function 'listCategories'.", "committedDate": "2020-09-04T05:27:40Z", "type": "commit"}, {"oid": "e70aae7609bc28b46b34812ed23fcfa39300ce0a", "url": "https://github.com/openequella/openEQUELLA/commit/e70aae7609bc28b46b34812ed23fcfa39300ce0a", "message": "Ensure Category Selector storybook works properly with 'argTypes'.", "committedDate": "2020-09-04T05:35:54Z", "type": "commit"}]}