{"pr_number": 2298, "pr_title": "Highlight search terms in the results", "pr_createdAt": "2020-09-17T05:55:48Z", "pr_url": "https://github.com/openequella/openEQUELLA/pull/2298", "timeline": [{"oid": "64eb0a163a35350a14b414fe28f36023e39007b5", "url": "https://github.com/openequella/openEQUELLA/commit/64eb0a163a35350a14b414fe28f36023e39007b5", "message": "front-end: Convert java TextUtils to Typescript\n\nThis contains the core of what the Legacy UI uses to highlight search results. So to ensure consistency with what users are used to, let's simply do a conversion for now.", "committedDate": "2020-09-17T05:31:35Z", "type": "commit"}, {"oid": "3b3a92d1c5ed88a6bab058ff3dff195d8ae30bbc", "url": "https://github.com/openequella/openEQUELLA/commit/3b3a92d1c5ed88a6bab058ff3dff195d8ae30bbc", "message": "front-end: Refactor SearchResult.stories.tsx to use SB 6\n\nAlso added a story to show keyword found in attachment.", "committedDate": "2020-09-17T05:31:35Z", "type": "commit"}, {"oid": "4a03d923898663962d7ad456ae6d1b7754819f6a", "url": "https://github.com/openequella/openEQUELLA/commit/4a03d923898663962d7ad456ae6d1b7754819f6a", "message": "front-end: Highlight title and description of search results", "committedDate": "2020-09-17T05:31:35Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTk4ODMwNw==", "url": "https://github.com/openequella/openEQUELLA/pull/2298#discussion_r489988307", "bodyText": "Just fixing a typo.", "author": "edalex-ian", "createdAt": "2020-09-17T05:57:27Z", "path": "Source/Plugins/Core/com.equella.core/js/tsrc/search/components/SearchResult.tsx", "diffHunk": "@@ -79,34 +80,51 @@ const useStyles = makeStyles((theme: Theme) => {\n       color: theme.palette.secondary.main,\n       borderRadius: \"50%\",\n     },\n+    highlight: {\n+      color: theme.palette.secondary.main,\n+    },\n   };\n });\n \n+export interface SearchResultProps {\n+  /**\n+   * The details of the items to display.\n+   */\n+  item: OEQ.Search.SearchResultItem;\n+\n+  /**\n+   * The list of words which should be highlighted.\n+   */\n+  highlights: string[];\n+}\n+\n export default function SearchResult({\n-  name,\n-  version,\n-  uuid,\n-  description,\n-  displayFields,\n-  modifiedDate,\n-  status,\n-  displayOptions,\n-  attachments,\n-  keywordFoundInAttachment,\n-  links,\n-}: OEQ.Search.SearchResultItem) {\n+  item: {\n+    name,\n+    version,\n+    uuid,\n+    description,\n+    displayFields,\n+    modifiedDate,\n+    status,\n+    displayOptions,\n+    attachments,\n+    keywordFoundInAttachment,\n+  },\n+  highlights,\n+}: SearchResultProps) {\n   const classes = useStyles();\n \n   const searchResultStrings = languageStrings.searchpage.searchresult;\n \n-  const [attachExapanded, setAttachExpanded] = React.useState(\n+  const [attachExpanded, setAttachExpanded] = React.useState(", "originalCommit": "4a03d923898663962d7ad456ae6d1b7754819f6a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDYxNDc3NA==", "url": "https://github.com/openequella/openEQUELLA/pull/2298#discussion_r490614774", "bodyText": "Is it possible to type args?", "author": "SammyIsConfused", "createdAt": "2020-09-17T23:23:05Z", "path": "Source/Plugins/Core/com.equella.core/js/__stories__/search/SearchResult.stories.tsx", "diffHunk": "@@ -15,131 +15,64 @@\n  * See the License for the specific language governing permissions and\n  * limitations under the License.\n  */\n+import type { Story } from \"@storybook/react\";\n import * as React from \"react\";\n import * as mockData from \"../../__mocks__/searchresult_mock_data\";\n-import SearchResult from \"../../tsrc/search/components/SearchResult\";\n-import { boolean, number, object, text } from \"@storybook/addon-knobs\";\n+import SearchResult, {\n+  SearchResultProps,\n+} from \"../../tsrc/search/components/SearchResult\";\n \n export default {\n   title: \"Search/SearchResult\",\n   component: SearchResult,\n };\n-const defaultItemName = \"Item Name\";\n-const defaultItemDescription = \"Item Description\";\n \n-export const BasicSearchResultComponent = () => (\n-  <SearchResult\n-    name={text(\"name\", mockData.basicSearchObj.name || defaultItemName)}\n-    version={number(\"version\", mockData.basicSearchObj.version)}\n-    uuid={text(\"uuid\", mockData.basicSearchObj.uuid)}\n-    description={text(\n-      \"description\",\n-      mockData.basicSearchObj.description || defaultItemDescription\n-    )}\n-    displayFields={object(\"display fields\", [\n-      ...mockData.basicSearchObj.displayFields,\n-    ])}\n-    modifiedDate={object(\"modified date\", mockData.basicSearchObj.modifiedDate)}\n-    createdDate={object(\"created date\", mockData.basicSearchObj.createdDate)}\n-    status={text(\"item status\", mockData.basicSearchObj.status)}\n-    displayOptions={object(\n-      \"display options\",\n-      mockData.basicSearchObj.displayOptions\n-    )}\n-    attachments={object(\"attachments\", [\n-      ...mockData.basicSearchObj.attachments,\n-    ])}\n-    links={object(\"links\", mockData.basicSearchObj.links)}\n-    collectionId={text(\"collection ID\", mockData.basicSearchObj.collectionId)}\n-    commentCount={number(\"comment count\", mockData.basicSearchObj.commentCount)}\n-    thumbnail={text(\"thumbnail\", mockData.basicSearchObj.thumbnail)}\n-    keywordFoundInAttachment={boolean(\n-      \"keywordFoundInAttachment\",\n-      mockData.basicSearchObj.keywordFoundInAttachment\n-    )}\n-  />\n+export const BasicSearchResult: Story<SearchResultProps> = (args) => (\n+  <SearchResult {...args} />\n );\n+BasicSearchResult.args = {\n+  item: {\n+    ...mockData.basicSearchObj,\n+  },\n+  highlights: [],\n+};\n+\n+export const AttachmentSearchResult: Story<SearchResultProps> = (args) => (", "originalCommit": "4a03d923898663962d7ad456ae6d1b7754819f6a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDYyMTU1MA==", "url": "https://github.com/openequella/openEQUELLA/pull/2298#discussion_r490621550", "bodyText": "It's possible, but kind of redundant and doesn't seem the idiomatic way. I guess that's also because the type of args is that of the Story generic and would just look like:\nconst AttachmentSearchResult: Story<SearchResultProps> = (args: SearchResultProps) => (", "author": "edalex-ian", "createdAt": "2020-09-17T23:45:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDYxNDc3NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDYxNTQzNQ==", "url": "https://github.com/openequella/openEQUELLA/pull/2298#discussion_r490615435", "bodyText": "If you are using spread here with no modifiers, surely you can just use it directly?\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                      item={{ ...itemResult }}\n          \n          \n            \n                      item={ itemResult }", "author": "SammyIsConfused", "createdAt": "2020-09-17T23:25:12Z", "path": "Source/Plugins/Core/com.equella.core/js/__tests__/tsrc/search/components/SearchResult.test.tsx", "diffHunk": "@@ -29,7 +29,11 @@ describe(\"<SearchResult/>\", () => {\n     return render(\n       //This needs to be wrapped inside a BrowserRouter, to prevent an `Invariant failed: You should not use <Link> outside a <Router>` error  because of the <Link/> tag within SearchResult\n       <BrowserRouter>\n-        <SearchResult {...itemResult} key={itemResult.uuid} />\n+        <SearchResult\n+          key={itemResult.uuid}\n+          item={{ ...itemResult }}", "originalCommit": "4a03d923898663962d7ad456ae6d1b7754819f6a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDYyMTg5Mg==", "url": "https://github.com/openequella/openEQUELLA/pull/2298#discussion_r490621892", "bodyText": "hmmmm... \ud83e\udd14\nI originally saw this as a copy of the object, but it was more so spreading it so that it's populate the old props. So yes, with the new props I could happily just drop it in. I'll tweak it.", "author": "edalex-ian", "createdAt": "2020-09-17T23:46:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDYxNTQzNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDYxNjQyNw==", "url": "https://github.com/openequella/openEQUELLA/pull/2298#discussion_r490616427", "bodyText": "Do we need tests for the functions in this file?", "author": "SammyIsConfused", "createdAt": "2020-09-17T23:28:37Z", "path": "Source/Plugins/Core/com.equella.core/js/tsrc/util/TextUtils.ts", "diffHunk": "@@ -0,0 +1,78 @@\n+/*\n+ * Licensed to The Apereo Foundation under one or more contributor license\n+ * agreements. See the NOTICE file distributed with this work for additional\n+ * information regarding copyright ownership.\n+ *\n+ * The Apereo Foundation licenses this file to you under the Apache License,\n+ * Version 2.0, (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+/**\n+ * Based on work from com.tle.web.sections.render.TextUtils\n+ */\n+\n+const removeNonWordCharacters = (highlight: string): string =>", "originalCommit": "4a03d923898663962d7ad456ae6d1b7754819f6a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDYyMjYxMw==", "url": "https://github.com/openequella/openEQUELLA/pull/2298#discussion_r490622613", "bodyText": "There is some coverage of this due to the tests in TextUtils.test.ts. True it's not exhaustive, but seeing this was a conversion of the old I think it'll do for now.\nIf there were test for the Java, I would've converted this too. But to derive all the cases this was attempting to address - without tests or doco - was not justified effort.", "author": "edalex-ian", "createdAt": "2020-09-17T23:49:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDYxNjQyNw=="}], "type": "inlineReview"}, {"oid": "fd6ccb92ad6acab171923ec2f54d1985162586f9", "url": "https://github.com/openequella/openEQUELLA/commit/fd6ccb92ad6acab171923ec2f54d1985162586f9", "message": "front-end: Remove redundant spread operators", "committedDate": "2020-09-18T00:04:21Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDYyNDQ0Nw==", "url": "https://github.com/openequella/openEQUELLA/pull/2298#discussion_r490624447", "bodyText": "I can basically imagine what string this regex will match, but can we have a simple example here?", "author": "PenghaiZhang", "createdAt": "2020-09-17T23:56:06Z", "path": "Source/Plugins/Core/com.equella.core/js/tsrc/util/TextUtils.ts", "diffHunk": "@@ -0,0 +1,78 @@\n+/*\n+ * Licensed to The Apereo Foundation under one or more contributor license\n+ * agreements. See the NOTICE file distributed with this work for additional\n+ * information regarding copyright ownership.\n+ *\n+ * The Apereo Foundation licenses this file to you under the Apache License,\n+ * Version 2.0, (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+/**\n+ * Based on work from com.tle.web.sections.render.TextUtils\n+ */\n+\n+const removeNonWordCharacters = (highlight: string): string =>\n+  highlight\n+    .replace(/\\\\/g, \"\")\n+    .replace(/\\./g, \"\")\n+    .replace(/\\(/g, \"\")\n+    .replace(/\\)/g, \"\")\n+    .replace(/\\[/g, \"\")\n+    .replace(/]/g, \"\")\n+    .replace(/\\+/g, \"\")\n+    .replace(/\\?/g, \".?\")\n+    .replace(/\\*/g, \"\\\\w*\")\n+    .replace(/\\|/g, \"\");\n+\n+const highlightsAsRegex = (highlights: string[]) =>\n+  highlights\n+    .map((h) => h.trim())\n+    .filter((h) => h.length > 0)\n+    .map((h) => removeNonWordCharacters(h))\n+    .filter((h) => h.length > 0)\n+    .join(\"|\");\n+\n+/**\n+ * Takes a line of text and a list of words which should be highlighted within that line. It returns\n+ * a `string` which contains the text, and the listed words encapsulated within `span`s\n+ * having the specified `class`.\n+ *\n+ * @param text Plain text to be highlighted\n+ * @param highlights A list of words to highlight\n+ * @param cssClass The CSS class to apply to the highlighting spans\n+ */\n+export const highlight = (\n+  text: string,\n+  highlights: string[],\n+  cssClass: string\n+): string => {\n+  const highlightsRegex = highlightsAsRegex(highlights);\n+  if (highlights.length < 1) {\n+    // Nothing to highlight\n+    return text;\n+  }\n+\n+  const re = new RegExp(\"^(.*?)\\\\b(\" + highlightsRegex + \")\\\\b(.*)$\", \"is\");", "originalCommit": "4a03d923898663962d7ad456ae6d1b7754819f6a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDYzMTQ5Mw==", "url": "https://github.com/openequella/openEQUELLA/pull/2298#discussion_r490631493", "bodyText": "Yeah, fair point. I've copied this across from the Java side (which had no doco) and so I've put it as was. But indeed, as I normally tell others, if you're going to have a regex, then you should document it as per best practice.\nI'll work on breaking it down and documenting it. \ud83d\udc4d", "author": "edalex-ian", "createdAt": "2020-09-18T00:21:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDYyNDQ0Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDYzMTcxMw==", "url": "https://github.com/openequella/openEQUELLA/pull/2298#discussion_r490631713", "bodyText": "If my understanding is right, I won't see\n<span class=\"${className}\">knives</span>\nif I search knife* ? oEQ's highlight approach does not include any stemming analyzer.", "author": "PenghaiZhang", "createdAt": "2020-09-18T00:22:00Z", "path": "Source/Plugins/Core/com.equella.core/js/__tests__/tsrc/util/TextUtils.test.ts", "diffHunk": "@@ -0,0 +1,39 @@\n+/*\n+ * Licensed to The Apereo Foundation under one or more contributor license\n+ * agreements. See the NOTICE file distributed with this work for additional\n+ * information regarding copyright ownership.\n+ *\n+ * The Apereo Foundation licenses this file to you under the Apache License,\n+ * Version 2.0, (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+import { highlight } from \"../../../tsrc/util/TextUtils\";\n+\n+describe(\"Highlighting of Text\", () => {\n+  const className = \"highlighted\";\n+  it.each([\n+    [\n+      \"The quick brown fox jumps over the lazy dog\",\n+      [\"The\", \"fox\", \"dog\"],\n+      `<span class=\"${className}\">The</span> quick brown <span class=\"${className}\">fox</span> jumps over <span class=\"${className}\">the</span> lazy <span class=\"${className}\">dog</span>`,\n+    ],\n+    [\n+      \"The life of kelpies explained\",\n+      [\"kelp*\"],\n+      `The life of <span class=\"${className}\">kelpies</span> explained`,", "originalCommit": "fd6ccb92ad6acab171923ec2f54d1985162586f9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDYzMjI0Nw==", "url": "https://github.com/openequella/openEQUELLA/pull/2298#discussion_r490632247", "bodyText": "That is correct. But that's also not something new due to this PR - i.e. this PR maintains the status quo. This is indeed one of the issues in oEQ not using the Lucene highlighting and instead doing it's own after the fact.", "author": "edalex-ian", "createdAt": "2020-09-18T00:24:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDYzMTcxMw=="}], "type": "inlineReview"}, {"oid": "eb5c6152548bcd61922cf7488957bd6f57c7269c", "url": "https://github.com/openequella/openEQUELLA/commit/eb5c6152548bcd61922cf7488957bd6f57c7269c", "message": "front-end: Document highlighting regular expression", "committedDate": "2020-09-18T06:40:19Z", "type": "commit"}]}