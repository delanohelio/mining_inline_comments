{"pr_number": 2572, "pr_title": "Feature - Advanced search selector", "pr_createdAt": "2020-11-30T06:09:56Z", "pr_url": "https://github.com/openequella/openEQUELLA/pull/2572", "timeline": [{"oid": "685002860ca0ca96b5556a90393792748a580cad", "url": "https://github.com/openequella/openEQUELLA/commit/685002860ca0ca96b5556a90393792748a580cad", "message": "refactor(front-end): Make RemoteSearchSelector generic\n\nRemoteSearchSelector is the same as what we'll need for Advanced Searches. So change it to a generic component that we can re-use.", "committedDate": "2020-11-30T05:45:56Z", "type": "commit"}, {"oid": "5de65baea2add725d0e0bb89f466c68b487edcb8", "url": "https://github.com/openequella/openEQUELLA/commit/5de65baea2add725d0e0bb89f466c68b487edcb8", "message": "feat(front-end): Add ability to navigate to Advanced Searches (from New Search UI)\n\nThis also required a refactor of how we route to the Search page, as it straddles the old and new due to the use of search.do to get to Advanced Searches.", "committedDate": "2020-11-30T05:45:56Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzAwMzM3OA==", "url": "https://github.com/openequella/openEQUELLA/pull/2572#discussion_r533003378", "bodyText": "What about adding some comments here to explain the logic ?\nThe logic here in my understanding is: if the current path ends with \"/page/search\", return true; if it doesn't , but if new Search UI is enabled and the request is not for an advanced search, then returns true.\nSo I image that if we turn on new Search and the request is for advanced search, we will see LegacyPage, which is what we want.", "author": "PenghaiZhang", "createdAt": "2020-12-01T00:59:38Z", "path": "Source/Plugins/Core/com.equella.core/js/tsrc/mainui/IndexPage.tsx", "diffHunk": "@@ -159,7 +161,35 @@ export default function IndexPage() {\n     setFullPageError(err);\n   }, []);\n \n-  function routeSwitch(content?: PageContent) {\n+  const routeSwitch = (content?: PageContent) => {\n+    const oldSearchPagePath = \"/searching.do\";\n+    const newSearchPagePath = \"/page/search\";\n+\n+    const newOrOldSearch = (location: Location): boolean => {\n+      const currentParams = new URLSearchParams(location.search);\n+      const currentPath = location.pathname;\n+\n+      const advancedSearchParamsPresent: boolean =\n+        currentParams.get(\"in\")?.startsWith(\"P\") ?? false;\n+      const advancedSearchRequested: boolean =\n+        currentPath.endsWith(oldSearchPagePath) && advancedSearchParamsPresent;\n+      const newSearchEnabled: boolean =\n+        typeof renderData !== \"undefined\" && renderData?.newSearch;\n+\n+      return (\n+        currentPath.match(newSearchPagePath) !== null ||\n+        (newSearchEnabled && !advancedSearchRequested)", "originalCommit": "5de65baea2add725d0e0bb89f466c68b487edcb8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzAyMzM0Nw==", "url": "https://github.com/openequella/openEQUELLA/pull/2572#discussion_r533023347", "bodyText": "Yup, sounds like you've got it. But! I'm happy (and see value in) adding some doco here. So will do.", "author": "edalex-ian", "createdAt": "2020-12-01T02:00:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzAwMzM3OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzAwNjA1NA==", "url": "https://github.com/openequella/openEQUELLA/pull/2572#discussion_r533006054", "bodyText": "I think that once we remove the switch for newSearchEnabled we need to change here accordingly. Do we need to todo to remind? It's not a big deal though.", "author": "PenghaiZhang", "createdAt": "2020-12-01T01:07:24Z", "path": "Source/Plugins/Core/com.equella.core/js/tsrc/mainui/IndexPage.tsx", "diffHunk": "@@ -159,7 +161,35 @@ export default function IndexPage() {\n     setFullPageError(err);\n   }, []);\n \n-  function routeSwitch(content?: PageContent) {\n+  const routeSwitch = (content?: PageContent) => {\n+    const oldSearchPagePath = \"/searching.do\";\n+    const newSearchPagePath = \"/page/search\";\n+\n+    const newOrOldSearch = (location: Location): boolean => {\n+      const currentParams = new URLSearchParams(location.search);\n+      const currentPath = location.pathname;\n+\n+      const advancedSearchParamsPresent: boolean =\n+        currentParams.get(\"in\")?.startsWith(\"P\") ?? false;\n+      const advancedSearchRequested: boolean =\n+        currentPath.endsWith(oldSearchPagePath) && advancedSearchParamsPresent;\n+      const newSearchEnabled: boolean =\n+        typeof renderData !== \"undefined\" && renderData?.newSearch;", "originalCommit": "5de65baea2add725d0e0bb89f466c68b487edcb8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzAyNDAyMA==", "url": "https://github.com/openequella/openEQUELLA/pull/2572#discussion_r533024020", "bodyText": "Good point. When we remove that, then this will indeed change. I'll mark with a TODO. \ud83d\udc4d\n(I'm not to sure what that change will look like mind you, but I guess we can figure that when we get to it - I think we remove the whole check, as we should only be here if NewUI is on).", "author": "edalex-ian", "createdAt": "2020-12-01T02:02:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzAwNjA1NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzAyNzA5NA==", "url": "https://github.com/openequella/openEQUELLA/pull/2572#discussion_r533027094", "bodyText": "Yeah that's what is in my mind.", "author": "PenghaiZhang", "createdAt": "2020-12-01T02:12:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzAwNjA1NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzAxMzM0Mg==", "url": "https://github.com/openequella/openEQUELLA/pull/2572#discussion_r533013342", "bodyText": "I am trying to think what will happen in Selection Session.\nFor example, we are in the My Resources and we click Search, and the URL must be search.do and does not include in. So this function will true. Consequently, SearchPage will get rendered instead of LegacyPage.\nI want to do some testing but I realise this PR is targeting develop...", "author": "PenghaiZhang", "createdAt": "2020-12-01T01:29:50Z", "path": "Source/Plugins/Core/com.equella.core/js/tsrc/mainui/IndexPage.tsx", "diffHunk": "@@ -172,17 +202,19 @@ export default function IndexPage() {\n         </Route>\n         {newUIRoutes}\n         <Route\n-          render={(p) => (\n-            <LegacyPage\n-              {...mkRouteProps(p)}\n-              errorCallback={errorCallback}\n-              legacyContent={{ content, setLegacyContentProps }}\n-            />\n-          )}\n+          path={[newSearchPagePath, oldSearchPagePath]}\n+          render={(p) =>\n+            newOrOldSearch(window.location) ? (", "originalCommit": "5de65baea2add725d0e0bb89f466c68b487edcb8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzAyNDUwNg==", "url": "https://github.com/openequella/openEQUELLA/pull/2572#discussion_r533024506", "bodyText": "Ohhh, ummm, aaaahh... Not sure.\nMaybe we merge this into develop first, then once that's done let's attempt a merge over to Selection Session and see what needs to be fixed. Maybe we need to use some of your new inSelectionSession() etc.", "author": "edalex-ian", "createdAt": "2020-12-01T02:04:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzAxMzM0Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzAyNjg0NA==", "url": "https://github.com/openequella/openEQUELLA/pull/2572#discussion_r533026844", "bodyText": "Good plan!", "author": "PenghaiZhang", "createdAt": "2020-12-01T02:11:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzAxMzM0Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzA0MTY1OA==", "url": "https://github.com/openequella/openEQUELLA/pull/2572#discussion_r533041658", "bodyText": "nit: might be good to use mocked uuids in a proper format here.", "author": "SammyIsConfused", "createdAt": "2020-12-01T02:59:41Z", "path": "Source/Plugins/Core/com.equella.core/js/__mocks__/AdvancedSearchModule.mock.ts", "diffHunk": "@@ -0,0 +1,24 @@\n+/*\n+ * Licensed to The Apereo Foundation under one or more contributor license\n+ * agreements. See the NOTICE file distributed with this work for additional\n+ * information regarding copyright ownership.\n+ *\n+ * The Apereo Foundation licenses this file to you under the Apache License,\n+ * Version 2.0, (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+import * as OEQ from \"@openequella/rest-api-client\";\n+\n+export const getAdvancedSearchesFromServerResult: OEQ.Common.BaseEntitySummary[] = [\n+  { name: \"Advanced Search 1\", uuid: \"123\" },", "originalCommit": "5de65baea2add725d0e0bb89f466c68b487edcb8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzA0NDAxNA==", "url": "https://github.com/openequella/openEQUELLA/pull/2572#discussion_r533044014", "bodyText": "Up to preference, but I'd use less abbreviated titles for acc and cur. Without knowing offhand what RefinePanelControl contains, its hard to know at-a-glance what these are for.  Makes sense with the c on line 90 as it is right next to the controls identifier, but here its a bit more opaque.", "author": "SammyIsConfused", "createdAt": "2020-12-01T03:07:49Z", "path": "Source/Plugins/Core/com.equella.core/js/tsrc/search/components/RefineSearchPanel.tsx", "diffHunk": "@@ -79,9 +83,24 @@ export const RefineSearchPanel = ({\n \n   const { showMore, showLess } = languageStrings.common.action;\n \n-  const [alwaysVisibleControl, ...collapsedControls] = controls.filter(\n-    (c) => !c.disabled\n-  );\n+  const {\n+    visible: alwaysVisibleControls,\n+    collapsed: collapsedControls,\n+  } = controls\n+    .filter((c) => !c.disabled)\n+    .reduce(\n+      (acc, cur: RefinePanelControl) => {", "originalCommit": "5de65baea2add725d0e0bb89f466c68b487edcb8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzA1NTI1Mw==", "url": "https://github.com/openequella/openEQUELLA/pull/2572#discussion_r533055253", "bodyText": "These are the conventional params for reduce functions. So better highlights the algorithm.", "author": "edalex-ian", "createdAt": "2020-12-01T03:49:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzA0NDAxNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzA1NjMxNg==", "url": "https://github.com/openequella/openEQUELLA/pull/2572#discussion_r533056316", "bodyText": "Ah of course my mistake, the accumulator and currentValue. I read this as if it was [acc, cur] : RefinePanelControl. In that case, this is fine to ignore.", "author": "SammyIsConfused", "createdAt": "2020-12-01T03:53:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzA0NDAxNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzA0NDMwNA==", "url": "https://github.com/openequella/openEQUELLA/pull/2572#discussion_r533044304", "bodyText": "Are we forgoing the general rule for openEquella strings only being capitalized on the first word for Advanced and Remote search? If not, this should be changed to \"Access advanced searches\".", "author": "SammyIsConfused", "createdAt": "2020-12-01T03:09:06Z", "path": "Source/Plugins/Core/com.equella.core/js/tsrc/util/langstrings.ts", "diffHunk": "@@ -379,6 +379,9 @@ export const languageStrings = {\n     refineSearchPanel: {\n       title: \"Refine search\",\n     },\n+    advancedSearchSelector: {\n+      title: \"Access Advanced searches\",", "originalCommit": "5de65baea2add725d0e0bb89f466c68b487edcb8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzA1NTA2OA==", "url": "https://github.com/openequella/openEQUELLA/pull/2572#discussion_r533055068", "bodyText": "Strictly following @cathfitz 's convention with 'Access Remote searches'.", "author": "edalex-ian", "createdAt": "2020-12-01T03:48:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzA0NDMwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzA1NTc2Ng==", "url": "https://github.com/openequella/openEQUELLA/pull/2572#discussion_r533055766", "bodyText": "Okay, no worries.", "author": "SammyIsConfused", "createdAt": "2020-12-01T03:50:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzA0NDMwNA=="}], "type": "inlineReview"}, {"oid": "76ec7ccb9be5e17c305280d67521e1233270f4d9", "url": "https://github.com/openequella/openEQUELLA/commit/76ec7ccb9be5e17c305280d67521e1233270f4d9", "message": "Merge branch 'develop' into feature/advanced_search_selector", "committedDate": "2020-12-01T05:44:43Z", "type": "commit"}, {"oid": "1b42d52a19155ad5e6cb4e0623f2c94bf7096ab5", "url": "https://github.com/openequella/openEQUELLA/commit/1b42d52a19155ad5e6cb4e0623f2c94bf7096ab5", "message": "chore(front-end): Add documentation for route switch\n\nThere's a bit of complexity as to when and how to trigger the New Search page due to straddling the old and new modes for other search related features. So here I attempt to capture that for easier reading.\n\nFeedback from PR #2572", "committedDate": "2020-12-01T06:10:56Z", "type": "commit"}, {"oid": "7a0a273768968dc4358a8685e21de4ce61b679f2", "url": "https://github.com/openequella/openEQUELLA/commit/7a0a273768968dc4358a8685e21de4ce61b679f2", "message": "chore(front-end): Use real UUIDs in mocks\n\nFeedback from PR #2572", "committedDate": "2020-12-01T06:17:37Z", "type": "commit"}]}