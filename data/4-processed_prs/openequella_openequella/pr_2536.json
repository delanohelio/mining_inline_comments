{"pr_number": 2536, "pr_title": "Feature/share search button", "pr_createdAt": "2020-11-19T10:31:40Z", "pr_url": "https://github.com/openequella/openEQUELLA/pull/2536", "timeline": [{"oid": "7560bdd853c515d3b32d09c4825d0540f8ffabad", "url": "https://github.com/openequella/openEQUELLA/commit/7560bdd853c515d3b32d09c4825d0540f8ffabad", "message": "Added 'copy search link' button to search result list", "committedDate": "2020-11-19T10:10:36Z", "type": "commit"}, {"oid": "4ec08bd66a3a59bd2f3a2ce3e2a2645a6111431b", "url": "https://github.com/openequella/openEQUELLA/commit/4ec08bd66a3a59bd2f3a2ce3e2a2645a6111431b", "message": "Put in a null check before mapping over collections. This addresses an issue when I came accross while clciking the copy search button on an already copied link", "committedDate": "2020-11-19T10:10:36Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzI1NTg3OQ==", "url": "https://github.com/openequella/openEQUELLA/pull/2536#discussion_r527255879", "bodyText": "Why added this question mark may I ask ? The type of value is Array which should ensure it won't be undefined or null.", "author": "PenghaiZhang", "createdAt": "2020-11-19T22:48:36Z", "path": "Source/Plugins/Core/com.equella.core/js/tsrc/modules/SearchModule.ts", "diffHunk": "@@ -274,7 +274,7 @@ export const generateQueryStringFromSearchOptions = (\n       return match(\n         [\n           Literal(\"collections\"),\n-          () => value.map((collection) => pick(collection, [\"uuid\"])),\n+          () => value?.map((collection) => pick(collection, [\"uuid\"])),", "originalCommit": "4ec08bd66a3a59bd2f3a2ce3e2a2645a6111431b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDcwNjE2Mg==", "url": "https://github.com/openequella/openEQUELLA/pull/2536#discussion_r530706162", "bodyText": "This is marked resolved but there is no answer or change?", "author": "edalex-ian", "createdAt": "2020-11-26T00:25:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzI1NTg3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDc3MjM3NA==", "url": "https://github.com/openequella/openEQUELLA/pull/2536#discussion_r530772374", "bodyText": "I thought I had put a comment for this one \ud83e\udd14\nBut, without the ? it can get into that match with an undefined value", "author": "mrblippy", "createdAt": "2020-11-26T04:50:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzI1NTg3OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzI1NjMyMQ==", "url": "https://github.com/openequella/openEQUELLA/pull/2536#discussion_r527256321", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            import { RenderData } from \"../mainui\";\n          \n          \n            \n            import type { RenderData } from \"../mainui\";", "author": "PenghaiZhang", "createdAt": "2020-11-19T22:49:37Z", "path": "Source/Plugins/Core/com.equella.core/js/tsrc/search/SearchPage.tsx", "diffHunk": "@@ -24,7 +24,10 @@ import { useEffect, useRef, useState } from \"react\";\n import { useHistory, useLocation } from \"react-router\";\n import { Static } from \"runtypes\";\n import { generateFromError } from \"../api/errors\";\n+import { AppConfig } from \"../AppConfig\";\n import { DateRangeSelector } from \"../components/DateRangeSelector\";\n+import MessageInfo from \"../components/MessageInfo\";\n+import { RenderData } from \"../mainui\";", "originalCommit": "4ec08bd66a3a59bd2f3a2ce3e2a2645a6111431b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzI1NzUxMA==", "url": "https://github.com/openequella/openEQUELLA/pull/2536#discussion_r527257510", "bodyText": "You can reuse searchStrings.", "author": "PenghaiZhang", "createdAt": "2020-11-19T22:51:50Z", "path": "Source/Plugins/Core/com.equella.core/js/tsrc/search/SearchPage.tsx", "diffHunk": "@@ -288,6 +295,27 @@ const SearchPage = ({ updateTemplate }: TemplateUpdateProps) => {\n     setFilterExpansion(false);\n   };\n \n+  const copySearchInfoSnackbar = (\n+    <MessageInfo\n+      open={showSnackBar}\n+      onClose={() => setShowSnackBar(false)}\n+      title={languageStrings.searchpage.shareSearchConfirmationText}", "originalCommit": "4ec08bd66a3a59bd2f3a2ce3e2a2645a6111431b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzI2MDUxNg==", "url": "https://github.com/openequella/openEQUELLA/pull/2536#discussion_r527260516", "bodyText": "Is there any possibility that writeText could fail ?", "author": "PenghaiZhang", "createdAt": "2020-11-19T22:58:33Z", "path": "Source/Plugins/Core/com.equella.core/js/tsrc/search/SearchPage.tsx", "diffHunk": "@@ -288,6 +295,27 @@ const SearchPage = ({ updateTemplate }: TemplateUpdateProps) => {\n     setFilterExpansion(false);\n   };\n \n+  const copySearchInfoSnackbar = (\n+    <MessageInfo\n+      open={showSnackBar}\n+      onClose={() => setShowSnackBar(false)}\n+      title={languageStrings.searchpage.shareSearchConfirmationText}\n+      variant=\"success\"\n+    />\n+  );\n+\n+  const handleCopySearch = () => {\n+    //base institution urls have a trailing / that we need to get rid of\n+    const instUrl = AppConfig.baseUrl.slice(0, -1);\n+    const searchUrl = `${instUrl}${\n+      location.pathname\n+    }?${generateQueryStringFromSearchOptions(searchPageOptions)}`;\n+\n+    navigator.clipboard.writeText(searchUrl).then(() => {", "originalCommit": "4ec08bd66a3a59bd2f3a2ce3e2a2645a6111431b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTIxNzkwOQ==", "url": "https://github.com/openequella/openEQUELLA/pull/2536#discussion_r529217909", "bodyText": "It's possible, so i will put a catch in for it", "author": "mrblippy", "createdAt": "2020-11-24T05:49:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzI2MDUxNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzI2MjM2Mw==", "url": "https://github.com/openequella/openEQUELLA/pull/2536#discussion_r527262363", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            import { Share } from \"@material-ui/icons\";\n          \n          \n            \n            import Share from \"@material-ui/icons/Share\"", "author": "PenghaiZhang", "createdAt": "2020-11-19T23:02:05Z", "path": "Source/Plugins/Core/com.equella.core/js/tsrc/search/components/SearchResultList.tsx", "diffHunk": "@@ -23,12 +23,14 @@ import {\n   CardHeader,\n   CircularProgress,\n   Grid,\n+  IconButton,\n   List,\n   ListItem,\n   Tooltip,\n   Typography,\n } from \"@material-ui/core\";\n import { makeStyles } from \"@material-ui/core/styles\";\n+import { Share } from \"@material-ui/icons\";", "originalCommit": "4ec08bd66a3a59bd2f3a2ce3e2a2645a6111431b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzI4MDk4Ng==", "url": "https://github.com/openequella/openEQUELLA/pull/2536#discussion_r527280986", "bodyText": "Definitely a good one to be cautious of for tree shaking and package sizes.", "author": "edalex-ian", "createdAt": "2020-11-19T23:53:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzI2MjM2Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzI2MzE2MA==", "url": "https://github.com/openequella/openEQUELLA/pull/2536#discussion_r527263160", "bodyText": "What about adding a label here for accessibility and writing tests more easily ?", "author": "PenghaiZhang", "createdAt": "2020-11-19T23:04:15Z", "path": "Source/Plugins/Core/com.equella.core/js/tsrc/search/components/SearchResultList.tsx", "diffHunk": "@@ -122,6 +129,13 @@ export const SearchResultList = ({\n                 </Button>\n               </Tooltip>\n             </Grid>\n+            <Grid item>\n+              <Tooltip title={searchPageStrings.shareSearchHelperText}>\n+                <IconButton onClick={onCopySearchLink}>", "originalCommit": "4ec08bd66a3a59bd2f3a2ce3e2a2645a6111431b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTA3MzY3MQ==", "url": "https://github.com/openequella/openEQUELLA/pull/2536#discussion_r529073671", "bodyText": "An IconButton wrapped in a Toolip component uses the Tooltip text as the title of the Button element:\n<button class=\"MuiButtonBase-root MuiIconButton-root\" tabindex=\"0\" type=\"button\" title=\"Copy search link to clipboard\">", "author": "mrblippy", "createdAt": "2020-11-23T23:58:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzI2MzE2MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzI4MTcyMA==", "url": "https://github.com/openequella/openEQUELLA/pull/2536#discussion_r527281720", "bodyText": "Two things:\n\nHow come you can't do it like the window.scroll below; and\nEven if you can't, rather than using () => {} could be better to use jest.fn();", "author": "edalex-ian", "createdAt": "2020-11-19T23:55:16Z", "path": "Source/Plugins/Core/com.equella.core/js/__tests__/tsrc/search/SearchPage.test.tsx", "diffHunk": "@@ -82,6 +82,11 @@ const mockConvertParamsToSearchOptions = jest.spyOn(\n   SearchModule,\n   \"queryStringParamsToSearchOptions\"\n );\n+Object.assign(navigator, {\n+  clipboard: {\n+    writeText: () => {},\n+  },\n+});", "originalCommit": "4ec08bd66a3a59bd2f3a2ce3e2a2645a6111431b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTIxMTk2Mg==", "url": "https://github.com/openequella/openEQUELLA/pull/2536#discussion_r529211962", "bodyText": "I did try doing it like window.scroll\nwindow.navigator.clipboard.writeText = jest.fn();. But it fails with TypeError: Cannot set property 'writeText' of undefined.", "author": "mrblippy", "createdAt": "2020-11-24T05:28:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzI4MTcyMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTkwNTk2NQ==", "url": "https://github.com/openequella/openEQUELLA/pull/2536#discussion_r529905965", "bodyText": "Does that include if you try:\nObject.assign(navigator, {\n  clipboard: {\n    writeText: jest.fn(),\n  },\n});", "author": "edalex-ian", "createdAt": "2020-11-24T21:54:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzI4MTcyMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTkyNDE3OQ==", "url": "https://github.com/openequella/openEQUELLA/pull/2536#discussion_r529924179", "bodyText": "Yup, that works just fine", "author": "mrblippy", "createdAt": "2020-11-24T22:11:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzI4MTcyMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzI4MjA2MQ==", "url": "https://github.com/openequella/openEQUELLA/pull/2536#discussion_r527282061", "bodyText": "Best to use languageString here rather than raw string literal.", "author": "edalex-ian", "createdAt": "2020-11-19T23:56:14Z", "path": "Source/Plugins/Core/com.equella.core/js/__tests__/tsrc/search/SearchPage.test.tsx", "diffHunk": "@@ -680,6 +685,18 @@ describe(\"<SearchPage/>\", () => {\n       selectedCategories: selectedCategories,\n     });\n   });\n+\n+  it(\"should copy a search link to clipboard, and show a snackbar\", async () => {\n+    const mockClipboard = jest.spyOn(navigator.clipboard, \"writeText\");\n+    const copySearchButton = screen.getByTitle(\"Copy search link to clipboard\");", "originalCommit": "4ec08bd66a3a59bd2f3a2ce3e2a2645a6111431b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzI4MjU1NA==", "url": "https://github.com/openequella/openEQUELLA/pull/2536#discussion_r527282554", "bodyText": "langstrings", "author": "edalex-ian", "createdAt": "2020-11-19T23:57:37Z", "path": "Source/Plugins/Core/com.equella.core/js/__tests__/tsrc/search/SearchPage.test.tsx", "diffHunk": "@@ -680,6 +685,18 @@ describe(\"<SearchPage/>\", () => {\n       selectedCategories: selectedCategories,\n     });\n   });\n+\n+  it(\"should copy a search link to clipboard, and show a snackbar\", async () => {\n+    const mockClipboard = jest.spyOn(navigator.clipboard, \"writeText\");\n+    const copySearchButton = screen.getByTitle(\"Copy search link to clipboard\");\n+    mockClipboard.mockResolvedValueOnce();\n+    await act(async () => {\n+      copySearchButton.click();\n+    });\n+    expect(\n+      screen.getByText(\"Search link saved to clipboard\")", "originalCommit": "4ec08bd66a3a59bd2f3a2ce3e2a2645a6111431b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "82d7aefcaea906aa84bf9cd2616038a579f12635", "url": "https://github.com/openequella/openEQUELLA/commit/82d7aefcaea906aa84bf9cd2616038a579f12635", "message": "add extra logging and assertion to BaseEntityAPITest, to try and work out why th test fails on github actions", "committedDate": "2020-11-21T07:30:13Z", "type": "commit"}, {"oid": "f9888d2bf59e536c265421ebf015398e7d494a34", "url": "https://github.com/openequella/openEQUELLA/commit/f9888d2bf59e536c265421ebf015398e7d494a34", "message": "try setting parallel=true, as that is one differnce to codebuild autotest config. this is to futher narrow down an issue in failing BaseEntityAPITest", "committedDate": "2020-11-21T09:42:03Z", "type": "commit"}, {"oid": "6275a9e1160c79a3d1ef5f1e1033d2ecd841f349", "url": "https://github.com/openequella/openEQUELLA/commit/6275a9e1160c79a3d1ef5f1e1033d2ecd841f349", "message": "more logging to try and work out why baseentity test is failing, will revert this later", "committedDate": "2020-11-22T22:14:01Z", "type": "commit"}, {"oid": "fff1f5a1419269cedab45ea2208d9ca9f47c11e8", "url": "https://github.com/openequella/openEQUELLA/commit/fff1f5a1419269cedab45ea2208d9ca9f47c11e8", "message": "Revert \"more logging to try and work out why baseentity test is failing, will revert this later\"\n\nThis reverts commit 6275a9e1160c79a3d1ef5f1e1033d2ecd841f349.", "committedDate": "2020-11-23T01:41:16Z", "type": "commit"}, {"oid": "cba132a0209ae3754637c094aab73f186e1eedc2", "url": "https://github.com/openequella/openEQUELLA/commit/cba132a0209ae3754637c094aab73f186e1eedc2", "message": "Revert \"try setting parallel=true, as that is one differnce to codebuild autotest config. this is to futher narrow down an issue in failing BaseEntityAPITest\"\n\nThis reverts commit f9888d2bf59e536c265421ebf015398e7d494a34.", "committedDate": "2020-11-23T01:41:42Z", "type": "commit"}, {"oid": "43c4d7e33e97004665ccfb49dbb2c2fe3af5231b", "url": "https://github.com/openequella/openEQUELLA/commit/43c4d7e33e97004665ccfb49dbb2c2fe3af5231b", "message": "Revert \"add extra logging and assertion to BaseEntityAPITest, to try and work out why th test fails on github actions\"\n\nThis reverts commit 82d7aefcaea906aa84bf9cd2616038a579f12635.", "committedDate": "2020-11-23T01:42:38Z", "type": "commit"}, {"oid": "75022e50aed94fb67269f8e89022385f11a8065b", "url": "https://github.com/openequella/openEQUELLA/commit/75022e50aed94fb67269f8e89022385f11a8065b", "message": "Check for one security node in results. This has been changed because the results come back in a different order for codebuild vs github actions", "committedDate": "2020-11-23T05:07:25Z", "type": "commit"}, {"oid": "588441ed11dedd09fa150d4bf89f934b14309d4a", "url": "https://github.com/openequella/openEQUELLA/commit/588441ed11dedd09fa150d4bf89f934b14309d4a", "message": "Handle error for navigator.clipboard, and reuse an existing language string const", "committedDate": "2020-11-23T23:06:33Z", "type": "commit"}, {"oid": "0e502043482ff6754700f4b6bb285e86835e7417", "url": "https://github.com/openequella/openEQUELLA/commit/0e502043482ff6754700f4b6bb285e86835e7417", "message": "Add selenuim test to test copying a saved search link to clipboard, and accessing it", "committedDate": "2020-11-24T05:35:01Z", "type": "commit"}, {"oid": "6585e2aff0c3e967e9bb6ccbe5c4b73a726996d5", "url": "https://github.com/openequella/openEQUELLA/commit/6585e2aff0c3e967e9bb6ccbe5c4b73a726996d5", "message": "Use language strings instead of raw strings for assertions", "committedDate": "2020-11-24T05:41:09Z", "type": "commit"}, {"oid": "d03a74cb8038b0ed492b36713144f8c1b62ed403", "url": "https://github.com/openequella/openEQUELLA/commit/d03a74cb8038b0ed492b36713144f8c1b62ed403", "message": "be more explicit when checking collection results for presence security node, instead of assuming the order", "committedDate": "2020-11-24T05:47:03Z", "type": "commit"}, {"oid": "f4c2145969d503de0fa3fb2ea007df93723edcf7", "url": "https://github.com/openequella/openEQUELLA/commit/f4c2145969d503de0fa3fb2ea007df93723edcf7", "message": "remove mock that i shouldn't have commited in the first place", "committedDate": "2020-11-24T22:09:02Z", "type": "commit"}, {"oid": "be81895d421d2430414e61d24fd7be05461bfc76", "url": "https://github.com/openequella/openEQUELLA/commit/be81895d421d2430414e61d24fd7be05461bfc76", "message": "Revert \"Add selenuim test to test copying a saved search link to clipboard, and accessing it\". I did this due to issues when accessing the clipboard api when running chrome in headless mode\n\nThis reverts commit 0e502043482ff6754700f4b6bb285e86835e7417.", "committedDate": "2020-11-25T05:07:50Z", "type": "commit"}, {"oid": "a423b0adb3ac3350ba1584bd1764db4be0d80187", "url": "https://github.com/openequella/openEQUELLA/commit/a423b0adb3ac3350ba1584bd1764db4be0d80187", "message": "Assert that the mocked clipboard has been called with the correct query string. This is to account for not being able to test the copy/pasting functionality correctly in the selenium headless NewSearchPageTest", "committedDate": "2020-11-25T05:13:57Z", "type": "commit"}, {"oid": "4f75b557d9257b6bea213ad29a628026a8359695", "url": "https://github.com/openequella/openEQUELLA/commit/4f75b557d9257b6bea213ad29a628026a8359695", "message": "add undefined type to json stringify function, as it's conceivable that the value can be undefined", "committedDate": "2020-11-26T05:40:31Z", "type": "commit"}]}