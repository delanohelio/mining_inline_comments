{"pr_number": 2498, "pr_title": "Fix view video attachments from New Search UI search results", "pr_createdAt": "2020-11-09T05:24:28Z", "pr_url": "https://github.com/openequella/openEQUELLA/pull/2498", "timeline": [{"oid": "e4796c605fc3b34ac30ce19c352b015c3318e3d3", "url": "https://github.com/openequella/openEQUELLA/commit/e4796c605fc3b34ac30ce19c352b015c3318e3d3", "message": "feat(server): Return attachment filePath in search results\n\nThat way it can be used to construct direct access URLs.", "committedDate": "2020-11-09T05:16:30Z", "type": "commit"}, {"oid": "720c86a12ba25c5bbbf6bf66b4f745f64374cfed", "url": "https://github.com/openequella/openEQUELLA/commit/720c86a12ba25c5bbbf6bf66b4f745f64374cfed", "message": "feat(oeq-ts-rest-api): Support attachment filePath in search results\n\nThat way it can be used to construct direct access URLs.", "committedDate": "2020-11-09T05:17:27Z", "type": "commit"}, {"oid": "9ba2c0212d31ac80bf0d5a47a46d4b8703b926d9", "url": "https://github.com/openequella/openEQUELLA/commit/9ba2c0212d31ac80bf0d5a47a46d4b8703b926d9", "message": "bugfix(new-ui): Display video attachments in lightbox\n\nUnless the viewer is set to 'download'. Unfortunately, before if the viewer was the old html5viewer it would try and send that link (and resultant content) to a <video>.", "committedDate": "2020-11-09T05:19:00Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDE1MDkzMg==", "url": "https://github.com/openequella/openEQUELLA/pull/2498#discussion_r520150932", "bodyText": "nit: since the string \"file\" is checked on line 87 and then used again in line 88's string literal, perhaps it could be a constant.", "author": "SammyIsConfused", "createdAt": "2020-11-09T22:06:33Z", "path": "Source/Plugins/Core/com.equella.core/js/tsrc/modules/ViewerModule.ts", "diffHunk": "@@ -65,3 +66,24 @@ export const determineViewer = (\n \n   return simpleLinkView;\n };\n+\n+/**\n+ * Based on attachment type, builds either a direct link to a file attachment URL or uses the\n+ * provided `viewUrl`.\n+ *\n+ * @param itemUuid The attachment item's UUID\n+ * @param itemVersion The attachment item's version\n+ * @param attachmentType The type of the attachment - as provided by the server\n+ * @param viewUrl The default 'view' link provided by the server for the attachment\n+ * @param fileAttachmentPath If attachment type of 'file' then the `filePath` provided by the server\n+ */\n+export const determineAttachmentViewUrl = (\n+  itemUuid: string,\n+  itemVersion: number,\n+  attachmentType: string,\n+  viewUrl: string,\n+  fileAttachmentPath?: string\n+): string =>\n+  attachmentType === \"file\"\n+    ? `${AppConfig.baseUrl}file/${itemUuid}/${itemVersion}/${fileAttachmentPath}`", "originalCommit": "9ba2c0212d31ac80bf0d5a47a46d4b8703b926d9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDIwMDYwNQ==", "url": "https://github.com/openequella/openEQUELLA/pull/2498#discussion_r520200605", "bodyText": "Thanks @SammyIsConfused .\nIn this case this is more the value of string union, vs. just the structure of a URL. I wouldn't want to imply they're directly related.", "author": "edalex-ian", "createdAt": "2020-11-10T00:07:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDE1MDkzMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDE5MTkxNA==", "url": "https://github.com/openequella/openEQUELLA/pull/2498#discussion_r520191914", "bodyText": "Just be curious here . Does fileAttachment.getFilename actually return a relative path ?  I wonder this because the file path in this test is \"directory/file.txt\".", "author": "PenghaiZhang", "createdAt": "2020-11-09T23:42:47Z", "path": "Source/Plugins/Core/com.equella.core/js/__tests__/tsrc/modules/ViewerModule.test.ts", "diffHunk": "@@ -58,3 +61,25 @@ describe(\"determineViewer()\", () => {\n       ).toEqual([\"lightbox\", fileViewUrl])\n   );\n });\n+\n+describe(\"determineAttachmentViewUrl()\", () => {\n+  const viewUrl = \"http://blah/blah\";\n+  const uuid = \"uuid\";\n+  const version = 1;\n+\n+  it(\"returns the viewUrl for non 'file' attachmentType\", () =>\n+    expect(\n+      determineAttachmentViewUrl(uuid, version, \"link\", viewUrl, undefined)\n+    ).toEqual(viewUrl));\n+\n+  it(\"returns an oEQ 'file' URL for attachmentType 'file'\", () =>\n+    expect(\n+      determineAttachmentViewUrl(\n+        uuid,\n+        version,\n+        \"file\",\n+        viewUrl,\n+        \"directory/file.txt\"", "originalCommit": "9ba2c0212d31ac80bf0d5a47a46d4b8703b926d9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDIwMTAzOQ==", "url": "https://github.com/openequella/openEQUELLA/pull/2498#discussion_r520201039", "bodyText": "I wondered the same thing. So went through some manual testing where I uploaded a zip file with several directories and then extracted that into an item and discovered it is indeed the path. (Shame the naming etc. is unclear.)", "author": "edalex-ian", "createdAt": "2020-11-10T00:08:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDE5MTkxNA=="}], "type": "inlineReview"}]}