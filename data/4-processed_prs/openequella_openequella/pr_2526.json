{"pr_number": 2526, "pr_title": "Handle PDF thumbnailing safely", "pr_createdAt": "2020-11-18T00:01:19Z", "pr_url": "https://github.com/openequella/openEQUELLA/pull/2526", "timeline": [{"oid": "67080e9261a0e357e565add866aa0e9c7c9d67aa", "url": "https://github.com/openequella/openEQUELLA/commit/67080e9261a0e357e565add866aa0e9c7c9d67aa", "message": "Add a process exec with a time limit", "committedDate": "2020-11-17T22:42:49Z", "type": "commit"}, {"oid": "4232dcd8c008daf5022443f4a36c1fedca7bf646", "url": "https://github.com/openequella/openEQUELLA/commit/4232dcd8c008daf5022443f4a36c1fedca7bf646", "message": "Consume pdf thumbnail time limit from image magick properties file", "committedDate": "2020-11-17T22:43:45Z", "type": "commit"}, {"oid": "3c936089b761a3dd2af9f60bc79df114c6e12f85", "url": "https://github.com/openequella/openEQUELLA/commit/3c936089b761a3dd2af9f60bc79df114c6e12f85", "message": "Use a timed process for PDF thumbnailing", "committedDate": "2020-11-17T22:51:50Z", "type": "commit"}, {"oid": "9384b9fa5f51bde4a726172221463248cce3ad03", "url": "https://github.com/openequella/openEQUELLA/commit/9384b9fa5f51bde4a726172221463248cce3ad03", "message": "Remove unnecessary $NON-NLS-1$ comment", "committedDate": "2020-11-17T22:55:17Z", "type": "commit"}, {"oid": "cc7986e05c68f7fd12882572829bd038c8935f45", "url": "https://github.com/openequella/openEQUELLA/commit/cc7986e05c68f7fd12882572829bd038c8935f45", "message": "Use StandardCharsets rather than inline string", "committedDate": "2020-11-17T22:58:53Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzI5MzIwNA==", "url": "https://github.com/openequella/openEQUELLA/pull/2526#discussion_r527293204", "bodyText": "This will make for some rather verbose logs, and is really only relevant for debugging issues so\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  LOGGER.info(\"maxDurationInSeconds not set. Using a regular non-timed process.\");\n          \n          \n            \n                  LOGGER.debug(\"maxDurationInSeconds not set. Using a regular non-timed process.\");", "author": "edalex-ian", "createdAt": "2020-11-20T00:18:55Z", "path": "Platform/Plugins/com.tle.platform.common/src/com/tle/common/util/ExecUtils.java", "diffHunk": "@@ -114,6 +115,38 @@ public static ExecResult exec(String[] cmdarray, Map<String, String> additionalE\n     }\n   }\n \n+  public static ExecResult execWithTimeLimit(long maxDurationInSeconds, String[] options) {\n+    if (maxDurationInSeconds < 1L) {\n+      LOGGER.info(\"maxDurationInSeconds not set. Using a regular non-timed process.\");", "originalCommit": "cc7986e05c68f7fd12882572829bd038c8935f45", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzI5NDMwOQ==", "url": "https://github.com/openequella/openEQUELLA/pull/2526#discussion_r527294309", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  LOGGER.info(\"Started timed process\");\n          \n          \n            \n                  LOGGER.debug(\"Started timed process\");", "author": "edalex-ian", "createdAt": "2020-11-20T00:20:13Z", "path": "Platform/Plugins/com.tle.platform.common/src/com/tle/common/util/ExecUtils.java", "diffHunk": "@@ -114,6 +115,38 @@ public static ExecResult exec(String[] cmdarray, Map<String, String> additionalE\n     }\n   }\n \n+  public static ExecResult execWithTimeLimit(long maxDurationInSeconds, String[] options) {\n+    if (maxDurationInSeconds < 1L) {\n+      LOGGER.info(\"maxDurationInSeconds not set. Using a regular non-timed process.\");\n+      return exec(options, null, null);\n+    }\n+    return execWithTimeLimit(options, null, null, maxDurationInSeconds);\n+  }\n+\n+  public static ExecResult execWithTimeLimit(\n+      String[] cmdarray, Map<String, String> additionalEnv, File dir, long durationInSeconds) {\n+    try {\n+      final Triple<Process, StreamReader, StreamReader> cp =\n+          createProcess(cmdarray, additionalEnv, dir);\n+      LOGGER.info(\"Started timed process\");", "originalCommit": "cc7986e05c68f7fd12882572829bd038c8935f45", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzI5NDU5OQ==", "url": "https://github.com/openequella/openEQUELLA/pull/2526#discussion_r527294599", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  LOGGER.info(\"Timed process finished\");\n          \n          \n            \n                  LOGGER.debug(\"Timed process finished\");", "author": "edalex-ian", "createdAt": "2020-11-20T00:20:31Z", "path": "Platform/Plugins/com.tle.platform.common/src/com/tle/common/util/ExecUtils.java", "diffHunk": "@@ -114,6 +115,38 @@ public static ExecResult exec(String[] cmdarray, Map<String, String> additionalE\n     }\n   }\n \n+  public static ExecResult execWithTimeLimit(long maxDurationInSeconds, String[] options) {\n+    if (maxDurationInSeconds < 1L) {\n+      LOGGER.info(\"maxDurationInSeconds not set. Using a regular non-timed process.\");\n+      return exec(options, null, null);\n+    }\n+    return execWithTimeLimit(options, null, null, maxDurationInSeconds);\n+  }\n+\n+  public static ExecResult execWithTimeLimit(\n+      String[] cmdarray, Map<String, String> additionalEnv, File dir, long durationInSeconds) {\n+    try {\n+      final Triple<Process, StreamReader, StreamReader> cp =\n+          createProcess(cmdarray, additionalEnv, dir);\n+      LOGGER.info(\"Started timed process\");\n+      final Process proc = cp.getFirst();\n+      final StreamReader stdOut = cp.getSecond();\n+      final StreamReader stdErr = cp.getThird();\n+      proc.waitFor(durationInSeconds, TimeUnit.SECONDS);\n+      if (!stdErr.isFinished() || !stdOut.isFinished()) {\n+        throw new InterruptedException();\n+      }\n+      LOGGER.info(\"Timed process finished\");", "originalCommit": "cc7986e05c68f7fd12882572829bd038c8935f45", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzI5OTEzMw==", "url": "https://github.com/openequella/openEQUELLA/pull/2526#discussion_r527299133", "bodyText": "Doesn't need to be this specific. Arguably any thumbnail process going rouge/forever should be hit on the head. I think the check should be removed, and the configuration property made more generic - e.g. thumbnailing.timeout.\nThat in turn raises the question as to whether all thumbnailing goes through here. And if not, should we really do the circuit breaker higher up.", "author": "edalex-ian", "createdAt": "2020-11-20T00:25:54Z", "path": "Source/Plugins/Core/com.equella.core/src/com/tle/core/imagemagick/ImageMagickServiceImpl.java", "diffHunk": "@@ -204,12 +209,34 @@ public Dimension getImageDimensions(FileHandle handle, String filename) throws I\n \n   @Override\n   public Dimension getImageDimensions(File image) throws IOException {\n-    ExecResult result =\n-        ExecUtils.exec(\n-            identifyExe.getAbsolutePath(),\n-            \"-format\",\n-            \"%wx%h\",\n-            new String(image.getAbsolutePath().getBytes(\"UTF-8\"), \"UTF-8\"));\n+    ExecResult result;\n+    if (image.getAbsolutePath().toLowerCase().contains(\".pdf\")) {", "originalCommit": "cc7986e05c68f7fd12882572829bd038c8935f45", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzMyNTg1NQ==", "url": "https://github.com/openequella/openEQUELLA/pull/2526#discussion_r527325855", "bodyText": "All of the ThumbnailGenerators (ImageThumbnailGenerator, PDFThumbnailGenerator, VideoThumbnailGenerator) pass through here. There is one exception - in the ImageThumbnailGenerator it checks if the file is a gif. If it is, it goes straight to conversion. All others hit here first.\nI could resolve this in a few different ways:\n\nSurround the conversion step with a time limit too\nMove this up to generateThumbnailAdvanced - all thumbnailing operations use this. However - this would work quite a bit differently as it's not an external process.\nMake the GIF check run getImageDimensions too\nRefactor this validation check out into it's own operation that gets run before all else in thumbnailing. Essentially running the identify call again but this time right at the start, doing nothing with the output - just as a validation step. And then operate as normal. While this would add a new load, if the file is valid this will take a split second and neglible processing power. If it isn't, it will attempt up until the time limit and then error out.", "author": "SammyIsConfused", "createdAt": "2020-11-20T00:56:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzI5OTEzMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzM4MjM3MA==", "url": "https://github.com/openequella/openEQUELLA/pull/2526#discussion_r527382370", "bodyText": "Went with the option to refactor this into it's own validation step.", "author": "SammyIsConfused", "createdAt": "2020-11-20T04:12:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzI5OTEzMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzMwMDk1OQ==", "url": "https://github.com/openequella/openEQUELLA/pull/2526#discussion_r527300959", "bodyText": "This duplicates the above. As per above, this branch may be removed. But if not, this should be centralised in a shared String[] as used above.", "author": "edalex-ian", "createdAt": "2020-11-20T00:28:02Z", "path": "Source/Plugins/Core/com.equella.core/src/com/tle/core/imagemagick/ImageMagickServiceImpl.java", "diffHunk": "@@ -204,12 +209,34 @@ public Dimension getImageDimensions(FileHandle handle, String filename) throws I\n \n   @Override\n   public Dimension getImageDimensions(File image) throws IOException {\n-    ExecResult result =\n-        ExecUtils.exec(\n-            identifyExe.getAbsolutePath(),\n-            \"-format\",\n-            \"%wx%h\",\n-            new String(image.getAbsolutePath().getBytes(\"UTF-8\"), \"UTF-8\"));\n+    ExecResult result;\n+    if (image.getAbsolutePath().toLowerCase().contains(\".pdf\")) {\n+      // use a timed process for pdfs so that thumbnailing\n+      // for large or badly generated PDFs doesn't attempt indefinitely.\n+      // Set in plugins/com.tle.core.imagemagick/config.properties\n+      // imageMagick.seconds.before.cancel.pdf.thumbnailing as an integer.\n+      // if not set, the default is 20 seconds. If set to 0, uses a regular non-timed process.\n+      result =\n+          ExecUtils.execWithTimeLimit(\n+              pdfThumbnailTimeLimit,\n+              new String[] {\n+                identifyExe.getAbsolutePath(),\n+                \"-format\",\n+                \"%wx%h\",\n+                new String(\n+                    image.getAbsolutePath().getBytes(StandardCharsets.UTF_8),\n+                    StandardCharsets.UTF_8)\n+              });\n+    } else {\n+      result =\n+          ExecUtils.exec(\n+              identifyExe.getAbsolutePath(),\n+              \"-format\",\n+              \"%wx%h\",\n+              new String(\n+                  image.getAbsolutePath().getBytes(StandardCharsets.UTF_8),\n+                  StandardCharsets.UTF_8));", "originalCommit": "cc7986e05c68f7fd12882572829bd038c8935f45", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzMwMTY4Mg==", "url": "https://github.com/openequella/openEQUELLA/pull/2526#discussion_r527301682", "bodyText": "This should also be added to the example optional config properties file as way of documentation.", "author": "edalex-ian", "createdAt": "2020-11-20T00:28:54Z", "path": "Source/Plugins/Core/com.equella.core/src/com/tle/core/imagemagick/guice/ImageMagickModule.java", "diffHunk": "@@ -32,5 +32,6 @@ protected String getFilename() {\n   @Override\n   protected void configure() {\n     bindProp(\"imageMagick.path\");\n+    bindInt(\"imageMagick.seconds.before.cancel.pdf.thumbnailing\", 20);", "originalCommit": "cc7986e05c68f7fd12882572829bd038c8935f45", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "fe97f043ce17407bfe68cb0a1b881f1f1e90342b", "url": "https://github.com/openequella/openEQUELLA/commit/fe97f043ce17407bfe68cb0a1b881f1f1e90342b", "message": "Elevate info logs to debug\n\nCo-authored-by: edalex-ian <43919233+edalex-ian@users.noreply.github.com>", "committedDate": "2020-11-20T00:36:33Z", "type": "commit"}, {"oid": "6497960d3bb7afc59db6c02d1e7fe4e70a539a75", "url": "https://github.com/openequella/openEQUELLA/commit/6497960d3bb7afc59db6c02d1e7fe4e70a539a75", "message": "Rename to thumbnailing.timeout and add docs to config.properties.unresolved", "committedDate": "2020-11-20T04:09:11Z", "type": "commit"}, {"oid": "4a73d3a5e1bbf9a5e9d93ec7ab34e4fe21dbef9c", "url": "https://github.com/openequella/openEQUELLA/commit/4a73d3a5e1bbf9a5e9d93ec7ab34e4fe21dbef9c", "message": "Refactor timed process to occur as validation step", "committedDate": "2020-11-20T04:10:00Z", "type": "commit"}, {"oid": "891e25824f1d61a503d56942db254fce6c5b698e", "url": "https://github.com/openequella/openEQUELLA/commit/891e25824f1d61a503d56942db254fce6c5b698e", "message": "Merge branch 'develop' into bugfix/make_pdf_thumbnailing_safe", "committedDate": "2020-11-26T04:26:31Z", "type": "commit"}, {"oid": "e4e84f41fd1be79e4bfa264be43f5d16a6e3f2b3", "url": "https://github.com/openequella/openEQUELLA/commit/e4e84f41fd1be79e4bfa264be43f5d16a6e3f2b3", "message": "Add wait to MimeTypesTest", "committedDate": "2020-11-26T05:14:09Z", "type": "commit"}]}