{"pr_number": 1749, "pr_title": "Make Canvas Integration work with new UI", "pr_createdAt": "2020-05-20T22:12:11Z", "pr_url": "https://github.com/openequella/openEQUELLA/pull/1749", "timeline": [{"oid": "bd2f08422b7ef20e025b43f6fba581e7f12ade06", "url": "https://github.com/openequella/openEQUELLA/commit/bd2f08422b7ef20e025b43f6fba581e7f12ade06", "message": "Make Canvas Integration work with new UI\n\nNote: This is a hack, and should be done more elegantly.\nWe should not be using dangerouslySetInnerHTML.", "committedDate": "2020-05-20T10:48:57Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODM0MTY5MA==", "url": "https://github.com/openequella/openEQUELLA/pull/1749#discussion_r428341690", "bodyText": "Obviously when we do this properly we don't need r.", "author": "edalex-ian", "createdAt": "2020-05-20T22:23:15Z", "path": "Source/Plugins/Core/com.equella.core/scalasrc/com/tle/web/api/LegacyContentApi.scala", "diffHunk": "@@ -448,14 +448,15 @@ class LegacyContentApi {\n         info.preventGET()\n         info.getRootRenderContext.setRootResultListener(new LegacyResponseListener(info))\n         LegacyContentController.execute(info)\n-        redirectResponse(info)\n+        val r = redirectResponse(info)", "originalCommit": "bd2f08422b7ef20e025b43f6fba581e7f12ade06", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODM0Mjg0Ng==", "url": "https://github.com/openequella/openEQUELLA/pull/1749#discussion_r428342846", "bodyText": "I acknowledge I'm the guilty party for this, but when we polish it we should probably do similar to the below with Option / filter / map so that we only include it if there is a form.", "author": "edalex-ian", "createdAt": "2020-05-20T22:25:57Z", "path": "Source/Plugins/Core/com.equella.core/scalasrc/com/tle/web/api/LegacyContentApi.scala", "diffHunk": "@@ -491,12 +492,19 @@ class LegacyContentApi {\n           val body = SectionUtils.renderToString(\n             context,\n             wrapBody(context, tr.getNamedResult(context, \"body\")))\n+          val form = context.getForm\n+          val formString: String =\n+            if (form.getAction != null) {\n+              SectionUtils.renderToString(context, form)\n+            } else \"\"\n+\n           val upperbody =\n             SectionUtils.renderToString(context, tr.getNamedResult(context, \"upperbody\"))\n           val scrops = renderScreenOptions(context)\n           val crumbs = renderCrumbs(context, decs).map(SectionUtils.renderToString(context, _))\n           Iterable(\n             Some(\"body\"                                          -> body),\n+            Some(\"form\"                                          -> formString),", "originalCommit": "bd2f08422b7ef20e025b43f6fba581e7f12ade06", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODM0MzYyMw==", "url": "https://github.com/openequella/openEQUELLA/pull/1749#discussion_r428343623", "bodyText": "Hopefully we can use a more idiomatic scala construct for this to. Maybe a for / yield, or an Option which will make it more straight forward below. (Again, I acknowledge I'm critiquing my own code.)", "author": "edalex-ian", "createdAt": "2020-05-20T22:27:57Z", "path": "Source/Plugins/Core/com.equella.core/scalasrc/com/tle/web/api/LegacyContentApi.scala", "diffHunk": "@@ -491,12 +492,19 @@ class LegacyContentApi {\n           val body = SectionUtils.renderToString(\n             context,\n             wrapBody(context, tr.getNamedResult(context, \"body\")))\n+          val form = context.getForm\n+          val formString: String =\n+            if (form.getAction != null) {\n+              SectionUtils.renderToString(context, form)\n+            } else \"\"\n+", "originalCommit": "bd2f08422b7ef20e025b43f6fba581e7f12ade06", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODM0NDg1OA==", "url": "https://github.com/openequella/openEQUELLA/pull/1749#discussion_r428344858", "bodyText": "I wonder if it matters that this is after LegacyForm where as in the legacy UI this 'form' seemed to get rendered before the 'body'. \ud83e\udd14", "author": "edalex-ian", "createdAt": "2020-05-20T22:31:07Z", "path": "Source/Plugins/Core/com.equella.core/js/tsrc/mainui/index.tsx", "diffHunk": "@@ -218,11 +218,20 @@ function IndexPage() {\n               {routeSwitch(content)}\n             </Template>\n           );\n-          return !content || content.noForm ? (\n-            template\n-          ) : (\n-            <LegacyForm state={content.state}>{template}</LegacyForm>\n-          );\n+          const render = () => {\n+            if (!content || content.noForm) {\n+              return template;\n+            } else {\n+              const { form } = content.html;\n+              return (\n+                <>\n+                  <LegacyForm state={content.state}>{template}</LegacyForm>\n+                  {form && <div dangerouslySetInnerHTML={{ __html: form }} />}", "originalCommit": "bd2f08422b7ef20e025b43f6fba581e7f12ade06", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODM2NTEwMg==", "url": "https://github.com/openequella/openEQUELLA/pull/1749#discussion_r428365102", "bodyText": "Do you mean the div that has an ID called body?  If yes, the body is part of this form in Old UI.", "author": "PenghaiZhang", "createdAt": "2020-05-20T23:32:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODM0NDg1OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODM3NDI1OQ==", "url": "https://github.com/openequella/openEQUELLA/pull/1749#discussion_r428374259", "bodyText": "Oh, I see. I thought it was:\n\nform\ndiv id=body\nscript\n\nI just reformatted the code, and now see it's actually:\n\nform\n\ndiv id=body\n\n\nscript\n\nCool, so as long as we maintain that structure - and with the input fields etc at the top within the form, then that should be okay. Either-way, the test suite is passing, so....", "author": "edalex-ian", "createdAt": "2020-05-21T00:02:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODM0NDg1OA=="}], "type": "inlineReview"}, {"oid": "1b08bc737d4acde55e64386ceff64d9c869aceff", "url": "https://github.com/openequella/openEQUELLA/commit/1b08bc737d4acde55e64386ceff64d9c869aceff", "message": "Use react-html-parser to add the form\n\nRather than using security risk dangerouslySetInnerHtml.\nAlso - remove test strings from LegacyContentApi.scala\nand use idiomatic Scala code to setup the form.", "committedDate": "2020-05-21T05:19:45Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODYyODcwMw==", "url": "https://github.com/openequella/openEQUELLA/pull/1749#discussion_r428628703", "bodyText": "Is cross site scripting a concern here?\nThis library does not sanitize inputs.\nhttps://github.com/remarkablemark/html-react-parser#is-this-library-xss-safe", "author": "ChristianMurphy", "createdAt": "2020-05-21T12:45:04Z", "path": "Source/Plugins/Core/com.equella.core/js/tsrc/mainui/index.tsx", "diffHunk": "@@ -218,11 +217,20 @@ function IndexPage() {\n               {routeSwitch(content)}\n             </Template>\n           );\n-          return !content || content.noForm ? (\n-            template\n-          ) : (\n-            <LegacyForm state={content.state}>{template}</LegacyForm>\n-          );\n+          const render = () => {\n+            if (!content || content.noForm) {\n+              return template;\n+            } else {\n+              const { form } = content.html;\n+              return (\n+                <>\n+                  <LegacyForm state={content.state}>{template}</LegacyForm>\n+                  {form && HtmlParser(form)}", "originalCommit": "1b08bc737d4acde55e64386ceff64d9c869aceff", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODk1NTE3NQ==", "url": "https://github.com/openequella/openEQUELLA/pull/1749#discussion_r428955175", "bodyText": "I don't believe so, as this is just a form which is normally server side rendered and we're attempting to bring it across to be rendered as part of the New UI. But it's also deep in the depths of Sections and Legacy Content wrapping so I can't say I'm 100% across where else (and how) these forms are used.\nIn this case - that we're attempting to fix - it's a form with is pragmatically built up server side with some hidden fields (with LTI values) which are then submitted via JS so as to complete the Canvas submission. It feels like this is the primary way this 'form' element is used, and hence why to date nothing else has broken with it being absent from the legacy content wrapping. I think.... \ud83e\udd1e", "author": "edalex-ian", "createdAt": "2020-05-21T22:45:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODYyODcwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODk2Mzc1OA==", "url": "https://github.com/openequella/openEQUELLA/pull/1749#discussion_r428963758", "bodyText": "BTW, the library we use is react-html-parser but not html-react-parser.  react-html-parser hasn't been updated for three years.", "author": "PenghaiZhang", "createdAt": "2020-05-21T23:14:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODYyODcwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODk2NTc2Ng==", "url": "https://github.com/openequella/openEQUELLA/pull/1749#discussion_r428965766", "bodyText": "heh, that naming's not confusing at all. \ud83d\ude2c", "author": "edalex-ian", "createdAt": "2020-05-21T23:21:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODYyODcwMw=="}], "type": "inlineReview"}]}