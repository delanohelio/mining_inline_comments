{"pr_number": 6118, "pr_title": "Interrupt all running tasks during shutdown", "pr_createdAt": "2020-03-14T01:00:04Z", "pr_url": "https://github.com/JabRef/jabref/pull/6118", "timeline": [{"oid": "70f530f31c1cf2da3e611f01a0ea7c5b82b6099e", "url": "https://github.com/JabRef/jabref/commit/70f530f31c1cf2da3e611f01a0ea7c5b82b6099e", "message": "Interrupt all running tasks during shutdown (and don't allow new tasks to be executed)\n\nCo-authored-by: Stefan Kolb <stefan-kolb@web.de>", "committedDate": "2020-03-14T00:58:59Z", "type": "commit"}, {"oid": "6988b490bab88d29ecb31aa126dd953967b27fe1", "url": "https://github.com/JabRef/jabref/commit/6988b490bab88d29ecb31aa126dd953967b27fe1", "message": "Merge remote-tracking branch 'origin/master' into fix-delay-task-throttler", "committedDate": "2020-03-30T20:22:25Z", "type": "commit"}, {"oid": "3ee3598792590c437d115c53435c9eb94e42f1b9", "url": "https://github.com/JabRef/jabref/commit/3ee3598792590c437d115c53435c9eb94e42f1b9", "message": "Merge branch 'master' into fix-delay-task-throttler", "committedDate": "2020-03-31T18:48:14Z", "type": "commit"}, {"oid": "79c164e05207272c7b4da5cb86b1041ef7086604", "url": "https://github.com/JabRef/jabref/commit/79c164e05207272c7b4da5cb86b1041ef7086604", "message": "Merge remote-tracking branch 'origin/master' into fix-delay-task-throttler", "committedDate": "2020-08-31T23:01:56Z", "type": "commit"}, {"oid": "f836dbe6bf4db3cd8334fc7cdd98dcd5bd9ad403", "url": "https://github.com/JabRef/jabref/commit/f836dbe6bf4db3cd8334fc7cdd98dcd5bd9ad403", "message": "Fix position of CHANGELOG.md entry", "committedDate": "2020-08-31T23:03:57Z", "type": "commit"}, {"oid": "c3e9a2232dee0e3bfd7fc9639f646520c168e04a", "url": "https://github.com/JabRef/jabref/commit/c3e9a2232dee0e3bfd7fc9639f646520c168e04a", "message": "Extend to JabRefExecutorService", "committedDate": "2020-08-31T23:44:56Z", "type": "commit"}, {"oid": "9df012a7f1a9b764f87fbd3412eda2be6318e263", "url": "https://github.com/JabRef/jabref/commit/9df012a7f1a9b764f87fbd3412eda2be6318e263", "message": "Merge remote-tracking branch 'origin/master' into fix-delay-task-throttler", "committedDate": "2020-08-31T23:46:37Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTAxMTg3OA==", "url": "https://github.com/JabRef/jabref/pull/6118#discussion_r481011878", "bodyText": "Upon termination, this method returns.\n??", "author": "tobiasdiez", "createdAt": "2020-09-01T09:48:57Z", "path": "src/main/java/org/jabref/JabRefExecutorService.java", "diffHunk": "@@ -132,13 +132,47 @@ public void submit(TimerTask timerTask, long millisecondsDelay) {\n         timer.schedule(timerTask, millisecondsDelay);\n     }\n \n+    /**\n+     * Shuts everything down. Upon termination, this method returns.", "originalCommit": "9df012a7f1a9b764f87fbd3412eda2be6318e263", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTAxMzAzMg==", "url": "https://github.com/JabRef/jabref/pull/6118#discussion_r481013032", "bodyText": "indent", "author": "tobiasdiez", "createdAt": "2020-09-01T09:50:44Z", "path": "src/main/java/org/jabref/JabRefExecutorService.java", "diffHunk": "@@ -132,13 +132,47 @@ public void submit(TimerTask timerTask, long millisecondsDelay) {\n         timer.schedule(timerTask, millisecondsDelay);\n     }\n \n+    /**\n+     * Shuts everything down. Upon termination, this method returns.\n+     */\n     public void shutdownEverything() {\n-        // those threads will be allowed to finish\n-        this.executorService.shutdown();\n-        // those threads will be interrupted in their current task\n-        this.lowPriorityExecutorService.shutdownNow();\n         // kill the remote thread\n         stopRemoteThread();\n+\n+        try {\n+            // those threads will be allowed to finish\n+            this.executorService.shutdown();\n+            if (!executorService.awaitTermination(60, TimeUnit.SECONDS)) {\n+                LOGGER.debug(\"One minute passed, saving still not completed. Trying forced shutdown.\");\n+                executorService.shutdownNow();\n+                if (executorService.awaitTermination(60, TimeUnit.SECONDS)) {\n+                    LOGGER.debug(\"One minute passed again - forced shutdown worked.\");\n+                } else {\n+                    LOGGER.error(\"DelayedTaskThrottler did not terminate\");\n+                }\n+            }\n+        } catch (InterruptedException ie) {\n+                executorService.shutdownNow();", "originalCommit": "9df012a7f1a9b764f87fbd3412eda2be6318e263", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTAxNDIxMA==", "url": "https://github.com/JabRef/jabref/pull/6118#discussion_r481014210", "bodyText": "add to interface", "author": "tobiasdiez", "createdAt": "2020-09-01T09:52:40Z", "path": "src/main/java/org/jabref/gui/util/DefaultTaskExecutor.java", "diffHunk": "@@ -122,6 +122,9 @@ public static void runInJavaFXThread(Runnable runnable) {\n         return scheduledExecutor.schedule(getJavaFXTask(task), delay, unit);\n     }\n \n+    /**\n+     * Shuts everything down. Upon termination, this method returns.", "originalCommit": "9df012a7f1a9b764f87fbd3412eda2be6318e263", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTAzMjI2Mg==", "url": "https://github.com/JabRef/jabref/pull/6118#discussion_r481032262", "bodyText": "Can't do - Added a comment to TaskExecutor", "author": "koppor", "createdAt": "2020-09-01T10:18:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTAxNDIxMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTAxNDU1OA==", "url": "https://github.com/JabRef/jabref/pull/6118#discussion_r481014558", "bodyText": "extract try block to method and call it for executorService and lowPriorityExecutorService", "author": "tobiasdiez", "createdAt": "2020-09-01T09:53:17Z", "path": "src/main/java/org/jabref/JabRefExecutorService.java", "diffHunk": "@@ -132,13 +132,47 @@ public void submit(TimerTask timerTask, long millisecondsDelay) {\n         timer.schedule(timerTask, millisecondsDelay);\n     }\n \n+    /**\n+     * Shuts everything down. Upon termination, this method returns.\n+     */\n     public void shutdownEverything() {\n-        // those threads will be allowed to finish\n-        this.executorService.shutdown();\n-        // those threads will be interrupted in their current task\n-        this.lowPriorityExecutorService.shutdownNow();\n         // kill the remote thread\n         stopRemoteThread();\n+\n+        try {", "originalCommit": "9df012a7f1a9b764f87fbd3412eda2be6318e263", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTAxNDk4Mg==", "url": "https://github.com/JabRef/jabref/pull/6118#discussion_r481014982", "bodyText": "thats not the delayed task throttler", "author": "tobiasdiez", "createdAt": "2020-09-01T09:54:00Z", "path": "src/main/java/org/jabref/JabRefExecutorService.java", "diffHunk": "@@ -132,13 +132,47 @@ public void submit(TimerTask timerTask, long millisecondsDelay) {\n         timer.schedule(timerTask, millisecondsDelay);\n     }\n \n+    /**\n+     * Shuts everything down. Upon termination, this method returns.\n+     */\n     public void shutdownEverything() {\n-        // those threads will be allowed to finish\n-        this.executorService.shutdown();\n-        // those threads will be interrupted in their current task\n-        this.lowPriorityExecutorService.shutdownNow();\n         // kill the remote thread\n         stopRemoteThread();\n+\n+        try {\n+            // those threads will be allowed to finish\n+            this.executorService.shutdown();\n+            if (!executorService.awaitTermination(60, TimeUnit.SECONDS)) {\n+                LOGGER.debug(\"One minute passed, saving still not completed. Trying forced shutdown.\");\n+                executorService.shutdownNow();\n+                if (executorService.awaitTermination(60, TimeUnit.SECONDS)) {\n+                    LOGGER.debug(\"One minute passed again - forced shutdown worked.\");\n+                } else {\n+                    LOGGER.error(\"DelayedTaskThrottler did not terminate\");", "originalCommit": "9df012a7f1a9b764f87fbd3412eda2be6318e263", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTAxNTIwNg==", "url": "https://github.com/JabRef/jabref/pull/6118#discussion_r481015206", "bodyText": "call above helper method", "author": "tobiasdiez", "createdAt": "2020-09-01T09:54:24Z", "path": "src/main/java/org/jabref/logic/util/DelayTaskThrottler.java", "diffHunk": "@@ -45,7 +46,25 @@ public void schedule(Runnable command) {\n         }\n     }\n \n+    /**\n+     * Shuts everything down. Upon termination, this method returns.\n+     */\n     public void shutdown() {\n+        // this is non-blocking. See https://stackoverflow.com/a/57383461/873282.\n         executor.shutdown();\n+        try {", "originalCommit": "9df012a7f1a9b764f87fbd3412eda2be6318e263", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "8a15394264a84cba50d6630588b7da9b7d256c51", "url": "https://github.com/JabRef/jabref/commit/8a15394264a84cba50d6630588b7da9b7d256c51", "message": "No more code clones", "committedDate": "2020-09-01T10:14:28Z", "type": "commit"}, {"oid": "eb0b55be7a11b9cad5c6e21812e204341069cf5e", "url": "https://github.com/JabRef/jabref/commit/eb0b55be7a11b9cad5c6e21812e204341069cf5e", "message": "Adress comments", "committedDate": "2020-09-01T10:18:29Z", "type": "commit"}, {"oid": "3edf24c86515f17b83b15735c5edb628c32f487f", "url": "https://github.com/JabRef/jabref/commit/3edf24c86515f17b83b15735c5edb628c32f487f", "message": "Merge branch 'master' into fix-delay-task-throttler", "committedDate": "2020-09-01T12:17:02Z", "type": "commit"}]}