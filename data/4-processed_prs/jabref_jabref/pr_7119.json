{"pr_number": 7119, "pr_title": "Improve library loading UX", "pr_createdAt": "2020-11-23T15:57:54Z", "pr_url": "https://github.com/JabRef/jabref/pull/7119", "timeline": [{"oid": "5ec4027f29b00d99a2a1ad59e30c3a3fc90c049f", "url": "https://github.com/JabRef/jabref/commit/5ec4027f29b00d99a2a1ad59e30c3a3fc90c049f", "message": "refactoring LibraryTab to be able to create an empty tab and feed it data when it's available", "committedDate": "2020-11-23T15:07:42Z", "type": "commit"}, {"oid": "e1af860e4c6f4d346955fe8851a0957dbc87f8b9", "url": "https://github.com/JabRef/jabref/commit/e1af860e4c6f4d346955fe8851a0957dbc87f8b9", "message": "applying the improvement when opening database using action", "committedDate": "2020-11-23T15:27:42Z", "type": "commit"}, {"oid": "5f2d7ea06c9e37d961dd10a9bb9414f4773486fa", "url": "https://github.com/JabRef/jabref/commit/5f2d7ea06c9e37d961dd10a9bb9414f4773486fa", "message": "checkstyle", "committedDate": "2020-11-23T16:39:23Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODkyMjQ2Mw==", "url": "https://github.com/JabRef/jabref/pull/7119#discussion_r528922463", "bodyText": "It would be cook if you could pass the exception as paramter to the error dialog as well, it's just one addtional paramter", "author": "Siedlerchr", "createdAt": "2020-11-23T18:48:36Z", "path": "src/main/java/org/jabref/gui/importer/actions/OpenDatabaseAction.java", "diffHunk": "@@ -210,4 +216,33 @@ private LibraryTab addNewDatabase(ParserResult result, final Path file, boolean\n         frame.addTab(libraryTab, raisePanel);\n         return libraryTab;\n     }\n+\n+    /* The layout to display in the tab when it's loading*/\n+    public Node createLoadingLayout() {\n+        ProgressIndicator progressIndicator = new ProgressIndicator(ProgressIndicator.INDETERMINATE_PROGRESS);\n+        BorderPane pane = new BorderPane();\n+        pane.setCenter(progressIndicator);\n+\n+        return pane;\n+    }\n+\n+    public void onDatabaseLoadingStarted(LibraryTab libraryTab, BackgroundTask<?> backgroundTask) {\n+        Node loadingLayout = createLoadingLayout();\n+        libraryTab.setContent(loadingLayout);\n+        libraryTab.setOnCloseRequest(e -> backgroundTask.cancel());\n+\n+        frame.addTab(libraryTab, true);\n+    }\n+\n+    public void onDatabaseLoadingSucceed(LibraryTab libraryTab, ParserResult result) {\n+        BibDatabaseContext context = result.getDatabaseContext();\n+        libraryTab.feedData(context);\n+\n+        OpenDatabaseAction.performPostOpenActions(libraryTab, result);\n+    }\n+\n+    public void onDatabaseLoadingFailed(LibraryTab libraryTab, Exception ex) {\n+        dialogService.showErrorDialogAndWait(Localization.lang(\"Connection error\"),", "originalCommit": "5f2d7ea06c9e37d961dd10a9bb9414f4773486fa", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "a1ee47404496f82c2cfa194686e39ebf7f0bbd29", "url": "https://github.com/JabRef/jabref/commit/a1ee47404496f82c2cfa194686e39ebf7f0bbd29", "message": "add exception parameter to error dialog", "committedDate": "2020-11-23T19:28:46Z", "type": "commit"}, {"oid": "1ca86161e986b2196902081a368fe9cb87cd7cd6", "url": "https://github.com/JabRef/jabref/commit/1ca86161e986b2196902081a368fe9cb87cd7cd6", "message": "Adding DataLoadingTask to LibraryTab", "committedDate": "2020-11-24T10:30:59Z", "type": "commit"}, {"oid": "8c0fd835d9245420f92508f53face49d506fafeb", "url": "https://github.com/JabRef/jabref/commit/8c0fd835d9245420f92508f53face49d506fafeb", "message": "Add getter for dataLoadingTask", "committedDate": "2020-11-24T10:39:10Z", "type": "commit"}, {"oid": "f43c2ff9d3dd99384f8dff9b545853fafbc2333a", "url": "https://github.com/JabRef/jabref/commit/f43c2ff9d3dd99384f8dff9b545853fafbc2333a", "message": "Fixing memory leak by canceling dataLoadingTask when tab is closed", "committedDate": "2020-11-24T10:48:25Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODk4MzQ0OA==", "url": "https://github.com/JabRef/jabref/pull/7119#discussion_r528983448", "bodyText": "I would let the LibraryTab handle the progress indicator. This could be done for example by setting the placeholder to the progress indicator. https://docs.oracle.com/javase/8/javafx/api/javafx/scene/control/TableView.html#placeholderProperty", "author": "tobiasdiez", "createdAt": "2020-11-23T20:42:20Z", "path": "src/main/java/org/jabref/gui/importer/actions/OpenDatabaseAction.java", "diffHunk": "@@ -210,4 +216,35 @@ private LibraryTab addNewDatabase(ParserResult result, final Path file, boolean\n         frame.addTab(libraryTab, raisePanel);\n         return libraryTab;\n     }\n+\n+    /* The layout to display in the tab when it's loading*/\n+    public Node createLoadingLayout() {", "originalCommit": "a1ee47404496f82c2cfa194686e39ebf7f0bbd29", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTU0MTc0Mg==", "url": "https://github.com/JabRef/jabref/pull/7119#discussion_r529541742", "bodyText": "There was a bug when I close a loading tab before it finishes, the tab next to it TableView would shrink but it seems using placeholder fixed it, Thank you", "author": "HoussemNasri", "createdAt": "2020-11-24T13:24:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODk4MzQ0OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODk4NDcxNg==", "url": "https://github.com/JabRef/jabref/pull/7119#discussion_r528984716", "bodyText": "I would put this before the feedData call. Some of the post actions change a lot of entries, which would result in unnecessary updates of the ui.", "author": "tobiasdiez", "createdAt": "2020-11-23T20:44:52Z", "path": "src/main/java/org/jabref/gui/importer/actions/OpenDatabaseAction.java", "diffHunk": "@@ -210,4 +216,35 @@ private LibraryTab addNewDatabase(ParserResult result, final Path file, boolean\n         frame.addTab(libraryTab, raisePanel);\n         return libraryTab;\n     }\n+\n+    /* The layout to display in the tab when it's loading*/\n+    public Node createLoadingLayout() {\n+        ProgressIndicator progressIndicator = new ProgressIndicator(ProgressIndicator.INDETERMINATE_PROGRESS);\n+        BorderPane pane = new BorderPane();\n+        pane.setCenter(progressIndicator);\n+\n+        return pane;\n+    }\n+\n+    public void onDatabaseLoadingStarted(LibraryTab libraryTab, BackgroundTask<?> backgroundTask) {\n+        Node loadingLayout = createLoadingLayout();\n+        libraryTab.setContent(loadingLayout);\n+        libraryTab.setOnCloseRequest(e -> backgroundTask.cancel());\n+\n+        frame.addTab(libraryTab, true);\n+    }\n+\n+    public void onDatabaseLoadingSucceed(LibraryTab libraryTab, ParserResult result) {\n+        BibDatabaseContext context = result.getDatabaseContext();\n+        libraryTab.feedData(context);\n+\n+        OpenDatabaseAction.performPostOpenActions(libraryTab, result);", "originalCommit": "a1ee47404496f82c2cfa194686e39ebf7f0bbd29", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODk4NjExMA==", "url": "https://github.com/JabRef/jabref/pull/7119#discussion_r528986110", "bodyText": "I think this should be in the opendatabaseaction class (as it's not really connected to the library tab)", "author": "tobiasdiez", "createdAt": "2020-11-23T20:47:22Z", "path": "src/main/java/org/jabref/gui/LibraryTab.java", "diffHunk": "@@ -140,15 +147,81 @@ public LibraryTab(JabRefFrame frame,\n         });\n     }\n \n+    public static LibraryTab createNewEmptyLibraryTab(JabRefFrame frame, Path file) {\n+        BibDatabaseContext context = new BibDatabaseContext();\n+        context.setDatabasePath(file);\n+\n+        return new LibraryTab(frame, frame.prefs(), context, ExternalFileTypes.getInstance());\n+    }\n+\n+    public void feedData(BibDatabaseContext bibDatabaseContext) {\n+        cleanUp();\n+\n+        this.bibDatabaseContext = Objects.requireNonNull(bibDatabaseContext);\n+\n+        bibDatabaseContext.getDatabase().registerListener(this);\n+        bibDatabaseContext.getMetaData().registerListener(this);\n+\n+        this.tableModel = new MainTableDataModel(getBibDatabaseContext(), preferencesService, Globals.stateManager);\n+        citationStyleCache = new CitationStyleCache(bibDatabaseContext);\n+        annotationCache = new FileAnnotationCache(bibDatabaseContext, preferencesService.getFilePreferences());\n+\n+        setupMainPanel();\n+        setupAutoCompletion();\n+\n+        this.getDatabase().registerListener(new SearchListener());\n+        this.getDatabase().registerListener(new EntriesRemovedListener());\n+\n+        // ensure that at each addition of a new entry, the entry is added to the groups interface\n+        this.bibDatabaseContext.getDatabase().registerListener(new GroupTreeListener());\n+        // ensure that all entry changes mark the panel as changed\n+        this.bibDatabaseContext.getDatabase().registerListener(this);\n+\n+        this.getDatabase().registerListener(new UpdateTimestampListener(preferencesService));\n+\n+        this.entryEditor = new EntryEditor(this, externalFileTypes);\n+\n+        Platform.runLater(() -> {\n+            EasyBind.subscribe(changedProperty, this::updateTabTitle);\n+            Globals.stateManager.getOpenDatabases().addListener((ListChangeListener<BibDatabaseContext>) c ->\n+                    updateTabTitle(changedProperty.getValue()));\n+        });\n+\n+        if (isDatabaseReadyForAutoSave(bibDatabaseContext)) {\n+            AutosaveManager autoSaver = AutosaveManager.start(bibDatabaseContext);\n+            autoSaver.registerListener(new AutosaveUiManager(this));\n+        }\n+\n+        BackupManager.start(this.bibDatabaseContext, Globals.entryTypesManager, Globals.prefs);\n+\n+        trackOpenNewDatabase(this);\n+\n+    }\n+\n+    private boolean isDatabaseReadyForAutoSave(BibDatabaseContext context) {\n+        return ((context.getLocation() == DatabaseLocation.SHARED) ||\n+                ((context.getLocation() == DatabaseLocation.LOCAL) && Globals.prefs.getBoolean(JabRefPreferences.LOCAL_AUTO_SAVE)))\n+                &&\n+                context.getDatabasePath().isPresent();\n+    }\n+\n+    private void trackOpenNewDatabase(LibraryTab libraryTab) {", "originalCommit": "a1ee47404496f82c2cfa194686e39ebf7f0bbd29", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTUwNTE4OA==", "url": "https://github.com/JabRef/jabref/pull/7119#discussion_r529505188", "bodyText": "and by this, you mean trackOpenNewDatabase(), right?", "author": "HoussemNasri", "createdAt": "2020-11-24T12:23:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODk4NjExMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTU3NDI4NQ==", "url": "https://github.com/JabRef/jabref/pull/7119#discussion_r529574285", "bodyText": "yes!", "author": "tobiasdiez", "createdAt": "2020-11-24T14:12:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODk4NjExMA=="}], "type": "inlineReview"}, {"oid": "ef088af6ca35eb4ac3707ffebecffd45fbca86ea", "url": "https://github.com/JabRef/jabref/commit/ef088af6ca35eb4ac3707ffebecffd45fbca86ea", "message": "Relocate LibraryTab method trackOpenNewDatabase() to OpenDatabaseAction", "committedDate": "2020-11-24T13:41:21Z", "type": "commit"}, {"oid": "77061c80a8e9c7e6dce2f028e425e899987e41b6", "url": "https://github.com/JabRef/jabref/commit/77061c80a8e9c7e6dce2f028e425e899987e41b6", "message": "Refactor LibraryTab to handle dataLoadingTask callbacks", "committedDate": "2020-11-24T13:41:22Z", "type": "commit"}, {"oid": "b7ca2d379021300818bb1ee5a50532f3f2d36203", "url": "https://github.com/JabRef/jabref/commit/b7ca2d379021300818bb1ee5a50532f3f2d36203", "message": "Put performPostOpenActions() before feedData() for performance reasons", "committedDate": "2020-11-24T18:00:53Z", "type": "commit"}, {"oid": "2e71e7a3c5297cbe34844e21d7b016b958c5702b", "url": "https://github.com/JabRef/jabref/commit/2e71e7a3c5297cbe34844e21d7b016b958c5702b", "message": "Fix groups pane not updating bug", "committedDate": "2020-11-24T22:46:30Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTQ2MjQ3Mg==", "url": "https://github.com/JabRef/jabref/pull/7119#discussion_r531462472", "bodyText": "This condition/if is uncessary as you either return null or the dataLoadingTask.", "author": "Siedlerchr", "createdAt": "2020-11-27T08:56:16Z", "path": "src/main/java/org/jabref/gui/LibraryTab.java", "diffHunk": "@@ -140,15 +152,107 @@ public LibraryTab(JabRefFrame frame,\n         });\n     }\n \n+    public void setDataLoadingTask(BackgroundTask<ParserResult> dataLoadingTask) {\n+        this.dataLoadingTask = dataLoadingTask;\n+    }\n+\n+    public BackgroundTask<?> getDataLoadingTask() {\n+        if (dataLoadingTask == null) {", "originalCommit": "2e71e7a3c5297cbe34844e21d7b016b958c5702b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "5783b3078297d39019f7149496bb1b3dfe5d4a54", "url": "https://github.com/JabRef/jabref/commit/5783b3078297d39019f7149496bb1b3dfe5d4a54", "message": "Cleanup code", "committedDate": "2020-11-27T22:07:34Z", "type": "commit"}, {"oid": "be3c2bff257fe4eedcc80c68e78c677e4ca841ff", "url": "https://github.com/JabRef/jabref/commit/be3c2bff257fe4eedcc80c68e78c677e4ca841ff", "message": "Merge branch 'master' into improve-database-loading-ux", "committedDate": "2020-12-05T18:41:52Z", "type": "commit"}, {"oid": "6c3149ce7ee0996c77aa7fbc7be1334d8dbf323a", "url": "https://github.com/JabRef/jabref/commit/6c3149ce7ee0996c77aa7fbc7be1334d8dbf323a", "message": "Extracted JabRefPreferences, fixed imports", "committedDate": "2020-12-05T19:24:36Z", "type": "commit"}, {"oid": "8b32c0953afc19d22abed054e4ac7d03d7d63b7d", "url": "https://github.com/JabRef/jabref/commit/8b32c0953afc19d22abed054e4ac7d03d7d63b7d", "message": "Extracted JabRefPreferences, fixed imports, removed dead code, shortened method name", "committedDate": "2020-12-05T19:33:01Z", "type": "commit"}]}