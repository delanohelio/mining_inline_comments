{"pr_number": 6232, "pr_title": "Allow basic markup syntax custom previews", "pr_createdAt": "2020-04-01T20:24:04Z", "pr_url": "https://github.com/JabRef/jabref/pull/6232", "timeline": [{"oid": "3cb10487fdc137f05d092861a0df93a3acc7aaae", "url": "https://github.com/JabRef/jabref/commit/3cb10487fdc137f05d092861a0df93a3acc7aaae", "message": "Allow basic markup syntax custom previews\n\nAdd MarkdownFormatter using https://github.com/vsch/flexmark-java/ to format markdown.\nTo configure Markdown in custom previews add the \"Markdown\" formatter.\nMarkdown is enabled by default for the comment field as requested in https://github.com/JabRef/jabref/issues/6194", "committedDate": "2020-04-01T20:16:16Z", "type": "commit"}, {"oid": "b13832575ebfd45df3b5381f5e6e424113bf5714", "url": "https://github.com/JabRef/jabref/commit/b13832575ebfd45df3b5381f5e6e424113bf5714", "message": "Remove AssertJ in favor of plain JUnit5", "committedDate": "2020-04-01T21:34:52Z", "type": "commit"}, {"oid": "1285b2a694228b3261fc36d9c3de95ad1c1137ed", "url": "https://github.com/JabRef/jabref/commit/1285b2a694228b3261fc36d9c3de95ad1c1137ed", "message": "Switch back to <p> instead of <br> for formatted text blocks", "committedDate": "2020-04-01T21:53:35Z", "type": "commit"}, {"oid": "c6d16d54bdacbfbee869513cbbf1282daa6bc8d1", "url": "https://github.com/JabRef/jabref/commit/c6d16d54bdacbfbee869513cbbf1282daa6bc8d1", "message": "Reduce MarkdownFormatterTest.formatWhenFormattingComplexMarkupThenReturnsOnlyOneLine to actually test newlines only because the rest is covered elsewhere", "committedDate": "2020-04-01T22:04:44Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjE4MDc0Ng==", "url": "https://github.com/JabRef/jabref/pull/6232#discussion_r402180746", "bodyText": "is requires annotations really necessary. I remember that I had a few problems with annotations vs jakarta.annotation in the past.", "author": "tobiasdiez", "createdAt": "2020-04-02T09:36:18Z", "path": "src/main/java/module-info.java", "diffHunk": "@@ -82,4 +82,11 @@\n     requires org.antlr.antlr4.runtime;\n     requires flowless;\n     requires org.apache.tika.core;\n+\n+    requires flexmark;\n+    requires flexmark.ext.gfm.strikethrough;\n+    requires flexmark.ext.gfm.tasklist;\n+    requires flexmark.util.ast;\n+    requires flexmark.util.data;\n+    requires annotations;", "originalCommit": "c6d16d54bdacbfbee869513cbbf1282daa6bc8d1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjUzMzk1NQ==", "url": "https://github.com/JabRef/jabref/pull/6232#discussion_r402533955", "bodyText": "You're right it's not needed, I was tempted to put @NotNull annotations on parameters but removed them because it doesn't make sense to use them on one class only. Apparently forgot to remove the requires.", "author": "AlexanderGirgis", "createdAt": "2020-04-02T18:44:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjE4MDc0Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjE4MTc0OQ==", "url": "https://github.com/JabRef/jabref/pull/6232#discussion_r402181749", "bodyText": "is the HTMLChars formatter still necessary or is the HtmlRenderer already taking care of it?", "author": "tobiasdiez", "createdAt": "2020-04-02T09:37:58Z", "path": "src/main/java/org/jabref/logic/layout/format/MarkdownFormatter.java", "diffHunk": "@@ -0,0 +1,41 @@\n+package org.jabref.logic.layout.format;\n+\n+import java.util.List;\n+import java.util.Objects;\n+\n+import org.jabref.logic.layout.LayoutFormatter;\n+\n+import com.vladsch.flexmark.ext.gfm.strikethrough.StrikethroughExtension;\n+import com.vladsch.flexmark.ext.gfm.tasklist.TaskListExtension;\n+import com.vladsch.flexmark.html.HtmlRenderer;\n+import com.vladsch.flexmark.parser.Parser;\n+import com.vladsch.flexmark.util.ast.Node;\n+import com.vladsch.flexmark.util.data.MutableDataSet;\n+\n+public class MarkdownFormatter implements LayoutFormatter {\n+\n+    private final Parser parser;\n+    private final HtmlRenderer renderer;\n+\n+    public MarkdownFormatter() {\n+        MutableDataSet options = new MutableDataSet();\n+        options.set(Parser.EXTENSIONS, List.of(\n+                StrikethroughExtension.create(),\n+                TaskListExtension.create()\n+        ));\n+\n+        parser = Parser.builder(options).build();\n+        renderer = HtmlRenderer.builder(options).build();\n+    }\n+\n+    @Override\n+    public String format(final String fieldText) {\n+        Objects.requireNonNull(fieldText, \"Field Text should not be null, when handed to formatter\");\n+\n+        Node document = parser.parse(fieldText);\n+        String html = renderer.render(document);\n+\n+        // workaround HTMLChars transforming \"\\n\" into <br> by returning a one liner", "originalCommit": "c6d16d54bdacbfbee869513cbbf1282daa6bc8d1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjMyMDM1OQ==", "url": "https://github.com/JabRef/jabref/pull/6232#discussion_r402320359", "bodyText": "It's needed to be checked whether the HtmlRenderer does some \"Magic\". Without guessing, I would gess not...\nThe HTMLChars formatter does:", "author": "koppor", "createdAt": "2020-04-02T13:39:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjE4MTc0OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjE4Mjc3Mw==", "url": "https://github.com/JabRef/jabref/pull/6232#discussion_r402182773", "bodyText": "Is there a reason not to simply replace \\\\format[HTMLChars]{\\\\comment} with \\\\format[Markdown,HTMLChars]{\\\\comment} (or \\\\format[Markdown]{\\\\comment} see above)? If the user changed the preview style a bit, then this replacement would still have the desired effect, right?", "author": "tobiasdiez", "createdAt": "2020-04-02T09:39:37Z", "path": "src/main/java/org/jabref/migrations/PreferencesMigrations.java", "diffHunk": "@@ -301,6 +302,12 @@ static void upgradePreviewStyleFromReviewToComment(JabRefPreferences prefs) {\n         prefs.setPreviewStyle(migratedStyle);\n     }\n \n+    static void upgradePreviewStyleAllowMarkdown(JabRefPreferences prefs) {\n+        String currentPreviewStyle = prefs.getPreviewStyle();\n+        String migratedStyle = currentPreviewStyle.replace(\"\\\\begin{comment}<BR><BR><b>Comment: </b> \\\\format[HTMLChars]{\\\\comment} \\\\end{comment}\", \"\\\\begin{comment}<BR><BR><b>Comment: </b> \\\\format[Markdown,HTMLChars]{\\\\comment} \\\\end{comment}\");", "originalCommit": "c6d16d54bdacbfbee869513cbbf1282daa6bc8d1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjUzODc3OQ==", "url": "https://github.com/JabRef/jabref/pull/6232#discussion_r402538779", "bodyText": "My reasoning was to not force a different behavior on people who consciously changed their configuration. So I only changed it, when it's the unchanged default value. However this is a matter of opinion. How are changes like this normally handled in Jabref?", "author": "AlexanderGirgis", "createdAt": "2020-04-02T18:52:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjE4Mjc3Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjU1MTY2Mw==", "url": "https://github.com/JabRef/jabref/pull/6232#discussion_r402551663", "bodyText": "I like the proposal by @tobiasdiez. It a) integrated the feature and b) focuses the update to the Comment field", "author": "koppor", "createdAt": "2020-04-02T19:14:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjE4Mjc3Mw=="}], "type": "inlineReview"}, {"oid": "62552128117c1a7a6fbbb8d885e476134f515487", "url": "https://github.com/JabRef/jabref/commit/62552128117c1a7a6fbbb8d885e476134f515487", "message": "Remove annotations left behind by reverted change.", "committedDate": "2020-04-02T18:56:25Z", "type": "commit"}, {"oid": "d7ca5364412ff2ca3f8f721ba8ec0ff424ed0106", "url": "https://github.com/JabRef/jabref/commit/d7ca5364412ff2ca3f8f721ba8ec0ff424ed0106", "message": "Narrow configuration migration to migrate customized preview configurations as well as suggested in review by @tobiasdiez and @koppor", "committedDate": "2020-04-02T20:36:16Z", "type": "commit"}, {"oid": "232915482c41c13421c2b613c2947aae1bf20e1f", "url": "https://github.com/JabRef/jabref/commit/232915482c41c13421c2b613c2947aae1bf20e1f", "message": "Merge branch 'master' into AlexanderGirgis-allow-basic-markup-in-comment-fixes-6194", "committedDate": "2020-04-03T06:23:01Z", "type": "commit"}, {"oid": "aae5ede8e31537a0cdbfa9a003dd6370f1cf78c0", "url": "https://github.com/JabRef/jabref/commit/aae5ede8e31537a0cdbfa9a003dd6370f1cf78c0", "message": "Fix checkstyle error in PreferencesMigrationsTest", "committedDate": "2020-04-03T20:04:48Z", "type": "commit"}, {"oid": "0cc45c6068ee544fe49a19309b1682dcf4492896", "url": "https://github.com/JabRef/jabref/commit/0cc45c6068ee544fe49a19309b1682dcf4492896", "message": "Merge branch 'allow-basic-markup-in-comment-fixes-6194' of https://github.com/AlexanderGirgis/jabref into allow-basic-markup-in-comment-fixes-6194", "committedDate": "2020-04-03T20:24:20Z", "type": "commit"}]}