{"pr_number": 6245, "pr_title": "Refactor EntryEditorPreferences", "pr_createdAt": "2020-04-05T16:32:09Z", "pr_url": "https://github.com/JabRef/jabref/pull/6245", "timeline": [{"oid": "69ca54f522804f6118a9b11b1ef56f86318dc32a", "url": "https://github.com/JabRef/jabref/commit/69ca54f522804f6118a9b11b1ef56f86318dc32a", "message": "Refactored JabRefPreferences, concentrated EntryEditorPreferences and extracted store logic out of dialog CustomizeGeneralFieldsDialogViewModel.", "committedDate": "2020-04-05T16:21:28Z", "type": "commit"}, {"oid": "f93fc243eb5c7721c7d16667aea72daac8295aa5", "url": "https://github.com/JabRef/jabref/commit/f93fc243eb5c7721c7d16667aea72daac8295aa5", "message": "Merge remote-tracking branch 'upstream/master' into refactor_entryeditorprefs\n\n# Conflicts:\n#\tsrc/main/java/org/jabref/preferences/JabRefPreferences.java\n#\tsrc/main/java/org/jabref/preferences/PreferencesService.java", "committedDate": "2020-04-05T16:25:25Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDU3ODI2Mg==", "url": "https://github.com/JabRef/jabref/pull/6245#discussion_r404578262", "bodyText": "This is probably a huge thing, but what about replacing this many boolean parameters with an enum?", "author": "Siedlerchr", "createdAt": "2020-04-07T06:59:44Z", "path": "src/main/java/org/jabref/gui/entryeditor/EntryEditorPreferences.java", "diffHunk": "@@ -24,7 +24,17 @@\n     private boolean avoidOverwritingCiteKey;\n     private final boolean shouldShowLatexCitationsTab;\n \n-    public EntryEditorPreferences(Map<String, Set<Field>> entryEditorTabList, FieldWriterPreferences fieldWriterPreferences, ImportFormatPreferences importFormatPreferences, List<Field> customTabFieldNames, boolean shouldShowRecommendationsTab, boolean isMrdlibAccepted, boolean shouldShowLatexCitationsTab, boolean showSourceTabByDefault, BibtexKeyPatternPreferences bibtexKeyPatternPreferences, KeyBindingRepository keyBindings, boolean avoidOverwritingCiteKey) {\n+    public EntryEditorPreferences(Map<String, Set<Field>> entryEditorTabList,\n+                                  FieldWriterPreferences fieldWriterPreferences,\n+                                  ImportFormatPreferences importFormatPreferences,\n+                                  List<Field> customTabFieldNames,\n+                                  boolean shouldShowRecommendationsTab,", "originalCommit": "f93fc243eb5c7721c7d16667aea72daac8295aa5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDU5MDgyMw==", "url": "https://github.com/JabRef/jabref/pull/6245#discussion_r404590823", "bodyText": "I think I'll leave that to my successor. \ud83d\ude09 I really wanted to focus on extracting the single calls to JabRefPreferences::get and put out of the codebase.\nAs soon as this is done, it should be easier to distinguish between preferences model and logic.\nBut we should keep this idea in mind.", "author": "calixtus", "createdAt": "2020-04-07T07:23:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDU3ODI2Mg=="}], "type": "inlineReview"}, {"oid": "d74b272660933fa1d7f67e15501047137f859ae9", "url": "https://github.com/JabRef/jabref/commit/d74b272660933fa1d7f67e15501047137f859ae9", "message": "Extracted calls to JabRefPreferences::get and put out of EntryEditorTabViewModel", "committedDate": "2020-04-08T21:55:55Z", "type": "commit"}, {"oid": "6af3ddd12ae0b66b121473ae47ededfd4c3921ca", "url": "https://github.com/JabRef/jabref/commit/6af3ddd12ae0b66b121473ae47ededfd4c3921ca", "message": "Fixed tests", "committedDate": "2020-04-08T22:07:24Z", "type": "commit"}, {"oid": "6d0a90af6e623bd02f0ffee5306a79e90838aebf", "url": "https://github.com/JabRef/jabref/commit/6d0a90af6e623bd02f0ffee5306a79e90838aebf", "message": "Refactored AutoCompletePreferences", "committedDate": "2020-04-10T19:16:58Z", "type": "commit"}, {"oid": "059d208d1b965dc5c92367b6f6f2cf3191ff0bcd", "url": "https://github.com/JabRef/jabref/commit/059d208d1b965dc5c92367b6f6f2cf3191ff0bcd", "message": "Merge remote-tracking branch 'upstream/master' into refactor_entryeditorprefs", "committedDate": "2020-04-11T10:16:10Z", "type": "commit"}, {"oid": "b85e8add74a3be68e2704a221eb4be4be3508e8c", "url": "https://github.com/JabRef/jabref/commit/b85e8add74a3be68e2704a221eb4be4be3508e8c", "message": "Merge remote-tracking branch 'upstream/master' into refactor_entryeditorprefs\n\n# Conflicts:\n#\tsrc/main/java/org/jabref/gui/customizefields/CustomizeGeneralFieldsDialogViewModel.java\n#\tsrc/main/java/org/jabref/gui/preferences/EntryEditorTabViewModel.java\n#\tsrc/main/java/org/jabref/preferences/JabRefPreferences.java", "committedDate": "2020-04-14T11:57:42Z", "type": "commit"}, {"oid": "647a781d25048dbc26308c075cb04c20f58f02c7", "url": "https://github.com/JabRef/jabref/commit/647a781d25048dbc26308c075cb04c20f58f02c7", "message": "Checkstyle and missing comment", "committedDate": "2020-04-17T16:19:14Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDMyODA0Mw==", "url": "https://github.com/JabRef/jabref/pull/6245#discussion_r410328043", "bodyText": "the prefix only doesn't really makes sense, right? Moreover, the enum name should be capitalized.", "author": "tobiasdiez", "createdAt": "2020-04-17T16:16:46Z", "path": "src/main/java/org/jabref/gui/autocompleter/AutoCompletePreferences.java", "diffHunk": "@@ -8,26 +8,24 @@\n \n public class AutoCompletePreferences {\n \n+    public enum onlyCompleteNameFormat {", "originalCommit": "b85e8add74a3be68e2704a221eb4be4be3508e8c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDMyODk2MQ==", "url": "https://github.com/JabRef/jabref/pull/6245#discussion_r410328961", "bodyText": "This field doesn't seem to be used", "author": "tobiasdiez", "createdAt": "2020-04-17T16:18:21Z", "path": "src/main/java/org/jabref/gui/bibtexkeypattern/GenerateBibtexKeySingleAction.java", "diffHunk": "@@ -4,37 +4,39 @@\n \n import org.jabref.gui.DialogService;\n import org.jabref.gui.actions.SimpleCommand;\n-import org.jabref.gui.entryeditor.EntryEditorPreferences;\n import org.jabref.gui.undo.UndoableKeyChange;\n import org.jabref.logic.bibtexkeypattern.BibtexKeyGenerator;\n+import org.jabref.logic.bibtexkeypattern.BibtexKeyPatternPreferences;\n import org.jabref.model.database.BibDatabaseContext;\n import org.jabref.model.entry.BibEntry;\n+import org.jabref.preferences.PreferencesService;\n \n public class GenerateBibtexKeySingleAction extends SimpleCommand {\n \n     private DialogService dialogService;\n     private BibDatabaseContext databaseContext;\n-    private EntryEditorPreferences preferences;\n+    private PreferencesService preferencesService;\n+    private BibtexKeyPatternPreferences bibtexKeyPatternPreferences;", "originalCommit": "b85e8add74a3be68e2704a221eb4be4be3508e8c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDMzMDI4OA==", "url": "https://github.com/JabRef/jabref/pull/6245#discussion_r410330288", "bodyText": "Shouldn't updateEntryEditorTabList be automatically called if storeEntryEditorTabList is called?", "author": "tobiasdiez", "createdAt": "2020-04-17T16:20:44Z", "path": "src/main/java/org/jabref/gui/customizefields/CustomizeGeneralFieldsDialogViewModel.java", "diffHunk": "@@ -43,48 +46,36 @@ public StringProperty fieldsTextProperty() {\n     }\n \n     public void saveFields() {\n+        Map<String, Set<Field>> customTabsMap = new LinkedHashMap<>();\n         String[] lines = fieldsText.get().split(\"\\n\");\n-        int i = 0;\n-        for (; i < lines.length; i++) {\n-            String[] parts = lines[i].split(\":\");\n+\n+        for (String line : lines) {\n+            String[] parts = line.split(\":\");\n             if (parts.length != 2) {\n-                // Report error and exit.\n-                String field = Localization.lang(\"field\");\n-                String title = Localization.lang(\"Error\");\n-                String content = Localization.lang(\"Each line must be of the following form\") + \" '\" +\n-                                 Localization.lang(\"Tabname\") + ':' + field + \"1;\" + field + \"2;...;\" + field + \"N'\";\n-                dialogService.showInformationDialogAndWait(title, content);\n+                dialogService.showInformationDialogAndWait(\n+                        Localization.lang(\"Error\"),\n+                        Localization.lang(\"Each line must be of the following form: 'tab:field1;field2;...;fieldN'.\"));\n                 return;\n             }\n \n             String testString = BibtexKeyGenerator.cleanKey(parts[1], preferences.getEnforceLegalKeys());\n             if (!testString.equals(parts[1]) || (parts[1].indexOf('&') >= 0)) {\n-                String title = Localization.lang(\"Error\");\n-                String content = Localization.lang(\"Field names are not allowed to contain white space or the following \"\n-                                                   + \"characters\")\n-                                 + \": # { } ( ) ~ , ^ & - \\\" ' ` \u02b9 \\\\\";\n-                dialogService.showInformationDialogAndWait(title, content);\n+                dialogService.showInformationDialogAndWait(\n+                        Localization.lang(\"Error\"),\n+                        Localization.lang(\"Field names are not allowed to contain white spaces or certain characters (%0).\",\n+                                \"# { } ( ) ~ , ^ & - \\\" ' ` \u02b9 \\\\\"));\n                 return;\n             }\n-            preferences.setCustomTabsNameAndFields(parts[0], parts[1], i);\n \n+            customTabsMap.put(parts[0], FieldFactory.parseFieldList(parts[1]));\n         }\n-        preferences.purgeSeries(JabRefPreferences.CUSTOM_TAB_NAME, i);\n-        preferences.purgeSeries(JabRefPreferences.CUSTOM_TAB_FIELDS, i);\n+\n+        preferences.storeEntryEditorTabList(customTabsMap);", "originalCommit": "647a781d25048dbc26308c075cb04c20f58f02c7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDMzMTUwMg==", "url": "https://github.com/JabRef/jabref/pull/6245#discussion_r410331502", "bodyText": "In my opinion, the name preferences is also fine. That's probably a matter of taste...", "author": "tobiasdiez", "createdAt": "2020-04-17T16:22:55Z", "path": "src/main/java/org/jabref/gui/fieldeditors/BibtexKeyEditorViewModel.java", "diffHunk": "@@ -5,28 +5,28 @@\n import org.jabref.gui.DialogService;\n import org.jabref.gui.autocompleter.AutoCompleteSuggestionProvider;\n import org.jabref.gui.bibtexkeypattern.GenerateBibtexKeySingleAction;\n-import org.jabref.gui.entryeditor.EntryEditorPreferences;\n import org.jabref.logic.integrity.FieldCheckers;\n import org.jabref.model.database.BibDatabaseContext;\n import org.jabref.model.entry.field.Field;\n+import org.jabref.preferences.PreferencesService;\n \n import de.saxsys.mvvmfx.utils.commands.Command;\n \n public class BibtexKeyEditorViewModel extends AbstractEditorViewModel {\n-    private final EntryEditorPreferences preferences;\n+    private final PreferencesService preferencesService;", "originalCommit": "647a781d25048dbc26308c075cb04c20f58f02c7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDM1NDY5NA==", "url": "https://github.com/JabRef/jabref/pull/6245#discussion_r410354694", "bodyText": "In the process of moving from JabRefPreferences to PreferencesService (and preferences objects) I wanted to distinguish between JabRefPreferences as preferences or prefs or whatever is used in the code on one hand and preferencesService on the other.\nBut we can change that after I'm hopefully done sometime.", "author": "calixtus", "createdAt": "2020-04-17T17:05:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDMzMTUwMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDMzMjE3Nw==", "url": "https://github.com/JabRef/jabref/pull/6245#discussion_r410332177", "bodyText": "Is this todo still relevant?", "author": "tobiasdiez", "createdAt": "2020-04-17T16:24:06Z", "path": "src/main/java/org/jabref/gui/preferences/EntryEditorTabViewModel.java", "diffHunk": "@@ -33,37 +32,42 @@\n     private final BooleanProperty firstNameModeFullProperty = new SimpleBooleanProperty();\n     private final BooleanProperty firstNameModeBothProperty = new SimpleBooleanProperty();\n \n-    private AutoCompletePreferences autoCompletePreferences;\n-\n     private final DialogService dialogService;\n-    private final JabRefPreferences preferences;\n+    private final PreferencesService preferencesService;\n+    private final EntryEditorPreferences initialEntryEditorPreferences;\n+    private final AutoCompletePreferences initialAutoCompletePreferences;\n \n-    public EntryEditorTabViewModel(DialogService dialogService, JabRefPreferences preferences) {\n+    public EntryEditorTabViewModel(DialogService dialogService, PreferencesService preferencesService) {\n         this.dialogService = dialogService;\n-        this.preferences = preferences;\n-        this.autoCompletePreferences = preferences.getAutoCompletePreferences();\n+        this.preferencesService = preferencesService;\n+        this.initialEntryEditorPreferences = preferencesService.getEntryEditorPreferences();\n+        this.initialAutoCompletePreferences = preferencesService.getAutoCompletePreferences();\n     }\n \n     @Override\n     public void setValues() {\n-        openOnNewEntryProperty.setValue(preferences.getBoolean(JabRefPreferences.AUTO_OPEN_FORM));\n-        defaultSourceProperty.setValue(preferences.getBoolean(JabRefPreferences.DEFAULT_SHOW_SOURCE));\n-        enableRelatedArticlesTabProperty.setValue(preferences.getBoolean(JabRefPreferences.SHOW_RECOMMENDATIONS));\n-        acceptRecommendationsProperty.setValue(preferences.getBoolean(JabRefPreferences.ACCEPT_RECOMMENDATIONS));\n-        enableLatexCitationsTabProperty.setValue(preferences.getBoolean(JabRefPreferences.SHOW_LATEX_CITATIONS));\n-        enableValidationProperty.setValue(preferences.getBoolean(JabRefPreferences.VALIDATE_IN_ENTRY_EDITOR));\n-        enableAutoCompleteProperty.setValue(autoCompletePreferences.shouldAutoComplete());\n-        autoCompleteFieldsProperty.setValue(autoCompletePreferences.getCompleteNamesAsString());\n-\n-        if (autoCompletePreferences.getOnlyCompleteFirstLast()) {\n+        // ToDo: Include EntryEditorFieldsEditor in PreferencesDialog", "originalCommit": "647a781d25048dbc26308c075cb04c20f58f02c7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDM1NzA2MA==", "url": "https://github.com/JabRef/jabref/pull/6245#discussion_r410357060", "bodyText": "Had the wrong name. Should be CustomizeGeneralFieldsDialog", "author": "calixtus", "createdAt": "2020-04-17T17:09:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDMzMjE3Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDMzNDAwNA==", "url": "https://github.com/JabRef/jabref/pull/6245#discussion_r410334004", "bodyText": "Can these constants JabRefPreferences.AUTO_OPEN_FORM etc now be made private?", "author": "tobiasdiez", "createdAt": "2020-04-17T16:27:09Z", "path": "src/main/java/org/jabref/gui/preferences/EntryEditorTabViewModel.java", "diffHunk": "@@ -78,35 +82,37 @@ public void setValues() {\n \n     @Override\n     public void storeSettings() {\n-        preferences.putBoolean(JabRefPreferences.AUTO_OPEN_FORM, openOnNewEntryProperty.getValue());\n-        preferences.putBoolean(JabRefPreferences.DEFAULT_SHOW_SOURCE, defaultSourceProperty.getValue());\n-        preferences.putBoolean(JabRefPreferences.SHOW_RECOMMENDATIONS, enableRelatedArticlesTabProperty.getValue());\n-        preferences.putBoolean(JabRefPreferences.ACCEPT_RECOMMENDATIONS, acceptRecommendationsProperty.getValue());\n-        preferences.putBoolean(JabRefPreferences.SHOW_LATEX_CITATIONS, enableLatexCitationsTabProperty.getValue());\n-        preferences.putBoolean(JabRefPreferences.VALIDATE_IN_ENTRY_EDITOR, enableValidationProperty.getValue());\n-\n-        autoCompletePreferences.setShouldAutoComplete(enableAutoCompleteProperty.getValue());\n-        autoCompletePreferences.setCompleteNames(autoCompleteFieldsProperty.getValue());\n-        if (autoCompleteBothProperty.getValue()) {\n-            autoCompletePreferences.setOnlyCompleteFirstLast(false);\n-            autoCompletePreferences.setOnlyCompleteLastFirst(false);\n-        } else if (autoCompleteFirstLastProperty.getValue()) {\n-            autoCompletePreferences.setOnlyCompleteFirstLast(true);\n-            autoCompletePreferences.setOnlyCompleteLastFirst(false);\n-        } else {\n-            autoCompletePreferences.setOnlyCompleteFirstLast(false);\n-            autoCompletePreferences.setOnlyCompleteLastFirst(true);\n+        preferencesService.storeEntryEditorPreferences(new EntryEditorPreferences(", "originalCommit": "647a781d25048dbc26308c075cb04c20f58f02c7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDM1ODgxOA==", "url": "https://github.com/JabRef/jabref/pull/6245#discussion_r410358818", "bodyText": "Sadly no, not yet, since they are still in use outside the preferences dialog. I did not yet remove all the calls to JabRefPreferences::get and ::put in the whole codebase, since this would make this PR completly unreviewable.\nI wanted to do this step by step.", "author": "calixtus", "createdAt": "2020-04-17T17:13:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDMzNDAwNA=="}], "type": "inlineReview"}, {"oid": "36d675cba95c692a35508636ecc491cbedc1437a", "url": "https://github.com/JabRef/jabref/commit/36d675cba95c692a35508636ecc491cbedc1437a", "message": "Rewording and small refactorings regarding discussion", "committedDate": "2020-04-17T17:24:11Z", "type": "commit"}, {"oid": "d7b18c302cd5e4300dc9c145c9fc0b53c71f83e7", "url": "https://github.com/JabRef/jabref/commit/d7b18c302cd5e4300dc9c145c9fc0b53c71f83e7", "message": "Merge remote-tracking branch 'upstream/master' into refactor_entryeditorprefs\n\n# Conflicts:\n#\tsrc/main/java/org/jabref/gui/fieldeditors/BibtexKeyEditorViewModel.java", "committedDate": "2020-04-20T10:14:27Z", "type": "commit"}]}