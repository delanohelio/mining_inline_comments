{"pr_number": 7243, "pr_title": "Fix Normalize pages formatter not replacing dashes", "pr_createdAt": "2020-12-25T16:43:20Z", "pr_url": "https://github.com/JabRef/jabref/pull/7243", "timeline": [{"oid": "afc0ff9fd7b2e3b6632680419547187d7c74060d", "url": "https://github.com/JabRef/jabref/commit/afc0ff9fd7b2e3b6632680419547187d7c74060d", "message": "Fix Normalize pages fornatter not replacing dashes\n\nFixes #7239", "committedDate": "2020-12-25T16:43:02Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODg5ODIxMQ==", "url": "https://github.com/JabRef/jabref/pull/7243#discussion_r548898211", "bodyText": "I think this may result in unwanted changes. The formatter should only format pages if they are \"kind of\" in the right format. Now something like 40&50 is changed to 4050.", "author": "tobiasdiez", "createdAt": "2020-12-25T18:05:18Z", "path": "src/main/java/org/jabref/logic/formatter/bibtexfields/NormalizePagesFormatter.java", "diffHunk": "@@ -63,7 +64,8 @@ public String format(String value) {\n         // Remove pages prefix\n         String cleanValue = value.replace(\"pp.\", \"\").replace(\"p.\", \"\");\n         // remove unwanted literals including en dash, em dash, and whitespace\n-        cleanValue = cleanValue.replaceAll(\"\\u2013|\\u2014\", \"-\").replaceAll(REJECT_LITERALS, \"\");\n+        cleanValue = EM_EN_DASH_PATTERN.matcher(cleanValue).replaceAll(\"-\");\n+        cleanValue = REJECT_LITERALS_PATTERN.matcher(cleanValue).replaceAll(\"\");", "originalCommit": "afc0ff9fd7b2e3b6632680419547187d7c74060d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTQxNjY1Nw==", "url": "https://github.com/JabRef/jabref/pull/7243#discussion_r549416657", "bodyText": "Fixed in the new commit", "author": "koppor", "createdAt": "2020-12-28T17:00:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODg5ODIxMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODg5ODI2NQ==", "url": "https://github.com/JabRef/jabref/pull/7243#discussion_r548898265", "bodyText": "I would put this into the PAGES_DETECT_PATTERN.", "author": "tobiasdiez", "createdAt": "2020-12-25T18:05:46Z", "path": "src/main/java/org/jabref/logic/formatter/bibtexfields/NormalizePagesFormatter.java", "diffHunk": "@@ -63,7 +64,8 @@ public String format(String value) {\n         // Remove pages prefix\n         String cleanValue = value.replace(\"pp.\", \"\").replace(\"p.\", \"\");\n         // remove unwanted literals including en dash, em dash, and whitespace\n-        cleanValue = cleanValue.replaceAll(\"\\u2013|\\u2014\", \"-\").replaceAll(REJECT_LITERALS, \"\");\n+        cleanValue = EM_EN_DASH_PATTERN.matcher(cleanValue).replaceAll(\"-\");", "originalCommit": "afc0ff9fd7b2e3b6632680419547187d7c74060d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODkwOTg4Nw==", "url": "https://github.com/JabRef/jabref/pull/7243#discussion_r548909887", "bodyText": "No, it makes sense to first replace all occurrences of en/em dashes before using pages detect pattern with a minus.", "author": "Siedlerchr", "createdAt": "2020-12-25T20:38:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODg5ODI2NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODkxMTQ5MQ==", "url": "https://github.com/JabRef/jabref/pull/7243#discussion_r548911491", "bodyText": "@Siedlerchr In BibTeX, an em-dash is ---, and an en-dash is --. Maybe the replacement should enforce this?", "author": "mlep", "createdAt": "2020-12-25T21:02:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODg5ODI2NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODkxMTc5MA==", "url": "https://github.com/JabRef/jabref/pull/7243#discussion_r548911790", "bodyText": "In pages you can either have a minus or a -- https://www.bibtex.com/f/pages-field/ at least that's what the mods exporter expects", "author": "Siedlerchr", "createdAt": "2020-12-25T21:06:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODg5ODI2NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODkxMzA0Nw==", "url": "https://github.com/JabRef/jabref/pull/7243#discussion_r548913047", "bodyText": "The URL you give mentions \"It is standard to use an en-dash (\u201c--\u201d) to separate a page range.\" \ud83d\ude09", "author": "mlep", "createdAt": "2020-12-25T21:24:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODg5ODI2NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODk2NzE0Mg==", "url": "https://github.com/JabRef/jabref/pull/7243#discussion_r548967142", "bodyText": "No, it makes sense to first replace all occurrences of en/em dashes before using pages detect pattern with a minus.\n\nWhat are the advantages of this approach? I only see that the performance is worse as you apply to regex per string instead of only one.\nI also agree with mlep, that -- is the desired format (and that also the format that the formatter produces). But this already covered by the part ?:-{1,2} in the regex. So my suggestion would be to simply replace - by -|\\u2013|\\u2014 in the regex.", "author": "tobiasdiez", "createdAt": "2020-12-26T10:10:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODg5ODI2NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODk4NDc2NQ==", "url": "https://github.com/JabRef/jabref/pull/7243#discussion_r548984765", "bodyText": "I looked a bit into it, the problem is that for the test case R404-R405 the page detect pattern regex does not match anything non-numeric and therefore would return the orginal value.\nE.g. it would only match 404-405", "author": "Siedlerchr", "createdAt": "2020-12-26T13:51:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODg5ODI2NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODk4NTAzMg==", "url": "https://github.com/JabRef/jabref/pull/7243#discussion_r548985032", "bodyText": "I would suggest we weaken the regex to follow the biblatex def: (2.2.1)\n\nA range is something optionally followed by one or more dashes optionally followed by some non-dash (e.g.5--7).", "author": "Siedlerchr", "createdAt": "2020-12-26T13:54:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODg5ODI2NQ=="}], "type": "inlineReview"}, {"oid": "a127881702ca3446826eea189cf17ded91b9d6e5", "url": "https://github.com/JabRef/jabref/commit/a127881702ca3446826eea189cf17ded91b9d6e5", "message": "add to existing regexes", "committedDate": "2020-12-26T13:51:03Z", "type": "commit"}, {"oid": "55be2f89d8120671467f36d887f1251db4f5696b", "url": "https://github.com/JabRef/jabref/commit/55be2f89d8120671467f36d887f1251db4f5696b", "message": "Simplify NormalizePagesFormatter and add UnprotectTermsFormatter", "committedDate": "2020-12-28T17:00:19Z", "type": "commit"}, {"oid": "edd430c6ef6896eae7c79f7b739a4ac846023340", "url": "https://github.com/JabRef/jabref/commit/edd430c6ef6896eae7c79f7b739a4ac846023340", "message": "Merge branch 'master' into fixNormalizePagesFormatter", "committedDate": "2020-12-28T17:03:36Z", "type": "commit"}, {"oid": "ed1f74cc0920907d5480569dfe0ac7fe2264db07", "url": "https://github.com/JabRef/jabref/commit/ed1f74cc0920907d5480569dfe0ac7fe2264db07", "message": "Fix checkstyle", "committedDate": "2020-12-28T17:36:37Z", "type": "commit"}, {"oid": "0ac8c19d62278edb2920a80699c5312c186e1f10", "url": "https://github.com/JabRef/jabref/commit/0ac8c19d62278edb2920a80699c5312c186e1f10", "message": "fix failing test and checkstlye", "committedDate": "2020-12-29T12:01:43Z", "type": "commit"}, {"oid": "3d334303320b974d7803b0f4ec50b69bc202ae4d", "url": "https://github.com/JabRef/jabref/commit/3d334303320b974d7803b0f4ec50b69bc202ae4d", "message": "try to fix l10n", "committedDate": "2020-12-29T12:36:39Z", "type": "commit"}, {"oid": "428aea1055d479c773fee9f65d28e33dde65b6f0", "url": "https://github.com/JabRef/jabref/commit/428aea1055d479c773fee9f65d28e33dde65b6f0", "message": "fix l10n again", "committedDate": "2020-12-29T12:41:56Z", "type": "commit"}, {"oid": "361cb5dfd2a4dbdacf1315eb8a871a9c2d982fe5", "url": "https://github.com/JabRef/jabref/commit/361cb5dfd2a4dbdacf1315eb8a871a9c2d982fe5", "message": "hopefully last l10n fix", "committedDate": "2020-12-29T12:48:03Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTc2NDc5OQ==", "url": "https://github.com/JabRef/jabref/pull/7243#discussion_r549764799", "bodyText": "input -> expected order makes more sense", "author": "tobiasdiez", "createdAt": "2020-12-29T16:20:49Z", "path": "src/test/java/org/jabref/logic/formatter/bibtexfields/NormalizePagesFormatterTest.java", "diffHunk": "@@ -10,102 +13,76 @@\n  */\n public class NormalizePagesFormatterTest {\n \n-    private NormalizePagesFormatter formatter;\n+    private final NormalizePagesFormatter formatter = new NormalizePagesFormatter();\n \n-    @BeforeEach\n-    public void setUp() {\n-        formatter = new NormalizePagesFormatter();\n-    }\n+    private static Stream<Arguments> tests() {\n+        return Stream.of(\n+                // formatSinglePageResultsInNoChange\n+                Arguments.of(\"1\", \"1\"),\n \n-    @Test\n-    public void formatSinglePageResultsInNoChange() {\n-        assertEquals(\"1\", formatter.format(\"1\"));\n-    }\n+                // formatPageNumbers\n+                Arguments.of(\"1--2\", \"1-2\"),\n \n-    @Test\n-    public void formatPageNumbers() {\n-        assertEquals(\"1--2\", formatter.format(\"1-2\"));\n-    }\n+                // formatPageNumbersCommaSeparated\n+                Arguments.of(\"1,2,3\", \"1,2,3\"),\n \n-    @Test\n-    public void formatPageNumbersCommaSeparated() {\n-        assertEquals(\"1,2,3\", formatter.format(\"1,2,3\"));\n-    }\n+                // formatPageNumbersPlusRange\n+                Arguments.of(\"43+\", \"43+\"),\n \n-    @Test\n-    public void formatPageNumbersPlusRange() {\n-        assertEquals(\"43+\", formatter.format(\"43+\"));\n-    }\n+                // ignoreWhitespaceInPageNumbers\n+                Arguments.of(\"1--2\", \"   1  - 2 \"),\n \n-    @Test\n-    public void ignoreWhitespaceInPageNumbers() {\n-        assertEquals(\"1--2\", formatter.format(\"   1  - 2 \"));\n-    }\n+                // removeWhitespaceSinglePage\n+                Arguments.of(\"1\", \"   1  \"),\n \n-    @Test\n-    public void removeWhitespaceSinglePage() {\n-        assertEquals(\"1\", formatter.format(\"   1  \"));\n-    }\n+                // removeWhitespacePageRange\n+                Arguments.of(\"1--2\", \"   1 -- 2  \"),\n \n-    @Test\n-    public void removeWhitespacePageRange() {\n-        assertEquals(\"1--2\", formatter.format(\"   1 -- 2  \"));\n-    }\n+                // ignoreWhitespaceInPageNumbersWithDoubleDash\n+                Arguments.of(\"43--103\", \"43 -- 103\"),\n \n-    @Test\n-    public void ignoreWhitespaceInPageNumbersWithDoubleDash() {\n-        assertEquals(\"43--103\", formatter.format(\"43 -- 103\"));\n-    }\n+                // keepCorrectlyFormattedPageNumbers\n+                Arguments.of(\"1--2\", \"1--2\"),\n \n-    @Test\n-    public void keepCorrectlyFormattedPageNumbers() {\n-        assertEquals(\"1--2\", formatter.format(\"1--2\"));\n-    }\n+                // formatPageNumbersRemoveUnexpectedLiterals\n+                Arguments.of(\"1--2\", \"{1}-{2}\"),\n \n-    @Test\n-    public void formatPageNumbersRemoveUnexpectedLiterals() {\n-        assertEquals(\"1--2\", formatter.format(\"{1}-{2}\"));\n-    }\n+                // formatPageNumbersRegexNotMatching\n+                Arguments.of(\"12\", \"12\"),\n \n-    @Test\n-    public void formatPageNumbersRegexNotMatching() {\n-        assertEquals(\"12\", formatter.format(\"12\"));\n-    }\n+                // doNotRemoveLetters\n+                Arguments.of(\"R1--R50\", \"R1-R50\"),\n \n-    @Test\n-    public void doNotRemoveLetters() {\n-        assertEquals(\"R1-R50\", formatter.format(\"R1-R50\"));\n-    }\n+                // replaceLongDashWithDoubleDash\n+                Arguments.of(\"1--50\", \"1 \\u2014 50\"),\n \n-    @Test\n-    public void replaceLongDashWithDoubleDash() {\n-        assertEquals(\"1--50\", formatter.format(\"1 \\u2014 50\"));\n-    }\n+                // removePagePrefix\n+                Arguments.of(\"50\", \"p.50\"),\n \n-    @Test\n-    public void removePagePrefix() {\n-        assertEquals(\"50\", formatter.format(\"p.50\"));\n-    }\n+                // removePagesPrefix\n+                Arguments.of(\"50\", \"pp.50\"),\n \n-    @Test\n-    public void removePagesPrefix() {\n-        assertEquals(\"50\", formatter.format(\"pp.50\"));\n-    }\n+                // keep &\n+                Arguments.of(\"40&50\", \"40&50\"),\n \n-    @Test\n-    public void formatACMPages() {\n-        // This appears in https://doi.org/10.1145/1658373.1658375\n-        assertEquals(\"2:1--2:33\", formatter.format(\"2:1-2:33\"));\n-    }\n+                // formatACMPages\n+                // This appears in https://doi.org/10.1145/1658373.1658375\n+                Arguments.of(\"2:1--2:33\", \"2:1-2:33\"),\n+\n+                // keepFormattedACMPages\n+                // This appears in https://doi.org/10.1145/1658373.1658375\n+                Arguments.of(\"2:1--2:33\", \"2:1--2:33\"),\n+\n+                // formatExample\n+                Arguments.of(\"1--2\", new NormalizePagesFormatter().getExampleInput()),\n \n-    @Test\n-    public void keepFormattedACMPages() {\n-        // This appears in https://doi.org/10.1145/1658373.1658375\n-        assertEquals(\"2:1--2:33\", formatter.format(\"2:1--2:33\"));\n+                // replaceDashWithMinus\n+                Arguments.of(\"R404--R405\", \"R404\u2013R405\"));\n     }\n \n-    @Test\n-    public void formatExample() {\n-        assertEquals(\"1--2\", formatter.format(formatter.getExampleInput()));\n+    @ParameterizedTest\n+    @MethodSource(\"tests\")\n+    public void test(String expected, String toFormat) {", "originalCommit": "361cb5dfd2a4dbdacf1315eb8a871a9c2d982fe5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTc2NzI2OQ==", "url": "https://github.com/JabRef/jabref/pull/7243#discussion_r549767269", "bodyText": "add \"balanced\" ?", "author": "tobiasdiez", "createdAt": "2020-12-29T16:28:00Z", "path": "src/main/java/org/jabref/logic/formatter/casechanger/UnprotectTermsFormatter.java", "diffHunk": "@@ -0,0 +1,63 @@\n+package org.jabref.logic.formatter.casechanger;\n+\n+import java.util.Objects;\n+\n+import org.jabref.logic.cleanup.Formatter;\n+import org.jabref.logic.l10n.Localization;\n+\n+/**\n+ * Remove {} brackets around words\n+ *\n+ * Related formatter: {@link ProtectTermsFormatter}\n+ */\n+public class UnprotectTermsFormatter extends Formatter {\n+\n+    @Override\n+    public String format(String text) {\n+        // similar implementation at {@link org.jabref.logic.formatter.bibtexfields.RemoveBracesFormatter.hasNegativeBraceCount}\n+        Objects.requireNonNull(text);\n+        if (text.isEmpty()) {\n+            return text;\n+        }\n+        StringBuilder result = new StringBuilder();\n+        int level = 0;\n+        int index = 0;\n+        do {\n+            char charAtIndex = text.charAt(index);\n+            if (charAtIndex == '{') {\n+                level++;\n+            } else if (charAtIndex == '}') {\n+                level--;\n+            } else {\n+                result.append(charAtIndex);\n+            }\n+            index++;\n+        } while (index < text.length() && level >= 0);\n+        if (level != 0) {\n+            // in case of unbalanced braces, the original text is returned unmodified\n+            return text;\n+        }\n+        return result.toString();\n+    }\n+\n+    @Override\n+    public String getDescription() {\n+        return Localization.lang(\n+                \"Removes all {} brackets around words.\");", "originalCommit": "361cb5dfd2a4dbdacf1315eb8a871a9c2d982fe5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTc2OTMxOA==", "url": "https://github.com/JabRef/jabref/pull/7243#discussion_r549769318", "bodyText": "I'm also not sure if I-X is correct or I--X for roman page numbers.", "author": "tobiasdiez", "createdAt": "2020-12-29T16:34:16Z", "path": "src/main/java/org/jabref/logic/formatter/bibtexfields/NormalizePagesFormatter.java", "diffHunk": "@@ -63,19 +65,9 @@ public String format(String value) {\n         // Remove pages prefix\n         String cleanValue = value.replace(\"pp.\", \"\").replace(\"p.\", \"\");\n         // remove unwanted literals including en dash, em dash, and whitespace\n-        cleanValue = cleanValue.replaceAll(\"\\u2013|\\u2014\", \"-\").replaceAll(REJECT_LITERALS, \"\");\n-        // try to find pages pattern\n-        Matcher matcher = PAGES_DETECT_PATTERN.matcher(cleanValue);\n-        if (matcher.matches()) {\n-            // replace\n-            if (Strings.isNullOrEmpty(matcher.group(\"endpage\"))) {\n-                return matcher.replaceFirst(SINGLE_PAGE_REPLACE_PATTERN);\n-            } else {\n-                return matcher.replaceFirst(PAGES_REPLACE_PATTERN);\n-            }\n-        }\n-        // no replacement\n-        return value;\n+        value = EM_EN_DASH_PATTERN.matcher(cleanValue).replaceAll(\"-\")\n+                                  .replaceAll(\"[ ]*[-]+[ ]*\", \"--\");\n+        return unprotectTermsFormatter.format(value.trim());", "originalCommit": "361cb5dfd2a4dbdacf1315eb8a871a9c2d982fe5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTc4NjA1MA==", "url": "https://github.com/JabRef/jabref/pull/7243#discussion_r549786050", "bodyText": "Result of test-driven-development \ud83d\ude07. I will think more about it now.", "author": "koppor", "createdAt": "2020-12-29T17:25:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTc2OTMxOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTQyNjIxMA==", "url": "https://github.com/JabRef/jabref/pull/7243#discussion_r551426210", "bodyText": "I'm also not sure if I-X is correct or I--X for roman page numbers.\n\nThis reads more as a page range, too. Roman 9 is written IX (and not I-X), isn't it?", "author": "koppor", "createdAt": "2021-01-04T16:32:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTc2OTMxOA=="}], "type": "inlineReview"}, {"oid": "1b7c1509183544d940e78b54cdf1840f631117b6", "url": "https://github.com/JabRef/jabref/commit/1b7c1509183544d940e78b54cdf1840f631117b6", "message": "Add new test cases", "committedDate": "2020-12-29T19:03:31Z", "type": "commit"}, {"oid": "76329c0d73af2f98751801f31d8107c7bb9e3afb", "url": "https://github.com/JabRef/jabref/commit/76329c0d73af2f98751801f31d8107c7bb9e3afb", "message": "Adapt localization", "committedDate": "2020-12-29T19:03:42Z", "type": "commit"}, {"oid": "37e4d0cfbcca4a942760d90859efa71fdc71e24b", "url": "https://github.com/JabRef/jabref/commit/37e4d0cfbcca4a942760d90859efa71fdc71e24b", "message": "Merge branch 'fixNormalizePagesFormatter' of github.com:JabRef/jabref into fixNormalizePagesFormatter", "committedDate": "2020-12-29T19:03:57Z", "type": "commit"}, {"oid": "c536b38ca88109b60cb384581790e5213af1d3ec", "url": "https://github.com/JabRef/jabref/commit/c536b38ca88109b60cb384581790e5213af1d3ec", "message": "Remove obsolete translation", "committedDate": "2020-12-29T19:05:20Z", "type": "commit"}, {"oid": "61567f84d2f6be158840317422ebb45bde0db20f", "url": "https://github.com/JabRef/jabref/commit/61567f84d2f6be158840317422ebb45bde0db20f", "message": "Handle more special cases (and also add examples to tests)", "committedDate": "2020-12-29T22:30:49Z", "type": "commit"}, {"oid": "93d7028a4f2a51a44136c4d3adad971f4cfaef8f", "url": "https://github.com/JabRef/jabref/commit/93d7028a4f2a51a44136c4d3adad971f4cfaef8f", "message": "Add missing tests", "committedDate": "2020-12-29T22:46:55Z", "type": "commit"}, {"oid": "05c01ed4232fe12cf52592f2b4b40268191e48f7", "url": "https://github.com/JabRef/jabref/commit/05c01ed4232fe12cf52592f2b4b40268191e48f7", "message": "Merge branch 'master' into fixNormalizePagesFormatter", "committedDate": "2021-01-04T16:30:40Z", "type": "commit"}]}