{"pr_number": 473, "pr_title": "Improve Memory Management", "pr_createdAt": "2020-04-06T22:19:59Z", "pr_url": "https://github.com/dogtagpki/jss/pull/473", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQyNTYzNw==", "url": "https://github.com/dogtagpki/jss/pull/473#discussion_r404425637", "bodyText": "Duplicate line.", "author": "cipherboy", "createdAt": "2020-04-06T22:25:59Z", "path": "org/mozilla/jss/util/NativeProxy.java", "diffHunk": "@@ -125,11 +140,13 @@ protected void finalize() throws Throwable {\n      *\n      * See comment in finalize.\n      */\n-    public final void close() throws Exception {\n+    public synchronized final void close() throws Exception {\n         try {\n-            if (registry.remove(this)) {\n+            registry.remove(this);\n+            if (mPointer != null) {\n                 releaseNativeResources();\n             }\n+            registry.remove(this);", "originalCommit": "bf5f7252435f0fdcff8c14e25b3e8779391b13d6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQyNTc4Mw==", "url": "https://github.com/dogtagpki/jss/pull/473#discussion_r404425783", "bodyText": "Noisy diff.", "author": "cipherboy", "createdAt": "2020-04-06T22:26:23Z", "path": "org/mozilla/jss/util/NativeProxy.java", "diffHunk": "@@ -144,15 +161,16 @@ public final void close() throws Exception {\n      *\n      * See also: JSS_clearPtrFromProxy(...) in jssutil.h\n      */\n-    public final void clear() {\n-        this.mPointer = null;\n+    public synchronized final void clear() {\n         registry.remove(this);\n+        this.mPointer = null;", "originalCommit": "bf5f7252435f0fdcff8c14e25b3e8779391b13d6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "8369e97dcf566172bfe42444f7e0eaf80de670bb", "url": "https://github.com/dogtagpki/jss/commit/8369e97dcf566172bfe42444f7e0eaf80de670bb", "message": "Improve SSLFDProxy's globalRef access\n\nSigned-off-by: Alexander Scheel <ascheel@redhat.com>", "committedDate": "2020-04-06T22:28:39Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQ0MTUwNA==", "url": "https://github.com/dogtagpki/jss/pull/473#discussion_r404441504", "bodyText": "How about we convert this method into SSLFDProxy.close()?\nclass PRFDProxy extends NativeProxy {\n    public void close() {\n        PR.Close(this); // don't call JSS_clearPtrFromProxy()\n        super.close(); // release native resources\n    }\n}\n\nclass SSLFDProxy extends PRFDProxy {\n    public void close() {\n        if (!fd.isNull()) {\n            SSL.RemoveCallbacks(fd); \n        }\n        super.close();\n    }\n}", "author": "edewata", "createdAt": "2020-04-06T23:08:06Z", "path": "org/mozilla/jss/nss/PR.java", "diffHunk": "@@ -66,20 +66,38 @@ public static native PRFDProxy NewBufferPRFD(BufferProxy read_buf,\n                                                  BufferProxy write_buf,\n                                                  byte[] peer_info);\n     /**\n-     * Close an existing PRFDProxy.\n+     * Close an existing PRFDProxy, clearing the pointer if successful.\n      *\n      * See also: PR_Close in /usr/include/nspr4/prio.h\n      */\n-    public static native int Close(PRFDProxy fd);\n+    public static int Close(PRFDProxy fd) {\n+        return Close(fd, true);\n+    }\n+\n+    /**\n+     * Close an existing PRFDProxy with an option to clear the pointer.\n+     *\n+     * See also: PR_Close in /usr/include/nspr4/prio.h\n+     */\n+    public static native int Close(PRFDProxy fd, boolean clear);\n \n     /**\n      * Close an existing SSLFDProxy.\n      *\n      * See also: org.mozilla.jss.nss.PR.Close\n-     *           org.mozilla.jss.nss.SSLFD.releaseNativeResources\n+     *           org.mozilla.jss.nss.SSLFDProxy.releaseNativeResources\n      */\n-    public static int Close(SSLFDProxy fd) throws Exception {\n-        int ret = PR.Close((PRFDProxy) fd);\n+    public synchronized static int Close(SSLFDProxy fd) throws Exception {", "originalCommit": "8369e97dcf566172bfe42444f7e0eaf80de670bb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQ1MDA4OQ==", "url": "https://github.com/dogtagpki/jss/pull/473#discussion_r404450089", "bodyText": "PR is static class and contains wrappers for NSPR functions beginning with the prefix PR_, of which PR_Close() is one. Since SSLFDProxy has the same native pointer type as PRFDProxy (a PRFileDesc * -- the difference is the former has been wrapped by a call to SSL.ImportFD(...)) there is no difference. All PR_ functions work, because NSS creates another PRFileDesc layer for SSL, on top of the existing one. We need to do a little more work in PR_Close on a SSLFDProxy instance, because we need to invoke the SSLFDProxy.close(...) method as well, which we don't necessarily want to do if it is NULL.\nOn the other hand PRProxy.close() and SSLFDProxy.close() take no arguments and are part of the NativeProxy+AutoCloseable interface, which free the proxy and clear the mPointer instance.\n\nOur use of PR_Close(PRFileDesc *) is limited mostly to SSLFDProxy instances, but we do test it on files as well, in the test suite.", "author": "cipherboy", "createdAt": "2020-04-06T23:33:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQ0MTUwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQ1MTEyMg==", "url": "https://github.com/dogtagpki/jss/pull/473#discussion_r404451122", "bodyText": "Namely, PRFDProxy.close() doesn't invoke anything actually -- but we explicitly call PR.Close(...) in SSLEngine's cleanup() handler. The issue is we can't call this strictly a \"free\" method -- closing a PRFDProxy via PR_Close(...) might send data over the network if the TLS connection hasn't properly terminated. This violates the contract for NativeProxy.releaseNativeResources(). We don't necessarily want to do that (nor do we necessary have space in our buffers, ... &c), hence why PRFDProxy.close() doesn't do anything and why SSLFDProxy.close() only (tries to) free the GlobalRefProxy self-pointer.\nEdit: Accidentally left out a few words.", "author": "cipherboy", "createdAt": "2020-04-06T23:36:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQ0MTUwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDgxNTI0OQ==", "url": "https://github.com/dogtagpki/jss/pull/473#discussion_r404815249", "bodyText": "Keep in mind, nss.PR is meant to be a thin wrapper over NSPR functions. Just like nss.SSL is a thin wrapper over SSL_ functions. We're likely going to move as much of this behind a single, large JNI call in an optimized SSLEngine implementation. Some of these details will thus go away.", "author": "cipherboy", "createdAt": "2020-04-07T13:38:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQ0MTUwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE4Mzc2MQ==", "url": "https://github.com/dogtagpki/jss/pull/473#discussion_r405183761", "bodyText": "I'm not really familiar with all the details, so I'll let you decide :) And feel free to merge as is since it's already approved. Anything we discussed here is for a possible future enhancement.\nTo my understanding NSPR only has a PR_Close(PRFileDesc*) function which is already wrapped by PR.Close(PRFDProxy). The PR.Close(SSLFDProxy) on the other hand does not have a corresponding native code in NSPR. Also, that method has a dependency on SSL class which is a wrapper for NSS. From design perspective I don't think a wrapper for NSPR should depend on a wrapper for NSS.\nI think if we want to do something similar to PR.Close(PRFDProxy), we probably should add an SSL.Close(SSLFDProxy) instead. Or we can just add an SSLFDProxy.close() like I described earlier. If we don't want to add PRFDProxy.close(), we probably can do something like this:\nclass SSLFDProxy extends PRFDProxy {\n    public void close() {\n        if (fd.isNull()) {\n            return;\n        }\n        SSL.RemoveCallbacks(fd); \n        PR.Close(this, false);\n        releaseNativeResources();\n    }\n}\n\nIt should be functionally identical to your code without creating an NSPR -> NSS dependency issue.", "author": "edewata", "createdAt": "2020-04-08T00:05:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQ0MTUwNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQ0MzY1OA==", "url": "https://github.com/dogtagpki/jss/pull/473#discussion_r404443658", "bodyText": "It looks like this condition only happens in JSS tests. If there is no real usage where clear == JNI_TRUE we might as well simplify the code to no longer call JSS_clearPtrFromProxy(). See also my other comment about not calling JSS_clearPtrFromProxy().", "author": "edewata", "createdAt": "2020-04-06T23:14:17Z", "path": "org/mozilla/jss/nss/PR.c", "diffHunk": "@@ -106,7 +106,7 @@ Java_org_mozilla_jss_nss_PR_Close(JNIEnv *env, jclass clazz, jobject fd)\n     }\n \n     PRStatus ret = PR_Close(real_fd);\n-    if (ret == PR_SUCCESS) {\n+    if (ret == PR_SUCCESS && clear == JNI_TRUE) {", "originalCommit": "8369e97dcf566172bfe42444f7e0eaf80de670bb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjMwNDUyMg==", "url": "https://github.com/dogtagpki/jss/pull/473#discussion_r406304522", "bodyText": "Yeah I think we could update this in a separate PR and simplify how these are handled.", "author": "cipherboy", "createdAt": "2020-04-09T15:52:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQ0MzY1OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQ0NzczMQ==", "url": "https://github.com/dogtagpki/jss/pull/473#discussion_r404447731", "bodyText": "We probably can use AtomicInteger:\nstatic AtomicInteger counter = new AtomicInteger();\nint index;\n\nprotected NativeProxy(byte[] pointer, boolean track) {\n    index = counter.getAndIncrement();\n}\npublic int hashCode() {\n    return index;\n}", "author": "edewata", "createdAt": "2020-04-06T23:26:05Z", "path": "org/mozilla/jss/util/NativeProxy.java", "diffHunk": "@@ -173,6 +197,21 @@ public final void clear() {\n      * releaseNativeResources() gets called.\n      */\n     static HashSet<NativeProxy> registry = new HashSet<NativeProxy>();\n+    static int registryIndex;", "originalCommit": "8369e97dcf566172bfe42444f7e0eaf80de670bb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQ1MjAwNg==", "url": "https://github.com/dogtagpki/jss/pull/473#discussion_r404452006", "bodyText": "Yeah, AtomicInteger is probably the best bet. The old NativeProxy used a random integer. \ud83e\udd84", "author": "cipherboy", "createdAt": "2020-04-06T23:39:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQ0NzczMQ=="}], "type": "inlineReview"}, {"oid": "4a1057d3cdf7cd7c58e1b551eefa8b1b083cece7", "url": "https://github.com/dogtagpki/jss/commit/4a1057d3cdf7cd7c58e1b551eefa8b1b083cece7", "message": "Improve SSLFDProxy's globalRef access\n\nSigned-off-by: Alexander Scheel <ascheel@redhat.com>", "committedDate": "2020-04-07T13:17:18Z", "type": "forcePushed"}, {"oid": "6b885a914df633d6342c863b32e35c0f9762f3a6", "url": "https://github.com/dogtagpki/jss/commit/6b885a914df633d6342c863b32e35c0f9762f3a6", "message": "Improve SSLFDProxy's globalRef access\n\nSigned-off-by: Alexander Scheel <ascheel@redhat.com>", "committedDate": "2020-04-07T13:21:29Z", "type": "forcePushed"}, {"oid": "1c5598c93dd38139609e1bf3760a957757935621", "url": "https://github.com/dogtagpki/jss/commit/1c5598c93dd38139609e1bf3760a957757935621", "message": "Improve SSLFDProxy's globalRef access\n\nSigned-off-by: Alexander Scheel <ascheel@redhat.com>", "committedDate": "2020-04-09T12:06:59Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjE2MDQyOQ==", "url": "https://github.com/dogtagpki/jss/pull/473#discussion_r406160429", "bodyText": "@edewata  -- I think this might be better and provide more random distribution of mHashCode.", "author": "cipherboy", "createdAt": "2020-04-09T12:13:13Z", "path": "org/mozilla/jss/util/NativeProxy.java", "diffHunk": "@@ -51,10 +53,13 @@ public NativeProxy(byte[] pointer) {\n      */\n     protected NativeProxy(byte[] pointer, boolean track) {\n         mPointer = pointer;\n+        mHashCode = registryIndex.getAndIncrement();\n+        if (mPointer != null) {\n+            mHashCode = Objects.hash(mHashCode, Arrays.hashCode(mPointer));", "originalCommit": "1c5598c93dd38139609e1bf3760a957757935621", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "c8e1c4b41533b6bea743ed48fa9afe50b0740c7f", "url": "https://github.com/dogtagpki/jss/commit/c8e1c4b41533b6bea743ed48fa9afe50b0740c7f", "message": "Improve SSLFDProxy's globalRef access\n\nSigned-off-by: Alexander Scheel <ascheel@redhat.com>", "committedDate": "2020-04-09T14:17:59Z", "type": "forcePushed"}, {"oid": "2da782288f2d21c1faa8f1fac2d55162c3914afc", "url": "https://github.com/dogtagpki/jss/commit/2da782288f2d21c1faa8f1fac2d55162c3914afc", "message": "Improve SSLFDProxy's globalRef access\n\nSigned-off-by: Alexander Scheel <ascheel@redhat.com>", "committedDate": "2020-04-14T14:47:26Z", "type": "forcePushed"}, {"oid": "ae96fe7ecfe1720cfc56b6c893132ead76cd3880", "url": "https://github.com/dogtagpki/jss/commit/ae96fe7ecfe1720cfc56b6c893132ead76cd3880", "message": "Make PK11Cert AutoCloseable\n\nSigned-off-by: Alexander Scheel <ascheel@redhat.com>", "committedDate": "2020-04-15T14:48:59Z", "type": "commit"}, {"oid": "3e4880edc8990bbc4b4ffeaf10bf4eb0ada04000", "url": "https://github.com/dogtagpki/jss/commit/3e4880edc8990bbc4b4ffeaf10bf4eb0ada04000", "message": "Make PK11Cipher AutoCloseable\n\nSigned-off-by: Alexander Scheel <ascheel@redhat.com>", "committedDate": "2020-04-15T14:49:00Z", "type": "commit"}, {"oid": "6651a3e2c6f3b5852a4135dccc31db318c4fa6d1", "url": "https://github.com/dogtagpki/jss/commit/6651a3e2c6f3b5852a4135dccc31db318c4fa6d1", "message": "Make PK11Key AutoCloseable\n\nSigned-off-by: Alexander Scheel <ascheel@redhat.com>", "committedDate": "2020-04-15T14:49:00Z", "type": "commit"}, {"oid": "32cb00de71e0709bbd74c6eb27e7aa93a84f93a8", "url": "https://github.com/dogtagpki/jss/commit/32cb00de71e0709bbd74c6eb27e7aa93a84f93a8", "message": "Make PK11MessageDigest AutoCloseable\n\nSigned-off-by: Alexander Scheel <ascheel@redhat.com>", "committedDate": "2020-04-15T14:49:00Z", "type": "commit"}, {"oid": "4fcb9c7bfa9535d6eb2943d9185aaea7db3c121e", "url": "https://github.com/dogtagpki/jss/commit/4fcb9c7bfa9535d6eb2943d9185aaea7db3c121e", "message": "Make PK11Signature AutoCloseable\n\nSigned-off-by: Alexander Scheel <ascheel@redhat.com>", "committedDate": "2020-04-15T14:49:00Z", "type": "commit"}, {"oid": "21359dd4178f7491603256a3d9a5e4f0f0c235cb", "url": "https://github.com/dogtagpki/jss/commit/21359dd4178f7491603256a3d9a5e4f0f0c235cb", "message": "Fix NativeProxy registry tracking\n\nWhen the switch was made to a HashSet-based registry in\neb5df01003d74b57473eacb84e538d31f5bb06ca, NativeProxy didn't override\nhashCode(...). This resulted in calls to close() (and thus, finalize())\nnot invoking the releaseNativeResources() function to release the\nunderlying memory.\n\nSigned-off-by: Alexander Scheel <ascheel@redhat.com>", "committedDate": "2020-04-15T14:49:00Z", "type": "commit"}, {"oid": "5ea19394c2af3d965463c22803d31cb45a347db4", "url": "https://github.com/dogtagpki/jss/commit/5ea19394c2af3d965463c22803d31cb45a347db4", "message": "Improve SSLFDProxy's globalRef access\n\nSigned-off-by: Alexander Scheel <ascheel@redhat.com>", "committedDate": "2020-04-15T14:49:01Z", "type": "commit"}, {"oid": "ee7e17ec7c12716965c1813b7dbbc524e6f4b2bb", "url": "https://github.com/dogtagpki/jss/commit/ee7e17ec7c12716965c1813b7dbbc524e6f4b2bb", "message": "Handle NULL SigContextProxy pointer\n\nSigned-off-by: Alexander Scheel <ascheel@redhat.com>", "committedDate": "2020-04-15T14:59:16Z", "type": "forcePushed"}, {"oid": "bd931acc416624b05cfe627ea3feddcb0f4a54a3", "url": "https://github.com/dogtagpki/jss/commit/bd931acc416624b05cfe627ea3feddcb0f4a54a3", "message": "Handle NULL pointers in releaseNativeResources\n\nIn the style of the previous commit, ensure all pointers are\nnon-NULL before continuing to free them. Some of these are excessive as\nNSS does do some checking, but in this case consistency is better.\n\nSigned-off-by: Alexander Scheel <ascheel@redhat.com>", "committedDate": "2020-04-15T15:06:45Z", "type": "forcePushed"}, {"oid": "156e0e7fe6bf56279eb9ebc0f2ce1031a2e9dc03", "url": "https://github.com/dogtagpki/jss/commit/156e0e7fe6bf56279eb9ebc0f2ce1031a2e9dc03", "message": "Fix SSLSocketBase/SocketProxy closure\n\nWith NativeProxy now exposing a close method, we can fix the interaction\nbetween SSLSocketBase and its wrapped SocketProxy. Previously,\nSSLSocketBase invoked a native method, socketClose() during its close()\nhandler (which is invoked from SSLSocket.close() and in turn from\nSSLSocket.finalize()). This gives a potential race condition when the\nvalue of mPointer is NULLed between SocketProxy.finalize() and\nSSLSocket.close() / SSLSocket.finalize() -- if the former executes\nbefore the latter, socketClose() would attempt to dereference a NULL\npointer.\n\nFix this in two parts:\n\n 1. Make SocketProxy.releaseNativeResource() actually release native\n    resources by calling JSSL_DestroySocketData(...); at the same time,\n    make closeSocket merely call PR_Close(...).\n 2. Update SSLSocketBase to call SocketProxy.close() explicitly.\n\nSigned-off-by: Alexander Scheel <ascheel@redhat.com>", "committedDate": "2020-04-15T23:40:27Z", "type": "commit"}, {"oid": "f284e3390b0722535505478ce9886f4ee92c6483", "url": "https://github.com/dogtagpki/jss/commit/f284e3390b0722535505478ce9886f4ee92c6483", "message": "Handle NULL pointers in releaseNativeResources\n\nIn the style of the previous commit, ensure all pointers are\nnon-NULL before continuing to free them. Some of these are excessive as\nNSS does do some checking, but in this case consistency is better.\n\nSigned-off-by: Alexander Scheel <ascheel@redhat.com>", "committedDate": "2020-04-15T23:40:27Z", "type": "commit"}, {"oid": "f284e3390b0722535505478ce9886f4ee92c6483", "url": "https://github.com/dogtagpki/jss/commit/f284e3390b0722535505478ce9886f4ee92c6483", "message": "Handle NULL pointers in releaseNativeResources\n\nIn the style of the previous commit, ensure all pointers are\nnon-NULL before continuing to free them. Some of these are excessive as\nNSS does do some checking, but in this case consistency is better.\n\nSigned-off-by: Alexander Scheel <ascheel@redhat.com>", "committedDate": "2020-04-15T23:40:27Z", "type": "forcePushed"}]}