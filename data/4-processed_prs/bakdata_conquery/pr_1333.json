{"pr_number": 1333, "pr_title": "remove decoupled meta store", "pr_createdAt": "2020-09-01T21:16:29Z", "pr_url": "https://github.com/bakdata/conquery/pull/1333", "timeline": [{"oid": "e2874c074c81c9b49541956c22a678a02de56703", "url": "https://github.com/bakdata/conquery/commit/e2874c074c81c9b49541956c22a678a02de56703", "message": "improve log message", "committedDate": "2020-09-22T15:33:40Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjcwNzg2MA==", "url": "https://github.com/bakdata/conquery/pull/1333#discussion_r496707860", "bodyText": "irgendwie wirkt das etwas redundant?", "author": "awildturtok", "createdAt": "2020-09-29T13:17:12Z", "path": "backend/src/main/java/com/bakdata/conquery/io/xodus/NamespacedStorageImpl.java", "diffHunk": "@@ -122,10 +127,15 @@ protected void createStores(Collector<KeyIncludingStore<?, ?>> collector) {\n \n \n \t\tcollector\n-\t\t\t.collect(dataset)\n-\t\t\t.collect(dictionaries)\n-\t\t\t.collect(concepts)\n-\t\t\t.collect(imports);\n+\t\t\t.collect(environment,dataset)", "originalCommit": "1c1044b6553af2a4f2b5acc5a300e5af064c0f37", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODg2ODk4NQ==", "url": "https://github.com/bakdata/conquery/pull/1333#discussion_r498868985", "bodyText": "Ich splitte das in einen Store und einen Environment collector okay?", "author": "thoniTUB", "createdAt": "2020-10-02T14:48:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjcwNzg2MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDM5NzU5Mg==", "url": "https://github.com/bakdata/conquery/pull/1333#discussion_r500397592", "bodyText": "Okay, ich habs jetzt doch anders gemacht damit man mehr m\u00f6glichkeiten zum hinzuf\u00fcgen hat", "author": "thoniTUB", "createdAt": "2020-10-06T15:35:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjcwNzg2MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjcxMDY1Nw==", "url": "https://github.com/bakdata/conquery/pull/1333#discussion_r496710657", "bodyText": "Ich hab gerade mal geschaut, die Store::close Methode wird nirgends implementiert :D", "author": "awildturtok", "createdAt": "2020-09-29T13:21:05Z", "path": "backend/src/main/java/com/bakdata/conquery/io/xodus/ConqueryStorageImpl.java", "diffHunk": "@@ -14,63 +13,84 @@\n import com.bakdata.conquery.util.functions.Collector;\n import com.codahale.metrics.Timer;\n import com.google.common.base.Stopwatch;\n+import com.google.common.collect.Multimap;\n+import com.google.common.collect.MultimapBuilder;\n import jetbrains.exodus.env.Environment;\n-import jetbrains.exodus.env.Environments;\n import lombok.Getter;\n import lombok.extern.slf4j.Slf4j;\n \n+/**\n+ * Base class of persistent storages to uniformly handle load of data and closing of storages.\n+ */\n @Getter @Slf4j\n public abstract class ConqueryStorageImpl implements ConqueryStorage {\n \n-\tprotected final File directory;\n \tprotected final Validator validator;\n-\tprotected final Environment environment;\n \tprotected final StorageConfig config;\n \t@Getter\n \tprotected final CentralRegistry centralRegistry = new CentralRegistry();\n \tprivate final List<KeyIncludingStore<?,?>> stores = new ArrayList<>();\n+\t\n+\tprivate final Multimap<Environment, KeyIncludingStore<?,?>> environmentToStores = MultimapBuilder.linkedHashKeys().arrayListValues().build();\n \n-\tpublic ConqueryStorageImpl(Validator validator, StorageConfig config, File directory) {\n-\t\tthis.directory = directory;\n+\tpublic ConqueryStorageImpl(Validator validator, StorageConfig config) {\n \t\tthis.validator = validator;\n-\t\tthis.environment = Environments.newInstance(directory, config.getXodus().createConfig());\n \t\tthis.config = config;\n \t}\n \n-\tprotected void createStores(Collector<KeyIncludingStore<?,?>> collector) {\n-\t}\n+\t/**\n+\t * Stores can contain of multiple environments, whose themselves can consist of multiple stores.\n+\t * This method collects this information as a mapping that is used to load and later close the stores.\n+\t * The environments should be collected in the order the stores should be loaded.\n+\t */\n+\tabstract protected void createStores(Collector<Environment,KeyIncludingStore<?,?>> collector);\n \n \t/**\n \t * Load all stores from disk.\n \t */\n \t@Override\n \tpublic void loadData() {\n-\t\tcreateStores(stores::add);\n-\t\tlog.info(\"Loading storage {} from {}\", this.getClass().getSimpleName(), directory);\n-\n-\t\ttry (final Timer.Context timer = JobMetrics.getStoreLoadingTimer()) {\n-\t\t\tStopwatch all = Stopwatch.createStarted();\n-\t\t\tfor (KeyIncludingStore<?, ?> store : stores) {\n-\t\t\t\tstore.loadData();\n+\t\tcreateStores(environmentToStores::put);\n+\t\tfor(Environment environment : environmentToStores.keySet()) {\n+\t\t\tlog.info(\"Loading storage {} from {}\", this.getClass().getSimpleName(), environment.getLocation());\n+\t\t\t\n+\t\t\ttry (final Timer.Context timer = JobMetrics.getStoreLoadingTimer()) {\n+\t\t\t\tStopwatch all = Stopwatch.createStarted();\n+\t\t\t\tfor (KeyIncludingStore<?, ?> store : environmentToStores.get(environment)) {\n+\t\t\t\t\tstore.loadData();\n+\t\t\t\t}\n+\t\t\t\tlog.info(\"Loading of environment {} completed within {}\", environment.getLocation(), all.stop());\n \t\t\t}\n-\t\t\tlog.info(\"Loaded complete {} storage within {}\", this.getClass().getSimpleName(), all.stop());\n \t\t}\n-\n \t}\n+\t\n \n \t@Override\n \tpublic void close() throws IOException {\n-\t\tfor(KeyIncludingStore<?, ?> store : stores) {\n-\t\t\tstore.close();\n+\t\tfor(Environment environment : environmentToStores.keySet()) {\n+\t\t\tlog.info(\"Closing stores of environment {}\", environment.getLocation());\n+\t\t\tfor (KeyIncludingStore<?, ?> store : environmentToStores.get(environment)) {\n+\t\t\t\tlog.info(\"Closing store {}\", store.toString());\n+\t\t\t\tstore.close();", "originalCommit": "1c1044b6553af2a4f2b5acc5a300e5af064c0f37", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODg2OTIyNg==", "url": "https://github.com/bakdata/conquery/pull/1333#discussion_r498869226", "bodyText": "Habe sie entfernt", "author": "thoniTUB", "createdAt": "2020-10-02T14:48:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjcxMDY1Nw=="}], "type": "inlineReview"}, {"oid": "4bf99dc4a96b208e5f03a4297290daec2f7564ad", "url": "https://github.com/bakdata/conquery/commit/4bf99dc4a96b208e5f03a4297290daec2f7564ad", "message": "remove meta store and cleanup", "committedDate": "2020-10-06T14:54:46Z", "type": "commit"}, {"oid": "ba89cad8bd7e141d785125e86a0a806314202879", "url": "https://github.com/bakdata/conquery/commit/ba89cad8bd7e141d785125e86a0a806314202879", "message": "improve log message", "committedDate": "2020-10-06T14:54:47Z", "type": "commit"}, {"oid": "80082ea7762ee251d4f1e80d49347f59065a6494", "url": "https://github.com/bakdata/conquery/commit/80082ea7762ee251d4f1e80d49347f59065a6494", "message": "remove unused close method", "committedDate": "2020-10-06T14:54:47Z", "type": "commit"}, {"oid": "80082ea7762ee251d4f1e80d49347f59065a6494", "url": "https://github.com/bakdata/conquery/commit/80082ea7762ee251d4f1e80d49347f59065a6494", "message": "remove unused close method", "committedDate": "2020-10-06T14:54:47Z", "type": "forcePushed"}, {"oid": "d309716e97680f51335b6fa2a28297466e91f9a3", "url": "https://github.com/bakdata/conquery/commit/d309716e97680f51335b6fa2a28297466e91f9a3", "message": "adds missing import", "committedDate": "2020-10-06T14:56:13Z", "type": "commit"}, {"oid": "1ae3470d3ed7804bb433fff942b2971e371a34b2", "url": "https://github.com/bakdata/conquery/commit/1ae3470d3ed7804bb433fff942b2971e371a34b2", "message": "fixes tests for storages, which are not auto closable anymore", "committedDate": "2020-10-06T15:34:52Z", "type": "commit"}, {"oid": "3242a9ab9e959fa6f356fc83f627c4b579d09330", "url": "https://github.com/bakdata/conquery/commit/3242a9ab9e959fa6f356fc83f627c4b579d09330", "message": "pass multimap directly to the stores", "committedDate": "2020-10-06T15:35:16Z", "type": "commit"}]}