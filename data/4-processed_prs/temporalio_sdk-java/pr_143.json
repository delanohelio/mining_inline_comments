{"pr_number": 143, "pr_title": "Activity interceptor", "pr_createdAt": "2020-07-06T21:54:58Z", "pr_url": "https://github.com/temporalio/sdk-java/pull/143", "timeline": [{"oid": "1edeace541781ac226f49f5aa01cc6397c21ae4d", "url": "https://github.com/temporalio/sdk-java/commit/1edeace541781ac226f49f5aa01cc6397c21ae4d", "message": "cleanup", "committedDate": "2020-06-29T03:40:16Z", "type": "commit"}, {"oid": "747e91c4f4deb30bedc5af1001db2b0644f718c0", "url": "https://github.com/temporalio/sdk-java/commit/747e91c4f4deb30bedc5af1001db2b0644f718c0", "message": "Refactored ExecuteActivityParameters", "committedDate": "2020-06-29T04:05:49Z", "type": "commit"}, {"oid": "dc5649d86c7529e456061c05567573fde273e2bd", "url": "https://github.com/temporalio/sdk-java/commit/dc5649d86c7529e456061c05567573fde273e2bd", "message": "Refactored ExecuteChildWorkflowParameters", "committedDate": "2020-06-30T01:34:57Z", "type": "commit"}, {"oid": "2722ddae75ec1129e8262456d7e55ed59c4c672d", "url": "https://github.com/temporalio/sdk-java/commit/2722ddae75ec1129e8262456d7e55ed59c4c672d", "message": "Refactored ContinueAsNewWorkflowExecutionParameters", "committedDate": "2020-06-30T16:09:06Z", "type": "commit"}, {"oid": "be7dc29289a3e6814c41a0e9a3c5fd394cb32930", "url": "https://github.com/temporalio/sdk-java/commit/be7dc29289a3e6814c41a0e9a3c5fd394cb32930", "message": "Refactored QueryWorkflowParameters", "committedDate": "2020-06-30T16:35:50Z", "type": "commit"}, {"oid": "4c8d88b1503d0fb01249c5533901954113429c8c", "url": "https://github.com/temporalio/sdk-java/commit/4c8d88b1503d0fb01249c5533901954113429c8c", "message": "Refactored TerminateWorkflowExecutionParameters. Added WorkflowStub.terminate", "committedDate": "2020-06-30T21:40:11Z", "type": "commit"}, {"oid": "bd13c1f2a569e8497d540c1754acee7e7ee90fd3", "url": "https://github.com/temporalio/sdk-java/commit/bd13c1f2a569e8497d540c1754acee7e7ee90fd3", "message": "Refactored StartChildWorkflowExecutionParameters", "committedDate": "2020-06-30T23:50:59Z", "type": "commit"}, {"oid": "665b53fdb5939f5c358fe30557f7b87f69638bd0", "url": "https://github.com/temporalio/sdk-java/commit/665b53fdb5939f5c358fe30557f7b87f69638bd0", "message": "refactored SignalWithStartWorkflowExecutionParameters & StartWorkflowExecutionParameters", "committedDate": "2020-07-01T03:35:43Z", "type": "commit"}, {"oid": "71a8718c1ff742b22cbc60076084323312a40a0a", "url": "https://github.com/temporalio/sdk-java/commit/71a8718c1ff742b22cbc60076084323312a40a0a", "message": "SignalExternalWorkflowParameters", "committedDate": "2020-07-01T04:01:29Z", "type": "commit"}, {"oid": "68b9ae9761863a9c7c6ff98c86247cce8859b0a7", "url": "https://github.com/temporalio/sdk-java/commit/68b9ae9761863a9c7c6ff98c86247cce8859b0a7", "message": "removed RetryParameters", "committedDate": "2020-07-01T04:02:45Z", "type": "commit"}, {"oid": "461510a60dd0cc6cca6afb0dab06b48c954817f1", "url": "https://github.com/temporalio/sdk-java/commit/461510a60dd0cc6cca6afb0dab06b48c954817f1", "message": "RemovedSignalExternalWorkflowParameters", "committedDate": "2020-07-01T04:07:20Z", "type": "commit"}, {"oid": "ff12203e12b6a43d7f5c592843e7c024dba75a4b", "url": "https://github.com/temporalio/sdk-java/commit/ff12203e12b6a43d7f5c592843e7c024dba75a4b", "message": "Switched from Builder to attributes", "committedDate": "2020-07-01T04:32:45Z", "type": "commit"}, {"oid": "0b71abee100be4aebe2d58bee5d4665387286632", "url": "https://github.com/temporalio/sdk-java/commit/0b71abee100be4aebe2d58bee5d4665387286632", "message": "From builder to request", "committedDate": "2020-07-01T05:02:18Z", "type": "commit"}, {"oid": "ca776f9ceb4ccd1c92d46ae5cc53097def0255d5", "url": "https://github.com/temporalio/sdk-java/commit/ca776f9ceb4ccd1c92d46ae5cc53097def0255d5", "message": "Removed Terminate & Cancel parameters", "committedDate": "2020-07-01T22:19:05Z", "type": "commit"}, {"oid": "7b150f5bc599325dcc1fb8d2af2cccb875376d6a", "url": "https://github.com/temporalio/sdk-java/commit/7b150f5bc599325dcc1fb8d2af2cccb875376d6a", "message": "Deleted ContinueAsNewWorkflowExecutionParameters and QueryWorkflowParameters", "committedDate": "2020-07-01T22:29:37Z", "type": "commit"}, {"oid": "ddb41068db9b4ecceab17bfb212a302ddb9d289a", "url": "https://github.com/temporalio/sdk-java/commit/ddb41068db9b4ecceab17bfb212a302ddb9d289a", "message": "Removed StartWorkflowExecutionParameters", "committedDate": "2020-07-01T22:37:52Z", "type": "commit"}, {"oid": "3078285d662639921eb425a663aceb5fc6cab4ef", "url": "https://github.com/temporalio/sdk-java/commit/3078285d662639921eb425a663aceb5fc6cab4ef", "message": "Merge branch 'master' of github.com:temporalio/temporal-java-sdk into parameters-refactoring", "committedDate": "2020-07-03T16:36:07Z", "type": "commit"}, {"oid": "32abd66f604e765adc5c9993b20ac796699e3e37", "url": "https://github.com/temporalio/sdk-java/commit/32abd66f604e765adc5c9993b20ac796699e3e37", "message": "Updated default RPC timeout to 10 seconds", "committedDate": "2020-07-03T16:54:14Z", "type": "commit"}, {"oid": "8c2628d2542f7a7eedcc465b144255ae6bfad529", "url": "https://github.com/temporalio/sdk-java/commit/8c2628d2542f7a7eedcc465b144255ae6bfad529", "message": "Updated dependcy versions", "committedDate": "2020-07-03T16:54:37Z", "type": "commit"}, {"oid": "ec481797f5868a9dbf205e2448daa800713fa74f", "url": "https://github.com/temporalio/sdk-java/commit/ec481797f5868a9dbf205e2448daa800713fa74f", "message": "Removed unused variable", "committedDate": "2020-07-03T16:55:02Z", "type": "commit"}, {"oid": "8a9695e808679bb8eb9a72988f57e94a2cc150d6", "url": "https://github.com/temporalio/sdk-java/commit/8a9695e808679bb8eb9a72988f57e94a2cc150d6", "message": "Updated gradle to 6.5.1", "committedDate": "2020-07-03T17:10:00Z", "type": "commit"}, {"oid": "8d2571a4c94dc6f7e2ef424e94aba26b96f92afd", "url": "https://github.com/temporalio/sdk-java/commit/8d2571a4c94dc6f7e2ef424e94aba26b96f92afd", "message": "checkUpdates plugin added", "committedDate": "2020-07-03T17:29:13Z", "type": "commit"}, {"oid": "43a2c79cb8eac4ee3e85e8de848e9e37f64b6baf", "url": "https://github.com/temporalio/sdk-java/commit/43a2c79cb8eac4ee3e85e8de848e9e37f64b6baf", "message": "Build will print list of failed tests", "committedDate": "2020-07-03T19:13:07Z", "type": "commit"}, {"oid": "ce5a7578a6aab0810200c9665ffd152b24fe1eec", "url": "https://github.com/temporalio/sdk-java/commit/ce5a7578a6aab0810200c9665ffd152b24fe1eec", "message": "Allowed multiple calls to registerWorkflowImplementationTypes", "committedDate": "2020-07-03T19:13:40Z", "type": "commit"}, {"oid": "6af33c9997cfccad6e802251106b0d3118720839", "url": "https://github.com/temporalio/sdk-java/commit/6af33c9997cfccad6e802251106b0d3118720839", "message": "ActivityInterceptor added", "committedDate": "2020-07-03T20:30:19Z", "type": "commit"}, {"oid": "100761aed130b31f78fab8e03ca2d6658b7dcdc5", "url": "https://github.com/temporalio/sdk-java/commit/100761aed130b31f78fab8e03ca2d6658b7dcdc5", "message": "Added ActivityInterceptor", "committedDate": "2020-07-06T20:28:17Z", "type": "commit"}, {"oid": "2c9863fd9030894bc286061c5740ec107cd4ca37", "url": "https://github.com/temporalio/sdk-java/commit/2c9863fd9030894bc286061c5740ec107cd4ca37", "message": "Merge branch 'master' of github.com:temporalio/temporal-java-sdk into activity-interceptor", "committedDate": "2020-07-06T20:28:27Z", "type": "commit"}, {"oid": "3d97f0e5a1cae736219339f5efa2a1d855e69075", "url": "https://github.com/temporalio/sdk-java/commit/3d97f0e5a1cae736219339f5efa2a1d855e69075", "message": "Added ActivityInterceptor test", "committedDate": "2020-07-06T21:54:34Z", "type": "commit"}, {"oid": "3337462e8cff25dd02adab143f3936e3386e0e28", "url": "https://github.com/temporalio/sdk-java/commit/3337462e8cff25dd02adab143f3936e3386e0e28", "message": "Added metricScope to local activity context", "committedDate": "2020-07-06T22:25:59Z", "type": "commit"}, {"oid": "52b7eaea633c57a2e4e7b954f927cb6d006cef48", "url": "https://github.com/temporalio/sdk-java/commit/52b7eaea633c57a2e4e7b954f927cb6d006cef48", "message": "Fixed interception of a local activity", "committedDate": "2020-07-07T00:29:04Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDYxNDEzNw==", "url": "https://github.com/temporalio/sdk-java/pull/143#discussion_r450614137", "bodyText": "Minor nit - Looks like stack trace in this test JSON may be out of sync after this change:\nhttps://github.com/temporalio/temporal-java-sdk/blob/master/src/test/resources/testAsyncActivityRetryHistory.json#L122", "author": "shawnhathaway", "createdAt": "2020-07-07T05:10:31Z", "path": "src/main/java/io/temporal/internal/sync/POJOActivityTaskHandler.java", "diffHunk": "@@ -234,29 +277,30 @@ public Result handle(\n \n     @Override\n     public ActivityTaskHandler.Result execute(ActivityInfoImpl info, Scope metricsScope) {\n-      ActivityExecutionContext context = new LocalActivityExecutionContextImpl(info);\n-      CurrentActivityExecutionContext.set(context);\n+      ActivityExecutionContext context = new LocalActivityExecutionContextImpl(info, metricsScope);\n       Optional<Payloads> input = info.getInput();\n+      ActivityInboundCallsInterceptor inboundCallsInterceptor =\n+          new POJOActivityInboundCallsInterceptor(activity, method);\n+      for (ActivityInterceptor interceptor : interceptors) {\n+        inboundCallsInterceptor = interceptor.interceptActivity(inboundCallsInterceptor);\n+      }\n+      inboundCallsInterceptor.init(context);\n       try {\n         Object[] args =\n             dataConverter.arrayFromPayloads(\n                 input, method.getParameterTypes(), method.getGenericParameterTypes());\n-        Object result = method.invoke(activity, args);\n+        Object result = inboundCallsInterceptor.execute(args);", "originalCommit": "52b7eaea633c57a2e4e7b954f927cb6d006cef48", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "b4d4c60909d276027e5db3355946464fc305d456", "url": "https://github.com/temporalio/sdk-java/commit/b4d4c60909d276027e5db3355946464fc305d456", "message": "Regenerated json files as stack traces have changed", "committedDate": "2020-07-07T18:39:56Z", "type": "commit"}]}