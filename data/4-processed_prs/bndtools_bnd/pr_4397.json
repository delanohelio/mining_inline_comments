{"pr_number": 4397, "pr_title": "allow the use of macros in the gpg property", "pr_createdAt": "2020-11-05T12:10:20Z", "pr_url": "https://github.com/bndtools/bnd/pull/4397", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODc1Mjc0OA==", "url": "https://github.com/bndtools/bnd/pull/4397#discussion_r518752748", "bodyText": "So why not remove it instead of passing the buck to the future with a comment? :-)", "author": "bjhargrave", "createdAt": "2020-11-06T13:32:36Z", "path": "biz.aQute.bndlib/src/aQute/bnd/build/ProjectBuilder.java", "diffHunk": "@@ -593,6 +593,7 @@ private boolean isMaster(InfoRepository repo, String bsn, Version v) throws Exce\n \t\treturn descriptor.phase == Phase.MASTER;\n \t}\n \n+\t// TODO: Needs to be removed. We allready have this method", "originalCommit": "18bd0c0fb5ca9b9300fd56c121861886458dd3bf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTU3NTk1Mg==", "url": "https://github.com/bndtools/bnd/pull/4397#discussion_r521575952", "bodyText": "Right you are. I accidentally committed the comment. Fixed it. I hope you don't mind that I did it in this PR.", "author": "juergen-albert", "createdAt": "2020-11-11T19:04:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODc1Mjc0OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODc1MzQ3OA==", "url": "https://github.com/bndtools/bnd/pull/4397#discussion_r518753478", "bodyText": "Why not just use flattened properties? It is big deal to change all these API from getting a Properties object to get a Processor object. I am not sure that is a great idea.\nIf flattened properties do not work, then I would suggest we implement a Properties subclass which wraps a Processor and pass that.", "author": "bjhargrave", "createdAt": "2020-11-06T13:34:01Z", "path": "biz.aQute.repository/src/aQute/bnd/repository/maven/provider/MavenBndRepository.java", "diffHunk": "@@ -194,7 +194,7 @@ public PutResult put(InputStream stream, PutOptions options) throws Exception {\n \t\t\t\t}\n \n \t\t\t\tlogger.debug(\"Put release {}\", pom.getRevision());\n-\t\t\t\ttry (Release releaser = storage.release(pom.getRevision(), options.context.getProperties())) {", "originalCommit": "18bd0c0fb5ca9b9300fd56c121861886458dd3bf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTU3NTMyNA==", "url": "https://github.com/bndtools/bnd/pull/4397#discussion_r521575324", "bodyText": "true that. Much easier solution!", "author": "juergen-albert", "createdAt": "2020-11-11T19:03:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODc1MzQ3OA=="}], "type": "inlineReview"}, {"oid": "fca22f9767b18ba3f8d2cae76d5d6e1edefeaad8", "url": "https://github.com/bndtools/bnd/commit/fca22f9767b18ba3f8d2cae76d5d6e1edefeaad8", "message": "allows use of macros in the gpg property and fixes baseline repo search\n\nSigned-off-by: Juergen Albert <j.albert@data-in-motion.biz>", "committedDate": "2020-11-11T19:01:54Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjEwNjMyMA==", "url": "https://github.com/bndtools/bnd/pull/4397#discussion_r522106320", "bodyText": "I don't think this needs to be public, just not private. So use default (package-private access).", "author": "bjhargrave", "createdAt": "2020-11-12T13:31:05Z", "path": "biz.aQute.bndlib/src/aQute/bnd/build/Project.java", "diffHunk": "@@ -1146,7 +1146,7 @@ private URI releaseRepo(RepositoryPlugin releaseRepo, Processor context, String\n \t\t}\n \t}\n \n-\tprivate List<RepositoryPlugin> getReleaseRepos(String names) {\n+\tpublic List<RepositoryPlugin> getReleaseRepos(String names) {", "originalCommit": "fca22f9767b18ba3f8d2cae76d5d6e1edefeaad8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjEwNjY1Nw==", "url": "https://github.com/bndtools/bnd/pull/4397#discussion_r522106657", "bodyText": "Don't need this since we don't make the method public.", "author": "bjhargrave", "createdAt": "2020-11-12T13:31:37Z", "path": "biz.aQute.bndlib/src/aQute/bnd/build/package-info.java", "diffHunk": "@@ -1,6 +1,6 @@\n /**\n  */\n-@Version(\"3.5.0\")\n+@Version(\"3.6.0\")", "originalCommit": "fca22f9767b18ba3f8d2cae76d5d6e1edefeaad8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "4982eb2764491a666d83a2c39f1667742cbef915", "url": "https://github.com/bndtools/bnd/commit/4982eb2764491a666d83a2c39f1667742cbef915", "message": "allows use of macros in the gpg property and fixes baseline repo search\n\nSigned-off-by: Juergen Albert <j.albert@data-in-motion.biz>", "committedDate": "2020-11-13T20:35:00Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzI0NjAwNA==", "url": "https://github.com/bndtools/bnd/pull/4397#discussion_r523246004", "bodyText": "Not protected. Protected is still API. Just default access (package-private).", "author": "bjhargrave", "createdAt": "2020-11-13T21:38:56Z", "path": "biz.aQute.bndlib/src/aQute/bnd/build/Project.java", "diffHunk": "@@ -1146,7 +1146,7 @@ private URI releaseRepo(RepositoryPlugin releaseRepo, Processor context, String\n \t\t}\n \t}\n \n-\tprivate List<RepositoryPlugin> getReleaseRepos(String names) {\n+\tprotected List<RepositoryPlugin> getReleaseRepos(String names) {", "originalCommit": "4982eb2764491a666d83a2c39f1667742cbef915", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "4588d221460e9612fddf3cf575df8449d5ea469a", "url": "https://github.com/bndtools/bnd/commit/4588d221460e9612fddf3cf575df8449d5ea469a", "message": "allows use of macros in the gpg property and fixes baseline repo search\n\nSigned-off-by: Juergen Albert <j.albert@data-in-motion.biz>", "committedDate": "2020-11-16T10:22:14Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDI5MjM2Ng==", "url": "https://github.com/bndtools/bnd/pull/4397#discussion_r524292366", "bodyText": "The error message seems a bit wrong since it mentions writeable repos when no one has even looked for a writeable repo. I also thought we decided not to change behavior and just warn if -releaserepo was not set but still release to the first writeable repo.", "author": "bjhargrave", "createdAt": "2020-11-16T14:08:00Z", "path": "biz.aQute.bndlib/src/aQute/bnd/build/ProjectBuilder.java", "diffHunk": "@@ -594,29 +594,32 @@ private boolean isMaster(InfoRepository repo, String bsn, Version v) throws Exce\n \t}\n \n \tprivate RepositoryPlugin getReleaseRepo() {\n-\t\tString repoName = getProperty(Constants.RELEASEREPO);\n \n-\t\tList<RepositoryPlugin> repos = getPlugins(RepositoryPlugin.class);\n-\t\tfor (RepositoryPlugin r : repos) {\n-\t\t\tif (r.canWrite()) {\n-\t\t\t\tif (repoName == null || r.getName()\n-\t\t\t\t\t.equals(repoName)) {\n-\t\t\t\t\treturn r;\n-\t\t\t\t}\n-\t\t\t}\n-\t\t}\n-\t\tif (repoName == null)\n+\t\tString repoNames = getProperty(Constants.RELEASEREPO);\n+\n+\t\tif (repoNames == null) {\n \t\t\terror(\"Could not find a writable repo for the release repo (-releaserepo is not set)\");", "originalCommit": "4588d221460e9612fddf3cf575df8449d5ea469a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDI5Mjg1MQ==", "url": "https://github.com/bndtools/bnd/pull/4397#discussion_r524292851", "bodyText": "Not empty can also mean 1. So the warning will trigger when there is only one repo in the list.", "author": "bjhargrave", "createdAt": "2020-11-16T14:08:42Z", "path": "biz.aQute.bndlib/src/aQute/bnd/build/ProjectBuilder.java", "diffHunk": "@@ -594,29 +594,32 @@ private boolean isMaster(InfoRepository repo, String bsn, Version v) throws Exce\n \t}\n \n \tprivate RepositoryPlugin getReleaseRepo() {\n-\t\tString repoName = getProperty(Constants.RELEASEREPO);\n \n-\t\tList<RepositoryPlugin> repos = getPlugins(RepositoryPlugin.class);\n-\t\tfor (RepositoryPlugin r : repos) {\n-\t\t\tif (r.canWrite()) {\n-\t\t\t\tif (repoName == null || r.getName()\n-\t\t\t\t\t.equals(repoName)) {\n-\t\t\t\t\treturn r;\n-\t\t\t\t}\n-\t\t\t}\n-\t\t}\n-\t\tif (repoName == null)\n+\t\tString repoNames = getProperty(Constants.RELEASEREPO);\n+\n+\t\tif (repoNames == null) {\n \t\t\terror(\"Could not find a writable repo for the release repo (-releaserepo is not set)\");\n-\t\telse\n-\t\t\terror(\"No such -releaserepo %s found\", repoName);\n+\t\t\treturn null;\n+\t\t}\n+\n+\t\tList<RepositoryPlugin> releaseRepos = project.getReleaseRepos(repoNames);\n \n+\t\tif (!releaseRepos.isEmpty()) {\n+\t\t\twarning(\"Found multiple release repositories [%s], so we will use the first one\", repoNames);", "originalCommit": "4588d221460e9612fddf3cf575df8449d5ea469a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDI5NDIwOA==", "url": "https://github.com/bndtools/bnd/pull/4397#discussion_r524294208", "bodyText": "The message should be something like \"no repo found to release into\" since we still allow the old behavior of releasing into a writeable rep.", "author": "bjhargrave", "createdAt": "2020-11-16T14:10:38Z", "path": "biz.aQute.bndlib/src/aQute/bnd/build/ProjectBuilder.java", "diffHunk": "@@ -594,29 +594,32 @@ private boolean isMaster(InfoRepository repo, String bsn, Version v) throws Exce\n \t}\n \n \tprivate RepositoryPlugin getReleaseRepo() {\n-\t\tString repoName = getProperty(Constants.RELEASEREPO);\n \n-\t\tList<RepositoryPlugin> repos = getPlugins(RepositoryPlugin.class);\n-\t\tfor (RepositoryPlugin r : repos) {\n-\t\t\tif (r.canWrite()) {\n-\t\t\t\tif (repoName == null || r.getName()\n-\t\t\t\t\t.equals(repoName)) {\n-\t\t\t\t\treturn r;\n-\t\t\t\t}\n-\t\t\t}\n-\t\t}\n-\t\tif (repoName == null)\n+\t\tString repoNames = getProperty(Constants.RELEASEREPO);\n+\n+\t\tif (repoNames == null) {\n \t\t\terror(\"Could not find a writable repo for the release repo (-releaserepo is not set)\");\n-\t\telse\n-\t\t\terror(\"No such -releaserepo %s found\", repoName);\n+\t\t\treturn null;\n+\t\t}\n+\n+\t\tList<RepositoryPlugin> releaseRepos = project.getReleaseRepos(repoNames);\n \n+\t\tif (!releaseRepos.isEmpty()) {\n+\t\t\twarning(\"Found multiple release repositories [%s], so we will use the first one\", repoNames);\n+\t\t\treturn releaseRepos.get(0);\n+\t\t}\n+\n+\t\terror(\"No such -releaserepo %s found\", repoNames);", "originalCommit": "4588d221460e9612fddf3cf575df8449d5ea469a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDI5NTk0NA==", "url": "https://github.com/bndtools/bnd/pull/4397#discussion_r524295944", "bodyText": "For these messages, we should use proper grammar. So we should capitalize \"Baselining\".", "author": "bjhargrave", "createdAt": "2020-11-16T14:13:14Z", "path": "biz.aQute.bndlib/src/aQute/bnd/build/ProjectBuilder.java", "diffHunk": "@@ -594,29 +594,32 @@ private boolean isMaster(InfoRepository repo, String bsn, Version v) throws Exce\n \t}\n \n \tprivate RepositoryPlugin getReleaseRepo() {\n-\t\tString repoName = getProperty(Constants.RELEASEREPO);\n \n-\t\tList<RepositoryPlugin> repos = getPlugins(RepositoryPlugin.class);\n-\t\tfor (RepositoryPlugin r : repos) {\n-\t\t\tif (r.canWrite()) {\n-\t\t\t\tif (repoName == null || r.getName()\n-\t\t\t\t\t.equals(repoName)) {\n-\t\t\t\t\treturn r;\n-\t\t\t\t}\n-\t\t\t}\n-\t\t}\n-\t\tif (repoName == null)\n+\t\tString repoNames = getProperty(Constants.RELEASEREPO);\n+\n+\t\tif (repoNames == null) {\n \t\t\terror(\"Could not find a writable repo for the release repo (-releaserepo is not set)\");\n-\t\telse\n-\t\t\terror(\"No such -releaserepo %s found\", repoName);\n+\t\t\treturn null;\n+\t\t}\n+\n+\t\tList<RepositoryPlugin> releaseRepos = project.getReleaseRepos(repoNames);\n \n+\t\tif (!releaseRepos.isEmpty()) {\n+\t\t\twarning(\"Found multiple release repositories [%s], so we will use the first one\", repoNames);\n+\t\t\treturn releaseRepos.get(0);\n+\t\t}\n+\n+\t\terror(\"No such -releaserepo %s found\", repoNames);\n \t\treturn null;\n \t}\n \n \tprivate RepositoryPlugin getBaselineRepo() {\n \t\tString repoName = getProperty(Constants.BASELINEREPO);\n-\t\tif (repoName == null)\n+\t\tif (repoName == null) {\n+\t\t\twarning(\"baselining is active, but no %s is set. Will fall back to release repositories\",", "originalCommit": "4588d221460e9612fddf3cf575df8449d5ea469a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDI5Njc0MA==", "url": "https://github.com/bndtools/bnd/pull/4397#discussion_r524296740", "bodyText": "I think this change should be in a separate commit from the other changes to repo finding since they are totally unrelated. This enable proper cherry-picking if we want.", "author": "bjhargrave", "createdAt": "2020-11-16T14:14:23Z", "path": "biz.aQute.repository/src/aQute/bnd/repository/maven/provider/MavenBndRepository.java", "diffHunk": "@@ -194,7 +194,7 @@ public PutResult put(InputStream stream, PutOptions options) throws Exception {\n \t\t\t\t}\n \n \t\t\t\tlogger.debug(\"Put release {}\", pom.getRevision());\n-\t\t\t\ttry (Release releaser = storage.release(pom.getRevision(), options.context.getProperties())) {\n+\t\t\t\ttry (Release releaser = storage.release(pom.getRevision(), options.context.getFlattenedProperties())) {", "originalCommit": "4588d221460e9612fddf3cf575df8449d5ea469a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "7d7ad78c9e436626fc1ac96241fe4148f91c4f00", "url": "https://github.com/bndtools/bnd/commit/7d7ad78c9e436626fc1ac96241fe4148f91c4f00", "message": "allows use of macros in the gpg property\n\nSigned-off-by: Juergen Albert <j.albert@data-in-motion.biz>", "committedDate": "2020-12-09T15:27:50Z", "type": "commit"}, {"oid": "7d7ad78c9e436626fc1ac96241fe4148f91c4f00", "url": "https://github.com/bndtools/bnd/commit/7d7ad78c9e436626fc1ac96241fe4148f91c4f00", "message": "allows use of macros in the gpg property\n\nSigned-off-by: Juergen Albert <j.albert@data-in-motion.biz>", "committedDate": "2020-12-09T15:27:50Z", "type": "forcePushed"}]}