{"pr_number": 2250, "pr_title": "fix #1995 Let exception handler deal with errors in Mono.subscribe", "pr_createdAt": "2020-07-06T12:28:33Z", "pr_url": "https://github.com/reactor/reactor-core/pull/2250", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDMyMDI3Nw==", "url": "https://github.com/reactor/reactor-core/pull/2250#discussion_r450320277", "bodyText": "this looks pretty much aligned with what is done in LambdaSubscriber#onNext, taking into account the fact that for Mono it already cancels the subscription (and calls completeConsumer on top of that). that said, maybe the only thing missing vs the flux version is Exceptions.throwIfFatal(t)", "author": "simonbasle", "createdAt": "2020-07-06T15:56:11Z", "path": "reactor-core/src/main/java/reactor/core/publisher/LambdaMonoSubscriber.java", "diffHunk": "@@ -171,8 +171,7 @@ public final void onNext(T x) {\n \t\t\t\tconsumer.accept(x);\n \t\t\t}\n \t\t\tcatch (Throwable t) {\n-\t\t\t\tOperators.onErrorDropped(t, this.initialContext);\n-\t\t\t\treturn;\n+\t\t\t\tdoError(t);", "originalCommit": "55ceb8be8e0928f87707030a541a1d160d100f0e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDMyMDk4Mw==", "url": "https://github.com/reactor/reactor-core/pull/2250#discussion_r450320983", "bodyText": "I would keep at least one additional test where the errorHolder::set is omitted, to demonstrate that if there is no error consumer, the exception in nextConsumer bubbles up wrapped in an ErrorCallbackNotImplemented exception.", "author": "simonbasle", "createdAt": "2020-07-06T15:57:22Z", "path": "reactor-core/src/test/java/reactor/core/publisher/LambdaMonoSubscriberTest.java", "diffHunk": "@@ -153,7 +153,7 @@ public void noSubscriptionConsumerTriggersRequestOfMax() {\n \t}\n \n \t@Test\n-\tpublic void onNextConsumerExceptionBubblesUpDoesntTriggerCancellation() {\n+\tpublic void onNextConsumerExceptionHandledByErrorHandler() {", "originalCommit": "55ceb8be8e0928f87707030a541a1d160d100f0e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "e10069acf08aaedf7a16537a60f8e463db522579", "url": "https://github.com/reactor/reactor-core/commit/e10069acf08aaedf7a16537a60f8e463db522579", "message": "code review", "committedDate": "2020-07-07T15:36:57Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTQwMjUzMg==", "url": "https://github.com/reactor/reactor-core/pull/2250#discussion_r451402532", "bodyText": "the errorHolder is unused in this test", "author": "simonbasle", "createdAt": "2020-07-08T09:18:08Z", "path": "reactor-core/src/test/java/reactor/core/publisher/LambdaMonoSubscriberTest.java", "diffHunk": "@@ -165,18 +165,38 @@ public void onNextConsumerExceptionBubblesUpDoesntTriggerCancellation() {\n \t\tTestSubscription testSubscription = new TestSubscription();\n \t\ttested.onSubscribe(testSubscription);\n \n-\t\t//as Mono is single-value, it cancels early on onNext. this leads to an exception\n-\t\t//during onNext to be bubbled up as a BubbledException, not propagated through onNext\n+\t\t//the error is expected to be propagated through doError\n+\t\ttested.onNext(\"foo\");\n+\n+\t\tassertThat(errorHolder.get()).as(\"onError\").isInstanceOf(IllegalArgumentException.class);\n+\t\tassertThat(testSubscription.isCancelled).as(\"subscription isCancelled\").isTrue();\n+\t}\n+\n+\n+\t@Test\n+\tpublic void onNextConsumerBubblesUpErrorCallbackNotImplemented() {\n+\t\tAtomicReference<Throwable> errorHolder = new AtomicReference<>(null);", "originalCommit": "b636b35edd573ef059b2500b80a3da87b6f51ebd", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTQwMjU3NQ==", "url": "https://github.com/reactor/reactor-core/pull/2250#discussion_r451402575", "bodyText": "mmh UnsupportedOperatorException ?? \ud83e\udd14", "author": "simonbasle", "createdAt": "2020-07-08T09:18:13Z", "path": "reactor-core/src/test/java/reactor/core/publisher/LambdaMonoSubscriberTest.java", "diffHunk": "@@ -165,18 +165,38 @@ public void onNextConsumerExceptionBubblesUpDoesntTriggerCancellation() {\n \t\tTestSubscription testSubscription = new TestSubscription();\n \t\ttested.onSubscribe(testSubscription);\n \n-\t\t//as Mono is single-value, it cancels early on onNext. this leads to an exception\n-\t\t//during onNext to be bubbled up as a BubbledException, not propagated through onNext\n+\t\t//the error is expected to be propagated through doError\n+\t\ttested.onNext(\"foo\");\n+\n+\t\tassertThat(errorHolder.get()).as(\"onError\").isInstanceOf(IllegalArgumentException.class);\n+\t\tassertThat(testSubscription.isCancelled).as(\"subscription isCancelled\").isTrue();\n+\t}\n+\n+\n+\t@Test\n+\tpublic void onNextConsumerBubblesUpErrorCallbackNotImplemented() {\n+\t\tAtomicReference<Throwable> errorHolder = new AtomicReference<>(null);\n+\n+\t\tLambdaMonoSubscriber<String> tested = new LambdaMonoSubscriber<>(\n+\t\t\t\tvalue -> { throw new IllegalArgumentException(); },\n+\t\t\t\tnull,\n+\t\t\t\t() -> {},\n+\t\t\t\tnull);\n+\n+\t\tTestSubscription testSubscription = new TestSubscription();\n+\t\ttested.onSubscribe(testSubscription);\n+\n+\t\t//the error is expected to be thrown as there is no error handler\n \t\ttry {\n \t\t\ttested.onNext(\"foo\");\n-\t\t\tfail(\"Expected a bubbling Exception\");\n-\t\t} catch (RuntimeException e) {\n-\t\t\tassertThat(e).matches(Exceptions::isBubbling, \"Expected a bubbling Exception\")\n-\t\t\t             .hasCauseInstanceOf(IllegalArgumentException.class);\n+\t\t\tfail(\"Expected IllegalArgumentException to be thrown\");\n+\t\t}\n+\t\tcatch (UnsupportedOperationException e) {", "originalCommit": "b636b35edd573ef059b2500b80a3da87b6f51ebd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTQwMzYzNg==", "url": "https://github.com/reactor/reactor-core/pull/2250#discussion_r451403636", "bodyText": "also you could use assertj assertThatIllegalArgumentException().isThrownBy(() -> tested.onNext(\"foo\"))", "author": "simonbasle", "createdAt": "2020-07-08T09:19:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTQwMjU3NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTU3Njg0MA==", "url": "https://github.com/reactor/reactor-core/pull/2250#discussion_r451576840", "bodyText": "eh sorry for the back and forth. now the test fails because obviously no error handler == ErrorCallbackNotImplemented. So the assertion should A) check that the exception satisfies the Exceptions.isErrorCallbackNotImplemented Predicate and B) that its cause is the IllegalArgumentException.\nthe starting point of the assertion should thus be the more generic assertThatExceptionOfType(RuntimeException.class).isThrownBy(() -> ....", "author": "simonbasle", "createdAt": "2020-07-08T14:12:32Z", "path": "reactor-core/src/test/java/reactor/core/publisher/LambdaMonoSubscriberTest.java", "diffHunk": "@@ -165,18 +166,27 @@ public void onNextConsumerExceptionBubblesUpDoesntTriggerCancellation() {\n \t\tTestSubscription testSubscription = new TestSubscription();\n \t\ttested.onSubscribe(testSubscription);\n \n-\t\t//as Mono is single-value, it cancels early on onNext. this leads to an exception\n-\t\t//during onNext to be bubbled up as a BubbledException, not propagated through onNext\n-\t\ttry {\n-\t\t\ttested.onNext(\"foo\");\n-\t\t\tfail(\"Expected a bubbling Exception\");\n-\t\t} catch (RuntimeException e) {\n-\t\t\tassertThat(e).matches(Exceptions::isBubbling, \"Expected a bubbling Exception\")\n-\t\t\t             .hasCauseInstanceOf(IllegalArgumentException.class);\n-\t\t}\n+\t\t//the error is expected to be propagated through doError\n+\t\ttested.onNext(\"foo\");\n \n-\t\tassertThat(errorHolder.get()).as(\"onError\").isNull();\n-\t\tassertThat(testSubscription.isCancelled).as(\"subscription isCancelled\").isFalse();\n+\t\tassertThat(errorHolder.get()).as(\"onError\").isInstanceOf(IllegalArgumentException.class);\n+\t\tassertThat(testSubscription.isCancelled).as(\"subscription isCancelled\").isTrue();\n+\t}\n+\n+\t@Test\n+\tpublic void onNextConsumerBubblesUpErrorCallbackNotImplemented() {\n+\t\tLambdaMonoSubscriber<String> tested = new LambdaMonoSubscriber<>(\n+\t\t\t\tvalue -> { throw new IllegalArgumentException(); },\n+\t\t\t\tnull,\n+\t\t\t\t() -> {},\n+\t\t\t\tnull);\n+\n+\t\tTestSubscription testSubscription = new TestSubscription();\n+\t\ttested.onSubscribe(testSubscription);\n+\n+\t\t//the error is expected to be thrown as there is no error handler\n+\t\tassertThatIllegalArgumentException().isThrownBy(() -> tested.onNext(\"foo\"));", "originalCommit": "cc79cf3f568366836f027547c8cb36faf8dfaffc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTY2NDgzNw==", "url": "https://github.com/reactor/reactor-core/pull/2250#discussion_r451664837", "bodyText": "My bad, I didnt' know how I missed it when re-running the test \ud83d\ude47\u200d\u2640\ufe0f", "author": "aneveu", "createdAt": "2020-07-08T16:15:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTU3Njg0MA=="}], "type": "inlineReview"}, {"oid": "5adce009051422ec4c9bea3f4d666687030afcf7", "url": "https://github.com/reactor/reactor-core/commit/5adce009051422ec4c9bea3f4d666687030afcf7", "message": "Let exception handler deal with errors in Mono.subscribe (#1995)", "committedDate": "2020-07-17T14:05:58Z", "type": "commit"}, {"oid": "320360028f2d24cebb8d4850d80bf34d09ab8613", "url": "https://github.com/reactor/reactor-core/commit/320360028f2d24cebb8d4850d80bf34d09ab8613", "message": "code review", "committedDate": "2020-07-17T14:06:02Z", "type": "commit"}, {"oid": "25b818a4e88ad1a975bd912e142101759291ca50", "url": "https://github.com/reactor/reactor-core/commit/25b818a4e88ad1a975bd912e142101759291ca50", "message": "add a third test to complete usecase coverage", "committedDate": "2020-07-17T14:06:03Z", "type": "commit"}, {"oid": "86a88644da623463348f5ca0ea6d622244f07989", "url": "https://github.com/reactor/reactor-core/commit/86a88644da623463348f5ca0ea6d622244f07989", "message": "code review", "committedDate": "2020-07-17T14:06:03Z", "type": "commit"}, {"oid": "57cf6018e32dc1418bc06b503b6b5d81e82decc9", "url": "https://github.com/reactor/reactor-core/commit/57cf6018e32dc1418bc06b503b6b5d81e82decc9", "message": "build fix", "committedDate": "2020-07-17T14:20:05Z", "type": "commit"}, {"oid": "57cf6018e32dc1418bc06b503b6b5d81e82decc9", "url": "https://github.com/reactor/reactor-core/commit/57cf6018e32dc1418bc06b503b6b5d81e82decc9", "message": "build fix", "committedDate": "2020-07-17T14:20:05Z", "type": "forcePushed"}]}