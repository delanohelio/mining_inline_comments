{"pr_number": 1186, "pr_title": "Further filter detected slow broker against pre-defined flush time threshold.", "pr_createdAt": "2020-05-04T18:16:47Z", "pr_url": "https://github.com/linkedin/cruise-control/pull/1186", "timeline": [{"oid": "ea4026694fccc2ae4de3e3289f4180089aa24dc0", "url": "https://github.com/linkedin/cruise-control/commit/ea4026694fccc2ae4de3e3289f4180089aa24dc0", "message": "Further filter detected slow broker against pre-defined flush time threshold.", "committedDate": "2020-05-04T18:16:07Z", "type": "commit"}, {"oid": "e5215e0d98b6189de5b64879d660be8c3553d0c3", "url": "https://github.com/linkedin/cruise-control/commit/e5215e0d98b6189de5b64879d660be8c3553d0c3", "message": "change threshold to 150ms.", "committedDate": "2020-05-04T18:19:37Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTY3ODY5OQ==", "url": "https://github.com/linkedin/cruise-control/pull/1186#discussion_r419678699", "bodyText": "Can we avoid passing private variable _logFlushTimeThresholdMs to non-static function detectMetricAnomaliesFromThreshold and update the name of the function to indicate its custom role regarding log flush time?\nActually it is a little confusing that we have another function in this class called getMetricAnomalies, which is also used for detecting metric anomalies -- can we merge/rename them to make the logic more clear?", "author": "efeg", "createdAt": "2020-05-04T19:35:43Z", "path": "cruise-control/src/main/java/com/linkedin/kafka/cruisecontrol/detector/SlowBrokerFinder.java", "diffHunk": "@@ -174,6 +184,7 @@ public SlowBrokerFinder() {\n     }\n \n     Set<BrokerEntity> detectMetricAnomalies = getMetricAnomalies(historicalLogFlushTimeMetricValues, currentLogFlushTimeMetricValues);\n+    detectMetricAnomalies.retainAll(detectMetricAnomaliesFromThreshold(currentLogFlushTimeMetricValues, _logFlushTimeThresholdMs));", "originalCommit": "e5215e0d98b6189de5b64879d660be8c3553d0c3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTcwMDA3Mw==", "url": "https://github.com/linkedin/cruise-control/pull/1186#discussion_r419700073", "bodyText": "I rename the method to make it more specific.\nI was thinking about merge this part of logic into getMetricAnomalies(). The issue is the logic in getMetricAnomalies() is generic and this extra check is specific to log flush time metrics.", "author": "kidkun", "createdAt": "2020-05-04T20:14:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTY3ODY5OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTY3OTIyMg==", "url": "https://github.com/linkedin/cruise-control/pull/1186#discussion_r419679222", "bodyText": "Nit: detectMetricAnomalies -> detectedMetricAnomalies?", "author": "efeg", "createdAt": "2020-05-04T19:36:36Z", "path": "cruise-control/src/main/java/com/linkedin/kafka/cruisecontrol/detector/SlowBrokerFinder.java", "diffHunk": "@@ -174,6 +184,7 @@ public SlowBrokerFinder() {\n     }\n \n     Set<BrokerEntity> detectMetricAnomalies = getMetricAnomalies(historicalLogFlushTimeMetricValues, currentLogFlushTimeMetricValues);\n+    detectMetricAnomalies.retainAll(detectMetricAnomaliesFromThreshold(currentLogFlushTimeMetricValues, _logFlushTimeThresholdMs));", "originalCommit": "e5215e0d98b6189de5b64879d660be8c3553d0c3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTY4MTkyNw==", "url": "https://github.com/linkedin/cruise-control/pull/1186#discussion_r419681927", "bodyText": "The loop uses only the key, but iterates over entities. Can we either iterate over keySet() or update the logic to use getValue(), as well?", "author": "efeg", "createdAt": "2020-05-04T19:41:18Z", "path": "cruise-control/src/main/java/com/linkedin/kafka/cruisecontrol/detector/SlowBrokerFinder.java", "diffHunk": "@@ -286,6 +297,16 @@ private void detectMetricAnomaliesFromPeers(Map<BrokerEntity, Double> currentVal\n     }\n   }\n \n+  private Set<BrokerEntity> detectMetricAnomaliesFromThreshold(Map<BrokerEntity, Double> currentValue, double threshold) {\n+    Set<BrokerEntity> detectedMetricAnomalies = new HashSet<>();\n+    for (Map.Entry<BrokerEntity, Double> entry : currentValue.entrySet()) {", "originalCommit": "e5215e0d98b6189de5b64879d660be8c3553d0c3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTY4Mjk3Mw==", "url": "https://github.com/linkedin/cruise-control/pull/1186#discussion_r419682973", "bodyText": "This function (i.e. configure) is full of repeated code fragments. Can we use util functions to eliminate code repetition and be more concise?", "author": "efeg", "createdAt": "2020-05-04T19:43:01Z", "path": "cruise-control/src/main/java/com/linkedin/kafka/cruisecontrol/detector/SlowBrokerFinder.java", "diffHunk": "@@ -416,6 +437,21 @@ public void configure(Map<String, ?> configs) {\n       }\n     }\n \n+    String logFlushTimeThresholdMs = (String) originalConfig.get(SLOW_BROKER_LOG_FLUSH_TIME_THRESHOLD_MS_CONFIG);", "originalCommit": "e5215e0d98b6189de5b64879d660be8c3553d0c3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTY4NDAzNQ==", "url": "https://github.com/linkedin/cruise-control/pull/1186#discussion_r419684035", "bodyText": "Nit: Enumerating functions does not give much information about the difference between testNoFalsePositiveDetection() and testNoFalsePositiveDetection2(). Can we rename them with a suffix that describes what each function are?", "author": "efeg", "createdAt": "2020-05-04T19:45:01Z", "path": "cruise-control/src/test/java/com/linkedin/kafka/cruisecontrol/detector/SlowBrokerFinderTest.java", "diffHunk": "@@ -161,6 +161,36 @@ public void testNoFalsePositiveDetection() {\n     assertTrue(anomalies.isEmpty());\n   }\n \n+  /**\n+   * Test slow broker finder does not report false positive anomaly when the broker's absolute log flush time is small.\n+   */\n+  @Test\n+  public void testNoFalsePositiveDetection2() {", "originalCommit": "e5215e0d98b6189de5b64879d660be8c3553d0c3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "eb435d115c1f366301c4d9d1ff56b0e654c96ba0", "url": "https://github.com/linkedin/cruise-control/commit/eb435d115c1f366301c4d9d1ff56b0e654c96ba0", "message": "Address the feedback.", "committedDate": "2020-05-04T21:32:31Z", "type": "commit"}, {"oid": "bacfdfec0e9da87479fcf90628bd89629aeda25a", "url": "https://github.com/linkedin/cruise-control/commit/bacfdfec0e9da87479fcf90628bd89629aeda25a", "message": "Fix build failure.", "committedDate": "2020-05-04T21:36:18Z", "type": "commit"}]}