{"pr_number": 1198, "pr_title": "Environment variable resolution in configs", "pr_createdAt": "2020-05-20T13:41:20Z", "pr_url": "https://github.com/linkedin/cruise-control/pull/1198", "timeline": [{"oid": "a726125da7865e4ee4a77b689ecca9b68c36274e", "url": "https://github.com/linkedin/cruise-control/commit/a726125da7865e4ee4a77b689ecca9b68c36274e", "message": "Environment variable resolution in configs\n\nThis commit enables parsing config values from environment variables.\nThis is particularly useful if passwords can't be hardcoded in the config\nfiles but instead passed to Cruise Control via an environment variable.\nFor instance if there is a MY_PASSWORD=test123 then defining the following\nconfig in cruisecontrol.properties will be resolved on startup to the\nactual password.\n\nConfig file on the disk:              Resolved runtime config:\nconfig.name=${env:MY_ENV_VAR}   ==>   config.name=test123", "committedDate": "2020-05-20T13:29:44Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjY1OTE5NQ==", "url": "https://github.com/linkedin/cruise-control/pull/1198#discussion_r432659195", "bodyText": "These hardcoded config names and the way the user is expected to name their environment variables to pass them to CC is not very clear. Would it help if we (1) refer to the following names rather than hardcoding these configs:\n\nAbstractConfig#CONFIG_PROVIDERS_CONFIG, and\nAbstractConfig#CONFIG_PROVIDERS_PARAM\n\nand (2) provide a brief section in Configurations.md regarding how to name env variables to pass them to CC?", "author": "efeg", "createdAt": "2020-05-29T18:20:25Z", "path": "cruise-control/src/main/java/com/linkedin/kafka/cruisecontrol/KafkaCruiseControlUtils.java", "diffHunk": "@@ -541,4 +547,20 @@ public static void sanityCheckNonExistingGoal(List<String> goals, Map<String, Go\n \n     return balancednessCostByGoal;\n   }\n+\n+  /**\n+   * Reads the configuration file, parses and validates the configs.\n+   * @param propertiesFile is the file containing the Cruise Control configuration.\n+   * @return a parsed {@link KafkaCruiseControlConfig}\n+   * @throws IOException if the configuration file can't be read.\n+   */\n+  public static KafkaCruiseControlConfig readConfig(String propertiesFile) throws IOException {\n+    Properties props = new Properties();\n+    try (InputStream propStream = new FileInputStream(propertiesFile)) {\n+      props.put(\"config.providers\", \"env\");\n+      props.put(\"config.providers.env.class\", EnvConfigProvider.class.getName());", "originalCommit": "a726125da7865e4ee4a77b689ecca9b68c36274e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODg3NjAwNA==", "url": "https://github.com/linkedin/cruise-control/pull/1198#discussion_r438876004", "bodyText": "AbstractConfig#CONFIG_PROVIDERS_PARAM seems to be private but I'll resolve the other points.", "author": "viktorsomogyi", "createdAt": "2020-06-11T15:33:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjY1OTE5NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjY2MTk5MA==", "url": "https://github.com/linkedin/cruise-control/pull/1198#discussion_r432661990", "bodyText": "Should we also mention the properties that enable configs to be provided out of the configuration file?\nIs it intentional to override these hardcoded properties if they were also defined in the configuration file?", "author": "efeg", "createdAt": "2020-05-29T18:25:46Z", "path": "cruise-control/src/main/java/com/linkedin/kafka/cruisecontrol/KafkaCruiseControlUtils.java", "diffHunk": "@@ -541,4 +547,20 @@ public static void sanityCheckNonExistingGoal(List<String> goals, Map<String, Go\n \n     return balancednessCostByGoal;\n   }\n+\n+  /**\n+   * Reads the configuration file, parses and validates the configs.", "originalCommit": "a726125da7865e4ee4a77b689ecca9b68c36274e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODk3MjI2OA==", "url": "https://github.com/linkedin/cruise-control/pull/1198#discussion_r438972268", "bodyText": "1st: acked, will do\n2nd: well, I treat them as defaults here so if people want to do something else than what CC does by default, then they should be free to. What can I improve here?", "author": "viktorsomogyi", "createdAt": "2020-06-11T17:58:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjY2MTk5MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjY2ODcxNw==", "url": "https://github.com/linkedin/cruise-control/pull/1198#discussion_r432668717", "bodyText": "Should we clear() _preConfiguredEnvironmentVariables?", "author": "efeg", "createdAt": "2020-05-29T18:40:00Z", "path": "cruise-control/src/main/java/com/linkedin/kafka/cruisecontrol/config/EnvConfigProvider.java", "diffHunk": "@@ -0,0 +1,59 @@\n+/*\n+ * Copyright 2020 LinkedIn Corp. Licensed under the BSD 2-Clause License (the \"License\"). See License in the project root for license information.\n+ */\n+\n+package com.linkedin.kafka.cruisecontrol.config;\n+\n+import org.apache.kafka.common.config.ConfigData;\n+import org.apache.kafka.common.config.ConfigException;\n+import org.apache.kafka.common.config.provider.ConfigProvider;\n+\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+\n+public class EnvConfigProvider implements ConfigProvider {\n+\n+  private Map<String, String> _preConfiguredEnvironmentVariables;\n+\n+  @Override\n+  public ConfigData get(String path) {\n+    assertNoPath(path);\n+    return new ConfigData(getenv());\n+  }\n+\n+  @Override\n+  public ConfigData get(String path, Set<String> keys) {\n+    assertNoPath(path);\n+    Map<String, String> filtered = new HashMap<>(getenv());\n+    filtered.keySet().retainAll(keys);\n+    return new ConfigData(filtered);\n+  }\n+\n+  @Override\n+  public void close() {\n+    // nop", "originalCommit": "a726125da7865e4ee4a77b689ecca9b68c36274e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODg3Nzk4OA==", "url": "https://github.com/linkedin/cruise-control/pull/1198#discussion_r438877988", "bodyText": "Good point, will do so.", "author": "viktorsomogyi", "createdAt": "2020-06-11T15:35:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjY2ODcxNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjY3MDQxMg==", "url": "https://github.com/linkedin/cruise-control/pull/1198#discussion_r432670412", "bodyText": "Nit: Is it possible to move the hardcoded value to a static variable?", "author": "efeg", "createdAt": "2020-05-29T18:43:27Z", "path": "cruise-control/src/test/java/com/linkedin/kafka/cruisecontrol/config/EnvConfigProviderTest.java", "diffHunk": "@@ -0,0 +1,37 @@\n+/*\n+ * Copyright 2020 LinkedIn Corp. Licensed under the BSD 2-Clause License (the \"License\"). See License in the project root for license information.\n+ */\n+\n+package com.linkedin.kafka.cruisecontrol.config;\n+\n+import com.linkedin.kafka.cruisecontrol.KafkaCruiseControlUtils;\n+import com.linkedin.kafka.cruisecontrol.config.constants.WebServerConfig;\n+import org.apache.kafka.common.config.types.Password;\n+import org.junit.Test;\n+\n+import java.io.IOException;\n+import java.util.Objects;\n+\n+import static org.junit.Assert.assertEquals;\n+\n+public class EnvConfigProviderTest {\n+\n+  public static final String TEST_PASSWORD = \"testPassword123\";\n+  public static final String NOT_SUBSTITUTED_CONFIG = \"${env:SSL_KEY_PASSWORD}\";\n+\n+  @Test\n+  public void testEnvConfigProvider() throws IOException {\n+    KafkaCruiseControlConfig configs = KafkaCruiseControlUtils.readConfig(\n+        Objects.requireNonNull(this.getClass().getClassLoader().getResource(\"envConfigProviderTest.properties\")).getPath());", "originalCommit": "a726125da7865e4ee4a77b689ecca9b68c36274e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "debe6d0c0e94dc6aad9cc0861195a0e8aa4b7c7e", "url": "https://github.com/linkedin/cruise-control/commit/debe6d0c0e94dc6aad9cc0861195a0e8aa4b7c7e", "message": "Fix review comments\n\nChange-Id: I1759b4c0f0a2dba59f59d1aa7838aef2d8205e6d", "committedDate": "2020-06-18T12:56:37Z", "type": "commit"}]}