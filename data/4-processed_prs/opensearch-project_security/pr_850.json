{"pr_number": 850, "pr_title": "Adding requested tenant to the thread context transient info for consumption", "pr_createdAt": "2020-11-20T21:52:31Z", "pr_url": "https://github.com/opensearch-project/security/pull/850", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzk5NTYzMg==", "url": "https://github.com/opensearch-project/security/pull/850#discussion_r527995632", "bodyText": "thanks @akbhatta . Could you pls add an overloaded method instead of changing existing method to main backward compatibility ? something like  getUserRolesTenantString", "author": "skkosuri-amzn", "createdAt": "2020-11-20T22:04:53Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/user/User.java", "diffHunk": "@@ -265,6 +265,9 @@ public final void addOpenDistroSecurityRoles(final Collection<String> securityRo\n     }\n \n     public final String getUserRolesString() {\n-        return name + \"|\" + String.join(\",\", getRoles()) + \"|\" + String.join(\",\", getOpenDistroSecurityRoles());\n+        return name + \"|\"", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzk5NzA3Mg==", "url": "https://github.com/opensearch-project/security/pull/850#discussion_r527997072", "bodyText": "Then I guess, you need to add a new thread_context string also. Probably, its fine then, make sure that you change common_utils also.", "author": "skkosuri-amzn", "createdAt": "2020-11-20T22:08:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzk5NTYzMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzk5NzQ3NA==", "url": "https://github.com/opensearch-project/security/pull/850#discussion_r527997474", "bodyText": "Good point. I thought about it. I am planning to put overloaded methods to common-utils:User.java\nHere, I don't see any usage of this function except while adding to thread context. may be renaming the method to  getUserRolesTenantString would suffice?", "author": "akbhatta", "createdAt": "2020-11-20T22:09:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzk5NTYzMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzk5OTAxMA==", "url": "https://github.com/opensearch-project/security/pull/850#discussion_r527999010", "bodyText": "Yes. I will post a PR for common-utils soon. I like the idea of renaming  getUserRolesString --> getUserRolesTenantString\nOR getUserRolesString --> getThreadContextTransientString. Let me know your preference.", "author": "akbhatta", "createdAt": "2020-11-20T22:13:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzk5NTYzMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzk5OTA0NQ==", "url": "https://github.com/opensearch-project/security/pull/850#discussion_r527999045", "bodyText": "If you overload, you need to add one more transport thread_context string , so leave it like that. And change common-utils. Sounds good.", "author": "skkosuri-amzn", "createdAt": "2020-11-20T22:13:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzk5NTYzMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODAwMDY2OQ==", "url": "https://github.com/opensearch-project/security/pull/850#discussion_r528000669", "bodyText": "will vote for: getUserRolesTenantString", "author": "skkosuri-amzn", "createdAt": "2020-11-20T22:17:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzk5NTYzMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODAwMzc3Ng==", "url": "https://github.com/opensearch-project/security/pull/850#discussion_r528003776", "bodyText": "renamed. keeping \"user_and_roles\" same for compatibility.", "author": "akbhatta", "createdAt": "2020-11-20T22:26:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzk5NTYzMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzcwNjQzMw==", "url": "https://github.com/opensearch-project/security/pull/850#discussion_r533706433", "bodyText": "Agreed in meeting to change it to getUserInfoString, OPENDISTRO_SECURITY_USER_INFO_THREAD_CONTEXT and (OPENDISTRO_SECURITY_CONFIG_PREFIX + \"user_info\") to make name agnostic in the future.", "author": "akbhatta", "createdAt": "2020-12-01T20:39:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzk5NTYzMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjk5NjU3Ng==", "url": "https://github.com/opensearch-project/security/pull/850#discussion_r532996576", "bodyText": "Can requestedTenant be null? Will it be better to skip requestedTenant if it is not set?", "author": "vrozov", "createdAt": "2020-12-01T00:39:38Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/user/User.java", "diffHunk": "@@ -264,7 +264,10 @@ public final void addOpenDistroSecurityRoles(final Collection<String> securityRo\n         return this.openDistroSecurityRoles == null ? Collections.emptySet() : Collections.unmodifiableSet(this.openDistroSecurityRoles);\n     }\n \n-    public final String getUserRolesString() {\n-        return name + \"|\" + String.join(\",\", getRoles()) + \"|\" + String.join(\",\", getOpenDistroSecurityRoles());\n+    public final String getUserRolesTenantString() {\n+        return name + \"|\"\n+                + String.join(\",\", getRoles()) + \"|\"\n+                + String.join(\",\", getOpenDistroSecurityRoles()) + \"|\"\n+                + requestedTenant;", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzAwMDM1OA==", "url": "https://github.com/opensearch-project/security/pull/850#discussion_r533000358", "bodyText": "Yes it can be null and is handled in common-utils. however I like your suggestion and updated to add requestedTenant only if non-null.", "author": "akbhatta", "createdAt": "2020-12-01T00:50:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjk5NjU3Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzAwNDM1NA==", "url": "https://github.com/opensearch-project/security/pull/850#discussion_r533004354", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    final String tenantStringPart;\n          \n          \n            \n                    final ImmutableList.Builder<String> builder = ImmutableList.builder();\n          \n          \n            \n                    builder.add(name, String.join(\",\", getRoles()),  String.join(\",\", getOpenDistroSecurityRoles()));\n          \n          \n            \n                    if (!Strings.isNullOrEmpty(requestedTenant)) {\n          \n          \n            \n                        builder.add(requestedTenant);\n          \n          \n            \n                    }\n          \n          \n            \n                    return String.join(\"|\", builder.build());", "author": "vrozov", "createdAt": "2020-12-01T01:02:17Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/user/User.java", "diffHunk": "@@ -264,7 +264,16 @@ public final void addOpenDistroSecurityRoles(final Collection<String> securityRo\n         return this.openDistroSecurityRoles == null ? Collections.emptySet() : Collections.unmodifiableSet(this.openDistroSecurityRoles);\n     }\n \n-    public final String getUserRolesString() {\n-        return name + \"|\" + String.join(\",\", getRoles()) + \"|\" + String.join(\",\", getOpenDistroSecurityRoles());\n+    public final String getUserRolesTenantString() {\n+        final String tenantStringPart;", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzAwODgwMQ==", "url": "https://github.com/opensearch-project/security/pull/850#discussion_r533008801", "bodyText": "done", "author": "akbhatta", "createdAt": "2020-12-01T01:15:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzAwNDM1NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzAyMzM2OQ==", "url": "https://github.com/opensearch-project/security/pull/850#discussion_r533023369", "bodyText": "why we are not changing this to USER_ROLES_TENANT ?\nI know that it was failing UT but we should be able to fix that? and what backward compatibility you were mentioning in your previous comment?", "author": "hardik-k-shah", "createdAt": "2020-12-01T02:00:42Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/filter/OpenDistroSecurityFilter.java", "diffHunk": "@@ -303,7 +303,7 @@ public int order() {\n             }\n \n             if(threadContext.getTransient(OPENDISTRO_SECURITY_USER_AND_ROLES) == null) {\n-                threadContext.putTransient(OPENDISTRO_SECURITY_USER_AND_ROLES, user.getUserRolesString());\n+                threadContext.putTransient(OPENDISTRO_SECURITY_USER_AND_ROLES, user.getUserRolesTenantString());", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzA2MzUyMg==", "url": "https://github.com/opensearch-project/security/pull/850#discussion_r533063522", "bodyText": "I could not find reference to OPENDISTRO_SECURITY_USER_AND_ROLES but UT was failing so kept the name.\nbackward compatibility was for the value (with and without tenant info is tested with common-utils parsing)", "author": "akbhatta", "createdAt": "2020-12-01T04:20:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzAyMzM2OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzY5MDQ2Ng==", "url": "https://github.com/opensearch-project/security/pull/850#discussion_r533690466", "bodyText": "It will be necessary to rename both the constant and it's key (OPENDISTRO_SECURITY_CONFIG_PREFIX + \"user_and_roles\"). The name of the constant is less important, renaming the key may introduce backward compatibility issue.", "author": "vrozov", "createdAt": "2020-12-01T20:09:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzAyMzM2OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzY5MjUwNw==", "url": "https://github.com/opensearch-project/security/pull/850#discussion_r533692507", "bodyText": "key (PENDISTRO_SECURITY_CONFIG_PREFIX + \"user_and_roles\") cannot be changed as it is being used by Alerting plugin. Changing the name of the constant is causing UT failure.", "author": "akbhatta", "createdAt": "2020-12-01T20:13:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzAyMzM2OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzcyODUzMw==", "url": "https://github.com/opensearch-project/security/pull/850#discussion_r533728533", "bodyText": "Agreed in meeting to change it to getUserInfoString, OPENDISTRO_SECURITY_USER_INFO_THREAD_CONTEXT and (OPENDISTRO_SECURITY_CONFIG_PREFIX + \"user_info\") to make name agnostic in the future.", "author": "akbhatta", "createdAt": "2020-12-01T21:20:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzAyMzM2OQ=="}], "type": "inlineReview"}, {"oid": "77089ce997f7035088a01a07254cb71da9907079", "url": "https://github.com/opensearch-project/security/commit/77089ce997f7035088a01a07254cb71da9907079", "message": "Adding requested tenant to the thread context transient info for consumption\n\nValidated that the common-utils:User.parse() does not break with this change", "committedDate": "2020-12-01T22:02:51Z", "type": "commit"}]}