{"pr_number": 926, "pr_title": "Short circuit privilege evaluation for bulk requests without index resolution", "pr_createdAt": "2020-12-22T22:11:05Z", "pr_url": "https://github.com/opensearch-project/security/pull/926", "timeline": [{"oid": "98f339e89b51d272dfd87a6ce27be9f3528c2e20", "url": "https://github.com/opensearch-project/security/commit/98f339e89b51d272dfd87a6ce27be9f3528c2e20", "message": "Short circuit privilege evaluation for bulk requests without index resolution", "committedDate": "2021-01-13T22:00:38Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MjI4MTkwMQ==", "url": "https://github.com/opensearch-project/security/pull/926#discussion_r562281901", "bodyText": "minor: you can return presponse once outside the if/else block", "author": "debjanibnrj", "createdAt": "2021-01-22T00:15:39Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/privileges/PrivilegesEvaluator.java", "diffHunk": "@@ -220,6 +221,24 @@ public PrivilegesEvaluatorResponse evaluate(final User user, String action0, fin\n             log.debug(\"mapped roles: {}\",mappedRoles.toString());\n         }\n \n+        if (request instanceof BulkRequest && (Strings.isNullOrEmpty(user.getRequestedTenant()))) {\n+            // Shortcut for bulk actions. The details are checked on the lower level of the BulkShardRequests (Action indices:data/write/bulk[s]).\n+            // This shortcut is only possible if the default tenant is selected, as we might need to rewrite the request for non-default tenants.\n+            // No further access check for the default tenant is necessary, as access will be also checked on the TransportShardBulkAction level.\n+\n+            if (!securityRoles.impliesClusterPermissionPermission(action0)) {\n+                presponse.missingPrivileges.add(action0);\n+                presponse.allowed = false;\n+                log.info(\"No {}-level perm match for {} [Action [{}]] [RolesChecked {}]\", \"cluster\", user, action0,\n+                        securityRoles.getRoleNames());\n+                log.info(\"No permissions for {}\", presponse.missingPrivileges);\n+                return presponse;\n+            } else {\n+                presponse.allowed = true;\n+                return presponse;\n+            }", "originalCommit": "98f339e89b51d272dfd87a6ce27be9f3528c2e20", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MjI4MjE5OA==", "url": "https://github.com/opensearch-project/security/pull/926#discussion_r562282198", "bodyText": "why two log.info's instead of one?", "author": "debjanibnrj", "createdAt": "2021-01-22T00:16:28Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/privileges/PrivilegesEvaluator.java", "diffHunk": "@@ -220,6 +221,24 @@ public PrivilegesEvaluatorResponse evaluate(final User user, String action0, fin\n             log.debug(\"mapped roles: {}\",mappedRoles.toString());\n         }\n \n+        if (request instanceof BulkRequest && (Strings.isNullOrEmpty(user.getRequestedTenant()))) {\n+            // Shortcut for bulk actions. The details are checked on the lower level of the BulkShardRequests (Action indices:data/write/bulk[s]).\n+            // This shortcut is only possible if the default tenant is selected, as we might need to rewrite the request for non-default tenants.\n+            // No further access check for the default tenant is necessary, as access will be also checked on the TransportShardBulkAction level.\n+\n+            if (!securityRoles.impliesClusterPermissionPermission(action0)) {\n+                presponse.missingPrivileges.add(action0);\n+                presponse.allowed = false;\n+                log.info(\"No {}-level perm match for {} [Action [{}]] [RolesChecked {}]\", \"cluster\", user, action0,\n+                        securityRoles.getRoleNames());\n+                log.info(\"No permissions for {}\", presponse.missingPrivileges);", "originalCommit": "98f339e89b51d272dfd87a6ce27be9f3528c2e20", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "b9941f43e3e151aeb6ebd8fcfab8e6bf04267ffe", "url": "https://github.com/opensearch-project/security/commit/b9941f43e3e151aeb6ebd8fcfab8e6bf04267ffe", "message": "CR review", "committedDate": "2021-01-22T00:30:18Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MjI5ODg4MA==", "url": "https://github.com/opensearch-project/security/pull/926#discussion_r562298880", "bodyText": "Should \"cluster\" be hardcoded to the log message format string?", "author": "vrozov", "createdAt": "2021-01-22T00:55:45Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/privileges/PrivilegesEvaluator.java", "diffHunk": "@@ -220,6 +221,22 @@ public PrivilegesEvaluatorResponse evaluate(final User user, String action0, fin\n             log.debug(\"mapped roles: {}\",mappedRoles.toString());\n         }\n \n+        if (request instanceof BulkRequest && (Strings.isNullOrEmpty(user.getRequestedTenant()))) {\n+            // Shortcut for bulk actions. The details are checked on the lower level of the BulkShardRequests (Action indices:data/write/bulk[s]).\n+            // This shortcut is only possible if the default tenant is selected, as we might need to rewrite the request for non-default tenants.\n+            // No further access check for the default tenant is necessary, as access will be also checked on the TransportShardBulkAction level.\n+\n+            if (!securityRoles.impliesClusterPermissionPermission(action0)) {\n+                presponse.missingPrivileges.add(action0);\n+                presponse.allowed = false;\n+                log.info(\"No {}-level perm match for {} [Action [{}]] [RolesChecked {}]. No permissions for {}\", \"cluster\", user, action0,", "originalCommit": "b9941f43e3e151aeb6ebd8fcfab8e6bf04267ffe", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "bf5289f2fd1694fbc50f38785bc69103fdb46a4f", "url": "https://github.com/opensearch-project/security/commit/bf5289f2fd1694fbc50f38785bc69103fdb46a4f", "message": "CR review", "committedDate": "2021-01-22T01:15:33Z", "type": "commit"}]}