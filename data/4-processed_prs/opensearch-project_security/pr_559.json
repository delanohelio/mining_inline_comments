{"pr_number": 559, "pr_title": "Implement ability to configure readonly fields for audit configuration", "pr_createdAt": "2020-07-13T17:23:26Z", "pr_url": "https://github.com/opensearch-project/security/pull/559", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDA4NjAxNg==", "url": "https://github.com/opensearch-project/security/pull/559#discussion_r454086016", "bodyText": "Can we generate this list dynamically instead of hard-coding it?\nThis is not flexible long-term in case if we add new configs.", "author": "dinusX", "createdAt": "2020-07-14T04:03:38Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/auditlog/config/AuditConfig.java", "diffHunk": "@@ -383,4 +383,16 @@ public String toString() {\n                 .filter(settings::hasValue)\n                 .collect(Collectors.toSet());\n     }\n+\n+    public static final ImmutableSet<String> FIELD_PATHS = ImmutableSet.of(\n+            \"/enable\",\n+            \"/audit/enable_rest\", \"/audit/disabled_rest_categories\",\n+            \"/audit/enable_transport\", \"/audit/disabled_transport_categories\",\n+            \"/audit/resolve_bulk_requests\", \"/audit/log_request_body\", \"/audit/resolve_indices\", \"/audit/exclude_sensitive_headers\",\n+            \"/audit/ignore_users\", \"/audit/ignore_requests\",\n+            \"/compliance/enabled\",\n+            \"/compliance/external_config\", \"/compliance/internal_config\",\n+            \"/compliance/read_metadata_only\", \"/compliance/read_watched_fields\", \"/compliance/read_ignore_users\",\n+            \"/compliance/write_metadata_only\", \"/compliance/write_log_diffs\", \"/compliance/write_watched_indices\", \"/compliance/write_ignore_users\"\n+    );", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDQ2MDQ1MQ==", "url": "https://github.com/opensearch-project/security/pull/559#discussion_r454460451", "bodyText": "Done. Using Jackson to find all the properties of a given class.", "author": "sujithvm", "createdAt": "2020-07-14T15:52:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDA4NjAxNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDA4ODk3MQ==", "url": "https://github.com/opensearch-project/security/pull/559#discussion_r454088971", "bodyText": "Should we fail or ignore with a message in case the path does not exist ?\nIn the future if you remove one of the existing paths, it might cause ES to not start anymore if this setting was not updated.", "author": "dinusX", "createdAt": "2020-07-14T04:15:12Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/OpenDistroSecurityPlugin.java", "diffHunk": "@@ -881,8 +881,12 @@ public Settings additionalSettings() {\n             settings.add(Setting.listSetting(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_IGNORE_REQUESTS, Collections.emptyList(), Function.identity(), Property.NodeScope)); //not filtered here\n             settings.add(Setting.boolSetting(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_RESOLVE_BULK_REQUESTS, false, Property.NodeScope, Property.Filtered));\n             settings.add(Setting.boolSetting(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_EXCLUDE_SENSITIVE_HEADERS, true, Property.NodeScope, Property.Filtered));\n-    \n-            \n+            settings.add(Setting.listSetting(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_CONFIG_READONLY_FIELDS, Collections.emptyList(), Function.identity(), (list) -> {\n+                if (!AuditConfig.FIELD_PATHS.containsAll(list)) {\n+                    throw new IllegalArgumentException(\"Invalid resource paths for read-only configs passed.\");\n+                }", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDQ0MjA2NA==", "url": "https://github.com/opensearch-project/security/pull/559#discussion_r454442064", "bodyText": "I think it is better to fail.\nThe fields are updated to dynamically fetch all valid fields now. If customer has configured something wrong, then customers may ignore message and wonder why it is not working correctly.\nIf some path is completely removed in the future, then it will force user to migrate which is desirable IMO.\nAny thoughts ?", "author": "sujithvm", "createdAt": "2020-07-14T15:26:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDA4ODk3MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDA4OTU4NA==", "url": "https://github.com/opensearch-project/security/pull/559#discussion_r454089584", "bodyText": "Can this by any chance override the existing list from the configuration?", "author": "dinusX", "createdAt": "2020-07-14T04:17:23Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/dlic/rest/api/AuditApiAction.java", "diffHunk": "@@ -153,6 +160,21 @@ protected void handlePut(final RestChannel channel, final RestRequest request, f\n         super.handlePut(channel, request, client, content);\n     }\n \n+    @Override\n+    protected void handleGet(final RestChannel channel, RestRequest request, Client client, final JsonNode content) {\n+        final SecurityDynamicConfiguration<?> configuration = load(getConfigName(), true);\n+        filter(configuration);\n+\n+        final String resourcename = getResourceName();\n+        if (!configuration.exists(resourcename)) {\n+            notFound(channel, \"Resource '\" + resourcename + \"' not found.\");\n+            return;\n+        }\n+\n+        configuration.putCObject(READONLY_FIELD, readonlyFields);", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDQzNDI0Mg==", "url": "https://github.com/opensearch-project/security/pull/559#discussion_r454434242", "bodyText": "No. This will not override existing list in configuration. This is not stored in the index. Just added in the GET response. load(getConfigName(), true) will return a new object with configuration from index.", "author": "sujithvm", "createdAt": "2020-07-14T15:15:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDA4OTU4NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTk0NjY3MA==", "url": "https://github.com/opensearch-project/security/pull/559#discussion_r455946670", "bodyText": "Can it be part of the index? Why is it part of elasticsearch.yml?", "author": "vrozov", "createdAt": "2020-07-16T17:19:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDA4OTU4NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTk4Mjc2Mg==", "url": "https://github.com/opensearch-project/security/pull/559#discussion_r455982762", "bodyText": "Mainly because of the following reasons:\n\nConfigs need same types for keys. Cannot have different implementing classes for keys in a configuration. For eg: internalusers all the keys are of same implementing type.\nAdmins also cannot change the readonly properties. Super-admin can bypass them. Not likely these settings are going to be changed often once deployed.\nConsidered storing in \"_meta\" of the document but we currently do expose APIs to update them. If at all user, user wants to change the readonly fields, then using super-admin we must replace the entire document after fetching the current configuration instead of updating in elasticsearch.yml (and doing a rolling restart).\n_meta is not available in 6.x versions.\n\nLet me know your thoughts", "author": "sujithvm", "createdAt": "2020-07-16T18:19:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDA4OTU4NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjczMzM5Mg==", "url": "https://github.com/opensearch-project/security/pull/559#discussion_r456733392", "bodyText": "Storing it in static_audit.yml resource file", "author": "sujithvm", "createdAt": "2020-07-18T01:37:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDA4OTU4NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDA5MDg2NQ==", "url": "https://github.com/opensearch-project/security/pull/559#discussion_r454090865", "bodyText": "Let's use \"read-only\" (with dash) in all the messages for consistency.", "author": "dinusX", "createdAt": "2020-07-14T04:22:30Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/dlic/rest/api/PatchableResourceApiAction.java", "diffHunk": "@@ -143,6 +143,11 @@ private void handleSinglePatch(RestChannel channel, RestRequest request, Client\n             }\n         }\n \n+        if (isReadonlyFieldUpdated(existingResourceAsJsonNode, patchedResourceAsJsonNode)) {\n+            request.params().clear();\n+            conflict(channel, \"Attempted to update readonly property.\");", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDA5MzQxMA==", "url": "https://github.com/opensearch-project/security/pull/559#discussion_r454093410", "bodyText": "Should we similarly test with admin certificate in the additional Patch methods ?", "author": "dinusX", "createdAt": "2020-07-14T04:32:00Z", "path": "src/test/java/com/amazon/opendistroforelasticsearch/security/dlic/rest/api/AuditApiActionTest.java", "diffHunk": "@@ -52,6 +69,177 @@ public void testInvalidPath() throws Exception {\n         assertEquals(HttpStatus.SC_METHOD_NOT_ALLOWED, response.getStatusCode());\n     }\n \n+    @Test\n+    public void testInvalidSetting() throws Exception {\n+        thrown.expect(IllegalArgumentException.class);\n+        thrown.expectMessage(\"Invalid resource paths for read-only configs passed.\");\n+\n+        final Settings settings = Settings.builder()\n+                .putList(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_CONFIG_READONLY_FIELDS, \"/test\")\n+                .build();\n+        setupWithRestRoles(settings);\n+    }\n+\n+    @Test\n+    public void testDisabledCategoryOrder() throws Exception {\n+        setup();\n+\n+        final List<String> testCategories = ImmutableList.of(\"SSL_EXCEPTION\", \"AUTHENTICATED\", \"BAD_HEADERS\");\n+        final AuditConfig auditConfig = new AuditConfig(true, AuditConfig.Filter.from(\n+                ImmutableMap.of(\"disabled_rest_categories\", testCategories)\n+        ), ComplianceConfig.DEFAULT);\n+        final ObjectNode json = DefaultObjectMapper.objectMapper.valueToTree(auditConfig);\n+\n+        testPutRequest(json, HttpStatus.SC_OK, true);\n+        RestHelper.HttpResponse response = rh.executeGetRequest(ENDPOINT, adminCredsHeader);\n+        List<String> actual = Streams.stream(readTree(response.getBody()).at(\"/config/audit/disabled_rest_categories\").iterator())\n+                .map(JsonNode::textValue)\n+                .collect(Collectors.toList());\n+        assertEquals(testCategories, actual);\n+    }\n+\n+    @Test\n+    public void testReadonlyApi() throws Exception {\n+        final List<String> readonlyFields = ImmutableList.of(\"/audit/enable_rest\", \"/audit/disabled_rest_categories\", \"/audit/ignore_requests\", \"/compliance/read_watched_fields\");\n+\n+        final Settings settings = Settings.builder()\n+                .putList(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_CONFIG_READONLY_FIELDS, readonlyFields)\n+                .build();\n+        setupWithRestRoles(settings);\n+        final ObjectMapper objectMapper = DefaultObjectMapper.objectMapper;\n+\n+        // test get\n+        RestHelper.HttpResponse response = rh.executeGetRequest(ENDPOINT, adminCredsHeader);\n+        assertEquals(HttpStatus.SC_OK, response.getStatusCode());\n+        List<String> actual = Streams.stream(readTree(response.getBody()).get(\"_readonly\").iterator())\n+                .map(JsonNode::textValue)\n+                .collect(Collectors.toList());\n+        assertEquals(readonlyFields, actual);\n+\n+        // test config\n+        final AuditConfig auditConfig = AuditConfig.from(Settings.EMPTY);\n+\n+        // reset\n+        ObjectNode json = objectMapper.valueToTree(auditConfig);\n+        testPutRequest(json, HttpStatus.SC_OK, true);\n+        // change enable_rest readonly property\n+        testReadonlyBoolean(json, \"/audit\", \"enable_rest\");\n+\n+        // reset\n+        json = objectMapper.valueToTree(auditConfig);\n+        testPutRequest(json, HttpStatus.SC_OK, true);\n+        // change disabled_rest_categories readonly property\n+        testReadonlyCategories(json, \"/audit\", \"disabled_rest_categories\");\n+\n+        // reset\n+        json = objectMapper.valueToTree(auditConfig);\n+        testPutRequest(json, HttpStatus.SC_OK, true);\n+        // change ignore_requests readonly property\n+        testReadonlyList(json, \"/audit\", \"ignore_requests\");\n+\n+        // reset\n+        json = objectMapper.valueToTree(auditConfig);\n+        testPutRequest(json, HttpStatus.SC_OK, true);\n+        // change ignore_requests readonly property\n+        testReadonlyMap(json, \"/compliance\", \"read_watched_fields\");\n+    }\n+\n+    private void testPutRequest(final JsonNode json, final int expectedStatus, final boolean sendAdminCertificate, final Header... header) throws Exception {\n+        rh.sendAdminCertificate = sendAdminCertificate;\n+        RestHelper.HttpResponse response = rh.executePutRequest(CONFIG_ENDPOINT, writeValueAsString(json, false), header);\n+        assertEquals(expectedStatus, response.getStatusCode());\n+    }\n+\n+    private void testReadonlyBoolean(final ObjectNode json, final String config, final String resource) throws Exception {\n+        final String resourcePath = \"/config\" + config + \"/\" + resource;\n+        ((ObjectNode)json.at(config)).put(resource, true);\n+        testPutRequest(json, HttpStatus.SC_OK, true);\n+        ((ObjectNode)json.at(config)).put(resource, false);\n+        testPutRequest(json, HttpStatus.SC_CONFLICT, false, adminCredsHeader);\n+        testBooleanPatch(resourcePath, false, HttpStatus.SC_CONFLICT, adminCredsHeader);", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDQzMzMzNw==", "url": "https://github.com/opensearch-project/security/pull/559#discussion_r454433337", "bodyText": "I have added on line 146 to test all actions as super-admin which includes Patch methods", "author": "sujithvm", "createdAt": "2020-07-14T15:14:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDA5MzQxMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDA5NDY3NA==", "url": "https://github.com/opensearch-project/security/pull/559#discussion_r454094674", "bodyText": "You can rewrite this method to reuse your new method \"testBooleanPatch\"", "author": "dinusX", "createdAt": "2020-07-14T04:36:43Z", "path": "src/test/java/com/amazon/opendistroforelasticsearch/security/dlic/rest/api/AuditApiActionTest.java", "diffHunk": "@@ -176,13 +359,21 @@ private void testPatchAction(final int expectedStatus, final Header... headers)\n         testBoolean(\"/config/compliance/external_config\", expectedStatus, headers);\n         testBoolean(\"/config/compliance/read_metadata_only\", expectedStatus, headers);\n         testList(\"/config/compliance/read_ignore_users\", ImmutableList.of(\"test-user-1\"), expectedStatus, headers);\n-        testMap(\"/config/compliance/read_watched_fields\", ImmutableMap.of(\"test-index-1\", Collections.singleton(\"test-field\")), expectedStatus, headers);\n+        testMap(\"/config/compliance/read_watched_fields\", ImmutableMap.of(\"test-index-1\", Collections.singletonList(\"test-field\")), expectedStatus, headers);\n         testBoolean(\"/config/compliance/write_metadata_only\", expectedStatus, headers);\n         testBoolean(\"/config/compliance/write_log_diffs\", expectedStatus, headers);\n         testList(\"/config/compliance/write_ignore_users\", ImmutableList.of(\"test-user-1\"), expectedStatus, headers);\n         testList(\"/config/compliance/write_watched_indices\", ImmutableList.of(\"test-index-1\"), expectedStatus, headers);\n     }\n \n+    private void testBooleanPatch(final String patchResource, final boolean value, final int expected, final Header... headers) throws Exception {\n+        RestHelper.HttpResponse response = rh.executePatchRequest(ENDPOINT, \"[{\\\"op\\\": \\\"add\\\",\\\"path\\\": \\\"\" + patchResource + \"\\\",\\\"value\\\": \" + value + \"}]\", headers);\n+        assertEquals(expected, response.getStatusCode());\n+        if (expected == HttpStatus.SC_OK) {\n+            assertTrue(readTree(rh.executeGetRequest(ENDPOINT, headers).getBody()).at(patchResource).asBoolean());\n+        }\n+    }\n+\n     private void testBoolean(final String patchResource, final int expected, final Header... headers) throws Exception {\n         // make true", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDA5Nzg1NA==", "url": "https://github.com/opensearch-project/security/pull/559#discussion_r454097854", "bodyText": "Should this be \"enable_rest\" or \"enable_rest_categories\" ?", "author": "dinusX", "createdAt": "2020-07-14T04:48:23Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/auditlog/config/AuditConfig.java", "diffHunk": "@@ -383,4 +383,16 @@ public String toString() {\n                 .filter(settings::hasValue)\n                 .collect(Collectors.toSet());\n     }\n+\n+    public static final ImmutableSet<String> FIELD_PATHS = ImmutableSet.of(\n+            \"/enable\",\n+            \"/audit/enable_rest\", \"/audit/disabled_rest_categories\",", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDQ2MDE4MA==", "url": "https://github.com/opensearch-project/security/pull/559#discussion_r454460180", "bodyText": "It is disabled_rest_categories as it blacklists categories ignored. This field is now dynamically fetched via Jackson properties of that class.", "author": "sujithvm", "createdAt": "2020-07-14T15:51:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDA5Nzg1NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTkwNDIyNA==", "url": "https://github.com/opensearch-project/security/pull/559#discussion_r455904224", "bodyText": "Use Sets.union().", "author": "vrozov", "createdAt": "2020-07-16T16:10:58Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/auditlog/config/AuditConfig.java", "diffHunk": "@@ -385,4 +384,11 @@ public String toString() {\n                 .filter(settings::hasValue)\n                 .collect(Collectors.toSet());\n     }\n+\n+    public static final Set<String> FIELD_PATHS = Stream.of(", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTk1NTQ4Ng==", "url": "https://github.com/opensearch-project/security/pull/559#discussion_r455955486", "bodyText": "Which order is important here and why? Should not natural order be sufficient?", "author": "vrozov", "createdAt": "2020-07-16T17:33:44Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/auditlog/impl/AuditCategory.java", "diffHunk": "@@ -22,19 +23,18 @@\n     COMPLIANCE_INTERNAL_CONFIG_READ,\n     COMPLIANCE_INTERNAL_CONFIG_WRITE;\n \n-    public static EnumSet<AuditCategory> parse(final Collection<String> categories) {\n-        EnumSet<AuditCategory> set = EnumSet.noneOf(AuditCategory.class);\n+    public static Set<AuditCategory> parse(final Collection<String> categories) {\n         if (categories.isEmpty())\n-            return set;\n+            return Collections.emptySet();\n \n         return categories\n                 .stream()\n                 .map(String::toUpperCase)\n                 .map(AuditCategory::valueOf)\n-                .collect(Collectors.toCollection(() -> set));\n+                .collect(ImmutableSet.toImmutableSet());", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTk1OTEyMg==", "url": "https://github.com/opensearch-project/security/pull/559#discussion_r455959122", "bodyText": "If the entries are passed as array, then the enum set reorders based on the order of elements defined within EnumSet.\nFor eg: [\"AUTHENTICATED\", \"GRANTED_PRIVILEGES\"] gets reordered as [\"GRANTED_PRIVILEGES\", \"AUTHENTICATED\"] as GRANTED_PRIVILEGES comes before AUTHENTICATED in EnumSet ordering.\nThis breaks if the same put request is called twice because to compare two JSON arrays are equal, the order must be same too. Also in the UI, the elements gets reordered on refetching. To avoid this, using ImmutableSet so that ordering remains the same as the way user enters them.", "author": "sujithvm", "createdAt": "2020-07-16T17:40:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTk1NTQ4Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjY4MjQzMA==", "url": "https://github.com/opensearch-project/security/pull/559#discussion_r456682430", "bodyText": "Had to resort to updating the test file in test resources as the resource file could not be injected into AuditApiAction for testing.\nIn tearDown clearing it.\nAttempted to change via Reflection to inject another value for the STATIC_RESOURCE but making tests to be unstable", "author": "sujithvm", "createdAt": "2020-07-17T21:29:22Z", "path": "src/test/java/com/amazon/opendistroforelasticsearch/security/dlic/rest/api/AuditApiActionTest.java", "diffHunk": "@@ -52,6 +81,177 @@ public void testInvalidPath() throws Exception {\n         assertEquals(HttpStatus.SC_METHOD_NOT_ALLOWED, response.getStatusCode());\n     }\n \n+    @Test\n+    public void testDisabledCategoryOrder() throws Exception {\n+        setup();\n+\n+        final List<String> testCategories = ImmutableList.of(\"SSL_EXCEPTION\", \"AUTHENTICATED\", \"BAD_HEADERS\");\n+        final AuditConfig auditConfig = new AuditConfig(true, AuditConfig.Filter.from(\n+                ImmutableMap.of(\"disabled_rest_categories\", testCategories)\n+        ), ComplianceConfig.DEFAULT);\n+        final ObjectNode json = DefaultObjectMapper.objectMapper.valueToTree(auditConfig);\n+\n+        testPutRequest(json, HttpStatus.SC_OK, true);\n+        RestHelper.HttpResponse response = rh.executeGetRequest(ENDPOINT, adminCredsHeader);\n+        List<String> actual = Streams.stream(readTree(response.getBody()).at(\"/config/audit/disabled_rest_categories\").iterator())\n+                .map(JsonNode::textValue)\n+                .collect(Collectors.toList());\n+        assertEquals(testCategories, actual);\n+    }\n+\n+    @Test\n+    public void testReadonlyApi() throws Exception {\n+        final List<String> readonlyFields = ImmutableList.of(\"/audit/enable_rest\", \"/audit/disabled_rest_categories\", \"/audit/ignore_requests\", \"/compliance/read_watched_fields\");\n+        updateStaticResourceReadonly(readonlyFields);", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjcxOTY1OQ==", "url": "https://github.com/opensearch-project/security/pull/559#discussion_r456719659", "bodyText": "Delegate conversion from JSON to isReadonlyFieldUpdated(), otherwise that conversion impacts all API actions even one that blindly return false.", "author": "vrozov", "createdAt": "2020-07-17T23:58:42Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/dlic/rest/api/AbstractApiAction.java", "diffHunk": "@@ -201,6 +202,11 @@ protected void handlePut(final RestChannel channel, final RestRequest request, f\n \t\t\treturn;\n \t\t}\n \n+\t\tif (isReadonlyFieldUpdated(Utils.convertJsonToJackson(existingConfiguration, false).get(getResourceName()), content)) {", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjcyMDk4Mg==", "url": "https://github.com/opensearch-project/security/pull/559#discussion_r456720982", "bodyText": "reuse AuditConfig.Filter.FIELDS and ComplianceConfig.FIELDS.", "author": "vrozov", "createdAt": "2020-07-18T00:05:19Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/auditlog/config/AuditConfig.java", "diffHunk": "@@ -385,4 +383,10 @@ public String toString() {\n                 .filter(settings::hasValue)\n                 .collect(Collectors.toSet());\n     }\n+\n+    public static final Set<String> FIELD_PATHS = Sets.union(\n+            DefaultObjectMapper.getFields(AuditConfig.class, \"/\"),\n+            Sets.union(\n+                    DefaultObjectMapper.getFields(AuditConfig.Filter.class, \"/audit/\"),", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjcyNTkwNg==", "url": "https://github.com/opensearch-project/security/pull/559#discussion_r456725906", "bodyText": "A prefix path needs to be added to represent the resource path hence did not reuse", "author": "sujithvm", "createdAt": "2020-07-18T00:36:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjcyMDk4Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjczMjgxNQ==", "url": "https://github.com/opensearch-project/security/pull/559#discussion_r456732815", "bodyText": "Done", "author": "sujithvm", "createdAt": "2020-07-18T01:31:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjcyMDk4Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njg0MjY5MQ==", "url": "https://github.com/opensearch-project/security/pull/559#discussion_r456842691", "bodyText": "nit: IllegalArgumentException does not seem to be a good match", "author": "vrozov", "createdAt": "2020-07-19T00:38:59Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/dlic/rest/api/AuditApiAction.java", "diffHunk": "@@ -126,6 +139,16 @@ public AuditApiAction(final Settings settings,\n         super(settings, configPath, controller, client, adminDNs, cl, cs, principalExtractor, privilegesEvaluator, threadPool, auditLog);\n         this.privilegesEvaluator = privilegesEvaluator;\n         this.threadContext = threadPool.getThreadContext();\n+        try {\n+            this.readonlyFields = DefaultObjectMapper.YAML_MAPPER\n+                    .readValue(this.getClass().getResourceAsStream(STATIC_RESOURCE), new TypeReference<Map<String, List<String>>>() {})\n+                    .get(READONLY_FIELD);\n+            if (!AuditConfig.FIELD_PATHS.containsAll(this.readonlyFields)) {\n+                throw new IllegalArgumentException(\"Invalid read-only field paths provided in file \" + STATIC_RESOURCE);", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzU4MTM5OA==", "url": "https://github.com/opensearch-project/security/pull/559#discussion_r457581398", "bodyText": "What would you suggest? Is it fine to throw the same StaticResourceException ?", "author": "sujithvm", "createdAt": "2020-07-20T17:39:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njg0MjY5MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzczNDQwNw==", "url": "https://github.com/opensearch-project/security/pull/559#discussion_r457734407", "bodyText": "Throwing StaticResourceException", "author": "sujithvm", "createdAt": "2020-07-20T22:48:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njg0MjY5MQ=="}], "type": "inlineReview"}, {"oid": "de3976276b9eb7aaedecde00c6d9016a6b4e041e", "url": "https://github.com/opensearch-project/security/commit/de3976276b9eb7aaedecde00c6d9016a6b4e041e", "message": "Implement ability to configure readonly fields for audit configuration", "committedDate": "2020-07-20T22:09:39Z", "type": "commit"}]}