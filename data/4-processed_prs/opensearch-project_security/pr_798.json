{"pr_number": 798, "pr_title": "Add user & roles to the thread context ", "pr_createdAt": "2020-10-26T07:05:43Z", "pr_url": "https://github.com/opensearch-project/security/pull/798", "timeline": [{"oid": "e2c33a7f6fa59b789e98b2cbc5930ff6785a2f35", "url": "https://github.com/opensearch-project/security/commit/e2c33a7f6fa59b789e98b2cbc5930ff6785a2f35", "message": "demo config for plugins security and default alerting roles", "committedDate": "2020-10-13T23:32:37Z", "type": "commit"}, {"oid": "773fb63ca3cc27068001856c739e6b5b7125758a", "url": "https://github.com/opensearch-project/security/commit/773fb63ca3cc27068001856c739e6b5b7125758a", "message": "fix spaces", "committedDate": "2020-10-14T04:16:33Z", "type": "commit"}, {"oid": "69bf2473dcba3bb4ab8c413277b1e52195f642e8", "url": "https://github.com/opensearch-project/security/commit/69bf2473dcba3bb4ab8c413277b1e52195f642e8", "message": "Merge branch 'master' of https://github.com/opendistro-for-elasticsearch/security into config_changes", "committedDate": "2020-10-16T21:23:08Z", "type": "commit"}, {"oid": "c1342491126d05ed4bd6352783165daf50cf690a", "url": "https://github.com/opensearch-project/security/commit/c1342491126d05ed4bd6352783165daf50cf690a", "message": "Add openditro roles to the User", "committedDate": "2020-10-24T23:15:42Z", "type": "commit"}, {"oid": "1d55c6c37e85d5e98205e82005a4b41d54388d45", "url": "https://github.com/opensearch-project/security/commit/1d55c6c37e85d5e98205e82005a4b41d54388d45", "message": "Merge branch 'master' of https://github.com/opendistro-for-elasticsearch/security into config_changes", "committedDate": "2020-10-24T23:16:51Z", "type": "commit"}, {"oid": "05334c0ee7c1da3ad9b62d2546b2412922bcc010", "url": "https://github.com/opensearch-project/security/commit/05334c0ee7c1da3ad9b62d2546b2412922bcc010", "message": "Add user roles to thread context", "committedDate": "2020-10-26T00:59:40Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjM4NjQwOQ==", "url": "https://github.com/opensearch-project/security/pull/798#discussion_r512386409", "bodyText": "nit: populate only if there is a call to chain. If access is denied, it is necessary to populate OPENDISTRO_SECURITY_USER_ROLES_STRING?", "author": "vrozov", "createdAt": "2020-10-27T02:54:42Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/filter/OpenDistroSecurityFilter.java", "diffHunk": "@@ -291,7 +292,11 @@ public int order() {\n             if (log.isDebugEnabled()) {\n                 log.debug(pres);\n             }\n-            \n+\n+            if(threadContext.getTransient(OPENDISTRO_SECURITY_USER_ROLES_STRING) == null) {", "originalCommit": "05334c0ee7c1da3ad9b62d2546b2412922bcc010", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjk1ODc1OA==", "url": "https://github.com/opensearch-project/security/pull/798#discussion_r512958758", "bodyText": "Does this require order of plugins loading to be enforced? If yes, how that will be done?", "author": "vrozov", "createdAt": "2020-10-27T19:12:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjM4NjQwOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzA3Nzc2Ng==", "url": "https://github.com/opensearch-project/security/pull/798#discussion_r513077766", "bodyText": "Discussed with @skkosuri-amzn, the ordering needs to be researched. Can be done as a follow up PR.", "author": "vrozov", "createdAt": "2020-10-27T22:47:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjM4NjQwOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjM4NzUxNA==", "url": "https://github.com/opensearch-project/security/pull/798#discussion_r512387514", "bodyText": "Can roles or odfe roles contain ,?", "author": "vrozov", "createdAt": "2020-10-27T02:58:43Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/user/User.java", "diffHunk": "@@ -263,4 +263,8 @@ public final void addOpenDistroSecurityRoles(final Collection<String> securityRo\n     public final Set<String> getOpenDistroSecurityRoles() {\n         return this.openDistroSecurityRoles == null ? Collections.emptySet() : Collections.unmodifiableSet(this.openDistroSecurityRoles);\n     }\n+\n+    public final String getUserRolesString() {\n+        return name + \"|\" + String.join(\",\", getRoles()) + \"|\" + String.join(\",\", getOpenDistroSecurityRoles());", "originalCommit": "05334c0ee7c1da3ad9b62d2546b2412922bcc010", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjM4OTI1Mw==", "url": "https://github.com/opensearch-project/security/pull/798#discussion_r512389253", "bodyText": "As far as I know, it can't contain ,. Pipe separated string format is used at other places including : UserInjector, RolesInjector.", "author": "skkosuri-amzn", "createdAt": "2020-10-27T03:05:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjM4NzUxNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjM5MDAwNQ==", "url": "https://github.com/opensearch-project/security/pull/798#discussion_r512390005", "bodyText": "For consistency with injected_user (that is also a String) please rename to remove STRING: OPENDISTRO_SECURITY_USER_ROLES_STRING ->OPENDISTRO_SECURITY_USER_AND_ROLES, \"user_roles_string\" -> \"user&roles\" or \"user_and_roles\".", "author": "vrozov", "createdAt": "2020-10-27T03:08:13Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/support/ConfigConstants.java", "diffHunk": "@@ -99,6 +99,8 @@\n     public static final String OPENDISTRO_SECURITY_USER = OPENDISTRO_SECURITY_CONFIG_PREFIX+\"user\";\n     public static final String OPENDISTRO_SECURITY_USER_HEADER = OPENDISTRO_SECURITY_CONFIG_PREFIX+\"user_header\";\n \n+    public static final String OPENDISTRO_SECURITY_USER_ROLES_STRING = OPENDISTRO_SECURITY_CONFIG_PREFIX + \"user_roles_string\";", "originalCommit": "05334c0ee7c1da3ad9b62d2546b2412922bcc010", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjM5NDkzNA==", "url": "https://github.com/opensearch-project/security/pull/798#discussion_r512394934", "bodyText": "Renamed. thanks.", "author": "skkosuri-amzn", "createdAt": "2020-10-27T03:27:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjM5MDAwNQ=="}], "type": "inlineReview"}, {"oid": "43982037fc7eca376951cdb926c69becb5824023", "url": "https://github.com/opensearch-project/security/commit/43982037fc7eca376951cdb926c69becb5824023", "message": "Renames the option to OPENDISTRO_SECURITY_USER_AND_ROLES", "committedDate": "2020-10-27T03:25:52Z", "type": "commit"}]}