{"pr_number": 334, "pr_title": "Upgrade checkout action to v2 to fix \"fatal: reference is not a tree\" issue", "pr_createdAt": "2020-03-31T01:46:28Z", "pr_url": "https://github.com/opensearch-project/security/pull/334", "timeline": [{"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTEyMjc3Mg==", "url": "https://github.com/opensearch-project/security/pull/334#discussion_r401122772", "bodyText": "I think we are moving away from openssl and using java ssl.\n@debjanibnrj what is the openssl status?", "author": "sujithvm", "createdAt": "2020-03-31T18:25:05Z", "path": ".github/workflows/ci.yml", "diffHunk": "@@ -12,24 +12,39 @@ on:\n jobs:\n   build:\n     runs-on: ubuntu-latest\n-    container: opendistroforelasticsearch/security-maven:v1\n \n     steps:\n \n+    - name: Set up JDK 11\n+      uses: actions/setup-java@v1\n+      with:\n+        java-version: 11.0.x\n+\n     - name: Checkout security\n-      uses: actions/checkout@v1\n+      uses: actions/checkout@v2\n \n     - name: Checkstyle\n       run: mvn checkstyle:checkstyle\n-      \n+\n+    - name: prepare openssl", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTEyMzkzMg==", "url": "https://github.com/opensearch-project/security/pull/334#discussion_r401123932", "bodyText": "only for 7.4+, other branches still support it", "author": "debjanibnrj", "createdAt": "2020-03-31T18:27:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTEyMjc3Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTEyNjM1MQ==", "url": "https://github.com/opensearch-project/security/pull/334#discussion_r401126351", "bodyText": "Okay. So we don't need this change for master and only for older branches. Is that correct ?", "author": "sujithvm", "createdAt": "2020-03-31T18:30:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTEyMjc3Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTEyODU1MA==", "url": "https://github.com/opensearch-project/security/pull/334#discussion_r401128550", "bodyText": "Yes, any branch before 7.4 will still need it. 7.4+ will default to using JDK SSL", "author": "debjanibnrj", "createdAt": "2020-03-31T18:34:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTEyMjc3Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTIzNDkyMw==", "url": "https://github.com/opensearch-project/security/pull/334#discussion_r401234923", "bodyText": "According to the release notes openssl is not supported for Java 12+ and CI uses Java 11 with OPENDISTRO_SECURITY_TEST_OPENSSL_OPT set to true. @dinusX  @hardik-k-shah what is your take here?", "author": "vrozov", "createdAt": "2020-03-31T21:47:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTEyMjc3Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTIzNzIzNw==", "url": "https://github.com/opensearch-project/security/pull/334#discussion_r401237237", "bodyText": "Currently, OpenSSL is not working with 7.4+. We did not get chance to debug that yet.\nTo keep master branch working, I guess we need to disable OpenSSL, till we find a fix", "author": "hardik-k-shah", "createdAt": "2020-03-31T21:51:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTEyMjc3Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTI1NjA5NQ==", "url": "https://github.com/opensearch-project/security/pull/334#discussion_r401256095", "bodyText": "Looks like I miss something here. On the master branch, PR CI workflow uses opendistroforelasticsearch/security-maven:v1 that sets OPENDISTRO_SECURITY_TEST_OPENSSL_OPT  to true and it (CI workflow) succeeds.", "author": "vrozov", "createdAt": "2020-03-31T22:37:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTEyMjc3Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTI3Mjc5Ng==", "url": "https://github.com/opensearch-project/security/pull/334#discussion_r401272796", "bodyText": "Did a quick scan through our codebase and it looks like OPENDISTRO_SECURITY_TEST_OPENSSL_OPT is only being used as part of this test - https://github.com/opendistro-for-elasticsearch/security/blob/cbcc6245bd923c545fc7e52dabe1bed267ddbf6c/src/test/java/com/amazon/opendistroforelasticsearch/security/ssl/OpenSSLTest.java#L58.\nOn the master branch running -\nmvn -Dtest=OpenSSLTest#testEnsureOpenSSLAvailability test passes as the netty library is still returning true for the statement - https://github.com/opendistro-for-elasticsearch/security/blob/cbcc6245bd923c545fc7e52dabe1bed267ddbf6c/src/test/java/com/amazon/opendistroforelasticsearch/security/ssl/OpenSSLTest.java#L61.\nHowever for 7.4+ versions of ES security node to node communication with Openssl was failing (due to unknown reasons) which resulted in having to disable OpenSsl for 7.4+ versions. PR.", "author": "debjanibnrj", "createdAt": "2020-03-31T23:28:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTEyMjc3Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTI4NTg2MQ==", "url": "https://github.com/opensearch-project/security/pull/334#discussion_r401285861", "bodyText": "@debjanibnrj Thank you for the explanation. Are there plans to investigate and enable openssl back later or is it permanently not supported? Is the issue with openssl specific to Java 12+ as the release notes suggest or it is common across all Java versions?\nAll, will it be OK to run tests without openssl installed and configured and with OPENDISTRO_SECURITY_TEST_OPENSSL_OPT not set on master and branches that support ES 7.4+?", "author": "vrozov", "createdAt": "2020-04-01T00:12:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTEyMjc3Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTcyMDQ0NQ==", "url": "https://github.com/opensearch-project/security/pull/334#discussion_r401720445", "bodyText": "We would like to get back to supporting OpenSSL. We have not invested enough time in discovering the issue with node to node communication. Will open an issue to investigate. If we see that it is not do-able we will have to take a stronger call.\nBased on what I'm seeing here - https://github.com/opendistro-for-elasticsearch/security/blob/opendistro-1.4/src/main/java/com/amazon/opendistroforelasticsearch/security/ssl/OpenDistroSecuritySSLPlugin.java#L85\nOpenSSL should be supported for Java versions below 12.\nYou can remove the OPENDISTRO_SECURITY_TEST_OPENSSL_OPT from 7.4+ branches, I don't think it will affect the tests, but would reverify by executing a test run for the same.", "author": "debjanibnrj", "createdAt": "2020-04-01T15:49:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTEyMjc3Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTEyODg1OQ==", "url": "https://github.com/opensearch-project/security/pull/334#discussion_r401128859", "bodyText": "Also the workflow runs on Ubuntu image. Can we not directly use openssl and set OPENDISTRO_SECURITY_TEST_OPENSSL_OPT=true for the test ?", "author": "sujithvm", "createdAt": "2020-03-31T18:34:49Z", "path": ".github/workflows/ci.yml", "diffHunk": "@@ -12,24 +12,39 @@ on:\n jobs:\n   build:\n     runs-on: ubuntu-latest\n-    container: opendistroforelasticsearch/security-maven:v1\n \n     steps:\n \n+    - name: Set up JDK 11\n+      uses: actions/setup-java@v1\n+      with:\n+        java-version: 11.0.x\n+\n     - name: Checkout security\n-      uses: actions/checkout@v1\n+      uses: actions/checkout@v2\n \n     - name: Checkstyle\n       run: mvn checkstyle:checkstyle\n-      \n+\n+    - name: prepare openssl\n+      run: |\n+        mkdir -p tmp/build-openssl && cd tmp/build-openssl\n+        curl -OL https://ftp.openssl.org/source/openssl-1.0.1u.tar.gz", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTIzMDQzNg==", "url": "https://github.com/opensearch-project/security/pull/334#discussion_r401230436", "bodyText": "Does it come with a compatible openssl version? My understanding is that netty version used by the plugin requires openssl 1.0.x.", "author": "vrozov", "createdAt": "2020-03-31T21:37:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTEyODg1OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTI3MDI2NQ==", "url": "https://github.com/opensearch-project/security/pull/334#discussion_r401270265", "bodyText": "Github image does not come with openssl preinstalled: https://github.com/actions/virtual-environments/blob/master/images/linux/Ubuntu1804-README.md", "author": "vrozov", "createdAt": "2020-03-31T23:20:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTEyODg1OQ=="}], "type": "inlineReview"}, {"oid": "2eb567543db6034dc69100c692944a8db9cc6f66", "url": "https://github.com/opensearch-project/security/commit/2eb567543db6034dc69100c692944a8db9cc6f66", "message": "Upgrade checkout action to v2 to fix \"fatal: reference is not a tree\" issue", "committedDate": "2020-04-01T01:20:09Z", "type": "commit"}, {"oid": "2eb567543db6034dc69100c692944a8db9cc6f66", "url": "https://github.com/opensearch-project/security/commit/2eb567543db6034dc69100c692944a8db9cc6f66", "message": "Upgrade checkout action to v2 to fix \"fatal: reference is not a tree\" issue", "committedDate": "2020-04-01T01:20:09Z", "type": "forcePushed"}]}