{"pr_number": 818, "pr_title": "Reject empty password in internal user creation", "pr_createdAt": "2020-10-30T19:37:20Z", "pr_url": "https://github.com/opensearch-project/security/pull/818", "timeline": [{"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODI5MTAxNA==", "url": "https://github.com/opensearch-project/security/pull/818#discussion_r518291014", "bodyText": "Can you reject in CredentialsValidator which is used by the account API for self-change password as well ?", "author": "sujithvm", "createdAt": "2020-11-05T19:02:01Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/dlic/rest/api/InternalUsersApiAction.java", "diffHunk": "@@ -116,8 +116,14 @@ protected void handlePut(RestChannel channel, final RestRequest request, final C\n             }\n         }\n \n-        // if password is set, it takes precedence over hash\n+        // Reject empty password\n         final String plainTextPassword = securityJsonNode.get(\"password\").asString();\n+        if (plainTextPassword != null && plainTextPassword.isEmpty()){\n+            badRequestResponse(channel, \"Please specify a non-empty 'password' when creating a new internal user.\");", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODQ2NDMwOA==", "url": "https://github.com/opensearch-project/security/pull/818#discussion_r518464308", "bodyText": "I tried that. But CredentialsValidator validates password using regex, and it responds status code 201: {\"status\":\"error\",\"reason\":\"Password does not match minimum criteria\"}. I believe what we want for empty password is status code 400: {\"status\":\"BAD_REQUEST\",\"message\":\"Please specify a non-empty 'password' when creating a new internal user.\"}.", "author": "cliu123", "createdAt": "2020-11-06T01:09:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODI5MTAxNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODQ3MzcwNw==", "url": "https://github.com/opensearch-project/security/pull/818#discussion_r518473707", "bodyText": "It returns 201 with that error message? This should not happen. 400 must be returned. Can you verify again", "author": "sujithvm", "createdAt": "2020-11-06T01:40:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODI5MTAxNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTk3NjE0Mw==", "url": "https://github.com/opensearch-project/security/pull/818#discussion_r519976143", "bodyText": "Moved the validation to CreadentialValidator.", "author": "cliu123", "createdAt": "2020-11-09T17:08:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODI5MTAxNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODI5MTg4MA==", "url": "https://github.com/opensearch-project/security/pull/818#discussion_r518291880", "bodyText": "Can you remove other checks for isEmpty() ?", "author": "sujithvm", "createdAt": "2020-11-05T19:03:32Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/dlic/rest/api/InternalUsersApiAction.java", "diffHunk": "@@ -116,8 +116,14 @@ protected void handlePut(RestChannel channel, final RestRequest request, final C\n             }\n         }\n \n-        // if password is set, it takes precedence over hash\n+        // Reject empty password\n         final String plainTextPassword = securityJsonNode.get(\"password\").asString();\n+        if (plainTextPassword != null && plainTextPassword.isEmpty()){\n+            badRequestResponse(channel, \"Please specify a non-empty 'password' when creating a new internal user.\");\n+            return;\n+        }\n+\n+        // if password is set, it takes precedence over hash", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODQ2NTYxNQ==", "url": "https://github.com/opensearch-project/security/pull/818#discussion_r518465615", "bodyText": "Done.", "author": "cliu123", "createdAt": "2020-11-06T01:13:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODI5MTg4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODQ3MzIwMQ==", "url": "https://github.com/opensearch-project/security/pull/818#discussion_r518473201", "bodyText": "Can you simplify the checks? we only need to check for password is not null and replace hash so that it takes precedence", "author": "sujithvm", "createdAt": "2020-11-06T01:38:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODI5MTg4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDIwNjE5OA==", "url": "https://github.com/opensearch-project/security/pull/818#discussion_r520206198", "bodyText": "Done.", "author": "cliu123", "createdAt": "2020-11-10T00:24:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODI5MTg4MA=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDAzODU1OQ==", "url": "https://github.com/opensearch-project/security/pull/818#discussion_r520038559", "bodyText": "Fine with keeping current behavior but username validation does not depend on regex", "author": "sujithvm", "createdAt": "2020-11-09T18:49:03Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/dlic/rest/validation/CredentialsValidator.java", "diffHunk": "@@ -53,39 +53,45 @@ public boolean validate() {\n         final String regex = this.esSettings.get(ConfigConstants.OPENDISTRO_SECURITY_RESTAPI_PASSWORD_VALIDATION_REGEX, null);\n \n         if ((request.method() == RestRequest.Method.PUT || request.method() == RestRequest.Method.PATCH)\n-                && regex != null\n-                && !regex.isEmpty()\n                 && this.content != null\n                 && this.content.length() > 1) {\n             try {\n                 final Map<String, Object> contentAsMap = XContentHelper.convertToMap(this.content, false, XContentType.JSON).v2();\n                 if (contentAsMap != null && contentAsMap.containsKey(\"password\")) {\n                     final String password = (String) contentAsMap.get(\"password\");\n \n-                    // Password can be null/empty for an existing user. Regex will validate password if present\n-                    if (password != null && !password.isEmpty() && !regex.isEmpty() && !Pattern.compile(\"^\"+regex+\"$\").matcher(password).matches()) {\n-                        if(log.isDebugEnabled()) {\n-                            log.debug(\"Regex does not match password\");\n-                        }\n+                    // Password is not allowed to be empty if present.\n+                    if (password != null && password.isEmpty()) {\n                         this.errorType = ErrorType.INVALID_PASSWORD;\n                         return false;\n                     }\n \n-                    final String username = Utils.coalesce(request.param(\"name\"), hasParams() ? (String) param[0] : null);\n+                    if (regex != null && !regex.isEmpty()) {\n+                        // Regex will validate password if present\n+                        if (password != null && !Pattern.compile(\"^\"+regex+\"$\").matcher(password).matches()) {\n+                            if(log.isDebugEnabled()) {\n+                                log.debug(\"Regex does not match password\");\n+                            }\n+                            this.errorType = ErrorType.INVALID_PASSWORD;\n+                            return false;\n+                        }\n+\n+                        final String username = Utils.coalesce(request.param(\"name\"), hasParams() ? (String) param[0] : null);", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODg4NTQ2NQ==", "url": "https://github.com/opensearch-project/security/pull/818#discussion_r528885465", "bodyText": "I see.", "author": "cliu123", "createdAt": "2020-11-23T17:43:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDAzODU1OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDAzOTY3OA==", "url": "https://github.com/opensearch-project/security/pull/818#discussion_r520039678", "bodyText": "Do include test for empty password but fix request instead of response for the tests as they are asserting updating other attributes", "author": "sujithvm", "createdAt": "2020-11-09T18:50:48Z", "path": "src/test/java/com/amazon/opendistroforelasticsearch/security/dlic/rest/api/UserApiTest.java", "diffHunk": "@@ -448,7 +449,7 @@ public void testPasswordRules() throws Exception {\n         Assert.assertTrue(response.getBody().contains(\"xxx\"));\n \n         response = rh.executePutRequest(\"/_opendistro/_security/api/internalusers/ok1\", \"{\\\"backend_roles\\\":[\\\"my-backend-role\\\"],\\\"attributes\\\":{},\\\"password\\\":\\\"\\\"}\", new Header[0]);\n-        Assert.assertEquals(HttpStatus.SC_OK, response.getStatusCode());\n+        Assert.assertEquals(HttpStatus.SC_BAD_REQUEST, response.getStatusCode());", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDIwNDM0OQ==", "url": "https://github.com/opensearch-project/security/pull/818#discussion_r520204349", "bodyText": "Fixed the response for expected behavior change and kept the original test case below.", "author": "cliu123", "createdAt": "2020-11-10T00:18:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDAzOTY3OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDA0MDIzOQ==", "url": "https://github.com/opensearch-project/security/pull/818#discussion_r520040239", "bodyText": "Why is this bad request ? it is updating read only user and password field is not present", "author": "sujithvm", "createdAt": "2020-11-09T18:51:43Z", "path": "src/test/java/com/amazon/opendistroforelasticsearch/security/dlic/rest/api/UserApiTest.java", "diffHunk": "@@ -534,7 +535,7 @@ public void testUserApiForNonSuperAdmin() throws Exception {\n \n         // Put read only users\n         response = rh.executePutRequest(\"/_opendistro/_security/api/internalusers/sarek\", \"[{ \\\"op\\\": \\\"add\\\", \\\"path\\\": \\\"/sarek/description\\\", \\\"value\\\": \\\"foo\\\" }]\", new Header[0]);\n-        Assert.assertEquals(HttpStatus.SC_FORBIDDEN, response.getStatusCode());\n+        Assert.assertEquals(HttpStatus.SC_BAD_REQUEST, response.getStatusCode());", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDA1ODMzMA==", "url": "https://github.com/opensearch-project/security/pull/818#discussion_r520058330", "bodyText": "Moving Line 56 - 57 down causes NotXContentException on Line 61. The method validate() still returns false for this use case, but the response throws bad request instead of forbidden. XContentHelper.convertToMap() somehow has dependencies on regex, which causes password indirectly dependent on regex, since password originates from XContentHelper.convertToMap().\nIt's fairly easy to verify this. If you comment out the line 56 - 57 and run this test, line 61 will throw out a NotXContentException", "author": "cliu123", "createdAt": "2020-11-09T19:14:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDA0MDIzOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODg4NDExNQ==", "url": "https://github.com/opensearch-project/security/pull/818#discussion_r528884115", "bodyText": "Fixed the test.", "author": "cliu123", "createdAt": "2020-11-23T17:41:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDA0MDIzOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDA0MDk0Mg==", "url": "https://github.com/opensearch-project/security/pull/818#discussion_r520040942", "bodyText": "Why is this bad request ? it is updating reserved user and password field is not present", "author": "sujithvm", "createdAt": "2020-11-09T18:52:56Z", "path": "src/test/java/com/amazon/opendistroforelasticsearch/security/dlic/rest/api/UserApiTest.java", "diffHunk": "@@ -554,7 +555,7 @@ public void testUserApiForNonSuperAdmin() throws Exception {\n \n         // Put hidden users\n         response = rh.executePutRequest(\"/_opendistro/_security/api/internalusers/hide\", \"[{ \\\"op\\\": \\\"add\\\", \\\"path\\\": \\\"/sarek/description\\\", \\\"value\\\": \\\"foo\\\" }]\", new Header[0]);\n-        Assert.assertEquals(HttpStatus.SC_NOT_FOUND, response.getStatusCode());\n+        Assert.assertEquals(HttpStatus.SC_BAD_REQUEST, response.getStatusCode());", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDA1ODcxMw==", "url": "https://github.com/opensearch-project/security/pull/818#discussion_r520058713", "bodyText": "Ditto", "author": "cliu123", "createdAt": "2020-11-09T19:15:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDA0MDk0Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODg4MzkzNw==", "url": "https://github.com/opensearch-project/security/pull/818#discussion_r528883937", "bodyText": "Fixed the test.", "author": "cliu123", "createdAt": "2020-11-23T17:41:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDA0MDk0Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDA0Mzc3MA==", "url": "https://github.com/opensearch-project/security/pull/818#discussion_r520043770", "bodyText": "nit: Use isNullOrEmpty", "author": "sujithvm", "createdAt": "2020-11-09T18:57:26Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/dlic/rest/validation/CredentialsValidator.java", "diffHunk": "@@ -53,39 +53,45 @@ public boolean validate() {\n         final String regex = this.esSettings.get(ConfigConstants.OPENDISTRO_SECURITY_RESTAPI_PASSWORD_VALIDATION_REGEX, null);\n \n         if ((request.method() == RestRequest.Method.PUT || request.method() == RestRequest.Method.PATCH)\n-                && regex != null\n-                && !regex.isEmpty()\n                 && this.content != null\n                 && this.content.length() > 1) {\n             try {\n                 final Map<String, Object> contentAsMap = XContentHelper.convertToMap(this.content, false, XContentType.JSON).v2();\n                 if (contentAsMap != null && contentAsMap.containsKey(\"password\")) {\n                     final String password = (String) contentAsMap.get(\"password\");\n \n-                    // Password can be null/empty for an existing user. Regex will validate password if present\n-                    if (password != null && !password.isEmpty() && !regex.isEmpty() && !Pattern.compile(\"^\"+regex+\"$\").matcher(password).matches()) {\n-                        if(log.isDebugEnabled()) {\n-                            log.debug(\"Regex does not match password\");\n-                        }\n+                    // Password is not allowed to be empty if present.\n+                    if (password != null && password.isEmpty()) {", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDE4NjQxNA==", "url": "https://github.com/opensearch-project/security/pull/818#discussion_r520186414", "bodyText": "isNullOrEmpty is equivalent to password == null || password.isEmpty(), but I thought what we want to is password != null && password.isEmpty(). We want to cover only the empty password scenario in this PR.", "author": "cliu123", "createdAt": "2020-11-09T23:28:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDA0Mzc3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDIxMjY4MQ==", "url": "https://github.com/opensearch-project/security/pull/818#discussion_r520212681", "bodyText": "I was referring to regex null or empty but looks like that line of code got removed in this code revision", "author": "sujithvm", "createdAt": "2020-11-10T00:43:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDA0Mzc3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDk2MTg2NA==", "url": "https://github.com/opensearch-project/security/pull/818#discussion_r520961864", "bodyText": "nit: Use isNullOrEmpty\n\nDone", "author": "cliu123", "createdAt": "2020-11-11T00:32:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDA0Mzc3MA=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDIxNjMxNQ==", "url": "https://github.com/opensearch-project/security/pull/818#discussion_r520216315", "bodyText": "Is the empty password checked only if regex is configured ? I see lines L56-57 inserted back in.\n&& regex != null\n&& !regex.isEmpty()", "author": "sujithvm", "createdAt": "2020-11-10T00:54:45Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/dlic/rest/validation/CredentialsValidator.java", "diffHunk": "@@ -62,8 +62,14 @@ public boolean validate() {\n                 if (contentAsMap != null && contentAsMap.containsKey(\"password\")) {\n                     final String password = (String) contentAsMap.get(\"password\");\n \n+                    // Password is not allowed to be empty if present.\n+                    if (password != null && password.isEmpty()) {", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDIxOTA1NA==", "url": "https://github.com/opensearch-project/security/pull/818#discussion_r520219054", "bodyText": "Yes, XContentHelper.convertToMap() has dependencies on regex != null && !regex.isEmpty(). Without Line 56-57, it throws out NotXContentException and makes the validate() return a false, and a bad request gets responded eventually.\nBased on current behavior, the logic validates password only when regex != null && !regex.isEmpty(). Unless the opendistro_security.restapi.password_validation_regex is specified in ES settings, the password is not validated.", "author": "cliu123", "createdAt": "2020-11-10T01:02:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDIxNjMxNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDIyOTI2MQ==", "url": "https://github.com/opensearch-project/security/pull/818#discussion_r520229261", "bodyText": "Could you explain the dependency of XContentHelper.convertToMap() on regex and why it is throwing NotXContentException  ?\nWe would still allow users to use empty passwords unless users specify regex. Why do we want this behavior instead of rejecting empty passwords for all scenarios.", "author": "sujithvm", "createdAt": "2020-11-10T01:32:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDIxNjMxNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDIzMzEyMA==", "url": "https://github.com/opensearch-project/security/pull/818#discussion_r520233120", "bodyText": "There is an easy way to verify the dependencies. If you comment out the line 56 - 57 on master branch and run UserApiTest.testUserApiForNonSuperAdmin(), this test will get a bad response instead of a forbidden. If you check the log, you'll see the NotXContentException thrown out from the line of XContentHelper.convertToMap().\nGiven the dependencies, we might have to reject empty password in InternalUsersApiAction and all other ApiActions where empty password should be rejected if we want to reject it for all scenarios.", "author": "cliu123", "createdAt": "2020-11-10T01:45:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDIxNjMxNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDM3NTA2OQ==", "url": "https://github.com/opensearch-project/security/pull/818#discussion_r520375069", "bodyText": "Are you saying the test/code needs to be fixed? If yes, please fix as needed.\nXContentHelper.convertToMap() is an elasticsearch function. I don't see how it can be dependent on the regex configuration of the security plugin", "author": "sujithvm", "createdAt": "2020-11-10T08:29:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDIxNjMxNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDc4MDI1NA==", "url": "https://github.com/opensearch-project/security/pull/818#discussion_r520780254", "bodyText": "It's not dependent on the regex configuation. XContentHelper.convertToMap() cannot map XContent correctly when XContent content contains a null field.", "author": "cliu123", "createdAt": "2020-11-10T18:31:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDIxNjMxNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDgyNTk2MA==", "url": "https://github.com/opensearch-project/security/pull/818#discussion_r520825960", "bodyText": "Regex is not part of content hence it cannot interfere with XContentHelper.convertToMap()", "author": "sujithvm", "createdAt": "2020-11-10T19:38:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDIxNjMxNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDgzMjk3Mw==", "url": "https://github.com/opensearch-project/security/pull/818#discussion_r520832973", "bodyText": "It is converting array PATCH array body with PUT request in the test testUserApiForNonSuperAdmin and is failing to convert array into map. Need to fix the tests", "author": "sujithvm", "createdAt": "2020-11-10T19:50:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDIxNjMxNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDg0NjYwMA==", "url": "https://github.com/opensearch-project/security/pull/818#discussion_r520846600", "bodyText": "Ok. That's the culprit. I fixed it and moved the validation to cover all scenarios.", "author": "cliu123", "createdAt": "2020-11-10T20:14:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDIxNjMxNQ=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTA5MDk4Ng==", "url": "https://github.com/opensearch-project/security/pull/818#discussion_r529090986", "bodyText": "Can password be null here?\nMaybe check for password is not null directly in the contentAsMap as these conditions are based on non-null password entry validation", "author": "sujithvm", "createdAt": "2020-11-24T00:49:34Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/dlic/rest/validation/CredentialsValidator.java", "diffHunk": "@@ -53,39 +54,45 @@ public boolean validate() {\n         final String regex = this.esSettings.get(ConfigConstants.OPENDISTRO_SECURITY_RESTAPI_PASSWORD_VALIDATION_REGEX, null);\n \n         if ((request.method() == RestRequest.Method.PUT || request.method() == RestRequest.Method.PATCH)\n-                && regex != null\n-                && !regex.isEmpty()\n                 && this.content != null\n                 && this.content.length() > 1) {\n             try {\n                 final Map<String, Object> contentAsMap = XContentHelper.convertToMap(this.content, false, XContentType.JSON).v2();\n                 if (contentAsMap != null && contentAsMap.containsKey(\"password\")) {\n                     final String password = (String) contentAsMap.get(\"password\");\n \n-                    // Password can be null/empty for an existing user. Regex will validate password if present\n-                    if (password != null && !password.isEmpty() && !regex.isEmpty() && !Pattern.compile(\"^\"+regex+\"$\").matcher(password).matches()) {\n-                        if(log.isDebugEnabled()) {\n-                            log.debug(\"Regex does not match password\");\n-                        }\n+                    // Password is not allowed to be empty if present.\n+                    if (password != null && password.isEmpty()) {\n                         this.errorType = ErrorType.INVALID_PASSWORD;\n                         return false;\n                     }\n \n-                    final String username = Utils.coalesce(request.param(\"name\"), hasParams() ? (String) param[0] : null);\n+                    if (!Strings.isNullOrEmpty(regex)) {\n+                        // Password can be null for an existing user. Regex will validate password if present\n+                        if (password != null && !Pattern.compile(\"^\"+regex+\"$\").matcher(password).matches()) {\n+                            if(log.isDebugEnabled()) {\n+                                log.debug(\"Regex does not match password\");\n+                            }\n+                            this.errorType = ErrorType.INVALID_PASSWORD;\n+                            return false;\n+                        }\n+\n+                        final String username = Utils.coalesce(request.param(\"name\"), hasParams() ? (String) param[0] : null);\n \n-                    if (username == null || username.isEmpty()) {\n-                        if (log.isDebugEnabled()) {\n-                            log.debug(\"Unable to validate username because no user is given\");\n+                        if (username == null || username.isEmpty()) {\n+                            if (log.isDebugEnabled()) {\n+                                log.debug(\"Unable to validate username because no user is given\");\n+                            }\n+                            return false;\n                         }\n-                        return false;\n-                    }\n \n-                    if (username.toLowerCase().equals(password.toLowerCase())) {\n-                        if (log.isDebugEnabled()) {\n-                            log.debug(\"Username must not match password\");\n+                        if (username.toLowerCase().equals(password.toLowerCase())) {", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTA5MjI3Mg==", "url": "https://github.com/opensearch-project/security/pull/818#discussion_r529092272", "bodyText": "Also not dependent on regex but it is inside Strings.isNullOrEmpty(regex) block? I understand the current behavior validates password against username only if regex is defined. Just looking for improvements here. Any thoughts?", "author": "sujithvm", "createdAt": "2020-11-24T00:53:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTA5MDk4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTA5OTczMA==", "url": "https://github.com/opensearch-project/security/pull/818#discussion_r529099730", "bodyText": "Yes, I thought about that too. In theory, password has nothing to do with regex. I feel like there're some potential points/use cases to validate password against username no matter regex is null/empty or not and refactoring could be needed here. It's worth to discuss with the team and to get more inputs.", "author": "cliu123", "createdAt": "2020-11-24T01:16:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTA5MDk4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTE0Nzg0Nw==", "url": "https://github.com/opensearch-project/security/pull/818#discussion_r529147847", "bodyText": "Can we address in this PR itself as change is happening around it", "author": "sujithvm", "createdAt": "2020-11-24T02:21:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTA5MDk4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTIxMjY3NA==", "url": "https://github.com/opensearch-project/security/pull/818#discussion_r529212674", "bodyText": "I'll create another PR to make this change given that this PR has been sitting there for more than 3 weeks and it has met the goal. Let's stick with the original scope of PRs.", "author": "cliu123", "createdAt": "2020-11-24T05:31:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTA5MDk4Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTc4MDYyOA==", "url": "https://github.com/opensearch-project/security/pull/818#discussion_r529780628", "bodyText": "Under what condition password will be null here? It is executed with contentAsMap.containsKey(\"password\") condition.", "author": "vrozov", "createdAt": "2020-11-24T18:11:41Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/dlic/rest/validation/CredentialsValidator.java", "diffHunk": "@@ -53,39 +54,45 @@ public boolean validate() {\n         final String regex = this.esSettings.get(ConfigConstants.OPENDISTRO_SECURITY_RESTAPI_PASSWORD_VALIDATION_REGEX, null);\n \n         if ((request.method() == RestRequest.Method.PUT || request.method() == RestRequest.Method.PATCH)\n-                && regex != null\n-                && !regex.isEmpty()\n                 && this.content != null\n                 && this.content.length() > 1) {\n             try {\n                 final Map<String, Object> contentAsMap = XContentHelper.convertToMap(this.content, false, XContentType.JSON).v2();\n                 if (contentAsMap != null && contentAsMap.containsKey(\"password\")) {\n                     final String password = (String) contentAsMap.get(\"password\");\n \n-                    // Password can be null/empty for an existing user. Regex will validate password if present\n-                    if (password != null && !password.isEmpty() && !regex.isEmpty() && !Pattern.compile(\"^\"+regex+\"$\").matcher(password).matches()) {\n-                        if(log.isDebugEnabled()) {\n-                            log.debug(\"Regex does not match password\");\n-                        }\n+                    // Password is not allowed to be empty if present.\n+                    if (password != null && password.isEmpty()) {", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTc4MzEyMw==", "url": "https://github.com/opensearch-project/security/pull/818#discussion_r529783123", "bodyText": "In theory, contentAsMap.containsKey() prevents null password. But before checking isEmpty(), it will be safer to ensure the object \"password\" is not null.", "author": "cliu123", "createdAt": "2020-11-24T18:15:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTc4MDYyOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTkwNjg5Mg==", "url": "https://github.com/opensearch-project/security/pull/818#discussion_r529906892", "bodyText": "I don't see why two checks are necessary. The check if (contentAsMap != null && contentAsMap.containsKey(\"password\")) looks redundant to me.", "author": "vrozov", "createdAt": "2020-11-24T21:55:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTc4MDYyOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDEzMTUxMg==", "url": "https://github.com/opensearch-project/security/pull/818#discussion_r530131512", "bodyText": "If contentAsMap is null or password field doesn't exist, there's no need to validate password at all.", "author": "cliu123", "createdAt": "2020-11-25T06:19:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTc4MDYyOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDY2Mjc4MA==", "url": "https://github.com/opensearch-project/security/pull/818#discussion_r530662780", "bodyText": "How contentAsMap can be null? Does not check password != null supersede contentAsMap.containsKey(\"password\")?", "author": "vrozov", "createdAt": "2020-11-25T21:58:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTc4MDYyOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDcyMDY0MA==", "url": "https://github.com/opensearch-project/security/pull/818#discussion_r530720640", "bodyText": "I removed password != null.", "author": "cliu123", "createdAt": "2020-11-26T01:21:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTc4MDYyOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjM1MzM5OA==", "url": "https://github.com/opensearch-project/security/pull/818#discussion_r532353398", "bodyText": "Will it be better to remove contentAsMap != null && contentAsMap.containsKey(\"password\")?", "author": "vrozov", "createdAt": "2020-11-30T05:21:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTc4MDYyOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjM1NjE4NQ==", "url": "https://github.com/opensearch-project/security/pull/818#discussion_r532356185", "bodyText": "If removing contentAsMap != null && contentAsMap.containsKey(\"password\"), we'd need to keep if (password != null && password.isEmpty()) { at Line 65 and add one more condition password != null at Line 89. Will this look better? If so, I'll update it.", "author": "cliu123", "createdAt": "2020-11-30T05:32:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTc4MDYyOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjg0ODI1MQ==", "url": "https://github.com/opensearch-project/security/pull/818#discussion_r532848251", "bodyText": "Replace contentAsMap != null && contentAsMap.containsKey(\"password\") with\nString password = contentAsMap.get(\"password\");\nif (password != null) {", "author": "vrozov", "createdAt": "2020-11-30T19:34:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTc4MDYyOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjg1MzY5Mg==", "url": "https://github.com/opensearch-project/security/pull/818#discussion_r532853692", "bodyText": "Ok. That prevents null password and we're good to remove all null password checks after it. I've made the change.", "author": "cliu123", "createdAt": "2020-11-30T19:43:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTc4MDYyOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTkxMjQ2Mw==", "url": "https://github.com/opensearch-project/security/pull/818#discussion_r529912463", "bodyText": "Is there a test that adds user with empty password and no hash?", "author": "vrozov", "createdAt": "2020-11-24T22:00:36Z", "path": "src/test/java/com/amazon/opendistroforelasticsearch/security/dlic/rest/api/UserApiTest.java", "diffHunk": "@@ -410,6 +410,7 @@ public void testPasswordRules() throws Exception {\n         addUserWithPassword(\"ok2\", \"$aA123456789\", HttpStatus.SC_CREATED);\n         addUserWithPassword(\"ok3\", \"$Aa123456789\", HttpStatus.SC_CREATED);\n         addUserWithPassword(\"ok4\", \"$1aAAAAAAAAA\", HttpStatus.SC_CREATED);\n+        addUserWithPasswordAndHash(\"empty_password\", \"\", \"$%^123\", HttpStatus.SC_BAD_REQUEST);", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTk3NjgzNQ==", "url": "https://github.com/opensearch-project/security/pull/818#discussion_r529976835", "bodyText": "Will be also good to test request to create user with \"password\": null", "author": "vrozov", "createdAt": "2020-11-24T23:01:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTkxMjQ2Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDE0MDExNA==", "url": "https://github.com/opensearch-project/security/pull/818#discussion_r530140114", "bodyText": "Done.", "author": "cliu123", "createdAt": "2020-11-25T06:46:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTkxMjQ2Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTk0OTM2MQ==", "url": "https://github.com/opensearch-project/security/pull/818#discussion_r529949361", "bodyText": "The request creates new user. Please change it to update existing user \"ok1\".", "author": "vrozov", "createdAt": "2020-11-24T22:35:27Z", "path": "src/test/java/com/amazon/opendistroforelasticsearch/security/dlic/rest/api/UserApiTest.java", "diffHunk": "@@ -448,7 +449,10 @@ public void testPasswordRules() throws Exception {\n         Assert.assertTrue(response.getBody().contains(\"xxx\"));\n \n         response = rh.executePutRequest(\"/_opendistro/_security/api/internalusers/ok1\", \"{\\\"backend_roles\\\":[\\\"my-backend-role\\\"],\\\"attributes\\\":{},\\\"password\\\":\\\"\\\"}\", new Header[0]);\n-        Assert.assertEquals(HttpStatus.SC_OK, response.getStatusCode());\n+        Assert.assertEquals(HttpStatus.SC_BAD_REQUEST, response.getStatusCode());\n+\n+        response = rh.executePutRequest(\"/_opendistro/_security/api/internalusers/non-empty_password\", \"{\\\"backend_roles\\\":[\\\"my-backend-role\\\"],\\\"attributes\\\":{},\\\"password\\\":\\\"Admin_123\\\"}\", new Header[0]);", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDEzNDE3Ng==", "url": "https://github.com/opensearch-project/security/pull/818#discussion_r530134176", "bodyText": "This intends to test user creation. Line 451-452 is to test updating existing user.", "author": "cliu123", "createdAt": "2020-11-25T06:28:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTk0OTM2MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDcxNDE1MQ==", "url": "https://github.com/opensearch-project/security/pull/818#discussion_r530714151", "bodyText": "User creation is tested using addUserWithPassword(), how this test is different?", "author": "vrozov", "createdAt": "2020-11-26T00:56:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTk0OTM2MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDcyMDc0MQ==", "url": "https://github.com/opensearch-project/security/pull/818#discussion_r530720741", "bodyText": "I change it to update the existing user \"ok1\".", "author": "cliu123", "createdAt": "2020-11-26T01:21:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTk0OTM2MQ=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": "2ae06246984a48a0981e0f109b5d3e0486a6bbad", "url": "https://github.com/opensearch-project/security/commit/2ae06246984a48a0981e0f109b5d3e0486a6bbad", "message": "Reject empty password in internal user creation", "committedDate": "2020-11-30T19:42:25Z", "type": "commit"}, {"oid": "2ae06246984a48a0981e0f109b5d3e0486a6bbad", "url": "https://github.com/opensearch-project/security/commit/2ae06246984a48a0981e0f109b5d3e0486a6bbad", "message": "Reject empty password in internal user creation", "committedDate": "2020-11-30T19:42:25Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjkxNjEyNQ==", "url": "https://github.com/opensearch-project/security/pull/818#discussion_r532916125", "bodyText": "nit: use final same as original final String password = (String) contentAsMap.get(\"password\");", "author": "sujithvm", "createdAt": "2020-11-30T21:30:25Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/dlic/rest/validation/CredentialsValidator.java", "diffHunk": "@@ -53,39 +54,44 @@ public boolean validate() {\n         final String regex = this.esSettings.get(ConfigConstants.OPENDISTRO_SECURITY_RESTAPI_PASSWORD_VALIDATION_REGEX, null);\n \n         if ((request.method() == RestRequest.Method.PUT || request.method() == RestRequest.Method.PATCH)\n-                && regex != null\n-                && !regex.isEmpty()\n                 && this.content != null\n                 && this.content.length() > 1) {\n             try {\n                 final Map<String, Object> contentAsMap = XContentHelper.convertToMap(this.content, false, XContentType.JSON).v2();\n-                if (contentAsMap != null && contentAsMap.containsKey(\"password\")) {\n-                    final String password = (String) contentAsMap.get(\"password\");\n-\n-                    // Password can be null/empty for an existing user. Regex will validate password if present\n-                    if (password != null && !password.isEmpty() && !regex.isEmpty() && !Pattern.compile(\"^\"+regex+\"$\").matcher(password).matches()) {\n-                        if(log.isDebugEnabled()) {\n-                            log.debug(\"Regex does not match password\");\n-                        }\n+                String password = (String) contentAsMap.get(\"password\");", "originalCommit": "2ae06246984a48a0981e0f109b5d3e0486a6bbad", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjkxNjM2MA==", "url": "https://github.com/opensearch-project/security/pull/818#discussion_r532916360", "bodyText": "Can contentAsMap be null? I see the null check is removed", "author": "sujithvm", "createdAt": "2020-11-30T21:30:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjkxNjEyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjkyNDU0OQ==", "url": "https://github.com/opensearch-project/security/pull/818#discussion_r532924549", "bodyText": "final Map<String, Object> contentAsMap = XContentHelper.convertToMap(this.content, false, XContentType.JSON).v2(); prevents null contentAsMap.", "author": "cliu123", "createdAt": "2020-11-30T21:47:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjkxNjEyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjkyNjA0Nw==", "url": "https://github.com/opensearch-project/security/pull/818#discussion_r532926047", "bodyText": "Does prevents null mean it throws null pointer exception or returns empty map?", "author": "sujithvm", "createdAt": "2020-11-30T21:50:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjkxNjEyNQ=="}], "type": "inlineReview"}]}