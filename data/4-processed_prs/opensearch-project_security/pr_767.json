{"pr_number": 767, "pr_title": "Change CD workflow to use new staging bucket for artifacts", "pr_createdAt": "2020-10-13T20:31:44Z", "pr_url": "https://github.com/opensearch-project/security/pull/767", "timeline": [{"oid": "d18e24487701e92011c1026bf1bf1eb10041769e", "url": "https://github.com/opensearch-project/security/commit/d18e24487701e92011c1026bf1bf1eb10041769e", "message": "Change CD workflow to use new staging bucket for artifacts", "committedDate": "2020-10-13T20:30:59Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDI4MzUxMA==", "url": "https://github.com/opensearch-project/security/pull/767#discussion_r504283510", "bodyText": "Will it be better to modify pom.xml and build.gradle to produce output files in the required format by passing ${GITHUB_RUN_NUMBER}?", "author": "vrozov", "createdAt": "2020-10-13T22:00:47Z", "path": ".github/workflows/cd.yml", "diffHunk": "@@ -50,11 +50,25 @@ jobs:\n \n     - name: Upload Artifacts to S3\n       run: |\n-        s3_path=s3://artifacts.opendistroforelasticsearch.amazon.com/downloads\n-        aws s3 cp artifacts/*.zip $s3_path/elasticsearch-plugins/opendistro-security/\n-        aws s3 cp artifacts/*.deb $s3_path/debs/opendistro-security/\n-        aws s3 cp artifacts/*.rpm $s3_path/rpms/opendistro-security/\n-        aws cloudfront create-invalidation --distribution-id ${{ secrets.DISTRIBUTION_ID }} --paths '/downloads/*'\n+        zip=`ls artifacts/*.zip`\n+        rpm=`ls artifacts/*.rpm`\n+        deb=`ls artifacts/*.deb`\n+\n+        # Inject the build number before the suffix\n+        zip_outfile=`basename ${zip%.zip}-build-${GITHUB_RUN_NUMBER}.zip`", "originalCommit": "d18e24487701e92011c1026bf1bf1eb10041769e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDI5MDM3OQ==", "url": "https://github.com/opensearch-project/security/pull/767#discussion_r504290379", "bodyText": "I would not modify those, because it would also change the names of the artifacts that go into Sonatype and the Github release. I think those artifacts do not want the build number.", "author": "camerski", "createdAt": "2020-10-13T22:17:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDI4MzUxMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDgyNTY5Ng==", "url": "https://github.com/opensearch-project/security/pull/767#discussion_r504825696", "bodyText": "Instead of github build number, can we use commit sha? This will allow us to build the same artifact if necessary.", "author": "vrozov", "createdAt": "2020-10-14T16:47:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDI4MzUxMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDkxNjc0MQ==", "url": "https://github.com/opensearch-project/security/pull/767#discussion_r504916741", "bodyText": "That's an option, but it makes it harder for us to know what the latest build is. The GITHUB_RUN_NUMBER increases monotonically, which makes figuring out what to promote to production easier. If you feel strongly then I'm happy to change it - the release process doesn't rely on human-readable names (or, at least, won't rely on those names soon).", "author": "camerski", "createdAt": "2020-10-14T19:22:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDI4MzUxMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDk1MzA1Ng==", "url": "https://github.com/opensearch-project/security/pull/767#discussion_r504953056", "bodyText": "This will give us an option to trigger CD workflow without impacting infra build for example when we tag release candidate commit with the final release tag.", "author": "vrozov", "createdAt": "2020-10-14T20:29:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDI4MzUxMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDk2NDYxMg==", "url": "https://github.com/opensearch-project/security/pull/767#discussion_r504964612", "bodyText": "The GITHUB_RUN_NUMBER also ensures that you will not impact the infra build.", "author": "camerski", "createdAt": "2020-10-14T20:51:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDI4MzUxMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDk2NTQ3NA==", "url": "https://github.com/opensearch-project/security/pull/767#discussion_r504965474", "bodyText": "In the interests of getting this unblocked, would you be OK with shipping this change as-is, and if we need to come back and change it to a hash then we can do that after the next release? This isn't a one-way door.", "author": "camerski", "createdAt": "2020-10-14T20:53:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDI4MzUxMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDk3NzIyOQ==", "url": "https://github.com/opensearch-project/security/pull/767#discussion_r504977229", "bodyText": "It is not so much important for me whether it is commit hash or github build number as long as I can re-run CD workflow on the same commit without impacting/confusing infra build. In case github build number will be incremented each time CD build runs, will not that cause confusion whether it is the same artifact as already published or a new artifact?", "author": "vrozov", "createdAt": "2020-10-14T21:17:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDI4MzUxMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDk4ODA4Ng==", "url": "https://github.com/opensearch-project/security/pull/767#discussion_r504988086", "bodyText": "That's OK, it will not cause any confusion. Once we select, say, build-15 as the version that goes into the next ODFE then that is locked in. If build-16 is identical then that's OK - we don't care. Once the release train has departed then there are no more changes :)", "author": "camerski", "createdAt": "2020-10-14T21:40:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDI4MzUxMA=="}], "type": "inlineReview"}]}