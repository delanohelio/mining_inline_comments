{"pr_number": 303, "pr_title": "AuditLog: Refactor to use thread pool config", "pr_createdAt": "2020-03-20T16:51:52Z", "pr_url": "https://github.com/opensearch-project/security/pull/303", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTg5OTQ0Nw==", "url": "https://github.com/opensearch-project/security/pull/303#discussion_r395899447", "bodyText": "it is a simple math :), consider 100_000.", "author": "vrozov", "createdAt": "2020-03-20T21:32:24Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/auditlog/config/AsyncStoragePoolConfig.java", "diffHunk": "@@ -0,0 +1,40 @@\n+package com.amazon.opendistroforelasticsearch.security.auditlog.config;\n+\n+import com.amazon.opendistroforelasticsearch.security.support.ConfigConstants;\n+import org.elasticsearch.common.settings.Settings;\n+\n+public class AsyncStoragePoolConfig {\n+    private static final int DEFAULT_THREAD_POOL_SIZE = 10;\n+    private static final int DEFAULT_THREAD_POOL_MAX_QUEUE_LEN = 100 * 1000;", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTkwMTk1OA==", "url": "https://github.com/opensearch-project/security/pull/303#discussion_r395901958", "bodyText": "consider making constructor private.", "author": "vrozov", "createdAt": "2020-03-20T21:40:04Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/auditlog/config/AsyncStoragePoolConfig.java", "diffHunk": "@@ -0,0 +1,40 @@\n+package com.amazon.opendistroforelasticsearch.security.auditlog.config;\n+\n+import com.amazon.opendistroforelasticsearch.security.support.ConfigConstants;\n+import org.elasticsearch.common.settings.Settings;\n+\n+public class AsyncStoragePoolConfig {\n+    private static final int DEFAULT_THREAD_POOL_SIZE = 10;\n+    private static final int DEFAULT_THREAD_POOL_MAX_QUEUE_LEN = 100 * 1000;\n+\n+    private final int threadPoolSize;\n+    private final int threadPoolMaxQueueLen;\n+\n+    public AsyncStoragePoolConfig(int threadPoolSize, int threadPoolMaxQueueLen) {", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTkyMTQyNg==", "url": "https://github.com/opensearch-project/security/pull/303#discussion_r395921426", "bodyText": "Public constructor is not needed for this PR but it will be made public soon in upcoming PRs as config will no longer be generated from Settings.", "author": "sujithvm", "createdAt": "2020-03-20T22:45:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTkwMTk1OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTkwMzYxOQ==", "url": "https://github.com/opensearch-project/security/pull/303#discussion_r395903619", "bodyText": "Is it a common practice to use a default value for an invalid setting? Can you point me how it is handled in other places? I would prefer at least a warning message or better an exception.", "author": "vrozov", "createdAt": "2020-03-20T21:45:10Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/auditlog/config/AsyncStoragePoolConfig.java", "diffHunk": "@@ -0,0 +1,40 @@\n+package com.amazon.opendistroforelasticsearch.security.auditlog.config;\n+\n+import com.amazon.opendistroforelasticsearch.security.support.ConfigConstants;\n+import org.elasticsearch.common.settings.Settings;\n+\n+public class AsyncStoragePoolConfig {\n+    private static final int DEFAULT_THREAD_POOL_SIZE = 10;\n+    private static final int DEFAULT_THREAD_POOL_MAX_QUEUE_LEN = 100 * 1000;\n+\n+    private final int threadPoolSize;\n+    private final int threadPoolMaxQueueLen;\n+\n+    public AsyncStoragePoolConfig(int threadPoolSize, int threadPoolMaxQueueLen) {\n+        if (threadPoolSize <= 0) {", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTkyMTkxMg==", "url": "https://github.com/opensearch-project/security/pull/303#discussion_r395921912", "bodyText": "I believe it is a very common practice?\nCreating a thread pool with negative value will complain and we can go two ways from there:\n\nComplain and crash the process\nUse default values.\n\nI will log a warning for this case.", "author": "sujithvm", "createdAt": "2020-03-20T22:48:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTkwMzYxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTkzMTQzNQ==", "url": "https://github.com/opensearch-project/security/pull/303#discussion_r395931435", "bodyText": "My take is to complain (log error) and crash. IMO, silently switching to a default value will cause confusion. Logging a warning may go unnoticed.", "author": "vrozov", "createdAt": "2020-03-20T23:31:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTkwMzYxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTkzNTA5NA==", "url": "https://github.com/opensearch-project/security/pull/303#discussion_r395935094", "bodyText": "I m slightly not sure if we should throw an exception and make it crash.\n\nReading from elasticsearch settings asks for a default value if not configured.\nUsers who don't care to make a specific config setting, this will crash for them too instead of relying on defaults.\nThis would make thread pool setting mandatory (may need to consult product and update docs).", "author": "sujithvm", "createdAt": "2020-03-20T23:49:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTkwMzYxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTkzNjc4OA==", "url": "https://github.com/opensearch-project/security/pull/303#discussion_r395936788", "bodyText": "If one of the settings is not present it needs to be replaced with a default value, there should not be any crash. In case an invalid value is passed to the constructor, it should be OK to throw an exception and fail to construct AsyncStoragePoolConfig object.", "author": "vrozov", "createdAt": "2020-03-20T23:58:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTkwMzYxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTk0MTYwMQ==", "url": "https://github.com/opensearch-project/security/pull/303#discussion_r395941601", "bodyText": "Alright", "author": "sujithvm", "createdAt": "2020-03-21T00:29:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTkwMzYxOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTkwMzc5OQ==", "url": "https://github.com/opensearch-project/security/pull/303#discussion_r395903799", "bodyText": "The same as threadPoolSize.", "author": "vrozov", "createdAt": "2020-03-20T21:45:39Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/auditlog/config/AsyncStoragePoolConfig.java", "diffHunk": "@@ -0,0 +1,40 @@\n+package com.amazon.opendistroforelasticsearch.security.auditlog.config;\n+\n+import com.amazon.opendistroforelasticsearch.security.support.ConfigConstants;\n+import org.elasticsearch.common.settings.Settings;\n+\n+public class AsyncStoragePoolConfig {\n+    private static final int DEFAULT_THREAD_POOL_SIZE = 10;\n+    private static final int DEFAULT_THREAD_POOL_MAX_QUEUE_LEN = 100 * 1000;\n+\n+    private final int threadPoolSize;\n+    private final int threadPoolMaxQueueLen;\n+\n+    public AsyncStoragePoolConfig(int threadPoolSize, int threadPoolMaxQueueLen) {\n+        if (threadPoolSize <= 0) {\n+            threadPoolSize = DEFAULT_THREAD_POOL_SIZE;\n+        }\n+\n+        if (threadPoolMaxQueueLen <= 0) {", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTkyMTkzNw==", "url": "https://github.com/opensearch-project/security/pull/303#discussion_r395921937", "bodyText": "Same as above", "author": "sujithvm", "createdAt": "2020-03-20T22:48:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTkwMzc5OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTkxMzc4Mw==", "url": "https://github.com/opensearch-project/security/pull/303#discussion_r395913783", "bodyText": "Will this class be used outside of AsyncStoragePool? The current usage is limited to AsyncStoragePool, why not to make it static inside AsyncStoragePool?", "author": "vrozov", "createdAt": "2020-03-20T22:18:31Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/auditlog/config/AsyncStoragePoolConfig.java", "diffHunk": "@@ -0,0 +1,40 @@\n+package com.amazon.opendistroforelasticsearch.security.auditlog.config;\n+\n+import com.amazon.opendistroforelasticsearch.security.support.ConfigConstants;\n+import org.elasticsearch.common.settings.Settings;\n+\n+public class AsyncStoragePoolConfig {", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTkzNDE2Mw==", "url": "https://github.com/opensearch-project/security/pull/303#discussion_r395934163", "bodyText": "Yes. It will be used outside AsyncStoragePool to notify config changes. Moreover having it as static inner class will make outer class dependent on inner class. Eg: AsyncStoragePool constructor accepting inner class AsyncStoragePoolConfig dependency.", "author": "sujithvm", "createdAt": "2020-03-20T23:44:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTkxMzc4Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTkzOTg3NQ==", "url": "https://github.com/opensearch-project/security/pull/303#discussion_r395939875", "bodyText": "Will it only notify AsyncStoragePool about config changes? The class name AsyncStoragePoolConfig  suggests that it is specific to AsyncStoragePool and can't be used with other thread pools. In this case, I don't see anything wrong with making it more explicit and making AsyncStoragePool constructor accept an instance of an inner static class. It is simply a way to organize naming.", "author": "vrozov", "createdAt": "2020-03-21T00:16:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTkxMzc4Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTk0MzI0Ng==", "url": "https://github.com/opensearch-project/security/pull/303#discussion_r395943246", "bodyText": "I will rename it to ThreadPoolConfig to make it more generic if we want to use config for other thread pools.", "author": "sujithvm", "createdAt": "2020-03-21T00:41:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTkxMzc4Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTkxNjM0NA==", "url": "https://github.com/opensearch-project/security/pull/303#discussion_r395916344", "bodyText": "Not sure why this method is necessary, can't it be inlined in the constructor?", "author": "vrozov", "createdAt": "2020-03-20T22:27:16Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/auditlog/routing/AsyncStoragePool.java", "diffHunk": "@@ -72,11 +59,18 @@ public void submit(AuditMessage message, AuditLogSink sink) {\n \t\t}\n \t}\n \n-\tprivate ThreadPoolExecutor createExecutor(final int threadPoolSize, final int maxQueueLen) {\n+\tprivate ThreadPoolExecutor createExecutor(final AsyncStoragePoolConfig config) {", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTkyMjQwOQ==", "url": "https://github.com/opensearch-project/security/pull/303#discussion_r395922409", "bodyText": "This class will be subscribed to a config listener in future PR which will update for any config changes which will call this function again. Hence moved it to be passed in a method.", "author": "sujithvm", "createdAt": "2020-03-20T22:50:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTkxNjM0NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTk0MTU0NQ==", "url": "https://github.com/opensearch-project/security/pull/303#discussion_r395941545", "bodyText": "To support config changes, it would be necessary to properly handle existing pool shutdown and creation of a new thread pool. What if there are pending tasks to execute? What if a running task takes too long to complete? This method is likely to require significant refactoring and new functionality before it can support config change.", "author": "vrozov", "createdAt": "2020-03-21T00:28:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTkxNjM0NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTk0MjkxMw==", "url": "https://github.com/opensearch-project/security/pull/303#discussion_r395942913", "bodyText": "Thread pool size can be dynamically changed. However dynamically changing the queue length will be more challenging as the current queue must depleted as LinkedBlockingQueue size cant be changed once initialized. For sure it will need more work.\nThis PR just cleans up exisiting code.", "author": "sujithvm", "createdAt": "2020-03-21T00:38:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTkxNjM0NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTk0OTY0Mg==", "url": "https://github.com/opensearch-project/security/pull/303#discussion_r395949642", "bodyText": "Please clarify, if you want to create another Executor on configuration change, it would be necessary to deal with the issues I mentioned. If configuration change will modify an existing Executor, this function can't be reused as it creates new instance of ThreadPoolExecutor. I'd recommend to inline the function, especially that it looks like it was supposed to be static (it takes member variable config as an argument), but also requires access to log that is not static.", "author": "vrozov", "createdAt": "2020-03-21T01:44:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTkxNjM0NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTk2MzA4MQ==", "url": "https://github.com/opensearch-project/security/pull/303#discussion_r395963081", "bodyText": "I was answering your concern of handling existing thread pool when there is a config change. I passed this as a param because createExecutor looked like a candidate that can be made separate. I will make this static.", "author": "sujithvm", "createdAt": "2020-03-21T05:17:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTkxNjM0NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTkxNzU5Mw==", "url": "https://github.com/opensearch-project/security/pull/303#discussion_r395917593", "bodyText": "Should this test be moved to RoutingConfigurationTest?", "author": "vrozov", "createdAt": "2020-03-20T22:31:21Z", "path": "src/test/java/com/amazon/opendistroforelasticsearch/security/auditlog/routing/ThreadPoolSettingsTest.java", "diffHunk": "@@ -15,21 +15,21 @@\n \n package com.amazon.opendistroforelasticsearch.security.auditlog.routing;\n \n+import com.amazon.opendistroforelasticsearch.security.auditlog.AbstractAuditlogiUnitTest;\n+import com.amazon.opendistroforelasticsearch.security.auditlog.config.AsyncStoragePoolConfig;\n+import com.amazon.opendistroforelasticsearch.security.test.helper.file.FileHelper;\n import org.elasticsearch.common.settings.Settings;\n import org.junit.Assert;\n import org.junit.Test;\n \n-import com.amazon.opendistroforelasticsearch.security.auditlog.AbstractAuditlogiUnitTest;\n-import com.amazon.opendistroforelasticsearch.security.auditlog.routing.AuditMessageRouter;\n-import com.amazon.opendistroforelasticsearch.security.test.helper.file.FileHelper;\n-\n public class ThreadPoolSettingsTest extends AbstractAuditlogiUnitTest {\n \n-\t@Test\n-\tpublic void testNoMultipleEndpointsConfiguration() throws Exception {\n-\t\tSettings settings = Settings.builder().loadFromPath(FileHelper.getAbsoluteFilePathFromClassPath(\"auditlog/endpoints/sink/configuration_no_multiple_endpoints.yml\")).build();\n-\t\tAuditMessageRouter router = createMessageRouterComplianceEnabled(settings);\n-\t\tAssert.assertEquals(5, router.storagePool.threadPoolSize);\n-\t\tAssert.assertEquals(200000, router.storagePool.threadPoolMaxQueueLen);\n-\t}\n+    @Test\n+    public void testNoMultipleEndpointsConfiguration() throws Exception {", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTkxOTE2NQ==", "url": "https://github.com/opensearch-project/security/pull/303#discussion_r395919165", "bodyText": "Is it necessary to change the signature of the AsyncStoragePool constructor? Can it continue to accept Settings and create AsyncStoragePoolConfig inside?", "author": "vrozov", "createdAt": "2020-03-20T22:37:20Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/auditlog/routing/AuditMessageRouter.java", "diffHunk": "@@ -51,7 +52,7 @@\n \n \tpublic AuditMessageRouter(final Settings settings, final Client clientProvider, ThreadPool threadPool, final Path configPath) {\n \t\tthis.sinkProvider = new SinkProvider(settings, clientProvider, threadPool, configPath);\n-\t\tthis.storagePool = new AsyncStoragePool(settings);\n+\t\tthis.storagePool = new AsyncStoragePool(AsyncStoragePoolConfig.getConfig(settings));", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTkyMjk2Ng==", "url": "https://github.com/opensearch-project/security/pull/303#discussion_r395922966", "bodyText": "I believe it is a good idea to pass only whats needed to a class.", "author": "sujithvm", "createdAt": "2020-03-20T22:52:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTkxOTE2NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTk0MzYxMw==", "url": "https://github.com/opensearch-project/security/pull/303#discussion_r395943613", "bodyText": "Yes, but on the other side, now AuditMessageRouter is exposed to Settings, AsyncStoragePool and in addition to AsyncStoragePoolConfig.", "author": "vrozov", "createdAt": "2020-03-21T00:44:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTkxOTE2NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTk0NDY4MA==", "url": "https://github.com/opensearch-project/security/pull/303#discussion_r395944680", "bodyText": "Those also will undergo changes.", "author": "sujithvm", "createdAt": "2020-03-21T00:53:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTkxOTE2NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTk0NDgxNg==", "url": "https://github.com/opensearch-project/security/pull/303#discussion_r395944816", "bodyText": "All required dependencies will be injected for all the classes", "author": "sujithvm", "createdAt": "2020-03-21T00:54:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTkxOTE2NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTk0NDg5Nw==", "url": "https://github.com/opensearch-project/security/pull/303#discussion_r395944897", "bodyText": "I really want to keep scope small for PRs as previous PRs went un-attended for weeks.", "author": "sujithvm", "createdAt": "2020-03-21T00:55:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTkxOTE2NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjAwMjQ3MA==", "url": "https://github.com/opensearch-project/security/pull/303#discussion_r396002470", "bodyText": "The check is not necessary. If there are no settings, it will return a default value, otherwise, it should check validity.", "author": "vrozov", "createdAt": "2020-03-21T15:38:40Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/auditlog/config/ThreadPoolConfig.java", "diffHunk": "@@ -0,0 +1,43 @@\n+package com.amazon.opendistroforelasticsearch.security.auditlog.config;\n+\n+import com.amazon.opendistroforelasticsearch.security.support.ConfigConstants;\n+import org.elasticsearch.common.settings.Settings;\n+\n+public class ThreadPoolConfig {\n+    private static final int DEFAULT_THREAD_POOL_SIZE = 10;\n+    private static final int DEFAULT_THREAD_POOL_MAX_QUEUE_LEN = 100_000;\n+\n+    private final int threadPoolSize;\n+    private final int threadPoolMaxQueueLen;\n+\n+    public ThreadPoolConfig(int threadPoolSize, int threadPoolMaxQueueLen) {\n+        if (threadPoolSize <= 0) {\n+            throw new IllegalArgumentException(\"Incorrect thread pool size: \" + threadPoolSize + \" configured for audit logging.\");\n+        }\n+\n+        if (threadPoolMaxQueueLen <= 0) {\n+            throw new IllegalArgumentException(\"Incorrect thread pool queue length: \" + threadPoolMaxQueueLen + \" configured for audit logging.\");\n+        }\n+\n+        this.threadPoolSize = threadPoolSize;\n+        this.threadPoolMaxQueueLen = threadPoolMaxQueueLen;\n+    }\n+\n+    public int getThreadPoolSize() {\n+        return threadPoolSize;\n+    }\n+\n+    public int getThreadPoolMaxQueueLen() {\n+        return threadPoolMaxQueueLen;\n+    }\n+\n+    public static ThreadPoolConfig getConfig(Settings settings) {\n+        int threadPoolSize = settings.getAsInt(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_THREADPOOL_SIZE, DEFAULT_THREAD_POOL_SIZE);\n+        int threadPoolMaxQueueLen = settings.getAsInt(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_THREADPOOL_MAX_QUEUE_LEN, DEFAULT_THREAD_POOL_MAX_QUEUE_LEN);\n+\n+        if (threadPoolSize <= 0) threadPoolSize = DEFAULT_THREAD_POOL_SIZE;", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjA0MTcxMw==", "url": "https://github.com/opensearch-project/security/pull/303#discussion_r396041713", "bodyText": "A lot of tests are explicitly setting this value to be 0 with the expectation to use the default thread pool", "author": "sujithvm", "createdAt": "2020-03-22T00:25:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjAwMjQ3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjA0NjEzMQ==", "url": "https://github.com/opensearch-project/security/pull/303#discussion_r396046131", "bodyText": "There are only 3 tests that incorrectly set the value to be 0. If they want to rely on the default value, they should either set it explicitly to the default value or not to set it at all.", "author": "vrozov", "createdAt": "2020-03-22T01:54:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjAwMjQ3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjA2NDk1MA==", "url": "https://github.com/opensearch-project/security/pull/303#discussion_r396064950", "bodyText": "I m really torn on changing this because I agree with you but removing this will change the functionality\n\nprevious: if set <= 0 or not defined, use default\ncurrent: if set <= 0, complain with exception. if not defined, use default.\n\nChanging functionality is something normally I wouldn't do in a refactor.\nThere are actually 40+ tests explicitly setting: opendistro_security.audit.threadpool.size to 0.\nIf you think changing the functionality is the correct way, let me know. I will change it.", "author": "sujithvm", "createdAt": "2020-03-22T07:57:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjAwMjQ3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjEyMTEyNQ==", "url": "https://github.com/opensearch-project/security/pull/303#discussion_r396121125", "bodyText": "I suggest changing the behavior to avoid the possibility of overruling explicitly set by a user settings. IMO, tests need to be changed anyway to avoid using \"opendistro_security.audit.threadpool.size\" string instead of OPENDISTRO_SECURITY_AUDIT_THREADPOOL_SIZE constant. If a test needs to use not a default value it should use ConfigConstants.OPENDISTRO_SECURITY_AUDIT_THREADPOOL_SIZE.", "author": "vrozov", "createdAt": "2020-03-22T17:44:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjAwMjQ3MA=="}], "type": "inlineReview"}, {"oid": "2be667e130ccc8d95affc7618efc0b49b036025e", "url": "https://github.com/opensearch-project/security/commit/2be667e130ccc8d95affc7618efc0b49b036025e", "message": "Refactor thread pool config", "committedDate": "2020-03-22T21:33:46Z", "type": "commit"}]}