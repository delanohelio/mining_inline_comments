{"pr_number": 763, "pr_title": "Support user injection for transport requests", "pr_createdAt": "2020-10-11T17:49:44Z", "pr_url": "https://github.com/opensearch-project/security/pull/763", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzgzMzg5Ng==", "url": "https://github.com/opensearch-project/security/pull/763#discussion_r503833896", "bodyText": "Why do we need to populate both?", "author": "krishna-ggk", "createdAt": "2020-10-13T10:15:34Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/auth/BackendRegistry.java", "diffHunk": "@@ -494,7 +500,9 @@ public boolean authenticate(final RestRequest request, final RestChannel channel\n \n         if(authenticated) {\n             final User impersonatedUser = impersonate(request, authenticatedUser);\n-            threadContext.putTransient(ConfigConstants.OPENDISTRO_SECURITY_USER, impersonatedUser==null?authenticatedUser:impersonatedUser);\n+            final User loggedInUser = impersonatedUser==null?authenticatedUser:impersonatedUser;\n+            threadContext.putTransient(ConfigConstants.OPENDISTRO_SECURITY_USER, loggedInUser);\n+            threadContext.putTransient(ConfigConstants.OPENDISTRO_SECURITY_USER_STRING, loggedInUser.getUserString());", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzYyMTU4Mw==", "url": "https://github.com/opensearch-project/security/pull/763#discussion_r507621583", "bodyText": "This is just to get the user details out to the plugins apart from security (by directly not taking dependency on security plugin). Set only for the REST requests after auth.", "author": "saikaranam-amazon", "createdAt": "2020-10-19T09:57:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzgzMzg5Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTczMjY1Ng==", "url": "https://github.com/opensearch-project/security/pull/763#discussion_r511732656", "bodyText": "How is it related to user injection for transport requests?", "author": "vrozov", "createdAt": "2020-10-26T05:56:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzgzMzg5Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjUzMDkzNw==", "url": "https://github.com/opensearch-project/security/pull/763#discussion_r512530937", "bodyText": "This gets the user details and plugins can use this to inject via transport.", "author": "saikaranam-amazon", "createdAt": "2020-10-27T09:22:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzgzMzg5Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzE1MDEyNQ==", "url": "https://github.com/opensearch-project/security/pull/763#discussion_r513150125", "bodyText": "Please split into 2 PRs. This is not a requirement for user injection into transport.", "author": "vrozov", "createdAt": "2020-10-28T02:57:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzgzMzg5Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDkxMjMyNQ==", "url": "https://github.com/opensearch-project/security/pull/763#discussion_r514912325", "bodyText": "Done. Removed this part in the current PR", "author": "saikaranam-amazon", "createdAt": "2020-10-30T07:26:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzgzMzg5Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzgzODc0OQ==", "url": "https://github.com/opensearch-project/security/pull/763#discussion_r503838749", "bodyText": "The volume of transport requests is quite high when compared to rest requests. Would this have any negative impact on audit log volume?\nAlso is there a chance that could result in repeated injections? (REST injects and the corresponding transport request also results in injection)", "author": "krishna-ggk", "createdAt": "2020-10-13T10:23:57Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/auth/UserInjector.java", "diffHunk": "@@ -153,4 +164,17 @@ boolean injectUser(RestRequest request) {\n         return true;\n \n     }\n+\n+    User injectUser(TransportRequest transportRequest, Task task, String action) {\n+        String injectedUserString = threadPool.getThreadContext().getHeader(ConfigConstants.OPENDISTRO_SECURITY_INJECTED_USER_HEADER);\n+        User user = getUser(injectedUserString);\n+        if(user == null) {\n+            return null;\n+        }\n+        auditLog.logSucceededLogin(user.getName(), true, null, transportRequest, action, task);\n+        if (log.isTraceEnabled()) {\n+            log.trace(\"Injected user object:{} \", user.toString());\n+        }\n+        return user;", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzYyMjU5NA==", "url": "https://github.com/opensearch-project/security/pull/763#discussion_r507622594", "bodyText": "This should be the first transport request and after this it should not trigger multiple injections.", "author": "saikaranam-amazon", "createdAt": "2020-10-19T09:59:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzgzODc0OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzg0MDQ0MQ==", "url": "https://github.com/opensearch-project/security/pull/763#discussion_r503840441", "bodyText": "Is there a need to pass both users?\nWhat would user0 be in case of injection?", "author": "krishna-ggk", "createdAt": "2020-10-13T10:26:53Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/transport/OpenDistroSecurityInterceptor.java", "diffHunk": "@@ -117,6 +118,7 @@ public OpenDistroSecurityInterceptor(final Settings settings,\n \n         final Map<String, String> origHeaders0 = getThreadContext().getHeaders();\n         final User user0 = getThreadContext().getTransient(ConfigConstants.OPENDISTRO_SECURITY_USER);\n+        final String injectedUserString = getThreadContext().getTransient(ConfigConstants.OPENDISTRO_SECURITY_INJECTED_USER);", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzYxOTc2Mg==", "url": "https://github.com/opensearch-project/security/pull/763#discussion_r507619762", "bodyText": "Only one user will be part of the request - user0 will take precedence if both the user0 and injectedUserString are present.", "author": "saikaranam-amazon", "createdAt": "2020-10-19T09:54:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzg0MDQ0MQ=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTcyNjAwNw==", "url": "https://github.com/opensearch-project/security/pull/763#discussion_r511726007", "bodyText": "Introduce private static InjectedUser class that extends User. Add TransportAddress as member of InjectedUser. Add setTransportAddress(String ipandport) to InjectedUser. Rename getUser() to getInjectedUser() and change return type from User to InjectedUser.", "author": "vrozov", "createdAt": "2020-10-26T05:27:50Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/auth/UserInjector.java", "diffHunk": "@@ -66,33 +68,30 @@\n \n     }\n \n-    boolean injectUser(RestRequest request) {\n-\n+    private User getUser(String injectedUserString) {", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDkxMjU0Mg==", "url": "https://github.com/opensearch-project/security/pull/763#discussion_r514912542", "bodyText": "Defined InjectedUser class for injected user usecase", "author": "saikaranam-amazon", "createdAt": "2020-10-30T07:26:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTcyNjAwNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTczMjQwMQ==", "url": "https://github.com/opensearch-project/security/pull/763#discussion_r511732401", "bodyText": "Move audit logging here.", "author": "vrozov", "createdAt": "2020-10-26T05:56:01Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/auth/BackendRegistry.java", "diffHunk": "@@ -241,6 +241,12 @@ public User authenticate(final TransportRequest request, final String sslPrincip\n     \t      return null;\n     \t  }\n \n+        User injectedUser = userInjector.injectUser(request, task, action);\n+\n+        if(injectedUser != null) {\n+            return injectedUser;", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDkxMjU5Mw==", "url": "https://github.com/opensearch-project/security/pull/763#discussion_r514912593", "bodyText": "Done", "author": "saikaranam-amazon", "createdAt": "2020-10-30T07:27:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTczMjQwMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTczNTI1NA==", "url": "https://github.com/opensearch-project/security/pull/763#discussion_r511735254", "bodyText": "Please introduce new role (avoid modifying existing one).", "author": "vrozov", "createdAt": "2020-10-26T06:07:53Z", "path": "src/test/resources/roles_mapping.yml", "diffHunk": "@@ -279,7 +279,7 @@ opendistro_security_kibana_server:\n opendistro_security_all_access:\n   reserved: false\n   hidden: false\n-  backend_roles: []\n+  backend_roles: [\"injecttest\"]", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDkxMjY0Mg==", "url": "https://github.com/opensearch-project/security/pull/763#discussion_r514912642", "bodyText": "Added another mapping file", "author": "saikaranam-amazon", "createdAt": "2020-10-30T07:27:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTczNTI1NA=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTU3MTc0Nw==", "url": "https://github.com/opensearch-project/security/pull/763#discussion_r519571747", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public class InjectedUser {\n          \n          \n            \n                public class InjectedUser extends User {", "author": "vrozov", "createdAt": "2020-11-09T06:12:35Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/auth/UserInjector.java", "diffHunk": "@@ -66,10 +68,34 @@\n \n     }\n \n-    boolean injectUser(RestRequest request) {\n+    public class InjectedUser {", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDUxOTcyMg==", "url": "https://github.com/opensearch-project/security/pull/763#discussion_r520519722", "bodyText": "Done", "author": "saikaranam-amazon", "createdAt": "2020-11-10T12:20:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTU3MTc0Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTU3NzI0MQ==", "url": "https://github.com/opensearch-project/security/pull/763#discussion_r519577241", "bodyText": "Is it used?", "author": "vrozov", "createdAt": "2020-11-09T06:32:40Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/support/ConfigConstants.java", "diffHunk": "@@ -98,10 +98,12 @@\n \n     public static final String OPENDISTRO_SECURITY_USER = OPENDISTRO_SECURITY_CONFIG_PREFIX+\"user\";\n     public static final String OPENDISTRO_SECURITY_USER_HEADER = OPENDISTRO_SECURITY_CONFIG_PREFIX+\"user_header\";\n+    public static final String OPENDISTRO_SECURITY_USER_STRING = OPENDISTRO_SECURITY_CONFIG_PREFIX + \"user_string\";", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDUxOTYxNg==", "url": "https://github.com/opensearch-project/security/pull/763#discussion_r520519616", "bodyText": "Removed. Will be part of separate CR if user_roles string can't be reused", "author": "saikaranam-amazon", "createdAt": "2020-11-10T12:20:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTU3NzI0MQ=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDk1MDg1Ng==", "url": "https://github.com/opensearch-project/security/pull/763#discussion_r520950856", "bodyText": "Could you add an empty line at the end of the file?", "author": "cliu123", "createdAt": "2020-11-10T23:59:51Z", "path": "src/test/resources/roles_transport_inject_user.yml", "diffHunk": "@@ -0,0 +1,13 @@\n+---\n+_meta:\n+  type: \"rolesmapping\"\n+  config_version: 2\n+opendistro_security_all_access:\n+  reserved: false\n+  hidden: false\n+  backend_roles: [\"injecttest\"]\n+  hosts: []\n+  users:\n+    - \"nagilum\"\n+  and_backend_roles: []\n+  description: \"Migrated from v6\"", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTAwNTg3Ng==", "url": "https://github.com/opensearch-project/security/pull/763#discussion_r521005876", "bodyText": "Should this be removed if not needed?", "author": "cliu123", "createdAt": "2020-11-11T01:44:39Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/transport/OpenDistroSecurityRequestHandler.java", "diffHunk": "@@ -145,8 +145,15 @@ protected void messageReceivedDecorate(final T request, final TransportRequestHa\n             //bypass non-netty requests\n             if(channelType.equals(\"direct\")) {\n                 final String userHeader = getThreadContext().getHeader(ConfigConstants.OPENDISTRO_SECURITY_USER_HEADER);\n+                final String injectedUserHeader = getThreadContext().getHeader(ConfigConstants.OPENDISTRO_SECURITY_INJECTED_USER_HEADER);\n \n-                if(!Strings.isNullOrEmpty(userHeader)) {\n+                if(Strings.isNullOrEmpty(userHeader)) {\n+                    //user can be null when a node client wants connect\n+                    //getThreadContext().putTransient(ConfigConstants.OPENDISTRO_SECURITY_USER, User.OPENDISTRO_SECURITY_INTERNAL);", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTAwNzI4OQ==", "url": "https://github.com/opensearch-project/security/pull/763#discussion_r521007289", "bodyText": "Should this be removed if not needed?", "author": "cliu123", "createdAt": "2020-11-11T01:46:39Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/transport/OpenDistroSecurityRequestHandler.java", "diffHunk": "@@ -202,10 +209,14 @@ protected void messageReceivedDecorate(final T request, final TransportRequestHa\n                         || HeaderHelper.isTrustedClusterRequest(getThreadContext())) {\n \n                     final String userHeader = getThreadContext().getHeader(ConfigConstants.OPENDISTRO_SECURITY_USER_HEADER);\n+                    final String injectedUserHeader = getThreadContext().getHeader(ConfigConstants.OPENDISTRO_SECURITY_INJECTED_USER_HEADER);\n \n                     if(Strings.isNullOrEmpty(userHeader)) {\n                         //user can be null when a node client wants connect\n                         //getThreadContext().putTransient(ConfigConstants.OPENDISTRO_SECURITY_USER, User.OPENDISTRO_SECURITY_INTERNAL);", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTA3NjA3Ng==", "url": "https://github.com/opensearch-project/security/pull/763#discussion_r521076076", "bodyText": "Seems to be from past PR. Removed either way.", "author": "saikaranam-amazon", "createdAt": "2020-11-11T03:18:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTAwNzI4OQ=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTExMDkyNg==", "url": "https://github.com/opensearch-project/security/pull/763#discussion_r521110926", "bodyText": "Is it necessary to have separate getter and setter for InetAddress and port? Should it be sufficient to provide getter for TransportAddress and setter that takes String and parses it?", "author": "vrozov", "createdAt": "2020-11-11T04:46:35Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/auth/UserInjector.java", "diffHunk": "@@ -66,10 +66,34 @@\n \n     }\n \n-    boolean injectUser(RestRequest request) {\n+    public static class InjectedUser extends User {\n+        private InetAddress inetAddress;\n+        private int port = -1;\n+\n+        public InjectedUser(String name) {\n+            super(name);\n+        }\n+\n+        public InetAddress getInetAddress() {", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTM2MTgwNA==", "url": "https://github.com/opensearch-project/security/pull/763#discussion_r521361804", "bodyText": "Marked transport as transient for serialization.", "author": "saikaranam-amazon", "createdAt": "2020-11-11T13:35:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTExMDkyNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTExMTQ2MA==", "url": "https://github.com/opensearch-project/security/pull/763#discussion_r521111460", "bodyText": "Please remove extra lines", "author": "vrozov", "createdAt": "2020-11-11T04:48:54Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/auth/UserInjector.java", "diffHunk": "@@ -127,30 +151,50 @@ boolean injectUser(RestRequest request) {\n             String[] ipAndPort = parts[2].split(\":\");\n             if (ipAndPort.length != 2) {\n                 log.error(\"Remote address must have format ip:port, was: {}. User injection failed.\", parts[2]);\n-                return false;\n-            } else {\n-                try {\n-                    InetAddress iAdress = InetAddress.getByName(ipAndPort[0]);\n-                    int port = Integer.parseInt(ipAndPort[1]);\n-                    threadPool.getThreadContext().putTransient(ConfigConstants.OPENDISTRO_SECURITY_REMOTE_ADDRESS, new TransportAddress(iAdress, port));\n-                } catch (UnknownHostException | NumberFormatException e) {\n-                    log.error(\"Cannot parse remote IP or port: {}, user injection failed.\", parts[2], e);\n-                    return false;\n-                }\n+                return null;\n+            }\n+            try {\n+                InetAddress iAdress = InetAddress.getByName(ipAndPort[0]);\n+                int port = Integer.parseInt(ipAndPort[1]);\n+                injectedUser.setInetAddress(iAdress);\n+                injectedUser.setPort(port);\n+            } catch (UnknownHostException | NumberFormatException e) {\n+                log.error(\"Cannot parse remote IP or port: {}, user injection failed.\", parts[2], e);\n+                return null;\n             }\n-        } else {\n-            threadPool.getThreadContext().putTransient(ConfigConstants.OPENDISTRO_SECURITY_REMOTE_ADDRESS, xffResolver.resolve(request));\n         }\n \n         // mark user injected for proper admin handling\n-        user.setInjected(true);\n+        injectedUser.setInjected(true);\n \n-        threadPool.getThreadContext().putTransient(ConfigConstants.OPENDISTRO_SECURITY_USER, user);\n-        auditLog.logSucceededLogin(parts[0], true, null, request);\n         if (log.isTraceEnabled()) {\n-            log.trace(\"Injected user object:{} \", user.toString());\n+            log.trace(\"Injected user object:{} \", injectedUser.toString());\n+        }\n+\n+        return injectedUser;\n+    }\n+\n+\n+    boolean injectUser(RestRequest request) {\n+        InjectedUser injectedUser = getInjectedUser();\n+        if(injectedUser == null) {\n+            return false;\n         }\n-        return true;\n \n+        // Set remote address into the thread context\n+        if (injectedUser.getInetAddress() != null && injectedUser.getPort() != -1) {\n+            TransportAddress transportAddress = new TransportAddress(injectedUser.getInetAddress(), injectedUser.getPort());\n+            threadPool.getThreadContext().putTransient(ConfigConstants.OPENDISTRO_SECURITY_REMOTE_ADDRESS, transportAddress);\n+        } else {\n+            threadPool.getThreadContext().putTransient(ConfigConstants.OPENDISTRO_SECURITY_REMOTE_ADDRESS, xffResolver.resolve(request));\n+        }\n+\n+        threadPool.getThreadContext().putTransient(ConfigConstants.OPENDISTRO_SECURITY_USER, injectedUser);\n+        auditLog.logSucceededLogin(injectedUser.getName(), true, null, request);\n+\n+        return true;\n     }\n }\n+", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTExMjE3Nw==", "url": "https://github.com/opensearch-project/security/pull/763#discussion_r521112177", "bodyText": "Consider moving User.class from SAFE_CLASSES to SAFE_ASSIGNABLE_FROM_CLASSES.", "author": "vrozov", "createdAt": "2020-11-11T04:51:44Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/support/Base64Helper.java", "diffHunk": "@@ -77,6 +78,7 @@\n         InetSocketAddress.class,\n         Pattern.class,\n         User.class,\n+        UserInjector.InjectedUser.class,", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTEyMDgyNg==", "url": "https://github.com/opensearch-project/security/pull/763#discussion_r521120826", "bodyText": "Is this flag necessary? User already has a flag whether it is injected or not.", "author": "vrozov", "createdAt": "2020-11-11T05:25:58Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/filter/OpenDistroSecurityFilter.java", "diffHunk": "@@ -169,7 +171,19 @@ public int order() {\n                 attachSourceFieldContext(request);\n             }\n             final Set<String> injectedRoles = rolesInjector.injectUserAndRoles(threadContext);\n+            boolean isInjectedUser = false;", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTM2MTQyMw==", "url": "https://github.com/opensearch-project/security/pull/763#discussion_r521361423", "bodyText": "We want to have to privileges check for the local and after injected user is set. For the rest of the cases, it should go with the normal flow.", "author": "saikaranam-amazon", "createdAt": "2020-11-11T13:35:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTEyMDgyNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTEyMTI5OA==", "url": "https://github.com/opensearch-project/security/pull/763#discussion_r521121298", "bodyText": "There is call to threadContext.getTransient(ConfigConstants.OPENDISTRO_SECURITY_USER), please reuse User user.", "author": "vrozov", "createdAt": "2020-11-11T05:27:57Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/filter/OpenDistroSecurityFilter.java", "diffHunk": "@@ -169,7 +171,19 @@ public int order() {\n                 attachSourceFieldContext(request);\n             }\n             final Set<String> injectedRoles = rolesInjector.injectUserAndRoles(threadContext);\n+            boolean isInjectedUser = false;\n+            if(threadContext.getTransient(ConfigConstants.OPENDISTRO_SECURITY_USER) == null", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjY3NTA1MQ==", "url": "https://github.com/opensearch-project/security/pull/763#discussion_r522675051", "bodyText": "authenticate() may return principal instead of ConfigConstants.OPENDISTRO_SECURITY_INJECTED_USER. Is it expected? If yes, why is it necessary to inject principal? Also in this case please rename injectedUser to reflect that it can be SSL principal user. Also rename isInjectedUser to canSkipPrivilegesEvaluation or enforcePrivilegesEvaluation.", "author": "vrozov", "createdAt": "2020-11-13T06:14:45Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/filter/OpenDistroSecurityFilter.java", "diffHunk": "@@ -169,7 +171,18 @@ public int order() {\n                 attachSourceFieldContext(request);\n             }\n             final Set<String> injectedRoles = rolesInjector.injectUserAndRoles(threadContext);\n-            final User user = threadContext.getTransient(ConfigConstants.OPENDISTRO_SECURITY_USER);\n+            boolean isInjectedUser = false;\n+            User user = threadContext.getTransient(ConfigConstants.OPENDISTRO_SECURITY_USER);\n+            if(user == null && threadContext.getTransient(ConfigConstants.OPENDISTRO_SECURITY_INJECTED_USER) != null) {\n+                String principal = threadContext.getTransient(ConfigConstants.OPENDISTRO_SECURITY_SSL_TRANSPORT_PRINCIPAL);\n+                User injectedUser = backendRegistry.authenticate(request, principal, task, action);", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjIxOTczNQ==", "url": "https://github.com/opensearch-project/security/pull/763#discussion_r526219735", "bodyText": "Made necessary changes\n\nDidn't pass principal as only user injection is needed here.\nRenamed the variable to enforcePrivilegesEvaluation", "author": "saikaranam-amazon", "createdAt": "2020-11-18T16:19:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjY3NTA1MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjY5MDY1NQ==", "url": "https://github.com/opensearch-project/security/pull/763#discussion_r522690655", "bodyText": "User is assignable from UserInjector.InjectedUser, so both User and UserInjector.InjectedUser should be serializable.", "author": "vrozov", "createdAt": "2020-11-13T06:46:33Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/support/Base64Helper.java", "diffHunk": "@@ -76,7 +77,7 @@\n         SocketAddress.class,\n         InetSocketAddress.class,\n         Pattern.class,\n-        User.class,\n+        UserInjector.InjectedUser.class,", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjIwNzAyOQ==", "url": "https://github.com/opensearch-project/security/pull/763#discussion_r526207029", "bodyText": "User is moved to SAFE_ASSIGNABLE_FROM_CLASSES", "author": "saikaranam-amazon", "createdAt": "2020-11-18T16:03:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjY5MDY1NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjY5MTYyNw==", "url": "https://github.com/opensearch-project/security/pull/763#discussion_r522691627", "bodyText": "Undo.", "author": "vrozov", "createdAt": "2020-11-13T06:47:38Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/user/User.java", "diffHunk": "@@ -32,6 +32,7 @@\n \n import java.io.IOException;\n import java.io.Serializable;\n+import java.net.InetAddress;", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjY5MTc5Mw==", "url": "https://github.com/opensearch-project/security/pull/763#discussion_r522691793", "bodyText": "Undo", "author": "vrozov", "createdAt": "2020-11-13T06:47:50Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/user/User.java", "diffHunk": "@@ -267,4 +268,5 @@ public final void addOpenDistroSecurityRoles(final Collection<String> securityRo\n     public final String getUserRolesString() {\n         return name + \"|\" + String.join(\",\", getRoles()) + \"|\" + String.join(\",\", getOpenDistroSecurityRoles());\n     }\n+", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjY5MzU0OA==", "url": "https://github.com/opensearch-project/security/pull/763#discussion_r522693548", "bodyText": "Add test cases with user injection disabled.", "author": "vrozov", "createdAt": "2020-11-13T06:50:02Z", "path": "src/test/java/com/amazon/opendistroforelasticsearch/security/TransportUserInjectorIntegTest.java", "diffHunk": "@@ -0,0 +1,126 @@\n+package com.amazon.opendistroforelasticsearch.security;\n+\n+import com.amazon.opendistroforelasticsearch.security.support.ConfigConstants;\n+import com.amazon.opendistroforelasticsearch.security.test.DynamicSecurityConfig;\n+import com.amazon.opendistroforelasticsearch.security.test.SingleClusterTest;\n+import org.elasticsearch.ElasticsearchSecurityException;\n+import org.elasticsearch.action.admin.cluster.health.ClusterHealthRequest;\n+import org.elasticsearch.action.admin.indices.create.CreateIndexRequest;\n+import org.elasticsearch.action.admin.indices.create.CreateIndexResponse;\n+import org.elasticsearch.client.Client;\n+import org.elasticsearch.cluster.metadata.IndexNameExpressionResolver;\n+import org.elasticsearch.cluster.service.ClusterService;\n+import org.elasticsearch.common.io.stream.NamedWriteableRegistry;\n+import org.elasticsearch.common.settings.Settings;\n+import org.elasticsearch.common.xcontent.NamedXContentRegistry;\n+import org.elasticsearch.env.Environment;\n+import org.elasticsearch.env.NodeEnvironment;\n+import org.elasticsearch.node.Node;\n+import org.elasticsearch.node.PluginAwareNode;\n+import org.elasticsearch.plugins.ActionPlugin;\n+import org.elasticsearch.plugins.Plugin;\n+import org.elasticsearch.repositories.RepositoriesService;\n+import org.elasticsearch.script.ScriptService;\n+import org.elasticsearch.threadpool.ThreadPool;\n+import org.elasticsearch.transport.Netty4Plugin;\n+import org.elasticsearch.watcher.ResourceWatcherService;\n+import org.junit.Assert;\n+import org.junit.Test;\n+\n+import java.nio.file.Path;\n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.function.Supplier;\n+\n+public class TransportUserInjectorIntegTest extends SingleClusterTest {\n+\n+    public static class UserInjectorPlugin extends Plugin implements ActionPlugin {\n+        Settings settings;\n+        public static String injectedUser = null;\n+\n+        public UserInjectorPlugin(final Settings settings, final Path configPath) {\n+            this.settings = settings;\n+        }\n+\n+        @Override\n+        public Collection<Object> createComponents(Client client, ClusterService clusterService, ThreadPool threadPool,\n+                                                   ResourceWatcherService resourceWatcherService, ScriptService scriptService,\n+                                                   NamedXContentRegistry xContentRegistry, Environment environment,\n+                                                   NodeEnvironment nodeEnvironment, NamedWriteableRegistry namedWriteableRegistry,\n+                                                   IndexNameExpressionResolver indexNameExpressionResolver,\n+                                                   Supplier<RepositoriesService> repositoriesServiceSupplier) {\n+            if(injectedUser != null)\n+                threadPool.getThreadContext().putTransient(ConfigConstants.OPENDISTRO_SECURITY_INJECTED_USER, injectedUser);\n+            return new ArrayList<>();\n+        }\n+    }\n+\n+    //Wait for the security plugin to load roles.\n+    private void waitForInit(Client client) throws Exception {\n+        try {\n+            client.admin().cluster().health(new ClusterHealthRequest()).actionGet();\n+        } catch (ElasticsearchSecurityException ex) {\n+            if(ex.getMessage().contains(\"Open Distro Security not initialized\")) {\n+                Thread.sleep(500);\n+                waitForInit(client);\n+            }\n+        }\n+    }\n+\n+    @Test\n+    public void testOpendistroSecurityUserInjection() throws Exception {", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzgzNjIxNQ==", "url": "https://github.com/opensearch-project/security/pull/763#discussion_r527836215", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        if(user == null && threadContext.getTransient(ConfigConstants.OPENDISTRO_SECURITY_INJECTED_USER) != null) {\n          \n          \n            \n                        if(user == null) {\n          \n      \n    \n    \n  \n\nWill it be better to rely on backendRegistry.authenticate(request, null, task, action);?", "author": "vrozov", "createdAt": "2020-11-20T17:10:33Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/filter/OpenDistroSecurityFilter.java", "diffHunk": "@@ -169,7 +171,17 @@ public int order() {\n                 attachSourceFieldContext(request);\n             }\n             final Set<String> injectedRoles = rolesInjector.injectUserAndRoles(threadContext);\n-            final User user = threadContext.getTransient(ConfigConstants.OPENDISTRO_SECURITY_USER);\n+            boolean enforcePrivilegesEvaluation = false;\n+            User user = threadContext.getTransient(ConfigConstants.OPENDISTRO_SECURITY_USER);\n+            if(user == null && threadContext.getTransient(ConfigConstants.OPENDISTRO_SECURITY_INJECTED_USER) != null) {", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzgzOTU2NQ==", "url": "https://github.com/opensearch-project/security/pull/763#discussion_r527839565", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        Assert.assertTrue(cir.isAcknowledged());\n          \n          \n            \n                        Assert.fail(\"Expecting exception\");", "author": "vrozov", "createdAt": "2020-11-20T17:16:04Z", "path": "src/test/java/com/amazon/opendistroforelasticsearch/security/TransportUserInjectorIntegTest.java", "diffHunk": "@@ -0,0 +1,167 @@\n+package com.amazon.opendistroforelasticsearch.security;\n+\n+import com.amazon.opendistroforelasticsearch.security.support.ConfigConstants;\n+import com.amazon.opendistroforelasticsearch.security.test.DynamicSecurityConfig;\n+import com.amazon.opendistroforelasticsearch.security.test.SingleClusterTest;\n+import org.elasticsearch.ElasticsearchSecurityException;\n+import org.elasticsearch.action.admin.cluster.health.ClusterHealthRequest;\n+import org.elasticsearch.action.admin.indices.create.CreateIndexRequest;\n+import org.elasticsearch.action.admin.indices.create.CreateIndexResponse;\n+import org.elasticsearch.client.Client;\n+import org.elasticsearch.cluster.metadata.IndexNameExpressionResolver;\n+import org.elasticsearch.cluster.service.ClusterService;\n+import org.elasticsearch.common.io.stream.NamedWriteableRegistry;\n+import org.elasticsearch.common.settings.Settings;\n+import org.elasticsearch.common.xcontent.NamedXContentRegistry;\n+import org.elasticsearch.env.Environment;\n+import org.elasticsearch.env.NodeEnvironment;\n+import org.elasticsearch.node.Node;\n+import org.elasticsearch.node.PluginAwareNode;\n+import org.elasticsearch.plugins.ActionPlugin;\n+import org.elasticsearch.plugins.Plugin;\n+import org.elasticsearch.repositories.RepositoriesService;\n+import org.elasticsearch.script.ScriptService;\n+import org.elasticsearch.threadpool.ThreadPool;\n+import org.elasticsearch.transport.Netty4Plugin;\n+import org.elasticsearch.watcher.ResourceWatcherService;\n+import org.junit.Assert;\n+import org.junit.Test;\n+\n+import java.nio.file.Path;\n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.function.Supplier;\n+\n+public class TransportUserInjectorIntegTest extends SingleClusterTest {\n+\n+    public static class UserInjectorPlugin extends Plugin implements ActionPlugin {\n+        Settings settings;\n+        public static String injectedUser = null;\n+\n+        public UserInjectorPlugin(final Settings settings, final Path configPath) {\n+            this.settings = settings;\n+        }\n+\n+        @Override\n+        public Collection<Object> createComponents(Client client, ClusterService clusterService, ThreadPool threadPool,\n+                                                   ResourceWatcherService resourceWatcherService, ScriptService scriptService,\n+                                                   NamedXContentRegistry xContentRegistry, Environment environment,\n+                                                   NodeEnvironment nodeEnvironment, NamedWriteableRegistry namedWriteableRegistry,\n+                                                   IndexNameExpressionResolver indexNameExpressionResolver,\n+                                                   Supplier<RepositoriesService> repositoriesServiceSupplier) {\n+            if(injectedUser != null)\n+                threadPool.getThreadContext().putTransient(ConfigConstants.OPENDISTRO_SECURITY_INJECTED_USER, injectedUser);\n+            return new ArrayList<>();\n+        }\n+    }\n+\n+    //Wait for the security plugin to load roles.\n+    private void waitForInit(Client client) throws Exception {\n+        try {\n+            client.admin().cluster().health(new ClusterHealthRequest()).actionGet();\n+        } catch (ElasticsearchSecurityException ex) {\n+            if(ex.getMessage().contains(\"Open Distro Security not initialized\")) {\n+                Thread.sleep(500);\n+                waitForInit(client);\n+            }\n+        }\n+    }\n+\n+    @Test\n+    public void testOpendistroSecurityUserInjection() throws Exception {\n+        final Settings clusterNodeSettings = Settings.builder()\n+                .put(ConfigConstants.OPENDISTRO_SECURITY_UNSUPPORTED_INJECT_USER_ENABLED, true)\n+                .build();\n+        setup(clusterNodeSettings, new DynamicSecurityConfig().setSecurityRolesMapping(\"roles_transport_inject_user.yml\"), Settings.EMPTY);\n+        final Settings tcSettings = Settings.builder()\n+                .put(minimumSecuritySettings(Settings.EMPTY).get(0))\n+                .put(\"cluster.name\", clusterInfo.clustername)\n+                .put(\"node.data\", false)\n+                .put(\"node.master\", false)\n+                .put(\"node.ingest\", false)\n+                .put(\"path.data\", \"./target/data/\" + clusterInfo.clustername + \"/cert/data\")\n+                .put(\"path.logs\", \"./target/data/\" + clusterInfo.clustername + \"/cert/logs\")\n+                .put(\"path.home\", \"./target\")\n+                .put(\"node.name\", \"testclient\")\n+                .put(\"discovery.initial_state_timeout\", \"8s\")\n+                .put(\"opendistro_security.allow_default_init_securityindex\", \"true\")\n+                .put(ConfigConstants.OPENDISTRO_SECURITY_UNSUPPORTED_INJECT_USER_ENABLED, true)\n+                .putList(\"discovery.zen.ping.unicast.hosts\", clusterInfo.nodeHost + \":\" + clusterInfo.nodePort)\n+                .build();\n+\n+\n+        // 1. without user injection\n+        try (Node node = new PluginAwareNode(false, tcSettings, Netty4Plugin.class,\n+                OpenDistroSecurityPlugin.class, UserInjectorPlugin.class).start()) {\n+            waitForInit(node.client());\n+            CreateIndexResponse cir = node.client().admin().indices().create(new CreateIndexRequest(\"captain-logs-1\")).actionGet();\n+            Assert.assertTrue(cir.isAcknowledged());\n+        }\n+\n+\n+        // 2. with invalid backend roles\n+        UserInjectorPlugin.injectedUser = \"ttt|kkk\";\n+        Exception exception = null;\n+        try (Node node = new PluginAwareNode(false, tcSettings, Netty4Plugin.class,\n+                OpenDistroSecurityPlugin.class, UserInjectorPlugin.class).start()) {\n+            waitForInit(node.client());\n+            CreateIndexResponse cir = node.client().admin().indices().create(new CreateIndexRequest(\"captain-logs-2\")).actionGet();\n+            Assert.assertTrue(cir.isAcknowledged());", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzg0MDQ4OQ==", "url": "https://github.com/opensearch-project/security/pull/763#discussion_r527840489", "bodyText": "Move that assert inside catch.", "author": "vrozov", "createdAt": "2020-11-20T17:17:38Z", "path": "src/test/java/com/amazon/opendistroforelasticsearch/security/TransportUserInjectorIntegTest.java", "diffHunk": "@@ -0,0 +1,167 @@\n+package com.amazon.opendistroforelasticsearch.security;\n+\n+import com.amazon.opendistroforelasticsearch.security.support.ConfigConstants;\n+import com.amazon.opendistroforelasticsearch.security.test.DynamicSecurityConfig;\n+import com.amazon.opendistroforelasticsearch.security.test.SingleClusterTest;\n+import org.elasticsearch.ElasticsearchSecurityException;\n+import org.elasticsearch.action.admin.cluster.health.ClusterHealthRequest;\n+import org.elasticsearch.action.admin.indices.create.CreateIndexRequest;\n+import org.elasticsearch.action.admin.indices.create.CreateIndexResponse;\n+import org.elasticsearch.client.Client;\n+import org.elasticsearch.cluster.metadata.IndexNameExpressionResolver;\n+import org.elasticsearch.cluster.service.ClusterService;\n+import org.elasticsearch.common.io.stream.NamedWriteableRegistry;\n+import org.elasticsearch.common.settings.Settings;\n+import org.elasticsearch.common.xcontent.NamedXContentRegistry;\n+import org.elasticsearch.env.Environment;\n+import org.elasticsearch.env.NodeEnvironment;\n+import org.elasticsearch.node.Node;\n+import org.elasticsearch.node.PluginAwareNode;\n+import org.elasticsearch.plugins.ActionPlugin;\n+import org.elasticsearch.plugins.Plugin;\n+import org.elasticsearch.repositories.RepositoriesService;\n+import org.elasticsearch.script.ScriptService;\n+import org.elasticsearch.threadpool.ThreadPool;\n+import org.elasticsearch.transport.Netty4Plugin;\n+import org.elasticsearch.watcher.ResourceWatcherService;\n+import org.junit.Assert;\n+import org.junit.Test;\n+\n+import java.nio.file.Path;\n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.function.Supplier;\n+\n+public class TransportUserInjectorIntegTest extends SingleClusterTest {\n+\n+    public static class UserInjectorPlugin extends Plugin implements ActionPlugin {\n+        Settings settings;\n+        public static String injectedUser = null;\n+\n+        public UserInjectorPlugin(final Settings settings, final Path configPath) {\n+            this.settings = settings;\n+        }\n+\n+        @Override\n+        public Collection<Object> createComponents(Client client, ClusterService clusterService, ThreadPool threadPool,\n+                                                   ResourceWatcherService resourceWatcherService, ScriptService scriptService,\n+                                                   NamedXContentRegistry xContentRegistry, Environment environment,\n+                                                   NodeEnvironment nodeEnvironment, NamedWriteableRegistry namedWriteableRegistry,\n+                                                   IndexNameExpressionResolver indexNameExpressionResolver,\n+                                                   Supplier<RepositoriesService> repositoriesServiceSupplier) {\n+            if(injectedUser != null)\n+                threadPool.getThreadContext().putTransient(ConfigConstants.OPENDISTRO_SECURITY_INJECTED_USER, injectedUser);\n+            return new ArrayList<>();\n+        }\n+    }\n+\n+    //Wait for the security plugin to load roles.\n+    private void waitForInit(Client client) throws Exception {\n+        try {\n+            client.admin().cluster().health(new ClusterHealthRequest()).actionGet();\n+        } catch (ElasticsearchSecurityException ex) {\n+            if(ex.getMessage().contains(\"Open Distro Security not initialized\")) {\n+                Thread.sleep(500);\n+                waitForInit(client);\n+            }\n+        }\n+    }\n+\n+    @Test\n+    public void testOpendistroSecurityUserInjection() throws Exception {\n+        final Settings clusterNodeSettings = Settings.builder()\n+                .put(ConfigConstants.OPENDISTRO_SECURITY_UNSUPPORTED_INJECT_USER_ENABLED, true)\n+                .build();\n+        setup(clusterNodeSettings, new DynamicSecurityConfig().setSecurityRolesMapping(\"roles_transport_inject_user.yml\"), Settings.EMPTY);\n+        final Settings tcSettings = Settings.builder()\n+                .put(minimumSecuritySettings(Settings.EMPTY).get(0))\n+                .put(\"cluster.name\", clusterInfo.clustername)\n+                .put(\"node.data\", false)\n+                .put(\"node.master\", false)\n+                .put(\"node.ingest\", false)\n+                .put(\"path.data\", \"./target/data/\" + clusterInfo.clustername + \"/cert/data\")\n+                .put(\"path.logs\", \"./target/data/\" + clusterInfo.clustername + \"/cert/logs\")\n+                .put(\"path.home\", \"./target\")\n+                .put(\"node.name\", \"testclient\")\n+                .put(\"discovery.initial_state_timeout\", \"8s\")\n+                .put(\"opendistro_security.allow_default_init_securityindex\", \"true\")\n+                .put(ConfigConstants.OPENDISTRO_SECURITY_UNSUPPORTED_INJECT_USER_ENABLED, true)\n+                .putList(\"discovery.zen.ping.unicast.hosts\", clusterInfo.nodeHost + \":\" + clusterInfo.nodePort)\n+                .build();\n+\n+\n+        // 1. without user injection\n+        try (Node node = new PluginAwareNode(false, tcSettings, Netty4Plugin.class,\n+                OpenDistroSecurityPlugin.class, UserInjectorPlugin.class).start()) {\n+            waitForInit(node.client());\n+            CreateIndexResponse cir = node.client().admin().indices().create(new CreateIndexRequest(\"captain-logs-1\")).actionGet();\n+            Assert.assertTrue(cir.isAcknowledged());\n+        }\n+\n+\n+        // 2. with invalid backend roles\n+        UserInjectorPlugin.injectedUser = \"ttt|kkk\";\n+        Exception exception = null;\n+        try (Node node = new PluginAwareNode(false, tcSettings, Netty4Plugin.class,\n+                OpenDistroSecurityPlugin.class, UserInjectorPlugin.class).start()) {\n+            waitForInit(node.client());\n+            CreateIndexResponse cir = node.client().admin().indices().create(new CreateIndexRequest(\"captain-logs-2\")).actionGet();\n+            Assert.assertTrue(cir.isAcknowledged());\n+        } catch (ElasticsearchSecurityException ex) {\n+            exception = ex;\n+            log.warn(ex);\n+        }\n+        Assert.assertNotNull(exception);\n+        Assert.assertTrue(exception.getMessage().contains(\"indices:admin/create\"));", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzg1NTM2MA==", "url": "https://github.com/opensearch-project/security/pull/763#discussion_r527855360", "bodyText": "Can you add comment that the request is expected to succeed as user injection is disabled.", "author": "vrozov", "createdAt": "2020-11-20T17:35:32Z", "path": "src/test/java/com/amazon/opendistroforelasticsearch/security/TransportUserInjectorIntegTest.java", "diffHunk": "@@ -0,0 +1,167 @@\n+package com.amazon.opendistroforelasticsearch.security;\n+\n+import com.amazon.opendistroforelasticsearch.security.support.ConfigConstants;\n+import com.amazon.opendistroforelasticsearch.security.test.DynamicSecurityConfig;\n+import com.amazon.opendistroforelasticsearch.security.test.SingleClusterTest;\n+import org.elasticsearch.ElasticsearchSecurityException;\n+import org.elasticsearch.action.admin.cluster.health.ClusterHealthRequest;\n+import org.elasticsearch.action.admin.indices.create.CreateIndexRequest;\n+import org.elasticsearch.action.admin.indices.create.CreateIndexResponse;\n+import org.elasticsearch.client.Client;\n+import org.elasticsearch.cluster.metadata.IndexNameExpressionResolver;\n+import org.elasticsearch.cluster.service.ClusterService;\n+import org.elasticsearch.common.io.stream.NamedWriteableRegistry;\n+import org.elasticsearch.common.settings.Settings;\n+import org.elasticsearch.common.xcontent.NamedXContentRegistry;\n+import org.elasticsearch.env.Environment;\n+import org.elasticsearch.env.NodeEnvironment;\n+import org.elasticsearch.node.Node;\n+import org.elasticsearch.node.PluginAwareNode;\n+import org.elasticsearch.plugins.ActionPlugin;\n+import org.elasticsearch.plugins.Plugin;\n+import org.elasticsearch.repositories.RepositoriesService;\n+import org.elasticsearch.script.ScriptService;\n+import org.elasticsearch.threadpool.ThreadPool;\n+import org.elasticsearch.transport.Netty4Plugin;\n+import org.elasticsearch.watcher.ResourceWatcherService;\n+import org.junit.Assert;\n+import org.junit.Test;\n+\n+import java.nio.file.Path;\n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.function.Supplier;\n+\n+public class TransportUserInjectorIntegTest extends SingleClusterTest {\n+\n+    public static class UserInjectorPlugin extends Plugin implements ActionPlugin {\n+        Settings settings;\n+        public static String injectedUser = null;\n+\n+        public UserInjectorPlugin(final Settings settings, final Path configPath) {\n+            this.settings = settings;\n+        }\n+\n+        @Override\n+        public Collection<Object> createComponents(Client client, ClusterService clusterService, ThreadPool threadPool,\n+                                                   ResourceWatcherService resourceWatcherService, ScriptService scriptService,\n+                                                   NamedXContentRegistry xContentRegistry, Environment environment,\n+                                                   NodeEnvironment nodeEnvironment, NamedWriteableRegistry namedWriteableRegistry,\n+                                                   IndexNameExpressionResolver indexNameExpressionResolver,\n+                                                   Supplier<RepositoriesService> repositoriesServiceSupplier) {\n+            if(injectedUser != null)\n+                threadPool.getThreadContext().putTransient(ConfigConstants.OPENDISTRO_SECURITY_INJECTED_USER, injectedUser);\n+            return new ArrayList<>();\n+        }\n+    }\n+\n+    //Wait for the security plugin to load roles.\n+    private void waitForInit(Client client) throws Exception {\n+        try {\n+            client.admin().cluster().health(new ClusterHealthRequest()).actionGet();\n+        } catch (ElasticsearchSecurityException ex) {\n+            if(ex.getMessage().contains(\"Open Distro Security not initialized\")) {\n+                Thread.sleep(500);\n+                waitForInit(client);\n+            }\n+        }\n+    }\n+\n+    @Test\n+    public void testOpendistroSecurityUserInjection() throws Exception {\n+        final Settings clusterNodeSettings = Settings.builder()\n+                .put(ConfigConstants.OPENDISTRO_SECURITY_UNSUPPORTED_INJECT_USER_ENABLED, true)\n+                .build();\n+        setup(clusterNodeSettings, new DynamicSecurityConfig().setSecurityRolesMapping(\"roles_transport_inject_user.yml\"), Settings.EMPTY);\n+        final Settings tcSettings = Settings.builder()\n+                .put(minimumSecuritySettings(Settings.EMPTY).get(0))\n+                .put(\"cluster.name\", clusterInfo.clustername)\n+                .put(\"node.data\", false)\n+                .put(\"node.master\", false)\n+                .put(\"node.ingest\", false)\n+                .put(\"path.data\", \"./target/data/\" + clusterInfo.clustername + \"/cert/data\")\n+                .put(\"path.logs\", \"./target/data/\" + clusterInfo.clustername + \"/cert/logs\")\n+                .put(\"path.home\", \"./target\")\n+                .put(\"node.name\", \"testclient\")\n+                .put(\"discovery.initial_state_timeout\", \"8s\")\n+                .put(\"opendistro_security.allow_default_init_securityindex\", \"true\")\n+                .put(ConfigConstants.OPENDISTRO_SECURITY_UNSUPPORTED_INJECT_USER_ENABLED, true)\n+                .putList(\"discovery.zen.ping.unicast.hosts\", clusterInfo.nodeHost + \":\" + clusterInfo.nodePort)\n+                .build();\n+\n+\n+        // 1. without user injection\n+        try (Node node = new PluginAwareNode(false, tcSettings, Netty4Plugin.class,\n+                OpenDistroSecurityPlugin.class, UserInjectorPlugin.class).start()) {\n+            waitForInit(node.client());\n+            CreateIndexResponse cir = node.client().admin().indices().create(new CreateIndexRequest(\"captain-logs-1\")).actionGet();\n+            Assert.assertTrue(cir.isAcknowledged());\n+        }\n+\n+\n+        // 2. with invalid backend roles\n+        UserInjectorPlugin.injectedUser = \"ttt|kkk\";\n+        Exception exception = null;\n+        try (Node node = new PluginAwareNode(false, tcSettings, Netty4Plugin.class,\n+                OpenDistroSecurityPlugin.class, UserInjectorPlugin.class).start()) {\n+            waitForInit(node.client());\n+            CreateIndexResponse cir = node.client().admin().indices().create(new CreateIndexRequest(\"captain-logs-2\")).actionGet();\n+            Assert.assertTrue(cir.isAcknowledged());\n+        } catch (ElasticsearchSecurityException ex) {\n+            exception = ex;\n+            log.warn(ex);\n+        }\n+        Assert.assertNotNull(exception);\n+        Assert.assertTrue(exception.getMessage().contains(\"indices:admin/create\"));\n+\n+        // 3. with valid backend roles for injected user\n+        UserInjectorPlugin.injectedUser = \"injectedadmin|injecttest\";\n+        try (Node node = new PluginAwareNode(false, tcSettings, Netty4Plugin.class,\n+                OpenDistroSecurityPlugin.class, UserInjectorPlugin.class).start()) {\n+            waitForInit(node.client());\n+            CreateIndexResponse cir = node.client().admin().indices().create(new CreateIndexRequest(\"captain-logs-2\")).actionGet();\n+            Assert.assertTrue(cir.isAcknowledged());\n+        }\n+    }\n+\n+    @Test\n+    public void testOpendistroSecurityUserInjectionWithConfigDisabled() throws Exception {\n+        final Settings clusterNodeSettings = Settings.builder()\n+                .put(ConfigConstants.OPENDISTRO_SECURITY_UNSUPPORTED_INJECT_USER_ENABLED, false)\n+                .build();\n+        setup(clusterNodeSettings, new DynamicSecurityConfig().setSecurityRolesMapping(\"roles_transport_inject_user.yml\"), Settings.EMPTY);\n+        final Settings tcSettings = Settings.builder()\n+                .put(minimumSecuritySettings(Settings.EMPTY).get(0))\n+                .put(\"cluster.name\", clusterInfo.clustername)\n+                .put(\"node.data\", false)\n+                .put(\"node.master\", false)\n+                .put(\"node.ingest\", false)\n+                .put(\"path.data\", \"./target/data/\" + clusterInfo.clustername + \"/cert/data\")\n+                .put(\"path.logs\", \"./target/data/\" + clusterInfo.clustername + \"/cert/logs\")\n+                .put(\"path.home\", \"./target\")\n+                .put(\"node.name\", \"testclient\")\n+                .put(\"discovery.initial_state_timeout\", \"8s\")\n+                .put(\"opendistro_security.allow_default_init_securityindex\", \"true\")\n+                .put(ConfigConstants.OPENDISTRO_SECURITY_UNSUPPORTED_INJECT_USER_ENABLED, false)\n+                .putList(\"discovery.zen.ping.unicast.hosts\", clusterInfo.nodeHost + \":\" + clusterInfo.nodePort)\n+                .build();\n+\n+        // 1. without user injection\n+        try (Node node = new PluginAwareNode(false, tcSettings, Netty4Plugin.class,\n+                OpenDistroSecurityPlugin.class, UserInjectorPlugin.class).start()) {\n+            waitForInit(node.client());\n+            CreateIndexResponse cir = node.client().admin().indices().create(new CreateIndexRequest(\"captain-logs-1\")).actionGet();\n+            Assert.assertTrue(cir.isAcknowledged());\n+        }\n+        \n+        // with invalid backend roles\n+        UserInjectorPlugin.injectedUser = \"ttt|kkk\";\n+        try (Node node = new PluginAwareNode(false, tcSettings, Netty4Plugin.class,\n+                OpenDistroSecurityPlugin.class, UserInjectorPlugin.class).start()) {\n+            waitForInit(node.client());\n+            CreateIndexResponse cir = node.client().admin().indices().create(new CreateIndexRequest(\"captain-logs-2\")).actionGet();\n+            Assert.assertTrue(cir.isAcknowledged());", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODk3MTUzMg==", "url": "https://github.com/opensearch-project/security/pull/763#discussion_r528971532", "bodyText": "Add Assert.fail() after the call to ensure that exception is raised.", "author": "vrozov", "createdAt": "2020-11-23T20:18:34Z", "path": "src/test/java/com/amazon/opendistroforelasticsearch/security/TransportUserInjectorIntegTest.java", "diffHunk": "@@ -0,0 +1,167 @@\n+package com.amazon.opendistroforelasticsearch.security;\n+\n+import com.amazon.opendistroforelasticsearch.security.support.ConfigConstants;\n+import com.amazon.opendistroforelasticsearch.security.test.DynamicSecurityConfig;\n+import com.amazon.opendistroforelasticsearch.security.test.SingleClusterTest;\n+import org.elasticsearch.ElasticsearchSecurityException;\n+import org.elasticsearch.action.admin.cluster.health.ClusterHealthRequest;\n+import org.elasticsearch.action.admin.indices.create.CreateIndexRequest;\n+import org.elasticsearch.action.admin.indices.create.CreateIndexResponse;\n+import org.elasticsearch.client.Client;\n+import org.elasticsearch.cluster.metadata.IndexNameExpressionResolver;\n+import org.elasticsearch.cluster.service.ClusterService;\n+import org.elasticsearch.common.io.stream.NamedWriteableRegistry;\n+import org.elasticsearch.common.settings.Settings;\n+import org.elasticsearch.common.xcontent.NamedXContentRegistry;\n+import org.elasticsearch.env.Environment;\n+import org.elasticsearch.env.NodeEnvironment;\n+import org.elasticsearch.node.Node;\n+import org.elasticsearch.node.PluginAwareNode;\n+import org.elasticsearch.plugins.ActionPlugin;\n+import org.elasticsearch.plugins.Plugin;\n+import org.elasticsearch.repositories.RepositoriesService;\n+import org.elasticsearch.script.ScriptService;\n+import org.elasticsearch.threadpool.ThreadPool;\n+import org.elasticsearch.transport.Netty4Plugin;\n+import org.elasticsearch.watcher.ResourceWatcherService;\n+import org.junit.Assert;\n+import org.junit.Test;\n+\n+import java.nio.file.Path;\n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.function.Supplier;\n+\n+public class TransportUserInjectorIntegTest extends SingleClusterTest {\n+\n+    public static class UserInjectorPlugin extends Plugin implements ActionPlugin {\n+        Settings settings;\n+        public static String injectedUser = null;\n+\n+        public UserInjectorPlugin(final Settings settings, final Path configPath) {\n+            this.settings = settings;\n+        }\n+\n+        @Override\n+        public Collection<Object> createComponents(Client client, ClusterService clusterService, ThreadPool threadPool,\n+                                                   ResourceWatcherService resourceWatcherService, ScriptService scriptService,\n+                                                   NamedXContentRegistry xContentRegistry, Environment environment,\n+                                                   NodeEnvironment nodeEnvironment, NamedWriteableRegistry namedWriteableRegistry,\n+                                                   IndexNameExpressionResolver indexNameExpressionResolver,\n+                                                   Supplier<RepositoriesService> repositoriesServiceSupplier) {\n+            if(injectedUser != null)\n+                threadPool.getThreadContext().putTransient(ConfigConstants.OPENDISTRO_SECURITY_INJECTED_USER, injectedUser);\n+            return new ArrayList<>();\n+        }\n+    }\n+\n+    //Wait for the security plugin to load roles.\n+    private void waitForInit(Client client) throws Exception {\n+        try {\n+            client.admin().cluster().health(new ClusterHealthRequest()).actionGet();\n+        } catch (ElasticsearchSecurityException ex) {\n+            if(ex.getMessage().contains(\"Open Distro Security not initialized\")) {\n+                Thread.sleep(500);\n+                waitForInit(client);\n+            }\n+        }\n+    }\n+\n+    @Test\n+    public void testOpendistroSecurityUserInjection() throws Exception {\n+        final Settings clusterNodeSettings = Settings.builder()\n+                .put(ConfigConstants.OPENDISTRO_SECURITY_UNSUPPORTED_INJECT_USER_ENABLED, true)\n+                .build();\n+        setup(clusterNodeSettings, new DynamicSecurityConfig().setSecurityRolesMapping(\"roles_transport_inject_user.yml\"), Settings.EMPTY);\n+        final Settings tcSettings = Settings.builder()\n+                .put(minimumSecuritySettings(Settings.EMPTY).get(0))\n+                .put(\"cluster.name\", clusterInfo.clustername)\n+                .put(\"node.data\", false)\n+                .put(\"node.master\", false)\n+                .put(\"node.ingest\", false)\n+                .put(\"path.data\", \"./target/data/\" + clusterInfo.clustername + \"/cert/data\")\n+                .put(\"path.logs\", \"./target/data/\" + clusterInfo.clustername + \"/cert/logs\")\n+                .put(\"path.home\", \"./target\")\n+                .put(\"node.name\", \"testclient\")\n+                .put(\"discovery.initial_state_timeout\", \"8s\")\n+                .put(\"opendistro_security.allow_default_init_securityindex\", \"true\")\n+                .put(ConfigConstants.OPENDISTRO_SECURITY_UNSUPPORTED_INJECT_USER_ENABLED, true)\n+                .putList(\"discovery.zen.ping.unicast.hosts\", clusterInfo.nodeHost + \":\" + clusterInfo.nodePort)\n+                .build();\n+\n+\n+        // 1. without user injection\n+        try (Node node = new PluginAwareNode(false, tcSettings, Netty4Plugin.class,\n+                OpenDistroSecurityPlugin.class, UserInjectorPlugin.class).start()) {\n+            waitForInit(node.client());\n+            CreateIndexResponse cir = node.client().admin().indices().create(new CreateIndexRequest(\"captain-logs-1\")).actionGet();\n+            Assert.assertTrue(cir.isAcknowledged());\n+        }\n+\n+\n+        // 2. with invalid backend roles\n+        UserInjectorPlugin.injectedUser = \"ttt|kkk\";\n+        Exception exception = null;\n+        try (Node node = new PluginAwareNode(false, tcSettings, Netty4Plugin.class,\n+                OpenDistroSecurityPlugin.class, UserInjectorPlugin.class).start()) {\n+            waitForInit(node.client());\n+            CreateIndexResponse cir = node.client().admin().indices().create(new CreateIndexRequest(\"captain-logs-2\")).actionGet();\n+        } catch (ElasticsearchSecurityException ex) {", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "72a42b4196415e9d8a182791014464238ac80676", "url": "https://github.com/opensearch-project/security/commit/72a42b4196415e9d8a182791014464238ac80676", "message": "Support user injection for transport requests", "committedDate": "2020-11-24T01:09:25Z", "type": "commit"}, {"oid": "72a42b4196415e9d8a182791014464238ac80676", "url": "https://github.com/opensearch-project/security/commit/72a42b4196415e9d8a182791014464238ac80676", "message": "Support user injection for transport requests", "committedDate": "2020-11-24T01:09:25Z", "type": "forcePushed"}]}