{"pr_number": 876, "pr_title": "Fix AuthCredentials equality", "pr_createdAt": "2020-12-04T23:25:49Z", "pr_url": "https://github.com/opensearch-project/security/pull/876", "timeline": [{"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NjYyMTgyNw==", "url": "https://github.com/opensearch-project/security/pull/876#discussion_r566621827", "bodyText": "Do we need to add && Objects.equals(password, other.password) here?", "author": "cliu123", "createdAt": "2021-01-29T07:18:14Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/user/AuthCredentials.java", "diffHunk": "@@ -175,19 +176,16 @@ public int hashCode() {\n     public boolean equals(Object obj) {\n         if (this == obj)\n             return true;\n-        if (obj == null)\n-            return false;\n-        if (getClass() != obj.getClass())\n+        if (obj == null || getClass() != obj.getClass()) {\n             return false;\n+        }\n+\n         AuthCredentials other = (AuthCredentials) obj;\n-        if (internalPasswordHash == null || other.internalPasswordHash == null || !MessageDigest.isEqual(internalPasswordHash, other.internalPasswordHash))\n-            return false;\n-        if (username == null) {\n-            if (other.username != null)\n-                return false;\n-        } else if (!username.equals(other.username))\n-            return false;\n-        return true;\n+        return Objects.equals(username, other.username)\n+            && Objects.equals(nativeCredentials, other.nativeCredentials)\n+            && Objects.equals(backendRoles, other.backendRoles)\n+            && MessageDigest.isEqual(internalPasswordHash, other.internalPasswordHash)\n+            && Objects.equals(attributes, other.attributes);", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NzAxNTQ5Nw==", "url": "https://github.com/opensearch-project/security/pull/876#discussion_r567015497", "bodyText": "The password is always filled with nulls and then set to null in the constructor, and the internalPasswordHash is used instead. We can check it here though if you prefer.", "author": "nicot", "createdAt": "2021-01-29T18:33:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NjYyMTgyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NzA3MTE5Nw==", "url": "https://github.com/opensearch-project/security/pull/876#discussion_r567071197", "bodyText": "Is it possible to be non-null values in any scenarios? If so, I'd add a check for it.", "author": "cliu123", "createdAt": "2021-01-29T20:17:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NjYyMTgyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NzA4NTQ1OQ==", "url": "https://github.com/opensearch-project/security/pull/876#discussion_r567085459", "bodyText": "It is not possible in any scenarios, but I can still add the check, is that what you'd prefer?", "author": "nicot", "createdAt": "2021-01-29T20:48:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NjYyMTgyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NzEwNjkxNA==", "url": "https://github.com/opensearch-project/security/pull/876#discussion_r567106914", "bodyText": "Yes, let's add the check. Thanks!", "author": "cliu123", "createdAt": "2021-01-29T21:36:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NjYyMTgyNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NjYyMzg0MQ==", "url": "https://github.com/opensearch-project/security/pull/876#discussion_r566623841", "bodyText": "Add 2 test cases?\n\nobject.internalPasswordHash == null && other.internalPasswordHash == null ==> equals() returns true\nobject.internalPasswordHash == null && other.internalPasswordHash == <non-null value> ==> equals() returns false.", "author": "cliu123", "createdAt": "2021-01-29T07:23:41Z", "path": "src/test/java/com/amazon/opendistroforelasticsearch/security/user/AuthCredentialsTests.java", "diffHunk": "@@ -0,0 +1,19 @@\n+package com.amazon.opendistroforelasticsearch.security.user;\n+\n+import org.junit.Assert;\n+import org.junit.Test;\n+\n+public class AuthCredentialsTests {\n+  @Test\n+  public void testEquality() {", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2ODA4NTYzMA==", "url": "https://github.com/opensearch-project/security/pull/876#discussion_r568085630", "bodyText": "@nicot How are the 2 test cases been taken care of?", "author": "cliu123", "createdAt": "2021-02-01T19:32:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NjYyMzg0MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2ODEyNjM1OA==", "url": "https://github.com/opensearch-project/security/pull/876#discussion_r568126358", "bodyText": "A user password will be null if we set the backendRoles.\n\nobject.internalPasswordHash == null && other.internalPasswordHash == null ==> equals() returns true\n\nThis is the test case on line 9 \u2014 the users have backendRoles, so the password is null for both.\n\nobject.internalPasswordHash == null && other.internalPasswordHash ==  ==> equals() returns false.\n\nThis is the test case on line 28 \u2014 one user has backendRoles and one has a password, and they are not equal.", "author": "nicot", "createdAt": "2021-02-01T20:43:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NjYyMzg0MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NjYzMDU5NQ==", "url": "https://github.com/opensearch-project/security/pull/876#discussion_r566630595", "bodyText": "Why is this change necessary? It doesn't look related to your change to me. Did I miss anything?", "author": "cliu123", "createdAt": "2021-01-29T07:40:39Z", "path": "src/test/java/com/amazon/opendistroforelasticsearch/security/cache/CachingTest.java", "diffHunk": "@@ -58,7 +58,7 @@ public void testRestCaching() throws Exception {\n \n         Assert.assertEquals(3, DummyHTTPAuthenticator.getCount());\n         Assert.assertEquals(1, DummyAuthorizer.getCount());\n-        Assert.assertEquals(3, DummyAuthenticationBackend.getAuthCount());\n+        Assert.assertEquals(1, DummyAuthenticationBackend.getAuthCount());", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NzAxNDI3OA==", "url": "https://github.com/opensearch-project/security/pull/876#discussion_r567014278", "bodyText": "My change fixes caching auth credentials, so the authentication backend is hit less. That's how I found this bug in the first place.", "author": "nicot", "createdAt": "2021-01-29T18:30:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NjYzMDU5NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NjYzMDY0MA==", "url": "https://github.com/opensearch-project/security/pull/876#discussion_r566630640", "bodyText": "Why is this change necessary? It doesn't look related to your change to me. Did I miss anything?", "author": "cliu123", "createdAt": "2021-01-29T07:40:46Z", "path": "src/test/java/com/amazon/opendistroforelasticsearch/security/cache/CachingTest.java", "diffHunk": "@@ -103,7 +103,7 @@ public void testRestCachingWithImpersonation() throws Exception {\n \n         Assert.assertEquals(4, DummyHTTPAuthenticator.getCount());\n         Assert.assertEquals(3, DummyAuthorizer.getCount());\n-        Assert.assertEquals(4, DummyAuthenticationBackend.getAuthCount());\n+        Assert.assertEquals(1, DummyAuthenticationBackend.getAuthCount());", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NzAxNDYwNQ==", "url": "https://github.com/opensearch-project/security/pull/876#discussion_r567014605", "bodyText": "Same here, caching auth credentials was broken before because equality wasn't working on the key. Now that it is fixed the calls to the authentication backend are properly cached and the backend is hit less.", "author": "nicot", "createdAt": "2021-01-29T18:31:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NjYzMDY0MA=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": "56a1b05334930640f38a45e7b6cbfb40944ea0a5", "url": "https://github.com/opensearch-project/security/commit/56a1b05334930640f38a45e7b6cbfb40944ea0a5", "message": "Fix AuthCredentials equality\n\nThis commit fixes the AuthCredentials class to correctly consider two AuthCredentials equal if they have the same username and both instances have null passwords. Before this commit, if both instances had null passwords, they would be considered not equal, causing them to never be cached. This fixes caching for backends using anonymous authentication.", "committedDate": "2021-01-29T23:24:05Z", "type": "commit"}, {"oid": "56a1b05334930640f38a45e7b6cbfb40944ea0a5", "url": "https://github.com/opensearch-project/security/commit/56a1b05334930640f38a45e7b6cbfb40944ea0a5", "message": "Fix AuthCredentials equality\n\nThis commit fixes the AuthCredentials class to correctly consider two AuthCredentials equal if they have the same username and both instances have null passwords. Before this commit, if both instances had null passwords, they would be considered not equal, causing them to never be cached. This fixes caching for backends using anonymous authentication.", "committedDate": "2021-01-29T23:24:05Z", "type": "forcePushed"}]}