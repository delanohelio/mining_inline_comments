{"pr_number": 306, "pr_title": "AuditLog: Refactor to audit config", "pr_createdAt": "2020-03-20T22:38:25Z", "pr_url": "https://github.com/opensearch-project/security/pull/306", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzUwNjkxNQ==", "url": "https://github.com/opensearch-project/security/pull/306#discussion_r397506915", "bodyText": "Consider isRestApiAuditEnabled.", "author": "vrozov", "createdAt": "2020-03-24T22:45:46Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/auditlog/config/AuditConfig.java", "diffHunk": "@@ -0,0 +1,195 @@\n+package com.amazon.opendistroforelasticsearch.security.auditlog.config;\n+\n+import com.amazon.opendistroforelasticsearch.security.auditlog.impl.AuditCategory;\n+import com.amazon.opendistroforelasticsearch.security.support.ConfigConstants;\n+import org.elasticsearch.common.settings.Settings;\n+\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.EnumSet;\n+import java.util.List;\n+\n+public class AuditConfig {\n+    private static final List<String> DEFAULT_IGNORED_USERS = Collections.singletonList(\"kibanaserver\");\n+    private static final List<String> DEFAULT_DISABLED_CATEGORIES =\n+            Arrays.asList(AuditCategory.AUTHENTICATED.toString(),\n+                    AuditCategory.GRANTED_PRIVILEGES.toString());\n+\n+    private final boolean restAuditingEnabled;", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzUwNzgzMw==", "url": "https://github.com/opensearch-project/security/pull/306#discussion_r397507833", "bodyText": "Set?", "author": "vrozov", "createdAt": "2020-03-24T22:48:02Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/auditlog/config/AuditConfig.java", "diffHunk": "@@ -0,0 +1,195 @@\n+package com.amazon.opendistroforelasticsearch.security.auditlog.config;\n+\n+import com.amazon.opendistroforelasticsearch.security.auditlog.impl.AuditCategory;\n+import com.amazon.opendistroforelasticsearch.security.support.ConfigConstants;\n+import org.elasticsearch.common.settings.Settings;\n+\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.EnumSet;\n+import java.util.List;\n+\n+public class AuditConfig {\n+    private static final List<String> DEFAULT_IGNORED_USERS = Collections.singletonList(\"kibanaserver\");\n+    private static final List<String> DEFAULT_DISABLED_CATEGORIES =\n+            Arrays.asList(AuditCategory.AUTHENTICATED.toString(),\n+                    AuditCategory.GRANTED_PRIVILEGES.toString());\n+\n+    private final boolean restAuditingEnabled;\n+    private final boolean transportAuditingEnabled;\n+    private final boolean resolveBulkRequests;\n+    private final boolean logRequestBody;\n+    private final boolean resolveIndices;\n+    private final boolean excludeSensitiveHeaders;\n+    private final List<String> ignoredAuditUsers;", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzUzODk3Mw==", "url": "https://github.com/opensearch-project/security/pull/306#discussion_r397538973", "bodyText": "Ignore users accepts pattern which may cause an issue with ordering and pattern matching.", "author": "sujithvm", "createdAt": "2020-03-25T00:18:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzUwNzgzMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzU0MTQzNA==", "url": "https://github.com/opensearch-project/security/pull/306#discussion_r397541434", "bodyText": "If an order is important (I don't think it is, as it is not \"match first\" or \"match last\"), use Set that preserves order (LinkedHashSet) as the implementation.", "author": "vrozov", "createdAt": "2020-03-25T00:26:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzUwNzgzMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzU0Njc2MQ==", "url": "https://github.com/opensearch-project/security/pull/306#discussion_r397546761", "bodyText": "This would propagate passing a higher level structure LinkedHashSet. We can't simply use Set type because it ll be important for consumers to know the underlying implementation that the set is ordered.", "author": "sujithvm", "createdAt": "2020-03-25T00:45:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzUwNzgzMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzU2MTE2Mg==", "url": "https://github.com/opensearch-project/security/pull/306#discussion_r397561162", "bodyText": "I looked into the current usage and don't think ordering matters so I ll move to Set with HashSet implementation", "author": "sujithvm", "createdAt": "2020-03-25T01:37:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzUwNzgzMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzUxNTYyNg==", "url": "https://github.com/opensearch-project/security/pull/306#discussion_r397515626", "bodyText": "I'd recommend using Builder pattern here as AuditConfig constructor takes a large number of arguments with the same type.", "author": "vrozov", "createdAt": "2020-03-24T23:08:39Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/auditlog/config/AuditConfig.java", "diffHunk": "@@ -0,0 +1,195 @@\n+package com.amazon.opendistroforelasticsearch.security.auditlog.config;\n+\n+import com.amazon.opendistroforelasticsearch.security.auditlog.impl.AuditCategory;\n+import com.amazon.opendistroforelasticsearch.security.support.ConfigConstants;\n+import org.elasticsearch.common.settings.Settings;\n+\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.EnumSet;\n+import java.util.List;\n+\n+public class AuditConfig {\n+    private static final List<String> DEFAULT_IGNORED_USERS = Collections.singletonList(\"kibanaserver\");\n+    private static final List<String> DEFAULT_DISABLED_CATEGORIES =\n+            Arrays.asList(AuditCategory.AUTHENTICATED.toString(),\n+                    AuditCategory.GRANTED_PRIVILEGES.toString());\n+\n+    private final boolean restAuditingEnabled;\n+    private final boolean transportAuditingEnabled;\n+    private final boolean resolveBulkRequests;\n+    private final boolean logRequestBody;\n+    private final boolean resolveIndices;\n+    private final boolean excludeSensitiveHeaders;\n+    private final List<String> ignoredAuditUsers;\n+    private final List<String> ignoredComplianceUsersForRead;\n+    private final List<String> ignoredComplianceUsersForWrite;\n+    private final List<String> ignoreAuditRequests;\n+    private final EnumSet<AuditCategory> disabledRestCategories;\n+    private final EnumSet<AuditCategory> disabledTransportCategories;\n+    private final String opendistrosecurityIndex;\n+\n+    public AuditConfig(final boolean restAuditingEnabled,", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzU0MTQ0Ng==", "url": "https://github.com/opensearch-project/security/pull/306#discussion_r397541446", "bodyText": "I did think about this but I don't see any places where config params will be set independently. Maybe when we need it, we can have it", "author": "sujithvm", "createdAt": "2020-03-25T00:26:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzUxNTYyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzU0Mjg4OQ==", "url": "https://github.com/opensearch-project/security/pull/306#discussion_r397542889", "bodyText": "If you don't want to introduce Builder now (I am OK with that), make the constructor private.", "author": "vrozov", "createdAt": "2020-03-25T00:31:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzUxNTYyNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzUxODk5Mw==", "url": "https://github.com/opensearch-project/security/pull/306#discussion_r397518993", "bodyText": "do not use this. Usually, log is a class variable, not an instance variable.", "author": "vrozov", "createdAt": "2020-03-24T23:18:10Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/auditlog/impl/AbstractAuditLog.java", "diffHunk": "@@ -118,77 +100,12 @@\n     protected AbstractAuditLog(Settings settings, final ThreadPool threadPool, final IndexNameExpressionResolver resolver, final ClusterService clusterService) {\n         super();\n         this.threadPool = threadPool;\n-\n         this.settings = settings;\n         this.resolver = resolver;\n         this.clusterService = clusterService;\n+        this.auditConfig = AuditConfig.getConfig(settings);\n \n-        this.opendistrosecurityIndex = settings.get(ConfigConstants.OPENDISTRO_SECURITY_CONFIG_INDEX_NAME, ConfigConstants.OPENDISTRO_SECURITY_DEFAULT_CONFIG_INDEX);\n-\n-        resolveBulkRequests = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_RESOLVE_BULK_REQUESTS, false);\n-\n-        restAuditingEnabled = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_ENABLE_REST, true);\n-        transportAuditingEnabled = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_ENABLE_TRANSPORT, true);\n-\n-        disabledRestCategories = AuditCategory.parse(getConfigList(\n-                settings,\n-                ConfigConstants.OPENDISTRO_SECURITY_AUDIT_CONFIG_DISABLED_REST_CATEGORIES,\n-                DEFAULT_DISABLED_CATEGORIES));\n-\n-        disabledTransportCategories = AuditCategory.parse(getConfigList(\n-                settings,\n-                ConfigConstants.OPENDISTRO_SECURITY_AUDIT_CONFIG_DISABLED_TRANSPORT_CATEGORIES,\n-                DEFAULT_DISABLED_CATEGORIES));\n-\n-        logRequestBody = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_LOG_REQUEST_BODY, true);\n-        resolveIndices = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_RESOLVE_INDICES, true);\n-\n-        ignoredAuditUsers = new ArrayList<>(settings.getAsList(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_IGNORE_USERS, defaultIgnoredUsers));\n-\n-        if(ignoredAuditUsers.size() == 1 && \"NONE\".equals(ignoredAuditUsers.get(0))) {\n-            ignoredAuditUsers.clear();\n-        }\n-\n-        if (ignoredAuditUsers.size() > 0) {\n-            log.info(\"Configured Users to ignore: {}\", ignoredAuditUsers);\n-        }\n-\n-        ignoredComplianceUsersForRead = new ArrayList<>(settings.getAsList(ConfigConstants.OPENDISTRO_SECURITY_COMPLIANCE_HISTORY_READ_IGNORE_USERS, defaultIgnoredUsers));\n-\n-        if(ignoredComplianceUsersForRead.size() == 1 && \"NONE\".equals(ignoredComplianceUsersForRead.get(0))) {\n-            ignoredComplianceUsersForRead.clear();\n-        }\n-\n-        if (ignoredComplianceUsersForRead.size() > 0) {\n-            log.info(\"Configured Users to ignore for read compliance events: {}\", ignoredComplianceUsersForRead);\n-        }\n-\n-        ignoredComplianceUsersForWrite = new ArrayList<>(settings.getAsList(ConfigConstants.OPENDISTRO_SECURITY_COMPLIANCE_HISTORY_WRITE_IGNORE_USERS, defaultIgnoredUsers));\n-\n-        if(ignoredComplianceUsersForWrite.size() == 1 && \"NONE\".equals(ignoredComplianceUsersForWrite.get(0))) {\n-            ignoredComplianceUsersForWrite.clear();\n-        }\n-\n-        if (ignoredComplianceUsersForWrite.size() > 0) {\n-            log.info(\"Configured Users to ignore for write compliance events: {}\", ignoredComplianceUsersForWrite);\n-        }\n-\n-        ignoreAuditRequests = settings.getAsList(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_IGNORE_REQUESTS, Collections.emptyList());\n-        if (ignoreAuditRequests.size() > 0) {\n-            log.info(\"Configured Requests to ignore: {}\", ignoreAuditRequests);\n-        }\n-\n-        this.excludeSensitiveHeaders = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_EXCLUDE_SENSITIVE_HEADERS, true);\n-    }\n-\n-    private static List<String> getConfigList(final Settings settings,\n-                                              final String key,\n-                                              final List<String> defaultList) {\n-        List<String> list = settings.getAsList(key, defaultList);\n-        if (list.size() == 1 && \"NONE\".equals(list.get(0))) {\n-            return Collections.emptyList();\n-        }\n-        return list;\n+        this.log.info(\"Configured audit settings: {}\", auditConfig.toString());", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzUzNjA2NQ==", "url": "https://github.com/opensearch-project/security/pull/306#discussion_r397536065", "bodyText": "Will make logger a class static", "author": "sujithvm", "createdAt": "2020-03-25T00:08:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzUxODk5Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzU0MDcyNg==", "url": "https://github.com/opensearch-project/security/pull/306#discussion_r397540726", "bodyText": "Since log is used in subclasses. Will not make it static as it needs reference to class.", "author": "sujithvm", "createdAt": "2020-03-25T00:24:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzUxODk5Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzU0NDk1OQ==", "url": "https://github.com/opensearch-project/security/pull/306#discussion_r397544959", "bodyText": "Please don't use this, so that if later log is changed to a class variable, it won't be necessary to introduce change here.", "author": "vrozov", "createdAt": "2020-03-25T00:39:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzUxODk5Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzUxOTcxOA==", "url": "https://github.com/opensearch-project/security/pull/306#discussion_r397519718", "bodyText": "Add new line.", "author": "vrozov", "createdAt": "2020-03-24T23:20:17Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/auditlog/config/AuditConfig.java", "diffHunk": "@@ -0,0 +1,195 @@\n+package com.amazon.opendistroforelasticsearch.security.auditlog.config;\n+\n+import com.amazon.opendistroforelasticsearch.security.auditlog.impl.AuditCategory;\n+import com.amazon.opendistroforelasticsearch.security.support.ConfigConstants;\n+import org.elasticsearch.common.settings.Settings;\n+\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.EnumSet;\n+import java.util.List;\n+\n+public class AuditConfig {\n+    private static final List<String> DEFAULT_IGNORED_USERS = Collections.singletonList(\"kibanaserver\");\n+    private static final List<String> DEFAULT_DISABLED_CATEGORIES =\n+            Arrays.asList(AuditCategory.AUTHENTICATED.toString(),\n+                    AuditCategory.GRANTED_PRIVILEGES.toString());\n+\n+    private final boolean restAuditingEnabled;\n+    private final boolean transportAuditingEnabled;\n+    private final boolean resolveBulkRequests;\n+    private final boolean logRequestBody;\n+    private final boolean resolveIndices;\n+    private final boolean excludeSensitiveHeaders;\n+    private final List<String> ignoredAuditUsers;\n+    private final List<String> ignoredComplianceUsersForRead;\n+    private final List<String> ignoredComplianceUsersForWrite;\n+    private final List<String> ignoreAuditRequests;\n+    private final EnumSet<AuditCategory> disabledRestCategories;\n+    private final EnumSet<AuditCategory> disabledTransportCategories;\n+    private final String opendistrosecurityIndex;\n+\n+    public AuditConfig(final boolean restAuditingEnabled,\n+                       final boolean transportAuditingEnabled,\n+                       final boolean resolveBulkRequests,\n+                       final boolean logRequestBody,\n+                       final boolean resolveIndices,\n+                       final boolean excludeSensitiveHeaders,\n+                       final List<String> ignoredAuditUsers,\n+                       final List<String> ignoredComplianceUsersForRead,\n+                       final List<String> ignoredComplianceUsersForWrite,\n+                       final List<String> ignoredAuditRequests,\n+                       final EnumSet<AuditCategory> disabledRestCategories,\n+                       final EnumSet<AuditCategory> disabledTransportCategories,\n+                       final String opendistrosecurityIndex) {\n+        this.restAuditingEnabled = restAuditingEnabled;\n+        this.transportAuditingEnabled = transportAuditingEnabled;\n+        this.resolveBulkRequests = resolveBulkRequests;\n+        this.logRequestBody = logRequestBody;\n+        this.resolveIndices = resolveIndices;\n+        this.excludeSensitiveHeaders = excludeSensitiveHeaders;\n+        this.ignoredAuditUsers = ignoredAuditUsers;\n+        this.ignoredComplianceUsersForRead = ignoredComplianceUsersForRead;\n+        this.ignoredComplianceUsersForWrite = ignoredComplianceUsersForWrite;\n+        this.ignoreAuditRequests = ignoredAuditRequests;\n+        this.disabledRestCategories = disabledRestCategories;\n+        this.disabledTransportCategories = disabledTransportCategories;\n+        this.opendistrosecurityIndex = opendistrosecurityIndex;\n+    }\n+\n+    public static AuditConfig getConfig(Settings settings) {\n+        final boolean restAuditingEnabled = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_ENABLE_REST, true);\n+        final boolean transportAuditingEnabled = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_ENABLE_TRANSPORT, true);\n+        final boolean resolveBulkRequests = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_RESOLVE_BULK_REQUESTS, false);\n+        final boolean logRequestBody = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_LOG_REQUEST_BODY, true);\n+        final boolean resolveIndices = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_RESOLVE_INDICES, true);\n+        final boolean excludeSensitiveHeaders = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_EXCLUDE_SENSITIVE_HEADERS, true);\n+\n+        final List<String> ignoredAuditUsers = getConfigList(\n+                settings,\n+                ConfigConstants.OPENDISTRO_SECURITY_AUDIT_IGNORE_USERS,\n+                DEFAULT_IGNORED_USERS);\n+\n+        final List<String> ignoredComplianceUsersForRead = getConfigList(\n+                settings,\n+                ConfigConstants.OPENDISTRO_SECURITY_COMPLIANCE_HISTORY_READ_IGNORE_USERS,\n+                DEFAULT_IGNORED_USERS);\n+\n+        final List<String> ignoredComplianceUsersForWrite = getConfigList(\n+                settings,\n+                ConfigConstants.OPENDISTRO_SECURITY_COMPLIANCE_HISTORY_WRITE_IGNORE_USERS,\n+                DEFAULT_IGNORED_USERS);\n+\n+        final List<String> ignoreAuditRequests = getConfigList(\n+                settings,\n+                ConfigConstants.OPENDISTRO_SECURITY_AUDIT_IGNORE_REQUESTS,\n+                Collections.emptyList());\n+\n+        final EnumSet<AuditCategory> disabledRestCategories = AuditCategory.parse(getConfigList(\n+                settings,\n+                ConfigConstants.OPENDISTRO_SECURITY_AUDIT_CONFIG_DISABLED_REST_CATEGORIES,\n+                DEFAULT_DISABLED_CATEGORIES));\n+\n+        final EnumSet<AuditCategory> disabledTransportCategories = AuditCategory.parse(getConfigList(\n+                settings,\n+                ConfigConstants.OPENDISTRO_SECURITY_AUDIT_CONFIG_DISABLED_TRANSPORT_CATEGORIES,\n+                DEFAULT_DISABLED_CATEGORIES));\n+\n+        final String opendistrosecurityIndex = settings.get(ConfigConstants.OPENDISTRO_SECURITY_CONFIG_INDEX_NAME, ConfigConstants.OPENDISTRO_SECURITY_DEFAULT_CONFIG_INDEX);\n+\n+        return new AuditConfig(restAuditingEnabled,\n+                transportAuditingEnabled,\n+                resolveBulkRequests,\n+                logRequestBody,\n+                resolveIndices,\n+                excludeSensitiveHeaders,\n+                ignoredAuditUsers,\n+                ignoredComplianceUsersForRead,\n+                ignoredComplianceUsersForWrite,\n+                ignoreAuditRequests,\n+                disabledRestCategories,\n+                disabledTransportCategories,\n+                opendistrosecurityIndex);\n+    }\n+\n+    private static List<String> getConfigList(final Settings settings,\n+                                              final String key,\n+                                              final List<String> defaultList) {\n+        List<String> list = settings.getAsList(key, defaultList);\n+        if (list.size() == 1 && \"NONE\".equals(list.get(0))) {\n+            return Collections.emptyList();\n+        }\n+        return list;\n+    }\n+\n+    public boolean isRestAuditingEnabled() {\n+        return restAuditingEnabled;\n+    }\n+\n+    public boolean isTransportAuditingEnabled() {\n+        return transportAuditingEnabled;\n+    }\n+\n+    public boolean shouldResolveBulkRequests() {\n+        return resolveBulkRequests;\n+    }\n+\n+    public boolean shouldLogRequestBody() {\n+        return logRequestBody;\n+    }\n+\n+    public boolean shouldResolveIndices() {\n+        return resolveIndices;\n+    }\n+\n+    public boolean shouldExcludeSensitiveHeaders() {\n+        return excludeSensitiveHeaders;\n+    }\n+\n+    public List<String> getIgnoredAuditUsers() {\n+        return ignoredAuditUsers;\n+    }\n+\n+    public List<String> getIgnoredComplianceUsersForRead() {\n+        return ignoredComplianceUsersForRead;\n+    }\n+\n+    public List<String> getIgnoredComplianceUsersForWrite() {\n+        return ignoredComplianceUsersForWrite;\n+    }\n+\n+    public List<String> getIgnoredAuditRequests() {\n+        return ignoreAuditRequests;\n+    }\n+\n+    public EnumSet<AuditCategory> getDisabledRestCategories() {\n+        return disabledRestCategories;\n+    }\n+\n+    public EnumSet<AuditCategory> getDisabledTransportCategories() {\n+        return disabledTransportCategories;\n+    }\n+\n+    public String getOpendistrosecurityIndex() {\n+        return opendistrosecurityIndex;\n+    }\n+\n+    @Override\n+    public String toString() {\n+        return \"AuditConfig{\" +\n+                \"restAuditingEnabled=\" + restAuditingEnabled +\n+                \", transportAuditingEnabled=\" + transportAuditingEnabled +\n+                \", resolveBulkRequests=\" + resolveBulkRequests +\n+                \", logRequestBody=\" + logRequestBody +\n+                \", resolveIndices=\" + resolveIndices +\n+                \", excludeSensitiveHeaders=\" + excludeSensitiveHeaders +\n+                \", ignoredAuditUsers=\" + ignoredAuditUsers +\n+                \", ignoredComplianceUsersForRead=\" + ignoredComplianceUsersForRead +\n+                \", ignoredComplianceUsersForWrite=\" + ignoredComplianceUsersForWrite +\n+                \", ignoreAuditRequests=\" + ignoreAuditRequests +\n+                \", disabledRestCategories=\" + disabledRestCategories +\n+                \", disabledTransportCategories=\" + disabledTransportCategories +\n+                \", opendistrosecurityIndex='\" + opendistrosecurityIndex + '\\'' +\n+                '}';\n+    }\n+}", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzUyMjU2Ng==", "url": "https://github.com/opensearch-project/security/pull/306#discussion_r397522566", "bodyText": "I guess it should be protected to be consistent with other member variables.", "author": "vrozov", "createdAt": "2020-03-24T23:28:26Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/auditlog/impl/AbstractAuditLog.java", "diffHunk": "@@ -81,32 +80,15 @@\n \n public abstract class AbstractAuditLog implements AuditLog {\n \n-    private static final List<String> DEFAULT_DISABLED_CATEGORIES = Arrays.asList(AuditCategory.AUTHENTICATED.toString(), AuditCategory.GRANTED_PRIVILEGES.toString());\n-\n     protected final Logger log = LogManager.getLogger(this.getClass());\n     protected final ThreadPool threadPool;\n     protected final IndexNameExpressionResolver resolver;\n     protected final ClusterService clusterService;\n     protected final Settings settings;\n-    protected final boolean restAuditingEnabled;\n-    protected final boolean transportAuditingEnabled;\n-    protected final boolean resolveBulkRequests;\n-\n-    protected final boolean logRequestBody;\n-    protected final boolean resolveIndices;\n-\n-    private List<String> ignoredAuditUsers;\n-    private List<String> ignoredComplianceUsersForRead;\n-    private List<String> ignoredComplianceUsersForWrite;\n-    private final List<String> ignoreAuditRequests;\n-    private final EnumSet<AuditCategory> disabledRestCategories;\n-    private final EnumSet<AuditCategory> disabledTransportCategories;\n-    private final List<String> defaultIgnoredUsers = Arrays.asList(\"kibanaserver\");\n-    private final boolean excludeSensitiveHeaders;\n-\n-    private final String opendistrosecurityIndex;\n-    private static final List<String> writeClasses = new ArrayList<>();\n \n+    private final AuditConfig auditConfig;", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzUyNDIyOA==", "url": "https://github.com/opensearch-project/security/pull/306#discussion_r397524228", "bodyText": "IMO, isEmpty() will be better", "author": "vrozov", "createdAt": "2020-03-24T23:32:57Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/auditlog/impl/AbstractAuditLog.java", "diffHunk": "@@ -737,6 +654,7 @@ private boolean checkTransportFilter(final AuditCategory category, final String\n             return false;\n         }\n \n+        final Collection<String>ignoredAuditUsers = auditConfig.getIgnoredAuditUsers();\n         if (ignoredAuditUsers.size() > 0 && WildcardMatcher.matchAny(ignoredAuditUsers, effectiveUser)) {", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODg1MDAxMg==", "url": "https://github.com/opensearch-project/security/pull/306#discussion_r398850012", "bodyText": "Logging entire configuration when configured. Hence removed these info logs.", "author": "sujithvm", "createdAt": "2020-03-26T19:51:44Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/auditlog/impl/AbstractAuditLog.java", "diffHunk": "@@ -118,81 +99,12 @@\n     protected AbstractAuditLog(Settings settings, final ThreadPool threadPool, final IndexNameExpressionResolver resolver, final ClusterService clusterService) {\n         super();\n         this.threadPool = threadPool;\n-\n         this.settings = settings;\n         this.resolver = resolver;\n         this.clusterService = clusterService;\n+        this.auditConfig = AuditConfig.getConfig(settings);\n \n-        this.opendistrosecurityIndex = settings.get(ConfigConstants.OPENDISTRO_SECURITY_CONFIG_INDEX_NAME, ConfigConstants.OPENDISTRO_SECURITY_DEFAULT_CONFIG_INDEX);\n-\n-        resolveBulkRequests = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_RESOLVE_BULK_REQUESTS, false);\n-\n-        restAuditingEnabled = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_ENABLE_REST, true);\n-        transportAuditingEnabled = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_ENABLE_TRANSPORT, true);\n-\n-        final List<String> disabledRestCategoriesList = settings.getAsList(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_CONFIG_DISABLED_REST_CATEGORIES, DEFAULT_DISABLED_CATEGORIES);\n-\n-        if (disabledRestCategoriesList.isEmpty() || (disabledRestCategoriesList.size() == 1 && \"NONE\".equalsIgnoreCase(disabledRestCategoriesList.get(0)))) {\n-            disabledRestCategories = EnumSet.noneOf(AuditCategory.class);\n-        } else {\n-            disabledRestCategories = AuditCategory.parse(disabledRestCategoriesList);\n-        }\n-\n-        if (!disabledRestCategories.isEmpty()) {\n-            log.info(\"Configured categories on rest layer to ignore: {}\", disabledRestCategories);", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODk0NDQzNA==", "url": "https://github.com/opensearch-project/security/pull/306#discussion_r398944434", "bodyText": "introduce helper function", "author": "vrozov", "createdAt": "2020-03-26T23:07:19Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/auditlog/config/AuditConfig.java", "diffHunk": "@@ -0,0 +1,190 @@\n+package com.amazon.opendistroforelasticsearch.security.auditlog.config;\n+\n+import com.amazon.opendistroforelasticsearch.security.auditlog.impl.AuditCategory;\n+import com.amazon.opendistroforelasticsearch.security.support.ConfigConstants;\n+import org.elasticsearch.common.settings.Settings;\n+\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.EnumSet;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Set;\n+\n+public class AuditConfig {\n+    private static final List<String> DEFAULT_IGNORED_USERS = Collections.singletonList(\"kibanaserver\");\n+    private static final List<String> DEFAULT_DISABLED_CATEGORIES =\n+            Arrays.asList(AuditCategory.AUTHENTICATED.toString(),\n+                    AuditCategory.GRANTED_PRIVILEGES.toString());\n+\n+    private final boolean isRestApiAuditEnabled;\n+    private final boolean isTransportAuditEnabled;\n+    private final boolean resolveBulkRequests;\n+    private final boolean logRequestBody;\n+    private final boolean resolveIndices;\n+    private final boolean excludeSensitiveHeaders;\n+    private final Set<String> ignoredAuditUsers;\n+    private final Set<String> ignoredComplianceUsersForRead;\n+    private final Set<String> ignoredComplianceUsersForWrite;\n+    private final Set<String> ignoreAuditRequests;\n+    private final EnumSet<AuditCategory> disabledRestCategories;\n+    private final EnumSet<AuditCategory> disabledTransportCategories;\n+    private final String opendistrosecurityIndex;\n+\n+    private AuditConfig(final boolean isRestApiAuditEnabled,\n+                        final boolean isTransportAuditEnabled,\n+                        final boolean resolveBulkRequests,\n+                        final boolean logRequestBody,\n+                        final boolean resolveIndices,\n+                        final boolean excludeSensitiveHeaders,\n+                        final Set<String> ignoredAuditUsers,\n+                        final Set<String> ignoredComplianceUsersForRead,\n+                        final Set<String> ignoredComplianceUsersForWrite,\n+                        final Set<String> ignoredAuditRequests,\n+                        final EnumSet<AuditCategory> disabledRestCategories,\n+                        final EnumSet<AuditCategory> disabledTransportCategories,\n+                        final String opendistrosecurityIndex) {\n+        this.isRestApiAuditEnabled = isRestApiAuditEnabled;\n+        this.isTransportAuditEnabled = isTransportAuditEnabled;\n+        this.resolveBulkRequests = resolveBulkRequests;\n+        this.logRequestBody = logRequestBody;\n+        this.resolveIndices = resolveIndices;\n+        this.excludeSensitiveHeaders = excludeSensitiveHeaders;\n+        this.ignoredAuditUsers = ignoredAuditUsers;\n+        this.ignoredComplianceUsersForRead = ignoredComplianceUsersForRead;\n+        this.ignoredComplianceUsersForWrite = ignoredComplianceUsersForWrite;\n+        this.ignoreAuditRequests = ignoredAuditRequests;\n+        this.disabledRestCategories = disabledRestCategories;\n+        this.disabledTransportCategories = disabledTransportCategories;\n+        this.opendistrosecurityIndex = opendistrosecurityIndex;\n+    }\n+\n+    public static AuditConfig getConfig(Settings settings) {\n+        final boolean isRestApiAuditEnabled = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_ENABLE_REST, true);\n+        final boolean isTransportAuditEnabled = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_ENABLE_TRANSPORT, true);\n+        final boolean resolveBulkRequests = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_RESOLVE_BULK_REQUESTS, false);\n+        final boolean logRequestBody = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_LOG_REQUEST_BODY, true);\n+        final boolean resolveIndices = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_RESOLVE_INDICES, true);\n+        final boolean excludeSensitiveHeaders = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_EXCLUDE_SENSITIVE_HEADERS, true);\n+        final String opendistrosecurityIndex = settings.get(ConfigConstants.OPENDISTRO_SECURITY_CONFIG_INDEX_NAME, ConfigConstants.OPENDISTRO_SECURITY_DEFAULT_CONFIG_INDEX);\n+\n+        final EnumSet<AuditCategory> disabledRestCategories;\n+        final List<String> disabledRestCategoriesList = settings.getAsList(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_CONFIG_DISABLED_REST_CATEGORIES, DEFAULT_DISABLED_CATEGORIES);\n+        if (disabledRestCategoriesList.isEmpty() || (disabledRestCategoriesList.size() == 1 && \"NONE\".equalsIgnoreCase(disabledRestCategoriesList.get(0)))) {", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTAwNDc4Ng==", "url": "https://github.com/opensearch-project/security/pull/306#discussion_r399004786", "bodyText": "I would appreciate if you could help design this helper function. Previously I had\nprivate static List<String> getSettingAsList(final Settings settings, final String key, final List<String> defaultList) {\n        final List<String> list = settings.getAsList(key, defaultList);\n        if (list.size() == 1 && \"NONE\".equals(list.get(0))) {\n            return Collections.emptyList();\n        }\n        return list;\n    }\n\nLooks like other params consider only \"NONE\" as implicitly empty (none, None are not considered). Do you want to retain this behavior or clear it in #325", "author": "sujithvm", "createdAt": "2020-03-27T02:44:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODk0NDQzNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTAxNTIyMg==", "url": "https://github.com/opensearch-project/security/pull/306#discussion_r399015222", "bodyText": "One way is to pass a flag whether \"NONE\" is case sensitive or not. Assuming that \"NONE\" will be deprecated soon, I suggest retaining the current behavior.", "author": "vrozov", "createdAt": "2020-03-27T03:26:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODk0NDQzNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTAxNzI1Ng==", "url": "https://github.com/opensearch-project/security/pull/306#discussion_r399017256", "bodyText": "Alright!\nSadly, I feel case in-sensitive handling of none was accidental in categories because of making it uppercase for enums and now have to deal with this complexity.", "author": "sujithvm", "createdAt": "2020-03-27T03:35:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODk0NDQzNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODk0NDg3Mw==", "url": "https://github.com/opensearch-project/security/pull/306#discussion_r398944873", "bodyText": "There is no need to create new ArrayList.", "author": "vrozov", "createdAt": "2020-03-26T23:08:46Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/auditlog/config/AuditConfig.java", "diffHunk": "@@ -0,0 +1,190 @@\n+package com.amazon.opendistroforelasticsearch.security.auditlog.config;\n+\n+import com.amazon.opendistroforelasticsearch.security.auditlog.impl.AuditCategory;\n+import com.amazon.opendistroforelasticsearch.security.support.ConfigConstants;\n+import org.elasticsearch.common.settings.Settings;\n+\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.EnumSet;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Set;\n+\n+public class AuditConfig {\n+    private static final List<String> DEFAULT_IGNORED_USERS = Collections.singletonList(\"kibanaserver\");\n+    private static final List<String> DEFAULT_DISABLED_CATEGORIES =\n+            Arrays.asList(AuditCategory.AUTHENTICATED.toString(),\n+                    AuditCategory.GRANTED_PRIVILEGES.toString());\n+\n+    private final boolean isRestApiAuditEnabled;\n+    private final boolean isTransportAuditEnabled;\n+    private final boolean resolveBulkRequests;\n+    private final boolean logRequestBody;\n+    private final boolean resolveIndices;\n+    private final boolean excludeSensitiveHeaders;\n+    private final Set<String> ignoredAuditUsers;\n+    private final Set<String> ignoredComplianceUsersForRead;\n+    private final Set<String> ignoredComplianceUsersForWrite;\n+    private final Set<String> ignoreAuditRequests;\n+    private final EnumSet<AuditCategory> disabledRestCategories;\n+    private final EnumSet<AuditCategory> disabledTransportCategories;\n+    private final String opendistrosecurityIndex;\n+\n+    private AuditConfig(final boolean isRestApiAuditEnabled,\n+                        final boolean isTransportAuditEnabled,\n+                        final boolean resolveBulkRequests,\n+                        final boolean logRequestBody,\n+                        final boolean resolveIndices,\n+                        final boolean excludeSensitiveHeaders,\n+                        final Set<String> ignoredAuditUsers,\n+                        final Set<String> ignoredComplianceUsersForRead,\n+                        final Set<String> ignoredComplianceUsersForWrite,\n+                        final Set<String> ignoredAuditRequests,\n+                        final EnumSet<AuditCategory> disabledRestCategories,\n+                        final EnumSet<AuditCategory> disabledTransportCategories,\n+                        final String opendistrosecurityIndex) {\n+        this.isRestApiAuditEnabled = isRestApiAuditEnabled;\n+        this.isTransportAuditEnabled = isTransportAuditEnabled;\n+        this.resolveBulkRequests = resolveBulkRequests;\n+        this.logRequestBody = logRequestBody;\n+        this.resolveIndices = resolveIndices;\n+        this.excludeSensitiveHeaders = excludeSensitiveHeaders;\n+        this.ignoredAuditUsers = ignoredAuditUsers;\n+        this.ignoredComplianceUsersForRead = ignoredComplianceUsersForRead;\n+        this.ignoredComplianceUsersForWrite = ignoredComplianceUsersForWrite;\n+        this.ignoreAuditRequests = ignoredAuditRequests;\n+        this.disabledRestCategories = disabledRestCategories;\n+        this.disabledTransportCategories = disabledTransportCategories;\n+        this.opendistrosecurityIndex = opendistrosecurityIndex;\n+    }\n+\n+    public static AuditConfig getConfig(Settings settings) {\n+        final boolean isRestApiAuditEnabled = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_ENABLE_REST, true);\n+        final boolean isTransportAuditEnabled = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_ENABLE_TRANSPORT, true);\n+        final boolean resolveBulkRequests = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_RESOLVE_BULK_REQUESTS, false);\n+        final boolean logRequestBody = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_LOG_REQUEST_BODY, true);\n+        final boolean resolveIndices = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_RESOLVE_INDICES, true);\n+        final boolean excludeSensitiveHeaders = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_EXCLUDE_SENSITIVE_HEADERS, true);\n+        final String opendistrosecurityIndex = settings.get(ConfigConstants.OPENDISTRO_SECURITY_CONFIG_INDEX_NAME, ConfigConstants.OPENDISTRO_SECURITY_DEFAULT_CONFIG_INDEX);\n+\n+        final EnumSet<AuditCategory> disabledRestCategories;\n+        final List<String> disabledRestCategoriesList = settings.getAsList(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_CONFIG_DISABLED_REST_CATEGORIES, DEFAULT_DISABLED_CATEGORIES);\n+        if (disabledRestCategoriesList.isEmpty() || (disabledRestCategoriesList.size() == 1 && \"NONE\".equalsIgnoreCase(disabledRestCategoriesList.get(0)))) {\n+            disabledRestCategories = EnumSet.noneOf(AuditCategory.class);\n+        } else {\n+            disabledRestCategories = AuditCategory.parse(disabledRestCategoriesList);\n+        }\n+\n+        final EnumSet<AuditCategory> disabledTransportCategories;\n+        final List<String> disabledTransportCategoriesList = settings.getAsList(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_CONFIG_DISABLED_TRANSPORT_CATEGORIES, DEFAULT_DISABLED_CATEGORIES);\n+        if (disabledTransportCategoriesList.isEmpty() || (disabledTransportCategoriesList.size() == 1 && \"NONE\".equalsIgnoreCase(disabledTransportCategoriesList.get(0)))) {\n+            disabledTransportCategories = EnumSet.noneOf(AuditCategory.class);\n+        } else {\n+            disabledTransportCategories = AuditCategory.parse(disabledTransportCategoriesList);\n+        }\n+\n+        final List<String> ignoredAuditUsers = new ArrayList<>(settings.getAsList(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_IGNORE_USERS, DEFAULT_IGNORED_USERS));", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODk5NjI4OA==", "url": "https://github.com/opensearch-project/security/pull/306#discussion_r398996288", "bodyText": "Won't this have a side-effect clearing the function unless getAsList returns a new list always?", "author": "sujithvm", "createdAt": "2020-03-27T02:10:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODk0NDg3Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTAwMTM1Nw==", "url": "https://github.com/opensearch-project/security/pull/306#discussion_r399001357", "bodyText": "There is no need to clear the original collection, use an empty collection.", "author": "vrozov", "createdAt": "2020-03-27T02:30:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODk0NDg3Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODk0OTY4MA==", "url": "https://github.com/opensearch-project/security/pull/306#discussion_r398949680", "bodyText": "auditConfig.toString() will translate to an extremely long string that will be hard to digest.", "author": "vrozov", "createdAt": "2020-03-26T23:23:07Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/auditlog/impl/AbstractAuditLog.java", "diffHunk": "@@ -118,81 +99,12 @@\n     protected AbstractAuditLog(Settings settings, final ThreadPool threadPool, final IndexNameExpressionResolver resolver, final ClusterService clusterService) {\n         super();\n         this.threadPool = threadPool;\n-\n         this.settings = settings;\n         this.resolver = resolver;\n         this.clusterService = clusterService;\n+        this.auditConfig = AuditConfig.getConfig(settings);\n \n-        this.opendistrosecurityIndex = settings.get(ConfigConstants.OPENDISTRO_SECURITY_CONFIG_INDEX_NAME, ConfigConstants.OPENDISTRO_SECURITY_DEFAULT_CONFIG_INDEX);\n-\n-        resolveBulkRequests = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_RESOLVE_BULK_REQUESTS, false);\n-\n-        restAuditingEnabled = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_ENABLE_REST, true);\n-        transportAuditingEnabled = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_ENABLE_TRANSPORT, true);\n-\n-        final List<String> disabledRestCategoriesList = settings.getAsList(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_CONFIG_DISABLED_REST_CATEGORIES, DEFAULT_DISABLED_CATEGORIES);\n-\n-        if (disabledRestCategoriesList.isEmpty() || (disabledRestCategoriesList.size() == 1 && \"NONE\".equalsIgnoreCase(disabledRestCategoriesList.get(0)))) {\n-            disabledRestCategories = EnumSet.noneOf(AuditCategory.class);\n-        } else {\n-            disabledRestCategories = AuditCategory.parse(disabledRestCategoriesList);\n-        }\n-\n-        if (!disabledRestCategories.isEmpty()) {\n-            log.info(\"Configured categories on rest layer to ignore: {}\", disabledRestCategories);\n-        }\n-\n-        final List<String> disabledTransportCategoriesList = settings.getAsList(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_CONFIG_DISABLED_TRANSPORT_CATEGORIES, DEFAULT_DISABLED_CATEGORIES);\n-\n-        if (disabledTransportCategoriesList.isEmpty() || (disabledTransportCategoriesList.size() == 1 && \"NONE\".equalsIgnoreCase(disabledTransportCategoriesList.get(0)))) {\n-            disabledTransportCategories = EnumSet.noneOf(AuditCategory.class);\n-        } else {\n-            disabledTransportCategories = AuditCategory.parse(disabledTransportCategoriesList);\n-        }\n-\n-        if (!disabledTransportCategories.isEmpty()) {\n-            log.info(\"Configured categories on transport layer to ignore: {}\", disabledTransportCategories);\n-        }\n-\n-        logRequestBody = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_LOG_REQUEST_BODY, true);\n-        resolveIndices = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_RESOLVE_INDICES, true);\n-\n-        ignoredAuditUsers = new ArrayList<>(settings.getAsList(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_IGNORE_USERS, defaultIgnoredUsers));\n-\n-        if(ignoredAuditUsers.size() == 1 && \"NONE\".equals(ignoredAuditUsers.get(0))) {\n-            ignoredAuditUsers.clear();\n-        }\n-\n-        if (ignoredAuditUsers.size() > 0) {\n-            log.info(\"Configured Users to ignore: {}\", ignoredAuditUsers);\n-        }\n-\n-        ignoredComplianceUsersForRead = new ArrayList<>(settings.getAsList(ConfigConstants.OPENDISTRO_SECURITY_COMPLIANCE_HISTORY_READ_IGNORE_USERS, defaultIgnoredUsers));\n-\n-        if(ignoredComplianceUsersForRead.size() == 1 && \"NONE\".equals(ignoredComplianceUsersForRead.get(0))) {\n-            ignoredComplianceUsersForRead.clear();\n-        }\n-\n-        if (ignoredComplianceUsersForRead.size() > 0) {\n-            log.info(\"Configured Users to ignore for read compliance events: {}\", ignoredComplianceUsersForRead);\n-        }\n-\n-        ignoredComplianceUsersForWrite = new ArrayList<>(settings.getAsList(ConfigConstants.OPENDISTRO_SECURITY_COMPLIANCE_HISTORY_WRITE_IGNORE_USERS, defaultIgnoredUsers));\n-\n-        if(ignoredComplianceUsersForWrite.size() == 1 && \"NONE\".equals(ignoredComplianceUsersForWrite.get(0))) {\n-            ignoredComplianceUsersForWrite.clear();\n-        }\n-\n-        if (ignoredComplianceUsersForWrite.size() > 0) {\n-            log.info(\"Configured Users to ignore for write compliance events: {}\", ignoredComplianceUsersForWrite);\n-        }\n-\n-        ignoreAuditRequests = settings.getAsList(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_IGNORE_REQUESTS, Collections.emptyList());\n-        if (ignoreAuditRequests.size() > 0) {\n-            log.info(\"Configured Requests to ignore: {}\", ignoreAuditRequests);\n-        }\n-\n-        this.excludeSensitiveHeaders = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_EXCLUDE_SENSITIVE_HEADERS, true);\n+        log.info(\"Configured audit settings: {}\", auditConfig.toString());", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODk5Nzc1NQ==", "url": "https://github.com/opensearch-project/security/pull/306#discussion_r398997755", "bodyText": "What would you suggest?", "author": "sujithvm", "createdAt": "2020-03-27T02:16:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODk0OTY4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTAxMjM3Ng==", "url": "https://github.com/opensearch-project/security/pull/306#discussion_r399012376", "bodyText": "I guess it will be good to log (one settings per log entry) only those settings that are different from the default, especially for boolean flags.", "author": "vrozov", "createdAt": "2020-03-27T03:14:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODk0OTY4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTAxNTQ2Mg==", "url": "https://github.com/opensearch-project/security/pull/306#discussion_r399015462", "bodyText": "Original logging was done only for lists and not for boolean. So I thought, it ll be better to log all.\nWhat do you think of prettifying toString() to something more descriptive ?", "author": "sujithvm", "createdAt": "2020-03-27T03:28:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODk0OTY4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTAzMDc1Ng==", "url": "https://github.com/opensearch-project/security/pull/306#discussion_r399030756", "bodyText": "It is an option but it will most likely mess up Intellij debugger. I'd recommend avoiding toString().", "author": "vrozov", "createdAt": "2020-03-27T04:36:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODk0OTY4MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODk1MDk4Mw==", "url": "https://github.com/opensearch-project/security/pull/306#discussion_r398950983", "bodyText": "Add new line", "author": "vrozov", "createdAt": "2020-03-26T23:26:47Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/auditlog/impl/AbstractAuditLog.java", "diffHunk": "@@ -869,4 +788,4 @@ private boolean checkRestFilter(final AuditCategory category, final String effec\n \n \n     protected abstract void save(final AuditMessage msg);\n-}\n+}", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODk1NTA4MA==", "url": "https://github.com/opensearch-project/security/pull/306#discussion_r398955080", "bodyText": "ImmutableSet.copyOf()? Consider moving Collection->Set (or ImmutableSet) converstion to AuditConfig constructor.", "author": "vrozov", "createdAt": "2020-03-26T23:39:43Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/auditlog/config/AuditConfig.java", "diffHunk": "@@ -0,0 +1,190 @@\n+package com.amazon.opendistroforelasticsearch.security.auditlog.config;\n+\n+import com.amazon.opendistroforelasticsearch.security.auditlog.impl.AuditCategory;\n+import com.amazon.opendistroforelasticsearch.security.support.ConfigConstants;\n+import org.elasticsearch.common.settings.Settings;\n+\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.EnumSet;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Set;\n+\n+public class AuditConfig {\n+    private static final List<String> DEFAULT_IGNORED_USERS = Collections.singletonList(\"kibanaserver\");\n+    private static final List<String> DEFAULT_DISABLED_CATEGORIES =\n+            Arrays.asList(AuditCategory.AUTHENTICATED.toString(),\n+                    AuditCategory.GRANTED_PRIVILEGES.toString());\n+\n+    private final boolean isRestApiAuditEnabled;\n+    private final boolean isTransportAuditEnabled;\n+    private final boolean resolveBulkRequests;\n+    private final boolean logRequestBody;\n+    private final boolean resolveIndices;\n+    private final boolean excludeSensitiveHeaders;\n+    private final Set<String> ignoredAuditUsers;\n+    private final Set<String> ignoredComplianceUsersForRead;\n+    private final Set<String> ignoredComplianceUsersForWrite;\n+    private final Set<String> ignoreAuditRequests;\n+    private final EnumSet<AuditCategory> disabledRestCategories;\n+    private final EnumSet<AuditCategory> disabledTransportCategories;\n+    private final String opendistrosecurityIndex;\n+\n+    private AuditConfig(final boolean isRestApiAuditEnabled,\n+                        final boolean isTransportAuditEnabled,\n+                        final boolean resolveBulkRequests,\n+                        final boolean logRequestBody,\n+                        final boolean resolveIndices,\n+                        final boolean excludeSensitiveHeaders,\n+                        final Set<String> ignoredAuditUsers,\n+                        final Set<String> ignoredComplianceUsersForRead,\n+                        final Set<String> ignoredComplianceUsersForWrite,\n+                        final Set<String> ignoredAuditRequests,\n+                        final EnumSet<AuditCategory> disabledRestCategories,\n+                        final EnumSet<AuditCategory> disabledTransportCategories,\n+                        final String opendistrosecurityIndex) {\n+        this.isRestApiAuditEnabled = isRestApiAuditEnabled;\n+        this.isTransportAuditEnabled = isTransportAuditEnabled;\n+        this.resolveBulkRequests = resolveBulkRequests;\n+        this.logRequestBody = logRequestBody;\n+        this.resolveIndices = resolveIndices;\n+        this.excludeSensitiveHeaders = excludeSensitiveHeaders;\n+        this.ignoredAuditUsers = ignoredAuditUsers;\n+        this.ignoredComplianceUsersForRead = ignoredComplianceUsersForRead;\n+        this.ignoredComplianceUsersForWrite = ignoredComplianceUsersForWrite;\n+        this.ignoreAuditRequests = ignoredAuditRequests;\n+        this.disabledRestCategories = disabledRestCategories;\n+        this.disabledTransportCategories = disabledTransportCategories;\n+        this.opendistrosecurityIndex = opendistrosecurityIndex;\n+    }\n+\n+    public static AuditConfig getConfig(Settings settings) {\n+        final boolean isRestApiAuditEnabled = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_ENABLE_REST, true);\n+        final boolean isTransportAuditEnabled = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_ENABLE_TRANSPORT, true);\n+        final boolean resolveBulkRequests = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_RESOLVE_BULK_REQUESTS, false);\n+        final boolean logRequestBody = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_LOG_REQUEST_BODY, true);\n+        final boolean resolveIndices = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_RESOLVE_INDICES, true);\n+        final boolean excludeSensitiveHeaders = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_EXCLUDE_SENSITIVE_HEADERS, true);\n+        final String opendistrosecurityIndex = settings.get(ConfigConstants.OPENDISTRO_SECURITY_CONFIG_INDEX_NAME, ConfigConstants.OPENDISTRO_SECURITY_DEFAULT_CONFIG_INDEX);\n+\n+        final EnumSet<AuditCategory> disabledRestCategories;\n+        final List<String> disabledRestCategoriesList = settings.getAsList(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_CONFIG_DISABLED_REST_CATEGORIES, DEFAULT_DISABLED_CATEGORIES);\n+        if (disabledRestCategoriesList.isEmpty() || (disabledRestCategoriesList.size() == 1 && \"NONE\".equalsIgnoreCase(disabledRestCategoriesList.get(0)))) {\n+            disabledRestCategories = EnumSet.noneOf(AuditCategory.class);\n+        } else {\n+            disabledRestCategories = AuditCategory.parse(disabledRestCategoriesList);\n+        }\n+\n+        final EnumSet<AuditCategory> disabledTransportCategories;\n+        final List<String> disabledTransportCategoriesList = settings.getAsList(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_CONFIG_DISABLED_TRANSPORT_CATEGORIES, DEFAULT_DISABLED_CATEGORIES);\n+        if (disabledTransportCategoriesList.isEmpty() || (disabledTransportCategoriesList.size() == 1 && \"NONE\".equalsIgnoreCase(disabledTransportCategoriesList.get(0)))) {\n+            disabledTransportCategories = EnumSet.noneOf(AuditCategory.class);\n+        } else {\n+            disabledTransportCategories = AuditCategory.parse(disabledTransportCategoriesList);\n+        }\n+\n+        final List<String> ignoredAuditUsers = new ArrayList<>(settings.getAsList(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_IGNORE_USERS, DEFAULT_IGNORED_USERS));\n+        if (ignoredAuditUsers.size() == 1 && \"NONE\".equals(ignoredAuditUsers.get(0))) {\n+            ignoredAuditUsers.clear();\n+        }\n+\n+        final List<String> ignoredComplianceUsersForRead = new ArrayList<>(settings.getAsList(ConfigConstants.OPENDISTRO_SECURITY_COMPLIANCE_HISTORY_READ_IGNORE_USERS, DEFAULT_IGNORED_USERS));\n+        if (ignoredComplianceUsersForRead.size() == 1 && \"NONE\".equals(ignoredComplianceUsersForRead.get(0))) {\n+            ignoredComplianceUsersForRead.clear();\n+        }\n+\n+        final List<String> ignoredComplianceUsersForWrite = new ArrayList<>(settings.getAsList(ConfigConstants.OPENDISTRO_SECURITY_COMPLIANCE_HISTORY_WRITE_IGNORE_USERS, DEFAULT_IGNORED_USERS));\n+        if (ignoredComplianceUsersForWrite.size() == 1 && \"NONE\".equals(ignoredComplianceUsersForWrite.get(0))) {\n+            ignoredComplianceUsersForWrite.clear();\n+        }\n+\n+        final List<String> ignoreAuditRequests = settings.getAsList(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_IGNORE_REQUESTS, Collections.emptyList());\n+\n+        return new AuditConfig(isRestApiAuditEnabled,\n+                isTransportAuditEnabled,\n+                resolveBulkRequests,\n+                logRequestBody,\n+                resolveIndices,\n+                excludeSensitiveHeaders,\n+                new HashSet<>(ignoredAuditUsers),", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODk1ODc5NA==", "url": "https://github.com/opensearch-project/security/pull/306#discussion_r398958794", "bodyText": "May this set contain \"NONE\"? Should \"NONE\" be handled in the constructor?", "author": "vrozov", "createdAt": "2020-03-26T23:51:18Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/auditlog/config/AuditConfig.java", "diffHunk": "@@ -0,0 +1,190 @@\n+package com.amazon.opendistroforelasticsearch.security.auditlog.config;\n+\n+import com.amazon.opendistroforelasticsearch.security.auditlog.impl.AuditCategory;\n+import com.amazon.opendistroforelasticsearch.security.support.ConfigConstants;\n+import org.elasticsearch.common.settings.Settings;\n+\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.EnumSet;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Set;\n+\n+public class AuditConfig {\n+    private static final List<String> DEFAULT_IGNORED_USERS = Collections.singletonList(\"kibanaserver\");\n+    private static final List<String> DEFAULT_DISABLED_CATEGORIES =\n+            Arrays.asList(AuditCategory.AUTHENTICATED.toString(),\n+                    AuditCategory.GRANTED_PRIVILEGES.toString());\n+\n+    private final boolean isRestApiAuditEnabled;\n+    private final boolean isTransportAuditEnabled;\n+    private final boolean resolveBulkRequests;\n+    private final boolean logRequestBody;\n+    private final boolean resolveIndices;\n+    private final boolean excludeSensitiveHeaders;\n+    private final Set<String> ignoredAuditUsers;\n+    private final Set<String> ignoredComplianceUsersForRead;\n+    private final Set<String> ignoredComplianceUsersForWrite;\n+    private final Set<String> ignoreAuditRequests;\n+    private final EnumSet<AuditCategory> disabledRestCategories;\n+    private final EnumSet<AuditCategory> disabledTransportCategories;\n+    private final String opendistrosecurityIndex;\n+\n+    private AuditConfig(final boolean isRestApiAuditEnabled,\n+                        final boolean isTransportAuditEnabled,\n+                        final boolean resolveBulkRequests,\n+                        final boolean logRequestBody,\n+                        final boolean resolveIndices,\n+                        final boolean excludeSensitiveHeaders,\n+                        final Set<String> ignoredAuditUsers,", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTAwODA1Ng==", "url": "https://github.com/opensearch-project/security/pull/306#discussion_r399008056", "bodyText": "I feel whoever is calling the constructor should deal with that. In this case, getConfig(settings). What if \"NONE\" is one of the users? It would be wrong to handle this in constructor. What are your thoughts?", "author": "sujithvm", "createdAt": "2020-03-27T02:56:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODk1ODc5NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTAxNDcwNA==", "url": "https://github.com/opensearch-project/security/pull/306#discussion_r399014704", "bodyText": "OK, let's assume that \"NONE\" is a valid input in the constructor and it means an empty list only in settings.", "author": "vrozov", "createdAt": "2020-03-27T03:24:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODk1ODc5NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODk2NzY0Nw==", "url": "https://github.com/opensearch-project/security/pull/306#discussion_r398967647", "bodyText": "If auditConfig is final and immutable (all fields are also final) how it can be reloaded dynamically?", "author": "vrozov", "createdAt": "2020-03-27T00:20:23Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/auditlog/impl/AbstractAuditLog.java", "diffHunk": "@@ -80,33 +79,15 @@\n import com.google.common.io.BaseEncoding;\n \n public abstract class AbstractAuditLog implements AuditLog {\n+    protected final Logger log = LogManager.getLogger(this.getClass());\n \n-    private static final List<String> DEFAULT_DISABLED_CATEGORIES = Arrays.asList(AuditCategory.AUTHENTICATED.toString(), AuditCategory.GRANTED_PRIVILEGES.toString());\n+    private final ThreadPool threadPool;\n+    private final IndexNameExpressionResolver resolver;\n+    private final ClusterService clusterService;\n+    private final Settings settings;\n+    private final AuditConfig auditConfig;", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODk5ODk1OA==", "url": "https://github.com/opensearch-project/security/pull/306#discussion_r398998958", "bodyText": "Yes this needs to be non-final when reloaded dynamically. I thought of doing it in #319 when the change is actually getting merged. Till then we don't need it. I feel having rigidity helps in making refactors less error-prone. Thats why I put this as final. What do you think?", "author": "sujithvm", "createdAt": "2020-03-27T02:21:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODk2NzY0Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODk2OTMxMA==", "url": "https://github.com/opensearch-project/security/pull/306#discussion_r398969310", "bodyText": "Use EMPTY_SETTINGS.", "author": "vrozov", "createdAt": "2020-03-27T00:26:23Z", "path": "src/test/java/com/amazon/opendistroforelasticsearch/security/auditlog/config/AuditConfigTest.java", "diffHunk": "@@ -0,0 +1,85 @@\n+package com.amazon.opendistroforelasticsearch.security.auditlog.config;\n+\n+import com.amazon.opendistroforelasticsearch.security.auditlog.impl.AuditCategory;\n+import com.amazon.opendistroforelasticsearch.security.support.ConfigConstants;\n+import org.elasticsearch.common.settings.Settings;\n+import org.hamcrest.Matcher;\n+import org.junit.Test;\n+\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.EnumSet;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Set;\n+\n+import static com.amazon.opendistroforelasticsearch.security.auditlog.impl.AuditCategory.*;\n+import static org.hamcrest.CoreMatchers.is;\n+import static org.junit.Assert.*;\n+\n+public class AuditConfigTest {\n+\n+    @Test\n+    public void testDefault() {\n+        // arrange\n+        final Settings settings = Settings.builder().build();\n+        final Set<String> defaultIgnoredUser = Collections.singleton(\"kibanaserver\");\n+        final EnumSet<AuditCategory> defaultDisabledCategories = EnumSet.of(AUTHENTICATED, GRANTED_PRIVILEGES);\n+        // act\n+        final AuditConfig auditConfig = AuditConfig.getConfig(settings);", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTM1NjMwMg==", "url": "https://github.com/opensearch-project/security/pull/306#discussion_r399356302", "bodyText": "nit: consider\nif (list.size() == 1 && \"NONE\".equals(ignoreCaseForNone? list.get(0).toUpperCase() : list.get(0)))", "author": "vrozov", "createdAt": "2020-03-27T15:40:11Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/auditlog/config/AuditConfig.java", "diffHunk": "@@ -0,0 +1,206 @@\n+package com.amazon.opendistroforelasticsearch.security.auditlog.config;\n+\n+import com.amazon.opendistroforelasticsearch.security.auditlog.impl.AuditCategory;\n+import com.amazon.opendistroforelasticsearch.security.support.ConfigConstants;\n+import com.google.common.collect.ImmutableSet;\n+import org.elasticsearch.common.settings.Settings;\n+\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.EnumSet;\n+import java.util.List;\n+import java.util.Set;\n+\n+public class AuditConfig {\n+    private static final List<String> DEFAULT_IGNORED_USERS = Collections.singletonList(\"kibanaserver\");\n+    private static final List<String> DEFAULT_DISABLED_CATEGORIES =\n+            Arrays.asList(AuditCategory.AUTHENTICATED.toString(),\n+                    AuditCategory.GRANTED_PRIVILEGES.toString());\n+\n+    private final boolean isRestApiAuditEnabled;\n+    private final boolean isTransportAuditEnabled;\n+    private final boolean resolveBulkRequests;\n+    private final boolean logRequestBody;\n+    private final boolean resolveIndices;\n+    private final boolean excludeSensitiveHeaders;\n+    private final Set<String> ignoredAuditUsers;\n+    private final Set<String> ignoredComplianceUsersForRead;\n+    private final Set<String> ignoredComplianceUsersForWrite;\n+    private final Set<String> ignoreAuditRequests;\n+    private final EnumSet<AuditCategory> disabledRestCategories;\n+    private final EnumSet<AuditCategory> disabledTransportCategories;\n+    private final String opendistrosecurityIndex;\n+\n+    private AuditConfig(final boolean isRestApiAuditEnabled,\n+                        final boolean isTransportAuditEnabled,\n+                        final boolean resolveBulkRequests,\n+                        final boolean logRequestBody,\n+                        final boolean resolveIndices,\n+                        final boolean excludeSensitiveHeaders,\n+                        final Set<String> ignoredAuditUsers,\n+                        final Set<String> ignoredComplianceUsersForRead,\n+                        final Set<String> ignoredComplianceUsersForWrite,\n+                        final Set<String> ignoredAuditRequests,\n+                        final EnumSet<AuditCategory> disabledRestCategories,\n+                        final EnumSet<AuditCategory> disabledTransportCategories,\n+                        final String opendistrosecurityIndex) {\n+        this.isRestApiAuditEnabled = isRestApiAuditEnabled;\n+        this.isTransportAuditEnabled = isTransportAuditEnabled;\n+        this.resolveBulkRequests = resolveBulkRequests;\n+        this.logRequestBody = logRequestBody;\n+        this.resolveIndices = resolveIndices;\n+        this.excludeSensitiveHeaders = excludeSensitiveHeaders;\n+        this.ignoredAuditUsers = ignoredAuditUsers;\n+        this.ignoredComplianceUsersForRead = ignoredComplianceUsersForRead;\n+        this.ignoredComplianceUsersForWrite = ignoredComplianceUsersForWrite;\n+        this.ignoreAuditRequests = ignoredAuditRequests;\n+        this.disabledRestCategories = disabledRestCategories;\n+        this.disabledTransportCategories = disabledTransportCategories;\n+        this.opendistrosecurityIndex = opendistrosecurityIndex;\n+    }\n+\n+    public static AuditConfig getConfig(Settings settings) {\n+        final boolean isRestApiAuditEnabled = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_ENABLE_REST, true);\n+        final boolean isTransportAuditEnabled = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_ENABLE_TRANSPORT, true);\n+        final boolean resolveBulkRequests = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_RESOLVE_BULK_REQUESTS, false);\n+        final boolean logRequestBody = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_LOG_REQUEST_BODY, true);\n+        final boolean resolveIndices = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_RESOLVE_INDICES, true);\n+        final boolean excludeSensitiveHeaders = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_EXCLUDE_SENSITIVE_HEADERS, true);\n+        final String opendistrosecurityIndex = settings.get(ConfigConstants.OPENDISTRO_SECURITY_CONFIG_INDEX_NAME, ConfigConstants.OPENDISTRO_SECURITY_DEFAULT_CONFIG_INDEX);\n+\n+        final EnumSet<AuditCategory> disabledRestCategories = AuditCategory.parse(getSettingAsList(\n+                settings,\n+                ConfigConstants.OPENDISTRO_SECURITY_AUDIT_CONFIG_DISABLED_REST_CATEGORIES,\n+                DEFAULT_DISABLED_CATEGORIES,\n+                true));\n+\n+        final EnumSet<AuditCategory> disabledTransportCategories = AuditCategory.parse(getSettingAsList(\n+                settings,\n+                ConfigConstants.OPENDISTRO_SECURITY_AUDIT_CONFIG_DISABLED_TRANSPORT_CATEGORIES,\n+                DEFAULT_DISABLED_CATEGORIES,\n+                true));\n+\n+        final Set<String> ignoredAuditUsers = ImmutableSet.copyOf(getSettingAsList(\n+                settings,\n+                ConfigConstants.OPENDISTRO_SECURITY_AUDIT_IGNORE_USERS,\n+                DEFAULT_IGNORED_USERS,\n+                false));\n+\n+        final Set<String> ignoredComplianceUsersForRead = ImmutableSet.copyOf(getSettingAsList(\n+                settings,\n+                ConfigConstants.OPENDISTRO_SECURITY_COMPLIANCE_HISTORY_READ_IGNORE_USERS,\n+                DEFAULT_IGNORED_USERS,\n+                false));\n+\n+        final Set<String> ignoredComplianceUsersForWrite = ImmutableSet.copyOf(getSettingAsList(\n+                settings,\n+                ConfigConstants.OPENDISTRO_SECURITY_COMPLIANCE_HISTORY_WRITE_IGNORE_USERS,\n+                DEFAULT_IGNORED_USERS,\n+                false));\n+\n+        final Set<String> ignoreAuditRequests = ImmutableSet.copyOf(settings.getAsList(\n+                ConfigConstants.OPENDISTRO_SECURITY_AUDIT_IGNORE_REQUESTS,\n+                Collections.emptyList()));\n+\n+        return new AuditConfig(isRestApiAuditEnabled,\n+                isTransportAuditEnabled,\n+                resolveBulkRequests,\n+                logRequestBody,\n+                resolveIndices,\n+                excludeSensitiveHeaders,\n+                ignoredAuditUsers,\n+                ignoredComplianceUsersForRead,\n+                ignoredComplianceUsersForWrite,\n+                ignoreAuditRequests,\n+                disabledRestCategories,\n+                disabledTransportCategories,\n+                opendistrosecurityIndex);\n+    }\n+\n+    private static List<String> getSettingAsList(final Settings settings, final String key, final List<String> defaultList, final boolean ignoreCaseForNone) {\n+        final List<String> list = settings.getAsList(key, defaultList);\n+        if (list.size() == 1) {", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTM2MTE3Nw==", "url": "https://github.com/opensearch-project/security/pull/306#discussion_r399361177", "bodyText": "Consider renaming getConfig() to from().", "author": "vrozov", "createdAt": "2020-03-27T15:47:07Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/auditlog/config/AuditConfig.java", "diffHunk": "@@ -0,0 +1,206 @@\n+package com.amazon.opendistroforelasticsearch.security.auditlog.config;\n+\n+import com.amazon.opendistroforelasticsearch.security.auditlog.impl.AuditCategory;\n+import com.amazon.opendistroforelasticsearch.security.support.ConfigConstants;\n+import com.google.common.collect.ImmutableSet;\n+import org.elasticsearch.common.settings.Settings;\n+\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.EnumSet;\n+import java.util.List;\n+import java.util.Set;\n+\n+public class AuditConfig {\n+    private static final List<String> DEFAULT_IGNORED_USERS = Collections.singletonList(\"kibanaserver\");\n+    private static final List<String> DEFAULT_DISABLED_CATEGORIES =\n+            Arrays.asList(AuditCategory.AUTHENTICATED.toString(),\n+                    AuditCategory.GRANTED_PRIVILEGES.toString());\n+\n+    private final boolean isRestApiAuditEnabled;\n+    private final boolean isTransportAuditEnabled;\n+    private final boolean resolveBulkRequests;\n+    private final boolean logRequestBody;\n+    private final boolean resolveIndices;\n+    private final boolean excludeSensitiveHeaders;\n+    private final Set<String> ignoredAuditUsers;\n+    private final Set<String> ignoredComplianceUsersForRead;\n+    private final Set<String> ignoredComplianceUsersForWrite;\n+    private final Set<String> ignoreAuditRequests;\n+    private final EnumSet<AuditCategory> disabledRestCategories;\n+    private final EnumSet<AuditCategory> disabledTransportCategories;\n+    private final String opendistrosecurityIndex;\n+\n+    private AuditConfig(final boolean isRestApiAuditEnabled,\n+                        final boolean isTransportAuditEnabled,\n+                        final boolean resolveBulkRequests,\n+                        final boolean logRequestBody,\n+                        final boolean resolveIndices,\n+                        final boolean excludeSensitiveHeaders,\n+                        final Set<String> ignoredAuditUsers,\n+                        final Set<String> ignoredComplianceUsersForRead,\n+                        final Set<String> ignoredComplianceUsersForWrite,\n+                        final Set<String> ignoredAuditRequests,\n+                        final EnumSet<AuditCategory> disabledRestCategories,\n+                        final EnumSet<AuditCategory> disabledTransportCategories,\n+                        final String opendistrosecurityIndex) {\n+        this.isRestApiAuditEnabled = isRestApiAuditEnabled;\n+        this.isTransportAuditEnabled = isTransportAuditEnabled;\n+        this.resolveBulkRequests = resolveBulkRequests;\n+        this.logRequestBody = logRequestBody;\n+        this.resolveIndices = resolveIndices;\n+        this.excludeSensitiveHeaders = excludeSensitiveHeaders;\n+        this.ignoredAuditUsers = ignoredAuditUsers;\n+        this.ignoredComplianceUsersForRead = ignoredComplianceUsersForRead;\n+        this.ignoredComplianceUsersForWrite = ignoredComplianceUsersForWrite;\n+        this.ignoreAuditRequests = ignoredAuditRequests;\n+        this.disabledRestCategories = disabledRestCategories;\n+        this.disabledTransportCategories = disabledTransportCategories;\n+        this.opendistrosecurityIndex = opendistrosecurityIndex;\n+    }\n+\n+    public static AuditConfig getConfig(Settings settings) {", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTM2Mzc3Nw==", "url": "https://github.com/opensearch-project/security/pull/306#discussion_r399363777", "bodyText": "Consider\nlog.info(\"Auditing on REST API is {}\", auditConfig.isRestApiAuditEnabled()? \"enabled\" : \"disabled\");", "author": "vrozov", "createdAt": "2020-03-27T15:50:42Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/auditlog/impl/AbstractAuditLog.java", "diffHunk": "@@ -118,81 +99,18 @@\n     protected AbstractAuditLog(Settings settings, final ThreadPool threadPool, final IndexNameExpressionResolver resolver, final ClusterService clusterService) {\n         super();\n         this.threadPool = threadPool;\n-\n         this.settings = settings;\n         this.resolver = resolver;\n         this.clusterService = clusterService;\n-\n-        this.opendistrosecurityIndex = settings.get(ConfigConstants.OPENDISTRO_SECURITY_CONFIG_INDEX_NAME, ConfigConstants.OPENDISTRO_SECURITY_DEFAULT_CONFIG_INDEX);\n-\n-        resolveBulkRequests = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_RESOLVE_BULK_REQUESTS, false);\n-\n-        restAuditingEnabled = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_ENABLE_REST, true);\n-        transportAuditingEnabled = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_ENABLE_TRANSPORT, true);\n-\n-        final List<String> disabledRestCategoriesList = settings.getAsList(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_CONFIG_DISABLED_REST_CATEGORIES, DEFAULT_DISABLED_CATEGORIES);\n-\n-        if (disabledRestCategoriesList.isEmpty() || (disabledRestCategoriesList.size() == 1 && \"NONE\".equalsIgnoreCase(disabledRestCategoriesList.get(0)))) {\n-            disabledRestCategories = EnumSet.noneOf(AuditCategory.class);\n-        } else {\n-            disabledRestCategories = AuditCategory.parse(disabledRestCategoriesList);\n-        }\n-\n-        if (!disabledRestCategories.isEmpty()) {\n-            log.info(\"Configured categories on rest layer to ignore: {}\", disabledRestCategories);\n-        }\n-\n-        final List<String> disabledTransportCategoriesList = settings.getAsList(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_CONFIG_DISABLED_TRANSPORT_CATEGORIES, DEFAULT_DISABLED_CATEGORIES);\n-\n-        if (disabledTransportCategoriesList.isEmpty() || (disabledTransportCategoriesList.size() == 1 && \"NONE\".equalsIgnoreCase(disabledTransportCategoriesList.get(0)))) {\n-            disabledTransportCategories = EnumSet.noneOf(AuditCategory.class);\n-        } else {\n-            disabledTransportCategories = AuditCategory.parse(disabledTransportCategoriesList);\n-        }\n-\n-        if (!disabledTransportCategories.isEmpty()) {\n-            log.info(\"Configured categories on transport layer to ignore: {}\", disabledTransportCategories);\n-        }\n-\n-        logRequestBody = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_LOG_REQUEST_BODY, true);\n-        resolveIndices = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_RESOLVE_INDICES, true);\n-\n-        ignoredAuditUsers = new ArrayList<>(settings.getAsList(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_IGNORE_USERS, defaultIgnoredUsers));\n-\n-        if(ignoredAuditUsers.size() == 1 && \"NONE\".equals(ignoredAuditUsers.get(0))) {\n-            ignoredAuditUsers.clear();\n-        }\n-\n-        if (ignoredAuditUsers.size() > 0) {\n-            log.info(\"Configured Users to ignore: {}\", ignoredAuditUsers);\n-        }\n-\n-        ignoredComplianceUsersForRead = new ArrayList<>(settings.getAsList(ConfigConstants.OPENDISTRO_SECURITY_COMPLIANCE_HISTORY_READ_IGNORE_USERS, defaultIgnoredUsers));\n-\n-        if(ignoredComplianceUsersForRead.size() == 1 && \"NONE\".equals(ignoredComplianceUsersForRead.get(0))) {\n-            ignoredComplianceUsersForRead.clear();\n-        }\n-\n-        if (ignoredComplianceUsersForRead.size() > 0) {\n-            log.info(\"Configured Users to ignore for read compliance events: {}\", ignoredComplianceUsersForRead);\n-        }\n-\n-        ignoredComplianceUsersForWrite = new ArrayList<>(settings.getAsList(ConfigConstants.OPENDISTRO_SECURITY_COMPLIANCE_HISTORY_WRITE_IGNORE_USERS, defaultIgnoredUsers));\n-\n-        if(ignoredComplianceUsersForWrite.size() == 1 && \"NONE\".equals(ignoredComplianceUsersForWrite.get(0))) {\n-            ignoredComplianceUsersForWrite.clear();\n-        }\n-\n-        if (ignoredComplianceUsersForWrite.size() > 0) {\n-            log.info(\"Configured Users to ignore for write compliance events: {}\", ignoredComplianceUsersForWrite);\n-        }\n-\n-        ignoreAuditRequests = settings.getAsList(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_IGNORE_REQUESTS, Collections.emptyList());\n-        if (ignoreAuditRequests.size() > 0) {\n-            log.info(\"Configured Requests to ignore: {}\", ignoreAuditRequests);\n-        }\n-\n-        this.excludeSensitiveHeaders = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_EXCLUDE_SENSITIVE_HEADERS, true);\n+        this.auditConfig = AuditConfig.getConfig(settings);\n+\n+        log.info(\"Configured audit setting for auditing on rest layer : {}\", auditConfig.isRestApiAuditEnabled());", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTM2NDQzMw==", "url": "https://github.com/opensearch-project/security/pull/306#discussion_r399364433", "bodyText": "remove this line", "author": "vrozov", "createdAt": "2020-03-27T15:51:40Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/auditlog/impl/AbstractAuditLog.java", "diffHunk": "@@ -118,81 +99,18 @@\n     protected AbstractAuditLog(Settings settings, final ThreadPool threadPool, final IndexNameExpressionResolver resolver, final ClusterService clusterService) {\n         super();\n         this.threadPool = threadPool;\n-\n         this.settings = settings;\n         this.resolver = resolver;\n         this.clusterService = clusterService;\n-\n-        this.opendistrosecurityIndex = settings.get(ConfigConstants.OPENDISTRO_SECURITY_CONFIG_INDEX_NAME, ConfigConstants.OPENDISTRO_SECURITY_DEFAULT_CONFIG_INDEX);\n-\n-        resolveBulkRequests = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_RESOLVE_BULK_REQUESTS, false);\n-\n-        restAuditingEnabled = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_ENABLE_REST, true);\n-        transportAuditingEnabled = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_ENABLE_TRANSPORT, true);\n-\n-        final List<String> disabledRestCategoriesList = settings.getAsList(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_CONFIG_DISABLED_REST_CATEGORIES, DEFAULT_DISABLED_CATEGORIES);\n-\n-        if (disabledRestCategoriesList.isEmpty() || (disabledRestCategoriesList.size() == 1 && \"NONE\".equalsIgnoreCase(disabledRestCategoriesList.get(0)))) {\n-            disabledRestCategories = EnumSet.noneOf(AuditCategory.class);\n-        } else {\n-            disabledRestCategories = AuditCategory.parse(disabledRestCategoriesList);\n-        }\n-\n-        if (!disabledRestCategories.isEmpty()) {\n-            log.info(\"Configured categories on rest layer to ignore: {}\", disabledRestCategories);\n-        }\n-\n-        final List<String> disabledTransportCategoriesList = settings.getAsList(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_CONFIG_DISABLED_TRANSPORT_CATEGORIES, DEFAULT_DISABLED_CATEGORIES);\n-\n-        if (disabledTransportCategoriesList.isEmpty() || (disabledTransportCategoriesList.size() == 1 && \"NONE\".equalsIgnoreCase(disabledTransportCategoriesList.get(0)))) {\n-            disabledTransportCategories = EnumSet.noneOf(AuditCategory.class);\n-        } else {\n-            disabledTransportCategories = AuditCategory.parse(disabledTransportCategoriesList);\n-        }\n-\n-        if (!disabledTransportCategories.isEmpty()) {\n-            log.info(\"Configured categories on transport layer to ignore: {}\", disabledTransportCategories);\n-        }\n-\n-        logRequestBody = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_LOG_REQUEST_BODY, true);\n-        resolveIndices = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_RESOLVE_INDICES, true);\n-\n-        ignoredAuditUsers = new ArrayList<>(settings.getAsList(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_IGNORE_USERS, defaultIgnoredUsers));\n-\n-        if(ignoredAuditUsers.size() == 1 && \"NONE\".equals(ignoredAuditUsers.get(0))) {\n-            ignoredAuditUsers.clear();\n-        }\n-\n-        if (ignoredAuditUsers.size() > 0) {\n-            log.info(\"Configured Users to ignore: {}\", ignoredAuditUsers);\n-        }\n-\n-        ignoredComplianceUsersForRead = new ArrayList<>(settings.getAsList(ConfigConstants.OPENDISTRO_SECURITY_COMPLIANCE_HISTORY_READ_IGNORE_USERS, defaultIgnoredUsers));\n-\n-        if(ignoredComplianceUsersForRead.size() == 1 && \"NONE\".equals(ignoredComplianceUsersForRead.get(0))) {\n-            ignoredComplianceUsersForRead.clear();\n-        }\n-\n-        if (ignoredComplianceUsersForRead.size() > 0) {\n-            log.info(\"Configured Users to ignore for read compliance events: {}\", ignoredComplianceUsersForRead);\n-        }\n-\n-        ignoredComplianceUsersForWrite = new ArrayList<>(settings.getAsList(ConfigConstants.OPENDISTRO_SECURITY_COMPLIANCE_HISTORY_WRITE_IGNORE_USERS, defaultIgnoredUsers));\n-\n-        if(ignoredComplianceUsersForWrite.size() == 1 && \"NONE\".equals(ignoredComplianceUsersForWrite.get(0))) {\n-            ignoredComplianceUsersForWrite.clear();\n-        }\n-\n-        if (ignoredComplianceUsersForWrite.size() > 0) {\n-            log.info(\"Configured Users to ignore for write compliance events: {}\", ignoredComplianceUsersForWrite);\n-        }\n-\n-        ignoreAuditRequests = settings.getAsList(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_IGNORE_REQUESTS, Collections.emptyList());\n-        if (ignoreAuditRequests.size() > 0) {\n-            log.info(\"Configured Requests to ignore: {}\", ignoreAuditRequests);\n-        }\n-\n-        this.excludeSensitiveHeaders = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_EXCLUDE_SENSITIVE_HEADERS, true);\n+        this.auditConfig = AuditConfig.getConfig(settings);\n+\n+        log.info(\"Configured audit setting for auditing on rest layer : {}\", auditConfig.isRestApiAuditEnabled());\n+        log.info(\"Configured audit setting for auditing on transport layer : {}\", auditConfig.isTransportApiAuditEnabled());\n+        log.info(\"Configured audit setting to log request body : {}\", auditConfig.shouldLogRequestBody());\n+        log.info(\"Configured audit setting to resolve bulk requests : {}\", auditConfig.shouldResolveBulkRequests());\n+        log.info(\"Configured audit setting to resolve indices : {}\", auditConfig.shouldResolveIndices());\n+        log.info(\"Configured audit setting to exclude sensitive headers : {}\", auditConfig.shouldExcludeSensitiveHeaders());\n+        log.info(\"All configured audit settings : {}\", auditConfig.toString());", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTQxODkxMA==", "url": "https://github.com/opensearch-project/security/pull/306#discussion_r399418910", "bodyText": "I would have personally preferred this to see all configured settings.\nWhy are you suggesting to remove this ?", "author": "sujithvm", "createdAt": "2020-03-27T17:14:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTM2NDQzMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTQ2NjEwOA==", "url": "https://github.com/opensearch-project/security/pull/306#discussion_r399466108", "bodyText": "Is it redundant?", "author": "vrozov", "createdAt": "2020-03-27T18:35:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTM2NDQzMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTM2NTg5OA==", "url": "https://github.com/opensearch-project/security/pull/306#discussion_r399365898", "bodyText": "Instead of toString() I recommend delegating logging to AuditConfig class itself: public void log(Logger log).", "author": "vrozov", "createdAt": "2020-03-27T15:53:45Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/auditlog/config/AuditConfig.java", "diffHunk": "@@ -0,0 +1,206 @@\n+package com.amazon.opendistroforelasticsearch.security.auditlog.config;\n+\n+import com.amazon.opendistroforelasticsearch.security.auditlog.impl.AuditCategory;\n+import com.amazon.opendistroforelasticsearch.security.support.ConfigConstants;\n+import com.google.common.collect.ImmutableSet;\n+import org.elasticsearch.common.settings.Settings;\n+\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.EnumSet;\n+import java.util.List;\n+import java.util.Set;\n+\n+public class AuditConfig {\n+    private static final List<String> DEFAULT_IGNORED_USERS = Collections.singletonList(\"kibanaserver\");\n+    private static final List<String> DEFAULT_DISABLED_CATEGORIES =\n+            Arrays.asList(AuditCategory.AUTHENTICATED.toString(),\n+                    AuditCategory.GRANTED_PRIVILEGES.toString());\n+\n+    private final boolean isRestApiAuditEnabled;\n+    private final boolean isTransportAuditEnabled;\n+    private final boolean resolveBulkRequests;\n+    private final boolean logRequestBody;\n+    private final boolean resolveIndices;\n+    private final boolean excludeSensitiveHeaders;\n+    private final Set<String> ignoredAuditUsers;\n+    private final Set<String> ignoredComplianceUsersForRead;\n+    private final Set<String> ignoredComplianceUsersForWrite;\n+    private final Set<String> ignoreAuditRequests;\n+    private final EnumSet<AuditCategory> disabledRestCategories;\n+    private final EnumSet<AuditCategory> disabledTransportCategories;\n+    private final String opendistrosecurityIndex;\n+\n+    private AuditConfig(final boolean isRestApiAuditEnabled,\n+                        final boolean isTransportAuditEnabled,\n+                        final boolean resolveBulkRequests,\n+                        final boolean logRequestBody,\n+                        final boolean resolveIndices,\n+                        final boolean excludeSensitiveHeaders,\n+                        final Set<String> ignoredAuditUsers,\n+                        final Set<String> ignoredComplianceUsersForRead,\n+                        final Set<String> ignoredComplianceUsersForWrite,\n+                        final Set<String> ignoredAuditRequests,\n+                        final EnumSet<AuditCategory> disabledRestCategories,\n+                        final EnumSet<AuditCategory> disabledTransportCategories,\n+                        final String opendistrosecurityIndex) {\n+        this.isRestApiAuditEnabled = isRestApiAuditEnabled;\n+        this.isTransportAuditEnabled = isTransportAuditEnabled;\n+        this.resolveBulkRequests = resolveBulkRequests;\n+        this.logRequestBody = logRequestBody;\n+        this.resolveIndices = resolveIndices;\n+        this.excludeSensitiveHeaders = excludeSensitiveHeaders;\n+        this.ignoredAuditUsers = ignoredAuditUsers;\n+        this.ignoredComplianceUsersForRead = ignoredComplianceUsersForRead;\n+        this.ignoredComplianceUsersForWrite = ignoredComplianceUsersForWrite;\n+        this.ignoreAuditRequests = ignoredAuditRequests;\n+        this.disabledRestCategories = disabledRestCategories;\n+        this.disabledTransportCategories = disabledTransportCategories;\n+        this.opendistrosecurityIndex = opendistrosecurityIndex;\n+    }\n+\n+    public static AuditConfig getConfig(Settings settings) {\n+        final boolean isRestApiAuditEnabled = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_ENABLE_REST, true);\n+        final boolean isTransportAuditEnabled = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_ENABLE_TRANSPORT, true);\n+        final boolean resolveBulkRequests = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_RESOLVE_BULK_REQUESTS, false);\n+        final boolean logRequestBody = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_LOG_REQUEST_BODY, true);\n+        final boolean resolveIndices = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_RESOLVE_INDICES, true);\n+        final boolean excludeSensitiveHeaders = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_EXCLUDE_SENSITIVE_HEADERS, true);\n+        final String opendistrosecurityIndex = settings.get(ConfigConstants.OPENDISTRO_SECURITY_CONFIG_INDEX_NAME, ConfigConstants.OPENDISTRO_SECURITY_DEFAULT_CONFIG_INDEX);\n+\n+        final EnumSet<AuditCategory> disabledRestCategories = AuditCategory.parse(getSettingAsList(\n+                settings,\n+                ConfigConstants.OPENDISTRO_SECURITY_AUDIT_CONFIG_DISABLED_REST_CATEGORIES,\n+                DEFAULT_DISABLED_CATEGORIES,\n+                true));\n+\n+        final EnumSet<AuditCategory> disabledTransportCategories = AuditCategory.parse(getSettingAsList(\n+                settings,\n+                ConfigConstants.OPENDISTRO_SECURITY_AUDIT_CONFIG_DISABLED_TRANSPORT_CATEGORIES,\n+                DEFAULT_DISABLED_CATEGORIES,\n+                true));\n+\n+        final Set<String> ignoredAuditUsers = ImmutableSet.copyOf(getSettingAsList(\n+                settings,\n+                ConfigConstants.OPENDISTRO_SECURITY_AUDIT_IGNORE_USERS,\n+                DEFAULT_IGNORED_USERS,\n+                false));\n+\n+        final Set<String> ignoredComplianceUsersForRead = ImmutableSet.copyOf(getSettingAsList(\n+                settings,\n+                ConfigConstants.OPENDISTRO_SECURITY_COMPLIANCE_HISTORY_READ_IGNORE_USERS,\n+                DEFAULT_IGNORED_USERS,\n+                false));\n+\n+        final Set<String> ignoredComplianceUsersForWrite = ImmutableSet.copyOf(getSettingAsList(\n+                settings,\n+                ConfigConstants.OPENDISTRO_SECURITY_COMPLIANCE_HISTORY_WRITE_IGNORE_USERS,\n+                DEFAULT_IGNORED_USERS,\n+                false));\n+\n+        final Set<String> ignoreAuditRequests = ImmutableSet.copyOf(settings.getAsList(\n+                ConfigConstants.OPENDISTRO_SECURITY_AUDIT_IGNORE_REQUESTS,\n+                Collections.emptyList()));\n+\n+        return new AuditConfig(isRestApiAuditEnabled,\n+                isTransportAuditEnabled,\n+                resolveBulkRequests,\n+                logRequestBody,\n+                resolveIndices,\n+                excludeSensitiveHeaders,\n+                ignoredAuditUsers,\n+                ignoredComplianceUsersForRead,\n+                ignoredComplianceUsersForWrite,\n+                ignoreAuditRequests,\n+                disabledRestCategories,\n+                disabledTransportCategories,\n+                opendistrosecurityIndex);\n+    }\n+\n+    private static List<String> getSettingAsList(final Settings settings, final String key, final List<String> defaultList, final boolean ignoreCaseForNone) {\n+        final List<String> list = settings.getAsList(key, defaultList);\n+        if (list.size() == 1) {\n+            final String elem = list.get(0);\n+            final String none = \"NONE\";\n+\n+            if (ignoreCaseForNone && none.equalsIgnoreCase(elem)) {\n+                return Collections.emptyList();\n+            }\n+            if (!ignoreCaseForNone && none.equals(elem)) {\n+                return Collections.emptyList();\n+            }\n+        }\n+        return list;\n+    }\n+\n+    public boolean isRestApiAuditEnabled() {\n+        return isRestApiAuditEnabled;\n+    }\n+\n+    public boolean isTransportApiAuditEnabled() {\n+        return isTransportAuditEnabled;\n+    }\n+\n+    public boolean shouldResolveBulkRequests() {\n+        return resolveBulkRequests;\n+    }\n+\n+    public boolean shouldLogRequestBody() {\n+        return logRequestBody;\n+    }\n+\n+    public boolean shouldResolveIndices() {\n+        return resolveIndices;\n+    }\n+\n+    public boolean shouldExcludeSensitiveHeaders() {\n+        return excludeSensitiveHeaders;\n+    }\n+\n+    public Set<String> getIgnoredAuditUsers() {\n+        return ignoredAuditUsers;\n+    }\n+\n+    public Set<String> getIgnoredComplianceUsersForRead() {\n+        return ignoredComplianceUsersForRead;\n+    }\n+\n+    public Set<String> getIgnoredComplianceUsersForWrite() {\n+        return ignoredComplianceUsersForWrite;\n+    }\n+\n+    public Set<String> getIgnoredAuditRequests() {\n+        return ignoreAuditRequests;\n+    }\n+\n+    public EnumSet<AuditCategory> getDisabledRestCategories() {\n+        return disabledRestCategories;\n+    }\n+\n+    public EnumSet<AuditCategory> getDisabledTransportCategories() {\n+        return disabledTransportCategories;\n+    }\n+\n+    public String getOpendistrosecurityIndex() {\n+        return opendistrosecurityIndex;\n+    }\n+\n+    @Override\n+    public String toString() {", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTQyOTM2Mg==", "url": "https://github.com/opensearch-project/security/pull/306#discussion_r399429362", "bodyText": "Maybe make a new issue to add this pattern to other classes as well?\nI feel the correct way of doing this is make a new interface Loggable for log and then implement it. Also should be able to configure the log level.", "author": "sujithvm", "createdAt": "2020-03-27T17:31:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTM2NTg5OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTQ2OTAwMQ==", "url": "https://github.com/opensearch-project/security/pull/306#discussion_r399469001", "bodyText": "I don't see a use case for Loggable interface. I think that INFO is the most appropriate level for logging AuditConfig. For now, I would not extend the pattern to other classes.", "author": "vrozov", "createdAt": "2020-03-27T18:41:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTM2NTg5OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTM2OTAwMw==", "url": "https://github.com/opensearch-project/security/pull/306#discussion_r399369003", "bodyText": "Please also add test for empty.", "author": "vrozov", "createdAt": "2020-03-27T15:58:15Z", "path": "src/test/java/com/amazon/opendistroforelasticsearch/security/auditlog/config/AuditConfigTest.java", "diffHunk": "@@ -0,0 +1,104 @@\n+package com.amazon.opendistroforelasticsearch.security.auditlog.config;\n+\n+import com.amazon.opendistroforelasticsearch.security.auditlog.impl.AuditCategory;\n+import com.amazon.opendistroforelasticsearch.security.support.ConfigConstants;\n+import com.google.common.collect.ImmutableSet;\n+import org.elasticsearch.common.settings.Settings;\n+import org.junit.Test;\n+\n+import java.util.Collections;\n+import java.util.EnumSet;\n+import java.util.Set;\n+\n+import static com.amazon.opendistroforelasticsearch.security.auditlog.impl.AuditCategory.*;\n+import static org.junit.Assert.*;\n+\n+public class AuditConfigTest {\n+\n+    @Test\n+    public void testDefault() {\n+        // arrange\n+        final Set<String> defaultIgnoredUser = Collections.singleton(\"kibanaserver\");\n+        final EnumSet<AuditCategory> defaultDisabledCategories = EnumSet.of(AUTHENTICATED, GRANTED_PRIVILEGES);\n+        // act\n+        final AuditConfig auditConfig = AuditConfig.getConfig(Settings.EMPTY);\n+        // assert\n+        assertTrue(auditConfig.isRestApiAuditEnabled());\n+        assertTrue(auditConfig.isTransportApiAuditEnabled());\n+        assertTrue(auditConfig.shouldLogRequestBody());\n+        assertTrue(auditConfig.shouldResolveIndices());\n+        assertFalse(auditConfig.shouldResolveBulkRequests());\n+        assertTrue(auditConfig.shouldExcludeSensitiveHeaders());\n+        assertTrue(auditConfig.getIgnoredAuditRequests().isEmpty());\n+        assertEquals(auditConfig.getIgnoredAuditUsers(), defaultIgnoredUser);\n+        assertEquals(auditConfig.getIgnoredComplianceUsersForRead(), defaultIgnoredUser);\n+        assertEquals(auditConfig.getIgnoredComplianceUsersForWrite(), defaultIgnoredUser);\n+        assertEquals(auditConfig.getDisabledRestCategories(), defaultDisabledCategories);\n+        assertEquals(auditConfig.getDisabledTransportCategories(), defaultDisabledCategories);\n+        assertEquals(\".opendistro_security\", auditConfig.getOpendistrosecurityIndex());\n+    }\n+\n+    @Test\n+    public void testConfig() {\n+        // arrange\n+        final Settings settings = Settings.builder()\n+                .put(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_ENABLE_REST, false)\n+                .put(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_ENABLE_TRANSPORT, false)\n+                .put(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_RESOLVE_BULK_REQUESTS, true)\n+                .put(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_LOG_REQUEST_BODY, false)\n+                .put(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_RESOLVE_INDICES, false)\n+                .put(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_EXCLUDE_SENSITIVE_HEADERS, false)\n+                .put(ConfigConstants.OPENDISTRO_SECURITY_CONFIG_INDEX_NAME, \"test-index\")\n+                .putList(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_IGNORE_REQUESTS, \"test-request\")\n+                .putList(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_IGNORE_USERS, \"test-user\")\n+                .putList(ConfigConstants.OPENDISTRO_SECURITY_COMPLIANCE_HISTORY_READ_IGNORE_USERS,\n+                        \"test-user-1\", \"test-user-2\")\n+                .putList(ConfigConstants.OPENDISTRO_SECURITY_COMPLIANCE_HISTORY_WRITE_IGNORE_USERS,\n+                        \"test-user-3\", \"test-user-4\")\n+                .putList(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_CONFIG_DISABLED_REST_CATEGORIES,\n+                        BAD_HEADERS.toString(), SSL_EXCEPTION.toString())\n+                .putList(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_CONFIG_DISABLED_TRANSPORT_CATEGORIES,\n+                        FAILED_LOGIN.toString(), MISSING_PRIVILEGES.toString())\n+                .build();\n+        // act\n+        final AuditConfig auditConfig = AuditConfig.getConfig(settings);\n+        // assert\n+        assertFalse(auditConfig.isRestApiAuditEnabled());\n+        assertFalse(auditConfig.isTransportApiAuditEnabled());\n+        assertFalse(auditConfig.shouldLogRequestBody());\n+        assertFalse(auditConfig.shouldResolveIndices());\n+        assertTrue(auditConfig.shouldResolveBulkRequests());\n+        assertFalse(auditConfig.shouldExcludeSensitiveHeaders());\n+        assertEquals(auditConfig.getIgnoredAuditUsers(), Collections.singleton(\"test-user\"));\n+        assertEquals(auditConfig.getIgnoredAuditRequests(), Collections.singleton(\"test-request\"));\n+        assertEquals(auditConfig.getIgnoredComplianceUsersForRead(), ImmutableSet.of(\"test-user-1\", \"test-user-2\"));\n+        assertEquals(auditConfig.getIgnoredComplianceUsersForWrite(), ImmutableSet.of(\"test-user-3\", \"test-user-4\"));\n+        assertEquals(auditConfig.getDisabledRestCategories(), EnumSet.of(BAD_HEADERS, SSL_EXCEPTION));\n+        assertEquals(auditConfig.getDisabledTransportCategories(), EnumSet.of(FAILED_LOGIN, MISSING_PRIVILEGES));\n+        assertEquals(\"test-index\", auditConfig.getOpendistrosecurityIndex());\n+    }\n+\n+    @Test\n+    public void testNone() {", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTQ3MjcyMw==", "url": "https://github.com/opensearch-project/security/pull/306#discussion_r399472723", "bodyText": "Please apply the same pattern: \"Auditing of request body is {}\"...", "author": "vrozov", "createdAt": "2020-03-27T18:48:11Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/auditlog/impl/AbstractAuditLog.java", "diffHunk": "@@ -118,81 +99,18 @@\n     protected AbstractAuditLog(Settings settings, final ThreadPool threadPool, final IndexNameExpressionResolver resolver, final ClusterService clusterService) {\n         super();\n         this.threadPool = threadPool;\n-\n         this.settings = settings;\n         this.resolver = resolver;\n         this.clusterService = clusterService;\n+        this.auditConfig = AuditConfig.from(settings);\n \n-        this.opendistrosecurityIndex = settings.get(ConfigConstants.OPENDISTRO_SECURITY_CONFIG_INDEX_NAME, ConfigConstants.OPENDISTRO_SECURITY_DEFAULT_CONFIG_INDEX);\n-\n-        resolveBulkRequests = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_RESOLVE_BULK_REQUESTS, false);\n-\n-        restAuditingEnabled = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_ENABLE_REST, true);\n-        transportAuditingEnabled = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_ENABLE_TRANSPORT, true);\n-\n-        final List<String> disabledRestCategoriesList = settings.getAsList(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_CONFIG_DISABLED_REST_CATEGORIES, DEFAULT_DISABLED_CATEGORIES);\n-\n-        if (disabledRestCategoriesList.isEmpty() || (disabledRestCategoriesList.size() == 1 && \"NONE\".equalsIgnoreCase(disabledRestCategoriesList.get(0)))) {\n-            disabledRestCategories = EnumSet.noneOf(AuditCategory.class);\n-        } else {\n-            disabledRestCategories = AuditCategory.parse(disabledRestCategoriesList);\n-        }\n-\n-        if (!disabledRestCategories.isEmpty()) {\n-            log.info(\"Configured categories on rest layer to ignore: {}\", disabledRestCategories);\n-        }\n-\n-        final List<String> disabledTransportCategoriesList = settings.getAsList(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_CONFIG_DISABLED_TRANSPORT_CATEGORIES, DEFAULT_DISABLED_CATEGORIES);\n-\n-        if (disabledTransportCategoriesList.isEmpty() || (disabledTransportCategoriesList.size() == 1 && \"NONE\".equalsIgnoreCase(disabledTransportCategoriesList.get(0)))) {\n-            disabledTransportCategories = EnumSet.noneOf(AuditCategory.class);\n-        } else {\n-            disabledTransportCategories = AuditCategory.parse(disabledTransportCategoriesList);\n-        }\n-\n-        if (!disabledTransportCategories.isEmpty()) {\n-            log.info(\"Configured categories on transport layer to ignore: {}\", disabledTransportCategories);\n-        }\n-\n-        logRequestBody = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_LOG_REQUEST_BODY, true);\n-        resolveIndices = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_RESOLVE_INDICES, true);\n-\n-        ignoredAuditUsers = new ArrayList<>(settings.getAsList(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_IGNORE_USERS, defaultIgnoredUsers));\n-\n-        if(ignoredAuditUsers.size() == 1 && \"NONE\".equals(ignoredAuditUsers.get(0))) {\n-            ignoredAuditUsers.clear();\n-        }\n-\n-        if (ignoredAuditUsers.size() > 0) {\n-            log.info(\"Configured Users to ignore: {}\", ignoredAuditUsers);\n-        }\n-\n-        ignoredComplianceUsersForRead = new ArrayList<>(settings.getAsList(ConfigConstants.OPENDISTRO_SECURITY_COMPLIANCE_HISTORY_READ_IGNORE_USERS, defaultIgnoredUsers));\n-\n-        if(ignoredComplianceUsersForRead.size() == 1 && \"NONE\".equals(ignoredComplianceUsersForRead.get(0))) {\n-            ignoredComplianceUsersForRead.clear();\n-        }\n-\n-        if (ignoredComplianceUsersForRead.size() > 0) {\n-            log.info(\"Configured Users to ignore for read compliance events: {}\", ignoredComplianceUsersForRead);\n-        }\n+        log.info(\"Auditing on REST API is {}\", auditConfig.isRestApiAuditEnabled() ? \"enabled\" : \"disabled\");\n+        log.info(\"Auditing on Transport API is {}\", auditConfig.isTransportApiAuditEnabled() ? \"enabled\" : \"disabled\");\n+        log.info(\"Configured audit setting to log request body : {}\", auditConfig.shouldLogRequestBody());", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTQ3NzkzNQ==", "url": "https://github.com/opensearch-project/security/pull/306#discussion_r399477935", "bodyText": "Consider adding excluded REST API audit categories here in case auditConfig.isRestApiAuditEnabled() is true. The same for Transport API. I don't see them being logged.", "author": "vrozov", "createdAt": "2020-03-27T18:58:14Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/auditlog/impl/AbstractAuditLog.java", "diffHunk": "@@ -118,81 +99,18 @@\n     protected AbstractAuditLog(Settings settings, final ThreadPool threadPool, final IndexNameExpressionResolver resolver, final ClusterService clusterService) {\n         super();\n         this.threadPool = threadPool;\n-\n         this.settings = settings;\n         this.resolver = resolver;\n         this.clusterService = clusterService;\n+        this.auditConfig = AuditConfig.from(settings);\n \n-        this.opendistrosecurityIndex = settings.get(ConfigConstants.OPENDISTRO_SECURITY_CONFIG_INDEX_NAME, ConfigConstants.OPENDISTRO_SECURITY_DEFAULT_CONFIG_INDEX);\n-\n-        resolveBulkRequests = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_RESOLVE_BULK_REQUESTS, false);\n-\n-        restAuditingEnabled = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_ENABLE_REST, true);\n-        transportAuditingEnabled = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_ENABLE_TRANSPORT, true);\n-\n-        final List<String> disabledRestCategoriesList = settings.getAsList(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_CONFIG_DISABLED_REST_CATEGORIES, DEFAULT_DISABLED_CATEGORIES);\n-\n-        if (disabledRestCategoriesList.isEmpty() || (disabledRestCategoriesList.size() == 1 && \"NONE\".equalsIgnoreCase(disabledRestCategoriesList.get(0)))) {\n-            disabledRestCategories = EnumSet.noneOf(AuditCategory.class);\n-        } else {\n-            disabledRestCategories = AuditCategory.parse(disabledRestCategoriesList);\n-        }\n-\n-        if (!disabledRestCategories.isEmpty()) {\n-            log.info(\"Configured categories on rest layer to ignore: {}\", disabledRestCategories);\n-        }\n-\n-        final List<String> disabledTransportCategoriesList = settings.getAsList(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_CONFIG_DISABLED_TRANSPORT_CATEGORIES, DEFAULT_DISABLED_CATEGORIES);\n-\n-        if (disabledTransportCategoriesList.isEmpty() || (disabledTransportCategoriesList.size() == 1 && \"NONE\".equalsIgnoreCase(disabledTransportCategoriesList.get(0)))) {\n-            disabledTransportCategories = EnumSet.noneOf(AuditCategory.class);\n-        } else {\n-            disabledTransportCategories = AuditCategory.parse(disabledTransportCategoriesList);\n-        }\n-\n-        if (!disabledTransportCategories.isEmpty()) {\n-            log.info(\"Configured categories on transport layer to ignore: {}\", disabledTransportCategories);\n-        }\n-\n-        logRequestBody = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_LOG_REQUEST_BODY, true);\n-        resolveIndices = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_RESOLVE_INDICES, true);\n-\n-        ignoredAuditUsers = new ArrayList<>(settings.getAsList(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_IGNORE_USERS, defaultIgnoredUsers));\n-\n-        if(ignoredAuditUsers.size() == 1 && \"NONE\".equals(ignoredAuditUsers.get(0))) {\n-            ignoredAuditUsers.clear();\n-        }\n-\n-        if (ignoredAuditUsers.size() > 0) {\n-            log.info(\"Configured Users to ignore: {}\", ignoredAuditUsers);\n-        }\n-\n-        ignoredComplianceUsersForRead = new ArrayList<>(settings.getAsList(ConfigConstants.OPENDISTRO_SECURITY_COMPLIANCE_HISTORY_READ_IGNORE_USERS, defaultIgnoredUsers));\n-\n-        if(ignoredComplianceUsersForRead.size() == 1 && \"NONE\".equals(ignoredComplianceUsersForRead.get(0))) {\n-            ignoredComplianceUsersForRead.clear();\n-        }\n-\n-        if (ignoredComplianceUsersForRead.size() > 0) {\n-            log.info(\"Configured Users to ignore for read compliance events: {}\", ignoredComplianceUsersForRead);\n-        }\n+        log.info(\"Auditing on REST API is {}\", auditConfig.isRestApiAuditEnabled() ? \"enabled\" : \"disabled\");", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTQ4MDM5Nw==", "url": "https://github.com/opensearch-project/security/pull/306#discussion_r399480397", "bodyText": "This was supposed to be done via bulk logging of toString()", "author": "sujithvm", "createdAt": "2020-03-27T19:03:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTQ3NzkzNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTQ4OTI1Mg==", "url": "https://github.com/opensearch-project/security/pull/306#discussion_r399489252", "bodyText": "I will log every param.\nEven is rest or transport api is disabled some categories are excluded. https://github.com/opendistro-for-elasticsearch/security/blob/master/src/main/java/com/amazon/opendistroforelasticsearch/security/auditlog/impl/AbstractAuditLog.java#L718", "author": "sujithvm", "createdAt": "2020-03-27T19:20:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTQ3NzkzNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTUyNjY5Mg==", "url": "https://github.com/opensearch-project/security/pull/306#discussion_r399526692", "bodyText": "nit: \"Bulk requests resolution is {} (enabled/disabled) during request auditing.\"", "author": "vrozov", "createdAt": "2020-03-27T20:40:40Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/auditlog/config/AuditConfig.java", "diffHunk": "@@ -0,0 +1,214 @@\n+package com.amazon.opendistroforelasticsearch.security.auditlog.config;\n+\n+import com.amazon.opendistroforelasticsearch.security.auditlog.impl.AuditCategory;\n+import com.amazon.opendistroforelasticsearch.security.support.ConfigConstants;\n+import com.google.common.collect.ImmutableSet;\n+import org.apache.logging.log4j.Logger;\n+import org.elasticsearch.common.settings.Settings;\n+\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.EnumSet;\n+import java.util.List;\n+import java.util.Set;\n+\n+public class AuditConfig {\n+    private static final List<String> DEFAULT_IGNORED_USERS = Collections.singletonList(\"kibanaserver\");\n+    private static final List<String> DEFAULT_DISABLED_CATEGORIES =\n+            Arrays.asList(AuditCategory.AUTHENTICATED.toString(),\n+                    AuditCategory.GRANTED_PRIVILEGES.toString());\n+\n+    private final boolean isRestApiAuditEnabled;\n+    private final boolean isTransportApiAuditEnabled;\n+    private final boolean resolveBulkRequests;\n+    private final boolean logRequestBody;\n+    private final boolean resolveIndices;\n+    private final boolean excludeSensitiveHeaders;\n+    private final Set<String> ignoredAuditUsers;\n+    private final Set<String> ignoredComplianceUsersForRead;\n+    private final Set<String> ignoredComplianceUsersForWrite;\n+    private final Set<String> ignoreAuditRequests;\n+    private final EnumSet<AuditCategory> disabledRestCategories;\n+    private final EnumSet<AuditCategory> disabledTransportCategories;\n+    private final String opendistrosecurityIndex;\n+\n+    private AuditConfig(final boolean isRestApiAuditEnabled,\n+                        final boolean isTransportApiAuditEnabled,\n+                        final boolean resolveBulkRequests,\n+                        final boolean logRequestBody,\n+                        final boolean resolveIndices,\n+                        final boolean excludeSensitiveHeaders,\n+                        final Set<String> ignoredAuditUsers,\n+                        final Set<String> ignoredComplianceUsersForRead,\n+                        final Set<String> ignoredComplianceUsersForWrite,\n+                        final Set<String> ignoredAuditRequests,\n+                        final EnumSet<AuditCategory> disabledRestCategories,\n+                        final EnumSet<AuditCategory> disabledTransportCategories,\n+                        final String opendistrosecurityIndex) {\n+        this.isRestApiAuditEnabled = isRestApiAuditEnabled;\n+        this.isTransportApiAuditEnabled = isTransportApiAuditEnabled;\n+        this.resolveBulkRequests = resolveBulkRequests;\n+        this.logRequestBody = logRequestBody;\n+        this.resolveIndices = resolveIndices;\n+        this.excludeSensitiveHeaders = excludeSensitiveHeaders;\n+        this.ignoredAuditUsers = ignoredAuditUsers;\n+        this.ignoredComplianceUsersForRead = ignoredComplianceUsersForRead;\n+        this.ignoredComplianceUsersForWrite = ignoredComplianceUsersForWrite;\n+        this.ignoreAuditRequests = ignoredAuditRequests;\n+        this.disabledRestCategories = disabledRestCategories;\n+        this.disabledTransportCategories = disabledTransportCategories;\n+        this.opendistrosecurityIndex = opendistrosecurityIndex;\n+    }\n+\n+    public static AuditConfig from(Settings settings) {\n+        final boolean isRestApiAuditEnabled = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_ENABLE_REST, true);\n+        final boolean isTransportAuditEnabled = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_ENABLE_TRANSPORT, true);\n+        final boolean resolveBulkRequests = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_RESOLVE_BULK_REQUESTS, false);\n+        final boolean logRequestBody = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_LOG_REQUEST_BODY, true);\n+        final boolean resolveIndices = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_RESOLVE_INDICES, true);\n+        final boolean excludeSensitiveHeaders = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_EXCLUDE_SENSITIVE_HEADERS, true);\n+        final String opendistrosecurityIndex = settings.get(ConfigConstants.OPENDISTRO_SECURITY_CONFIG_INDEX_NAME, ConfigConstants.OPENDISTRO_SECURITY_DEFAULT_CONFIG_INDEX);\n+\n+        final EnumSet<AuditCategory> disabledRestCategories = AuditCategory.parse(getSettingAsList(\n+                settings,\n+                ConfigConstants.OPENDISTRO_SECURITY_AUDIT_CONFIG_DISABLED_REST_CATEGORIES,\n+                DEFAULT_DISABLED_CATEGORIES,\n+                true));\n+\n+        final EnumSet<AuditCategory> disabledTransportCategories = AuditCategory.parse(getSettingAsList(\n+                settings,\n+                ConfigConstants.OPENDISTRO_SECURITY_AUDIT_CONFIG_DISABLED_TRANSPORT_CATEGORIES,\n+                DEFAULT_DISABLED_CATEGORIES,\n+                true));\n+\n+        final Set<String> ignoredAuditUsers = ImmutableSet.copyOf(getSettingAsList(\n+                settings,\n+                ConfigConstants.OPENDISTRO_SECURITY_AUDIT_IGNORE_USERS,\n+                DEFAULT_IGNORED_USERS,\n+                false));\n+\n+        final Set<String> ignoredComplianceUsersForRead = ImmutableSet.copyOf(getSettingAsList(\n+                settings,\n+                ConfigConstants.OPENDISTRO_SECURITY_COMPLIANCE_HISTORY_READ_IGNORE_USERS,\n+                DEFAULT_IGNORED_USERS,\n+                false));\n+\n+        final Set<String> ignoredComplianceUsersForWrite = ImmutableSet.copyOf(getSettingAsList(\n+                settings,\n+                ConfigConstants.OPENDISTRO_SECURITY_COMPLIANCE_HISTORY_WRITE_IGNORE_USERS,\n+                DEFAULT_IGNORED_USERS,\n+                false));\n+\n+        final Set<String> ignoreAuditRequests = ImmutableSet.copyOf(settings.getAsList(\n+                ConfigConstants.OPENDISTRO_SECURITY_AUDIT_IGNORE_REQUESTS,\n+                Collections.emptyList()));\n+\n+        return new AuditConfig(isRestApiAuditEnabled,\n+                isTransportAuditEnabled,\n+                resolveBulkRequests,\n+                logRequestBody,\n+                resolveIndices,\n+                excludeSensitiveHeaders,\n+                ignoredAuditUsers,\n+                ignoredComplianceUsersForRead,\n+                ignoredComplianceUsersForWrite,\n+                ignoreAuditRequests,\n+                disabledRestCategories,\n+                disabledTransportCategories,\n+                opendistrosecurityIndex);\n+    }\n+\n+    private static List<String> getSettingAsList(final Settings settings, final String key, final List<String> defaultList, final boolean ignoreCaseForNone) {\n+        final List<String> list = settings.getAsList(key, defaultList);\n+        if (list.size() == 1 && \"NONE\".equals(ignoreCaseForNone? list.get(0).toUpperCase() : list.get(0))) {\n+            return Collections.emptyList();\n+        }\n+        return list;\n+    }\n+\n+    public boolean isRestApiAuditEnabled() {\n+        return isRestApiAuditEnabled;\n+    }\n+\n+    public boolean isTransportApiAuditEnabled() {\n+        return isTransportApiAuditEnabled;\n+    }\n+\n+    public boolean shouldResolveBulkRequests() {\n+        return resolveBulkRequests;\n+    }\n+\n+    public boolean shouldLogRequestBody() {\n+        return logRequestBody;\n+    }\n+\n+    public boolean shouldResolveIndices() {\n+        return resolveIndices;\n+    }\n+\n+    public boolean shouldExcludeSensitiveHeaders() {\n+        return excludeSensitiveHeaders;\n+    }\n+\n+    public Set<String> getIgnoredAuditUsers() {\n+        return ignoredAuditUsers;\n+    }\n+\n+    public Set<String> getIgnoredComplianceUsersForRead() {\n+        return ignoredComplianceUsersForRead;\n+    }\n+\n+    public Set<String> getIgnoredComplianceUsersForWrite() {\n+        return ignoredComplianceUsersForWrite;\n+    }\n+\n+    public Set<String> getIgnoredAuditRequests() {\n+        return ignoreAuditRequests;\n+    }\n+\n+    public EnumSet<AuditCategory> getDisabledRestCategories() {\n+        return disabledRestCategories;\n+    }\n+\n+    public EnumSet<AuditCategory> getDisabledTransportCategories() {\n+        return disabledTransportCategories;\n+    }\n+\n+    public String getOpendistrosecurityIndex() {\n+        return opendistrosecurityIndex;\n+    }\n+\n+    public void log(Logger logger) {\n+        logger.info(\"Auditing on REST API is {}\", isRestApiAuditEnabled ? \"enabled\" : \"disabled\");\n+        logger.info(\"Auditing on Transport API is {}\", isTransportApiAuditEnabled ? \"enabled\" : \"disabled\");\n+        logger.info(\"Auditing of request body is {}\", logRequestBody ? \"enabled\" : \"disabled\");\n+        logger.info(\"Auditing should {} resolve bulk requests\", resolveBulkRequests ? \"\" : \"not\");", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTUyODQwMw==", "url": "https://github.com/opensearch-project/security/pull/306#discussion_r399528403", "bodyText": "nit: \"Sensitive headers auditing is {} (enabled/disabled).\"", "author": "vrozov", "createdAt": "2020-03-27T20:44:24Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/auditlog/config/AuditConfig.java", "diffHunk": "@@ -0,0 +1,214 @@\n+package com.amazon.opendistroforelasticsearch.security.auditlog.config;\n+\n+import com.amazon.opendistroforelasticsearch.security.auditlog.impl.AuditCategory;\n+import com.amazon.opendistroforelasticsearch.security.support.ConfigConstants;\n+import com.google.common.collect.ImmutableSet;\n+import org.apache.logging.log4j.Logger;\n+import org.elasticsearch.common.settings.Settings;\n+\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.EnumSet;\n+import java.util.List;\n+import java.util.Set;\n+\n+public class AuditConfig {\n+    private static final List<String> DEFAULT_IGNORED_USERS = Collections.singletonList(\"kibanaserver\");\n+    private static final List<String> DEFAULT_DISABLED_CATEGORIES =\n+            Arrays.asList(AuditCategory.AUTHENTICATED.toString(),\n+                    AuditCategory.GRANTED_PRIVILEGES.toString());\n+\n+    private final boolean isRestApiAuditEnabled;\n+    private final boolean isTransportApiAuditEnabled;\n+    private final boolean resolveBulkRequests;\n+    private final boolean logRequestBody;\n+    private final boolean resolveIndices;\n+    private final boolean excludeSensitiveHeaders;\n+    private final Set<String> ignoredAuditUsers;\n+    private final Set<String> ignoredComplianceUsersForRead;\n+    private final Set<String> ignoredComplianceUsersForWrite;\n+    private final Set<String> ignoreAuditRequests;\n+    private final EnumSet<AuditCategory> disabledRestCategories;\n+    private final EnumSet<AuditCategory> disabledTransportCategories;\n+    private final String opendistrosecurityIndex;\n+\n+    private AuditConfig(final boolean isRestApiAuditEnabled,\n+                        final boolean isTransportApiAuditEnabled,\n+                        final boolean resolveBulkRequests,\n+                        final boolean logRequestBody,\n+                        final boolean resolveIndices,\n+                        final boolean excludeSensitiveHeaders,\n+                        final Set<String> ignoredAuditUsers,\n+                        final Set<String> ignoredComplianceUsersForRead,\n+                        final Set<String> ignoredComplianceUsersForWrite,\n+                        final Set<String> ignoredAuditRequests,\n+                        final EnumSet<AuditCategory> disabledRestCategories,\n+                        final EnumSet<AuditCategory> disabledTransportCategories,\n+                        final String opendistrosecurityIndex) {\n+        this.isRestApiAuditEnabled = isRestApiAuditEnabled;\n+        this.isTransportApiAuditEnabled = isTransportApiAuditEnabled;\n+        this.resolveBulkRequests = resolveBulkRequests;\n+        this.logRequestBody = logRequestBody;\n+        this.resolveIndices = resolveIndices;\n+        this.excludeSensitiveHeaders = excludeSensitiveHeaders;\n+        this.ignoredAuditUsers = ignoredAuditUsers;\n+        this.ignoredComplianceUsersForRead = ignoredComplianceUsersForRead;\n+        this.ignoredComplianceUsersForWrite = ignoredComplianceUsersForWrite;\n+        this.ignoreAuditRequests = ignoredAuditRequests;\n+        this.disabledRestCategories = disabledRestCategories;\n+        this.disabledTransportCategories = disabledTransportCategories;\n+        this.opendistrosecurityIndex = opendistrosecurityIndex;\n+    }\n+\n+    public static AuditConfig from(Settings settings) {\n+        final boolean isRestApiAuditEnabled = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_ENABLE_REST, true);\n+        final boolean isTransportAuditEnabled = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_ENABLE_TRANSPORT, true);\n+        final boolean resolveBulkRequests = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_RESOLVE_BULK_REQUESTS, false);\n+        final boolean logRequestBody = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_LOG_REQUEST_BODY, true);\n+        final boolean resolveIndices = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_RESOLVE_INDICES, true);\n+        final boolean excludeSensitiveHeaders = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_EXCLUDE_SENSITIVE_HEADERS, true);\n+        final String opendistrosecurityIndex = settings.get(ConfigConstants.OPENDISTRO_SECURITY_CONFIG_INDEX_NAME, ConfigConstants.OPENDISTRO_SECURITY_DEFAULT_CONFIG_INDEX);\n+\n+        final EnumSet<AuditCategory> disabledRestCategories = AuditCategory.parse(getSettingAsList(\n+                settings,\n+                ConfigConstants.OPENDISTRO_SECURITY_AUDIT_CONFIG_DISABLED_REST_CATEGORIES,\n+                DEFAULT_DISABLED_CATEGORIES,\n+                true));\n+\n+        final EnumSet<AuditCategory> disabledTransportCategories = AuditCategory.parse(getSettingAsList(\n+                settings,\n+                ConfigConstants.OPENDISTRO_SECURITY_AUDIT_CONFIG_DISABLED_TRANSPORT_CATEGORIES,\n+                DEFAULT_DISABLED_CATEGORIES,\n+                true));\n+\n+        final Set<String> ignoredAuditUsers = ImmutableSet.copyOf(getSettingAsList(\n+                settings,\n+                ConfigConstants.OPENDISTRO_SECURITY_AUDIT_IGNORE_USERS,\n+                DEFAULT_IGNORED_USERS,\n+                false));\n+\n+        final Set<String> ignoredComplianceUsersForRead = ImmutableSet.copyOf(getSettingAsList(\n+                settings,\n+                ConfigConstants.OPENDISTRO_SECURITY_COMPLIANCE_HISTORY_READ_IGNORE_USERS,\n+                DEFAULT_IGNORED_USERS,\n+                false));\n+\n+        final Set<String> ignoredComplianceUsersForWrite = ImmutableSet.copyOf(getSettingAsList(\n+                settings,\n+                ConfigConstants.OPENDISTRO_SECURITY_COMPLIANCE_HISTORY_WRITE_IGNORE_USERS,\n+                DEFAULT_IGNORED_USERS,\n+                false));\n+\n+        final Set<String> ignoreAuditRequests = ImmutableSet.copyOf(settings.getAsList(\n+                ConfigConstants.OPENDISTRO_SECURITY_AUDIT_IGNORE_REQUESTS,\n+                Collections.emptyList()));\n+\n+        return new AuditConfig(isRestApiAuditEnabled,\n+                isTransportAuditEnabled,\n+                resolveBulkRequests,\n+                logRequestBody,\n+                resolveIndices,\n+                excludeSensitiveHeaders,\n+                ignoredAuditUsers,\n+                ignoredComplianceUsersForRead,\n+                ignoredComplianceUsersForWrite,\n+                ignoreAuditRequests,\n+                disabledRestCategories,\n+                disabledTransportCategories,\n+                opendistrosecurityIndex);\n+    }\n+\n+    private static List<String> getSettingAsList(final Settings settings, final String key, final List<String> defaultList, final boolean ignoreCaseForNone) {\n+        final List<String> list = settings.getAsList(key, defaultList);\n+        if (list.size() == 1 && \"NONE\".equals(ignoreCaseForNone? list.get(0).toUpperCase() : list.get(0))) {\n+            return Collections.emptyList();\n+        }\n+        return list;\n+    }\n+\n+    public boolean isRestApiAuditEnabled() {\n+        return isRestApiAuditEnabled;\n+    }\n+\n+    public boolean isTransportApiAuditEnabled() {\n+        return isTransportApiAuditEnabled;\n+    }\n+\n+    public boolean shouldResolveBulkRequests() {\n+        return resolveBulkRequests;\n+    }\n+\n+    public boolean shouldLogRequestBody() {\n+        return logRequestBody;\n+    }\n+\n+    public boolean shouldResolveIndices() {\n+        return resolveIndices;\n+    }\n+\n+    public boolean shouldExcludeSensitiveHeaders() {\n+        return excludeSensitiveHeaders;\n+    }\n+\n+    public Set<String> getIgnoredAuditUsers() {\n+        return ignoredAuditUsers;\n+    }\n+\n+    public Set<String> getIgnoredComplianceUsersForRead() {\n+        return ignoredComplianceUsersForRead;\n+    }\n+\n+    public Set<String> getIgnoredComplianceUsersForWrite() {\n+        return ignoredComplianceUsersForWrite;\n+    }\n+\n+    public Set<String> getIgnoredAuditRequests() {\n+        return ignoreAuditRequests;\n+    }\n+\n+    public EnumSet<AuditCategory> getDisabledRestCategories() {\n+        return disabledRestCategories;\n+    }\n+\n+    public EnumSet<AuditCategory> getDisabledTransportCategories() {\n+        return disabledTransportCategories;\n+    }\n+\n+    public String getOpendistrosecurityIndex() {\n+        return opendistrosecurityIndex;\n+    }\n+\n+    public void log(Logger logger) {\n+        logger.info(\"Auditing on REST API is {}\", isRestApiAuditEnabled ? \"enabled\" : \"disabled\");\n+        logger.info(\"Auditing on Transport API is {}\", isTransportApiAuditEnabled ? \"enabled\" : \"disabled\");\n+        logger.info(\"Auditing of request body is {}\", logRequestBody ? \"enabled\" : \"disabled\");\n+        logger.info(\"Auditing should {} resolve bulk requests\", resolveBulkRequests ? \"\" : \"not\");\n+        logger.info(\"Auditing should {} resolve indices\", resolveBulkRequests ? \"\" : \"not\");\n+        logger.info(\"Auditing should {} exclude sensitive headers\", excludeSensitiveHeaders ? \"\" : \"not\");", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTUyODk0Mw==", "url": "https://github.com/opensearch-project/security/pull/306#discussion_r399528943", "bodyText": "nit: \"Auditing requests from {} users is disabled.\" (check if it is not empty?)", "author": "vrozov", "createdAt": "2020-03-27T20:45:35Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/auditlog/config/AuditConfig.java", "diffHunk": "@@ -0,0 +1,214 @@\n+package com.amazon.opendistroforelasticsearch.security.auditlog.config;\n+\n+import com.amazon.opendistroforelasticsearch.security.auditlog.impl.AuditCategory;\n+import com.amazon.opendistroforelasticsearch.security.support.ConfigConstants;\n+import com.google.common.collect.ImmutableSet;\n+import org.apache.logging.log4j.Logger;\n+import org.elasticsearch.common.settings.Settings;\n+\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.EnumSet;\n+import java.util.List;\n+import java.util.Set;\n+\n+public class AuditConfig {\n+    private static final List<String> DEFAULT_IGNORED_USERS = Collections.singletonList(\"kibanaserver\");\n+    private static final List<String> DEFAULT_DISABLED_CATEGORIES =\n+            Arrays.asList(AuditCategory.AUTHENTICATED.toString(),\n+                    AuditCategory.GRANTED_PRIVILEGES.toString());\n+\n+    private final boolean isRestApiAuditEnabled;\n+    private final boolean isTransportApiAuditEnabled;\n+    private final boolean resolveBulkRequests;\n+    private final boolean logRequestBody;\n+    private final boolean resolveIndices;\n+    private final boolean excludeSensitiveHeaders;\n+    private final Set<String> ignoredAuditUsers;\n+    private final Set<String> ignoredComplianceUsersForRead;\n+    private final Set<String> ignoredComplianceUsersForWrite;\n+    private final Set<String> ignoreAuditRequests;\n+    private final EnumSet<AuditCategory> disabledRestCategories;\n+    private final EnumSet<AuditCategory> disabledTransportCategories;\n+    private final String opendistrosecurityIndex;\n+\n+    private AuditConfig(final boolean isRestApiAuditEnabled,\n+                        final boolean isTransportApiAuditEnabled,\n+                        final boolean resolveBulkRequests,\n+                        final boolean logRequestBody,\n+                        final boolean resolveIndices,\n+                        final boolean excludeSensitiveHeaders,\n+                        final Set<String> ignoredAuditUsers,\n+                        final Set<String> ignoredComplianceUsersForRead,\n+                        final Set<String> ignoredComplianceUsersForWrite,\n+                        final Set<String> ignoredAuditRequests,\n+                        final EnumSet<AuditCategory> disabledRestCategories,\n+                        final EnumSet<AuditCategory> disabledTransportCategories,\n+                        final String opendistrosecurityIndex) {\n+        this.isRestApiAuditEnabled = isRestApiAuditEnabled;\n+        this.isTransportApiAuditEnabled = isTransportApiAuditEnabled;\n+        this.resolveBulkRequests = resolveBulkRequests;\n+        this.logRequestBody = logRequestBody;\n+        this.resolveIndices = resolveIndices;\n+        this.excludeSensitiveHeaders = excludeSensitiveHeaders;\n+        this.ignoredAuditUsers = ignoredAuditUsers;\n+        this.ignoredComplianceUsersForRead = ignoredComplianceUsersForRead;\n+        this.ignoredComplianceUsersForWrite = ignoredComplianceUsersForWrite;\n+        this.ignoreAuditRequests = ignoredAuditRequests;\n+        this.disabledRestCategories = disabledRestCategories;\n+        this.disabledTransportCategories = disabledTransportCategories;\n+        this.opendistrosecurityIndex = opendistrosecurityIndex;\n+    }\n+\n+    public static AuditConfig from(Settings settings) {\n+        final boolean isRestApiAuditEnabled = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_ENABLE_REST, true);\n+        final boolean isTransportAuditEnabled = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_ENABLE_TRANSPORT, true);\n+        final boolean resolveBulkRequests = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_RESOLVE_BULK_REQUESTS, false);\n+        final boolean logRequestBody = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_LOG_REQUEST_BODY, true);\n+        final boolean resolveIndices = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_RESOLVE_INDICES, true);\n+        final boolean excludeSensitiveHeaders = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_EXCLUDE_SENSITIVE_HEADERS, true);\n+        final String opendistrosecurityIndex = settings.get(ConfigConstants.OPENDISTRO_SECURITY_CONFIG_INDEX_NAME, ConfigConstants.OPENDISTRO_SECURITY_DEFAULT_CONFIG_INDEX);\n+\n+        final EnumSet<AuditCategory> disabledRestCategories = AuditCategory.parse(getSettingAsList(\n+                settings,\n+                ConfigConstants.OPENDISTRO_SECURITY_AUDIT_CONFIG_DISABLED_REST_CATEGORIES,\n+                DEFAULT_DISABLED_CATEGORIES,\n+                true));\n+\n+        final EnumSet<AuditCategory> disabledTransportCategories = AuditCategory.parse(getSettingAsList(\n+                settings,\n+                ConfigConstants.OPENDISTRO_SECURITY_AUDIT_CONFIG_DISABLED_TRANSPORT_CATEGORIES,\n+                DEFAULT_DISABLED_CATEGORIES,\n+                true));\n+\n+        final Set<String> ignoredAuditUsers = ImmutableSet.copyOf(getSettingAsList(\n+                settings,\n+                ConfigConstants.OPENDISTRO_SECURITY_AUDIT_IGNORE_USERS,\n+                DEFAULT_IGNORED_USERS,\n+                false));\n+\n+        final Set<String> ignoredComplianceUsersForRead = ImmutableSet.copyOf(getSettingAsList(\n+                settings,\n+                ConfigConstants.OPENDISTRO_SECURITY_COMPLIANCE_HISTORY_READ_IGNORE_USERS,\n+                DEFAULT_IGNORED_USERS,\n+                false));\n+\n+        final Set<String> ignoredComplianceUsersForWrite = ImmutableSet.copyOf(getSettingAsList(\n+                settings,\n+                ConfigConstants.OPENDISTRO_SECURITY_COMPLIANCE_HISTORY_WRITE_IGNORE_USERS,\n+                DEFAULT_IGNORED_USERS,\n+                false));\n+\n+        final Set<String> ignoreAuditRequests = ImmutableSet.copyOf(settings.getAsList(\n+                ConfigConstants.OPENDISTRO_SECURITY_AUDIT_IGNORE_REQUESTS,\n+                Collections.emptyList()));\n+\n+        return new AuditConfig(isRestApiAuditEnabled,\n+                isTransportAuditEnabled,\n+                resolveBulkRequests,\n+                logRequestBody,\n+                resolveIndices,\n+                excludeSensitiveHeaders,\n+                ignoredAuditUsers,\n+                ignoredComplianceUsersForRead,\n+                ignoredComplianceUsersForWrite,\n+                ignoreAuditRequests,\n+                disabledRestCategories,\n+                disabledTransportCategories,\n+                opendistrosecurityIndex);\n+    }\n+\n+    private static List<String> getSettingAsList(final Settings settings, final String key, final List<String> defaultList, final boolean ignoreCaseForNone) {\n+        final List<String> list = settings.getAsList(key, defaultList);\n+        if (list.size() == 1 && \"NONE\".equals(ignoreCaseForNone? list.get(0).toUpperCase() : list.get(0))) {\n+            return Collections.emptyList();\n+        }\n+        return list;\n+    }\n+\n+    public boolean isRestApiAuditEnabled() {\n+        return isRestApiAuditEnabled;\n+    }\n+\n+    public boolean isTransportApiAuditEnabled() {\n+        return isTransportApiAuditEnabled;\n+    }\n+\n+    public boolean shouldResolveBulkRequests() {\n+        return resolveBulkRequests;\n+    }\n+\n+    public boolean shouldLogRequestBody() {\n+        return logRequestBody;\n+    }\n+\n+    public boolean shouldResolveIndices() {\n+        return resolveIndices;\n+    }\n+\n+    public boolean shouldExcludeSensitiveHeaders() {\n+        return excludeSensitiveHeaders;\n+    }\n+\n+    public Set<String> getIgnoredAuditUsers() {\n+        return ignoredAuditUsers;\n+    }\n+\n+    public Set<String> getIgnoredComplianceUsersForRead() {\n+        return ignoredComplianceUsersForRead;\n+    }\n+\n+    public Set<String> getIgnoredComplianceUsersForWrite() {\n+        return ignoredComplianceUsersForWrite;\n+    }\n+\n+    public Set<String> getIgnoredAuditRequests() {\n+        return ignoreAuditRequests;\n+    }\n+\n+    public EnumSet<AuditCategory> getDisabledRestCategories() {\n+        return disabledRestCategories;\n+    }\n+\n+    public EnumSet<AuditCategory> getDisabledTransportCategories() {\n+        return disabledTransportCategories;\n+    }\n+\n+    public String getOpendistrosecurityIndex() {\n+        return opendistrosecurityIndex;\n+    }\n+\n+    public void log(Logger logger) {\n+        logger.info(\"Auditing on REST API is {}\", isRestApiAuditEnabled ? \"enabled\" : \"disabled\");\n+        logger.info(\"Auditing on Transport API is {}\", isTransportApiAuditEnabled ? \"enabled\" : \"disabled\");\n+        logger.info(\"Auditing of request body is {}\", logRequestBody ? \"enabled\" : \"disabled\");\n+        logger.info(\"Auditing should {} resolve bulk requests\", resolveBulkRequests ? \"\" : \"not\");\n+        logger.info(\"Auditing should {} resolve indices\", resolveBulkRequests ? \"\" : \"not\");\n+        logger.info(\"Auditing should {} exclude sensitive headers\", excludeSensitiveHeaders ? \"\" : \"not\");\n+        logger.info(\"Auditing will ignore users {}\", ignoredAuditUsers);", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTUzMDAxOA==", "url": "https://github.com/opensearch-project/security/pull/306#discussion_r399530018", "bodyText": "nit: \"Compliance read operation requests auditing from {} users is disabled.\" (check if it is not empty)", "author": "vrozov", "createdAt": "2020-03-27T20:48:12Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/auditlog/config/AuditConfig.java", "diffHunk": "@@ -0,0 +1,214 @@\n+package com.amazon.opendistroforelasticsearch.security.auditlog.config;\n+\n+import com.amazon.opendistroforelasticsearch.security.auditlog.impl.AuditCategory;\n+import com.amazon.opendistroforelasticsearch.security.support.ConfigConstants;\n+import com.google.common.collect.ImmutableSet;\n+import org.apache.logging.log4j.Logger;\n+import org.elasticsearch.common.settings.Settings;\n+\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.EnumSet;\n+import java.util.List;\n+import java.util.Set;\n+\n+public class AuditConfig {\n+    private static final List<String> DEFAULT_IGNORED_USERS = Collections.singletonList(\"kibanaserver\");\n+    private static final List<String> DEFAULT_DISABLED_CATEGORIES =\n+            Arrays.asList(AuditCategory.AUTHENTICATED.toString(),\n+                    AuditCategory.GRANTED_PRIVILEGES.toString());\n+\n+    private final boolean isRestApiAuditEnabled;\n+    private final boolean isTransportApiAuditEnabled;\n+    private final boolean resolveBulkRequests;\n+    private final boolean logRequestBody;\n+    private final boolean resolveIndices;\n+    private final boolean excludeSensitiveHeaders;\n+    private final Set<String> ignoredAuditUsers;\n+    private final Set<String> ignoredComplianceUsersForRead;\n+    private final Set<String> ignoredComplianceUsersForWrite;\n+    private final Set<String> ignoreAuditRequests;\n+    private final EnumSet<AuditCategory> disabledRestCategories;\n+    private final EnumSet<AuditCategory> disabledTransportCategories;\n+    private final String opendistrosecurityIndex;\n+\n+    private AuditConfig(final boolean isRestApiAuditEnabled,\n+                        final boolean isTransportApiAuditEnabled,\n+                        final boolean resolveBulkRequests,\n+                        final boolean logRequestBody,\n+                        final boolean resolveIndices,\n+                        final boolean excludeSensitiveHeaders,\n+                        final Set<String> ignoredAuditUsers,\n+                        final Set<String> ignoredComplianceUsersForRead,\n+                        final Set<String> ignoredComplianceUsersForWrite,\n+                        final Set<String> ignoredAuditRequests,\n+                        final EnumSet<AuditCategory> disabledRestCategories,\n+                        final EnumSet<AuditCategory> disabledTransportCategories,\n+                        final String opendistrosecurityIndex) {\n+        this.isRestApiAuditEnabled = isRestApiAuditEnabled;\n+        this.isTransportApiAuditEnabled = isTransportApiAuditEnabled;\n+        this.resolveBulkRequests = resolveBulkRequests;\n+        this.logRequestBody = logRequestBody;\n+        this.resolveIndices = resolveIndices;\n+        this.excludeSensitiveHeaders = excludeSensitiveHeaders;\n+        this.ignoredAuditUsers = ignoredAuditUsers;\n+        this.ignoredComplianceUsersForRead = ignoredComplianceUsersForRead;\n+        this.ignoredComplianceUsersForWrite = ignoredComplianceUsersForWrite;\n+        this.ignoreAuditRequests = ignoredAuditRequests;\n+        this.disabledRestCategories = disabledRestCategories;\n+        this.disabledTransportCategories = disabledTransportCategories;\n+        this.opendistrosecurityIndex = opendistrosecurityIndex;\n+    }\n+\n+    public static AuditConfig from(Settings settings) {\n+        final boolean isRestApiAuditEnabled = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_ENABLE_REST, true);\n+        final boolean isTransportAuditEnabled = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_ENABLE_TRANSPORT, true);\n+        final boolean resolveBulkRequests = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_RESOLVE_BULK_REQUESTS, false);\n+        final boolean logRequestBody = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_LOG_REQUEST_BODY, true);\n+        final boolean resolveIndices = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_RESOLVE_INDICES, true);\n+        final boolean excludeSensitiveHeaders = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_EXCLUDE_SENSITIVE_HEADERS, true);\n+        final String opendistrosecurityIndex = settings.get(ConfigConstants.OPENDISTRO_SECURITY_CONFIG_INDEX_NAME, ConfigConstants.OPENDISTRO_SECURITY_DEFAULT_CONFIG_INDEX);\n+\n+        final EnumSet<AuditCategory> disabledRestCategories = AuditCategory.parse(getSettingAsList(\n+                settings,\n+                ConfigConstants.OPENDISTRO_SECURITY_AUDIT_CONFIG_DISABLED_REST_CATEGORIES,\n+                DEFAULT_DISABLED_CATEGORIES,\n+                true));\n+\n+        final EnumSet<AuditCategory> disabledTransportCategories = AuditCategory.parse(getSettingAsList(\n+                settings,\n+                ConfigConstants.OPENDISTRO_SECURITY_AUDIT_CONFIG_DISABLED_TRANSPORT_CATEGORIES,\n+                DEFAULT_DISABLED_CATEGORIES,\n+                true));\n+\n+        final Set<String> ignoredAuditUsers = ImmutableSet.copyOf(getSettingAsList(\n+                settings,\n+                ConfigConstants.OPENDISTRO_SECURITY_AUDIT_IGNORE_USERS,\n+                DEFAULT_IGNORED_USERS,\n+                false));\n+\n+        final Set<String> ignoredComplianceUsersForRead = ImmutableSet.copyOf(getSettingAsList(\n+                settings,\n+                ConfigConstants.OPENDISTRO_SECURITY_COMPLIANCE_HISTORY_READ_IGNORE_USERS,\n+                DEFAULT_IGNORED_USERS,\n+                false));\n+\n+        final Set<String> ignoredComplianceUsersForWrite = ImmutableSet.copyOf(getSettingAsList(\n+                settings,\n+                ConfigConstants.OPENDISTRO_SECURITY_COMPLIANCE_HISTORY_WRITE_IGNORE_USERS,\n+                DEFAULT_IGNORED_USERS,\n+                false));\n+\n+        final Set<String> ignoreAuditRequests = ImmutableSet.copyOf(settings.getAsList(\n+                ConfigConstants.OPENDISTRO_SECURITY_AUDIT_IGNORE_REQUESTS,\n+                Collections.emptyList()));\n+\n+        return new AuditConfig(isRestApiAuditEnabled,\n+                isTransportAuditEnabled,\n+                resolveBulkRequests,\n+                logRequestBody,\n+                resolveIndices,\n+                excludeSensitiveHeaders,\n+                ignoredAuditUsers,\n+                ignoredComplianceUsersForRead,\n+                ignoredComplianceUsersForWrite,\n+                ignoreAuditRequests,\n+                disabledRestCategories,\n+                disabledTransportCategories,\n+                opendistrosecurityIndex);\n+    }\n+\n+    private static List<String> getSettingAsList(final Settings settings, final String key, final List<String> defaultList, final boolean ignoreCaseForNone) {\n+        final List<String> list = settings.getAsList(key, defaultList);\n+        if (list.size() == 1 && \"NONE\".equals(ignoreCaseForNone? list.get(0).toUpperCase() : list.get(0))) {\n+            return Collections.emptyList();\n+        }\n+        return list;\n+    }\n+\n+    public boolean isRestApiAuditEnabled() {\n+        return isRestApiAuditEnabled;\n+    }\n+\n+    public boolean isTransportApiAuditEnabled() {\n+        return isTransportApiAuditEnabled;\n+    }\n+\n+    public boolean shouldResolveBulkRequests() {\n+        return resolveBulkRequests;\n+    }\n+\n+    public boolean shouldLogRequestBody() {\n+        return logRequestBody;\n+    }\n+\n+    public boolean shouldResolveIndices() {\n+        return resolveIndices;\n+    }\n+\n+    public boolean shouldExcludeSensitiveHeaders() {\n+        return excludeSensitiveHeaders;\n+    }\n+\n+    public Set<String> getIgnoredAuditUsers() {\n+        return ignoredAuditUsers;\n+    }\n+\n+    public Set<String> getIgnoredComplianceUsersForRead() {\n+        return ignoredComplianceUsersForRead;\n+    }\n+\n+    public Set<String> getIgnoredComplianceUsersForWrite() {\n+        return ignoredComplianceUsersForWrite;\n+    }\n+\n+    public Set<String> getIgnoredAuditRequests() {\n+        return ignoreAuditRequests;\n+    }\n+\n+    public EnumSet<AuditCategory> getDisabledRestCategories() {\n+        return disabledRestCategories;\n+    }\n+\n+    public EnumSet<AuditCategory> getDisabledTransportCategories() {\n+        return disabledTransportCategories;\n+    }\n+\n+    public String getOpendistrosecurityIndex() {\n+        return opendistrosecurityIndex;\n+    }\n+\n+    public void log(Logger logger) {\n+        logger.info(\"Auditing on REST API is {}\", isRestApiAuditEnabled ? \"enabled\" : \"disabled\");\n+        logger.info(\"Auditing on Transport API is {}\", isTransportApiAuditEnabled ? \"enabled\" : \"disabled\");\n+        logger.info(\"Auditing of request body is {}\", logRequestBody ? \"enabled\" : \"disabled\");\n+        logger.info(\"Auditing should {} resolve bulk requests\", resolveBulkRequests ? \"\" : \"not\");\n+        logger.info(\"Auditing should {} resolve indices\", resolveBulkRequests ? \"\" : \"not\");\n+        logger.info(\"Auditing should {} exclude sensitive headers\", excludeSensitiveHeaders ? \"\" : \"not\");\n+        logger.info(\"Auditing will ignore users {}\", ignoredAuditUsers);\n+        logger.info(\"Auditing of compliance read operation will ignore users {}\", ignoredComplianceUsersForRead);", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTUzMDI2Ng==", "url": "https://github.com/opensearch-project/security/pull/306#discussion_r399530266", "bodyText": "nit: Same as read.", "author": "vrozov", "createdAt": "2020-03-27T20:48:43Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/auditlog/config/AuditConfig.java", "diffHunk": "@@ -0,0 +1,214 @@\n+package com.amazon.opendistroforelasticsearch.security.auditlog.config;\n+\n+import com.amazon.opendistroforelasticsearch.security.auditlog.impl.AuditCategory;\n+import com.amazon.opendistroforelasticsearch.security.support.ConfigConstants;\n+import com.google.common.collect.ImmutableSet;\n+import org.apache.logging.log4j.Logger;\n+import org.elasticsearch.common.settings.Settings;\n+\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.EnumSet;\n+import java.util.List;\n+import java.util.Set;\n+\n+public class AuditConfig {\n+    private static final List<String> DEFAULT_IGNORED_USERS = Collections.singletonList(\"kibanaserver\");\n+    private static final List<String> DEFAULT_DISABLED_CATEGORIES =\n+            Arrays.asList(AuditCategory.AUTHENTICATED.toString(),\n+                    AuditCategory.GRANTED_PRIVILEGES.toString());\n+\n+    private final boolean isRestApiAuditEnabled;\n+    private final boolean isTransportApiAuditEnabled;\n+    private final boolean resolveBulkRequests;\n+    private final boolean logRequestBody;\n+    private final boolean resolveIndices;\n+    private final boolean excludeSensitiveHeaders;\n+    private final Set<String> ignoredAuditUsers;\n+    private final Set<String> ignoredComplianceUsersForRead;\n+    private final Set<String> ignoredComplianceUsersForWrite;\n+    private final Set<String> ignoreAuditRequests;\n+    private final EnumSet<AuditCategory> disabledRestCategories;\n+    private final EnumSet<AuditCategory> disabledTransportCategories;\n+    private final String opendistrosecurityIndex;\n+\n+    private AuditConfig(final boolean isRestApiAuditEnabled,\n+                        final boolean isTransportApiAuditEnabled,\n+                        final boolean resolveBulkRequests,\n+                        final boolean logRequestBody,\n+                        final boolean resolveIndices,\n+                        final boolean excludeSensitiveHeaders,\n+                        final Set<String> ignoredAuditUsers,\n+                        final Set<String> ignoredComplianceUsersForRead,\n+                        final Set<String> ignoredComplianceUsersForWrite,\n+                        final Set<String> ignoredAuditRequests,\n+                        final EnumSet<AuditCategory> disabledRestCategories,\n+                        final EnumSet<AuditCategory> disabledTransportCategories,\n+                        final String opendistrosecurityIndex) {\n+        this.isRestApiAuditEnabled = isRestApiAuditEnabled;\n+        this.isTransportApiAuditEnabled = isTransportApiAuditEnabled;\n+        this.resolveBulkRequests = resolveBulkRequests;\n+        this.logRequestBody = logRequestBody;\n+        this.resolveIndices = resolveIndices;\n+        this.excludeSensitiveHeaders = excludeSensitiveHeaders;\n+        this.ignoredAuditUsers = ignoredAuditUsers;\n+        this.ignoredComplianceUsersForRead = ignoredComplianceUsersForRead;\n+        this.ignoredComplianceUsersForWrite = ignoredComplianceUsersForWrite;\n+        this.ignoreAuditRequests = ignoredAuditRequests;\n+        this.disabledRestCategories = disabledRestCategories;\n+        this.disabledTransportCategories = disabledTransportCategories;\n+        this.opendistrosecurityIndex = opendistrosecurityIndex;\n+    }\n+\n+    public static AuditConfig from(Settings settings) {\n+        final boolean isRestApiAuditEnabled = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_ENABLE_REST, true);\n+        final boolean isTransportAuditEnabled = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_ENABLE_TRANSPORT, true);\n+        final boolean resolveBulkRequests = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_RESOLVE_BULK_REQUESTS, false);\n+        final boolean logRequestBody = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_LOG_REQUEST_BODY, true);\n+        final boolean resolveIndices = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_RESOLVE_INDICES, true);\n+        final boolean excludeSensitiveHeaders = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_EXCLUDE_SENSITIVE_HEADERS, true);\n+        final String opendistrosecurityIndex = settings.get(ConfigConstants.OPENDISTRO_SECURITY_CONFIG_INDEX_NAME, ConfigConstants.OPENDISTRO_SECURITY_DEFAULT_CONFIG_INDEX);\n+\n+        final EnumSet<AuditCategory> disabledRestCategories = AuditCategory.parse(getSettingAsList(\n+                settings,\n+                ConfigConstants.OPENDISTRO_SECURITY_AUDIT_CONFIG_DISABLED_REST_CATEGORIES,\n+                DEFAULT_DISABLED_CATEGORIES,\n+                true));\n+\n+        final EnumSet<AuditCategory> disabledTransportCategories = AuditCategory.parse(getSettingAsList(\n+                settings,\n+                ConfigConstants.OPENDISTRO_SECURITY_AUDIT_CONFIG_DISABLED_TRANSPORT_CATEGORIES,\n+                DEFAULT_DISABLED_CATEGORIES,\n+                true));\n+\n+        final Set<String> ignoredAuditUsers = ImmutableSet.copyOf(getSettingAsList(\n+                settings,\n+                ConfigConstants.OPENDISTRO_SECURITY_AUDIT_IGNORE_USERS,\n+                DEFAULT_IGNORED_USERS,\n+                false));\n+\n+        final Set<String> ignoredComplianceUsersForRead = ImmutableSet.copyOf(getSettingAsList(\n+                settings,\n+                ConfigConstants.OPENDISTRO_SECURITY_COMPLIANCE_HISTORY_READ_IGNORE_USERS,\n+                DEFAULT_IGNORED_USERS,\n+                false));\n+\n+        final Set<String> ignoredComplianceUsersForWrite = ImmutableSet.copyOf(getSettingAsList(\n+                settings,\n+                ConfigConstants.OPENDISTRO_SECURITY_COMPLIANCE_HISTORY_WRITE_IGNORE_USERS,\n+                DEFAULT_IGNORED_USERS,\n+                false));\n+\n+        final Set<String> ignoreAuditRequests = ImmutableSet.copyOf(settings.getAsList(\n+                ConfigConstants.OPENDISTRO_SECURITY_AUDIT_IGNORE_REQUESTS,\n+                Collections.emptyList()));\n+\n+        return new AuditConfig(isRestApiAuditEnabled,\n+                isTransportAuditEnabled,\n+                resolveBulkRequests,\n+                logRequestBody,\n+                resolveIndices,\n+                excludeSensitiveHeaders,\n+                ignoredAuditUsers,\n+                ignoredComplianceUsersForRead,\n+                ignoredComplianceUsersForWrite,\n+                ignoreAuditRequests,\n+                disabledRestCategories,\n+                disabledTransportCategories,\n+                opendistrosecurityIndex);\n+    }\n+\n+    private static List<String> getSettingAsList(final Settings settings, final String key, final List<String> defaultList, final boolean ignoreCaseForNone) {\n+        final List<String> list = settings.getAsList(key, defaultList);\n+        if (list.size() == 1 && \"NONE\".equals(ignoreCaseForNone? list.get(0).toUpperCase() : list.get(0))) {\n+            return Collections.emptyList();\n+        }\n+        return list;\n+    }\n+\n+    public boolean isRestApiAuditEnabled() {\n+        return isRestApiAuditEnabled;\n+    }\n+\n+    public boolean isTransportApiAuditEnabled() {\n+        return isTransportApiAuditEnabled;\n+    }\n+\n+    public boolean shouldResolveBulkRequests() {\n+        return resolveBulkRequests;\n+    }\n+\n+    public boolean shouldLogRequestBody() {\n+        return logRequestBody;\n+    }\n+\n+    public boolean shouldResolveIndices() {\n+        return resolveIndices;\n+    }\n+\n+    public boolean shouldExcludeSensitiveHeaders() {\n+        return excludeSensitiveHeaders;\n+    }\n+\n+    public Set<String> getIgnoredAuditUsers() {\n+        return ignoredAuditUsers;\n+    }\n+\n+    public Set<String> getIgnoredComplianceUsersForRead() {\n+        return ignoredComplianceUsersForRead;\n+    }\n+\n+    public Set<String> getIgnoredComplianceUsersForWrite() {\n+        return ignoredComplianceUsersForWrite;\n+    }\n+\n+    public Set<String> getIgnoredAuditRequests() {\n+        return ignoreAuditRequests;\n+    }\n+\n+    public EnumSet<AuditCategory> getDisabledRestCategories() {\n+        return disabledRestCategories;\n+    }\n+\n+    public EnumSet<AuditCategory> getDisabledTransportCategories() {\n+        return disabledTransportCategories;\n+    }\n+\n+    public String getOpendistrosecurityIndex() {\n+        return opendistrosecurityIndex;\n+    }\n+\n+    public void log(Logger logger) {\n+        logger.info(\"Auditing on REST API is {}\", isRestApiAuditEnabled ? \"enabled\" : \"disabled\");\n+        logger.info(\"Auditing on Transport API is {}\", isTransportApiAuditEnabled ? \"enabled\" : \"disabled\");\n+        logger.info(\"Auditing of request body is {}\", logRequestBody ? \"enabled\" : \"disabled\");\n+        logger.info(\"Auditing should {} resolve bulk requests\", resolveBulkRequests ? \"\" : \"not\");\n+        logger.info(\"Auditing should {} resolve indices\", resolveBulkRequests ? \"\" : \"not\");\n+        logger.info(\"Auditing should {} exclude sensitive headers\", excludeSensitiveHeaders ? \"\" : \"not\");\n+        logger.info(\"Auditing will ignore users {}\", ignoredAuditUsers);\n+        logger.info(\"Auditing of compliance read operation will ignore users {}\", ignoredComplianceUsersForRead);\n+        logger.info(\"Auditing of compliance write operation will ignore users {}\", ignoredComplianceUsersForWrite);", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTUzMjE3Nw==", "url": "https://github.com/opensearch-project/security/pull/306#discussion_r399532177", "bodyText": "nit: Move it next to REST API log entry. \"{} are excluded from REST API auditing.\" (check if it is not empty)", "author": "vrozov", "createdAt": "2020-03-27T20:53:01Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/auditlog/config/AuditConfig.java", "diffHunk": "@@ -0,0 +1,214 @@\n+package com.amazon.opendistroforelasticsearch.security.auditlog.config;\n+\n+import com.amazon.opendistroforelasticsearch.security.auditlog.impl.AuditCategory;\n+import com.amazon.opendistroforelasticsearch.security.support.ConfigConstants;\n+import com.google.common.collect.ImmutableSet;\n+import org.apache.logging.log4j.Logger;\n+import org.elasticsearch.common.settings.Settings;\n+\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.EnumSet;\n+import java.util.List;\n+import java.util.Set;\n+\n+public class AuditConfig {\n+    private static final List<String> DEFAULT_IGNORED_USERS = Collections.singletonList(\"kibanaserver\");\n+    private static final List<String> DEFAULT_DISABLED_CATEGORIES =\n+            Arrays.asList(AuditCategory.AUTHENTICATED.toString(),\n+                    AuditCategory.GRANTED_PRIVILEGES.toString());\n+\n+    private final boolean isRestApiAuditEnabled;\n+    private final boolean isTransportApiAuditEnabled;\n+    private final boolean resolveBulkRequests;\n+    private final boolean logRequestBody;\n+    private final boolean resolveIndices;\n+    private final boolean excludeSensitiveHeaders;\n+    private final Set<String> ignoredAuditUsers;\n+    private final Set<String> ignoredComplianceUsersForRead;\n+    private final Set<String> ignoredComplianceUsersForWrite;\n+    private final Set<String> ignoreAuditRequests;\n+    private final EnumSet<AuditCategory> disabledRestCategories;\n+    private final EnumSet<AuditCategory> disabledTransportCategories;\n+    private final String opendistrosecurityIndex;\n+\n+    private AuditConfig(final boolean isRestApiAuditEnabled,\n+                        final boolean isTransportApiAuditEnabled,\n+                        final boolean resolveBulkRequests,\n+                        final boolean logRequestBody,\n+                        final boolean resolveIndices,\n+                        final boolean excludeSensitiveHeaders,\n+                        final Set<String> ignoredAuditUsers,\n+                        final Set<String> ignoredComplianceUsersForRead,\n+                        final Set<String> ignoredComplianceUsersForWrite,\n+                        final Set<String> ignoredAuditRequests,\n+                        final EnumSet<AuditCategory> disabledRestCategories,\n+                        final EnumSet<AuditCategory> disabledTransportCategories,\n+                        final String opendistrosecurityIndex) {\n+        this.isRestApiAuditEnabled = isRestApiAuditEnabled;\n+        this.isTransportApiAuditEnabled = isTransportApiAuditEnabled;\n+        this.resolveBulkRequests = resolveBulkRequests;\n+        this.logRequestBody = logRequestBody;\n+        this.resolveIndices = resolveIndices;\n+        this.excludeSensitiveHeaders = excludeSensitiveHeaders;\n+        this.ignoredAuditUsers = ignoredAuditUsers;\n+        this.ignoredComplianceUsersForRead = ignoredComplianceUsersForRead;\n+        this.ignoredComplianceUsersForWrite = ignoredComplianceUsersForWrite;\n+        this.ignoreAuditRequests = ignoredAuditRequests;\n+        this.disabledRestCategories = disabledRestCategories;\n+        this.disabledTransportCategories = disabledTransportCategories;\n+        this.opendistrosecurityIndex = opendistrosecurityIndex;\n+    }\n+\n+    public static AuditConfig from(Settings settings) {\n+        final boolean isRestApiAuditEnabled = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_ENABLE_REST, true);\n+        final boolean isTransportAuditEnabled = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_ENABLE_TRANSPORT, true);\n+        final boolean resolveBulkRequests = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_RESOLVE_BULK_REQUESTS, false);\n+        final boolean logRequestBody = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_LOG_REQUEST_BODY, true);\n+        final boolean resolveIndices = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_RESOLVE_INDICES, true);\n+        final boolean excludeSensitiveHeaders = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_EXCLUDE_SENSITIVE_HEADERS, true);\n+        final String opendistrosecurityIndex = settings.get(ConfigConstants.OPENDISTRO_SECURITY_CONFIG_INDEX_NAME, ConfigConstants.OPENDISTRO_SECURITY_DEFAULT_CONFIG_INDEX);\n+\n+        final EnumSet<AuditCategory> disabledRestCategories = AuditCategory.parse(getSettingAsList(\n+                settings,\n+                ConfigConstants.OPENDISTRO_SECURITY_AUDIT_CONFIG_DISABLED_REST_CATEGORIES,\n+                DEFAULT_DISABLED_CATEGORIES,\n+                true));\n+\n+        final EnumSet<AuditCategory> disabledTransportCategories = AuditCategory.parse(getSettingAsList(\n+                settings,\n+                ConfigConstants.OPENDISTRO_SECURITY_AUDIT_CONFIG_DISABLED_TRANSPORT_CATEGORIES,\n+                DEFAULT_DISABLED_CATEGORIES,\n+                true));\n+\n+        final Set<String> ignoredAuditUsers = ImmutableSet.copyOf(getSettingAsList(\n+                settings,\n+                ConfigConstants.OPENDISTRO_SECURITY_AUDIT_IGNORE_USERS,\n+                DEFAULT_IGNORED_USERS,\n+                false));\n+\n+        final Set<String> ignoredComplianceUsersForRead = ImmutableSet.copyOf(getSettingAsList(\n+                settings,\n+                ConfigConstants.OPENDISTRO_SECURITY_COMPLIANCE_HISTORY_READ_IGNORE_USERS,\n+                DEFAULT_IGNORED_USERS,\n+                false));\n+\n+        final Set<String> ignoredComplianceUsersForWrite = ImmutableSet.copyOf(getSettingAsList(\n+                settings,\n+                ConfigConstants.OPENDISTRO_SECURITY_COMPLIANCE_HISTORY_WRITE_IGNORE_USERS,\n+                DEFAULT_IGNORED_USERS,\n+                false));\n+\n+        final Set<String> ignoreAuditRequests = ImmutableSet.copyOf(settings.getAsList(\n+                ConfigConstants.OPENDISTRO_SECURITY_AUDIT_IGNORE_REQUESTS,\n+                Collections.emptyList()));\n+\n+        return new AuditConfig(isRestApiAuditEnabled,\n+                isTransportAuditEnabled,\n+                resolveBulkRequests,\n+                logRequestBody,\n+                resolveIndices,\n+                excludeSensitiveHeaders,\n+                ignoredAuditUsers,\n+                ignoredComplianceUsersForRead,\n+                ignoredComplianceUsersForWrite,\n+                ignoreAuditRequests,\n+                disabledRestCategories,\n+                disabledTransportCategories,\n+                opendistrosecurityIndex);\n+    }\n+\n+    private static List<String> getSettingAsList(final Settings settings, final String key, final List<String> defaultList, final boolean ignoreCaseForNone) {\n+        final List<String> list = settings.getAsList(key, defaultList);\n+        if (list.size() == 1 && \"NONE\".equals(ignoreCaseForNone? list.get(0).toUpperCase() : list.get(0))) {\n+            return Collections.emptyList();\n+        }\n+        return list;\n+    }\n+\n+    public boolean isRestApiAuditEnabled() {\n+        return isRestApiAuditEnabled;\n+    }\n+\n+    public boolean isTransportApiAuditEnabled() {\n+        return isTransportApiAuditEnabled;\n+    }\n+\n+    public boolean shouldResolveBulkRequests() {\n+        return resolveBulkRequests;\n+    }\n+\n+    public boolean shouldLogRequestBody() {\n+        return logRequestBody;\n+    }\n+\n+    public boolean shouldResolveIndices() {\n+        return resolveIndices;\n+    }\n+\n+    public boolean shouldExcludeSensitiveHeaders() {\n+        return excludeSensitiveHeaders;\n+    }\n+\n+    public Set<String> getIgnoredAuditUsers() {\n+        return ignoredAuditUsers;\n+    }\n+\n+    public Set<String> getIgnoredComplianceUsersForRead() {\n+        return ignoredComplianceUsersForRead;\n+    }\n+\n+    public Set<String> getIgnoredComplianceUsersForWrite() {\n+        return ignoredComplianceUsersForWrite;\n+    }\n+\n+    public Set<String> getIgnoredAuditRequests() {\n+        return ignoreAuditRequests;\n+    }\n+\n+    public EnumSet<AuditCategory> getDisabledRestCategories() {\n+        return disabledRestCategories;\n+    }\n+\n+    public EnumSet<AuditCategory> getDisabledTransportCategories() {\n+        return disabledTransportCategories;\n+    }\n+\n+    public String getOpendistrosecurityIndex() {\n+        return opendistrosecurityIndex;\n+    }\n+\n+    public void log(Logger logger) {\n+        logger.info(\"Auditing on REST API is {}\", isRestApiAuditEnabled ? \"enabled\" : \"disabled\");\n+        logger.info(\"Auditing on Transport API is {}\", isTransportApiAuditEnabled ? \"enabled\" : \"disabled\");\n+        logger.info(\"Auditing of request body is {}\", logRequestBody ? \"enabled\" : \"disabled\");\n+        logger.info(\"Auditing should {} resolve bulk requests\", resolveBulkRequests ? \"\" : \"not\");\n+        logger.info(\"Auditing should {} resolve indices\", resolveBulkRequests ? \"\" : \"not\");\n+        logger.info(\"Auditing should {} exclude sensitive headers\", excludeSensitiveHeaders ? \"\" : \"not\");\n+        logger.info(\"Auditing will ignore users {}\", ignoredAuditUsers);\n+        logger.info(\"Auditing of compliance read operation will ignore users {}\", ignoredComplianceUsersForRead);\n+        logger.info(\"Auditing of compliance write operation will ignore users {}\", ignoredComplianceUsersForWrite);\n+        logger.info(\"Auditing has disabled rest categories {}\", disabledRestCategories);", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTUzMjI4MA==", "url": "https://github.com/opensearch-project/security/pull/306#discussion_r399532280", "bodyText": "nit: Same as REST API.", "author": "vrozov", "createdAt": "2020-03-27T20:53:17Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/auditlog/config/AuditConfig.java", "diffHunk": "@@ -0,0 +1,214 @@\n+package com.amazon.opendistroforelasticsearch.security.auditlog.config;\n+\n+import com.amazon.opendistroforelasticsearch.security.auditlog.impl.AuditCategory;\n+import com.amazon.opendistroforelasticsearch.security.support.ConfigConstants;\n+import com.google.common.collect.ImmutableSet;\n+import org.apache.logging.log4j.Logger;\n+import org.elasticsearch.common.settings.Settings;\n+\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.EnumSet;\n+import java.util.List;\n+import java.util.Set;\n+\n+public class AuditConfig {\n+    private static final List<String> DEFAULT_IGNORED_USERS = Collections.singletonList(\"kibanaserver\");\n+    private static final List<String> DEFAULT_DISABLED_CATEGORIES =\n+            Arrays.asList(AuditCategory.AUTHENTICATED.toString(),\n+                    AuditCategory.GRANTED_PRIVILEGES.toString());\n+\n+    private final boolean isRestApiAuditEnabled;\n+    private final boolean isTransportApiAuditEnabled;\n+    private final boolean resolveBulkRequests;\n+    private final boolean logRequestBody;\n+    private final boolean resolveIndices;\n+    private final boolean excludeSensitiveHeaders;\n+    private final Set<String> ignoredAuditUsers;\n+    private final Set<String> ignoredComplianceUsersForRead;\n+    private final Set<String> ignoredComplianceUsersForWrite;\n+    private final Set<String> ignoreAuditRequests;\n+    private final EnumSet<AuditCategory> disabledRestCategories;\n+    private final EnumSet<AuditCategory> disabledTransportCategories;\n+    private final String opendistrosecurityIndex;\n+\n+    private AuditConfig(final boolean isRestApiAuditEnabled,\n+                        final boolean isTransportApiAuditEnabled,\n+                        final boolean resolveBulkRequests,\n+                        final boolean logRequestBody,\n+                        final boolean resolveIndices,\n+                        final boolean excludeSensitiveHeaders,\n+                        final Set<String> ignoredAuditUsers,\n+                        final Set<String> ignoredComplianceUsersForRead,\n+                        final Set<String> ignoredComplianceUsersForWrite,\n+                        final Set<String> ignoredAuditRequests,\n+                        final EnumSet<AuditCategory> disabledRestCategories,\n+                        final EnumSet<AuditCategory> disabledTransportCategories,\n+                        final String opendistrosecurityIndex) {\n+        this.isRestApiAuditEnabled = isRestApiAuditEnabled;\n+        this.isTransportApiAuditEnabled = isTransportApiAuditEnabled;\n+        this.resolveBulkRequests = resolveBulkRequests;\n+        this.logRequestBody = logRequestBody;\n+        this.resolveIndices = resolveIndices;\n+        this.excludeSensitiveHeaders = excludeSensitiveHeaders;\n+        this.ignoredAuditUsers = ignoredAuditUsers;\n+        this.ignoredComplianceUsersForRead = ignoredComplianceUsersForRead;\n+        this.ignoredComplianceUsersForWrite = ignoredComplianceUsersForWrite;\n+        this.ignoreAuditRequests = ignoredAuditRequests;\n+        this.disabledRestCategories = disabledRestCategories;\n+        this.disabledTransportCategories = disabledTransportCategories;\n+        this.opendistrosecurityIndex = opendistrosecurityIndex;\n+    }\n+\n+    public static AuditConfig from(Settings settings) {\n+        final boolean isRestApiAuditEnabled = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_ENABLE_REST, true);\n+        final boolean isTransportAuditEnabled = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_ENABLE_TRANSPORT, true);\n+        final boolean resolveBulkRequests = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_RESOLVE_BULK_REQUESTS, false);\n+        final boolean logRequestBody = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_LOG_REQUEST_BODY, true);\n+        final boolean resolveIndices = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_RESOLVE_INDICES, true);\n+        final boolean excludeSensitiveHeaders = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_EXCLUDE_SENSITIVE_HEADERS, true);\n+        final String opendistrosecurityIndex = settings.get(ConfigConstants.OPENDISTRO_SECURITY_CONFIG_INDEX_NAME, ConfigConstants.OPENDISTRO_SECURITY_DEFAULT_CONFIG_INDEX);\n+\n+        final EnumSet<AuditCategory> disabledRestCategories = AuditCategory.parse(getSettingAsList(\n+                settings,\n+                ConfigConstants.OPENDISTRO_SECURITY_AUDIT_CONFIG_DISABLED_REST_CATEGORIES,\n+                DEFAULT_DISABLED_CATEGORIES,\n+                true));\n+\n+        final EnumSet<AuditCategory> disabledTransportCategories = AuditCategory.parse(getSettingAsList(\n+                settings,\n+                ConfigConstants.OPENDISTRO_SECURITY_AUDIT_CONFIG_DISABLED_TRANSPORT_CATEGORIES,\n+                DEFAULT_DISABLED_CATEGORIES,\n+                true));\n+\n+        final Set<String> ignoredAuditUsers = ImmutableSet.copyOf(getSettingAsList(\n+                settings,\n+                ConfigConstants.OPENDISTRO_SECURITY_AUDIT_IGNORE_USERS,\n+                DEFAULT_IGNORED_USERS,\n+                false));\n+\n+        final Set<String> ignoredComplianceUsersForRead = ImmutableSet.copyOf(getSettingAsList(\n+                settings,\n+                ConfigConstants.OPENDISTRO_SECURITY_COMPLIANCE_HISTORY_READ_IGNORE_USERS,\n+                DEFAULT_IGNORED_USERS,\n+                false));\n+\n+        final Set<String> ignoredComplianceUsersForWrite = ImmutableSet.copyOf(getSettingAsList(\n+                settings,\n+                ConfigConstants.OPENDISTRO_SECURITY_COMPLIANCE_HISTORY_WRITE_IGNORE_USERS,\n+                DEFAULT_IGNORED_USERS,\n+                false));\n+\n+        final Set<String> ignoreAuditRequests = ImmutableSet.copyOf(settings.getAsList(\n+                ConfigConstants.OPENDISTRO_SECURITY_AUDIT_IGNORE_REQUESTS,\n+                Collections.emptyList()));\n+\n+        return new AuditConfig(isRestApiAuditEnabled,\n+                isTransportAuditEnabled,\n+                resolveBulkRequests,\n+                logRequestBody,\n+                resolveIndices,\n+                excludeSensitiveHeaders,\n+                ignoredAuditUsers,\n+                ignoredComplianceUsersForRead,\n+                ignoredComplianceUsersForWrite,\n+                ignoreAuditRequests,\n+                disabledRestCategories,\n+                disabledTransportCategories,\n+                opendistrosecurityIndex);\n+    }\n+\n+    private static List<String> getSettingAsList(final Settings settings, final String key, final List<String> defaultList, final boolean ignoreCaseForNone) {\n+        final List<String> list = settings.getAsList(key, defaultList);\n+        if (list.size() == 1 && \"NONE\".equals(ignoreCaseForNone? list.get(0).toUpperCase() : list.get(0))) {\n+            return Collections.emptyList();\n+        }\n+        return list;\n+    }\n+\n+    public boolean isRestApiAuditEnabled() {\n+        return isRestApiAuditEnabled;\n+    }\n+\n+    public boolean isTransportApiAuditEnabled() {\n+        return isTransportApiAuditEnabled;\n+    }\n+\n+    public boolean shouldResolveBulkRequests() {\n+        return resolveBulkRequests;\n+    }\n+\n+    public boolean shouldLogRequestBody() {\n+        return logRequestBody;\n+    }\n+\n+    public boolean shouldResolveIndices() {\n+        return resolveIndices;\n+    }\n+\n+    public boolean shouldExcludeSensitiveHeaders() {\n+        return excludeSensitiveHeaders;\n+    }\n+\n+    public Set<String> getIgnoredAuditUsers() {\n+        return ignoredAuditUsers;\n+    }\n+\n+    public Set<String> getIgnoredComplianceUsersForRead() {\n+        return ignoredComplianceUsersForRead;\n+    }\n+\n+    public Set<String> getIgnoredComplianceUsersForWrite() {\n+        return ignoredComplianceUsersForWrite;\n+    }\n+\n+    public Set<String> getIgnoredAuditRequests() {\n+        return ignoreAuditRequests;\n+    }\n+\n+    public EnumSet<AuditCategory> getDisabledRestCategories() {\n+        return disabledRestCategories;\n+    }\n+\n+    public EnumSet<AuditCategory> getDisabledTransportCategories() {\n+        return disabledTransportCategories;\n+    }\n+\n+    public String getOpendistrosecurityIndex() {\n+        return opendistrosecurityIndex;\n+    }\n+\n+    public void log(Logger logger) {\n+        logger.info(\"Auditing on REST API is {}\", isRestApiAuditEnabled ? \"enabled\" : \"disabled\");\n+        logger.info(\"Auditing on Transport API is {}\", isTransportApiAuditEnabled ? \"enabled\" : \"disabled\");\n+        logger.info(\"Auditing of request body is {}\", logRequestBody ? \"enabled\" : \"disabled\");\n+        logger.info(\"Auditing should {} resolve bulk requests\", resolveBulkRequests ? \"\" : \"not\");\n+        logger.info(\"Auditing should {} resolve indices\", resolveBulkRequests ? \"\" : \"not\");\n+        logger.info(\"Auditing should {} exclude sensitive headers\", excludeSensitiveHeaders ? \"\" : \"not\");\n+        logger.info(\"Auditing will ignore users {}\", ignoredAuditUsers);\n+        logger.info(\"Auditing of compliance read operation will ignore users {}\", ignoredComplianceUsersForRead);\n+        logger.info(\"Auditing of compliance write operation will ignore users {}\", ignoredComplianceUsersForWrite);\n+        logger.info(\"Auditing has disabled rest categories {}\", disabledRestCategories);\n+        logger.info(\"Auditing has disabled transport categories {}\", disabledTransportCategories);", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTUzNDY3Mw==", "url": "https://github.com/opensearch-project/security/pull/306#discussion_r399534673", "bodyText": "nit: \"Open distro auditing uses {} index(alias?) to write auditing events.\"", "author": "vrozov", "createdAt": "2020-03-27T20:58:52Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/auditlog/config/AuditConfig.java", "diffHunk": "@@ -0,0 +1,214 @@\n+package com.amazon.opendistroforelasticsearch.security.auditlog.config;\n+\n+import com.amazon.opendistroforelasticsearch.security.auditlog.impl.AuditCategory;\n+import com.amazon.opendistroforelasticsearch.security.support.ConfigConstants;\n+import com.google.common.collect.ImmutableSet;\n+import org.apache.logging.log4j.Logger;\n+import org.elasticsearch.common.settings.Settings;\n+\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.EnumSet;\n+import java.util.List;\n+import java.util.Set;\n+\n+public class AuditConfig {\n+    private static final List<String> DEFAULT_IGNORED_USERS = Collections.singletonList(\"kibanaserver\");\n+    private static final List<String> DEFAULT_DISABLED_CATEGORIES =\n+            Arrays.asList(AuditCategory.AUTHENTICATED.toString(),\n+                    AuditCategory.GRANTED_PRIVILEGES.toString());\n+\n+    private final boolean isRestApiAuditEnabled;\n+    private final boolean isTransportApiAuditEnabled;\n+    private final boolean resolveBulkRequests;\n+    private final boolean logRequestBody;\n+    private final boolean resolveIndices;\n+    private final boolean excludeSensitiveHeaders;\n+    private final Set<String> ignoredAuditUsers;\n+    private final Set<String> ignoredComplianceUsersForRead;\n+    private final Set<String> ignoredComplianceUsersForWrite;\n+    private final Set<String> ignoreAuditRequests;\n+    private final EnumSet<AuditCategory> disabledRestCategories;\n+    private final EnumSet<AuditCategory> disabledTransportCategories;\n+    private final String opendistrosecurityIndex;\n+\n+    private AuditConfig(final boolean isRestApiAuditEnabled,\n+                        final boolean isTransportApiAuditEnabled,\n+                        final boolean resolveBulkRequests,\n+                        final boolean logRequestBody,\n+                        final boolean resolveIndices,\n+                        final boolean excludeSensitiveHeaders,\n+                        final Set<String> ignoredAuditUsers,\n+                        final Set<String> ignoredComplianceUsersForRead,\n+                        final Set<String> ignoredComplianceUsersForWrite,\n+                        final Set<String> ignoredAuditRequests,\n+                        final EnumSet<AuditCategory> disabledRestCategories,\n+                        final EnumSet<AuditCategory> disabledTransportCategories,\n+                        final String opendistrosecurityIndex) {\n+        this.isRestApiAuditEnabled = isRestApiAuditEnabled;\n+        this.isTransportApiAuditEnabled = isTransportApiAuditEnabled;\n+        this.resolveBulkRequests = resolveBulkRequests;\n+        this.logRequestBody = logRequestBody;\n+        this.resolveIndices = resolveIndices;\n+        this.excludeSensitiveHeaders = excludeSensitiveHeaders;\n+        this.ignoredAuditUsers = ignoredAuditUsers;\n+        this.ignoredComplianceUsersForRead = ignoredComplianceUsersForRead;\n+        this.ignoredComplianceUsersForWrite = ignoredComplianceUsersForWrite;\n+        this.ignoreAuditRequests = ignoredAuditRequests;\n+        this.disabledRestCategories = disabledRestCategories;\n+        this.disabledTransportCategories = disabledTransportCategories;\n+        this.opendistrosecurityIndex = opendistrosecurityIndex;\n+    }\n+\n+    public static AuditConfig from(Settings settings) {\n+        final boolean isRestApiAuditEnabled = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_ENABLE_REST, true);\n+        final boolean isTransportAuditEnabled = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_ENABLE_TRANSPORT, true);\n+        final boolean resolveBulkRequests = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_RESOLVE_BULK_REQUESTS, false);\n+        final boolean logRequestBody = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_LOG_REQUEST_BODY, true);\n+        final boolean resolveIndices = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_RESOLVE_INDICES, true);\n+        final boolean excludeSensitiveHeaders = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_EXCLUDE_SENSITIVE_HEADERS, true);\n+        final String opendistrosecurityIndex = settings.get(ConfigConstants.OPENDISTRO_SECURITY_CONFIG_INDEX_NAME, ConfigConstants.OPENDISTRO_SECURITY_DEFAULT_CONFIG_INDEX);\n+\n+        final EnumSet<AuditCategory> disabledRestCategories = AuditCategory.parse(getSettingAsList(\n+                settings,\n+                ConfigConstants.OPENDISTRO_SECURITY_AUDIT_CONFIG_DISABLED_REST_CATEGORIES,\n+                DEFAULT_DISABLED_CATEGORIES,\n+                true));\n+\n+        final EnumSet<AuditCategory> disabledTransportCategories = AuditCategory.parse(getSettingAsList(\n+                settings,\n+                ConfigConstants.OPENDISTRO_SECURITY_AUDIT_CONFIG_DISABLED_TRANSPORT_CATEGORIES,\n+                DEFAULT_DISABLED_CATEGORIES,\n+                true));\n+\n+        final Set<String> ignoredAuditUsers = ImmutableSet.copyOf(getSettingAsList(\n+                settings,\n+                ConfigConstants.OPENDISTRO_SECURITY_AUDIT_IGNORE_USERS,\n+                DEFAULT_IGNORED_USERS,\n+                false));\n+\n+        final Set<String> ignoredComplianceUsersForRead = ImmutableSet.copyOf(getSettingAsList(\n+                settings,\n+                ConfigConstants.OPENDISTRO_SECURITY_COMPLIANCE_HISTORY_READ_IGNORE_USERS,\n+                DEFAULT_IGNORED_USERS,\n+                false));\n+\n+        final Set<String> ignoredComplianceUsersForWrite = ImmutableSet.copyOf(getSettingAsList(\n+                settings,\n+                ConfigConstants.OPENDISTRO_SECURITY_COMPLIANCE_HISTORY_WRITE_IGNORE_USERS,\n+                DEFAULT_IGNORED_USERS,\n+                false));\n+\n+        final Set<String> ignoreAuditRequests = ImmutableSet.copyOf(settings.getAsList(\n+                ConfigConstants.OPENDISTRO_SECURITY_AUDIT_IGNORE_REQUESTS,\n+                Collections.emptyList()));\n+\n+        return new AuditConfig(isRestApiAuditEnabled,\n+                isTransportAuditEnabled,\n+                resolveBulkRequests,\n+                logRequestBody,\n+                resolveIndices,\n+                excludeSensitiveHeaders,\n+                ignoredAuditUsers,\n+                ignoredComplianceUsersForRead,\n+                ignoredComplianceUsersForWrite,\n+                ignoreAuditRequests,\n+                disabledRestCategories,\n+                disabledTransportCategories,\n+                opendistrosecurityIndex);\n+    }\n+\n+    private static List<String> getSettingAsList(final Settings settings, final String key, final List<String> defaultList, final boolean ignoreCaseForNone) {\n+        final List<String> list = settings.getAsList(key, defaultList);\n+        if (list.size() == 1 && \"NONE\".equals(ignoreCaseForNone? list.get(0).toUpperCase() : list.get(0))) {\n+            return Collections.emptyList();\n+        }\n+        return list;\n+    }\n+\n+    public boolean isRestApiAuditEnabled() {\n+        return isRestApiAuditEnabled;\n+    }\n+\n+    public boolean isTransportApiAuditEnabled() {\n+        return isTransportApiAuditEnabled;\n+    }\n+\n+    public boolean shouldResolveBulkRequests() {\n+        return resolveBulkRequests;\n+    }\n+\n+    public boolean shouldLogRequestBody() {\n+        return logRequestBody;\n+    }\n+\n+    public boolean shouldResolveIndices() {\n+        return resolveIndices;\n+    }\n+\n+    public boolean shouldExcludeSensitiveHeaders() {\n+        return excludeSensitiveHeaders;\n+    }\n+\n+    public Set<String> getIgnoredAuditUsers() {\n+        return ignoredAuditUsers;\n+    }\n+\n+    public Set<String> getIgnoredComplianceUsersForRead() {\n+        return ignoredComplianceUsersForRead;\n+    }\n+\n+    public Set<String> getIgnoredComplianceUsersForWrite() {\n+        return ignoredComplianceUsersForWrite;\n+    }\n+\n+    public Set<String> getIgnoredAuditRequests() {\n+        return ignoreAuditRequests;\n+    }\n+\n+    public EnumSet<AuditCategory> getDisabledRestCategories() {\n+        return disabledRestCategories;\n+    }\n+\n+    public EnumSet<AuditCategory> getDisabledTransportCategories() {\n+        return disabledTransportCategories;\n+    }\n+\n+    public String getOpendistrosecurityIndex() {\n+        return opendistrosecurityIndex;\n+    }\n+\n+    public void log(Logger logger) {\n+        logger.info(\"Auditing on REST API is {}\", isRestApiAuditEnabled ? \"enabled\" : \"disabled\");\n+        logger.info(\"Auditing on Transport API is {}\", isTransportApiAuditEnabled ? \"enabled\" : \"disabled\");\n+        logger.info(\"Auditing of request body is {}\", logRequestBody ? \"enabled\" : \"disabled\");\n+        logger.info(\"Auditing should {} resolve bulk requests\", resolveBulkRequests ? \"\" : \"not\");\n+        logger.info(\"Auditing should {} resolve indices\", resolveBulkRequests ? \"\" : \"not\");\n+        logger.info(\"Auditing should {} exclude sensitive headers\", excludeSensitiveHeaders ? \"\" : \"not\");\n+        logger.info(\"Auditing will ignore users {}\", ignoredAuditUsers);\n+        logger.info(\"Auditing of compliance read operation will ignore users {}\", ignoredComplianceUsersForRead);\n+        logger.info(\"Auditing of compliance write operation will ignore users {}\", ignoredComplianceUsersForWrite);\n+        logger.info(\"Auditing has disabled rest categories {}\", disabledRestCategories);\n+        logger.info(\"Auditing has disabled transport categories {}\", disabledTransportCategories);\n+        logger.info(\"Auditing is configured to use opendistro security index {}\", opendistrosecurityIndex);", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTUzOTA3MQ==", "url": "https://github.com/opensearch-project/security/pull/306#discussion_r399539071", "bodyText": "Sorry if I missed that rename in the prior reviews. Can you please rename it back to log as other classes mostly use log for the Logger.", "author": "vrozov", "createdAt": "2020-03-27T21:09:15Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/auditlog/impl/AbstractAuditLog.java", "diffHunk": "@@ -80,33 +79,15 @@\n import com.google.common.io.BaseEncoding;\n \n public abstract class AbstractAuditLog implements AuditLog {\n+    protected final Logger logger = LogManager.getLogger(this.getClass());", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTU0NDU5Nw==", "url": "https://github.com/opensearch-project/security/pull/306#discussion_r399544597", "bodyText": "logger seems more appropriate than log", "author": "sujithvm", "createdAt": "2020-03-27T21:23:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTUzOTA3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTU2Mzk2NQ==", "url": "https://github.com/opensearch-project/security/pull/306#discussion_r399563965", "bodyText": "I don't have a strong preference of log over logger, just want to be consistent. For me, both log and logger are fine.\nAs the majority of other classes use log and the change is not part of AuditConfig refactoring, let's keep it as log in this PR/commit.", "author": "vrozov", "createdAt": "2020-03-27T22:20:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTUzOTA3MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTU2NjEwMg==", "url": "https://github.com/opensearch-project/security/pull/306#discussion_r399566102", "bodyText": "My bad for not being clear. I was not sure if opendistrosecurityIndex can be an alias instead of an index, so I put \"alias?\". If it can be an alias, please use \"index or alias\", otherwise just \"index\".", "author": "vrozov", "createdAt": "2020-03-27T22:27:22Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/auditlog/config/AuditConfig.java", "diffHunk": "@@ -0,0 +1,214 @@\n+package com.amazon.opendistroforelasticsearch.security.auditlog.config;\n+\n+import com.amazon.opendistroforelasticsearch.security.auditlog.impl.AuditCategory;\n+import com.amazon.opendistroforelasticsearch.security.support.ConfigConstants;\n+import com.google.common.collect.ImmutableSet;\n+import org.apache.logging.log4j.Logger;\n+import org.elasticsearch.common.settings.Settings;\n+\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.EnumSet;\n+import java.util.List;\n+import java.util.Set;\n+\n+public class AuditConfig {\n+    private static final List<String> DEFAULT_IGNORED_USERS = Collections.singletonList(\"kibanaserver\");\n+    private static final List<String> DEFAULT_DISABLED_CATEGORIES =\n+            Arrays.asList(AuditCategory.AUTHENTICATED.toString(),\n+                    AuditCategory.GRANTED_PRIVILEGES.toString());\n+\n+    private final boolean isRestApiAuditEnabled;\n+    private final boolean isTransportApiAuditEnabled;\n+    private final boolean resolveBulkRequests;\n+    private final boolean logRequestBody;\n+    private final boolean resolveIndices;\n+    private final boolean excludeSensitiveHeaders;\n+    private final Set<String> ignoredAuditUsers;\n+    private final Set<String> ignoredComplianceUsersForRead;\n+    private final Set<String> ignoredComplianceUsersForWrite;\n+    private final Set<String> ignoreAuditRequests;\n+    private final EnumSet<AuditCategory> disabledRestCategories;\n+    private final EnumSet<AuditCategory> disabledTransportCategories;\n+    private final String opendistrosecurityIndex;\n+\n+    private AuditConfig(final boolean isRestApiAuditEnabled,\n+                        final boolean isTransportApiAuditEnabled,\n+                        final boolean resolveBulkRequests,\n+                        final boolean logRequestBody,\n+                        final boolean resolveIndices,\n+                        final boolean excludeSensitiveHeaders,\n+                        final Set<String> ignoredAuditUsers,\n+                        final Set<String> ignoredComplianceUsersForRead,\n+                        final Set<String> ignoredComplianceUsersForWrite,\n+                        final Set<String> ignoredAuditRequests,\n+                        final EnumSet<AuditCategory> disabledRestCategories,\n+                        final EnumSet<AuditCategory> disabledTransportCategories,\n+                        final String opendistrosecurityIndex) {\n+        this.isRestApiAuditEnabled = isRestApiAuditEnabled;\n+        this.isTransportApiAuditEnabled = isTransportApiAuditEnabled;\n+        this.resolveBulkRequests = resolveBulkRequests;\n+        this.logRequestBody = logRequestBody;\n+        this.resolveIndices = resolveIndices;\n+        this.excludeSensitiveHeaders = excludeSensitiveHeaders;\n+        this.ignoredAuditUsers = ignoredAuditUsers;\n+        this.ignoredComplianceUsersForRead = ignoredComplianceUsersForRead;\n+        this.ignoredComplianceUsersForWrite = ignoredComplianceUsersForWrite;\n+        this.ignoreAuditRequests = ignoredAuditRequests;\n+        this.disabledRestCategories = disabledRestCategories;\n+        this.disabledTransportCategories = disabledTransportCategories;\n+        this.opendistrosecurityIndex = opendistrosecurityIndex;\n+    }\n+\n+    public static AuditConfig from(Settings settings) {\n+        final boolean isRestApiAuditEnabled = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_ENABLE_REST, true);\n+        final boolean isTransportAuditEnabled = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_ENABLE_TRANSPORT, true);\n+        final boolean resolveBulkRequests = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_RESOLVE_BULK_REQUESTS, false);\n+        final boolean logRequestBody = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_LOG_REQUEST_BODY, true);\n+        final boolean resolveIndices = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_RESOLVE_INDICES, true);\n+        final boolean excludeSensitiveHeaders = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_EXCLUDE_SENSITIVE_HEADERS, true);\n+        final String opendistrosecurityIndex = settings.get(ConfigConstants.OPENDISTRO_SECURITY_CONFIG_INDEX_NAME, ConfigConstants.OPENDISTRO_SECURITY_DEFAULT_CONFIG_INDEX);\n+\n+        final EnumSet<AuditCategory> disabledRestCategories = AuditCategory.parse(getSettingAsList(\n+                settings,\n+                ConfigConstants.OPENDISTRO_SECURITY_AUDIT_CONFIG_DISABLED_REST_CATEGORIES,\n+                DEFAULT_DISABLED_CATEGORIES,\n+                true));\n+\n+        final EnumSet<AuditCategory> disabledTransportCategories = AuditCategory.parse(getSettingAsList(\n+                settings,\n+                ConfigConstants.OPENDISTRO_SECURITY_AUDIT_CONFIG_DISABLED_TRANSPORT_CATEGORIES,\n+                DEFAULT_DISABLED_CATEGORIES,\n+                true));\n+\n+        final Set<String> ignoredAuditUsers = ImmutableSet.copyOf(getSettingAsList(\n+                settings,\n+                ConfigConstants.OPENDISTRO_SECURITY_AUDIT_IGNORE_USERS,\n+                DEFAULT_IGNORED_USERS,\n+                false));\n+\n+        final Set<String> ignoredComplianceUsersForRead = ImmutableSet.copyOf(getSettingAsList(\n+                settings,\n+                ConfigConstants.OPENDISTRO_SECURITY_COMPLIANCE_HISTORY_READ_IGNORE_USERS,\n+                DEFAULT_IGNORED_USERS,\n+                false));\n+\n+        final Set<String> ignoredComplianceUsersForWrite = ImmutableSet.copyOf(getSettingAsList(\n+                settings,\n+                ConfigConstants.OPENDISTRO_SECURITY_COMPLIANCE_HISTORY_WRITE_IGNORE_USERS,\n+                DEFAULT_IGNORED_USERS,\n+                false));\n+\n+        final Set<String> ignoreAuditRequests = ImmutableSet.copyOf(settings.getAsList(\n+                ConfigConstants.OPENDISTRO_SECURITY_AUDIT_IGNORE_REQUESTS,\n+                Collections.emptyList()));\n+\n+        return new AuditConfig(isRestApiAuditEnabled,\n+                isTransportAuditEnabled,\n+                resolveBulkRequests,\n+                logRequestBody,\n+                resolveIndices,\n+                excludeSensitiveHeaders,\n+                ignoredAuditUsers,\n+                ignoredComplianceUsersForRead,\n+                ignoredComplianceUsersForWrite,\n+                ignoreAuditRequests,\n+                disabledRestCategories,\n+                disabledTransportCategories,\n+                opendistrosecurityIndex);\n+    }\n+\n+    private static List<String> getSettingAsList(final Settings settings, final String key, final List<String> defaultList, final boolean ignoreCaseForNone) {\n+        final List<String> list = settings.getAsList(key, defaultList);\n+        if (list.size() == 1 && \"NONE\".equals(ignoreCaseForNone? list.get(0).toUpperCase() : list.get(0))) {\n+            return Collections.emptyList();\n+        }\n+        return list;\n+    }\n+\n+    public boolean isRestApiAuditEnabled() {\n+        return isRestApiAuditEnabled;\n+    }\n+\n+    public boolean isTransportApiAuditEnabled() {\n+        return isTransportApiAuditEnabled;\n+    }\n+\n+    public boolean shouldResolveBulkRequests() {\n+        return resolveBulkRequests;\n+    }\n+\n+    public boolean shouldLogRequestBody() {\n+        return logRequestBody;\n+    }\n+\n+    public boolean shouldResolveIndices() {\n+        return resolveIndices;\n+    }\n+\n+    public boolean shouldExcludeSensitiveHeaders() {\n+        return excludeSensitiveHeaders;\n+    }\n+\n+    public Set<String> getIgnoredAuditUsers() {\n+        return ignoredAuditUsers;\n+    }\n+\n+    public Set<String> getIgnoredComplianceUsersForRead() {\n+        return ignoredComplianceUsersForRead;\n+    }\n+\n+    public Set<String> getIgnoredComplianceUsersForWrite() {\n+        return ignoredComplianceUsersForWrite;\n+    }\n+\n+    public Set<String> getIgnoredAuditRequests() {\n+        return ignoreAuditRequests;\n+    }\n+\n+    public EnumSet<AuditCategory> getDisabledRestCategories() {\n+        return disabledRestCategories;\n+    }\n+\n+    public EnumSet<AuditCategory> getDisabledTransportCategories() {\n+        return disabledTransportCategories;\n+    }\n+\n+    public String getOpendistrosecurityIndex() {\n+        return opendistrosecurityIndex;\n+    }\n+\n+    public void log(Logger logger) {\n+        logger.info(\"Auditing on REST API is {}.\", isRestApiAuditEnabled ? \"enabled\" : \"disabled\");\n+        logger.info(\"Auditing on Transport API is {}.\", isTransportApiAuditEnabled ? \"enabled\" : \"disabled\");\n+        logger.info(\"Auditing of request body is {}.\", logRequestBody ? \"enabled\" : \"disabled\");\n+        logger.info(\"Bulk requests resolution is {} during request auditing.\", resolveBulkRequests ? \"enabled\" : \"disabled\");\n+        logger.info(\"Index resolution is {} during request auditing.\", resolveIndices ? \"enabled\" : \"disabled\");\n+        logger.info(\"Sensitive headers auditing is {}.\", excludeSensitiveHeaders ? \"enabled\" : \"disabled\");\n+        logger.info(\"Auditing requests from {} users is disabled.\", ignoredAuditUsers);\n+        logger.info(\"Compliance read operation requests auditing from {} users is disabled.\", ignoredComplianceUsersForRead);\n+        logger.info(\"Compliance write operation requests auditing from {} users is disabled.\", ignoredComplianceUsersForWrite);\n+        logger.info(\"{} are excluded from REST API auditing.\", disabledRestCategories);\n+        logger.info(\"{} are excluded from Transport API auditing.\", disabledTransportCategories);\n+        logger.info(\"Open distro auditing uses {} index(alias?) to write auditing events.\", opendistrosecurityIndex);", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTU2ODYwMg==", "url": "https://github.com/opensearch-project/security/pull/306#discussion_r399568602", "bodyText": "It uses that index to monitor change events for internal configuration.", "author": "sujithvm", "createdAt": "2020-03-27T22:36:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTU2NjEwMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDQ1NzAwNw==", "url": "https://github.com/opensearch-project/security/pull/306#discussion_r400457007", "bodyText": "Assuming that you will make another round of changes, can you move this to line 175?", "author": "vrozov", "createdAt": "2020-03-30T19:58:44Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/auditlog/config/AuditConfig.java", "diffHunk": "@@ -0,0 +1,204 @@\n+package com.amazon.opendistroforelasticsearch.security.auditlog.config;\n+\n+import com.amazon.opendistroforelasticsearch.security.auditlog.impl.AuditCategory;\n+import com.amazon.opendistroforelasticsearch.security.support.ConfigConstants;\n+import com.google.common.collect.ImmutableSet;\n+import org.apache.logging.log4j.Logger;\n+import org.elasticsearch.common.settings.Settings;\n+\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.EnumSet;\n+import java.util.List;\n+import java.util.Set;\n+\n+public class AuditConfig {\n+    private static final List<String> DEFAULT_IGNORED_USERS = Collections.singletonList(\"kibanaserver\");\n+    private static final List<String> DEFAULT_DISABLED_CATEGORIES =\n+            Arrays.asList(AuditCategory.AUTHENTICATED.toString(),\n+                    AuditCategory.GRANTED_PRIVILEGES.toString());\n+\n+    private final boolean isRestApiAuditEnabled;\n+    private final boolean isTransportApiAuditEnabled;\n+    private final boolean resolveBulkRequests;\n+    private final boolean logRequestBody;\n+    private final boolean resolveIndices;\n+    private final boolean excludeSensitiveHeaders;\n+    private final Set<String> ignoredAuditUsers;\n+    private final Set<String> ignoredComplianceUsersForRead;\n+    private final Set<String> ignoredComplianceUsersForWrite;\n+    private final Set<String> ignoreAuditRequests;\n+    private final EnumSet<AuditCategory> disabledRestCategories;\n+    private final EnumSet<AuditCategory> disabledTransportCategories;\n+\n+    private AuditConfig(final boolean isRestApiAuditEnabled,\n+                        final boolean isTransportApiAuditEnabled,\n+                        final boolean resolveBulkRequests,\n+                        final boolean logRequestBody,\n+                        final boolean resolveIndices,\n+                        final boolean excludeSensitiveHeaders,\n+                        final Set<String> ignoredAuditUsers,\n+                        final Set<String> ignoredComplianceUsersForRead,\n+                        final Set<String> ignoredComplianceUsersForWrite,\n+                        final Set<String> ignoredAuditRequests,\n+                        final EnumSet<AuditCategory> disabledRestCategories,\n+                        final EnumSet<AuditCategory> disabledTransportCategories) {\n+        this.isRestApiAuditEnabled = isRestApiAuditEnabled;\n+        this.isTransportApiAuditEnabled = isTransportApiAuditEnabled;\n+        this.resolveBulkRequests = resolveBulkRequests;\n+        this.logRequestBody = logRequestBody;\n+        this.resolveIndices = resolveIndices;\n+        this.excludeSensitiveHeaders = excludeSensitiveHeaders;\n+        this.ignoredAuditUsers = ignoredAuditUsers;\n+        this.ignoredComplianceUsersForRead = ignoredComplianceUsersForRead;\n+        this.ignoredComplianceUsersForWrite = ignoredComplianceUsersForWrite;\n+        this.ignoreAuditRequests = ignoredAuditRequests;\n+        this.disabledRestCategories = disabledRestCategories;\n+        this.disabledTransportCategories = disabledTransportCategories;\n+    }\n+\n+    public static AuditConfig from(Settings settings) {\n+        final boolean isRestApiAuditEnabled = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_ENABLE_REST, true);\n+        final boolean isTransportAuditEnabled = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_ENABLE_TRANSPORT, true);\n+        final boolean resolveBulkRequests = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_RESOLVE_BULK_REQUESTS, false);\n+        final boolean logRequestBody = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_LOG_REQUEST_BODY, true);\n+        final boolean resolveIndices = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_RESOLVE_INDICES, true);\n+        final boolean excludeSensitiveHeaders = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_EXCLUDE_SENSITIVE_HEADERS, true);\n+        final String opendistrosecurityIndex = settings.get(ConfigConstants.OPENDISTRO_SECURITY_CONFIG_INDEX_NAME, ConfigConstants.OPENDISTRO_SECURITY_DEFAULT_CONFIG_INDEX);\n+\n+        final EnumSet<AuditCategory> disabledRestCategories = AuditCategory.parse(getSettingAsList(\n+                settings,\n+                ConfigConstants.OPENDISTRO_SECURITY_AUDIT_CONFIG_DISABLED_REST_CATEGORIES,\n+                DEFAULT_DISABLED_CATEGORIES,\n+                true));\n+\n+        final EnumSet<AuditCategory> disabledTransportCategories = AuditCategory.parse(getSettingAsList(\n+                settings,\n+                ConfigConstants.OPENDISTRO_SECURITY_AUDIT_CONFIG_DISABLED_TRANSPORT_CATEGORIES,\n+                DEFAULT_DISABLED_CATEGORIES,\n+                true));\n+\n+        final Set<String> ignoredAuditUsers = ImmutableSet.copyOf(getSettingAsList(\n+                settings,\n+                ConfigConstants.OPENDISTRO_SECURITY_AUDIT_IGNORE_USERS,\n+                DEFAULT_IGNORED_USERS,\n+                false));\n+\n+        final Set<String> ignoredComplianceUsersForRead = ImmutableSet.copyOf(getSettingAsList(\n+                settings,\n+                ConfigConstants.OPENDISTRO_SECURITY_COMPLIANCE_HISTORY_READ_IGNORE_USERS,\n+                DEFAULT_IGNORED_USERS,\n+                false));\n+\n+        final Set<String> ignoredComplianceUsersForWrite = ImmutableSet.copyOf(getSettingAsList(\n+                settings,\n+                ConfigConstants.OPENDISTRO_SECURITY_COMPLIANCE_HISTORY_WRITE_IGNORE_USERS,\n+                DEFAULT_IGNORED_USERS,\n+                false));\n+\n+        final Set<String> ignoreAuditRequests = ImmutableSet.copyOf(settings.getAsList(\n+                ConfigConstants.OPENDISTRO_SECURITY_AUDIT_IGNORE_REQUESTS,\n+                Collections.emptyList()));\n+\n+        return new AuditConfig(isRestApiAuditEnabled,\n+                isTransportAuditEnabled,\n+                resolveBulkRequests,\n+                logRequestBody,\n+                resolveIndices,\n+                excludeSensitiveHeaders,\n+                ignoredAuditUsers,\n+                ignoredComplianceUsersForRead,\n+                ignoredComplianceUsersForWrite,\n+                ignoreAuditRequests,\n+                disabledRestCategories,\n+                disabledTransportCategories);\n+    }\n+\n+    private static List<String> getSettingAsList(final Settings settings, final String key, final List<String> defaultList, final boolean ignoreCaseForNone) {\n+        final List<String> list = settings.getAsList(key, defaultList);\n+        if (list.size() == 1 && \"NONE\".equals(ignoreCaseForNone? list.get(0).toUpperCase() : list.get(0))) {\n+            return Collections.emptyList();\n+        }\n+        return list;\n+    }\n+\n+    public boolean isRestApiAuditEnabled() {\n+        return isRestApiAuditEnabled;\n+    }\n+\n+    public boolean isTransportApiAuditEnabled() {\n+        return isTransportApiAuditEnabled;\n+    }\n+\n+    public boolean shouldResolveBulkRequests() {\n+        return resolveBulkRequests;\n+    }\n+\n+    public boolean shouldLogRequestBody() {\n+        return logRequestBody;\n+    }\n+\n+    public boolean shouldResolveIndices() {\n+        return resolveIndices;\n+    }\n+\n+    public boolean shouldExcludeSensitiveHeaders() {\n+        return excludeSensitiveHeaders;\n+    }\n+\n+    public Set<String> getIgnoredAuditUsers() {\n+        return ignoredAuditUsers;\n+    }\n+\n+    public Set<String> getIgnoredComplianceUsersForRead() {\n+        return ignoredComplianceUsersForRead;\n+    }\n+\n+    public Set<String> getIgnoredComplianceUsersForWrite() {\n+        return ignoredComplianceUsersForWrite;\n+    }\n+\n+    public Set<String> getIgnoredAuditRequests() {\n+        return ignoreAuditRequests;\n+    }\n+\n+    public EnumSet<AuditCategory> getDisabledRestCategories() {\n+        return disabledRestCategories;\n+    }\n+\n+    public EnumSet<AuditCategory> getDisabledTransportCategories() {\n+        return disabledTransportCategories;\n+    }\n+\n+    public void log(Logger logger) {\n+        logger.info(\"Auditing on REST API is {}.\", isRestApiAuditEnabled ? \"enabled\" : \"disabled\");\n+        logger.info(\"Auditing on Transport API is {}.\", isTransportApiAuditEnabled ? \"enabled\" : \"disabled\");\n+        logger.info(\"Auditing of request body is {}.\", logRequestBody ? \"enabled\" : \"disabled\");\n+        logger.info(\"Bulk requests resolution is {} during request auditing.\", resolveBulkRequests ? \"enabled\" : \"disabled\");\n+        logger.info(\"Index resolution is {} during request auditing.\", resolveIndices ? \"enabled\" : \"disabled\");\n+        logger.info(\"Sensitive headers auditing is {}.\", excludeSensitiveHeaders ? \"enabled\" : \"disabled\");\n+        logger.info(\"Auditing requests from {} users is disabled.\", ignoredAuditUsers);\n+        logger.info(\"Compliance read operation requests auditing from {} users is disabled.\", ignoredComplianceUsersForRead);\n+        logger.info(\"Compliance write operation requests auditing from {} users is disabled.\", ignoredComplianceUsersForWrite);\n+        logger.info(\"{} are excluded from REST API auditing.\", disabledRestCategories);", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDQ1NzQyMQ==", "url": "https://github.com/opensearch-project/security/pull/306#discussion_r400457421", "bodyText": "and this one to line 176.", "author": "vrozov", "createdAt": "2020-03-30T19:59:28Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/auditlog/config/AuditConfig.java", "diffHunk": "@@ -0,0 +1,204 @@\n+package com.amazon.opendistroforelasticsearch.security.auditlog.config;\n+\n+import com.amazon.opendistroforelasticsearch.security.auditlog.impl.AuditCategory;\n+import com.amazon.opendistroforelasticsearch.security.support.ConfigConstants;\n+import com.google.common.collect.ImmutableSet;\n+import org.apache.logging.log4j.Logger;\n+import org.elasticsearch.common.settings.Settings;\n+\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.EnumSet;\n+import java.util.List;\n+import java.util.Set;\n+\n+public class AuditConfig {\n+    private static final List<String> DEFAULT_IGNORED_USERS = Collections.singletonList(\"kibanaserver\");\n+    private static final List<String> DEFAULT_DISABLED_CATEGORIES =\n+            Arrays.asList(AuditCategory.AUTHENTICATED.toString(),\n+                    AuditCategory.GRANTED_PRIVILEGES.toString());\n+\n+    private final boolean isRestApiAuditEnabled;\n+    private final boolean isTransportApiAuditEnabled;\n+    private final boolean resolveBulkRequests;\n+    private final boolean logRequestBody;\n+    private final boolean resolveIndices;\n+    private final boolean excludeSensitiveHeaders;\n+    private final Set<String> ignoredAuditUsers;\n+    private final Set<String> ignoredComplianceUsersForRead;\n+    private final Set<String> ignoredComplianceUsersForWrite;\n+    private final Set<String> ignoreAuditRequests;\n+    private final EnumSet<AuditCategory> disabledRestCategories;\n+    private final EnumSet<AuditCategory> disabledTransportCategories;\n+\n+    private AuditConfig(final boolean isRestApiAuditEnabled,\n+                        final boolean isTransportApiAuditEnabled,\n+                        final boolean resolveBulkRequests,\n+                        final boolean logRequestBody,\n+                        final boolean resolveIndices,\n+                        final boolean excludeSensitiveHeaders,\n+                        final Set<String> ignoredAuditUsers,\n+                        final Set<String> ignoredComplianceUsersForRead,\n+                        final Set<String> ignoredComplianceUsersForWrite,\n+                        final Set<String> ignoredAuditRequests,\n+                        final EnumSet<AuditCategory> disabledRestCategories,\n+                        final EnumSet<AuditCategory> disabledTransportCategories) {\n+        this.isRestApiAuditEnabled = isRestApiAuditEnabled;\n+        this.isTransportApiAuditEnabled = isTransportApiAuditEnabled;\n+        this.resolveBulkRequests = resolveBulkRequests;\n+        this.logRequestBody = logRequestBody;\n+        this.resolveIndices = resolveIndices;\n+        this.excludeSensitiveHeaders = excludeSensitiveHeaders;\n+        this.ignoredAuditUsers = ignoredAuditUsers;\n+        this.ignoredComplianceUsersForRead = ignoredComplianceUsersForRead;\n+        this.ignoredComplianceUsersForWrite = ignoredComplianceUsersForWrite;\n+        this.ignoreAuditRequests = ignoredAuditRequests;\n+        this.disabledRestCategories = disabledRestCategories;\n+        this.disabledTransportCategories = disabledTransportCategories;\n+    }\n+\n+    public static AuditConfig from(Settings settings) {\n+        final boolean isRestApiAuditEnabled = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_ENABLE_REST, true);\n+        final boolean isTransportAuditEnabled = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_ENABLE_TRANSPORT, true);\n+        final boolean resolveBulkRequests = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_RESOLVE_BULK_REQUESTS, false);\n+        final boolean logRequestBody = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_LOG_REQUEST_BODY, true);\n+        final boolean resolveIndices = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_RESOLVE_INDICES, true);\n+        final boolean excludeSensitiveHeaders = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_EXCLUDE_SENSITIVE_HEADERS, true);\n+        final String opendistrosecurityIndex = settings.get(ConfigConstants.OPENDISTRO_SECURITY_CONFIG_INDEX_NAME, ConfigConstants.OPENDISTRO_SECURITY_DEFAULT_CONFIG_INDEX);\n+\n+        final EnumSet<AuditCategory> disabledRestCategories = AuditCategory.parse(getSettingAsList(\n+                settings,\n+                ConfigConstants.OPENDISTRO_SECURITY_AUDIT_CONFIG_DISABLED_REST_CATEGORIES,\n+                DEFAULT_DISABLED_CATEGORIES,\n+                true));\n+\n+        final EnumSet<AuditCategory> disabledTransportCategories = AuditCategory.parse(getSettingAsList(\n+                settings,\n+                ConfigConstants.OPENDISTRO_SECURITY_AUDIT_CONFIG_DISABLED_TRANSPORT_CATEGORIES,\n+                DEFAULT_DISABLED_CATEGORIES,\n+                true));\n+\n+        final Set<String> ignoredAuditUsers = ImmutableSet.copyOf(getSettingAsList(\n+                settings,\n+                ConfigConstants.OPENDISTRO_SECURITY_AUDIT_IGNORE_USERS,\n+                DEFAULT_IGNORED_USERS,\n+                false));\n+\n+        final Set<String> ignoredComplianceUsersForRead = ImmutableSet.copyOf(getSettingAsList(\n+                settings,\n+                ConfigConstants.OPENDISTRO_SECURITY_COMPLIANCE_HISTORY_READ_IGNORE_USERS,\n+                DEFAULT_IGNORED_USERS,\n+                false));\n+\n+        final Set<String> ignoredComplianceUsersForWrite = ImmutableSet.copyOf(getSettingAsList(\n+                settings,\n+                ConfigConstants.OPENDISTRO_SECURITY_COMPLIANCE_HISTORY_WRITE_IGNORE_USERS,\n+                DEFAULT_IGNORED_USERS,\n+                false));\n+\n+        final Set<String> ignoreAuditRequests = ImmutableSet.copyOf(settings.getAsList(\n+                ConfigConstants.OPENDISTRO_SECURITY_AUDIT_IGNORE_REQUESTS,\n+                Collections.emptyList()));\n+\n+        return new AuditConfig(isRestApiAuditEnabled,\n+                isTransportAuditEnabled,\n+                resolveBulkRequests,\n+                logRequestBody,\n+                resolveIndices,\n+                excludeSensitiveHeaders,\n+                ignoredAuditUsers,\n+                ignoredComplianceUsersForRead,\n+                ignoredComplianceUsersForWrite,\n+                ignoreAuditRequests,\n+                disabledRestCategories,\n+                disabledTransportCategories);\n+    }\n+\n+    private static List<String> getSettingAsList(final Settings settings, final String key, final List<String> defaultList, final boolean ignoreCaseForNone) {\n+        final List<String> list = settings.getAsList(key, defaultList);\n+        if (list.size() == 1 && \"NONE\".equals(ignoreCaseForNone? list.get(0).toUpperCase() : list.get(0))) {\n+            return Collections.emptyList();\n+        }\n+        return list;\n+    }\n+\n+    public boolean isRestApiAuditEnabled() {\n+        return isRestApiAuditEnabled;\n+    }\n+\n+    public boolean isTransportApiAuditEnabled() {\n+        return isTransportApiAuditEnabled;\n+    }\n+\n+    public boolean shouldResolveBulkRequests() {\n+        return resolveBulkRequests;\n+    }\n+\n+    public boolean shouldLogRequestBody() {\n+        return logRequestBody;\n+    }\n+\n+    public boolean shouldResolveIndices() {\n+        return resolveIndices;\n+    }\n+\n+    public boolean shouldExcludeSensitiveHeaders() {\n+        return excludeSensitiveHeaders;\n+    }\n+\n+    public Set<String> getIgnoredAuditUsers() {\n+        return ignoredAuditUsers;\n+    }\n+\n+    public Set<String> getIgnoredComplianceUsersForRead() {\n+        return ignoredComplianceUsersForRead;\n+    }\n+\n+    public Set<String> getIgnoredComplianceUsersForWrite() {\n+        return ignoredComplianceUsersForWrite;\n+    }\n+\n+    public Set<String> getIgnoredAuditRequests() {\n+        return ignoreAuditRequests;\n+    }\n+\n+    public EnumSet<AuditCategory> getDisabledRestCategories() {\n+        return disabledRestCategories;\n+    }\n+\n+    public EnumSet<AuditCategory> getDisabledTransportCategories() {\n+        return disabledTransportCategories;\n+    }\n+\n+    public void log(Logger logger) {\n+        logger.info(\"Auditing on REST API is {}.\", isRestApiAuditEnabled ? \"enabled\" : \"disabled\");\n+        logger.info(\"Auditing on Transport API is {}.\", isTransportApiAuditEnabled ? \"enabled\" : \"disabled\");\n+        logger.info(\"Auditing of request body is {}.\", logRequestBody ? \"enabled\" : \"disabled\");\n+        logger.info(\"Bulk requests resolution is {} during request auditing.\", resolveBulkRequests ? \"enabled\" : \"disabled\");\n+        logger.info(\"Index resolution is {} during request auditing.\", resolveIndices ? \"enabled\" : \"disabled\");\n+        logger.info(\"Sensitive headers auditing is {}.\", excludeSensitiveHeaders ? \"enabled\" : \"disabled\");\n+        logger.info(\"Auditing requests from {} users is disabled.\", ignoredAuditUsers);\n+        logger.info(\"Compliance read operation requests auditing from {} users is disabled.\", ignoredComplianceUsersForRead);\n+        logger.info(\"Compliance write operation requests auditing from {} users is disabled.\", ignoredComplianceUsersForWrite);\n+        logger.info(\"{} are excluded from REST API auditing.\", disabledRestCategories);\n+        logger.info(\"{} are excluded from Transport API auditing.\", disabledTransportCategories);", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "8445d07d4757a95e162790d280afff7edd2b8db1", "url": "https://github.com/opensearch-project/security/commit/8445d07d4757a95e162790d280afff7edd2b8db1", "message": "Refactor to use audit config", "committedDate": "2020-04-04T01:31:05Z", "type": "commit"}, {"oid": "65a7534165c71427f4853ba747eb5136ef533b07", "url": "https://github.com/opensearch-project/security/commit/65a7534165c71427f4853ba747eb5136ef533b07", "message": "Address code reviews", "committedDate": "2020-04-04T01:31:05Z", "type": "commit"}, {"oid": "44fd98532ba47d8221242f4eb7e03a567d5ea104", "url": "https://github.com/opensearch-project/security/commit/44fd98532ba47d8221242f4eb7e03a567d5ea104", "message": "Address code reviews", "committedDate": "2020-04-04T01:31:05Z", "type": "commit"}, {"oid": "b4c7bcad42812940bfe5f9f78a5da894e5e84e8b", "url": "https://github.com/opensearch-project/security/commit/b4c7bcad42812940bfe5f9f78a5da894e5e84e8b", "message": "Remove unnecessary imports", "committedDate": "2020-04-04T01:31:05Z", "type": "commit"}, {"oid": "8a83821cb3897e65df124e7503128b84fe21e565", "url": "https://github.com/opensearch-project/security/commit/8a83821cb3897e65df124e7503128b84fe21e565", "message": "Address code reviews", "committedDate": "2020-04-04T01:31:05Z", "type": "commit"}, {"oid": "bbe7c2da641319c79eb92a1104a43413c3c4a0ea", "url": "https://github.com/opensearch-project/security/commit/bbe7c2da641319c79eb92a1104a43413c3c4a0ea", "message": "Address code reviews", "committedDate": "2020-04-04T01:31:05Z", "type": "commit"}, {"oid": "8c59f64160f37b13c91e86735f789248b2a19edc", "url": "https://github.com/opensearch-project/security/commit/8c59f64160f37b13c91e86735f789248b2a19edc", "message": "Address code reviews", "committedDate": "2020-04-04T01:31:05Z", "type": "commit"}, {"oid": "8aebeb4a35f9e3c1ab9022c888e33f5a63a9f851", "url": "https://github.com/opensearch-project/security/commit/8aebeb4a35f9e3c1ab9022c888e33f5a63a9f851", "message": "Change grammar of logs", "committedDate": "2020-04-04T01:31:05Z", "type": "commit"}, {"oid": "343a56ad406831b92b6a6693f976d6bef2cf7f37", "url": "https://github.com/opensearch-project/security/commit/343a56ad406831b92b6a6693f976d6bef2cf7f37", "message": "Revert back to log", "committedDate": "2020-04-04T01:31:05Z", "type": "commit"}, {"oid": "505a2495ee2b30f18e4a68d0bef49b646ed396bd", "url": "https://github.com/opensearch-project/security/commit/505a2495ee2b30f18e4a68d0bef49b646ed396bd", "message": "Update log statement for open distro security index", "committedDate": "2020-04-04T01:31:05Z", "type": "commit"}, {"oid": "8080e0db8af98567582bb0f19cba8bc1be33c25a", "url": "https://github.com/opensearch-project/security/commit/8080e0db8af98567582bb0f19cba8bc1be33c25a", "message": "Remove opendistro index from audit log config", "committedDate": "2020-04-04T01:31:05Z", "type": "commit"}, {"oid": "779ffa856dc6717f69378cc6609d4a91846475e9", "url": "https://github.com/opensearch-project/security/commit/779ffa856dc6717f69378cc6609d4a91846475e9", "message": "Update tests", "committedDate": "2020-04-04T01:31:05Z", "type": "commit"}, {"oid": "9ccb2a49090c10944e063acc5c96840c91a4c3f4", "url": "https://github.com/opensearch-project/security/commit/9ccb2a49090c10944e063acc5c96840c91a4c3f4", "message": "move log messages", "committedDate": "2020-04-04T01:31:05Z", "type": "commit"}, {"oid": "02410371433a36a60a8ab3bcfce60ee1cf515cee", "url": "https://github.com/opensearch-project/security/commit/02410371433a36a60a8ab3bcfce60ee1cf515cee", "message": "Move audit config to inner class AuditConfig.Filter", "committedDate": "2020-04-04T01:31:05Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzQ5Njk1OQ==", "url": "https://github.com/opensearch-project/security/pull/306#discussion_r403496959", "bodyText": "opendistrosecurityIndex is not used.", "author": "vrozov", "createdAt": "2020-04-04T17:50:15Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/auditlog/config/AuditConfig.java", "diffHunk": "@@ -0,0 +1,206 @@\n+package com.amazon.opendistroforelasticsearch.security.auditlog.config;\n+\n+import com.amazon.opendistroforelasticsearch.security.auditlog.impl.AuditCategory;\n+import com.amazon.opendistroforelasticsearch.security.support.ConfigConstants;\n+import com.google.common.collect.ImmutableSet;\n+import org.apache.logging.log4j.Logger;\n+import org.elasticsearch.common.settings.Settings;\n+\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.EnumSet;\n+import java.util.List;\n+import java.util.Set;\n+\n+public class AuditConfig {\n+    public static class Filter {\n+        private static final List<String> DEFAULT_IGNORED_USERS = Collections.singletonList(\"kibanaserver\");\n+        private static final List<String> DEFAULT_DISABLED_CATEGORIES =\n+                Arrays.asList(AuditCategory.AUTHENTICATED.toString(),\n+                        AuditCategory.GRANTED_PRIVILEGES.toString());\n+\n+        private final boolean isRestApiAuditEnabled;\n+        private final boolean isTransportApiAuditEnabled;\n+        private final boolean resolveBulkRequests;\n+        private final boolean logRequestBody;\n+        private final boolean resolveIndices;\n+        private final boolean excludeSensitiveHeaders;\n+        private final Set<String> ignoredAuditUsers;\n+        private final Set<String> ignoredComplianceUsersForRead;\n+        private final Set<String> ignoredComplianceUsersForWrite;\n+        private final Set<String> ignoreAuditRequests;\n+        private final EnumSet<AuditCategory> disabledRestCategories;\n+        private final EnumSet<AuditCategory> disabledTransportCategories;\n+\n+        private Filter(final boolean isRestApiAuditEnabled,\n+                       final boolean isTransportApiAuditEnabled,\n+                       final boolean resolveBulkRequests,\n+                       final boolean logRequestBody,\n+                       final boolean resolveIndices,\n+                       final boolean excludeSensitiveHeaders,\n+                       final Set<String> ignoredAuditUsers,\n+                       final Set<String> ignoredComplianceUsersForRead,\n+                       final Set<String> ignoredComplianceUsersForWrite,\n+                       final Set<String> ignoredAuditRequests,\n+                       final EnumSet<AuditCategory> disabledRestCategories,\n+                       final EnumSet<AuditCategory> disabledTransportCategories) {\n+            this.isRestApiAuditEnabled = isRestApiAuditEnabled;\n+            this.isTransportApiAuditEnabled = isTransportApiAuditEnabled;\n+            this.resolveBulkRequests = resolveBulkRequests;\n+            this.logRequestBody = logRequestBody;\n+            this.resolveIndices = resolveIndices;\n+            this.excludeSensitiveHeaders = excludeSensitiveHeaders;\n+            this.ignoredAuditUsers = ignoredAuditUsers;\n+            this.ignoredComplianceUsersForRead = ignoredComplianceUsersForRead;\n+            this.ignoredComplianceUsersForWrite = ignoredComplianceUsersForWrite;\n+            this.ignoreAuditRequests = ignoredAuditRequests;\n+            this.disabledRestCategories = disabledRestCategories;\n+            this.disabledTransportCategories = disabledTransportCategories;\n+        }\n+\n+        public static Filter from(Settings settings) {\n+            final boolean isRestApiAuditEnabled = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_ENABLE_REST, true);\n+            final boolean isTransportAuditEnabled = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_ENABLE_TRANSPORT, true);\n+            final boolean resolveBulkRequests = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_RESOLVE_BULK_REQUESTS, false);\n+            final boolean logRequestBody = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_LOG_REQUEST_BODY, true);\n+            final boolean resolveIndices = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_RESOLVE_INDICES, true);\n+            final boolean excludeSensitiveHeaders = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_EXCLUDE_SENSITIVE_HEADERS, true);\n+            final String opendistrosecurityIndex = settings.get(ConfigConstants.OPENDISTRO_SECURITY_CONFIG_INDEX_NAME, ConfigConstants.OPENDISTRO_SECURITY_DEFAULT_CONFIG_INDEX);", "originalCommit": "02410371433a36a60a8ab3bcfce60ee1cf515cee", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "83bdfb791bb857530d27e3db0347129973f8d9ff", "url": "https://github.com/opensearch-project/security/commit/83bdfb791bb857530d27e3db0347129973f8d9ff", "message": "Remove unused opendistro security index", "committedDate": "2020-04-05T01:10:27Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE3ODQ3NQ==", "url": "https://github.com/opensearch-project/security/pull/306#discussion_r405178475", "bodyText": "[suggestion]: we might consider including Lombok as a dependency in the future as it will simplify adding constructors, setters, getters and builders. Created issue https://github.com/opendistro-for-elasticsearch/security/issues/363", "author": "debjanibnrj", "createdAt": "2020-04-07T23:48:13Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/auditlog/config/AuditConfig.java", "diffHunk": "@@ -0,0 +1,205 @@\n+package com.amazon.opendistroforelasticsearch.security.auditlog.config;\n+\n+import com.amazon.opendistroforelasticsearch.security.auditlog.impl.AuditCategory;\n+import com.amazon.opendistroforelasticsearch.security.support.ConfigConstants;\n+import com.google.common.collect.ImmutableSet;\n+import org.apache.logging.log4j.Logger;\n+import org.elasticsearch.common.settings.Settings;\n+\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.EnumSet;\n+import java.util.List;\n+import java.util.Set;\n+\n+public class AuditConfig {\n+    public static class Filter {\n+        private static final List<String> DEFAULT_IGNORED_USERS = Collections.singletonList(\"kibanaserver\");\n+        private static final List<String> DEFAULT_DISABLED_CATEGORIES =\n+                Arrays.asList(AuditCategory.AUTHENTICATED.toString(),\n+                        AuditCategory.GRANTED_PRIVILEGES.toString());\n+\n+        private final boolean isRestApiAuditEnabled;\n+        private final boolean isTransportApiAuditEnabled;\n+        private final boolean resolveBulkRequests;\n+        private final boolean logRequestBody;\n+        private final boolean resolveIndices;\n+        private final boolean excludeSensitiveHeaders;\n+        private final Set<String> ignoredAuditUsers;\n+        private final Set<String> ignoredComplianceUsersForRead;\n+        private final Set<String> ignoredComplianceUsersForWrite;\n+        private final Set<String> ignoreAuditRequests;\n+        private final EnumSet<AuditCategory> disabledRestCategories;\n+        private final EnumSet<AuditCategory> disabledTransportCategories;\n+\n+        private Filter(final boolean isRestApiAuditEnabled,", "originalCommit": "83bdfb791bb857530d27e3db0347129973f8d9ff", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE3OTUyNQ==", "url": "https://github.com/opensearch-project/security/pull/306#discussion_r405179525", "bodyText": "just curious, why does this flag default to false and the others to true?", "author": "debjanibnrj", "createdAt": "2020-04-07T23:51:36Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/auditlog/config/AuditConfig.java", "diffHunk": "@@ -0,0 +1,205 @@\n+package com.amazon.opendistroforelasticsearch.security.auditlog.config;\n+\n+import com.amazon.opendistroforelasticsearch.security.auditlog.impl.AuditCategory;\n+import com.amazon.opendistroforelasticsearch.security.support.ConfigConstants;\n+import com.google.common.collect.ImmutableSet;\n+import org.apache.logging.log4j.Logger;\n+import org.elasticsearch.common.settings.Settings;\n+\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.EnumSet;\n+import java.util.List;\n+import java.util.Set;\n+\n+public class AuditConfig {\n+    public static class Filter {\n+        private static final List<String> DEFAULT_IGNORED_USERS = Collections.singletonList(\"kibanaserver\");\n+        private static final List<String> DEFAULT_DISABLED_CATEGORIES =\n+                Arrays.asList(AuditCategory.AUTHENTICATED.toString(),\n+                        AuditCategory.GRANTED_PRIVILEGES.toString());\n+\n+        private final boolean isRestApiAuditEnabled;\n+        private final boolean isTransportApiAuditEnabled;\n+        private final boolean resolveBulkRequests;\n+        private final boolean logRequestBody;\n+        private final boolean resolveIndices;\n+        private final boolean excludeSensitiveHeaders;\n+        private final Set<String> ignoredAuditUsers;\n+        private final Set<String> ignoredComplianceUsersForRead;\n+        private final Set<String> ignoredComplianceUsersForWrite;\n+        private final Set<String> ignoreAuditRequests;\n+        private final EnumSet<AuditCategory> disabledRestCategories;\n+        private final EnumSet<AuditCategory> disabledTransportCategories;\n+\n+        private Filter(final boolean isRestApiAuditEnabled,\n+                       final boolean isTransportApiAuditEnabled,\n+                       final boolean resolveBulkRequests,\n+                       final boolean logRequestBody,\n+                       final boolean resolveIndices,\n+                       final boolean excludeSensitiveHeaders,\n+                       final Set<String> ignoredAuditUsers,\n+                       final Set<String> ignoredComplianceUsersForRead,\n+                       final Set<String> ignoredComplianceUsersForWrite,\n+                       final Set<String> ignoredAuditRequests,\n+                       final EnumSet<AuditCategory> disabledRestCategories,\n+                       final EnumSet<AuditCategory> disabledTransportCategories) {\n+            this.isRestApiAuditEnabled = isRestApiAuditEnabled;\n+            this.isTransportApiAuditEnabled = isTransportApiAuditEnabled;\n+            this.resolveBulkRequests = resolveBulkRequests;\n+            this.logRequestBody = logRequestBody;\n+            this.resolveIndices = resolveIndices;\n+            this.excludeSensitiveHeaders = excludeSensitiveHeaders;\n+            this.ignoredAuditUsers = ignoredAuditUsers;\n+            this.ignoredComplianceUsersForRead = ignoredComplianceUsersForRead;\n+            this.ignoredComplianceUsersForWrite = ignoredComplianceUsersForWrite;\n+            this.ignoreAuditRequests = ignoredAuditRequests;\n+            this.disabledRestCategories = disabledRestCategories;\n+            this.disabledTransportCategories = disabledTransportCategories;\n+        }\n+\n+        public static Filter from(Settings settings) {\n+            final boolean isRestApiAuditEnabled = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_ENABLE_REST, true);\n+            final boolean isTransportAuditEnabled = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_ENABLE_TRANSPORT, true);\n+            final boolean resolveBulkRequests = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_RESOLVE_BULK_REQUESTS, false);", "originalCommit": "83bdfb791bb857530d27e3db0347129973f8d9ff", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE4OTEwNg==", "url": "https://github.com/opensearch-project/security/pull/306#discussion_r405189106", "bodyText": "Retained the existing default.\nResolving bulk requests results in additional computation hence user must intentionally set to true.", "author": "sujithvm", "createdAt": "2020-04-08T00:23:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE3OTUyNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE4MDUzNQ==", "url": "https://github.com/opensearch-project/security/pull/306#discussion_r405180535", "bodyText": "Would be useful to provide doc comments for classes in the future.", "author": "debjanibnrj", "createdAt": "2020-04-07T23:54:47Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/auditlog/config/AuditConfig.java", "diffHunk": "@@ -0,0 +1,205 @@\n+package com.amazon.opendistroforelasticsearch.security.auditlog.config;\n+\n+import com.amazon.opendistroforelasticsearch.security.auditlog.impl.AuditCategory;\n+import com.amazon.opendistroforelasticsearch.security.support.ConfigConstants;\n+import com.google.common.collect.ImmutableSet;\n+import org.apache.logging.log4j.Logger;\n+import org.elasticsearch.common.settings.Settings;\n+\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.EnumSet;\n+import java.util.List;\n+import java.util.Set;\n+\n+public class AuditConfig {", "originalCommit": "83bdfb791bb857530d27e3db0347129973f8d9ff", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE5ODU1Nw==", "url": "https://github.com/opensearch-project/security/pull/306#discussion_r405198557", "bodyText": "Add private constructor for AuditConfig to avoid class misuse. It is a container for other classes inside AuditConfig.", "author": "vrozov", "createdAt": "2020-04-08T00:57:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE4MDUzNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE4MTA2Nw==", "url": "https://github.com/opensearch-project/security/pull/306#discussion_r405181067", "bodyText": "I see us using this function and then converting the output to a set. Any reason why we don't return a Set by default.", "author": "debjanibnrj", "createdAt": "2020-04-07T23:56:35Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/auditlog/config/AuditConfig.java", "diffHunk": "@@ -0,0 +1,205 @@\n+package com.amazon.opendistroforelasticsearch.security.auditlog.config;\n+\n+import com.amazon.opendistroforelasticsearch.security.auditlog.impl.AuditCategory;\n+import com.amazon.opendistroforelasticsearch.security.support.ConfigConstants;\n+import com.google.common.collect.ImmutableSet;\n+import org.apache.logging.log4j.Logger;\n+import org.elasticsearch.common.settings.Settings;\n+\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.EnumSet;\n+import java.util.List;\n+import java.util.Set;\n+\n+public class AuditConfig {\n+    public static class Filter {\n+        private static final List<String> DEFAULT_IGNORED_USERS = Collections.singletonList(\"kibanaserver\");\n+        private static final List<String> DEFAULT_DISABLED_CATEGORIES =\n+                Arrays.asList(AuditCategory.AUTHENTICATED.toString(),\n+                        AuditCategory.GRANTED_PRIVILEGES.toString());\n+\n+        private final boolean isRestApiAuditEnabled;\n+        private final boolean isTransportApiAuditEnabled;\n+        private final boolean resolveBulkRequests;\n+        private final boolean logRequestBody;\n+        private final boolean resolveIndices;\n+        private final boolean excludeSensitiveHeaders;\n+        private final Set<String> ignoredAuditUsers;\n+        private final Set<String> ignoredComplianceUsersForRead;\n+        private final Set<String> ignoredComplianceUsersForWrite;\n+        private final Set<String> ignoreAuditRequests;\n+        private final EnumSet<AuditCategory> disabledRestCategories;\n+        private final EnumSet<AuditCategory> disabledTransportCategories;\n+\n+        private Filter(final boolean isRestApiAuditEnabled,\n+                       final boolean isTransportApiAuditEnabled,\n+                       final boolean resolveBulkRequests,\n+                       final boolean logRequestBody,\n+                       final boolean resolveIndices,\n+                       final boolean excludeSensitiveHeaders,\n+                       final Set<String> ignoredAuditUsers,\n+                       final Set<String> ignoredComplianceUsersForRead,\n+                       final Set<String> ignoredComplianceUsersForWrite,\n+                       final Set<String> ignoredAuditRequests,\n+                       final EnumSet<AuditCategory> disabledRestCategories,\n+                       final EnumSet<AuditCategory> disabledTransportCategories) {\n+            this.isRestApiAuditEnabled = isRestApiAuditEnabled;\n+            this.isTransportApiAuditEnabled = isTransportApiAuditEnabled;\n+            this.resolveBulkRequests = resolveBulkRequests;\n+            this.logRequestBody = logRequestBody;\n+            this.resolveIndices = resolveIndices;\n+            this.excludeSensitiveHeaders = excludeSensitiveHeaders;\n+            this.ignoredAuditUsers = ignoredAuditUsers;\n+            this.ignoredComplianceUsersForRead = ignoredComplianceUsersForRead;\n+            this.ignoredComplianceUsersForWrite = ignoredComplianceUsersForWrite;\n+            this.ignoreAuditRequests = ignoredAuditRequests;\n+            this.disabledRestCategories = disabledRestCategories;\n+            this.disabledTransportCategories = disabledTransportCategories;\n+        }\n+\n+        public static Filter from(Settings settings) {\n+            final boolean isRestApiAuditEnabled = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_ENABLE_REST, true);\n+            final boolean isTransportAuditEnabled = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_ENABLE_TRANSPORT, true);\n+            final boolean resolveBulkRequests = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_RESOLVE_BULK_REQUESTS, false);\n+            final boolean logRequestBody = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_LOG_REQUEST_BODY, true);\n+            final boolean resolveIndices = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_RESOLVE_INDICES, true);\n+            final boolean excludeSensitiveHeaders = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_EXCLUDE_SENSITIVE_HEADERS, true);\n+\n+            final EnumSet<AuditCategory> disabledRestCategories = AuditCategory.parse(getSettingAsList(\n+                    settings,\n+                    ConfigConstants.OPENDISTRO_SECURITY_AUDIT_CONFIG_DISABLED_REST_CATEGORIES,\n+                    DEFAULT_DISABLED_CATEGORIES,\n+                    true));\n+\n+            final EnumSet<AuditCategory> disabledTransportCategories = AuditCategory.parse(getSettingAsList(\n+                    settings,\n+                    ConfigConstants.OPENDISTRO_SECURITY_AUDIT_CONFIG_DISABLED_TRANSPORT_CATEGORIES,\n+                    DEFAULT_DISABLED_CATEGORIES,\n+                    true));\n+\n+            final Set<String> ignoredAuditUsers = ImmutableSet.copyOf(getSettingAsList(\n+                    settings,\n+                    ConfigConstants.OPENDISTRO_SECURITY_AUDIT_IGNORE_USERS,\n+                    DEFAULT_IGNORED_USERS,\n+                    false));\n+\n+            final Set<String> ignoredComplianceUsersForRead = ImmutableSet.copyOf(getSettingAsList(\n+                    settings,\n+                    ConfigConstants.OPENDISTRO_SECURITY_COMPLIANCE_HISTORY_READ_IGNORE_USERS,\n+                    DEFAULT_IGNORED_USERS,\n+                    false));\n+\n+            final Set<String> ignoredComplianceUsersForWrite = ImmutableSet.copyOf(getSettingAsList(\n+                    settings,\n+                    ConfigConstants.OPENDISTRO_SECURITY_COMPLIANCE_HISTORY_WRITE_IGNORE_USERS,\n+                    DEFAULT_IGNORED_USERS,\n+                    false));\n+\n+            final Set<String> ignoreAuditRequests = ImmutableSet.copyOf(settings.getAsList(\n+                    ConfigConstants.OPENDISTRO_SECURITY_AUDIT_IGNORE_REQUESTS,\n+                    Collections.emptyList()));\n+\n+            return new Filter(isRestApiAuditEnabled,\n+                    isTransportAuditEnabled,\n+                    resolveBulkRequests,\n+                    logRequestBody,\n+                    resolveIndices,\n+                    excludeSensitiveHeaders,\n+                    ignoredAuditUsers,\n+                    ignoredComplianceUsersForRead,\n+                    ignoredComplianceUsersForWrite,\n+                    ignoreAuditRequests,\n+                    disabledRestCategories,\n+                    disabledTransportCategories);\n+        }\n+\n+        private static List<String> getSettingAsList(final Settings settings, final String key, final List<String> defaultList, final boolean ignoreCaseForNone) {", "originalCommit": "83bdfb791bb857530d27e3db0347129973f8d9ff", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE5Mjk2Mg==", "url": "https://github.com/opensearch-project/security/pull/306#discussion_r405192962", "bodyText": "Sounds good!", "author": "sujithvm", "createdAt": "2020-04-08T00:37:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE4MTA2Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTIwNTYwMg==", "url": "https://github.com/opensearch-project/security/pull/306#discussion_r405205602", "bodyText": "Converting the output to a set has an additional cost when it is passed to AuditCategory.parse() as it will be constructing a different set and checking for uniqueness again (not a big deal).", "author": "vrozov", "createdAt": "2020-04-08T01:24:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE4MTA2Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE4MjAxMA==", "url": "https://github.com/opensearch-project/security/pull/306#discussion_r405182010", "bodyText": "nit: maybe rename this to logger. auditConfigFilter.log(log) was a little difficult for me to understand", "author": "debjanibnrj", "createdAt": "2020-04-07T23:59:28Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/auditlog/impl/AbstractAuditLog.java", "diffHunk": "@@ -80,33 +79,16 @@\n import com.google.common.io.BaseEncoding;\n \n public abstract class AbstractAuditLog implements AuditLog {\n-\n-    private static final List<String> DEFAULT_DISABLED_CATEGORIES = Arrays.asList(AuditCategory.AUTHENTICATED.toString(), AuditCategory.GRANTED_PRIVILEGES.toString());\n-\n     protected final Logger log = LogManager.getLogger(this.getClass());", "originalCommit": "83bdfb791bb857530d27e3db0347129973f8d9ff", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE5MDM2MA==", "url": "https://github.com/opensearch-project/security/pull/306#discussion_r405190360", "bodyText": "I had renamed this to logger. @vrozov wanted it renamed back to log", "author": "sujithvm", "createdAt": "2020-04-08T00:28:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE4MjAxMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE5OTM1Nw==", "url": "https://github.com/opensearch-project/security/pull/306#discussion_r405199357", "bodyText": "@debjanibnrj It is more consistent with how Logger is named in other places and avoids unnecessary diffs.", "author": "vrozov", "createdAt": "2020-04-08T01:00:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE4MjAxMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTIwMTUxMg==", "url": "https://github.com/opensearch-project/security/pull/306#discussion_r405201512", "bodyText": "@vrozov Fair point with reducing diffs but auditConfigFilter.log(log) would be confusing to anyone especially because this is around audit \"logging\"", "author": "sujithvm", "createdAt": "2020-04-08T01:09:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE4MjAxMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTIwNzI2Ng==", "url": "https://github.com/opensearch-project/security/pull/306#discussion_r405207266", "bodyText": "IMO, it is a problem with method name, not Logger name. Rename AuditConfig.Filter.log().", "author": "vrozov", "createdAt": "2020-04-08T01:30:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE4MjAxMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTIwODM0Mw==", "url": "https://github.com/opensearch-project/security/pull/306#discussion_r405208343", "bodyText": "It is not a static function if thats what you mean.", "author": "sujithvm", "createdAt": "2020-04-08T01:35:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE4MjAxMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTIxMDMyNQ==", "url": "https://github.com/opensearch-project/security/pull/306#discussion_r405210325", "bodyText": "I mean that the minor readability problem is caused by AuditConfig.Filter class method name log(). It is not important whether it is static or not.", "author": "vrozov", "createdAt": "2020-04-08T01:43:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE4MjAxMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTIxMjYyMQ==", "url": "https://github.com/opensearch-project/security/pull/306#discussion_r405212621", "bodyText": "If you want it renamed to something specific I will rename as you had previously suggested to use log() otherwise let's leave this. I m fine with this.", "author": "sujithvm", "createdAt": "2020-04-08T01:51:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE4MjAxMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTIxNTg4NA==", "url": "https://github.com/opensearch-project/security/pull/306#discussion_r405215884", "bodyText": "I am fine the current function name or with a different function name if you want to add readability. I strongly prefer log not to be renamed to logger.", "author": "vrozov", "createdAt": "2020-04-08T02:03:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE4MjAxMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTIyNjc2Mg==", "url": "https://github.com/opensearch-project/security/pull/306#discussion_r405226762", "bodyText": "@vrozov Can you approve this PR in that case ?", "author": "sujithvm", "createdAt": "2020-04-08T02:45:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE4MjAxMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE4MzI2MA==", "url": "https://github.com/opensearch-project/security/pull/306#discussion_r405183260", "bodyText": "wildcard imports are generally considered bad practice.", "author": "debjanibnrj", "createdAt": "2020-04-08T00:03:42Z", "path": "src/test/java/com/amazon/opendistroforelasticsearch/security/auditlog/config/AuditConfigFilterTest.java", "diffHunk": "@@ -0,0 +1,126 @@\n+package com.amazon.opendistroforelasticsearch.security.auditlog.config;\n+\n+import com.amazon.opendistroforelasticsearch.security.auditlog.impl.AuditCategory;\n+import com.amazon.opendistroforelasticsearch.security.support.ConfigConstants;\n+import com.google.common.collect.ImmutableSet;\n+import org.elasticsearch.common.settings.Settings;\n+import org.junit.Test;\n+\n+import java.util.Collections;\n+import java.util.EnumSet;\n+import java.util.Set;\n+\n+import static com.amazon.opendistroforelasticsearch.security.auditlog.impl.AuditCategory.*;", "originalCommit": "83bdfb791bb857530d27e3db0347129973f8d9ff", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE5MTc3NQ==", "url": "https://github.com/opensearch-project/security/pull/306#discussion_r405191775", "bodyText": "I assumed it is generally fine to have wildcard imports for constants/values.\nRemoving this would add 10 other import lines.", "author": "sujithvm", "createdAt": "2020-04-08T00:32:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE4MzI2MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE5MjcwMQ==", "url": "https://github.com/opensearch-project/security/pull/306#discussion_r405192701", "bodyText": "Seeing as your using most audit categories for the tests this is a fair point. For import static org.junit.Assert.*; it may be better to specify the specific imports.", "author": "debjanibnrj", "createdAt": "2020-04-08T00:36:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE4MzI2MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE5NTg5Ng==", "url": "https://github.com/opensearch-project/security/pull/306#discussion_r405195896", "bodyText": "Should probably write a checkstyle rule for this", "author": "sujithvm", "createdAt": "2020-04-08T00:48:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE4MzI2MA=="}], "type": "inlineReview"}, {"oid": "442470f798c725832252b72cd41069d850cf5a20", "url": "https://github.com/opensearch-project/security/commit/442470f798c725832252b72cd41069d850cf5a20", "message": "Address code reviews", "committedDate": "2020-04-08T00:49:18Z", "type": "commit"}, {"oid": "9fee10cde967b2cf3c942abb25614e94de2972c1", "url": "https://github.com/opensearch-project/security/commit/9fee10cde967b2cf3c942abb25614e94de2972c1", "message": "More specific imports", "committedDate": "2020-04-08T01:00:54Z", "type": "commit"}, {"oid": "60cf91df686ae5833494df60776862df078fad1a", "url": "https://github.com/opensearch-project/security/commit/60cf91df686ae5833494df60776862df078fad1a", "message": "Add private constructor", "committedDate": "2020-04-08T01:24:57Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTIyODcyNg==", "url": "https://github.com/opensearch-project/security/pull/306#discussion_r405228726", "bodyText": "Consider  moving this method to AuditConfig from AuditConfig.Filter", "author": "vrozov", "createdAt": "2020-04-08T02:52:56Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/auditlog/config/AuditConfig.java", "diffHunk": "@@ -0,0 +1,268 @@\n+package com.amazon.opendistroforelasticsearch.security.auditlog.config;\n+\n+import com.amazon.opendistroforelasticsearch.security.auditlog.impl.AuditCategory;\n+import com.amazon.opendistroforelasticsearch.security.support.ConfigConstants;\n+import com.google.common.collect.ImmutableSet;\n+import org.apache.logging.log4j.Logger;\n+import org.elasticsearch.common.settings.Settings;\n+\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.EnumSet;\n+import java.util.List;\n+import java.util.Set;\n+\n+/**\n+ * Class represents configuration for audit logging.\n+ */\n+public class AuditConfig {\n+\n+    private AuditConfig() { }\n+\n+    /**\n+     * Filter represents set of filtering configuration settings for audit logging.\n+     * Audit logger will use these settings to determine what audit logs are to be generated.\n+     */\n+    public static class Filter {\n+        private static final List<String> DEFAULT_IGNORED_USERS = Collections.singletonList(\"kibanaserver\");\n+        private static final List<String> DEFAULT_DISABLED_CATEGORIES =\n+                Arrays.asList(AuditCategory.AUTHENTICATED.toString(),\n+                        AuditCategory.GRANTED_PRIVILEGES.toString());\n+\n+        private final boolean isRestApiAuditEnabled;\n+        private final boolean isTransportApiAuditEnabled;\n+        private final boolean resolveBulkRequests;\n+        private final boolean logRequestBody;\n+        private final boolean resolveIndices;\n+        private final boolean excludeSensitiveHeaders;\n+        private final Set<String> ignoredAuditUsers;\n+        private final Set<String> ignoredComplianceUsersForRead;\n+        private final Set<String> ignoredComplianceUsersForWrite;\n+        private final Set<String> ignoreAuditRequests;\n+        private final EnumSet<AuditCategory> disabledRestCategories;\n+        private final EnumSet<AuditCategory> disabledTransportCategories;\n+\n+        private Filter(final boolean isRestApiAuditEnabled,\n+                       final boolean isTransportApiAuditEnabled,\n+                       final boolean resolveBulkRequests,\n+                       final boolean logRequestBody,\n+                       final boolean resolveIndices,\n+                       final boolean excludeSensitiveHeaders,\n+                       final Set<String> ignoredAuditUsers,\n+                       final Set<String> ignoredComplianceUsersForRead,\n+                       final Set<String> ignoredComplianceUsersForWrite,\n+                       final Set<String> ignoredAuditRequests,\n+                       final EnumSet<AuditCategory> disabledRestCategories,\n+                       final EnumSet<AuditCategory> disabledTransportCategories) {\n+            this.isRestApiAuditEnabled = isRestApiAuditEnabled;\n+            this.isTransportApiAuditEnabled = isTransportApiAuditEnabled;\n+            this.resolveBulkRequests = resolveBulkRequests;\n+            this.logRequestBody = logRequestBody;\n+            this.resolveIndices = resolveIndices;\n+            this.excludeSensitiveHeaders = excludeSensitiveHeaders;\n+            this.ignoredAuditUsers = ignoredAuditUsers;\n+            this.ignoredComplianceUsersForRead = ignoredComplianceUsersForRead;\n+            this.ignoredComplianceUsersForWrite = ignoredComplianceUsersForWrite;\n+            this.ignoreAuditRequests = ignoredAuditRequests;\n+            this.disabledRestCategories = disabledRestCategories;\n+            this.disabledTransportCategories = disabledTransportCategories;\n+        }\n+\n+        /**\n+         * Generate audit logging configuration from settings defined in elasticsearch.yml\n+         * @param settings settings\n+         * @return audit configuration filter\n+         */\n+        public static Filter from(Settings settings) {\n+            final boolean isRestApiAuditEnabled = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_ENABLE_REST, true);\n+            final boolean isTransportAuditEnabled = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_ENABLE_TRANSPORT, true);\n+            final boolean resolveBulkRequests = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_RESOLVE_BULK_REQUESTS, false);\n+            final boolean logRequestBody = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_LOG_REQUEST_BODY, true);\n+            final boolean resolveIndices = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_RESOLVE_INDICES, true);\n+            final boolean excludeSensitiveHeaders = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_EXCLUDE_SENSITIVE_HEADERS, true);\n+\n+            final EnumSet<AuditCategory> disabledRestCategories = AuditCategory.parse(getSettingAsSet(\n+                    settings,\n+                    ConfigConstants.OPENDISTRO_SECURITY_AUDIT_CONFIG_DISABLED_REST_CATEGORIES,\n+                    DEFAULT_DISABLED_CATEGORIES,\n+                    true));\n+\n+            final EnumSet<AuditCategory> disabledTransportCategories = AuditCategory.parse(getSettingAsSet(\n+                    settings,\n+                    ConfigConstants.OPENDISTRO_SECURITY_AUDIT_CONFIG_DISABLED_TRANSPORT_CATEGORIES,\n+                    DEFAULT_DISABLED_CATEGORIES,\n+                    true));\n+\n+            final Set<String> ignoredAuditUsers = getSettingAsSet(\n+                    settings,\n+                    ConfigConstants.OPENDISTRO_SECURITY_AUDIT_IGNORE_USERS,\n+                    DEFAULT_IGNORED_USERS,\n+                    false);\n+\n+            final Set<String> ignoredComplianceUsersForRead = getSettingAsSet(\n+                    settings,\n+                    ConfigConstants.OPENDISTRO_SECURITY_COMPLIANCE_HISTORY_READ_IGNORE_USERS,\n+                    DEFAULT_IGNORED_USERS,\n+                    false);\n+\n+            final Set<String> ignoredComplianceUsersForWrite = getSettingAsSet(\n+                    settings,\n+                    ConfigConstants.OPENDISTRO_SECURITY_COMPLIANCE_HISTORY_WRITE_IGNORE_USERS,\n+                    DEFAULT_IGNORED_USERS,\n+                    false);\n+\n+            final Set<String> ignoreAuditRequests = ImmutableSet.copyOf(settings.getAsList(\n+                    ConfigConstants.OPENDISTRO_SECURITY_AUDIT_IGNORE_REQUESTS,\n+                    Collections.emptyList()));\n+\n+            return new Filter(isRestApiAuditEnabled,\n+                    isTransportAuditEnabled,\n+                    resolveBulkRequests,\n+                    logRequestBody,\n+                    resolveIndices,\n+                    excludeSensitiveHeaders,\n+                    ignoredAuditUsers,\n+                    ignoredComplianceUsersForRead,\n+                    ignoredComplianceUsersForWrite,\n+                    ignoreAuditRequests,\n+                    disabledRestCategories,\n+                    disabledTransportCategories);\n+        }\n+\n+        private static Set<String> getSettingAsSet(final Settings settings, final String key, final List<String> defaultList, final boolean ignoreCaseForNone) {", "originalCommit": "60cf91df686ae5833494df60776862df078fad1a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTIzNDc3Mg==", "url": "https://github.com/opensearch-project/security/pull/306#discussion_r405234772", "bodyText": "Will move it when needed as this has more restricted scope as NONE handling is not used everywhere as theres plans to deprecate it.", "author": "sujithvm", "createdAt": "2020-04-08T03:17:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTIyODcyNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTIzMTI5MA==", "url": "https://github.com/opensearch-project/security/pull/306#discussion_r405231290", "bodyText": "In case conversion to Set is done inside this function, it is better to add isEmpty() check here. I am not 100% convinced that it is necessary to convert to Set from List here as it is not always necessary and in the future there may be different requirements for case-sensitivity of the returned Set.", "author": "vrozov", "createdAt": "2020-04-08T03:03:12Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/auditlog/config/AuditConfig.java", "diffHunk": "@@ -0,0 +1,268 @@\n+package com.amazon.opendistroforelasticsearch.security.auditlog.config;\n+\n+import com.amazon.opendistroforelasticsearch.security.auditlog.impl.AuditCategory;\n+import com.amazon.opendistroforelasticsearch.security.support.ConfigConstants;\n+import com.google.common.collect.ImmutableSet;\n+import org.apache.logging.log4j.Logger;\n+import org.elasticsearch.common.settings.Settings;\n+\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.EnumSet;\n+import java.util.List;\n+import java.util.Set;\n+\n+/**\n+ * Class represents configuration for audit logging.\n+ */\n+public class AuditConfig {\n+\n+    private AuditConfig() { }\n+\n+    /**\n+     * Filter represents set of filtering configuration settings for audit logging.\n+     * Audit logger will use these settings to determine what audit logs are to be generated.\n+     */\n+    public static class Filter {\n+        private static final List<String> DEFAULT_IGNORED_USERS = Collections.singletonList(\"kibanaserver\");\n+        private static final List<String> DEFAULT_DISABLED_CATEGORIES =\n+                Arrays.asList(AuditCategory.AUTHENTICATED.toString(),\n+                        AuditCategory.GRANTED_PRIVILEGES.toString());\n+\n+        private final boolean isRestApiAuditEnabled;\n+        private final boolean isTransportApiAuditEnabled;\n+        private final boolean resolveBulkRequests;\n+        private final boolean logRequestBody;\n+        private final boolean resolveIndices;\n+        private final boolean excludeSensitiveHeaders;\n+        private final Set<String> ignoredAuditUsers;\n+        private final Set<String> ignoredComplianceUsersForRead;\n+        private final Set<String> ignoredComplianceUsersForWrite;\n+        private final Set<String> ignoreAuditRequests;\n+        private final EnumSet<AuditCategory> disabledRestCategories;\n+        private final EnumSet<AuditCategory> disabledTransportCategories;\n+\n+        private Filter(final boolean isRestApiAuditEnabled,\n+                       final boolean isTransportApiAuditEnabled,\n+                       final boolean resolveBulkRequests,\n+                       final boolean logRequestBody,\n+                       final boolean resolveIndices,\n+                       final boolean excludeSensitiveHeaders,\n+                       final Set<String> ignoredAuditUsers,\n+                       final Set<String> ignoredComplianceUsersForRead,\n+                       final Set<String> ignoredComplianceUsersForWrite,\n+                       final Set<String> ignoredAuditRequests,\n+                       final EnumSet<AuditCategory> disabledRestCategories,\n+                       final EnumSet<AuditCategory> disabledTransportCategories) {\n+            this.isRestApiAuditEnabled = isRestApiAuditEnabled;\n+            this.isTransportApiAuditEnabled = isTransportApiAuditEnabled;\n+            this.resolveBulkRequests = resolveBulkRequests;\n+            this.logRequestBody = logRequestBody;\n+            this.resolveIndices = resolveIndices;\n+            this.excludeSensitiveHeaders = excludeSensitiveHeaders;\n+            this.ignoredAuditUsers = ignoredAuditUsers;\n+            this.ignoredComplianceUsersForRead = ignoredComplianceUsersForRead;\n+            this.ignoredComplianceUsersForWrite = ignoredComplianceUsersForWrite;\n+            this.ignoreAuditRequests = ignoredAuditRequests;\n+            this.disabledRestCategories = disabledRestCategories;\n+            this.disabledTransportCategories = disabledTransportCategories;\n+        }\n+\n+        /**\n+         * Generate audit logging configuration from settings defined in elasticsearch.yml\n+         * @param settings settings\n+         * @return audit configuration filter\n+         */\n+        public static Filter from(Settings settings) {\n+            final boolean isRestApiAuditEnabled = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_ENABLE_REST, true);\n+            final boolean isTransportAuditEnabled = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_ENABLE_TRANSPORT, true);\n+            final boolean resolveBulkRequests = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_RESOLVE_BULK_REQUESTS, false);\n+            final boolean logRequestBody = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_LOG_REQUEST_BODY, true);\n+            final boolean resolveIndices = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_RESOLVE_INDICES, true);\n+            final boolean excludeSensitiveHeaders = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_EXCLUDE_SENSITIVE_HEADERS, true);\n+\n+            final EnumSet<AuditCategory> disabledRestCategories = AuditCategory.parse(getSettingAsSet(\n+                    settings,\n+                    ConfigConstants.OPENDISTRO_SECURITY_AUDIT_CONFIG_DISABLED_REST_CATEGORIES,\n+                    DEFAULT_DISABLED_CATEGORIES,\n+                    true));\n+\n+            final EnumSet<AuditCategory> disabledTransportCategories = AuditCategory.parse(getSettingAsSet(\n+                    settings,\n+                    ConfigConstants.OPENDISTRO_SECURITY_AUDIT_CONFIG_DISABLED_TRANSPORT_CATEGORIES,\n+                    DEFAULT_DISABLED_CATEGORIES,\n+                    true));\n+\n+            final Set<String> ignoredAuditUsers = getSettingAsSet(\n+                    settings,\n+                    ConfigConstants.OPENDISTRO_SECURITY_AUDIT_IGNORE_USERS,\n+                    DEFAULT_IGNORED_USERS,\n+                    false);\n+\n+            final Set<String> ignoredComplianceUsersForRead = getSettingAsSet(\n+                    settings,\n+                    ConfigConstants.OPENDISTRO_SECURITY_COMPLIANCE_HISTORY_READ_IGNORE_USERS,\n+                    DEFAULT_IGNORED_USERS,\n+                    false);\n+\n+            final Set<String> ignoredComplianceUsersForWrite = getSettingAsSet(\n+                    settings,\n+                    ConfigConstants.OPENDISTRO_SECURITY_COMPLIANCE_HISTORY_WRITE_IGNORE_USERS,\n+                    DEFAULT_IGNORED_USERS,\n+                    false);\n+\n+            final Set<String> ignoreAuditRequests = ImmutableSet.copyOf(settings.getAsList(\n+                    ConfigConstants.OPENDISTRO_SECURITY_AUDIT_IGNORE_REQUESTS,\n+                    Collections.emptyList()));\n+\n+            return new Filter(isRestApiAuditEnabled,\n+                    isTransportAuditEnabled,\n+                    resolveBulkRequests,\n+                    logRequestBody,\n+                    resolveIndices,\n+                    excludeSensitiveHeaders,\n+                    ignoredAuditUsers,\n+                    ignoredComplianceUsersForRead,\n+                    ignoredComplianceUsersForWrite,\n+                    ignoreAuditRequests,\n+                    disabledRestCategories,\n+                    disabledTransportCategories);\n+        }\n+\n+        private static Set<String> getSettingAsSet(final Settings settings, final String key, final List<String> defaultList, final boolean ignoreCaseForNone) {\n+            final List<String> list = settings.getAsList(key, defaultList);\n+            if (list.size() == 1 && \"NONE\".equals(ignoreCaseForNone? list.get(0).toUpperCase() : list.get(0))) {", "originalCommit": "60cf91df686ae5833494df60776862df078fad1a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTIzNDg0NQ==", "url": "https://github.com/opensearch-project/security/pull/306#discussion_r405234845", "bodyText": "Will change it when needed in the future.", "author": "sujithvm", "createdAt": "2020-04-08T03:17:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTIzMTI5MA=="}], "type": "inlineReview"}]}