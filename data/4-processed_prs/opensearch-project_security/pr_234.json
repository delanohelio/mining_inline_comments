{"pr_number": 234, "pr_title": "Fix to use inner channel when channel is not direct or transport type", "pr_createdAt": "2020-02-17T22:06:16Z", "pr_url": "https://github.com/opensearch-project/security/pull/234", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDM4MDM4NQ==", "url": "https://github.com/opensearch-project/security/pull/234#discussion_r380380385", "bodyText": "I am not sure if we should change channel to innerChannel here.", "author": "sujithvm", "createdAt": "2020-02-17T22:06:57Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/transport/OpenDistroSecurityRequestHandler.java", "diffHunk": "@@ -126,16 +126,9 @@ protected void messageReceivedDecorate(final T request, final TransportRequestHa\n \n             String channelType = transportChannel.getChannelType();\n \n-            if(!channelType.equals(\"direct\") && !channelType.equals(\"transport\")) {\n-                Class wrappedChannelCls = transportChannel.getClass();\n-\n-                try {\n-                    Method getInnerChannel = wrappedChannelCls.getMethod(\"getInnerChannel\", null);\n-                    TransportChannel innerChannel = (TransportChannel)(getInnerChannel.invoke(transportChannel));\n-                    channelType = innerChannel.getChannelType();\n-                } catch (NoSuchMethodException ex) {\n-                    throw new RuntimeException(\"Unknown channel type \" + channelType + \" does not implement getInnerChannel method.\");\n-                }\n+            if (!channelType.equals(\"direct\") && !channelType.equals(\"transport\")) {\n+                TransportChannel innerChannel = getInnerChannel(transportChannel);\n+                channelType = innerChannel.getChannelType();", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDQwNzIzOA==", "url": "https://github.com/opensearch-project/security/pull/234#discussion_r380407238", "bodyText": "Afaik its fine to change channel to innerChannel here.\nIn our previous PR's we override the channelType value instead of the channel value but the idea behind the two seem to be the same - https://github.com/opendistro-for-elasticsearch/security-ssl/pull/2/files; https://github.com/opendistro-for-elasticsearch/security/pull/3/files.", "author": "debjanibnrj", "createdAt": "2020-02-18T00:35:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDM4MDM4NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDM4MDUxNA==", "url": "https://github.com/opensearch-project/security/pull/234#discussion_r380380514", "bodyText": "Also wondering if this check should come after the following if (!\"transport\".equals(channel.getChannelType())) check", "author": "sujithvm", "createdAt": "2020-02-17T22:07:37Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/ssl/transport/OpenDistroSecuritySSLRequestHandler.java", "diffHunk": "@@ -81,6 +82,11 @@ public final void messageReceived(T request, TransportChannel channel, Task task\n             channel.sendResponse(exception);\n             throw exception;\n         }\n+\n+        String channelType = channel.getChannelType();\n+        if (!channelType.equals(\"direct\") && !channelType.equals(\"transport\")) {\n+            channel = getInnerChannel(channel);", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDM5MTQyOA==", "url": "https://github.com/opensearch-project/security/pull/234#discussion_r380391428", "bodyText": "Please include comments about why this check needs to be there.", "author": "debjanibnrj", "createdAt": "2020-02-17T22:58:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDM4MDUxNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDM5MzIyNQ==", "url": "https://github.com/opensearch-project/security/pull/234#discussion_r380393225", "bodyText": "Sure. Will add comments. Can you verify the logic ?", "author": "sujithvm", "createdAt": "2020-02-17T23:07:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDM4MDUxNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDM5NzYzOQ==", "url": "https://github.com/opensearch-project/security/pull/234#discussion_r380397639", "bodyText": "Logic seems fine for PA. As an extra measure we can verify that the returned channel from getInnerChannel is of channelType transport.", "author": "debjanibnrj", "createdAt": "2020-02-17T23:32:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDM4MDUxNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDM5ODE1NA==", "url": "https://github.com/opensearch-project/security/pull/234#discussion_r380398154", "bodyText": "throw a runtime error if its not basic and transport ?", "author": "sujithvm", "createdAt": "2020-02-17T23:36:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDM4MDUxNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDM5ODY5NQ==", "url": "https://github.com/opensearch-project/security/pull/234#discussion_r380398695", "bodyText": "I think so, esp since we're expecting the Wrapper classes getInnerChannel to return a transport channel.", "author": "debjanibnrj", "createdAt": "2020-02-17T23:40:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDM4MDUxNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDQwMDgzOA==", "url": "https://github.com/opensearch-project/security/pull/234#discussion_r380400838", "bodyText": "We are getting a transport channel but the issue is with the channelType, custom implementations may pass", "author": "sujithvm", "createdAt": "2020-02-17T23:54:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDM4MDUxNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDM5MTU3Ng==", "url": "https://github.com/opensearch-project/security/pull/234#discussion_r380391576", "bodyText": "Wasn't this originally - (!\"netty\".equals(channel.getChannelType()) && !\"direct\".equals(channel.getChannelType())) based on https://github.com/opendistro-for-elasticsearch/security-ssl/pull/2/files.\nWhy are we checking for !channelType.equals(\"transport\")?", "author": "debjanibnrj", "createdAt": "2020-02-17T22:58:47Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/ssl/transport/OpenDistroSecuritySSLRequestHandler.java", "diffHunk": "@@ -81,6 +82,11 @@ public final void messageReceived(T request, TransportChannel channel, Task task\n             channel.sendResponse(exception);\n             throw exception;\n         }\n+\n+        String channelType = channel.getChannelType();\n+        if (!channelType.equals(\"direct\") && !channelType.equals(\"transport\")) {", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDM5MTgyNQ==", "url": "https://github.com/opensearch-project/security/pull/234#discussion_r380391825", "bodyText": "Maybe its changed from elastic side elastic/elasticsearch#40074", "author": "sujithvm", "createdAt": "2020-02-17T23:00:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDM5MTU3Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDM5ODAxMw==", "url": "https://github.com/opensearch-project/security/pull/234#discussion_r380398013", "bodyText": "Thanks for clarifying", "author": "debjanibnrj", "createdAt": "2020-02-17T23:35:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDM5MTU3Ng=="}], "type": "inlineReview"}, {"oid": "bb0eff9a4a657c1711cbf83e2301a20f8e97db54", "url": "https://github.com/opensearch-project/security/commit/bb0eff9a4a657c1711cbf83e2301a20f8e97db54", "message": "Fix to use inner channel when channel is not direct or transport type", "committedDate": "2020-02-18T23:02:57Z", "type": "commit"}]}