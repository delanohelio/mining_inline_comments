{"pr_number": 586, "pr_title": "Removing hidden/reserved roles added via rolesmapping", "pr_createdAt": "2020-07-26T17:50:09Z", "pr_url": "https://github.com/opensearch-project/security/pull/586", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTAxNjE3Ng==", "url": "https://github.com/opensearch-project/security/pull/586#discussion_r461016176", "bodyText": "Is this supposed to be True or False ?", "author": "dinusX", "createdAt": "2020-07-27T16:29:51Z", "path": "src/test/java/com/amazon/opendistroforelasticsearch/security/OpendistroSecurityRolesTests.java", "diffHunk": "@@ -79,11 +80,15 @@ public void testOpenDistroSecurityRoles() throws Exception {\n \t\tAssert.assertTrue(resc.getBody().contains(\"sr_user\"));\n \t\tAssert.assertTrue(resc.getBody().contains(\"xyz_sr\"));\n \n-\t\t// Ensure hidden reserved and non-existent roles are not available\n+\t\t// Opendistro_security_roles cannot contain roles that don't exist.\n \t\tAssert.assertFalse(resc.getBody().contains(\"xyz_sr_non_existent\"));\n-\t\tAssert.assertFalse(resc.getBody().contains(\"xyz_sr_hidden\"));\n+\n+\t\t// Opendistro_security_roles can contain reserved roles.\n \t\tAssert.assertTrue(resc.getBody().contains(\"xyz_sr_reserved\"));\n \n+\t\t// Opendistro_security_roles cannot contain roles that are hidden in rolesmapping.yml.\n+\t\tAssert.assertTrue(resc.getBody().contains(\"xyz_sr_hidden\"));\n+", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTA0MTc4OQ==", "url": "https://github.com/opensearch-project/security/pull/586#discussion_r461041789", "bodyText": "False, good catch. Was an error in the test + test config. I have fixed this.", "author": "debjanibnrj", "createdAt": "2020-07-27T17:11:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTAxNjE3Ng=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTA1MDE5Ng==", "url": "https://github.com/opensearch-project/security/pull/586#discussion_r461050196", "bodyText": "nit: use exists? same as original code?", "author": "sujithvm", "createdAt": "2020-07-27T17:25:22Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/dlic/rest/api/InternalUsersApiAction.java", "diffHunk": "@@ -115,18 +115,24 @@ protected void handlePut(RestChannel channel, final RestRequest request, final C\n         final ObjectNode contentAsNode = (ObjectNode) content;\n         final SecurityJsonNode securityJsonNode = new SecurityJsonNode(contentAsNode);\n \n-        // Don't allow user to add hidden, reserved or non-existent role\n+        // Don't allow user to add hidden, reserved or non-existent rolesmapping\n         final List<String> opendistroSecurityRoles = securityJsonNode.get(\"opendistro_security_roles\").asList();\n         if (opendistroSecurityRoles != null) {\n             final SecurityDynamicConfiguration<?> rolesConfiguration = load(CType.ROLES, false);\n+            final SecurityDynamicConfiguration<?> rolesmappingConfiguration = load(CType.ROLESMAPPING, false);\n             for (final String role: opendistroSecurityRoles) {\n \n-                if (!rolesConfiguration.exists(role) || rolesConfiguration.isHidden(role)) {\n+                if (rolesConfiguration.getCEntry(role) == null) {", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTA2MjUyMA==", "url": "https://github.com/opensearch-project/security/pull/586#discussion_r461062520", "bodyText": "We can add the roles check here itself having the same definition as \"isHiddenOrNonExistent\" ?", "author": "sujithvm", "createdAt": "2020-07-27T17:46:52Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/securityconf/DynamicConfigFactory.java", "diffHunk": "@@ -300,23 +307,23 @@ public String getHash(String user) {\n         public List<String> getOpenDistroSecurityRoles(String user) {\n             InternalUserV7 tmp = internalUserV7SecurityDynamicConfiguration.getCEntry(user);\n \n-            // Filtering out hidden and non-existent roles for existing users\n+            // Opendistro security roles should only contain roles that exist in the roles dynamic config.\n+            // We should filter out any roles that have hidden rolesmapping.\n             return tmp == null ? ImmutableList.of() :\n-                tmp.getOpendistro_security_roles().stream().filter(role -> !isHiddenOrNonExistent(role)).collect(ImmutableList.toImmutableList());\n+                tmp.getOpendistro_security_roles().stream().filter(role -> !isRolesMappingHidden(role) && rolesV7SecurityDynamicConfiguration.exists(role)).collect(ImmutableList.toImmutableList());\n         }\n \n-        // We will remove opendistro security mapping for roles that are hidden or non-existent in the roles configuration\n-        private boolean isHiddenOrNonExistent(String rolename) {\n-            final RoleV7 role = roleV7SecurityDynamicConfiguration.getCEntry(rolename);\n-            return role == null || role.isHidden();\n+        // Remove any hidden rolesmapping from the opendistro security roles\n+        private boolean isRolesMappingHidden(String rolename) {\n+            final RoleMappingsV7 roleMapping = rolesMappingsV7SecurityDynamicConfiguration.getCEntry(rolename);\n+            return roleMapping!=null && roleMapping.isHidden();", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "6c1f002b25d77f2636c86b419dc4be7a00f889fe", "url": "https://github.com/opensearch-project/security/commit/6c1f002b25d77f2636c86b419dc4be7a00f889fe", "message": "Removing hidden/reserved roles added via rolesmapping\n\nEarlier the InternalUsers API was filtering out all hidden/reserved roles. We will just restrict it to hidden/reserved roles associated via rolesmapping. This will ensure behaviour of rolesmapping and internalusers API is the same.", "committedDate": "2020-07-27T18:24:47Z", "type": "commit"}, {"oid": "6c1f002b25d77f2636c86b419dc4be7a00f889fe", "url": "https://github.com/opensearch-project/security/commit/6c1f002b25d77f2636c86b419dc4be7a00f889fe", "message": "Removing hidden/reserved roles added via rolesmapping\n\nEarlier the InternalUsers API was filtering out all hidden/reserved roles. We will just restrict it to hidden/reserved roles associated via rolesmapping. This will ensure behaviour of rolesmapping and internalusers API is the same.", "committedDate": "2020-07-27T18:24:47Z", "type": "forcePushed"}]}