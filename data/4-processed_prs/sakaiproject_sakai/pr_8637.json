{"pr_number": 8637, "pr_title": "SAK-44379 Move file conversion service to session factory", "pr_createdAt": "2020-09-30T13:32:05Z", "pr_url": "https://github.com/sakaiproject/sakai/pull/8637", "timeline": [{"oid": "a04079bbb8b9845572461b9c570d003fc0e399ee", "url": "https://github.com/sakaiproject/sakai/commit/a04079bbb8b9845572461b9c570d003fc0e399ee", "message": "SAK-44379 Move file conversion service to session factory\n\nhttps://jira.sakaiproject.org/browse/SAK-44379", "committedDate": "2020-09-30T15:27:08Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODUxNjIwOQ==", "url": "https://github.com/sakaiproject/sakai/pull/8637#discussion_r498516209", "bodyText": "You can do straight up sql using hibernate no need to bring in sqlservice", "author": "ern", "createdAt": "2020-10-01T21:13:17Z", "path": "kernel/kernel-impl/src/main/java/org/sakaiproject/content/impl/FileConversionServiceImpl.java", "diffHunk": "@@ -28,39 +28,47 @@\n import java.util.concurrent.ScheduledExecutorService;\n import java.util.concurrent.TimeUnit;\n \n+import org.hibernate.Session;\n+import org.hibernate.SessionFactory;\n+import org.hibernate.criterion.Restrictions;\n+\n import org.sakaiproject.authz.api.SecurityAdvisor;\n import org.sakaiproject.authz.api.SecurityService;\n import org.sakaiproject.component.api.ServerConfigurationService;\n import org.sakaiproject.content.api.ContentHostingService;\n import org.sakaiproject.content.api.ContentResource;\n import org.sakaiproject.content.api.FileConversionService;\n-import org.sakaiproject.content.api.repository.FileConversionQueueItemRepository;\n import org.sakaiproject.content.hbm.FileConversionQueueItem;\n import org.sakaiproject.content.impl.converters.LoolFileConverter;\n+import org.sakaiproject.db.api.SqlService;\n import org.sakaiproject.entity.api.ResourceProperties;\n import org.sakaiproject.entity.api.ResourcePropertiesEdit;\n import org.sakaiproject.exception.IdUnusedException;\n import org.sakaiproject.exception.PermissionException;\n-import org.springframework.transaction.TransactionStatus;\n-import org.springframework.transaction.annotation.Transactional;\n-import org.springframework.transaction.support.TransactionCallbackWithoutResult;\n-import org.springframework.transaction.support.TransactionTemplate;\n \n import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.transaction.annotation.Transactional;\n+import org.springframework.transaction.support.TransactionTemplate;\n \n import lombok.Setter;\n import lombok.extern.slf4j.Slf4j;\n \n+import javax.annotation.Resource;\n+\n @Slf4j\n @Setter\n public class FileConversionServiceImpl implements FileConversionService {\n \n     @Autowired private ContentHostingService contentHostingService;\n-    @Autowired private FileConversionQueueItemRepository repository;\n     @Autowired private SecurityService securityService;\n     @Autowired private ServerConfigurationService serverConfigurationService;\n+    @Autowired private SqlService sqlService;", "originalCommit": "a04079bbb8b9845572461b9c570d003fc0e399ee", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTY0NDAzNA==", "url": "https://github.com/sakaiproject/sakai/pull/8637#discussion_r499644034", "bodyText": "I used sql service as I didn't want to load the entity before updating it with a simple update. Can you do that? Also, there's very little testing you can do with this. The main thing that needs testing is the actual libre office integration, ie: load testing. It seemed real overkill to create a Dao just for these simple calls when there'd be little to no yield in unit testing.\nThe entity is not in the persistence context of the sessions created by the worker threads. You have to load it every time. Or, if you want to use the persisted entity, you do the entire libreoffice call inside a transaction, effectively making the db useless as a mutex, which this code is currently using it for.", "author": "adrianfish", "createdAt": "2020-10-05T14:32:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODUxNjIwOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODc0Nzc5NA==", "url": "https://github.com/sakaiproject/sakai/pull/8637#discussion_r508747794", "bodyText": "You can evict an Entity after making changes.", "author": "ern", "createdAt": "2020-10-20T18:29:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODUxNjIwOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjgxNTMxMg==", "url": "https://github.com/sakaiproject/sakai/pull/8637#discussion_r516815312", "bodyText": "Changes made. All hibernate now. I still think it seems overkill to add a dao interface and impl, though. You can't even test this meaningfully without bringing up a docker container with libre in it.", "author": "adrianfish", "createdAt": "2020-11-03T16:54:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODUxNjIwOQ=="}], "type": "inlineReview"}, {"oid": "ba2cd4d98511c8a5fea9dc68be445345a91ad5f4", "url": "https://github.com/sakaiproject/sakai/commit/ba2cd4d98511c8a5fea9dc68be445345a91ad5f4", "message": "SAK-44379 Move file conversion service to session factory\n\nhttps://jira.sakaiproject.org/browse/SAK-44379", "committedDate": "2020-10-23T13:37:57Z", "type": "forcePushed"}, {"oid": "ebca36e2474c409c8bc754fed7e8673d1c9df58d", "url": "https://github.com/sakaiproject/sakai/commit/ebca36e2474c409c8bc754fed7e8673d1c9df58d", "message": "SAK-44379 Move file conversion service to session factory\n\nhttps://jira.sakaiproject.org/browse/SAK-44379", "committedDate": "2020-10-23T14:35:22Z", "type": "forcePushed"}, {"oid": "c03ef437699220be39865ff74167243c50eb362a", "url": "https://github.com/sakaiproject/sakai/commit/c03ef437699220be39865ff74167243c50eb362a", "message": "SAK-44379 Move file conversion service to session factory\n\nhttps://jira.sakaiproject.org/browse/SAK-44379", "committedDate": "2020-12-02T16:50:43Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTQxNzY0OQ==", "url": "https://github.com/sakaiproject/sakai/pull/8637#discussion_r535417649", "bodyText": "You don't need to manage the session as that is performed by Spring TX Manager", "author": "ern", "createdAt": "2020-12-03T17:03:57Z", "path": "kernel/kernel-impl/src/main/java/org/sakaiproject/content/impl/persistence/FileConversionServiceRepositoryImpl.java", "diffHunk": "@@ -0,0 +1,56 @@\n+package org.sakaiproject.content.impl.persistence;\n+\n+import org.hibernate.Session;\n+import org.hibernate.SessionFactory;\n+import org.hibernate.TransientObjectException;\n+import org.hibernate.criterion.Restrictions;\n+\n+import java.util.List;\n+import javax.annotation.Resource;\n+\n+import org.springframework.transaction.annotation.Transactional;\n+\n+import org.sakaiproject.content.api.persistence.FileConversionQueueItem;\n+import org.sakaiproject.content.api.persistence.FileConversionServiceRepository;\n+\n+import lombok.Setter;\n+\n+public class FileConversionServiceRepositoryImpl implements FileConversionServiceRepository {\n+\n+    @Resource(name = \"org.sakaiproject.springframework.orm.hibernate.GlobalSessionFactory\")\n+    @Setter\n+    private SessionFactory sessionFactory;\n+\n+    @Transactional\n+    public List<FileConversionQueueItem> findByStatus(FileConversionQueueItem.Status status) {\n+\n+        Session session = sessionFactory.getCurrentSession();\n+        List<FileConversionQueueItem> items\n+            = session.createCriteria(FileConversionQueueItem.class)\n+                .add(Restrictions.eq(\"status\", status)).list();\n+        session.close();", "originalCommit": "c03ef437699220be39865ff74167243c50eb362a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTQxODE5OQ==", "url": "https://github.com/sakaiproject/sakai/pull/8637#discussion_r535418199", "bodyText": "same here no need to manage the session", "author": "ern", "createdAt": "2020-12-03T17:04:29Z", "path": "kernel/kernel-impl/src/main/java/org/sakaiproject/content/impl/persistence/FileConversionServiceRepositoryImpl.java", "diffHunk": "@@ -0,0 +1,56 @@\n+package org.sakaiproject.content.impl.persistence;\n+\n+import org.hibernate.Session;\n+import org.hibernate.SessionFactory;\n+import org.hibernate.TransientObjectException;\n+import org.hibernate.criterion.Restrictions;\n+\n+import java.util.List;\n+import javax.annotation.Resource;\n+\n+import org.springframework.transaction.annotation.Transactional;\n+\n+import org.sakaiproject.content.api.persistence.FileConversionQueueItem;\n+import org.sakaiproject.content.api.persistence.FileConversionServiceRepository;\n+\n+import lombok.Setter;\n+\n+public class FileConversionServiceRepositoryImpl implements FileConversionServiceRepository {\n+\n+    @Resource(name = \"org.sakaiproject.springframework.orm.hibernate.GlobalSessionFactory\")\n+    @Setter\n+    private SessionFactory sessionFactory;\n+\n+    @Transactional\n+    public List<FileConversionQueueItem> findByStatus(FileConversionQueueItem.Status status) {\n+\n+        Session session = sessionFactory.getCurrentSession();\n+        List<FileConversionQueueItem> items\n+            = session.createCriteria(FileConversionQueueItem.class)\n+                .add(Restrictions.eq(\"status\", status)).list();\n+        session.close();\n+        return items;\n+    }\n+\n+    @Transactional\n+    public FileConversionQueueItem save(FileConversionQueueItem item) {\n+\n+        Session session = sessionFactory.getCurrentSession();\n+        FileConversionQueueItem mergedItem = null;\n+        try {\n+            mergedItem = (FileConversionQueueItem) session.merge(item);\n+        } catch (TransientObjectException toe) {\n+            session.persist(item);\n+            mergedItem = item;\n+        }\n+        session.flush();", "originalCommit": "c03ef437699220be39865ff74167243c50eb362a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTQyMDM2Nw==", "url": "https://github.com/sakaiproject/sakai/pull/8637#discussion_r535420367", "bodyText": "I think this should be repository it's how it's done in other places", "author": "ern", "createdAt": "2020-12-03T17:06:36Z", "path": "kernel/kernel-impl/src/main/java/org/sakaiproject/content/impl/FileConversionServiceImpl.java", "diffHunk": "@@ -34,32 +34,30 @@\n import org.sakaiproject.content.api.ContentHostingService;\n import org.sakaiproject.content.api.ContentResource;\n import org.sakaiproject.content.api.FileConversionService;\n-import org.sakaiproject.content.api.repository.FileConversionQueueItemRepository;\n-import org.sakaiproject.content.hbm.FileConversionQueueItem;\n+import org.sakaiproject.content.api.persistence.FileConversionQueueItem;\n+import org.sakaiproject.content.api.persistence.FileConversionServiceRepository;\n import org.sakaiproject.content.impl.converters.LoolFileConverter;\n import org.sakaiproject.entity.api.ResourceProperties;\n import org.sakaiproject.entity.api.ResourcePropertiesEdit;\n import org.sakaiproject.exception.IdUnusedException;\n import org.sakaiproject.exception.PermissionException;\n-import org.springframework.transaction.TransactionStatus;\n-import org.springframework.transaction.annotation.Transactional;\n-import org.springframework.transaction.support.TransactionCallbackWithoutResult;\n-import org.springframework.transaction.support.TransactionTemplate;\n \n import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.transaction.annotation.Transactional;\n \n import lombok.Setter;\n import lombok.extern.slf4j.Slf4j;\n \n+import javax.annotation.Resource;\n+\n @Slf4j\n @Setter\n public class FileConversionServiceImpl implements FileConversionService {\n \n     @Autowired private ContentHostingService contentHostingService;\n-    @Autowired private FileConversionQueueItemRepository repository;", "originalCommit": "c03ef437699220be39865ff74167243c50eb362a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "2258379fa7babade7298df72c12a97054b0e2096", "url": "https://github.com/sakaiproject/sakai/commit/2258379fa7babade7298df72c12a97054b0e2096", "message": "SAK-44379 Move file conversion service to session factory\n\nhttps://jira.sakaiproject.org/browse/SAK-44379", "committedDate": "2020-12-04T16:26:50Z", "type": "forcePushed"}, {"oid": "fca054ad3d12ef6c63effc43a9bc030f162360de", "url": "https://github.com/sakaiproject/sakai/commit/fca054ad3d12ef6c63effc43a9bc030f162360de", "message": "SAK-44379 Move file conversion service to session factory\n\nhttps://jira.sakaiproject.org/browse/SAK-44379", "committedDate": "2020-12-04T17:16:15Z", "type": "commit"}, {"oid": "fca054ad3d12ef6c63effc43a9bc030f162360de", "url": "https://github.com/sakaiproject/sakai/commit/fca054ad3d12ef6c63effc43a9bc030f162360de", "message": "SAK-44379 Move file conversion service to session factory\n\nhttps://jira.sakaiproject.org/browse/SAK-44379", "committedDate": "2020-12-04T17:16:15Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDU3MTIyNw==", "url": "https://github.com/sakaiproject/sakai/pull/8637#discussion_r540571227", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    session.close();", "author": "ern", "createdAt": "2020-12-10T23:16:23Z", "path": "kernel/kernel-impl/src/main/java/org/sakaiproject/content/impl/persistence/FileConversionServiceRepositoryImpl.java", "diffHunk": "@@ -0,0 +1,26 @@\n+package org.sakaiproject.content.impl.persistence;\n+\n+import org.hibernate.Session;\n+import org.hibernate.criterion.Restrictions;\n+\n+import java.util.List;\n+\n+import org.springframework.transaction.annotation.Transactional;\n+\n+import org.sakaiproject.content.api.persistence.FileConversionQueueItem;\n+import org.sakaiproject.content.api.persistence.FileConversionServiceRepository;\n+import org.sakaiproject.springframework.data.SpringCrudRepositoryImpl;\n+\n+public class FileConversionServiceRepositoryImpl extends SpringCrudRepositoryImpl<FileConversionQueueItem, Long>  implements FileConversionServiceRepository {\n+\n+    @Transactional\n+    public List<FileConversionQueueItem> findByStatus(FileConversionQueueItem.Status status) {\n+\n+        Session session = sessionFactory.getCurrentSession();\n+        List<FileConversionQueueItem> items\n+            = session.createCriteria(FileConversionQueueItem.class)\n+                .add(Restrictions.eq(\"status\", status)).list();\n+        session.close();", "originalCommit": "fca054ad3d12ef6c63effc43a9bc030f162360de", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "4fb3d42a6c3c1f34df0ab6d4ac1056533978d6df", "url": "https://github.com/sakaiproject/sakai/commit/4fb3d42a6c3c1f34df0ab6d4ac1056533978d6df", "message": "remove session.close()", "committedDate": "2020-12-10T23:16:41Z", "type": "commit"}]}