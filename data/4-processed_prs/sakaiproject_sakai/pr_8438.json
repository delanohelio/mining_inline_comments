{"pr_number": 8438, "pr_title": "SAK-44071: Update Presence correctly by clearing timer and update active tabs", "pr_createdAt": "2020-08-06T13:32:43Z", "pr_url": "https://github.com/sakaiproject/sakai/pull/8438", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODQxNTA5MQ==", "url": "https://github.com/sakaiproject/sakai/pull/8438#discussion_r468415091", "bodyText": "I'd just make hidden a boolean. You don't use that string in any console output, so there's no point overcomplicating it. Actually, forget that. I'd just use document.hidden. It's supported in all the browsers we're interested in. Sakai won't work in IE < 10, anyway. I'd just remove your hidden var and use document.hidden.", "author": "adrianfish", "createdAt": "2020-08-11T08:31:41Z", "path": "library/src/morpheus-master/js/src/sakai.morpheus.update.presence.js", "diffHunk": "@@ -1,4 +1,49 @@\n-function updatePresence(){\n+var active_tab_listener_attached = false; // initial load\n+\n+// Set the name of the hidden property and the change event for visibility\n+var hidden, visibilityChange;\n+if (typeof document.hidden !== \"undefined\") { // Opera 12.10 and Firefox 18 and later support \n+    hidden = \"hidden\";", "originalCommit": "2fe378b2af7364f126e8f80bb07872eece04c81e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTI0NDY2OA==", "url": "https://github.com/sakaiproject/sakai/pull/8438#discussion_r469244668", "bodyText": "I'm going to remove the variable declaration - it's not used (should have seen that ;p) and it works without it.\nBrowser support for the Page Visibility API is currently good.\nIE - 10+\nFirefox - 10+\nChrome - 14+\nSafari - 6.1+\nOpera - 12.1+", "author": "TurRil", "createdAt": "2020-08-12T13:06:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODQxNTA5MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTI0NjAwNw==", "url": "https://github.com/sakaiproject/sakai/pull/8438#discussion_r469246007", "bodyText": "Awesome browser support. Great.", "author": "ottenhoff", "createdAt": "2020-08-12T13:08:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODQxNTA5MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODQyNDkyMQ==", "url": "https://github.com/sakaiproject/sakai/pull/8438#discussion_r468424921", "bodyText": "I think you should be using your variable  \"visibilityChange\" from earlier. Although perhaps \"visibiitychange\" just works on all the modern browsers now. Anyway, you should use that variable you created.", "author": "adrianfish", "createdAt": "2020-08-11T08:48:20Z", "path": "library/src/morpheus-master/js/src/sakai.morpheus.update.presence.js", "diffHunk": "@@ -1,4 +1,49 @@\n-function updatePresence(){\n+var active_tab_listener_attached = false; // initial load\n+\n+// Set the name of the hidden property and the change event for visibility\n+var hidden, visibilityChange;\n+if (typeof document.hidden !== \"undefined\") { // Opera 12.10 and Firefox 18 and later support \n+    hidden = \"hidden\";\n+    visibilityChange = \"visibilitychange\";\n+} else if (typeof document.msHidden !== \"undefined\") {\n+    hidden = \"msHidden\";\n+    visibilityChange = \"msvisibilitychange\";\n+} else if (typeof document.webkitHidden !== \"undefined\") {\n+    hidden = \"webkitHidden\";\n+    visibilityChange = \"webkitvisibilitychange\";\n+}\n+\n+function updatePresenceTimeout(_ms, _go) {\n+    if (window.sakaiLastPresenceTimeOut != null) {\n+        clearTimeout(window.sakaiLastPresenceTimeOut);\n+        window.sakaiLastPresenceTimeOut = null;\n+    }\n+    if (_go) {\n+        window.sakaiLastPresenceTimeOut = setTimeout('updatePresence()', _ms);\n+    }\n+}\n+\n+// Triggers when visibility changes\n+function handleVisibilityChange() {\n+    if (document.hidden) {\n+        console.log(\"hidden\");\n+        updatePresenceTimeout(window.sakaiPresenceTimeDelay, false); //stop\n+    } else  {\n+        console.log(\"visible\");\n+        updatePresenceTimeout(window.sakaiPresenceTimeDelay, false); \n+        updatePresence(); //start immediately\n+    }\n+}\n+\n+function updatePresence() {\n+  if (!active_tab_listener_attached) {\n+    document.addEventListener(\"visibilitychange\", handleVisibilityChange, false);", "originalCommit": "2fe378b2af7364f126e8f80bb07872eece04c81e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTI0NDYxMA==", "url": "https://github.com/sakaiproject/sakai/pull/8438#discussion_r469244610", "bodyText": "Yes, can pretty much remove the variable declaration and run it as is.", "author": "TurRil", "createdAt": "2020-08-12T13:06:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODQyNDkyMQ=="}], "type": "inlineReview"}, {"oid": "2bd6156973117d530711f0e2e6e70933dae9e310", "url": "https://github.com/sakaiproject/sakai/commit/2bd6156973117d530711f0e2e6e70933dae9e310", "message": "SAK-44071: Update Presence correctly by clearing timer and update when browser tab is active.", "committedDate": "2020-08-12T07:40:55Z", "type": "commit"}, {"oid": "c4e438ed4a460c16192668972b7e17e98eccdca0", "url": "https://github.com/sakaiproject/sakai/commit/c4e438ed4a460c16192668972b7e17e98eccdca0", "message": "SAK-44071: Updates to improve JS according to Codacy/PR Quality Review.", "committedDate": "2020-08-12T07:40:56Z", "type": "commit"}, {"oid": "fdf8593880138274af342012a75cd4d634203ea8", "url": "https://github.com/sakaiproject/sakai/commit/fdf8593880138274af342012a75cd4d634203ea8", "message": "SAK-44071: define document.addEventListener early as empty function and redefine after all functions are declared.", "committedDate": "2020-08-12T07:40:57Z", "type": "commit"}, {"oid": "fdf8593880138274af342012a75cd4d634203ea8", "url": "https://github.com/sakaiproject/sakai/commit/fdf8593880138274af342012a75cd4d634203ea8", "message": "SAK-44071: define document.addEventListener early as empty function and redefine after all functions are declared.", "committedDate": "2020-08-12T07:40:57Z", "type": "forcePushed"}, {"oid": "787f86e84f24cc008f3084ccac6551697812cde9", "url": "https://github.com/sakaiproject/sakai/commit/787f86e84f24cc008f3084ccac6551697812cde9", "message": "SAK-44071: Updated code after review - removed variable declarations that where not used.", "committedDate": "2020-08-12T13:07:55Z", "type": "commit"}]}