{"pr_number": 8221, "pr_title": "SAK-43649: SWITCH: Permissions widget: Stay in page after Undo Changes", "pr_createdAt": "2020-05-13T16:56:31Z", "pr_url": "https://github.com/sakaiproject/sakai/pull/8221", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTA1MzY4OQ==", "url": "https://github.com/sakaiproject/sakai/pull/8221#discussion_r425053689", "bodyText": "I'd move this code into your resetPermissions function body. You do this by waiting on the updateComplete promise.\nthis.updateComplete.then(() => {\nlet inputs = this.renderRoot.querySelectorAll(\"input[type='checkbox']\");\ninputs.forEach(elem => {\nlet role = elem.getAttribute('data-role');\nlet perm = elem.getAttribute('data-perm');\n  if (role && perm) {\n    elem.checked = this.on[role].includes(perm);\n  }\n})\n\n});\n... you get the idea. That way the  render has finished and you can manipulate the checks.", "author": "adrianfish", "createdAt": "2020-05-14T11:05:05Z", "path": "webcomponents/tool/src/main/frontend/js/sakai-permissions.js", "diffHunk": "@@ -65,6 +65,16 @@ class SakaiPermissions extends SakaiElement {\n   get tool() { return this._tool; }\n \n   updated(changedProperties) {\n+    let inputs = this.renderRoot.querySelectorAll(\"input[type='checkbox']\");\n+    inputs.forEach(elem => { \n+      let role = elem.getAttribute('data-role');\n+      let perm = elem.getAttribute('data-perm');\n+      \n+      if(role && perm){\n+        elem.checked = this.on[role].includes(perm);\n+      }\n+    })", "originalCommit": "df5a0852f073f5b726dee7e3088b2ac869c0608b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTIwNjMzMA==", "url": "https://github.com/sakaiproject/sakai/pull/8221#discussion_r425206330", "bodyText": "Nice! I like the idea. So, no need to reload or re-render. Sorry but, I'm still learning about webcomponents and litelement.\nI think I've set all the blank lines and spaces as you like. Anyway, if anything else is needed, just say it.\nThanks for your help.", "author": "frasese", "createdAt": "2020-05-14T15:01:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTA1MzY4OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTIyNTcxMw==", "url": "https://github.com/sakaiproject/sakai/pull/8221#discussion_r425225713", "bodyText": "The dispatchEvent part is to reset the table cell style arround the checkbox.\nWe also can do this calling this.attachHandlers() or just:\n$('.permissions-table input:checkbox').change();\nBut I don't like the idea to mix vanilla javascript with jquery (at least inside the same fragment/method)", "author": "frasese", "createdAt": "2020-05-14T15:27:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTA1MzY4OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTA1NTI3Nw==", "url": "https://github.com/sakaiproject/sakai/pull/8221#discussion_r425055277", "bodyText": "blank line here please, it makes js easier to read, imo, if you leave a blank line at the start of any multi line function body, even lambdas.", "author": "adrianfish", "createdAt": "2020-05-14T11:08:13Z", "path": "webcomponents/tool/src/main/frontend/js/sakai-permissions.js", "diffHunk": "@@ -65,6 +65,16 @@ class SakaiPermissions extends SakaiElement {\n   get tool() { return this._tool; }\n \n   updated(changedProperties) {\n+    let inputs = this.renderRoot.querySelectorAll(\"input[type='checkbox']\");\n+    inputs.forEach(elem => { \n+      let role = elem.getAttribute('data-role');", "originalCommit": "df5a0852f073f5b726dee7e3088b2ac869c0608b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTA1NTMyOQ==", "url": "https://github.com/sakaiproject/sakai/pull/8221#discussion_r425055329", "bodyText": "Please leave a space between between if and the brace. Same for the curly brace on the end.\nif (role && perm) {\nI am very fussy about these tiny things ... :) I also like a blank line after the function definition if the body has more than one line of code in it. I am fussy, ask Miguel!", "author": "adrianfish", "createdAt": "2020-05-14T11:08:17Z", "path": "webcomponents/tool/src/main/frontend/js/sakai-permissions.js", "diffHunk": "@@ -65,6 +65,16 @@ class SakaiPermissions extends SakaiElement {\n   get tool() { return this._tool; }\n \n   updated(changedProperties) {\n+    let inputs = this.renderRoot.querySelectorAll(\"input[type='checkbox']\");\n+    inputs.forEach(elem => { \n+      let role = elem.getAttribute('data-role');\n+      let perm = elem.getAttribute('data-perm');\n+      \n+      if(role && perm){", "originalCommit": "df5a0852f073f5b726dee7e3088b2ac869c0608b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "6600f8b0fd06ddbc954f426e7d174f181d26bb54", "url": "https://github.com/sakaiproject/sakai/commit/6600f8b0fd06ddbc954f426e7d174f181d26bb54", "message": "SAK-43649: SWITCH: Permissions widget: Stay in page after Undo Changes", "committedDate": "2020-05-14T14:52:11Z", "type": "forcePushed"}, {"oid": "510116b9074a8275bd0e00efe2af2322170b672e", "url": "https://github.com/sakaiproject/sakai/commit/510116b9074a8275bd0e00efe2af2322170b672e", "message": "SAK-43649: SWITCH: Permissions widget: Stay in page after Undo Changes", "committedDate": "2020-05-14T14:56:35Z", "type": "forcePushed"}, {"oid": "f9d0d5766af6c35ac80377997304988f0dd93af1", "url": "https://github.com/sakaiproject/sakai/commit/f9d0d5766af6c35ac80377997304988f0dd93af1", "message": "SAK-43649: SWITCH: Permissions widget: Stay in page after Undo Changes", "committedDate": "2020-05-14T15:19:50Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTIzNzQ1MA==", "url": "https://github.com/sakaiproject/sakai/pull/8221#discussion_r425237450", "bodyText": "You don't need a blank like on if blocks, just function bodies. Sorry for not being clear :(\nI know I am being a bit pedantic here - I just think this approach makes the js more readable later. Adding blanks before every block would be a bit too much whitespace though. So, a compromise.", "author": "adrianfish", "createdAt": "2020-05-14T15:42:39Z", "path": "webcomponents/tool/src/main/frontend/js/sakai-permissions.js", "diffHunk": "@@ -172,6 +172,31 @@ class SakaiPermissions extends SakaiElement {\n   }\n \n   resetPermissions() {\n+\n+    this.updateComplete.then(() => {\n+\n+      let inputs = this.renderRoot.querySelectorAll(\"input[type='checkbox']\");\n+      inputs.forEach(elem => {\n+\n+          let role = elem.getAttribute('data-role');\n+          let perm = elem.getAttribute('data-perm');\n+          if (role && perm) {\n+\n+            elem.checked = this.on[role].includes(perm);", "originalCommit": "f9d0d5766af6c35ac80377997304988f0dd93af1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTI1NDcwOQ==", "url": "https://github.com/sakaiproject/sakai/pull/8221#discussion_r425254709", "bodyText": "Can't you just use \"new Event(\"change\", { bubbles: true })\" for these lines? Maybe you don't even need to bubble it.\nhttps://developer.mozilla.org/en-US/docs/Web/Guide/Events/Creating_and_triggering_events", "author": "adrianfish", "createdAt": "2020-05-14T16:06:09Z", "path": "webcomponents/tool/src/main/frontend/js/sakai-permissions.js", "diffHunk": "@@ -172,6 +172,31 @@ class SakaiPermissions extends SakaiElement {\n   }\n \n   resetPermissions() {\n+\n+    this.updateComplete.then(() => {\n+\n+      let inputs = this.renderRoot.querySelectorAll(\"input[type='checkbox']\");\n+      inputs.forEach(elem => {\n+\n+          let role = elem.getAttribute('data-role');\n+          let perm = elem.getAttribute('data-perm');\n+          if (role && perm) {\n+\n+            elem.checked = this.on[role].includes(perm);\n+            if (\"createEvent\" in document) {\n+\n+                let evt = document.createEvent(\"HTMLEvents\");\n+                evt.initEvent(\"change\", false, true);", "originalCommit": "f9d0d5766af6c35ac80377997304988f0dd93af1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTI4Mzc3Mw==", "url": "https://github.com/sakaiproject/sakai/pull/8221#discussion_r425283773", "bodyText": "Yes. You are right. I'm still attached to the old ways...", "author": "frasese", "createdAt": "2020-05-14T16:47:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTI1NDcwOQ=="}], "type": "inlineReview"}, {"oid": "906873df9f046e2852d07808dd072c0df2322188", "url": "https://github.com/sakaiproject/sakai/commit/906873df9f046e2852d07808dd072c0df2322188", "message": "SAK-43649: SWITCH: Permissions widget: Stay in page after Undo Changes", "committedDate": "2020-05-14T16:23:39Z", "type": "forcePushed"}, {"oid": "60483a0fe993ec45432d1a504fbdd61b5a17a34a", "url": "https://github.com/sakaiproject/sakai/commit/60483a0fe993ec45432d1a504fbdd61b5a17a34a", "message": "SAK-43649: SWITCH: Permissions widget: Stay in page after Undo Changes", "committedDate": "2020-05-14T16:33:54Z", "type": "forcePushed"}, {"oid": "812b40835892170819159869371ad42b1c861a22", "url": "https://github.com/sakaiproject/sakai/commit/812b40835892170819159869371ad42b1c861a22", "message": "SAK-43649: SWITCH: Permissions widget: Stay in page after Undo Changes", "committedDate": "2020-05-14T16:43:45Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTMzODY2NQ==", "url": "https://github.com/sakaiproject/sakai/pull/8221#discussion_r425338665", "bodyText": "I'd get rid of this test. Only really old crappy browsers don't have this. Up to you though.", "author": "adrianfish", "createdAt": "2020-05-14T18:14:29Z", "path": "webcomponents/tool/src/main/frontend/js/sakai-permissions.js", "diffHunk": "@@ -172,6 +172,30 @@ class SakaiPermissions extends SakaiElement {\n   }\n \n   resetPermissions() {\n+\n+    this.updateComplete.then(() => {\n+\n+      let inputs = this.renderRoot.querySelectorAll(\"input[type='checkbox']\");\n+      inputs.forEach(elem => {\n+\n+          let role = elem.getAttribute('data-role');\n+          let perm = elem.getAttribute('data-perm');\n+          if (role && perm) {\n+            let elemChanged = (elem.checked != this.on[role].includes(perm));\n+            elem.checked = this.on[role].includes(perm);\n+            if (elemChanged) {\n+              if (elem.dispatchEvent) {\n+                  elem.dispatchEvent(new Event(\"change\"));", "originalCommit": "812b40835892170819159869371ad42b1c861a22", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "08d25c8b65f99aff2cc7845e4beb3bf763925581", "url": "https://github.com/sakaiproject/sakai/commit/08d25c8b65f99aff2cc7845e4beb3bf763925581", "message": "SAK-43649: SWITCH: Permissions widget: Stay in page after Undo Changes", "committedDate": "2020-05-14T20:17:49Z", "type": "commit"}, {"oid": "08d25c8b65f99aff2cc7845e4beb3bf763925581", "url": "https://github.com/sakaiproject/sakai/commit/08d25c8b65f99aff2cc7845e4beb3bf763925581", "message": "SAK-43649: SWITCH: Permissions widget: Stay in page after Undo Changes", "committedDate": "2020-05-14T20:17:49Z", "type": "forcePushed"}]}