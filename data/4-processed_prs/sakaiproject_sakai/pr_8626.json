{"pr_number": 8626, "pr_title": "SAK-44324: SAMIGO - Calculated Questions: Some functions don't work (mXparser)", "pr_createdAt": "2020-09-28T09:36:12Z", "pr_url": "https://github.com/sakaiproject/sakai/pull/8626", "timeline": [{"oid": "6cb5b58a49f788f6de733fbcb7c794530e9268df", "url": "https://github.com/sakaiproject/sakai/commit/6cb5b58a49f788f6de733fbcb7c794530e9268df", "message": "SAK-44324: SAMIGO - Calculated Questions: Some functions don't work (mXparser)", "committedDate": "2020-09-28T09:34:50Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjQzMDkyNA==", "url": "https://github.com/sakaiproject/sakai/pull/8626#discussion_r496430924", "bodyText": "@ottenhoff Added spanish translations", "author": "jesusmmp", "createdAt": "2020-09-29T05:43:30Z", "path": "samigo/samigo-app/src/java/org/sakaiproject/tool/assessment/bundle/AuthorMessages_es.properties", "diffHunk": "@@ -120,11 +120,11 @@ calc_question_answer_variance=Puede definir la tolerancia aceptable como una con\n calc_question_answer_decimal=Variables y f\\u00f3rmulas soportan cifras decimales. Por defecto ser\\u00e1n 3.\n calc_question_example1=Kevin tiene {x} manzanas. \\u00c9l compra {y} m\\u00e1s. Ahora Kevin tiene [[{x}+{y}]]. Jane come {z} manzanas. Kevin tiene ahora {{w}} manzanas.\n calc_question_example1_formula=La f\\u00f3rmula w en el ejemplo anterior se definir\\u00eda como\\: {x} + {y} - {z}\n-calc_question_functions=Puede usar las siguientes funciones matem\\u00e1ticas\\: SIN, COS, TAN, ASIN, ACOS, ATAN, ABS, EXP, SGN, SQRT, LOG10, y LN.\n-calc_question_example2=Resolver\\: COS({a}) * ({c} - {b}) \\= {{z}}.\n-calc_question_example2_formula=La f\\u00f3rmula z en el ejemplo anterior se definir\\u00eda como\\: COS({a}) * ({c} - {b})\n+calc_question_functions=Puede usar las siguientes funciones matem\\u00e1ticas\\: sin, cos, tan, asin, acos, atan, abs, exp, sgn, sqrt, log10 y ln.\n+calc_question_example2=Resolver\\: cos({a}) * ({c} - {b}) \\= {{z}}.\n+calc_question_example2_formula=La f\\u00f3rmula z en el ejemplo anterior se definir\\u00eda como\\: cos({a}) * ({c} - {b})\n calc_question_example3=El \\u00e1rea del cuadrado es [[ {s} * {s} ]]m. Encuentra la longitud del lado {{Z}}. La f\\u00f3rmula Z ser\\u00eda {s}.\n-calc_question_constants=Hay dos constantes integradas, PI(3.14...) y e(2.718...). Pueden ser utilizadas en sus expresiones de f\\u00f3rmula.\n+calc_question_constants=Hay constantes integradas: pi(3.14...), e(2.718...), [phi](1.618...), etc. Pueden ser utilizadas en sus expresiones de f\\u00f3rmula.", "originalCommit": "6cb5b58a49f788f6de733fbcb7c794530e9268df", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjQzMTE4Nw==", "url": "https://github.com/sakaiproject/sakai/pull/8626#discussion_r496431187", "bodyText": "@ottenhoff Added unescape to make work functions that contains <, and >", "author": "jesusmmp", "createdAt": "2020-09-29T05:44:24Z", "path": "samigo/samigo-app/src/java/org/sakaiproject/tool/assessment/ui/listener/author/CalculatedQuestionExtractListener.java", "diffHunk": "@@ -460,7 +462,7 @@ private Long getMaxSequenceValue(Map<String, CalculatedQuestionVariableBean> var\n \n             // evaluate each calculation\n             for (CalculatedQuestionCalculationBean cqcb : calculatedQuestionBean.getCalculationsList()) {\n-                String formulaStr = GradingService.cleanFormula(cqcb.getText());\n+                String formulaStr = StringEscapeUtils.unescapeHtml4(GradingService.cleanFormula(cqcb.getText()));", "originalCommit": "6cb5b58a49f788f6de733fbcb7c794530e9268df", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjQzMTM0OQ==", "url": "https://github.com/sakaiproject/sakai/pull/8626#discussion_r496431349", "bodyText": "@ottenhoff Added a new test that contains >", "author": "jesusmmp", "createdAt": "2020-09-29T05:44:59Z", "path": "samigo/samigo-services/src/test/org/sakaiproject/tool/assessment/services/GradingServiceTest.java", "diffHunk": "@@ -431,7 +449,41 @@ public void testCalculationsToValues() throws SamigoExpressionError {\n         Assert.assertEquals(\"1E11\", result);                 \n         result = gradingService.processFormulaIntoValue(\"1000000000000.00\", 2);\n         Assert.assertNotNull(result);\n-        Assert.assertEquals(\"1E12\", result);                 \n+        Assert.assertEquals(\"1E12\", result);\n+\n+        // mixed-case functions\n+        result = gradingService.processFormulaIntoValue(\"qNor(0.5, 2, 1)\", 2);\n+        Assert.assertNotNull(result);\n+        Assert.assertEquals(\"2\", result);\n+        result = gradingService.processFormulaIntoValue(\"cNor(0.7, 3, 1)\", 2);\n+        Assert.assertNotNull(result);\n+        Assert.assertEquals(\"0.01\", result);\n+        // test lowercasing\n+        result = gradingService.processFormulaIntoValue(\"pi + E\", 2);\n+        Assert.assertNotNull(result);\n+        Assert.assertEquals(\"5.86\", result);\n+        // speed of light\n+        result = gradingService.processFormulaIntoValue(\"[c]*3\", 2);\n+        Assert.assertNotNull(result);\n+        Assert.assertEquals(\"899377374\", result);\n+        // golden ratio\n+        result = gradingService.processFormulaIntoValue(\"3*[phi]\", 2);\n+        Assert.assertNotNull(result);\n+        Assert.assertEquals(\"4.85\", result);\n+        // binomial coefficient\n+        result = gradingService.processFormulaIntoValue(\"C(8,3)\", 2);\n+        Assert.assertNotNull(result);\n+        Assert.assertEquals(\"56\", result);\n+        result = gradingService.processFormulaIntoValue(\"if(1>3, 5, 2)\", 2);\n+        Assert.assertNotNull(result);\n+        Assert.assertEquals(\"2\", result);", "originalCommit": "6cb5b58a49f788f6de733fbcb7c794530e9268df", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "b7bde26d54520dbb0794f1ce21eb69f1845aa159", "url": "https://github.com/sakaiproject/sakai/commit/b7bde26d54520dbb0794f1ce21eb69f1845aa159", "message": "SAK-44324: SAMIGO - Calculated Questions: Some functions don't work (mXparser)", "committedDate": "2020-10-08T06:30:25Z", "type": "commit"}]}