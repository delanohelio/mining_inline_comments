{"pr_number": 17898, "pr_title": "Compress metric units defensively", "pr_createdAt": "2020-11-25T17:41:24Z", "pr_url": "https://github.com/hazelcast/hazelcast/pull/17898", "timeline": [{"oid": "eb0e73c8d7696c3f362d3d585e54e306fb0f6e07", "url": "https://github.com/hazelcast/hazelcast/commit/eb0e73c8d7696c3f362d3d585e54e306fb0f6e07", "message": "Compress metric unites defensively\n\nThe units of the metrics are directly derived from the ProbeUnit enum\nand the MetricCompressor takes the ordinal when creating the blob. On\nthe consumer side this ordinal is taken and a lookup is made with the\nordinal potentially leading to IndexOutOfBoundsException if the ordinal\nis higher than the size of the array holding the possible values of the\nunits. This can be the case every time we add a new unit to the\nProbeUnit enum, which the MetricCompressor is not aware of.\n\nTo prevent potential issues, we make the unit compression and extraction\nmore defensive. We change the compression to convert the marked units to\na tag with name \"metric-unit\" and set the unit to null. With this the\nmetric can still be processed by MC and the consumers using an metric\nextractor and retain the information about the unit. The extractor is\nmade more defensive by adding a bound check to prevent the\nIndexOutOfBoundsException in the mentioned case.", "committedDate": "2020-12-07T12:00:14Z", "type": "commit"}, {"oid": "eb0e73c8d7696c3f362d3d585e54e306fb0f6e07", "url": "https://github.com/hazelcast/hazelcast/commit/eb0e73c8d7696c3f362d3d585e54e306fb0f6e07", "message": "Compress metric unites defensively\n\nThe units of the metrics are directly derived from the ProbeUnit enum\nand the MetricCompressor takes the ordinal when creating the blob. On\nthe consumer side this ordinal is taken and a lookup is made with the\nordinal potentially leading to IndexOutOfBoundsException if the ordinal\nis higher than the size of the array holding the possible values of the\nunits. This can be the case every time we add a new unit to the\nProbeUnit enum, which the MetricCompressor is not aware of.\n\nTo prevent potential issues, we make the unit compression and extraction\nmore defensive. We change the compression to convert the marked units to\na tag with name \"metric-unit\" and set the unit to null. With this the\nmetric can still be processed by MC and the consumers using an metric\nextractor and retain the information about the unit. The extractor is\nmade more defensive by adding a bound check to prevent the\nIndexOutOfBoundsException in the mentioned case.", "committedDate": "2020-12-07T12:00:14Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzUxOTQ4MQ==", "url": "https://github.com/hazelcast/hazelcast/pull/17898#discussion_r537519481", "bodyText": "Can we safely delete the argument in 4.3? That's probably a question on MC forward-compatibility with IMDG.", "author": "puzpuzpuz", "createdAt": "2020-12-07T13:49:33Z", "path": "hazelcast/src/main/java/com/hazelcast/internal/metrics/ProbeUnit.java", "diffHunk": "@@ -36,4 +34,26 @@\n     BOOLEAN,\n     /** 0..n, ordinal of an enum */\n     ENUM,\n+    /** Timestamp or duration represented in \u00b5s */\n+    // RU_COMPAT_4_2\n+    // remove constructor argument in 4.3", "originalCommit": "eb0e73c8d7696c3f362d3d585e54e306fb0f6e07", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzUzMzQ0Ng==", "url": "https://github.com/hazelcast/hazelcast/pull/17898#discussion_r537533446", "bodyText": "I think if MC handles the units as @emre commented, we can delete the argument safely.", "author": "blazember", "createdAt": "2020-12-07T14:08:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzUxOTQ4MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzUzNjc3Nw==", "url": "https://github.com/hazelcast/hazelcast/pull/17898#discussion_r537536777", "bodyText": "I considered the same question and I think yes. We will upgrade MC to latest minor release when it comes out.", "author": "emre-aydin", "createdAt": "2020-12-07T14:12:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzUxOTQ4MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzU0NDI5Mg==", "url": "https://github.com/hazelcast/hazelcast/pull/17898#discussion_r537544292", "bodyText": "Thanks for the clarification guys!", "author": "puzpuzpuz", "createdAt": "2020-12-07T14:22:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzUxOTQ4MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzUyNDIxNA==", "url": "https://github.com/hazelcast/hazelcast/pull/17898#discussion_r537524214", "bodyText": "nit: I'd also add a note to the enum javadoc. The text could be Note. The order of enum ordinals is important for compatibility purposes with potential metrics consumers. Do not delete existing value and always add new ones to the end of the list. or smth like that.", "author": "puzpuzpuz", "createdAt": "2020-12-07T13:56:17Z", "path": "hazelcast/src/main/java/com/hazelcast/internal/metrics/ProbeUnit.java", "diffHunk": "@@ -36,4 +34,26 @@\n     BOOLEAN,\n     /** 0..n, ordinal of an enum */\n     ENUM,\n+    /** Timestamp or duration represented in \u00b5s */\n+    // RU_COMPAT_4_2\n+    // remove constructor argument in 4.3\n+    US(true);", "originalCommit": "eb0e73c8d7696c3f362d3d585e54e306fb0f6e07", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzU2MTk0MQ==", "url": "https://github.com/hazelcast/hazelcast/pull/17898#discussion_r537561941", "bodyText": "Thanks for the comment, added the above roles to the javadoc of the enum.", "author": "blazember", "createdAt": "2020-12-07T14:45:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzUyNDIxNA=="}], "type": "inlineReview"}, {"oid": "fa2a6087afa71dc8185fb3ca138881aa340f490b", "url": "https://github.com/hazelcast/hazelcast/commit/fa2a6087afa71dc8185fb3ca138881aa340f490b", "message": "Address review comment and change the RU_COMPAT comments", "committedDate": "2020-12-07T14:43:57Z", "type": "commit"}]}