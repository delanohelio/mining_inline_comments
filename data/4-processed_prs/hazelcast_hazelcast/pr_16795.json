{"pr_number": 16795, "pr_title": "fix: measure ReplicatedMap operations latency in nanoseconds and report in milliseconds", "pr_createdAt": "2020-03-24T15:52:49Z", "pr_url": "https://github.com/hazelcast/hazelcast/pull/16795", "timeline": [{"oid": "cf8dd843137600284a9ef28651b337f7712e28ef", "url": "https://github.com/hazelcast/hazelcast/commit/cf8dd843137600284a9ef28651b337f7712e28ef", "message": "fix: measure ReplicatedMap gets latency in milliseconds", "committedDate": "2020-03-24T15:49:51Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzI5NTAzOQ==", "url": "https://github.com/hazelcast/hazelcast/pull/16795#discussion_r397295039", "bodyText": "I think we should rather report it as nanos and change the unit to NS too, similarly to the map counterpart: \n  \n    \n      hazelcast/hazelcast/src/main/java/com/hazelcast/client/impl/protocol/task/map/MapGetMessageTask.java\n    \n    \n         Line 71\n      in\n      97ff57b\n    \n    \n    \n    \n\n        \n          \n           .incrementGetLatencyNanos(System.nanoTime() - startTimeNanos); \n        \n    \n  \n\n\nI'd expect with reporting as millis, we typically report 0.\nThe same fields in the map are not metrics though \ud83e\udd14 This seems to be an error, I send a PR to fix this.\n\n  \n    \n      hazelcast/hazelcast/src/main/java/com/hazelcast/internal/monitor/impl/LocalMapStatsImpl.java\n    \n    \n         Line 140\n      in\n      296aac5\n    \n    \n    \n    \n\n        \n          \n           private volatile long totalGetLatenciesNanos;", "author": "blazember", "createdAt": "2020-03-24T16:34:20Z", "path": "hazelcast/src/main/java/com/hazelcast/client/impl/protocol/task/replicatedmap/ReplicatedMapGetMessageTask.java", "diffHunk": "@@ -59,7 +60,7 @@ protected Object processResponseBeforeSending(Object response) {\n         ReplicatedMapService replicatedMapService = getService(ReplicatedMapService.SERVICE_NAME);\n         if (replicatedMapService.getReplicatedMapConfig(parameters.name).isStatisticsEnabled()) {\n             LocalReplicatedMapStatsImpl stats = replicatedMapService.getLocalReplicatedMapStatsImpl(parameters.name);\n-            stats.incrementGets(System.nanoTime() - startTimeNanos);\n+            stats.incrementGets(TimeUnit.NANOSECONDS.toMillis(System.nanoTime() - startTimeNanos));", "originalCommit": "cf8dd843137600284a9ef28651b337f7712e28ef", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzMwMDM0Ng==", "url": "https://github.com/hazelcast/hazelcast/pull/16795#discussion_r397300346", "bodyText": "After taking another look, we do have metrics for maps' total get latency, but we do it a bit different:\n\n  \n    \n      hazelcast/hazelcast/src/main/java/com/hazelcast/internal/monitor/impl/LocalMapStatsImpl.java\n    \n    \n        Lines 311 to 315\n      in\n      296aac5\n    \n    \n    \n    \n\n        \n          \n           @Probe(name = MAP_METRIC_TOTAL_GET_LATENCY, unit = MS) \n        \n\n        \n          \n           @Override \n        \n\n        \n          \n           public long getTotalGetLatency() { \n        \n\n        \n          \n               return convertNanosToMillis(totalGetLatenciesNanos); \n        \n\n        \n          \n           } \n        \n    \n  \n\n\nSo we accumulate nanos, but convert it to millis for the metrics collector. I believe this is the right way to do.\n@alex-dukhno @puzpuzpuz \u261d\ufe0f", "author": "blazember", "createdAt": "2020-03-24T16:41:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzI5NTAzOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzMyMzM1OQ==", "url": "https://github.com/hazelcast/hazelcast/pull/16795#discussion_r397323359", "bodyText": "I believe this is the right way to do.\n\nI agree. We should do the same here.", "author": "puzpuzpuz", "createdAt": "2020-03-24T17:12:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzI5NTAzOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzQxODM4NA==", "url": "https://github.com/hazelcast/hazelcast/pull/16795#discussion_r397418384", "bodyText": "@blazember how about MAX_*_LATENCY? they are collected in the same methods as total*Latencies\ne.g. \n  \n    \n      hazelcast/hazelcast/src/main/java/com/hazelcast/internal/monitor/impl/LocalReplicatedMapStatsImpl.java\n    \n    \n        Lines 238 to 242\n      in\n      296aac5\n    \n    \n    \n    \n\n        \n          \n           public void incrementPuts(long latency) { \n        \n\n        \n          \n               PUT_COUNT.incrementAndGet(this); \n        \n\n        \n          \n               TOTAL_PUT_LATENCIES.addAndGet(this, latency); \n        \n\n        \n          \n               setMax(this, MAX_PUT_LATENCY, latency); \n        \n\n        \n          \n           } \n        \n    \n  \n\n\nedit: I meant how they should be reported? NS?", "author": "alex-dukhno", "createdAt": "2020-03-24T19:48:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzI5NTAzOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODczNTMzNQ==", "url": "https://github.com/hazelcast/hazelcast/pull/16795#discussion_r398735335", "bodyText": "I think MS is good, the max is very likely to be in the MS range anyways. Also, the map stats report it as MS, the best is to be consistent across the structures.", "author": "blazember", "createdAt": "2020-03-26T16:58:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzI5NTAzOQ=="}], "type": "inlineReview"}, {"oid": "7a1c6241fcdd7f799d43e31b85508a6030960a75", "url": "https://github.com/hazelcast/hazelcast/commit/7a1c6241fcdd7f799d43e31b85508a6030960a75", "message": "collect in nanos report in millis", "committedDate": "2020-03-24T20:00:40Z", "type": "commit"}, {"oid": "7a1c6241fcdd7f799d43e31b85508a6030960a75", "url": "https://github.com/hazelcast/hazelcast/commit/7a1c6241fcdd7f799d43e31b85508a6030960a75", "message": "collect in nanos report in millis", "committedDate": "2020-03-24T20:00:40Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzY0MTAzMA==", "url": "https://github.com/hazelcast/hazelcast/pull/16795#discussion_r397641030", "bodyText": "Changes in this class seem to be unrelated. #16781 is meant to address the problem across the whole code base.\nIf these changes are aimed to make operation latency probes for LocalReplicatedMapStats consistent, PR description has to updated at least.", "author": "puzpuzpuz", "createdAt": "2020-03-25T06:57:20Z", "path": "hazelcast/src/main/java/com/hazelcast/replicatedmap/impl/record/AbstractReplicatedRecordStore.java", "diffHunk": "@@ -75,7 +75,7 @@ public Object removeWithVersion(Object key, long version) {\n     @SuppressWarnings(\"unchecked\")\n     private Object remove(InternalReplicatedMapStorage<K, V> storage, Object key) {\n         isNotNull(key, \"key\");\n-        long time = Clock.currentTimeMillis();\n+        long time = System.nanoTime();", "originalCommit": "7a1c6241fcdd7f799d43e31b85508a6030960a75", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODM2MDUwOA==", "url": "https://github.com/hazelcast/hazelcast/pull/16795#discussion_r398360508", "bodyText": "nit: extract this and the following one methods into a common module (say, TimeUtil) and reuse them here and in LocalMapStats.", "author": "puzpuzpuz", "createdAt": "2020-03-26T07:22:43Z", "path": "hazelcast/src/main/java/com/hazelcast/internal/monitor/impl/LocalReplicatedMapStatsImpl.java", "diffHunk": "@@ -400,14 +405,22 @@ public void fromJson(JsonObject json) {\n         ownedEntryCount = getLong(json, \"ownedEntryCount\", -1L);\n         ownedEntryMemoryCost = getLong(json, \"ownedEntryMemoryCost\", -1L);\n         creationTime = getLong(json, \"creationTime\", -1L);\n-        totalGetLatencies = getLong(json, \"totalGetLatencies\", -1L);\n-        totalPutLatencies = getLong(json, \"totalPutLatencies\", -1L);\n-        totalRemoveLatencies = getLong(json, \"totalRemoveLatencies\", -1L);\n+        totalGetLatenciesNanos = convertMillisToNanos(getLong(json, \"totalGetLatencies\", -1L));\n+        totalPutLatenciesNanos = convertMillisToNanos(getLong(json, \"totalPutLatencies\", -1L));\n+        totalRemoveLatenciesNanos = convertMillisToNanos(getLong(json, \"totalRemoveLatencies\", -1L));\n         maxGetLatency = getLong(json, \"maxGetLatency\", -1L);\n         maxPutLatency = getLong(json, \"maxPutLatency\", -1L);\n         maxRemoveLatency = getLong(json, \"maxRemoveLatency\", -1L);\n     }\n \n+    private static long convertNanosToMillis(long nanos) {", "originalCommit": "7a1c6241fcdd7f799d43e31b85508a6030960a75", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODM2NDQ5NQ==", "url": "https://github.com/hazelcast/hazelcast/pull/16795#discussion_r398364495", "bodyText": "This call with nanos instead of millis as the argument automatically changes unit for maxRemoveLatency (and other max*Latency fields) in LocalReplicatedMapStatsImpl to nanos. Thus, they should be converted when reading the probe and when serializing stats to JSON, like it's done in LocalMapStatsImpl.", "author": "puzpuzpuz", "createdAt": "2020-03-26T07:32:18Z", "path": "hazelcast/src/main/java/com/hazelcast/replicatedmap/impl/record/AbstractReplicatedRecordStore.java", "diffHunk": "@@ -86,7 +86,7 @@ private Object remove(InternalReplicatedMapStorage<K, V> storage, Object key) {\n             storage.remove(marshalledKey, current);\n         }\n         if (replicatedMapConfig.isStatisticsEnabled()) {\n-            getStats().incrementRemoves(Clock.currentTimeMillis() - time);\n+            getStats().incrementRemoves(System.nanoTime() - time);", "originalCommit": "7a1c6241fcdd7f799d43e31b85508a6030960a75", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODM2NTMyMQ==", "url": "https://github.com/hazelcast/hazelcast/pull/16795#discussion_r398365321", "bodyText": "nit: rename argument of #incrementRemoves() to latencyNanos and, optionally, rename the method itself to #incrementRemovesLatencyNanos (see LocalMapStatsImpl for example). The same consideration applies to other #increment*() methods.", "author": "puzpuzpuz", "createdAt": "2020-03-26T07:34:20Z", "path": "hazelcast/src/main/java/com/hazelcast/replicatedmap/impl/record/AbstractReplicatedRecordStore.java", "diffHunk": "@@ -86,7 +86,7 @@ private Object remove(InternalReplicatedMapStorage<K, V> storage, Object key) {\n             storage.remove(marshalledKey, current);\n         }\n         if (replicatedMapConfig.isStatisticsEnabled()) {\n-            getStats().incrementRemoves(Clock.currentTimeMillis() - time);\n+            getStats().incrementRemoves(System.nanoTime() - time);", "originalCommit": "7a1c6241fcdd7f799d43e31b85508a6030960a75", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "518f0bd2dcc6981e8db9601e457eca2864209de5", "url": "https://github.com/hazelcast/hazelcast/commit/518f0bd2dcc6981e8db9601e457eca2864209de5", "message": "align naming to nanos", "committedDate": "2020-03-26T10:10:52Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODczMzA0MA==", "url": "https://github.com/hazelcast/hazelcast/pull/16795#discussion_r398733040", "bodyText": "These should be converted to MS too.", "author": "blazember", "createdAt": "2020-03-26T16:55:42Z", "path": "hazelcast/src/main/java/com/hazelcast/internal/monitor/impl/LocalReplicatedMapStatsImpl.java", "diffHunk": "@@ -235,62 +232,68 @@ public long getPutOperationCount() {\n         return putCount;\n     }\n \n-    public void incrementPuts(long latency) {\n+    public void incrementPutsNanos(long latencyNanos) {\n         PUT_COUNT.incrementAndGet(this);\n-        TOTAL_PUT_LATENCIES.addAndGet(this, latency);\n-        setMax(this, MAX_PUT_LATENCY, latency);\n+        TOTAL_PUT_LATENCIES.addAndGet(this, latencyNanos);\n+        setMax(this, MAX_PUT_LATENCY, latencyNanos);\n     }\n \n     @Override\n     public long getGetOperationCount() {\n         return getCount;\n     }\n \n-    public void incrementGets(long latency) {\n+    public void incrementGetsNanos(long latencyNanos) {\n         GET_COUNT.incrementAndGet(this);\n-        TOTAL_GET_LATENCIES.addAndGet(this, latency);\n-        setMax(this, MAX_GET_LATENCY, latency);\n+        TOTAL_GET_LATENCIES.addAndGet(this, latencyNanos);\n+        setMax(this, MAX_GET_LATENCY, latencyNanos);\n     }\n \n     @Override\n     public long getRemoveOperationCount() {\n         return removeCount;\n     }\n \n-    public void incrementRemoves(long latency) {\n+    public void incrementRemovesNanos(long latencyNanos) {\n         REMOVE_COUNT.incrementAndGet(this);\n-        TOTAL_REMOVE_LATENCIES.addAndGet(this, latency);\n-        setMax(this, MAX_REMOVE_LATENCY, latency);\n+        TOTAL_REMOVE_LATENCIES.addAndGet(this, latencyNanos);\n+        setMax(this, MAX_REMOVE_LATENCY, latencyNanos);\n     }\n \n+    @Probe(name = REPLICATED_MAP_METRIC_TOTAL_PUT_LATENCIES, unit = MS)\n     @Override\n     public long getTotalPutLatency() {\n-        return totalPutLatencies;\n+        return convertNanosToMillis(totalPutLatenciesNanos);\n     }\n \n+    @Probe(name = REPLICATED_MAP_METRIC_TOTAL_GET_LATENCIES, unit = MS)\n     @Override\n     public long getTotalGetLatency() {\n-        return totalGetLatencies;\n+        return convertNanosToMillis(totalGetLatenciesNanos);\n     }\n \n+    @Probe(name = REPLICATED_MAP_METRIC_TOTAL_REMOVE_LATENCIES, unit = MS)\n     @Override\n     public long getTotalRemoveLatency() {\n-        return totalRemoveLatencies;\n+        return convertNanosToMillis(totalRemoveLatenciesNanos);\n     }\n \n+    @Probe(name = REPLICATED_MAP_MAX_GET_LATENCY, unit = MS)\n     @Override\n     public long getMaxPutLatency() {\n-        return maxPutLatency;\n+        return maxPutLatencyNanos;", "originalCommit": "518f0bd2dcc6981e8db9601e457eca2864209de5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODc5MDUzMA==", "url": "https://github.com/hazelcast/hazelcast/pull/16795#discussion_r398790530", "bodyText": "Nice catch. I don't know why I didn't notice this. \ud83d\ude05", "author": "puzpuzpuz", "createdAt": "2020-03-26T18:15:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODczMzA0MA=="}], "type": "inlineReview"}, {"oid": "4a5ec91df0b4252c2870c0bd581b691c2b9854b5", "url": "https://github.com/hazelcast/hazelcast/commit/4a5ec91df0b4252c2870c0bd581b691c2b9854b5", "message": "fix convertions", "committedDate": "2020-03-27T15:34:18Z", "type": "commit"}, {"oid": "a212d66f816837aa092d1c855edff40587e2fea0", "url": "https://github.com/hazelcast/hazelcast/commit/a212d66f816837aa092d1c855edff40587e2fea0", "message": "fix tests", "committedDate": "2020-03-31T10:39:33Z", "type": "commit"}]}