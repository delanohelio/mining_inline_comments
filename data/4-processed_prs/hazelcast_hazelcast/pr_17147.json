{"pr_number": 17147, "pr_title": "Handle membership in the client on split brain", "pr_createdAt": "2020-07-01T08:13:47Z", "pr_url": "https://github.com/hazelcast/hazelcast/pull/17147", "timeline": [{"oid": "354e2cbd486220e864ca1bc9d8e709e9829f4745", "url": "https://github.com/hazelcast/hazelcast/commit/354e2cbd486220e864ca1bc9d8e709e9829f4745", "message": "Handle membership in the client on split brain\n\nIt could be the case that when split brain occurs the member list\nversion that client remembers is already bigger than the the\nhalf that client is connected to. In this case, client can not\napply the member list because it has an older version. But\nin fact, it should have been applied, otherwise client get\nstuck with an old member-list.\n\nAs a solution, we clear the member-list version everytime\nwe re-register the member list listener.\n\nfixes https://github.com/hazelcast/hazelcast/issues/16855", "committedDate": "2020-07-01T09:38:14Z", "type": "commit"}, {"oid": "354e2cbd486220e864ca1bc9d8e709e9829f4745", "url": "https://github.com/hazelcast/hazelcast/commit/354e2cbd486220e864ca1bc9d8e709e9829f4745", "message": "Handle membership in the client on split brain\n\nIt could be the case that when split brain occurs the member list\nversion that client remembers is already bigger than the the\nhalf that client is connected to. In this case, client can not\napply the member list because it has an older version. But\nin fact, it should have been applied, otherwise client get\nstuck with an old member-list.\n\nAs a solution, we clear the member-list version everytime\nwe re-register the member list listener.\n\nfixes https://github.com/hazelcast/hazelcast/issues/16855", "committedDate": "2020-07-01T09:38:14Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODk0MzQ5MA==", "url": "https://github.com/hazelcast/hazelcast/pull/17147#discussion_r448943490", "bodyText": "Minor: we don't check whether or not aRemovedLatch is open", "author": "mdumandag", "createdAt": "2020-07-02T11:47:49Z", "path": "hazelcast/src/test/java/com/hazelcast/client/heartbeat/ClientHeartbeatTest.java", "diffHunk": "@@ -324,4 +328,63 @@ public boolean decodeRemoveResponse(ClientMessage clientMessage) {\n             }\n         };\n     }\n+\n+    @Test\n+    public void testClientMembershipEvents_onSplitBrain() {\n+        Config config = new Config();\n+        HazelcastInstance instanceA = hazelcastFactory.newHazelcastInstance(config);\n+\n+        ClientConfig clientConfig = new ClientConfig();\n+        clientConfig.getConnectionStrategyConfig().getConnectionRetryConfig()\n+                .setClusterConnectTimeoutMillis(Integer.MAX_VALUE);\n+        HazelcastInstance client = hazelcastFactory.newHazelcastClient(clientConfig);\n+\n+        HazelcastInstance instanceB = hazelcastFactory.newHazelcastInstance(config);\n+        HazelcastInstance instanceC = hazelcastFactory.newHazelcastInstance(config);\n+\n+        Member memberA = instanceA.getCluster().getLocalMember();\n+        Member memberB = instanceB.getCluster().getLocalMember();\n+        Member memberC = instanceC.getCluster().getLocalMember();\n+\n+        CountDownLatch splitLatch = new CountDownLatch(1);\n+        CountDownLatch bRemovedLatch = new CountDownLatch(1);\n+        CountDownLatch aRemovedLatch = new CountDownLatch(1);\n+\n+        CountDownLatch switchedToCLatch = new CountDownLatch(1);\n+        client.getCluster().addMembershipListener(new MembershipListener() {\n+            @Override\n+            public void memberAdded(MembershipEvent membershipEvent) {\n+                if (memberC.equals(membershipEvent.getMember())) {\n+                    switchedToCLatch.countDown();\n+                }\n+            }\n+\n+            @Override\n+            public void memberRemoved(MembershipEvent membershipEvent) {\n+                if (memberC.equals(membershipEvent.getMember())) {\n+                    splitLatch.countDown();\n+                }\n+\n+                if (memberB.equals(membershipEvent.getMember())) {\n+                    bRemovedLatch.countDown();\n+                }\n+\n+                if (memberA.equals(membershipEvent.getMember())) {\n+                    aRemovedLatch.countDown();\n+                }\n+            }\n+        });\n+\n+        blockCommunicationBetween(instanceA, instanceC);\n+        closeConnectionBetween(instanceA, instanceC);\n+        blockCommunicationBetween(instanceB, instanceC);\n+        closeConnectionBetween(instanceB, instanceC);\n+\n+        assertOpenEventually(\" A B | C\", splitLatch);\n+        instanceB.shutdown();\n+        assertOpenEventually(\" A | C\", bRemovedLatch);\n+        instanceA.shutdown();\n+", "originalCommit": "354e2cbd486220e864ca1bc9d8e709e9829f4745", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODk2NDc1NQ==", "url": "https://github.com/hazelcast/hazelcast/pull/17147#discussion_r448964755", "bodyText": "Good catch \ud83d\udc4d", "author": "sancar", "createdAt": "2020-07-02T12:28:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODk0MzQ5MA=="}], "type": "inlineReview"}, {"oid": "8aa17116dd7394790cd22f83de6c22b2650b4620", "url": "https://github.com/hazelcast/hazelcast/commit/8aa17116dd7394790cd22f83de6c22b2650b4620", "message": "test fix", "committedDate": "2020-07-02T12:29:41Z", "type": "commit"}]}