{"pr_number": 16808, "pr_title": "Added support for IMap.computeIfAbsent() #14913", "pr_createdAt": "2020-03-28T07:23:05Z", "pr_url": "https://github.com/hazelcast/hazelcast/pull/16808", "timeline": [{"oid": "ac0c446a4cca8dc6ddf042724f39921f972e1ee4", "url": "https://github.com/hazelcast/hazelcast/commit/ac0c446a4cca8dc6ddf042724f39921f972e1ee4", "message": "Added support for IMap.computeIfAbsent() #14913", "committedDate": "2020-03-28T07:21:47Z", "type": "commit"}, {"oid": "eef5aee61cbd9f66b04aad8b9838caaa737d6716", "url": "https://github.com/hazelcast/hazelcast/commit/eef5aee61cbd9f66b04aad8b9838caaa737d6716", "message": "Removed unnecessary client-jvm-only tests #14913", "committedDate": "2020-03-28T10:51:54Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDcxMzExNQ==", "url": "https://github.com/hazelcast/hazelcast/pull/16808#discussion_r400713115", "bodyText": "Should the actual logic not be done on the server side?\nIt seems you are first getting the value, then convert it and try to set it.\nIf it is all done remotely, less remote calls are involved.", "author": "pveentjer", "createdAt": "2020-03-31T07:56:47Z", "path": "hazelcast/src/main/java/com/hazelcast/client/impl/proxy/ClientMapProxy.java", "diffHunk": "@@ -2014,4 +2015,32 @@ private V computeIfPresentLocally(K key,\n             }\n         }\n     }\n+\n+    @Override\n+    public V computeIfAbsent(K key, Function<? super K, ? extends V> mappingFunction) {\n+        checkNotNull(key, NULL_KEY_IS_NOT_ALLOWED);\n+        checkNotNull(mappingFunction, NULL_FUNCTION_IS_NOT_ALLOWED);\n+\n+        return computeIfAbsentLocally(key, mappingFunction);\n+    }\n+\n+    private V computeIfAbsentLocally(K key, Function<? super K, ? extends V> mappingFunction) {", "originalCommit": "eef5aee61cbd9f66b04aad8b9838caaa737d6716", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDc0NTE2Mg==", "url": "https://github.com/hazelcast/hazelcast/pull/16808#discussion_r400745162", "bodyText": "Hi Peter,\nFor the client, it was decided to execute the function locally -\n#16636 (comment)", "author": "webashutosh", "createdAt": "2020-03-31T08:49:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDcxMzExNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDg5MDE2MA==", "url": "https://github.com/hazelcast/hazelcast/pull/16808#discussion_r400890160", "bodyText": "Now that I see it, can you add @Nonnull annotations to all parameters here, to computeIfPresent and all of the implementations?", "author": "mmedenjak", "createdAt": "2020-03-31T12:55:48Z", "path": "hazelcast/src/main/java/com/hazelcast/map/IMap.java", "diffHunk": "@@ -2955,4 +2956,26 @@ default void addIndex(IndexType type, String... attributes) {\n      */\n     V computeIfPresent(K key, BiFunction<? super K, ? super V, ? extends V> remappingFunction);\n \n+    /**\n+     * {@inheritDoc}\n+     *\n+     * <p> </p>\n+     * <p>\n+     *     If the supplied {@code mappingFunction} is a lambda, anonymous class or an inner class,\n+     *     it would be executed locally. Same would happen if it is not serializable.\n+     *     This may result in two round-trips between hazelcast nodes.\n+     *</p>\n+     * <p>\n+     *     Otherwise (i.e. if it is a top-level class or a member class, and it is serializable), the function <i>may be</i> sent\n+     *     to the server which owns the key. This results in a single remote call. Also, the function would have exclusive\n+     *     access to the map entry during its execution.\n+     *     Note that in this case, the function class must be deployed on all the servers (either physically\n+     *     or via user-code-deployment).\n+     * </p>\n+     * <p>\n+     *     When this method is invoked using a hazelcast-client instance, the {@code mappingFunction} is always executed locally\n+     * </p>\n+     */\n+    V computeIfAbsent(K key, Function<? super K, ? extends V> mappingFunction);", "originalCommit": "eef5aee61cbd9f66b04aad8b9838caaa737d6716", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "0b8c911799ed7293a262d3a1b8807180c131b976", "url": "https://github.com/hazelcast/hazelcast/commit/0b8c911799ed7293a262d3a1b8807180c131b976", "message": "Added @Nonnull annotations to method args #14913", "committedDate": "2020-03-31T14:17:05Z", "type": "commit"}]}