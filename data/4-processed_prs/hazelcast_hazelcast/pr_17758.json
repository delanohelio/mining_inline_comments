{"pr_number": 17758, "pr_title": "[BACKPORT] Fixed a data loss issue on lite member promotion (#17644)", "pr_createdAt": "2020-10-23T13:26:44Z", "pr_url": "https://github.com/hazelcast/hazelcast/pull/17758", "timeline": [{"oid": "e8abc4d3330b151535fa7420066aa43929645aa2", "url": "https://github.com/hazelcast/hazelcast/commit/e8abc4d3330b151535fa7420066aa43929645aa2", "message": "Fixed a data loss issue on lite member promotion (#17644)\n\nNotify cluster members on lite member promotion to update\nmemberGroupSize. Otherwise, a data member might be not aware of other\npromoted data members, and it may cause backup operations\nnot being issued to other data members.\n\nCloses https://github.com/hazelcast/hazelcast/issues/17621", "committedDate": "2020-10-23T13:22:49Z", "type": "commit"}, {"oid": "2db56f6c455b18efa92b8392c63c41effb6ff62f", "url": "https://github.com/hazelcast/hazelcast/commit/2db56f6c455b18efa92b8392c63c41effb6ff62f", "message": "Fixed a compilation issue", "committedDate": "2020-10-23T13:54:34Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjUwNDkwOA==", "url": "https://github.com/hazelcast/hazelcast/pull/17758#discussion_r512504908", "bodyText": "nit: could use waitClusterForSafeState here and assertEqualsEventually in subsequent assertTrueEventually usages below.", "author": "vbekiaris", "createdAt": "2020-10-27T08:42:13Z", "path": "hazelcast/src/test/java/com/hazelcast/internal/cluster/impl/PromoteLiteMemberTest.java", "diffHunk": "@@ -374,6 +376,110 @@ private void memberAttributes_arePreserved_afterPromotion(boolean isMaster) thro\n         }\n     }\n \n+    @Test\n+    public void test_lite_member_promotion_causes_no_data_loss_on_three_members() throws InterruptedException {\n+        final int entryCount = 1000;\n+\n+        TestHazelcastInstanceFactory factory = createHazelcastInstanceFactory();\n+        Config config = new Config().setLiteMember(true);\n+\n+        // start first hazelcast instance as a lite member\n+        final HazelcastInstance firstHazelcastInstance = factory.newHazelcastInstance(config);\n+\n+        // start second and third hazelcast instances as a lite member\n+        final HazelcastInstance secondHazelcastInstance = factory.newHazelcastInstance(config);\n+        final HazelcastInstance thirdHazelcastInstance = factory.newHazelcastInstance(config);\n+\n+        // promote all instances to data members\n+        firstHazelcastInstance.getCluster().promoteLocalLiteMember();\n+        secondHazelcastInstance.getCluster().promoteLocalLiteMember();\n+        thirdHazelcastInstance.getCluster().promoteLocalLiteMember();\n+\n+        // check if cluster is in a good shape\n+        assertTrueEventually(new AssertTask() {", "originalCommit": "2db56f6c455b18efa92b8392c63c41effb6ff62f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}