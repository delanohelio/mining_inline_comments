{"pr_number": 17769, "pr_title": "Fix natural filtering strategy for map events", "pr_createdAt": "2020-10-27T09:33:02Z", "pr_url": "https://github.com/hazelcast/hazelcast/pull/17769", "timeline": [{"oid": "aee7afa2fcf397a9c792a18ec06a0d094e237954", "url": "https://github.com/hazelcast/hazelcast/commit/aee7afa2fcf397a9c792a18ec06a0d094e237954", "message": "checkstyle", "committedDate": "2020-10-27T12:32:28Z", "type": "forcePushed"}, {"oid": "898225eafacd60d06e90716d4e4384e7ed00e379", "url": "https://github.com/hazelcast/hazelcast/commit/898225eafacd60d06e90716d4e4384e7ed00e379", "message": "checkstyle", "committedDate": "2021-01-27T12:33:00Z", "type": "forcePushed"}, {"oid": "1fb451570a88871e0f8097a8e13df9cc4856bf8c", "url": "https://github.com/hazelcast/hazelcast/commit/1fb451570a88871e0f8097a8e13df9cc4856bf8c", "message": "add test", "committedDate": "2021-02-03T14:38:40Z", "type": "forcePushed"}, {"oid": "37f003395158f5220784842e315c538720ef26d2", "url": "https://github.com/hazelcast/hazelcast/commit/37f003395158f5220784842e315c538720ef26d2", "message": "add test", "committedDate": "2021-02-04T09:10:17Z", "type": "forcePushed"}, {"oid": "0a52e89f336142ac6ad1de0e5e9acc49f952b3b9", "url": "https://github.com/hazelcast/hazelcast/commit/0a52e89f336142ac6ad1de0e5e9acc49f952b3b9", "message": "Refactor constructor signatures", "committedDate": "2021-02-10T08:48:39Z", "type": "commit"}, {"oid": "8b67cdee426b8d76d76aba6097fe0873c37a1bfa", "url": "https://github.com/hazelcast/hazelcast/commit/8b67cdee426b8d76d76aba6097fe0873c37a1bfa", "message": "Add local entry listener with a filter", "committedDate": "2021-02-10T08:48:39Z", "type": "commit"}, {"oid": "ce285199c3fd4efd6383e0196e5f04cd1e4fdcd1", "url": "https://github.com/hazelcast/hazelcast/commit/ce285199c3fd4efd6383e0196e5f04cd1e4fdcd1", "message": "checkstyle", "committedDate": "2021-02-10T08:48:40Z", "type": "commit"}, {"oid": "7bda64acf9962f15f7e36fe2a1a80869c92221ab", "url": "https://github.com/hazelcast/hazelcast/commit/7bda64acf9962f15f7e36fe2a1a80869c92221ab", "message": "add test", "committedDate": "2021-02-10T08:48:40Z", "type": "commit"}, {"oid": "cb21b50ac1781fcc5337d73c975afa4b343ab030", "url": "https://github.com/hazelcast/hazelcast/commit/cb21b50ac1781fcc5337d73c975afa4b343ab030", "message": "Address reviews", "committedDate": "2021-02-10T08:58:29Z", "type": "commit"}, {"oid": "cb21b50ac1781fcc5337d73c975afa4b343ab030", "url": "https://github.com/hazelcast/hazelcast/commit/cb21b50ac1781fcc5337d73c975afa4b343ab030", "message": "Address reviews", "committedDate": "2021-02-10T08:58:29Z", "type": "forcePushed"}, {"oid": "5854b49236cb27d355eccd0c615e816481843a8c", "url": "https://github.com/hazelcast/hazelcast/commit/5854b49236cb27d355eccd0c615e816481843a8c", "message": "fix checkstyle", "committedDate": "2021-02-10T09:13:03Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MzYzMzY4MQ==", "url": "https://github.com/hazelcast/hazelcast/pull/17769#discussion_r573633681", "bodyText": "you can omit <Throwable> here, it's not accurate anyway since we add all kinds of objects to the logCollector.", "author": "vbekiaris", "createdAt": "2021-02-10T10:58:24Z", "path": "hazelcast/src/test/java/com/hazelcast/map/LocalListenerTest.java", "diffHunk": "@@ -0,0 +1,115 @@\n+/*\n+ * Copyright (c) 2008-2021, Hazelcast, Inc. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.map;\n+\n+import com.hazelcast.config.Config;\n+import com.hazelcast.core.HazelcastInstance;\n+import com.hazelcast.logging.AbstractLogger;\n+import com.hazelcast.logging.LogEvent;\n+import com.hazelcast.map.impl.MapService;\n+import com.hazelcast.map.impl.MapServiceContext;\n+import com.hazelcast.map.impl.event.MapEventPublisher;\n+import com.hazelcast.map.listener.EntryRemovedListener;\n+import com.hazelcast.spi.impl.NodeEngineImpl;\n+import com.hazelcast.test.HazelcastSerialClassRunner;\n+import com.hazelcast.test.HazelcastTestSupport;\n+import com.hazelcast.test.annotation.ParallelJVMTest;\n+import com.hazelcast.test.annotation.QuickTest;\n+import org.junit.Test;\n+import org.junit.experimental.categories.Category;\n+import org.junit.runner.RunWith;\n+\n+import java.util.concurrent.CopyOnWriteArrayList;\n+import java.util.logging.Level;\n+\n+import static com.hazelcast.map.impl.event.MapEventPublisherImpl.PROP_LISTENER_WITH_PREDICATE_PRODUCES_NATURAL_EVENT_TYPES;\n+import static com.hazelcast.test.Accessors.getNodeEngineImpl;\n+import static com.hazelcast.test.starter.ReflectionUtils.setFieldValueReflectively;\n+import static org.junit.Assert.assertTrue;\n+\n+@RunWith(HazelcastSerialClassRunner.class)\n+@Category({QuickTest.class, ParallelJVMTest.class})\n+public class LocalListenerTest extends HazelcastTestSupport {\n+\n+    @Test\n+    public void no_exception_when_not_notifiable_listener() throws IllegalAccessException {\n+        Config config = getConfig()\n+                .setProperty(PROP_LISTENER_WITH_PREDICATE_PRODUCES_NATURAL_EVENT_TYPES, \"true\");\n+\n+        HazelcastInstance instance = createHazelcastInstance(config);\n+        IMap<String, String> map = instance.getMap(randomString());\n+\n+        MapEventPublisherLogger mapEventPublisherLogger = new MapEventPublisherLogger();\n+        injectLogger(instance, mapEventPublisherLogger);\n+\n+        // this entry-removed-listener is not notifiable,\n+        // since we expect entry added events.\n+        map.addLocalEntryListener((EntryRemovedListener<String, String>) event -> {\n+        });\n+\n+        // generate entry-added event\n+        map.put(\"key\", \"value\");\n+\n+        // no exception we expect (we use assertTrueAllTheTime\n+        // since event is fired after put return)\n+        assertTrueAllTheTime(() -> assertTrue(mapEventPublisherLogger.logCollector.toString(),\n+                mapEventPublisherLogger.logCollector.isEmpty()), 5);\n+\n+    }\n+\n+    private void injectLogger(HazelcastInstance instance,\n+                              MapEventPublisherLogger mapEventPublisherLogger) throws IllegalAccessException {\n+        NodeEngineImpl nodeEngine1 = getNodeEngineImpl(instance);\n+        MapService mapService = nodeEngine1.getService(MapService.SERVICE_NAME);\n+        MapServiceContext mapServiceContext = mapService.getMapServiceContext();\n+        MapEventPublisher mapEventPublisher = mapServiceContext.getMapEventPublisher();\n+        setFieldValueReflectively(mapEventPublisher, \"logger\", mapEventPublisherLogger);\n+    }\n+\n+    private class MapEventPublisherLogger extends AbstractLogger {\n+\n+        private final CopyOnWriteArrayList logCollector\n+                = new CopyOnWriteArrayList<Throwable>();", "originalCommit": "5854b49236cb27d355eccd0c615e816481843a8c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MzY0MjI4Mg==", "url": "https://github.com/hazelcast/hazelcast/pull/17769#discussion_r573642282", "bodyText": "fixed", "author": "ahmetmircik", "createdAt": "2021-02-10T11:11:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MzYzMzY4MQ=="}], "type": "inlineReview"}, {"oid": "62b3f16ca37ee5cdc4d7708f87f372cd02cf0e20", "url": "https://github.com/hazelcast/hazelcast/commit/62b3f16ca37ee5cdc4d7708f87f372cd02cf0e20", "message": "Address reviews", "committedDate": "2021-02-10T11:11:31Z", "type": "commit"}]}