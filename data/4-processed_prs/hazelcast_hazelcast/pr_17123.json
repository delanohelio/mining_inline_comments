{"pr_number": 17123, "pr_title": "Auditlog - configuration and events", "pr_createdAt": "2020-06-23T08:02:54Z", "pr_url": "https://github.com/hazelcast/hazelcast/pull/17123", "timeline": [{"oid": "2e9c3f83c7292ca3d2eac6cdfc7fb9a4e1cdfa0e", "url": "https://github.com/hazelcast/hazelcast/commit/2e9c3f83c7292ca3d2eac6cdfc7fb9a4e1cdfa0e", "message": "Add auditable events.", "committedDate": "2020-06-23T08:19:42Z", "type": "forcePushed"}, {"oid": "c8138a48dd703e6b2d3a0d147855b3bafd4ea024", "url": "https://github.com/hazelcast/hazelcast/commit/c8138a48dd703e6b2d3a0d147855b3bafd4ea024", "message": "Add auditable events.", "committedDate": "2020-06-23T09:51:20Z", "type": "forcePushed"}, {"oid": "de75f7c09b5cc86f6d23dbbac173e27f40d9cb25", "url": "https://github.com/hazelcast/hazelcast/commit/de75f7c09b5cc86f6d23dbbac173e27f40d9cb25", "message": "Add auditable events.", "committedDate": "2020-06-23T10:45:16Z", "type": "forcePushed"}, {"oid": "b63e3a311cd0b451c42f759de2c6f1f9f637a010", "url": "https://github.com/hazelcast/hazelcast/commit/b63e3a311cd0b451c42f759de2c6f1f9f637a010", "message": "Add auditable events.", "committedDate": "2020-06-23T15:02:40Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDcxMDEwMg==", "url": "https://github.com/hazelcast/hazelcast/pull/17123#discussion_r444710102", "bodyText": "What is the added value of a Boolean compared to boolean?", "author": "pveentjer", "createdAt": "2020-06-24T07:52:40Z", "path": "hazelcast/src/main/java/com/hazelcast/client/impl/protocol/task/AuthenticationBaseMessageTask.java", "diffHunk": "@@ -126,14 +127,24 @@ private AuthenticationStatus authenticate() {\n \n     private AuthenticationStatus authenticate(SecurityContext securityContext) {\n         Connection connection = endpoint.getConnection();\n+        Boolean passed = Boolean.FALSE;", "originalCommit": "b63e3a311cd0b451c42f759de2c6f1f9f637a010", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDcxMzE2OA==", "url": "https://github.com/hazelcast/hazelcast/pull/17123#discussion_r444713168", "bodyText": "It avoids boxing in the addParameter call.", "author": "kwart", "createdAt": "2020-06-24T07:57:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDcxMDEwMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDcxMjM0NQ==", "url": "https://github.com/hazelcast/hazelcast/pull/17123#discussion_r444712345", "bodyText": "Why a Boolean?", "author": "pveentjer", "createdAt": "2020-06-24T07:56:28Z", "path": "hazelcast/src/main/java/com/hazelcast/internal/ascii/rest/HttpCommandProcessor.java", "diffHunk": "@@ -213,12 +214,22 @@ private boolean authenticate(@Nonnull HttpPostCommand command,\n         }\n         String decodedPass = pass != null ? URLDecoder.decode(pass, \"UTF-8\") : null;\n         UsernamePasswordCredentials credentials = new UsernamePasswordCredentials(decodedName, decodedPass);\n+        Boolean passed = Boolean.FALSE;", "originalCommit": "b63e3a311cd0b451c42f759de2c6f1f9f637a010", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDcxMzg4OA==", "url": "https://github.com/hazelcast/hazelcast/pull/17123#discussion_r444713888", "bodyText": "It avoids boxing in the addParameter call.", "author": "kwart", "createdAt": "2020-06-24T07:59:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDcxMjM0NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzQ5NjE1NA==", "url": "https://github.com/hazelcast/hazelcast/pull/17123#discussion_r447496154", "bodyText": "Afaik no new object is made if you have a boolean that is being boxed. So I don't think there is any difference from a performance perspective. Anyhow. It isn't very important.", "author": "pveentjer", "createdAt": "2020-06-30T08:13:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDcxMjM0NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDcxMzQzMg==", "url": "https://github.com/hazelcast/hazelcast/pull/17123#discussion_r444713432", "bodyText": "Would be nice to have the audit log dump its content in the Diagnostics.", "author": "pveentjer", "createdAt": "2020-06-24T07:58:16Z", "path": "hazelcast/src/main/java/com/hazelcast/internal/auditlog/impl/AuditlogTypeIds.java", "diffHunk": "@@ -18,7 +18,69 @@\n \n public final class AuditlogTypeIds {\n ", "originalCommit": "b63e3a311cd0b451c42f759de2c6f1f9f637a010", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDcxNDE4Ng==", "url": "https://github.com/hazelcast/hazelcast/pull/17123#discussion_r444714186", "bodyText": "Boolean vs boolean", "author": "pveentjer", "createdAt": "2020-06-24T07:59:40Z", "path": "hazelcast/src/main/java/com/hazelcast/internal/cluster/impl/ClusterJoinManager.java", "diffHunk": "@@ -373,14 +374,25 @@ private void secureLogin(JoinRequest joinRequest, Connection connection) {\n                 throw new SecurityException(\"Expecting security credentials, but credentials could not be found in join request\");\n             }\n             String endpoint = joinRequest.getAddress().getHost();\n+            Boolean passed = Boolean.FALSE;", "originalCommit": "b63e3a311cd0b451c42f759de2c6f1f9f637a010", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDcxNTMyMA==", "url": "https://github.com/hazelcast/hazelcast/pull/17123#discussion_r444715320", "bodyText": "Can't we enable it by default? And at least dump everything into diagnostics. Diagnostics should also be enabled by default but that is another discussion.", "author": "pveentjer", "createdAt": "2020-06-24T08:01:47Z", "path": "hazelcast/src/main/java/com/hazelcast/spi/properties/ClusterProperty.java", "diffHunk": "@@ -1029,8 +1029,6 @@ private int getWhenNoSSLDetected() {\n     public static final HazelcastProperty CLIENT_PROTOCOL_UNVERIFIED_MESSAGE_BYTES =\n             new HazelcastProperty(\"hazelcast.client.protocol.max.message.bytes\", 4096);\n \n-    public static final HazelcastProperty AUDIT_LOG_ENABLED = new HazelcastProperty(\"hazelcast.auditlog.enabled\", false);", "originalCommit": "b63e3a311cd0b451c42f759de2c6f1f9f637a010", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDc4Nzk2NQ==", "url": "https://github.com/hazelcast/hazelcast/pull/17123#discussion_r450787965", "bodyText": "Leftover SSLConfig, there is one more occurrence.", "author": "mmedenjak", "createdAt": "2020-07-07T11:14:28Z", "path": "hazelcast/src/main/java/com/hazelcast/config/AbstractFactoryWithPropertiesConfig.java", "diffHunk": "@@ -0,0 +1,147 @@\n+/*\n+ * Copyright (c) 2008-2020, Hazelcast, Inc. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.config;\n+\n+import java.util.Objects;\n+import java.util.Properties;\n+\n+/**\n+ * Configuration base for config types with a factory class and its properties.\n+ *\n+ * @param <T> final child type\n+ */\n+public abstract class AbstractFactoryWithPropertiesConfig<T extends AbstractFactoryWithPropertiesConfig<T>> {\n+\n+    private boolean enabled;\n+    private String factoryClassName;\n+    private Properties properties = new Properties();\n+\n+    /**\n+     * Returns the factory class name.\n+     */\n+    public String getFactoryClassName() {\n+        return factoryClassName;\n+    }\n+\n+    /**\n+     * Sets the factory class name.\n+     */\n+    public T setFactoryClassName(String factoryClassName) {\n+        this.factoryClassName = factoryClassName;\n+        return self();\n+    }\n+\n+    /**\n+     * Returns if this configuration is enabled.\n+     *\n+     * @return {@code true} if enabled, {@code false} otherwise\n+     */\n+    public boolean isEnabled() {\n+        return enabled;\n+    }\n+\n+    /**\n+     * Enables and disables this configuration.\n+     *\n+     * @param enabled {@code true} to enable, {@code false} to disable\n+     */\n+    public T setEnabled(boolean enabled) {\n+        this.enabled = enabled;\n+        return self();\n+    }\n+\n+    /**\n+     * Sets a single property.\n+     *\n+     * @param name  the name of the property to set\n+     * @param value the value of the property to set\n+     * @return the updated SSLConfig\n+     * @throws NullPointerException if name or value is {@code null}\n+     */\n+    public T setProperty(String name, String value) {\n+        properties.put(name, value);\n+        return self();\n+    }\n+\n+    /**\n+     * Gets a property.\n+     *\n+     * @param name the name of the property to get\n+     * @return the value of the property, null if not found\n+     * @throws NullPointerException if name is {@code null}\n+     */\n+    public String getProperty(String name) {\n+        return properties.getProperty(name);\n+    }\n+\n+    /**\n+     * Gets all properties.\n+     *\n+     * @return the properties\n+     */\n+    public Properties getProperties() {\n+        return properties;\n+    }\n+\n+    /**\n+     * Sets the properties.\n+     *\n+     * @param properties the properties to set\n+     * @return the updated SSLConfig", "originalCommit": "b63e3a311cd0b451c42f759de2c6f1f9f637a010", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDc4OTA0NA==", "url": "https://github.com/hazelcast/hazelcast/pull/17123#discussion_r450789044", "bodyText": "Can we move these into a public package? I guess these are part of public API now, given that we can't change the IDs after we've released them. Also, maybe we can refer to this file from the AuditlogService javadoc.", "author": "mmedenjak", "createdAt": "2020-07-07T11:16:40Z", "path": "hazelcast/src/main/java/com/hazelcast/internal/auditlog/impl/AuditlogTypeIds.java", "diffHunk": "@@ -18,7 +18,69 @@\n \n public final class AuditlogTypeIds {\n \n-    public static final String CONNECTION_ASKS_PROTOCOL = \"HZ-1001\";\n+    // Network Events\n+    /**\n+     * Event type ID: Connection accepted.\n+     */\n+    public static final String NETWORK_CONNECT = \"HZ-0101\";", "originalCommit": "b63e3a311cd0b451c42f759de2c6f1f9f637a010", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mjc5NTQzMg==", "url": "https://github.com/hazelcast/hazelcast/pull/17123#discussion_r452795432", "bodyText": "Good point. I'll move the class and update the JavaDoc.", "author": "kwart", "createdAt": "2020-07-10T11:50:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDc4OTA0NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDc5MTk3NA==", "url": "https://github.com/hazelcast/hazelcast/pull/17123#discussion_r450791974", "bodyText": "Not related to this class, but can you complete the javadoc for AuditlogService#eventBuilder?", "author": "mmedenjak", "createdAt": "2020-07-07T11:22:45Z", "path": "hazelcast/src/main/java/com/hazelcast/internal/auditlog/AuditlogServiceFactory.java", "diffHunk": "@@ -0,0 +1,40 @@\n+/*\n+ * Copyright (c) 2008-2020, Hazelcast, Inc. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.internal.auditlog;\n+\n+import java.util.Properties;\n+\n+import javax.security.auth.callback.CallbackHandler;\n+\n+/**\n+ * Interface implemented by {@link AuditlogService} factory classes.\n+ */\n+public interface AuditlogServiceFactory {", "originalCommit": "b63e3a311cd0b451c42f759de2c6f1f9f637a010", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDc5MzgzMg==", "url": "https://github.com/hazelcast/hazelcast/pull/17123#discussion_r450793832", "bodyText": "Unfortunately seems params are an easy way how to leak private API. User implementations can now get references to classes such as com.hazelcast.internal.nio.Connection. I don't see an easy way out of it but I'd prefer that we don't do it.", "author": "mmedenjak", "createdAt": "2020-07-07T11:26:36Z", "path": "hazelcast/src/main/java/com/hazelcast/client/impl/protocol/task/AuthenticationBaseMessageTask.java", "diffHunk": "@@ -126,14 +127,24 @@ private AuthenticationStatus authenticate() {\n \n     private AuthenticationStatus authenticate(SecurityContext securityContext) {\n         Connection connection = endpoint.getConnection();\n+        Boolean passed = Boolean.FALSE;\n         try {\n             LoginContext lc = securityContext.createClientLoginContext(clusterName, credentials, connection);\n             lc.login();\n             endpoint.setLoginContext(lc);\n+            passed = Boolean.TRUE;\n             return AUTHENTICATED;\n         } catch (LoginException e) {\n             logger.warning(e);\n             return CREDENTIALS_FAILED;\n+        } finally {\n+            nodeEngine.getNode().getNodeExtension().getAuditlogService()\n+                .eventBuilder(AuditlogTypeIds.AUTHENTICATION_CLIENT)\n+                .message(\"Client connection authentication.\")\n+                .addParameter(\"connection\", connection)", "originalCommit": "b63e3a311cd0b451c42f759de2c6f1f9f637a010", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjgwMzEwNA==", "url": "https://github.com/hazelcast/hazelcast/pull/17123#discussion_r452803104", "bodyText": "I wouldn't call it leaking private API. We don't do any promise about specific types. Params are just objects. If the consuming class doesn't recognize the type, it should just use Object.toString().\nBy using this way we avoid possibly expensive toString calls when it's not necessary.", "author": "kwart", "createdAt": "2020-07-10T12:09:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDc5MzgzMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjgxOTAzNQ==", "url": "https://github.com/hazelcast/hazelcast/pull/17123#discussion_r452819035", "bodyText": "Just wondering, if a user implements some service and uses the methods on the Connection but we move the Connection class or remove it's methods in a patch release - is that ok? Is it something that we can warn users about? Like - you can downcast to specific parameter classes but it's still private API?", "author": "mmedenjak", "createdAt": "2020-07-10T12:43:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDc5MzgzMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDM3NTUwOA==", "url": "https://github.com/hazelcast/hazelcast/pull/17123#discussion_r454375508", "bodyText": "The warning will be added to EventBuilder javadoc.", "author": "kwart", "createdAt": "2020-07-14T13:56:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDc5MzgzMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDg0MjkxNw==", "url": "https://github.com/hazelcast/hazelcast/pull/17123#discussion_r450842917", "bodyText": "Can you also add some @Nullable or @Nonnull annotations to the parameters for reference? I guess it's not easy to determine in some cases as it depends on the concrete config class implementation.", "author": "mmedenjak", "createdAt": "2020-07-07T12:57:03Z", "path": "hazelcast/src/main/java/com/hazelcast/config/AbstractFactoryWithPropertiesConfig.java", "diffHunk": "@@ -0,0 +1,147 @@\n+/*\n+ * Copyright (c) 2008-2020, Hazelcast, Inc. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.config;\n+\n+import java.util.Objects;\n+import java.util.Properties;\n+\n+/**\n+ * Configuration base for config types with a factory class and its properties.\n+ *\n+ * @param <T> final child type\n+ */\n+public abstract class AbstractFactoryWithPropertiesConfig<T extends AbstractFactoryWithPropertiesConfig<T>> {\n+\n+    private boolean enabled;\n+    private String factoryClassName;\n+    private Properties properties = new Properties();\n+\n+    /**\n+     * Returns the factory class name.\n+     */\n+    public String getFactoryClassName() {\n+        return factoryClassName;\n+    }\n+\n+    /**\n+     * Sets the factory class name.\n+     */\n+    public T setFactoryClassName(String factoryClassName) {", "originalCommit": "b63e3a311cd0b451c42f759de2c6f1f9f637a010", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDg0NDEyNg==", "url": "https://github.com/hazelcast/hazelcast/pull/17123#discussion_r450844126", "bodyText": "I'm also thinking if we can somehow document (for example in AuditlogTypeIds) what are the parameters for each type, any maybe use some static strings for reference.", "author": "mmedenjak", "createdAt": "2020-07-07T12:58:55Z", "path": "hazelcast/src/main/java/com/hazelcast/client/impl/protocol/task/AuthenticationBaseMessageTask.java", "diffHunk": "@@ -126,14 +127,24 @@ private AuthenticationStatus authenticate() {\n \n     private AuthenticationStatus authenticate(SecurityContext securityContext) {\n         Connection connection = endpoint.getConnection();\n+        Boolean passed = Boolean.FALSE;\n         try {\n             LoginContext lc = securityContext.createClientLoginContext(clusterName, credentials, connection);\n             lc.login();\n             endpoint.setLoginContext(lc);\n+            passed = Boolean.TRUE;\n             return AUTHENTICATED;\n         } catch (LoginException e) {\n             logger.warning(e);\n             return CREDENTIALS_FAILED;\n+        } finally {\n+            nodeEngine.getNode().getNodeExtension().getAuditlogService()\n+                .eventBuilder(AuditlogTypeIds.AUTHENTICATION_CLIENT)\n+                .message(\"Client connection authentication.\")\n+                .addParameter(\"connection\", connection)\n+                .addParameter(\"credentials\", credentials)", "originalCommit": "b63e3a311cd0b451c42f759de2c6f1f9f637a010", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mjg0Njg0Mw==", "url": "https://github.com/hazelcast/hazelcast/pull/17123#discussion_r452846843", "bodyText": "I would rather avoid such commitments at least in the first iteration. If we see a demand for parameter specifications we can think about how to define names and assigned types in the next versions.", "author": "kwart", "createdAt": "2020-07-10T13:34:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDg0NDEyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzE3MTMyNw==", "url": "https://github.com/hazelcast/hazelcast/pull/17123#discussion_r453171327", "bodyText": "Sounds good. But we need to be explicit about this in the documentation then - the parameters are not public API yet and don't have guarantees. You can use the event ID and message and that's it.", "author": "mmedenjak", "createdAt": "2020-07-11T08:20:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDg0NDEyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDM2MTY1Ng==", "url": "https://github.com/hazelcast/hazelcast/pull/17123#discussion_r454361656", "bodyText": "I'll add a warning to EventBuilder class's JavaDoc.", "author": "kwart", "createdAt": "2020-07-14T13:37:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDg0NDEyNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDg0NTQwOQ==", "url": "https://github.com/hazelcast/hazelcast/pull/17123#discussion_r450845409", "bodyText": "Can you use com.hazelcast.internal.util.Preconditions#checkNotNull(T, java.lang.String) instead? It's commonly used in some other config files. It changes the thrown exception type though to NullPointerException.", "author": "mmedenjak", "createdAt": "2020-07-07T13:01:01Z", "path": "hazelcast/src/main/java/com/hazelcast/config/AbstractFactoryWithPropertiesConfig.java", "diffHunk": "@@ -0,0 +1,147 @@\n+/*\n+ * Copyright (c) 2008-2020, Hazelcast, Inc. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.config;\n+\n+import java.util.Objects;\n+import java.util.Properties;\n+\n+/**\n+ * Configuration base for config types with a factory class and its properties.\n+ *\n+ * @param <T> final child type\n+ */\n+public abstract class AbstractFactoryWithPropertiesConfig<T extends AbstractFactoryWithPropertiesConfig<T>> {\n+\n+    private boolean enabled;\n+    private String factoryClassName;\n+    private Properties properties = new Properties();\n+\n+    /**\n+     * Returns the factory class name.\n+     */\n+    public String getFactoryClassName() {\n+        return factoryClassName;\n+    }\n+\n+    /**\n+     * Sets the factory class name.\n+     */\n+    public T setFactoryClassName(String factoryClassName) {\n+        this.factoryClassName = factoryClassName;\n+        return self();\n+    }\n+\n+    /**\n+     * Returns if this configuration is enabled.\n+     *\n+     * @return {@code true} if enabled, {@code false} otherwise\n+     */\n+    public boolean isEnabled() {\n+        return enabled;\n+    }\n+\n+    /**\n+     * Enables and disables this configuration.\n+     *\n+     * @param enabled {@code true} to enable, {@code false} to disable\n+     */\n+    public T setEnabled(boolean enabled) {\n+        this.enabled = enabled;\n+        return self();\n+    }\n+\n+    /**\n+     * Sets a single property.\n+     *\n+     * @param name  the name of the property to set\n+     * @param value the value of the property to set\n+     * @return the updated SSLConfig\n+     * @throws NullPointerException if name or value is {@code null}\n+     */\n+    public T setProperty(String name, String value) {\n+        properties.put(name, value);\n+        return self();\n+    }\n+\n+    /**\n+     * Gets a property.\n+     *\n+     * @param name the name of the property to get\n+     * @return the value of the property, null if not found\n+     * @throws NullPointerException if name is {@code null}\n+     */\n+    public String getProperty(String name) {\n+        return properties.getProperty(name);\n+    }\n+\n+    /**\n+     * Gets all properties.\n+     *\n+     * @return the properties\n+     */\n+    public Properties getProperties() {\n+        return properties;\n+    }\n+\n+    /**\n+     * Sets the properties.\n+     *\n+     * @param properties the properties to set\n+     * @return the updated SSLConfig\n+     * @throws IllegalArgumentException if properties is {@code null}\n+     */\n+    public T setProperties(Properties properties) {\n+        if (properties == null) {", "originalCommit": "b63e3a311cd0b451c42f759de2c6f1f9f637a010", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjgxMjAwNg==", "url": "https://github.com/hazelcast/hazelcast/pull/17123#discussion_r452812006", "bodyText": "I guess I can't as the checkNotNull throws a NPE and setProperties throws the IAE.", "author": "kwart", "createdAt": "2020-07-10T12:29:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDg0NTQwOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzE3MTg2OA==", "url": "https://github.com/hazelcast/hazelcast/pull/17123#discussion_r453171868", "bodyText": "If this was the case already in 4.0 then yes, we can't change it. But if it's newly introduced config, I'd prefer checkNotNull as it's commonly used in public API.", "author": "mmedenjak", "createdAt": "2020-07-11T08:26:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDg0NTQwOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzE4OTMyNQ==", "url": "https://github.com/hazelcast/hazelcast/pull/17123#discussion_r453189325", "bodyText": "It's the old thingy from the SSLConfig - the AbstractFactoryWithPropertiesConfig is a new shared parent class to which some methods were moved from the SSLConfig.", "author": "kwart", "createdAt": "2020-07-11T12:16:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDg0NTQwOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDg2ODc5NA==", "url": "https://github.com/hazelcast/hazelcast/pull/17123#discussion_r450868794", "bodyText": "I guess we might also throw InvalidConfigurationException but then it would be different from the behaviour above. WDYT?", "author": "mmedenjak", "createdAt": "2020-07-07T13:35:26Z", "path": "hazelcast/src/main/java/com/hazelcast/instance/impl/DefaultNodeExtension.java", "diffHunk": "@@ -164,6 +165,12 @@ private void checkSecurityAllowed() {\n                 throw new IllegalStateException(\"Symmetric Encryption requires Hazelcast Enterprise Edition\");\n             }\n         }\n+        AuditlogConfig auditlogConfig = node.getConfig().getAuditlogConfig();\n+        if (auditlogConfig != null && auditlogConfig.isEnabled()) {\n+            if (!BuildInfoProvider.getBuildInfo().isEnterprise()) {\n+                throw new IllegalStateException(\"Auditlog requires Hazelcast Enterprise Edition\");", "originalCommit": "b63e3a311cd0b451c42f759de2c6f1f9f637a010", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjgxNDY5Ng==", "url": "https://github.com/hazelcast/hazelcast/pull/17123#discussion_r452814696", "bodyText": "This can be changed, but I would rather keep the reported exception in sync with other EE features (HR, persistence, security features).", "author": "kwart", "createdAt": "2020-07-10T12:34:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDg2ODc5NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDg3MTUxMg==", "url": "https://github.com/hazelcast/hazelcast/pull/17123#discussion_r450871512", "bodyText": "This is in the internal package, maybe I misunderstood that the SPI was public? The service is in internal too.", "author": "mmedenjak", "createdAt": "2020-07-07T13:39:21Z", "path": "hazelcast/src/main/java/com/hazelcast/internal/auditlog/AuditlogServiceFactory.java", "diffHunk": "@@ -0,0 +1,40 @@\n+/*\n+ * Copyright (c) 2008-2020, Hazelcast, Inc. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.internal.auditlog;", "originalCommit": "b63e3a311cd0b451c42f759de2c6f1f9f637a010", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjgxODYzOA==", "url": "https://github.com/hazelcast/hazelcast/pull/17123#discussion_r452818638", "bodyText": "Good point. Totally forgot about moving it into the wildness in 4.1. :) It was intentionally internal in 4.0 but it should be public now so I'll move the package out of the *.internal", "author": "kwart", "createdAt": "2020-07-10T12:42:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDg3MTUxMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDg3Mjg5Mg==", "url": "https://github.com/hazelcast/hazelcast/pull/17123#discussion_r450872892", "bodyText": "Do we want to log which member joined?", "author": "mmedenjak", "createdAt": "2020-07-07T13:41:23Z", "path": "hazelcast/src/main/java/com/hazelcast/internal/cluster/impl/ClusterServiceImpl.java", "diffHunk": "@@ -400,7 +401,11 @@ public boolean finalizeJoin(MembersView membersView, Address callerAddress, UUID\n             membershipManager.updateMembers(membersView);\n             clusterHeartbeatManager.heartbeat();\n             setJoined(true);\n-\n+            node.getNodeExtension().getAuditlogService()\n+                .eventBuilder(AuditlogTypeIds.CLUSTER_MEMBER_ADDED)\n+                .message(\"Member joined\")\n+                .addParameter(\"membersView\", membersView)", "originalCommit": "b63e3a311cd0b451c42f759de2c6f1f9f637a010", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDM4ODc1Ng==", "url": "https://github.com/hazelcast/hazelcast/pull/17123#discussion_r454388756", "bodyText": "\ud83d\udc4d I'll add it as new parameter: address", "author": "kwart", "createdAt": "2020-07-14T14:15:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDg3Mjg5Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDg3MzI0OQ==", "url": "https://github.com/hazelcast/hazelcast/pull/17123#discussion_r450873249", "bodyText": "Do we want to log which member?", "author": "mmedenjak", "createdAt": "2020-07-07T13:41:54Z", "path": "hazelcast/src/main/java/com/hazelcast/internal/cluster/impl/ClusterServiceImpl.java", "diffHunk": "@@ -990,7 +998,12 @@ public void promoteLocalLiteMember() {\n             }\n \n             MemberImpl localMemberInMemberList = membershipManager.getMember(member.getAddress());\n-            if (localMemberInMemberList.isLiteMember()) {\n+            boolean result = localMemberInMemberList.isLiteMember();\n+            node.getNodeExtension().getAuditlogService().eventBuilder(AuditlogTypeIds.CLUSTER_PROMOTE_MEMBER)\n+                .message(\"Promotion of the lite member\")\n+                .addParameter(\"success\", result)", "originalCommit": "b63e3a311cd0b451c42f759de2c6f1f9f637a010", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDg3NDE0OA==", "url": "https://github.com/hazelcast/hazelcast/pull/17123#discussion_r450874148", "bodyText": "Do you want to log if it was added or removed?", "author": "mmedenjak", "createdAt": "2020-07-07T13:43:12Z", "path": "hazelcast/src/main/java/com/hazelcast/internal/cluster/impl/MembershipManager.java", "diffHunk": "@@ -789,6 +803,11 @@ private void sortMembersInMembershipOrder(List<Member> members) {\n \n     private void sendMembershipEventNotifications(MemberImpl member, Set<Member> members, final boolean added) {\n         int eventType = added ? MembershipEvent.MEMBER_ADDED : MembershipEvent.MEMBER_REMOVED;\n+        node.getNodeExtension().getAuditlogService()\n+                .eventBuilder(added ? AuditlogTypeIds.CLUSTER_MEMBER_ADDED : AuditlogTypeIds.CLUSTER_MEMBER_REMOVED)\n+                .message(\"Membership changed\")\n+                .addParameter(\"memberAddress\", member.getAddress())", "originalCommit": "b63e3a311cd0b451c42f759de2c6f1f9f637a010", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjgyODc0OA==", "url": "https://github.com/hazelcast/hazelcast/pull/17123#discussion_r452828748", "bodyText": "Do you mean to have it in the message too? Currently, the add and remove types are differentiated in typeId().", "author": "kwart", "createdAt": "2020-07-10T13:02:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDg3NDE0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzE3MTUyMA==", "url": "https://github.com/hazelcast/hazelcast/pull/17123#discussion_r453171520", "bodyText": "Ah, right, missed that, thanks.", "author": "mmedenjak", "createdAt": "2020-07-11T08:22:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDg3NDE0OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDg3NDQ2Nw==", "url": "https://github.com/hazelcast/hazelcast/pull/17123#discussion_r450874467", "bodyText": "Minor - typo: fillFactoryWithPropertiesCofnig -> fillFactoryWithPropertiesConfig", "author": "mmedenjak", "createdAt": "2020-07-07T13:43:43Z", "path": "hazelcast/src/main/java/com/hazelcast/internal/config/AbstractDomConfigProcessor.java", "diffHunk": "@@ -226,21 +227,24 @@ protected ClassFilter parseClassFilterList(Node node) {\n     }\n \n     protected SSLConfig parseSslConfig(Node node) {\n-        SSLConfig sslConfig = new SSLConfig();\n+        return fillFactoryWithPropertiesCofnig(node, new SSLConfig());", "originalCommit": "b63e3a311cd0b451c42f759de2c6f1f9f637a010", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDg3NTUyMg==", "url": "https://github.com/hazelcast/hazelcast/pull/17123#discussion_r450875522", "bodyText": "I guess we should make clear in the documentation that these invocations are done in performance sensitive places so the logger appender should not do anything too heavy.", "author": "mmedenjak", "createdAt": "2020-07-07T13:45:14Z", "path": "hazelcast/src/main/java/com/hazelcast/internal/server/tcp/TcpServerAcceptor.java", "diffHunk": "@@ -288,7 +289,12 @@ private void newConnection(final EndpointQualifier qualifier, SocketChannel sock\n             if (logger.isFineEnabled()) {\n                 logger.fine(\"Accepting socket connection from \" + channel.socket().getRemoteSocketAddress());\n             }\n-\n+            serverContext.getAuditLogService()\n+                .eventBuilder(AuditlogTypeIds.NETWORK_CONNECT)\n+                .message(\"New connection accepted.\")", "originalCommit": "b63e3a311cd0b451c42f759de2c6f1f9f637a010", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mjg0NDEyNA==", "url": "https://github.com/hazelcast/hazelcast/pull/17123#discussion_r452844124", "bodyText": "I'll add a note to the AuditloService javadoc.", "author": "kwart", "createdAt": "2020-07-10T13:30:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDg3NTUyMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDg3NjUwOQ==", "url": "https://github.com/hazelcast/hazelcast/pull/17123#discussion_r450876509", "bodyText": "What if any users were already using this property to set it to true?", "author": "mmedenjak", "createdAt": "2020-07-07T13:46:39Z", "path": "hazelcast/src/main/java/com/hazelcast/spi/properties/ClusterProperty.java", "diffHunk": "@@ -1029,8 +1029,6 @@ private int getWhenNoSSLDetected() {\n     public static final HazelcastProperty CLIENT_PROTOCOL_UNVERIFIED_MESSAGE_BYTES =\n             new HazelcastProperty(\"hazelcast.client.protocol.max.message.bytes\", 4096);\n \n-    public static final HazelcastProperty AUDIT_LOG_ENABLED = new HazelcastProperty(\"hazelcast.auditlog.enabled\", false);", "originalCommit": "b63e3a311cd0b451c42f759de2c6f1f9f637a010", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mjg0MzI2Mw==", "url": "https://github.com/hazelcast/hazelcast/pull/17123#discussion_r452843263", "bodyText": "It's not a documented property. It was intended only for API testing.\nI would rather see it removed, but if you think it can cause troubles we can leave it unused and just mark it deprecated.", "author": "kwart", "createdAt": "2020-07-10T13:28:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDg3NjUwOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzE3MTQ5MQ==", "url": "https://github.com/hazelcast/hazelcast/pull/17123#discussion_r453171491", "bodyText": "If it wasn't documented in the reference manual and if it was intended for testing, I think we can remove it.", "author": "mmedenjak", "createdAt": "2020-07-11T08:21:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDg3NjUwOQ=="}], "type": "inlineReview"}, {"oid": "dc86f17c615f05d077c0d13c50bfdf69668876f9", "url": "https://github.com/hazelcast/hazelcast/commit/dc86f17c615f05d077c0d13c50bfdf69668876f9", "message": "Add auditable events.", "committedDate": "2020-07-09T08:31:54Z", "type": "forcePushed"}, {"oid": "bf79c129f6b8b11728afcefba39c39e49b4e63dc", "url": "https://github.com/hazelcast/hazelcast/commit/bf79c129f6b8b11728afcefba39c39e49b4e63dc", "message": "fix checkstyle", "committedDate": "2020-07-10T14:29:42Z", "type": "forcePushed"}, {"oid": "343fd272279ea09e398d062bbc04330b6b0f02d2", "url": "https://github.com/hazelcast/hazelcast/commit/343fd272279ea09e398d062bbc04330b6b0f02d2", "message": "Cover review comments", "committedDate": "2020-07-14T14:30:19Z", "type": "forcePushed"}, {"oid": "53067846f680667c85061607e89c6b56c706cd2f", "url": "https://github.com/hazelcast/hazelcast/commit/53067846f680667c85061607e89c6b56c706cd2f", "message": "Implement review comments", "committedDate": "2020-07-21T11:10:39Z", "type": "forcePushed"}, {"oid": "a9c9f3678173970d4d9d27a330bc947c2d6bb465", "url": "https://github.com/hazelcast/hazelcast/commit/a9c9f3678173970d4d9d27a330bc947c2d6bb465", "message": "Add auditable events.", "committedDate": "2020-07-24T12:56:58Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzExOTA3Nw==", "url": "https://github.com/hazelcast/hazelcast/pull/17123#discussion_r467119077", "bodyText": "Shouldn't this be AuditlogTypeIds.CLUSTER_MEMBER_REMOVED?", "author": "mmedenjak", "createdAt": "2020-08-07T15:41:49Z", "path": "hazelcast/src/main/java/com/hazelcast/internal/cluster/impl/MembershipManager.java", "diffHunk": "@@ -706,13 +714,19 @@ private void removeMember(MemberImpl member, String reason, boolean shouldCloseC\n             }\n \n             logger.info(\"Removing \" + member);\n-            clusterService.getClusterJoinManager().removeJoin(member.getAddress());\n+            clusterService.getClusterJoinManager().removeJoin(address);\n             clusterService.getClusterHeartbeatManager().removeMember(member);\n             partialDisconnectionHandler.removeMember(member);\n \n             MemberMap newMembers = MemberMap.cloneExcluding(currentMembers, member);\n             setMembers(newMembers);\n \n+            node.getNodeExtension().getAuditlogService().eventBuilder(AuditlogTypeIds.CLUSTER_MEMBER_SUSPECTED)", "originalCommit": "a9c9f3678173970d4d9d27a330bc947c2d6bb465", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "5e697f697126bd56654d34b88fe652616451f02a", "url": "https://github.com/hazelcast/hazelcast/commit/5e697f697126bd56654d34b88fe652616451f02a", "message": "Add auditable events.", "committedDate": "2020-08-10T09:00:06Z", "type": "commit"}, {"oid": "a37de59e6caba89d04c49067b8c19631ae4f5fc4", "url": "https://github.com/hazelcast/hazelcast/commit/a37de59e6caba89d04c49067b8c19631ae4f5fc4", "message": "Fix ChangeLoggingRule", "committedDate": "2020-08-10T09:11:09Z", "type": "forcePushed"}, {"oid": "08b986514ebb6f9c08167e5fbde76cae25e6de45", "url": "https://github.com/hazelcast/hazelcast/commit/08b986514ebb6f9c08167e5fbde76cae25e6de45", "message": "Fix ChangeLoggingRule", "committedDate": "2020-08-10T09:33:15Z", "type": "commit"}, {"oid": "08b986514ebb6f9c08167e5fbde76cae25e6de45", "url": "https://github.com/hazelcast/hazelcast/commit/08b986514ebb6f9c08167e5fbde76cae25e6de45", "message": "Fix ChangeLoggingRule", "committedDate": "2020-08-10T09:33:15Z", "type": "forcePushed"}]}