{"pr_number": 17702, "pr_title": "Add support for processing WAN replication messages from 3.x members", "pr_createdAt": "2020-10-08T10:00:06Z", "pr_url": "https://github.com/hazelcast/hazelcast/pull/17702", "timeline": [{"oid": "840a1668bccab23acfabb3ad3db46e29ab38d119", "url": "https://github.com/hazelcast/hazelcast/commit/840a1668bccab23acfabb3ad3db46e29ab38d119", "message": "Add support for processing WAN replication messages from 3.x members\n\nAdds support on PASSIVE (target) cluster to be able to deserialize and\nprocess WAN replication events from a 3.x ACTIVE (source) cluster.\n\nCo-authored-by: Vassilis Bekiaris <vbekiaris@gmail.com>", "committedDate": "2020-10-08T09:20:11Z", "type": "commit"}, {"oid": "9a64f1cc3f919b03f27d589974b21a828110d56b", "url": "https://github.com/hazelcast/hazelcast/commit/9a64f1cc3f919b03f27d589974b21a828110d56b", "message": "Change compatibility matching rule (#17025)\n\nChange compatibility matching rule\r\n\r\nWe change the rule which determines if a packet was sent by a member of\r\nanother major version. Previously, we were looking for the existence of\r\na flag on the Packet which meant the sender needed to be at least 3.12.8\r\nor 4.0.2. This places a restriction on the source cluster when migrating\r\nfrom 3.12 to 4.0 which means users need to perform a rolling restart of\r\nall source cluster members to 3.12.8 before migrating data.\r\n\r\nInstead, we change the rule to determine that a packet was sent if\r\nanother flag is missing. This removes the restriction on the source\r\ncluster but places another restriction on the target cluster.\r\nRegardless, this is much simpler for actual migration scenarios - now\r\nusers probably don't need to do any kind of restart of the source\r\ncluster and may only set up the target cluster appropriately after which\r\nthey can add the WAN configuration between the two clusters dynamically.\r\n\r\nThis also means that now the migration members must not be members of\r\nthe same cluster with members not setting the FLAG_4_0, which means they\r\ncannot coexist in the same cluster with 4.0.1 and 4.2+ members. This is\r\nalso ok because \"migration\" members may easily be started alongside\r\n4.0.2 members and may simply be shut down before rolling up to 4.2.\r\n\r\nUnfortunately we cannot make a compatibility test for this scenario as\r\nit requires a wide range of versions running inside a single JVM, namely\r\n4.0.2, 4.0.2-migration and 3.12.1 while the compatibility guardian\r\nframework assumes it will need to translate only between two versions -\r\nthe current codebase version and another version. The migration scenario\r\nwas tested manually:\r\n- started two 3.12.1 members\r\n- started two 4.0.2 members\r\n- started a lite 4.0.2-migration member\r\n- added dynamic WAN configuration between 3.12.1 and 4.0.2-migration\r\n- added data in 3.12.1 cluster\r\n- asserted data is in 4.0.2 members, shutdown 3.12.1 and 4.0.2-migration", "committedDate": "2020-10-08T09:20:39Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjA0MjA3OA==", "url": "https://github.com/hazelcast/hazelcast/pull/17702#discussion_r502042078", "bodyText": "Does 4.1 set it?", "author": "blazember", "createdAt": "2020-10-08T22:14:39Z", "path": "hazelcast/src/main/java/com/hazelcast/internal/nio/tcp/TcpIpEndpointManager.java", "diffHunk": "@@ -176,7 +178,16 @@ public void addConnectionListener(ConnectionListener listener) {\n \n     @Override\n     public synchronized void accept(Packet packet) {\n-        bindHandler.process(packet);\n+        // the packet was sent from 3.12 if the 4_0 flag is missing\n+        // 4.0.1 and 4.2 members do not set this flag", "originalCommit": "9a64f1cc3f919b03f27d589974b21a828110d56b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDY5ODgxMQ==", "url": "https://github.com/hazelcast/hazelcast/pull/17702#discussion_r510698811", "bodyText": "Whoops, good catch. I'll send a PR for master.", "author": "mmedenjak", "createdAt": "2020-10-23T07:49:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjA0MjA3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzU5ODc2OA==", "url": "https://github.com/hazelcast/hazelcast/pull/17702#discussion_r513598768", "bodyText": "Fixed with #17756", "author": "mmedenjak", "createdAt": "2020-10-28T16:43:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjA0MjA3OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjA0NTExMg==", "url": "https://github.com/hazelcast/hazelcast/pull/17702#discussion_r502045112", "bodyText": "Same question with 4.1.", "author": "blazember", "createdAt": "2020-10-08T22:22:33Z", "path": "hazelcast/src/main/java/com/hazelcast/spi/impl/operationservice/impl/OperationRunnerImpl.java", "diffHunk": "@@ -404,7 +405,15 @@ public void run(Packet packet) throws Exception {\n         Connection connection = packet.getConn();\n         Address caller = connection.getEndPoint();\n         try {\n-            Object object = nodeEngine.toObject(packet);\n+            // the packet was sent from 3.12 if the 4_0 flag is missing\n+            // 4.0.1 and 4.2 members do not set this flag", "originalCommit": "9a64f1cc3f919b03f27d589974b21a828110d56b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDY5OTA4MQ==", "url": "https://github.com/hazelcast/hazelcast/pull/17702#discussion_r510699081", "bodyText": "Same as other comment, I need to add it on master but this PR seems good to go.", "author": "mmedenjak", "createdAt": "2020-10-23T07:50:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjA0NTExMg=="}], "type": "inlineReview"}]}