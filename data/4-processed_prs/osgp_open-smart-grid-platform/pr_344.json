{"pr_number": 344, "pr_title": "FLEX-5395 Add configuration of IP addresses that may be duplicated", "pr_createdAt": "2020-06-08T15:53:41Z", "pr_url": "https://github.com/OSGP/open-smart-grid-platform/pull/344", "timeline": [{"oid": "56b7c72f09832eeaabd641ed87d58f8d3a564dcc", "url": "https://github.com/OSGP/open-smart-grid-platform/commit/56b7c72f09832eeaabd641ed87d58f8d3a564dcc", "message": "FLEX-5395 ~ Adds configuration of IP addresses that may be duplicated\n\nUpon device registration, the IP address of the registered device is\nremoved in the database for other devices where it is configured (with\nthe exception of the loopback address - localhost / 127.0.0.1).\n\nThese changes allow to either configure that such clean up should never\nbe performed (allowing multiple devices to share any network address),\nor to configure a comma separated list of IP addresses or IP address\nranges that may be shared (for instance\n\"192.168.0.1,192.168.1.12-192.168.2.103\" to allow sharing of 192.168.0.1\nor any IP address from 192.168.1.12 to 192.168.2.103 inclusive).", "committedDate": "2020-06-08T15:52:10Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzE2ODc0Mg==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/344#discussion_r437168742", "bodyText": "A bit strange to put this in setUp, while it is overridden in a lot of tests", "author": "robindenadel", "createdAt": "2020-06-09T06:35:55Z", "path": "osgp/platform/osgp-core/src/test/java/org/opensmartgridplatform/core/application/services/DeviceNetworkAddressCleanupServiceTest.java", "diffHunk": "@@ -0,0 +1,168 @@\n+/**\n+ * Copyright 2020 Smart Society Services B.V.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ */\n+package org.opensmartgridplatform.core.application.services;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.ArgumentMatchers.any;\n+import static org.mockito.Mockito.never;\n+import static org.mockito.Mockito.times;\n+import static org.mockito.Mockito.verify;\n+import static org.mockito.Mockito.when;\n+\n+import java.net.InetAddress;\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.stream.Collectors;\n+\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.extension.ExtendWith;\n+import org.mockito.ArgumentCaptor;\n+import org.mockito.Mockito;\n+import org.mockito.MockitoAnnotations;\n+import org.mockito.junit.jupiter.MockitoExtension;\n+import org.opensmartgridplatform.domain.core.entities.Device;\n+import org.opensmartgridplatform.domain.core.repositories.DeviceRepository;\n+\n+@ExtendWith(MockitoExtension.class)\n+public class DeviceNetworkAddressCleanupServiceTest {\n+\n+    private DeviceRepository deviceRepository;\n+    private DeviceNetworkAddressCleanupService deviceNetworkAddressCleanupService;\n+\n+    @BeforeEach\n+    public void setUp() {\n+        this.deviceRepository = Mockito.mock(DeviceRepository.class);\n+        final boolean allowMultipleDevicesPerNetworkAddress = false;\n+        final List<String> ipRangesAllowingMultipleDevicesPerAddress = Collections.emptyList();\n+        this.deviceNetworkAddressCleanupService = new DeviceNetworkAddressCleanupService(this.deviceRepository,", "originalCommit": "56b7c72f09832eeaabd641ed87d58f8d3a564dcc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzQyNTY3Ng==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/344#discussion_r437425676", "bodyText": "I changed the way the setup is handled, so this default before-each that is hardly ever used is no longer applied.", "author": "bvdzwet", "createdAt": "2020-06-09T13:40:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzE2ODc0Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzE3NTU5Mw==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/344#discussion_r437175593", "bodyText": "You could consider making constants of these variables, since they are used in almost every test", "author": "robindenadel", "createdAt": "2020-06-09T06:52:30Z", "path": "osgp/platform/osgp-core/src/test/java/org/opensmartgridplatform/core/application/services/DeviceNetworkAddressCleanupServiceTest.java", "diffHunk": "@@ -0,0 +1,168 @@\n+/**\n+ * Copyright 2020 Smart Society Services B.V.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ */\n+package org.opensmartgridplatform.core.application.services;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.ArgumentMatchers.any;\n+import static org.mockito.Mockito.never;\n+import static org.mockito.Mockito.times;\n+import static org.mockito.Mockito.verify;\n+import static org.mockito.Mockito.when;\n+\n+import java.net.InetAddress;\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.stream.Collectors;\n+\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.extension.ExtendWith;\n+import org.mockito.ArgumentCaptor;\n+import org.mockito.Mockito;\n+import org.mockito.MockitoAnnotations;\n+import org.mockito.junit.jupiter.MockitoExtension;\n+import org.opensmartgridplatform.domain.core.entities.Device;\n+import org.opensmartgridplatform.domain.core.repositories.DeviceRepository;\n+\n+@ExtendWith(MockitoExtension.class)\n+public class DeviceNetworkAddressCleanupServiceTest {\n+\n+    private DeviceRepository deviceRepository;\n+    private DeviceNetworkAddressCleanupService deviceNetworkAddressCleanupService;\n+\n+    @BeforeEach\n+    public void setUp() {\n+        this.deviceRepository = Mockito.mock(DeviceRepository.class);\n+        final boolean allowMultipleDevicesPerNetworkAddress = false;\n+        final List<String> ipRangesAllowingMultipleDevicesPerAddress = Collections.emptyList();\n+        this.deviceNetworkAddressCleanupService = new DeviceNetworkAddressCleanupService(this.deviceRepository,\n+                allowMultipleDevicesPerNetworkAddress, ipRangesAllowingMultipleDevicesPerAddress);\n+        MockitoAnnotations.initMocks(this);\n+    }\n+\n+    @Test\n+    public void duplicateAddressesAreAllowedForLoopbackAddresses() throws Exception {\n+        assertThat(this.deviceNetworkAddressCleanupService.allowDuplicateEntries(InetAddress.getLoopbackAddress()))\n+                .isTrue();\n+    }\n+\n+    @Test\n+    public void noDevicesAreUpdatedWhenTheNetworkAddressIsNotUsed() throws Exception {\n+        final String host = \"192.168.0.13\";\n+        final InetAddress inetAddress = InetAddress.getByName(host);", "originalCommit": "56b7c72f09832eeaabd641ed87d58f8d3a564dcc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzQyODg3MA==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/344#discussion_r437428870", "bodyText": "I changed the way the host and InetAddress are configured in the tests, making some use of constants. In general I don't think we should be too eager to extract as much as possible from test code, as this can make the separate tests harder to understand looking at them in isolation, without tracing other parts of the code. I hope you are OK with the balance I tried to find here.", "author": "bvdzwet", "createdAt": "2020-06-09T13:44:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzE3NTU5Mw=="}], "type": "inlineReview"}, {"oid": "bf45d446f5a24d1182cd56bec840315bc77308c7", "url": "https://github.com/OSGP/open-smart-grid-platform/commit/bf45d446f5a24d1182cd56bec840315bc77308c7", "message": "FLEX-5395 ~ Only allows 127.0.0.1 as duplicate network address\n\nBy default only allow 127.0.0.1 to be used as network address with\nmultiple registered devices simultaneously. Allowing all loopback\naddresses (127.*.*.*) to have duplicates caused some Cucumber test\ndepending on network address cleanup for other loopback addresses to\nfail.\nIt is still possible by changing configuration to allow IP addresses to\nbe shared between devices for all addresses or for specific ranges.\n\nAddresses some review comments about the setup in the test code, where\nsetup with before-each was overridden in most test cases, and some\nspecific values were used in most of the tests.\n\nSimplified code for InetAddress in DeviceRegistrationMessageService.\nInetAddress.getByName(\"127.0.0.1\") works just fine, while\nInetAddress.getLoopbackAddress() could return other values than\n127.0.0.1 according to its documentation (even though the current\nimplementation does return 127.0.0.1).", "committedDate": "2020-06-09T13:36:00Z", "type": "commit"}]}