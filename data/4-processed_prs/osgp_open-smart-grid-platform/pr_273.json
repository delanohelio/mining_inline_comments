{"pr_number": 273, "pr_title": "Feature/flex 5299 protocol adapter iec60870 general interrogation", "pr_createdAt": "2020-04-08T13:24:09Z", "pr_url": "https://github.com/OSGP/open-smart-grid-platform/pull/273", "timeline": [{"oid": "8c90a3359b9d5b349406d70fd92857bb94140e83", "url": "https://github.com/OSGP/open-smart-grid-platform/commit/8c90a3359b9d5b349406d70fd92857bb94140e83", "message": "Updates pom files for JDK11 compliancy", "committedDate": "2020-03-30T12:38:31Z", "type": "commit"}, {"oid": "a57f5e56f5ba564ea3275cd8b69a513ad07613e0", "url": "https://github.com/OSGP/open-smart-grid-platform/commit/a57f5e56f5ba564ea3275cd8b69a513ad07613e0", "message": "Updates some poms to fix sonar rule about order of pom elements\n\n\"pom elements should be in the recommended order (squid:S3423)\"", "committedDate": "2020-03-30T12:54:31Z", "type": "commit"}, {"oid": "09a27a249541a6c197332d7c5576d1d6fcacdfdf", "url": "https://github.com/OSGP/open-smart-grid-platform/commit/09a27a249541a6c197332d7c5576d1d6fcacdfdf", "message": "FLEX-5299 ~ Adds initial implementation for general interrogation", "committedDate": "2020-04-03T12:17:14Z", "type": "commit"}, {"oid": "5d020d030eae29f8feb4faee9adee5564b087861", "url": "https://github.com/OSGP/open-smart-grid-platform/commit/5d020d030eae29f8feb4faee9adee5564b087861", "message": "FLEX-5299 ~ Adds DTOs", "committedDate": "2020-04-03T12:18:16Z", "type": "commit"}, {"oid": "9047962c1b6f463d22785bf51e7b3b88ecd90041", "url": "https://github.com/OSGP/open-smart-grid-platform/commit/9047962c1b6f463d22785bf51e7b3b88ecd90041", "message": "FLEX-5299 ~ Refactors protocol adapter\n\nUse a single set of ASDU handlers for all device types,\nhandle measurement reports by device specific service classes", "committedDate": "2020-04-07T14:03:22Z", "type": "commit"}, {"oid": "fd20e1347830f6510562e8e4c01cd029b7dff2e0", "url": "https://github.com/OSGP/open-smart-grid-platform/commit/fd20e1347830f6510562e8e4c01cd029b7dff2e0", "message": "FLEX-5299 ~ Implements get light sensor status in iec60870 protocol adapter", "committedDate": "2020-04-08T13:19:04Z", "type": "commit"}, {"oid": "b4a2c2eebb3b745718bce3e233037ffdbaaeeac2", "url": "https://github.com/OSGP/open-smart-grid-platform/commit/b4a2c2eebb3b745718bce3e233037ffdbaaeeac2", "message": "Merge branch 'development' into feature/FLEX-5299-protocol-adapter-iec60870-general-interrogation", "committedDate": "2020-04-08T13:20:33Z", "type": "commit"}, {"oid": "3a7acd7db81de20ea9049018b70110bdcd062039", "url": "https://github.com/OSGP/open-smart-grid-platform/commit/3a7acd7db81de20ea9049018b70110bdcd062039", "message": "FLEX-5299 ~ Fixes two sonar issues", "committedDate": "2020-04-08T13:58:58Z", "type": "commit"}, {"oid": "ec6d2658503c47a8ed7abf5000fd7a81f813951d", "url": "https://github.com/OSGP/open-smart-grid-platform/commit/ec6d2658503c47a8ed7abf5000fd7a81f813951d", "message": "Merge branch 'development' into feature/FLEX-5299-protocol-adapter-iec60870-general-interrogation\n\nosgp/protocol-adapter-iec60870/osgp-protocol-adapter-iec60870/src/integration-test/java/org/opensmartgridplatform/adapter/protocol/iec60870/integrationtests/config/TestConfiguration.java\nosgp/protocol-adapter-iec60870/osgp-protocol-adapter-iec60870/src/main/java/org/opensmartgridplatform/adapter/protocol/iec60870/domain/services/ClientAsduHandlerImpl.java\nosgp/protocol-adapter-iec60870/osgp-protocol-adapter-iec60870/src/main/java/org/opensmartgridplatform/adapter/protocol/iec60870/domain/services/ClientConnectionEventListener.java\nosgp/protocol-adapter-iec60870/osgp-protocol-adapter-iec60870/src/test/java/org/opensmartgridplatform/adapter/protocol/iec60870/domain/services/ClientConnectionEventListenerTest.java", "committedDate": "2020-04-08T14:20:04Z", "type": "commit"}, {"oid": "fe0b7ca82a87fe498e297f0643379226e04bdc57", "url": "https://github.com/OSGP/open-smart-grid-platform/commit/fe0b7ca82a87fe498e297f0643379226e04bdc57", "message": "FLEX-5299 ~ Adds db migration script for new Iec60870Device fields", "committedDate": "2020-04-08T14:47:40Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTcwNTgxMw==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r405705813", "bodyText": "Any reason this is not private, like the other fields?", "author": "bvdzwet", "createdAt": "2020-04-08T17:50:54Z", "path": "osgp/protocol-adapter-iec60870/osgp-protocol-adapter-iec60870/src/integration-test/java/org/opensmartgridplatform/adapter/protocol/iec60870/integrationtests/TestContextConfiguration.java", "diffHunk": "@@ -0,0 +1,43 @@\n+/**\n+ * Copyright 2019 Smart Society Services B.V.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ */\n+package org.opensmartgridplatform.adapter.protocol.iec60870.integrationtests;\n+\n+import static org.mockito.Mockito.reset;\n+\n+import org.openmuc.j60870.Connection;\n+import org.opensmartgridplatform.adapter.protocol.iec60870.infra.messaging.DeviceResponseMessageSender;\n+import org.opensmartgridplatform.adapter.protocol.iec60870.infra.messaging.LogItemRequestMessageSender;\n+import org.opensmartgridplatform.adapter.protocol.iec60870.integrationtests.config.InboundRequestsTestConfiguration;\n+import org.opensmartgridplatform.adapter.protocol.iec60870.integrationtests.config.LogItemTestConfiguration;\n+import org.opensmartgridplatform.adapter.protocol.iec60870.integrationtests.config.OutboundResponsesTestConfiguration;\n+import org.opensmartgridplatform.adapter.protocol.iec60870.integrationtests.config.TestConfiguration;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.beans.factory.annotation.Qualifier;\n+import org.springframework.test.context.ContextConfiguration;\n+\n+import io.cucumber.java.Before;\n+\n+@ContextConfiguration(classes = { TestConfiguration.class, InboundRequestsTestConfiguration.class,\n+        OutboundResponsesTestConfiguration.class, LogItemTestConfiguration.class })\n+public class TestContextConfiguration {\n+\n+    @Autowired\n+    LogItemRequestMessageSender logItemRequestMessageSenderMock;", "originalCommit": "fe0b7ca82a87fe498e297f0643379226e04bdc57", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTcxMDU3OQ==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r405710579", "bodyText": "I know it would not look very nice, but wouldn't it be more logical if this was named getGetHealthStatusRequestMessageProcessor? (Same for the GetLightSensorStatusRequestMessageProcessor bean below.)\nIf it was a conscious decision not to use getGet, you can leave it as is I guess.", "author": "bvdzwet", "createdAt": "2020-04-08T17:58:56Z", "path": "osgp/protocol-adapter-iec60870/osgp-protocol-adapter-iec60870/src/integration-test/java/org/opensmartgridplatform/adapter/protocol/iec60870/integrationtests/config/InboundRequestsTestConfiguration.java", "diffHunk": "@@ -0,0 +1,56 @@\n+/**\n+ * Copyright 2020 Smart Society Services B.V.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ */\n+package org.opensmartgridplatform.adapter.protocol.iec60870.integrationtests.config;\n+\n+import static org.mockito.Mockito.mock;\n+\n+import javax.jms.ConnectionFactory;\n+\n+import org.apache.activemq.jms.pool.PooledConnectionFactory;\n+import org.opensmartgridplatform.adapter.protocol.iec60870.infra.messaging.DeviceRequestMessageListener;\n+import org.opensmartgridplatform.adapter.protocol.iec60870.infra.messaging.processors.ConnectRequestMessageProcessor;\n+import org.opensmartgridplatform.adapter.protocol.iec60870.infra.messaging.processors.GetHealthStatusRequestMessageProcessor;\n+import org.opensmartgridplatform.adapter.protocol.iec60870.infra.messaging.processors.GetLightSensorStatusRequestMessageProcessor;\n+import org.opensmartgridplatform.shared.infra.jms.BaseMessageProcessorMap;\n+import org.opensmartgridplatform.shared.infra.jms.MessageProcessorMap;\n+import org.springframework.context.annotation.Bean;\n+import org.springframework.context.annotation.Configuration;\n+\n+@Configuration\n+public class InboundRequestsTestConfiguration {\n+\n+    @Bean(name = \"protocolIec60870InboundOsgpCoreRequestsConnectionFactory\")\n+    public ConnectionFactory iec60870RequestsConnectionFactory() {\n+        return mock(PooledConnectionFactory.class);\n+    }\n+\n+    @Bean(name = \"protocolIec60870InboundOsgpCoreRequestsMessageListener\")\n+    public DeviceRequestMessageListener iec60870RequestsMessageListener() {\n+        return new DeviceRequestMessageListener();\n+    }\n+\n+    @Bean(name = \"protocolIec60870InboundOsgpCoreRequestsMessageProcessorMap\")\n+    public MessageProcessorMap iec60870RequestMessageProcessorMap() {\n+        return new BaseMessageProcessorMap(\"protocolIec60870InboundOsgpCoreRequestsMessageProcessorMap\");\n+    }\n+\n+    @Bean\n+    public ConnectRequestMessageProcessor connectRequestMessageProcessor() {\n+        return new ConnectRequestMessageProcessor();\n+    }\n+\n+    @Bean\n+    public GetHealthStatusRequestMessageProcessor getHealthStatusRequestMessageProcessor() {", "originalCommit": "fe0b7ca82a87fe498e297f0643379226e04bdc57", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTU5MzYwNQ==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r409593605", "bodyText": "Why? It is the message processor for GetHealthStatus requests not for getGetHealthStatus requests? Furthermore I believe we never add an additonal \"get\" for bean definitions?\nMaybe you're confused with something like a getGetStatusResponse method used for getting the GetStatusResponse?", "author": "smvdheijden", "createdAt": "2020-04-16T14:18:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTcxMDU3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTYwMjMwNg==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r409602306", "bodyText": "I agree, if get is not used with the beans it should not be duplicated here, my bad.", "author": "bvdzwet", "createdAt": "2020-04-16T14:29:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTcxMDU3OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTcxOTExNw==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r405719117", "bodyText": "This works fine, but given this class already uses Cucumber expressions, I'd favor those over regex configuration unless there is a clear advantage to using the regex.\nYou could consider dropping the ^, $ and replacing the part after device with {string} like in the whenIReceiveAduOfType step.", "author": "bvdzwet", "createdAt": "2020-04-08T18:13:35Z", "path": "osgp/protocol-adapter-iec60870/osgp-protocol-adapter-iec60870/src/integration-test/java/org/opensmartgridplatform/adapter/protocol/iec60870/integrationtests/steps/AsduSteps.java", "diffHunk": "@@ -30,4 +43,16 @@ public void whenIReceiveAsduOfType(final String asduType) {\n         final ASdu asdu = AsduFactory.ofType(ASduType.valueOf(asduType));\n         this.connectionSteps.getConnectionEventListener().newASdu(asdu);\n     }\n+\n+    @Then(\"^I should send a general interrogation command to device \\\"([^\\\"]*)\\\"$\")", "originalCommit": "fe0b7ca82a87fe498e297f0643379226e04bdc57", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTU5NDU5NA==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r409594594", "bodyText": "I think I might have used the proposed definition as given by Cucumber. Not sure why it has not used {string}.\nUpdated the code to use a Cucumber expression.", "author": "smvdheijden", "createdAt": "2020-04-16T14:19:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTcxOTExNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTcyODQyNQ==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r405728425", "bodyText": "I am not to fond of the duplication of the step description and debug logging it by default in every step.\nIt looks like just extra maintenance, adding it, and keeping it in sync when the step is refactored (or going out of sync and appearing sloppy).\nIf we deem it valuable to debug log every step in this kind of manner, it might be more opportune to look into Cucumber reporting, which allows creation of reporting plugins where you can intercept events (which include step related events, see for instance io.cucumber.plugin.EventListener, io.cucumber.plugin.event,TestStepStarted and the data it gives access to).", "author": "bvdzwet", "createdAt": "2020-04-08T18:29:15Z", "path": "osgp/protocol-adapter-iec60870/osgp-protocol-adapter-iec60870/src/integration-test/java/org/opensmartgridplatform/adapter/protocol/iec60870/integrationtests/steps/AsduSteps.java", "diffHunk": "@@ -30,4 +43,16 @@ public void whenIReceiveAsduOfType(final String asduType) {\n         final ASdu asdu = AsduFactory.ofType(ASduType.valueOf(asduType));\n         this.connectionSteps.getConnectionEventListener().newASdu(asdu);\n     }\n+\n+    @Then(\"^I should send a general interrogation command to device \\\"([^\\\"]*)\\\"$\")\n+    public void thenIShouldSendAGeneralInterrogationCommandToDevice(final String deviceIdentification)\n+            throws Exception {\n+        LOGGER.debug(\"Then I should send a general interrogation command to device {}\", deviceIdentification);", "originalCommit": "fe0b7ca82a87fe498e297f0643379226e04bdc57", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjIxNjI0Ng==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r406216246", "bodyText": "This certainly works, and if it is the only place a DeviceType is created from a step argument it is OK.\nI was wondering if it would not be nicer to use a Cucumber custom parameter type in such cases (documented somewhere under Cucumber expressions, and under Configuration with the type registry in the documentation for Cucumber).\nNo need to change the code, but I wanted to make sure you know the alternative mentioned here is available.", "author": "bvdzwet", "createdAt": "2020-04-09T13:47:01Z", "path": "osgp/protocol-adapter-iec60870/osgp-protocol-adapter-iec60870/src/integration-test/java/org/opensmartgridplatform/adapter/protocol/iec60870/integrationtests/steps/ConnectionSteps.java", "diffHunk": "@@ -82,26 +84,43 @@ public void givenIec60870DeviceIsNotConnected() throws ConnectionFailureExceptio\n                 .thenReturn(deviceConnection);\n     }\n \n-    @Given(\"an existing connection with an IEC60870 device\")\n-    public void givenIec60870DeviceIsConnected() throws ClientConnectionAlreadyInCacheException {\n-        LOGGER.debug(\"Given IEC60870 device is connected\");\n-\n+    @Given(\"an existing connection with IEC60870 device {string} of type {string}\")\n+    public void givenIec60870DeviceIsConnected(final String deviceIdentification, final String typeOfDevice)\n+            throws Exception {\n+        LOGGER.debug(\"Given an existing connection with IEC60870 device {} of type {}\", deviceIdentification,\n+                typeOfDevice);\n+        final DeviceType deviceType = DeviceType.valueOf(typeOfDevice);", "originalCommit": "fe0b7ca82a87fe498e297f0643379226e04bdc57", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTU5NTg3OA==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r409595878", "bodyText": "Added a DeviceType custom parameter type, although my Cucumber plugin doesn't seem to like it, as the step definition is now marked as missing from within the feature file...", "author": "smvdheijden", "createdAt": "2020-04-16T14:21:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjIxNjI0Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjIyMjc1Mg==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r406222752", "bodyText": "I was confused a bit between device and identification in the code that follows with connectionDevice and getGatewayDeviceIndentification().\nIt seems clearer to use something like connectionDeviceIdentification (or maybe even better, gatewayDeviceIdentification) to indicate this is not a device, but just the identification.", "author": "bvdzwet", "createdAt": "2020-04-09T13:56:17Z", "path": "osgp/protocol-adapter-iec60870/osgp-protocol-adapter-iec60870/src/integration-test/java/org/opensmartgridplatform/adapter/protocol/iec60870/integrationtests/steps/ConnectionSteps.java", "diffHunk": "@@ -82,26 +84,43 @@ public void givenIec60870DeviceIsNotConnected() throws ConnectionFailureExceptio\n                 .thenReturn(deviceConnection);\n     }\n \n-    @Given(\"an existing connection with an IEC60870 device\")\n-    public void givenIec60870DeviceIsConnected() throws ClientConnectionAlreadyInCacheException {\n-        LOGGER.debug(\"Given IEC60870 device is connected\");\n-\n+    @Given(\"an existing connection with IEC60870 device {string} of type {string}\")\n+    public void givenIec60870DeviceIsConnected(final String deviceIdentification, final String typeOfDevice)\n+            throws Exception {\n+        LOGGER.debug(\"Given an existing connection with IEC60870 device {} of type {}\", deviceIdentification,\n+                typeOfDevice);\n+        final DeviceType deviceType = DeviceType.valueOf(typeOfDevice);\n         // Make sure the connection event listener works as expected\n-        final ResponseMetadata responseMetadata = new ResponseMetadata.Builder()\n-                .withDeviceIdentification(DEFAULT_DEVICE_IDENTIFICATION)\n-                .withOrganisationIdentification(DEFAULT_ORGANISATION_IDENTIFICATION)\n-                .withDomainInfo(new DomainInfo(DEFAULT_DOMAIN, DEFAULT_DOMAIN_VERSION))\n-                .withMessageType(DEFAULT_MESSAGE_TYPE)\n-                .build();\n+        this.connectionParameters = this.initConnectionParameters(deviceIdentification);\n+        final ResponseMetadata responseMetadata = this.initResponseMetadata(deviceIdentification, deviceType);\n         this.connectionEventListener = new ClientConnectionEventListener(\n                 this.connectionParameters.getDeviceIdentification(), this.connectionCacheSpy,\n                 this.clientAsduHandlerRegistry, responseMetadata);\n \n         // Make sure a connection could be retrieved from the cache\n         // Only needed for scenarios sending requests to a device\n-        final Connection connection = mock(Connection.class);\n-        this.connectionCacheSpy.addConnection(DEFAULT_DEVICE_IDENTIFICATION,\n-                new DeviceConnection(connection, this.connectionParameters));\n+        // final Connection connection = mock(Connection.class);\n+        this.connectionCacheSpy.addConnection(deviceIdentification,\n+                new DeviceConnection(this.connection, this.connectionParameters));\n+    }\n+\n+    @When(\"I connect to IEC60870 device {string}\")\n+    public void whenIConnectToIEC60870Device(final String deviceIdentification) throws Exception {\n+        LOGGER.debug(\"When I connect to IEC60870 device {}\", deviceIdentification);\n+        final Iec60870Device device = this.iec60870DeviceSteps.getDevice(deviceIdentification)\n+                .orElseThrow(() -> new Exception(\"Device not found\"));\n+        final DeviceType deviceType = device.getDeviceType();\n+        String connectionDevice = deviceIdentification;", "originalCommit": "fe0b7ca82a87fe498e297f0643379226e04bdc57", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODY1ODU4NQ==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r408658585", "bodyText": "In this case I'd chosen to use connectionDevice as not all devices will have a gatewayDevice?\nExtended the name with \"Identification\".", "author": "smvdheijden", "createdAt": "2020-04-15T08:09:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjIyMjc1Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjIzMTc3Ng==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r406231776", "bodyText": "The common address, IP address and the port appear not to be important information for understanding the test, as they are tucked away here. Besides that, they are the default values in the ConnectionParameters Builder.\nDefaults in the Builder are fine, but I think they should not be repeated elsewhere unless there is a good reason to do so.", "author": "bvdzwet", "createdAt": "2020-04-09T14:09:10Z", "path": "osgp/protocol-adapter-iec60870/osgp-protocol-adapter-iec60870/src/integration-test/java/org/opensmartgridplatform/adapter/protocol/iec60870/integrationtests/steps/ConnectionSteps.java", "diffHunk": "@@ -117,4 +136,30 @@ public void thenIShouldCacheConnection() throws ClientConnectionAlreadyInCacheEx\n     public ConnectionEventListener getConnectionEventListener() {\n         return this.connectionEventListener;\n     }\n+\n+    private ConnectionParameters initConnectionParameters(final String deviceIdentification) {\n+        return new ConnectionParameters.Builder().commonAddress(0)", "originalCommit": "fe0b7ca82a87fe498e297f0643379226e04bdc57", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODY1OTcwNw==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r408659707", "bodyText": "You're right, I probably forgot to clean this code after adding the defaults to the builder...", "author": "smvdheijden", "createdAt": "2020-04-15T08:12:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjIzMTc3Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjIzNDc4OQ==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r406234789", "bodyText": "Initially I thought why 2019? But then I saw this is moved here from ContextConfigurationSteps.\nIt looks like it has landed in a better place here.", "author": "bvdzwet", "createdAt": "2020-04-09T14:13:28Z", "path": "osgp/protocol-adapter-iec60870/osgp-protocol-adapter-iec60870/src/integration-test/java/org/opensmartgridplatform/adapter/protocol/iec60870/integrationtests/TestContextConfiguration.java", "diffHunk": "@@ -0,0 +1,43 @@\n+/**\n+ * Copyright 2019 Smart Society Services B.V.", "originalCommit": "fe0b7ca82a87fe498e297f0643379226e04bdc57", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjI0MTM0Mg==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r406241342", "bodyText": "Is it necessary to use a DataTable argument and call asMaps?\nWith a simple List it is not, and I would expect things to work if the parameter was something like List<Map<String, String>> deviceRows instead.", "author": "bvdzwet", "createdAt": "2020-04-09T14:22:51Z", "path": "osgp/protocol-adapter-iec60870/osgp-protocol-adapter-iec60870/src/integration-test/java/org/opensmartgridplatform/adapter/protocol/iec60870/integrationtests/steps/Iec60870DeviceSteps.java", "diffHunk": "@@ -25,6 +33,37 @@\n     @Given(\"an IEC60870 device\")\n     public void givenIec60870Device() {\n         final Iec60870Device device = Iec60870DeviceFactory.createDefaultWith(DEFAULT_DEVICE_IDENTIFICATION);\n-        when(this.repositoryMock.findByDeviceIdentification(DEFAULT_DEVICE_IDENTIFICATION)).thenReturn(device);\n+        when(this.repositoryMock.findByDeviceIdentification(DEFAULT_DEVICE_IDENTIFICATION))\n+                .thenReturn(Optional.of(device));\n+    }\n+\n+    @Given(\"IEC60870 devices\")\n+    public void givenIec60870Devices(final DataTable dataTable) {\n+\n+        final List<Map<String, String>> rows = dataTable.asMaps();", "originalCommit": "fe0b7ca82a87fe498e297f0643379226e04bdc57", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTYwMTkwOQ==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r409601909", "bodyText": "I would prefer the use of DataTable as it looks cleaner to me.\nRefactored some of the code:\n\nrenamed the parameter to deviceTable\nmoved the asMaps() call to the for loop", "author": "smvdheijden", "createdAt": "2020-04-16T14:28:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjI0MTM0Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjI0NDIwNQ==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r406244205", "bodyText": "I wouldn't use i here instead of invocation. The latter is clearer, and the single character is mostly used for integer index values.", "author": "bvdzwet", "createdAt": "2020-04-09T14:26:45Z", "path": "osgp/protocol-adapter-iec60870/osgp-protocol-adapter-iec60870/src/integration-test/java/org/opensmartgridplatform/adapter/protocol/iec60870/integrationtests/steps/Iec60870DeviceSteps.java", "diffHunk": "@@ -25,6 +33,37 @@\n     @Given(\"an IEC60870 device\")\n     public void givenIec60870Device() {\n         final Iec60870Device device = Iec60870DeviceFactory.createDefaultWith(DEFAULT_DEVICE_IDENTIFICATION);\n-        when(this.repositoryMock.findByDeviceIdentification(DEFAULT_DEVICE_IDENTIFICATION)).thenReturn(device);\n+        when(this.repositoryMock.findByDeviceIdentification(DEFAULT_DEVICE_IDENTIFICATION))\n+                .thenReturn(Optional.of(device));\n+    }\n+\n+    @Given(\"IEC60870 devices\")\n+    public void givenIec60870Devices(final DataTable dataTable) {\n+\n+        final List<Map<String, String>> rows = dataTable.asMaps();\n+\n+        final List<Iec60870Device> devices = new ArrayList<>();\n+\n+        for (final Map<String, String> colums : rows) {\n+            final Iec60870Device device = Iec60870DeviceFactory.fromSettings(colums);\n+            when(this.repositoryMock.findByDeviceIdentification(device.getDeviceIdentification()))\n+                    .thenReturn(Optional.of(device));\n+            devices.add(device);\n+        }\n+\n+        when(this.repositoryMock.findByGatewayDeviceIdentification(anyString()))\n+                .thenAnswer(i -> this.getDevicesForGateway(i.getArgument(0), devices));", "originalCommit": "fe0b7ca82a87fe498e297f0643379226e04bdc57", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODY2NDA1MA==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r408664050", "bodyText": "Done", "author": "smvdheijden", "createdAt": "2020-04-15T08:19:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjI0NDIwNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjI1MTQxMw==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r406251413", "bodyText": "Missing license header.", "author": "bvdzwet", "createdAt": "2020-04-09T14:36:40Z", "path": "osgp/protocol-adapter-iec60870/osgp-protocol-adapter-iec60870/src/integration-test/java/org/opensmartgridplatform/adapter/protocol/iec60870/integrationtests/steps/MockedDeviceSteps.java", "diffHunk": "@@ -0,0 +1,107 @@\n+package org.opensmartgridplatform.adapter.protocol.iec60870.integrationtests.steps;", "originalCommit": "fe0b7ca82a87fe498e297f0643379226e04bdc57", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjI1NTA0NA==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r406255044", "bodyText": "I think I am not so happy with this name. Mocking is a technique in the implementation of the tests and should not be essential to a step class, in that it is included in its name.\nI am guessing based on what I see in this class, and suspect something like ControlledStationSteps or Iec60870ServerSteps better fits what these steps have to offer.\nJust let me know if this is indeed the case, or if I am missing something.", "author": "bvdzwet", "createdAt": "2020-04-09T14:41:43Z", "path": "osgp/protocol-adapter-iec60870/osgp-protocol-adapter-iec60870/src/integration-test/java/org/opensmartgridplatform/adapter/protocol/iec60870/integrationtests/steps/MockedDeviceSteps.java", "diffHunk": "@@ -0,0 +1,107 @@\n+package org.opensmartgridplatform.adapter.protocol.iec60870.integrationtests.steps;\n+\n+import static org.mockito.ArgumentMatchers.any;\n+import static org.mockito.ArgumentMatchers.eq;\n+import static org.mockito.Mockito.doAnswer;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.stream.Collectors;\n+\n+import org.mockito.invocation.InvocationOnMock;\n+import org.openmuc.j60870.ASdu;\n+import org.openmuc.j60870.ASduType;\n+import org.openmuc.j60870.CauseOfTransmission;\n+import org.openmuc.j60870.Connection;\n+import org.openmuc.j60870.ConnectionEventListener;\n+import org.openmuc.j60870.ie.IeQualifierOfInterrogation;\n+import org.openmuc.j60870.ie.IeSinglePointWithQuality;\n+import org.openmuc.j60870.ie.InformationObject;\n+import org.springframework.beans.factory.annotation.Autowired;\n+\n+import io.cucumber.datatable.DataTable;\n+import io.cucumber.java.en.Given;\n+\n+public class MockedDeviceSteps {", "originalCommit": "fe0b7ca82a87fe498e297f0643379226e04bdc57", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODY2NTU4Mg==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r408665582", "bodyText": "Renamed", "author": "smvdheijden", "createdAt": "2020-04-15T08:21:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjI1NTA0NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjI2Mzk5MA==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r406263990", "bodyText": "I have some questions here. Mostly for my own understanding. Only cause for change (now or later) if it makes sense.\nIs the ProcessImage here a class that represents all/some of the information stored on a device.\nIf so, then maybe not now, but very soon it will possibly be convenient to have it accessible broader than here.\nSomething else I was thinking about (if my earlier assumptions are correct) is if it would make sense to split this method up, where givenAProcessImageOnTheControlledStation sets up the data for a controlled station and other methods determine what happens when some or all of this information is requested (something like a when step whenAGeneralInterrogationCommandIsReceived).", "author": "bvdzwet", "createdAt": "2020-04-09T14:53:38Z", "path": "osgp/protocol-adapter-iec60870/osgp-protocol-adapter-iec60870/src/integration-test/java/org/opensmartgridplatform/adapter/protocol/iec60870/integrationtests/steps/MockedDeviceSteps.java", "diffHunk": "@@ -0,0 +1,107 @@\n+package org.opensmartgridplatform.adapter.protocol.iec60870.integrationtests.steps;\n+\n+import static org.mockito.ArgumentMatchers.any;\n+import static org.mockito.ArgumentMatchers.eq;\n+import static org.mockito.Mockito.doAnswer;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.stream.Collectors;\n+\n+import org.mockito.invocation.InvocationOnMock;\n+import org.openmuc.j60870.ASdu;\n+import org.openmuc.j60870.ASduType;\n+import org.openmuc.j60870.CauseOfTransmission;\n+import org.openmuc.j60870.Connection;\n+import org.openmuc.j60870.ConnectionEventListener;\n+import org.openmuc.j60870.ie.IeQualifierOfInterrogation;\n+import org.openmuc.j60870.ie.IeSinglePointWithQuality;\n+import org.openmuc.j60870.ie.InformationObject;\n+import org.springframework.beans.factory.annotation.Autowired;\n+\n+import io.cucumber.datatable.DataTable;\n+import io.cucumber.java.en.Given;\n+\n+public class MockedDeviceSteps {\n+    @Autowired\n+    private ConnectionSteps connectionSteps;\n+\n+    @Autowired\n+    private Connection connection;\n+\n+    @Given(\"a process image on the controlled station\")\n+    public void givenAProcessImageOnTheControlledStation(final DataTable datatable) throws Throwable {", "originalCommit": "fe0b7ca82a87fe498e297f0643379226e04bdc57", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODc1NDIwMA==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r408754200", "bodyText": "The Process Image should represent the actual status of all objects for a device. I agree with you that it would be convenient to have this class accessible broader than here. It could probably be moved to the osgp-iec60870 component.\nI am not sure though about splitting up the method, at least not in this context.\nIn this case it is intended to mock a device to return a specific set of values when receiving a GI request. If splitting up, in my opinion it would be to another given step: givenTheDeviceRespondsToGeneralInterrogationWith or something like that, as I think the when step should be a trigger on the system/component under test (in this case the protocol adapter)?", "author": "smvdheijden", "createdAt": "2020-04-15T10:54:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjI2Mzk5MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjI2NzQwNQ==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r406267405", "bodyText": "Now this helper method is tied to mockito by the invocation parameter. It could be easier to allow forms of reuse if the mockito stuff was kept together inside the step method. It feels cleaner if the commonAddress and qualifer were arguments of a method like this one instead of the invocation.\nThe method now only makes sense and can only be properly understood when looked at in combination with the method it is called from.\nJust see how you feel about this, to judge whether to leave it as is, or refactor it.", "author": "bvdzwet", "createdAt": "2020-04-09T14:58:08Z", "path": "osgp/protocol-adapter-iec60870/osgp-protocol-adapter-iec60870/src/integration-test/java/org/opensmartgridplatform/adapter/protocol/iec60870/integrationtests/steps/MockedDeviceSteps.java", "diffHunk": "@@ -0,0 +1,107 @@\n+package org.opensmartgridplatform.adapter.protocol.iec60870.integrationtests.steps;\n+\n+import static org.mockito.ArgumentMatchers.any;\n+import static org.mockito.ArgumentMatchers.eq;\n+import static org.mockito.Mockito.doAnswer;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.stream.Collectors;\n+\n+import org.mockito.invocation.InvocationOnMock;\n+import org.openmuc.j60870.ASdu;\n+import org.openmuc.j60870.ASduType;\n+import org.openmuc.j60870.CauseOfTransmission;\n+import org.openmuc.j60870.Connection;\n+import org.openmuc.j60870.ConnectionEventListener;\n+import org.openmuc.j60870.ie.IeQualifierOfInterrogation;\n+import org.openmuc.j60870.ie.IeSinglePointWithQuality;\n+import org.openmuc.j60870.ie.InformationObject;\n+import org.springframework.beans.factory.annotation.Autowired;\n+\n+import io.cucumber.datatable.DataTable;\n+import io.cucumber.java.en.Given;\n+\n+public class MockedDeviceSteps {\n+    @Autowired\n+    private ConnectionSteps connectionSteps;\n+\n+    @Autowired\n+    private Connection connection;\n+\n+    @Given(\"a process image on the controlled station\")\n+    public void givenAProcessImageOnTheControlledStation(final DataTable datatable) throws Throwable {\n+\n+        final ProcessImage processImage = ProcessImage.fromDataTable(datatable);\n+\n+        doAnswer(invocation -> this.sendInterrogationResponse(invocation, processImage)).when(this.connection)\n+                .interrogation(any(Integer.class), eq(CauseOfTransmission.ACTIVATION),\n+                        any(IeQualifierOfInterrogation.class));\n+    }\n+\n+    private Object sendInterrogationResponse(final InvocationOnMock invocation, final ProcessImage processImage) {", "originalCommit": "fe0b7ca82a87fe498e297f0643379226e04bdc57", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTYwNDg2NA==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r409604864", "bodyText": "Agreed and updated...", "author": "smvdheijden", "createdAt": "2020-04-16T14:32:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjI2NzQwNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjI3NzI5Nw==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r406277297", "bodyText": "Same as earlier, I wonder if it would not be cleaner to put some more distance between the Cucumber DataTable and the ProcessImage. If I was correct earlier the step parameter could be changed from DataTable to a list of maps, breaking this dependency, and avoiding the code to explicitly go from data table to list of maps.", "author": "bvdzwet", "createdAt": "2020-04-09T15:12:28Z", "path": "osgp/protocol-adapter-iec60870/osgp-protocol-adapter-iec60870/src/integration-test/java/org/opensmartgridplatform/adapter/protocol/iec60870/integrationtests/steps/MockedDeviceSteps.java", "diffHunk": "@@ -0,0 +1,107 @@\n+package org.opensmartgridplatform.adapter.protocol.iec60870.integrationtests.steps;\n+\n+import static org.mockito.ArgumentMatchers.any;\n+import static org.mockito.ArgumentMatchers.eq;\n+import static org.mockito.Mockito.doAnswer;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.stream.Collectors;\n+\n+import org.mockito.invocation.InvocationOnMock;\n+import org.openmuc.j60870.ASdu;\n+import org.openmuc.j60870.ASduType;\n+import org.openmuc.j60870.CauseOfTransmission;\n+import org.openmuc.j60870.Connection;\n+import org.openmuc.j60870.ConnectionEventListener;\n+import org.openmuc.j60870.ie.IeQualifierOfInterrogation;\n+import org.openmuc.j60870.ie.IeSinglePointWithQuality;\n+import org.openmuc.j60870.ie.InformationObject;\n+import org.springframework.beans.factory.annotation.Autowired;\n+\n+import io.cucumber.datatable.DataTable;\n+import io.cucumber.java.en.Given;\n+\n+public class MockedDeviceSteps {\n+    @Autowired\n+    private ConnectionSteps connectionSteps;\n+\n+    @Autowired\n+    private Connection connection;\n+\n+    @Given(\"a process image on the controlled station\")\n+    public void givenAProcessImageOnTheControlledStation(final DataTable datatable) throws Throwable {\n+\n+        final ProcessImage processImage = ProcessImage.fromDataTable(datatable);\n+\n+        doAnswer(invocation -> this.sendInterrogationResponse(invocation, processImage)).when(this.connection)\n+                .interrogation(any(Integer.class), eq(CauseOfTransmission.ACTIVATION),\n+                        any(IeQualifierOfInterrogation.class));\n+    }\n+\n+    private Object sendInterrogationResponse(final InvocationOnMock invocation, final ProcessImage processImage) {\n+        final int commonAddress = invocation.getArgument(0);\n+        final IeQualifierOfInterrogation qualifier = invocation.getArgument(2);\n+\n+        final ConnectionEventListener listener = this.connectionSteps.getConnectionEventListener();\n+        listener.newASdu(this.interrogationActivationConfirmationAsdu(commonAddress, qualifier));\n+        for (final ASdu asdu : processImage.toInterrogationAsdus(commonAddress, qualifier)) {\n+            listener.newASdu(asdu);\n+        }\n+        listener.newASdu(this.interrogationActivationTerminationAsdu(commonAddress, qualifier));\n+        return null;\n+    }\n+\n+    private ASdu interrogationActivationConfirmationAsdu(final int commonAddress,\n+            final IeQualifierOfInterrogation qualifier) {\n+        return this.interrogationAsdu(commonAddress, CauseOfTransmission.ACTIVATION_CON, qualifier);\n+    }\n+\n+    private ASdu interrogationActivationTerminationAsdu(final int commonAddress,\n+            final IeQualifierOfInterrogation qualifier) {\n+        return this.interrogationAsdu(commonAddress, CauseOfTransmission.ACTIVATION_TERMINATION, qualifier);\n+    }\n+\n+    private ASdu interrogationAsdu(final int commonAddress, final CauseOfTransmission cot,\n+            final IeQualifierOfInterrogation qualifier) {\n+        return new ASdu(ASduType.C_IC_NA_1, false, cot, false, false, 0, commonAddress,\n+                new InformationObject(0, qualifier));\n+    }\n+\n+    private static class ProcessImage {\n+        private final List<InformationObject> image;\n+\n+        private ProcessImage(final List<InformationObject> image) {\n+            this.image = image;\n+        }\n+\n+        public static ProcessImage fromDataTable(final DataTable datatable) {\n+\n+            final List<Map<String, String>> rows = datatable.asMaps();", "originalCommit": "fe0b7ca82a87fe498e297f0643379226e04bdc57", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTYwNzM3NQ==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r409607375", "bodyText": "I would prefer the DataTable, refactored the code in a similar way as earlier.", "author": "smvdheijden", "createdAt": "2020-04-16T14:35:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjI3NzI5Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjI3ODc2Mg==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r406278762", "bodyText": "This should either be un-commented and used, or removed.", "author": "bvdzwet", "createdAt": "2020-04-09T15:14:33Z", "path": "osgp/protocol-adapter-iec60870/osgp-protocol-adapter-iec60870/src/integration-test/java/org/opensmartgridplatform/adapter/protocol/iec60870/integrationtests/steps/MockedDeviceSteps.java", "diffHunk": "@@ -0,0 +1,107 @@\n+package org.opensmartgridplatform.adapter.protocol.iec60870.integrationtests.steps;\n+\n+import static org.mockito.ArgumentMatchers.any;\n+import static org.mockito.ArgumentMatchers.eq;\n+import static org.mockito.Mockito.doAnswer;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.stream.Collectors;\n+\n+import org.mockito.invocation.InvocationOnMock;\n+import org.openmuc.j60870.ASdu;\n+import org.openmuc.j60870.ASduType;\n+import org.openmuc.j60870.CauseOfTransmission;\n+import org.openmuc.j60870.Connection;\n+import org.openmuc.j60870.ConnectionEventListener;\n+import org.openmuc.j60870.ie.IeQualifierOfInterrogation;\n+import org.openmuc.j60870.ie.IeSinglePointWithQuality;\n+import org.openmuc.j60870.ie.InformationObject;\n+import org.springframework.beans.factory.annotation.Autowired;\n+\n+import io.cucumber.datatable.DataTable;\n+import io.cucumber.java.en.Given;\n+\n+public class MockedDeviceSteps {\n+    @Autowired\n+    private ConnectionSteps connectionSteps;\n+\n+    @Autowired\n+    private Connection connection;\n+\n+    @Given(\"a process image on the controlled station\")\n+    public void givenAProcessImageOnTheControlledStation(final DataTable datatable) throws Throwable {\n+\n+        final ProcessImage processImage = ProcessImage.fromDataTable(datatable);\n+\n+        doAnswer(invocation -> this.sendInterrogationResponse(invocation, processImage)).when(this.connection)\n+                .interrogation(any(Integer.class), eq(CauseOfTransmission.ACTIVATION),\n+                        any(IeQualifierOfInterrogation.class));\n+    }\n+\n+    private Object sendInterrogationResponse(final InvocationOnMock invocation, final ProcessImage processImage) {\n+        final int commonAddress = invocation.getArgument(0);\n+        final IeQualifierOfInterrogation qualifier = invocation.getArgument(2);\n+\n+        final ConnectionEventListener listener = this.connectionSteps.getConnectionEventListener();\n+        listener.newASdu(this.interrogationActivationConfirmationAsdu(commonAddress, qualifier));\n+        for (final ASdu asdu : processImage.toInterrogationAsdus(commonAddress, qualifier)) {\n+            listener.newASdu(asdu);\n+        }\n+        listener.newASdu(this.interrogationActivationTerminationAsdu(commonAddress, qualifier));\n+        return null;\n+    }\n+\n+    private ASdu interrogationActivationConfirmationAsdu(final int commonAddress,\n+            final IeQualifierOfInterrogation qualifier) {\n+        return this.interrogationAsdu(commonAddress, CauseOfTransmission.ACTIVATION_CON, qualifier);\n+    }\n+\n+    private ASdu interrogationActivationTerminationAsdu(final int commonAddress,\n+            final IeQualifierOfInterrogation qualifier) {\n+        return this.interrogationAsdu(commonAddress, CauseOfTransmission.ACTIVATION_TERMINATION, qualifier);\n+    }\n+\n+    private ASdu interrogationAsdu(final int commonAddress, final CauseOfTransmission cot,\n+            final IeQualifierOfInterrogation qualifier) {\n+        return new ASdu(ASduType.C_IC_NA_1, false, cot, false, false, 0, commonAddress,\n+                new InformationObject(0, qualifier));\n+    }\n+\n+    private static class ProcessImage {\n+        private final List<InformationObject> image;\n+\n+        private ProcessImage(final List<InformationObject> image) {\n+            this.image = image;\n+        }\n+\n+        public static ProcessImage fromDataTable(final DataTable datatable) {\n+\n+            final List<Map<String, String>> rows = datatable.asMaps();\n+\n+            final List<InformationObject> informationObjects = rows.stream()\n+                    .map(ProcessImage::informationObject)\n+                    .collect(Collectors.toList());\n+            return new ProcessImage(informationObjects);\n+        }\n+\n+        public List<ASdu> toInterrogationAsdus(final int commonAddress, final IeQualifierOfInterrogation qualifier) {\n+            final CauseOfTransmission cot = CauseOfTransmission.causeFor(qualifier.getValue());\n+            final List<ASdu> asdus = new ArrayList<>();\n+            asdus.add(new ASdu(ASduType.M_SP_NA_1, true, cot, false, false, 0, commonAddress,\n+                    this.image.toArray(new InformationObject[0])));\n+            return asdus;\n+        }\n+\n+        public static InformationObject informationObject(final Map<String, String> map) {\n+            final int informationObjectAddress = Integer.parseInt(map.getOrDefault(\"information_object_address\", \"0\"));\n+            // final String informationObjectType =\n+            // map.get(\"information_object_type\");", "originalCommit": "fe0b7ca82a87fe498e297f0643379226e04bdc57", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODc1NDk1Mg==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r408754952", "bodyText": "Done", "author": "smvdheijden", "createdAt": "2020-04-15T10:56:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjI3ODc2Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjI4NTc1Nw==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r406285757", "bodyText": "Not regarding the changes from this pull request, but the name request steps had me confused until I looked more into the code. Request is so general it could have just as well been a request to a device. Perhaps the longer name OsgpCoreRequestSteps is a clearer alternative. (Something similar could be said for the ResponseSteps I suppose.)", "author": "bvdzwet", "createdAt": "2020-04-09T15:24:55Z", "path": "osgp/protocol-adapter-iec60870/osgp-protocol-adapter-iec60870/src/integration-test/java/org/opensmartgridplatform/adapter/protocol/iec60870/integrationtests/steps/RequestSteps.java", "diffHunk": "@@ -14,13 +14,18 @@\n import javax.jms.ObjectMessage;\n \n import org.opensmartgridplatform.adapter.protocol.iec60870.infra.messaging.DeviceRequestMessageListener;\n+import org.opensmartgridplatform.dto.da.ConnectRequestDto;\n import org.opensmartgridplatform.dto.da.GetHealthStatusRequestDto;\n+import org.opensmartgridplatform.shared.infra.jms.MessageType;\n import org.opensmartgridplatform.shared.infra.jms.ObjectMessageBuilder;\n import org.springframework.beans.factory.annotation.Autowired;\n \n import io.cucumber.java.en.When;\n \n public class RequestSteps {", "originalCommit": "fe0b7ca82a87fe498e297f0643379226e04bdc57", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODc3ODQ2OA==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r408778468", "bodyText": "Renamed the classes to OsgpCoreRequestSteps and OsgpCoreResponseSteps. (Renaming to InboundRequestSteps and OutboundResponseSteps also crossed my mind)", "author": "smvdheijden", "createdAt": "2020-04-15T11:42:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjI4NTc1Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjMxMDM5OQ==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r406310399", "bodyText": "Indent with spaces.", "author": "bvdzwet", "createdAt": "2020-04-09T16:01:19Z", "path": "osgp/protocol-adapter-iec60870/osgp-protocol-adapter-iec60870/src/integration-test/resources/features/GeneralInterrogation.feature", "diffHunk": "@@ -0,0 +1,31 @@\n+Feature: General Interrogation\n+  As controlling station\n+  I want to send general interrogation requests to controlled stations\n+  So that I am able to return the actual statuses of the controlled stations\n+\n+\tBackground:", "originalCommit": "fe0b7ca82a87fe498e297f0643379226e04bdc57", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjMxODUwNA==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r406318504", "bodyText": "Just for my understanding, is the scenario that a connect request occurs for the gateway, and that the gateway will send responses for all devices behind it, which are transferred to OSGP core by the protocol adapter?\nThis is somewhat different from the scenario I would expect based on other value streams (for instance a request is made for gas readings which are read from a gas meter behind a smart meter gateway device).\nTranslated to this case, I would expect the interrogation to be for LMD_1 for instance, where the command is passed through GATEWAY_1 with some identication of the targeted light measurement device that the gateway understands.\nThis would be followed by a response for just the targeted light measurement device.\nJust let me know if my interpretation is wrong, and how this will work instead.", "author": "bvdzwet", "createdAt": "2020-04-09T16:14:41Z", "path": "osgp/protocol-adapter-iec60870/osgp-protocol-adapter-iec60870/src/integration-test/resources/features/GeneralInterrogation.feature", "diffHunk": "@@ -0,0 +1,31 @@\n+Feature: General Interrogation\n+  As controlling station\n+  I want to send general interrogation requests to controlled stations\n+  So that I am able to return the actual statuses of the controlled stations\n+\n+\tBackground:\n+    Given IEC60870 devices\n+      | device_identification | device_type               | gateway_device_identification | device_address |\n+      | GATEWAY_1             | LIGHT_MEASUREMENT_GATEWAY |                               |                |\n+      | LMD_1                 | LIGHT_MEASUREMENT_DEVICE  | GATEWAY_1                     |              1 |\n+      | LMD_2                 | LIGHT_MEASUREMENT_DEVICE  | GATEWAY_1                     |              2 |\n+    And a process image on the controlled station\n+      | information_object_address | information_object_type | information_element_value |\n+      |                          1 | SIQ                     | OFF                       |\n+      |                          2 | SIQ                     | ON                        |\n+\n+  Scenario: send general interrogation command after connecting to a controlled station\n+    When I receive a connect request for IEC60870 device \"GATEWAY_1\" from osgp core", "originalCommit": "fe0b7ca82a87fe498e297f0643379226e04bdc57", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODc4NDQzMA==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r408784430", "bodyText": "In the case of smart metering the smart meter is offline, and only when a request is received a connection is established and data is read, either for the e-meter or g-meter or both. In this case the controlled station should always be connected, and only when for example osgp or the device is restarted, or due to some other technical interruptions, a connect request will be sent to the controlled station, after which a general interrogation should take place. This general interrogation will read all objects from the controlled station, which will be sent to osgp-core as light sensor status objects for the individual light measurement devices defined for the controlled station.", "author": "smvdheijden", "createdAt": "2020-04-15T11:53:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjMxODUwNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjY0OTU2MQ==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r406649561", "bodyText": "Should this log statement say \"for light measurement gateway\"?", "author": "bvdzwet", "createdAt": "2020-04-10T07:57:57Z", "path": "osgp/protocol-adapter-iec60870/osgp-protocol-adapter-iec60870/src/main/java/org/opensmartgridplatform/adapter/protocol/iec60870/application/services/DistributionAutomationDeviceResponseService.java", "diffHunk": "@@ -0,0 +1,41 @@\n+/**\n+ * Copyright 2020 Smart Society Services B.V.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ */\n+\n+package org.opensmartgridplatform.adapter.protocol.iec60870.application.services;\n+\n+import org.opensmartgridplatform.adapter.protocol.iec60870.domain.services.MeasurementReportingService;\n+import org.opensmartgridplatform.adapter.protocol.iec60870.domain.valueobjects.DeviceType;\n+import org.opensmartgridplatform.adapter.protocol.iec60870.domain.valueobjects.ResponseMetadata;\n+import org.opensmartgridplatform.dto.da.measurements.MeasurementReportDto;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.stereotype.Service;\n+\n+@Service\n+public class DistributionAutomationDeviceResponseService extends AbstractDeviceResponseService {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(DistributionAutomationDeviceResponseService.class);\n+\n+    private static final DeviceType DEVICE_TYPE = DeviceType.DA_DEVICE;\n+\n+    @Autowired\n+    private MeasurementReportingService measurementReportingService;\n+\n+    public DistributionAutomationDeviceResponseService() {\n+        super(DEVICE_TYPE);\n+    }\n+\n+    @Override\n+    public void process(final MeasurementReportDto measurementReportDto, final ResponseMetadata responseMetadata) {\n+        LOGGER.info(\"Received measurement report {} for light measurement gateway {}.\", measurementReportDto,", "originalCommit": "fe0b7ca82a87fe498e297f0643379226e04bdc57", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODc4NTUyNA==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r408785524", "bodyText": "No, changed it.", "author": "smvdheijden", "createdAt": "2020-04-15T11:55:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjY0OTU2MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjY1NTk3Ng==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r406655976", "bodyText": "To me it is not immediately obvious why the response meta data is being replaced with a new correlation UID.\nIs there some reason that the one in the current response meta data should not be used? (Maybe because it is not related to earlier actions/events like a request that could be traced?)", "author": "bvdzwet", "createdAt": "2020-04-10T08:16:44Z", "path": "osgp/protocol-adapter-iec60870/osgp-protocol-adapter-iec60870/src/main/java/org/opensmartgridplatform/adapter/protocol/iec60870/application/services/LightMeasurementDeviceResponseService.java", "diffHunk": "@@ -0,0 +1,95 @@\n+/**\n+ * Copyright 2020 Smart Society Services B.V.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ */\n+\n+package org.opensmartgridplatform.adapter.protocol.iec60870.application.services;\n+\n+import java.util.Optional;\n+\n+import org.opensmartgridplatform.adapter.protocol.iec60870.domain.entities.Iec60870Device;\n+import org.opensmartgridplatform.adapter.protocol.iec60870.domain.exceptions.AsduHandlerException;\n+import org.opensmartgridplatform.adapter.protocol.iec60870.domain.factories.ResponseMetadataFactory;\n+import org.opensmartgridplatform.adapter.protocol.iec60870.domain.repositories.Iec60870DeviceRepository;\n+import org.opensmartgridplatform.adapter.protocol.iec60870.domain.services.LightMeasurementService;\n+import org.opensmartgridplatform.adapter.protocol.iec60870.domain.valueobjects.DeviceType;\n+import org.opensmartgridplatform.adapter.protocol.iec60870.domain.valueobjects.ResponseMetadata;\n+import org.opensmartgridplatform.dto.da.measurements.MeasurementGroupDto;\n+import org.opensmartgridplatform.dto.da.measurements.MeasurementReportDto;\n+import org.opensmartgridplatform.dto.da.measurements.elements.BitmaskMeasurementElementDto;\n+import org.opensmartgridplatform.dto.valueobjects.LightSensorStatusDto;\n+import org.opensmartgridplatform.shared.infra.jms.MessageType;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.stereotype.Service;\n+\n+@Service\n+public class LightMeasurementDeviceResponseService extends AbstractDeviceResponseService {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(LightMeasurementDeviceResponseService.class);\n+\n+    private static final DeviceType DEVICE_TYPE = DeviceType.LIGHT_MEASUREMENT_DEVICE;\n+\n+    @Autowired\n+    private Iec60870DeviceRepository iec60870DeviceRepository;\n+\n+    @Autowired\n+    private ResponseMetadataFactory responseMetadataFactory;\n+\n+    @Autowired\n+    private LightMeasurementService lightMeasurementService;\n+\n+    public LightMeasurementDeviceResponseService() {\n+        super(DEVICE_TYPE);\n+    }\n+\n+    @Override\n+    public void process(final MeasurementReportDto measurementReportDto, final ResponseMetadata responseMetadata)\n+            throws AsduHandlerException {\n+        LOGGER.info(\"Received measurement report {} for light measurement gateway {}.\", measurementReportDto,\n+                responseMetadata.getDeviceIdentification());\n+\n+        final ResponseMetadata newResponseMetadata = this.responseMetadataFactory", "originalCommit": "fe0b7ca82a87fe498e297f0643379226e04bdc57", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTYxNDQxNw==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r409614417", "bodyText": "New correlation uids are already created in asdu handlers, so no need to recreate here and thus removed...\nAs discussed earlier we still might need a mechanism to relate correlation uids from requests to responses...", "author": "smvdheijden", "createdAt": "2020-04-16T14:44:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjY1NTk3Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjY1NjY5Nw==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r406656697", "bodyText": "It looks out of place that the methods here throw an AsduHandlerException.\nNot finding a device does not appear to be related to handling of ASDUs.", "author": "bvdzwet", "createdAt": "2020-04-10T08:19:03Z", "path": "osgp/protocol-adapter-iec60870/osgp-protocol-adapter-iec60870/src/main/java/org/opensmartgridplatform/adapter/protocol/iec60870/application/services/LightMeasurementDeviceResponseService.java", "diffHunk": "@@ -0,0 +1,95 @@\n+/**\n+ * Copyright 2020 Smart Society Services B.V.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ */\n+\n+package org.opensmartgridplatform.adapter.protocol.iec60870.application.services;\n+\n+import java.util.Optional;\n+\n+import org.opensmartgridplatform.adapter.protocol.iec60870.domain.entities.Iec60870Device;\n+import org.opensmartgridplatform.adapter.protocol.iec60870.domain.exceptions.AsduHandlerException;\n+import org.opensmartgridplatform.adapter.protocol.iec60870.domain.factories.ResponseMetadataFactory;\n+import org.opensmartgridplatform.adapter.protocol.iec60870.domain.repositories.Iec60870DeviceRepository;\n+import org.opensmartgridplatform.adapter.protocol.iec60870.domain.services.LightMeasurementService;\n+import org.opensmartgridplatform.adapter.protocol.iec60870.domain.valueobjects.DeviceType;\n+import org.opensmartgridplatform.adapter.protocol.iec60870.domain.valueobjects.ResponseMetadata;\n+import org.opensmartgridplatform.dto.da.measurements.MeasurementGroupDto;\n+import org.opensmartgridplatform.dto.da.measurements.MeasurementReportDto;\n+import org.opensmartgridplatform.dto.da.measurements.elements.BitmaskMeasurementElementDto;\n+import org.opensmartgridplatform.dto.valueobjects.LightSensorStatusDto;\n+import org.opensmartgridplatform.shared.infra.jms.MessageType;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.stereotype.Service;\n+\n+@Service\n+public class LightMeasurementDeviceResponseService extends AbstractDeviceResponseService {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(LightMeasurementDeviceResponseService.class);\n+\n+    private static final DeviceType DEVICE_TYPE = DeviceType.LIGHT_MEASUREMENT_DEVICE;\n+\n+    @Autowired\n+    private Iec60870DeviceRepository iec60870DeviceRepository;\n+\n+    @Autowired\n+    private ResponseMetadataFactory responseMetadataFactory;\n+\n+    @Autowired\n+    private LightMeasurementService lightMeasurementService;\n+\n+    public LightMeasurementDeviceResponseService() {\n+        super(DEVICE_TYPE);\n+    }\n+\n+    @Override\n+    public void process(final MeasurementReportDto measurementReportDto, final ResponseMetadata responseMetadata)\n+            throws AsduHandlerException {\n+        LOGGER.info(\"Received measurement report {} for light measurement gateway {}.\", measurementReportDto,\n+                responseMetadata.getDeviceIdentification());\n+\n+        final ResponseMetadata newResponseMetadata = this.responseMetadataFactory\n+                .createWithNewCorrelationUid(responseMetadata);\n+\n+        final Iec60870Device device = this.iec60870DeviceRepository\n+                .findByDeviceIdentification(responseMetadata.getDeviceIdentification())\n+                .orElseThrow(AsduHandlerException.withMessage(\"Device not found.\"));", "originalCommit": "fe0b7ca82a87fe498e297f0643379226e04bdc57", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTUzMzYzOQ==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r409533639", "bodyText": "Refactored code, errors will be logged instead of throwing exceptions.", "author": "smvdheijden", "createdAt": "2020-04-16T12:57:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjY1NjY5Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjY3NDE2OA==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r406674168", "bodyText": "This code assumes at least a single element is present for measurements in the measurement group and measurement elements in the measurement.\nIs it safe to assume that these will always be present, or should a clearer exception than an IndexOutOfBoundsException be thrown?\nIs there any reason not to check if there is more than one element in these collections, and throw an exception or log a warning if this would be the case?", "author": "bvdzwet", "createdAt": "2020-04-10T09:08:09Z", "path": "osgp/protocol-adapter-iec60870/osgp-protocol-adapter-iec60870/src/main/java/org/opensmartgridplatform/adapter/protocol/iec60870/application/services/LightMeasurementGatewayDeviceResponseService.java", "diffHunk": "@@ -0,0 +1,94 @@\n+/**\n+ * Copyright 2020 Smart Society Services B.V.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ */\n+\n+package org.opensmartgridplatform.adapter.protocol.iec60870.application.services;\n+\n+import java.util.List;\n+import java.util.Optional;\n+\n+import org.opensmartgridplatform.adapter.protocol.iec60870.domain.entities.Iec60870Device;\n+import org.opensmartgridplatform.adapter.protocol.iec60870.domain.factories.ResponseMetadataFactory;\n+import org.opensmartgridplatform.adapter.protocol.iec60870.domain.repositories.Iec60870DeviceRepository;\n+import org.opensmartgridplatform.adapter.protocol.iec60870.domain.services.LightMeasurementService;\n+import org.opensmartgridplatform.adapter.protocol.iec60870.domain.valueobjects.DeviceType;\n+import org.opensmartgridplatform.adapter.protocol.iec60870.domain.valueobjects.ResponseMetadata;\n+import org.opensmartgridplatform.dto.da.measurements.MeasurementGroupDto;\n+import org.opensmartgridplatform.dto.da.measurements.MeasurementReportDto;\n+import org.opensmartgridplatform.dto.da.measurements.elements.BitmaskMeasurementElementDto;\n+import org.opensmartgridplatform.dto.valueobjects.LightSensorStatusDto;\n+import org.opensmartgridplatform.shared.infra.jms.MessageType;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.stereotype.Service;\n+\n+@Service\n+public class LightMeasurementGatewayDeviceResponseService extends AbstractDeviceResponseService {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(LightMeasurementGatewayDeviceResponseService.class);\n+\n+    private static final DeviceType DEVICE_TYPE = DeviceType.LIGHT_MEASUREMENT_GATEWAY;\n+\n+    @Autowired\n+    private Iec60870DeviceRepository iec60870DeviceRepository;\n+\n+    @Autowired\n+    private ResponseMetadataFactory responseMetadataFactory;\n+\n+    @Autowired\n+    private LightMeasurementService lightMeasurementService;\n+\n+    public LightMeasurementGatewayDeviceResponseService() {\n+        super(DEVICE_TYPE);\n+    }\n+\n+    @Override\n+    public void process(final MeasurementReportDto measurementReportDto, final ResponseMetadata responseMetadata) {\n+        LOGGER.info(\"Received measurement report {} for light measurement gateway {}.\", measurementReportDto,\n+                responseMetadata.getDeviceIdentification());\n+\n+        final ResponseMetadata newResponseMetadata = this.responseMetadataFactory\n+                .createWithNewCorrelationUid(responseMetadata);\n+\n+        final List<Iec60870Device> lightMeasurementDevices = this.iec60870DeviceRepository\n+                .findByGatewayDeviceIdentification(responseMetadata.getDeviceIdentification());\n+\n+        this.sendLightSensorStatusResponses(measurementReportDto, lightMeasurementDevices, newResponseMetadata);\n+    }\n+\n+    private void sendLightSensorStatusResponses(final MeasurementReportDto measurementReportDto,\n+            final List<Iec60870Device> lightMeasurementDevices, final ResponseMetadata responseMetadata) {\n+\n+        for (final MeasurementGroupDto mg : measurementReportDto.getMeasurementGroups()) {\n+            final Optional<Iec60870Device> device = lightMeasurementDevices.stream()\n+                    .filter(d -> d.getInformationObjectAddress().toString().equals(mg.getIdentification()))\n+                    .findFirst();\n+            device.ifPresent(d -> this.sendLightSensorStatusResponse(mg, d, responseMetadata));\n+        }\n+    }\n+\n+    private void sendLightSensorStatusResponse(final MeasurementGroupDto measurementGroupDto,\n+            final Iec60870Device device, final ResponseMetadata responseMetadata) {\n+        final ResponseMetadata rm = new ResponseMetadata.Builder()\n+                .withCorrelationUid(responseMetadata.getCorrelationUid())\n+                .withDeviceIdentification(device.getDeviceIdentification())\n+                .withDomainInfo(device.getDeviceType().domainType().domainInfo())\n+                .withMessageType(MessageType.GET_LIGHT_SENSOR_STATUS.name())\n+                .withOrganisationIdentification(responseMetadata.getOrganisationIdentification())\n+                .build();\n+\n+        final boolean on = ((BitmaskMeasurementElementDto) measurementGroupDto.getMeasurements()\n+                .get(0)\n+                .getMeasurementElements()\n+                .get(0)).getValue() == 1;", "originalCommit": "fe0b7ca82a87fe498e297f0643379226e04bdc57", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTUzNDQ2Mg==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r409534462", "bodyText": "In the case of light measurement gateway/devices, the result of a general interrogation of the gateway device should result in information objects for each light measurement  device, which in turn is represented as a single-point information element. So for a general interrogation each light measurement device will be represented by a measurement group with a single measurement containing a single measurement element (in the form of a BitmaskMeasurementElementDto).\nFor events this will be different, as they will also contain a timestamp.\nI would expect events to be handled by the LightMeasurementDeviceResponseService though.\nRefactored the code.", "author": "smvdheijden", "createdAt": "2020-04-16T12:58:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjY3NDE2OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjY4MjE3OQ==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r406682179", "bodyText": "Is there a good reason the gateway device modelling is placed in the protocol adapter device?\nLooking at the smart metering domain the protocol adapter does not have this relation.\nThe relation between a device and its gateway device is in OSGP core, where for smart meters the details for identifying the device on the gateway are in the smart_meter table.\nI don't have a firm grasp of what the gateway device in the IEC60870 domain means, but unless there is a good reason it is different, I think it may better be more aligned across the domains.", "author": "bvdzwet", "createdAt": "2020-04-10T09:30:48Z", "path": "osgp/protocol-adapter-iec60870/osgp-protocol-adapter-iec60870/src/main/java/org/opensmartgridplatform/adapter/protocol/iec60870/domain/entities/Iec60870Device.java", "diffHunk": "@@ -27,18 +31,33 @@\n     @Column(unique = true, nullable = false, length = 40)\n     private String deviceIdentification;\n \n+    @Column(nullable = false)\n+    @Enumerated(EnumType.STRING)\n+    private DeviceType deviceType;\n+\n+    @Column\n+    private String gatewayDeviceIdentification;", "originalCommit": "fe0b7ca82a87fe498e297f0643379226e04bdc57", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODgxNzYxNA==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r408817614", "bodyText": "Gatewaydevice is placed here as well in order to prevent access to osgp-core database, while still being able to send light measurement device specific events to osgp-core (reusing existing osgp-core event functionality)", "author": "smvdheijden", "createdAt": "2020-04-15T12:52:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjY4MjE3OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjY4NDkxNA==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r406684914", "bodyText": "This check is a bit different from device.hasGatewayDevice(), it looks cleaner to use the method from the device than to replicate the logic.", "author": "bvdzwet", "createdAt": "2020-04-10T09:38:46Z", "path": "osgp/protocol-adapter-iec60870/osgp-protocol-adapter-iec60870/src/integration-test/java/org/opensmartgridplatform/adapter/protocol/iec60870/integrationtests/steps/ConnectionSteps.java", "diffHunk": "@@ -82,26 +84,43 @@ public void givenIec60870DeviceIsNotConnected() throws ConnectionFailureExceptio\n                 .thenReturn(deviceConnection);\n     }\n \n-    @Given(\"an existing connection with an IEC60870 device\")\n-    public void givenIec60870DeviceIsConnected() throws ClientConnectionAlreadyInCacheException {\n-        LOGGER.debug(\"Given IEC60870 device is connected\");\n-\n+    @Given(\"an existing connection with IEC60870 device {string} of type {string}\")\n+    public void givenIec60870DeviceIsConnected(final String deviceIdentification, final String typeOfDevice)\n+            throws Exception {\n+        LOGGER.debug(\"Given an existing connection with IEC60870 device {} of type {}\", deviceIdentification,\n+                typeOfDevice);\n+        final DeviceType deviceType = DeviceType.valueOf(typeOfDevice);\n         // Make sure the connection event listener works as expected\n-        final ResponseMetadata responseMetadata = new ResponseMetadata.Builder()\n-                .withDeviceIdentification(DEFAULT_DEVICE_IDENTIFICATION)\n-                .withOrganisationIdentification(DEFAULT_ORGANISATION_IDENTIFICATION)\n-                .withDomainInfo(new DomainInfo(DEFAULT_DOMAIN, DEFAULT_DOMAIN_VERSION))\n-                .withMessageType(DEFAULT_MESSAGE_TYPE)\n-                .build();\n+        this.connectionParameters = this.initConnectionParameters(deviceIdentification);\n+        final ResponseMetadata responseMetadata = this.initResponseMetadata(deviceIdentification, deviceType);\n         this.connectionEventListener = new ClientConnectionEventListener(\n                 this.connectionParameters.getDeviceIdentification(), this.connectionCacheSpy,\n                 this.clientAsduHandlerRegistry, responseMetadata);\n \n         // Make sure a connection could be retrieved from the cache\n         // Only needed for scenarios sending requests to a device\n-        final Connection connection = mock(Connection.class);\n-        this.connectionCacheSpy.addConnection(DEFAULT_DEVICE_IDENTIFICATION,\n-                new DeviceConnection(connection, this.connectionParameters));\n+        // final Connection connection = mock(Connection.class);\n+        this.connectionCacheSpy.addConnection(deviceIdentification,\n+                new DeviceConnection(this.connection, this.connectionParameters));\n+    }\n+\n+    @When(\"I connect to IEC60870 device {string}\")\n+    public void whenIConnectToIEC60870Device(final String deviceIdentification) throws Exception {\n+        LOGGER.debug(\"When I connect to IEC60870 device {}\", deviceIdentification);\n+        final Iec60870Device device = this.iec60870DeviceSteps.getDevice(deviceIdentification)\n+                .orElseThrow(() -> new Exception(\"Device not found\"));\n+        final DeviceType deviceType = device.getDeviceType();\n+        String connectionDevice = deviceIdentification;\n+        if (device.getGatewayDeviceIdentification() != null) {", "originalCommit": "fe0b7ca82a87fe498e297f0643379226e04bdc57", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjcxMTQ2Nw==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r406711467", "bodyText": "Any reason this is a checked exception?\nThe advice of Effective Java for instance, is only to use checked exceptions if a caller can avoid the exception by proper use of the API, or if there is something useful the caller can do when the exception is caught.\nI am not sure if these conditions apply here, but I wouldn't think so by what I have seen until now.", "author": "bvdzwet", "createdAt": "2020-04-10T11:06:34Z", "path": "osgp/protocol-adapter-iec60870/osgp-protocol-adapter-iec60870/src/main/java/org/opensmartgridplatform/adapter/protocol/iec60870/domain/exceptions/AsduHandlerException.java", "diffHunk": "@@ -0,0 +1,23 @@\n+/**\n+ * Copyright 2019 Smart Society Services B.V.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ */\n+package org.opensmartgridplatform.adapter.protocol.iec60870.domain.exceptions;\n+\n+import java.util.function.Supplier;\n+\n+public class AsduHandlerException extends Exception {", "originalCommit": "fe0b7ca82a87fe498e297f0643379226e04bdc57", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTUzNTUzMg==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r409535532", "bodyText": "Removed the exception (replaced throwing exceptions by logging errors)", "author": "smvdheijden", "createdAt": "2020-04-16T12:59:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjcxMTQ2Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjcxMzUzMQ==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r406713531", "bodyText": "It feels a little inconsistent that closing all connections is called closeAll... while closing a single connection is called disconnect.", "author": "bvdzwet", "createdAt": "2020-04-10T11:14:21Z", "path": "osgp/protocol-adapter-iec60870/osgp-protocol-adapter-iec60870/src/main/java/org/opensmartgridplatform/adapter/protocol/iec60870/domain/services/ClientConnectionService.java", "diffHunk": "@@ -21,6 +22,24 @@\n      */\n     ClientConnection getConnection(RequestMetadata requestMetadata) throws ConnectionFailureException;\n \n+    /**\n+     * Closes the {@link Connection}, sends a disconnect request and closes the\n+     * socket.\n+     *\n+     * @param deviceIdentification\n+     *            Device for which to close the connection.\n+     */\n+    void disconnect(String deviceIdentification);", "originalCommit": "fe0b7ca82a87fe498e297f0643379226e04bdc57", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTM4NzE2OQ==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r409387169", "bodyText": "Hmm, I think you disconnect a device by closing the connnection, so for a device it would be appropriate to use disconnect?\nAnyway, renamed methods to:\ncloseConnection(String deviceIdentification)\nclose(ClientConnection connection)", "author": "smvdheijden", "createdAt": "2020-04-16T08:47:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjcxMzUzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTU4MzMwOQ==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r409583309", "bodyText": "OK with the rename, maybe if the javadocs had looked more like your explanation, I wouldn't have commented about this.", "author": "bvdzwet", "createdAt": "2020-04-16T14:05:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjcxMzUzMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjcxMzk4Ng==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r406713986", "bodyText": "This documentation reads like implementation notes. For a service I think it may be cleaner to leave these out, or to add them under a section for implementation details that are expected from implementors.", "author": "bvdzwet", "createdAt": "2020-04-10T11:16:11Z", "path": "osgp/protocol-adapter-iec60870/osgp-protocol-adapter-iec60870/src/main/java/org/opensmartgridplatform/adapter/protocol/iec60870/domain/services/ClientConnectionService.java", "diffHunk": "@@ -21,6 +22,24 @@\n      */\n     ClientConnection getConnection(RequestMetadata requestMetadata) throws ConnectionFailureException;\n \n+    /**\n+     * Closes the {@link Connection}, sends a disconnect request and closes the\n+     * socket.", "originalCommit": "fe0b7ca82a87fe498e297f0643379226e04bdc57", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTM2NTgwNQ==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r409365805", "bodyText": "Refactored the code, removing interfaces and renaming ...impl classes, as a result the documentation is gone...", "author": "smvdheijden", "createdAt": "2020-04-16T08:13:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjcxMzk4Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjcyMjI3MA==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r406722270", "bodyText": "No need to be explicit about interface methods being abstract.", "author": "bvdzwet", "createdAt": "2020-04-10T11:44:55Z", "path": "osgp/protocol-adapter-iec60870/osgp-protocol-adapter-iec60870/src/main/java/org/opensmartgridplatform/adapter/protocol/iec60870/domain/services/DeviceResponseService.java", "diffHunk": "@@ -0,0 +1,20 @@\n+/**\n+ * Copyright 2020 Smart Society Services B.V.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ */\n+\n+package org.opensmartgridplatform.adapter.protocol.iec60870.domain.services;\n+\n+import org.opensmartgridplatform.adapter.protocol.iec60870.domain.exceptions.AsduHandlerException;\n+import org.opensmartgridplatform.adapter.protocol.iec60870.domain.valueobjects.ResponseMetadata;\n+import org.opensmartgridplatform.dto.da.measurements.MeasurementReportDto;\n+\n+@FunctionalInterface\n+public interface DeviceResponseService {\n+\n+    abstract void process(MeasurementReportDto measurementReportDto, ResponseMetadata responseMetadata)", "originalCommit": "fe0b7ca82a87fe498e297f0643379226e04bdc57", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODgyMjAzNA==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r408822034", "bodyText": "Probably forgot to remove this when changing from abstract class to interface...", "author": "smvdheijden", "createdAt": "2020-04-15T12:59:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjcyMjI3MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjcyMzI3NQ==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r406723275", "bodyText": "I'd expect an AsduHandlerException with ASDU handlers, not at the level of abstraction that this service appears to be at.\nIt may be my lack of understanding, unlucky naming, or just out of place.", "author": "bvdzwet", "createdAt": "2020-04-10T11:48:40Z", "path": "osgp/protocol-adapter-iec60870/osgp-protocol-adapter-iec60870/src/main/java/org/opensmartgridplatform/adapter/protocol/iec60870/domain/services/DeviceResponseService.java", "diffHunk": "@@ -0,0 +1,20 @@\n+/**\n+ * Copyright 2020 Smart Society Services B.V.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ */\n+\n+package org.opensmartgridplatform.adapter.protocol.iec60870.domain.services;\n+\n+import org.opensmartgridplatform.adapter.protocol.iec60870.domain.exceptions.AsduHandlerException;\n+import org.opensmartgridplatform.adapter.protocol.iec60870.domain.valueobjects.ResponseMetadata;\n+import org.opensmartgridplatform.dto.da.measurements.MeasurementReportDto;\n+\n+@FunctionalInterface\n+public interface DeviceResponseService {\n+\n+    abstract void process(MeasurementReportDto measurementReportDto, ResponseMetadata responseMetadata)\n+            throws AsduHandlerException;", "originalCommit": "fe0b7ca82a87fe498e297f0643379226e04bdc57", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTUzNjg3MA==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r409536870", "bodyText": "Looked convenient to reuse the exception as these services are only used from within the ASDU handlers.\nRefactored code to log errors instead of throwing exceptions...", "author": "smvdheijden", "createdAt": "2020-04-16T13:01:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjcyMzI3NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjcyNDA3MA==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r406724070", "bodyText": "The name ending in map suggests map semantics (while the map here looks like it is an implementation detail). Maybe a name not tied to the collection API, but more to the general business purpose would be a bit clearer.", "author": "bvdzwet", "createdAt": "2020-04-10T11:51:25Z", "path": "osgp/protocol-adapter-iec60870/osgp-protocol-adapter-iec60870/src/main/java/org/opensmartgridplatform/adapter/protocol/iec60870/domain/services/DeviceResponseServiceMap.java", "diffHunk": "@@ -0,0 +1,29 @@\n+/**\n+ * Copyright 2020 Smart Society Services B.V.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ */\n+\n+package org.opensmartgridplatform.adapter.protocol.iec60870.domain.services;\n+\n+import java.util.EnumMap;\n+import java.util.Map;\n+\n+import org.opensmartgridplatform.adapter.protocol.iec60870.domain.valueobjects.DeviceType;\n+import org.springframework.stereotype.Component;\n+\n+@Component\n+public class DeviceResponseServiceMap {", "originalCommit": "fe0b7ca82a87fe498e297f0643379226e04bdc57", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTU0MjQ4MA==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r409542480", "bodyText": "Would DeviceResponseServiceRegistry be ok?\nAt least it would be similar to for example the AsduHandlerRegistry.", "author": "smvdheijden", "createdAt": "2020-04-16T13:10:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjcyNDA3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTU4NzM2Mw==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r409587363", "bodyText": "Something with registry seems appropriate, especially if this is used in other places in the code base as well.", "author": "bvdzwet", "createdAt": "2020-04-16T14:10:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjcyNDA3MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjczNTU2OQ==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r406735569", "bodyText": "Regarding the withNewCorrelationUid, I commented before about why this is done.\nBy now I have become aware of the ClientConnectionEventListener that has ResponseMetadata for a device, created when the connection was set up.\nI would suspect that it might be better to create the new correlation UID at the source of something you could follow.\nIn this case, from newASdu, when the asduHandler is called with the response metadata. It may be better to call it from there with a new correlation UID and don't mess with it later-on when the metadata passes other code.", "author": "bvdzwet", "createdAt": "2020-04-10T12:27:42Z", "path": "osgp/protocol-adapter-iec60870/osgp-protocol-adapter-iec60870/src/main/java/org/opensmartgridplatform/adapter/protocol/iec60870/domain/services/asduhandlers/MeasurementAsduHandler.java", "diffHunk": "@@ -50,13 +51,14 @@ public MeasurementAsduHandler(final ASduType asduType) {\n     }\n \n     @Override\n-    public void handleAsdu(final ASdu asdu, final ResponseMetadata responseMetadata) {\n+    public void handleAsdu(final ASdu asdu, final ResponseMetadata responseMetadata) throws AsduHandlerException {\n         LOGGER.info(\"Received measurement of type {}.\", asdu.getTypeIdentification());\n         final ResponseMetadata newResponseMetadata = this.responseMetadataFactory\n                 .createWithNewCorrelationUid(responseMetadata);", "originalCommit": "fe0b7ca82a87fe498e297f0643379226e04bdc57", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTY5MTM1Mw==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r409691353", "bodyText": "Agreed and already updated based on your earlier comment.", "author": "smvdheijden", "createdAt": "2020-04-16T16:30:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjczNTU2OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjgzODg0Ng==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r406838846", "bodyText": "This is fine, but you could consider setting these from constants in ConnectionParameters.\nThe advantage of that could be that the defaults are documented in a way and are easily available to other code if desired.", "author": "bvdzwet", "createdAt": "2020-04-10T16:38:55Z", "path": "osgp/protocol-adapter-iec60870/osgp-protocol-adapter-iec60870/src/main/java/org/opensmartgridplatform/adapter/protocol/iec60870/domain/valueobjects/ConnectionParameters.java", "diffHunk": "@@ -61,10 +61,10 @@ public String toString() {\n     }\n \n     public static class Builder {\n-        private String ipAddress = null;\n+        private String ipAddress = \"localhost\";", "originalCommit": "fe0b7ca82a87fe498e297f0643379226e04bdc57", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODgyNjk2OQ==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r408826969", "bodyText": "Done", "author": "smvdheijden", "createdAt": "2020-04-15T13:08:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjgzODg0Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjgzOTg2Mw==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r406839863", "bodyText": "This is certainly shorter than DISTRIBUTION_AUTOMATION_DEVICE.\nGiven that we usually do not use abbreviations, why do so here, or is DA such a highly established abbreviation that it is more obvious to use than the longer variation? (Would it no longer fit in the database columns where it could end up?)", "author": "bvdzwet", "createdAt": "2020-04-10T16:41:20Z", "path": "osgp/protocol-adapter-iec60870/osgp-protocol-adapter-iec60870/src/main/java/org/opensmartgridplatform/adapter/protocol/iec60870/domain/valueobjects/DeviceType.java", "diffHunk": "@@ -0,0 +1,24 @@\n+/**\n+ * Copyright 2020 Smart Society Services B.V.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ */\n+package org.opensmartgridplatform.adapter.protocol.iec60870.domain.valueobjects;\n+\n+public enum DeviceType {\n+    DA_DEVICE(DomainType.DISTRIBUTION_AUTOMATION),", "originalCommit": "fe0b7ca82a87fe498e297f0643379226e04bdc57", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODgyOTc1OQ==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r408829759", "bodyText": "Changed", "author": "smvdheijden", "createdAt": "2020-04-15T13:12:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjgzOTg2Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjg0NDE3Mw==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r406844173", "bodyText": "It feels odd that the protocol adapter would have to know about stuff like device type and domain.", "author": "bvdzwet", "createdAt": "2020-04-10T16:51:20Z", "path": "osgp/protocol-adapter-iec60870/osgp-protocol-adapter-iec60870/src/main/java/org/opensmartgridplatform/adapter/protocol/iec60870/domain/valueobjects/DomainType.java", "diffHunk": "@@ -0,0 +1,23 @@\n+/**\n+ * Copyright 2020 Smart Society Services B.V.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ */\n+package org.opensmartgridplatform.adapter.protocol.iec60870.domain.valueobjects;\n+\n+public enum DomainType {", "originalCommit": "fe0b7ca82a87fe498e297f0643379226e04bdc57", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTU1MDI4NQ==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r409550285", "bodyText": "I do partially agree, for most protocol adapters the response messages are also domain specific. For being able to send domain specific messages, some domain knowledge will be needed. Otherwise we would have to create either protocol specific response messages that will need to be understood by the domain adapters (introducing protocol knowledge in the domain adapters) or we would have to define such generic messages so that they can be understood by both protocol and domain adapters, or ???\nThe knowledge of domain was mainly introduced as a means for knowing to which domain adapter the responses should be routed to. For this routing I also added another story on the backlog (FLEX-5304, which also contains a still unanswered question about some routing options, maybe you can have a look as well?)\nIn the meantime it will probably be sufficient for now to reuse the domain info transferred from the request metadata into the response metadata, which should be available in the client connection event listener/asdu handlers...", "author": "smvdheijden", "createdAt": "2020-04-16T13:21:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjg0NDE3Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjg0OTM1Nw==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r406849357", "bodyText": "Is there some logical place where we could manage values like these as constants?", "author": "bvdzwet", "createdAt": "2020-04-10T17:03:22Z", "path": "osgp/protocol-adapter-iec60870/osgp-protocol-adapter-iec60870/src/main/java/org/opensmartgridplatform/adapter/protocol/iec60870/infra/messaging/processors/ConnectRequestMessageProcessor.java", "diffHunk": "@@ -0,0 +1,77 @@\n+/**\n+ * Copyright 2020 Smart Society Services B.V.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ */\n+package org.opensmartgridplatform.adapter.protocol.iec60870.infra.messaging.processors;\n+\n+import java.io.IOException;\n+\n+import org.openmuc.j60870.ASdu;\n+import org.openmuc.j60870.ASduType;\n+import org.openmuc.j60870.CauseOfTransmission;\n+import org.openmuc.j60870.ie.IeQualifierOfInterrogation;\n+import org.openmuc.j60870.ie.InformationObject;\n+import org.opensmartgridplatform.adapter.protocol.iec60870.domain.services.ClientConnection;\n+import org.opensmartgridplatform.adapter.protocol.iec60870.domain.valueobjects.LogItem;\n+import org.opensmartgridplatform.adapter.protocol.iec60870.domain.valueobjects.RequestMetadata;\n+import org.opensmartgridplatform.adapter.protocol.iec60870.infra.messaging.AbstractMessageProcessor;\n+import org.opensmartgridplatform.shared.exceptionhandling.ComponentType;\n+import org.opensmartgridplatform.shared.exceptionhandling.ProtocolAdapterException;\n+import org.opensmartgridplatform.shared.infra.jms.MessageType;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.stereotype.Component;\n+\n+/**\n+ * Class for processing get health status requests.\n+ */\n+@Component\n+public class ConnectRequestMessageProcessor extends AbstractMessageProcessor {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(ConnectRequestMessageProcessor.class);\n+\n+    public ConnectRequestMessageProcessor() {\n+        super(MessageType.CONNECT);\n+    }\n+\n+    @Override\n+    public void process(final ClientConnection deviceConnection, final RequestMetadata requestMetadata)\n+            throws ProtocolAdapterException {\n+\n+        final String deviceIdentification = requestMetadata.getDeviceIdentification();\n+        final String organisationIdentification = requestMetadata.getOrganisationIdentification();\n+\n+        LOGGER.info(\"Connect request for IEC60870 device {} for organisation {}\", deviceIdentification,\n+                organisationIdentification);\n+        LOGGER.info(\"Starting general interrogation for IEC60870 device {}\", deviceIdentification);\n+\n+        try {\n+            // Perform general interrogation\n+            final int ieQualifierOfInterrogationValue = 20;", "originalCommit": "fe0b7ca82a87fe498e297f0643379226e04bdc57", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODg0OTc5Ng==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r408849796", "bodyText": "Would have been nice to have an enum for these values in j60870 library.\nIt looks like a subset of the CauseOfTransmission.\nCreated an enum in osgp-iec0870, although we will probably only be using INTERROGATED_BY_STATION <20> for now.", "author": "smvdheijden", "createdAt": "2020-04-15T13:40:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjg0OTM1Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTU5NTQ5Mw==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r409595493", "bodyText": "This brings back memories from some changes in the DLMS library where enums exist(ed) for many types, which we found useful, but they are/were deprecated by the library maintainers and may be removed any time.", "author": "bvdzwet", "createdAt": "2020-04-16T14:20:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjg0OTM1Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjg1MDg4MA==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r406850880", "bodyText": "It would probably be a little more robust if the CauseOfTransmission would be in a local variable, like the commonAddress and the ieQualifierOfInterrogationValue. By repeating it there is always the risk these get out of sync by code modifications, making the message misleading. Same for the IeQualifierOfInterrogation.\nThen again, this creation of an object that will presumably be generated elsewhere looks dodgy. If the library changes how would you know you are logging the correct information? (Or is there some test for this?)", "author": "bvdzwet", "createdAt": "2020-04-10T17:07:10Z", "path": "osgp/protocol-adapter-iec60870/osgp-protocol-adapter-iec60870/src/main/java/org/opensmartgridplatform/adapter/protocol/iec60870/infra/messaging/processors/ConnectRequestMessageProcessor.java", "diffHunk": "@@ -0,0 +1,77 @@\n+/**\n+ * Copyright 2020 Smart Society Services B.V.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ */\n+package org.opensmartgridplatform.adapter.protocol.iec60870.infra.messaging.processors;\n+\n+import java.io.IOException;\n+\n+import org.openmuc.j60870.ASdu;\n+import org.openmuc.j60870.ASduType;\n+import org.openmuc.j60870.CauseOfTransmission;\n+import org.openmuc.j60870.ie.IeQualifierOfInterrogation;\n+import org.openmuc.j60870.ie.InformationObject;\n+import org.opensmartgridplatform.adapter.protocol.iec60870.domain.services.ClientConnection;\n+import org.opensmartgridplatform.adapter.protocol.iec60870.domain.valueobjects.LogItem;\n+import org.opensmartgridplatform.adapter.protocol.iec60870.domain.valueobjects.RequestMetadata;\n+import org.opensmartgridplatform.adapter.protocol.iec60870.infra.messaging.AbstractMessageProcessor;\n+import org.opensmartgridplatform.shared.exceptionhandling.ComponentType;\n+import org.opensmartgridplatform.shared.exceptionhandling.ProtocolAdapterException;\n+import org.opensmartgridplatform.shared.infra.jms.MessageType;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.stereotype.Component;\n+\n+/**\n+ * Class for processing get health status requests.\n+ */\n+@Component\n+public class ConnectRequestMessageProcessor extends AbstractMessageProcessor {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(ConnectRequestMessageProcessor.class);\n+\n+    public ConnectRequestMessageProcessor() {\n+        super(MessageType.CONNECT);\n+    }\n+\n+    @Override\n+    public void process(final ClientConnection deviceConnection, final RequestMetadata requestMetadata)\n+            throws ProtocolAdapterException {\n+\n+        final String deviceIdentification = requestMetadata.getDeviceIdentification();\n+        final String organisationIdentification = requestMetadata.getOrganisationIdentification();\n+\n+        LOGGER.info(\"Connect request for IEC60870 device {} for organisation {}\", deviceIdentification,\n+                organisationIdentification);\n+        LOGGER.info(\"Starting general interrogation for IEC60870 device {}\", deviceIdentification);\n+\n+        try {\n+            // Perform general interrogation\n+            final int ieQualifierOfInterrogationValue = 20;\n+            final int originatorAddress = 0;\n+            final int commonAddress = deviceConnection.getConnectionParameters().getCommonAddress();\n+\n+            deviceConnection.getConnection()\n+                    .interrogation(commonAddress, CauseOfTransmission.ACTIVATION,\n+                            new IeQualifierOfInterrogation(ieQualifierOfInterrogationValue));\n+\n+            // interrogation command creates this asdu internally, however we\n+            // need it here as well for logging...\n+            final ASdu asdu = new ASdu(ASduType.C_IC_NA_1, false, CauseOfTransmission.ACTIVATION, false, false,", "originalCommit": "fe0b7ca82a87fe498e297f0643379226e04bdc57", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODg3MzM0Mg==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r408873342", "bodyText": "Created local variables and added unit test.", "author": "smvdheijden", "createdAt": "2020-04-15T14:11:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjg1MDg4MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjg1Mzk5Mw==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r406853993", "bodyText": "This is not about requesting the health status that failed, but the connect/interrogation.", "author": "bvdzwet", "createdAt": "2020-04-10T17:14:39Z", "path": "osgp/protocol-adapter-iec60870/osgp-protocol-adapter-iec60870/src/main/java/org/opensmartgridplatform/adapter/protocol/iec60870/infra/messaging/processors/ConnectRequestMessageProcessor.java", "diffHunk": "@@ -0,0 +1,77 @@\n+/**\n+ * Copyright 2020 Smart Society Services B.V.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ */\n+package org.opensmartgridplatform.adapter.protocol.iec60870.infra.messaging.processors;\n+\n+import java.io.IOException;\n+\n+import org.openmuc.j60870.ASdu;\n+import org.openmuc.j60870.ASduType;\n+import org.openmuc.j60870.CauseOfTransmission;\n+import org.openmuc.j60870.ie.IeQualifierOfInterrogation;\n+import org.openmuc.j60870.ie.InformationObject;\n+import org.opensmartgridplatform.adapter.protocol.iec60870.domain.services.ClientConnection;\n+import org.opensmartgridplatform.adapter.protocol.iec60870.domain.valueobjects.LogItem;\n+import org.opensmartgridplatform.adapter.protocol.iec60870.domain.valueobjects.RequestMetadata;\n+import org.opensmartgridplatform.adapter.protocol.iec60870.infra.messaging.AbstractMessageProcessor;\n+import org.opensmartgridplatform.shared.exceptionhandling.ComponentType;\n+import org.opensmartgridplatform.shared.exceptionhandling.ProtocolAdapterException;\n+import org.opensmartgridplatform.shared.infra.jms.MessageType;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.stereotype.Component;\n+\n+/**\n+ * Class for processing get health status requests.\n+ */\n+@Component\n+public class ConnectRequestMessageProcessor extends AbstractMessageProcessor {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(ConnectRequestMessageProcessor.class);\n+\n+    public ConnectRequestMessageProcessor() {\n+        super(MessageType.CONNECT);\n+    }\n+\n+    @Override\n+    public void process(final ClientConnection deviceConnection, final RequestMetadata requestMetadata)\n+            throws ProtocolAdapterException {\n+\n+        final String deviceIdentification = requestMetadata.getDeviceIdentification();\n+        final String organisationIdentification = requestMetadata.getOrganisationIdentification();\n+\n+        LOGGER.info(\"Connect request for IEC60870 device {} for organisation {}\", deviceIdentification,\n+                organisationIdentification);\n+        LOGGER.info(\"Starting general interrogation for IEC60870 device {}\", deviceIdentification);\n+\n+        try {\n+            // Perform general interrogation\n+            final int ieQualifierOfInterrogationValue = 20;\n+            final int originatorAddress = 0;\n+            final int commonAddress = deviceConnection.getConnectionParameters().getCommonAddress();\n+\n+            deviceConnection.getConnection()\n+                    .interrogation(commonAddress, CauseOfTransmission.ACTIVATION,\n+                            new IeQualifierOfInterrogation(ieQualifierOfInterrogationValue));\n+\n+            // interrogation command creates this asdu internally, however we\n+            // need it here as well for logging...\n+            final ASdu asdu = new ASdu(ASduType.C_IC_NA_1, false, CauseOfTransmission.ACTIVATION, false, false,\n+                    originatorAddress, commonAddress,\n+                    new InformationObject(0, new IeQualifierOfInterrogation(ieQualifierOfInterrogationValue)));\n+\n+            final LogItem logItem = new LogItem(deviceIdentification, organisationIdentification, false,\n+                    asdu.toString());\n+\n+            this.getLoggingService().log(logItem);\n+\n+        } catch (final IOException | RuntimeException e) {\n+            LOGGER.warn(\"Requesting the health status for device {} failed\", deviceIdentification, e);", "originalCommit": "fe0b7ca82a87fe498e297f0643379226e04bdc57", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODg3NDYwNQ==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r408874605", "bodyText": "Updated message.", "author": "smvdheijden", "createdAt": "2020-04-15T14:13:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjg1Mzk5Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjg1NzA2NA==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r406857064", "bodyText": "Do all processors execute a general interrogation, with CoT ACTIVATION?\nMaybe this is how it works, but it looks surprising if you don't know the protocol and see all the different processors (connect, health status, light sensor status) do the same thing.\nIf it indeed needs to be the same everywhere, shouldn't this be refactored to avoid the duplication?", "author": "bvdzwet", "createdAt": "2020-04-10T17:22:05Z", "path": "osgp/protocol-adapter-iec60870/osgp-protocol-adapter-iec60870/src/main/java/org/opensmartgridplatform/adapter/protocol/iec60870/infra/messaging/processors/GetLightSensorStatusRequestMessageProcessor.java", "diffHunk": "@@ -0,0 +1,77 @@\n+/**\n+ * Copyright 2020 Smart Society Services B.V.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ */\n+package org.opensmartgridplatform.adapter.protocol.iec60870.infra.messaging.processors;\n+\n+import java.io.IOException;\n+\n+import org.openmuc.j60870.ASdu;\n+import org.openmuc.j60870.ASduType;\n+import org.openmuc.j60870.CauseOfTransmission;\n+import org.openmuc.j60870.ie.IeQualifierOfInterrogation;\n+import org.openmuc.j60870.ie.InformationObject;\n+import org.opensmartgridplatform.adapter.protocol.iec60870.domain.services.ClientConnection;\n+import org.opensmartgridplatform.adapter.protocol.iec60870.domain.valueobjects.LogItem;\n+import org.opensmartgridplatform.adapter.protocol.iec60870.domain.valueobjects.RequestMetadata;\n+import org.opensmartgridplatform.adapter.protocol.iec60870.infra.messaging.AbstractMessageProcessor;\n+import org.opensmartgridplatform.shared.exceptionhandling.ComponentType;\n+import org.opensmartgridplatform.shared.exceptionhandling.ProtocolAdapterException;\n+import org.opensmartgridplatform.shared.infra.jms.MessageType;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.stereotype.Component;\n+\n+/**\n+ * Class for processing get light sensor status requests.\n+ */\n+@Component\n+public class GetLightSensorStatusRequestMessageProcessor extends AbstractMessageProcessor {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(GetLightSensorStatusRequestMessageProcessor.class);\n+\n+    public GetLightSensorStatusRequestMessageProcessor() {\n+        super(MessageType.GET_LIGHT_SENSOR_STATUS);\n+    }\n+\n+    @Override\n+    public void process(final ClientConnection deviceConnection, final RequestMetadata requestMetadata)\n+            throws ProtocolAdapterException {\n+\n+        final String deviceIdentification = requestMetadata.getDeviceIdentification();\n+        final String organisationIdentification = requestMetadata.getOrganisationIdentification();\n+\n+        LOGGER.info(\"Get light sensor status request for IEC60870 device {} for organisation {}\", deviceIdentification,\n+                organisationIdentification);\n+\n+        try {\n+            // Perform general interrogation\n+            final int ieQualifierOfInterrogationValue = 20;\n+            final int originatorAddress = 0;\n+            final int commonAddress = deviceConnection.getConnectionParameters().getCommonAddress();\n+\n+            deviceConnection.getConnection()\n+                    .interrogation(commonAddress, CauseOfTransmission.ACTIVATION,\n+                            new IeQualifierOfInterrogation(ieQualifierOfInterrogationValue));", "originalCommit": "fe0b7ca82a87fe498e297f0643379226e04bdc57", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDA3Nzk2MA==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r410077960", "bodyText": "The get health status message processor could probably be removed once the connection restore mechanism uses the connect requests.\nThe get light sensor status should unfortunately use the general interrogation as well, because the read command will not be supported in the actual light measurement device implementation.\nRefactored duplicated code into a new GeneralInterrogationService class.", "author": "smvdheijden", "createdAt": "2020-04-17T08:39:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjg1NzA2NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjg1ODc4MA==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r406858780", "bodyText": "Should there be constraints so that either both the gateway_device_identification and information_object_address are set or neither?\nIf an information_object_address should be unique for iec60870_device per gateway device, is this enforced? (Would it be possible through constraints, or logic in the services/repositories?)", "author": "bvdzwet", "createdAt": "2020-04-10T17:26:20Z", "path": "osgp/protocol-adapter-iec60870/osgp-protocol-adapter-iec60870/src/main/resources/db/migration/V20200408162500000__Additional_device_fields.sql", "diffHunk": "@@ -0,0 +1,17 @@\n+DO $$\n+BEGIN\n+\n+  IF NOT EXISTS(SELECT 1 FROM information_schema.columns WHERE table_schema = current_schema AND table_name = 'iec60870_device' AND column_name = 'device_type')\n+  THEN\n+  \tALTER TABLE iec60870_device ADD COLUMN device_type VARCHAR(255) NOT NULL DEFAULT 'DA_DEVICE';\n+  \tALTER TABLE iec60870_device ADD COLUMN gateway_device_identification VARCHAR(40);\n+  \tALTER TABLE iec60870_device ADD COLUMN information_object_address INTEGER;", "originalCommit": "fe0b7ca82a87fe498e297f0643379226e04bdc57", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTY4NjE1Nw==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r409686157", "bodyText": "Added additional unique and check constraints.\nWas wondering if it would make sense to include device_type as well in the check?\n(for now, only for device type 'LIGHT_MEASUREMENT_DEVICE' both gateway_device_identification and information_object_address should be set, otherwise both should be null)", "author": "smvdheijden", "createdAt": "2020-04-16T16:22:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjg1ODc4MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzkyNTc4MA==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r407925780", "bodyText": "Not from the changes in this pull request, but this looks like a painfully over-complicated way to do the same as could be accomplished with System.currentTimeMillis().", "author": "bvdzwet", "createdAt": "2020-04-14T07:34:56Z", "path": "osgp/protocol-adapter-iec60870/osgp-protocol-adapter-iec60870/src/test/java/org/opensmartgridplatform/adapter/protocol/iec60870/application/mapping/Iec60870InformationObjectConverterTest.java", "diffHunk": "@@ -31,17 +33,24 @@\n \n     private static final long TIMESTAMP_NOW = ZonedDateTime.now(ZoneOffset.UTC).toInstant().toEpochMilli();", "originalCommit": "fe0b7ca82a87fe498e297f0643379226e04bdc57", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODg4MzM5MQ==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r408883391", "bodyText": "Updated", "author": "smvdheijden", "createdAt": "2020-04-15T14:25:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzkyNTc4MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzkyOTkwMg==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r407929902", "bodyText": "2020?", "author": "bvdzwet", "createdAt": "2020-04-14T07:42:15Z", "path": "osgp/protocol-adapter-iec60870/osgp-protocol-adapter-iec60870/src/test/java/org/opensmartgridplatform/adapter/protocol/iec60870/application/mapping/informationelements/IeSinglePointWithQualityConverterTest.java", "diffHunk": "@@ -0,0 +1,120 @@\n+/**\n+ * Copyright 2019 Smart Society Services B.V.", "originalCommit": "fe0b7ca82a87fe498e297f0643379226e04bdc57", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODg4Mzg0OQ==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r408883849", "bodyText": "Done", "author": "smvdheijden", "createdAt": "2020-04-15T14:25:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzkyOTkwMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzkzMzEzNg==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r407933136", "bodyText": "I am fine with the bit-shifting if it is your preference, but wanted to check you have considered using binary literals instead? I personally find for small values like single bytes they are quite expressive (e.g. 0b00010000 instead of 1 << 4).", "author": "bvdzwet", "createdAt": "2020-04-14T07:48:10Z", "path": "osgp/protocol-adapter-iec60870/osgp-protocol-adapter-iec60870/src/test/java/org/opensmartgridplatform/adapter/protocol/iec60870/application/mapping/informationelements/IeSinglePointWithQualityConverterTest.java", "diffHunk": "@@ -0,0 +1,120 @@\n+/**\n+ * Copyright 2019 Smart Society Services B.V.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ */\n+package org.opensmartgridplatform.adapter.protocol.iec60870.application.mapping.informationelements;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+\n+import org.junit.jupiter.api.Test;\n+import org.openmuc.j60870.ie.IeSinglePointWithQuality;\n+import org.opensmartgridplatform.dto.da.measurements.elements.BitmaskMeasurementElementDto;\n+\n+public class IeSinglePointWithQualityConverterTest {\n+\n+    private static final int IE_OFF = 0;\n+    private static final int IE_ON = 1 << 0;\n+    private static final int IE_QUALITY_BLOCKED = 1 << 4;", "originalCommit": "fe0b7ca82a87fe498e297f0643379226e04bdc57", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODg5NDAzNQ==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r408894035", "bodyText": "I had not considered them yet, refactored the code...", "author": "smvdheijden", "createdAt": "2020-04-15T14:38:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzkzMzEzNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzkzNjE4Mw==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r407936183", "bodyText": "This will work, since the distinct values do not have overlapping bit values. It feels semantically more appropriate however in case of combining bit patterns, to use | (bitwise inclusive or) instead of + (addition).", "author": "bvdzwet", "createdAt": "2020-04-14T07:53:35Z", "path": "osgp/protocol-adapter-iec60870/osgp-protocol-adapter-iec60870/src/test/java/org/opensmartgridplatform/adapter/protocol/iec60870/application/mapping/informationelements/IeSinglePointWithQualityConverterTest.java", "diffHunk": "@@ -0,0 +1,120 @@\n+/**\n+ * Copyright 2019 Smart Society Services B.V.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ */\n+package org.opensmartgridplatform.adapter.protocol.iec60870.application.mapping.informationelements;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+\n+import org.junit.jupiter.api.Test;\n+import org.openmuc.j60870.ie.IeSinglePointWithQuality;\n+import org.opensmartgridplatform.dto.da.measurements.elements.BitmaskMeasurementElementDto;\n+\n+public class IeSinglePointWithQualityConverterTest {\n+\n+    private static final int IE_OFF = 0;\n+    private static final int IE_ON = 1 << 0;\n+    private static final int IE_QUALITY_BLOCKED = 1 << 4;\n+    private static final int IE_QUALITY_SUBSTITUTED = 1 << 5;\n+    private static final int IE_QUALITY_NOT_TOPICAL = 1 << 6;\n+    private static final int IE_QUALITY_INVALID = 1 << 7;\n+    private static final int IE_ALL = IE_ON + IE_QUALITY_BLOCKED + IE_QUALITY_SUBSTITUTED + IE_QUALITY_NOT_TOPICAL\n+            + IE_QUALITY_INVALID;", "originalCommit": "fe0b7ca82a87fe498e297f0643379226e04bdc57", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODg5NTMyMQ==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r408895321", "bodyText": "Updated", "author": "smvdheijden", "createdAt": "2020-04-15T14:40:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzkzNjE4Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzk0ODY3MA==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r407948670", "bodyText": "Starting test method names with test looks like a reminder of an old JUnit convention to identify test methods (for which we have the Test annotation now).", "author": "bvdzwet", "createdAt": "2020-04-14T08:14:17Z", "path": "osgp/protocol-adapter-iec60870/osgp-protocol-adapter-iec60870/src/test/java/org/opensmartgridplatform/adapter/protocol/iec60870/domain/services/ClientConnectionServiceImplTest.java", "diffHunk": "@@ -0,0 +1,230 @@\n+/**\n+ * Copyright 2020 Smart Society Services B.V.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ */\n+\n+package org.opensmartgridplatform.adapter.protocol.iec60870.domain.services;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.ArgumentMatchers.any;\n+import static org.mockito.ArgumentMatchers.eq;\n+import static org.mockito.Mockito.verify;\n+import static org.mockito.Mockito.when;\n+\n+import java.util.Optional;\n+\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.extension.ExtendWith;\n+import org.mockito.InjectMocks;\n+import org.mockito.Mock;\n+import org.mockito.Spy;\n+import org.mockito.junit.jupiter.MockitoExtension;\n+import org.openmuc.j60870.ConnectionEventListener;\n+import org.opensmartgridplatform.adapter.protocol.iec60870.domain.entities.Iec60870Device;\n+import org.opensmartgridplatform.adapter.protocol.iec60870.domain.repositories.Iec60870DeviceRepository;\n+import org.opensmartgridplatform.adapter.protocol.iec60870.domain.valueobjects.RequestMetadata;\n+import org.opensmartgridplatform.adapter.protocol.iec60870.testutils.factories.ClientConnectionFactory;\n+import org.opensmartgridplatform.adapter.protocol.iec60870.testutils.factories.Iec60870DeviceFactory;\n+import org.opensmartgridplatform.adapter.protocol.iec60870.testutils.factories.RequestMetadataFactory;\n+\n+@ExtendWith(MockitoExtension.class)\n+public class ClientConnectionServiceImplTest {\n+\n+    @InjectMocks\n+    private ClientConnectionServiceImpl clientConnectionService;\n+\n+    @Spy\n+    private ClientConnectionCacheImpl connectionCache;\n+\n+    @Mock\n+    private Client iec60870Client;\n+\n+    @Mock\n+    private Iec60870DeviceRepository iec60870DeviceRepository;\n+\n+    @Mock\n+    private ClientAsduHandlerRegistry clientAsduHandlerRegistry;\n+\n+    /**\n+     * Test method for\n+     * {@link org.opensmartgridplatform.adapter.protocol.iec60870.domain.services.ClientConnectionServiceImpl#getConnection(org.opensmartgridplatform.adapter.protocol.iec60870.domain.valueobjects.RequestMetadata)}.\n+     *\n+     * @throws Exception\n+     */\n+    @Test\n+    void testGetConnectionShouldReturnExistingConnectionWhenInCache() throws Exception {", "originalCommit": "fe0b7ca82a87fe498e297f0643379226e04bdc57", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODg5ODEzMw==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r408898133", "bodyText": "Personally I prefer to start test methods with should, however Tests methods are still created starting with test when creating new JUnit test cases in Eclipse...", "author": "smvdheijden", "createdAt": "2020-04-15T14:44:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzk0ODY3MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzk1MDQ2Mg==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r407950462", "bodyText": "Are these javadocs the result of some form of automatic test generation?\nFor me it feels like some extra lines I should just try to ignore. I believe functionality being tested is better reveilled through well-picked test method names.", "author": "bvdzwet", "createdAt": "2020-04-14T08:17:17Z", "path": "osgp/protocol-adapter-iec60870/osgp-protocol-adapter-iec60870/src/test/java/org/opensmartgridplatform/adapter/protocol/iec60870/domain/services/ClientConnectionServiceImplTest.java", "diffHunk": "@@ -0,0 +1,230 @@\n+/**\n+ * Copyright 2020 Smart Society Services B.V.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ */\n+\n+package org.opensmartgridplatform.adapter.protocol.iec60870.domain.services;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.ArgumentMatchers.any;\n+import static org.mockito.ArgumentMatchers.eq;\n+import static org.mockito.Mockito.verify;\n+import static org.mockito.Mockito.when;\n+\n+import java.util.Optional;\n+\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.extension.ExtendWith;\n+import org.mockito.InjectMocks;\n+import org.mockito.Mock;\n+import org.mockito.Spy;\n+import org.mockito.junit.jupiter.MockitoExtension;\n+import org.openmuc.j60870.ConnectionEventListener;\n+import org.opensmartgridplatform.adapter.protocol.iec60870.domain.entities.Iec60870Device;\n+import org.opensmartgridplatform.adapter.protocol.iec60870.domain.repositories.Iec60870DeviceRepository;\n+import org.opensmartgridplatform.adapter.protocol.iec60870.domain.valueobjects.RequestMetadata;\n+import org.opensmartgridplatform.adapter.protocol.iec60870.testutils.factories.ClientConnectionFactory;\n+import org.opensmartgridplatform.adapter.protocol.iec60870.testutils.factories.Iec60870DeviceFactory;\n+import org.opensmartgridplatform.adapter.protocol.iec60870.testutils.factories.RequestMetadataFactory;\n+\n+@ExtendWith(MockitoExtension.class)\n+public class ClientConnectionServiceImplTest {\n+\n+    @InjectMocks\n+    private ClientConnectionServiceImpl clientConnectionService;\n+\n+    @Spy\n+    private ClientConnectionCacheImpl connectionCache;\n+\n+    @Mock\n+    private Client iec60870Client;\n+\n+    @Mock\n+    private Iec60870DeviceRepository iec60870DeviceRepository;\n+\n+    @Mock\n+    private ClientAsduHandlerRegistry clientAsduHandlerRegistry;\n+\n+    /**\n+     * Test method for\n+     * {@link org.opensmartgridplatform.adapter.protocol.iec60870.domain.services.ClientConnectionServiceImpl#getConnection(org.opensmartgridplatform.adapter.protocol.iec60870.domain.valueobjects.RequestMetadata)}.\n+     *\n+     * @throws Exception\n+     */", "originalCommit": "fe0b7ca82a87fe498e297f0643379226e04bdc57", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODkwNjIzOQ==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r408906239", "bodyText": "Yes, javadocs are automatically created when creating a JUnit test case in Eclipse.\nRemoved them.", "author": "smvdheijden", "createdAt": "2020-04-15T14:54:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzk1MDQ2Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODA2MDM5Ng==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r408060396", "bodyText": "CreatedConnection or NewConnection instead of CreateConnection? (Also in the other method with CreateConnection in its name?)", "author": "bvdzwet", "createdAt": "2020-04-14T11:21:17Z", "path": "osgp/protocol-adapter-iec60870/osgp-protocol-adapter-iec60870/src/test/java/org/opensmartgridplatform/adapter/protocol/iec60870/domain/services/ClientConnectionServiceImplTest.java", "diffHunk": "@@ -0,0 +1,230 @@\n+/**\n+ * Copyright 2020 Smart Society Services B.V.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ */\n+\n+package org.opensmartgridplatform.adapter.protocol.iec60870.domain.services;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.ArgumentMatchers.any;\n+import static org.mockito.ArgumentMatchers.eq;\n+import static org.mockito.Mockito.verify;\n+import static org.mockito.Mockito.when;\n+\n+import java.util.Optional;\n+\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.extension.ExtendWith;\n+import org.mockito.InjectMocks;\n+import org.mockito.Mock;\n+import org.mockito.Spy;\n+import org.mockito.junit.jupiter.MockitoExtension;\n+import org.openmuc.j60870.ConnectionEventListener;\n+import org.opensmartgridplatform.adapter.protocol.iec60870.domain.entities.Iec60870Device;\n+import org.opensmartgridplatform.adapter.protocol.iec60870.domain.repositories.Iec60870DeviceRepository;\n+import org.opensmartgridplatform.adapter.protocol.iec60870.domain.valueobjects.RequestMetadata;\n+import org.opensmartgridplatform.adapter.protocol.iec60870.testutils.factories.ClientConnectionFactory;\n+import org.opensmartgridplatform.adapter.protocol.iec60870.testutils.factories.Iec60870DeviceFactory;\n+import org.opensmartgridplatform.adapter.protocol.iec60870.testutils.factories.RequestMetadataFactory;\n+\n+@ExtendWith(MockitoExtension.class)\n+public class ClientConnectionServiceImplTest {\n+\n+    @InjectMocks\n+    private ClientConnectionServiceImpl clientConnectionService;\n+\n+    @Spy\n+    private ClientConnectionCacheImpl connectionCache;\n+\n+    @Mock\n+    private Client iec60870Client;\n+\n+    @Mock\n+    private Iec60870DeviceRepository iec60870DeviceRepository;\n+\n+    @Mock\n+    private ClientAsduHandlerRegistry clientAsduHandlerRegistry;\n+\n+    /**\n+     * Test method for\n+     * {@link org.opensmartgridplatform.adapter.protocol.iec60870.domain.services.ClientConnectionServiceImpl#getConnection(org.opensmartgridplatform.adapter.protocol.iec60870.domain.valueobjects.RequestMetadata)}.\n+     *\n+     * @throws Exception\n+     */\n+    @Test\n+    void testGetConnectionShouldReturnExistingConnectionWhenInCache() throws Exception {\n+        // Arrange\n+        final String deviceIdentification = \"DA_DVC_1\";\n+        final Iec60870Device device = Iec60870DeviceFactory.createDistributionAutomationDevice(deviceIdentification);\n+        when(this.iec60870DeviceRepository.findByDeviceIdentification(deviceIdentification))\n+                .thenReturn(Optional.of(device));\n+\n+        final RequestMetadata requestMetadata = RequestMetadataFactory.forDevice(deviceIdentification);\n+        final ClientConnection expectedConnection = ClientConnectionFactory.forDevice(deviceIdentification);\n+        this.connectionCache.addConnection(deviceIdentification, expectedConnection);\n+\n+        // Act\n+        final ClientConnection actualConnection = this.clientConnectionService.getConnection(requestMetadata);\n+\n+        // Assert\n+        assertThat(actualConnection).isEqualTo(expectedConnection);\n+    }\n+\n+    /**\n+     * Test method for\n+     * {@link org.opensmartgridplatform.adapter.protocol.iec60870.domain.services.ClientConnectionServiceImpl#getConnection(org.opensmartgridplatform.adapter.protocol.iec60870.domain.valueobjects.RequestMetadata)}.\n+     *\n+     * @throws Exception\n+     */\n+    @Test\n+    void testGetConnectionShouldReturnExistingConnectionToGatewayDeviceWhenInCache() throws Exception {\n+        // Arrange\n+        final String deviceIdentification = \"LM_DVC_1\";\n+        final String gatewayDeviceIdentification = \"LM_GATEWAY_1\";\n+        final Iec60870Device device = Iec60870DeviceFactory.createLightMeasurementDevice(deviceIdentification,\n+                gatewayDeviceIdentification);\n+        when(this.iec60870DeviceRepository.findByDeviceIdentification(deviceIdentification))\n+                .thenReturn(Optional.of(device));\n+\n+        final RequestMetadata requestMetadata = RequestMetadataFactory.forDevice(deviceIdentification);\n+\n+        final ClientConnection expectedConnection = ClientConnectionFactory.forDevice(gatewayDeviceIdentification);\n+        this.connectionCache.addConnection(gatewayDeviceIdentification, expectedConnection);\n+\n+        // Act\n+        final ClientConnection actualConnection = this.clientConnectionService.getConnection(requestMetadata);\n+\n+        // Assert\n+        assertThat(actualConnection).isEqualTo(expectedConnection);\n+    }\n+\n+    /**\n+     * Test method for\n+     * {@link org.opensmartgridplatform.adapter.protocol.iec60870.domain.services.ClientConnectionServiceImpl#getConnection(org.opensmartgridplatform.adapter.protocol.iec60870.domain.valueobjects.RequestMetadata)}.\n+     *\n+     * @throws Exception\n+     */\n+    @Test\n+    void testGetConnectionShouldReturnCreateConnectionWhenNotInCache() throws Exception {", "originalCommit": "fe0b7ca82a87fe498e297f0643379226e04bdc57", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODkxMTIwNg==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r408911206", "bodyText": "Could be I meant to create methods with ShouldCreate instead of ShouldReturnCreate...\nRenamed to ShouldReturnNew...", "author": "smvdheijden", "createdAt": "2020-04-15T15:00:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODA2MDM5Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODIwOTQ5OA==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r408209498", "bodyText": "I found the name with DisconnectString a bit confusing. With a general type like String, the name would be clearer if it was something like DisconnectByDeviceIdentification or so.", "author": "bvdzwet", "createdAt": "2020-04-14T15:03:47Z", "path": "osgp/protocol-adapter-iec60870/osgp-protocol-adapter-iec60870/src/test/java/org/opensmartgridplatform/adapter/protocol/iec60870/domain/services/ClientConnectionServiceImplTest.java", "diffHunk": "@@ -0,0 +1,230 @@\n+/**\n+ * Copyright 2020 Smart Society Services B.V.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ */\n+\n+package org.opensmartgridplatform.adapter.protocol.iec60870.domain.services;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.ArgumentMatchers.any;\n+import static org.mockito.ArgumentMatchers.eq;\n+import static org.mockito.Mockito.verify;\n+import static org.mockito.Mockito.when;\n+\n+import java.util.Optional;\n+\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.extension.ExtendWith;\n+import org.mockito.InjectMocks;\n+import org.mockito.Mock;\n+import org.mockito.Spy;\n+import org.mockito.junit.jupiter.MockitoExtension;\n+import org.openmuc.j60870.ConnectionEventListener;\n+import org.opensmartgridplatform.adapter.protocol.iec60870.domain.entities.Iec60870Device;\n+import org.opensmartgridplatform.adapter.protocol.iec60870.domain.repositories.Iec60870DeviceRepository;\n+import org.opensmartgridplatform.adapter.protocol.iec60870.domain.valueobjects.RequestMetadata;\n+import org.opensmartgridplatform.adapter.protocol.iec60870.testutils.factories.ClientConnectionFactory;\n+import org.opensmartgridplatform.adapter.protocol.iec60870.testutils.factories.Iec60870DeviceFactory;\n+import org.opensmartgridplatform.adapter.protocol.iec60870.testutils.factories.RequestMetadataFactory;\n+\n+@ExtendWith(MockitoExtension.class)\n+public class ClientConnectionServiceImplTest {\n+\n+    @InjectMocks\n+    private ClientConnectionServiceImpl clientConnectionService;\n+\n+    @Spy\n+    private ClientConnectionCacheImpl connectionCache;\n+\n+    @Mock\n+    private Client iec60870Client;\n+\n+    @Mock\n+    private Iec60870DeviceRepository iec60870DeviceRepository;\n+\n+    @Mock\n+    private ClientAsduHandlerRegistry clientAsduHandlerRegistry;\n+\n+    /**\n+     * Test method for\n+     * {@link org.opensmartgridplatform.adapter.protocol.iec60870.domain.services.ClientConnectionServiceImpl#getConnection(org.opensmartgridplatform.adapter.protocol.iec60870.domain.valueobjects.RequestMetadata)}.\n+     *\n+     * @throws Exception\n+     */\n+    @Test\n+    void testGetConnectionShouldReturnExistingConnectionWhenInCache() throws Exception {\n+        // Arrange\n+        final String deviceIdentification = \"DA_DVC_1\";\n+        final Iec60870Device device = Iec60870DeviceFactory.createDistributionAutomationDevice(deviceIdentification);\n+        when(this.iec60870DeviceRepository.findByDeviceIdentification(deviceIdentification))\n+                .thenReturn(Optional.of(device));\n+\n+        final RequestMetadata requestMetadata = RequestMetadataFactory.forDevice(deviceIdentification);\n+        final ClientConnection expectedConnection = ClientConnectionFactory.forDevice(deviceIdentification);\n+        this.connectionCache.addConnection(deviceIdentification, expectedConnection);\n+\n+        // Act\n+        final ClientConnection actualConnection = this.clientConnectionService.getConnection(requestMetadata);\n+\n+        // Assert\n+        assertThat(actualConnection).isEqualTo(expectedConnection);\n+    }\n+\n+    /**\n+     * Test method for\n+     * {@link org.opensmartgridplatform.adapter.protocol.iec60870.domain.services.ClientConnectionServiceImpl#getConnection(org.opensmartgridplatform.adapter.protocol.iec60870.domain.valueobjects.RequestMetadata)}.\n+     *\n+     * @throws Exception\n+     */\n+    @Test\n+    void testGetConnectionShouldReturnExistingConnectionToGatewayDeviceWhenInCache() throws Exception {\n+        // Arrange\n+        final String deviceIdentification = \"LM_DVC_1\";\n+        final String gatewayDeviceIdentification = \"LM_GATEWAY_1\";\n+        final Iec60870Device device = Iec60870DeviceFactory.createLightMeasurementDevice(deviceIdentification,\n+                gatewayDeviceIdentification);\n+        when(this.iec60870DeviceRepository.findByDeviceIdentification(deviceIdentification))\n+                .thenReturn(Optional.of(device));\n+\n+        final RequestMetadata requestMetadata = RequestMetadataFactory.forDevice(deviceIdentification);\n+\n+        final ClientConnection expectedConnection = ClientConnectionFactory.forDevice(gatewayDeviceIdentification);\n+        this.connectionCache.addConnection(gatewayDeviceIdentification, expectedConnection);\n+\n+        // Act\n+        final ClientConnection actualConnection = this.clientConnectionService.getConnection(requestMetadata);\n+\n+        // Assert\n+        assertThat(actualConnection).isEqualTo(expectedConnection);\n+    }\n+\n+    /**\n+     * Test method for\n+     * {@link org.opensmartgridplatform.adapter.protocol.iec60870.domain.services.ClientConnectionServiceImpl#getConnection(org.opensmartgridplatform.adapter.protocol.iec60870.domain.valueobjects.RequestMetadata)}.\n+     *\n+     * @throws Exception\n+     */\n+    @Test\n+    void testGetConnectionShouldReturnCreateConnectionWhenNotInCache() throws Exception {\n+        // Arrange\n+        final String deviceIdentification = \"DA_DVC_1\";\n+        final Iec60870Device device = Iec60870DeviceFactory.createDistributionAutomationDevice(deviceIdentification);\n+        when(this.iec60870DeviceRepository.findByDeviceIdentification(deviceIdentification))\n+                .thenReturn(Optional.of(device));\n+\n+        final RequestMetadata requestMetadata = RequestMetadataFactory.forDevice(deviceIdentification);\n+        final ClientConnection expectedConnection = ClientConnectionFactory.forDevice(deviceIdentification);\n+        when(this.iec60870Client.connect(eq(expectedConnection.getConnectionParameters()),\n+                any(ConnectionEventListener.class))).thenReturn(expectedConnection);\n+\n+        // Act\n+        final ClientConnection actualConnection = this.clientConnectionService.getConnection(requestMetadata);\n+\n+        // Assert\n+        assertThat(actualConnection).isEqualTo(expectedConnection);\n+    }\n+\n+    /**\n+     * Test method for\n+     * {@link org.opensmartgridplatform.adapter.protocol.iec60870.domain.services.ClientConnectionServiceImpl#getConnection(org.opensmartgridplatform.adapter.protocol.iec60870.domain.valueobjects.RequestMetadata)}.\n+     *\n+     * @throws Exception\n+     */\n+    @Test\n+    void testGetConnectionShouldReturnCreateConnectionToGatewayDeviceWhenNotInCache() throws Exception {\n+        // Arrange\n+        final String deviceIdentification = \"LM_DVC_1\";\n+        final String gatewayDeviceIdentification = \"LM_GATEWAY_1\";\n+        final Iec60870Device device = Iec60870DeviceFactory.createLightMeasurementDevice(deviceIdentification,\n+                gatewayDeviceIdentification);\n+        final Iec60870Device gateway = Iec60870DeviceFactory\n+                .createLightMeasurementGatewayDevice(gatewayDeviceIdentification);\n+        when(this.iec60870DeviceRepository.findByDeviceIdentification(deviceIdentification))\n+                .thenReturn(Optional.of(device));\n+        when(this.iec60870DeviceRepository.findByDeviceIdentification(gatewayDeviceIdentification))\n+                .thenReturn(Optional.of(gateway));\n+\n+        final RequestMetadata requestMetadata = RequestMetadataFactory.forDevice(deviceIdentification);\n+        final ClientConnection expectedConnection = ClientConnectionFactory.forDevice(gatewayDeviceIdentification);\n+        when(this.iec60870Client.connect(eq(expectedConnection.getConnectionParameters()),\n+                any(ConnectionEventListener.class))).thenReturn(expectedConnection);\n+\n+        // Act\n+        final ClientConnection actualConnection = this.clientConnectionService.getConnection(requestMetadata);\n+\n+        // Assert\n+        assertThat(actualConnection).isEqualTo(expectedConnection);\n+    }\n+\n+    /**\n+     * Test method for\n+     * {@link org.opensmartgridplatform.adapter.protocol.iec60870.domain.services.ClientConnectionServiceImpl#disconnect(java.lang.String)}.\n+     *\n+     * @throws Exception\n+     */\n+    @Test\n+    void testDisconnectString() throws Exception {", "originalCommit": "fe0b7ca82a87fe498e297f0643379226e04bdc57", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODkxMjg1Nw==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r408912857", "bodyText": "Probably auto-generated method names... Renamed.", "author": "smvdheijden", "createdAt": "2020-04-15T15:02:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODIwOTQ5OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODIyMTQ2Mg==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r408221462", "bodyText": "These should either be final or not follow the naming convention for constants (I'd guess the first).", "author": "bvdzwet", "createdAt": "2020-04-14T15:19:06Z", "path": "osgp/protocol-adapter-iec60870/osgp-protocol-adapter-iec60870/src/test/java/org/opensmartgridplatform/adapter/protocol/iec60870/domain/services/asduhandlers/SinglePointWithQualityAsduHandlerTest.java", "diffHunk": "@@ -0,0 +1,150 @@\n+/**\n+ * Copyright 2020 Smart Society Services B.V.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ */\n+\n+package org.opensmartgridplatform.adapter.protocol.iec60870.domain.services.asduhandlers;\n+\n+import static org.mockito.ArgumentMatchers.any;\n+import static org.mockito.ArgumentMatchers.eq;\n+import static org.mockito.Mockito.verify;\n+import static org.mockito.Mockito.when;\n+\n+import java.util.Arrays;\n+\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.extension.ExtendWith;\n+import org.mockito.InjectMocks;\n+import org.mockito.Mock;\n+import org.mockito.junit.jupiter.MockitoExtension;\n+import org.openmuc.j60870.ASdu;\n+import org.openmuc.j60870.ASduType;\n+import org.openmuc.j60870.CauseOfTransmission;\n+import org.openmuc.j60870.ie.IeSinglePointWithQuality;\n+import org.openmuc.j60870.ie.InformationObject;\n+import org.opensmartgridplatform.adapter.protocol.iec60870.application.services.Iec60870AsduConverterService;\n+import org.opensmartgridplatform.adapter.protocol.iec60870.application.services.LightMeasurementGatewayDeviceResponseService;\n+import org.opensmartgridplatform.adapter.protocol.iec60870.domain.factories.LogItemFactory;\n+import org.opensmartgridplatform.adapter.protocol.iec60870.domain.factories.ResponseMetadataFactory;\n+import org.opensmartgridplatform.adapter.protocol.iec60870.domain.services.DeviceResponseServiceMap;\n+import org.opensmartgridplatform.adapter.protocol.iec60870.domain.services.LoggingService;\n+import org.opensmartgridplatform.adapter.protocol.iec60870.domain.valueobjects.DeviceType;\n+import org.opensmartgridplatform.adapter.protocol.iec60870.domain.valueobjects.LogItem;\n+import org.opensmartgridplatform.adapter.protocol.iec60870.domain.valueobjects.ResponseMetadata;\n+import org.opensmartgridplatform.adapter.protocol.iec60870.testutils.builders.AsduBuilder;\n+import org.opensmartgridplatform.dto.da.measurements.MeasurementDto;\n+import org.opensmartgridplatform.dto.da.measurements.MeasurementElementDto;\n+import org.opensmartgridplatform.dto.da.measurements.MeasurementGroupDto;\n+import org.opensmartgridplatform.dto.da.measurements.MeasurementReportDto;\n+import org.opensmartgridplatform.dto.da.measurements.MeasurementReportHeaderDto;\n+import org.opensmartgridplatform.dto.da.measurements.elements.BitmaskMeasurementElementDto;\n+\n+@ExtendWith(MockitoExtension.class)\n+public class SinglePointWithQualityAsduHandlerTest {\n+\n+    private static final String GATEWAY_DEVICE_IDENTIFICATION = \"TEST-GATEWAY-1\";\n+    private static final DeviceType GATEWAY_DEVICE_TYPE = DeviceType.LIGHT_MEASUREMENT_GATEWAY;\n+    private static final int LMD_1_IOA = 1;\n+    private static final boolean LMD_1_ON = true;\n+    private static final int LMD_2_IOA = 2;\n+    private static final boolean LMD_2_ON = false;\n+    private static String MEASUREMENT_TYPE = ASduType.M_SP_NA_1.name();\n+    private static String MEASUREMENT_REASON = CauseOfTransmission.INTERROGATED_BY_STATION.name();\n+    private static int MEASUREMENT_ORIGINATOR_ADDRESS = 0;\n+    private static int MEASUREMENT_COMMON_ADDRESS = 0;", "originalCommit": "fe0b7ca82a87fe498e297f0643379226e04bdc57", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODkxMzU0OQ==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r408913549", "bodyText": "Added missing finals", "author": "smvdheijden", "createdAt": "2020-04-15T15:03:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODIyMTQ2Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODIyODQ5NA==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r408228494", "bodyText": "Any reason this has default visibility instead of public like most test classes?\nThe same could be questioned regarding the test methods, and other elements that are left with default visibility instead of being public or private.", "author": "bvdzwet", "createdAt": "2020-04-14T15:28:07Z", "path": "osgp/protocol-adapter-iec60870/osgp-protocol-adapter-iec60870/src/test/java/org/opensmartgridplatform/adapter/protocol/iec60870/domain/valueobjects/DomainInfoTest.java", "diffHunk": "@@ -0,0 +1,117 @@\n+/**\n+ * Copyright 2020 Smart Society Services B.V.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ */\n+package org.opensmartgridplatform.adapter.protocol.iec60870.domain.valueobjects;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+\n+import org.junit.jupiter.api.Test;\n+\n+class DomainInfoTest {", "originalCommit": "fe0b7ca82a87fe498e297f0643379226e04bdc57", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODkxNjQxMA==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r408916410", "bodyText": "Auto-generated class and methods\nForgotten for constants....", "author": "smvdheijden", "createdAt": "2020-04-15T15:07:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODIyODQ5NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODIzMDc4MQ==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r408230781", "bodyText": "My initial thoughts were: what does this test? The actual DomainInfo is created just like the expected from the constants.\nMaybe rename the test to something with DomainInfoIsIdentifiedByDomainAndVersion.\nHmm, it appears the equality tests are already elsewhere in this class, making me doubt what this test has to offer?", "author": "bvdzwet", "createdAt": "2020-04-14T15:31:04Z", "path": "osgp/protocol-adapter-iec60870/osgp-protocol-adapter-iec60870/src/test/java/org/opensmartgridplatform/adapter/protocol/iec60870/domain/valueobjects/DomainInfoTest.java", "diffHunk": "@@ -0,0 +1,117 @@\n+/**\n+ * Copyright 2020 Smart Society Services B.V.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ */\n+package org.opensmartgridplatform.adapter.protocol.iec60870.domain.valueobjects;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+\n+import org.junit.jupiter.api.Test;\n+\n+class DomainInfoTest {\n+    static final String DOMAIN_DISTRIBUTION_AUTOMATION = \"DISTRIBUTION_AUTOMATION\";\n+    static final String DOMAIN_PUBLIC_LIGHTING = \"PUBLIC_LIGHTING\";\n+    static final String DOMAIN_VERSION = \"1.0\";\n+    static final DomainInfo DOMAIN_INFO_DISTRIBUTION_AUTOMATION = new DomainInfo(DOMAIN_DISTRIBUTION_AUTOMATION,\n+            DOMAIN_VERSION);\n+    static final DomainInfo DOMAIN_INFO_PUBLIC_LIGHTING = new DomainInfo(DOMAIN_PUBLIC_LIGHTING, DOMAIN_VERSION);\n+\n+    @Test\n+    void testDomainInfo() {", "originalCommit": "fe0b7ca82a87fe498e297f0643379226e04bdc57", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODkzODgyMQ==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r408938821", "bodyText": "Removed", "author": "smvdheijden", "createdAt": "2020-04-15T15:36:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODIzMDc4MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODIzNTEyMQ==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r408235121", "bodyText": "Not necessarily wrong, but a bit over the top I'd say.\nIt looks like this tests that getters return what has been set in the constructor.\nIt's be clearer if the constructor was inside the test if you really want to do this, so you can see inside the test method that the expected value is what was used to create the value object.", "author": "bvdzwet", "createdAt": "2020-04-14T15:37:04Z", "path": "osgp/protocol-adapter-iec60870/osgp-protocol-adapter-iec60870/src/test/java/org/opensmartgridplatform/adapter/protocol/iec60870/domain/valueobjects/DomainInfoTest.java", "diffHunk": "@@ -0,0 +1,117 @@\n+/**\n+ * Copyright 2020 Smart Society Services B.V.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ */\n+package org.opensmartgridplatform.adapter.protocol.iec60870.domain.valueobjects;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+\n+import org.junit.jupiter.api.Test;\n+\n+class DomainInfoTest {\n+    static final String DOMAIN_DISTRIBUTION_AUTOMATION = \"DISTRIBUTION_AUTOMATION\";\n+    static final String DOMAIN_PUBLIC_LIGHTING = \"PUBLIC_LIGHTING\";\n+    static final String DOMAIN_VERSION = \"1.0\";\n+    static final DomainInfo DOMAIN_INFO_DISTRIBUTION_AUTOMATION = new DomainInfo(DOMAIN_DISTRIBUTION_AUTOMATION,\n+            DOMAIN_VERSION);\n+    static final DomainInfo DOMAIN_INFO_PUBLIC_LIGHTING = new DomainInfo(DOMAIN_PUBLIC_LIGHTING, DOMAIN_VERSION);\n+\n+    @Test\n+    void testDomainInfo() {\n+        // Arrange\n+        final DomainInfo expected = DOMAIN_INFO_DISTRIBUTION_AUTOMATION;\n+        // Act\n+        final DomainInfo actual = new DomainInfo(\"DISTRIBUTION_AUTOMATION\", \"1.0\");\n+        // Assert\n+        assertThat(actual).isEqualTo(expected);\n+    }\n+\n+    @Test\n+    void testGetDomain() {\n+        // Arrange\n+        final String expected = DOMAIN_DISTRIBUTION_AUTOMATION;\n+        // Act\n+        final String actual = DOMAIN_INFO_DISTRIBUTION_AUTOMATION.getDomain();\n+        // Assert\n+        assertThat(actual).isEqualTo(expected);\n+    }\n+\n+    @Test\n+    void testGetDomainVersion() {\n+        // Arrange\n+        final String expected = DOMAIN_VERSION;\n+        // Act\n+        final String actual = DOMAIN_INFO_DISTRIBUTION_AUTOMATION.getDomainVersion();\n+        // Assert\n+        assertThat(actual).isEqualTo(expected);\n+    }", "originalCommit": "fe0b7ca82a87fe498e297f0643379226e04bdc57", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODIzODQ3Mg==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r408238472", "bodyText": "For equality test, I see no advantage over assertThat(this).isEqualTo(that). If anything goes wrong chances are the error message is clearer when leaning on the assertions library.\nOther than that, testing equality on identical instances looks a bit over the top.", "author": "bvdzwet", "createdAt": "2020-04-14T15:41:42Z", "path": "osgp/protocol-adapter-iec60870/osgp-protocol-adapter-iec60870/src/test/java/org/opensmartgridplatform/adapter/protocol/iec60870/domain/valueobjects/DomainInfoTest.java", "diffHunk": "@@ -0,0 +1,117 @@\n+/**\n+ * Copyright 2020 Smart Society Services B.V.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ */\n+package org.opensmartgridplatform.adapter.protocol.iec60870.domain.valueobjects;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+\n+import org.junit.jupiter.api.Test;\n+\n+class DomainInfoTest {\n+    static final String DOMAIN_DISTRIBUTION_AUTOMATION = \"DISTRIBUTION_AUTOMATION\";\n+    static final String DOMAIN_PUBLIC_LIGHTING = \"PUBLIC_LIGHTING\";\n+    static final String DOMAIN_VERSION = \"1.0\";\n+    static final DomainInfo DOMAIN_INFO_DISTRIBUTION_AUTOMATION = new DomainInfo(DOMAIN_DISTRIBUTION_AUTOMATION,\n+            DOMAIN_VERSION);\n+    static final DomainInfo DOMAIN_INFO_PUBLIC_LIGHTING = new DomainInfo(DOMAIN_PUBLIC_LIGHTING, DOMAIN_VERSION);\n+\n+    @Test\n+    void testDomainInfo() {\n+        // Arrange\n+        final DomainInfo expected = DOMAIN_INFO_DISTRIBUTION_AUTOMATION;\n+        // Act\n+        final DomainInfo actual = new DomainInfo(\"DISTRIBUTION_AUTOMATION\", \"1.0\");\n+        // Assert\n+        assertThat(actual).isEqualTo(expected);\n+    }\n+\n+    @Test\n+    void testGetDomain() {\n+        // Arrange\n+        final String expected = DOMAIN_DISTRIBUTION_AUTOMATION;\n+        // Act\n+        final String actual = DOMAIN_INFO_DISTRIBUTION_AUTOMATION.getDomain();\n+        // Assert\n+        assertThat(actual).isEqualTo(expected);\n+    }\n+\n+    @Test\n+    void testGetDomainVersion() {\n+        // Arrange\n+        final String expected = DOMAIN_VERSION;\n+        // Act\n+        final String actual = DOMAIN_INFO_DISTRIBUTION_AUTOMATION.getDomainVersion();\n+        // Assert\n+        assertThat(actual).isEqualTo(expected);\n+    }\n+\n+    @Test\n+    void testEqualsReturnsTrueForSameObjects() {\n+        // Arrange\n+        final DomainInfo thisDomainInfo = DOMAIN_INFO_DISTRIBUTION_AUTOMATION;\n+        final DomainInfo otherDomainInfo = DOMAIN_INFO_DISTRIBUTION_AUTOMATION;\n+        // Act\n+        final boolean actual = thisDomainInfo.equals(otherDomainInfo);", "originalCommit": "fe0b7ca82a87fe498e297f0643379226e04bdc57", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTY0NzMxMg==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r409647312", "bodyText": "Hmm, wouldn't that mean that you rely on the underlying implementation of isEqualTo to use the equals method in the class? (Which is of course very likely, but the underlying implementation might be slightly different and not use the equals method in all cases)", "author": "smvdheijden", "createdAt": "2020-04-16T15:27:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODIzODQ3Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODIzOTkxMw==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r408239913", "bodyText": "This makes that I have to scroll and look back at the constants to understand this test.\nIt would stand out more clear if both domain info objects were created in the test I think.", "author": "bvdzwet", "createdAt": "2020-04-14T15:43:37Z", "path": "osgp/protocol-adapter-iec60870/osgp-protocol-adapter-iec60870/src/test/java/org/opensmartgridplatform/adapter/protocol/iec60870/domain/valueobjects/DomainInfoTest.java", "diffHunk": "@@ -0,0 +1,117 @@\n+/**\n+ * Copyright 2020 Smart Society Services B.V.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ */\n+package org.opensmartgridplatform.adapter.protocol.iec60870.domain.valueobjects;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+\n+import org.junit.jupiter.api.Test;\n+\n+class DomainInfoTest {\n+    static final String DOMAIN_DISTRIBUTION_AUTOMATION = \"DISTRIBUTION_AUTOMATION\";\n+    static final String DOMAIN_PUBLIC_LIGHTING = \"PUBLIC_LIGHTING\";\n+    static final String DOMAIN_VERSION = \"1.0\";\n+    static final DomainInfo DOMAIN_INFO_DISTRIBUTION_AUTOMATION = new DomainInfo(DOMAIN_DISTRIBUTION_AUTOMATION,\n+            DOMAIN_VERSION);\n+    static final DomainInfo DOMAIN_INFO_PUBLIC_LIGHTING = new DomainInfo(DOMAIN_PUBLIC_LIGHTING, DOMAIN_VERSION);\n+\n+    @Test\n+    void testDomainInfo() {\n+        // Arrange\n+        final DomainInfo expected = DOMAIN_INFO_DISTRIBUTION_AUTOMATION;\n+        // Act\n+        final DomainInfo actual = new DomainInfo(\"DISTRIBUTION_AUTOMATION\", \"1.0\");\n+        // Assert\n+        assertThat(actual).isEqualTo(expected);\n+    }\n+\n+    @Test\n+    void testGetDomain() {\n+        // Arrange\n+        final String expected = DOMAIN_DISTRIBUTION_AUTOMATION;\n+        // Act\n+        final String actual = DOMAIN_INFO_DISTRIBUTION_AUTOMATION.getDomain();\n+        // Assert\n+        assertThat(actual).isEqualTo(expected);\n+    }\n+\n+    @Test\n+    void testGetDomainVersion() {\n+        // Arrange\n+        final String expected = DOMAIN_VERSION;\n+        // Act\n+        final String actual = DOMAIN_INFO_DISTRIBUTION_AUTOMATION.getDomainVersion();\n+        // Assert\n+        assertThat(actual).isEqualTo(expected);\n+    }\n+\n+    @Test\n+    void testEqualsReturnsTrueForSameObjects() {\n+        // Arrange\n+        final DomainInfo thisDomainInfo = DOMAIN_INFO_DISTRIBUTION_AUTOMATION;\n+        final DomainInfo otherDomainInfo = DOMAIN_INFO_DISTRIBUTION_AUTOMATION;\n+        // Act\n+        final boolean actual = thisDomainInfo.equals(otherDomainInfo);\n+        // Assert\n+        assertThat(actual).isTrue();\n+    }\n+\n+    @Test\n+    void testEqualsReturnsTrueForObjectsWithSameValues() {\n+        // Arrange\n+        final DomainInfo thisDomainInfo = DOMAIN_INFO_DISTRIBUTION_AUTOMATION;", "originalCommit": "fe0b7ca82a87fe498e297f0643379226e04bdc57", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODk0MjkwNA==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r408942904", "bodyText": "Updated", "author": "smvdheijden", "createdAt": "2020-04-15T15:41:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODIzOTkxMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODI0Mjc2OA==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r408242768", "bodyText": "For clearer messages if anything should ever go wrong, I'd just use an assertThat(this).isEqualTo(that) style assertion instead of the isTrue.\nA test name with something like DomainInfoIsIdentifiedByItsValues would look nicer in my opinion, as it is more about what is important than about there being an equals method that returns true.", "author": "bvdzwet", "createdAt": "2020-04-14T15:47:25Z", "path": "osgp/protocol-adapter-iec60870/osgp-protocol-adapter-iec60870/src/test/java/org/opensmartgridplatform/adapter/protocol/iec60870/domain/valueobjects/DomainInfoTest.java", "diffHunk": "@@ -0,0 +1,117 @@\n+/**\n+ * Copyright 2020 Smart Society Services B.V.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ */\n+package org.opensmartgridplatform.adapter.protocol.iec60870.domain.valueobjects;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+\n+import org.junit.jupiter.api.Test;\n+\n+class DomainInfoTest {\n+    static final String DOMAIN_DISTRIBUTION_AUTOMATION = \"DISTRIBUTION_AUTOMATION\";\n+    static final String DOMAIN_PUBLIC_LIGHTING = \"PUBLIC_LIGHTING\";\n+    static final String DOMAIN_VERSION = \"1.0\";\n+    static final DomainInfo DOMAIN_INFO_DISTRIBUTION_AUTOMATION = new DomainInfo(DOMAIN_DISTRIBUTION_AUTOMATION,\n+            DOMAIN_VERSION);\n+    static final DomainInfo DOMAIN_INFO_PUBLIC_LIGHTING = new DomainInfo(DOMAIN_PUBLIC_LIGHTING, DOMAIN_VERSION);\n+\n+    @Test\n+    void testDomainInfo() {\n+        // Arrange\n+        final DomainInfo expected = DOMAIN_INFO_DISTRIBUTION_AUTOMATION;\n+        // Act\n+        final DomainInfo actual = new DomainInfo(\"DISTRIBUTION_AUTOMATION\", \"1.0\");\n+        // Assert\n+        assertThat(actual).isEqualTo(expected);\n+    }\n+\n+    @Test\n+    void testGetDomain() {\n+        // Arrange\n+        final String expected = DOMAIN_DISTRIBUTION_AUTOMATION;\n+        // Act\n+        final String actual = DOMAIN_INFO_DISTRIBUTION_AUTOMATION.getDomain();\n+        // Assert\n+        assertThat(actual).isEqualTo(expected);\n+    }\n+\n+    @Test\n+    void testGetDomainVersion() {\n+        // Arrange\n+        final String expected = DOMAIN_VERSION;\n+        // Act\n+        final String actual = DOMAIN_INFO_DISTRIBUTION_AUTOMATION.getDomainVersion();\n+        // Assert\n+        assertThat(actual).isEqualTo(expected);\n+    }\n+\n+    @Test\n+    void testEqualsReturnsTrueForSameObjects() {\n+        // Arrange\n+        final DomainInfo thisDomainInfo = DOMAIN_INFO_DISTRIBUTION_AUTOMATION;\n+        final DomainInfo otherDomainInfo = DOMAIN_INFO_DISTRIBUTION_AUTOMATION;\n+        // Act\n+        final boolean actual = thisDomainInfo.equals(otherDomainInfo);\n+        // Assert\n+        assertThat(actual).isTrue();\n+    }\n+\n+    @Test\n+    void testEqualsReturnsTrueForObjectsWithSameValues() {\n+        // Arrange\n+        final DomainInfo thisDomainInfo = DOMAIN_INFO_DISTRIBUTION_AUTOMATION;\n+        final DomainInfo otherDomainInfo = new DomainInfo(DOMAIN_DISTRIBUTION_AUTOMATION, DOMAIN_VERSION);\n+        // Act\n+        final boolean actual = thisDomainInfo.equals(otherDomainInfo);", "originalCommit": "fe0b7ca82a87fe498e297f0643379226e04bdc57", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTY5ODM1Ng==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r409698356", "bodyText": "I think I will probably leave this as is for now. I prefer to use the triple-A style of unit testing, with the clear separation between arrange-act-assert in the code (similar to given-when-then in the cucumber tests).", "author": "smvdheijden", "createdAt": "2020-04-16T16:41:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODI0Mjc2OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODI0NzAzNQ==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r408247035", "bodyText": "I wouldn't test the general result of the toString contents.\nIf this is a specifically formatted result that is actually expected to contain certain text, it probably would be better to include another method for that.", "author": "bvdzwet", "createdAt": "2020-04-14T15:53:08Z", "path": "osgp/protocol-adapter-iec60870/osgp-protocol-adapter-iec60870/src/test/java/org/opensmartgridplatform/adapter/protocol/iec60870/domain/valueobjects/DomainInfoTest.java", "diffHunk": "@@ -0,0 +1,117 @@\n+/**\n+ * Copyright 2020 Smart Society Services B.V.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ */\n+package org.opensmartgridplatform.adapter.protocol.iec60870.domain.valueobjects;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+\n+import org.junit.jupiter.api.Test;\n+\n+class DomainInfoTest {\n+    static final String DOMAIN_DISTRIBUTION_AUTOMATION = \"DISTRIBUTION_AUTOMATION\";\n+    static final String DOMAIN_PUBLIC_LIGHTING = \"PUBLIC_LIGHTING\";\n+    static final String DOMAIN_VERSION = \"1.0\";\n+    static final DomainInfo DOMAIN_INFO_DISTRIBUTION_AUTOMATION = new DomainInfo(DOMAIN_DISTRIBUTION_AUTOMATION,\n+            DOMAIN_VERSION);\n+    static final DomainInfo DOMAIN_INFO_PUBLIC_LIGHTING = new DomainInfo(DOMAIN_PUBLIC_LIGHTING, DOMAIN_VERSION);\n+\n+    @Test\n+    void testDomainInfo() {\n+        // Arrange\n+        final DomainInfo expected = DOMAIN_INFO_DISTRIBUTION_AUTOMATION;\n+        // Act\n+        final DomainInfo actual = new DomainInfo(\"DISTRIBUTION_AUTOMATION\", \"1.0\");\n+        // Assert\n+        assertThat(actual).isEqualTo(expected);\n+    }\n+\n+    @Test\n+    void testGetDomain() {\n+        // Arrange\n+        final String expected = DOMAIN_DISTRIBUTION_AUTOMATION;\n+        // Act\n+        final String actual = DOMAIN_INFO_DISTRIBUTION_AUTOMATION.getDomain();\n+        // Assert\n+        assertThat(actual).isEqualTo(expected);\n+    }\n+\n+    @Test\n+    void testGetDomainVersion() {\n+        // Arrange\n+        final String expected = DOMAIN_VERSION;\n+        // Act\n+        final String actual = DOMAIN_INFO_DISTRIBUTION_AUTOMATION.getDomainVersion();\n+        // Assert\n+        assertThat(actual).isEqualTo(expected);\n+    }\n+\n+    @Test\n+    void testEqualsReturnsTrueForSameObjects() {\n+        // Arrange\n+        final DomainInfo thisDomainInfo = DOMAIN_INFO_DISTRIBUTION_AUTOMATION;\n+        final DomainInfo otherDomainInfo = DOMAIN_INFO_DISTRIBUTION_AUTOMATION;\n+        // Act\n+        final boolean actual = thisDomainInfo.equals(otherDomainInfo);\n+        // Assert\n+        assertThat(actual).isTrue();\n+    }\n+\n+    @Test\n+    void testEqualsReturnsTrueForObjectsWithSameValues() {\n+        // Arrange\n+        final DomainInfo thisDomainInfo = DOMAIN_INFO_DISTRIBUTION_AUTOMATION;\n+        final DomainInfo otherDomainInfo = new DomainInfo(DOMAIN_DISTRIBUTION_AUTOMATION, DOMAIN_VERSION);\n+        // Act\n+        final boolean actual = thisDomainInfo.equals(otherDomainInfo);\n+        // Assert\n+        assertThat(actual).isTrue();\n+    }\n+\n+    @Test\n+    void testEqualsReturnsFalseForObjectsWithDifferentDomainValues() {\n+        // Arrange\n+        final DomainInfo thisDomainInfo = new DomainInfo(DOMAIN_DISTRIBUTION_AUTOMATION, DOMAIN_VERSION);\n+        final DomainInfo otherDomainInfo = new DomainInfo(DOMAIN_PUBLIC_LIGHTING, DOMAIN_VERSION);\n+        // Act\n+        final boolean actual = thisDomainInfo.equals(otherDomainInfo);\n+        // Assert\n+        assertThat(actual).isFalse();\n+    }\n+\n+    @Test\n+    void testEqualsReturnsFalseForObjectsWithDifferentDomainVersionValues() {\n+        // Arrange\n+        final DomainInfo thisDomainInfo = new DomainInfo(DOMAIN_DISTRIBUTION_AUTOMATION, \"1.0\");\n+        final DomainInfo otherDomainInfo = new DomainInfo(DOMAIN_DISTRIBUTION_AUTOMATION, \"2.0\");\n+        // Act\n+        final boolean actual = thisDomainInfo.equals(otherDomainInfo);\n+        // Assert\n+        assertThat(actual).isFalse();\n+    }\n+\n+    @Test\n+    void testHashCode() {\n+        // Arrange\n+        final DomainInfo domainInfo = new DomainInfo(DOMAIN_PUBLIC_LIGHTING, DOMAIN_VERSION);\n+        final int expected = DOMAIN_INFO_PUBLIC_LIGHTING.hashCode();\n+        // Act\n+        final int actual = domainInfo.hashCode();\n+        // Assert\n+        assertThat(actual).isEqualTo(expected);\n+    }\n+\n+    @Test\n+    void testToString() {", "originalCommit": "fe0b7ca82a87fe498e297f0643379226e04bdc57", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTU2MzU2NQ==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r409563565", "bodyText": "Result of an overly eager attempt to reach 100% unit test coverage by checking all methods in the add JUnit Test Case dialog in Eclipse..\nThat being said, I believe we still have plenty of classes not properly implementing equals, hashCode and toString...\nFound an external library especially for unit testing toString methods:\nhttps://github.com/jparams/to-string-verifier ;-)\nFor now I guess I'll leave it as is...", "author": "smvdheijden", "createdAt": "2020-04-16T13:39:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODI0NzAzNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODI1MzIyMA==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r408253220", "bodyText": "I find it very hard to understand what this class is testing and why?\nPerhaps there is some good reason to do this, but then I feel it is perhaps not clearly expressed in the test method names.\nSame as with DomainInfoTest regarding the absence of public/private modifiers.", "author": "bvdzwet", "createdAt": "2020-04-14T16:01:27Z", "path": "osgp/protocol-adapter-iec60870/osgp-protocol-adapter-iec60870/src/test/java/org/opensmartgridplatform/adapter/protocol/iec60870/domain/valueobjects/DomainTypeTest.java", "diffHunk": "@@ -0,0 +1,35 @@\n+/**\n+ * Copyright 2020 Smart Society Services B.V.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ */\n+package org.opensmartgridplatform.adapter.protocol.iec60870.domain.valueobjects;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+\n+import org.junit.jupiter.api.Test;\n+\n+class DomainTypeTest {", "originalCommit": "fe0b7ca82a87fe498e297f0643379226e04bdc57", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODk3Mzg5OA==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r408973898", "bodyText": "I thought the DomainType would be a convenient class for the relation between DeviceType and DomainInfo.\nI think we could also use the domain info passed into the original connect request to route event messages to the correct domain. (With the assumption the correct domain info object is used in each connect request) Therefor I've removed the relation between DeviceType and DomainInfo (and thus the DomainType class). Added a DomainInfoFactory with a forDeviceType method only for testing.", "author": "smvdheijden", "createdAt": "2020-04-15T16:27:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODI1MzIyMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODI1NDQzNg==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r408254436", "bodyText": "Why use an abbreviation? I think we generally just take the hit on character count and write things out.", "author": "bvdzwet", "createdAt": "2020-04-14T16:03:08Z", "path": "osgp/protocol-adapter-iec60870/osgp-protocol-adapter-iec60870/src/test/java/org/opensmartgridplatform/adapter/protocol/iec60870/testutils/builders/AsduBuilder.java", "diffHunk": "@@ -0,0 +1,56 @@\n+/**\n+ * Copyright 2020 Smart Society Services B.V.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ */\n+\n+package org.opensmartgridplatform.adapter.protocol.iec60870.testutils.builders;\n+\n+import org.openmuc.j60870.ASdu;\n+import org.openmuc.j60870.ASduType;\n+import org.openmuc.j60870.CauseOfTransmission;\n+import org.openmuc.j60870.ie.InformationObject;\n+\n+public class AsduBuilder {\n+\n+    private final ASduType asduType;\n+    private CauseOfTransmission cot = CauseOfTransmission.SPONTANEOUS;", "originalCommit": "fe0b7ca82a87fe498e297f0643379226e04bdc57", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODg5OTQ2NQ==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r408899465", "bodyText": "Updated", "author": "smvdheijden", "createdAt": "2020-04-15T14:45:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODI1NDQzNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODI1ODQ3MQ==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r408258471", "bodyText": "No license header?", "author": "bvdzwet", "createdAt": "2020-04-14T16:08:47Z", "path": "osgp/protocol-adapter-iec60870/osgp-protocol-adapter-iec60870/src/test/java/org/opensmartgridplatform/adapter/protocol/iec60870/testutils/matchers/AsduMatcher.java", "diffHunk": "@@ -0,0 +1,29 @@\n+package org.opensmartgridplatform.adapter.protocol.iec60870.testutils.matchers;", "originalCommit": "fe0b7ca82a87fe498e297f0643379226e04bdc57", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODg5OTg3Nw==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r408899877", "bodyText": "Done", "author": "smvdheijden", "createdAt": "2020-04-15T14:46:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODI1ODQ3MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODI1OTM5OQ==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r408259399", "bodyText": "2020?", "author": "bvdzwet", "createdAt": "2020-04-14T16:10:07Z", "path": "osgp/protocol-adapter-iec60870/osgp-protocol-adapter-iec60870/src/test/java/org/opensmartgridplatform/adapter/protocol/iec60870/testutils/matchers/GetLightSensorStatusResponseMessageMatcher.java", "diffHunk": "@@ -0,0 +1,44 @@\n+/**\n+ * Copyright 2019 Smart Society Services B.V.", "originalCommit": "fe0b7ca82a87fe498e297f0643379226e04bdc57", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODkwMDExMA==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r408900110", "bodyText": "Done", "author": "smvdheijden", "createdAt": "2020-04-15T14:46:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODI1OTM5OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODI2NjM1Mg==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r408266352", "bodyText": "I am a bit confused why some choices are made.\nFor instance, why is there an extra field for the LightSensorStatusDto, and why are some values in the matches method hard coded, while others compare the values from argument with those from this.responseMessage.\nCouldn't all values be compared based on looking at values of argument and this.responseMessage?\nMaybe this class could even be a more generic ProtocolResponseMessageMatcher then?\nAm I missing something?", "author": "bvdzwet", "createdAt": "2020-04-14T16:20:10Z", "path": "osgp/protocol-adapter-iec60870/osgp-protocol-adapter-iec60870/src/test/java/org/opensmartgridplatform/adapter/protocol/iec60870/testutils/matchers/GetLightSensorStatusResponseMessageMatcher.java", "diffHunk": "@@ -0,0 +1,44 @@\n+/**\n+ * Copyright 2019 Smart Society Services B.V.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ */\n+package org.opensmartgridplatform.adapter.protocol.iec60870.testutils.matchers;\n+\n+import org.mockito.ArgumentMatcher;\n+import org.opensmartgridplatform.dto.valueobjects.LightSensorStatusDto;\n+import org.opensmartgridplatform.shared.infra.jms.MessageType;\n+import org.opensmartgridplatform.shared.infra.jms.ProtocolResponseMessage;\n+import org.opensmartgridplatform.shared.infra.jms.ResponseMessageResultType;\n+\n+public class GetLightSensorStatusResponseMessageMatcher implements ArgumentMatcher<ProtocolResponseMessage> {", "originalCommit": "fe0b7ca82a87fe498e297f0643379226e04bdc57", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODk2ODk1OA==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r408968958", "bodyText": "I guess what happened, was that I started out with creating a matcher for LightSensorStatusDto, but later on noticed that it was contained within a protocol response message...\nAnyway, I've refactored it into a ProtocolResponseMessageMatcher.", "author": "smvdheijden", "createdAt": "2020-04-15T16:19:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODI2NjM1Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODI2Njc5Mw==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r408266793", "bodyText": "No license header?", "author": "bvdzwet", "createdAt": "2020-04-14T16:20:52Z", "path": "osgp/protocol-adapter-iec60870/osgp-protocol-adapter-iec60870/src/test/java/org/opensmartgridplatform/adapter/protocol/iec60870/testutils/matchers/asdu/InterrogationActivationAsduMatcher.java", "diffHunk": "@@ -0,0 +1,20 @@\n+package org.opensmartgridplatform.adapter.protocol.iec60870.testutils.matchers.asdu;", "originalCommit": "fe0b7ca82a87fe498e297f0643379226e04bdc57", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODkwMzg5Mw==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r408903893", "bodyText": "Done", "author": "smvdheijden", "createdAt": "2020-04-15T14:51:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODI2Njc5Mw=="}], "type": "inlineReview"}, {"oid": "38c1094ef037391b349937b1ae58dc4f503750f1", "url": "https://github.com/OSGP/open-smart-grid-platform/commit/38c1094ef037391b349937b1ae58dc4f503750f1", "message": "FLEX-5299 ~ Processes review comments", "committedDate": "2020-04-17T09:34:09Z", "type": "commit"}, {"oid": "4227ff6d166e0c2bf5df18ae178ff8ff20975e48", "url": "https://github.com/OSGP/open-smart-grid-platform/commit/4227ff6d166e0c2bf5df18ae178ff8ff20975e48", "message": "Merge branch 'development' into feature/FLEX-5299-protocol-adapter-iec60870-general-interrogation", "committedDate": "2020-04-17T09:36:53Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDE1MDEzOQ==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r410150139", "bodyText": "License header?", "author": "bvdzwet", "createdAt": "2020-04-17T10:59:54Z", "path": "osgp/protocol-adapter-iec60870/osgp-iec60870/src/main/java/org/opensmartgridplatform/iec60870/QualifierOfInterrogation.java", "diffHunk": "@@ -0,0 +1,62 @@\n+package org.opensmartgridplatform.iec60870;", "originalCommit": "4227ff6d166e0c2bf5df18ae178ff8ff20975e48", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDE2MDEyNw==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r410160127", "bodyText": "I am not to fond of optionals in the code like this. There will often be difficulty in clean and precise naming. The name device, for instance, is a slight mismatch, cause it does not leave room to use device for the actual device in the optional (and optionalDevice would not make me much happier either).\nI think the combination of isPresent() + get() is a very unfortunate use of optionals and the get method should rarely to never be used. Even the optional orElse(null) followed by null check would (in my opinion) be cleaner, but preferences may differ.\nFor now leave it as is I guess, mostly because I would like to have seen the following block changed from if optional isPresent in an ifPresentOrElse construct. My preferred option however is an addition to the Optional API in Java 9, and therefore not yet ready to be applied in our code base.", "author": "bvdzwet", "createdAt": "2020-04-17T11:23:30Z", "path": "osgp/protocol-adapter-iec60870/osgp-protocol-adapter-iec60870/src/main/java/org/opensmartgridplatform/adapter/protocol/iec60870/application/services/LightMeasurementDeviceResponseService.java", "diffHunk": "@@ -48,19 +45,18 @@ public LightMeasurementDeviceResponseService() {\n     }\n \n     @Override\n-    public void process(final MeasurementReportDto measurementReportDto, final ResponseMetadata responseMetadata)\n-            throws AsduHandlerException {\n-        LOGGER.info(\"Received measurement report {} for light measurement gateway {}.\", measurementReportDto,\n+    public void process(final MeasurementReportDto measurementReportDto, final ResponseMetadata responseMetadata) {\n+        LOGGER.info(\"Received measurement report {} for light measurement device {}.\", measurementReportDto,\n                 responseMetadata.getDeviceIdentification());\n \n-        final ResponseMetadata newResponseMetadata = this.responseMetadataFactory\n-                .createWithNewCorrelationUid(responseMetadata);\n-\n-        final Iec60870Device device = this.iec60870DeviceRepository\n-                .findByDeviceIdentification(responseMetadata.getDeviceIdentification())\n-                .orElseThrow(AsduHandlerException.withMessage(\"Device not found.\"));\n+        final Optional<Iec60870Device> device = this.iec60870DeviceRepository\n+                .findByDeviceIdentification(responseMetadata.getDeviceIdentification());", "originalCommit": "4227ff6d166e0c2bf5df18ae178ff8ff20975e48", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDE4NjcxNw==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r410186717", "bodyText": "Doesn't this give issues when you have more than 1 gateway device (both gateway_device_identification and information_object_address being null). This was why I wondered if the constraint could be here or would have to be enforced with repository code.\nUpdate: the unique constraint works fine. Multiple rows with NULL values are accepted. This is not an issue.", "author": "bvdzwet", "createdAt": "2020-04-17T12:23:35Z", "path": "osgp/protocol-adapter-iec60870/osgp-protocol-adapter-iec60870/src/main/resources/db/migration/V20200408162500000__Additional_device_fields.sql", "diffHunk": "@@ -9,6 +9,15 @@ BEGIN\n \n   \tALTER TABLE iec60870_device ALTER COLUMN common_address SET DEFAULT 0;\n \n+    ALTER TABLE iec60870_device\n+      ADD CONSTRAINT iec60870_device_gateway_key\n+        UNIQUE (gateway_device_identification, information_object_address);", "originalCommit": "4227ff6d166e0c2bf5df18ae178ff8ff20975e48", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "a63c8a737af9c44cea3b25a6e6a2b2407fbb2513", "url": "https://github.com/OSGP/open-smart-grid-platform/commit/a63c8a737af9c44cea3b25a6e6a2b2407fbb2513", "message": "Adds missing license header", "committedDate": "2020-04-17T13:10:36Z", "type": "commit"}, {"oid": "d7f4d67480483e10f7a9ebd924e0e36cce424ec2", "url": "https://github.com/OSGP/open-smart-grid-platform/commit/d7f4d67480483e10f7a9ebd924e0e36cce424ec2", "message": "Fixes license header", "committedDate": "2020-04-17T13:14:57Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDIxNDEzOA==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r410214138", "bodyText": "2019?", "author": "bvdzwet", "createdAt": "2020-04-17T13:15:40Z", "path": "osgp/protocol-adapter-iec60870/osgp-iec60870/src/main/java/org/opensmartgridplatform/iec60870/QualifierOfInterrogation.java", "diffHunk": "@@ -1,3 +1,10 @@\n+/**\n+ * Copyright 2019 Smart Society Services B.V.", "originalCommit": "a63c8a737af9c44cea3b25a6e6a2b2407fbb2513", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDIxOTg0OA==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r410219848", "bodyText": "fixed", "author": "smvdheijden", "createdAt": "2020-04-17T13:25:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDIxNDEzOA=="}], "type": "inlineReview"}]}