{"pr_number": 353, "pr_title": "OC-595 Log information about messages on Kafka topics", "pr_createdAt": "2020-06-15T13:13:09Z", "pr_url": "https://github.com/OSGP/open-smart-grid-platform/pull/353", "timeline": [{"oid": "f70e988183faf10635bf2dd292b2446dcd4d53a6", "url": "https://github.com/OSGP/open-smart-grid-platform/commit/f70e988183faf10635bf2dd292b2446dcd4d53a6", "message": "OC-595 ~ Adds logging of Kafka consumer records\n\nAdds KafkaLogger for use with consumer configuration on Kafka topics to\nbe able to log data and metadata of messages that are posted on a topic.\n\nAdds osgp-adapter-kafka-logging as deployable project in servlet\ncontainers with configuration of consumers for currently known topics\nin the GXF code base.\n\nThe configurations of the different logging consumers are subject to a\nSpring conditional, following a boolean property (for instance\npeakshaving.kafka.logging.enabled). Default this enabled property is set\nto false, which should prevent warning or error logging if a Kafka\nbroker is not available for certain topics in a monitored environment.\n\nThe consumed messages for the configured topics will be logged to a file\nspecified in the logback configuration with an appender named MESSAGES.\nThis appender leaves out most of the default stuff that is normally\nadded as context with logged data, leaving only the date and time of\nlogging, and the message that is logged.", "committedDate": "2020-06-15T13:04:42Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDgyNzA5MQ==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/353#discussion_r440827091", "bodyText": "this file can be removed", "author": "robindenadel", "createdAt": "2020-06-16T12:55:47Z", "path": "osgp/platform/osgp-adapter-kafka-logging/src/main/java/org/opensmartgridplatform/adapter/kafka/logging/config/DistributionAutomationLoggingEnabled.java", "diffHunk": "@@ -0,0 +1,22 @@\n+/**", "originalCommit": "f70e988183faf10635bf2dd292b2446dcd4d53a6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDg3NTA5MQ==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/353#discussion_r440875091", "bodyText": "removed", "author": "bvdzwet", "createdAt": "2020-06-16T14:01:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDgyNzA5MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDgyNzMwOQ==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/353#discussion_r440827309", "bodyText": "this file can be removed", "author": "robindenadel", "createdAt": "2020-06-16T12:56:06Z", "path": "osgp/platform/osgp-adapter-kafka-logging/src/main/java/org/opensmartgridplatform/adapter/kafka/logging/config/KafkaDistributionAutomationConsumerConfig.java", "diffHunk": "@@ -0,0 +1,45 @@\n+/**", "originalCommit": "f70e988183faf10635bf2dd292b2446dcd4d53a6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDg3NDkwOQ==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/353#discussion_r440874909", "bodyText": "removed", "author": "bvdzwet", "createdAt": "2020-06-16T14:01:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDgyNzMwOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDgyNzQ5OQ==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/353#discussion_r440827499", "bodyText": "this file can be removed", "author": "robindenadel", "createdAt": "2020-06-16T12:56:25Z", "path": "osgp/platform/osgp-adapter-kafka-logging/src/main/java/org/opensmartgridplatform/adapter/kafka/logging/infra/kafka/in/MeterReadingConsumer.java", "diffHunk": "@@ -0,0 +1,32 @@\n+/**", "originalCommit": "f70e988183faf10635bf2dd292b2446dcd4d53a6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDg3NTYyNA==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/353#discussion_r440875624", "bodyText": "removed", "author": "bvdzwet", "createdAt": "2020-06-16T14:02:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDgyNzQ5OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDgyNzg3Mg==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/353#discussion_r440827872", "bodyText": "this section can be removed", "author": "robindenadel", "createdAt": "2020-06-16T12:57:02Z", "path": "osgp/platform/osgp-adapter-kafka-logging/src/main/resources/osgp-adapter-kafka-logging.properties", "diffHunk": "@@ -0,0 +1,35 @@\n+# =========================================================\n+# KAFKA CONFIG DISTRIBUTIONAUTOMATION LOGGING CONSUMER\n+# =========================================================\n+\n+distributionautomation.kafka.logging.enabled=false\n+\n+distributionautomation.kafka.common.properties.prefix=distributionautomation.kafka\n+distributionautomation.kafka.bootstrap.servers=localhost:9092\n+distributionautomation.kafka.topic=g_osgp_distributionautomation_monitoring_dev\n+\n+distributionautomation.kafka.consumer.key.deserializer=org.apache.kafka.common.serialization.StringDeserializer\n+distributionautomation.kafka.consumer.value.deserializer=org.opensmartgridplatform.adapter.kafka.da.serialization.MeterReadingDeserializer\n+distributionautomation.kafka.consumer.group.id=DistributionAutomationLoggingConsumer\n+distributionautomation.kafka.consumer.enable.auto.commit=true\n+distributionautomation.kafka.consumer.poll.timeout=3000\n+distributionautomation.kafka.consumer.concurrency=1\n+distributionautomation.kafka.consumer.auto.offset.reset=latest\n+", "originalCommit": "f70e988183faf10635bf2dd292b2446dcd4d53a6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDg3NjI1MA==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/353#discussion_r440876250", "bodyText": "removed", "author": "bvdzwet", "createdAt": "2020-06-16T14:03:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDgyNzg3Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDgyODI1OQ==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/353#discussion_r440828259", "bodyText": "this file can be removed", "author": "robindenadel", "createdAt": "2020-06-16T12:57:40Z", "path": "osgp/platform/osgp-adapter-kafka-logging/src/test/java/org/opensmartgridplatform/adapter/kafka/logging/infra/kafka/in/MeterReadingConsumerTest.java", "diffHunk": "@@ -0,0 +1,148 @@\n+/**", "originalCommit": "f70e988183faf10635bf2dd292b2446dcd4d53a6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDg3Njk4NQ==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/353#discussion_r440876985", "bodyText": "removed", "author": "bvdzwet", "createdAt": "2020-06-16T14:04:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDgyODI1OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDgyODkwNw==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/353#discussion_r440828907", "bodyText": "very nice!", "author": "robindenadel", "createdAt": "2020-06-16T12:58:46Z", "path": "osgp/platform/osgp-adapter-kafka-logging/src/test/java/org/opensmartgridplatform/adapter/kafka/logging/infra/kafka/in/PeakShavingConsumerTest.java", "diffHunk": "@@ -0,0 +1,109 @@\n+/**\n+ * Copyright 2020 Smart Society Services B.V.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ */\n+package org.opensmartgridplatform.adapter.kafka.logging.infra.kafka.in;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+\n+import java.time.LocalDateTime;\n+import java.util.Map;\n+import java.util.concurrent.CountDownLatch;\n+import java.util.concurrent.TimeUnit;\n+\n+import org.apache.kafka.common.serialization.StringSerializer;\n+import org.junit.jupiter.api.Test;\n+import org.opensmartgridplatform.adapter.kafka.logging.config.ApplicationContext;\n+import org.opensmartgridplatform.adapter.kafka.logging.config.PeakShavingLoggingEnabled;\n+import org.opensmartgridplatform.adapter.kafka.logging.infra.kafka.in.PeakShavingConsumerTest.TestConfig;\n+import org.opensmartgridplatform.kafka.logging.CountDownKafkaLogger;\n+import org.opensmartgridplatform.kafka.logging.KafkaLogger;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.beans.factory.annotation.Value;\n+import org.springframework.context.annotation.Bean;\n+import org.springframework.context.annotation.Conditional;\n+import org.springframework.context.annotation.Configuration;\n+import org.springframework.context.annotation.Import;\n+import org.springframework.kafka.core.DefaultKafkaProducerFactory;\n+import org.springframework.kafka.core.KafkaTemplate;\n+import org.springframework.kafka.core.ProducerFactory;\n+import org.springframework.kafka.test.EmbeddedKafkaBroker;\n+import org.springframework.kafka.test.context.EmbeddedKafka;\n+import org.springframework.kafka.test.utils.KafkaTestUtils;\n+import org.springframework.test.annotation.DirtiesContext;\n+import org.springframework.test.context.TestPropertySource;\n+import org.springframework.test.context.junit.jupiter.SpringJUnitConfig;\n+\n+@SpringJUnitConfig(TestConfig.class)\n+@TestPropertySource(\"classpath:osgp-adapter-kafka-logging-test-peakshaving.properties\")\n+@EmbeddedKafka(partitions = 1,\n+        topics = { \"${peakshaving.kafka.topic}\" },\n+        brokerProperties = { \"listeners=PLAINTEXT://${peakshaving.kafka.bootstrap.servers}\",\n+                \"log.dirs=target/kafka-logs-peakshaving\", \"auto.create.topics.enable=true\" })\n+@DirtiesContext\n+public class PeakShavingConsumerTest {\n+\n+    /**\n+     * Spring test context configuration setting up the CountDownKafkaLogger to\n+     * be used to verify sending peak shaving data leads to it being logged.\n+     *\n+     * @see CountDownKafkaLogger\n+     */\n+    @Configuration\n+    @Import(ApplicationContext.class)\n+    @Conditional(PeakShavingLoggingEnabled.class)\n+    public static class TestConfig {\n+\n+        @Bean\n+        public CountDownLatch countDownLatch() {\n+            return new CountDownLatch(1);\n+        }\n+\n+        @Bean\n+        public KafkaLogger kafkaLogger(final CountDownLatch countDownLatch, final String peakShavingData) {\n+            return new CountDownKafkaLogger(countDownLatch, peakShavingData);\n+        }\n+\n+        @Bean\n+        public String peakShavingData() {\n+            return \"TST-01; 220.1; 220.2; 220.3; 5.1; 5.2; 5.3; 7.1; 7.2; 7.3;\";\n+        }\n+    }\n+\n+    @Value(\"${peakshaving.kafka.topic}\")\n+    private String topic;\n+\n+    @Autowired\n+    private CountDownLatch countDownLatch;\n+\n+    @Autowired\n+    private String peakShavingData;\n+\n+    @Autowired\n+    private EmbeddedKafkaBroker broker;\n+\n+    @Test\n+    void logsMessagesPostedToThePeakShavingTopic() throws Exception {\n+        this.whenPeakShavingDataIsSentToTheTopic();\n+        this.theKafkaLoggerLogsThePeakShavingData();\n+    }", "originalCommit": "f70e988183faf10635bf2dd292b2446dcd4d53a6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDgyOTQwNA==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/353#discussion_r440829404", "bodyText": "this file can be removed", "author": "robindenadel", "createdAt": "2020-06-16T12:59:35Z", "path": "osgp/platform/osgp-adapter-kafka-logging/src/test/resources/osgp-adapter-kafka-logging-test-distributionautomation.properties", "diffHunk": "@@ -0,0 +1,9 @@\n+# =========================================================", "originalCommit": "f70e988183faf10635bf2dd292b2446dcd4d53a6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDg3NzUwOA==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/353#discussion_r440877508", "bodyText": "removed", "author": "bvdzwet", "createdAt": "2020-06-16T14:05:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDgyOTQwNA=="}], "type": "inlineReview"}, {"oid": "decd24e8573e251e8e314145c2597f4ba89941ed", "url": "https://github.com/OSGP/open-smart-grid-platform/commit/decd24e8573e251e8e314145c2597f4ba89941ed", "message": "OC-595 ~ Removed DistributionAutomation MeterReading logging\n\nThe MeterReadings are a left-over from a hackathon that has taken place.\n\nThe Avro format mentioned in the story acceptance criteria is one that\nstill has to be defined as an outcome of OC-574. Once that is done, the\npeak shaving consumer tests that work with a String based consumer\nrecord value, will have to be updated to use the new Avro format.", "committedDate": "2020-06-16T14:11:44Z", "type": "commit"}, {"oid": "3a4338bc21a693c0c60580c01a05c52e9c18d0b5", "url": "https://github.com/OSGP/open-smart-grid-platform/commit/3a4338bc21a693c0c60580c01a05c52e9c18d0b5", "message": "Merges branch 'development' into feature/OC-595-create-logging-kafka-listener", "committedDate": "2020-06-16T14:12:26Z", "type": "commit"}, {"oid": "deec55a1818d28e2e844bac44202855ab3e513cc", "url": "https://github.com/OSGP/open-smart-grid-platform/commit/deec55a1818d28e2e844bac44202855ab3e513cc", "message": "OC-595 ~ Removes dependency to meter reading Avro project\n\nThe code for logging meter readings messages has been removed from the\nosgp-adapter-kafka-logging project. This removes the no longer\napplicable maven dependency as well.", "committedDate": "2020-06-16T14:36:45Z", "type": "commit"}]}