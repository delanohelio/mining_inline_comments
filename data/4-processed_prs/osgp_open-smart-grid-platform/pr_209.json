{"pr_number": 209, "pr_title": "OC-544: Sets fields on response message.", "pr_createdAt": "2020-02-27T13:51:28Z", "pr_url": "https://github.com/OSGP/open-smart-grid-platform/pull/209", "timeline": [{"oid": "ec9f94b96ecdaf5aef094913211b72a1e67407f5", "url": "https://github.com/OSGP/open-smart-grid-platform/commit/ec9f94b96ecdaf5aef094913211b72a1e67407f5", "message": "OC-544: Sets fields on response message.", "committedDate": "2020-02-27T13:44:43Z", "type": "commit"}, {"oid": "e52bec30b9b3819b2266b577a56d1f28cb59242b", "url": "https://github.com/OSGP/open-smart-grid-platform/commit/e52bec30b9b3819b2266b577a56d1f28cb59242b", "message": "OC-544: Sets the fields scheduled and retryHeader in the signing server.", "committedDate": "2020-02-28T10:08:46Z", "type": "commit"}, {"oid": "f659bb89fb7935f3d337e9b5439be61b75b181f6", "url": "https://github.com/OSGP/open-smart-grid-platform/commit/f659bb89fb7935f3d337e9b5439be61b75b181f6", "message": "OC-544: Sets isScheduled field for iec-61850.", "committedDate": "2020-02-28T11:03:18Z", "type": "commit"}, {"oid": "b82eb5075f021d6dbb673df4565c4de8c2c4af30", "url": "https://github.com/OSGP/open-smart-grid-platform/commit/b82eb5075f021d6dbb673df4565c4de8c2c4af30", "message": "OC-544: Fixes sonar issue.", "committedDate": "2020-02-28T13:34:32Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Njk0MTY5NQ==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/209#discussion_r386941695", "bodyText": "The ProtocolResponseMessage is built with and instance of DeviceMessageMetadata. Setting .scheduled(messageMetadata.isScheduled()) should not be nessecary.\nThe original code sets .scheduled(false), which overrides the value of DeviceMessageMetadata. Perhaps it would be better to keep the orginal behavior?", "author": "kevinsmeets", "createdAt": "2020-03-03T10:54:12Z", "path": "osgp/protocol-adapter-iec60870/osgp-protocol-adapter-iec60870/src/main/java/org/opensmartgridplatform/adapter/protocol/iec60870/infra/messaging/DeviceRequestMessageListener.java", "diffHunk": "@@ -93,7 +94,8 @@ private void sendNotSupportedException(final ObjectMessage objectMessage, final\n                     .result(ResponseMessageResultType.NOT_OK)\n                     .osgpException(osgpException)\n                     .dataObject(objectMessage.getObject())\n-                    .scheduled(false)\n+                    .retryHeader(new RetryHeader())\n+                    .scheduled(messageMetadata.isScheduled())", "originalCommit": "b82eb5075f021d6dbb673df4565c4de8c2c4af30", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzAwNTk0MA==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/209#discussion_r387005940", "bodyText": "OK", "author": "robindenadel", "createdAt": "2020-03-03T13:06:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Njk0MTY5NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Njk0MzA3Nw==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/209#discussion_r386943077", "bodyText": "OK", "author": "kevinsmeets", "createdAt": "2020-03-03T10:56:39Z", "path": "osgp/protocol-adapter-iec61850/osgp-protocol-adapter-iec61850/src/main/java/org/opensmartgridplatform/adapter/protocol/iec61850/application/services/DeviceManagementService.java", "diffHunk": "@@ -144,24 +145,31 @@ public void sendMeasurements(final String deviceIdentification, final GetDataRes\n         // Correlation ID is generated @ WS adapter, domain+version is\n         // hard-coded\n         // for now\n-        final ProtocolResponseMessage responseMessage = new ProtocolResponseMessage.Builder().dataObject(\n-                response).deviceMessageMetadata(\n-                new DeviceMessageMetadata(deviceIdentification, NO_ORGANISATION, NO_CORRELATION_UID,\n-                        MessageType.GET_DATA.name(), 0)).result(ResponseMessageResultType.OK).domain(\n-                \"MICROGRIDS\").domainVersion(\"1.0\").build();\n+        final ProtocolResponseMessage responseMessage = new ProtocolResponseMessage.Builder().dataObject(response)\n+                .deviceMessageMetadata(new DeviceMessageMetadata(deviceIdentification, NO_ORGANISATION,\n+                        NO_CORRELATION_UID, MessageType.GET_DATA.name(), 0))\n+                .result(ResponseMessageResultType.OK)\n+                .domain(\"MICROGRIDS\")\n+                .domainVersion(\"1.0\")\n+                .retryHeader(new RetryHeader())\n+                .scheduled(false)", "originalCommit": "b82eb5075f021d6dbb673df4565c4de8c2c4af30", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Njk0MzEyNA==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/209#discussion_r386943124", "bodyText": "OK", "author": "kevinsmeets", "createdAt": "2020-03-03T10:56:45Z", "path": "osgp/protocol-adapter-iec61850/osgp-protocol-adapter-iec61850/src/main/java/org/opensmartgridplatform/adapter/protocol/iec61850/application/services/DeviceManagementService.java", "diffHunk": "@@ -144,24 +145,31 @@ public void sendMeasurements(final String deviceIdentification, final GetDataRes\n         // Correlation ID is generated @ WS adapter, domain+version is\n         // hard-coded\n         // for now\n-        final ProtocolResponseMessage responseMessage = new ProtocolResponseMessage.Builder().dataObject(\n-                response).deviceMessageMetadata(\n-                new DeviceMessageMetadata(deviceIdentification, NO_ORGANISATION, NO_CORRELATION_UID,\n-                        MessageType.GET_DATA.name(), 0)).result(ResponseMessageResultType.OK).domain(\n-                \"MICROGRIDS\").domainVersion(\"1.0\").build();\n+        final ProtocolResponseMessage responseMessage = new ProtocolResponseMessage.Builder().dataObject(response)\n+                .deviceMessageMetadata(new DeviceMessageMetadata(deviceIdentification, NO_ORGANISATION,\n+                        NO_CORRELATION_UID, MessageType.GET_DATA.name(), 0))\n+                .result(ResponseMessageResultType.OK)\n+                .domain(\"MICROGRIDS\")\n+                .domainVersion(\"1.0\")\n+                .retryHeader(new RetryHeader())\n+                .scheduled(false)\n+                .build();\n         this.responseSender.send(responseMessage);\n     }\n \n     public void sendPqValues(final String deviceIdentification, final String reportDataSet,\n             final GetPQValuesResponseDto response) {\n-        final Iec61850DeviceReportGroup deviceReportGroup =\n-                this.deviceReportGroupRepository.findByDeviceIdentificationAndReportDataSet(\n-                deviceIdentification, reportDataSet);\n-        final ProtocolResponseMessage responseMessage = new ProtocolResponseMessage.Builder().dataObject(\n-                response).deviceMessageMetadata(\n-                new DeviceMessageMetadata(deviceIdentification, NO_ORGANISATION, NO_CORRELATION_UID,\n-                        MessageType.GET_POWER_QUALITY_VALUES.name(), 0)).result(ResponseMessageResultType.OK).domain(\n-                deviceReportGroup.getDomain()).domainVersion(deviceReportGroup.getDomainVersion()).build();\n+        final Iec61850DeviceReportGroup deviceReportGroup = this.deviceReportGroupRepository\n+                .findByDeviceIdentificationAndReportDataSet(deviceIdentification, reportDataSet);\n+        final ProtocolResponseMessage responseMessage = new ProtocolResponseMessage.Builder().dataObject(response)\n+                .deviceMessageMetadata(new DeviceMessageMetadata(deviceIdentification, NO_ORGANISATION,\n+                        NO_CORRELATION_UID, MessageType.GET_POWER_QUALITY_VALUES.name(), 0))\n+                .result(ResponseMessageResultType.OK)\n+                .domain(deviceReportGroup.getDomain())\n+                .domainVersion(deviceReportGroup.getDomainVersion())\n+                .retryHeader(new RetryHeader())\n+                .scheduled(false)", "originalCommit": "b82eb5075f021d6dbb673df4565c4de8c2c4af30", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Njk1NDYzOA==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/209#discussion_r386954638", "bodyText": "Move this logic to a new function DeviceMessageMetadata.isScheduled() { return this.scheduleTime != null && this.scheduleTime > 0 }.", "author": "kevinsmeets", "createdAt": "2020-03-03T11:20:15Z", "path": "osgp/protocol-adapter-iec61850/osgp-protocol-adapter-iec61850/src/main/java/org/opensmartgridplatform/adapter/protocol/iec61850/infra/messaging/BaseMessageProcessor.java", "diffHunk": "@@ -100,7 +101,10 @@ public void checkForRedelivery(final DeviceMessageMetadata deviceMessageMetadata\n                     deviceMessageMetadata.getOrganisationIdentification(),\n                     deviceMessageMetadata.getDeviceIdentification(), deviceMessageMetadata.getCorrelationUid(),\n                     deviceMessageMetadata.getMessagePriority());\n-            this.handleExpectedError(deviceResponse, e, domainInformation, deviceMessageMetadata.getMessageType());\n+            final Long scheduleTime = deviceMessageMetadata.getScheduleTime();\n+            final boolean isScheduled = scheduleTime != null && scheduleTime > 0;", "originalCommit": "b82eb5075f021d6dbb673df4565c4de8c2c4af30", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzAwNjA0Mw==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/209#discussion_r387006043", "bodyText": "Done", "author": "robindenadel", "createdAt": "2020-03-03T13:06:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Njk1NDYzOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Njk1NTI2NA==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/209#discussion_r386955264", "bodyText": "ProtocolResponseMessages should be constructed using the values of the ProtocolRequestMessages. The value for isScheduled is derived from the request, but the RetryHeader instance is not.", "author": "kevinsmeets", "createdAt": "2020-03-03T11:21:34Z", "path": "osgp/protocol-adapter-iec61850/osgp-protocol-adapter-iec61850/src/main/java/org/opensmartgridplatform/adapter/protocol/iec61850/infra/messaging/BaseMessageProcessor.java", "diffHunk": "@@ -129,14 +133,20 @@ public void handleDeviceResponse(final DeviceResponse deviceResponse,\n                 deviceResponse.getDeviceIdentification(), deviceResponse.getOrganisationIdentification(),\n                 deviceResponse.getCorrelationUid(), messageType, deviceResponse.getMessagePriority());\n         final ProtocolResponseMessage protocolResponseMessage = new ProtocolResponseMessage.Builder()\n-                .domain(domainInformation.getDomain()).domainVersion(domainInformation.getDomainVersion())\n-                .deviceMessageMetadata(deviceMessageMetadata).result(result).osgpException(ex).retryCount(retryCount)\n+                .domain(domainInformation.getDomain())\n+                .domainVersion(domainInformation.getDomainVersion())\n+                .deviceMessageMetadata(deviceMessageMetadata)\n+                .result(result)\n+                .osgpException(ex)\n+                .retryCount(retryCount)\n+                .retryHeader(new RetryHeader())\n+                .scheduled(isScheduled)", "originalCommit": "b82eb5075f021d6dbb673df4565c4de8c2c4af30", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzAwNjM3Mw==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/209#discussion_r387006373", "bodyText": "removed the RetryHeader", "author": "robindenadel", "createdAt": "2020-03-03T13:07:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Njk1NTI2NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Njk3MjA1OA==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/209#discussion_r386972058", "bodyText": "The siging-server should pass values it has received, not setting them like this. Make sure to retrieve the retry header values from the incoming unsignedOslpEnvelopeDto instance.", "author": "kevinsmeets", "createdAt": "2020-03-03T11:56:48Z", "path": "osgp/protocol-adapter-oslp/signing-server/src/main/java/org/opensmartgridplatform/signing/server/application/services/SigningService.java", "diffHunk": "@@ -77,23 +77,34 @@ private void doSignMessage(final UnsignedOslpEnvelopeDto unsignedOslpEnvelopeDto\n         final Message payloadMessage = unsignedOslpEnvelopeDto.getPayloadMessage();\n         final String organisationIdentification = unsignedOslpEnvelopeDto.getOrganisationIdentification();\n         final int messagePriority = unsignedOslpEnvelopeDto.getMessagePriority();\n+        final boolean scheduled = unsignedOslpEnvelopeDto.isScheduled();\n \n         final OslpEnvelope oslpEnvelope = new OslpEnvelope.Builder().withDeviceId(deviceId)\n-                .withSequenceNumber(sequenceNumber).withPrimaryKey(this.privateKey).withSignature(this.signature)\n-                .withProvider(this.signatureProvider).withPayloadMessage(payloadMessage).build();\n+                .withSequenceNumber(sequenceNumber)\n+                .withPrimaryKey(this.privateKey)\n+                .withSignature(this.signature)\n+                .withProvider(this.signatureProvider)\n+                .withPayloadMessage(payloadMessage)\n+                .build();\n \n         ResponseMessage responseMessage;\n \n         if (oslpEnvelope == null) {\n             LOGGER.error(\"Message for device: {} with correlationId: {} NOT SIGNED, sending error to protocol-adapter\",\n                     deviceIdentification, correlationUid);\n \n-            responseMessage = ResponseMessage.newResponseMessageBuilder().withCorrelationUid(correlationUid)\n+            responseMessage = ResponseMessage.newResponseMessageBuilder()\n+                    .withCorrelationUid(correlationUid)\n                     .withOrganisationIdentification(organisationIdentification)\n-                    .withDeviceIdentification(deviceIdentification).withResult(ResponseMessageResultType.NOT_OK)\n+                    .withDeviceIdentification(deviceIdentification)\n+                    .withResult(ResponseMessageResultType.NOT_OK)\n                     .withOsgpException(\n                             new OsgpException(ComponentType.UNKNOWN, \"Failed to build signed OslpEnvelope\", null))\n-                    .withDataObject(unsignedOslpEnvelopeDto).withMessagePriority(messagePriority).build();\n+                    .withDataObject(unsignedOslpEnvelopeDto)\n+                    .withMessagePriority(messagePriority)\n+                    .withScheduled(scheduled)\n+                    .withRetryHeader(new RetryHeader())", "originalCommit": "b82eb5075f021d6dbb673df4565c4de8c2c4af30", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzAwNjE3NA==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/209#discussion_r387006174", "bodyText": "removed the RetryHeader", "author": "robindenadel", "createdAt": "2020-03-03T13:07:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Njk3MjA1OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Njk3MzMzMQ==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/209#discussion_r386973331", "bodyText": "Same here.", "author": "kevinsmeets", "createdAt": "2020-03-03T11:59:37Z", "path": "osgp/protocol-adapter-oslp/signing-server/src/main/java/org/opensmartgridplatform/signing/server/application/services/SigningService.java", "diffHunk": "@@ -102,10 +113,16 @@ private void doSignMessage(final UnsignedOslpEnvelopeDto unsignedOslpEnvelopeDto\n             final SignedOslpEnvelopeDto signedOslpEnvelopeDto = new SignedOslpEnvelopeDto(oslpEnvelope,\n                     unsignedOslpEnvelopeDto);\n \n-            responseMessage = ResponseMessage.newResponseMessageBuilder().withCorrelationUid(correlationUid)\n+            responseMessage = ResponseMessage.newResponseMessageBuilder()\n+                    .withCorrelationUid(correlationUid)\n                     .withOrganisationIdentification(organisationIdentification)\n-                    .withDeviceIdentification(deviceIdentification).withResult(ResponseMessageResultType.OK)\n-                    .withDataObject(signedOslpEnvelopeDto).withMessagePriority(messagePriority).build();\n+                    .withDeviceIdentification(deviceIdentification)\n+                    .withResult(ResponseMessageResultType.OK)\n+                    .withDataObject(signedOslpEnvelopeDto)\n+                    .withMessagePriority(messagePriority)\n+                    .withScheduled(scheduled)\n+                    .withRetryHeader(new RetryHeader())", "originalCommit": "b82eb5075f021d6dbb673df4565c4de8c2c4af30", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzAwNjI1MA==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/209#discussion_r387006250", "bodyText": "removed the RetryHeader", "author": "robindenadel", "createdAt": "2020-03-03T13:07:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Njk3MzMzMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Njk3NTQ1OA==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/209#discussion_r386975458", "bodyText": "What a silly mistake here... Good thing it is fixed \ud83d\udc4d", "author": "kevinsmeets", "createdAt": "2020-03-03T12:04:15Z", "path": "osgp/platform/osgp-core/src/main/java/org/opensmartgridplatform/core/application/services/DeviceResponseMessageService.java", "diffHunk": "@@ -102,9 +102,9 @@ private boolean shouldRetryBasedOnException(final OsgpException e) {\n             return false;\n         }\n \n-        final String exceptionMsg = e.toString();\n+        String exceptionMsg = e.toString();\n         if (e.getCause() != null) {\n-            exceptionMsg.concat(e.getCause().toString());\n+            exceptionMsg = exceptionMsg.concat(e.getCause().toString());", "originalCommit": "b82eb5075f021d6dbb673df4565c4de8c2c4af30", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "591fec1a8440945f3cdf2d36b265635769426cde", "url": "https://github.com/OSGP/open-smart-grid-platform/commit/591fec1a8440945f3cdf2d36b265635769426cde", "message": "OC-544: Adresses review comments.", "committedDate": "2020-03-03T12:41:28Z", "type": "commit"}, {"oid": "eb57026c3878c5a479ab6e367aeefeaa03060b8a", "url": "https://github.com/OSGP/open-smart-grid-platform/commit/eb57026c3878c5a479ab6e367aeefeaa03060b8a", "message": "Merge branch 'development' into feature/OC-544", "committedDate": "2020-03-03T12:42:24Z", "type": "commit"}, {"oid": "8a6dfe67723ba2b9bf4ddc94307959bbebe8fc35", "url": "https://github.com/OSGP/open-smart-grid-platform/commit/8a6dfe67723ba2b9bf4ddc94307959bbebe8fc35", "message": "OC-544: Uses the isScheduled method.", "committedDate": "2020-03-03T13:06:21Z", "type": "commit"}, {"oid": "97f52dc50ff0feb211540c2e6b6fa3890a3c79fd", "url": "https://github.com/OSGP/open-smart-grid-platform/commit/97f52dc50ff0feb211540c2e6b6fa3890a3c79fd", "message": "OC-544: Reverts some of the changes made to process the review comments.", "committedDate": "2020-03-03T15:18:35Z", "type": "commit"}]}