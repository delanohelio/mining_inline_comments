{"pr_number": 419, "pr_title": "FLEX-5453 Prevent error getting firmware version with multiple pending firmware updates", "pr_createdAt": "2020-09-16T17:21:42Z", "pr_url": "https://github.com/OSGP/open-smart-grid-platform/pull/419", "timeline": [{"oid": "c0b61fdc319cc03870ff4b0e5d247c386cf94ec2", "url": "https://github.com/OSGP/open-smart-grid-platform/commit/c0b61fdc319cc03870ff4b0e5d247c386cf94ec2", "message": "FLEX-5453 ~ Deals with multiple SSLD pending firmware updates\n\nReturns a list of SsldPendingFirmwareUpdates searching by device\nidentification and deals with multiple values being returned.", "committedDate": "2020-09-16T17:13:36Z", "type": "commit"}, {"oid": "5c64180a6f6e35b9411c49c42e8598406cf5d0e1", "url": "https://github.com/OSGP/open-smart-grid-platform/commit/5c64180a6f6e35b9411c49c42e8598406cf5d0e1", "message": "FLEX-5453 ~ Adds unit test for handling the lists of pending updates\n\nAdds unit tests for the code that worked with a single\nSsldPendingFirmwareUpdate for a given device identification, that has\nbeen changed to deal with lists of pending updates instead.", "committedDate": "2020-09-17T15:13:45Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDgyMjAxMA==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/419#discussion_r490822010", "bodyText": "I assume this method needs a @Test annotation?", "author": "smvdheijden", "createdAt": "2020-09-18T09:30:32Z", "path": "osgp/platform/osgp-adapter-domain-core/src/test/java/org/opensmartgridplatform/adapter/domain/core/application/services/FirmwareManagementServiceTest.java", "diffHunk": "@@ -177,4 +209,184 @@ public void testTryToAddFirmwareVersionToHistoryWhenFileIsNotAvailable() throws\n         verify(this.deviceFirmwareFileRepository, never()).save(any(DeviceFirmwareFile.class));\n     }\n \n+    @Test\n+    void handlesZeroSsldPendingFirmwareUpdatesDoingNothing() {\n+        final String deviceIdentification = \"Test-SSLD-1\";\n+        when(this.ssldPendingFirmwareUpdateRepository.findByDeviceIdentification(deviceIdentification))\n+                .thenReturn(Collections.emptyList());\n+\n+        this.firmwareManagementService.handleSsldPendingFirmwareUpdate(deviceIdentification);\n+\n+        verify(this.ssldPendingFirmwareUpdateRepository).findByDeviceIdentification(deviceIdentification);\n+        verifyNoMoreInteractions(this.ssldPendingFirmwareUpdateRepository);\n+        verifyNoInteractions(this.osgpCoreRequestMessageSender);\n+    }\n+\n+    @Test\n+    void handlesOneSsldPendingFirmwareUpdateRetrievingFirmwareVersion() throws Exception {\n+        final String deviceIdentification = \"Test-SSLD-1\";\n+        final Ssld ssld = new Ssld(deviceIdentification);\n+        final String correlationUid = \"correlation-uid-pending-firmware-update\";\n+        final SsldPendingFirmwareUpdate ssldPendingFirmwareUpdate = this.anSsldPendingFirmwareUpdate(1L, new Date(),\n+                deviceIdentification, correlationUid);\n+        final Organisation organisation = new Organisation(ssldPendingFirmwareUpdate.getOrganisationIdentification(),\n+                \"Organisation\", \"ORG\", PlatformFunctionGroup.USER);\n+        when(this.ssldPendingFirmwareUpdateRepository.findByDeviceIdentification(deviceIdentification))\n+                .thenReturn(Collections.singletonList(ssldPendingFirmwareUpdate));\n+        when(this.deviceDomainService.searchActiveDevice(eq(deviceIdentification), any(ComponentType.class)))\n+                .thenReturn(ssld);\n+        when(this.organisationDomainService.searchOrganisation(organisation.getOrganisationIdentification()))\n+                .thenReturn(organisation);\n+\n+        this.firmwareManagementService.handleSsldPendingFirmwareUpdate(deviceIdentification);\n+\n+        verify(this.ssldPendingFirmwareUpdateRepository, never()).delete(ssldPendingFirmwareUpdate);\n+\n+        /*\n+         * Verify the firmware version request is made for the device with the\n+         * SsldPendingFirmwareUpdate and that it uses the correlation UID from\n+         * SsldPendingFirmwareUpdate, as this is important for the way the\n+         * firmware version response will be treated later-on in a more complete\n+         * firmware update scenario than the fragment seen here in this unit\n+         * test.\n+         */\n+        this.assertFirmwareVersionRequested(organisation.getOrganisationIdentification(), deviceIdentification,\n+                correlationUid);\n+    }\n+\n+    @Test\n+    void handlesMultipleSsldPendingFirmwareUpdatesWithoutFailure() throws Exception {\n+        final String deviceIdentification = \"Test-SSLD-1\";\n+        final Ssld ssld = new Ssld(deviceIdentification);\n+        final String correlationUidMostRecentPendingFirmwareUpdate = \"correlation-uid-most-recent\";\n+        final long mostRecentCreationMillis = System.currentTimeMillis();\n+        final SsldPendingFirmwareUpdate olderPendingFirmwareUpdate1 = this.anSsldPendingFirmwareUpdate(134562345L,\n+                new Date(mostRecentCreationMillis - 3_000_000_000L), deviceIdentification, \"correlation-uid-1\");\n+        final SsldPendingFirmwareUpdate olderPendingFirmwareUpdate2 = this.anSsldPendingFirmwareUpdate(227587L,\n+                new Date(mostRecentCreationMillis - 604_800_000L), deviceIdentification, \"correlation-uid-2\");\n+        final SsldPendingFirmwareUpdate olderPendingFirmwareUpdate3 = this.anSsldPendingFirmwareUpdate(308943152L,\n+                new Date(mostRecentCreationMillis - 123L), deviceIdentification, \"correlation-uid-3\");\n+        final SsldPendingFirmwareUpdate mostRecentPendingFirmwareUpdate = this.anSsldPendingFirmwareUpdate(4459483L,\n+                new Date(mostRecentCreationMillis), deviceIdentification,\n+                correlationUidMostRecentPendingFirmwareUpdate);\n+        final Organisation organisation = new Organisation(\n+                mostRecentPendingFirmwareUpdate.getOrganisationIdentification(), \"Organisation\", \"ORG\",\n+                PlatformFunctionGroup.USER);\n+        when(this.ssldPendingFirmwareUpdateRepository.findByDeviceIdentification(deviceIdentification))\n+                .thenReturn(Arrays.asList(olderPendingFirmwareUpdate1, olderPendingFirmwareUpdate2,\n+                        mostRecentPendingFirmwareUpdate, olderPendingFirmwareUpdate3));\n+        when(this.deviceDomainService.searchActiveDevice(eq(deviceIdentification), any(ComponentType.class)))\n+                .thenReturn(ssld);\n+        when(this.organisationDomainService.searchOrganisation(organisation.getOrganisationIdentification()))\n+                .thenReturn(organisation);\n+\n+        this.firmwareManagementService.handleSsldPendingFirmwareUpdate(deviceIdentification);\n+\n+        /*\n+         * Verify the older pending firmware updates are deleted. This appears\n+         * to be a reasonable way to deal with multiple records being present.\n+         * The most recent pending update should not be deleted at this point,\n+         * as it is important for the way the firmware version response will be\n+         * treated later-on in a more complete firmware update scenario than the\n+         * fragment seen here in this unit test.\n+         *\n+         * The check is here to confirm the code works as it was meant to be\n+         * implemented. Not so much as a definitive specification as how it\n+         * should work.\n+         */\n+        final ArgumentCaptor<SsldPendingFirmwareUpdate> pendingUpdateCaptor = ArgumentCaptor\n+                .forClass(SsldPendingFirmwareUpdate.class);\n+        verify(this.ssldPendingFirmwareUpdateRepository, atLeastOnce()).delete(pendingUpdateCaptor.capture());\n+        final List<SsldPendingFirmwareUpdate> deletedPendingUpdates = pendingUpdateCaptor.getAllValues();\n+        assertThat(deletedPendingUpdates).containsExactlyInAnyOrder(olderPendingFirmwareUpdate1,\n+                olderPendingFirmwareUpdate2, olderPendingFirmwareUpdate3);\n+\n+        /*\n+         * Check that a get firmware version message is sent for the most recent\n+         * pending firmware update.\n+         */\n+        this.assertFirmwareVersionRequested(organisation.getOrganisationIdentification(), deviceIdentification,\n+                correlationUidMostRecentPendingFirmwareUpdate);\n+    }\n+\n+    private void assertFirmwareVersionRequested(final String organisationIdentification,\n+            final String deviceIdentification, final String correlationUid) {\n+\n+        final ArgumentCaptor<RequestMessage> requestMessageCaptor = ArgumentCaptor.forClass(RequestMessage.class);\n+        verify(this.osgpCoreRequestMessageSender).sendWithDelay(requestMessageCaptor.capture(),\n+                eq(MessageType.GET_FIRMWARE_VERSION.name()), anyInt(), any(), any());\n+\n+        final RequestMessage actualRequestMessage = requestMessageCaptor.getValue();\n+        assertThat(actualRequestMessage.getCorrelationUid()).isEqualTo(correlationUid);\n+        assertThat(actualRequestMessage.getDeviceIdentification()).isEqualTo(deviceIdentification);\n+        assertThat(actualRequestMessage.getOrganisationIdentification()).isEqualTo(organisationIdentification);\n+    }\n+\n+    private SsldPendingFirmwareUpdate anSsldPendingFirmwareUpdate(final Long id, final Date creationTime,\n+            final String deviceIdentification, final String correlationUid) {\n+\n+        final FirmwareModuleType firmwareModuleType = FirmwareModuleType.FUNCTIONAL;\n+        final String firmwareVersion = \"test-version\";\n+        final String organisationIdentification = \"test-org\";\n+        final SsldPendingFirmwareUpdate ssldPendingFirmwareUpdate = new SsldPendingFirmwareUpdate(deviceIdentification,\n+                firmwareModuleType, firmwareVersion, organisationIdentification, correlationUid);\n+        ReflectionTestUtils.setField(ssldPendingFirmwareUpdate, \"id\", id, Long.class);\n+        ReflectionTestUtils.setField(ssldPendingFirmwareUpdate, \"creationTime\", creationTime, Date.class);\n+        return ssldPendingFirmwareUpdate;\n+    }\n+\n+    void checkSsldPendingFirmwareUpdateReturnsFalseIfThereAreNoPendingUpdates() {", "originalCommit": "5c64180a6f6e35b9411c49c42e8598406cf5d0e1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDg2Njc2Mg==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/419#discussion_r490866762", "bodyText": "The method is pretty useless without the annotation. Added the annotation.", "author": "bvdzwet", "createdAt": "2020-09-18T10:55:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDgyMjAxMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDgyMjA3NA==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/419#discussion_r490822074", "bodyText": "I assume this method needs a @Test annotation?", "author": "smvdheijden", "createdAt": "2020-09-18T09:30:39Z", "path": "osgp/platform/osgp-adapter-domain-core/src/test/java/org/opensmartgridplatform/adapter/domain/core/application/services/FirmwareManagementServiceTest.java", "diffHunk": "@@ -177,4 +209,184 @@ public void testTryToAddFirmwareVersionToHistoryWhenFileIsNotAvailable() throws\n         verify(this.deviceFirmwareFileRepository, never()).save(any(DeviceFirmwareFile.class));\n     }\n \n+    @Test\n+    void handlesZeroSsldPendingFirmwareUpdatesDoingNothing() {\n+        final String deviceIdentification = \"Test-SSLD-1\";\n+        when(this.ssldPendingFirmwareUpdateRepository.findByDeviceIdentification(deviceIdentification))\n+                .thenReturn(Collections.emptyList());\n+\n+        this.firmwareManagementService.handleSsldPendingFirmwareUpdate(deviceIdentification);\n+\n+        verify(this.ssldPendingFirmwareUpdateRepository).findByDeviceIdentification(deviceIdentification);\n+        verifyNoMoreInteractions(this.ssldPendingFirmwareUpdateRepository);\n+        verifyNoInteractions(this.osgpCoreRequestMessageSender);\n+    }\n+\n+    @Test\n+    void handlesOneSsldPendingFirmwareUpdateRetrievingFirmwareVersion() throws Exception {\n+        final String deviceIdentification = \"Test-SSLD-1\";\n+        final Ssld ssld = new Ssld(deviceIdentification);\n+        final String correlationUid = \"correlation-uid-pending-firmware-update\";\n+        final SsldPendingFirmwareUpdate ssldPendingFirmwareUpdate = this.anSsldPendingFirmwareUpdate(1L, new Date(),\n+                deviceIdentification, correlationUid);\n+        final Organisation organisation = new Organisation(ssldPendingFirmwareUpdate.getOrganisationIdentification(),\n+                \"Organisation\", \"ORG\", PlatformFunctionGroup.USER);\n+        when(this.ssldPendingFirmwareUpdateRepository.findByDeviceIdentification(deviceIdentification))\n+                .thenReturn(Collections.singletonList(ssldPendingFirmwareUpdate));\n+        when(this.deviceDomainService.searchActiveDevice(eq(deviceIdentification), any(ComponentType.class)))\n+                .thenReturn(ssld);\n+        when(this.organisationDomainService.searchOrganisation(organisation.getOrganisationIdentification()))\n+                .thenReturn(organisation);\n+\n+        this.firmwareManagementService.handleSsldPendingFirmwareUpdate(deviceIdentification);\n+\n+        verify(this.ssldPendingFirmwareUpdateRepository, never()).delete(ssldPendingFirmwareUpdate);\n+\n+        /*\n+         * Verify the firmware version request is made for the device with the\n+         * SsldPendingFirmwareUpdate and that it uses the correlation UID from\n+         * SsldPendingFirmwareUpdate, as this is important for the way the\n+         * firmware version response will be treated later-on in a more complete\n+         * firmware update scenario than the fragment seen here in this unit\n+         * test.\n+         */\n+        this.assertFirmwareVersionRequested(organisation.getOrganisationIdentification(), deviceIdentification,\n+                correlationUid);\n+    }\n+\n+    @Test\n+    void handlesMultipleSsldPendingFirmwareUpdatesWithoutFailure() throws Exception {\n+        final String deviceIdentification = \"Test-SSLD-1\";\n+        final Ssld ssld = new Ssld(deviceIdentification);\n+        final String correlationUidMostRecentPendingFirmwareUpdate = \"correlation-uid-most-recent\";\n+        final long mostRecentCreationMillis = System.currentTimeMillis();\n+        final SsldPendingFirmwareUpdate olderPendingFirmwareUpdate1 = this.anSsldPendingFirmwareUpdate(134562345L,\n+                new Date(mostRecentCreationMillis - 3_000_000_000L), deviceIdentification, \"correlation-uid-1\");\n+        final SsldPendingFirmwareUpdate olderPendingFirmwareUpdate2 = this.anSsldPendingFirmwareUpdate(227587L,\n+                new Date(mostRecentCreationMillis - 604_800_000L), deviceIdentification, \"correlation-uid-2\");\n+        final SsldPendingFirmwareUpdate olderPendingFirmwareUpdate3 = this.anSsldPendingFirmwareUpdate(308943152L,\n+                new Date(mostRecentCreationMillis - 123L), deviceIdentification, \"correlation-uid-3\");\n+        final SsldPendingFirmwareUpdate mostRecentPendingFirmwareUpdate = this.anSsldPendingFirmwareUpdate(4459483L,\n+                new Date(mostRecentCreationMillis), deviceIdentification,\n+                correlationUidMostRecentPendingFirmwareUpdate);\n+        final Organisation organisation = new Organisation(\n+                mostRecentPendingFirmwareUpdate.getOrganisationIdentification(), \"Organisation\", \"ORG\",\n+                PlatformFunctionGroup.USER);\n+        when(this.ssldPendingFirmwareUpdateRepository.findByDeviceIdentification(deviceIdentification))\n+                .thenReturn(Arrays.asList(olderPendingFirmwareUpdate1, olderPendingFirmwareUpdate2,\n+                        mostRecentPendingFirmwareUpdate, olderPendingFirmwareUpdate3));\n+        when(this.deviceDomainService.searchActiveDevice(eq(deviceIdentification), any(ComponentType.class)))\n+                .thenReturn(ssld);\n+        when(this.organisationDomainService.searchOrganisation(organisation.getOrganisationIdentification()))\n+                .thenReturn(organisation);\n+\n+        this.firmwareManagementService.handleSsldPendingFirmwareUpdate(deviceIdentification);\n+\n+        /*\n+         * Verify the older pending firmware updates are deleted. This appears\n+         * to be a reasonable way to deal with multiple records being present.\n+         * The most recent pending update should not be deleted at this point,\n+         * as it is important for the way the firmware version response will be\n+         * treated later-on in a more complete firmware update scenario than the\n+         * fragment seen here in this unit test.\n+         *\n+         * The check is here to confirm the code works as it was meant to be\n+         * implemented. Not so much as a definitive specification as how it\n+         * should work.\n+         */\n+        final ArgumentCaptor<SsldPendingFirmwareUpdate> pendingUpdateCaptor = ArgumentCaptor\n+                .forClass(SsldPendingFirmwareUpdate.class);\n+        verify(this.ssldPendingFirmwareUpdateRepository, atLeastOnce()).delete(pendingUpdateCaptor.capture());\n+        final List<SsldPendingFirmwareUpdate> deletedPendingUpdates = pendingUpdateCaptor.getAllValues();\n+        assertThat(deletedPendingUpdates).containsExactlyInAnyOrder(olderPendingFirmwareUpdate1,\n+                olderPendingFirmwareUpdate2, olderPendingFirmwareUpdate3);\n+\n+        /*\n+         * Check that a get firmware version message is sent for the most recent\n+         * pending firmware update.\n+         */\n+        this.assertFirmwareVersionRequested(organisation.getOrganisationIdentification(), deviceIdentification,\n+                correlationUidMostRecentPendingFirmwareUpdate);\n+    }\n+\n+    private void assertFirmwareVersionRequested(final String organisationIdentification,\n+            final String deviceIdentification, final String correlationUid) {\n+\n+        final ArgumentCaptor<RequestMessage> requestMessageCaptor = ArgumentCaptor.forClass(RequestMessage.class);\n+        verify(this.osgpCoreRequestMessageSender).sendWithDelay(requestMessageCaptor.capture(),\n+                eq(MessageType.GET_FIRMWARE_VERSION.name()), anyInt(), any(), any());\n+\n+        final RequestMessage actualRequestMessage = requestMessageCaptor.getValue();\n+        assertThat(actualRequestMessage.getCorrelationUid()).isEqualTo(correlationUid);\n+        assertThat(actualRequestMessage.getDeviceIdentification()).isEqualTo(deviceIdentification);\n+        assertThat(actualRequestMessage.getOrganisationIdentification()).isEqualTo(organisationIdentification);\n+    }\n+\n+    private SsldPendingFirmwareUpdate anSsldPendingFirmwareUpdate(final Long id, final Date creationTime,\n+            final String deviceIdentification, final String correlationUid) {\n+\n+        final FirmwareModuleType firmwareModuleType = FirmwareModuleType.FUNCTIONAL;\n+        final String firmwareVersion = \"test-version\";\n+        final String organisationIdentification = \"test-org\";\n+        final SsldPendingFirmwareUpdate ssldPendingFirmwareUpdate = new SsldPendingFirmwareUpdate(deviceIdentification,\n+                firmwareModuleType, firmwareVersion, organisationIdentification, correlationUid);\n+        ReflectionTestUtils.setField(ssldPendingFirmwareUpdate, \"id\", id, Long.class);\n+        ReflectionTestUtils.setField(ssldPendingFirmwareUpdate, \"creationTime\", creationTime, Date.class);\n+        return ssldPendingFirmwareUpdate;\n+    }\n+\n+    void checkSsldPendingFirmwareUpdateReturnsFalseIfThereAreNoPendingUpdates() {\n+        final String organisationIdentification = \"test-org\";\n+        final String deviceIdentification = \"device-identification\";\n+        final String correlationUid = \"correlation-uid-no-pending-updates\";\n+        final CorrelationIds ids = new CorrelationIds(organisationIdentification, deviceIdentification, correlationUid);\n+        final List<FirmwareVersion> firmwareVersions = Collections\n+                .singletonList(new FirmwareVersion(FirmwareModuleType.FUNCTIONAL, VERSION_3));\n+        when(this.ssldPendingFirmwareUpdateRepository.findByDeviceIdentification(deviceIdentification))\n+                .thenReturn(Collections.emptyList());\n+\n+        assertThat(this.firmwareManagementService.checkSsldPendingFirmwareUpdate(ids, firmwareVersions)).isFalse();\n+\n+        verify(this.ssldPendingFirmwareUpdateRepository).findByDeviceIdentification(deviceIdentification);\n+        verifyNoMoreInteractions(this.ssldPendingFirmwareUpdateRepository);\n+    }\n+\n+    void checkSsldPendingFirmwareUpdateReturnsFalseIfPendingUpdatesAreForDifferentCorrelationUids() {", "originalCommit": "5c64180a6f6e35b9411c49c42e8598406cf5d0e1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDg2NzA3OA==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/419#discussion_r490867078", "bodyText": "Added the annotation.", "author": "bvdzwet", "createdAt": "2020-09-18T10:56:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDgyMjA3NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDgyMjE3MA==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/419#discussion_r490822170", "bodyText": "I assume this method needs a @Test annotation?", "author": "smvdheijden", "createdAt": "2020-09-18T09:30:51Z", "path": "osgp/platform/osgp-adapter-domain-core/src/test/java/org/opensmartgridplatform/adapter/domain/core/application/services/FirmwareManagementServiceTest.java", "diffHunk": "@@ -177,4 +209,184 @@ public void testTryToAddFirmwareVersionToHistoryWhenFileIsNotAvailable() throws\n         verify(this.deviceFirmwareFileRepository, never()).save(any(DeviceFirmwareFile.class));\n     }\n \n+    @Test\n+    void handlesZeroSsldPendingFirmwareUpdatesDoingNothing() {\n+        final String deviceIdentification = \"Test-SSLD-1\";\n+        when(this.ssldPendingFirmwareUpdateRepository.findByDeviceIdentification(deviceIdentification))\n+                .thenReturn(Collections.emptyList());\n+\n+        this.firmwareManagementService.handleSsldPendingFirmwareUpdate(deviceIdentification);\n+\n+        verify(this.ssldPendingFirmwareUpdateRepository).findByDeviceIdentification(deviceIdentification);\n+        verifyNoMoreInteractions(this.ssldPendingFirmwareUpdateRepository);\n+        verifyNoInteractions(this.osgpCoreRequestMessageSender);\n+    }\n+\n+    @Test\n+    void handlesOneSsldPendingFirmwareUpdateRetrievingFirmwareVersion() throws Exception {\n+        final String deviceIdentification = \"Test-SSLD-1\";\n+        final Ssld ssld = new Ssld(deviceIdentification);\n+        final String correlationUid = \"correlation-uid-pending-firmware-update\";\n+        final SsldPendingFirmwareUpdate ssldPendingFirmwareUpdate = this.anSsldPendingFirmwareUpdate(1L, new Date(),\n+                deviceIdentification, correlationUid);\n+        final Organisation organisation = new Organisation(ssldPendingFirmwareUpdate.getOrganisationIdentification(),\n+                \"Organisation\", \"ORG\", PlatformFunctionGroup.USER);\n+        when(this.ssldPendingFirmwareUpdateRepository.findByDeviceIdentification(deviceIdentification))\n+                .thenReturn(Collections.singletonList(ssldPendingFirmwareUpdate));\n+        when(this.deviceDomainService.searchActiveDevice(eq(deviceIdentification), any(ComponentType.class)))\n+                .thenReturn(ssld);\n+        when(this.organisationDomainService.searchOrganisation(organisation.getOrganisationIdentification()))\n+                .thenReturn(organisation);\n+\n+        this.firmwareManagementService.handleSsldPendingFirmwareUpdate(deviceIdentification);\n+\n+        verify(this.ssldPendingFirmwareUpdateRepository, never()).delete(ssldPendingFirmwareUpdate);\n+\n+        /*\n+         * Verify the firmware version request is made for the device with the\n+         * SsldPendingFirmwareUpdate and that it uses the correlation UID from\n+         * SsldPendingFirmwareUpdate, as this is important for the way the\n+         * firmware version response will be treated later-on in a more complete\n+         * firmware update scenario than the fragment seen here in this unit\n+         * test.\n+         */\n+        this.assertFirmwareVersionRequested(organisation.getOrganisationIdentification(), deviceIdentification,\n+                correlationUid);\n+    }\n+\n+    @Test\n+    void handlesMultipleSsldPendingFirmwareUpdatesWithoutFailure() throws Exception {\n+        final String deviceIdentification = \"Test-SSLD-1\";\n+        final Ssld ssld = new Ssld(deviceIdentification);\n+        final String correlationUidMostRecentPendingFirmwareUpdate = \"correlation-uid-most-recent\";\n+        final long mostRecentCreationMillis = System.currentTimeMillis();\n+        final SsldPendingFirmwareUpdate olderPendingFirmwareUpdate1 = this.anSsldPendingFirmwareUpdate(134562345L,\n+                new Date(mostRecentCreationMillis - 3_000_000_000L), deviceIdentification, \"correlation-uid-1\");\n+        final SsldPendingFirmwareUpdate olderPendingFirmwareUpdate2 = this.anSsldPendingFirmwareUpdate(227587L,\n+                new Date(mostRecentCreationMillis - 604_800_000L), deviceIdentification, \"correlation-uid-2\");\n+        final SsldPendingFirmwareUpdate olderPendingFirmwareUpdate3 = this.anSsldPendingFirmwareUpdate(308943152L,\n+                new Date(mostRecentCreationMillis - 123L), deviceIdentification, \"correlation-uid-3\");\n+        final SsldPendingFirmwareUpdate mostRecentPendingFirmwareUpdate = this.anSsldPendingFirmwareUpdate(4459483L,\n+                new Date(mostRecentCreationMillis), deviceIdentification,\n+                correlationUidMostRecentPendingFirmwareUpdate);\n+        final Organisation organisation = new Organisation(\n+                mostRecentPendingFirmwareUpdate.getOrganisationIdentification(), \"Organisation\", \"ORG\",\n+                PlatformFunctionGroup.USER);\n+        when(this.ssldPendingFirmwareUpdateRepository.findByDeviceIdentification(deviceIdentification))\n+                .thenReturn(Arrays.asList(olderPendingFirmwareUpdate1, olderPendingFirmwareUpdate2,\n+                        mostRecentPendingFirmwareUpdate, olderPendingFirmwareUpdate3));\n+        when(this.deviceDomainService.searchActiveDevice(eq(deviceIdentification), any(ComponentType.class)))\n+                .thenReturn(ssld);\n+        when(this.organisationDomainService.searchOrganisation(organisation.getOrganisationIdentification()))\n+                .thenReturn(organisation);\n+\n+        this.firmwareManagementService.handleSsldPendingFirmwareUpdate(deviceIdentification);\n+\n+        /*\n+         * Verify the older pending firmware updates are deleted. This appears\n+         * to be a reasonable way to deal with multiple records being present.\n+         * The most recent pending update should not be deleted at this point,\n+         * as it is important for the way the firmware version response will be\n+         * treated later-on in a more complete firmware update scenario than the\n+         * fragment seen here in this unit test.\n+         *\n+         * The check is here to confirm the code works as it was meant to be\n+         * implemented. Not so much as a definitive specification as how it\n+         * should work.\n+         */\n+        final ArgumentCaptor<SsldPendingFirmwareUpdate> pendingUpdateCaptor = ArgumentCaptor\n+                .forClass(SsldPendingFirmwareUpdate.class);\n+        verify(this.ssldPendingFirmwareUpdateRepository, atLeastOnce()).delete(pendingUpdateCaptor.capture());\n+        final List<SsldPendingFirmwareUpdate> deletedPendingUpdates = pendingUpdateCaptor.getAllValues();\n+        assertThat(deletedPendingUpdates).containsExactlyInAnyOrder(olderPendingFirmwareUpdate1,\n+                olderPendingFirmwareUpdate2, olderPendingFirmwareUpdate3);\n+\n+        /*\n+         * Check that a get firmware version message is sent for the most recent\n+         * pending firmware update.\n+         */\n+        this.assertFirmwareVersionRequested(organisation.getOrganisationIdentification(), deviceIdentification,\n+                correlationUidMostRecentPendingFirmwareUpdate);\n+    }\n+\n+    private void assertFirmwareVersionRequested(final String organisationIdentification,\n+            final String deviceIdentification, final String correlationUid) {\n+\n+        final ArgumentCaptor<RequestMessage> requestMessageCaptor = ArgumentCaptor.forClass(RequestMessage.class);\n+        verify(this.osgpCoreRequestMessageSender).sendWithDelay(requestMessageCaptor.capture(),\n+                eq(MessageType.GET_FIRMWARE_VERSION.name()), anyInt(), any(), any());\n+\n+        final RequestMessage actualRequestMessage = requestMessageCaptor.getValue();\n+        assertThat(actualRequestMessage.getCorrelationUid()).isEqualTo(correlationUid);\n+        assertThat(actualRequestMessage.getDeviceIdentification()).isEqualTo(deviceIdentification);\n+        assertThat(actualRequestMessage.getOrganisationIdentification()).isEqualTo(organisationIdentification);\n+    }\n+\n+    private SsldPendingFirmwareUpdate anSsldPendingFirmwareUpdate(final Long id, final Date creationTime,\n+            final String deviceIdentification, final String correlationUid) {\n+\n+        final FirmwareModuleType firmwareModuleType = FirmwareModuleType.FUNCTIONAL;\n+        final String firmwareVersion = \"test-version\";\n+        final String organisationIdentification = \"test-org\";\n+        final SsldPendingFirmwareUpdate ssldPendingFirmwareUpdate = new SsldPendingFirmwareUpdate(deviceIdentification,\n+                firmwareModuleType, firmwareVersion, organisationIdentification, correlationUid);\n+        ReflectionTestUtils.setField(ssldPendingFirmwareUpdate, \"id\", id, Long.class);\n+        ReflectionTestUtils.setField(ssldPendingFirmwareUpdate, \"creationTime\", creationTime, Date.class);\n+        return ssldPendingFirmwareUpdate;\n+    }\n+\n+    void checkSsldPendingFirmwareUpdateReturnsFalseIfThereAreNoPendingUpdates() {\n+        final String organisationIdentification = \"test-org\";\n+        final String deviceIdentification = \"device-identification\";\n+        final String correlationUid = \"correlation-uid-no-pending-updates\";\n+        final CorrelationIds ids = new CorrelationIds(organisationIdentification, deviceIdentification, correlationUid);\n+        final List<FirmwareVersion> firmwareVersions = Collections\n+                .singletonList(new FirmwareVersion(FirmwareModuleType.FUNCTIONAL, VERSION_3));\n+        when(this.ssldPendingFirmwareUpdateRepository.findByDeviceIdentification(deviceIdentification))\n+                .thenReturn(Collections.emptyList());\n+\n+        assertThat(this.firmwareManagementService.checkSsldPendingFirmwareUpdate(ids, firmwareVersions)).isFalse();\n+\n+        verify(this.ssldPendingFirmwareUpdateRepository).findByDeviceIdentification(deviceIdentification);\n+        verifyNoMoreInteractions(this.ssldPendingFirmwareUpdateRepository);\n+    }\n+\n+    void checkSsldPendingFirmwareUpdateReturnsFalseIfPendingUpdatesAreForDifferentCorrelationUids() {\n+        final String organisationIdentification = \"test-org\";\n+        final String deviceIdentification = \"device-identification\";\n+        final String correlationUid = \"correlation-uid-not-with-pending-updates\";\n+        final CorrelationIds ids = new CorrelationIds(organisationIdentification, deviceIdentification, correlationUid);\n+        final List<FirmwareVersion> firmwareVersions = Arrays.asList(\n+                new FirmwareVersion(FirmwareModuleType.SECURITY, VERSION_2),\n+                new FirmwareVersion(FirmwareModuleType.FUNCTIONAL, VERSION_1));\n+        when(this.ssldPendingFirmwareUpdateRepository.findByDeviceIdentification(deviceIdentification))\n+                .thenReturn(Collections.singletonList(this.anSsldPendingFirmwareUpdate(4579L, new Date(),\n+                        deviceIdentification, \"some-other-correlation-uid\")));\n+\n+        assertThat(this.firmwareManagementService.checkSsldPendingFirmwareUpdate(ids, firmwareVersions)).isFalse();\n+\n+        verify(this.ssldPendingFirmwareUpdateRepository).findByDeviceIdentification(deviceIdentification);\n+        verifyNoMoreInteractions(this.ssldPendingFirmwareUpdateRepository);\n+    }\n+\n+    void checkSsldPendingFirmwareUpdateReturnsTrueAndDeletesPendingUpdateWithMatchingCorrelationUid() {", "originalCommit": "5c64180a6f6e35b9411c49c42e8598406cf5d0e1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDg2Njg0OQ==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/419#discussion_r490866849", "bodyText": "Added the annotation.", "author": "bvdzwet", "createdAt": "2020-09-18T10:55:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDgyMjE3MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDgzNDU0MQ==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/419#discussion_r490834541", "bodyText": "As discussed this morning, I'm wondering if we might introduce new issues by using the most recent pending firmware update record and removing the others (in case of multiple pending update records).\nPerhaps a slightly better approach could be to use a new correlation uid and to delete pending update records after retrieving the firmware version?\nAs you mentioned, it would probably be even better to have some status field in the device_firmware_file table and keep track of the latest versions in the device_firmware_module table, but this along with a broader analysis should be investigated in a new issue...\nFor now we could probably leave this as is, as it seems to fix the error.", "author": "smvdheijden", "createdAt": "2020-09-18T09:51:04Z", "path": "osgp/platform/osgp-adapter-domain-core/src/main/java/org/opensmartgridplatform/adapter/domain/core/application/services/FirmwareManagementService.java", "diffHunk": "@@ -153,27 +155,69 @@ private static String getFirmwareFilename(final String firmwareUrl) {\n \n     public void handleSsldPendingFirmwareUpdate(final String deviceIdentification) {\n \n-        final SsldPendingFirmwareUpdate ssldPendingFirmwareUpdate = this.ssldPendingFirmwareUpdateRepository\n+        final List<SsldPendingFirmwareUpdate> ssldPendingFirmwareUpdates = this.ssldPendingFirmwareUpdateRepository\n                 .findByDeviceIdentification(deviceIdentification);\n \n-        if (ssldPendingFirmwareUpdate != null) {\n-            final String organisationIdentification = ssldPendingFirmwareUpdate.getOrganisationIdentification();\n-            final String correlationUid = ssldPendingFirmwareUpdate.getCorrelationUid();\n+        if (CollectionUtils.isEmpty(ssldPendingFirmwareUpdates)) {\n+            return;\n+        }\n+        /*\n+         * A pending firmware update record was stored for this device earlier.\n+         * This means this method is probably called following a firmware\n+         * update. Retrieve the firmware version from the device to have the\n+         * current version that is installed available.\n+         *\n+         * If multiple pending update records exist, it is not really clear what\n+         * to do. The following approach assumes the most recently created one\n+         * is relevant, and other pending records are out-dated.\n+         */\n+        final SsldPendingFirmwareUpdate ssldPendingFirmwareUpdate = this", "originalCommit": "5c64180a6f6e35b9411c49c42e8598406cf5d0e1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDg3ODY5NQ==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/419#discussion_r490878695", "bodyText": "I am going to create a new item on the backlog for improving the firmware update process (including bringing the registered version up to date as soon as possible). I will include some information about the possibilities that may lay in using the available tables in another manner, instead of keeping track of a pending firmware update table.", "author": "bvdzwet", "createdAt": "2020-09-18T11:19:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDgzNDU0MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDgzNjQ2MA==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/419#discussion_r490836460", "bodyText": "This method seems to be doing multiple things (hence needing a long method name). Would it make the code cleaner if this method is refactored by splitting this up into 2 methods on for retrieving the most recent and one for deleting outdated?", "author": "smvdheijden", "createdAt": "2020-09-18T09:54:45Z", "path": "osgp/platform/osgp-adapter-domain-core/src/main/java/org/opensmartgridplatform/adapter/domain/core/application/services/FirmwareManagementService.java", "diffHunk": "@@ -153,27 +155,69 @@ private static String getFirmwareFilename(final String firmwareUrl) {\n \n     public void handleSsldPendingFirmwareUpdate(final String deviceIdentification) {\n \n-        final SsldPendingFirmwareUpdate ssldPendingFirmwareUpdate = this.ssldPendingFirmwareUpdateRepository\n+        final List<SsldPendingFirmwareUpdate> ssldPendingFirmwareUpdates = this.ssldPendingFirmwareUpdateRepository\n                 .findByDeviceIdentification(deviceIdentification);\n \n-        if (ssldPendingFirmwareUpdate != null) {\n-            final String organisationIdentification = ssldPendingFirmwareUpdate.getOrganisationIdentification();\n-            final String correlationUid = ssldPendingFirmwareUpdate.getCorrelationUid();\n+        if (CollectionUtils.isEmpty(ssldPendingFirmwareUpdates)) {\n+            return;\n+        }\n+        /*\n+         * A pending firmware update record was stored for this device earlier.\n+         * This means this method is probably called following a firmware\n+         * update. Retrieve the firmware version from the device to have the\n+         * current version that is installed available.\n+         *\n+         * If multiple pending update records exist, it is not really clear what\n+         * to do. The following approach assumes the most recently created one\n+         * is relevant, and other pending records are out-dated.\n+         */\n+        final SsldPendingFirmwareUpdate ssldPendingFirmwareUpdate = this\n+                .getMostRecentDeletingOutdatedPendingFirmwareUpdates(ssldPendingFirmwareUpdates);\n+\n+        final String organisationIdentification = ssldPendingFirmwareUpdate.getOrganisationIdentification();\n+        final String correlationUid = ssldPendingFirmwareUpdate.getCorrelationUid();\n+\n+        LOGGER.info(\n+                \"Handling SSLD pending firmware update for device identification: {}, organisation identification: {} and correlation UID: {}.\",\n+                deviceIdentification, organisationIdentification, correlationUid);\n \n-            LOGGER.info(\n-                    \"Handling SSLD pending firmware update for device identification: {}, organisation identification: {} and correlation UID: {}.\",\n-                    deviceIdentification, organisationIdentification, correlationUid);\n-\n-            try {\n-                final int messagePriority = MessagePriorityEnum.DEFAULT.getPriority();\n-                this.getFirmwareVersion(organisationIdentification, deviceIdentification, correlationUid,\n-                        DeviceFunction.GET_FIRMWARE_VERSION.name(), messagePriority, this.getFirmwareVersionDelay);\n-            } catch (final FunctionalException e) {\n-                LOGGER.error(\"Caught exception when calling get firmware version\", e);\n-            }\n+        try {\n+            final int messagePriority = MessagePriorityEnum.DEFAULT.getPriority();\n+            this.getFirmwareVersion(organisationIdentification, deviceIdentification, correlationUid,\n+                    DeviceFunction.GET_FIRMWARE_VERSION.name(), messagePriority, this.getFirmwareVersionDelay);\n+        } catch (final FunctionalException e) {\n+            LOGGER.error(\"Caught exception when calling get firmware version\", e);\n         }\n     }\n \n+    private SsldPendingFirmwareUpdate getMostRecentDeletingOutdatedPendingFirmwareUpdates(", "originalCommit": "5c64180a6f6e35b9411c49c42e8598406cf5d0e1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDg4MjY2OQ==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/419#discussion_r490882669", "bodyText": "I refactored the code, and think it is better now. You can check if you agree.\nI noticed a warning about using != with the pending firmware update ID, which is a Long object value, which I fixed as well.", "author": "bvdzwet", "createdAt": "2020-09-18T11:26:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDgzNjQ2MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDg0NDgyOA==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/419#discussion_r490844828", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    assertThat(this.firmwareManagementService.checkSsldPendingFirmwareUpdate(ids, firmwareVersions)).isFalse();\n          \n          \n            \n                    // act\n          \n          \n            \n                    boolean hasPendingFirmwareUpdate = this.firmwareManagementService.checkSsldPendingFirmwareUpdate(ids, firmwareVersions);\n          \n          \n            \n            \n          \n          \n            \n                    // assert\n          \n          \n            \n                    assertThat(hasPendingFirmwareUpdate).isFalse();", "author": "smvdheijden", "createdAt": "2020-09-18T10:11:25Z", "path": "osgp/platform/osgp-adapter-domain-core/src/test/java/org/opensmartgridplatform/adapter/domain/core/application/services/FirmwareManagementServiceTest.java", "diffHunk": "@@ -177,4 +209,184 @@ public void testTryToAddFirmwareVersionToHistoryWhenFileIsNotAvailable() throws\n         verify(this.deviceFirmwareFileRepository, never()).save(any(DeviceFirmwareFile.class));\n     }\n \n+    @Test\n+    void handlesZeroSsldPendingFirmwareUpdatesDoingNothing() {\n+        final String deviceIdentification = \"Test-SSLD-1\";\n+        when(this.ssldPendingFirmwareUpdateRepository.findByDeviceIdentification(deviceIdentification))\n+                .thenReturn(Collections.emptyList());\n+\n+        this.firmwareManagementService.handleSsldPendingFirmwareUpdate(deviceIdentification);\n+\n+        verify(this.ssldPendingFirmwareUpdateRepository).findByDeviceIdentification(deviceIdentification);\n+        verifyNoMoreInteractions(this.ssldPendingFirmwareUpdateRepository);\n+        verifyNoInteractions(this.osgpCoreRequestMessageSender);\n+    }\n+\n+    @Test\n+    void handlesOneSsldPendingFirmwareUpdateRetrievingFirmwareVersion() throws Exception {\n+        final String deviceIdentification = \"Test-SSLD-1\";\n+        final Ssld ssld = new Ssld(deviceIdentification);\n+        final String correlationUid = \"correlation-uid-pending-firmware-update\";\n+        final SsldPendingFirmwareUpdate ssldPendingFirmwareUpdate = this.anSsldPendingFirmwareUpdate(1L, new Date(),\n+                deviceIdentification, correlationUid);\n+        final Organisation organisation = new Organisation(ssldPendingFirmwareUpdate.getOrganisationIdentification(),\n+                \"Organisation\", \"ORG\", PlatformFunctionGroup.USER);\n+        when(this.ssldPendingFirmwareUpdateRepository.findByDeviceIdentification(deviceIdentification))\n+                .thenReturn(Collections.singletonList(ssldPendingFirmwareUpdate));\n+        when(this.deviceDomainService.searchActiveDevice(eq(deviceIdentification), any(ComponentType.class)))\n+                .thenReturn(ssld);\n+        when(this.organisationDomainService.searchOrganisation(organisation.getOrganisationIdentification()))\n+                .thenReturn(organisation);\n+\n+        this.firmwareManagementService.handleSsldPendingFirmwareUpdate(deviceIdentification);\n+\n+        verify(this.ssldPendingFirmwareUpdateRepository, never()).delete(ssldPendingFirmwareUpdate);\n+\n+        /*\n+         * Verify the firmware version request is made for the device with the\n+         * SsldPendingFirmwareUpdate and that it uses the correlation UID from\n+         * SsldPendingFirmwareUpdate, as this is important for the way the\n+         * firmware version response will be treated later-on in a more complete\n+         * firmware update scenario than the fragment seen here in this unit\n+         * test.\n+         */\n+        this.assertFirmwareVersionRequested(organisation.getOrganisationIdentification(), deviceIdentification,\n+                correlationUid);\n+    }\n+\n+    @Test\n+    void handlesMultipleSsldPendingFirmwareUpdatesWithoutFailure() throws Exception {\n+        final String deviceIdentification = \"Test-SSLD-1\";\n+        final Ssld ssld = new Ssld(deviceIdentification);\n+        final String correlationUidMostRecentPendingFirmwareUpdate = \"correlation-uid-most-recent\";\n+        final long mostRecentCreationMillis = System.currentTimeMillis();\n+        final SsldPendingFirmwareUpdate olderPendingFirmwareUpdate1 = this.anSsldPendingFirmwareUpdate(134562345L,\n+                new Date(mostRecentCreationMillis - 3_000_000_000L), deviceIdentification, \"correlation-uid-1\");\n+        final SsldPendingFirmwareUpdate olderPendingFirmwareUpdate2 = this.anSsldPendingFirmwareUpdate(227587L,\n+                new Date(mostRecentCreationMillis - 604_800_000L), deviceIdentification, \"correlation-uid-2\");\n+        final SsldPendingFirmwareUpdate olderPendingFirmwareUpdate3 = this.anSsldPendingFirmwareUpdate(308943152L,\n+                new Date(mostRecentCreationMillis - 123L), deviceIdentification, \"correlation-uid-3\");\n+        final SsldPendingFirmwareUpdate mostRecentPendingFirmwareUpdate = this.anSsldPendingFirmwareUpdate(4459483L,\n+                new Date(mostRecentCreationMillis), deviceIdentification,\n+                correlationUidMostRecentPendingFirmwareUpdate);\n+        final Organisation organisation = new Organisation(\n+                mostRecentPendingFirmwareUpdate.getOrganisationIdentification(), \"Organisation\", \"ORG\",\n+                PlatformFunctionGroup.USER);\n+        when(this.ssldPendingFirmwareUpdateRepository.findByDeviceIdentification(deviceIdentification))\n+                .thenReturn(Arrays.asList(olderPendingFirmwareUpdate1, olderPendingFirmwareUpdate2,\n+                        mostRecentPendingFirmwareUpdate, olderPendingFirmwareUpdate3));\n+        when(this.deviceDomainService.searchActiveDevice(eq(deviceIdentification), any(ComponentType.class)))\n+                .thenReturn(ssld);\n+        when(this.organisationDomainService.searchOrganisation(organisation.getOrganisationIdentification()))\n+                .thenReturn(organisation);\n+\n+        this.firmwareManagementService.handleSsldPendingFirmwareUpdate(deviceIdentification);\n+\n+        /*\n+         * Verify the older pending firmware updates are deleted. This appears\n+         * to be a reasonable way to deal with multiple records being present.\n+         * The most recent pending update should not be deleted at this point,\n+         * as it is important for the way the firmware version response will be\n+         * treated later-on in a more complete firmware update scenario than the\n+         * fragment seen here in this unit test.\n+         *\n+         * The check is here to confirm the code works as it was meant to be\n+         * implemented. Not so much as a definitive specification as how it\n+         * should work.\n+         */\n+        final ArgumentCaptor<SsldPendingFirmwareUpdate> pendingUpdateCaptor = ArgumentCaptor\n+                .forClass(SsldPendingFirmwareUpdate.class);\n+        verify(this.ssldPendingFirmwareUpdateRepository, atLeastOnce()).delete(pendingUpdateCaptor.capture());\n+        final List<SsldPendingFirmwareUpdate> deletedPendingUpdates = pendingUpdateCaptor.getAllValues();\n+        assertThat(deletedPendingUpdates).containsExactlyInAnyOrder(olderPendingFirmwareUpdate1,\n+                olderPendingFirmwareUpdate2, olderPendingFirmwareUpdate3);\n+\n+        /*\n+         * Check that a get firmware version message is sent for the most recent\n+         * pending firmware update.\n+         */\n+        this.assertFirmwareVersionRequested(organisation.getOrganisationIdentification(), deviceIdentification,\n+                correlationUidMostRecentPendingFirmwareUpdate);\n+    }\n+\n+    private void assertFirmwareVersionRequested(final String organisationIdentification,\n+            final String deviceIdentification, final String correlationUid) {\n+\n+        final ArgumentCaptor<RequestMessage> requestMessageCaptor = ArgumentCaptor.forClass(RequestMessage.class);\n+        verify(this.osgpCoreRequestMessageSender).sendWithDelay(requestMessageCaptor.capture(),\n+                eq(MessageType.GET_FIRMWARE_VERSION.name()), anyInt(), any(), any());\n+\n+        final RequestMessage actualRequestMessage = requestMessageCaptor.getValue();\n+        assertThat(actualRequestMessage.getCorrelationUid()).isEqualTo(correlationUid);\n+        assertThat(actualRequestMessage.getDeviceIdentification()).isEqualTo(deviceIdentification);\n+        assertThat(actualRequestMessage.getOrganisationIdentification()).isEqualTo(organisationIdentification);\n+    }\n+\n+    private SsldPendingFirmwareUpdate anSsldPendingFirmwareUpdate(final Long id, final Date creationTime,\n+            final String deviceIdentification, final String correlationUid) {\n+\n+        final FirmwareModuleType firmwareModuleType = FirmwareModuleType.FUNCTIONAL;\n+        final String firmwareVersion = \"test-version\";\n+        final String organisationIdentification = \"test-org\";\n+        final SsldPendingFirmwareUpdate ssldPendingFirmwareUpdate = new SsldPendingFirmwareUpdate(deviceIdentification,\n+                firmwareModuleType, firmwareVersion, organisationIdentification, correlationUid);\n+        ReflectionTestUtils.setField(ssldPendingFirmwareUpdate, \"id\", id, Long.class);\n+        ReflectionTestUtils.setField(ssldPendingFirmwareUpdate, \"creationTime\", creationTime, Date.class);\n+        return ssldPendingFirmwareUpdate;\n+    }\n+\n+    void checkSsldPendingFirmwareUpdateReturnsFalseIfThereAreNoPendingUpdates() {\n+        final String organisationIdentification = \"test-org\";\n+        final String deviceIdentification = \"device-identification\";\n+        final String correlationUid = \"correlation-uid-no-pending-updates\";\n+        final CorrelationIds ids = new CorrelationIds(organisationIdentification, deviceIdentification, correlationUid);\n+        final List<FirmwareVersion> firmwareVersions = Collections\n+                .singletonList(new FirmwareVersion(FirmwareModuleType.FUNCTIONAL, VERSION_3));\n+        when(this.ssldPendingFirmwareUpdateRepository.findByDeviceIdentification(deviceIdentification))\n+                .thenReturn(Collections.emptyList());\n+\n+        assertThat(this.firmwareManagementService.checkSsldPendingFirmwareUpdate(ids, firmwareVersions)).isFalse();", "originalCommit": "5c64180a6f6e35b9411c49c42e8598406cf5d0e1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDg0NjMxNw==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/419#discussion_r490846317", "bodyText": "In my opinion the suggestion would lead to a cleaner separation of steps in arrange-act-assert approach.\n(Same applies to other tests below)\nAlthough this is probably a matter of opinion...", "author": "smvdheijden", "createdAt": "2020-09-18T10:14:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDg0NDgyOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDg5MTkyNw==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/419#discussion_r490891927", "bodyText": "While arrange-act-assert makes for a good test approach, I quite strongly dislike the addition of comments indicating these separate stages.\nI don't think that stating the obvious is a good reason to add a comment. Comments should rather explain things that could use some explanation.\nSomething like the following looks like needless duplication:\n// assert\nassertThat ...\nThis falls, I think, in the same category as comments like:\nx = y +1; // make x one more than y\nIn my taste, adding the comments makes the tests look like a beginners tutorial on testing, instead of real world project test code. While I am all for clear and understandable code, I think there is a line between that and treating every reader as a programming novice, which is, in my opinion, crossed adding the comments as you propose.\nAs you said, apparently opinions can vary...", "author": "bvdzwet", "createdAt": "2020-09-18T11:41:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDg0NDgyOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTA0MzY5Nw==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/419#discussion_r491043697", "bodyText": "As discussed, the suggestion was not as much about adding the comments, but more about splitting up the act-assert steps that are currently on one line to have a cleaner separation between the arrange-act-assert steps.\nStill matter of opinion, no deal-breaker...", "author": "smvdheijden", "createdAt": "2020-09-18T15:57:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDg0NDgyOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTA1NDM2Mg==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/419#discussion_r491054362", "bodyText": "OK, I did not read that carefully enough the first time,\nI don't think it is necessarily better to always have the code acting and asserting on separate lines.\nLooking at this particular case again, I tend to agree with your suggestion, but for the additional reason that the name of the return value makes the meaning of the return value a bit more obvious.\nI'll also try to put the w in firmware this time, so we won't need a third round of changes! ;)", "author": "bvdzwet", "createdAt": "2020-09-18T16:15:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDg0NDgyOA=="}], "type": "inlineReview"}, {"oid": "33153843b9fea81f6c5316718921ff7846ae515f", "url": "https://github.com/OSGP/open-smart-grid-platform/commit/33153843b9fea81f6c5316718921ff7846ae515f", "message": "FLEX-5453 ~ Adds test annotations and splits method in two\n\nSome of the unit test methods supposed to test functionality missed the\nTest annotation, which has been added to have them executed.\n\nThe method getMostRecentDeletingOutdatedPendingFirmwareUpdates has a\nlong name, revealing that it does multiple things. This is refactored\ninto two more specialized methods\n(getMostRecentSsldPendingFirmwareUpdate and\ndeleteOutdatedSsldPendingFirmareUpdates).\n\nThe id of the SsldPendingFirmareUpdate is a Long object value. Therefore\nthe use of \"!=\" has been replaced by \"!Objects.equals\".", "committedDate": "2020-09-18T11:53:25Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTAzODY3MA==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/419#discussion_r491038670", "bodyText": "Fix typo (missing \"w\" in firmware):\ndeleteOutdatedSsldPendingFirmareUpdates -> deleteOutdatedSsldPendingFirmwareUpdates", "author": "smvdheijden", "createdAt": "2020-09-18T15:48:46Z", "path": "osgp/platform/osgp-adapter-domain-core/src/main/java/org/opensmartgridplatform/adapter/domain/core/application/services/FirmwareManagementService.java", "diffHunk": "@@ -190,32 +201,23 @@ public void handleSsldPendingFirmwareUpdate(final String deviceIdentification) {\n         }\n     }\n \n-    private SsldPendingFirmwareUpdate getMostRecentDeletingOutdatedPendingFirmwareUpdates(\n+    private Optional<SsldPendingFirmwareUpdate> getMostRecentSsldPendingFirmwareUpdate(\n             final List<SsldPendingFirmwareUpdate> ssldPendingFirmwareUpdates) {\n \n-        if (CollectionUtils.isEmpty(ssldPendingFirmwareUpdates)) {\n-            throw new IllegalArgumentException(\"ssldPendingFirmwareUpdates must not be empty\");\n-        }\n-        if (ssldPendingFirmwareUpdates.size() == 1) {\n-            return ssldPendingFirmwareUpdates.get(0);\n-        }\n-\n-        LOGGER.warn(\"Found multiple pending firmware update records for SSLD: {}\", ssldPendingFirmwareUpdates);\n-\n-        final SsldPendingFirmwareUpdate mostRecentSsldPendingFirmwareUpdate = ssldPendingFirmwareUpdates.stream()\n+        return ssldPendingFirmwareUpdates.stream()\n                 .max(Comparator.comparing(SsldPendingFirmwareUpdate::getCreationTime)\n-                        .thenComparing(Comparator.comparing(SsldPendingFirmwareUpdate::getId)))\n-                .orElseThrow(() -> new AssertionError(\"No most recent pending firmware update from a non-empty list\"));\n+                        .thenComparing(Comparator.comparing(SsldPendingFirmwareUpdate::getId)));\n+    }\n \n-        ssldPendingFirmwareUpdates.forEach(pendingUpdate -> {\n-            if (mostRecentSsldPendingFirmwareUpdate.getId() != pendingUpdate.getId()) {\n-                LOGGER.warn(\"Deleting pending firmware update assumed outdated: {}\", pendingUpdate);\n-                this.ssldPendingFirmwareUpdateRepository.delete(pendingUpdate);\n-            }\n-        });\n+    private void deleteOutdatedSsldPendingFirmareUpdates(final List<SsldPendingFirmwareUpdate> updatesToDelete,", "originalCommit": "33153843b9fea81f6c5316718921ff7846ae515f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTA1NDk5NQ==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/419#discussion_r491054995", "bodyText": "Added the w.", "author": "bvdzwet", "createdAt": "2020-09-18T16:16:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTAzODY3MA=="}], "type": "inlineReview"}, {"oid": "50985829ccd54e25037c2935cd912b1f8a4e0f76", "url": "https://github.com/OSGP/open-smart-grid-platform/commit/50985829ccd54e25037c2935cd912b1f8a4e0f76", "message": "FLEX-5453 ~ Fixes spelling mistake and splits act and assert statements", "committedDate": "2020-09-18T16:19:55Z", "type": "commit"}, {"oid": "247d6e0baa7472fbbfbd4d66912f1e36c694817d", "url": "https://github.com/OSGP/open-smart-grid-platform/commit/247d6e0baa7472fbbfbd4d66912f1e36c694817d", "message": "FLEX-5453 ~ Splits act-assert line in two lines in two methods", "committedDate": "2020-09-21T09:06:51Z", "type": "commit"}]}