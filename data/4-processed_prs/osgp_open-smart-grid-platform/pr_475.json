{"pr_number": 475, "pr_title": "FLEX-5534 ~ Improves archiving performance", "pr_createdAt": "2020-10-26T21:08:07Z", "pr_url": "https://github.com/OSGP/open-smart-grid-platform/pull/475", "timeline": [{"oid": "eb0695ee6f51c70adedaa958bdc4f5f165539419", "url": "https://github.com/OSGP/open-smart-grid-platform/commit/eb0695ee6f51c70adedaa958bdc4f5f165539419", "message": "FLEX-5534 ~ Optimize Event table", "committedDate": "2020-10-26T21:07:16Z", "type": "commit"}, {"oid": "18d2576413f733d410e1ba7128ea307fddd149c5", "url": "https://github.com/OSGP/open-smart-grid-platform/commit/18d2576413f733d410e1ba7128ea307fddd149c5", "message": "Merge branch 'development' of github.com:OSGP/open-smart-grid-platform into feature/FLEX-5534-improve-archiving-performance", "committedDate": "2020-10-27T14:56:36Z", "type": "commit"}, {"oid": "985af7a5f8399a7d83d7f5cbb7474befafc55b6c", "url": "https://github.com/OSGP/open-smart-grid-platform/commit/985af7a5f8399a7d83d7f5cbb7474befafc55b6c", "message": "FLEX-5534 ~ Fixes search functionality", "committedDate": "2020-10-27T16:12:08Z", "type": "commit"}, {"oid": "cd31855dc7663caedbaf173994f01d30814be80e", "url": "https://github.com/OSGP/open-smart-grid-platform/commit/cd31855dc7663caedbaf173994f01d30814be80e", "message": "FLEX-5334 ~ Completes changes", "committedDate": "2020-10-28T20:52:41Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTAyMzk5Mg==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/475#discussion_r515023992", "bodyText": "Also remove the Autowired DeviceRepository field, as it seems it is no longer used...", "author": "smvdheijden", "createdAt": "2020-10-30T11:14:32Z", "path": "integration-tests/cucumber-tests-platform/src/test/java/org/opensmartgridplatform/cucumber/platform/glue/steps/database/core/EventSteps.java", "diffHunk": "@@ -48,10 +47,10 @@\n \n     @Given(\"^an event$\")\n     public void anEvent(final Map<String, String> data) {\n-        final Device device = this.deviceRepository\n-                .findByDeviceIdentification(getString(data, PlatformKeys.KEY_DEVICE_IDENTIFICATION));\n+        final String deviceIdentification = getString(data, PlatformKeys.KEY_DEVICE_IDENTIFICATION);", "originalCommit": "cd31855dc7663caedbaf173994f01d30814be80e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTIyNjkyMQ==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/475#discussion_r515226921", "bodyText": "Done.", "author": "rlemmers", "createdAt": "2020-10-30T16:35:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTAyMzk5Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTA2NjMyOA==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/475#discussion_r515066328", "bodyText": "Consider making this an autowired configurable property.", "author": "smvdheijden", "createdAt": "2020-10-30T12:34:58Z", "path": "osgp/platform/osgp-adapter-domain-core/src/main/java/org/opensmartgridplatform/adapter/domain/core/application/services/TransactionalDeviceLogItemService.java", "diffHunk": "@@ -30,14 +31,16 @@\n @Transactional(transactionManager = \"domainLoggingTransactionManager\")\n public class TransactionalDeviceLogItemService {\n \n+    private static final int PAGE_SIZE = 500;", "originalCommit": "cd31855dc7663caedbaf173994f01d30814be80e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTIyNjg0Nw==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/475#discussion_r515226847", "bodyText": "Discussed this and decided not to implement this, because it's very unlikely we will use this page size for tweaking.", "author": "rlemmers", "createdAt": "2020-10-30T16:34:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTA2NjMyOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTA2NjM4OQ==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/475#discussion_r515066389", "bodyText": "Consider making this an autowired configurable property.", "author": "smvdheijden", "createdAt": "2020-10-30T12:35:04Z", "path": "osgp/platform/osgp-adapter-domain-core/src/main/java/org/opensmartgridplatform/adapter/domain/core/application/services/TransactionalEventService.java", "diffHunk": "@@ -30,13 +31,15 @@\n @Transactional(transactionManager = \"transactionManager\")\n public class TransactionalEventService {\n \n+    private static final int PAGE_SIZE = 500;", "originalCommit": "cd31855dc7663caedbaf173994f01d30814be80e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTIyNjgwMw==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/475#discussion_r515226803", "bodyText": "Discussed this and decided not to implement this, because it's very unlikely we will use this page size for tweaking.", "author": "rlemmers", "createdAt": "2020-10-30T16:34:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTA2NjM4OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTA3NjA1MQ==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/475#discussion_r515076051", "bodyText": "Move the line above the comment, to keep the comment closer to the if statement.", "author": "smvdheijden", "createdAt": "2020-10-30T12:54:33Z", "path": "osgp/platform/osgp-core/src/main/java/org/opensmartgridplatform/core/application/services/EventNotificationMessageService.java", "diffHunk": "@@ -218,47 +219,45 @@ private void createRelayStatus(final Device device, final Event switchingEvent,\n         }\n     }\n \n-    private void handleSwitchingEvent(final Device device, final Date dateTime, final EventType eventType,\n+    private void handleSwitchingEvent(final String deviceIdentification, final Date dateTime, final EventType eventType,\n             final int index) throws UnknownEntityException {\n \n         // If the index == 0 handle all LIGHT relays, otherwise just handle the\n         // index.\n+        final Ssld ssld = this.eventNotificationHelperService.findSsld(deviceIdentification);", "originalCommit": "cd31855dc7663caedbaf173994f01d30814be80e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTIyNTQ2Ng==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/475#discussion_r515225466", "bodyText": "Done.", "author": "rlemmers", "createdAt": "2020-10-30T16:32:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTA3NjA1MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTA3Njg0Ng==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/475#discussion_r515076846", "bodyText": "\ud83d\udc4d", "author": "smvdheijden", "createdAt": "2020-10-30T12:55:58Z", "path": "osgp/platform/osgp-core/src/main/java/org/opensmartgridplatform/core/application/services/EventNotificationMessageService.java", "diffHunk": "@@ -329,8 +328,8 @@ private void printRelayIndexes(final Set<Integer> indexesLightRelays, final Set<\n     private void printRelayStatuses(final Map<Integer, RelayStatus> lastRelayStatusPerIndex,\n             final String deviceIdentification) {\n         LOGGER.info(\"print relay statuses for device: {}\", deviceIdentification);\n-        for (final Integer key : lastRelayStatusPerIndex.keySet()) {\n-            LOGGER.info(\"key: {}, value: {}\", key, lastRelayStatusPerIndex.get(key));\n+        for (final Entry<Integer, RelayStatus> entry : lastRelayStatusPerIndex.entrySet()) {", "originalCommit": "cd31855dc7663caedbaf173994f01d30814be80e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTA3OTk3MQ==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/475#discussion_r515079971", "bodyText": "Shouldn't a NOT NULL constraint be added once the column is filled with data?", "author": "smvdheijden", "createdAt": "2020-10-30T13:01:45Z", "path": "osgp/platform/osgp-core/src/main/resources/db/migration/V20201027172100000__Replaces_Event_deviceId_by_deviceIdentification.sql", "diffHunk": "@@ -0,0 +1,21 @@\n+DO\n+$$\n+BEGIN\n+\n+  IF NOT EXISTS(SELECT 1 FROM information_schema.columns\n+                WHERE table_schema = current_schema AND table_name = 'event' AND column_name = 'device_identification')\n+  THEN\n+    ALTER TABLE event ADD COLUMN device_identification CHARACTER VARYING(40),", "originalCommit": "cd31855dc7663caedbaf173994f01d30814be80e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTIyNTExNQ==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/475#discussion_r515225115", "bodyText": "The original \"device\" did not have one, therefore not added here, to be on the safe side.", "author": "rlemmers", "createdAt": "2020-10-30T16:32:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTA3OTk3MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTA4MDI4OQ==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/475#discussion_r515080289", "bodyText": "Isn't @Column(nullable = false) needed here?", "author": "smvdheijden", "createdAt": "2020-10-30T13:02:21Z", "path": "osgp/platform/osgp-domain-core/src/main/java/org/opensmartgridplatform/domain/core/entities/Event.java", "diffHunk": "@@ -27,9 +25,7 @@\n      */\n     private static final long serialVersionUID = 5987663923796632312L;\n \n-    @ManyToOne()\n-    @JoinColumn(name = \"device\")\n-    private Device device;\n+    private String deviceIdentification;", "originalCommit": "cd31855dc7663caedbaf173994f01d30814be80e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTIyNTM1NQ==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/475#discussion_r515225355", "bodyText": "Not added to stay in line with the old code, to be on the safe side.", "author": "rlemmers", "createdAt": "2020-10-30T16:32:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTA4MDI4OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTA4MjMyMg==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/475#discussion_r515082322", "bodyText": "Is this check really needed?", "author": "smvdheijden", "createdAt": "2020-10-30T13:06:16Z", "path": "osgp/platform/osgp-core/src/main/java/org/opensmartgridplatform/core/application/services/EventNotificationMessageService.java", "diffHunk": "@@ -58,18 +59,17 @@\n     public void handleEvent(final String deviceIdentification, final Date dateTime, final EventType eventType,\n             final String description, final Integer index) throws UnknownEntityException {\n \n-        // Lookup device\n-        final Device device = this.eventNotificationHelperService.findDevice(deviceIdentification);\n-        // If the event belongs to an existing device, then save it,\n-        // otherwise don't.\n-        this.eventNotificationHelperService.saveEvent(new Event(device,\n+        // Check if the event belongs to an existing device\n+        this.eventNotificationHelperService.findDevice(deviceIdentification);", "originalCommit": "cd31855dc7663caedbaf173994f01d30814be80e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTIyNDc2OA==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/475#discussion_r515224768", "bodyText": "Check removed.", "author": "rlemmers", "createdAt": "2020-10-30T16:31:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTA4MjMyMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTA4Mzk3NA==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/475#discussion_r515083974", "bodyText": "Not in scope for this story, but it would be nice if the findByDeviceIdentification call is modified to return an Optional<Ssld>...", "author": "smvdheijden", "createdAt": "2020-10-30T13:09:16Z", "path": "osgp/platform/osgp-core/src/main/java/org/opensmartgridplatform/core/application/services/EventNotificationHelperService.java", "diffHunk": "@@ -63,6 +63,14 @@ public Ssld findSsld(final Long id) throws UnknownEntityException {\n         return ssld.get();\n     }\n \n+    public Ssld findSsld(final String deviceIdentification) throws UnknownEntityException {\n+        final Ssld ssld = this.ssldRepository.findByDeviceIdentification(deviceIdentification);", "originalCommit": "cd31855dc7663caedbaf173994f01d30814be80e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTIyNDY1Nw==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/475#discussion_r515224657", "bodyText": "Agreed to look into this some other time.", "author": "rlemmers", "createdAt": "2020-10-30T16:31:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTA4Mzk3NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTA4NTI1NA==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/475#discussion_r515085254", "bodyText": "Not in scope for this story, but this could easily be refactored to a isSwitchingEvent method, making the comment unnecessary...", "author": "smvdheijden", "createdAt": "2020-10-30T13:11:32Z", "path": "osgp/platform/osgp-core/src/main/java/org/opensmartgridplatform/core/application/services/EventNotificationMessageService.java", "diffHunk": "@@ -58,18 +59,17 @@\n     public void handleEvent(final String deviceIdentification, final Date dateTime, final EventType eventType,\n             final String description, final Integer index) throws UnknownEntityException {\n \n-        // Lookup device\n-        final Device device = this.eventNotificationHelperService.findDevice(deviceIdentification);\n-        // If the event belongs to an existing device, then save it,\n-        // otherwise don't.\n-        this.eventNotificationHelperService.saveEvent(new Event(device,\n+        // Check if the event belongs to an existing device\n+        this.eventNotificationHelperService.findDevice(deviceIdentification);\n+\n+        this.eventNotificationHelperService.saveEvent(new Event(deviceIdentification,\n                 dateTime != null ? dateTime : DateTime.now().toDate(), eventType, description, index));\n \n         // Check if it was a switching event.\n         if (eventType.equals(EventType.LIGHT_EVENTS_LIGHT_ON) || eventType.equals(EventType.LIGHT_EVENTS_LIGHT_OFF)\n                 || eventType.equals(EventType.TARIFF_EVENTS_TARIFF_ON)\n                 || eventType.equals(EventType.TARIFF_EVENTS_TARIFF_OFF)) {", "originalCommit": "cd31855dc7663caedbaf173994f01d30814be80e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTIyNDM1Mg==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/475#discussion_r515224352", "bodyText": "Done (and Eclipse also replaced the code at a second place in this file, when I refactored this).", "author": "rlemmers", "createdAt": "2020-10-30T16:30:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTA4NTI1NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTA4NTU5Mg==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/475#discussion_r515085592", "bodyText": "\ud83d\udc4d", "author": "smvdheijden", "createdAt": "2020-10-30T13:12:12Z", "path": "osgp/platform/osgp-adapter-ws-publiclighting/src/main/java/org/opensmartgridplatform/adapter/ws/publiclighting/infra/jms/messageprocessor/DomainResponseMessageProcessor.java", "diffHunk": "@@ -76,7 +76,7 @@ public void init() {\n \n     @Override\n     public void processMessage(final ObjectMessage message) {\n-        LOGGER.debug(\"Processing smart metering response message\");\n+        LOGGER.debug(\"Processing public lighting response message\");", "originalCommit": "cd31855dc7663caedbaf173994f01d30814be80e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTA5MjI4OA==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/475#discussion_r515092288", "bodyText": "\ud83e\udd14\n\ud83d\udc4d", "author": "smvdheijden", "createdAt": "2020-10-30T13:22:38Z", "path": "osgp/platform/osgp-adapter-domain-publiclighting/src/main/java/org/opensmartgridplatform/adapter/domain/publiclighting/application/services/AdHocManagementService.java", "diffHunk": "@@ -390,18 +390,15 @@ private LightMeasurementDevice updateLmdLastCommunicationTime(final LightMeasure\n     }\n \n     private boolean isDuplicateEvent(final Event event, final LightMeasurementDevice lmd) {\n-        final List<Event> events = this.eventRepository.findTop2ByDeviceOrderByDateTimeDesc(lmd);\n-        for (final Event e : events) {\n-            if (event.getDateTime().equals(e.getDateTime())) {\n-                // Exact match found, skip this event of the result set.\n-                continue;\n-            } else if (event.getEventType().equals(e.getEventType())) {\n-                // If second event has same type, duplicate event has been\n-                // detected.\n-                return true;\n-            }\n-        }\n-        return false;\n+        final List<Event> events = this.eventRepository\n+                .findTop2ByDeviceIdentificationOrderByDateTimeDesc(lmd.getDeviceIdentification());\n+\n+        // Returns true if one of the events differs in date/time and has the\n+        // same event type\n+        return events.stream()", "originalCommit": "cd31855dc7663caedbaf173994f01d30814be80e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "1f92b161fb9506275eb5af61e58b4445406bf9e6", "url": "https://github.com/OSGP/open-smart-grid-platform/commit/1f92b161fb9506275eb5af61e58b4445406bf9e6", "message": "FLEX-5334 ~ Processes review comments", "committedDate": "2020-10-30T14:20:02Z", "type": "commit"}]}