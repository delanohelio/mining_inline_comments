{"pr_number": 248, "pr_title": "Slim 2326/add generic filtering of pq data", "pr_createdAt": "2020-03-25T08:09:53Z", "pr_url": "https://github.com/OSGP/open-smart-grid-platform/pull/248", "timeline": [{"oid": "f61f3baea55afb8b1cac048f0ba157950619bb70", "url": "https://github.com/OSGP/open-smart-grid-platform/commit/f61f3baea55afb8b1cac048f0ba157950619bb70", "message": "SLIM-2326 first raw impl of generic PQ data with selective access", "committedDate": "2020-03-23T14:00:15Z", "type": "commit"}, {"oid": "edeacd1ae4626a9d1021f5e16e5d6692e8c5f3ca", "url": "https://github.com/OSGP/open-smart-grid-platform/commit/edeacd1ae4626a9d1021f5e16e5d6692e8c5f3ca", "message": "SLIM-2196 obis code from String, added unit test for selected values filter", "committedDate": "2020-03-24T11:44:03Z", "type": "commit"}, {"oid": "e1e525130517955f5d67210ed24ab476ea35d239", "url": "https://github.com/OSGP/open-smart-grid-platform/commit/e1e525130517955f5d67210ed24ab476ea35d239", "message": "SLIM-2326 selective access support", "committedDate": "2020-03-25T08:09:04Z", "type": "commit"}, {"oid": "eea315a244e9acd57874f95d2aace26d79de4f22", "url": "https://github.com/OSGP/open-smart-grid-platform/commit/eea315a244e9acd57874f95d2aace26d79de4f22", "message": "SLIM-2326 fix for selective access", "committedDate": "2020-03-25T09:54:11Z", "type": "commit"}, {"oid": "ff466b72e1759c0d948db0ee68e1eed8ca01b863", "url": "https://github.com/OSGP/open-smart-grid-platform/commit/ff466b72e1759c0d948db0ee68e1eed8ca01b863", "message": "SLIM-2326 refactored into abstract classes", "committedDate": "2020-03-25T17:08:41Z", "type": "commit"}, {"oid": "9feb7dd665c41e31c125952902858d6d8d61e2b1", "url": "https://github.com/OSGP/open-smart-grid-platform/commit/9feb7dd665c41e31c125952902858d6d8d61e2b1", "message": "SLIM-2326 renamed specific executor to handler. Made handlers more abstract", "committedDate": "2020-03-26T08:58:42Z", "type": "commit"}, {"oid": "ef0d3adbb9b807e8689959da0372e37bab9919fd", "url": "https://github.com/OSGP/open-smart-grid-platform/commit/ef0d3adbb9b807e8689959da0372e37bab9919fd", "message": "SLIM-2326 code cleanup, Sonar warnings", "committedDate": "2020-03-26T11:59:01Z", "type": "commit"}, {"oid": "3a177cee6b11af5d2c3e48a25262fab5a61f01af", "url": "https://github.com/OSGP/open-smart-grid-platform/commit/3a177cee6b11af5d2c3e48a25262fab5a61f01af", "message": "SLIM-2326 changed scalar back to scaler", "committedDate": "2020-03-26T12:23:00Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTE3NDg5MA==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/248#discussion_r399174890", "bodyText": "most code in this class is the old executor, I rewrote some, and some code I kept intact.", "author": "coendamen", "createdAt": "2020-03-27T10:40:31Z", "path": "osgp/protocol-adapter-dlms/osgp-protocol-adapter-dlms/src/main/java/org/opensmartgridplatform/adapter/protocol/dlms/domain/commands/monitoring/AbstractGetPowerQualityProfileHandler.java", "diffHunk": "@@ -6,7 +6,7 @@\n  *", "originalCommit": "3a177cee6b11af5d2c3e48a25262fab5a61f01af", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "b2d0e94094d419468fc141f787beb8652743d5b0", "url": "https://github.com/OSGP/open-smart-grid-platform/commit/b2d0e94094d419468fc141f787beb8652743d5b0", "message": "SLIM-2326 added functional description to obiscodes", "committedDate": "2020-03-30T08:38:04Z", "type": "commit"}, {"oid": "1503318282f244ac9a63445f6805a5a861a21eee", "url": "https://github.com/OSGP/open-smart-grid-platform/commit/1503318282f244ac9a63445f6805a5a861a21eee", "message": "SLIM-2326 updated XSD to handle PQ request and response", "committedDate": "2020-03-30T09:16:06Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDA0MjkzNQ==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/248#discussion_r400042935", "bodyText": "Er is wel een Unit Test voor deze Class, maar die covered niet wat er in deze Class gebeurd.\nHet gedrag in de super wordt hier wel getest.", "author": "jboon", "createdAt": "2020-03-30T09:17:39Z", "path": "osgp/protocol-adapter-dlms/osgp-protocol-adapter-dlms/src/main/java/org/opensmartgridplatform/adapter/protocol/dlms/domain/commands/monitoring/GetPowerQualityProfileCommandExecutor.java", "diffHunk": "@@ -0,0 +1,46 @@\n+/**\n+ * Copyright 2017 Smart Society Services B.V.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ */\n+package org.opensmartgridplatform.adapter.protocol.dlms.domain.commands.monitoring;\n+\n+import org.opensmartgridplatform.adapter.protocol.dlms.domain.commands.AbstractCommandExecutor;\n+import org.opensmartgridplatform.adapter.protocol.dlms.domain.entities.DlmsDevice;\n+import org.opensmartgridplatform.adapter.protocol.dlms.domain.factories.DlmsConnectionManager;\n+import org.opensmartgridplatform.adapter.protocol.dlms.exceptions.ProtocolAdapterException;\n+import org.opensmartgridplatform.dto.valueobjects.smartmetering.GetPowerQualityProfileRequestDataDto;\n+import org.opensmartgridplatform.dto.valueobjects.smartmetering.GetPowerQualityProfileResponseDto;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.stereotype.Component;\n+", "originalCommit": "3a177cee6b11af5d2c3e48a25262fab5a61f01af", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDA0MzgxNg==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/248#discussion_r400043816", "bodyText": "Geen Unit Test", "author": "jboon", "createdAt": "2020-03-30T09:18:58Z", "path": "osgp/protocol-adapter-dlms/osgp-protocol-adapter-dlms/src/main/java/org/opensmartgridplatform/adapter/protocol/dlms/domain/commands/monitoring/GetPowerQualityProfileNoSelectiveAccessHandler.java", "diffHunk": "@@ -0,0 +1,62 @@\n+/**\n+ * Copyright 2017 Smart Society Services B.V.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ */\n+package org.opensmartgridplatform.adapter.protocol.dlms.domain.commands.monitoring;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Map;\n+\n+import org.openmuc.jdlms.datatypes.DataObject;\n+import org.opensmartgridplatform.adapter.protocol.dlms.domain.commands.utils.DlmsHelper;\n+import org.opensmartgridplatform.adapter.protocol.dlms.domain.commands.utils.ScalerUnitInfo;\n+import org.opensmartgridplatform.dto.valueobjects.smartmetering.CaptureObjectDefinitionDto;\n+import org.opensmartgridplatform.dto.valueobjects.smartmetering.ProfileEntryDto;\n+import org.opensmartgridplatform.dto.valueobjects.smartmetering.ProfileEntryValueDto;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.stereotype.Component;\n+", "originalCommit": "3a177cee6b11af5d2c3e48a25262fab5a61f01af", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDA0NTkyMg==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/248#discussion_r400045922", "bodyText": "ik zal de executor test ombutsen naar een handler test.", "author": "coendamen", "createdAt": "2020-03-30T09:22:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDA0MzgxNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDA1Nzc4OQ==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/248#discussion_r400057789", "bodyText": "ombudsman :-)", "author": "jboon", "createdAt": "2020-03-30T09:41:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDA0MzgxNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDA0ODIzMg==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/248#discussion_r400048232", "bodyText": "Dit kan beter in een eigen Unit Test class.", "author": "jboon", "createdAt": "2020-03-30T09:25:55Z", "path": "osgp/protocol-adapter-dlms/osgp-protocol-adapter-dlms/src/test/java/org/opensmartgridplatform/adapter/protocol/dlms/domain/commands/monitoring/GetPowerQualityProfileCommandExecutorTest.java", "diffHunk": "@@ -66,19 +67,66 @@ public void testExecute() throws ProtocolAdapterException {\n         when(dlmsHelper.readLong(any(DataObject.class), any(String.class))).thenCallRealMethod();\r\n         when(dlmsHelper.convertDataObjectToDateTime(any(DataObject.class))).thenCallRealMethod();\r\n         when(dlmsHelper.fromDateTimeValue(any())).thenCallRealMethod();\r\n+        when(dlmsHelper.getClockDefinition()).thenCallRealMethod();\r\n \r\n-        GetPowerQualityProfileCommandExecutor executor = new GetPowerQualityProfileCommandExecutor(dlmsHelper);\r\n+        GetPowerQualityProfileSelectiveAccessHandler handler = new GetPowerQualityProfileSelectiveAccessHandler(\r\n+                dlmsHelper);\r\n \r\n         // EXECUTE\r\n \r\n-        GetPowerQualityProfileResponseDto responseDto = executor.execute(conn, dlmsDevice, requestDto);\r\n+        GetPowerQualityProfileResponseDto responseDto = handler.handle(conn, dlmsDevice, requestDto);\r\n \r\n         // ASSERT\r\n \r\n         assertThat(responseDto.getPowerQualityProfileResponseDatas().size()).isEqualTo(2);\r\n         assertThat(responseDto.getPowerQualityProfileResponseDatas().get(0).getCaptureObjects().size()).isEqualTo(3);\r\n         assertThat(responseDto.getPowerQualityProfileResponseDatas().get(0).getProfileEntries().size()).isEqualTo(4);\r\n \r\n+        for (ProfileEntryDto profileEntryDto : responseDto.getPowerQualityProfileResponseDatas().get(0)\r\n+                                                          .getProfileEntries()) {\r\n+            assertThat(profileEntryDto.getProfileEntryValues().size()).isEqualTo(3);\r\n+        }\r\n+    }\r\n+\r\n+    @Test\r\n+    public void testExecuteNoSelectiveAccess() throws ProtocolAdapterException {\r", "originalCommit": "3a177cee6b11af5d2c3e48a25262fab5a61f01af", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDA0OTk1Nw==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/248#discussion_r400049957", "bodyText": "Ik vind het moeilijk te beoordelen of deze test volledig is. Wat ik wel kan beoordelen is dat ik uit deze test niet kan opmaken wat de implementatie zou moeten doen. Dit kun je verbeteren door duidelijk test methode namen en laten zien wat je als inhoud verwacht. Tenzij de size van de verschillende collecties dat is waar het om gaat, maar wellicht is de inhoud van de collecties ook belangrijk?", "author": "jboon", "createdAt": "2020-03-30T09:28:34Z", "path": "osgp/protocol-adapter-dlms/osgp-protocol-adapter-dlms/src/test/java/org/opensmartgridplatform/adapter/protocol/dlms/domain/commands/monitoring/GetPowerQualityProfileCommandExecutorTest.java", "diffHunk": "@@ -66,19 +67,66 @@ public void testExecute() throws ProtocolAdapterException {\n         when(dlmsHelper.readLong(any(DataObject.class), any(String.class))).thenCallRealMethod();\r", "originalCommit": "3a177cee6b11af5d2c3e48a25262fab5a61f01af", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDA1NDY0Ng==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/248#discussion_r400054646", "bodyText": "er zit heel veel logica in de dlmshelper, hier is een aparte test voor. deze test transformeert data van de meter (die ik inschiet via de mock) naar een DTO. de ene handler filtert vooraf, en de andere achteraf.", "author": "coendamen", "createdAt": "2020-03-30T09:35:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDA0OTk1Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDA3NDA3NQ==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/248#discussion_r400074075", "bodyText": "De unit testen komen niet 1 op 1 overeen met de classes. Dan willen we wel, lijkt me?", "author": "evanbarn", "createdAt": "2020-03-30T10:07:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDA0OTk1Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDA4MDI3MA==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/248#discussion_r400080270", "bodyText": "nee het idee was, omdat de executor alleen maar een if-then-else statement is, om deze testen samen te voegen tot 1 test, beetje lui maar wel effectief :-)\nik ben deze nu aan het herschikken naar 2 handler tests.", "author": "coendamen", "createdAt": "2020-03-30T10:18:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDA0OTk1Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDEyNjAyNQ==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/248#discussion_r400126025", "bodyText": "I don't know how everything should work together, but when I run the test with coverage GetPowerQualityProfileCommandExecutor.execute() isn't covered; this is weird because it is the only method in the class under test.", "author": "jandik", "createdAt": "2020-03-30T11:42:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDA0OTk1Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDEyODE0NQ==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/248#discussion_r400128145", "bodyText": "Oh, sorry, duplicate apparently :-)", "author": "jandik", "createdAt": "2020-03-30T11:46:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDA0OTk1Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDEyOTUxMQ==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/248#discussion_r400129511", "bodyText": "@jandik I reshuffled the tests", "author": "coendamen", "createdAt": "2020-03-30T11:49:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDA0OTk1Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDA1MTA2Ng==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/248#discussion_r400051066", "bodyText": "Dit is een mooi target voor Lombok!", "author": "jboon", "createdAt": "2020-03-30T09:30:09Z", "path": "osgp/shared/osgp-dto/src/main/java/org/opensmartgridplatform/dto/valueobjects/smartmetering/ObisCodeValuesDto.java", "diffHunk": "@@ -30,6 +31,28 @@ public ObisCodeValuesDto(final byte a, final byte b, final byte c, final byte d,\n         this.f = f;\n     }\n \n+    public ObisCodeValuesDto(String obisCode) {", "originalCommit": "3a177cee6b11af5d2c3e48a25262fab5a61f01af", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDA1MTIyMg==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/248#discussion_r400051222", "bodyText": "Scheelt je ook een Sonar check", "author": "jboon", "createdAt": "2020-03-30T09:30:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDA1MTA2Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDE5OTU1MQ==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/248#discussion_r400199551", "bodyText": "ja goed punt. ik ga echter lombok nu niet introduceren in osgp. dan is er 1 class die lombok gebrukt en wie weet wanneer er een andere class aangeraakt gaat worden.", "author": "coendamen", "createdAt": "2020-03-30T13:40:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDA1MTA2Ng=="}], "type": "inlineReview"}, {"oid": "76d670600deb556faa911dc66e795eac0cb12b62", "url": "https://github.com/OSGP/open-smart-grid-platform/commit/76d670600deb556faa911dc66e795eac0cb12b62", "message": "SLIM-2326 process review comments, refactored some tests", "committedDate": "2020-03-30T10:32:06Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDA5ODkxMQ==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/248#discussion_r400098911", "bodyText": "This method uses deprecated classes/methods.", "author": "jandik", "createdAt": "2020-03-30T10:51:35Z", "path": "osgp/protocol-adapter-dlms/osgp-protocol-adapter-dlms/src/main/java/org/opensmartgridplatform/adapter/protocol/dlms/domain/commands/monitoring/AbstractGetPowerQualityProfileHandler.java", "diffHunk": "@@ -267,12 +307,9 @@ private boolean isSelectedValue(final List<CaptureObjectDefinitionDto> selectedV\n             return true;\n         }\n \n-        for (final CaptureObjectDefinitionDto captureObjectDefinition : selectedValues) {\n-            if (this.isDefinitionOfSameObject(cosemObjectDefinitionDto, captureObjectDefinition)) {\n-                return true;\n-            }\n-        }\n-        return false;\n+        return selectedValues.stream().anyMatch(\n+                selectedValue -> this.isDefinitionOfSameObject(cosemObjectDefinitionDto, selectedValue));\n+\n     }\n \n     private boolean isClockDefinition(final CosemObjectDefinitionDto cosemObjectDefinitionDto) {", "originalCommit": "1503318282f244ac9a63445f6805a5a861a21eee", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDExMTQ3Nw==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/248#discussion_r400111477", "bodyText": "yes, the entire openmuc lib usage is deprecated, out of scope of this PR. needs investigation on how to proceed", "author": "coendamen", "createdAt": "2020-03-30T11:14:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDA5ODkxMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDEwMTAxMg==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/248#discussion_r400101012", "bodyText": "I would expect this method to be redundant, if equals() was defined properly on these DTO's and/or one can be mapped to the other.", "author": "jandik", "createdAt": "2020-03-30T10:55:13Z", "path": "osgp/protocol-adapter-dlms/osgp-protocol-adapter-dlms/src/main/java/org/opensmartgridplatform/adapter/protocol/dlms/domain/commands/monitoring/AbstractGetPowerQualityProfileHandler.java", "diffHunk": "@@ -293,16 +330,11 @@ private boolean isDefinitionOfSameObject(final CosemObjectDefinitionDto cosemObj\n         final byte[] obisBytesCosemObjectDefinition = cosemObjectDefinitionDto.getLogicalName().toByteArray();\n         final byte attributeIndexCosemObjectDefinition = (byte) cosemObjectDefinitionDto.getAttributeIndex();\n         final int dataIndexCosemObjectDefinition = cosemObjectDefinitionDto.getDataIndex();\n-\n         final int classIdCaptureObjectDefinition = captureObjectDefinition.getClassId();\n         final byte[] obisBytesCaptureObjectDefinition = captureObjectDefinition.getLogicalName().toByteArray();\n         final byte attributeIndexCaptureObjectDefinition = captureObjectDefinition.getAttributeIndex();\n-        final int dataIndexCaptureObjectDefinition;\n-        if (captureObjectDefinition.getDataIndex() == null) {\n-            dataIndexCaptureObjectDefinition = 0;\n-        } else {\n-            dataIndexCaptureObjectDefinition = captureObjectDefinition.getDataIndex();\n-        }\n+        final int dataIndexCaptureObjectDefinition =\n+                captureObjectDefinition.getDataIndex() == null ? 0 : captureObjectDefinition.getDataIndex();\n \n         return classIdCaptureObjectDefinition == classIdCosemObjectDefinition && Arrays", "originalCommit": "1503318282f244ac9a63445f6805a5a861a21eee", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDEwMzAwNQ==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/248#discussion_r400103005", "bodyText": "Consider using classic for-loop with variable positionInDataObjectsList inlined; this ensures increment of the variable and improves readability", "author": "jandik", "createdAt": "2020-03-30T10:58:30Z", "path": "osgp/protocol-adapter-dlms/osgp-protocol-adapter-dlms/src/main/java/org/opensmartgridplatform/adapter/protocol/dlms/domain/commands/monitoring/AbstractGetPowerQualityProfileHandler.java", "diffHunk": "@@ -463,39 +439,105 @@ private ProfileEntryValueDto makeNumericProfileEntryValueDto(final DataObject da\n             }\n         } catch (final ProtocolAdapterException e) {\n             LOGGER.error(\"Error creating ProfileEntryDto from {}\", dataObject, e);\n-            final String dbgInfo = this.dlmsHelper.getDebugInfo(dataObject);\n-            return new ProfileEntryValueDto(dbgInfo);\n+            final String debugInfo = this.dlmsHelper.getDebugInfo(dataObject);\n+            return new ProfileEntryValueDto(debugInfo);\n         }\n     }\n \n-    private List<ScalerUnitInfo> retrieveScalerUnits(final DlmsConnectionManager conn, final DlmsDevice device,\n-            final List<GetResult> captureObjects) throws ProtocolAdapterException {\n+    private Map<Integer, CaptureObjectDefinitionDto> createSelectableCaptureObjects(\n+            final List<GetResult> captureObjects, List<String> logicalNames) throws ProtocolAdapterException {\n \n-        final List<ScalerUnitInfo> result = new ArrayList<>();\n+        Map<Integer, CaptureObjectDefinitionDto> selectableCaptureObjects = new HashMap<>();\n \n+        // there is always only one GetResult\n         for (final GetResult captureObjectResult : captureObjects) {\n-            final DataObject dataObject = captureObjectResult.getResultData();\n-            final List<DataObject> dataObjectList1 = dataObject.getValue();\n-            for (final DataObject captureObjectDataObject : dataObjectList1) {\n+\n+            final List<DataObject> dataObjects = captureObjectResult.getResultData().getValue();\n+            int positionInDataObjectsList = 0;\n+\n+            for (DataObject dataObject : dataObjects) {", "originalCommit": "1503318282f244ac9a63445f6805a5a861a21eee", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDE3NjgzNw==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/248#discussion_r400176837", "bodyText": "you are right, that would be an improvement.", "author": "coendamen", "createdAt": "2020-03-30T13:08:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDEwMzAwNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDEwMzkzNw==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/248#discussion_r400103937", "bodyText": "Potential NullPointerException. The comment suggests this will never happen, but I don't know if it never can happen.", "author": "jandik", "createdAt": "2020-03-30T11:00:14Z", "path": "osgp/protocol-adapter-dlms/osgp-protocol-adapter-dlms/src/main/java/org/opensmartgridplatform/adapter/protocol/dlms/domain/commands/monitoring/AbstractGetPowerQualityProfileHandler.java", "diffHunk": "@@ -463,39 +439,105 @@ private ProfileEntryValueDto makeNumericProfileEntryValueDto(final DataObject da\n             }\n         } catch (final ProtocolAdapterException e) {\n             LOGGER.error(\"Error creating ProfileEntryDto from {}\", dataObject, e);\n-            final String dbgInfo = this.dlmsHelper.getDebugInfo(dataObject);\n-            return new ProfileEntryValueDto(dbgInfo);\n+            final String debugInfo = this.dlmsHelper.getDebugInfo(dataObject);\n+            return new ProfileEntryValueDto(debugInfo);\n         }\n     }\n \n-    private List<ScalerUnitInfo> retrieveScalerUnits(final DlmsConnectionManager conn, final DlmsDevice device,\n-            final List<GetResult> captureObjects) throws ProtocolAdapterException {\n+    private Map<Integer, CaptureObjectDefinitionDto> createSelectableCaptureObjects(\n+            final List<GetResult> captureObjects, List<String> logicalNames) throws ProtocolAdapterException {\n \n-        final List<ScalerUnitInfo> result = new ArrayList<>();\n+        Map<Integer, CaptureObjectDefinitionDto> selectableCaptureObjects = new HashMap<>();\n \n+        // there is always only one GetResult\n         for (final GetResult captureObjectResult : captureObjects) {\n-            final DataObject dataObject = captureObjectResult.getResultData();\n-            final List<DataObject> dataObjectList1 = dataObject.getValue();\n-            for (final DataObject captureObjectDataObject : dataObjectList1) {\n+\n+            final List<DataObject> dataObjects = captureObjectResult.getResultData().getValue();\n+            int positionInDataObjectsList = 0;\n+\n+            for (DataObject dataObject : dataObjects) {\n \n                 final CosemObjectDefinitionDto cosemObjectDefinitionDto = this.dlmsHelper\n-                        .readObjectDefinition(captureObjectDataObject, CAPTURE_OBJECT);\n-                final int classId = cosemObjectDefinitionDto.getClassId();\n+                        .readObjectDefinition(dataObject, CAPTURE_OBJECT);\n+\n                 final String logicalName = cosemObjectDefinitionDto.getLogicalName().toString();\n-                if (this.hasScalerUnit(classId)) {\n-                    final AttributeAddress addr = new AttributeAddress(classId, logicalName,\n-                            SCALER_UNITS_MAP.get(classId));\n-                    final List<GetResult> scalerUnitResult = this.dlmsHelper\n-                            .getAndCheck(conn, device, \"retrieve scaler unit for capture object\", addr);\n-                    final DataObject scalerUnitDataObject = scalerUnitResult.get(0).getResultData();\n-                    result.add(new ScalerUnitInfo(logicalName, classId, scalerUnitDataObject));\n-                } else {\n-                    result.add(new ScalerUnitInfo(logicalName, classId, null));\n+\n+                if (logicalNames.contains(logicalName)) {\n+                    selectableCaptureObjects.put(positionInDataObjectsList,\n+                            new CaptureObjectDefinitionDto(cosemObjectDefinitionDto.getClassId(),\n+                                    new ObisCodeValuesDto(logicalName),\n+                                    (byte) cosemObjectDefinitionDto.getAttributeIndex(),\n+                                    cosemObjectDefinitionDto.getDataIndex()));\n                 }\n+                positionInDataObjectsList++;\n+            }\n+        }\n+\n+        return selectableCaptureObjects;\n+    }\n+\n+    private List<ScalerUnitInfo> createScalerUnitInfos(final DlmsConnectionManager conn, final DlmsDevice device,\n+            final List<GetResult> captureObjects) throws ProtocolAdapterException {\n+\n+        List<ScalerUnitInfo> scalerUnitInfos = new ArrayList<>();\n+\n+        // there is always only one GetResult\n+        for (final GetResult captureObjectResult : captureObjects) {\n+\n+            final List<DataObject> dataObjects = captureObjectResult.getResultData().getValue();", "originalCommit": "1503318282f244ac9a63445f6805a5a861a21eee", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDExMjExMA==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/248#discussion_r400112110", "bodyText": "I tried with data en without getting data from the meter. so I think we are good. I do understand your point", "author": "coendamen", "createdAt": "2020-03-30T11:16:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDEwMzkzNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDExMDc2MA==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/248#discussion_r400110760", "bodyText": "These look like enums; consider defining them as such.", "author": "jandik", "createdAt": "2020-03-30T11:13:23Z", "path": "osgp/protocol-adapter-dlms/osgp-protocol-adapter-dlms/src/main/java/org/opensmartgridplatform/adapter/protocol/dlms/domain/commands/monitoring/AbstractGetPowerQualityProfileHandler.java", "diffHunk": "@@ -463,39 +439,105 @@ private ProfileEntryValueDto makeNumericProfileEntryValueDto(final DataObject da\n             }\n         } catch (final ProtocolAdapterException e) {\n             LOGGER.error(\"Error creating ProfileEntryDto from {}\", dataObject, e);\n-            final String dbgInfo = this.dlmsHelper.getDebugInfo(dataObject);\n-            return new ProfileEntryValueDto(dbgInfo);\n+            final String debugInfo = this.dlmsHelper.getDebugInfo(dataObject);\n+            return new ProfileEntryValueDto(debugInfo);\n         }\n     }\n \n-    private List<ScalerUnitInfo> retrieveScalerUnits(final DlmsConnectionManager conn, final DlmsDevice device,\n-            final List<GetResult> captureObjects) throws ProtocolAdapterException {\n+    private Map<Integer, CaptureObjectDefinitionDto> createSelectableCaptureObjects(\n+            final List<GetResult> captureObjects, List<String> logicalNames) throws ProtocolAdapterException {\n \n-        final List<ScalerUnitInfo> result = new ArrayList<>();\n+        Map<Integer, CaptureObjectDefinitionDto> selectableCaptureObjects = new HashMap<>();\n \n+        // there is always only one GetResult\n         for (final GetResult captureObjectResult : captureObjects) {\n-            final DataObject dataObject = captureObjectResult.getResultData();\n-            final List<DataObject> dataObjectList1 = dataObject.getValue();\n-            for (final DataObject captureObjectDataObject : dataObjectList1) {\n+\n+            final List<DataObject> dataObjects = captureObjectResult.getResultData().getValue();\n+            int positionInDataObjectsList = 0;\n+\n+            for (DataObject dataObject : dataObjects) {\n \n                 final CosemObjectDefinitionDto cosemObjectDefinitionDto = this.dlmsHelper\n-                        .readObjectDefinition(captureObjectDataObject, CAPTURE_OBJECT);\n-                final int classId = cosemObjectDefinitionDto.getClassId();\n+                        .readObjectDefinition(dataObject, CAPTURE_OBJECT);\n+\n                 final String logicalName = cosemObjectDefinitionDto.getLogicalName().toString();\n-                if (this.hasScalerUnit(classId)) {\n-                    final AttributeAddress addr = new AttributeAddress(classId, logicalName,\n-                            SCALER_UNITS_MAP.get(classId));\n-                    final List<GetResult> scalerUnitResult = this.dlmsHelper\n-                            .getAndCheck(conn, device, \"retrieve scaler unit for capture object\", addr);\n-                    final DataObject scalerUnitDataObject = scalerUnitResult.get(0).getResultData();\n-                    result.add(new ScalerUnitInfo(logicalName, classId, scalerUnitDataObject));\n-                } else {\n-                    result.add(new ScalerUnitInfo(logicalName, classId, null));\n+\n+                if (logicalNames.contains(logicalName)) {\n+                    selectableCaptureObjects.put(positionInDataObjectsList,\n+                            new CaptureObjectDefinitionDto(cosemObjectDefinitionDto.getClassId(),\n+                                    new ObisCodeValuesDto(logicalName),\n+                                    (byte) cosemObjectDefinitionDto.getAttributeIndex(),\n+                                    cosemObjectDefinitionDto.getDataIndex()));\n                 }\n+                positionInDataObjectsList++;\n+            }\n+        }\n+\n+        return selectableCaptureObjects;\n+    }\n+\n+    private List<ScalerUnitInfo> createScalerUnitInfos(final DlmsConnectionManager conn, final DlmsDevice device,\n+            final List<GetResult> captureObjects) throws ProtocolAdapterException {\n+\n+        List<ScalerUnitInfo> scalerUnitInfos = new ArrayList<>();\n+\n+        // there is always only one GetResult\n+        for (final GetResult captureObjectResult : captureObjects) {\n+\n+            final List<DataObject> dataObjects = captureObjectResult.getResultData().getValue();\n+\n+            for (DataObject dataObject : dataObjects) {\n+                scalerUnitInfos.add(createScalerUnitInfo(conn, device, dataObject));\n             }\n         }\n \n-        return result;\n+        return scalerUnitInfos;\n+    }\n+\n+    private ScalerUnitInfo createScalerUnitInfo(final DlmsConnectionManager conn, final DlmsDevice device,\n+            final DataObject dataObject) throws ProtocolAdapterException {\n+\n+        final CosemObjectDefinitionDto cosemObjectDefinitionDto = this.dlmsHelper\n+                .readObjectDefinition(dataObject, CAPTURE_OBJECT);\n+\n+        final int classId = cosemObjectDefinitionDto.getClassId();\n+        final String logicalName = cosemObjectDefinitionDto.getLogicalName().toString();\n+\n+        if (this.hasScalerUnit(classId)) {\n+            final AttributeAddress addr = new AttributeAddress(classId, logicalName, SCALER_UNITS_MAP.get(classId));\n+            final List<GetResult> scalerUnitResult = this.dlmsHelper\n+                    .getAndCheck(conn, device, \"retrieve scaler unit for capture object\", addr);\n+            final DataObject scalerUnitDataObject = scalerUnitResult.get(0).getResultData();\n+            return new ScalerUnitInfo(logicalName, classId, scalerUnitDataObject);\n+        } else {\n+            return new ScalerUnitInfo(logicalName, classId, null);\n+        }\n+    }\n+\n+    private static List<String> getLogicalNamesPublicDefinableLoadProfile() {\n+\n+        return Arrays.asList(OBIS_CODE_CLOCK, NR_VOLTAGE_SAGS_L1, NR_VOLTAGE_SAGS_L2, NR_VOLTAGE_SAGS_L3,", "originalCommit": "1503318282f244ac9a63445f6805a5a861a21eee", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDExOTc0NA==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/248#discussion_r400119744", "bodyText": "you are right, how lazy of me :-)", "author": "coendamen", "createdAt": "2020-03-30T11:30:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDExMDc2MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDEyMzQ0OA==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/248#discussion_r400123448", "bodyText": "It seems to me this is a wrong modification: scalar sounds perfectly fine. Rename the class to ScalarUnitInfo?", "author": "jandik", "createdAt": "2020-03-30T11:37:53Z", "path": "osgp/protocol-adapter-dlms/osgp-protocol-adapter-dlms/src/main/java/org/opensmartgridplatform/adapter/protocol/dlms/domain/commands/utils/ScalerUnitInfo.java", "diffHunk": "@@ -16,11 +16,11 @@\n     private final int classId;\n     private final DataObject scalerUnit;\n \n-    public ScalerUnitInfo(final String logicalName, final int classId, final DataObject scalarUnit) {\n+    public ScalerUnitInfo(final String logicalName, final int classId, final DataObject scalerUnit) {", "originalCommit": "1503318282f244ac9a63445f6805a5a861a21eee", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDEyNzIxNA==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/248#discussion_r400127214", "bodyText": "yes, I had exactly the same idea, so I changed everything to SCALAR, only to find out that in the openmuc lib, the word SCALER is used... so I changed it all back again....", "author": "coendamen", "createdAt": "2020-03-30T11:44:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDEyMzQ0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDEyODI0NQ==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/248#discussion_r400128245", "bodyText": "RegisterAttribute.SCALER_UNIT.attributeId());", "author": "coendamen", "createdAt": "2020-03-30T11:46:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDEyMzQ0OA=="}], "type": "inlineReview"}, {"oid": "95eca23ea43b21540e464f89ad87118cea9250f9", "url": "https://github.com/OSGP/open-smart-grid-platform/commit/95eca23ea43b21540e464f89ad87118cea9250f9", "message": "SLIM-2326 process review comments", "committedDate": "2020-03-30T11:47:47Z", "type": "commit"}, {"oid": "d86648a1b2521996dae45c2300ade1bbbe9dd575", "url": "https://github.com/OSGP/open-smart-grid-platform/commit/d86648a1b2521996dae45c2300ade1bbbe9dd575", "message": "Merge branch 'development' of https://github.com/OSGP/open-smart-grid-platform into SLIM-2326/add_generic_filtering_of_pq_data", "committedDate": "2020-03-30T11:49:53Z", "type": "commit"}, {"oid": "20ef48d7230775968bb54ec216f19a4462cb0edd", "url": "https://github.com/OSGP/open-smart-grid-platform/commit/20ef48d7230775968bb54ec216f19a4462cb0edd", "message": "SLIM-2326 process review comments", "committedDate": "2020-03-30T13:47:03Z", "type": "commit"}]}