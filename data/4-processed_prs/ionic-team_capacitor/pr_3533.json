{"pr_number": 3533, "pr_title": "refactor(cli): config refactor", "pr_createdAt": "2020-09-10T01:56:10Z", "pr_url": "https://github.com/ionic-team/capacitor/pull/3533", "timeline": [{"oid": "8c3d3e0965e7d84ee1829338c180a801233e43ff", "url": "https://github.com/ionic-team/capacitor/commit/8c3d3e0965e7d84ee1829338c180a801233e43ff", "message": "strip params from check functions", "committedDate": "2020-09-09T22:50:21Z", "type": "commit"}, {"oid": "2762d7fb5303665f1799e83b6cc8eee04839bfec", "url": "https://github.com/ionic-team/capacitor/commit/2762d7fb5303665f1799e83b6cc8eee04839bfec", "message": "resolveNode doesn't need config", "committedDate": "2020-09-09T23:19:29Z", "type": "commit"}, {"oid": "ca1510d5397d59810d67564688565b906801decf", "url": "https://github.com/ionic-team/capacitor/commit/ca1510d5397d59810d67564688565b906801decf", "message": "remove public config methods and unused properties", "committedDate": "2020-09-10T00:32:43Z", "type": "commit"}, {"oid": "172f594ad35af59716ffaede3991323527596abe", "url": "https://github.com/ionic-team/capacitor/commit/172f594ad35af59716ffaede3991323527596abe", "message": "config refactor", "committedDate": "2020-09-10T01:26:59Z", "type": "commit"}, {"oid": "5381669fcec5ab87cc3106f6f8b125fa9c73919e", "url": "https://github.com/ionic-team/capacitor/commit/5381669fcec5ab87cc3106f6f8b125fa9c73919e", "message": "readonly", "committedDate": "2020-09-10T01:41:23Z", "type": "commit"}, {"oid": "8665579235e43bd4ba0cacaf8a58fc3d140fe1fd", "url": "https://github.com/ionic-team/capacitor/commit/8665579235e43bd4ba0cacaf8a58fc3d140fe1fd", "message": "bug fixes", "committedDate": "2020-09-10T01:52:17Z", "type": "commit"}, {"oid": "b2c4f92a58850736d4c74ddfe789da02ce805fb6", "url": "https://github.com/ionic-team/capacitor/commit/b2c4f92a58850736d4c74ddfe789da02ce805fb6", "message": "fix tests", "committedDate": "2020-09-10T02:11:27Z", "type": "commit"}, {"oid": "5b0f13af57b7ddd9d5347cf46edd88bd29525b4f", "url": "https://github.com/ionic-team/capacitor/commit/5b0f13af57b7ddd9d5347cf46edd88bd29525b4f", "message": "be more clear about resolving package.json", "committedDate": "2020-09-10T16:10:54Z", "type": "commit"}, {"oid": "ff836cba2144c86864e01e8ee87b36771653ea4b", "url": "https://github.com/ionic-team/capacitor/commit/ff836cba2144c86864e01e8ee87b36771653ea4b", "message": "Merge branch 'main' into config-refactor\n\nConflicts:\n\tcli/src/android/add.ts\n\tcli/src/android/common.ts\n\tcli/src/android/doctor.ts\n\tcli/src/android/open.ts\n\tcli/src/android/update.ts\n\tcli/src/common.ts\n\tcli/src/config.ts\n\tcli/src/cordova.ts\n\tcli/src/index.ts\n\tcli/src/ios/add.ts\n\tcli/src/ios/common.ts\n\tcli/src/ios/doctor.ts\n\tcli/src/ios/open.ts\n\tcli/src/ios/update.ts\n\tcli/src/plugin.ts\n\tcli/src/tasks/add.ts\n\tcli/src/tasks/copy.ts\n\tcli/src/tasks/create.ts\n\tcli/src/tasks/doctor.ts\n\tcli/src/tasks/init.ts\n\tcli/src/tasks/list.ts\n\tcli/src/tasks/new-plugin.ts\n\tcli/src/tasks/open.ts\n\tcli/src/tasks/serve.ts\n\tcli/src/tasks/sync.ts\n\tcli/src/tasks/update.ts\n\tcli/src/web/copy.ts\n\tcli/test/util.ts", "committedDate": "2020-09-14T22:07:18Z", "type": "commit"}, {"oid": "a9ee8be99c0d0e2bb19030da505b438573f79fd9", "url": "https://github.com/ionic-team/capacitor/commit/a9ee8be99c0d0e2bb19030da505b438573f79fd9", "message": "Merge branch 'main' into config-refactor", "committedDate": "2020-09-16T00:14:51Z", "type": "commit"}, {"oid": "16ce02cae9808249907030745c9aefc740db34ec", "url": "https://github.com/ionic-team/capacitor/commit/16ce02cae9808249907030745c9aefc740db34ec", "message": "Merge branch 'main' into config-refactor", "committedDate": "2020-09-17T21:46:06Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDg3NDg2OA==", "url": "https://github.com/ionic-team/capacitor/pull/3533#discussion_r490874868", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                cordovaSwiftVersion: '5.0',\n          \n          \n            \n                cordovaSwiftVersion: '5.1',\n          \n      \n    \n    \n  \n\nWe updated the Capacitor version to 5.1, so this one should be probably updated too", "author": "jcesarmobile", "createdAt": "2020-09-18T11:11:30Z", "path": "cli/src/config.ts", "diffHunk": "@@ -1,354 +1,156 @@\n-/* eslint-disable */\n-import { accessSync, readFileSync } from 'fs';\n-import { basename, join, resolve } from 'path';\n-import prompts from 'prompts';\n-\n-import c from './colors';\n-import { logFatal, readJSON } from './common';\n-import { CliConfig, ExternalConfig, OS, PackageJson } from './definitions';\n+import { readJSON } from 'fs-extra';\n+import { dirname, join, resolve } from 'path';\n+\n+import type {\n+  Config,\n+  ExternalConfig,\n+  CLIConfig,\n+  AndroidConfig,\n+  IOSConfig,\n+  PackageJson,\n+} from './definitions';\n+import { OS } from './definitions';\n+\n+export const EXTERNAL_CONFIG_FILE = 'capacitor.config.json';\n+\n+export async function loadConfig(): Promise<Config> {\n+  const appRootDir = process.cwd();\n+  const cliRootDir = dirname(__dirname);\n+  const extConfig = await loadExternalConfig(\n+    resolve(appRootDir, EXTERNAL_CONFIG_FILE),\n+  );\n+\n+  const appId = extConfig.appId ?? '';\n+  const appName = extConfig.appName ?? '';\n+  const webDir = extConfig.webDir ?? 'www';\n+  const cli = await loadCLIConfig(cliRootDir);\n+\n+  return {\n+    windows: {\n+      androidStudioPath:\n+        'C:\\\\Program Files\\\\Android\\\\Android Studio\\\\bin\\\\studio64.exe',\n+    },\n+    linux: {\n+      androidStudioPath: '/usr/local/android-studio/bin/studio.sh',\n+    },\n+    android: await loadAndroidConfig(appRootDir, cli.assetsDir),\n+    ios: await loadIOSConfig(appRootDir, cli.assetsDir),\n+    web: {\n+      name: 'web',\n+    },\n+    cli,\n+    app: {\n+      rootDir: appRootDir,\n+      appId,\n+      appName,\n+      webDir,\n+      webDirAbs: resolve(appRootDir, webDir),\n+      package: (await readPackageJSON(resolve(appRootDir, 'package.json'))) ?? {\n+        name: appName,\n+        version: '1.0.0',\n+      },\n+      extConfigName: EXTERNAL_CONFIG_FILE,\n+      extConfigFilePath: resolve(appRootDir, EXTERNAL_CONFIG_FILE),\n+      extConfig,\n+      bundledWebRuntime: extConfig.bundledWebRuntime ?? false,\n+    },\n+  };\n+}\n \n-let Package: PackageJson;\n-let ExtConfig: ExternalConfig;\n+async function loadCLIConfig(rootDir: string): Promise<CLIConfig> {\n+  const assetsName = 'assets';\n \n-export class Config implements CliConfig {\n-  windows = {\n-    androidStudioPath:\n-      'C:\\\\Program Files\\\\Android\\\\Android Studio\\\\bin\\\\studio64.exe',\n+  return {\n+    rootDir,\n+    assetsName,\n+    assetsDir: join(rootDir, assetsName),\n+    package: await readJSON(resolve(rootDir, 'package.json')),\n+    os: determineOS(process.platform),\n   };\n+}\n \n-  linux = {\n-    androidStudioPath: '/usr/local/android-studio/bin/studio.sh',\n-  };\n+async function loadAndroidConfig(\n+  rootDir: string,\n+  assetDir: string,\n+): Promise<AndroidConfig> {\n+  const name = 'android';\n+  const platformDir = resolve(rootDir, name);\n+  const webDir = 'app/src/main/assets/public';\n+  const resDir = 'app/src/main/res';\n+\n+  const templateName = 'android-template';\n+  const pluginsFolderName = 'capacitor-cordova-android-plugins';\n \n-  android = {\n-    name: 'android',\n+  return {\n+    name,\n     minVersion: '21',\n-    platformDir: '',\n-    webDir: 'app/src/main/assets/public',\n-    webDirAbs: '',\n-    resDir: 'app/src/main/res',\n-    resDirAbs: '',\n+    platformDir,\n+    webDir,\n+    webDirAbs: resolve(platformDir, webDir),\n+    resDir,\n+    resDirAbs: resolve(platformDir, resDir),\n     assets: {\n-      templateName: 'android-template',\n-      pluginsFolderName: 'capacitor-cordova-android-plugins',\n-      templateDir: '',\n-      pluginsDir: '',\n+      templateName,\n+      pluginsFolderName,\n+      templateDir: resolve(assetDir, templateName),\n+      pluginsDir: resolve(assetDir, pluginsFolderName),\n     },\n   };\n+}\n \n-  ios = {\n-    name: 'ios',\n+async function loadIOSConfig(\n+  rootDir: string,\n+  assetDir: string,\n+): Promise<IOSConfig> {\n+  const name = 'ios';\n+  const platformDir = resolve(rootDir, name);\n+  const webDir = 'public';\n+  const nativeProjectName = 'App';\n+  const templateName = 'ios-template';\n+  const pluginsFolderName = 'capacitor-cordova-ios-plugins';\n+\n+  return {\n+    name,\n     minVersion: '11.0',\n     cordovaSwiftVersion: '5.0',", "originalCommit": "16ce02cae9808249907030745c9aefc740db34ec", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "151a41f3b06e32c969fe5f54b48426f2432edad9", "url": "https://github.com/ionic-team/capacitor/commit/151a41f3b06e32c969fe5f54b48426f2432edad9", "message": "Update cli/src/config.ts\n\nCo-authored-by: jcesarmobile <jcesarmobile@gmail.com>", "committedDate": "2020-09-18T16:40:29Z", "type": "commit"}, {"oid": "be4e89d5a07bb530de54878a893ffaf403d73636", "url": "https://github.com/ionic-team/capacitor/commit/be4e89d5a07bb530de54878a893ffaf403d73636", "message": "show plugin config last when adding it", "committedDate": "2020-09-18T17:25:08Z", "type": "commit"}, {"oid": "8cf2ac8f3e6b48cb6682e4770860a45e4478c089", "url": "https://github.com/ionic-team/capacitor/commit/8cf2ac8f3e6b48cb6682e4770860a45e4478c089", "message": "Merge branch 'main' into config-refactor", "committedDate": "2020-09-18T17:27:57Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjAwMjU0Mw==", "url": "https://github.com/ionic-team/capacitor/pull/3533#discussion_r492002543", "bodyText": "It's still showing the plugins first because on first execution oldConfig is empty and just adds the plugin entry to it\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  ...oldConfig,\n          \n          \n            \n                  ...extConfig,\n          \n          \n            \n                  ...extConfig,\n          \n          \n            \n                  ...oldConfig,", "author": "jcesarmobile", "createdAt": "2020-09-21T12:26:27Z", "path": "cli/src/common.ts", "diffHunk": "@@ -222,47 +206,28 @@ export function buildXmlElement(configElement: any, rootName: string): string {\n   return builder.buildObject(configElement);\n }\n \n-/**\n- * Check for or create our main configuration file.\n- * @param config\n- */\n-export async function getOrCreateConfig(\n+export async function mergeConfig(\n   config: Config,\n-): Promise<string | undefined> {\n-  const configPath = join(config.app.rootDir, config.app.extConfigName);\n-  if (await existsAsync(configPath)) {\n-    return configPath;\n-  }\n+  extConfig: ExternalConfig,\n+): Promise<void> {\n+  const oldConfig = { ...config.app.extConfig };\n \n-  await writePrettyJSON(config.app.extConfigFilePath, {\n-    appId: config.app.appId,\n-    appName: config.app.appName,\n-    bundledWebRuntime: config.app.bundledWebRuntime,\n-    webDir: basename(resolve(config.app.rootDir, config.app.webDir)),\n-    plugins: {\n+  if (!oldConfig.plugins) {\n+    oldConfig.plugins = {\n       SplashScreen: {\n         launchShowDuration: 0,\n       },\n-    },\n-  });\n-\n-  // Store our newly created or found external config as the default\n-  config.loadExternalConfig();\n-}\n-\n-export async function mergeConfig(\n-  config: Config,\n-  settings: any,\n-): Promise<void> {\n-  const configPath = join(config.app.rootDir, config.app.extConfigName);\n-\n-  await writePrettyJSON(config.app.extConfigFilePath, {\n-    ...config.app.extConfig,\n-    ...settings,\n-  });\n+    };\n+  }\n \n-  // Store our newly created or found external config as the default\n-  config.loadExternalConfig();\n+  await writeJSON(\n+    config.app.extConfigFilePath,\n+    {\n+      ...oldConfig,\n+      ...extConfig,", "originalCommit": "8cf2ac8f3e6b48cb6682e4770860a45e4478c089", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjI2MzM3OA==", "url": "https://github.com/ionic-team/capacitor/pull/3533#discussion_r492263378", "bodyText": "Unfortunately we want extConfig to overwrite keys on oldConfig, so this suggestion won't work", "author": "imhoffd", "createdAt": "2020-09-21T18:29:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjAwMjU0Mw=="}], "type": "inlineReview"}, {"oid": "74b85beb2c1d207cf6e784aa56cdf7f82ed7e85a", "url": "https://github.com/ionic-team/capacitor/commit/74b85beb2c1d207cf6e784aa56cdf7f82ed7e85a", "message": "write plugin last (attempt 2 \ud83d\ude02)", "committedDate": "2020-09-21T18:34:30Z", "type": "commit"}]}