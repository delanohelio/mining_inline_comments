{"pr_number": 3160, "pr_title": "fix(iOS): Making permissions switch statements exhaustive & supporting new iOS 14 cases", "pr_createdAt": "2020-06-25T17:20:57Z", "pr_url": "https://github.com/ionic-team/capacitor/pull/3160", "timeline": [{"oid": "2f14c57a000787539ec705d3b402a7475b7925c5", "url": "https://github.com/ionic-team/capacitor/commit/2f14c57a000787539ec705d3b402a7475b7925c5", "message": "Cleaned up permissions enum handling. Added unknown default handlers and new iOS 14 enum cases.", "committedDate": "2020-06-25T17:12:51Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTcxOTY0Mw==", "url": "https://github.com/ionic-team/capacitor/pull/3160#discussion_r445719643", "bodyText": "In addition to the new case, authorizationStatus() is being deprecated in favor of authorizationStatus(for:). The implications of .limited aren't fully clear to me yet so I'm adding this warning to be sure that it gets revisited before the beta period is over since it might require changes across more of Capacitor. But this addresses the immediate problem of compiles breaking with Xcode 12 until that time.", "author": "ikeith", "createdAt": "2020-06-25T17:25:41Z", "path": "ios/Capacitor/Capacitor/Plugins/Permissions.swift", "diffHunk": "@@ -52,16 +54,25 @@ public class CAPPermissionsPlugin: CAPPlugin {\n \n   func checkPhotos(_ call: CAPPluginCall) {\n     let photoAuthorizationStatus = PHPhotoLibrary.authorizationStatus()\n-\n-    var ret = \"prompt\"\n+    \n+    let ret: String\n     switch (photoAuthorizationStatus) {\n-      case .notDetermined:\n-        ret = \"prompt\"\n-      case .denied, .restricted:\n-        ret = \"denied\"\n-      case .authorized:\n-        ret = \"granted\"\n+    case .denied, .restricted:\n+      ret = \"denied\"\n+    case .authorized:\n+      ret = \"granted\"\n+    #if swift(>=5.3)\n+    case .limited:\n+      // TODO: address this new case properly\n+      #warning(\".limited != .authorized, authorization status should be revisted for iOS 14\")", "originalCommit": "2f14c57a000787539ec705d3b402a7475b7925c5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "7479349eccb46637e644c61afb1a644953e19d4b", "url": "https://github.com/ionic-team/capacitor/commit/7479349eccb46637e644c61afb1a644953e19d4b", "message": "Missed a type declaration", "committedDate": "2020-06-25T19:58:50Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTgwNTMwMw==", "url": "https://github.com/ionic-team/capacitor/pull/3160#discussion_r445805303", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  #warning(\".limited != .authorized, authorization status should be revisted for iOS 14\")\n          \n          \n            \n                  #warning(\".limited != .authorized, authorization status should be revisited for iOS 14\")", "author": "imhoffd", "createdAt": "2020-06-25T20:00:29Z", "path": "ios/Capacitor/Capacitor/Plugins/Permissions.swift", "diffHunk": "@@ -52,31 +54,42 @@ public class CAPPermissionsPlugin: CAPPlugin {\n \n   func checkPhotos(_ call: CAPPluginCall) {\n     let photoAuthorizationStatus = PHPhotoLibrary.authorizationStatus()\n-\n-    var ret = \"prompt\"\n+    \n+    let ret: String\n     switch (photoAuthorizationStatus) {\n-      case .notDetermined:\n-        ret = \"prompt\"\n-      case .denied, .restricted:\n-        ret = \"denied\"\n-      case .authorized:\n-        ret = \"granted\"\n+    case .denied, .restricted:\n+      ret = \"denied\"\n+    case .authorized:\n+      ret = \"granted\"\n+    #if swift(>=5.3)\n+    case .limited:\n+      // TODO: address this new case properly\n+      #warning(\".limited != .authorized, authorization status should be revisted for iOS 14\")", "originalCommit": "7479349eccb46637e644c61afb1a644953e19d4b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "78fc230ed01a447ce5b5b7396574fff6dceca26d", "url": "https://github.com/ionic-team/capacitor/commit/78fc230ed01a447ce5b5b7396574fff6dceca26d", "message": "Update ios/Capacitor/Capacitor/Plugins/Permissions.swift\n\nCo-authored-by: Dan Imhoff <dwieeb@gmail.com>", "committedDate": "2020-06-25T20:27:31Z", "type": "commit"}, {"oid": "ac4bea895ae154931af4d7be32695f2bada6621a", "url": "https://github.com/ionic-team/capacitor/commit/ac4bea895ae154931af4d7be32695f2bada6621a", "message": "Changing @unknown default to be a failure case.", "committedDate": "2020-06-30T14:42:38Z", "type": "commit"}, {"oid": "56ffb24f8434d94c3a5965f23e6b1410116e8895", "url": "https://github.com/ionic-team/capacitor/commit/56ffb24f8434d94c3a5965f23e6b1410116e8895", "message": "Merge branch 'permission-enums' of github.com:ionic-team/capacitor into permission-enums", "committedDate": "2020-06-30T14:42:44Z", "type": "commit"}, {"oid": "08310b9c334879b96c58c2f913ad707e8ee02f8f", "url": "https://github.com/ionic-team/capacitor/commit/08310b9c334879b96c58c2f913ad707e8ee02f8f", "message": "Merge branch 'master' into permission-enums", "committedDate": "2020-06-30T14:43:09Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODE5ODg5NQ==", "url": "https://github.com/ionic-team/capacitor/pull/3160#discussion_r448198895", "bodyText": "The new enum cases are not bound to Swift 5.3. They are added in iOS 14 and the availability check should check for os version instead.", "author": "MortenGregersen", "createdAt": "2020-07-01T08:22:16Z", "path": "ios/Capacitor/Capacitor/Plugins/Permissions.swift", "diffHunk": "@@ -52,31 +56,44 @@ public class CAPPermissionsPlugin: CAPPlugin {\n \n   func checkPhotos(_ call: CAPPluginCall) {\n     let photoAuthorizationStatus = PHPhotoLibrary.authorizationStatus()\n-\n-    var ret = \"prompt\"\n+    \n+    let ret: String\n     switch (photoAuthorizationStatus) {\n-      case .notDetermined:\n-        ret = \"prompt\"\n-      case .denied, .restricted:\n-        ret = \"denied\"\n-      case .authorized:\n-        ret = \"granted\"\n+    case .denied, .restricted:\n+      ret = \"denied\"\n+    case .authorized:\n+      ret = \"granted\"\n+    #if swift(>=5.3)", "originalCommit": "08310b9c334879b96c58c2f913ad707e8ee02f8f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODI3MzgyMA==", "url": "https://github.com/ionic-team/capacitor/pull/3160#discussion_r448273820", "bodyText": "As far as I know, they are only available on iOS 14 if you use SDK 14 to compile (Xcode 12), if you use SDK 13 (Xcode 11) then they won't be available because it works in a sort of \"compatibility mode\".\nThe #if swift(>=5.3) is only true on Xcode 12, it's false in Xcode 11 because it ships with swift 5.1 to 5.2.4.\nI agree that using if #available(iOS 14, *) would be more clear, but sadly, it can't be used inside the switch.\nMaybe is less confusing if we use #if compiler(>=5.3) instead of #if swift(>=5.3)?", "author": "jcesarmobile", "createdAt": "2020-07-01T10:36:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODE5ODg5NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODM4MDYyOQ==", "url": "https://github.com/ionic-team/capacitor/pull/3160#discussion_r448380629", "bodyText": "Yes, it is true that language version is not synonymous with the SDK version but in practice it's not an issue. The only way it would be a problem is if you downloaded a newer version of the Swift compiler and replaced the toolchain in Xcode 11. If you did that, you should know what you're doing and can expect side effects in many places.\nNot only is #available invalid inside a switch statement (so we'd need to have duplicated switches to use it), it doesn't actually solve our problem because that's a hook to insert a runtime check, meaning the new enum case would fail to compile under Xcode 11. There is no compiler flag that I'm aware of to strip code based on the SDK or OS version being targeted.\nAt this time, we need to be able to build cleanly with Xcode 11 and 12. Ultimately, this is only temporary for some months until 12 becomes the default.", "author": "ikeith", "createdAt": "2020-07-01T13:55:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODE5ODg5NQ=="}], "type": "inlineReview"}, {"oid": "4e1bd25791d5dfd60eefd196090e990284beddb8", "url": "https://github.com/ionic-team/capacitor/commit/4e1bd25791d5dfd60eefd196090e990284beddb8", "message": "Merge branch 'master' into permission-enums", "committedDate": "2020-07-01T10:40:46Z", "type": "commit"}]}