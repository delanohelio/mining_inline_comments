{"pr_number": 3091, "pr_title": "feat(cli): Allow to use capacitor commands in custom platforms", "pr_createdAt": "2020-06-11T14:41:22Z", "pr_url": "https://github.com/ionic-team/capacitor/pull/3091", "timeline": [{"oid": "09e5c54321d6f68deabb0481627c59d7469ac672", "url": "https://github.com/ionic-team/capacitor/commit/09e5c54321d6f68deabb0481627c59d7469ac672", "message": "feat(cli): Allow to use capacitor commands in custom platforms", "committedDate": "2020-06-11T14:25:04Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTExOTAwNw==", "url": "https://github.com/ionic-team/capacitor/pull/3091#discussion_r441119007", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  const result = await runCommand(`cd \"${platformFolder}\" && ${await hasYarn(config) ? 'yarn' : 'npm'} run copy`);\n          \n          \n            \n                  const result = await runCommand(`cd \"${platformFolder}\" && ${await hasYarn(config) ? 'yarn' : 'npm'} run capacitor:copy`);", "author": "imhoffd", "createdAt": "2020-06-16T20:22:32Z", "path": "cli/src/tasks/copy.ts", "diffHunk": "@@ -10,15 +10,25 @@ import { getCordovaPlugins, handleCordovaPluginsJS, writeCordovaAndroidManifest\n import chalk from 'chalk';\n \n export async function copyCommand(config: Config, selectedPlatformName: string) {\n-  const platforms = config.selectPlatforms(selectedPlatformName);\n-  if (platforms.length === 0) {\n-    logInfo(`There are no platforms to copy yet. Create one with \\`capacitor create\\`.`);\n-    return;\n-  }\n-  try {\n-    await allSerial(platforms.map(platformName => () => copy(config, platformName)));\n-  } catch (e) {\n-    logError(e);\n+  if (selectedPlatformName && !config.isValidPlatform(selectedPlatformName)) {\n+    const platformFolder = resolveNode(config, selectedPlatformName);\n+    if (platformFolder) {\n+      const result = await runCommand(`cd \"${platformFolder}\" && ${await hasYarn(config) ? 'yarn' : 'npm'} run copy`);", "originalCommit": "09e5c54321d6f68deabb0481627c59d7469ac672", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTExOTExMw==", "url": "https://github.com/ionic-team/capacitor/pull/3091#discussion_r441119113", "bodyText": "We should probably not do this. sync = copy + update, so we should just run npm run capacitor:copy followed by npm run capacitor:sync. What do you think?", "author": "imhoffd", "createdAt": "2020-06-16T20:22:46Z", "path": "cli/src/tasks/sync.ts", "diffHunk": "@@ -1,28 +1,38 @@\n import { Config } from '../config';\n import { copy } from './copy';\n import { update, updateChecks } from './update';\n-import { check, checkPackage, checkWebDir, log, logError, logFatal, logInfo } from '../common';\n+import { check, checkPackage, checkWebDir, hasYarn, log, logError, logFatal, logInfo, resolveNode, runCommand } from '../common';\n \n import { allSerial } from '../util/promise';\n \n /**\n  * Sync is a copy and an update in one.\n  */\n-export async function syncCommand(config: Config, selectedPlatform: string, deployment: boolean) {\n-  const then = +new Date;\n-  const platforms = config.selectPlatforms(selectedPlatform);\n-  if (platforms.length === 0) {\n-    logInfo(`There are no platforms to sync yet. Create one with \"capacitor create\".`);\n-    return;\n-  }\n-  try {\n-    await check(config, [checkPackage, checkWebDir, ...updateChecks(config, platforms)]);\n-    await allSerial(platforms.map(platformName => () => sync(config, platformName, deployment)));\n-    const now = +new Date;\n-    const diff = (now - then) / 1000;\n-    log(`Sync finished in ${diff}s`);\n-  } catch (e) \u00a0{\n-    logFatal(e);\n+export async function syncCommand(config: Config, selectedPlatformName: string, deployment: boolean) {\n+  if (selectedPlatformName && !config.isValidPlatform(selectedPlatformName)) {\n+    const platformFolder = resolveNode(config, selectedPlatformName);\n+    if (platformFolder) {\n+      const result = await runCommand(`cd \"${platformFolder}\" && ${await hasYarn(config) ? 'yarn' : 'npm'} run sync`);", "originalCommit": "09e5c54321d6f68deabb0481627c59d7469ac672", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTExOTYyMQ==", "url": "https://github.com/ionic-team/capacitor/pull/3091#discussion_r441119621", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  const result = await runCommand(`cd \"${platformFolder}\" && ${await hasYarn(config) ? 'yarn' : 'npm'} run update`);\n          \n          \n            \n                  const result = await runCommand(`cd \"${platformFolder}\" && ${await hasYarn(config) ? 'yarn' : 'npm'} run capacitor:update`);", "author": "imhoffd", "createdAt": "2020-06-16T20:23:49Z", "path": "cli/src/tasks/update.ts", "diffHunk": "@@ -2,29 +2,39 @@ import { Config } from '../config';\n import { updateAndroid } from '../android/update';\n import { updateIOS, updateIOSChecks } from '../ios/update';\n import { allSerial } from '../util/promise';\n-import { CheckFunction, check, checkPackage, log, logError, logFatal, logInfo, runTask } from '../common';\n+import { CheckFunction, check, checkPackage, hasYarn, log, logError, logFatal, logInfo, resolveNode, runCommand, runTask } from '../common';\n \n import chalk from 'chalk';\n \n export async function updateCommand(config: Config, selectedPlatformName: string, deployment: boolean) {\n-  const then = +new Date;\n-  const platforms = config.selectPlatforms(selectedPlatformName);\n-  if (platforms.length === 0) {\n-    logInfo(`There are no platforms to update yet. Create one with \"capacitor create\".`);\n-    return;\n-  }\n-  try {\n-    await check(\n-      config,\n-      [checkPackage, ...updateChecks(config, platforms)]\n-    );\n+  if (selectedPlatformName && !config.isValidPlatform(selectedPlatformName)) {\n+    const platformFolder = resolveNode(config, selectedPlatformName);\n+    if (platformFolder) {\n+      const result = await runCommand(`cd \"${platformFolder}\" && ${await hasYarn(config) ? 'yarn' : 'npm'} run update`);", "originalCommit": "09e5c54321d6f68deabb0481627c59d7469ac672", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "e3b03baff44c90e186d2f18fbd333ef83957e911", "url": "https://github.com/ionic-team/capacitor/commit/e3b03baff44c90e186d2f18fbd333ef83957e911", "message": "Merge branch 'master' into custom-platforms-poc", "committedDate": "2020-06-23T20:50:33Z", "type": "commit"}, {"oid": "338c9d71c9a2347fd92a416cc5fa011f619ac952", "url": "https://github.com/ionic-team/capacitor/commit/338c9d71c9a2347fd92a416cc5fa011f619ac952", "message": "Update cli/src/tasks/update.ts", "committedDate": "2020-06-23T20:52:34Z", "type": "commit"}, {"oid": "1435c88e13e9176e2c4dba7eb5f95d4f15243e01", "url": "https://github.com/ionic-team/capacitor/commit/1435c88e13e9176e2c4dba7eb5f95d4f15243e01", "message": "Update cli/src/tasks/copy.ts", "committedDate": "2020-06-23T20:52:40Z", "type": "commit"}, {"oid": "386709d8c30d9a5c3c23b74641bdb1b0d08b5653", "url": "https://github.com/ionic-team/capacitor/commit/386709d8c30d9a5c3c23b74641bdb1b0d08b5653", "message": "copy + update for sync", "committedDate": "2020-06-23T20:58:16Z", "type": "commit"}, {"oid": "2c9fe0a5e7a777f8dd23a5199d9352b42efdc9fd", "url": "https://github.com/ionic-team/capacitor/commit/2c9fe0a5e7a777f8dd23a5199d9352b42efdc9fd", "message": "lint fix", "committedDate": "2020-06-23T21:03:32Z", "type": "commit"}, {"oid": "8a3328b877d63356d636cfe3d257e8670b796fd7", "url": "https://github.com/ionic-team/capacitor/commit/8a3328b877d63356d636cfe3d257e8670b796fd7", "message": "get add working", "committedDate": "2020-06-23T21:09:39Z", "type": "commit"}, {"oid": "c841145815d3d04580b2f95fb6d7c63016bf084a", "url": "https://github.com/ionic-team/capacitor/commit/c841145815d3d04580b2f95fb6d7c63016bf084a", "message": "implement platform resolution\n\nref: https://github.com/ionic-team/capacitor/pull/3091#issuecomment-644997288", "committedDate": "2020-06-23T21:19:36Z", "type": "commit"}, {"oid": "4b1b38e8d2a4ed39708c8a8ff0d408cfcb1ef30d", "url": "https://github.com/ionic-team/capacitor/commit/4b1b38e8d2a4ed39708c8a8ff0d408cfcb1ef30d", "message": "Merge branch 'master' into custom-platforms-poc", "committedDate": "2020-06-26T18:21:12Z", "type": "commit"}, {"oid": "5089ebacf37d0c132e4aa6f6253177e2cf81d2fc", "url": "https://github.com/ionic-team/capacitor/commit/5089ebacf37d0c132e4aa6f6253177e2cf81d2fc", "message": "fix: support console output for platform hooks", "committedDate": "2020-06-26T19:13:07Z", "type": "commit"}, {"oid": "6fb7bca3aad0536a3f6245e172f6af70c0aeaf91", "url": "https://github.com/ionic-team/capacitor/commit/6fb7bca3aad0536a3f6245e172f6af70c0aeaf91", "message": "fix: create runPlatformHook func", "committedDate": "2020-06-26T19:36:37Z", "type": "commit"}, {"oid": "de53ac870fef34449aace48529b7ee425781fdc1", "url": "https://github.com/ionic-team/capacitor/commit/de53ac870fef34449aace48529b7ee425781fdc1", "message": "fix: missed comment removal", "committedDate": "2020-06-26T19:39:39Z", "type": "commit"}, {"oid": "04065b53c3d2f724658653d309600306bc649154", "url": "https://github.com/ionic-team/capacitor/commit/04065b53c3d2f724658653d309600306bc649154", "message": "chore: import reshuffle to alpha sort", "committedDate": "2020-06-26T19:42:58Z", "type": "commit"}, {"oid": "8349ad768b5b578394bcb682a28e5682a9e574dd", "url": "https://github.com/ionic-team/capacitor/commit/8349ad768b5b578394bcb682a28e5682a9e574dd", "message": "Merge pull request #1 from IT-MikeS/custom-platforms-poc\n\nfix: support console output for platform hooks", "committedDate": "2020-06-26T23:41:45Z", "type": "commit"}, {"oid": "565b218dce0ea89885be37e156a7cdf34f13d08e", "url": "https://github.com/ionic-team/capacitor/commit/565b218dce0ea89885be37e156a7cdf34f13d08e", "message": "open command for custom platforms", "committedDate": "2020-06-29T17:16:06Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzEzNDM3Ng==", "url": "https://github.com/ionic-team/capacitor/pull/3091#discussion_r447134376", "bodyText": "Shouldn't this be runPlatformHook instead?", "author": "IT-MikeS", "createdAt": "2020-06-29T17:27:18Z", "path": "cli/src/tasks/open.ts", "diffHunk": "@@ -1,26 +1,35 @@\n import { Config } from '../config';\n-import { logFatal, logInfo, runTask } from '../common';\n+import { hasYarn, log, logError, logFatal, logInfo, resolvePlatform, runCommand, runTask } from '../common';\n import { openAndroid } from '../android/open';\n import { openElectron } from '../electron/open';\n import { openIOS } from '../ios/open';\n \n-export async function openCommand(config: Config, selectedPlatform: string) {\n-  const platforms = config.selectPlatforms(selectedPlatform);\n-  let platformName: string;\n-  if (platforms.length === 0) {\n-    logInfo(`There are no platforms to open yet. Create one with \"capacitor add\".`);\n-    return;\n-  } else if (platforms.length === 1) {\n-    platformName = platforms[0];\n+export async function openCommand(config: Config, selectedPlatformName: string) {\n+  if (selectedPlatformName && !config.isValidPlatform(selectedPlatformName)) {\n+    const platformFolder = resolvePlatform(config, selectedPlatformName);\n+    if (platformFolder) {\n+      const result = await runCommand(`cd \"${platformFolder}\" && ${await hasYarn(config) ? 'yarn' : 'npm'} run capacitor:open`);", "originalCommit": "565b218dce0ea89885be37e156a7cdf34f13d08e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzE0MzQ0NA==", "url": "https://github.com/ionic-team/capacitor/pull/3091#discussion_r447143444", "bodyText": "Ah yeah, I forgot to merge before doing this. \ud83d\ude02", "author": "imhoffd", "createdAt": "2020-06-29T17:43:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzEzNDM3Ng=="}], "type": "inlineReview"}, {"oid": "5bf44a6711b0ec16929b912b6a2c5a137e2b2025", "url": "https://github.com/ionic-team/capacitor/commit/5bf44a6711b0ec16929b912b6a2c5a137e2b2025", "message": "use runPlatformHook", "committedDate": "2020-06-29T17:44:16Z", "type": "commit"}, {"oid": "0400160bbef76d4993ac3c9b466d554520038bd3", "url": "https://github.com/ionic-team/capacitor/commit/0400160bbef76d4993ac3c9b466d554520038bd3", "message": "oops", "committedDate": "2020-06-29T17:45:16Z", "type": "commit"}, {"oid": "cacf5af8ec78ae09ddf322afe61490eba34dfe11", "url": "https://github.com/ionic-team/capacitor/commit/cacf5af8ec78ae09ddf322afe61490eba34dfe11", "message": "Merge branch 'master' into custom-platforms-poc", "committedDate": "2020-06-29T18:25:32Z", "type": "commit"}, {"oid": "1ade8ed63fae0f0b1136c1f19d51f536d344c8e7", "url": "https://github.com/ionic-team/capacitor/commit/1ade8ed63fae0f0b1136c1f19d51f536d344c8e7", "message": "Merge branch 'master' into custom-platforms-poc", "committedDate": "2020-07-01T17:53:15Z", "type": "commit"}]}