{"pr_number": 3347, "pr_title": "GH-3340: IntegrationEvents  -add getSourceAsType()", "pr_createdAt": "2020-07-17T21:45:14Z", "pr_url": "https://github.com/spring-projects/spring-integration/pull/3347", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzU2MjY4Mw==", "url": "https://github.com/spring-projects/spring-integration/pull/3347#discussion_r457562683", "bodyText": "Yeah... I didn't mean to deprecate per-channel-adapter URL configuration.\nMy idea was just to deprecate a getUrl() since it not always reflect a connection reality.\nSince we have now that MqttConnectOptions getConnectionInfo() may be it is better to clone its instance and modify its serverURIs with the provided URL. So, we still can keep existing apps without respective modification for per-channel-adapter-client-factory.\nWDYT?", "author": "artembilan", "createdAt": "2020-07-20T17:07:15Z", "path": "spring-integration-mqtt/src/main/java/org/springframework/integration/mqtt/inbound/AbstractMqttMessageDrivenChannelAdapter.java", "diffHunk": "@@ -54,14 +55,35 @@\n \n \tprotected final Lock topicLock = new ReentrantLock(); // NOSONAR\n \n-\tpublic AbstractMqttMessageDrivenChannelAdapter(String url, String clientId, String... topic) {\n+\t/**\n+\t * Construct an instance with the provided properties.\n+\t * @param clientId the client id.\n+\t * @param topics the topics.\n+\t * @since 5.4.\n+\t */\n+\t@SuppressWarnings(\"deprecation\")\n+\tpublic AbstractMqttMessageDrivenChannelAdapter(String clientId, String... topics) {\n+\t\tthis(null, clientId, topics);\n+\t}\n+\n+\t/**\n+\t * Deprecated - do not use; implementations must maintain the url or other connection\n+\t * information.\n+\t * @deprecated in favor of\n+\t * {@link #AbstractMqttMessageDrivenChannelAdapter(String, String...)}.\n+\t * @param url the url.\n+\t * @param clientId the client id.\n+\t * @param topics the topics.\n+\t */\n+\t@Deprecated", "originalCommit": "8b76bc84ac660e8345828c5453be0d40968bea4f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzYwMjgzNA==", "url": "https://github.com/spring-projects/spring-integration/pull/3347#discussion_r457602834", "bodyText": "Good point - I hadn't thought of the shared factory.", "author": "garyrussell", "createdAt": "2020-07-20T18:17:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzU2MjY4Mw=="}], "type": "inlineReview"}, {"oid": "473ccc983cfdb1f4b35aa4da8d88b248499ecd35", "url": "https://github.com/spring-projects/spring-integration/commit/473ccc983cfdb1f4b35aa4da8d88b248499ecd35", "message": "GH-3340: IntegrationEvents  -add getSourceAsType()\n\nResolves https://github.com/spring-projects/spring-integration/issues/3340\n\n- add common super-interface for MQTT components\n- add `getConnectionInfo()` so users can examine server URIs etc", "committedDate": "2020-07-21T14:02:45Z", "type": "commit"}, {"oid": "69d0db064cd9e8f3c7389650fef6fa5d33a13340", "url": "https://github.com/spring-projects/spring-integration/commit/69d0db064cd9e8f3c7389650fef6fa5d33a13340", "message": "Reinstate per-adapter URIs - support multiple", "committedDate": "2020-07-21T14:02:45Z", "type": "commit"}, {"oid": "69d0db064cd9e8f3c7389650fef6fa5d33a13340", "url": "https://github.com/spring-projects/spring-integration/commit/69d0db064cd9e8f3c7389650fef6fa5d33a13340", "message": "Reinstate per-adapter URIs - support multiple", "committedDate": "2020-07-21T14:02:45Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODE4MjQ5NQ==", "url": "https://github.com/spring-projects/spring-integration/pull/3347#discussion_r458182495", "bodyText": "M-m-m. May be this delegate should be just \"read-only\"?\nAnd all the setters should throw UnsupportedOperationException instead of delegation?", "author": "artembilan", "createdAt": "2020-07-21T15:22:18Z", "path": "spring-integration-mqtt/src/main/java/org/springframework/integration/mqtt/core/DefaultMqttPahoClientFactory.java", "diffHunk": "@@ -95,9 +105,270 @@ public void setConnectionOptions(MqttConnectOptions options) {\n \n \t@Override\n \tpublic MqttConnectOptions getConnectionOptions() {\n-\t\treturn this.options;\n+\t\tif (this.serverUris == null) {\n+\t\t\treturn this.options;\n+\t\t}\n+\t\telse {\n+\t\t\treturn new ExtendedOptions();\n+\t\t}\n \t}\n \n+\t@Override\n+\tpublic void setServerUris(List<String> serverUris) {\n+\t\tthis.serverUris = serverUris;\n+\t}\n+\n+\tprivate class ExtendedOptions extends MqttConnectOptions {\n+\n+\t\t@Override\n+\t\tpublic char[] getPassword() {\n+\t\t\treturn DefaultMqttPahoClientFactory.this.options.getPassword();\n+\t\t}\n+\n+\t\t@Override\n+\t\tpublic void setPassword(char[] password) {\n+\t\t\tDefaultMqttPahoClientFactory.this.options.setPassword(password);", "originalCommit": "69d0db064cd9e8f3c7389650fef6fa5d33a13340", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODE4NjcwNg==", "url": "https://github.com/spring-projects/spring-integration/pull/3347#discussion_r458186706", "bodyText": "I wouldn't do this. It is mutation of an external shared factory.\nWhat drove you to drop that url-based configuration?\nI thought we just need to have a consistency on the read side...", "author": "artembilan", "createdAt": "2020-07-21T15:27:57Z", "path": "spring-integration-mqtt/src/main/java/org/springframework/integration/mqtt/inbound/MqttPahoMessageDrivenChannelAdapter.java", "diffHunk": "@@ -89,42 +94,91 @@\n \tprivate ApplicationEventPublisher applicationEventPublisher;\n \n \t/**\n-\t * Use this constructor for a single url (although it may be overridden\n-\t * if the server URI(s) are provided by the {@link MqttConnectOptions#getServerURIs()}\n-\t * provided by the {@link MqttPahoClientFactory}).\n+\t * Use this constructor for a single url (although it may be overridden if the server\n+\t * URI(s) are provided by the {@link MqttConnectOptions#getServerURIs()} provided by\n+\t * the {@link MqttPahoClientFactory}).\n+\t * @deprecated in favor of\n+\t * {@link #MqttPahoMessageDrivenChannelAdapter(List, String, MqttPahoClientFactory, String...)}\n+\t * - set the url in the client factory connection options.\n \t * @param url the URL.\n \t * @param clientId The client id.\n \t * @param clientFactory The client factory.\n \t * @param topic The topic(s).\n \t */\n+\t@Deprecated\n+\t@SuppressWarnings(\"deprecation\")\n \tpublic MqttPahoMessageDrivenChannelAdapter(String url, String clientId, MqttPahoClientFactory clientFactory,\n \t\t\tString... topic) {\n \t\tsuper(url, clientId, topic);\n \t\tthis.clientFactory = clientFactory;\n \t}\n \n \t/**\n-\t * Use this constructor if the server URI(s) are provided by the {@link MqttConnectOptions#getServerURIs()}\n-\t * provided by the {@link MqttPahoClientFactory}.\n+\t * Use this constructor with a list of server URIs, which will take precedence over\n+\t * the factory's connection options' server URIs.\n+\t * @param serverUris the server URIs.\n+\t * @param clientId The client id.\n+\t * @param clientFactory The client factory.\n+\t * @param topic The topic(s).\n+\t * @since 5.4\n+\t */\n+\tpublic MqttPahoMessageDrivenChannelAdapter(List<String> serverUris, String clientId,\n+\t\t\tMqttPahoClientFactory clientFactory, String... topic) {\n+\t\tsuper(clientId, topic);\n+\t\tthis.clientFactory = clientFactory;\n+\t\tthis.clientFactory.setServerUris(serverUris);", "originalCommit": "69d0db064cd9e8f3c7389650fef6fa5d33a13340", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODI0ODUzMw==", "url": "https://github.com/spring-projects/spring-integration/pull/3347#discussion_r458248533", "bodyText": "Oh, you're right - need to rethink.\nThe reason is if you want to connect to a cluster, the only way you can do it is via the connect options - here I am restoring the functionality, but enhanced to allow cluster per adapter with a single factory.", "author": "garyrussell", "createdAt": "2020-07-21T16:57:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODE4NjcwNg=="}], "type": "inlineReview"}, {"oid": "9f1153b761f2478f6e0dacbabd8b76f2485a7dc8", "url": "https://github.com/spring-projects/spring-integration/commit/9f1153b761f2478f6e0dacbabd8b76f2485a7dc8", "message": "Restore single URL per adapter.", "committedDate": "2020-07-21T17:46:50Z", "type": "commit"}, {"oid": "9f1153b761f2478f6e0dacbabd8b76f2485a7dc8", "url": "https://github.com/spring-projects/spring-integration/commit/9f1153b761f2478f6e0dacbabd8b76f2485a7dc8", "message": "Restore single URL per adapter.", "committedDate": "2020-07-21T17:46:50Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODI4NzYxMQ==", "url": "https://github.com/spring-projects/spring-integration/pull/3347#discussion_r458287611", "bodyText": "Better to extract local variable for URL to avoid noise from Sonar that we defer NPE calling the method several times.", "author": "artembilan", "createdAt": "2020-07-21T18:00:56Z", "path": "spring-integration-mqtt/src/main/java/org/springframework/integration/mqtt/inbound/MqttPahoMessageDrivenChannelAdapter.java", "diffHunk": "@@ -174,6 +183,16 @@ public void setApplicationEventPublisher(ApplicationEventPublisher applicationEv\n \t\tthis.applicationEventPublisher = applicationEventPublisher; // NOSONAR (inconsistent synchronization)\n \t}\n \n+\t@Override\n+\tpublic MqttConnectOptions getConnectionInfo() {\n+\t\tMqttConnectOptions options = this.clientFactory.getConnectionOptions();\n+\t\tif (options.getServerURIs() == null && getUrl() != null) {\n+\t\t\toptions = MqttUtils.cloneConnectOptions(options);\n+\t\t\toptions.setServerURIs(new String[] { getUrl() });", "originalCommit": "9f1153b761f2478f6e0dacbabd8b76f2485a7dc8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODI4Nzc2Mg==", "url": "https://github.com/spring-projects/spring-integration/pull/3347#discussion_r458287762", "bodyText": "I think there is no deprecations any more.", "author": "artembilan", "createdAt": "2020-07-21T18:01:10Z", "path": "spring-integration-mqtt/src/main/java/org/springframework/integration/mqtt/inbound/MqttPahoMessageDrivenChannelAdapter.java", "diffHunk": "@@ -258,6 +277,7 @@ public void removeTopic(String... topic) {\n \t\t}\n \t}\n \n+\t@SuppressWarnings(\"deprecation\")", "originalCommit": "9f1153b761f2478f6e0dacbabd8b76f2485a7dc8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODI4ODE5NA==", "url": "https://github.com/spring-projects/spring-integration/pull/3347#discussion_r458288194", "bodyText": "Looks like this one is out of use", "author": "artembilan", "createdAt": "2020-07-21T18:01:53Z", "path": "spring-integration-mqtt/src/main/java/org/springframework/integration/mqtt/inbound/MqttPahoMessageDrivenChannelAdapter.java", "diffHunk": "@@ -68,6 +72,8 @@\n \n \tprivate final MqttPahoClientFactory clientFactory;\n \n+\tprivate Supplier<List<String>> uriSupplier;", "originalCommit": "9f1153b761f2478f6e0dacbabd8b76f2485a7dc8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODI4ODQ4MQ==", "url": "https://github.com/spring-projects/spring-integration/pull/3347#discussion_r458288481", "bodyText": "I don't see deprecations any more", "author": "artembilan", "createdAt": "2020-07-21T18:02:22Z", "path": "spring-integration-mqtt/src/main/java/org/springframework/integration/mqtt/outbound/MqttPahoMessageHandler.java", "diffHunk": "@@ -92,13 +94,14 @@ public MqttPahoMessageHandler(String url, String clientId, MqttPahoClientFactory\n \t * @param clientFactory The client factory.\n \t * @since 4.1\n \t */\n+\t@SuppressWarnings(\"deprecation\")", "originalCommit": "9f1153b761f2478f6e0dacbabd8b76f2485a7dc8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODI4ODk0Mw==", "url": "https://github.com/spring-projects/spring-integration/pull/3347#discussion_r458288943", "bodyText": "Looks like duplication for this ifs", "author": "artembilan", "createdAt": "2020-07-21T18:03:12Z", "path": "spring-integration-mqtt/src/main/java/org/springframework/integration/mqtt/outbound/MqttPahoMessageHandler.java", "diffHunk": "@@ -154,6 +157,19 @@ public void setApplicationEventPublisher(ApplicationEventPublisher applicationEv\n \t\tthis.applicationEventPublisher = applicationEventPublisher;\n \t}\n \n+\t@Override\n+\tpublic MqttConnectOptions getConnectionInfo() {\n+\t\tMqttConnectOptions options = this.clientFactory.getConnectionOptions();\n+\t\tif (options.getServerURIs() == null && getUrl() != null) {\n+\t\t\tif (options.getServerURIs() == null && getUrl() != null) {", "originalCommit": "9f1153b761f2478f6e0dacbabd8b76f2485a7dc8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODI4OTYwNg==", "url": "https://github.com/spring-projects/spring-integration/pull/3347#discussion_r458289606", "bodyText": "Why does password have a special treatment?", "author": "artembilan", "createdAt": "2020-07-21T18:04:21Z", "path": "spring-integration-mqtt/src/main/java/org/springframework/integration/mqtt/support/MqttUtils.java", "diffHunk": "@@ -0,0 +1,49 @@\n+/*\n+ * Copyright 2020 the original author or authors.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.springframework.integration.mqtt.support;\n+\n+import org.eclipse.paho.client.mqttv3.MqttConnectOptions;\n+\n+import org.springframework.beans.BeanUtils;\n+\n+/**\n+ * MQTT Utilities\n+ *\n+ * @author Gary Russell\n+ * @since 5.4\n+ *\n+ */\n+public final class MqttUtils {\n+\n+\tprivate MqttUtils() {\n+\t}\n+\n+\t/**\n+\t * Clone the {@link MqttConnectOptions}, except the serverUris.\n+\t * @param options the options to clone.\n+\t * @return the clone.\n+\t */\n+\tpublic static MqttConnectOptions cloneConnectOptions(MqttConnectOptions options) {\n+\t\tMqttConnectOptions options2 = new MqttConnectOptions();\n+\t\tBeanUtils.copyProperties(options, options2, \"password\", \"serverURIs\");\n+\t\tif (options.getPassword() != null) {", "originalCommit": "9f1153b761f2478f6e0dacbabd8b76f2485a7dc8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODMwMjYyNA==", "url": "https://github.com/spring-projects/spring-integration/pull/3347#discussion_r458302624", "bodyText": "setPassword clones the Char[]. Same thing with serverURIs - but we know they are null.", "author": "garyrussell", "createdAt": "2020-07-21T18:26:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODI4OTYwNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODI5MDY3OA==", "url": "https://github.com/spring-projects/spring-integration/pull/3347#discussion_r458290678", "bodyText": "Would be great to mention such a type requirement on the MqttIntegrationEvent class JavaDocs.", "author": "artembilan", "createdAt": "2020-07-21T18:06:16Z", "path": "src/reference/asciidoc/mqtt.adoc", "diffHunk": "@@ -403,3 +403,14 @@ Certain application events are published by the adapters.\n * `MqttSubscribedEvent` - published by the inbound adapter after subscribing to the topics.\n \n These events can be received by an `ApplicationListener<MqttIntegrationEvent>` or with an `@EventListener` method.\n+\n+To determine the source of an event, use the following; you can check the bean name and/or the connect options (to access the server URIs etc).\n+\n+====\n+[source, java]\n+----\n+MqttPahoComponent source = event.getSourceAsType();", "originalCommit": "9f1153b761f2478f6e0dacbabd8b76f2485a7dc8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODMwMzEzNA==", "url": "https://github.com/spring-projects/spring-integration/pull/3347#discussion_r458303134", "bodyText": "I don't see how we can -  the event is not aware of Paho - we have an open issue to migrate to another client which will have a different type.", "author": "garyrussell", "createdAt": "2020-07-21T18:27:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODI5MDY3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODMwNTAzNw==", "url": "https://github.com/spring-projects/spring-integration/pull/3347#discussion_r458305037", "bodyText": "OK. Can we then document it on Paho components about such a specific for events?", "author": "artembilan", "createdAt": "2020-07-21T18:30:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODI5MDY3OA=="}], "type": "inlineReview"}, {"oid": "c986a3f7d56a53659249261447f1ec891ea1a597", "url": "https://github.com/spring-projects/spring-integration/commit/c986a3f7d56a53659249261447f1ec891ea1a597", "message": "Code cleanup for previous commit.", "committedDate": "2020-07-21T18:39:39Z", "type": "commit"}]}