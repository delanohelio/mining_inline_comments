{"pr_number": 3380, "pr_title": "GH-3370: Remove synchronized from RemoteFileUtils", "pr_createdAt": "2020-09-10T15:00:34Z", "pr_url": "https://github.com/spring-projects/spring-integration/pull/3380", "timeline": [{"oid": "e8e6483fe0ebe97ca652302f30cd2bbaf91a809c", "url": "https://github.com/spring-projects/spring-integration/commit/e8e6483fe0ebe97ca652302f30cd2bbaf91a809c", "message": "GH-3370: Remove synchronized from RemoteFileUtils\n\nFixes https://github.com/spring-projects/spring-integration/issues/3370\n\nThe `synchronized` on the `RemoteFileUtils.makeDirectories()` makes an application too\n slow, especially when we deal with different paths in different sessions\n\n* Remove the `synchronized` from that method and rework `SftpSession.mkdir()`\nto return `false` when \"A file cannot be created if it already exists\" exception\nis thrown from the server.\nEssentially make an `exists()` call to be sure that an exception is really related\nto \"file-already-exists\" answer from the server\n\n**Cherry-pick to 5.3.x, 5.2.x & 4.3.x**", "committedDate": "2020-09-10T15:00:07Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjQxOTU5NA==", "url": "https://github.com/spring-projects/spring-integration/pull/3380#discussion_r486419594", "bodyText": "I think this should return true since it was a race condition. RFU currently discards the result; I think it should check it and throw an exception if false - see FtpSession where we simply delegate to the client.", "author": "garyrussell", "createdAt": "2020-09-10T15:07:50Z", "path": "spring-integration-sftp/src/main/java/org/springframework/integration/sftp/session/SftpSession.java", "diffHunk": "@@ -252,8 +252,13 @@ public boolean mkdir(String remoteDirectory) throws IOException {\n \t\ttry {\n \t\t\tthis.channel.mkdir(remoteDirectory);\n \t\t}\n-\t\tcatch (SftpException e) {\n-\t\t\tthrow new NestedIOException(\"failed to create remote directory '\" + remoteDirectory + \"'.\", e);\n+\t\tcatch (SftpException ex) {\n+\t\t\tif (ex.id == ChannelSftp.SSH_FX_FAILURE && exists(remoteDirectory)) {\n+\t\t\t\treturn false;", "originalCommit": "e8e6483fe0ebe97ca652302f30cd2bbaf91a809c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "59e7871ace1f3b80917056761b8d08eb03adb7b7", "url": "https://github.com/spring-projects/spring-integration/commit/59e7871ace1f3b80917056761b8d08eb03adb7b7", "message": "* Re-throw an exception in the `SftpSession.mkdir()`\nwhen error code is not `4` or remote dir does not exist", "committedDate": "2020-09-10T15:11:54Z", "type": "commit"}, {"oid": "b7ccb1324bb44e9a227971a622ea408157d9ff24", "url": "https://github.com/spring-projects/spring-integration/commit/b7ccb1324bb44e9a227971a622ea408157d9ff24", "message": "* Check `session.mkdir()` result in the\n`RemoteFileUtils` to throw an `IOException` when `false`", "committedDate": "2020-09-10T15:30:54Z", "type": "commit"}, {"oid": "81871b57caba8c296d6a725720115819bc90c50f", "url": "https://github.com/spring-projects/spring-integration/commit/81871b57caba8c296d6a725720115819bc90c50f", "message": "* Fix mock test to return `true` for `mkdir` instead of `null`", "committedDate": "2020-09-10T17:10:31Z", "type": "commit"}]}