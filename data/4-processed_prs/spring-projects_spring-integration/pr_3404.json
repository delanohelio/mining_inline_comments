{"pr_number": 3404, "pr_title": "Fix MeterRegistry eager load", "pr_createdAt": "2020-10-15T18:50:58Z", "pr_url": "https://github.com/spring-projects/spring-integration/pull/3404", "timeline": [{"oid": "03e30c6fa6cdcf75d9e0aa6b0bcdd5cd9263f6e7", "url": "https://github.com/spring-projects/spring-integration/commit/03e30c6fa6cdcf75d9e0aa6b0bcdd5cd9263f6e7", "message": "Fix MeterRegistry eager load\n\nIf there is a `MeterRegistry` bean (any) in the application context,\nwe add a `MicrometerMetricsCaptor` bean which populates meters further\nfrom the components.\nIn some case we may load a `MicrometerMetricsCaptor` bean too early\nso, not all the stuff around `MeterRegistry` maybe ready.\nSee Spring Boot and its `MetricsAutoConfiguration`\n\n* Fix the `MicrometerMetricsCaptorRegistrar` the way to rely on the\n`ObjectProvider<MeterRegistry>` instead\n* Add package protected ctor to the `MicrometerMetricsCaptor` to\nprovide a target `MeterRegistry` on demand\n\nAll of that will ensure that we use an already post-processed `MeterRegistry`\nincluding Spring Boot auto-configuration\n\n**Cherry-pick to 5.3.x & 5.2.x**", "committedDate": "2020-10-15T18:50:38Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTc3MTU2NA==", "url": "https://github.com/spring-projects/spring-integration/pull/3404#discussion_r505771564", "bodyText": "Shouldn't we get the first if there are more than one? (provider.stream().findFirst()) This would then be consistent with the existing code.", "author": "garyrussell", "createdAt": "2020-10-15T18:58:06Z", "path": "spring-integration-core/src/main/java/org/springframework/integration/support/management/micrometer/MicrometerMetricsCaptor.java", "diffHunk": "@@ -49,31 +50,44 @@\n \n \tpublic static final String MICROMETER_CAPTOR_NAME = \"integrationMicrometerMetricsCaptor\";\n \n-\tprotected final MeterRegistry meterRegistry; // NOSONAR\n+\tprivate MeterRegistry meterRegistry;\n+\n+\tprivate ObjectProvider<MeterRegistry> meterRegistryProvider;\n \n \tpublic MicrometerMetricsCaptor(MeterRegistry meterRegistry) {\n \t\tAssert.notNull(meterRegistry, \"meterRegistry cannot be null\");\n \t\tthis.meterRegistry = meterRegistry;\n \t}\n \n+\tMicrometerMetricsCaptor(ObjectProvider<MeterRegistry> meterRegistryProvider) {\n+\t\tthis.meterRegistryProvider = meterRegistryProvider;\n+\t}\n+\n+\tpublic MeterRegistry getMeterRegistry() {\n+\t\tif (this.meterRegistry == null) {\n+\t\t\tthis.meterRegistry = this.meterRegistryProvider.getIfUnique();", "originalCommit": "03e30c6fa6cdcf75d9e0aa6b0bcdd5cd9263f6e7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTc3NTU1Ng==", "url": "https://github.com/spring-projects/spring-integration/pull/3404#discussion_r505775556", "bodyText": "Well, it is better to use a getIfUnique() since this one returns for a @Primary one - exactly what we want to have in case of Spring Boot.\nApparently the current solution is still bug, since we inject really only one MeterRegistry (Prometheus), but not the composite built by Boot including all the rest available registries, e.g. WaveFront one.", "author": "artembilan", "createdAt": "2020-10-15T19:05:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTc3MTU2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTc3NzUyNA==", "url": "https://github.com/spring-projects/spring-integration/pull/3404#discussion_r505777524", "bodyText": "OK; just waiting for travis, then.", "author": "garyrussell", "createdAt": "2020-10-15T19:09:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTc3MTU2NA=="}], "type": "inlineReview"}]}