{"pr_number": 3200, "pr_title": "GH-3199: FailoverClientCF - Fail Back Option", "pr_createdAt": "2020-02-28T19:51:20Z", "pr_url": "https://github.com/spring-projects/spring-integration/pull/3200", "timeline": [{"oid": "31e2869bc9475c4ba2f34d1692606b3c9434e6b2", "url": "https://github.com/spring-projects/spring-integration/commit/31e2869bc9475c4ba2f34d1692606b3c9434e6b2", "message": "GH-3199: FailoverClientCF - Fail Back Option\n\nResolves: https://github.com/spring-projects/spring-integration/issues/3199\n\nPreviously, the FCCF did not cache a shared connection; if server 1 is down\nand server 2 is up, this caused an attempt to connect to server 1 every time\nwe got the connection.\n\nAdd 2 options: `refreshSharedInterval` and `closeOnRefresh`, defaulting to\n0 and false respectively, to maintain the same behavior as before the options\nexisted.\n\nDisallow caching of the single shared connection if the delegate factories are\n`CachingClientConnectionFactory` instances.\n\n**cherry-pick to 5.2.x**\n\nI will backport to 5.1.x, 4.3.x after review/merge.", "committedDate": "2020-02-28T19:42:28Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTkwNDI0Nw==", "url": "https://github.com/spring-projects/spring-integration/pull/3200#discussion_r385904247", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            Set `closeOnRefresh` to close thee \"old\" connection after a refresh actually creates a new connection.\n          \n          \n            \n            Set `closeOnRefresh` to close the \"old\" connection after a refresh actually creates a new connection.", "author": "artembilan", "createdAt": "2020-02-28T20:20:16Z", "path": "src/reference/asciidoc/ip.adoc", "diffHunk": "@@ -536,6 +536,23 @@ The following example shows how to configure a failover client connection factor\n \n NOTE: When using the failover connection factory, the `singleUse` property must be consistent between the factory itself and the list of factories it is configured to use.\n \n+The connnection factory has two properties when used with a shared connection (`singleUse=false`):\n+\n+* `refreshSharedInterval`\n+* `closeOnRefresh`\n+\n+These are `0` and `false` to retain the same behavior that existed before the properties were added.\n+\n+Consider the following scenario based on the above configuration:\n+Let's say `clientFactory1` cannot establish a connection but `clientFactory2` can.\n+Each time the `failCF` `getConnection()` method is called, we will again attempt to connect using `clientFactory1`; if successful, the \"old\" connection will remain open and may be reused in future if the first factory fails once more.\n+\n+Set `refreshSharedInterval` to only attempt to reconnect with the first factory after that time has expired; set it to `Long.MAX_VALUE` if you only want to fail back to the first factory when the current connection fails.\n+\n+Set `closeOnRefresh` to close thee \"old\" connection after a refresh actually creates a new connection.", "originalCommit": "31e2869bc9475c4ba2f34d1692606b3c9434e6b2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "53a3ac4f1ebaaa36e9074b6fafbf931358d42093", "url": "https://github.com/spring-projects/spring-integration/commit/53a3ac4f1ebaaa36e9074b6fafbf931358d42093", "message": "Polish javadocs and fix typo in docs", "committedDate": "2020-02-28T20:32:09Z", "type": "commit"}]}