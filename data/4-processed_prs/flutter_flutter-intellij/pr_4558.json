{"pr_number": 4558, "pr_title": "Refactor edits", "pr_createdAt": "2020-05-19T22:06:31Z", "pr_url": "https://github.com/flutter/flutter-intellij/pull/4558", "timeline": [{"oid": "d9cb0385b4bf3c3bb4f6238aae277d4c8d0d1fe3", "url": "https://github.com/flutter/flutter-intellij/commit/d9cb0385b4bf3c3bb4f6238aae277d4c8d0d1fe3", "message": "Refactor edit code in plugin tool", "committedDate": "2020-05-19T21:52:38Z", "type": "commit"}, {"oid": "dc071a649df6d3b87ab689020a08a23a86c752e7", "url": "https://github.com/flutter/flutter-intellij/commit/dc071a649df6d3b87ab689020a08a23a86c752e7", "message": "reformat", "committedDate": "2020-05-19T21:58:21Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODE0MzU2MQ==", "url": "https://github.com/flutter/flutter-intellij/pull/4558#discussion_r428143561", "bodyText": "this might format better if you end the version param w/ a trailing comma: version: '4.1',),", "author": "devoncarew", "createdAt": "2020-05-20T16:23:24Z", "path": "tool/plugin/lib/edit.dart", "diffHunk": "@@ -4,14 +4,271 @@\n  * found in the LICENSE file.\n  */\n \n-//import 'dart:async';\n-//import 'dart:convert';\n-//import 'dart:io';\n+import 'dart:async';\n+import 'dart:io';\n \n-//import 'package:path/path.dart' as p;\n+import 'build_spec.dart';\n+import 'util.dart';\n \n-//import 'build_spec.dart';\n-//import 'globals.dart';\n+Set<EditCommand> appliedEditCommands = {};\n \n-class Edit {\n-}\n\\ No newline at end of file\n+void checkAndClearAppliedEditCommands() {\n+  if (appliedEditCommands.length != editCommands.length) {\n+    var commands = <EditCommand>{};\n+    commands.addAll(editCommands);\n+    commands.removeAll(appliedEditCommands);\n+    separator(\"UNUSED EditCommand\");\n+    commands.forEach((cmd) => log(cmd.toString()));\n+  }\n+  appliedEditCommands.clear();\n+}\n+\n+List<EditCommand> editCommands = [\n+  EditAndroidModuleLibraryManager(),\n+  EditFlutterProjectSystem(),\n+  EditFlutterDescriptionProvider(),\n+  Subst(\n+      path: 'flutter-studio/src/io/flutter/project/FlutterProjectSystem.java',\n+      initial:\n+          'gradleProjectSystem.getAndroidFacetsWithPackageName(project, packageName, scope)',\n+      replacement: 'Collections.emptyList()',\n+      version: '4.0'),\n+  Subst(\n+      path:\n+          'flutter-studio/src/io/flutter/actions/FlutterShowStructureSettingsAction.java',\n+      initial: 'import com.android.tools.idea.gradle.structure.actions.AndroidShowStructureSettingsAction;',\n+      replacement: 'import com.android.tools.idea.gradle.actions.AndroidShowStructureSettingsAction;',\n+      versions: ['3.6', '4.0', '2020.1']),\n+  Subst(\n+      path: 'flutter-studio/src/io/flutter/actions/OpenAndroidModule.java',\n+      initial: 'findGradleTarget',\n+      replacement: 'findImportTarget',\n+      versions: ['3.6', '4.0', '2020.1']),\n+  Subst(\n+      path: 'src/io/flutter/utils/AndroidUtils.java',\n+      initial:\n+          'import com.android.tools.idea.gradle.dsl.parser.BuildModelContext;',\n+      replacement:\n+          'import com.android.tools.idea.gradle.dsl.model.BuildModelContext;',\n+      version: '4.1'),", "originalCommit": "dc071a649df6d3b87ab689020a08a23a86c752e7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODE0ODkwMw==", "url": "https://github.com/flutter/flutter-intellij/pull/4558#discussion_r428148903", "bodyText": "Yes, it looks a little better, thanks.", "author": "stevemessick", "createdAt": "2020-05-20T16:31:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODE0MzU2MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODE0NDM0NA==", "url": "https://github.com/flutter/flutter-intellij/pull/4558#discussion_r428144344", "bodyText": "this could use the expression shorthand: ==>", "author": "devoncarew", "createdAt": "2020-05-20T16:24:39Z", "path": "tool/plugin/lib/edit.dart", "diffHunk": "@@ -4,14 +4,271 @@\n  * found in the LICENSE file.\n  */\n \n-//import 'dart:async';\n-//import 'dart:convert';\n-//import 'dart:io';\n+import 'dart:async';\n+import 'dart:io';\n \n-//import 'package:path/path.dart' as p;\n+import 'build_spec.dart';\n+import 'util.dart';\n \n-//import 'build_spec.dart';\n-//import 'globals.dart';\n+Set<EditCommand> appliedEditCommands = {};\n \n-class Edit {\n-}\n\\ No newline at end of file\n+void checkAndClearAppliedEditCommands() {\n+  if (appliedEditCommands.length != editCommands.length) {\n+    var commands = <EditCommand>{};\n+    commands.addAll(editCommands);\n+    commands.removeAll(appliedEditCommands);\n+    separator(\"UNUSED EditCommand\");\n+    commands.forEach((cmd) => log(cmd.toString()));\n+  }\n+  appliedEditCommands.clear();\n+}\n+\n+List<EditCommand> editCommands = [\n+  EditAndroidModuleLibraryManager(),\n+  EditFlutterProjectSystem(),\n+  EditFlutterDescriptionProvider(),\n+  Subst(\n+      path: 'flutter-studio/src/io/flutter/project/FlutterProjectSystem.java',\n+      initial:\n+          'gradleProjectSystem.getAndroidFacetsWithPackageName(project, packageName, scope)',\n+      replacement: 'Collections.emptyList()',\n+      version: '4.0'),\n+  Subst(\n+      path:\n+          'flutter-studio/src/io/flutter/actions/FlutterShowStructureSettingsAction.java',\n+      initial: 'import com.android.tools.idea.gradle.structure.actions.AndroidShowStructureSettingsAction;',\n+      replacement: 'import com.android.tools.idea.gradle.actions.AndroidShowStructureSettingsAction;',\n+      versions: ['3.6', '4.0', '2020.1']),\n+  Subst(\n+      path: 'flutter-studio/src/io/flutter/actions/OpenAndroidModule.java',\n+      initial: 'findGradleTarget',\n+      replacement: 'findImportTarget',\n+      versions: ['3.6', '4.0', '2020.1']),\n+  Subst(\n+      path: 'src/io/flutter/utils/AndroidUtils.java',\n+      initial:\n+          'import com.android.tools.idea.gradle.dsl.parser.BuildModelContext;',\n+      replacement:\n+          'import com.android.tools.idea.gradle.dsl.model.BuildModelContext;',\n+      version: '4.1'),\n+];\n+\n+// Used to test checkAndClearAppliedEditCommands()\n+class Unused extends EditCommand {\n+  @override\n+  String get path => 'unused';\n+\n+  @override\n+  String convert(BuildSpec spec) {\n+    return null;\n+  }\n+}\n+\n+class EditAndroidModuleLibraryManager extends EditCommand {\n+  @override\n+  String get path =>\n+      'flutter-studio/src/io/flutter/android/AndroidModuleLibraryManager.java';\n+\n+  @override\n+  String convert(BuildSpec spec) {\n+    if (spec.version.startsWith('3.6')) {\n+      var processedFile, source;\n+      processedFile = File(\n+          'flutter-studio/src/io/flutter/android/AndroidModuleLibraryManager.java');\n+      source = processedFile.readAsStringSync();\n+      var original = source;\n+      source = source.replaceAll(\n+        'super(filePath',\n+        'super(filePath.toString()',\n+      );\n+      // Starting with 3.6 we need to call a simplified init().\n+      // This is where the $PROJECT_FILE$ macro is defined, #registerComponents.\n+      source = source.replaceAll(\n+        'getStateStore().setPath(path',\n+        'getStateStore().setPath(path.toString()',\n+      );\n+      processedFile.writeAsStringSync(source);\n+      return original;\n+    } else {\n+      return null;\n+    }\n+  }\n+}\n+\n+class EditFlutterProjectSystem extends EditCommand {\n+  @override\n+  String get path =>\n+      'flutter-studio/src/io/flutter/project/FlutterProjectSystem.java';\n+\n+  @override\n+  String convert(BuildSpec spec) {\n+    if (!spec.version.startsWith('4.')) {\n+      var processedFile, source;\n+      processedFile = File(\n+          'flutter-studio/src/io/flutter/project/FlutterProjectSystem.java');\n+      source = processedFile.readAsStringSync();\n+      var original = source;\n+      source = source.replaceAll(\n+        'import com.android.tools.idea.projectsystem.SourceProvidersFactory;',\n+        '',\n+      );\n+      source = source.replaceAll(' SourceProvidersFactory ', ' Object ');\n+      source = source.replaceAll(\n+        'gradleProjectSystem.getSourceProvidersFactory()',\n+        'new Object()',\n+      );\n+      source = source.replaceAll(\n+        'gradleProjectSystem.getAndroidFacetsWithPackageName(project, packageName, scope)',\n+        'Collections.emptyList()',\n+      );\n+      if (spec.version.startsWith('3.6')) {\n+        source = source.replaceAll(\n+          'gradleProjectSystem.getSubmodules()',\n+          'new java.util.ArrayList()',\n+        );\n+      }\n+      processedFile.writeAsStringSync(source);\n+      return original;\n+    } else {\n+      return null;\n+    }\n+  }\n+}\n+\n+class EditFlutterDescriptionProvider extends EditCommand {\n+  @override\n+  String get path =>\n+      'flutter-studio/src/io/flutter/module/FlutterDescriptionProvider.java';\n+\n+  @override\n+  String convert(BuildSpec spec) {\n+    if (!spec.version.startsWith('4.')) {\n+      var processedFile, source;\n+      processedFile = File(\n+          'flutter-studio/src/io/flutter/module/FlutterDescriptionProvider.java');\n+      source = processedFile.readAsStringSync();\n+      var original = source;\n+      source = source.replaceAll(\n+        'import com.android.tools.idea.npw.model.ProjectSyncInvoker',\n+        'import com.android.tools.idea.npw.model.NewModuleModel',\n+      );\n+      source = source.replaceAll(\n+        'createStep(@NotNull Project model, @NotNull ProjectSyncInvoker invoker, String parent)',\n+        'createStep(@NotNull NewModuleModel model)',\n+      );\n+      source = source.replaceAll(\n+        'FlutterProjectModel model(@NotNull Project project,',\n+        'FlutterProjectModel model(@NotNull NewModuleModel project,',\n+      );\n+      source = source.replaceAll(\n+        'mySharedModel.getValue().project().setValue(project);',\n+        'mySharedModel.getValue().project().setValue(project.getProject().getValue());',\n+      );\n+      processedFile.writeAsStringSync(source);\n+      return original;\n+    } else {\n+      return null;\n+    }\n+  }\n+}\n+\n+/// Apply all the editCommands applicable to a given BuildSpec.\n+Future<int> applyEdits(BuildSpec spec, Function compileFn) async {\n+  // Handle skipped files.\n+  for (String file in spec.filesToSkip) {\n+    var entity =\n+        FileSystemEntity.isFileSync(file) ? File(file) : Directory(file);\n+    if (entity.existsSync()) {\n+      await entity.rename('$file~');\n+      if (entity is File) {\n+        var stubFile = File('${file}_stub');\n+        if (stubFile.existsSync()) {\n+          await stubFile.copy('$file');\n+        }\n+      }\n+    }\n+  }\n+\n+  var edited = <EditCommand, String>{};\n+  try {\n+    editCommands.forEach((edit) {\n+      var source = edit.convert(spec);\n+      if (source != null) {\n+        edited[edit] = source;\n+        appliedEditCommands.add(edit);\n+      }\n+    });\n+\n+    return await compileFn.call();\n+  } finally {\n+    // Restore sources.\n+    edited.forEach((edit, source) {\n+      log('Restoring ${edit.path}');\n+      edit.restore(source);\n+    });\n+\n+    // Restore skipped files.\n+    for (var file in spec.filesToSkip) {\n+      var name = '$file~';\n+      var entity =\n+          FileSystemEntity.isFileSync(name) ? File(name) : Directory(name);\n+      if (entity.existsSync()) {\n+        await entity.rename(file);\n+      }\n+    }\n+  }\n+}\n+\n+/// Make some changes to a source file prior to compiling for a specific IDE.\n+abstract class EditCommand {\n+  String convert(BuildSpec spec);\n+\n+  void restore(String source) {\n+    var processedFile = File(path);\n+    processedFile.writeAsStringSync(source);\n+  }\n+\n+  String get path;\n+}\n+\n+/// Single substitution in a file for one or more IDE versions.\n+class Subst extends EditCommand {\n+  @override\n+  String path;\n+  String initial;\n+  String replacement;\n+  List<String> versions;\n+\n+  Subst({this.versions, this.initial, this.replacement, this.path, version})\n+      : assert(initial != null),\n+        assert(replacement != null),\n+        assert(path != null) {\n+    if (version != null) {\n+      // Disallow both version and versions keywords.\n+      assert(versions == null);\n+      versions = [version];\n+    }\n+  }\n+\n+  @override\n+  String convert(BuildSpec spec) {\n+    if (versionMatches(spec)) {\n+      var processedFile = File(path);\n+      var source = processedFile.readAsStringSync();\n+      var original = source;\n+      source = source.replaceAll(initial, replacement);\n+      processedFile.writeAsStringSync(source);\n+      return original;\n+    } else {\n+      return null;\n+    }\n+  }\n+\n+  String toString() {\n+    return \"Subst(path: $path, versions: $versions)\";", "originalCommit": "dc071a649df6d3b87ab689020a08a23a86c752e7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODE0ODkzMQ==", "url": "https://github.com/flutter/flutter-intellij/pull/4558#discussion_r428148931", "bodyText": "Done!", "author": "stevemessick", "createdAt": "2020-05-20T16:32:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODE0NDM0NA=="}], "type": "inlineReview"}, {"oid": "9566d819f99a3ee4ec33b5eec4c3f65ae878adb3", "url": "https://github.com/flutter/flutter-intellij/commit/9566d819f99a3ee4ec33b5eec4c3f65ae878adb3", "message": "cleanup", "committedDate": "2020-05-20T16:30:42Z", "type": "commit"}]}