{"pr_number": 4275, "pr_title": "fix an issue with sending in non-absolute paths to flutter.subscriptions", "pr_createdAt": "2020-01-10T19:37:18Z", "pr_url": "https://github.com/flutter/flutter-intellij/pull/4275", "timeline": [{"oid": "f492d8c0a1da112a84d038afbb6401fe0b87b782", "url": "https://github.com/flutter/flutter-intellij/commit/f492d8c0a1da112a84d038afbb6401fe0b87b782", "message": "fix an issue with sending in non-absolute paths to flutter.subscriptions", "committedDate": "2020-01-10T19:27:19Z", "type": "commit"}, {"oid": "ad8cbd57fecb6845bb0f35064cdbb88d9df8ac7c", "url": "https://github.com/flutter/flutter-intellij/commit/ad8cbd57fecb6845bb0f35064cdbb88d9df8ac7c", "message": "use getCannonicalPath() in more places", "committedDate": "2020-01-10T19:36:14Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzExODE5Mg==", "url": "https://github.com/flutter/flutter-intellij/pull/4275#discussion_r367118192", "bodyText": "getCanonicalPath() is used in many other places. Why change to getPath() here? It looks like the initialization is (line 114 in the original):\nnewPaths.add(file.getCanonicalPath());.", "author": "stevemessick", "createdAt": "2020-01-15T21:32:41Z", "path": "src/io/flutter/editor/ActiveEditorsOutlineService.java", "diffHunk": "@@ -192,7 +192,7 @@ public FlutterOutline getOutline(String path) {\n    */\n   @Nullable\n   public FlutterOutline getIfUpdated(@NotNull PsiFile file) {\n-    final FlutterOutline outline = getOutline(file.getVirtualFile().getCanonicalPath());\n+    final FlutterOutline outline = getOutline(file.getOriginalFile().getVirtualFile().getPath());", "originalCommit": "ad8cbd57fecb6845bb0f35064cdbb88d9df8ac7c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzEzOTgxMg==", "url": "https://github.com/flutter/flutter-intellij/pull/4275#discussion_r367139812", "bodyText": "I haven't reviewed neither this nor other usages of getCanonicalPath(). Just noticed this word and remembered that normally we don't need to use this method. Its javadoc says that in fact in most cases we should work with usual paths. As I understand, we might need to work with canonical paths only for some known corner cases with symlinks. But I don't think there're a lot. For example, in Dart plugin there are zero usages of getCanonicalPath().", "author": "alexander-doroshko", "createdAt": "2020-01-15T22:24:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzExODE5Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzE2NDMzNg==", "url": "https://github.com/flutter/flutter-intellij/pull/4275#discussion_r367164336", "bodyText": "Thanks @stevemessick, @alexander-doroshko; I'll review our uses here. We should definitely use the same technique (either getPath or getCanonicalPath) when storing and clearing from the path list.\nThe main part of this specific fix is that for PsiFiles, you can sometimes get non-absolute paths from getPath() - I believe if the PsiFile file is backed by a LightVirtualFile? The getOriginalFile() should avoid that, and then getFile() should return an absolute path (which we need later for the analysis server).", "author": "devoncarew", "createdAt": "2020-01-15T23:40:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzExODE5Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzMzMTUzNg==", "url": "https://github.com/flutter/flutter-intellij/pull/4275#discussion_r367331536", "bodyText": "PsiFile.getOriginalFile() normally returns this. There are just a few cases when original file is different. The main use case is code completion. Platform creates a fake copy of PsiFile and performs completion there, so CompletionContributors might need to use original files. In all other cases we usually don't care and use PsiFile as is without calling getOriginalFile(). So as a cleanup, we may get rid of unneeded getOriginalFile() calls in our plugins. OTOH, the only harm from such calls is 17 useless characters in the source code.\nIn those cases when PsiFile is not equal to PsiFile.getOriginalFile(), PsiFile.getVirtualFile() returns null. So getOriginalFile() can't fix the exception from #4273\nThere are 116 subclasses of VirtualFile and most of them may be opened in an editor. So, it's not safe to send fileInEditor.getPath() to the server, and #4273 proves that. In the Dart plugin we check VirtualFile.isInLocalFileSystem() and isFileNameRespectedByAnalysisServer() (see DartAnalysisServerService.isLocalAnalyzableFile()). You may want to do the same in the Flutter plugin.", "author": "alexander-doroshko", "createdAt": "2020-01-16T10:08:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzExODE5Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzU3MzExNw==", "url": "https://github.com/flutter/flutter-intellij/pull/4275#discussion_r367573117", "bodyText": "Great, thanks for the review. I'll update or re-create this PR w/ the new info.", "author": "devoncarew", "createdAt": "2020-01-16T18:14:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzExODE5Mg=="}], "type": "inlineReview"}, {"oid": "db0f8dc836e65d871d14fafbb57114f645a8bd70", "url": "https://github.com/flutter/flutter-intellij/commit/db0f8dc836e65d871d14fafbb57114f645a8bd70", "message": "standardize on use of VirtualFile.getFile() instead of getCanonicalFile() in ActiveEditorsOutlineService.java", "committedDate": "2020-01-16T00:24:05Z", "type": "commit"}, {"oid": "5d8f51d9aeb15c9c615d4a63f47f5f664ca8b278", "url": "https://github.com/flutter/flutter-intellij/commit/5d8f51d9aeb15c9c615d4a63f47f5f664ca8b278", "message": "use VirtualFile.file.isInLocalFileSystem()", "committedDate": "2020-01-17T22:49:35Z", "type": "commit"}, {"oid": "5cf7b42578feb1f1561014780373807457c65aaa", "url": "https://github.com/flutter/flutter-intellij/commit/5cf7b42578feb1f1561014780373807457c65aaa", "message": "misc cleanups", "committedDate": "2020-01-17T22:55:54Z", "type": "commit"}, {"oid": "c2d0ebf7c18344870e2fc3497d50f36c1b1543e2", "url": "https://github.com/flutter/flutter-intellij/commit/c2d0ebf7c18344870e2fc3497d50f36c1b1543e2", "message": "misc change to the git diff", "committedDate": "2020-01-18T05:32:03Z", "type": "commit"}, {"oid": "a16bba9ce662e316c8a9863040a9657d75d23e0b", "url": "https://github.com/flutter/flutter-intellij/commit/a16bba9ce662e316c8a9863040a9657d75d23e0b", "message": "misc change to the git diff", "committedDate": "2020-01-18T05:34:02Z", "type": "commit"}]}