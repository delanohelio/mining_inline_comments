{"pr_number": 1456, "pr_title": "Use new IntervalMergingIterator to merge intervals on the fly ", "pr_createdAt": "2020-01-26T08:59:03Z", "pr_url": "https://github.com/broadinstitute/picard/pull/1456", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDc3NTg1Mw==", "url": "https://github.com/broadinstitute/picard/pull/1456#discussion_r384775853", "bodyText": "Would be nice to expose to the command line the option to not concatenate all the merged interval names.  In the use case which prompted this, a TON of sites (think whole genome gvcf with bp resolution) are often merged into a single interval, which then has an outrageously long concatenated name.  These concatenated names often don't carry any useful information, and can make the resulting interval list extremely large.", "author": "kachulis", "createdAt": "2020-02-26T21:26:18Z", "path": "src/main/java/picard/vcf/VcfToIntervalList.java", "diffHunk": "@@ -84,10 +91,23 @@ protected int doWork() {\n         IOUtil.assertFileIsReadable(INPUT);\n         IOUtil.assertFileIsWritable(OUTPUT);\n \n-        final IntervalList intervalList = VCFFileReader.fromVcf(INPUT, INCLUDE_FILTERED);\n+        try (VCFFileReader vcfReader = new VCFFileReader(INPUT.toPath(), false)) {\n+            final Iterator<Interval> samFileIterator = VCFFileReader.toIntervals(vcfReader, INCLUDE_FILTERED);\n+            try (IntervalListWriter writer = new IntervalListWriter(OUTPUT.toPath(), new SAMFileHeader(vcfReader.getFileHeader().getSequenceDictionary()))) {\n+                final IntervalList.IntervalMergerIterator mergingIterator =\n+                        new IntervalList.IntervalMergerIterator(samFileIterator, true, false, true);", "originalCommit": "68fe8bea94b403d64f47d456831629b684776e07", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTkwNDkzMg==", "url": "https://github.com/broadinstitute/picard/pull/1456#discussion_r389904932", "bodyText": "Yeah, \ud83d\udc4d", "author": "skwalker", "createdAt": "2020-03-09T19:14:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDc3NTg1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTQwMDczMg==", "url": "https://github.com/broadinstitute/picard/pull/1456#discussion_r395400732", "bodyText": "like so?", "author": "yfarjoun", "createdAt": "2020-03-20T01:16:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDc3NTg1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTYxNzUwNw==", "url": "https://github.com/broadinstitute/picard/pull/1456#discussion_r395617507", "bodyText": "yep!", "author": "kachulis", "createdAt": "2020-03-20T12:56:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDc3NTg1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTcwNzc1Nw==", "url": "https://github.com/broadinstitute/picard/pull/1456#discussion_r395707757", "bodyText": "@skwalker can you try this on your VCF that was causing all the trouble and see if it helps?", "author": "yfarjoun", "createdAt": "2020-03-20T15:19:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDc3NTg1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDk1NDAzNg==", "url": "https://github.com/broadinstitute/picard/pull/1456#discussion_r404954036", "bodyText": "It works! Thank you (the output interval list went from almost 10G to less than 1 with that change)", "author": "skwalker", "createdAt": "2020-04-07T16:39:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDc3NTg1Mw=="}], "type": "inlineReview"}, {"oid": "9da2b5d5dc9987f5e86e90f15b85fc9a32b8d7c6", "url": "https://github.com/broadinstitute/picard/commit/9da2b5d5dc9987f5e86e90f15b85fc9a32b8d7c6", "message": "- use new IntervalMergingIterator to merge intervals on the fly and write the intervalList without having to hold it all in memory.", "committedDate": "2020-03-20T01:49:38Z", "type": "commit"}, {"oid": "e883eccaf62e7b68c2dca4316e54bf9e96949fc5", "url": "https://github.com/broadinstitute/picard/commit/e883eccaf62e7b68c2dca4316e54bf9e96949fc5", "message": "- adapted code to modified version of merging iterator that was actually merged into htsjdk", "committedDate": "2020-03-20T01:49:58Z", "type": "commit"}, {"oid": "8ed64955b878e90b44037156f14c504334368114", "url": "https://github.com/broadinstitute/picard/commit/8ed64955b878e90b44037156f14c504334368114", "message": "- make the concatenation of variant names/intervals optional", "committedDate": "2020-03-20T01:49:58Z", "type": "commit"}, {"oid": "8ed64955b878e90b44037156f14c504334368114", "url": "https://github.com/broadinstitute/picard/commit/8ed64955b878e90b44037156f14c504334368114", "message": "- make the concatenation of variant names/intervals optional", "committedDate": "2020-03-20T01:49:58Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDk1NDYyNA==", "url": "https://github.com/broadinstitute/picard/pull/1456#discussion_r404954624", "bodyText": "Don't we usually want boolean argument defaults to be false?", "author": "skwalker", "createdAt": "2020-04-07T16:40:48Z", "path": "src/main/java/picard/vcf/VcfToIntervalList.java", "diffHunk": "@@ -74,6 +81,11 @@\n     @Argument(shortName = StandardOptionDefinitions.OUTPUT_SHORT_NAME, doc = \"The output Picard Interval List.\")\n     public File OUTPUT;\n \n+    @Argument(doc=\"Controls the naming of the resulting intervals. When true, each resulting interval will be named the concatenation of \" +\n+            \"the variant ID fields (if present), or 'interval-<number>' (if not) with a pipe '|' separator. \" +\n+            \"When false, only the first name will be used.\")\n+    public boolean CONCATENATE_IDS = true;", "originalCommit": "8ed64955b878e90b44037156f14c504334368114", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTExNzgxNg==", "url": "https://github.com/broadinstitute/picard/pull/1456#discussion_r405117816", "bodyText": "good point.", "author": "yfarjoun", "createdAt": "2020-04-07T21:15:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDk1NDYyNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTEwMjAwMA==", "url": "https://github.com/broadinstitute/picard/pull/1456#discussion_r405102000", "bodyText": "does this need to be \".incomplete\" ?", "author": "skwalker", "createdAt": "2020-04-07T20:46:37Z", "path": "src/main/java/picard/vcf/VcfToIntervalList.java", "diffHunk": "@@ -84,10 +96,23 @@ protected int doWork() {\n         IOUtil.assertFileIsReadable(INPUT);\n         IOUtil.assertFileIsWritable(OUTPUT);\n \n-        final IntervalList intervalList = VCFFileReader.fromVcf(INPUT, INCLUDE_FILTERED);\n+        try (VCFFileReader vcfReader = new VCFFileReader(INPUT.toPath(), false)) {\n+            final Iterator<Interval> samFileIterator = VCFFileReader.toIntervals(vcfReader, INCLUDE_FILTERED);\n+            try (IntervalListWriter writer = new IntervalListWriter(OUTPUT.toPath(), new SAMFileHeader(vcfReader.getFileHeader().getSequenceDictionary()))) {\n+                final IntervalList.IntervalMergerIterator mergingIterator =\n+                        new IntervalList.IntervalMergerIterator(samFileIterator, true, false, CONCATENATE_IDS);\n+                for (final Interval interval : new IterableAdapter<>(mergingIterator)){\n+                    writer.write(interval);\n+                }\n+            } catch (IOException e) {\n+                if(!OUTPUT.renameTo(new File(OUTPUT.getAbsolutePath() + \"incomplete\"))){", "originalCommit": "8ed64955b878e90b44037156f14c504334368114", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTExNzk5NQ==", "url": "https://github.com/broadinstitute/picard/pull/1456#discussion_r405117995", "bodyText": "ah, yes. I'll add the period. thanks.", "author": "yfarjoun", "createdAt": "2020-04-07T21:16:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTEwMjAwMA=="}], "type": "inlineReview"}, {"oid": "b5eab4bdf1224cc5c04e0f07681c4e97c80c15c2", "url": "https://github.com/broadinstitute/picard/commit/b5eab4bdf1224cc5c04e0f07681c4e97c80c15c2", "message": "making IntervalListToBed faster (3 mins instead of over 3 hours for a 1.6G vcf)", "committedDate": "2020-06-02T22:22:00Z", "type": "commit"}, {"oid": "f2822b6f816c279fd32c6f1688011de720e89c7f", "url": "https://github.com/broadinstitute/picard/commit/f2822b6f816c279fd32c6f1688011de720e89c7f", "message": "minor updates for yossi", "committedDate": "2020-06-02T22:23:44Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTEwNTIzNw==", "url": "https://github.com/broadinstitute/picard/pull/1456#discussion_r441105237", "bodyText": "no need to close out since it's inside the T-W-R loop.", "author": "yfarjoun", "createdAt": "2020-06-16T19:55:03Z", "path": "src/main/java/picard/util/IntervalListToBed.java", "diffHunk": "@@ -69,24 +69,37 @@ protected int doWork() {\n         IOUtil.assertFileIsReadable(INPUT);\n         IOUtil.assertFileIsWritable(OUTPUT);\n \n-        IntervalList intervals = IntervalList.fromFile(INPUT);\n-        if (SORT) intervals = intervals.sorted();\n+        try (final AbstractFeatureReader<Interval, LineIterator> intervalsReader = AbstractFeatureReader.getFeatureReader(INPUT.getPath(), new IntervalListCodec(), false);\n+             final BufferedWriter out = IOUtil.openFileForBufferedWriting(OUTPUT)) {\n \n-        try {\n-            final BufferedWriter out = IOUtil.openFileForBufferedWriting(OUTPUT);\n-            for (final Interval i : intervals) {\n+            Iterable<Interval> intervalIterable = intervalsReader.iterator();\n+            if (SORT) {\n+\n+                final SortingCollection<Interval> sortedIntervals =\n+                        SortingCollection.newInstance(Interval.class, new IntervalCodec(((SAMFileHeader)intervalsReader.getHeader()).getSequenceDictionary()),\n+                                Interval::compareTo, 500000, OUTPUT.toPath());\n+\n+                for (final Interval i: intervalsReader.iterator()) {\n+                    sortedIntervals.add(i);\n+                }\n+\n+                intervalIterable = sortedIntervals;\n+            }\n+\n+            for (final Interval i : intervalIterable) {\n                 final String strand = i.isNegativeStrand() ? \"-\" : \"+\";\n                 final List<?> fields = CollectionUtil.makeList(i.getContig(), i.getStart()-1, i.getEnd(), i.getName(), SCORE, strand);\n                 out.append(fields.stream().map(String::valueOf).collect(Collectors.joining(\"\\t\")));\n                 out.newLine();\n-            }\n \n+            }", "originalCommit": "f2822b6f816c279fd32c6f1688011de720e89c7f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjQ4NDkzNw==", "url": "https://github.com/broadinstitute/picard/pull/1456#discussion_r452484937", "bodyText": "still no need to close", "author": "yfarjoun", "createdAt": "2020-07-09T20:55:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTEwNTIzNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTEwNjAyNA==", "url": "https://github.com/broadinstitute/picard/pull/1456#discussion_r441106024", "bodyText": "this is actually a closable iterator, so you can put it inside the try clause above as well", "author": "yfarjoun", "createdAt": "2020-06-16T19:56:33Z", "path": "src/main/java/picard/util/IntervalListToBed.java", "diffHunk": "@@ -69,24 +69,37 @@ protected int doWork() {\n         IOUtil.assertFileIsReadable(INPUT);\n         IOUtil.assertFileIsWritable(OUTPUT);\n \n-        IntervalList intervals = IntervalList.fromFile(INPUT);\n-        if (SORT) intervals = intervals.sorted();\n+        try (final AbstractFeatureReader<Interval, LineIterator> intervalsReader = AbstractFeatureReader.getFeatureReader(INPUT.getPath(), new IntervalListCodec(), false);\n+             final BufferedWriter out = IOUtil.openFileForBufferedWriting(OUTPUT)) {\n \n-        try {\n-            final BufferedWriter out = IOUtil.openFileForBufferedWriting(OUTPUT);\n-            for (final Interval i : intervals) {\n+            Iterable<Interval> intervalIterable = intervalsReader.iterator();", "originalCommit": "f2822b6f816c279fd32c6f1688011de720e89c7f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTY4MzM4Ng==", "url": "https://github.com/broadinstitute/picard/pull/1456#discussion_r441683386", "bodyText": "it is in the try clause, I think maybe it looks confusing in the side by side view ?", "author": "skwalker", "createdAt": "2020-06-17T16:44:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTEwNjAyNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjQ4NTg0Ng==", "url": "https://github.com/broadinstitute/picard/pull/1456#discussion_r452485846", "bodyText": "I meant that intervalIterable can be instantiated inside the parens:\ntry (AbstractFeatureReader<Interval, LineIterator> intervalsReader = AbstractFeatureReader.getFeatureReader(INPUT.getPath(), new IntervalListCodec(), false);\n       Iterable<Interval> intervalIterable = intervalsReader.iterator();\n       BufferedWriter out = IOUtil.openFileForBufferedWriting(OUTPUT)){", "author": "yfarjoun", "createdAt": "2020-07-09T20:57:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTEwNjAyNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTEwNzA5NQ==", "url": "https://github.com/broadinstitute/picard/pull/1456#discussion_r441107095", "bodyText": "why was this bad? perhaps you can explain in a comment since the code below seems needlessly complicated....", "author": "yfarjoun", "createdAt": "2020-06-16T19:58:36Z", "path": "src/main/java/picard/util/IntervalListToBed.java", "diffHunk": "@@ -69,24 +69,37 @@ protected int doWork() {\n         IOUtil.assertFileIsReadable(INPUT);\n         IOUtil.assertFileIsWritable(OUTPUT);\n \n-        IntervalList intervals = IntervalList.fromFile(INPUT);\n-        if (SORT) intervals = intervals.sorted();", "originalCommit": "f2822b6f816c279fd32c6f1688011de720e89c7f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTY4MjcyMQ==", "url": "https://github.com/broadinstitute/picard/pull/1456#discussion_r441682721", "bodyText": "It's causing it to hold everything in place which takes forever to load (I was running on an intervallist from a  <1 G vcf and it was running for over 3 hours...) and now it takes 3 minutes", "author": "skwalker", "createdAt": "2020-06-17T16:43:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTEwNzA5NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTEwOTEwNQ==", "url": "https://github.com/broadinstitute/picard/pull/1456#discussion_r441109105", "bodyText": "unneeded empty new lines.", "author": "yfarjoun", "createdAt": "2020-06-16T20:02:31Z", "path": "src/main/java/picard/util/IntervalListToBed.java", "diffHunk": "@@ -69,24 +69,37 @@ protected int doWork() {\n         IOUtil.assertFileIsReadable(INPUT);\n         IOUtil.assertFileIsWritable(OUTPUT);\n \n-        IntervalList intervals = IntervalList.fromFile(INPUT);\n-        if (SORT) intervals = intervals.sorted();\n+        try (final AbstractFeatureReader<Interval, LineIterator> intervalsReader = AbstractFeatureReader.getFeatureReader(INPUT.getPath(), new IntervalListCodec(), false);\n+             final BufferedWriter out = IOUtil.openFileForBufferedWriting(OUTPUT)) {\n \n-        try {\n-            final BufferedWriter out = IOUtil.openFileForBufferedWriting(OUTPUT);\n-            for (final Interval i : intervals) {\n+            Iterable<Interval> intervalIterable = intervalsReader.iterator();\n+            if (SORT) {\n+\n+                final SortingCollection<Interval> sortedIntervals =\n+                        SortingCollection.newInstance(Interval.class, new IntervalCodec(((SAMFileHeader)intervalsReader.getHeader()).getSequenceDictionary()),\n+                                Interval::compareTo, 500000, OUTPUT.toPath());\n+\n+                for (final Interval i: intervalsReader.iterator()) {\n+                    sortedIntervals.add(i);\n+                }\n+\n+                intervalIterable = sortedIntervals;\n+            }\n+\n+            for (final Interval i : intervalIterable) {\n                 final String strand = i.isNegativeStrand() ? \"-\" : \"+\";\n                 final List<?> fields = CollectionUtil.makeList(i.getContig(), i.getStart()-1, i.getEnd(), i.getName(), SCORE, strand);\n                 out.append(fields.stream().map(String::valueOf).collect(Collectors.joining(\"\\t\")));\n                 out.newLine();\n-            }\n \n+            }\n             out.close();\n-        }\n-        catch (IOException ioe) {\n+            return 0;\n+        } catch (IOException ioe) {\n             throw new RuntimeIOException(ioe);\n         }\n \n-        return 0;\n+", "originalCommit": "f2822b6f816c279fd32c6f1688011de720e89c7f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzM3OTM5OQ==", "url": "https://github.com/broadinstitute/picard/pull/1456#discussion_r457379399", "bodyText": "empty new line still here", "author": "kachulis", "createdAt": "2020-07-20T13:24:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTEwOTEwNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTEwOTkzMA==", "url": "https://github.com/broadinstitute/picard/pull/1456#discussion_r441109930", "bodyText": "Hmmm. The reason that this was default true was that that was the behavior prior to making this an option....we didn't want to change the default behavior....why does the default need to change?", "author": "yfarjoun", "createdAt": "2020-06-16T20:04:20Z", "path": "src/main/java/picard/vcf/VcfToIntervalList.java", "diffHunk": "@@ -84,7 +84,7 @@\n     @Argument(doc=\"Controls the naming of the resulting intervals. When true, each resulting interval will be named the concatenation of \" +\n             \"the variant ID fields (if present), or 'interval-<number>' (if not) with a pipe '|' separator. \" +\n             \"When false, only the first name will be used.\")\n-    public boolean CONCATENATE_IDS = true;\n+    public boolean CONCATENATE_IDS = false;", "originalCommit": "f2822b6f816c279fd32c6f1688011de720e89c7f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTY3MDkxMg==", "url": "https://github.com/broadinstitute/picard/pull/1456#discussion_r441670912", "bodyText": "I thought boolean arguments are supposed to default to false? I could make it\nDONT_ CONCATENATE_IDS or something or maybe it doesn't matter enough", "author": "skwalker", "createdAt": "2020-06-17T16:24:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTEwOTkzMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTgwMzg2OA==", "url": "https://github.com/broadinstitute/picard/pull/1456#discussion_r441803868", "bodyText": "yeah, make the default value false, but keep the default behavior the same...or define an enum \"CONCAT_ALL\" & \"USE_FIRST\" to control the behaviour (with the default value being CONCAT_ALL)", "author": "yfarjoun", "createdAt": "2020-06-17T20:08:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTEwOTkzMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjg3MTkwNg==", "url": "https://github.com/broadinstitute/picard/pull/1456#discussion_r442871906", "bodyText": "Yeah, I like the enum idea better than a double negative (too confusing) \ud83d\udc4d", "author": "skwalker", "createdAt": "2020-06-19T14:26:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTEwOTkzMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTExMDI1Mg==", "url": "https://github.com/broadinstitute/picard/pull/1456#discussion_r441110252", "bodyText": "there is a preference for explicit imports...can you ask IntelliJ to use explicit imports?", "author": "yfarjoun", "createdAt": "2020-06-16T20:05:05Z", "path": "src/main/java/picard/util/IntervalListToBed.java", "diffHunk": "@@ -23,11 +23,11 @@\n  */\n package picard.util;\n \n-import htsjdk.samtools.util.CollectionUtil;\n-import htsjdk.samtools.util.IOUtil;\n-import htsjdk.samtools.util.Interval;\n-import htsjdk.samtools.util.IntervalList;\n-import htsjdk.samtools.util.RuntimeIOException;\n+import htsjdk.samtools.SAMFileHeader;\n+import htsjdk.samtools.util.*;", "originalCommit": "f2822b6f816c279fd32c6f1688011de720e89c7f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "5fb98421370be9ff845aa16a542fe042e900ae3e", "url": "https://github.com/broadinstitute/picard/commit/5fb98421370be9ff845aa16a542fe042e900ae3e", "message": "responding to comments", "committedDate": "2020-06-17T16:44:23Z", "type": "commit"}, {"oid": "cd351944bde1a83c757616ee9ecb1e151caa83e3", "url": "https://github.com/broadinstitute/picard/commit/cd351944bde1a83c757616ee9ecb1e151caa83e3", "message": "responding to comments; fixing sort in intervallisttobed", "committedDate": "2020-06-19T14:39:49Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzQxNzMxMg==", "url": "https://github.com/broadinstitute/picard/pull/1456#discussion_r447417312", "bodyText": "this cannot work...the @argument value is modified after the class is instantiated...so concatenate_ids will always be true. move this line into doWork()", "author": "yfarjoun", "createdAt": "2020-06-30T05:25:16Z", "path": "src/main/java/picard/vcf/VcfToIntervalList.java", "diffHunk": "@@ -81,10 +81,17 @@\n     @Argument(shortName = StandardOptionDefinitions.OUTPUT_SHORT_NAME, doc = \"The output Picard Interval List.\")\n     public File OUTPUT;\n \n-    @Argument(doc=\"Controls the naming of the resulting intervals. When true, each resulting interval will be named the concatenation of \" +\n-            \"the variant ID fields (if present), or 'interval-<number>' (if not) with a pipe '|' separator. \" +\n-            \"When false, only the first name will be used.\")\n-    public boolean CONCATENATE_IDS = false;\n+\n+    public enum VARIANT_ID_TYPES {\n+        CONCAT_ALL,\n+        USE_FIRST\n+    }\n+\n+    @Argument(doc=\"Controls the naming of the resulting intervals. When set to CONCAT_ALL (the default), each resulting \" +\n+            \"interval will be named the concatenation of the variant ID fields (if present), or 'interval-<number>' \" +\n+            \"(if not) with a pipe '|' separator. If set to USE_FIRST, only the first name will be used.\")\n+    public VARIANT_ID_TYPES VARIANT_ID_METHOD = VARIANT_ID_TYPES.CONCAT_ALL;\n+    public final boolean concatenate_ids = (VARIANT_ID_METHOD == VARIANT_ID_TYPES.CONCAT_ALL);", "originalCommit": "cd351944bde1a83c757616ee9ecb1e151caa83e3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "4193e26c0e539bae219ea5af4bc2715bdd800da4", "url": "https://github.com/broadinstitute/picard/commit/4193e26c0e539bae219ea5af4bc2715bdd800da4", "message": "responding to yossi's comments", "committedDate": "2020-07-09T19:34:25Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjQ4NjI2Nw==", "url": "https://github.com/broadinstitute/picard/pull/1456#discussion_r452486267", "bodyText": "too many new lines", "author": "yfarjoun", "createdAt": "2020-07-09T20:58:22Z", "path": "src/test/java/picard/vcf/VcfToIntervalListTest.java", "diffHunk": "@@ -48,12 +49,33 @@ public void testExcludingFiltered(\n         if (includeFiltered) {\n             arguments.add(VcfToIntervalList.INCLUDE_FILTERED_SHORT_NAME + \"=true\");\n         }\n+        if (useFirstID) {\n+            arguments.add(\"VARIANT_ID_METHOD=USE_FIRST\");\n+        } else {\n+            arguments.add(\"VARIANT_ID_METHOD=CONCAT_ALL\"); // this should be the default and unnecessary\n+        }\n         runPicardCommandLine(arguments);\n \n         Assert.assertTrue(outputFile.exists());\n \n         final List<Interval> intervals = IntervalList.fromFile(outputFile).getIntervals();\n \n         Assert.assertEquals(intervals.size(), expectedIntervalsSize);\n+\n+        if (useFirstID) {\n+            for (Interval interval : intervals) {\n+                Assert.assertFalse(interval.getName().contains(\"|\"));\n+            }\n+        } else {\n+            // make sure the one where two sites that should be concatenated into one interval were actually concatenated\n+            Assert.assertTrue(intervals.get(5).getName().contains(\"|\"));\n+", "originalCommit": "4193e26c0e539bae219ea5af4bc2715bdd800da4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzM4OTY5MQ==", "url": "https://github.com/broadinstitute/picard/pull/1456#discussion_r457389691", "bodyText": "still too many new lines", "author": "kachulis", "createdAt": "2020-07-20T13:36:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjQ4NjI2Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjQ4NjM3Mw==", "url": "https://github.com/broadinstitute/picard/pull/1456#discussion_r452486373", "bodyText": "remove comment?", "author": "yfarjoun", "createdAt": "2020-07-09T20:58:35Z", "path": "src/test/java/picard/vcf/VcfToIntervalListTest.java", "diffHunk": "@@ -48,12 +49,33 @@ public void testExcludingFiltered(\n         if (includeFiltered) {\n             arguments.add(VcfToIntervalList.INCLUDE_FILTERED_SHORT_NAME + \"=true\");\n         }\n+        if (useFirstID) {\n+            arguments.add(\"VARIANT_ID_METHOD=USE_FIRST\");\n+        } else {\n+            arguments.add(\"VARIANT_ID_METHOD=CONCAT_ALL\"); // this should be the default and unnecessary\n+        }\n         runPicardCommandLine(arguments);\n \n         Assert.assertTrue(outputFile.exists());\n \n         final List<Interval> intervals = IntervalList.fromFile(outputFile).getIntervals();\n \n         Assert.assertEquals(intervals.size(), expectedIntervalsSize);\n+\n+        if (useFirstID) {\n+            for (Interval interval : intervals) {\n+                Assert.assertFalse(interval.getName().contains(\"|\"));\n+            }\n+        } else {\n+            // make sure the one where two sites that should be concatenated into one interval were actually concatenated\n+            Assert.assertTrue(intervals.get(5).getName().contains(\"|\"));\n+\n+\n+        }\n+\n+\n+\n     }\n }\n+\n+// USE_FIRST", "originalCommit": "4193e26c0e539bae219ea5af4bc2715bdd800da4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "fd108292a7c3d4c06d068fb2d1285dc1ee94c37f", "url": "https://github.com/broadinstitute/picard/commit/fd108292a7c3d4c06d068fb2d1285dc1ee94c37f", "message": "responding to yossi", "committedDate": "2020-07-17T19:37:05Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjY1MjU2MQ==", "url": "https://github.com/broadinstitute/picard/pull/1456#discussion_r456652561", "bodyText": "No longer need to close out because try-with-resources", "author": "kachulis", "createdAt": "2020-07-17T20:11:24Z", "path": "src/main/java/picard/util/IntervalListToBed.java", "diffHunk": "@@ -69,24 +75,45 @@ protected int doWork() {\n         IOUtil.assertFileIsReadable(INPUT);\n         IOUtil.assertFileIsWritable(OUTPUT);\n \n-        IntervalList intervals = IntervalList.fromFile(INPUT);\n-        if (SORT) intervals = intervals.sorted();\n-\n-        try {\n-            final BufferedWriter out = IOUtil.openFileForBufferedWriting(OUTPUT);\n-            for (final Interval i : intervals) {\n-                final String strand = i.isNegativeStrand() ? \"-\" : \"+\";\n-                final List<?> fields = CollectionUtil.makeList(i.getContig(), i.getStart()-1, i.getEnd(), i.getName(), SCORE, strand);\n-                out.append(fields.stream().map(String::valueOf).collect(Collectors.joining(\"\\t\")));\n-                out.newLine();\n-            }\n+        try (final AbstractFeatureReader<Interval, LineIterator> intervalsReader = AbstractFeatureReader.getFeatureReader(INPUT.getPath(), new IntervalListCodec(), false);\n+             CloseableIterator<Interval> intervalsToUse = getSortedIntervals(intervalsReader);\n+             final BufferedWriter out = IOUtil.openFileForBufferedWriting(OUTPUT)) {\n+            intervalsToUse.stream().forEach(i -> generateOutput(i, out));\n \n             out.close();", "originalCommit": "fd108292a7c3d4c06d068fb2d1285dc1ee94c37f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzM4MDU2OA==", "url": "https://github.com/broadinstitute/picard/pull/1456#discussion_r457380568", "bodyText": "no longer needs \"TODO\" comment", "author": "kachulis", "createdAt": "2020-07-20T13:26:09Z", "path": "src/main/java/picard/vcf/VcfToIntervalList.java", "diffHunk": "@@ -83,11 +101,25 @@\n     protected int doWork() {\n         IOUtil.assertFileIsReadable(INPUT);\n         IOUtil.assertFileIsWritable(OUTPUT);\n+        final boolean concatenate_ids = (VARIANT_ID_METHOD == VARIANT_ID_TYPES.CONCAT_ALL); // TODO: move to doWork() section\n ", "originalCommit": "fd108292a7c3d4c06d068fb2d1285dc1ee94c37f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzM4NTQwMg==", "url": "https://github.com/broadinstitute/picard/pull/1456#discussion_r457385402", "bodyText": "unnecessary semicolon", "author": "kachulis", "createdAt": "2020-07-20T13:31:31Z", "path": "src/main/java/picard/vcf/VcfToIntervalList.java", "diffHunk": "@@ -83,11 +101,25 @@\n     protected int doWork() {\n         IOUtil.assertFileIsReadable(INPUT);\n         IOUtil.assertFileIsWritable(OUTPUT);\n+        final boolean concatenate_ids = (VARIANT_ID_METHOD == VARIANT_ID_TYPES.CONCAT_ALL); // TODO: move to doWork() section\n \n-        final IntervalList intervalList = VCFFileReader.fromVcf(INPUT, INCLUDE_FILTERED);\n+        try (VCFFileReader vcfReader = new VCFFileReader(INPUT.toPath(), false)) {\n+            final Iterator<Interval> samFileIterator = VCFFileReader.toIntervals(vcfReader, INCLUDE_FILTERED);\n+            try (IntervalListWriter writer = new IntervalListWriter(OUTPUT.toPath(), new SAMFileHeader(vcfReader.getFileHeader().getSequenceDictionary()))) {\n+                final IntervalList.IntervalMergerIterator mergingIterator =\n+                        new IntervalList.IntervalMergerIterator(samFileIterator, true, false, concatenate_ids);\n+                for (final Interval interval : new IterableAdapter<>(mergingIterator)){\n+                    writer.write(interval);\n+                }\n+            } catch (IOException e) {\n+                if(!OUTPUT.renameTo(new File(OUTPUT.getAbsolutePath() + \".incomplete\"))){\n+                    OUTPUT.delete();\n+                };", "originalCommit": "fd108292a7c3d4c06d068fb2d1285dc1ee94c37f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzM5MzU0Mg==", "url": "https://github.com/broadinstitute/picard/pull/1456#discussion_r457393542", "bodyText": "need to add this file, tests fail currently because doesn't exist in repo", "author": "kachulis", "createdAt": "2020-07-20T13:40:20Z", "path": "src/test/java/picard/util/IntervalListToBedTest.java", "diffHunk": "@@ -13,6 +13,7 @@\n public class IntervalListToBedTest {\n     private static final String TEST_DATA_DIR = \"testdata/picard/util/\";\n     private final File INTERVAL_LIST = new File(TEST_DATA_DIR, \"interval_list_to_bed_test.interval_list\");\n+    private final File UNSORTED_INTERVAL_LIST = new File(TEST_DATA_DIR, \"unsorted_interval_list_to_bed_test.interval_list\");", "originalCommit": "fd108292a7c3d4c06d068fb2d1285dc1ee94c37f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzcyODQ2MQ==", "url": "https://github.com/broadinstitute/picard/pull/1456#discussion_r457728461", "bodyText": "\ud83e\udd26\u200d\u2640\ufe0f", "author": "skwalker", "createdAt": "2020-07-20T22:31:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzM5MzU0Mg=="}], "type": "inlineReview"}, {"oid": "9a9434e07a839a8f6700eb1e2228fd77b26621ec", "url": "https://github.com/broadinstitute/picard/commit/9a9434e07a839a8f6700eb1e2228fd77b26621ec", "message": "responding to comments, adding test", "committedDate": "2020-07-20T22:53:43Z", "type": "commit"}, {"oid": "94f3ad919adfa60d7fd61a79ba76d77d04ccbee2", "url": "https://github.com/broadinstitute/picard/commit/94f3ad919adfa60d7fd61a79ba76d77d04ccbee2", "message": "Merge branch 'master' into yf_scale_vcfToIntervalList", "committedDate": "2020-08-11T16:24:18Z", "type": "commit"}]}