{"pr_number": 3163, "pr_title": "Adds Docker HEALTHCHECK to Kafka and adjusts for upstream /bin/sh change", "pr_createdAt": "2020-08-05T05:30:56Z", "pr_url": "https://github.com/openzipkin/zipkin/pull/3163", "timeline": [{"oid": "ca340c48c812c7a4b4d97b3dfa806e76a2d0f07f", "url": "https://github.com/openzipkin/zipkin/commit/ca340c48c812c7a4b4d97b3dfa806e76a2d0f07f", "message": "Adds Docker HEALTHCHECK to Kafka and adjusts for upstream /bin/sh change\n\nBefore, we were linking individual images /bin/sh to BusyBox. This change\nuses the upstream change here. Especially as it allows HEALTHCHECK to\nwork (HEALTHCHECK at Dockerfile level only works with /bin/sh)\n\nhttps://github.com/openzipkin/docker-jre-full/pull/20\n\nUsing this, we add a HEALTHCHECK for our test Kafka image based on a Gitter\ndiscussion.", "committedDate": "2020-08-05T05:27:24Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTQ4MjMxMA==", "url": "https://github.com/openzipkin/zipkin/pull/3163#discussion_r465482310", "bodyText": "we forgot to add this to our main image!", "author": "codefromthecrypt", "createdAt": "2020-08-05T05:31:16Z", "path": "docker/Dockerfile.release", "diffHunk": "@@ -108,4 +108,7 @@ USER zipkin\n \n EXPOSE 9410 9411\n \n-ENTRYPOINT [\"/busybox/sh\", \"run.sh\"]\n+# Same settings and rationale as Dockerfile (non-release)\n+HEALTHCHECK --interval=5s --start-period=30s --timeout=5s CMD wget -qO- http://127.0.0.1:9411/health &> /dev/null || exit 1", "originalCommit": "ca340c48c812c7a4b4d97b3dfa806e76a2d0f07f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTQ4NzgzMA==", "url": "https://github.com/openzipkin/zipkin/pull/3163#discussion_r465487830", "bodyText": "we don't need to bind host ports by default as it is especially confusing as only 19092 will work\nthe others are exposed directly by the Dockerfile so we don't need to re-declare expose here either.", "author": "codefromthecrypt", "createdAt": "2020-08-05T05:49:36Z", "path": "docker/examples/docker-compose-kafka.yml", "diffHunk": "@@ -29,10 +29,7 @@ services:\n     # environment:\n       # - KAFKA_ADVERTISED_HOST_NAME=192.168.99.100\n     ports:\n-      - 2181:2181", "originalCommit": "ca340c48c812c7a4b4d97b3dfa806e76a2d0f07f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTYzOTU2MQ==", "url": "https://github.com/openzipkin/zipkin/pull/3163#discussion_r465639561", "bodyText": "\ud83d\udc4d", "author": "jeqo", "createdAt": "2020-08-05T10:51:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTQ4NzgzMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTQ4ODE0OQ==", "url": "https://github.com/openzipkin/zipkin/pull/3163#discussion_r465488149", "bodyText": "this version is what allows health conditions (note: v3 does not!!)", "author": "codefromthecrypt", "createdAt": "2020-08-05T05:50:05Z", "path": "docker/examples/docker-compose-mem.yml", "diffHunk": "@@ -20,7 +20,7 @@\n #\n # Note that this file is meant for learning Zipkin, not production deployments.\n \n-version: '2'\n+version: '2.4'", "originalCommit": "ca340c48c812c7a4b4d97b3dfa806e76a2d0f07f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTY0MDI3NA==", "url": "https://github.com/openzipkin/zipkin/pull/3163#discussion_r465640274", "bodyText": "just in case, is there any docs confirming this (v3 not supporting healthchecks)? I wasn't able to find this restriction.", "author": "jeqo", "createdAt": "2020-08-05T10:52:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTQ4ODE0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTY2NjQ2Ng==", "url": "https://github.com/openzipkin/zipkin/pull/3163#discussion_r465666466", "bodyText": "I actually integrated this with a pinot image for test purposes, and it works in 2.x like so\n    depends_on:\n      kafka-zookeeper:\n        condition: service_healthy\nThe docs are very bad about this being removed, only mildly discusses it at the entrypoint of 'condition'\nhttps://docs.docker.com/compose/compose-file/#depends_on\n\nOptions for v3 are not incredible.. basically you have to use wait-for-it and duplicate the health check code of your upstream. I hope v2 lives forever", "author": "codefromthecrypt", "createdAt": "2020-08-05T11:42:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTQ4ODE0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTY3NTUwMg==", "url": "https://github.com/openzipkin/zipkin/pull/3163#discussion_r465675502", "bodyText": "make sense. thanks @adriancole !", "author": "jeqo", "createdAt": "2020-08-05T12:00:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTQ4ODE0OQ=="}], "type": "inlineReview"}, {"oid": "18879a1af6b8676909911f9880b1f8d5b2162eda", "url": "https://github.com/openzipkin/zipkin/commit/18879a1af6b8676909911f9880b1f8d5b2162eda", "message": "license", "committedDate": "2020-08-05T07:14:47Z", "type": "commit"}, {"oid": "1edccdb44585d07344cdf451fb4e27aa0caf91d2", "url": "https://github.com/openzipkin/zipkin/commit/1edccdb44585d07344cdf451fb4e27aa0caf91d2", "message": "fix zipkin entrypoints", "committedDate": "2020-08-05T08:18:05Z", "type": "commit"}, {"oid": "48bca925febc2eca74eb1051484ec5ab8fd95afe", "url": "https://github.com/openzipkin/zipkin/commit/48bca925febc2eca74eb1051484ec5ab8fd95afe", "message": "license", "committedDate": "2020-08-05T08:45:21Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTYzODE3MA==", "url": "https://github.com/openzipkin/zipkin/pull/3163#discussion_r465638170", "bodyText": "nit: typo\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n             * to allow manual allows usage of the docker-compose v2 service_healthy condition\n          \n          \n            \n             * to allow manual usage of the docker-compose v2 service_healthy condition", "author": "jeqo", "createdAt": "2020-08-05T10:48:42Z", "path": "docker/RATIONALE.md", "diffHunk": "@@ -0,0 +1,17 @@\n+# zipkin-docker rationale\n+\n+## Why do we add HEALTHCHECK for test images?\n+\n+While most of our images are not production, we still add HEALTHCHECK for a better ad-hoc\n+and automation experience. Many of our setups will not operate without a service\n+dependency: having HEALTHCHECK present makes triage and scripting a bit easier.\n+\n+HEALTHCHECK on our test image serves primarily two purposes:\n+ * ad-hoc or scripted status of health using docker ps instead of knowing Kafka commands\n+ * to allow manual allows usage of the docker-compose v2 service_healthy condition", "originalCommit": "48bca925febc2eca74eb1051484ec5ab8fd95afe", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTY2NzE3Ng==", "url": "https://github.com/openzipkin/zipkin/pull/3163#discussion_r465667176", "bodyText": "thanks @jeqo! 421d8d6", "author": "codefromthecrypt", "createdAt": "2020-08-05T11:44:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTYzODE3MA=="}], "type": "inlineReview"}]}