{"pr_number": 3243, "pr_title": "Refactors Cassandra queries so they are cheaper and easier to migrate", "pr_createdAt": "2020-10-17T12:10:00Z", "pr_url": "https://github.com/openzipkin/zipkin/pull/3243", "timeline": [{"oid": "e82aad36846ed1d17e0405961763eecb23593dfb", "url": "https://github.com/openzipkin/zipkin/commit/e82aad36846ed1d17e0405961763eecb23593dfb", "message": "Refactors Cassandra queries so they are cheaper and easier to migrate\n\nBefore, we used labels a lot, and generally a lot of query builder code.\nThis switches most to positional syntax, which is cheaper and easier to\nmigrate to cassandra driver 4.\n\nThis also reformats everything to make the migration feel like less\nchange.\n\nFinally, this consolidates as much code as possible, notably repetitive\ninserts and queries, again to reduce the heft needed to upgrade later.", "committedDate": "2020-10-17T12:06:12Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjkzNjk3Mg==", "url": "https://github.com/openzipkin/zipkin/pull/3243#discussion_r506936972", "bodyText": "you'll notice constants like this around. we had assigned them via variables before, this is just a bit more obvious.", "author": "codefromthecrypt", "createdAt": "2020-10-17T12:11:27Z", "path": "zipkin-storage/cassandra-v1/src/main/java/zipkin2/storage/cassandra/v1/SelectRemoteServiceNames.java", "diffHunk": "@@ -17,33 +17,35 @@\n import com.datastax.driver.core.ResultSet;\n import com.datastax.driver.core.ResultSetFuture;\n import com.datastax.driver.core.Session;\n-import com.datastax.driver.core.querybuilder.QueryBuilder;\n import java.util.List;\n import java.util.Locale;\n import zipkin2.Call;\n import zipkin2.storage.cassandra.internal.call.DistinctSortedStrings;\n import zipkin2.storage.cassandra.internal.call.ResultSetFutureCall;\n \n+import static com.datastax.driver.core.querybuilder.QueryBuilder.bindMarker;\n+import static com.datastax.driver.core.querybuilder.QueryBuilder.eq;\n+import static com.datastax.driver.core.querybuilder.QueryBuilder.select;\n+import static zipkin2.storage.cassandra.v1.Tables.REMOTE_SERVICE_NAMES;\n+\n final class SelectRemoteServiceNames extends ResultSetFutureCall<ResultSet> {\n \n-  static class Factory {\n+  static final class Factory {\n     final Session session;\n     final PreparedStatement preparedStatement;\n-    final DistinctSortedStrings remoteServiceNames =\n-      new DistinctSortedStrings(\"remote_service_name\");\n \n     Factory(Session session) {\n       this.session = session;\n-      this.preparedStatement = session.prepare(QueryBuilder.select(\"remote_service_name\")\n-        .from(Tables.REMOTE_SERVICE_NAMES)\n-        .where(QueryBuilder.eq(\"service_name\", QueryBuilder.bindMarker(\"service_name\")))\n-        .limit(QueryBuilder.bindMarker(\"limit_\")));\n+      this.preparedStatement =\n+        session.prepare(select(\"remote_service_name\").from(REMOTE_SERVICE_NAMES)\n+          .where(eq(\"service_name\", bindMarker()))\n+          .limit(1000));", "originalCommit": "e82aad36846ed1d17e0405961763eecb23593dfb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjkzNzA3MQ==", "url": "https://github.com/openzipkin/zipkin/pull/3243#discussion_r506937071", "bodyText": "both of these complicated sharing and testing for things that were constant in practice. The timestamp codec has not difference based on version, and bucketCount was always set to 10 with no means to override it ever. since this is a legacy codebase I think being more obvious about constants is better than looking as if we had really parameterized them.", "author": "codefromthecrypt", "createdAt": "2020-10-17T12:12:54Z", "path": "zipkin-storage/cassandra-v1/src/main/java/zipkin2/storage/cassandra/v1/CassandraSpanStore.java", "diffHunk": "@@ -67,8 +64,6 @@\n     indexFetchMultiplier = storage.indexFetchMultiplier;\n     strictTraceId = storage.strictTraceId;\n     searchEnabled = storage.searchEnabled;\n-    timestampCodec = new TimestampCodec(metadata.protocolVersion);\n-    buckets = IntStream.range(0, storage.bucketCount).boxed().collect(Collectors.toSet());", "originalCommit": "e82aad36846ed1d17e0405961763eecb23593dfb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjkzNzE0NA==", "url": "https://github.com/openzipkin/zipkin/pull/3243#discussion_r506937144", "bodyText": "this is mostly lifted from cassandra v1s (the common things)", "author": "codefromthecrypt", "createdAt": "2020-10-17T12:13:49Z", "path": "zipkin-storage/cassandra/src/main/java/zipkin2/storage/cassandra/internal/CassandraStorageBuilder.java", "diffHunk": "@@ -0,0 +1,166 @@\n+/*\n+ * Copyright 2015-2020 The OpenZipkin Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except\n+ * in compliance with the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License\n+ * is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express\n+ * or implied. See the License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+package zipkin2.storage.cassandra.internal;\n+\n+import com.datastax.driver.core.HostDistance;\n+import com.datastax.driver.core.PoolingOptions;\n+import java.util.Collections;\n+import java.util.LinkedHashSet;\n+import java.util.List;\n+import java.util.Set;\n+import java.util.concurrent.TimeUnit;\n+import zipkin2.internal.Nullable;\n+import zipkin2.storage.QueryRequest;\n+import zipkin2.storage.StorageComponent;\n+\n+public abstract class CassandraStorageBuilder<B extends CassandraStorageBuilder<B>>", "originalCommit": "e82aad36846ed1d17e0405961763eecb23593dfb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjkzNzE3OA==", "url": "https://github.com/openzipkin/zipkin/pull/3243#discussion_r506937178", "bodyText": "this was lifted to avoid copy/pasta between new and old cassandra. especially this code is different in v4 and annoying to do twice.", "author": "codefromthecrypt", "createdAt": "2020-10-17T12:14:24Z", "path": "zipkin-storage/cassandra/src/main/java/zipkin2/storage/cassandra/internal/SessionBuilder.java", "diffHunk": "@@ -0,0 +1,113 @@\n+/*\n+ * Copyright 2015-2020 The OpenZipkin Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except\n+ * in compliance with the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License\n+ * is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express\n+ * or implied. See the License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+package zipkin2.storage.cassandra.internal;\n+\n+import com.datastax.driver.core.AuthProvider;\n+import com.datastax.driver.core.Cluster;\n+import com.datastax.driver.core.ConsistencyLevel;\n+import com.datastax.driver.core.PoolingOptions;\n+import com.datastax.driver.core.QueryLogger;\n+import com.datastax.driver.core.QueryOptions;\n+import com.datastax.driver.core.Session;\n+import com.datastax.driver.core.policies.DCAwareRoundRobinPolicy;\n+import com.datastax.driver.core.policies.LatencyAwarePolicy;\n+import com.datastax.driver.core.policies.RoundRobinPolicy;\n+import com.datastax.driver.core.policies.TokenAwarePolicy;\n+import java.net.InetSocketAddress;\n+import java.util.ArrayList;\n+import java.util.LinkedHashSet;\n+import java.util.List;\n+import java.util.Set;\n+import zipkin2.internal.Nullable;\n+\n+import static zipkin2.Call.propagateIfFatal;\n+\n+public final class SessionBuilder {", "originalCommit": "e82aad36846ed1d17e0405961763eecb23593dfb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "5119fd919b6804a0dd014d21ff94812047c756bc", "url": "https://github.com/openzipkin/zipkin/commit/5119fd919b6804a0dd014d21ff94812047c756bc", "message": "whoops forgot server tests", "committedDate": "2020-10-17T12:20:26Z", "type": "commit"}, {"oid": "d5ff2adaacb7f9ec8e7b1a7577f68d74d908f434", "url": "https://github.com/openzipkin/zipkin/commit/d5ff2adaacb7f9ec8e7b1a7577f68d74d908f434", "message": "reflection drift", "committedDate": "2020-10-17T14:17:20Z", "type": "commit"}]}