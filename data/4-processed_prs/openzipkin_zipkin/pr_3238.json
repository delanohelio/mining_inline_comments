{"pr_number": 3238, "pr_title": "Finishes Docker refactoring", "pr_createdAt": "2020-10-15T06:43:00Z", "pr_url": "https://github.com/openzipkin/zipkin/pull/3238", "timeline": [{"oid": "4ce2ebca7b09ee33e4c16012c772e42c177dcb76", "url": "https://github.com/openzipkin/zipkin/commit/4ce2ebca7b09ee33e4c16012c772e42c177dcb76", "message": "Finishes Docker refactoring\n\nThis does several things of importance around Docker:\n\n* Makes default heap for 'mem' 128m, slim 32m and otherwise 64m\n  * We now use `-XX:+ExitOnOutOfMemoryError` instead of letting the process live on OOM\n  * Before, memory was unbounded\n* Consolidates zipkin production images similar to zipkin-dependencies:\n  * See https://github.com/openzipkin/zipkin-dependencies/pull/181\n  * This means no duplicated Dockerfile\n* Removes detection of legacy docker links and associated profiles\n  * these were added for an old docker-compose setup\n  * added a README example for the ancient\n* Makes ENTRYPOINT and HEALTHCHECK like other images\n* Changes example to suggest applying logging via `command` not `JAVA_OPTS`\n* Switches docker-compose examples to use imports\n* Adds docker-compose-example.xml\n* Consolidates RATIONALE", "committedDate": "2020-10-15T06:41:09Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTIxMjUwMA==", "url": "https://github.com/openzipkin/zipkin/pull/3238#discussion_r505212500", "bodyText": "I ran curl in a for loop with the example app. it never died on OOM", "author": "codefromthecrypt", "createdAt": "2020-10-15T06:43:52Z", "path": "docker/docker-bin/start-zipkin", "diffHunk": "@@ -0,0 +1,37 @@\n+#!/bin/sh\n+#\n+# Copyright 2015-2020 The OpenZipkin Authors\n+#\n+# Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except\n+# in compliance with the License. You may obtain a copy of the License at\n+#\n+# http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software distributed under the License\n+# is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express\n+# or implied. See the License for the specific language governing permissions and limitations under\n+# the License.\n+#\n+\n+# ENTRYPOINT script that starts Zipkin\n+set -eu\n+\n+STORAGE_TYPE=${STORAGE_TYPE:-mem}\n+\n+if [ \"${STORAGE_TYPE}\" = \"mem\" ]; then\n+  # When using in-memory provider, allocate 128m, most of which for trace storage\n+  JAVA_OPTS=${JAVA_OPTS:-\"-Xms128m -Xmx128m -XX:+ExitOnOutOfMemoryError\"}", "originalCommit": "4ce2ebca7b09ee33e4c16012c772e42c177dcb76", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTIxMjg4OA==", "url": "https://github.com/openzipkin/zipkin/pull/3238#discussion_r505212888", "bodyText": "new example", "author": "codefromthecrypt", "createdAt": "2020-10-15T06:44:10Z", "path": "docker/examples/README.md", "diffHunk": "@@ -74,6 +72,22 @@ In other words, if you are running a sample application on your laptop, you woul\n If you are using Docker machine, adjust `KAFKA_ADVERTISED_HOST_NAME` in `docker-compose-kafka.yml`\n and the `bootstrapServers` configuration of the kafka sender to match your Docker host IP (ex. 192.168.99.100:19092).\n \n+# Example\n+\n+The docker-compose configuration can be extended to host an [example application](https://github.com/openzipkin/brave-example)", "originalCommit": "4ce2ebca7b09ee33e4c16012c772e42c177dcb76", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTIxMzYwNA==", "url": "https://github.com/openzipkin/zipkin/pull/3238#discussion_r505213604", "bodyText": "moved prometheus to a separate file", "author": "codefromthecrypt", "createdAt": "2020-10-15T06:44:47Z", "path": "docker/examples/docker-compose-prometheus.yml", "diffHunk": "@@ -15,28 +15,39 @@\n # This file uses the version 2 docker-compose file format, described here:\n # https://docs.docker.com/compose/compose-file/#version-2\n #\n-# This runs the zipkin and zipkin-mysql containers, using docker-compose's\n-# default networking to wire the containers together.\n+# This runs containers that collect data for our Grafana dashboard", "originalCommit": "4ce2ebca7b09ee33e4c16012c772e42c177dcb76", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTIxNDAzMw==", "url": "https://github.com/openzipkin/zipkin/pull/3238#discussion_r505214033", "bodyText": "default docker-compose is slim+mem now (not mysql)", "author": "codefromthecrypt", "createdAt": "2020-10-15T06:45:10Z", "path": "docker/examples/docker-compose.yml", "diffHunk": "@@ -15,92 +15,31 @@\n # This file uses the version 2 docker-compose file format, described here:\n # https://docs.docker.com/compose/compose-file/#version-2\n #\n-# This runs the zipkin and zipkin-mysql containers, using docker-compose's\n-# default networking to wire the containers together.\n+# This runs the zipkin slim container, using docker-compose's default networking\n+# to wire other containers together.\n #\n # Note that this file is meant for learning Zipkin, not production deployments.\n \n version: '2.4'\n \n services:\n-  storage:\n-    image: openzipkin/zipkin-mysql\n-    container_name: mysql\n-    # Uncomment to expose the storage port for testing\n-    # ports:\n-    #   - 3306:3306\n-\n   # The zipkin process services the UI, and also exposes a POST endpoint that\n-  # instrumentation can send trace data to. Scribe is disabled by default.\n+  # instrumentation can send trace data to.\n   zipkin:\n-    image: openzipkin/zipkin\n+    image: openzipkin/zipkin-slim:${TAG:-latest}", "originalCommit": "4ce2ebca7b09ee33e4c16012c772e42c177dcb76", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTIxNDUzNg==", "url": "https://github.com/openzipkin/zipkin/pull/3238#discussion_r505214536", "bodyText": "need to update docker hub automated builds as Dockerfile.release is gone now.", "author": "codefromthecrypt", "createdAt": "2020-10-15T06:45:35Z", "path": "docker/hooks/build", "diffHunk": "@@ -25,7 +25,18 @@ cd ..\n \n echo \"Building images for $SOURCE_BRANCH\"\n \n-docker build --build-arg source_branch=${SOURCE_BRANCH} -f \"$DOCKERFILE_PATH\" -t \"$IMAGE_NAME\" .\n+echo \"Building images for $SOURCE_BRANCH\"\n+\n+# $SOURCE_BRANCH is something like\n+#\n+#   master       - Building the master branch. This cut command will return 'master', and Dockerfiles will ignore it\n+#   1.0.1        - Building a release image along with a new Zipkin server version. This cut command will return\n+#                  '1.0.1' and Dockerfiles will use it to fetch the correct version of Zipkin.\n+#   docker-1.0.1 - Building a release image, but not a new Zipkin server. This cut command will return\n+#                  '1.0.1' and Dockerfiles will use it to fetch the correct version of Zipkin.\n+RELEASE_VERSION=\"$(echo \"${SOURCE_BRANCH}\" | cut -d '-' -f 2)\"\n+\n+docker build --build-arg RELEASE_VERSION=\"$RELEASE_VERSION\" -f \"$DOCKERFILE_PATH\" -t \"$IMAGE_NAME\" .", "originalCommit": "4ce2ebca7b09ee33e4c16012c772e42c177dcb76", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "af6341e95c9dccda981ae007ad5cb446ff5c5228", "url": "https://github.com/openzipkin/zipkin/commit/af6341e95c9dccda981ae007ad5cb446ff5c5228", "message": "unneeded", "committedDate": "2020-10-15T06:50:14Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTIyNzgwNg==", "url": "https://github.com/openzipkin/zipkin/pull/3238#discussion_r505227806", "bodyText": "consider  mvn -T1C -q --batch-mode -DskipTests -Dlicense.skip=true --also-make -pl zipkin-server package for parallel builds.", "author": "jorgheymans", "createdAt": "2020-10-15T06:56:44Z", "path": "docker/install.sh", "diffHunk": "@@ -0,0 +1,46 @@\n+#!/bin/sh\n+#\n+# Copyright 2016-2020 The OpenZipkin Authors\n+#\n+# Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except\n+# in compliance with the License. You may obtain a copy of the License at\n+#\n+# http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software distributed under the License\n+# is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express\n+# or implied. See the License for the specific language governing permissions and limitations under\n+# the License.\n+#\n+\n+set -eux\n+\n+# This script decides based on $RELEASE_VERSION whether to build or download the binaries we need.\n+if [ \"$RELEASE_VERSION\" = \"master\" ]\n+then\n+  echo \"*** Building from source...\"\n+  # Use the same command as we suggest in zipkin-server/README.md\n+  #  * Uses mvn not ./mvnw to reduce layer size: we control the Maven version in Docker\n+  (cd /code; mvn -q --batch-mode -DskipTests -Dlicense.skip=true --also-make -pl zipkin-server package)", "originalCommit": "af6341e95c9dccda981ae007ad5cb446ff5c5228", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTI4NTk1Mw==", "url": "https://github.com/openzipkin/zipkin/pull/3238#discussion_r505285953", "bodyText": "sure. trying now. thanks for the tip", "author": "codefromthecrypt", "createdAt": "2020-10-15T07:46:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTIyNzgwNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTMwNjc1Mw==", "url": "https://github.com/openzipkin/zipkin/pull/3238#discussion_r505306753", "bodyText": "significantly faster thanks!", "author": "codefromthecrypt", "createdAt": "2020-10-15T08:03:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTIyNzgwNg=="}], "type": "inlineReview"}, {"oid": "8333cd1f4eb267e74f944b0aca67e881c9425235", "url": "https://github.com/openzipkin/zipkin/commit/8333cd1f4eb267e74f944b0aca67e881c9425235", "message": "faster more healthy", "committedDate": "2020-10-15T08:05:33Z", "type": "commit"}, {"oid": "74ebf8da2e884363c4b5852b68c15ca797f8274c", "url": "https://github.com/openzipkin/zipkin/commit/74ebf8da2e884363c4b5852b68c15ca797f8274c", "message": "missed a spot", "committedDate": "2020-10-15T08:08:15Z", "type": "commit"}, {"oid": "cc91ccb3b95f7939fd9c324d266c03cec6770b08", "url": "https://github.com/openzipkin/zipkin/commit/cc91ccb3b95f7939fd9c324d266c03cec6770b08", "message": "whoops", "committedDate": "2020-10-15T08:26:52Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTMzOTM0Mw==", "url": "https://github.com/openzipkin/zipkin/pull/3238#discussion_r505339343", "bodyText": "just curious about the reason for this change.", "author": "jcchavezs", "createdAt": "2020-10-15T08:32:31Z", "path": "docker/Dockerfile", "diffHunk": "@@ -49,79 +44,64 @@ RUN mvn -q --batch-mode -DskipTests -Dlicense.skip=true --also-make -pl zipkin-s\n # cache between builds.\n FROM openzipkin/java:${java_version} as zipkin-builder\n \n-COPY --from=built /root/.m2 /root/.m2\n-COPY --from=built /root/.npm /root/.npm\n+COPY --from=install /root/.m2 /root/.m2\n+COPY --from=install /root/.npm /root/.npm\n \n #####\n # zipkin-ui - An image containing the Zipkin web frontend only, served by NGINX\n #####\n \n FROM nginx:1.18-alpine as zipkin-ui\n-LABEL MAINTAINER Zipkin \"https://zipkin.io/\"\n+LABEL MAINTAINER OpenZipkin \"http://zipkin.io/\"", "originalCommit": "cc91ccb3b95f7939fd9c324d266c03cec6770b08", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTM3NDkzNQ==", "url": "https://github.com/openzipkin/zipkin/pull/3238#discussion_r505374935", "bodyText": "consistent with other images and project files. I noticed it was different", "author": "codefromthecrypt", "createdAt": "2020-10-15T09:02:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTMzOTM0Mw=="}], "type": "inlineReview"}, {"oid": "d46d3767ed82fba1bb2a40d739173a2a42f5fe92", "url": "https://github.com/openzipkin/zipkin/commit/d46d3767ed82fba1bb2a40d739173a2a42f5fe92", "message": "drift", "committedDate": "2020-10-15T08:32:44Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTM0MDkyMA==", "url": "https://github.com/openzipkin/zipkin/pull/3238#discussion_r505340920", "bodyText": "I think this depends on your resources but still valuable info so I am not sure on how to improve it.", "author": "jcchavezs", "createdAt": "2020-10-15T08:34:12Z", "path": "docker/RATIONALE.md", "diffHunk": "@@ -1,21 +1,43 @@\n # zipkin-docker rationale\n \n-## Why do we add HEALTHCHECK for test images?\n-\n+## Why do we add HEALTHCHECK?\n While most of our images are not production, we still add HEALTHCHECK for a better ad-hoc\n and automation experience. Many of our setups will not operate without a service\n dependency: having HEALTHCHECK present makes triage and scripting a bit easier.\n \n-HEALTHCHECK on our test image serves primarily two purposes:\n+HEALTHCHECK on our test image serves primarily three purposes:\n  * ad-hoc or scripted status of health using docker ps instead of knowing Kafka commands\n  * to allow manual usage of the docker-compose v2 service_healthy condition\n+ * support Docker Hub automated test service\n \n Ex. The following command can be used ad-hoc or in scripts without the user knowing Kafka:\n ```bash\n $ docker inspect --format='{{json .State.Health.Status}}' kafka-zookeeper\n \"unhealthy\"\n ```\n \n+### Why do we change default timeouts?\n+We changed timeouts in order to mark success faster.\n+\n+By default, the Docker health check runs after 30s, and if a failure occurs,\n+it waits 30s to try again. This implies a minimum of 30s before the server is\n+marked healthy.\n+\n+https://docs.docker.com/engine/reference/builder/#healthcheck\n+\n+We expect the server startup to take less than 10 seconds, even in a fresh", "originalCommit": "cc91ccb3b95f7939fd9c324d266c03cec6770b08", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "c83a8cb0eeaef396008ab76b5accf9a13e2f4abd", "url": "https://github.com/openzipkin/zipkin/commit/c83a8cb0eeaef396008ab76b5accf9a13e2f4abd", "message": "typo", "committedDate": "2020-10-15T09:05:35Z", "type": "commit"}, {"oid": "aa7f8cdad57e5c9fe87b4447302ec759d974c86d", "url": "https://github.com/openzipkin/zipkin/commit/aa7f8cdad57e5c9fe87b4447302ec759d974c86d", "message": "fail faster better stronger", "committedDate": "2020-10-15T10:36:29Z", "type": "commit"}, {"oid": "932c076e825e6b01ebb00a553adbec88bbb05899", "url": "https://github.com/openzipkin/zipkin/commit/932c076e825e6b01ebb00a553adbec88bbb05899", "message": "done me thinks", "committedDate": "2020-10-15T11:20:06Z", "type": "commit"}, {"oid": "9656062b83bd650e60e8d0df7ebdf1730faf96d5", "url": "https://github.com/openzipkin/zipkin/commit/9656062b83bd650e60e8d0df7ebdf1730faf96d5", "message": "switches to github actions for testing images", "committedDate": "2020-10-15T12:01:29Z", "type": "commit"}, {"oid": "2a3aa45138dd10184787f99a69e552ca17afd0a2", "url": "https://github.com/openzipkin/zipkin/commit/2a3aa45138dd10184787f99a69e552ca17afd0a2", "message": "tries dynamic targets", "committedDate": "2020-10-16T01:28:28Z", "type": "commit"}, {"oid": "22f186212f1671a4e30e7822dfeb59090cb5c9d0", "url": "https://github.com/openzipkin/zipkin/commit/22f186212f1671a4e30e7822dfeb59090cb5c9d0", "message": "typo", "committedDate": "2020-10-16T01:32:14Z", "type": "commit"}, {"oid": "3b85920ad0b5e3f4f9914d7b89c9610a0f207e62", "url": "https://github.com/openzipkin/zipkin/commit/3b85920ad0b5e3f4f9914d7b89c9610a0f207e62", "message": "moar typo", "committedDate": "2020-10-16T01:48:38Z", "type": "commit"}, {"oid": "9005332867271a7091a7ebaafe7869d8bfdb5614", "url": "https://github.com/openzipkin/zipkin/commit/9005332867271a7091a7ebaafe7869d8bfdb5614", "message": "Fixes zipkin-ui healthcheck", "committedDate": "2020-10-16T03:17:06Z", "type": "commit"}, {"oid": "54dc6c6102502c9faa525b6f42882eed0853c3c0", "url": "https://github.com/openzipkin/zipkin/commit/54dc6c6102502c9faa525b6f42882eed0853c3c0", "message": "Removes flakey apt repos", "committedDate": "2020-10-16T03:54:16Z", "type": "commit"}, {"oid": "5785e20c71fb83ee7bfafb14a0e0d6809fba7381", "url": "https://github.com/openzipkin/zipkin/commit/5785e20c71fb83ee7bfafb14a0e0d6809fba7381", "message": "redundant", "committedDate": "2020-10-16T03:56:54Z", "type": "commit"}, {"oid": "9f13e1cd8737e78abfc6580e5296633ae819ba95", "url": "https://github.com/openzipkin/zipkin/commit/9f13e1cd8737e78abfc6580e5296633ae819ba95", "message": "typo", "committedDate": "2020-10-16T03:58:52Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjA0MDM5NQ==", "url": "https://github.com/openzipkin/zipkin/pull/3238#discussion_r506040395", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                      if [ \"${{ matrix.target }}\" = \"openzipkin/zipkin-ui\" ]; then\n          \n          \n            \n                      if [ \"${{ matrix.target }}\" = \"zipkin-ui\" ]; then", "author": "codefromthecrypt", "createdAt": "2020-10-16T04:09:42Z", "path": ".github/workflows/docker-tests.yml", "diffHunk": "@@ -0,0 +1,63 @@\n+name: Continuous Build Docker\n+on:\n+  push:\n+    branches:\n+      - master\n+  pull_request:\n+    branches:\n+      - master\n+\n+jobs:\n+  discover-targets:\n+    name: Build target matrix\n+    runs-on: ubuntu-latest\n+    outputs:\n+      matrix: ${{ steps.set-matrix.outputs.matrix }}\n+    steps:\n+      - name: Checkout Sources\n+        uses: actions/checkout@v2\n+        with:\n+          fetch-depth: 1\n+      - id: set-matrix\n+        name: Generate outputs.matrix from pom.xml listing\n+        run: echo \"::set-output name=matrix::{\\\"include\\\":$(.github/workflows/targets-as-json)}\"\n+  build-and-verify-docker:\n+    name: Build and verify Docker images\n+    needs: discover-targets\n+    runs-on: ubuntu-latest\n+    strategy:\n+      matrix: ${{ fromJson(needs.discover-targets.outputs.matrix) }}\n+    steps:\n+      # Remove apt repos that are known to break from time to time.\n+      # See https://github.com/actions/virtual-environments/issues/323\n+      - name: Remove broken apt repos\n+        run: |\n+          for apt_file in `grep -lr microsoft /etc/apt/sources.list.d/`; do sudo rm $apt_file; done\n+      - name: Install Docker\n+        uses: docker-practice/actions-setup-docker@master\n+        with:\n+          docker_version: 19.03\n+      - name: Cache docker\n+        uses: actions/cache@v1\n+        with:\n+          path: ~/.docker\n+          key: ${{ runner.os }}-docker-${{ hashFiles('**/Dockerfile') }}\n+          restore-keys: ${{ runner.os }}-docker\n+      - name: Checkout Repository\n+        uses: actions/checkout@v2\n+        with:\n+          fetch-depth: 1\n+      - name: Build Docker image openzipkin/${{ matrix.target }}:test\n+        run:  docker/build_image ${{ matrix.target }}\n+      - name: Verify Docker image openzipkin/${{ matrix.target }}:test\n+        run: |\n+          # This just makes sure containers run and the HEALTHCHECK works (for now..)\n+          touch docker-sut.env\n+          if [ \"${{ matrix.target }}\" = \"openzipkin/zipkin-ui\" ]; then", "originalCommit": "9f13e1cd8737e78abfc6580e5296633ae819ba95", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "1bf2d2433ec20404104d6d6de1f37e2680d3677b", "url": "https://github.com/openzipkin/zipkin/commit/1bf2d2433ec20404104d6d6de1f37e2680d3677b", "message": "typo", "committedDate": "2020-10-16T04:09:50Z", "type": "commit"}, {"oid": "6ec3a33f2b64cd5facab9e1477477f2c40105cee", "url": "https://github.com/openzipkin/zipkin/commit/6ec3a33f2b64cd5facab9e1477477f2c40105cee", "message": "just use last build of slim", "committedDate": "2020-10-16T04:44:04Z", "type": "commit"}, {"oid": "6b8dc7713a98968af2340317ba745a5f8b80dd76", "url": "https://github.com/openzipkin/zipkin/commit/6b8dc7713a98968af2340317ba745a5f8b80dd76", "message": "switch to compose", "committedDate": "2020-10-16T05:05:38Z", "type": "commit"}, {"oid": "9d1b1f64afbd13a1776ce683e9a332e11bf0d352", "url": "https://github.com/openzipkin/zipkin/commit/9d1b1f64afbd13a1776ce683e9a332e11bf0d352", "message": "less output and correct syntax", "committedDate": "2020-10-16T05:37:46Z", "type": "commit"}]}