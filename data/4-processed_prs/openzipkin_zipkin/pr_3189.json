{"pr_number": 3189, "pr_title": "Polishes Kafka Docker image more", "pr_createdAt": "2020-08-25T01:55:26Z", "pr_url": "https://github.com/openzipkin/zipkin/pull/3189", "timeline": [{"oid": "6ed87e6cd86c9e8e5769910497d894cd39f97e46", "url": "https://github.com/openzipkin/zipkin/commit/6ed87e6cd86c9e8e5769910497d894cd39f97e46", "message": "Polishes Kafka Docker image more\n\nThis primarily mentions why relative dir is in use (to make it easy to change).", "committedDate": "2020-08-25T01:54:26Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjA1NzEwNg==", "url": "https://github.com/openzipkin/zipkin/pull/3189#discussion_r476057106", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            # All Kafka content including binaries logs writes under WORKDIR\n          \n          \n            \n            # All Kafka content including binaries and logs write under WORKDIR", "author": "codefromthecrypt", "createdAt": "2020-08-25T01:55:55Z", "path": "docker/collector/kafka/Dockerfile", "diffHunk": "@@ -26,17 +25,19 @@ RUN /tmp/install && rm /tmp/install\n FROM openzipkin/jre-full:14.0.2-14.29.23\n LABEL MAINTAINER Zipkin \"https://zipkin.io/\"\n \n-# add HEALTHCHECK and ENTRYPOINT scripts\n+# Add HEALTHCHECK and ENTRYPOINT scripts\n COPY docker/collector/kafka/docker-bin/* /usr/local/bin/\n \n-# setup non-root user and its home dir\n+# All Kafka content including binaries logs writes under WORKDIR", "originalCommit": "6ed87e6cd86c9e8e5769910497d894cd39f97e46", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "01758f6193fc2904736f53b5a10dbf8256edcdaa", "url": "https://github.com/openzipkin/zipkin/commit/01758f6193fc2904736f53b5a10dbf8256edcdaa", "message": "Update docker/collector/kafka/Dockerfile", "committedDate": "2020-08-25T01:56:00Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjA1NzU1Mg==", "url": "https://github.com/openzipkin/zipkin/pull/3189#discussion_r476057552", "bodyText": "note: the workdir is now decoupled from the convention", "author": "codefromthecrypt", "createdAt": "2020-08-25T01:56:36Z", "path": "docker/collector/kafka/Dockerfile", "diffHunk": "@@ -26,17 +25,19 @@ RUN /tmp/install && rm /tmp/install\n FROM openzipkin/jre-full:14.0.2-14.29.23\n LABEL MAINTAINER Zipkin \"https://zipkin.io/\"\n \n-# add HEALTHCHECK and ENTRYPOINT scripts\n+# Add HEALTHCHECK and ENTRYPOINT scripts\n COPY docker/collector/kafka/docker-bin/* /usr/local/bin/\n \n-# setup non-root user and its home dir\n+# All Kafka content including binaries and logs write under WORKDIR\n+WORKDIR /kafka\n+\n+# Ensure the process doesn't run as root\n ARG USER=kafka\n-WORKDIR /${USER}\n-RUN adduser -g '' -h /${USER} -D ${USER}", "originalCommit": "01758f6193fc2904736f53b5a10dbf8256edcdaa", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjA1NzgxOQ==", "url": "https://github.com/openzipkin/zipkin/pull/3189#discussion_r476057819", "bodyText": "clears a minor log warning", "author": "codefromthecrypt", "createdAt": "2020-08-25T01:56:58Z", "path": "docker/collector/kafka/docker-bin/docker-entrypoint", "diffHunk": "@@ -14,10 +14,13 @@\n #\n \n # ENTRYPOINT script that starts ZooKeeper and then Kafka\n+#\n+# This intentionally locates config using the current working directory, in order to consolidate\n+# Dockerfile instructions to WORKDIR\n set -eu\n \n echo Starting ZooKeeper\n-bin/kafka-run-class.sh -Dlog4j.configuration=file:config/log4j.properties org.apache.zookeeper.server.quorum.QuorumPeerMain config/zookeeper.properties &\n+bin/kafka-run-class.sh -Dlog4j.configuration=file:./config/log4j.properties org.apache.zookeeper.server.quorum.QuorumPeerMain ./config/zookeeper.properties &", "originalCommit": "01758f6193fc2904736f53b5a10dbf8256edcdaa", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjA2MTg4OQ==", "url": "https://github.com/openzipkin/zipkin/pull/3189#discussion_r476061889", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            # Add HEALTHCHECK and ENTRYPOINT scripts\n          \n          \n            \n            # Add HEALTHCHECK and ENTRYPOINT scripts into the default search path", "author": "codefromthecrypt", "createdAt": "2020-08-25T02:03:14Z", "path": "docker/collector/kafka/Dockerfile", "diffHunk": "@@ -26,17 +25,19 @@ RUN /tmp/install && rm /tmp/install\n FROM openzipkin/jre-full:14.0.2-14.29.23\n LABEL MAINTAINER Zipkin \"https://zipkin.io/\"\n \n-# add HEALTHCHECK and ENTRYPOINT scripts\n+# Add HEALTHCHECK and ENTRYPOINT scripts", "originalCommit": "01758f6193fc2904736f53b5a10dbf8256edcdaa", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "b6b222f8c5e8cca81a2594ea38fd56fe27caad9f", "url": "https://github.com/openzipkin/zipkin/commit/b6b222f8c5e8cca81a2594ea38fd56fe27caad9f", "message": "Update docker/collector/kafka/Dockerfile", "committedDate": "2020-08-25T02:03:17Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjA2MjM0Mg==", "url": "https://github.com/openzipkin/zipkin/pull/3189#discussion_r476062342", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            # Copy content we installed earlier\n          \n          \n            \n            # Copy binaries and config we installed earlier", "author": "codefromthecrypt", "createdAt": "2020-08-25T02:03:56Z", "path": "docker/collector/kafka/Dockerfile", "diffHunk": "@@ -26,17 +25,19 @@ RUN /tmp/install && rm /tmp/install\n FROM openzipkin/jre-full:14.0.2-14.29.23\n LABEL MAINTAINER Zipkin \"https://zipkin.io/\"\n \n-# add HEALTHCHECK and ENTRYPOINT scripts\n+# Add HEALTHCHECK and ENTRYPOINT scripts into the default search path\n COPY docker/collector/kafka/docker-bin/* /usr/local/bin/\n \n-# setup non-root user and its home dir\n+# All Kafka content including binaries and logs write under WORKDIR\n+WORKDIR /kafka\n+\n+# Ensure the process doesn't run as root\n ARG USER=kafka\n-WORKDIR /${USER}\n-RUN adduser -g '' -h /${USER} -D ${USER}\n+RUN adduser -g '' -h  ${PWD} -D ${USER}\n USER ${USER}\n \n-# copy content we installed earlier into the home dir\n-COPY --from=install --chown=${USER} /install /${USER}\n+# Copy content we installed earlier", "originalCommit": "b6b222f8c5e8cca81a2594ea38fd56fe27caad9f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "469cb532fdb2472c8229782627223467af67e408", "url": "https://github.com/openzipkin/zipkin/commit/469cb532fdb2472c8229782627223467af67e408", "message": "Update docker/collector/kafka/Dockerfile", "committedDate": "2020-08-25T02:04:00Z", "type": "commit"}, {"oid": "03f768e749e727c0162c7cc74698055ea4d8ae85", "url": "https://github.com/openzipkin/zipkin/commit/03f768e749e727c0162c7cc74698055ea4d8ae85", "message": "use the power of GNU tar", "committedDate": "2020-08-25T03:23:24Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjExMjI1MQ==", "url": "https://github.com/openzipkin/zipkin/pull/3189#discussion_r476112251", "bodyText": "the power of GNU tar :D", "author": "codefromthecrypt", "createdAt": "2020-08-25T03:24:38Z", "path": "docker/collector/kafka/install", "diffHunk": "@@ -13,16 +13,18 @@\n # the License.\n \n # install script used only in building the docker image, but not at runtime.\n+# This uses relative path so that you can change the home dir without editing this file.\n+# This also trims dependencies to only those used at runtime.\n set -eux\n \n echo \"*** Installing Kafka and dependencies\"\n APACHE_MIRROR=$(curl --stderr /dev/null https://www.apache.org/dyn/closer.cgi\\?as_json\\=1 | sed -n '/preferred/s/.*\"\\(.*\\)\"/\\1/gp')\n \n-# download kafka binaries\n-curl -sSL $APACHE_MIRROR/kafka/$KAFKA_VERSION/kafka_$SCALA_VERSION-$KAFKA_VERSION.tgz | tar xz\n-mv kafka_$SCALA_VERSION-$KAFKA_VERSION/* .\n+# Download scripts and config for Kafka and ZooKeeper, but not for Connect\n+curl -sSL $APACHE_MIRROR/kafka/$KAFKA_VERSION/kafka_$SCALA_VERSION-$KAFKA_VERSION.tgz | tar xvz \\\n+  --wildcards --strip=1 --exclude=connect* */bin/zookeeper-* */bin/kafka-* */config", "originalCommit": "03f768e749e727c0162c7cc74698055ea4d8ae85", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "547f60d829249ace38f646fbd4761d7ba08581ce", "url": "https://github.com/openzipkin/zipkin/commit/547f60d829249ace38f646fbd4761d7ba08581ce", "message": "nov", "committedDate": "2020-08-25T03:26:06Z", "type": "commit"}, {"oid": "a79c0df578ee233f78e12f6fd452bdd753acd947", "url": "https://github.com/openzipkin/zipkin/commit/a79c0df578ee233f78e12f6fd452bdd753acd947", "message": "document wtf", "committedDate": "2020-08-25T03:37:16Z", "type": "commit"}, {"oid": "af146062065511e7ac6162f87b25bd8f0a7df5b1", "url": "https://github.com/openzipkin/zipkin/commit/af146062065511e7ac6162f87b25bd8f0a7df5b1", "message": "nicer name in docker ps", "committedDate": "2020-08-25T08:22:48Z", "type": "commit"}, {"oid": "b1e7ac60846c9d190c55d48de45d892588f537c8", "url": "https://github.com/openzipkin/zipkin/commit/b1e7ac60846c9d190c55d48de45d892588f537c8", "message": "final polish", "committedDate": "2020-08-30T12:14:45Z", "type": "commit"}, {"oid": "aee139e5ef85d9574b437433226c8a24b918fb0c", "url": "https://github.com/openzipkin/zipkin/commit/aee139e5ef85d9574b437433226c8a24b918fb0c", "message": "add license metadata", "committedDate": "2020-08-30T12:23:18Z", "type": "commit"}, {"oid": "11200feb6ce4c758863ef6c743a31a4b2d882a26", "url": "https://github.com/openzipkin/zipkin/commit/11200feb6ce4c758863ef6c743a31a4b2d882a26", "message": "last polish", "committedDate": "2020-09-01T00:00:16Z", "type": "commit"}]}