{"pr_number": 15, "pr_title": "Versioning support in TorchServe", "pr_createdAt": "2020-01-20T06:21:09Z", "pr_url": "https://github.com/pytorch/serve/pull/15", "timeline": [{"oid": "3ff4987979f87b30043067e40336fcc528c16ff1", "url": "https://github.com/pytorch/serve/commit/3ff4987979f87b30043067e40336fcc528c16ff1", "message": "added intial place holders for versioning", "committedDate": "2020-01-20T06:19:28Z", "type": "commit"}, {"oid": "e8937e13b5e5b79ba2c4d71bcc5303ee0ba82221", "url": "https://github.com/pytorch/serve/commit/e8937e13b5e5b79ba2c4d71bcc5303ee0ba82221", "message": "Support for versioning", "committedDate": "2020-01-21T07:13:07Z", "type": "commit"}, {"oid": "2d729fc68f4010ee3f8dac85b9bbaa6588164cdc", "url": "https://github.com/pytorch/serve/commit/2d729fc68f4010ee3f8dac85b9bbaa6588164cdc", "message": "updated inference apis and worker scaling logic", "committedDate": "2020-01-21T08:24:29Z", "type": "commit"}, {"oid": "df5fcc2f8994c489b336677bd5203bd2a5d3c7f2", "url": "https://github.com/pytorch/serve/commit/df5fcc2f8994c489b336677bd5203bd2a5d3c7f2", "message": "adding getModel to hide version manager class", "committedDate": "2020-01-21T09:04:39Z", "type": "commit"}, {"oid": "b94f94faf63a8514e9717a0f0c8e0a0de50ff627", "url": "https://github.com/pytorch/serve/commit/b94f94faf63a8514e9717a0f0c8e0a0de50ff627", "message": "updated management apis and fixed predict api", "committedDate": "2020-01-21T10:24:18Z", "type": "commit"}, {"oid": "fed924258b407fd1e834aaece413aea768204539", "url": "https://github.com/pytorch/serve/commit/fed924258b407fd1e834aaece413aea768204539", "message": "added version support in model archive", "committedDate": "2020-01-21T12:02:17Z", "type": "commit"}, {"oid": "d0b971b2827fb4db0132107330691dce4e9d819e", "url": "https://github.com/pytorch/serve/commit/d0b971b2827fb4db0132107330691dce4e9d819e", "message": "added changes to describe model api", "committedDate": "2020-01-21T12:17:03Z", "type": "commit"}, {"oid": "771abe15262cc030a3416100674a1c4d03e8c16a", "url": "https://github.com/pytorch/serve/commit/771abe15262cc030a3416100674a1c4d03e8c16a", "message": "reverted unneccessary version change", "committedDate": "2020-01-21T12:42:17Z", "type": "commit"}, {"oid": "fd61003b8fab05bea03f7dffe8ba54c7e8052ba3", "url": "https://github.com/pytorch/serve/commit/fd61003b8fab05bea03f7dffe8ba54c7e8052ba3", "message": "Fixed issues", "committedDate": "2020-01-21T12:52:48Z", "type": "commit"}, {"oid": "ef2524f9bbf04b7e5c5e479eb90c4cb26f4db2dd", "url": "https://github.com/pytorch/serve/commit/ef2524f9bbf04b7e5c5e479eb90c4cb26f4db2dd", "message": "Merge branch 'versioning' of https://github.com/pytorch/serve into versioning", "committedDate": "2020-01-21T12:53:04Z", "type": "commit"}, {"oid": "f78f9031f5e6fcc7ae0a55234c5024637b1b475c", "url": "https://github.com/pytorch/serve/commit/f78f9031f5e6fcc7ae0a55234c5024637b1b475c", "message": "fixed model name", "committedDate": "2020-01-21T13:00:18Z", "type": "commit"}, {"oid": "eb509358554c020380230a9adea02ddb8e8755c2", "url": "https://github.com/pytorch/serve/commit/eb509358554c020380230a9adea02ddb8e8755c2", "message": "updated test mar files", "committedDate": "2020-01-21T13:29:37Z", "type": "commit"}, {"oid": "dc36803e42d4fec9aa4b5f88a9a88df954d8add9", "url": "https://github.com/pytorch/serve/commit/dc36803e42d4fec9aa4b5f88a9a88df954d8add9", "message": "changes for threads/worker naming", "committedDate": "2020-01-21T14:47:54Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTMxNDMxMw==", "url": "https://github.com/pytorch/serve/pull/15#discussion_r369314313", "bodyText": "remove dead code", "author": "mycpuorg", "createdAt": "2020-01-22T00:21:38Z", "path": "frontend/server/src/main/java/org/pytorch/serve/wlm/ModelManager.java", "diffHunk": "@@ -98,65 +101,78 @@ public ModelArchive registerModel(\n         }\n \n         archive.validate();\n-\n-        Model model = new Model(archive, configManager.getJobQueueSize());\n-        model.setBatchSize(batchSize);\n-        model.setMaxBatchDelay(maxBatchDelay);\n-        model.setResponseTimeout(responseTimeout);\n-        Model existingModel = models.putIfAbsent(modelName, model);\n-        if (existingModel != null) {\n-            // model already exists\n-            throw new ConflictStatusException(\"Model \" + modelName + \" is already registered.\");\n-        }\n-        logger.info(\"Model {} loaded.\", model.getModelName());\n+        \n+//        Model model = new Model(archive, configManager.getJobQueueSize());", "originalCommit": "3ff4987979f87b30043067e40336fcc528c16ff1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTYwNzQzNg==", "url": "https://github.com/pytorch/serve/pull/15#discussion_r371607436", "bodyText": "Done", "author": "dhaniram-kshirsagar", "createdAt": "2020-01-28T04:38:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTMxNDMxMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTMxNDQ3OA==", "url": "https://github.com/pytorch/serve/pull/15#discussion_r369314478", "bodyText": "this removes unregisterModel() is the impl for this coming in a future commit?", "author": "mycpuorg", "createdAt": "2020-01-22T00:22:15Z", "path": "frontend/server/src/main/java/org/pytorch/serve/wlm/ModelManager.java", "diffHunk": "@@ -98,65 +101,78 @@ public ModelArchive registerModel(\n         }\n \n         archive.validate();\n-\n-        Model model = new Model(archive, configManager.getJobQueueSize());\n-        model.setBatchSize(batchSize);\n-        model.setMaxBatchDelay(maxBatchDelay);\n-        model.setResponseTimeout(responseTimeout);\n-        Model existingModel = models.putIfAbsent(modelName, model);\n-        if (existingModel != null) {\n-            // model already exists\n-            throw new ConflictStatusException(\"Model \" + modelName + \" is already registered.\");\n-        }\n-        logger.info(\"Model {} loaded.\", model.getModelName());\n+        \n+//        Model model = new Model(archive, configManager.getJobQueueSize());\n+//        model.setBatchSize(batchSize);\n+//        model.setMaxBatchDelay(maxBatchDelay);\n+//        model.setResponseTimeout(responseTimeout);\n+//        Model existingModel = modelsNameMap.putIfAbsent(modelName, model);\n+//        if (existingModel != null) {\n+//            // model already exists\n+//            throw new ConflictStatusException(\"Model \" + modelName + \" is already registered.\");\n+//        }\n+        \n+        Model tempModel = createModel(archive, configManager,\n+\t\t\t      batchSize, maxBatchDelay,\n+\t\t\t      responseTimeout, preloadModel);\n+        \n+        createVersionedModel(tempModel, versionId);\n+\n+        logger.info(\"Model {} loaded.\", tempModel.getModelName());\n \n         return archive;\n     }\n \n     public HttpResponseStatus unregisterModel(String modelName) {\n-        Model model = models.remove(modelName);\n-        if (model == null) {\n-            logger.warn(\"Model not found: \" + modelName);\n-            return HttpResponseStatus.NOT_FOUND;\n-        }\n-        model.setMinWorkers(0);\n-        model.setMaxWorkers(0);\n-        CompletableFuture<HttpResponseStatus> futureStatus = wlm.modelChanged(model);\n-        HttpResponseStatus httpResponseStatus = HttpResponseStatus.OK;\n-\n-        try {\n-            httpResponseStatus = futureStatus.get();\n-        } catch (InterruptedException | ExecutionException e) {\n-            logger.warn(\"Process was interrupted while cleaning resources.\");\n-            httpResponseStatus = HttpResponseStatus.INTERNAL_SERVER_ERROR;\n-        }\n-\n-        // Only continue cleaning if resource cleaning succeeded\n-        if (httpResponseStatus == HttpResponseStatus.OK) {\n-            model.getModelArchive().clean();\n-            startupModels.remove(modelName);\n-            logger.info(\"Model {} unregistered.\", modelName);\n-        } else {\n-            models.put(modelName, model);\n-        }\n+//        Model model = modelsNameMap.remove(modelName);\n+//        if (model == null) {\n+//            logger.warn(\"Model not found: \" + modelName);\n+//            return HttpResponseStatus.NOT_FOUND;", "originalCommit": "3ff4987979f87b30043067e40336fcc528c16ff1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTMxNDYzMA==", "url": "https://github.com/pytorch/serve/pull/15#discussion_r369314630", "bodyText": "this removes support for updating models. is the impl for this coming in a future model?", "author": "mycpuorg", "createdAt": "2020-01-22T00:22:50Z", "path": "frontend/server/src/main/java/org/pytorch/serve/wlm/ModelManager.java", "diffHunk": "@@ -98,65 +101,78 @@ public ModelArchive registerModel(\n         }\n \n         archive.validate();\n-\n-        Model model = new Model(archive, configManager.getJobQueueSize());\n-        model.setBatchSize(batchSize);\n-        model.setMaxBatchDelay(maxBatchDelay);\n-        model.setResponseTimeout(responseTimeout);\n-        Model existingModel = models.putIfAbsent(modelName, model);\n-        if (existingModel != null) {\n-            // model already exists\n-            throw new ConflictStatusException(\"Model \" + modelName + \" is already registered.\");\n-        }\n-        logger.info(\"Model {} loaded.\", model.getModelName());\n+        \n+//        Model model = new Model(archive, configManager.getJobQueueSize());\n+//        model.setBatchSize(batchSize);\n+//        model.setMaxBatchDelay(maxBatchDelay);\n+//        model.setResponseTimeout(responseTimeout);\n+//        Model existingModel = modelsNameMap.putIfAbsent(modelName, model);\n+//        if (existingModel != null) {\n+//            // model already exists\n+//            throw new ConflictStatusException(\"Model \" + modelName + \" is already registered.\");\n+//        }\n+        \n+        Model tempModel = createModel(archive, configManager,\n+\t\t\t      batchSize, maxBatchDelay,\n+\t\t\t      responseTimeout, preloadModel);\n+        \n+        createVersionedModel(tempModel, versionId);\n+\n+        logger.info(\"Model {} loaded.\", tempModel.getModelName());\n \n         return archive;\n     }\n \n     public HttpResponseStatus unregisterModel(String modelName) {\n-        Model model = models.remove(modelName);\n-        if (model == null) {\n-            logger.warn(\"Model not found: \" + modelName);\n-            return HttpResponseStatus.NOT_FOUND;\n-        }\n-        model.setMinWorkers(0);\n-        model.setMaxWorkers(0);\n-        CompletableFuture<HttpResponseStatus> futureStatus = wlm.modelChanged(model);\n-        HttpResponseStatus httpResponseStatus = HttpResponseStatus.OK;\n-\n-        try {\n-            httpResponseStatus = futureStatus.get();\n-        } catch (InterruptedException | ExecutionException e) {\n-            logger.warn(\"Process was interrupted while cleaning resources.\");\n-            httpResponseStatus = HttpResponseStatus.INTERNAL_SERVER_ERROR;\n-        }\n-\n-        // Only continue cleaning if resource cleaning succeeded\n-        if (httpResponseStatus == HttpResponseStatus.OK) {\n-            model.getModelArchive().clean();\n-            startupModels.remove(modelName);\n-            logger.info(\"Model {} unregistered.\", modelName);\n-        } else {\n-            models.put(modelName, model);\n-        }\n+//        Model model = modelsNameMap.remove(modelName);\n+//        if (model == null) {\n+//            logger.warn(\"Model not found: \" + modelName);\n+//            return HttpResponseStatus.NOT_FOUND;\n+//        }\n+//        model.setMinWorkers(0);\n+//        model.setMaxWorkers(0);\n+//        CompletableFuture<HttpResponseStatus> futureStatus = wlm.modelChanged(model);\n+//        HttpResponseStatus httpResponseStatus = HttpResponseStatus.OK;\n+//\n+//        try {\n+//            httpResponseStatus = futureStatus.get();\n+//        } catch (InterruptedException | ExecutionException e) {\n+//            logger.warn(\"Process was interrupted while cleaning resources.\");\n+//            httpResponseStatus = HttpResponseStatus.INTERNAL_SERVER_ERROR;\n+//        }\n+//\n+//        // Only continue cleaning if resource cleaning succeeded\n+//        if (httpResponseStatus == HttpResponseStatus.OK) {\n+//            model.getModelArchive().clean();\n+//            startupModels.remove(modelName);\n+//            logger.info(\"Model {} unregistered.\", modelName);\n+//        } else {\n+//            modelsNameMap.put(modelName, model);\n+//        }\n+    \tHttpResponseStatus httpResponseStatus = HttpResponseStatus.OK;\n \n         return httpResponseStatus;\n     }\n \n     public CompletableFuture<HttpResponseStatus> updateModel(\n             String modelName, int minWorkers, int maxWorkers) {\n-        Model model = models.get(modelName);\n-        if (model == null) {\n-            throw new AssertionError(\"Model not found: \" + modelName);\n-        }\n-        model.setMinWorkers(minWorkers);\n-        model.setMaxWorkers(maxWorkers);\n-        logger.debug(\"updateModel: {}, count: {}\", modelName, minWorkers);\n-        return wlm.modelChanged(model);\n+//        Model model = modelsNameMap.get(modelName);", "originalCommit": "3ff4987979f87b30043067e40336fcc528c16ff1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTYwNzU0MA==", "url": "https://github.com/pytorch/serve/pull/15#discussion_r371607540", "bodyText": "Done", "author": "dhaniram-kshirsagar", "createdAt": "2020-01-28T04:39:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTMxNDYzMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTMxNDc2Mw==", "url": "https://github.com/pytorch/serve/pull/15#discussion_r369314763", "bodyText": "it's worthwhile changing the method name to getDefaultModels() or something of the nature.", "author": "mycpuorg", "createdAt": "2020-01-22T00:23:27Z", "path": "frontend/server/src/main/java/org/pytorch/serve/wlm/ModelManager.java", "diffHunk": "@@ -98,65 +101,78 @@ public ModelArchive registerModel(\n         }\n \n         archive.validate();\n-\n-        Model model = new Model(archive, configManager.getJobQueueSize());\n-        model.setBatchSize(batchSize);\n-        model.setMaxBatchDelay(maxBatchDelay);\n-        model.setResponseTimeout(responseTimeout);\n-        Model existingModel = models.putIfAbsent(modelName, model);\n-        if (existingModel != null) {\n-            // model already exists\n-            throw new ConflictStatusException(\"Model \" + modelName + \" is already registered.\");\n-        }\n-        logger.info(\"Model {} loaded.\", model.getModelName());\n+        \n+//        Model model = new Model(archive, configManager.getJobQueueSize());\n+//        model.setBatchSize(batchSize);\n+//        model.setMaxBatchDelay(maxBatchDelay);\n+//        model.setResponseTimeout(responseTimeout);\n+//        Model existingModel = modelsNameMap.putIfAbsent(modelName, model);\n+//        if (existingModel != null) {\n+//            // model already exists\n+//            throw new ConflictStatusException(\"Model \" + modelName + \" is already registered.\");\n+//        }\n+        \n+        Model tempModel = createModel(archive, configManager,\n+\t\t\t      batchSize, maxBatchDelay,\n+\t\t\t      responseTimeout, preloadModel);\n+        \n+        createVersionedModel(tempModel, versionId);\n+\n+        logger.info(\"Model {} loaded.\", tempModel.getModelName());\n \n         return archive;\n     }\n \n     public HttpResponseStatus unregisterModel(String modelName) {\n-        Model model = models.remove(modelName);\n-        if (model == null) {\n-            logger.warn(\"Model not found: \" + modelName);\n-            return HttpResponseStatus.NOT_FOUND;\n-        }\n-        model.setMinWorkers(0);\n-        model.setMaxWorkers(0);\n-        CompletableFuture<HttpResponseStatus> futureStatus = wlm.modelChanged(model);\n-        HttpResponseStatus httpResponseStatus = HttpResponseStatus.OK;\n-\n-        try {\n-            httpResponseStatus = futureStatus.get();\n-        } catch (InterruptedException | ExecutionException e) {\n-            logger.warn(\"Process was interrupted while cleaning resources.\");\n-            httpResponseStatus = HttpResponseStatus.INTERNAL_SERVER_ERROR;\n-        }\n-\n-        // Only continue cleaning if resource cleaning succeeded\n-        if (httpResponseStatus == HttpResponseStatus.OK) {\n-            model.getModelArchive().clean();\n-            startupModels.remove(modelName);\n-            logger.info(\"Model {} unregistered.\", modelName);\n-        } else {\n-            models.put(modelName, model);\n-        }\n+//        Model model = modelsNameMap.remove(modelName);\n+//        if (model == null) {\n+//            logger.warn(\"Model not found: \" + modelName);\n+//            return HttpResponseStatus.NOT_FOUND;\n+//        }\n+//        model.setMinWorkers(0);\n+//        model.setMaxWorkers(0);\n+//        CompletableFuture<HttpResponseStatus> futureStatus = wlm.modelChanged(model);\n+//        HttpResponseStatus httpResponseStatus = HttpResponseStatus.OK;\n+//\n+//        try {\n+//            httpResponseStatus = futureStatus.get();\n+//        } catch (InterruptedException | ExecutionException e) {\n+//            logger.warn(\"Process was interrupted while cleaning resources.\");\n+//            httpResponseStatus = HttpResponseStatus.INTERNAL_SERVER_ERROR;\n+//        }\n+//\n+//        // Only continue cleaning if resource cleaning succeeded\n+//        if (httpResponseStatus == HttpResponseStatus.OK) {\n+//            model.getModelArchive().clean();\n+//            startupModels.remove(modelName);\n+//            logger.info(\"Model {} unregistered.\", modelName);\n+//        } else {\n+//            modelsNameMap.put(modelName, model);\n+//        }\n+    \tHttpResponseStatus httpResponseStatus = HttpResponseStatus.OK;\n \n         return httpResponseStatus;\n     }\n \n     public CompletableFuture<HttpResponseStatus> updateModel(\n             String modelName, int minWorkers, int maxWorkers) {\n-        Model model = models.get(modelName);\n-        if (model == null) {\n-            throw new AssertionError(\"Model not found: \" + modelName);\n-        }\n-        model.setMinWorkers(minWorkers);\n-        model.setMaxWorkers(maxWorkers);\n-        logger.debug(\"updateModel: {}, count: {}\", modelName, minWorkers);\n-        return wlm.modelChanged(model);\n+//        Model model = modelsNameMap.get(modelName);\n+//        if (model == null) {\n+//            throw new AssertionError(\"Model not found: \" + modelName);\n+//        }\n+//        model.setMinWorkers(minWorkers);\n+//        model.setMaxWorkers(maxWorkers);\n+//        logger.debug(\"updateModel: {}, count: {}\", modelName, minWorkers);\n+        return wlm.modelChanged(null);\n     }\n \n     public Map<String, Model> getModels() {", "originalCommit": "3ff4987979f87b30043067e40336fcc528c16ff1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTYwNzcxOQ==", "url": "https://github.com/pytorch/serve/pull/15#discussion_r371607719", "bodyText": "Done", "author": "dhaniram-kshirsagar", "createdAt": "2020-01-28T04:40:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTMxNDc2Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTMxNTcxMQ==", "url": "https://github.com/pytorch/serve/pull/15#discussion_r369315711", "bodyText": "nice.\nDoes this propagate upwards to the HTTP req handler level?", "author": "mycpuorg", "createdAt": "2020-01-22T00:27:15Z", "path": "frontend/server/src/main/java/org/pytorch/serve/http/ManagementRequestHandler.java", "diffHunk": "@@ -121,10 +127,11 @@ private void handleListModels(ChannelHandlerContext ctx, QueryStringDecoder deco\n         NettyUtils.sendJsonResponse(ctx, list);\n     }\n \n-    private void handleDescribeModel(ChannelHandlerContext ctx, String modelName)\n+    private void handleDescribeModel(\n+            ChannelHandlerContext ctx, String modelName, String modelVersion)\n             throws ModelNotFoundException {\n         ModelManager modelManager = ModelManager.getInstance();\n-        Model model = modelManager.getModels().get(modelName);\n+        Model model = modelManager.getModel(modelName, modelVersion);", "originalCommit": "dc36803e42d4fec9aa4b5f88a9a88df954d8add9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTM1Mzk5Mw==", "url": "https://github.com/pytorch/serve/pull/15#discussion_r369353993", "bodyText": "We are still working on it.", "author": "dhaniram-kshirsagar", "createdAt": "2020-01-22T03:21:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTMxNTcxMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTYwNzkxNA==", "url": "https://github.com/pytorch/serve/pull/15#discussion_r371607914", "bodyText": "Done.", "author": "dhaniram-kshirsagar", "createdAt": "2020-01-28T04:41:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTMxNTcxMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTMxNjQ4NA==", "url": "https://github.com/pytorch/serve/pull/15#discussion_r369316484", "bodyText": "any particular reason this is public? We don't expect this to be a part of http req handling codebase do we?", "author": "mycpuorg", "createdAt": "2020-01-22T00:30:16Z", "path": "frontend/server/src/main/java/org/pytorch/serve/wlm/ModelVersionedRefs.java", "diffHunk": "@@ -25,111 +18,143 @@ public ModelVersionedRefs() {\n         this.modelsVersionMap = new ConcurrentHashMap<>();\n     }\n \n-    private void _validateVersionId(String v)\n-\tthrows InvalidModelVersionException, NumberFormatException {\n-\tDouble vd = Double.valueOf(v);\n-\tif (vd <= Double.valueOf(\"0.0\"))\n-\t    throw new InvalidModelVersionException(\"Model Version is invalid: \" + v);\n+    private void validateVersionId(String v)\n+            throws InvalidModelVersionException, NumberFormatException {\n+        // TODO add exception handling for NumberFormatException\n+        Double vd = Double.valueOf(v);\n+        if (vd <= Double.valueOf(\"0.0\")) {\n+            throw new InvalidModelVersionException(\"Model version is invalid: \" + v);\n+        }\n     }\n \n-    private void _checkVersionCapacity() {\n-\t// place holder only for now\n+    private void checkVersionCapacity() {\n+        // place holder only for now\n     }\n \n     /**\n-     * Adds a new version of the Model to the Map if it does not exist\n-     * Sets this version as the default version of the model which is\n-     * automatically served on the next request to this model.\n-     * If it already exists in the map, throws an exception with conflict\n-     * status\n+     * Adds a new version of the Model to the Map if it does not exist Sets this version as the\n+     * default version of the model which is automatically served on the next request to this model.\n+     * If it already exists in the map, throws an exception with conflict status\n      *\n-     * @param model: Model object with all the parameters initialized\n-     *         as desired\n-     * @param versionId: String obj of version ID from the manifest\n+     * @param model: Model object with all the parameters initialized as desired\n+     * @param versionId: String version ID from the manifest\n      * @return None\n      */\n-    public void addVersionModel(Model model, String versionId)\n-\tthrows InvalidModelVersionException, InvalidModelVersionException {\n-\t_validateVersionId(versionId);\n-\t_checkVersionCapacity();\n-\tif (this.modelsVersionMap.putIfAbsent(Double.valueOf(versionId), model) != null)\n-\t    throw new InvalidModelVersionException(\n-\t\t\t\t\t\t   \"Model \" + model.getModelName() + \" is already registered.\");\n-\tthis.setDefaultVersion(versionId);\n+    public void addVersionModel(Model model, String versionId) throws InvalidModelVersionException {\n+        logger.debug(\"Adding new version {} for model {}\", versionId, model.getModelName());\n+\n+        if (versionId == null) {\n+            throw new InvalidModelVersionException(\"Model version not found. \");\n+        }\n+\n+        validateVersionId(versionId);\n+        checkVersionCapacity();\n+\n+        if (this.modelsVersionMap.putIfAbsent(Double.valueOf(versionId), model) != null) {\n+            throw new InvalidModelVersionException(\n+                    \"Model \" + model.getModelName() + \" is already registered.\");\n+        }\n+\n+        // TODO what if user wants to keep existing default as it is?\n+        this.setDefaultVersion(versionId);\n     }\n \n     /**\n      * Returns a String object of the default version of this Model\n-     * @return      String obj of the current default Version\n+     *\n+     * @return String obj of the current default Version\n      */\n     public String getDefaultVersion() {\n-\treturn this.defaultVersion.toString();\n+        return this.defaultVersion.toString();\n     }\n \n     /**\n-     * Sets the default version of the model to the version in\n-     * arg\n-     * @param       A valid String obj with version to set default\n-     * @return      None\n+     * Sets the default version of the model to the version in arg\n+     *\n+     * @param A valid String obj with version to set default\n+     * @return None\n      */\n-    public void setDefaultVersion(String versionId)\n-\tthrows InvalidModelVersionException {\n-\t_validateVersionId(versionId);\n-\tif (this.modelsVersionMap.get(Double.valueOf(versionId)) == null)\n-\t    throw new InvalidModelVersionException(\"Can't set default to: \" + versionId);\n-\tthis.defaultVersion = Double.valueOf(versionId);\n+    public void setDefaultVersion(String versionId) throws InvalidModelVersionException {\n+        validateVersionId(versionId);\n+        Model model = this.modelsVersionMap.get(Double.valueOf(versionId));\n+        if (model == null) {\n+            throw new InvalidModelVersionException(\"Can't set default to: \" + versionId);\n+        }\n+\n+        logger.debug(\"Setting default version to {} for model {}\", versionId, model.getModelName());\n+        this.defaultVersion = Double.valueOf(versionId);\n     }\n \n     /**\n-     * Removes the specified version of the model from the Map\n-     * If it's the default version then throws an exception\n-     * The Client is responsible for setting a new default\n-     * prior to deleting the current default\n+     * Removes the specified version of the model from the Map If it's the default version then\n+     * throws an exception The Client is responsible for setting a new default prior to deleting the\n+     * current default\n      *\n-     * @param  A String specifying a valid non-default version Id\n-     * @return On Success - a String specifying the new default version Id\n-     *         On Failure - throws InvalidModelVersionException\n+     * @param A String specifying a valid non-default version Id\n+     * @return On Success - Removed model for given version Id\n+     * @throws On Failure - throws InvalidModelVersionException and ModelNotFoundException\n      */\n-    public String removeVersionModel(String versionId)\n-\tthrows InvalidModelVersionException {\n-\tif (this.defaultVersion.compareTo(Double.valueOf(versionId)) == 0) {\n-\t    throw new InvalidModelVersionException(\"Can't remove default version: \" + versionId);\n-\t}\n-\treturn this.defaultVersion.toString();\n+    public Model removeVersionModel(String versionId)", "originalCommit": "dc36803e42d4fec9aa4b5f88a9a88df954d8add9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTYwODA1Mg==", "url": "https://github.com/pytorch/serve/pull/15#discussion_r371608052", "bodyText": "It needs to be public as this is going to get called from ModelManager for removing versioned models", "author": "dhaniram-kshirsagar", "createdAt": "2020-01-28T04:43:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTMxNjQ4NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTMxNzMzMA==", "url": "https://github.com/pytorch/serve/pull/15#discussion_r369317330", "bodyText": "If we are adopting this method to compute a unique key for model and version combo then we should somehow propagate this info (perhaps through documentation in README) to the users.", "author": "mycpuorg", "createdAt": "2020-01-22T00:33:24Z", "path": "frontend/server/src/main/java/org/pytorch/serve/wlm/Model.java", "diffHunk": "@@ -48,6 +48,14 @@ public String getModelName() {\n         return modelArchive.getModelName();\n     }\n \n+    public String getModelVersionName() {\n+        return modelArchive.getModelName() + \"_\" + modelArchive.getModelVersion();", "originalCommit": "dc36803e42d4fec9aa4b5f88a9a88df954d8add9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTM1NDEyMA==", "url": "https://github.com/pytorch/serve/pull/15#discussion_r369354120", "bodyText": "Sure.", "author": "dhaniram-kshirsagar", "createdAt": "2020-01-22T03:21:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTMxNzMzMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDgwMDg5MQ==", "url": "https://github.com/pytorch/serve/pull/15#discussion_r370800891", "bodyText": "What are the acceptable formats for model versions (and the default ones that we generate)? I can potentially see this being an issue as some common model names used are model_pathlength ie: resnet_18.", "author": "alexwong", "createdAt": "2020-01-24T19:21:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTMxNzMzMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTYwODQxOQ==", "url": "https://github.com/pytorch/serve/pull/15#discussion_r371608419", "bodyText": "@mycpuorg - The unique key created using name+version is internal to component and is not required to part of doc. @alexwong - Model version is non-negative double value and to be supplied by user via MAR utility", "author": "dhaniram-kshirsagar", "createdAt": "2020-01-28T04:45:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTMxNzMzMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTMxNzY4Mg==", "url": "https://github.com/pytorch/serve/pull/15#discussion_r369317682", "bodyText": "We probably need to check for clash of versions? What's to prevent user from entering 100 model archives with the same version?", "author": "mycpuorg", "createdAt": "2020-01-22T00:34:50Z", "path": "frontend/server/src/main/java/org/pytorch/serve/wlm/ModelManager.java", "diffHunk": "@@ -101,78 +101,108 @@ public ModelArchive registerModel(\n         }\n \n         archive.validate();\n-        \n-//        Model model = new Model(archive, configManager.getJobQueueSize());\n-//        model.setBatchSize(batchSize);\n-//        model.setMaxBatchDelay(maxBatchDelay);\n-//        model.setResponseTimeout(responseTimeout);\n-//        Model existingModel = modelsNameMap.putIfAbsent(modelName, model);\n-//        if (existingModel != null) {\n-//            // model already exists\n-//            throw new ConflictStatusException(\"Model \" + modelName + \" is already registered.\");\n-//        }\n-        \n-        Model tempModel = createModel(archive, configManager,\n-\t\t\t      batchSize, maxBatchDelay,\n-\t\t\t      responseTimeout, preloadModel);\n-        \n+\n+        Model tempModel =\n+                createModel(archive, configManager, batchSize, maxBatchDelay, responseTimeout);\n+\n         createVersionedModel(tempModel, versionId);\n \n         logger.info(\"Model {} loaded.\", tempModel.getModelName());\n \n         return archive;\n     }\n \n-    public HttpResponseStatus unregisterModel(String modelName) {\n-//        Model model = modelsNameMap.remove(modelName);\n-//        if (model == null) {\n-//            logger.warn(\"Model not found: \" + modelName);\n-//            return HttpResponseStatus.NOT_FOUND;\n-//        }\n-//        model.setMinWorkers(0);\n-//        model.setMaxWorkers(0);\n-//        CompletableFuture<HttpResponseStatus> futureStatus = wlm.modelChanged(model);\n-//        HttpResponseStatus httpResponseStatus = HttpResponseStatus.OK;\n-//\n-//        try {\n-//            httpResponseStatus = futureStatus.get();\n-//        } catch (InterruptedException | ExecutionException e) {\n-//            logger.warn(\"Process was interrupted while cleaning resources.\");\n-//            httpResponseStatus = HttpResponseStatus.INTERNAL_SERVER_ERROR;\n-//        }\n-//\n-//        // Only continue cleaning if resource cleaning succeeded\n-//        if (httpResponseStatus == HttpResponseStatus.OK) {\n-//            model.getModelArchive().clean();\n-//            startupModels.remove(modelName);\n-//            logger.info(\"Model {} unregistered.\", modelName);\n-//        } else {\n-//            modelsNameMap.put(modelName, model);\n-//        }\n-    \tHttpResponseStatus httpResponseStatus = HttpResponseStatus.OK;\n+    private Model createModel(\n+            ModelArchive archive,\n+            ConfigManager configManager2,\n+            int batchSize,\n+            int maxBatchDelay,\n+            int responseTimeout) {\n+        Model model = new Model(archive, configManager.getJobQueueSize());\n+        model.setBatchSize(batchSize);\n+        model.setMaxBatchDelay(maxBatchDelay);\n+        model.setResponseTimeout(responseTimeout);\n+\n+        return model;\n+    }\n+\n+    private void createVersionedModel(Model model, String versionId) {\n+        // TODO Auto-generated method stub\n+        ModelVersionedRefs modelVersionRef = new ModelVersionedRefs();\n+        modelVersionRef.addVersionModel(model, versionId);", "originalCommit": "dc36803e42d4fec9aa4b5f88a9a88df954d8add9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTYwODQ4MA==", "url": "https://github.com/pytorch/serve/pull/15#discussion_r371608480", "bodyText": "Done", "author": "dhaniram-kshirsagar", "createdAt": "2020-01-28T04:46:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTMxNzY4Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTMxODY3Mw==", "url": "https://github.com/pytorch/serve/pull/15#discussion_r369318673", "bodyText": "since we are not overloading here, let's force them to send a valid version ID by throwing exception in else-block.", "author": "mycpuorg", "createdAt": "2020-01-22T00:38:48Z", "path": "frontend/server/src/main/java/org/pytorch/serve/wlm/ModelVersionedRefs.java", "diffHunk": "@@ -25,111 +18,143 @@ public ModelVersionedRefs() {\n         this.modelsVersionMap = new ConcurrentHashMap<>();\n     }\n \n-    private void _validateVersionId(String v)\n-\tthrows InvalidModelVersionException, NumberFormatException {\n-\tDouble vd = Double.valueOf(v);\n-\tif (vd <= Double.valueOf(\"0.0\"))\n-\t    throw new InvalidModelVersionException(\"Model Version is invalid: \" + v);\n+    private void validateVersionId(String v)\n+            throws InvalidModelVersionException, NumberFormatException {\n+        // TODO add exception handling for NumberFormatException\n+        Double vd = Double.valueOf(v);\n+        if (vd <= Double.valueOf(\"0.0\")) {\n+            throw new InvalidModelVersionException(\"Model version is invalid: \" + v);\n+        }\n     }\n \n-    private void _checkVersionCapacity() {\n-\t// place holder only for now\n+    private void checkVersionCapacity() {\n+        // place holder only for now\n     }\n \n     /**\n-     * Adds a new version of the Model to the Map if it does not exist\n-     * Sets this version as the default version of the model which is\n-     * automatically served on the next request to this model.\n-     * If it already exists in the map, throws an exception with conflict\n-     * status\n+     * Adds a new version of the Model to the Map if it does not exist Sets this version as the\n+     * default version of the model which is automatically served on the next request to this model.\n+     * If it already exists in the map, throws an exception with conflict status\n      *\n-     * @param model: Model object with all the parameters initialized\n-     *         as desired\n-     * @param versionId: String obj of version ID from the manifest\n+     * @param model: Model object with all the parameters initialized as desired\n+     * @param versionId: String version ID from the manifest\n      * @return None\n      */\n-    public void addVersionModel(Model model, String versionId)\n-\tthrows InvalidModelVersionException, InvalidModelVersionException {\n-\t_validateVersionId(versionId);\n-\t_checkVersionCapacity();\n-\tif (this.modelsVersionMap.putIfAbsent(Double.valueOf(versionId), model) != null)\n-\t    throw new InvalidModelVersionException(\n-\t\t\t\t\t\t   \"Model \" + model.getModelName() + \" is already registered.\");\n-\tthis.setDefaultVersion(versionId);\n+    public void addVersionModel(Model model, String versionId) throws InvalidModelVersionException {\n+        logger.debug(\"Adding new version {} for model {}\", versionId, model.getModelName());\n+\n+        if (versionId == null) {\n+            throw new InvalidModelVersionException(\"Model version not found. \");\n+        }\n+\n+        validateVersionId(versionId);\n+        checkVersionCapacity();\n+\n+        if (this.modelsVersionMap.putIfAbsent(Double.valueOf(versionId), model) != null) {\n+            throw new InvalidModelVersionException(\n+                    \"Model \" + model.getModelName() + \" is already registered.\");\n+        }\n+\n+        // TODO what if user wants to keep existing default as it is?\n+        this.setDefaultVersion(versionId);\n     }\n \n     /**\n      * Returns a String object of the default version of this Model\n-     * @return      String obj of the current default Version\n+     *\n+     * @return String obj of the current default Version\n      */\n     public String getDefaultVersion() {\n-\treturn this.defaultVersion.toString();\n+        return this.defaultVersion.toString();\n     }\n \n     /**\n-     * Sets the default version of the model to the version in\n-     * arg\n-     * @param       A valid String obj with version to set default\n-     * @return      None\n+     * Sets the default version of the model to the version in arg\n+     *\n+     * @param A valid String obj with version to set default\n+     * @return None\n      */\n-    public void setDefaultVersion(String versionId)\n-\tthrows InvalidModelVersionException {\n-\t_validateVersionId(versionId);\n-\tif (this.modelsVersionMap.get(Double.valueOf(versionId)) == null)\n-\t    throw new InvalidModelVersionException(\"Can't set default to: \" + versionId);\n-\tthis.defaultVersion = Double.valueOf(versionId);\n+    public void setDefaultVersion(String versionId) throws InvalidModelVersionException {\n+        validateVersionId(versionId);\n+        Model model = this.modelsVersionMap.get(Double.valueOf(versionId));\n+        if (model == null) {\n+            throw new InvalidModelVersionException(\"Can't set default to: \" + versionId);\n+        }\n+\n+        logger.debug(\"Setting default version to {} for model {}\", versionId, model.getModelName());\n+        this.defaultVersion = Double.valueOf(versionId);\n     }\n \n     /**\n-     * Removes the specified version of the model from the Map\n-     * If it's the default version then throws an exception\n-     * The Client is responsible for setting a new default\n-     * prior to deleting the current default\n+     * Removes the specified version of the model from the Map If it's the default version then\n+     * throws an exception The Client is responsible for setting a new default prior to deleting the\n+     * current default\n      *\n-     * @param  A String specifying a valid non-default version Id\n-     * @return On Success - a String specifying the new default version Id\n-     *         On Failure - throws InvalidModelVersionException\n+     * @param A String specifying a valid non-default version Id\n+     * @return On Success - Removed model for given version Id\n+     * @throws On Failure - throws InvalidModelVersionException and ModelNotFoundException\n      */\n-    public String removeVersionModel(String versionId)\n-\tthrows InvalidModelVersionException {\n-\tif (this.defaultVersion.compareTo(Double.valueOf(versionId)) == 0) {\n-\t    throw new InvalidModelVersionException(\"Can't remove default version: \" + versionId);\n-\t}\n-\treturn this.defaultVersion.toString();\n+    public Model removeVersionModel(String versionId)\n+            throws InvalidModelVersionException, ModelNotFoundException {\n+        if (versionId == null) {\n+            versionId = this.getDefaultVersion();\n+        } else {\n+            validateVersionId(versionId);\n+        }\n+\n+        if (this.defaultVersion.compareTo(Double.valueOf(versionId)) == 0\n+                && modelsVersionMap.size() > 1) {\n+            throw new InvalidModelVersionException(\n+                    String.format(\"Can't remove default version: %s\", versionId));\n+        }\n+\n+        Model model = this.modelsVersionMap.remove(Double.valueOf(versionId));\n+        if (model == null) {\n+            throw new ModelNotFoundException(\n+                    String.format(\"Model version: %s not found\", versionId));\n+        }\n+\n+        logger.debug(\"Removed model: {} version: {}\", model.getModelName(), versionId);\n+\n+        return model;\n     }\n \n     /**\n      * Returns the Model obj corresponding to the version provided\n      *\n-     * @param  A String specifying a valid version Id\n-     * @return On Success - a Model Obj previously registered\n-     *         On Failure - null\n+     * @param A String specifying a valid version Id\n+     * @return On Success - a Model Obj previously registered On Failure - null\n      */\n-    public Model getVersionModel(String versionId)\n-\tthrows InvalidModelVersionException {\n-\t_validateVersionId(versionId);\n-\treturn this.modelsVersionMap.get(Double.valueOf(versionId));\n-    }\n+    public Model getVersionModel(String versionId) throws InvalidModelVersionException {\n+        Model model = null;\n+        if (versionId != null) {\n+            validateVersionId(versionId);\n+            model = this.modelsVersionMap.get(Double.valueOf(versionId));\n+        } else {\n+            model = this.getDefaultModel();", "originalCommit": "dc36803e42d4fec9aa4b5f88a9a88df954d8add9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTYwODkyMw==", "url": "https://github.com/pytorch/serve/pull/15#discussion_r371608923", "bodyText": "This is to handle scenarios where the user has not supplied model number and default should be executed such as /models/<name_of_model> or /predictions/<model_name>", "author": "dhaniram-kshirsagar", "createdAt": "2020-01-28T04:48:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTMxODY3Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTMxODk5Ng==", "url": "https://github.com/pytorch/serve/pull/15#discussion_r369318996", "bodyText": "not sure if this convention is followed in Java of using '_' ahead of a privately used function in a class? I don't see any other practice/convention used in this project.", "author": "mycpuorg", "createdAt": "2020-01-22T00:40:01Z", "path": "frontend/server/src/main/java/org/pytorch/serve/wlm/ModelVersionedRefs.java", "diffHunk": "@@ -25,111 +18,143 @@ public ModelVersionedRefs() {\n         this.modelsVersionMap = new ConcurrentHashMap<>();\n     }\n \n-    private void _validateVersionId(String v)\n-\tthrows InvalidModelVersionException, NumberFormatException {\n-\tDouble vd = Double.valueOf(v);\n-\tif (vd <= Double.valueOf(\"0.0\"))\n-\t    throw new InvalidModelVersionException(\"Model Version is invalid: \" + v);\n+    private void validateVersionId(String v)\n+            throws InvalidModelVersionException, NumberFormatException {\n+        // TODO add exception handling for NumberFormatException\n+        Double vd = Double.valueOf(v);\n+        if (vd <= Double.valueOf(\"0.0\")) {\n+            throw new InvalidModelVersionException(\"Model version is invalid: \" + v);\n+        }\n     }\n \n-    private void _checkVersionCapacity() {\n-\t// place holder only for now\n+    private void checkVersionCapacity() {", "originalCommit": "dc36803e42d4fec9aa4b5f88a9a88df954d8add9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTM2NDE3Nw==", "url": "https://github.com/pytorch/serve/pull/15#discussion_r369364177", "bodyText": "In java, the identifier does not begin with '_'.", "author": "dhaniram-kshirsagar", "createdAt": "2020-01-22T04:20:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTMxODk5Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTMxOTE2Nw==", "url": "https://github.com/pytorch/serve/pull/15#discussion_r369319167", "bodyText": "indentation looks a little off here ??", "author": "mycpuorg", "createdAt": "2020-01-22T00:40:38Z", "path": "frontend/server/src/main/java/org/pytorch/serve/wlm/ModelManager.java", "diffHunk": "@@ -203,9 +240,37 @@ public void workerStatus(final ChannelHandlerContext ctx) {\n                     String response = \"Healthy\";\n                     int numWorking = 0;\n                     int numScaled = 0;\n-                    for (Map.Entry<String, Model> m : modelsNameMap.entrySet()) {\n+                    for (Map.Entry<String, ModelVersionedRefs> m : modelsNameMap.entrySet()) {", "originalCommit": "dc36803e42d4fec9aa4b5f88a9a88df954d8add9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTM2NDI4Nw==", "url": "https://github.com/pytorch/serve/pull/15#discussion_r369364287", "bodyText": "The indentation is per Gradle java code format command fJ which is using google java coding style.", "author": "dhaniram-kshirsagar", "createdAt": "2020-01-22T04:21:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTMxOTE2Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTMxOTgyMg==", "url": "https://github.com/pytorch/serve/pull/15#discussion_r369319822", "bodyText": "Is this a new response we are sending or has it been around? Does the client know or care about what this health status is? Why not send, 500 with a hint about 'scaling'", "author": "mycpuorg", "createdAt": "2020-01-22T00:43:18Z", "path": "frontend/server/src/main/java/org/pytorch/serve/wlm/ModelManager.java", "diffHunk": "@@ -203,9 +240,37 @@ public void workerStatus(final ChannelHandlerContext ctx) {\n                     String response = \"Healthy\";\n                     int numWorking = 0;\n                     int numScaled = 0;\n-                    for (Map.Entry<String, Model> m : modelsNameMap.entrySet()) {\n+                    for (Map.Entry<String, ModelVersionedRefs> m : modelsNameMap.entrySet()) {\n+                        numScaled += m.getValue().getDefaultModel().getMinWorkers();\n+                        numWorking +=\n+                                wlm.getNumRunningWorkers(\n+                                        m.getValue().getDefaultModel().getModelVersionName());\n+                    }\n+\n+                    if ((numWorking > 0) && (numWorking < numScaled)) {\n+                        response = \"Partial Healthy\";", "originalCommit": "dc36803e42d4fec9aa4b5f88a9a88df954d8add9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTYwOTIyMg==", "url": "https://github.com/pytorch/serve/pull/15#discussion_r371609222", "bodyText": "This has been ported as-is from MMS. It is overall status.", "author": "dhaniram-kshirsagar", "createdAt": "2020-01-28T04:50:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTMxOTgyMg=="}], "type": "inlineReview"}, {"oid": "2c6e81e84e0730749e53401df9c98e1f20e00ab0", "url": "https://github.com/pytorch/serve/commit/2c6e81e84e0730749e53401df9c98e1f20e00ab0", "message": "added check to re-add default version on unregister failure", "committedDate": "2020-01-22T09:09:21Z", "type": "commit"}, {"oid": "3e57607f82d9e7f53acd6c599abfd940d0768def", "url": "https://github.com/pytorch/serve/commit/3e57607f82d9e7f53acd6c599abfd940d0768def", "message": "fixed pmd issues", "committedDate": "2020-01-22T09:43:54Z", "type": "commit"}, {"oid": "ffb3225386f7f6b8889052328c7bc9262624334a", "url": "https://github.com/pytorch/serve/commit/ffb3225386f7f6b8889052328c7bc9262624334a", "message": "fixed muliple model version registration logic", "committedDate": "2020-01-22T11:54:52Z", "type": "commit"}, {"oid": "46b1fb585bb6f98e0641b81bcbd8e874345c6b05", "url": "https://github.com/pytorch/serve/commit/46b1fb585bb6f98e0641b81bcbd8e874345c6b05", "message": "updated error message while unregistering default model version", "committedDate": "2020-01-22T12:44:00Z", "type": "commit"}, {"oid": "684a6b86097e981db1dcceb2ac3b723ff2d70ffd", "url": "https://github.com/pytorch/serve/commit/684a6b86097e981db1dcceb2ac3b723ff2d70ffd", "message": "added new api to change model version", "committedDate": "2020-01-22T13:55:01Z", "type": "commit"}, {"oid": "90fb0479980e36fdd28494d291a2b82927d2423e", "url": "https://github.com/pytorch/serve/commit/90fb0479980e36fdd28494d291a2b82927d2423e", "message": "incorporated code review comments and updated UT", "committedDate": "2020-01-22T14:14:59Z", "type": "commit"}, {"oid": "9437ca78aade21d04b75ea8ee1a309f0c9a08474", "url": "https://github.com/pytorch/serve/commit/9437ca78aade21d04b75ea8ee1a309f0c9a08474", "message": "Add dockerfile", "committedDate": "2020-01-22T21:44:04Z", "type": "commit"}, {"oid": "82b90fcef49fe491fcfc7575c3d92c1ac2144223", "url": "https://github.com/pytorch/serve/commit/82b90fcef49fe491fcfc7575c3d92c1ac2144223", "message": "enhanced describe api to describe all model vesrions", "committedDate": "2020-01-23T07:16:45Z", "type": "commit"}, {"oid": "a5de60d8d47c70d8e5fd0a57a4badf6c81e6ed53", "url": "https://github.com/pytorch/serve/commit/a5de60d8d47c70d8e5fd0a57a4badf6c81e6ed53", "message": "generalised existing test cases", "committedDate": "2020-01-23T11:16:54Z", "type": "commit"}, {"oid": "fc82b02ec9af876a04c6b5a8b76a9af17f2c2a82", "url": "https://github.com/pytorch/serve/commit/fc82b02ec9af876a04c6b5a8b76a9af17f2c2a82", "message": "added describe api UTs", "committedDate": "2020-01-23T11:51:29Z", "type": "commit"}, {"oid": "5aff124be5d04c368525736c73989ffc0c1601f8", "url": "https://github.com/pytorch/serve/commit/5aff124be5d04c368525736c73989ffc0c1601f8", "message": "fixed model name in UT", "committedDate": "2020-01-23T12:17:28Z", "type": "commit"}, {"oid": "2c2c6521f0afecec2bcb96cefb2c921b759c96d3", "url": "https://github.com/pytorch/serve/commit/2c2c6521f0afecec2bcb96cefb2c921b759c96d3", "message": "added more test cases for versioned apis", "committedDate": "2020-01-23T12:56:40Z", "type": "commit"}, {"oid": "7c4a5c280144a48612a42e43d7a7975d02e6c706", "url": "https://github.com/pytorch/serve/commit/7c4a5c280144a48612a42e43d7a7975d02e6c706", "message": "added UT for versioned scaling up of model and negative test case to unregister default version", "committedDate": "2020-01-23T13:17:33Z", "type": "commit"}, {"oid": "9f86f4401f585a90f68edd470760d65be3508fa8", "url": "https://github.com/pytorch/serve/commit/9f86f4401f585a90f68edd470760d65be3508fa8", "message": "fixed UTs", "committedDate": "2020-01-23T14:39:21Z", "type": "commit"}, {"oid": "ed12d6007c3bd461e4624130eef7c2c30278094e", "url": "https://github.com/pytorch/serve/commit/ed12d6007c3bd461e4624130eef7c2c30278094e", "message": "added missed mar file", "committedDate": "2020-01-23T14:46:44Z", "type": "commit"}, {"oid": "afe1b946979bac66cefae3a784bfbb4e219c36de", "url": "https://github.com/pytorch/serve/commit/afe1b946979bac66cefae3a784bfbb4e219c36de", "message": "adding benchmark scripts", "committedDate": "2020-01-23T16:11:19Z", "type": "commit"}, {"oid": "f7f1488df4e072c83121badae1ece6af3370f823", "url": "https://github.com/pytorch/serve/commit/f7f1488df4e072c83121badae1ece6af3370f823", "message": "commented test case for unregister default version", "committedDate": "2020-01-23T17:10:08Z", "type": "commit"}, {"oid": "8a310945188ffa84f075425bb4be71330a437f94", "url": "https://github.com/pytorch/serve/commit/8a310945188ffa84f075425bb4be71330a437f94", "message": "changed expected type to array", "committedDate": "2020-01-23T17:20:38Z", "type": "commit"}, {"oid": "bd1d18424953f43b000a5177f3e16ad2709af111", "url": "https://github.com/pytorch/serve/commit/bd1d18424953f43b000a5177f3e16ad2709af111", "message": "pmd and formatting fixes", "committedDate": "2020-01-23T17:48:54Z", "type": "commit"}, {"oid": "943e341020a2d46c10f2f4f72f5c26202ee34653", "url": "https://github.com/pytorch/serve/commit/943e341020a2d46c10f2f4f72f5c26202ee34653", "message": "Updated docs for versioning related apis and replaced TS with TorchServe", "committedDate": "2020-01-24T07:36:27Z", "type": "commit"}, {"oid": "86107596bddd601739a587288a4b5e6249e5c0bc", "url": "https://github.com/pytorch/serve/commit/86107596bddd601739a587288a4b5e6249e5c0bc", "message": "updated java installation steps for mac to use openjdk", "committedDate": "2020-01-24T13:17:32Z", "type": "commit"}, {"oid": "433716a59112b39ab2a3e85fd37e3383c3872be2", "url": "https://github.com/pytorch/serve/commit/433716a59112b39ab2a3e85fd37e3383c3872be2", "message": "updated model url", "committedDate": "2020-01-24T13:23:20Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDc5MTkzMA==", "url": "https://github.com/pytorch/serve/pull/15#discussion_r370791930", "bodyText": "Remove hard-coded path.", "author": "alexwong", "createdAt": "2020-01-24T19:00:37Z", "path": "benchmarks/benchmark.py", "diffHunk": "@@ -0,0 +1,480 @@\n+#!/usr/bin/env python3\n+\n+\"\"\"\n+Execute the TorchServe Benchmark.  For instructions, run with the --help flag\n+\"\"\"\n+\n+# pylint: disable=redefined-builtin\n+\n+import argparse\n+import itertools\n+import multiprocessing\n+import os\n+import pprint\n+import shutil\n+import subprocess\n+import sys\n+import time\n+import traceback\n+from functools import reduce\n+from urllib.request import urlretrieve\n+\n+import pandas as pd\n+\n+MODEL_STORE = \"/Users/harsh_bafna/model_store\"", "originalCommit": "433716a59112b39ab2a3e85fd37e3383c3872be2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTYwOTI4Mw==", "url": "https://github.com/pytorch/serve/pull/15#discussion_r371609283", "bodyText": "Done", "author": "dhaniram-kshirsagar", "createdAt": "2020-01-28T04:51:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDc5MTkzMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDc5MjQ0Ng==", "url": "https://github.com/pytorch/serve/pull/15#discussion_r370792446", "bodyText": "Just a mention, but at some point we should stop having to support Python 2 as it's been deprecated as of 2020.", "author": "alexwong", "createdAt": "2020-01-24T19:01:46Z", "path": "benchmarks/install_dependencies.sh", "diffHunk": "@@ -0,0 +1,118 @@\n+#!/bin/bash\n+\n+# Copyright 2018 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+# Licensed under the Apache License, Version 2.0 (the \"License\").\n+# You may not use this file except in compliance with the License.\n+# A copy of the License is located at\n+#     http://www.apache.org/licenses/LICENSE-2.0\n+# or in the \"license\" file accompanying this file. This file is distributed\n+# on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+# express or implied. See the License for the specific language governing\n+# permissions and limitations under the License.\n+\n+# This file contains the installation setup for running benchmarks on EC2 isntance.\n+# To run on a machine with GPU : ./install_dependencies True\n+# To run on a machine with CPU : ./install_dependencies False\n+set -ex\n+\n+sudo apt-get update\n+sudo apt-get -y upgrade\n+echo \"Setting up your Ubuntu machine to load test MMS\"\n+sudo apt-get install -y \\\n+        python \\\n+        python-pip \\", "originalCommit": "433716a59112b39ab2a3e85fd37e3383c3872be2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTYwOTk3NA==", "url": "https://github.com/pytorch/serve/pull/15#discussion_r371609974", "bodyText": "Done.", "author": "dhaniram-kshirsagar", "createdAt": "2020-01-28T04:55:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDc5MjQ0Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDc5NTA3OA==", "url": "https://github.com/pytorch/serve/pull/15#discussion_r370795078", "bodyText": "segments[3].equals(\"predict\")", "author": "alexwong", "createdAt": "2020-01-24T19:08:02Z", "path": "frontend/server/src/main/java/org/pytorch/serve/http/InferenceRequestHandler.java", "diffHunk": "@@ -128,18 +136,23 @@ private void handleLegacyPredict(\n             QueryStringDecoder decoder,\n             String[] segments)\n             throws ModelNotFoundException {\n-        if (segments.length < 3 || !\"predict\".equals(segments[2])) {\n+\n+        String modelVersion = null;\n+        if (segments.length == 4 && \"predict\".equals(segments[3])) {", "originalCommit": "433716a59112b39ab2a3e85fd37e3383c3872be2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTYwOTQ4Nw==", "url": "https://github.com/pytorch/serve/pull/15#discussion_r371609487", "bodyText": "This as per PMD standards and it also protects us from NULL point exception.", "author": "dhaniram-kshirsagar", "createdAt": "2020-01-28T04:52:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDc5NTA3OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDc5NTE3MQ==", "url": "https://github.com/pytorch/serve/pull/15#discussion_r370795171", "bodyText": "segments[2].equals(\"predict\")", "author": "alexwong", "createdAt": "2020-01-24T19:08:15Z", "path": "frontend/server/src/main/java/org/pytorch/serve/http/InferenceRequestHandler.java", "diffHunk": "@@ -128,18 +136,23 @@ private void handleLegacyPredict(\n             QueryStringDecoder decoder,\n             String[] segments)\n             throws ModelNotFoundException {\n-        if (segments.length < 3 || !\"predict\".equals(segments[2])) {\n+\n+        String modelVersion = null;\n+        if (segments.length == 4 && \"predict\".equals(segments[3])) {\n+            modelVersion = segments[2];\n+        } else if (segments.length < 3 || !\"predict\".equals(segments[2])) {", "originalCommit": "433716a59112b39ab2a3e85fd37e3383c3872be2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTYwOTUwNQ==", "url": "https://github.com/pytorch/serve/pull/15#discussion_r371609505", "bodyText": "This as per PMD standards and it also protects us from NULL point exception.", "author": "dhaniram-kshirsagar", "createdAt": "2020-01-28T04:52:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDc5NTE3MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDc5NjAwOA==", "url": "https://github.com/pytorch/serve/pull/15#discussion_r370796008", "bodyText": "Remove or add comment describing what this is for.", "author": "alexwong", "createdAt": "2020-01-24T19:10:20Z", "path": "frontend/server/src/main/java/org/pytorch/serve/http/InferenceRequestHandler.java", "diffHunk": "@@ -151,7 +164,9 @@ private void predict(\n \n         if (HttpMethod.OPTIONS.equals(req.method())) {\n             ModelManager modelManager = ModelManager.getInstance();\n-            Model model = modelManager.getModels().get(modelName);\n+\n+            // ModelVersionedRefs model = modelManager.getModel(modelName, modelVersion);", "originalCommit": "433716a59112b39ab2a3e85fd37e3383c3872be2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTYwOTY3Ng==", "url": "https://github.com/pytorch/serve/pull/15#discussion_r371609676", "bodyText": "Removed commented code.", "author": "dhaniram-kshirsagar", "createdAt": "2020-01-28T04:53:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDc5NjAwOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDc5Njc1OQ==", "url": "https://github.com/pytorch/serve/pull/15#discussion_r370796759", "bodyText": "I've been seeing a lot of checking of strings and stuff for segments which has I guess model name and model version. Would it be better to make it a class so we can directly check if a field is not null rather than checking length each time?", "author": "alexwong", "createdAt": "2020-01-24T19:12:08Z", "path": "frontend/server/src/main/java/org/pytorch/serve/http/ManagementRequestHandler.java", "diffHunk": "@@ -67,12 +67,20 @@ protected void handleRequest(\n                     throw new MethodNotAllowedException();\n                 }\n \n+                String modelVersion = null;\n+                if (segments.length == 4) {", "originalCommit": "433716a59112b39ab2a3e85fd37e3383c3872be2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTYxMDYxNQ==", "url": "https://github.com/pytorch/serve/pull/15#discussion_r371610615", "bodyText": "This is per existing framework however as you have suggested the same can be improved.", "author": "dhaniram-kshirsagar", "createdAt": "2020-01-28T04:59:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDc5Njc1OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDc5NzM1OQ==", "url": "https://github.com/pytorch/serve/pull/15#discussion_r370797359", "bodyText": "segments[4].equals(\"set-default\")", "author": "alexwong", "createdAt": "2020-01-24T19:13:33Z", "path": "frontend/server/src/main/java/org/pytorch/serve/http/ManagementRequestHandler.java", "diffHunk": "@@ -67,12 +67,20 @@ protected void handleRequest(\n                     throw new MethodNotAllowedException();\n                 }\n \n+                String modelVersion = null;\n+                if (segments.length == 4) {\n+                    modelVersion = segments[3];\n+                }\n                 if (HttpMethod.GET.equals(method)) {\n-                    handleDescribeModel(ctx, segments[2]);\n+                    handleDescribeModel(ctx, segments[2], modelVersion);\n                 } else if (HttpMethod.PUT.equals(method)) {\n-                    handleScaleModel(ctx, decoder, segments[2]);\n+                    if (segments.length == 5 && \"set-default\".equals(segments[4])) {", "originalCommit": "433716a59112b39ab2a3e85fd37e3383c3872be2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTYxMDczMw==", "url": "https://github.com/pytorch/serve/pull/15#discussion_r371610733", "bodyText": "This as per PMD standards and it also protects us from NULL point exception.", "author": "dhaniram-kshirsagar", "createdAt": "2020-01-28T04:59:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDc5NzM1OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDc5NzYzNQ==", "url": "https://github.com/pytorch/serve/pull/15#discussion_r370797635", "bodyText": "Why contentEquals vs equals?", "author": "alexwong", "createdAt": "2020-01-24T19:14:06Z", "path": "frontend/server/src/main/java/org/pytorch/serve/http/ManagementRequestHandler.java", "diffHunk": "@@ -84,7 +92,8 @@ protected void handleRequest(\n \n     private boolean isManagementReq(String[] segments) {\n         return segments.length == 0\n-                || ((segments.length == 2 || segments.length == 3) && segments[1].equals(\"models\"))\n+                || ((segments.length >= 2 && segments.length <= 4) && segments[1].equals(\"models\"))\n+                || (segments.length == 5 && segments[4].contentEquals(\"set-default\"))", "originalCommit": "433716a59112b39ab2a3e85fd37e3383c3872be2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTYxMTA0NA==", "url": "https://github.com/pytorch/serve/pull/15#discussion_r371611044", "bodyText": "Changed to equals.", "author": "dhaniram-kshirsagar", "createdAt": "2020-01-28T05:01:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDc5NzYzNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDc5Nzk1Ng==", "url": "https://github.com/pytorch/serve/pull/15#discussion_r370797956", "bodyText": "modelVersion.equals(\"all\")", "author": "alexwong", "createdAt": "2020-01-24T19:14:52Z", "path": "frontend/server/src/main/java/org/pytorch/serve/http/ManagementRequestHandler.java", "diffHunk": "@@ -121,14 +130,29 @@ private void handleListModels(ChannelHandlerContext ctx, QueryStringDecoder deco\n         NettyUtils.sendJsonResponse(ctx, list);\n     }\n \n-    private void handleDescribeModel(ChannelHandlerContext ctx, String modelName)\n+    private void handleDescribeModel(\n+            ChannelHandlerContext ctx, String modelName, String modelVersion)\n             throws ModelNotFoundException {\n         ModelManager modelManager = ModelManager.getInstance();\n-        Model model = modelManager.getModels().get(modelName);\n-        if (model == null) {\n-            throw new ModelNotFoundException(\"Model not found: \" + modelName);\n+        ArrayList<DescribeModelResponse> resp = new ArrayList<DescribeModelResponse>();\n+\n+        if (\"all\".equals(modelVersion)) {", "originalCommit": "433716a59112b39ab2a3e85fd37e3383c3872be2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTYxMTU0Nw==", "url": "https://github.com/pytorch/serve/pull/15#discussion_r371611547", "bodyText": "This is as per PMD. This also helps to avoid null pointer exception.", "author": "dhaniram-kshirsagar", "createdAt": "2020-01-28T05:04:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDc5Nzk1Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDc5ODg4NQ==", "url": "https://github.com/pytorch/serve/pull/15#discussion_r370798885", "bodyText": "Still reading all of the code. But here we check for both model and model version (more strict) but throw a generic modelnotfound exception. If we're checking for model version, I think we should throw some versionnotfound exception (still reading through code so this may not exist in this PR) and only throw modelnotfound if the model was never registered (ie: no versions exist at all).", "author": "alexwong", "createdAt": "2020-01-24T19:16:58Z", "path": "frontend/server/src/main/java/org/pytorch/serve/http/ManagementRequestHandler.java", "diffHunk": "@@ -121,14 +130,29 @@ private void handleListModels(ChannelHandlerContext ctx, QueryStringDecoder deco\n         NettyUtils.sendJsonResponse(ctx, list);\n     }\n \n-    private void handleDescribeModel(ChannelHandlerContext ctx, String modelName)\n+    private void handleDescribeModel(\n+            ChannelHandlerContext ctx, String modelName, String modelVersion)\n             throws ModelNotFoundException {\n         ModelManager modelManager = ModelManager.getInstance();\n-        Model model = modelManager.getModels().get(modelName);\n-        if (model == null) {\n-            throw new ModelNotFoundException(\"Model not found: \" + modelName);\n+        ArrayList<DescribeModelResponse> resp = new ArrayList<DescribeModelResponse>();\n+\n+        if (\"all\".equals(modelVersion)) {\n+            for (Map.Entry<Double, Model> m : modelManager.getAllModelVersions(modelName)) {\n+                resp.add(createModelResponse(modelManager, modelName, m.getValue()));\n+            }\n+        } else {\n+            Model model = modelManager.getModel(modelName, modelVersion);", "originalCommit": "433716a59112b39ab2a3e85fd37e3383c3872be2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTg4MzkzNA==", "url": "https://github.com/pytorch/serve/pull/15#discussion_r371883934", "bodyText": "Done.", "author": "harshbafna", "createdAt": "2020-01-28T15:44:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDc5ODg4NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDc5OTI5NA==", "url": "https://github.com/pytorch/serve/pull/15#discussion_r370799294", "bodyText": "Can unregister model handle modelVersion == null? I can see it being useful to not have to provide a version when unregistering.", "author": "alexwong", "createdAt": "2020-01-24T19:17:49Z", "path": "frontend/server/src/main/java/org/pytorch/serve/http/ManagementRequestHandler.java", "diffHunk": "@@ -216,32 +240,41 @@ private void handleRegisterModel(\n         updateModelWorkers(\n                 ctx,\n                 modelName,\n+                archive.getModelVersion(),\n                 initialWorkers,\n                 initialWorkers,\n                 synchronous,\n                 f -> {\n-                    modelManager.unregisterModel(archive.getModelName());\n+                    modelManager.unregisterModel(archive.getModelName(), archive.getModelVersion());\n                     return null;\n                 });\n     }\n \n-    private void handleUnregisterModel(ChannelHandlerContext ctx, String modelName)\n+    private void handleUnregisterModel(\n+            ChannelHandlerContext ctx, String modelName, String modelVersion)\n             throws ModelNotFoundException, InternalServerException, RequestTimeoutException {\n         ModelManager modelManager = ModelManager.getInstance();\n-        HttpResponseStatus httpResponseStatus = modelManager.unregisterModel(modelName);\n+        HttpResponseStatus httpResponseStatus =\n+                modelManager.unregisterModel(modelName, modelVersion);", "originalCommit": "433716a59112b39ab2a3e85fd37e3383c3872be2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTYxMjA0Ng==", "url": "https://github.com/pytorch/serve/pull/15#discussion_r371612046", "bodyText": "With null version, it will try to remove default however as per our logic, we don't allow default model deletion unless it is the only version available with TorchServe", "author": "dhaniram-kshirsagar", "createdAt": "2020-01-28T05:07:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDc5OTI5NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDgwMjQ2NA==", "url": "https://github.com/pytorch/serve/pull/15#discussion_r370802464", "bodyText": "Where does 25 length restriction come from? We should document this somewhere.", "author": "alexwong", "createdAt": "2020-01-24T19:24:57Z", "path": "frontend/server/src/main/java/org/pytorch/serve/wlm/WorkerLifeCycle.java", "diffHunk": "@@ -117,8 +117,10 @@ public void startWorker(int port) throws WorkerInitializationException, Interrup\n                         \"W-\"\n                                 + port\n                                 + '-'\n-                                + model.getModelName()\n-                                        .substring(0, Math.min(model.getModelName().length(), 25));\n+                                + model.getModelVersionName()\n+                                        .substring(\n+                                                0,\n+                                                Math.min(model.getModelVersionName().length(), 25));", "originalCommit": "433716a59112b39ab2a3e85fd37e3383c3872be2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTYxMjM2NA==", "url": "https://github.com/pytorch/serve/pull/15#discussion_r371612364", "bodyText": "Ported as is from MMS. We will have to discuss this.", "author": "dhaniram-kshirsagar", "createdAt": "2020-01-28T05:09:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDgwMjQ2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTg4NDEyNQ==", "url": "https://github.com/pytorch/serve/pull/15#discussion_r371884125", "bodyText": "Done.", "author": "harshbafna", "createdAt": "2020-01-28T15:45:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDgwMjQ2NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDgwMzI0Mg==", "url": "https://github.com/pytorch/serve/pull/15#discussion_r370803242", "bodyText": "I'm assuming modelversionname = old_model_name + version. Could cause problems is user passes in a long model name.", "author": "alexwong", "createdAt": "2020-01-24T19:26:41Z", "path": "frontend/server/src/main/java/org/pytorch/serve/wlm/WorkerThread.java", "diffHunk": "@@ -322,15 +324,15 @@ public void shutdown() {\n     }\n \n     private final String getWorkerName() {\n-        String modelName = model.getModelName();\n+        String modelName = model.getModelVersionName();\n         if (modelName.length() > 25) {\n             modelName = modelName.substring(0, 25);", "originalCommit": "433716a59112b39ab2a3e85fd37e3383c3872be2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTYxMjQ0MQ==", "url": "https://github.com/pytorch/serve/pull/15#discussion_r371612441", "bodyText": "See earlier comment for name length", "author": "dhaniram-kshirsagar", "createdAt": "2020-01-28T05:09:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDgwMzI0Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTg4NDY3MA==", "url": "https://github.com/pytorch/serve/pull/15#discussion_r371884670", "bodyText": "Done.", "author": "harshbafna", "createdAt": "2020-01-28T15:45:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDgwMzI0Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDgwMzU1NQ==", "url": "https://github.com/pytorch/serve/pull/15#discussion_r370803555", "bodyText": "Why are the eager and ts tests removed?", "author": "alexwong", "createdAt": "2020-01-24T19:27:21Z", "path": "frontend/server/src/test/java/org/pytorch/serve/ModelServerTest.java", "diffHunk": "@@ -284,75 +293,38 @@ private void testDescribeApi(Channel channel) throws InterruptedException {\n         Assert.assertEquals(result, noopApiResult);\n     }\n \n-    private void testLoadModel(Channel channel) throws InterruptedException {\n-        result = null;\n-        latch = new CountDownLatch(1);\n-        HttpRequest req =\n-                new DefaultFullHttpRequest(\n-                        HttpVersion.HTTP_1_1,\n-                        HttpMethod.POST,\n-                        \"/models?url=noop.mar&model_name=noop_v1.0&runtime=python&synchronous=false\");\n-        channel.writeAndFlush(req);\n-        latch.await();\n-\n-        StatusResponse resp = JsonUtils.GSON.fromJson(result, StatusResponse.class);\n-        Assert.assertEquals(resp.getStatus(), \"Model \\\"noop_v1.0\\\" registered\");\n-    }\n-\n-    private void testLoadModelEager(Channel channel) throws InterruptedException {", "originalCommit": "433716a59112b39ab2a3e85fd37e3383c3872be2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTYxMjY2OQ==", "url": "https://github.com/pytorch/serve/pull/15#discussion_r371612669", "bodyText": "These test cases have not been removed rather we have generalized the testLoadModel method to include these. This is to take care of code repetition", "author": "dhaniram-kshirsagar", "createdAt": "2020-01-28T05:11:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDgwMzU1NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDgwMzcyNw==", "url": "https://github.com/pytorch/serve/pull/15#discussion_r370803727", "bodyText": "Why are these removed?", "author": "alexwong", "createdAt": "2020-01-24T19:27:44Z", "path": "frontend/server/src/test/java/org/pytorch/serve/ModelServerTest.java", "diffHunk": "@@ -473,79 +435,62 @@ private void testListModels(Channel channel) throws InterruptedException {\n         Assert.assertEquals(resp.getModels().size(), 1);\n     }\n \n-    private void testDescribeModel(Channel channel) throws InterruptedException {\n+    private void testDescribeModel(\n+            Channel channel, String modelName, String requestVersion, String expectedVersion)\n+            throws InterruptedException {\n         result = null;\n         latch = new CountDownLatch(1);\n+        String requestURL = \"/models/\" + modelName;\n+        if (requestVersion != null) {\n+            requestURL += \"/\" + requestVersion;\n+        }\n         HttpRequest req =\n-                new DefaultFullHttpRequest(\n-                        HttpVersion.HTTP_1_1, HttpMethod.GET, \"/models/noop_v1.0\");\n+                new DefaultFullHttpRequest(HttpVersion.HTTP_1_1, HttpMethod.GET, requestURL);\n         channel.writeAndFlush(req);\n         latch.await();\n \n-        DescribeModelResponse resp = JsonUtils.GSON.fromJson(result, DescribeModelResponse.class);\n-        Assert.assertTrue(resp.getWorkers().size() > 1);\n+        DescribeModelResponse[] resp =\n+                JsonUtils.GSON.fromJson(result, DescribeModelResponse[].class);\n+        if (\"all\".equals(requestVersion)) {\n+            Assert.assertTrue(resp.length >= 1);\n+        } else {\n+            Assert.assertTrue(resp.length == 1);\n+        }\n+        Assert.assertTrue(expectedVersion.equals(resp[0].getModelVersion()));\n     }\n \n-    private void testPredictions(Channel channel) throws InterruptedException {\n+    private void testSetDefault(Channel channel, String modelName, String defaultVersion)\n+            throws InterruptedException {\n         result = null;\n         latch = new CountDownLatch(1);\n-        DefaultFullHttpRequest req =\n-                new DefaultFullHttpRequest(\n-                        HttpVersion.HTTP_1_1, HttpMethod.POST, \"/predictions/noop\");\n-        req.content().writeCharSequence(\"data=test\", CharsetUtil.UTF_8);\n-        HttpUtil.setContentLength(req, req.content().readableBytes());\n-        req.headers()\n-                .set(\n-                        HttpHeaderNames.CONTENT_TYPE,\n-                        HttpHeaderValues.APPLICATION_X_WWW_FORM_URLENCODED);\n-        channel.writeAndFlush(req);\n+        String requestURL = \"/models/\" + modelName + \"/\" + defaultVersion + \"/set-default\";\n \n-        latch.await();\n-        Assert.assertEquals(result, \"OK\");\n-    }\n-\n-    private void testPredictionsEager(Channel channel) throws InterruptedException {", "originalCommit": "433716a59112b39ab2a3e85fd37e3383c3872be2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTYxMjc3Mw==", "url": "https://github.com/pytorch/serve/pull/15#discussion_r371612773", "bodyText": "Same comment as earlier for test case removal.", "author": "dhaniram-kshirsagar", "createdAt": "2020-01-28T05:11:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDgwMzcyNw=="}], "type": "inlineReview"}, {"oid": "977d052c6c6eeed693fa570691623d3c0eef8f36", "url": "https://github.com/pytorch/serve/commit/977d052c6c6eeed693fa570691623d3c0eef8f36", "message": "Corrected benchmark test script per torchserve", "committedDate": "2020-01-27T12:28:22Z", "type": "commit"}, {"oid": "818e6ec232386d47ce33ebf6caf092097cb75048", "url": "https://github.com/pytorch/serve/commit/818e6ec232386d47ce33ebf6caf092097cb75048", "message": "Changes for review comments", "committedDate": "2020-01-28T05:52:44Z", "type": "commit"}, {"oid": "09931c26f4fd6f6e998f3fe2ec21e91aad5fe025", "url": "https://github.com/pytorch/serve/commit/09931c26f4fd6f6e998f3fe2ec21e91aad5fe025", "message": "updated formatting", "committedDate": "2020-01-28T05:59:02Z", "type": "commit"}, {"oid": "2d7fd30f3302eacb031c406531f8540c189fcaa7", "url": "https://github.com/pytorch/serve/commit/2d7fd30f3302eacb031c406531f8540c189fcaa7", "message": "updated unregister failure test case", "committedDate": "2020-01-28T08:51:57Z", "type": "commit"}, {"oid": "79aa2ef787248d08b4c2c7d7283f8be56225e705", "url": "https://github.com/pytorch/serve/commit/79aa2ef787248d08b4c2c7d7283f8be56225e705", "message": "added ModelVersionNotFoundException", "committedDate": "2020-01-28T09:21:11Z", "type": "commit"}, {"oid": "3b9be4aaaa988976e6ffab40a6d2aa6c3ca6b7fa", "url": "https://github.com/pytorch/serve/commit/3b9be4aaaa988976e6ffab40a6d2aa6c3ca6b7fa", "message": "updated formatting and made changes as per UT", "committedDate": "2020-01-28T09:37:52Z", "type": "commit"}, {"oid": "2a53bb5e62b2a712680f1c725208df3d3c2c085a", "url": "https://github.com/pytorch/serve/commit/2a53bb5e62b2a712680f1c725208df3d3c2c085a", "message": "updated wlm to use ModelVersionName object as key", "committedDate": "2020-01-28T11:58:26Z", "type": "commit"}, {"oid": "5afc163eb8ce404b3221439f501cb120793a639b", "url": "https://github.com/pytorch/serve/commit/5afc163eb8ce404b3221439f501cb120793a639b", "message": "incorporated code review comments", "committedDate": "2020-01-28T12:22:49Z", "type": "commit"}, {"oid": "ca207f5e98a89f0df73adc4f54d72e8ed696c29e", "url": "https://github.com/pytorch/serve/commit/ca207f5e98a89f0df73adc4f54d72e8ed696c29e", "message": "removed versionedModelName length restriction", "committedDate": "2020-01-28T12:30:47Z", "type": "commit"}, {"oid": "e75d4bcbd0fe4ce4b11888253732f5bdadd9e9aa", "url": "https://github.com/pytorch/serve/commit/e75d4bcbd0fe4ce4b11888253732f5bdadd9e9aa", "message": "Merge pull request #17 from pytorch/docker_init\n\nAdd example Dockerfile", "committedDate": "2020-01-28T12:40:45Z", "type": "commit"}, {"oid": "0c66c7c53848e329232bdf0c7626003b14b861ac", "url": "https://github.com/pytorch/serve/commit/0c66c7c53848e329232bdf0c7626003b14b861ac", "message": "Added local python package installation support", "committedDate": "2020-01-28T12:46:22Z", "type": "commit"}, {"oid": "e7a26d0cfec8c69f35d1d93a6758a299480a1fa8", "url": "https://github.com/pytorch/serve/commit/e7a26d0cfec8c69f35d1d93a6758a299480a1fa8", "message": "Fixed jdk issue for ubuntu", "committedDate": "2020-01-28T12:47:45Z", "type": "commit"}, {"oid": "50e7d8d2956661aa83048e7f4eaadab5f24828c9", "url": "https://github.com/pytorch/serve/commit/50e7d8d2956661aa83048e7f4eaadab5f24828c9", "message": "added docker and code coverage documentation", "committedDate": "2020-01-28T14:05:14Z", "type": "commit"}, {"oid": "93cb11b108a4b319d561599897ddd842196d4e05", "url": "https://github.com/pytorch/serve/commit/93cb11b108a4b319d561599897ddd842196d4e05", "message": "updated benchmarking script and doc", "committedDate": "2020-01-28T14:38:02Z", "type": "commit"}, {"oid": "109a2b8f65d7e0b2bb38a57c14016698644dd4a6", "url": "https://github.com/pytorch/serve/commit/109a2b8f65d7e0b2bb38a57c14016698644dd4a6", "message": "added benchmark reports' path in README", "committedDate": "2020-01-28T15:48:53Z", "type": "commit"}, {"oid": "70ddeae9c29755528ef2ad0fe1e318ad396f135e", "url": "https://github.com/pytorch/serve/commit/70ddeae9c29755528ef2ad0fe1e318ad396f135e", "message": "merged master and resolved confilcts", "committedDate": "2020-01-29T05:56:45Z", "type": "commit"}, {"oid": "b499bfe4744ea79cdb813e43df237ea129407d19", "url": "https://github.com/pytorch/serve/commit/b499bfe4744ea79cdb813e43df237ea129407d19", "message": "updated documentation to replace TS with TorchServe and add version in torch-model-archiver command", "committedDate": "2020-01-29T06:09:29Z", "type": "commit"}, {"oid": "2a0d41a8409b7d48334f2ac21b24552c6f2c0eac", "url": "https://github.com/pytorch/serve/commit/2a0d41a8409b7d48334f2ac21b24552c6f2c0eac", "message": "added example to create resnet-18.mar and added reference to docker and benchmark readme", "committedDate": "2020-01-29T06:52:49Z", "type": "commit"}, {"oid": "d6bb935b26fbc5fb252e932c9e8ac0efada9fa44", "url": "https://github.com/pytorch/serve/commit/d6bb935b26fbc5fb252e932c9e8ac0efada9fa44", "message": "fixed small issue in benchmark script found during testing", "committedDate": "2020-01-29T07:03:21Z", "type": "commit"}]}