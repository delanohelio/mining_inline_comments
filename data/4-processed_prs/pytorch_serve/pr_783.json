{"pr_number": 783, "pr_title": "Fixed: Model reader logging bugs.", "pr_createdAt": "2020-11-13T21:33:39Z", "pr_url": "https://github.com/pytorch/serve/pull/783", "timeline": [{"oid": "140bcca7b79025146b045d42fb01736d1b007360", "url": "https://github.com/pytorch/serve/commit/140bcca7b79025146b045d42fb01736d1b007360", "message": "Fixed: Model reader logging bugs.\n\n* The lines read from the stdout/stderr of the handler will now be\nlogged on a distinct logger (the MODEL_LOGGER). This gives much finer\ngrained control over logging in custom handlers.\n* The metrics logger is now initialized via and sl4j logging factory\nrather than through log4j. The call to log metrics was slightly modified\nto fit with this more generic logger which only accepts String\narguments.", "committedDate": "2020-11-13T21:47:42Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NDgxNDU4MA==", "url": "https://github.com/pytorch/serve/pull/783#discussion_r594814580", "bodyText": "These changes store model log in separate log files. It is much easier for user to control model log format. The only problem is that the mapping information b/w frontend worker thread id and backend worker pid is missing. It will be difficult to debug TS to detect if there is sth wrong with frontend worker thread.", "author": "lxning", "createdAt": "2021-03-16T02:18:58Z", "path": "frontend/server/src/main/java/org/pytorch/serve/wlm/WorkerLifeCycle.java", "diffHunk": "@@ -141,8 +141,10 @@ private synchronized void setPort(int port) {\n         private boolean error;\n         private WorkerLifeCycle lifeCycle;\n         private AtomicBoolean isRunning = new AtomicBoolean(true);\n-        private static final org.apache.log4j.Logger loggerModelMetrics =\n-                org.apache.log4j.Logger.getLogger(ConfigManager.MODEL_METRICS_LOGGER);\n+        private static final Logger loggerModelMetrics =\n+                LoggerFactory.getLogger(ConfigManager.MODEL_METRICS_LOGGER);\n+        private static final Logger loggerModelOutput =\n+                LoggerFactory.getLogger(ConfigManager.MODEL_LOGGER);\n ", "originalCommit": "d691dda23759a83c1d00818615bb8ded612d6e2a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NTEyMjk0Nw==", "url": "https://github.com/pytorch/serve/pull/783#discussion_r595122947", "bodyText": "Hi, thanks for having a look. Where do you think the PID message should end up?", "author": "aparmentier-coveo", "createdAt": "2021-03-16T12:30:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NDgxNDU4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NTQwNTM2NQ==", "url": "https://github.com/pytorch/serve/pull/783#discussion_r595405365", "bodyText": "current model log example as following:\n2021-03-16 17:27:09,260 [INFO ] W-9001-vgg11_v2_1.0-stdout org.pytorch.serve.wlm.WorkerLifeCycle - Connection accepted: /home/model-server/tmp/.ts.sock.9001.\nthis pr model log example as following. Here, it is difficult to know which frontend worker thread has problem from the log.\n2021-03-16 02:02:41,569 [INFO ] MODEL_LOG - Listening on port: /home/model-server/tmp/.ts.sock.9006\n2021-03-16 02:02:41,576 [INFO ] MODEL_LOG - Listening on port: /home/model-server/tmp/.ts.sock.9002\n2021-03-16 02:02:41,573 [INFO ] MODEL_LOG - Listening on port: /home/model-server/tmp/.ts.sock.9009\n2021-03-16 02:02:41,566 [INFO ] MODEL_LOG - Listening on port: /home/model-server/tmp/.ts.sock.9015\n2021-03-16 02:02:41,562 [INFO ] MODEL_LOG - Listening on port: /home/model-server/tmp/.ts.sock.9014\n2021-03-16 02:02:41,562 [INFO ] MODEL_LOG - Listening on port: /home/model-server/tmp/.ts.sock.9007\n2021-03-16 02:02:41,587 [INFO ] MODEL_LOG - [PID]55\n2021-03-16 02:02:41,588 [INFO ] MODEL_LOG - Torch worker started.\n2021-03-16 02:02:41,588 [INFO ] MODEL_LOG - Python runtime: 3.6.9\n2021-03-16 02:02:41,587 [INFO ] MODEL_LOG - [PID]54\n2021-03-16 02:02:41,589 [INFO ] MODEL_LOG - [PID]56\n2021-03-16 02:02:41,589 [INFO ] MODEL_LOG - [PID]59\n2021-03-16 02:02:41,589 [INFO ] MODEL_LOG - Torch worker started.\n2021-03-16 02:02:41,590 [INFO ] MODEL_LOG - [PID]58\n2021-03-16 02:02:41,590 [INFO ] MODEL_LOG - [PID]57\n2021-03-16 02:02:41,590 [INFO ] MODEL_LOG - Listening on port: /home/model-server/tmp/.ts.sock.9004\n2021-03-16 02:02:41,592 [INFO ] MODEL_LOG - Torch worker started.\n2021-03-16 02:02:41,592 [INFO ] MODEL_LOG - Torch worker started.\n2021-03-16 02:02:41,593 [INFO ] MODEL_LOG - Python runtime: 3.6.9\n2021-03-16 02:02:41,591 [INFO ] MODEL_LOG - Python runtime: 3.6.9\n2021-03-16 02:02:41,591 [INFO ] MODEL_LOG - Torch worker started.\n2021-03-16 02:02:41,590 [INFO ] MODEL_LOG - Torch worker started.\n2021-03-16 02:02:41,593 [INFO ] MODEL_LOG - Python runtime: 3.6.9\n2021-03-16 02:02:41,593 [INFO ] MODEL_LOG - [PID]79\nIt would be very helpful if each message contains frontend worker thread id (eg. W-9001-vgg11_v2_1.0)  information in the model log.", "author": "lxning", "createdAt": "2021-03-16T17:46:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NDgxNDU4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NTUzMzA0MA==", "url": "https://github.com/pytorch/serve/pull/783#discussion_r595533040", "bodyText": "Oh I see, thank you. I think that would just be a change to the log4j default settings for the MODEL_LOG. I'll experiment and probably update this PR tomorrow.", "author": "aparmentier-coveo", "createdAt": "2021-03-16T20:54:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NDgxNDU4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NTU1OTA1Ng==", "url": "https://github.com/pytorch/serve/pull/783#discussion_r595559056", "bodyText": "Thanks a lot.", "author": "lxning", "createdAt": "2021-03-16T21:38:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NDgxNDU4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NjM3MTY5Nw==", "url": "https://github.com/pytorch/serve/pull/783#discussion_r596371697", "bodyText": "I rebased and updated the default logging pattern format for MODEL_LOG to be the same as the other logs which include a thread name.\nCheers,\nAlex", "author": "aparmentier-coveo", "createdAt": "2021-03-17T20:49:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NDgxNDU4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NjUyMjUxMw==", "url": "https://github.com/pytorch/serve/pull/783#discussion_r596522513", "bodyText": "It works. Thank you!", "author": "lxning", "createdAt": "2021-03-18T03:13:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NDgxNDU4MA=="}], "type": "inlineReview"}, {"oid": "ebdfce3ac6b1d267092f9388a5c9963d3b654126", "url": "https://github.com/pytorch/serve/commit/ebdfce3ac6b1d267092f9388a5c9963d3b654126", "message": "Fixed: Model reader logging bugs.\n\n* The lines read from the stdout/stderr of the handler will now be\nlogged on a distinct logger (the MODEL_LOGGER). This gives much finer\ngrained control over logging in custom handlers.\n* The metrics logger is now initialized via and sl4j logging factory\nrather than through log4j. The call to log metrics was slightly modified\nto fit with this more generic logger which only accepts String\narguments.", "committedDate": "2021-03-17T20:47:08Z", "type": "commit"}, {"oid": "810eee04605c50a15661c17398383ffef3c0617b", "url": "https://github.com/pytorch/serve/commit/810eee04605c50a15661c17398383ffef3c0617b", "message": "Fixed: MODEL_LOG thread name added.", "committedDate": "2021-03-17T20:47:08Z", "type": "commit"}, {"oid": "810eee04605c50a15661c17398383ffef3c0617b", "url": "https://github.com/pytorch/serve/commit/810eee04605c50a15661c17398383ffef3c0617b", "message": "Fixed: MODEL_LOG thread name added.", "committedDate": "2021-03-17T20:47:08Z", "type": "forcePushed"}, {"oid": "26f9b5ba9d43ac384a7ca7b95a26a7fb1987ba4b", "url": "https://github.com/pytorch/serve/commit/26f9b5ba9d43ac384a7ca7b95a26a7fb1987ba4b", "message": "Merge branch 'master' into logging/fix-model-reader", "committedDate": "2021-04-16T19:06:10Z", "type": "commit"}, {"oid": "f090d6ced3da95287fca96a48ac06bf73fb170bb", "url": "https://github.com/pytorch/serve/commit/f090d6ced3da95287fca96a48ac06bf73fb170bb", "message": "Merge branch 'master' into logging/fix-model-reader", "committedDate": "2021-04-19T16:16:05Z", "type": "commit"}, {"oid": "f5f3bbba5bb8b1910d57a7571da19e3c6608b571", "url": "https://github.com/pytorch/serve/commit/f5f3bbba5bb8b1910d57a7571da19e3c6608b571", "message": "Merge branch 'master' into logging/fix-model-reader", "committedDate": "2021-04-19T16:50:24Z", "type": "commit"}]}