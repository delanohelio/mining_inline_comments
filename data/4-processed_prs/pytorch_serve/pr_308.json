{"pr_number": 308, "pr_title": "Dockerfile enhancements", "pr_createdAt": "2020-05-07T17:17:04Z", "pr_url": "https://github.com/pytorch/serve/pull/308", "timeline": [{"oid": "5af7ba9870a250b9a274b4346084c450b6a6be1b", "url": "https://github.com/pytorch/serve/commit/5af7ba9870a250b9a274b4346084c450b6a6be1b", "message": "dockerfile now points to latest torchserve on pypi and added separate files for dev", "committedDate": "2020-05-07T16:55:59Z", "type": "commit"}, {"oid": "b788f04ac4b756e8cf32cc5db354c053705f3742", "url": "https://github.com/pytorch/serve/commit/b788f04ac4b756e8cf32cc5db354c053705f3742", "message": "Minor changes", "committedDate": "2020-05-07T17:36:55Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTY3OTg4NQ==", "url": "https://github.com/pytorch/serve/pull/308#discussion_r421679885", "bodyText": "Can't we have a separate requirements.txt in docker folder with all the required packages. That way we can simply COPY requirements.txt in the docker file and RUN pip install -r requirements.txt in all the Dockerfiles. We will have one place to update if we need to add packages or pin the versions of packages right?", "author": "vdantu", "createdAt": "2020-05-07T17:41:38Z", "path": "docker/Dockerfile.cpu", "diffHunk": "@@ -20,12 +20,7 @@ RUN apt-get update && \\\n RUN update-alternatives --install /usr/bin/python python /usr/bin/python3 1\n RUN update-alternatives --install /usr/local/bin/pip pip /usr/local/bin/pip3 1\n \n-RUN pip install --no-cache-dir psutil\n-RUN pip install --no-cache-dir torch\n-RUN pip install --no-cache-dir torchvision\n-RUN pip install --no-cache-dir torchtext\n-ADD serve serve\n-RUN pip install ../serve/\n+RUN pip install --no-cache-dir psutil future torch torchvision torchtext torchserve", "originalCommit": "5af7ba9870a250b9a274b4346084c450b6a6be1b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjU5ODQ4Ng==", "url": "https://github.com/pytorch/serve/pull/308#discussion_r422598486", "bodyText": "@vdantu There is a separate GH issues for requirements.txt -- this can be tackled as part of its sol", "author": "chauhang", "createdAt": "2020-05-10T06:58:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTY3OTg4NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzkzMzE3MQ==", "url": "https://github.com/pytorch/serve/pull/308#discussion_r423933171", "bodyText": "@vdantu @chauhang I have added you both in this PR for a separate requirements.txt\nPlease review and comment there as well. Thanks.\n#228", "author": "mycpuorg", "createdAt": "2020-05-12T18:07:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTY3OTg4NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTczNjQyMg==", "url": "https://github.com/pytorch/serve/pull/308#discussion_r425736422", "bodyText": "#228 will address the requirement.txt and new issue can be created to incorporate those changes in new Dockerfile. Please suggest.", "author": "dhaniram-kshirsagar", "createdAt": "2020-05-15T11:22:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTY3OTg4NQ=="}], "type": "inlineReview"}, {"oid": "88df06b71933cfd64964c3ba8c2d360b38b3eea1", "url": "https://github.com/pytorch/serve/commit/88df06b71933cfd64964c3ba8c2d360b38b3eea1", "message": "Made build and run commands consistent", "committedDate": "2020-05-08T06:36:51Z", "type": "commit"}, {"oid": "6b6044970a6aee4a38badb0b152061a25ec5ae8b", "url": "https://github.com/pytorch/serve/commit/6b6044970a6aee4a38badb0b152061a25ec5ae8b", "message": "Fixing formatting", "committedDate": "2020-05-08T06:38:20Z", "type": "commit"}, {"oid": "adcae965086948e39c8a2e940ac7434974825648", "url": "https://github.com/pytorch/serve/commit/adcae965086948e39c8a2e940ac7434974825648", "message": "Consistency issue", "committedDate": "2020-05-08T06:40:07Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjU5NzU0OA==", "url": "https://github.com/pytorch/serve/pull/308#discussion_r422597548", "bodyText": "@dhaniram-kshirsagar The model archiver also need to be added to the docker during production install. Add the pip install for that as well", "author": "chauhang", "createdAt": "2020-05-10T06:49:27Z", "path": "docker/Dockerfile.cpu", "diffHunk": "@@ -20,12 +20,7 @@ RUN apt-get update && \\\n RUN update-alternatives --install /usr/bin/python python /usr/bin/python3 1\n RUN update-alternatives --install /usr/local/bin/pip pip /usr/local/bin/pip3 1\n \n-RUN pip install --no-cache-dir psutil\n-RUN pip install --no-cache-dir torch\n-RUN pip install --no-cache-dir torchvision\n-RUN pip install --no-cache-dir torchtext\n-ADD serve serve\n-RUN pip install ../serve/\n+RUN pip install --no-cache-dir psutil future torch torchvision torchtext torchserve", "originalCommit": "adcae965086948e39c8a2e940ac7434974825648", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjU5NzYwMA==", "url": "https://github.com/pytorch/serve/pull/308#discussion_r422597600", "bodyText": "@dhaniram-kshirsagar Add the pip install from model archiver as well", "author": "chauhang", "createdAt": "2020-05-10T06:50:03Z", "path": "docker/Dockerfile.gpu", "diffHunk": "@@ -21,10 +21,7 @@ RUN update-alternatives --install /usr/bin/python python /usr/bin/python3 1\n RUN update-alternatives --install /usr/local/bin/pip pip /usr/local/bin/pip3 1\n \n RUN export USE_CUDA=1\n-RUN pip install psutil future torch torchvision torchtext\n-RUN pip install --no-cache-dir psutil\n-ADD serve serve\n-RUN pip install ../serve/\n+RUN pip install --no-cache-dir psutil future torch torchvision torchtext torchserve", "originalCommit": "adcae965086948e39c8a2e940ac7434974825648", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjU5ODQwNA==", "url": "https://github.com/pytorch/serve/pull/308#discussion_r422598404", "bodyText": "@dhaniram-kshirsagar Why are g++, python3-dev, vim needed for production version of docker containers? Please review and remove any non essential items. This will help in reducing the size of the docker container and speedup the launch time", "author": "chauhang", "createdAt": "2020-05-10T06:57:25Z", "path": "docker/Dockerfile.cpu", "diffHunk": "@@ -9,7 +9,7 @@ RUN apt-get update && \\\n     dpkg-dev \\\n     g++ \\", "originalCommit": "adcae965086948e39c8a2e940ac7434974825648", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTczNTAyNw==", "url": "https://github.com/pytorch/serve/pull/308#discussion_r425735027", "bodyText": "PR #309 for #178 is addressing this and other concerns related to dockerfile in this PR. Also, #309 will result in single docker file for cpu and gpu. #309 is almost done with respect to multi-stage and buildkit hence planning to merge #309 changes to this PR to avoid duplication of work.  Please have a look at comments in #309.", "author": "dhaniram-kshirsagar", "createdAt": "2020-05-15T11:19:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjU5ODQwNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjU5ODc2MQ==", "url": "https://github.com/pytorch/serve/pull/308#discussion_r422598761", "bodyText": "Please remove from all the docker files", "author": "chauhang", "createdAt": "2020-05-10T07:00:54Z", "path": "docker/Dockerfile_dev.gpu", "diffHunk": "@@ -0,0 +1,47 @@\n+FROM nvidia/cuda:10.1-cudnn7-runtime-ubuntu18.04\n+\n+ENV PYTHONUNBUFFERED TRUE\n+\n+RUN apt-get update && \\\n+    DEBIAN_FRONTEND=noninteractive apt-get install --no-install-recommends -y \\\n+    fakeroot \\\n+    ca-certificates \\\n+    dpkg-dev \\\n+    g++ \\\n+    python3-dev \\\n+    openjdk-11-jdk-headless \\\n+    curl \\\n+    vim \\\n+    && rm -rf /var/lib/apt/lists/* \\\n+    && cd /tmp \\\n+    && curl -O https://bootstrap.pypa.io/get-pip.py \\\n+    && python3 get-pip.py\n+\n+RUN update-alternatives --install /usr/bin/python python /usr/bin/python3 1\n+RUN update-alternatives --install /usr/local/bin/pip pip /usr/local/bin/pip3 1\n+\n+RUN export USE_CUDA=1\n+RUN pip install psutil future torch torchvision torchtext\n+ADD serve serve\n+RUN pip install ../serve/\n+\n+RUN useradd -m model-server \\\n+    && mkdir -p /home/model-server/tmp\n+\n+COPY dockerd-entrypoint.sh /usr/local/bin/dockerd-entrypoint.sh\n+\n+RUN chmod +x /usr/local/bin/dockerd-entrypoint.sh \\\n+    && chown -R model-server /home/model-server\n+\n+COPY config.properties /home/model-server/config.properties\n+RUN mkdir /home/model-server/model-store && chown -R model-server /home/model-server/model-store\n+\n+EXPOSE 8080 8081\n+\n+USER model-server\n+WORKDIR /home/model-server\n+ENV TEMP=/home/model-server/tmp\n+ENTRYPOINT [\"/usr/local/bin/dockerd-entrypoint.sh\"]\n+CMD [\"serve\"]\n+\n+LABEL maintainer=\"wongale@amazon.com\"", "originalCommit": "adcae965086948e39c8a2e940ac7434974825648", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjYwMjcyNQ==", "url": "https://github.com/pytorch/serve/pull/308#discussion_r422602725", "bodyText": "@dhaniram-kshirsagar The docker dev build command throws many errors for the failing gradle tests while the build is happening\n 5 tests completed, 1 failed\n  \n  > Task :server:test FAILED\n  > Task :server:jacocoTestReport\n  \n  FAILURE: Build failed with an exception.\n  \n  * What went wrong:\n  Execution failed for task ':server:test'.\n  > There were failing tests. See the report at: file:///serve/frontend/server/build/reports/tests/test/index.html\n\nHowever after this it still proceeds and creates a container.\nFailed to build torchserve\nInstalling collected packages: torchserve\n    Running setup.py install for torchserve: started\n    Running setup.py install for torchserve: still running...\n    Running setup.py install for torchserve: still running...\n    Running setup.py install for torchserve: finished with status 'done'\nSuccessfully installed torchserve-0.0.1b20200510\nRemoving intermediate container a7e2317f538d\n ---> b30ed2bfdf4f\nStep 9/20 : RUN useradd -m model-server     && mkdir -p /home/model-server/tmp\n....\n\n\nPlease fix the errors so that all the gradle tests work fine which will be needed for the development build.\nNote: The build for branch issue_266 worked fine, so unclear where the error is.\n./build_image.sh -b issue_266 -t torchserver:dev gave no errors", "author": "chauhang", "createdAt": "2020-05-10T07:39:02Z", "path": "docker/README.md", "diffHunk": "@@ -54,27 +68,50 @@ The TorchServe's inference and management APIs can be accessed on localhost over\n curl http://localhost:8080/ping\n ```\n \n-#### Check running containers\n+# Create TorchServe docker image from source\n+\n+The following are examples on how to use the `build_image.sh` script to build Docker images to support CPU or GPU inference.\n+\n+To build the TorchServe image for a CPU device using the `master` branch, use the following command:\n \n ```bash\n-docker ps\n+./build_image.sh", "originalCommit": "adcae965086948e39c8a2e940ac7434974825648", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjgxODc0Mw==", "url": "https://github.com/pytorch/serve/pull/308#discussion_r426818743", "bodyText": "I tried to reproduce this with latest changes however no luck. IMO, fixes #352 and #341 should take care of these intermittent build failures.", "author": "dhaniram-kshirsagar", "createdAt": "2020-05-18T18:32:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjYwMjcyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzUzNzUwOQ==", "url": "https://github.com/pytorch/serve/pull/308#discussion_r427537509", "bodyText": "Again tried different combinations to repro this however still no luck. With changes in this PR [branch -> issue_266]\ncd docker\n./build_image.sh [checkout master]\n--> successfully created image\n\nintroduce some error in any of java file [to fail the build]\nmodify the build_image.sh so that it uses existing serve\n-finally execute script\n./build_image.sh\n--> build fails and no docker file is created.\n\nPlease provide details if the above steps are incorrect.", "author": "dhaniram-kshirsagar", "createdAt": "2020-05-19T19:10:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjYwMjcyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODgzMjg1Ng==", "url": "https://github.com/pytorch/serve/pull/308#discussion_r428832856", "bodyText": "Verified that this works on branch issue_266", "author": "maaquib", "createdAt": "2020-05-21T18:24:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjYwMjcyNQ=="}], "type": "inlineReview"}, {"oid": "929afd8c98c10b6517d5356c7ee72fcdbadac249", "url": "https://github.com/pytorch/serve/commit/929afd8c98c10b6517d5356c7ee72fcdbadac249", "message": "Enhanced Dockerfile for binary per #178 and other misc.", "committedDate": "2020-05-18T15:49:34Z", "type": "commit"}, {"oid": "fad8c6d4b076db662c7f2c74d7f53b227907249d", "url": "https://github.com/pytorch/serve/commit/fad8c6d4b076db662c7f2c74d7f53b227907249d", "message": "Fixed gpu related issues in start script", "committedDate": "2020-05-18T18:10:10Z", "type": "commit"}, {"oid": "ad92e924a602abad63d829c470efcff0cde0d9f9", "url": "https://github.com/pytorch/serve/commit/ad92e924a602abad63d829c470efcff0cde0d9f9", "message": "Corrected the heading font", "committedDate": "2020-05-18T18:16:02Z", "type": "commit"}, {"oid": "650c2feca01a2e7cfaae17d506f59861efbfad58", "url": "https://github.com/pytorch/serve/commit/650c2feca01a2e7cfaae17d506f59861efbfad58", "message": "Added mar creation steps from container", "committedDate": "2020-05-18T19:06:34Z", "type": "commit"}, {"oid": "120526bd27391f104caba8cf00f4917d1f54737e", "url": "https://github.com/pytorch/serve/commit/120526bd27391f104caba8cf00f4917d1f54737e", "message": "Merge branch 'issue_266' of https://github.com/pytorch/serve into issue_266", "committedDate": "2020-05-18T19:06:54Z", "type": "commit"}, {"oid": "8929d0e655f2b0966dea4f1c754328f31006a295", "url": "https://github.com/pytorch/serve/commit/8929d0e655f2b0966dea4f1c754328f31006a295", "message": "added buildkit support for dev docker files", "committedDate": "2020-05-19T13:21:43Z", "type": "commit"}, {"oid": "72f9d5d2f51be599203cf44942bdd60fa4a87fdb", "url": "https://github.com/pytorch/serve/commit/72f9d5d2f51be599203cf44942bdd60fa4a87fdb", "message": "Merge branch 'staging_0_1_1' into issue_266", "committedDate": "2020-05-19T13:22:27Z", "type": "commit"}, {"oid": "824d912e99adb4c6712c7efbf9580779e654c676", "url": "https://github.com/pytorch/serve/commit/824d912e99adb4c6712c7efbf9580779e654c676", "message": "Merge branch 'issue_266' of https://github.com/pytorch/serve into issue_266", "committedDate": "2020-05-19T13:22:47Z", "type": "commit"}, {"oid": "1fb39cb2500898da19507405fb20f08cadbcc528", "url": "https://github.com/pytorch/serve/commit/1fb39cb2500898da19507405fb20f08cadbcc528", "message": "Fix for buildkit", "committedDate": "2020-05-19T13:58:37Z", "type": "commit"}, {"oid": "df05ec101c654c163d1d13b496ffcf4a70b897b8", "url": "https://github.com/pytorch/serve/commit/df05ec101c654c163d1d13b496ffcf4a70b897b8", "message": "Restoring psutil and future as absence leads intermittent hangged build", "committedDate": "2020-05-19T18:14:54Z", "type": "commit"}, {"oid": "705cbf1c706479c66db37558b5f3116c73136b06", "url": "https://github.com/pytorch/serve/commit/705cbf1c706479c66db37558b5f3116c73136b06", "message": "Fixed review comments for doc", "committedDate": "2020-05-21T11:28:26Z", "type": "commit"}, {"oid": "1df2fd5dc44d3350b276769a36d5a495d0fbb8d1", "url": "https://github.com/pytorch/serve/commit/1df2fd5dc44d3350b276769a36d5a495d0fbb8d1", "message": "Fixed typo", "committedDate": "2020-05-21T11:30:55Z", "type": "commit"}, {"oid": "6913a21e9b483d0f6d47ae25fdacbe277ea6e952", "url": "https://github.com/pytorch/serve/commit/6913a21e9b483d0f6d47ae25fdacbe277ea6e952", "message": "Merge branch 'staging_0_1_1' into issue_266", "committedDate": "2020-05-21T11:32:39Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODc5MzAyMA==", "url": "https://github.com/pytorch/serve/pull/308#discussion_r428793020", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            ADD serve serve\n          \n          \n            \n            ADD ../serve serve", "author": "maaquib", "createdAt": "2020-05-21T17:12:49Z", "path": "docker/Dockerfile_dev.gpu", "diffHunk": "@@ -21,10 +34,10 @@ RUN update-alternatives --install /usr/bin/python python /usr/bin/python3 1\n RUN update-alternatives --install /usr/local/bin/pip pip /usr/local/bin/pip3 1\n \n RUN export USE_CUDA=1\n-RUN pip install psutil future torch torchvision torchtext\n-RUN pip install --no-cache-dir psutil\n+RUN pip install --no-cache-dir psutil future torch torchvision torchtext\n ADD serve serve", "originalCommit": "6913a21e9b483d0f6d47ae25fdacbe277ea6e952", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODc5MzMyNg==", "url": "https://github.com/pytorch/serve/pull/308#discussion_r428793326", "bodyText": "Given that the docker build would be run from the serve/docker directory shouldn't this be\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            ADD serve serve\n          \n          \n            \n            ADD ../serve serve", "author": "maaquib", "createdAt": "2020-05-21T17:13:17Z", "path": "docker/Dockerfile_dev.cpu", "diffHunk": "@@ -20,12 +33,10 @@ RUN apt-get update && \\\n RUN update-alternatives --install /usr/bin/python python /usr/bin/python3 1\n RUN update-alternatives --install /usr/local/bin/pip pip /usr/local/bin/pip3 1\n \n-RUN pip install --no-cache-dir psutil\n-RUN pip install --no-cache-dir torch\n-RUN pip install --no-cache-dir torchvision\n-RUN pip install --no-cache-dir torchtext\n+RUN pip install --no-cache-dir psutil future torch torchvision torchtext\n ADD serve serve", "originalCommit": "6913a21e9b483d0f6d47ae25fdacbe277ea6e952", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "952846552d62477407853d7076aa0394fa5b4d3c", "url": "https://github.com/pytorch/serve/commit/952846552d62477407853d7076aa0394fa5b4d3c", "message": "Merge branch 'staging_0_1_1' into issue_266", "committedDate": "2020-05-21T18:25:44Z", "type": "commit"}]}