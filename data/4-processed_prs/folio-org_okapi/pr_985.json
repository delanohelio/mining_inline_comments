{"pr_number": 985, "pr_title": "Allow module and interface discovery for same tenant OKAPI-863", "pr_createdAt": "2020-10-03T15:09:49Z", "pr_url": "https://github.com/folio-org/okapi/pull/985", "timeline": [{"oid": "435702d54e065c3ecbe8404da07b51796d38599f", "url": "https://github.com/folio-org/okapi/commit/435702d54e065c3ecbe8404da07b51796d38599f", "message": "Allow module and interface discovery for same tenant OKAPI-863\n\nOkapi on its own can not check if tenant is valid, so it might\npass no required permissions to auth. But auth will still fail\nif tenant in token doesn't match. Internally this is done in\nthe routing entry of Okapi module to use a new property which\nlists permissions to use when tenant matches {tenantId} in\npathPattern. This solution is, thus, backwards compatible with\nOKAPI-835 for a tenant match.", "committedDate": "2020-10-03T15:07:47Z", "type": "commit"}, {"oid": "edd99d12c9cbe9148a71ed9403ebbc3fb692ed9a", "url": "https://github.com/folio-org/okapi/commit/edd99d12c9cbe9148a71ed9403ebbc3fb692ed9a", "message": "Must have token(session) when matching permissionsTenant\n\nFix description as well.", "committedDate": "2020-10-05T07:23:29Z", "type": "commit"}, {"oid": "beeb98de2edc76b134d2d768373da2a1a8856066", "url": "https://github.com/folio-org/okapi/commit/beeb98de2edc76b134d2d768373da2a1a8856066", "message": "Rename permissionsTenant to permissionsRequiredTenant", "committedDate": "2020-10-05T13:59:03Z", "type": "commit"}, {"oid": "fe78380cb1d4e2f1cc2015dcd0e0e7957cbd82af", "url": "https://github.com/folio-org/okapi/commit/fe78380cb1d4e2f1cc2015dcd0e0e7957cbd82af", "message": "Guess that schema is checked afterall :-)", "committedDate": "2020-10-05T14:04:54Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTY4NjI1MA==", "url": "https://github.com/folio-org/okapi/pull/985#discussion_r499686250", "bodyText": "Does this mean one tenant can see another tenant's modules?", "author": "hjiebsco", "createdAt": "2020-10-05T15:30:09Z", "path": "okapi-core/src/test/java/org/folio/okapi/MultiTenantTest.java", "diffHunk": "@@ -335,6 +335,27 @@ public void test1() {\n     ja = new JsonArray(res.body().asString());\n     Assert.assertEquals(3, ja.size()); // two sample modules and auth module\n \n+    res = given()\n+        .header(\"Content-Type\", \"application/json\")\n+        .header(\"X-Okapi-Tenant\", tenant2)\n+        .get(\"/_/proxy/tenants/\" + tenant2 + \"/modules\")\n+        .then().statusCode(401).log().ifValidationFails()\n+        .extract().response();\n+\n+    res = given()\n+        .header(\"Content-Type\", \"application/json\")\n+        .header(\"X-Okapi-Token\", okapiTokenTenant2)\n+        .get(\"/_/proxy/tenants/\" + tenant2 + \"/modules\")\n+        .then().statusCode(200).log().ifValidationFails()\n+        .extract().response();\n+\n+    res = given()\n+        .header(\"Content-Type\", \"application/json\")\n+        .header(\"X-Okapi-Token\", okapiTokenTenant2)\n+        .get(\"/_/proxy/tenants/\" + tenant1 + \"/modules\")\n+        .then().statusCode(200).log().ifValidationFails()", "originalCommit": "fe78380cb1d4e2f1cc2015dcd0e0e7957cbd82af", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTY5Mjk1NA==", "url": "https://github.com/folio-org/okapi/pull/985#discussion_r499692954", "bodyText": "No. In this test, the permissionsRequired are in effect and real mod-authtoken would reject because the tenant does not have permissions. THe auth module used in this test does not test against mod-permissions etc.", "author": "adamdickmeiss", "createdAt": "2020-10-05T15:39:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTY4NjI1MA=="}], "type": "inlineReview"}]}