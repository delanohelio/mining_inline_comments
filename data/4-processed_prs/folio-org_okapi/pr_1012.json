{"pr_number": 1012, "pr_title": "Add more metrics backends (Prometheus and JMX) support", "pr_createdAt": "2020-10-22T18:46:15Z", "pr_url": "https://github.com/folio-org/okapi/pull/1012", "timeline": [{"oid": "954a5f2a60787cc414524742cfa374cc21ca21a8", "url": "https://github.com/folio-org/okapi/commit/954a5f2a60787cc414524742cfa374cc21ca21a8", "message": "Add metrics Prometheus backend support", "committedDate": "2020-10-22T17:52:42Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDk5OTg3OA==", "url": "https://github.com/folio-org/okapi/pull/1012#discussion_r510999878", "bodyText": "I think you should break this long line with backslashes.. Of course, so that it's possible to still cut'n paste to shell.", "author": "adamdickmeiss", "createdAt": "2020-10-23T16:25:51Z", "path": "doc/guide.md", "diffHunk": "@@ -3050,23 +3049,18 @@ Use `modulePermissions` to grant permissions for the token.\n \n ### Instrumentation\n \n-Okapi pushes instrumentation data to an InfluxDB backend, from which\n-they can be shown with something like Grafana. Vert.x pushes some numbers\n-automatically, but various parts of Okapi push their own numbers explicitly,\n-so we can classify by tenant or module. Individual\n-modules may push their own numbers as well, as needed. It is hoped that they\n-will use a key naming scheme that is close to what we do in Okapi.\n+Okapi uses Micrometer to managing metrics and reporting to backends. To enable it,\n+add Java parameter `-Dvertx.metrics.options.enabled=true` first.\n \n-Enabling the metrics via `-enable-metrics` will start sending metrics to `localhost:8086`\n+More Java parameters are needed to config which backends to use\n+* `-DinfluxDbOptions='{\"uri\": \"http://localhost:8086\", \"db\":\"okapi\"}'` - Send metrics to InfluxDB\n+* `-DprometheusOptions='{\"embeddedServerOptions\": {\"port\": 9930}}'` - Expose `<server>:9930/metrics` for Prometheus\n+* `-DjmxMetricsOptions='{\"domain\": \"org.folio.metrics\"}'` - JMX\n \n-Follwing Java parameters can be used to config InfluxDB connection.\n-* `influxUrl` - default to `http://localhost:8086`\n-* `influxDbName` - default to `okapi`\n-* `influxUser` - default to null\n-* `influxPassword` - default to null\n+Another Java parameter can be used to filter metrics\n+* `-DmetricsPrefixFilter=org.folio` - Will only report metrics with name starting `org.folio`\n \n-For example: `java -DinfluxUrl=http://influx.yourdomain.io:8086 -jar okapi-core/target/okapi-core-fat.jar dev -enable-metrics` then metrics\n-will be sent to `http://influx.yourdomain.io:8086`\n+A full example: `java -Dvertx.metrics.options.enabled=true -DmetricsPrefixFilter=org.folio -DinfluxDbOptions='{\"uri\": \"http://localhost:8086\", \"db\":\"okapi\"}' -DprometheusOptions='{\"embeddedServerOptions\": {\"port\": 9930}}' -DjmxMetricsOptions='{\"domain\": \"org.folio\"}' -jar okapi-core/target/okapi-core-fat.jar dev`\n ", "originalCommit": "954a5f2a60787cc414524742cfa374cc21ca21a8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTMzNjcwNw==", "url": "https://github.com/folio-org/okapi/pull/1012#discussion_r511336707", "bodyText": "Reformatted as suggested.", "author": "hjiebsco", "createdAt": "2020-10-24T08:24:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDk5OTg3OA=="}], "type": "inlineReview"}, {"oid": "467b1cf0b5326c44d355d1b038493e250b27f267", "url": "https://github.com/folio-org/okapi/commit/467b1cf0b5326c44d355d1b038493e250b27f267", "message": "Reformat guide example", "committedDate": "2020-10-24T08:22:51Z", "type": "commit"}, {"oid": "1320d1b9288ac487e769703a1fe4aefb1b9bb818", "url": "https://github.com/folio-org/okapi/commit/1320d1b9288ac487e769703a1fe4aefb1b9bb818", "message": "Merge branch 'master' into OKAPI-900-prometheus", "committedDate": "2020-10-24T08:24:11Z", "type": "commit"}]}