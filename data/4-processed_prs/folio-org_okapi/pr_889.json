{"pr_number": 889, "pr_title": "Okapi 773 switch discovery only if all succeeds", "pr_createdAt": "2020-03-10T14:42:47Z", "pr_url": "https://github.com/folio-org/okapi/pull/889", "timeline": [{"oid": "8f1c61e637887703ec15632ce76275e206d5d3a7", "url": "https://github.com/folio-org/okapi/commit/8f1c61e637887703ec15632ce76275e206d5d3a7", "message": "Fix SQ smells; refactor ProxyService.getNewIterator", "committedDate": "2020-03-09T13:32:22Z", "type": "commit"}, {"oid": "bbee244eb4d489011f189de1c5db49415e5adbd2", "url": "https://github.com/folio-org/okapi/commit/bbee244eb4d489011f189de1c5db49415e5adbd2", "message": "Make a few utilities static", "committedDate": "2020-03-09T13:34:21Z", "type": "commit"}, {"oid": "1a85a674c95b50f541c9df3faf06587003170ba7", "url": "https://github.com/folio-org/okapi/commit/1a85a674c95b50f541c9df3faf06587003170ba7", "message": "Log version details in Okapi startup; more testing", "committedDate": "2020-03-10T09:26:07Z", "type": "commit"}, {"oid": "8c4371d92d1c3906d4f397541b266824cd2db3ac", "url": "https://github.com/folio-org/okapi/commit/8c4371d92d1c3906d4f397541b266824cd2db3ac", "message": "For mode initdatabase, avoid exit\n\nThis allows us to test it.", "committedDate": "2020-03-10T11:04:17Z", "type": "commit"}, {"oid": "135cbdc91c358e5a48d12cb40997b2fbb2f28526", "url": "https://github.com/folio-org/okapi/commit/135cbdc91c358e5a48d12cb40997b2fbb2f28526", "message": "Test initdatabase with bad credentials", "committedDate": "2020-03-10T11:31:45Z", "type": "commit"}, {"oid": "0cdbf84f02c6e0adca1a65a954fc13c922e939e8", "url": "https://github.com/folio-org/okapi/commit/0cdbf84f02c6e0adca1a65a954fc13c922e939e8", "message": "fixing test", "committedDate": "2020-03-10T12:08:47Z", "type": "commit"}, {"oid": "4c228367720f124746f56aef01f4892f23517c40", "url": "https://github.com/folio-org/okapi/commit/4c228367720f124746f56aef01f4892f23517c40", "message": "Test purgedatabase", "committedDate": "2020-03-10T12:32:37Z", "type": "commit"}, {"oid": "82b0bc016ed0d65ff5c6ed7cf859b2b85f6752fe", "url": "https://github.com/folio-org/okapi/commit/82b0bc016ed0d65ff5c6ed7cf859b2b85f6752fe", "message": "Switch modules for tenant only if all succeeds OKAPI-773", "committedDate": "2020-03-10T14:41:20Z", "type": "commit"}, {"oid": "4340d158c235fe1da31739454f743058e1978d37", "url": "https://github.com/folio-org/okapi/commit/4340d158c235fe1da31739454f743058e1978d37", "message": "Remove a few unused definitions", "committedDate": "2020-03-10T14:53:16Z", "type": "commit"}, {"oid": "cc29f3814b11bfdb1dcfc817ab199050ffe2e30e", "url": "https://github.com/folio-org/okapi/commit/cc29f3814b11bfdb1dcfc817ab199050ffe2e30e", "message": "Install always returns 400 if tenant init fails\n\nThe response body has more details WRT which module failed - including\nthe status code from it.", "committedDate": "2020-03-11T10:01:32Z", "type": "commit"}, {"oid": "5173be39ee8f52aa2effdc8c003f30957db4dd77", "url": "https://github.com/folio-org/okapi/commit/5173be39ee8f52aa2effdc8c003f30957db4dd77", "message": "Update auth test case ErrorType USER", "committedDate": "2020-03-11T10:14:01Z", "type": "commit"}, {"oid": "651873e6cca300cb9119d5925bda39a14dda6035", "url": "https://github.com/folio-org/okapi/commit/651873e6cca300cb9119d5925bda39a14dda6035", "message": "Reorder headers and wondering abt java:S2275", "committedDate": "2020-03-11T10:25:14Z", "type": "commit"}, {"oid": "e7d3715c7b95a55fd9091e1295f7a9ce1339aab7", "url": "https://github.com/folio-org/okapi/commit/e7d3715c7b95a55fd9091e1295f7a9ce1339aab7", "message": "no format for Throwable", "committedDate": "2020-03-11T10:33:32Z", "type": "commit"}, {"oid": "a975c4f0d26324b416d49e4fc80121475faf5992", "url": "https://github.com/folio-org/okapi/commit/a975c4f0d26324b416d49e4fc80121475faf5992", "message": "Useless log", "committedDate": "2020-03-11T10:52:01Z", "type": "commit"}, {"oid": "719a911cd7970ec9a07cf379de5bdf04c7cdbf6e", "url": "https://github.com/folio-org/okapi/commit/719a911cd7970ec9a07cf379de5bdf04c7cdbf6e", "message": "ExtendedAsyncResult to Promise map", "committedDate": "2020-03-11T10:52:47Z", "type": "commit"}, {"oid": "0179852657bb4c6af67f96d67f2d67e3358d3360", "url": "https://github.com/folio-org/okapi/commit/0179852657bb4c6af67f96d67f2d67e3358d3360", "message": "Remove useless curly braces around statement", "committedDate": "2020-03-11T11:01:13Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mjk3MTMwOA==", "url": "https://github.com/folio-org/okapi/pull/889#discussion_r392971308", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    Json.encode(cli.getRespHeaders().entries()));\n          \n          \n            \n                    () -> Json.encode(cli.getRespHeaders().entries()));\n          \n      \n    \n    \n  \n\nAvoid encoding when debug logging is diabled.", "author": "julianladisch", "createdAt": "2020-03-16T12:09:54Z", "path": "okapi-core/src/main/java/org/folio/okapi/managers/ProxyService.java", "diffHunk": "@@ -1108,14 +1092,13 @@ private void authForSystemInterface(ModuleDescriptor authMod, RoutingEntry filt,\n     ModuleInstance authInst = new ModuleInstance(authMod, filt, inst.getPath(), HttpMethod.HEAD, inst.isHandler());\n     doCallSystemInterface(headers, tenantId, null, authInst, modPerms, \"\", res -> {\n       if (res.failed()) {\n-        logger.warn(\"Auth check for systemInterface failed!\");\n-        fut.handle(new Failure<>(res.getType(), res.cause()));\n+        fut.handle(res);\n         return;\n       }\n       OkapiClient cli = res.result();\n       String deftok = cli.getRespHeaders().get(XOkapiHeaders.TOKEN);\n-      logger.debug(\"authForSystemInterface:\"\n-        + Json.encode(cli.getRespHeaders().entries()));\n+      logger.debug(\"authForSystemInterface: {}\",\n+        Json.encode(cli.getRespHeaders().entries()));", "originalCommit": "0179852657bb4c6af67f96d67f2d67e3358d3360", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mjk3MjAwOA==", "url": "https://github.com/folio-org/okapi/pull/889#discussion_r392972008", "bodyText": "Good!", "author": "julianladisch", "createdAt": "2020-03-16T12:11:16Z", "path": "okapi-core/src/main/java/org/folio/okapi/managers/ProxyService.java", "diffHunk": "@@ -1033,7 +1017,7 @@ private DeploymentDescriptor pickInstance(List<DeploymentDescriptor> instances)\n    */\n   public void callSystemInterface(Tenant tenant, ModuleInstance inst,\n     String request, ProxyContext pc,\n-    Handler<ExtendedAsyncResult<OkapiClient>> fut) {\n+    Handler<AsyncResult<OkapiClient>> fut) {", "originalCommit": "0179852657bb4c6af67f96d67f2d67e3358d3360", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mjk4MjA0NQ==", "url": "https://github.com/folio-org/okapi/pull/889#discussion_r392982045", "bodyText": "If it is intentional that the failure is only logged and not reported via promise there should be a // comment saying so.", "author": "julianladisch", "createdAt": "2020-03-16T12:27:52Z", "path": "okapi-core/src/main/java/org/folio/okapi/MainVerticle.java", "diffHunk": "@@ -457,7 +434,7 @@ private void checkSuperTenant(String okapiModule, Promise<Void> promise) {\n       if (res.succeeded()) {\n         logger.info(\"Deploy completed succesfully\");\n       } else {\n-        logger.info(\"Deploy failed: {}\", res.cause());\n+        logger.info(\"Deploy failed\", res.cause());", "originalCommit": "0179852657bb4c6af67f96d67f2d67e3358d3360", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzAzNjY5MQ==", "url": "https://github.com/folio-org/okapi/pull/889#discussion_r393036691", "bodyText": "It should probably report failure, but I'd rather not change behavior WRT this, so I'll add a comment.", "author": "adamdickmeiss", "createdAt": "2020-03-16T13:51:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mjk4MjA0NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzYzNTA4NA==", "url": "https://github.com/folio-org/okapi/pull/889#discussion_r393635084", "bodyText": "Created an issue for this: https://issues.folio.org/browse/OKAPI-816", "author": "julianladisch", "createdAt": "2020-03-17T12:14:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mjk4MjA0NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mjk4NjI3Ng==", "url": "https://github.com/folio-org/okapi/pull/889#discussion_r392986276", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    logger.warn(\"pull for {} failed with status {}\", baseUrl,\n          \n          \n            \n                      res1.cause().getMessage());\n          \n          \n            \n                    logger.warn(\"pull for {} failed: {}\", baseUrl,\n          \n          \n            \n                      res1.cause().getMessage(), res1);\n          \n      \n    \n    \n  \n\nAdd stacktrace.", "author": "julianladisch", "createdAt": "2020-03-16T12:32:54Z", "path": "okapi-core/src/main/java/org/folio/okapi/managers/PullManager.java", "diffHunk": "@@ -52,17 +52,17 @@ private void getRemoteUrl(Iterator<String> it,\n     final Buffer body = Buffer.buffer();\n     HttpClientRequest req = httpClient.getAbs(url, res1 -> {\n       if (res1.failed()) {\n-        logger.info(\"pull for \" + baseUrl + \" failed with status \"\n-          + res1.cause().getMessage());\n+        logger.warn(\"pull for {} failed with status {}\", baseUrl,\n+          res1.cause().getMessage());", "originalCommit": "0179852657bb4c6af67f96d67f2d67e3358d3360", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "cdddd974b629f8fc586740a66d75099af36e0145", "url": "https://github.com/folio-org/okapi/commit/cdddd974b629f8fc586740a66d75099af36e0145", "message": "Julians suggestions", "committedDate": "2020-03-16T13:57:39Z", "type": "commit"}, {"oid": "4354c73013680757ccd3253660eda9ccd65a291b", "url": "https://github.com/folio-org/okapi/commit/4354c73013680757ccd3253660eda9ccd65a291b", "message": "Proper stacktrace", "committedDate": "2020-03-16T14:18:34Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzYyNjY3Ng==", "url": "https://github.com/folio-org/okapi/pull/889#discussion_r393626676", "bodyText": "The duplicate code should be extracted into a method:\n private void undeployFirstAndDeploy(TestContext context, JsonObject aConf, Handler<AsyncResult<String>> fut) {\n   Async myAsync = context.async();\n   undeployFirst(context.asyncAssertSuccess(handler -> {\n     DeploymentOptions opt = new DeploymentOptions().setConfig(aConf);\n     vertx.deployVerticle(MainVerticle.class.getName(), opt, res -> {\n       fut.handle(res);\n       myAsync.complete();\n     });\n   }));\n   myAsync.await(2000);\n }\n\n private void undeployFirstAndDeploy(TestContext context, JsonObject aConf) {\n   undeployFirstAndDeploy(context, aConf, context.asyncAssertSuccess());\n }\n\nExample usage:\nundeployFirstAndDeploy(context, conf);\n\nundeployFirstAndDeploy(context, conf, context.asyncAssertFailure(cause -> {\n  Assert.assertThat(cause.getMessage(), containsString(\n      \"password authentication failed for user \\\"okapi\\\"\"));\n}));", "author": "julianladisch", "createdAt": "2020-03-17T11:58:21Z", "path": "okapi-core/src/test/java/org/folio/okapi/ModuleTest.java", "diffHunk": "@@ -2681,32 +2683,97 @@ private void undeployFirst(Handler<AsyncResult<Void>> fut) {\n   }\n \n   @Test\n-  public void testInternalModule(TestContext context) {\n-    logger.info(\"testInternalModule 1\");\n+  public void testInitdatabase(TestContext context) {\n+    conf.remove(\"mongo_db_init\");\n+    conf.remove(\"postgres_db_init\");\n+    conf.put(\"mode\", \"initdatabase\");\n     async = context.async();\n     undeployFirst(x -> {\n-      conf.remove(\"mongo_db_init\");\n-      conf.remove(\"postgres_db_init\");\n+      DeploymentOptions opt = new DeploymentOptions().setConfig(conf);\n+      vertx.deployVerticle(MainVerticle.class.getName(), opt, res -> {\n+        context.assertTrue(res.succeeded());\n+        async.complete();\n+      });\n+    });\n+    async.await(1000);\n+  }", "originalCommit": "0179852657bb4c6af67f96d67f2d67e3358d3360", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDkyODU2Nw==", "url": "https://github.com/folio-org/okapi/pull/889#discussion_r394928567", "bodyText": "ok. Done", "author": "adamdickmeiss", "createdAt": "2020-03-19T10:31:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzYyNjY3Ng=="}], "type": "inlineReview"}, {"oid": "5a4b9ef06da46ef78fe47166e374c90bf25cf8c1", "url": "https://github.com/folio-org/okapi/commit/5a4b9ef06da46ef78fe47166e374c90bf25cf8c1", "message": "Merge branch 'master' into okapi-773-switch-discovery-only-if-all-succeeds", "committedDate": "2020-03-19T08:54:47Z", "type": "commit"}, {"oid": "7ca5b221187b6de060a6f48bd36771fcf63e4199", "url": "https://github.com/folio-org/okapi/commit/7ca5b221187b6de060a6f48bd36771fcf63e4199", "message": "undeployFirstAndDeploy utility for ModuleTest", "committedDate": "2020-03-19T10:31:20Z", "type": "commit"}]}