{"pr_number": 1128, "pr_title": "Works around possibility to have an empty set of extra fields", "pr_createdAt": "2020-03-27T04:11:40Z", "pr_url": "https://github.com/openzipkin/brave/pull/1128", "timeline": [{"oid": "772892a5a3fbd2d8f068c9ee6ee12a891a2f65d1", "url": "https://github.com/openzipkin/brave/commit/772892a5a3fbd2d8f068c9ee6ee12a891a2f65d1", "message": "Works around possibility to have an empty set of extra fields\n\nWe didn't eagerly validate `ExtraFieldPropagation`, that it had any\nfields at all. This leads to late bugs where an exception is thrown for\ntrying to inject nothing.\n\nAs they type `ExtraFieldPropagation` has public methods in use, this\ndoesn't change signatures. Rather, it creates a wrapper in the case\nnothing exists.\n\nWIP as some unit tests are due.", "committedDate": "2020-03-27T04:09:26Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTAyNTMzOQ==", "url": "https://github.com/openzipkin/brave/pull/1128#discussion_r399025339", "bodyText": "this signature is retained on empty", "author": "codefromthecrypt", "createdAt": "2020-03-27T04:12:13Z", "path": "brave/src/main/java/brave/propagation/ExtraFieldPropagation.java", "diffHunk": "@@ -272,15 +275,39 @@ public static void set(TraceContext context, String name, String value) {\n     PropagationFields.put(context, lowercase(name), value, Extra.class);\n   }\n \n-  public static final class Factory extends Propagation.Factory {\n+  public static class Factory extends Propagation.Factory {\n     final Propagation.Factory delegate;\n+\n+    Factory(Propagation.Factory delegate) {\n+      this.delegate = delegate;\n+    }\n+\n+    @Override public <K> ExtraFieldPropagation<K> create(Propagation.KeyFactory<K> keyFactory) {", "originalCommit": "772892a5a3fbd2d8f068c9ee6ee12a891a2f65d1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTAyNTQ0Mw==", "url": "https://github.com/openzipkin/brave/pull/1128#discussion_r399025443", "bodyText": "this signature is retained on empty", "author": "codefromthecrypt", "createdAt": "2020-03-27T04:12:35Z", "path": "brave/src/main/java/brave/propagation/ExtraFieldPropagation.java", "diffHunk": "@@ -348,7 +360,7 @@ public static void set(TraceContext context, String name, String value) {\n   // This is here to support extraction from carriers missing a get field by name function. The only\n   // known example is OpenTracing TextMap https://github.com/opentracing/opentracing-java/issues/305\n   public List<K> extraKeys() {", "originalCommit": "772892a5a3fbd2d8f068c9ee6ee12a891a2f65d1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTAyNTYyNg==", "url": "https://github.com/openzipkin/brave/pull/1128#discussion_r399025626", "bodyText": "this signature is retained on empty", "author": "codefromthecrypt", "createdAt": "2020-03-27T04:13:17Z", "path": "brave/src/main/java/brave/propagation/ExtraFieldPropagation.java", "diffHunk": "@@ -163,6 +163,7 @@ public FactoryBuilder addPrefixedFields(String prefix, Collection<String> fieldN\n       return this;\n     }\n \n+    /** Returns a wrapper of the delegate if there are no fields to propagate. */\n     public Factory build() {", "originalCommit": "772892a5a3fbd2d8f068c9ee6ee12a891a2f65d1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTAzNzQ2NA==", "url": "https://github.com/openzipkin/brave/pull/1128#discussion_r399037464", "bodyText": "I believe we can keep this class package-private", "author": "anuraaga", "createdAt": "2020-03-27T05:04:30Z", "path": "brave/src/main/java/brave/propagation/ExtraFieldPropagation.java", "diffHunk": "@@ -272,15 +275,39 @@ public static void set(TraceContext context, String name, String value) {\n     PropagationFields.put(context, lowercase(name), value, Extra.class);\n   }\n \n-  public static final class Factory extends Propagation.Factory {\n+  public static class Factory extends Propagation.Factory {\n     final Propagation.Factory delegate;\n+\n+    Factory(Propagation.Factory delegate) {\n+      this.delegate = delegate;\n+    }\n+\n+    @Override public <K> ExtraFieldPropagation<K> create(Propagation.KeyFactory<K> keyFactory) {\n+      return new ExtraFieldPropagation<>(delegate, keyFactory);\n+    }\n+\n+    @Override public boolean supportsJoin() {\n+      return delegate.supportsJoin();\n+    }\n+\n+    @Override public boolean requires128BitTraceId() {\n+      return delegate.requires128BitTraceId();\n+    }\n+\n+    @Override public TraceContext decorate(TraceContext context) {\n+      return delegate.decorate(context);\n+    }\n+  }\n+\n+  public static final class RealFactory extends Factory {", "originalCommit": "772892a5a3fbd2d8f068c9ee6ee12a891a2f65d1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTAzOTQ0NA==", "url": "https://github.com/openzipkin/brave/pull/1128#discussion_r399039444", "bodyText": "good catch!", "author": "codefromthecrypt", "createdAt": "2020-03-27T05:13:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTAzNzQ2NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTAzODQ0NQ==", "url": "https://github.com/openzipkin/brave/pull/1128#discussion_r399038445", "bodyText": "Since we're not doing any extra validation here this is confusing to me. How about\nif (fields.isEmpty()) return new Factory(delegate);\nreturn new RealFactory(delegate, fields.toArray(...", "author": "anuraaga", "createdAt": "2020-03-27T05:09:03Z", "path": "brave/src/main/java/brave/propagation/ExtraFieldPropagation.java", "diffHunk": "@@ -199,8 +200,10 @@ public Factory build() {\n       for (i = 0; i < keyToField.length; i++) {\n         keyToField[i] = keyToFieldList.get(i);\n       }\n-      return new Factory(delegate, fields.toArray(new String[0]), keys.toArray(new String[0]),\n-        keyToField, redacted);\n+      String[] validated = fields.toArray(new String[0]);", "originalCommit": "772892a5a3fbd2d8f068c9ee6ee12a891a2f65d1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTAzOTUxNQ==", "url": "https://github.com/openzipkin/brave/pull/1128#discussion_r399039515", "bodyText": "sgtm", "author": "codefromthecrypt", "createdAt": "2020-03-27T05:13:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTAzODQ0NQ=="}], "type": "inlineReview"}, {"oid": "4236795dd15d842e7c04390d5acb69e6c8f5e58a", "url": "https://github.com/openzipkin/brave/commit/4236795dd15d842e7c04390d5acb69e6c8f5e58a", "message": "unit tests", "committedDate": "2020-03-27T05:13:37Z", "type": "commit"}, {"oid": "4bc39466d612429cc3e6a88929294f0c47b7df22", "url": "https://github.com/openzipkin/brave/commit/4bc39466d612429cc3e6a88929294f0c47b7df22", "message": "feedback", "committedDate": "2020-03-27T05:15:26Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTU5MDUzMg==", "url": "https://github.com/openzipkin/brave/pull/1128#discussion_r399590532", "bodyText": "@meltsufin  this bud's for you\nregardless of if extra fields are added to the builder or not, behavior will be predictable", "author": "codefromthecrypt", "createdAt": "2020-03-28T00:12:18Z", "path": "brave/src/test/java/brave/propagation/ExtraFieldPropagationTest.java", "diffHunk": "@@ -105,12 +110,58 @@\n     TraceContext context = extractWithAmazonTraceId();\n \n     try (Tracing t = Tracing.newBuilder().propagationFactory(factory).build();\n-         CurrentTraceContext.Scope scope = t.currentTraceContext().newScope(context)) {\n+         Scope scope = t.currentTraceContext().newScope(context)) {\n       assertThat(ExtraFieldPropagation.get(\"x-amzn-trace-id\"))\n         .isEqualTo(awsTraceId);\n     }\n   }\n \n+  @Test public void emptyFields_disallowed() {\n+    assertThatThrownBy(() -> ExtraFieldPropagation.newFactory(B3Propagation.FACTORY, \"\"))\n+      .hasMessage(\"fieldNames[0] is empty\");\n+\n+    assertThatThrownBy(() -> ExtraFieldPropagation.newFactory(B3Propagation.FACTORY, asList(\"\")))\n+      .hasMessage(\"fieldNames[0] is empty\");\n+\n+    assertThatThrownBy(() -> newFactoryBuilder(B3Propagation.FACTORY).addField(\"\").build())\n+      .hasMessage(\"fieldName is empty\");\n+\n+    assertThatThrownBy(() -> newFactoryBuilder(B3Propagation.FACTORY).addRedactedField(\"\").build())\n+      .hasMessage(\"fieldName is empty\");\n+\n+    assertThatThrownBy(\n+      () -> newFactoryBuilder(B3Propagation.FACTORY).addPrefixedFields(\"foo\", asList(\"\")).build())\n+      .hasMessage(\"fieldNames[0] is empty\");\n+  }\n+\n+  // We formerly enforced presence of field names in the factory's factory method\n+  @Test public void noFields_newFactory_disallowed() {\n+    assertThatThrownBy(() -> ExtraFieldPropagation.newFactory(B3Propagation.FACTORY))\n+      .hasMessage(\"no field names\");\n+\n+    assertThatThrownBy(() -> ExtraFieldPropagation.newFactory(B3Propagation.FACTORY, asList()))\n+      .hasMessage(\"no field names\");\n+  }\n+\n+  // We formerly accepted .build() when no fields were present", "originalCommit": "4bc39466d612429cc3e6a88929294f0c47b7df22", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTY1OTk3MA==", "url": "https://github.com/openzipkin/brave/pull/1128#discussion_r399659970", "bodyText": "Thanks! Much appreciated! \ud83d\ude03", "author": "meltsufin", "createdAt": "2020-03-28T13:01:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTU5MDUzMg=="}], "type": "inlineReview"}]}