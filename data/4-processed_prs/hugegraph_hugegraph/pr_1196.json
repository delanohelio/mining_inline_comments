{"pr_number": 1196, "pr_title": "use lz4 instead of gzip for StringEncoding compress/decompress", "pr_createdAt": "2020-09-28T12:22:02Z", "pr_url": "https://github.com/hugegraph/hugegraph/pull/1196", "timeline": [{"oid": "f00f547cd2432fe880c2ef91f75b310bcdb098ed", "url": "https://github.com/hugegraph/hugegraph/commit/f00f547cd2432fe880c2ef91f75b310bcdb098ed", "message": "use lz4 instead of gzip for StringEncoding compress/decompress\n\nChange-Id: Ie4458ba481ac3625139458cc92e9dbc0631898da", "committedDate": "2020-09-28T12:23:09Z", "type": "commit"}, {"oid": "f00f547cd2432fe880c2ef91f75b310bcdb098ed", "url": "https://github.com/hugegraph/hugegraph/commit/f00f547cd2432fe880c2ef91f75b310bcdb098ed", "message": "use lz4 instead of gzip for StringEncoding compress/decompress\n\nChange-Id: Ie4458ba481ac3625139458cc92e9dbc0631898da", "committedDate": "2020-09-28T12:23:09Z", "type": "forcePushed"}, {"oid": "0910c1c30c9618ad3245391ac00e00539888ad51", "url": "https://github.com/hugegraph/hugegraph/commit/0910c1c30c9618ad3245391ac00e00539888ad51", "message": "improve\n\nChange-Id: I39cbfe2f643b46ca736e5076ef73ec6203b0be3a", "committedDate": "2020-09-28T13:22:27Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjQzMTIzMg==", "url": "https://github.com/hugegraph/hugegraph/pull/1196#discussion_r496431232", "bodyText": "to avoid copy bytes, add method decode(bytes, offset, length), and let BytesBuffer implements OutputStream that  BytesBuffer instance could be pass into LZ4BlockOutputStream.", "author": "javeme", "createdAt": "2020-09-29T05:44:35Z", "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/util/StringEncoding.java", "diffHunk": "@@ -156,14 +153,13 @@ public static String encodeBase64(byte[] bytes) {\n \n     public static String decompress(byte[] value) {\n         BytesBuffer buf = BytesBuffer.allocate(value.length * 2);\n-        try (ByteArrayInputStream bis = new ByteArrayInputStream(value);\n-             GZIPInputStream in = new GZIPInputStream(bis)) {\n+        try (ByteArrayInputStream bis = new ByteArrayInputStream(value)) {\n             byte[] bytes = new byte[value.length];\n             int len;\n-            while ((len = in.read(bytes)) > 0) {\n+            while ((len = bis.read(bytes)) > 0) {\n                 buf.write(bytes, 0, len);\n             }\n-            return decode(buf.bytes());\n+            return decode(LZ4Util.decompress(buf.bytes(), BLOCK_SIZE).array());", "originalCommit": "f00f547cd2432fe880c2ef91f75b310bcdb098ed", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjU4NjkyNA==", "url": "https://github.com/hugegraph/hugegraph/pull/1196#discussion_r496586924", "bodyText": "address it:\nuse BytesBuffer instead of ByteArrayOutputStream in compress and decompress method, and init  BytesBuffer estimate size", "author": "javeme", "createdAt": "2020-09-29T09:48:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjQzMTIzMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjQzNDMzNg==", "url": "https://github.com/hugegraph/hugegraph/pull/1196#discussion_r496434336", "bodyText": "no need to write a buf, just LZ4Util.decompress(value)", "author": "javeme", "createdAt": "2020-09-29T05:54:54Z", "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/util/StringEncoding.java", "diffHunk": "@@ -156,14 +153,13 @@ public static String encodeBase64(byte[] bytes) {\n \n     public static String decompress(byte[] value) {\n         BytesBuffer buf = BytesBuffer.allocate(value.length * 2);\n-        try (ByteArrayInputStream bis = new ByteArrayInputStream(value);\n-             GZIPInputStream in = new GZIPInputStream(bis)) {\n+        try (ByteArrayInputStream bis = new ByteArrayInputStream(value)) {\n             byte[] bytes = new byte[value.length];\n             int len;\n-            while ((len = in.read(bytes)) > 0) {\n+            while ((len = bis.read(bytes)) > 0) {", "originalCommit": "f00f547cd2432fe880c2ef91f75b310bcdb098ed", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjQzNDc5Mg==", "url": "https://github.com/hugegraph/hugegraph/pull/1196#discussion_r496434792", "bodyText": "just return LZ4Util.compress(bytes, BLOCK_SIZE).bytes()", "author": "javeme", "createdAt": "2020-09-29T05:56:17Z", "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/util/StringEncoding.java", "diffHunk": "@@ -142,12 +141,10 @@ public static String encodeBase64(byte[] bytes) {\n \n     public static byte[] compress(String value) {\n         final int outputSize = Math.max(32, value.length() / 8);\n-        final int gzipBufSize = 4 * (int) Bytes.KB;\n-        try (ByteArrayOutputStream bos = new ByteArrayOutputStream(outputSize);\n-             GZIPOutputStream out = new GZIPOutputStream(bos, gzipBufSize)) {\n+        try (ByteArrayOutputStream bos = new ByteArrayOutputStream(outputSize)) {\n             byte[] bytes = encode(value);\n-            out.write(bytes);\n-            out.finish();\n+            bytes = LZ4Util.compress(bytes, BLOCK_SIZE).array();\n+            bos.write(bytes);", "originalCommit": "f00f547cd2432fe880c2ef91f75b310bcdb098ed", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "5b2b44ce3a89794673023f0a88c538d49b5a45dc", "url": "https://github.com/hugegraph/hugegraph/commit/5b2b44ce3a89794673023f0a88c538d49b5a45dc", "message": "improve\n\nChange-Id: I408bc15c3be531239c92b3da1d75af192a532347", "committedDate": "2020-09-29T07:37:00Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjU4MzgwNQ==", "url": "https://github.com/hugegraph/hugegraph/pull/1196#discussion_r496583805", "bodyText": "keep origin", "author": "javeme", "createdAt": "2020-09-29T09:44:04Z", "path": "hugegraph-test/src/main/resources/hugegraph.properties", "diffHunk": "@@ -1,7 +1,7 @@\n gremlin.graph=com.baidu.hugegraph.HugeFactory\n \n-backend=${backend}\n-serializer=${serializer}\n+backend=rocksdb\n+serializer=binary", "originalCommit": "5b2b44ce3a89794673023f0a88c538d49b5a45dc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "be7e3ee0ea6d60410d965e0bced14a75ce869b40", "url": "https://github.com/hugegraph/hugegraph/commit/be7e3ee0ea6d60410d965e0bced14a75ce869b40", "message": "use BytesBuffer improve LZ4Util\n\nChange-Id: I812c0ba5a2abda0d11cb2e7af5ebc00da0c26ef6", "committedDate": "2020-09-29T10:38:45Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjYyMDM0Ng==", "url": "https://github.com/hugegraph/hugegraph/pull/1196#discussion_r496620346", "bodyText": "rename to buf", "author": "javeme", "createdAt": "2020-09-29T10:47:20Z", "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/util/StringEncoding.java", "diffHunk": "@@ -135,11 +144,13 @@ public static String encodeBase64(byte[] bytes) {\n     }\n \n     public static byte[] compress(String value) {\n-        return LZ4Util.compress(encode(value), BLOCK_SIZE).array();\n+        BytesBuffer bf = LZ4Util.compress(encode(value), BLOCK_SIZE);", "originalCommit": "be7e3ee0ea6d60410d965e0bced14a75ce869b40", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjYyMDQxOQ==", "url": "https://github.com/hugegraph/hugegraph/pull/1196#discussion_r496620419", "bodyText": "ditto", "author": "javeme", "createdAt": "2020-09-29T10:47:28Z", "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/util/StringEncoding.java", "diffHunk": "@@ -135,11 +144,13 @@ public static String encodeBase64(byte[] bytes) {\n     }\n \n     public static byte[] compress(String value) {\n-        return LZ4Util.compress(encode(value), BLOCK_SIZE).array();\n+        BytesBuffer bf = LZ4Util.compress(encode(value), BLOCK_SIZE);\n+        return bf.bytes();\n     }\n \n     public static String decompress(byte[] value) {\n-        return decode(LZ4Util.decompress(value, BLOCK_SIZE).array());\n+        BytesBuffer bf = LZ4Util.decompress(value, BLOCK_SIZE);", "originalCommit": "be7e3ee0ea6d60410d965e0bced14a75ce869b40", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjYyMDY2Ng==", "url": "https://github.com/hugegraph/hugegraph/pull/1196#discussion_r496620666", "bodyText": "rename to buf", "author": "javeme", "createdAt": "2020-09-29T10:47:55Z", "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/util/LZ4Util.java", "diffHunk": "@@ -37,35 +36,35 @@\n     public static BytesBuffer compress(byte[] bytes, int blockSize) {\n         LZ4Factory factory = LZ4Factory.fastestInstance();\n         LZ4Compressor compressor = factory.fastCompressor();\n-        ByteArrayOutputStream baos = new ByteArrayOutputStream();\n+        BytesBuffer bf = new BytesBuffer(bytes.length / 8);\n         LZ4BlockOutputStream lz4Output = new LZ4BlockOutputStream(\n-                                         baos, blockSize, compressor);\n+                                         bf, blockSize, compressor);\n         try {\n             lz4Output.write(bytes);\n             lz4Output.close();\n         } catch (IOException e) {\n             throw new BackendException(\"Failed to compress\", e);\n         }\n-        return BytesBuffer.wrap(baos.toByteArray());\n+        return bf;\n     }\n \n     public static BytesBuffer decompress(byte[] bytes, int blockSize) {\n         LZ4Factory factory = LZ4Factory.fastestInstance();\n-        LZ4FastDecompressor decompresser = factory.fastDecompressor();\n+        LZ4FastDecompressor decompressor = factory.fastDecompressor();\n         ByteArrayInputStream bais = new ByteArrayInputStream(bytes);\n-        ByteArrayOutputStream baos = new ByteArrayOutputStream(blockSize);\n+        BytesBuffer bf = new BytesBuffer(bytes.length * 8);", "originalCommit": "be7e3ee0ea6d60410d965e0bced14a75ce869b40", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjYyMDczNA==", "url": "https://github.com/hugegraph/hugegraph/pull/1196#discussion_r496620734", "bodyText": "rename to buf", "author": "javeme", "createdAt": "2020-09-29T10:47:59Z", "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/util/LZ4Util.java", "diffHunk": "@@ -37,35 +36,35 @@\n     public static BytesBuffer compress(byte[] bytes, int blockSize) {\n         LZ4Factory factory = LZ4Factory.fastestInstance();\n         LZ4Compressor compressor = factory.fastCompressor();\n-        ByteArrayOutputStream baos = new ByteArrayOutputStream();\n+        BytesBuffer bf = new BytesBuffer(bytes.length / 8);", "originalCommit": "be7e3ee0ea6d60410d965e0bced14a75ce869b40", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjYyMjY1Ng==", "url": "https://github.com/hugegraph/hugegraph/pull/1196#discussion_r496622656", "bodyText": "prefer keep these methods returning void", "author": "javeme", "createdAt": "2020-09-29T10:51:44Z", "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/backend/serializer/BytesBuffer.java", "diffHunk": "@@ -179,27 +181,32 @@ public BytesBuffer write(byte val) {\n         return this;\n     }\n \n-    public BytesBuffer write(int val) {\n+    @Override\n+    public void write(int b) throws IOException {\n+        this.writeByte(b);\n+    }\n+\n+    public BytesBuffer writeByte(int val) {\n         assert val <= UINT8_MAX;\n         require(BYTE_LEN);\n         this.buffer.put((byte) val);\n         return this;\n     }\n \n-    public BytesBuffer write(byte[] val) {\n+    public BytesBuffer writeByteArray(byte[] val) {\n         require(BYTE_LEN * val.length);\n         this.buffer.put(val);\n         return this;\n     }\n \n-    public BytesBuffer write(byte[] val, int offset, int length) {\n+    public BytesBuffer writeByteArray(byte[] val, int offset, int length) {", "originalCommit": "be7e3ee0ea6d60410d965e0bced14a75ce869b40", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "0019088faf4e46fe543cf4cfee6053edcef47756", "url": "https://github.com/hugegraph/hugegraph/commit/0019088faf4e46fe543cf4cfee6053edcef47756", "message": "improve\n\nChange-Id: I3bc4db83bdf3d6eed14567a771f25c744d486d44", "committedDate": "2020-09-29T11:05:02Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjY2MTg1NQ==", "url": "https://github.com/hugegraph/hugegraph/pull/1196#discussion_r496661855", "bodyText": "add \"@OverRide\" for 3 write() methods", "author": "javeme", "createdAt": "2020-09-29T12:05:31Z", "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/backend/serializer/BytesBuffer.java", "diffHunk": "@@ -179,27 +181,25 @@ public BytesBuffer write(byte val) {\n         return this;\n     }\n \n-    public BytesBuffer write(int val) {\n+    public void write(int val) {\n         assert val <= UINT8_MAX;\n         require(BYTE_LEN);\n         this.buffer.put((byte) val);\n-        return this;\n     }\n \n-    public BytesBuffer write(byte[] val) {\n+    public void write(byte[] val) {\n         require(BYTE_LEN * val.length);\n         this.buffer.put(val);\n-        return this;\n     }\n \n-    public BytesBuffer write(byte[] val, int offset, int length) {\n+    public void write(byte[] val, int offset, int length) {", "originalCommit": "0019088faf4e46fe543cf4cfee6053edcef47756", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "99f44ff40a34d23e336517de8fbfe46e1c404e5f", "url": "https://github.com/hugegraph/hugegraph/commit/99f44ff40a34d23e336517de8fbfe46e1c404e5f", "message": "improve\n\nChange-Id: Ia3b3b4cff5cb4967815deeb27d0bcd5093d3c75e", "committedDate": "2020-09-29T12:26:36Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjcyODkwNw==", "url": "https://github.com/hugegraph/hugegraph/pull/1196#discussion_r496728907", "bodyText": "add a const var buf_ratio, let init_size=bytes.length/buf_ratio, also update decompress to bytes.length*buf_ratio", "author": "javeme", "createdAt": "2020-09-29T13:44:44Z", "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/util/LZ4Util.java", "diffHunk": "@@ -36,7 +36,7 @@\n     public static BytesBuffer compress(byte[] bytes, int blockSize) {\n         LZ4Factory factory = LZ4Factory.fastestInstance();\n         LZ4Compressor compressor = factory.fastCompressor();\n-        BytesBuffer buf = new BytesBuffer(bytes.length / 8);\n+        BytesBuffer buf = new BytesBuffer(bytes.length);", "originalCommit": "99f44ff40a34d23e336517de8fbfe46e1c404e5f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "866a9337222672b398c156d42d969289c7863c36", "url": "https://github.com/hugegraph/hugegraph/commit/866a9337222672b398c156d42d969289c7863c36", "message": "improve\n\nChange-Id: Ie15e6bf9c6eed48a448c4ed84d35e4f27197b67b", "committedDate": "2020-09-30T02:17:01Z", "type": "commit"}, {"oid": "e593b5376af88aa18fd1f50d89c01def3f2d037e", "url": "https://github.com/hugegraph/hugegraph/commit/e593b5376af88aa18fd1f50d89c01def3f2d037e", "message": "improve\n\nChange-Id: Ib68648def8946433666211b25782775151fb4c52", "committedDate": "2020-09-30T03:37:42Z", "type": "commit"}, {"oid": "c703c6d830437f215f48ccecb7bcab0104777085", "url": "https://github.com/hugegraph/hugegraph/commit/c703c6d830437f215f48ccecb7bcab0104777085", "message": "improve\n\nChange-Id: I0919c57e990f50a0df18a4d942d2de67947f928e", "committedDate": "2020-10-23T08:33:06Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDg2MTM2Mg==", "url": "https://github.com/hugegraph/hugegraph/pull/1196#discussion_r510861362", "bodyText": "prefer to not add this method", "author": "javeme", "createdAt": "2020-10-23T12:51:20Z", "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/util/StringEncoding.java", "diffHunk": "@@ -144,12 +144,20 @@ public static String encodeBase64(byte[] bytes) {\n     }\n \n     public static byte[] compress(String value) {\n-        BytesBuffer buf = LZ4Util.compress(encode(value), BLOCK_SIZE);\n+        return compress(value, 0.0F);\n+    }\n+\n+    public static byte[] compress(String value, float ratio) {", "originalCommit": "c703c6d830437f215f48ccecb7bcab0104777085", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDg2MTQyMg==", "url": "https://github.com/hugegraph/hugegraph/pull/1196#discussion_r510861422", "bodyText": "ditto", "author": "javeme", "createdAt": "2020-10-23T12:51:26Z", "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/util/StringEncoding.java", "diffHunk": "@@ -144,12 +144,20 @@ public static String encodeBase64(byte[] bytes) {\n     }\n \n     public static byte[] compress(String value) {\n-        BytesBuffer buf = LZ4Util.compress(encode(value), BLOCK_SIZE);\n+        return compress(value, 0.0F);\n+    }\n+\n+    public static byte[] compress(String value, float ratio) {\n+        BytesBuffer buf = LZ4Util.compress(encode(value), BLOCK_SIZE, ratio);\n         return buf.bytes();\n     }\n \n     public static String decompress(byte[] value) {\n-        BytesBuffer buf = LZ4Util.decompress(value, BLOCK_SIZE);\n+        return decompress(value, 0.0F);\n+    }\n+\n+    public static String decompress(byte[] value, float ratio) {", "originalCommit": "c703c6d830437f215f48ccecb7bcab0104777085", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTc4NjI5MA==", "url": "https://github.com/hugegraph/hugegraph/pull/1196#discussion_r511786290", "bodyText": "rename to bufferRatio", "author": "javeme", "createdAt": "2020-10-26T08:27:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDg2MTQyMg=="}], "type": "inlineReview"}, {"oid": "e457ec05224154499674521ccacd420dfb82e65b", "url": "https://github.com/hugegraph/hugegraph/commit/e457ec05224154499674521ccacd420dfb82e65b", "message": "improve\n\nChange-Id: If332999b94a2ef918b2b9d125a99de6ae15b59fe", "committedDate": "2020-10-26T02:53:29Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTc4NjE3OA==", "url": "https://github.com/hugegraph/hugegraph/pull/1196#discussion_r511786178", "bodyText": "define const", "author": "javeme", "createdAt": "2020-10-26T08:27:06Z", "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/util/StringEncoding.java", "diffHunk": "@@ -141,32 +144,21 @@ public static String encodeBase64(byte[] bytes) {\n     }\n \n     public static byte[] compress(String value) {\n-        final int outputSize = Math.max(32, value.length() / 8);\n-        final int gzipBufSize = 4 * (int) Bytes.KB;\n-        try (ByteArrayOutputStream bos = new ByteArrayOutputStream(outputSize);\n-             GZIPOutputStream out = new GZIPOutputStream(bos, gzipBufSize)) {\n-            byte[] bytes = encode(value);\n-            out.write(bytes);\n-            out.finish();\n-            return bos.toByteArray();\n-        } catch (IOException e) {\n-            throw new BackendException(\"Failed to compress: %s\", e, value);\n-        }\n+        return compress(value, 0.0F);", "originalCommit": "e457ec05224154499674521ccacd420dfb82e65b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "3751061f74954912d88f59d858febfad0ddd1f09", "url": "https://github.com/hugegraph/hugegraph/commit/3751061f74954912d88f59d858febfad0ddd1f09", "message": "improve\n\nChange-Id: I1970aab20cea373a6e5e1c11dea364aa38b7d3d4", "committedDate": "2020-10-26T08:34:49Z", "type": "commit"}]}