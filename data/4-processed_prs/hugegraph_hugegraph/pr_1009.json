{"pr_number": 1009, "pr_title": "throw ExistedException if create schemas with same name and properties different", "pr_createdAt": "2020-05-28T10:39:24Z", "pr_url": "https://github.com/hugegraph/hugegraph/pull/1009", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjEyMjg3Ng==", "url": "https://github.com/hugegraph/hugegraph/pull/1009#discussion_r432122876", "bodyText": "align with \".vertexLabel\"", "author": "javeme", "createdAt": "2020-05-28T21:05:14Z", "path": "hugegraph-test/src/main/java/com/baidu/hugegraph/core/VertexLabelCoreTest.java", "diffHunk": "@@ -1041,4 +1043,41 @@ public void testCreateTime() {\n         createTime = (Date) person.userdata().get(Userdata.CREATE_TIME);\n         Assert.assertFalse(createTime.after(now));\n     }\n+\n+    @Test\n+    public void testDuplicatePropertyWithIdentityProperties() {\n+        super.initPropertyKeys();\n+        SchemaManager schema = graph().schema();\n+        schema.vertexLabel(\"person\").properties(\"name\", \"age\", \"city\")\n+                .primaryKeys(\"name\").create();", "originalCommit": "d7c09f30a39a5793b05d689b415cc1b0b6f1ba31", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjEyMzMxMQ==", "url": "https://github.com/hugegraph/hugegraph/pull/1009#discussion_r432123311", "bodyText": "remove empty lines", "author": "javeme", "createdAt": "2020-05-28T21:06:03Z", "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/schema/builder/VertexLabelBuilder.java", "diffHunk": "@@ -130,6 +130,72 @@ public VertexLabel create() {\n         });\n     }\n \n+    /**\n+     * Check whither this has same properties with vertexLabel.\n+     * Only  properties,  primaryKeys, nullableKeys, enableLabelIndex  is checked.\n+     * The id, idStrategy, checkExist, transaction,userdata is not checked.\n+     * @param existedVertexLabel to be compared with\n+     * @return true if this has same properties with propertyKey\n+     */\n+    private boolean hasSameProperties(VertexLabel existedVertexLabel) {\n+\n+//        if (this.idStrategy != existedVertexLabel.idStrategy()) {\n+//            return false;\n+//        }\n+\n+        Set<Id> existedProperties = existedVertexLabel.properties();\n+        if (this.properties.size() != existedProperties.size()) {\n+            return false;\n+        }\n+        for (String propertyName : this.properties) {\n+            PropertyKey propertyKey = this.transaction.getPropertyKey(propertyName);\n+            if (! existedProperties.contains(propertyKey.id())) {\n+                return false;\n+            }\n+        }\n+\n+        List<Id> existedPrimaryKeys = existedVertexLabel.primaryKeys();\n+        if (this.primaryKeys.size() != existedPrimaryKeys.size()) {\n+            return false;\n+        }\n+\n+        for (String primaryKeyName : this.primaryKeys) {\n+            PropertyKey primaryKey = this.transaction.getPropertyKey(primaryKeyName);\n+            if (!existedPrimaryKeys.contains(primaryKey.id())) {\n+                return false;\n+            }\n+        }\n+\n+        Set<Id> existedNullableKeys = existedVertexLabel.nullableKeys();\n+        if (this.nullableKeys.size() != existedNullableKeys.size()) {\n+            return false;\n+        }\n+\n+        for (String nullableKeyName : this.nullableKeys) {\n+            PropertyKey nullableKey = this.transaction.getPropertyKey(nullableKeyName);\n+            if (!existedNullableKeys.contains(nullableKey.id())) {\n+                return false;\n+            }\n+        }\n+\n+        // this.enableLabelIndex == null, it means true.\n+        if (this.enableLabelIndex == null || this.enableLabelIndex) {\n+            if (! existedVertexLabel.enableLabelIndex()) {\n+                return false;\n+            }\n+        } else {\n+            if (existedVertexLabel.enableLabelIndex() == false) {\n+                return false;\n+            }\n+        }\n+\n+\n+        return true;\n+\n+\n+", "originalCommit": "d7c09f30a39a5793b05d689b415cc1b0b6f1ba31", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjEyMzQ2Ng==", "url": "https://github.com/hugegraph/hugegraph/pull/1009#discussion_r432123466", "bodyText": "remove unused code", "author": "javeme", "createdAt": "2020-05-28T21:06:23Z", "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/schema/builder/VertexLabelBuilder.java", "diffHunk": "@@ -130,6 +130,72 @@ public VertexLabel create() {\n         });\n     }\n \n+    /**\n+     * Check whither this has same properties with vertexLabel.\n+     * Only  properties,  primaryKeys, nullableKeys, enableLabelIndex  is checked.\n+     * The id, idStrategy, checkExist, transaction,userdata is not checked.\n+     * @param existedVertexLabel to be compared with\n+     * @return true if this has same properties with propertyKey\n+     */\n+    private boolean hasSameProperties(VertexLabel existedVertexLabel) {\n+\n+//        if (this.idStrategy != existedVertexLabel.idStrategy()) {\n+//            return false;\n+//        }", "originalCommit": "d7c09f30a39a5793b05d689b415cc1b0b6f1ba31", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjEyMzc4NA==", "url": "https://github.com/hugegraph/hugegraph/pull/1009#discussion_r432123784", "bodyText": "remove space in \"! existedProperties\"", "author": "javeme", "createdAt": "2020-05-28T21:07:01Z", "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/schema/builder/VertexLabelBuilder.java", "diffHunk": "@@ -130,6 +130,72 @@ public VertexLabel create() {\n         });\n     }\n \n+    /**\n+     * Check whither this has same properties with vertexLabel.\n+     * Only  properties,  primaryKeys, nullableKeys, enableLabelIndex  is checked.\n+     * The id, idStrategy, checkExist, transaction,userdata is not checked.\n+     * @param existedVertexLabel to be compared with\n+     * @return true if this has same properties with propertyKey\n+     */\n+    private boolean hasSameProperties(VertexLabel existedVertexLabel) {\n+\n+//        if (this.idStrategy != existedVertexLabel.idStrategy()) {\n+//            return false;\n+//        }\n+\n+        Set<Id> existedProperties = existedVertexLabel.properties();\n+        if (this.properties.size() != existedProperties.size()) {\n+            return false;\n+        }\n+        for (String propertyName : this.properties) {\n+            PropertyKey propertyKey = this.transaction.getPropertyKey(propertyName);\n+            if (! existedProperties.contains(propertyKey.id())) {", "originalCommit": "d7c09f30a39a5793b05d689b415cc1b0b6f1ba31", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjEyODkyOA==", "url": "https://github.com/hugegraph/hugegraph/pull/1009#discussion_r432128928", "bodyText": "prefer to move this method to class EdgeLabel, and process parent fields by each super class like SchemaLabel/SchemaElement", "author": "javeme", "createdAt": "2020-05-28T21:17:33Z", "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/schema/builder/EdgeLabelBuilder.java", "diffHunk": "@@ -141,6 +141,72 @@ public EdgeLabel create() {\n         });\n     }\n \n+    private boolean hasSameProperties(EdgeLabel existedEdgeLabel) {", "originalCommit": "d7c09f30a39a5793b05d689b415cc1b0b6f1ba31", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjIxMDM3Nw==", "url": "https://github.com/hugegraph/hugegraph/pull/1009#discussion_r432210377", "bodyText": "If move hasSameProperties to EdgeLabel, and parent class, it will reduce some duplicate check.\nSchemaLabel has the following fields used by VertexLabel and EdgeLabel.\nprivate final Set<Id> properties;\n    private final Set<Id> nullableKeys;\n    private final Set<Id> indexLabels;\n    private boolean enableLabelIndex;\n\nBut the parameter should be Builder, and in should has proper method to retrieve correspond information.  There is not common parent Builder with these information.", "author": "houzhizhen", "createdAt": "2020-05-29T01:33:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjEyODkyOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjEyOTI3Mg==", "url": "https://github.com/hugegraph/hugegraph/pull/1009#discussion_r432129272", "bodyText": "space", "author": "javeme", "createdAt": "2020-05-28T21:18:18Z", "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/schema/builder/IndexLabelBuilder.java", "diffHunk": "@@ -99,6 +99,45 @@ public IndexLabel build() {\n         return indexLabel;\n     }\n \n+\n+    /**\n+     * Check whither this has same properties with existedIndexLabel.\n+     * Only baseType,baseValue,indexType, indexFields is checked.\n+     * The id, checkExist, transaction,userdata is not checked.\n+     * @param existedIndexLabel to be compared with\n+     * @return true if this has same properties with propertyKey\n+     */\n+    private boolean hasSameProperties(IndexLabel existedIndexLabel) {\n+        // baseType is null, it means HugeType.SYS_SCHEMA\n+        if (this.baseType == null && existedIndexLabel.baseType() != HugeType.SYS_SCHEMA\n+        || this.baseType != existedIndexLabel.baseType()) {\n+            return false;\n+        }\n+\n+        SchemaLabel schemaLabel = this.loadElement();\n+        if (! schemaLabel.id().equals(existedIndexLabel.baseValue())) {", "originalCommit": "d7c09f30a39a5793b05d689b415cc1b0b6f1ba31", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjEyOTM0OA==", "url": "https://github.com/hugegraph/hugegraph/pull/1009#discussion_r432129348", "bodyText": "align", "author": "javeme", "createdAt": "2020-05-28T21:18:28Z", "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/schema/builder/IndexLabelBuilder.java", "diffHunk": "@@ -99,6 +99,45 @@ public IndexLabel build() {\n         return indexLabel;\n     }\n \n+\n+    /**\n+     * Check whither this has same properties with existedIndexLabel.\n+     * Only baseType,baseValue,indexType, indexFields is checked.\n+     * The id, checkExist, transaction,userdata is not checked.\n+     * @param existedIndexLabel to be compared with\n+     * @return true if this has same properties with propertyKey\n+     */\n+    private boolean hasSameProperties(IndexLabel existedIndexLabel) {\n+        // baseType is null, it means HugeType.SYS_SCHEMA\n+        if (this.baseType == null && existedIndexLabel.baseType() != HugeType.SYS_SCHEMA\n+        || this.baseType != existedIndexLabel.baseType()) {", "originalCommit": "d7c09f30a39a5793b05d689b415cc1b0b6f1ba31", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjEyOTQyMg==", "url": "https://github.com/hugegraph/hugegraph/pull/1009#discussion_r432129422", "bodyText": "align", "author": "javeme", "createdAt": "2020-05-28T21:18:40Z", "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/schema/builder/IndexLabelBuilder.java", "diffHunk": "@@ -99,6 +99,45 @@ public IndexLabel build() {\n         return indexLabel;\n     }\n \n+\n+    /**\n+     * Check whither this has same properties with existedIndexLabel.\n+     * Only baseType,baseValue,indexType, indexFields is checked.\n+     * The id, checkExist, transaction,userdata is not checked.\n+     * @param existedIndexLabel to be compared with\n+     * @return true if this has same properties with propertyKey\n+     */\n+    private boolean hasSameProperties(IndexLabel existedIndexLabel) {\n+        // baseType is null, it means HugeType.SYS_SCHEMA\n+        if (this.baseType == null && existedIndexLabel.baseType() != HugeType.SYS_SCHEMA\n+        || this.baseType != existedIndexLabel.baseType()) {\n+            return false;\n+        }\n+\n+        SchemaLabel schemaLabel = this.loadElement();\n+        if (! schemaLabel.id().equals(existedIndexLabel.baseValue())) {\n+            return false;\n+        }\n+\n+        if (this.indexType == null && existedIndexLabel.indexType() != IndexType.SECONDARY\n+                || this.indexType != existedIndexLabel.indexType()) {", "originalCommit": "d7c09f30a39a5793b05d689b415cc1b0b6f1ba31", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "65c2f35ffc3190a21153a1b6cf0489f340e93107", "url": "https://github.com/hugegraph/hugegraph/commit/65c2f35ffc3190a21153a1b6cf0489f340e93107", "message": "Check for 4 types of schema: propertyKey,vertexLabel,indexLabel,and edgeLabel. If the two or more create statements as the code follows are identical, the system will only create one schema quietly.", "committedDate": "2020-05-29T02:47:14Z", "type": "commit"}, {"oid": "97bc6bbddde246b6986831e977283359c59e145d", "url": "https://github.com/hugegraph/hugegraph/commit/97bc6bbddde246b6986831e977283359c59e145d", "message": "tiny improvement", "committedDate": "2020-05-29T03:22:14Z", "type": "commit"}, {"oid": "97bc6bbddde246b6986831e977283359c59e145d", "url": "https://github.com/hugegraph/hugegraph/commit/97bc6bbddde246b6986831e977283359c59e145d", "message": "tiny improvement", "committedDate": "2020-05-29T03:22:14Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzAxMzgxNA==", "url": "https://github.com/hugegraph/hugegraph/pull/1009#discussion_r433013814", "bodyText": "here this. enableLabelIndex = false, seems only existedEdgeLabel.enableLabelIndex() == true should return false.", "author": "Linary", "createdAt": "2020-06-01T02:04:05Z", "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/schema/builder/EdgeLabelBuilder.java", "diffHunk": "@@ -149,6 +149,71 @@ public EdgeLabel create() {\n         });\n     }\n \n+    private boolean hasSameProperties(EdgeLabel existedEdgeLabel) {\n+        HugeGraph graph = this.graph();\n+        Id sourceId = graph.vertexLabel(this.sourceLabel).id();\n+        if (! existedEdgeLabel.sourceLabel().equals(sourceId)) {\n+            return false;\n+        }\n+\n+        Id targetId = graph.vertexLabel(this.targetLabel).id();\n+\n+        if (! existedEdgeLabel.targetLabel().equals(targetId)) {\n+            return false;\n+        }\n+\n+        if (this.frequency != existedEdgeLabel.frequency()) {\n+            return false;\n+        }\n+\n+        // this.enableLabelIndex == null, it means true.\n+        if (this.enableLabelIndex == null || this.enableLabelIndex) {\n+            if (! existedEdgeLabel.enableLabelIndex()) {\n+                return false;\n+            }\n+        } else { // means false\n+            if (existedEdgeLabel.enableLabelIndex() == false) {", "originalCommit": "97bc6bbddde246b6986831e977283359c59e145d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzAxOTkwNg==", "url": "https://github.com/hugegraph/hugegraph/pull/1009#discussion_r433019906", "bodyText": "Good job, this is a bug.", "author": "houzhizhen", "createdAt": "2020-06-01T02:42:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzAxMzgxNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzAxMzk0Ng==", "url": "https://github.com/hugegraph/hugegraph/pull/1009#discussion_r433013946", "bodyText": "There should no space between ! and existedEdgeLabel.sourceLabel().equals(sourceId) in our code style", "author": "Linary", "createdAt": "2020-06-01T02:05:00Z", "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/schema/builder/EdgeLabelBuilder.java", "diffHunk": "@@ -149,6 +149,71 @@ public EdgeLabel create() {\n         });\n     }\n \n+    private boolean hasSameProperties(EdgeLabel existedEdgeLabel) {\n+        HugeGraph graph = this.graph();\n+        Id sourceId = graph.vertexLabel(this.sourceLabel).id();\n+        if (! existedEdgeLabel.sourceLabel().equals(sourceId)) {", "originalCommit": "97bc6bbddde246b6986831e977283359c59e145d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "a114c1197a4539272da78042b9fe7c112e1297ac", "url": "https://github.com/hugegraph/hugegraph/commit/a114c1197a4539272da78042b9fe7c112e1297ac", "message": "bug fix: current enableLabelIndex is false, and existed enableLabelIndex is true, it should return false", "committedDate": "2020-06-01T02:54:56Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzA0Mjk4Mg==", "url": "https://github.com/hugegraph/hugegraph/pull/1009#discussion_r433042982", "bodyText": "delete empty line", "author": "zhoney", "createdAt": "2020-06-01T05:06:36Z", "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/schema/builder/EdgeLabelBuilder.java", "diffHunk": "@@ -149,6 +149,69 @@ public EdgeLabel create() {\n         });\n     }\n \n+    private boolean hasSameProperties(EdgeLabel existedEdgeLabel) {\n+        HugeGraph graph = this.graph();\n+        Id sourceId = graph.vertexLabel(this.sourceLabel).id();\n+        if (!existedEdgeLabel.sourceLabel().equals(sourceId)) {\n+            return false;\n+        }\n+\n+        Id targetId = graph.vertexLabel(this.targetLabel).id();\n+", "originalCommit": "a114c1197a4539272da78042b9fe7c112e1297ac", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzA0MzExMA==", "url": "https://github.com/hugegraph/hugegraph/pull/1009#discussion_r433043110", "bodyText": "more or less empty\nOnly baseType, baseValue, indexType, indexFields are checked.", "author": "zhoney", "createdAt": "2020-06-01T05:07:18Z", "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/schema/builder/IndexLabelBuilder.java", "diffHunk": "@@ -99,6 +99,47 @@ public IndexLabel build() {\n         return indexLabel;\n     }\n \n+\n+    /**\n+     * Check whether this has same properties with existedIndexLabel.\n+     * Only baseType,baseValue,indexType, indexFields are checked.", "originalCommit": "a114c1197a4539272da78042b9fe7c112e1297ac", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzA0MzUwNw==", "url": "https://github.com/hugegraph/hugegraph/pull/1009#discussion_r433043507", "bodyText": "ditto", "author": "zhoney", "createdAt": "2020-06-01T05:09:17Z", "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/schema/builder/PropertyKeyBuilder.java", "diffHunk": "@@ -98,6 +98,34 @@ public PropertyKey create() {\n         });\n     }\n \n+\n+    /**\n+     * Check whether this has same properties with propertyKey.\n+     * Only dataType, cardinality, aggregateType  are checked.", "originalCommit": "a114c1197a4539272da78042b9fe7c112e1297ac", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzA0MzUyOA==", "url": "https://github.com/hugegraph/hugegraph/pull/1009#discussion_r433043528", "bodyText": "ditto", "author": "zhoney", "createdAt": "2020-06-01T05:09:25Z", "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/schema/builder/VertexLabelBuilder.java", "diffHunk": "@@ -137,6 +137,62 @@ public VertexLabel create() {\n         });\n     }\n \n+    /**\n+     * Check whether this has same properties with existedVertexLabel.\n+     * Only  properties,  primaryKeys, nullableKeys, enableLabelIndex  are checked.", "originalCommit": "a114c1197a4539272da78042b9fe7c112e1297ac", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "eab1896801a8e6aa77b64625876eb1f07b0df74f", "url": "https://github.com/hugegraph/hugegraph/commit/eab1896801a8e6aa77b64625876eb1f07b0df74f", "message": "fix space problem in methods comments", "committedDate": "2020-06-01T05:56:31Z", "type": "commit"}]}