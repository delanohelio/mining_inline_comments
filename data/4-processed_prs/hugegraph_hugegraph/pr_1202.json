{"pr_number": 1202, "pr_title": "Let drop column family mutual exclusion with other operations", "pr_createdAt": "2020-09-30T05:13:57Z", "pr_url": "https://github.com/hugegraph/hugegraph/pull/1202", "timeline": [{"oid": "436c691c02fef34ec2c015b52e9725dbf8918f70", "url": "https://github.com/hugegraph/hugegraph/commit/436c691c02fef34ec2c015b52e9725dbf8918f70", "message": "Let drop column family mutual exclusion with other operations\n\n* use ReadWriteLock\n\nChange-Id: Id68401b568d7de8910026fcf420947d42bf23802", "committedDate": "2020-09-30T05:13:10Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzM3MjQ3Mw==", "url": "https://github.com/hugegraph/hugegraph/pull/1202#discussion_r497372473", "bodyText": "unneeded to reload rocksdb if not operate batch after CF is dropped.\nbut we can keep these code for future use (don't --amend)", "author": "javeme", "createdAt": "2020-09-30T09:31:33Z", "path": "hugegraph-rocksdb/src/main/java/com/baidu/hugegraph/backend/store/rocksdb/RocksDBStdSessions.java", "diffHunk": "@@ -247,6 +251,36 @@ public synchronized void dropTable(String... tables)\n         }\n     }\n \n+    public void reload() throws RocksDBException {", "originalCommit": "436c691c02fef34ec2c015b52e9725dbf8918f70", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "0d0496c5b54622e72551e107571c28e443615a24", "url": "https://github.com/hugegraph/hugegraph/commit/0d0496c5b54622e72551e107571c28e443615a24", "message": "don't reload rocksdb\n\nChange-Id: I823030bc9ab23ac5612f74bddd9f9dff40e4a5cf", "committedDate": "2020-10-29T09:09:48Z", "type": "commit"}, {"oid": "0d0496c5b54622e72551e107571c28e443615a24", "url": "https://github.com/hugegraph/hugegraph/commit/0d0496c5b54622e72551e107571c28e443615a24", "message": "don't reload rocksdb\n\nChange-Id: I823030bc9ab23ac5612f74bddd9f9dff40e4a5cf", "committedDate": "2020-10-29T09:09:48Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDEwMTM5NA==", "url": "https://github.com/hugegraph/hugegraph/pull/1202#discussion_r514101394", "bodyText": "set final", "author": "javeme", "createdAt": "2020-10-29T09:03:29Z", "path": "hugegraph-rocksdb/src/main/java/com/baidu/hugegraph/backend/store/rocksdb/RocksDBStdSessions.java", "diffHunk": "@@ -67,17 +67,18 @@\n import com.baidu.hugegraph.backend.store.BackendEntryIterator;\n import com.baidu.hugegraph.config.HugeConfig;\n import com.baidu.hugegraph.util.Bytes;\n-import com.baidu.hugegraph.util.GZipUtil;\n import com.baidu.hugegraph.util.E;\n+import com.baidu.hugegraph.util.GZipUtil;\n import com.baidu.hugegraph.util.StringEncoding;\n import com.google.common.collect.ImmutableList;\n \n public class RocksDBStdSessions extends RocksDBSessions {\n \n+    private final HugeConfig config;\n     private final String dataPath;\n     private final String walPath;\n \n-    private final RocksDB rocksdb;\n+    private volatile RocksDB rocksdb;", "originalCommit": "e460e0217b84d81d2d813c00d4322e33b04d04ad", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDEwMjQ1MQ==", "url": "https://github.com/hugegraph/hugegraph/pull/1202#discussion_r514102451", "bodyText": "rename to truncateLock", "author": "javeme", "createdAt": "2020-10-29T09:05:14Z", "path": "hugegraph-rocksdb/src/main/java/com/baidu/hugegraph/backend/store/rocksdb/RocksDBStore.java", "diffHunk": "@@ -79,6 +83,8 @@\n     private RocksDBSessions sessions;\n     private final Map<HugeType, String> tableDiskMapping;\n \n+    private final ReadWriteLock lock;", "originalCommit": "e460e0217b84d81d2d813c00d4322e33b04d04ad", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDEwMjk4NA==", "url": "https://github.com/hugegraph/hugegraph/pull/1202#discussion_r514102984", "bodyText": "remove space", "author": "javeme", "createdAt": "2020-10-29T09:06:03Z", "path": "hugegraph-rocksdb/src/main/java/com/baidu/hugegraph/backend/store/rocksdb/RocksDBStore.java", "diffHunk": "@@ -344,18 +351,24 @@ public boolean opened() {\n \n     @Override\n     public void mutate(BackendMutation mutation) {\n-        this.checkOpened();\n+        Lock readLock = this.lock.readLock();\n+        readLock.lock();\n+        try {\n+            this.checkOpened();\n \n-        if (LOG.isDebugEnabled()) {\n-            LOG.debug(\"Store {} mutation: {}\", this.store, mutation);\n-        }\n+            if (LOG.isDebugEnabled()) {\n+                LOG.debug(\"Store {} mutation: {}\", this.store, mutation);\n+            }\n \n-        for (HugeType type : mutation.types()) {\n-            Session session = this.session(type);\n-            for (Iterator<BackendAction> it = mutation.mutation(type);\n-                 it.hasNext();) {\n-                this.mutate(session, it.next());\n+            for (HugeType type : mutation.types()) {\n+                Session session = this.session(type);\n+                for (Iterator<BackendAction> it = mutation.mutation(type);\n+                     it.hasNext(); ) {", "originalCommit": "e460e0217b84d81d2d813c00d4322e33b04d04ad", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "ae545199a3a74758c19bf3a9df0fbddb51e1f979", "url": "https://github.com/hugegraph/hugegraph/commit/ae545199a3a74758c19bf3a9df0fbddb51e1f979", "message": "tiny improve\n\nChange-Id: I32a896790b9a28e2fac90cdddd258ef306cd296a", "committedDate": "2020-10-29T12:08:28Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDkyOTQ3Mw==", "url": "https://github.com/hugegraph/hugegraph/pull/1202#discussion_r514929473", "bodyText": "Config can be removed by making config protected in super class.", "author": "houzhizhen", "createdAt": "2020-10-30T08:10:24Z", "path": "hugegraph-rocksdb/src/main/java/com/baidu/hugegraph/backend/store/rocksdb/RocksDBStdSessions.java", "diffHunk": "@@ -87,6 +88,7 @@ public RocksDBStdSessions(HugeConfig config, String database, String store,\n                               String dataPath, String walPath)\n                               throws RocksDBException {\n         super(config, database, store);\n+        this.config = config;", "originalCommit": "ae545199a3a74758c19bf3a9df0fbddb51e1f979", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDkzMDMxNw==", "url": "https://github.com/hugegraph/hugegraph/pull/1202#discussion_r514930317", "bodyText": "using constructor chain by this(...) can reduce some duplicate codes.", "author": "houzhizhen", "createdAt": "2020-10-30T08:12:21Z", "path": "hugegraph-rocksdb/src/main/java/com/baidu/hugegraph/backend/store/rocksdb/RocksDBStdSessions.java", "diffHunk": "@@ -112,6 +114,7 @@ public RocksDBStdSessions(HugeConfig config, String database, String store,\n                               String dataPath, String walPath,\n                               List<String> cfNames) throws RocksDBException {\n         super(config, database, store);", "originalCommit": "ae545199a3a74758c19bf3a9df0fbddb51e1f979", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}