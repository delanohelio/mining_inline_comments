{"pr_number": 1098, "pr_title": "fix ci too much exception \"pk table not exist\"", "pr_createdAt": "2020-07-16T13:32:41Z", "pr_url": "https://github.com/hugegraph/hugegraph/pull/1098", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjE5ODQwMg==", "url": "https://github.com/hugegraph/hugegraph/pull/1098#discussion_r456198402", "bodyText": "move to line 258", "author": "javeme", "createdAt": "2020-07-17T03:30:20Z", "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/StandardHugeGraph.java", "diffHunk": "@@ -250,11 +252,13 @@ public void clearBackend() {\n         this.loadSystemStore().open(this.configuration);\n         this.loadGraphStore().open(this.configuration);\n         try {\n+            LockUtil.lock(this.name, TaskManager.HEARTBEAT);\n             this.storeProvider.clear();\n         } finally {\n             this.loadGraphStore().close();\n             this.loadSystemStore().close();\n             this.loadSchemaStore().close();\n+            LockUtil.unlock(this.name, TaskManager.HEARTBEAT);", "originalCommit": "b2d0075c9e4e9d5a71ff3626cfbc383971eb692e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjE5ODQ4MA==", "url": "https://github.com/hugegraph/hugegraph/pull/1098#discussion_r456198480", "bodyText": "move out of try", "author": "javeme", "createdAt": "2020-07-17T03:30:38Z", "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/StandardHugeGraph.java", "diffHunk": "@@ -250,11 +252,13 @@ public void clearBackend() {\n         this.loadSystemStore().open(this.configuration);\n         this.loadGraphStore().open(this.configuration);\n         try {\n+            LockUtil.lock(this.name, TaskManager.HEARTBEAT);", "originalCommit": "b2d0075c9e4e9d5a71ff3626cfbc383971eb692e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjE5OTEzMw==", "url": "https://github.com/hugegraph/hugegraph/pull/1098#discussion_r456199133", "bodyText": "rename to a common name like GRAPH_LOCK", "author": "javeme", "createdAt": "2020-07-17T03:33:23Z", "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/StandardHugeGraph.java", "diffHunk": "@@ -231,12 +231,14 @@ public void initBackend() {\n         this.loadSystemStore().open(this.configuration);\n         this.loadGraphStore().open(this.configuration);\n         try {\n+            LockUtil.lock(this.name, TaskManager.HEARTBEAT);", "originalCommit": "b2d0075c9e4e9d5a71ff3626cfbc383971eb692e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjI2NTEwNg==", "url": "https://github.com/hugegraph/hugegraph/pull/1098#discussion_r456265106", "bodyText": "remove empty line", "author": "javeme", "createdAt": "2020-07-17T07:22:45Z", "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/StandardHugeGraph.java", "diffHunk": "@@ -268,14 +272,15 @@ public void clearBackend() {\n     public void truncateBackend() {\n         this.waitUntilAllTasksCompleted();\n \n+        LockUtil.lock(this.name, TaskManager.GRAPH_LOCK);\n+", "originalCommit": "d4300877401040b6ad9ef39cf574e986efe39d2f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjI2NzA4NQ==", "url": "https://github.com/hugegraph/hugegraph/pull/1098#discussion_r456267085", "bodyText": "move to LockUtil", "author": "javeme", "createdAt": "2020-07-17T07:27:04Z", "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/task/TaskManager.java", "diffHunk": "@@ -45,7 +45,7 @@\n \n     private static final Logger LOG = Log.logger(TaskManager.class);\n \n-    public static final String HEARTBEAT = \"heartbeat\";\n+    public static final String GRAPH_LOCK = \"graph_lock\";", "originalCommit": "d4300877401040b6ad9ef39cf574e986efe39d2f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njc1MjI1MQ==", "url": "https://github.com/hugegraph/hugegraph/pull/1098#discussion_r456752251", "bodyText": "only do executeTasksOnWorker and cancelTasksOnWorker when !server.master() or server.onlySingleNode(), and rename server to serverManager", "author": "javeme", "createdAt": "2020-07-18T05:31:13Z", "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/task/TaskManager.java", "diffHunk": "@@ -276,6 +288,11 @@ private void scheduleOrExecuteJob() {\n             }\n         } catch (Throwable e) {\n             LOG.error(\"Exception occurred when schedule job\", e);\n+        } finally {", "originalCommit": "94672c0407aa1ba9fa26e9582ee42605963c544b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "2eee796f97876dfb826f42c41377c06bd600d292", "url": "https://github.com/hugegraph/hugegraph/commit/2eee796f97876dfb826f42c41377c06bd600d292", "message": "fix ci too much exception \"pk table not exist\"\n\nChange-Id: Ie9a1ba689ae4aec876bf9793970a1d62e3c69abf", "committedDate": "2020-07-21T02:27:39Z", "type": "commit"}, {"oid": "c8a3d64f19c4b4b7a07188395134ee2a404caf8d", "url": "https://github.com/hugegraph/hugegraph/commit/c8a3d64f19c4b4b7a07188395134ee2a404caf8d", "message": "improve\n\nChange-Id: Ifbaa77b45177c668b61b90eeca5b436ea970060f", "committedDate": "2020-07-21T02:27:39Z", "type": "commit"}, {"oid": "73cfba2cfda9247f816c8dfe0a39ccb9c1cf6958", "url": "https://github.com/hugegraph/hugegraph/commit/73cfba2cfda9247f816c8dfe0a39ccb9c1cf6958", "message": "improve\n\nChange-Id: I09dfb1a993ae382e590e2116ead6bcb14b3ebce0", "committedDate": "2020-07-21T02:27:39Z", "type": "commit"}, {"oid": "1d3ce5305d5b64ebe796ef674b9e36d58562129e", "url": "https://github.com/hugegraph/hugegraph/commit/1d3ce5305d5b64ebe796ef674b9e36d58562129e", "message": "improve\n\nChange-Id: I3c4e3330c8b9fb916f3fe1db591cbb74950bb6af", "committedDate": "2020-07-21T02:27:39Z", "type": "commit"}, {"oid": "f8e44da5305c1400faf4add5d9405ad074291b15", "url": "https://github.com/hugegraph/hugegraph/commit/f8e44da5305c1400faf4add5d9405ad074291b15", "message": "improve\n\nChange-Id: I6222493175e1c3438eb6023149ca598b8d583b7f", "committedDate": "2020-07-21T02:27:39Z", "type": "commit"}, {"oid": "98d8fe007305532fe15a33d5bceb2faccec31567", "url": "https://github.com/hugegraph/hugegraph/commit/98d8fe007305532fe15a33d5bceb2faccec31567", "message": "improve\n\nChange-Id: I30149b43146e0e82f775357181c5455928ae463a", "committedDate": "2020-07-21T02:27:39Z", "type": "commit"}, {"oid": "98d8fe007305532fe15a33d5bceb2faccec31567", "url": "https://github.com/hugegraph/hugegraph/commit/98d8fe007305532fe15a33d5bceb2faccec31567", "message": "improve\n\nChange-Id: I30149b43146e0e82f775357181c5455928ae463a", "committedDate": "2020-07-21T02:27:39Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzgxNDgzMA==", "url": "https://github.com/hugegraph/hugegraph/pull/1098#discussion_r457814830", "bodyText": "add graphName() to call graphparams.name() to avoid auth issue", "author": "javeme", "createdAt": "2020-07-21T03:30:17Z", "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/task/TaskManager.java", "diffHunk": "@@ -252,30 +254,48 @@ protected void notifyNewTask(HugeTask<?> task) {\n     }\n \n     private void scheduleOrExecuteJob() {\n+        List<String> graphs = new ArrayList<>();\n         try {\n             for (TaskScheduler entry : this.schedulers.values()) {\n                 StandardTaskScheduler scheduler = (StandardTaskScheduler) entry;\n-                ServerInfoManager server = scheduler.serverManager();\n+                ServerInfoManager serverManager = scheduler.serverManager();\n+\n+                String graph = scheduler.graph().name();", "originalCommit": "98d8fe007305532fe15a33d5bceb2faccec31567", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "2dd04ad72eabafb5d5a2badba7a7f74887b722a8", "url": "https://github.com/hugegraph/hugegraph/commit/2dd04ad72eabafb5d5a2badba7a7f74887b722a8", "message": "improve\n\nChange-Id: I4fed921ad3519e9ad8ecdc2df265eb568ada832d", "committedDate": "2020-07-21T05:25:12Z", "type": "commit"}, {"oid": "8977fa350e6c88f2ea8bd90734412ea946cd37fc", "url": "https://github.com/hugegraph/hugegraph/commit/8977fa350e6c88f2ea8bd90734412ea946cd37fc", "message": "improve\n\nChange-Id: Ide2df71f51ccd9ab381db371c0297450b1ebe3bc", "committedDate": "2020-07-21T06:22:56Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzkwNDkxMA==", "url": "https://github.com/hugegraph/hugegraph/pull/1098#discussion_r457904910", "bodyText": "add some comments", "author": "javeme", "createdAt": "2020-07-21T07:51:25Z", "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/task/TaskManager.java", "diffHunk": "@@ -94,7 +94,7 @@ public void addScheduler(HugeGraphParams graph) {\n         this.schedulers.put(graph, scheduler);\n     }\n \n-    public void closeScheduler(HugeGraphParams graph) {\n+    public synchronized void closeScheduler(HugeGraphParams graph) {", "originalCommit": "8977fa350e6c88f2ea8bd90734412ea946cd37fc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "e312e7e381018e52be3d7afcbeb38b44cd6ec3a8", "url": "https://github.com/hugegraph/hugegraph/commit/e312e7e381018e52be3d7afcbeb38b44cd6ec3a8", "message": "improve\n\nChange-Id: I01caba3f1c6fe9ebef6b948b4b90c367e272e026", "committedDate": "2020-07-21T08:56:50Z", "type": "commit"}]}