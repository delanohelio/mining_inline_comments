{"pr_number": 873, "pr_title": "refactor(e2e): Reduce unnecessary operations, simplify setup/teardown for methods tests", "pr_createdAt": "2020-08-03T17:55:05Z", "pr_url": "https://github.com/Azure/azure-iot-sdk-java/pull/873", "timeline": [{"oid": "545207b7aef101b0117999bb8af44beeb4a24d4a", "url": "https://github.com/Azure/azure-iot-sdk-java/commit/545207b7aef101b0117999bb8af44beeb4a24d4a", "message": "refactor(e2e): Reduce unnecessary operations, simplify setup/teardown for methods tests\n\nEach deviceMethods client only allows one method invocation at a time, but some tests deliberately have the method invocation take multiple seconds. This commit splits the static device method client so that each test instance has its own direct method client instead. That minimizes any cross-test interference that the above synchronization could cause\n\nFixed the device method tests not waiting for the methods subscription message to be acknowledged on the device before invoking the method\n\nPreviously test setup always created and opened a device client instance regardless of if the test actually needs it. Now that setup is opt-in with a call to super.openDeviceClientAndSubscribeToMethods(...)\n\nAlso, test setup used to include calls to close the device client under test even though the client is never open before the test. I have removed that to reduce unnecessary code.", "committedDate": "2020-08-03T17:53:35Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDU3MjQyMg==", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/873#discussion_r464572422", "bodyText": "The client was never open at this point, so we can remove this", "author": "timtay-microsoft", "createdAt": "2020-08-03T17:55:29Z", "path": "iot-e2e-tests/common/src/test/java/tests/integration/com/microsoft/azure/sdk/iot/helpers/DeviceEmulator.java", "diffHunk": "@@ -54,26 +57,9 @@\n         this.client = client;\n     }\n \n-    void setup() throws IOException\n+    void open() throws IOException\n     {\n-        try\n-        {\n-            if (this.client != null)\n-            {\n-                this.client.closeNow();", "originalCommit": "545207b7aef101b0117999bb8af44beeb4a24d4a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDU3MjYxNw==", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/873#discussion_r464572617", "bodyText": "Each test instance has its own statistics, so there is no need to clear them between test runs", "author": "timtay-microsoft", "createdAt": "2020-08-03T17:55:53Z", "path": "iot-e2e-tests/common/src/test/java/tests/integration/com/microsoft/azure/sdk/iot/helpers/DeviceEmulator.java", "diffHunk": "@@ -54,26 +57,9 @@\n         this.client = client;\n     }\n \n-    void setup() throws IOException\n+    void open() throws IOException\n     {\n-        try\n-        {\n-            if (this.client != null)\n-            {\n-                this.client.closeNow();\n-            }\n-        }\n-        catch (IOException e)\n-        {\n-            e.printStackTrace();\n-        }\n-\n-        clearStatistics();", "originalCommit": "545207b7aef101b0117999bb8af44beeb4a24d4a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDU3MjkxMA==", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/873#discussion_r464572910", "bodyText": "Adding this step to ensure that the device methods subscription message gets acknowledged before continuing.", "author": "timtay-microsoft", "createdAt": "2020-08-03T17:56:30Z", "path": "iot-e2e-tests/common/src/test/java/tests/integration/com/microsoft/azure/sdk/iot/helpers/DeviceEmulator.java", "diffHunk": "@@ -149,6 +135,22 @@ else if (client instanceof ModuleClient)\n                     this.deviceMethodCallback, this.deviceMethodCallbackContext,\n                     this.deviceMethodStatusCallback, this.deviceMethodStatusCallbackContext);\n         }\n+\n+        long startTime = System.currentTimeMillis();\n+        while (deviceStatus.statusOk == 0)", "originalCommit": "545207b7aef101b0117999bb8af44beeb4a24d4a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDU3MzE1MQ==", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/873#discussion_r464573151", "bodyText": "Renaming to \"subscribe\" to be more descriptive", "author": "timtay-microsoft", "createdAt": "2020-08-03T17:56:57Z", "path": "iot-e2e-tests/common/src/test/java/tests/integration/com/microsoft/azure/sdk/iot/helpers/DeviceTestManager.java", "diffHunk": "@@ -50,29 +50,27 @@ public void waitIotHub(int numberOfEvents, long timeoutInSeconds) throws Interru\n         }\n     }\n \n-    public void clearDevice()\n+    public void clearStatistics()\n     {\n         this.deviceEmulator.clearStatistics();\n     }\n \n-    public void setup(boolean enableMethod, boolean enableTwin) throws IOException, InterruptedException", "originalCommit": "545207b7aef101b0117999bb8af44beeb4a24d4a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDU3NDA1Ng==", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/873#discussion_r464574056", "bodyText": "This creates a device/module client for this test and opens it. Not every test needs this though, so I moved this logic to the super.openDeviceClientAndSubscribeToMethods() call instead", "author": "timtay-microsoft", "createdAt": "2020-08-03T17:58:44Z", "path": "iot-e2e-tests/common/src/test/java/tests/integration/com/microsoft/azure/sdk/iot/iothub/methods/DeviceMethodTests.java", "diffHunk": "@@ -47,16 +45,11 @@ public DeviceMethodTests(IotHubClientProtocol protocol, AuthenticationType authe\n         super(protocol, authenticationType, clientType, publicKeyCert, privateKey, x509Thumbprint);\n     }\n \n-    @Before\n-    public void cleanToStart() throws Exception\n-    {\n-        super.cleanToStart();", "originalCommit": "545207b7aef101b0117999bb8af44beeb4a24d4a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDU3NTQ4Ng==", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/873#discussion_r464575486", "bodyText": "Having a static device method client is an issue since each client only allows one method invocation at a time (the method invocation method is synchronized)\nIn theory, if one test's method invocation takes 10 seconds, that adds a 10 second delay to all concurrently running tests, too.\nI removed this static client in favor of one client per test instance so that no test can interfere with a different test through this.", "author": "timtay-microsoft", "createdAt": "2020-08-03T18:01:29Z", "path": "iot-e2e-tests/common/src/test/java/tests/integration/com/microsoft/azure/sdk/iot/iothub/setup/DeviceMethodCommon.java", "diffHunk": "@@ -59,7 +59,6 @@ public static Collection inputs() throws Exception\n \n     protected static String iotHubConnectionString = \"\";\n \n-    protected static DeviceMethod methodServiceClient;", "originalCommit": "545207b7aef101b0117999bb8af44beeb4a24d4a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "271753e27f4c7bd30ad44c97fde6fe23126e0ba8", "url": "https://github.com/Azure/azure-iot-sdk-java/commit/271753e27f4c7bd30ad44c97fde6fe23126e0ba8", "message": "squash", "committedDate": "2020-08-03T18:03:54Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDU3ODQxNQ==", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/873#discussion_r464578415", "bodyText": "All of the above logic isn't necessary since the test client starts off closed, are opened elsewhere, and we no longer have connection stability issues that require us to use this confirmOpenStabilized(...) anymore.", "author": "timtay-microsoft", "createdAt": "2020-08-03T18:07:27Z", "path": "iot-e2e-tests/common/src/test/java/tests/integration/com/microsoft/azure/sdk/iot/iothub/setup/DeviceMethodCommon.java", "diffHunk": "@@ -255,36 +254,19 @@ public static void classSetup()\n         }\n     }\n \n-    public void cleanToStart() throws Exception\n+    public void openDeviceClientAndSubscribeToMethods() throws Exception\n     {\n         testInstance.setup();\n-        actualStatusUpdates = new ArrayList<Pair<IotHubConnectionStatus, Throwable>>();\n-        setConnectionStatusCallBack(actualStatusUpdates);\n+        testInstance.deviceTestManager.client.open();\n \n         try\n         {\n-            this.testInstance.deviceTestManager.tearDown();\n-        }\n-        catch (IOException e)\n-        {\n-            e.printStackTrace();\n-        }\n-        catch (InterruptedException e)\n-        {\n-            e.printStackTrace();\n-        }\n-\n-        this.testInstance.deviceTestManager.clearDevice();\n-\n-        try\n-        {\n-            this.testInstance.deviceTestManager.setup(true, false);\n-            IotHubServicesCommon.confirmOpenStabilized(actualStatusUpdates, 120000, this.testInstance.deviceTestManager.client);", "originalCommit": "271753e27f4c7bd30ad44c97fde6fe23126e0ba8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDU4MDkxNw==", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/873#discussion_r464580917", "bodyText": "As a backstory for this confirmOpenStabilized(), our AMQP layer used to be unstable and our tests would have to wait a bit for the instability to go away before continuing. I fixed that instability a while back, so we really don't need this anymore", "author": "timtay-microsoft", "createdAt": "2020-08-03T18:12:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDU3ODQxNQ=="}], "type": "inlineReview"}, {"oid": "1e8a7cb46325e4520d66fe25de0aab880c7c9e47", "url": "https://github.com/Azure/azure-iot-sdk-java/commit/1e8a7cb46325e4520d66fe25de0aab880c7c9e47", "message": "squash", "committedDate": "2020-08-03T18:08:53Z", "type": "commit"}]}