{"pr_number": 888, "pr_title": "fix(iot-dev): Fix issue where amqp layer ignored delivery state of sent messages", "pr_createdAt": "2020-08-07T22:59:06Z", "pr_url": "https://github.com/Azure/azure-iot-sdk-java/pull/888", "timeline": [{"oid": "53fec11a048202764bd17477703bafe07e89492b", "url": "https://github.com/Azure/azure-iot-sdk-java/commit/53fec11a048202764bd17477703bafe07e89492b", "message": "fix(iot-dev): Fix issue where amqp layer ignored delivery state of sent messages", "committedDate": "2020-08-07T22:58:12Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzMyMDM1Mw==", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/888#discussion_r467320353", "bodyText": "The exception translator above does the hard work of figuring out if the message can be retried or not", "author": "timtay-microsoft", "createdAt": "2020-08-07T23:00:49Z", "path": "device/iot-device-client/src/main/java/com/microsoft/azure/sdk/iot/device/transport/amqps/AmqpsIotHubConnection.java", "diffHunk": "@@ -468,9 +470,29 @@ public void onAuthenticationSessionOpened()\n     }\n \n     @Override\n-    public void onMessageAcknowledged(Message message)\n+    public void onMessageAcknowledged(Message message, DeliveryState deliveryState)\n     {\n-        this.listener.onMessageSent(message, null);\n+        if (deliveryState == Accepted.getInstance())\n+        {\n+            this.listener.onMessageSent(message, null);\n+        }\n+        else if (deliveryState instanceof Rejected)\n+        {\n+            // The message was not accepted by the server, and the reason why is found within the nested error\n+            TransportException ex = AmqpsExceptionTranslator.convertFromAmqpException(((Rejected) deliveryState).getError());\n+            this.listener.onMessageSent(message, ex);", "originalCommit": "53fec11a048202764bd17477703bafe07e89492b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "c49f24de70b07333a84e72c4291f5877d82157e0", "url": "https://github.com/Azure/azure-iot-sdk-java/commit/c49f24de70b07333a84e72c4291f5877d82157e0", "message": "Merge branch 'master' into timtay/amqpDeliveryState", "committedDate": "2020-08-13T16:01:43Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDA5NjM1Mg==", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/888#discussion_r470096352", "bodyText": "Does the service ever send a delivery state of \"released\"? What do they expect the client to do, in this case?", "author": "abhipsaMisra", "createdAt": "2020-08-13T17:02:25Z", "path": "device/iot-device-client/src/main/java/com/microsoft/azure/sdk/iot/device/transport/amqps/AmqpsIotHubConnection.java", "diffHunk": "@@ -468,9 +470,29 @@ public void onAuthenticationSessionOpened()\n     }\n \n     @Override\n-    public void onMessageAcknowledged(Message message)\n+    public void onMessageAcknowledged(Message message, DeliveryState deliveryState)\n     {\n-        this.listener.onMessageSent(message, null);\n+        if (deliveryState == Accepted.getInstance())\n+        {\n+            this.listener.onMessageSent(message, null);\n+        }\n+        else if (deliveryState instanceof Rejected)\n+        {\n+            // The message was not accepted by the server, and the reason why is found within the nested error\n+            TransportException ex = AmqpsExceptionTranslator.convertFromAmqpException(((Rejected) deliveryState).getError());\n+            this.listener.onMessageSent(message, ex);\n+        }\n+        else if (deliveryState == Released.getInstance())", "originalCommit": "c49f24de70b07333a84e72c4291f5877d82157e0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDEwMzA5OA==", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/888#discussion_r470103098", "bodyText": "I've never seen it, but the protocol defines it as a possible delivery state. As a delivery state, it just means that the service has made the message available to be re-delivered for whatever reason. So on the client side, we just need to create a retryable exception here so that the transport layer re-sends it", "author": "timtay-microsoft", "createdAt": "2020-08-13T17:10:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDA5NjM1Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDE1MDY1OQ==", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/888#discussion_r470150659", "bodyText": "why is the check for rejected look different than the other delivery states?\nShouldn't it be\ndeliveryState == Rejected.getInstance() ?", "author": "azabbasi", "createdAt": "2020-08-13T18:09:57Z", "path": "device/iot-device-client/src/main/java/com/microsoft/azure/sdk/iot/device/transport/amqps/AmqpsIotHubConnection.java", "diffHunk": "@@ -468,9 +470,29 @@ public void onAuthenticationSessionOpened()\n     }\n \n     @Override\n-    public void onMessageAcknowledged(Message message)\n+    public void onMessageAcknowledged(Message message, DeliveryState deliveryState)\n     {\n-        this.listener.onMessageSent(message, null);\n+        if (deliveryState == Accepted.getInstance())\n+        {\n+            this.listener.onMessageSent(message, null);\n+        }\n+        else if (deliveryState instanceof Rejected)", "originalCommit": "c49f24de70b07333a84e72c4291f5877d82157e0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDE1MTI3Nw==", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/888#discussion_r470151277", "bodyText": "Rejected is the one delivery state that comes with additional information in the ack. For Accepted/Released, there is no payload telling why the message was Accepted/Released. For Rejected, there should be some error details explaining why the message was rejected", "author": "timtay-microsoft", "createdAt": "2020-08-13T18:11:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDE1MDY1OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDE1MTkzOA==", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/888#discussion_r470151938", "bodyText": "There are at least 4 more delivery state types that are defined in the transport layer that will fall into the else statement here, can you point me to the service documentation that indicates what delivery states they may return? I am just curious.", "author": "azabbasi", "createdAt": "2020-08-13T18:12:13Z", "path": "device/iot-device-client/src/main/java/com/microsoft/azure/sdk/iot/device/transport/amqps/AmqpsIotHubConnection.java", "diffHunk": "@@ -468,9 +470,29 @@ public void onAuthenticationSessionOpened()\n     }\n \n     @Override\n-    public void onMessageAcknowledged(Message message)\n+    public void onMessageAcknowledged(Message message, DeliveryState deliveryState)\n     {\n-        this.listener.onMessageSent(message, null);\n+        if (deliveryState == Accepted.getInstance())\n+        {\n+            this.listener.onMessageSent(message, null);\n+        }\n+        else if (deliveryState instanceof Rejected)\n+        {\n+            // The message was not accepted by the server, and the reason why is found within the nested error\n+            TransportException ex = AmqpsExceptionTranslator.convertFromAmqpException(((Rejected) deliveryState).getError());\n+            this.listener.onMessageSent(message, ex);\n+        }\n+        else if (deliveryState == Released.getInstance())\n+        {\n+            // As per AMQP spec, this state means the message should be re-delivered to the server at a later time\n+            ProtocolException protocolException = new ProtocolException(\"Message was released by the amqp server\");\n+            protocolException.setRetryable(true);\n+            this.listener.onMessageSent(message, protocolException);\n+        }\n+        else", "originalCommit": "c49f24de70b07333a84e72c4291f5877d82157e0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDE1MzA4MQ==", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/888#discussion_r470153081", "bodyText": "There isn't any documentation like that, unfortunately. For Modified/Received, I'm not sure what the SDK is supposed to do. I've never seen those delivery states returned, though", "author": "timtay-microsoft", "createdAt": "2020-08-13T18:14:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDE1MTkzOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDE1NDA0Mg==", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/888#discussion_r470154042", "bodyText": "From the official AMQP spec, though:\n\u2022 accepted: indicates successful processing at the receiver.\n\u2022 rejected: indicates an invalid and unprocessable message.\n\u2022 released: indicates that the message was not (and will not be) processed.\n\u2022 modified: indicates that the message was modified, but not processed.\n\u2022 received: indicates partial message data seen by the receiver as well as the starting point for a resumed transfer.", "author": "timtay-microsoft", "createdAt": "2020-08-13T18:15:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDE1MTkzOA=="}], "type": "inlineReview"}]}