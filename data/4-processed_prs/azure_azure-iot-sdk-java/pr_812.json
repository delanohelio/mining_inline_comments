{"pr_number": 812, "pr_title": "Test Runners Simplification", "pr_createdAt": "2020-06-17T18:32:01Z", "pr_url": "https://github.com/Azure/azure-iot-sdk-java/pull/812", "timeline": [{"oid": "0309977fa364bcccedddc548897f71e42453dbad", "url": "https://github.com/Azure/azure-iot-sdk-java/commit/0309977fa364bcccedddc548897f71e42453dbad", "message": "refactor(e2e): Remove JVMRunner classes, move logic to test classes\n\nThis simplifies the test project by removing a layer of inheritence that is no longer needed", "committedDate": "2020-06-18T18:01:49Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjQ0NTQwMg==", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/812#discussion_r442445402", "bodyText": "No need to clean up here. The nightly jobs will clean these identities up", "author": "timtay-microsoft", "createdAt": "2020-06-18T19:13:18Z", "path": "iot-e2e-tests/android/app/src/androidTest/java/com/microsoft/azure/sdk/iot/android/iothub/HubTierConnectionAndroidRunner.java", "diffHunk": "@@ -41,15 +39,7 @@ public static Collection inputs() throws IOException, IotHubException, GeneralSe\n     {\n         iotHubConnectionString = BuildConfig.IotHubConnectionString;\n         isBasicTierHub = Boolean.parseBoolean(BuildConfig.IsBasicTierHub);\n-        Collection inputs = inputsCommon();\n-        identities = getIdentities(inputs);\n         isPullRequest = Boolean.parseBoolean(BuildConfig.IsPullRequest);\n-        return inputs;\n-    }\n-\n-    @AfterClass\n-    public static void cleanUpResources()\n-    {\n-        tearDown(identities);", "originalCommit": "2607dbd7041c3012d44dd9e4d39926768864257f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjQ0NTc5NA==", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/812#discussion_r442445794", "bodyText": "All of these configurations are lifted from the now defunct jvm pom.xml so that the jvm tests still run with the same settings", "author": "timtay-microsoft", "createdAt": "2020-06-18T19:14:07Z", "path": "iot-e2e-tests/common/pom.xml", "diffHunk": "@@ -117,6 +117,29 @@\n                     <argLine>\n                         -javaagent:${settings.localRepository}/org/jmockit/jmockit/1.24/jmockit-1.24.jar\n                     </argLine>\n+\n+                    <includes>\n+                        <!-- Mvn install will run tests found in the files that match the ______Tests.java naming pattern -->\n+                        <include>*Tests.java</include>\n+                    </includes>\n+\n+                    <!--\n+                    For more details on parallelization in use here, see:\n+                    http://maven.apache.org/surefire/maven-surefire-plugin/examples/fork-options-and-parallel-execution.html\n+                    -->\n+                    <!--Intentionally not using multiple forks. Tests are safe across threads, but don't appear to be safe across jvm instances at the same time-->\n+                    <forkCount>1</forkCount>\n+\n+                    <!--Tests can be run in parallel with tests within their own test class as well as in parallel with tests from other test classes-->\n+                    <parallel>both</parallel>\n+\n+                    <!--Maven will spawn up as many threads as it wants/can while running tests in parallel-->\n+                    <useUnlimitedThreads>true</useUnlimitedThreads>\n+\n+                    <skipITs>${skipITs}</skipITs>\n+                    <argLine>\n+                        -javaagent:${settings.localRepository}/org/jmockit/jmockit/1.24/jmockit-1.24.jar\n+                    </argLine>", "originalCommit": "2607dbd7041c3012d44dd9e4d39926768864257f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjQ0NjI0MA==", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/812#discussion_r442446240", "bodyText": "Now that we don't have separate runners for tpm/symmetrickey/x509, there is no way to just tag the TPM tests as flakey since it is in the same class as symmetric key and x509", "author": "timtay-microsoft", "createdAt": "2020-06-18T19:15:04Z", "path": "iot-e2e-tests/common/src/main/java/com/microsoft/azure/sdk/iot/common/setup/provisioning/ProvisioningCommon.java", "diffHunk": "@@ -133,7 +132,54 @@ else if (attestationType == AttestationType.TPM)\n         {\n             throw new IllegalArgumentException(\"Unknown attestation type provided\");\n         }\n+    }\n \n+    public static Collection inputs() throws Exception\n+    {\n+        if (IntegrationTest.isPullRequest)\n+        {\n+            return Arrays.asList(\n+                    new Object[][]\n+                            {\n+                                    {ProvisioningDeviceClientTransportProtocol.HTTPS, AttestationType.X509},\n+                                    {ProvisioningDeviceClientTransportProtocol.AMQPS, AttestationType.X509},\n+                                    {ProvisioningDeviceClientTransportProtocol.AMQPS_WS, AttestationType.X509},\n+                                    {ProvisioningDeviceClientTransportProtocol.MQTT, AttestationType.X509},\n+                                    {ProvisioningDeviceClientTransportProtocol.MQTT_WS, AttestationType.X509},\n+\n+                                    {ProvisioningDeviceClientTransportProtocol.HTTPS, AttestationType.SYMMETRIC_KEY},\n+                                    {ProvisioningDeviceClientTransportProtocol.AMQPS, AttestationType.SYMMETRIC_KEY},\n+                                    {ProvisioningDeviceClientTransportProtocol.AMQPS_WS, AttestationType.SYMMETRIC_KEY},\n+                                    {ProvisioningDeviceClientTransportProtocol.MQTT, AttestationType.SYMMETRIC_KEY},\n+                                    {ProvisioningDeviceClientTransportProtocol.MQTT_WS, AttestationType.SYMMETRIC_KEY},\n+\n+                                    //TODO tpm tests are flakey, so skip them for PR runs", "originalCommit": "2607dbd7041c3012d44dd9e4d39926768864257f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "6259df74303983e51f0ad21c0b55511a2c081a9f", "url": "https://github.com/Azure/azure-iot-sdk-java/commit/6259df74303983e51f0ad21c0b55511a2c081a9f", "message": "refactor(e2e): Remove JVMRunner classes, move logic to test classes\n\nThis simplifies the test project by removing a layer of inheritence that is no longer needed", "committedDate": "2020-06-18T20:05:46Z", "type": "forcePushed"}, {"oid": "e9028056e104c4a38824983d42e358efa6057b3b", "url": "https://github.com/Azure/azure-iot-sdk-java/commit/e9028056e104c4a38824983d42e358efa6057b3b", "message": "refactor(e2e): Remove JVMRunner classes, move logic to test classes\n\nThis simplifies the test project by removing a layer of inheritence that is no longer needed", "committedDate": "2020-06-18T23:14:54Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjU1Nzc4MQ==", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/812#discussion_r442557781", "bodyText": "This \"skipITs\" flag has outlived its usefulness, so I'm killing it. There are maven sponsored ways to skip integration tests", "author": "timtay-microsoft", "createdAt": "2020-06-18T23:42:49Z", "path": "deps/pom.xml", "diffHunk": "@@ -38,7 +38,6 @@\n \n     <properties>\n         <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>\n-        <skipITs>true</skipITs>", "originalCommit": "c7edf802310613c6853c94dcc3ffb6bed7d6ff7b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjU1Nzg5NQ==", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/812#discussion_r442557895", "bodyText": "Very orthogonal, but this unit test takes 1 minute to run, and adds nothing valuable", "author": "timtay-microsoft", "createdAt": "2020-06-18T23:43:12Z", "path": "deps/src/test/java/tests/unit/com/microsoft/azure/sdk/iot/deps/transport/amqp/AmqpConnectionTest.java", "diffHunk": "@@ -170,28 +170,6 @@ public void OpenThrowExceptionReactor() throws IOException, InterruptedException\n \n         //assert\n     }\n-\n-    @Test (expected = IOException.class)\n-    public void OpenThrowsOnWaitLock() throws IOException, InterruptedException\n-    {", "originalCommit": "c7edf802310613c6853c94dcc3ffb6bed7d6ff7b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjU1ODIwOQ==", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/812#discussion_r442558209", "bodyText": "In turning the common module into a test project, this jar no longer contains the actual test code that android needs to run. Switching over to local references because there is no other way to get the \"iot-e2e-common-0.26.0-tests.jar\" file", "author": "timtay-microsoft", "createdAt": "2020-06-18T23:44:16Z", "path": "iot-e2e-tests/android/app/build.gradle", "diffHunk": "@@ -82,10 +82,12 @@ dependencies {\n     implementation 'com.android.support:appcompat-v7:28.0.0'\n     implementation 'com.android.support:multidex:1.0.3'\n \n-    implementation ('com.microsoft.azure.sdk.iot:iot-e2e-common:0.26.0'){", "originalCommit": "c7edf802310613c6853c94dcc3ffb6bed7d6ff7b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjU1ODM2Mw==", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/812#discussion_r442558363", "bodyText": "In the pom file for the common module, I have excluded these jars from the shade jar, so there is no need to exclude them here anymore", "author": "timtay-microsoft", "createdAt": "2020-06-18T23:44:45Z", "path": "iot-e2e-tests/android/app/build.gradle", "diffHunk": "@@ -82,10 +82,12 @@ dependencies {\n     implementation 'com.android.support:appcompat-v7:28.0.0'\n     implementation 'com.android.support:multidex:1.0.3'\n \n-    implementation ('com.microsoft.azure.sdk.iot:iot-e2e-common:0.26.0'){\n-        exclude module: 'junit'\n-        exclude module: 'azure-storage'", "originalCommit": "c7edf802310613c6853c94dcc3ffb6bed7d6ff7b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjU1OTE0Mw==", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/812#discussion_r442559143", "bodyText": "previously, this test code was in a normal jar, not a test jar. This extra step is now necessary to package this new test project", "author": "timtay-microsoft", "createdAt": "2020-06-18T23:47:37Z", "path": "iot-e2e-tests/common/pom.xml", "diffHunk": "@@ -100,6 +96,20 @@\n                     <compilerArgument>-XDignore.symbol.file</compilerArgument>\n                 </configuration>\n             </plugin>\n+            <plugin>\n+                <groupId>org.apache.maven.plugins</groupId>\n+                <artifactId>maven-jar-plugin</artifactId>\n+                <version>2.2</version>\n+                <executions>\n+                    <execution>\n+                        <goals>\n+                            <!--This plugin will generate a jar file that contains all the test code so that the android\n+                            test code can reference it.-->\n+                            <goal>test-jar</goal>", "originalCommit": "c7edf802310613c6853c94dcc3ffb6bed7d6ff7b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjU1OTI1Nw==", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/812#discussion_r442559257", "bodyText": "These settings are taken directly from the old JVM module", "author": "timtay-microsoft", "createdAt": "2020-06-18T23:47:56Z", "path": "iot-e2e-tests/common/pom.xml", "diffHunk": "@@ -113,10 +123,17 @@\n                     </execution>\n                 </executions>\n                 <configuration>\n-                    <skipITs>${skipITs}</skipITs>\n-                    <argLine>\n-                        -javaagent:${settings.localRepository}/org/jmockit/jmockit/1.24/jmockit-1.24.jar\n-                    </argLine>\n+                    <includes>\n+                        <!--By default, only test files that end in ___Test.java are recognized as tests. This statement extends that to ___Tests.java files-->\n+                        <include>*Tests.java</include>\n+                    </includes>\n+                    <forkCount>1</forkCount>\n+\n+                    <!--Tests can be run in parallel with tests within their own test class as well as in parallel with tests from other test classes-->\n+                    <parallel>both</parallel>\n+\n+                    <!--Maven will spawn up as many threads as it wants/can while running tests in parallel-->\n+                    <useUnlimitedThreads>true</useUnlimitedThreads>", "originalCommit": "c7edf802310613c6853c94dcc3ffb6bed7d6ff7b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjU1OTQ1Ng==", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/812#discussion_r442559456", "bodyText": "This annotation used to sit at the JVMRunner level, but since that level no longer exists, this logic is here", "author": "timtay-microsoft", "createdAt": "2020-06-18T23:48:40Z", "path": "iot-e2e-tests/common/src/test/java/tests/integration/com/microsoft/azure/sdk/iot/iothub/FileUploadTests.java", "diffHunk": "@@ -36,20 +39,20 @@\n import java.util.concurrent.*;\n import java.util.concurrent.atomic.AtomicBoolean;\n \n-import static com.microsoft.azure.sdk.iot.common.helpers.CorrelationDetailsLoggingAssert.buildExceptionMessage;\n-import static com.microsoft.azure.sdk.iot.common.tests.iothub.FileUploadTests.STATUS.FAILURE;\n-import static com.microsoft.azure.sdk.iot.common.tests.iothub.FileUploadTests.STATUS.SUCCESS;\n import static com.microsoft.azure.sdk.iot.device.IotHubStatusCode.OK;\n import static com.microsoft.azure.sdk.iot.device.IotHubStatusCode.OK_EMPTY;\n import static junit.framework.TestCase.fail;\n import static org.junit.Assert.*;\n+import static tests.integration.com.microsoft.azure.sdk.iot.helpers.CorrelationDetailsLoggingAssert.buildExceptionMessage;\n+import static tests.integration.com.microsoft.azure.sdk.iot.iothub.FileUploadTests.STATUS.FAILURE;\n+import static tests.integration.com.microsoft.azure.sdk.iot.iothub.FileUploadTests.STATUS.SUCCESS;\n \n /**\n- * Test class containing all tests to be run on JVM and android pertaining to FileUpload. Class needs to be extended\n- * in order to run these tests as that extended class handles setting connection strings and certificate generation\n+ * Test class containing all tests to be run on JVM and android pertaining to FileUpload.\n  */\n @FlakeyTest\n @IotHubTest\n+@RunWith(Parameterized.class)", "originalCommit": "c7edf802310613c6853c94dcc3ffb6bed7d6ff7b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDM5NDA2NQ==", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/812#discussion_r444394065", "bodyText": "nit: braces n the same line or on new line?", "author": "abhipsaMisra", "createdAt": "2020-06-23T17:36:26Z", "path": "iot-e2e-tests/android/app/src/androidTest/java/com/microsoft/azure/sdk/iot/android/iothub/FileUploadAndroidRunner.java", "diffHunk": "@@ -32,17 +33,16 @@\n     @Rule\n     public Rerun count = new Rerun(3);\n \n-    public FileUploadAndroidRunner(IotHubClientProtocol protocol, AuthenticationType authenticationType, boolean withProxy) throws InterruptedException, IOException, IotHubException, URISyntaxException\n-    {\n+    public FileUploadAndroidRunner(IotHubClientProtocol protocol, AuthenticationType authenticationType, boolean withProxy) throws InterruptedException, IOException, IotHubException, URISyntaxException {", "originalCommit": "9f6a0c918c014a57c12ff36620532c28f91e2b08", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDQwNjM4Mw==", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/812#discussion_r444406383", "bodyText": "new line, good catch", "author": "timtay-microsoft", "createdAt": "2020-06-23T17:56:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDM5NDA2NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDM5NzYyNg==", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/812#discussion_r444397626", "bodyText": "why do we want tests to fail if teardown fails? Anything that is relevant to the test case should be a part of the test method directly.", "author": "abhipsaMisra", "createdAt": "2020-06-23T17:42:00Z", "path": "iot-e2e-tests/common/src/test/java/tests/integration/com/microsoft/azure/sdk/iot/iothub/TransportClientTests.java", "diffHunk": "@@ -956,7 +973,7 @@ private void tearDownTwin(TransportClient transportClient)\n         catch (Exception e)\n         {\n             e.printStackTrace();\n-            fail(\"Encountered exception during tearDownTwin: \" + Tools.getStackTraceFromThrowable(e));\n+            TestCase.fail(\"Encountered exception during tearDownTwin: \" + Tools.getStackTraceFromThrowable(e));", "originalCommit": "9f6a0c918c014a57c12ff36620532c28f91e2b08", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDQwNjU4NA==", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/812#discussion_r444406584", "bodyText": "Good point. I'll remove this", "author": "timtay-microsoft", "createdAt": "2020-06-23T17:56:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDM5NzYyNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDM5ODY3Ng==", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/812#discussion_r444398676", "bodyText": "why ignored?", "author": "abhipsaMisra", "createdAt": "2020-06-23T17:43:10Z", "path": "iot-e2e-tests/common/src/test/java/tests/integration/com/microsoft/azure/sdk/iot/iothub/serviceclient/JobClientTests.java", "diffHunk": "@@ -188,6 +201,7 @@ public static void tearDown() throws Exception\n     }\n \n     @Test (timeout=TEST_TIMEOUT_MS)\n+    @Ignore", "originalCommit": "9f6a0c918c014a57c12ff36620532c28f91e2b08", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDQwNjk2OQ==", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/812#discussion_r444406969", "bodyText": "These tests were previously ignored through the pom file rather than in source. I'm just moving the ignore back into source so it is more obvious that this test isn't being run", "author": "timtay-microsoft", "createdAt": "2020-06-23T17:57:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDM5ODY3Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDQwODM4OQ==", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/812#discussion_r444408389", "bodyText": "azure-iot-sdk-java/iot-e2e-tests/jvm/pom.xml\n    \n    \n         Line 126\n      in\n      453b31c\n    \n    \n    \n    \n\n        \n          \n           **/JobClientJVMRunner.java", "author": "timtay-microsoft", "createdAt": "2020-06-23T17:59:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDM5ODY3Ng=="}], "type": "inlineReview"}, {"oid": "665fdcf9d612d874267715b32dd6512556306899", "url": "https://github.com/Azure/azure-iot-sdk-java/commit/665fdcf9d612d874267715b32dd6512556306899", "message": "make environment variable retrieval done only at common level\n\nworks for both android and jvm", "committedDate": "2020-06-23T19:30:02Z", "type": "forcePushed"}, {"oid": "739526b29bf209055485aa9f5c5a456232a14de6", "url": "https://github.com/Azure/azure-iot-sdk-java/commit/739526b29bf209055485aa9f5c5a456232a14de6", "message": "refactor(e2e): Remove JVMRunner classes, move logic to test classes\n\nThis simplifies the test project by removing a layer of inheritence that is no longer needed", "committedDate": "2020-06-23T21:43:11Z", "type": "forcePushed"}, {"oid": "c4dfd70dfea3e29614294f59e763e34a2f2218d1", "url": "https://github.com/Azure/azure-iot-sdk-java/commit/c4dfd70dfea3e29614294f59e763e34a2f2218d1", "message": "refactor(e2e): Remove JVMRunner classes, move logic to test classes\n\nThis simplifies the test project by removing a layer of inheritence that is no longer needed", "committedDate": "2020-06-23T22:53:28Z", "type": "commit"}, {"oid": "c4dfd70dfea3e29614294f59e763e34a2f2218d1", "url": "https://github.com/Azure/azure-iot-sdk-java/commit/c4dfd70dfea3e29614294f59e763e34a2f2218d1", "message": "refactor(e2e): Remove JVMRunner classes, move logic to test classes\n\nThis simplifies the test project by removing a layer of inheritence that is no longer needed", "committedDate": "2020-06-23T22:53:28Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTA3ODI2OA==", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/812#discussion_r445078268", "bodyText": "This might be a good time to remove these test re-runs", "author": "abhipsaMisra", "createdAt": "2020-06-24T18:08:12Z", "path": "iot-e2e-tests/android/app/src/androidTest/java/com/microsoft/azure/sdk/iot/android/iothub/TokenRenewalAndroidRunner.java", "diffHunk": "@@ -20,13 +20,4 @@\n {\n     @Rule\n     public Rerun count = new Rerun(3);", "originalCommit": "c4dfd70dfea3e29614294f59e763e34a2f2218d1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTA3ODQ1Ng==", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/812#discussion_r445078456", "bodyText": "Sure thing", "author": "timtay-microsoft", "createdAt": "2020-06-24T18:08:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTA3ODI2OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTA3ODU5NQ==", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/812#discussion_r445078595", "bodyText": "Do we still need these android runners? Is it for separating tests by test groups?", "author": "abhipsaMisra", "createdAt": "2020-06-24T18:08:50Z", "path": "iot-e2e-tests/android/app/src/androidTest/java/com/microsoft/azure/sdk/iot/android/iothub/FileUploadAndroidRunner.java", "diffHunk": "@@ -36,13 +37,4 @@ public FileUploadAndroidRunner(IotHubClientProtocol protocol, AuthenticationType\n     {\n         super(protocol, authenticationType, withProxy);\n     }\n-", "originalCommit": "c4dfd70dfea3e29614294f59e763e34a2f2218d1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTA3OTkxMg==", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/812#discussion_r445079912", "bodyText": "At this point, yes, they only exist so that we can run them in smaller groups", "author": "timtay-microsoft", "createdAt": "2020-06-24T18:11:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTA3ODU5NQ=="}], "type": "inlineReview"}, {"oid": "5491f805d93b94ee91547c6101076bbfd98543f1", "url": "https://github.com/Azure/azure-iot-sdk-java/commit/5491f805d93b94ee91547c6101076bbfd98543f1", "message": "remove android reruns", "committedDate": "2020-06-24T18:10:57Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTA4MDg4Mg==", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/812#discussion_r445080882", "bodyText": "nit - and not directly related to this PR: these var names should also specify the time unit; is it 60 * 1000 ms/ 60 * 1000 secs/ 60 * 1000 mins ....?", "author": "abhipsaMisra", "createdAt": "2020-06-24T18:12:57Z", "path": "iot-e2e-tests/common/src/test/java/tests/integration/com/microsoft/azure/sdk/iot/helpers/Tools.java", "diffHunk": "@@ -15,22 +15,33 @@\n import java.io.IOException;\n import java.net.SocketException;\n import java.net.UnknownHostException;\n+import java.util.Arrays;\n import java.util.Collection;\n+import java.util.HashMap;\n+import java.util.Map;\n \n public class Tools\n {\n     private static final long RETRY_TIMEOUT_ON_NETWORK_FAILURE = 60 * 1000;", "originalCommit": "c4dfd70dfea3e29614294f59e763e34a2f2218d1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTA4MTIwMA==", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/812#discussion_r445081200", "bodyText": "Milliseconds, and sure, I can scrub through these real fast", "author": "timtay-microsoft", "createdAt": "2020-06-24T18:13:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTA4MDg4Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTA4MjU4NQ==", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/812#discussion_r445082585", "bodyText": "we should log something here, to indicate that env var retrieval from buildConfig failed.", "author": "abhipsaMisra", "createdAt": "2020-06-24T18:16:02Z", "path": "iot-e2e-tests/common/src/test/java/tests/integration/com/microsoft/azure/sdk/iot/helpers/Tools.java", "diffHunk": "@@ -39,21 +50,47 @@ public static String retrieveEnvironmentVariableValue(String environmentVariable\n \n     public static String retrieveEnvironmentVariableValue(String environmentVariableName, String defaultValue)\n     {\n-        try\n+        String environmentVariableValue;\n+        if (ANDROID_ENV_VAR.containsKey(environmentVariableName))\n+        {\n+            environmentVariableValue = ANDROID_ENV_VAR.get(environmentVariableName);\n+        }\n+        else\n         {\n-            String value = retrieveEnvironmentVariableValue(environmentVariableName);\n+            environmentVariableValue = System.getenv().get(environmentVariableName);\n+        }\n \n-            if (value == null || value.isEmpty())\n-            {\n-                return defaultValue;\n-            }\n+        if (environmentVariableValue == null || environmentVariableValue.isEmpty())\n+        {\n+            return defaultValue;\n+        }\n \n-            return value;\n+        return environmentVariableValue;\n+    }\n+\n+    private static Map<String, String> retrieveAndroidEnvVariables()\n+    {\n+        Map<String, String> envVariables = new HashMap<>();\n+        try\n+        {\n+            Class buildConfig = Class.forName(ANDROID_BUILD_CONFIG_CLASS);\n+            Arrays.stream(buildConfig.getFields()).forEach(field -> {\n+                try\n+                {\n+                    envVariables.put(field.getName(), field.get(null).toString());\n+                }\n+                catch (IllegalAccessException e)\n+                {\n+                    // disregard", "originalCommit": "c4dfd70dfea3e29614294f59e763e34a2f2218d1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTA4MzAyMA==", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/812#discussion_r445083020", "bodyText": "Our e2e test suite currently doesn't log anything but test failures", "author": "timtay-microsoft", "createdAt": "2020-06-24T18:16:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTA4MjU4NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTA4MzE0Nw==", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/812#discussion_r445083147", "bodyText": "I can see about adding this, though", "author": "timtay-microsoft", "createdAt": "2020-06-24T18:17:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTA4MjU4NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTA4NDg4Ng==", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/812#discussion_r445084886", "bodyText": "this shouldn't be required any more, correct?", "author": "abhipsaMisra", "createdAt": "2020-06-24T18:20:06Z", "path": "iot-e2e-tests/common/src/test/java/tests/integration/com/microsoft/azure/sdk/iot/iothub/serviceclient/ExportImportTests.java", "diffHunk": "@@ -56,7 +55,26 @@\n \n     private static RegistryManager registryManager;\n \n+    @BeforeClass\n     public static void setUp() throws URISyntaxException, InvalidKeyException, StorageException, IOException\n+    {\n+        if (iotHubConnectionString == null || iotHubConnectionString.isEmpty())\n+        {\n+            iotHubConnectionString = Tools.retrieveEnvironmentVariableValue(TestConstants.IOT_HUB_CONNECTION_STRING_ENV_VAR_NAME);\n+            isBasicTierHub = Boolean.parseBoolean(Tools.retrieveEnvironmentVariableValue(TestConstants.IS_BASIC_TIER_HUB_ENV_VAR_NAME));\n+            storageAccountConnectionString = Tools.retrieveEnvironmentVariableValue(TestConstants.STORAGE_ACCOUNT_CONNECTION_STRING_ENV_VAR_NAME);\n+            isPullRequest = Boolean.parseBoolean(Tools.retrieveEnvironmentVariableValue(TestConstants.IS_PULL_REQUEST));\n+        }\n+\n+        // If the environment variable isn't set, then it is likely because it is an android device running these tests\n+        // If running these tests on android, a different method will get the environment variables, and then call setUpCommon().", "originalCommit": "c4dfd70dfea3e29614294f59e763e34a2f2218d1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTA4NTAxMg==", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/812#discussion_r445085012", "bodyText": "Yep, I'll delete this", "author": "timtay-microsoft", "createdAt": "2020-06-24T18:20:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTA4NDg4Ng=="}], "type": "inlineReview"}, {"oid": "a9b900374f4030e101933417591051594a6578ff", "url": "https://github.com/Azure/azure-iot-sdk-java/commit/a9b900374f4030e101933417591051594a6578ff", "message": "cr comments", "committedDate": "2020-06-24T18:24:28Z", "type": "commit"}, {"oid": "9923a621475671a7fbe5ba6386e6aa0098ce102b", "url": "https://github.com/Azure/azure-iot-sdk-java/commit/9923a621475671a7fbe5ba6386e6aa0098ce102b", "message": "Merge branch 'master' into timtay/testRunners", "committedDate": "2020-06-24T18:26:14Z", "type": "commit"}, {"oid": "260ab2b3f2b068ccb2f9ccd06f1a91398cb30c9c", "url": "https://github.com/Azure/azure-iot-sdk-java/commit/260ab2b3f2b068ccb2f9ccd06f1a91398cb30c9c", "message": "fixup", "committedDate": "2020-06-24T18:46:29Z", "type": "commit"}, {"oid": "7428a57e71212f5e1920df5579756d6dabef5ce2", "url": "https://github.com/Azure/azure-iot-sdk-java/commit/7428a57e71212f5e1920df5579756d6dabef5ce2", "message": "Merge branch 'timtay/testRunners' of https://github.com/Azure/azure-iot-sdk-java into timtay/testRunners", "committedDate": "2020-06-24T18:46:45Z", "type": "commit"}]}