{"pr_number": 856, "pr_title": "Support topic message fragmentation with chunking of messages", "pr_createdAt": "2020-07-07T18:23:12Z", "pr_url": "https://github.com/hashgraph/hedera-mirror-node/pull/856", "timeline": [{"oid": "70ea7bcc87d11681d66c1ac7ca54ebcb1a697575", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/70ea7bcc87d11681d66c1ac7ca54ebcb1a697575", "message": "Support topic message fragmentaton with chunking of messages in importer and grpc\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2020-07-09T02:51:11Z", "type": "commit"}, {"oid": "92787414a29857f3b9251d1ebc9ce91792d9411b", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/92787414a29857f3b9251d1ebc9ce91792d9411b", "message": "Address nullable chunk info in tests\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2020-07-09T02:51:11Z", "type": "commit"}, {"oid": "70d730f5389c080a0de5f047dd711fea25e10f2b", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/70d730f5389c080a0de5f047dd711fea25e10f2b", "message": "Fix broken grpc tests\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2020-07-09T02:51:11Z", "type": "commit"}, {"oid": "1689f35328cf3d38842ab4e395dbe2477dcf7ae7", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/1689f35328cf3d38842ab4e395dbe2477dcf7ae7", "message": "Added additional tests\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2020-07-09T02:51:11Z", "type": "commit"}, {"oid": "87da46c57166db44fe48404c6baf3899eb763663", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/87da46c57166db44fe48404c6baf3899eb763663", "message": "Removed extra out of order message in test\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2020-07-09T02:51:11Z", "type": "commit"}, {"oid": "87da46c57166db44fe48404c6baf3899eb763663", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/87da46c57166db44fe48404c6baf3899eb763663", "message": "Removed extra out of order message in test\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2020-07-09T02:51:11Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTA3NDk1NA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/856#discussion_r451074954", "bodyText": "Did you check the previous releases to see if it impacts us and we need to add any response codes, etc besides the chunk specific ones? e.g. 0.4.3+ and 0.5.x if applicable", "author": "steven-sheehy", "createdAt": "2020-07-07T18:53:12Z", "path": "pom.xml", "diffHunk": "@@ -60,7 +60,7 @@\n         <docker.skip.deployer>true</docker.skip.deployer>\n         <docker.tag.version>${project.version}</docker.tag.version>\n         <grpc.version>1.29.0</grpc.version>\n-        <hedera-protobuf.version>0.4.2</hedera-protobuf.version>\n+        <hedera-protobuf.version>0.6.0-alpha1</hedera-protobuf.version>", "originalCommit": "607bf4cb8455ec0085870a4bef8eb09d692b83e5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjQ5MTA0Mg==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/856#discussion_r452491042", "bodyText": "I did check the response code to see if there were any updates prior and post 0.4.2.\nI also checked for other proto updates and doesn't seem to be any.", "author": "Nana-EC", "createdAt": "2020-07-09T21:08:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTA3NDk1NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjUyMTQ3MQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/856#discussion_r452521471", "bodyText": "Cool, just wanted to verify that check was done. Thanks", "author": "steven-sheehy", "createdAt": "2020-07-09T22:19:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTA3NDk1NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTA3NTMwMA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/856#discussion_r451075300", "bodyText": "nit: I don't think this line should be wrapped. Doesn't look that long.", "author": "steven-sheehy", "createdAt": "2020-07-07T18:53:54Z", "path": "hedera-mirror-protobuf/src/main/proto/com/hedera/mirror/api/proto/ConsensusService.proto", "diffHunk": "@@ -53,12 +54,15 @@ message ConsensusTopicResponse {\n     uint64 sequenceNumber = 4; // Starts at 1 for first submitted message. Incremented on each submitted message.\n \n     uint64 runningHashVersion = 5; // Version of the SHA-384 digest used to update the running hash.\n+\n+    .proto.ConsensusMessageChunkInfo chunkInfo = 6; // Optional information of the current chunk in a fragmented message.\n }\n \n //\n // The Mirror Service provides the ability to query a stream of Hedera Consensus Service (HCS) messages for an\n // HCS Topic via a specific (possibly open-ended) time range.\n //\n service ConsensusService {\n-    rpc subscribeTopic (ConsensusTopicQuery) returns (stream ConsensusTopicResponse);\n+    rpc subscribeTopic (ConsensusTopicQuery) returns (stream", "originalCommit": "607bf4cb8455ec0085870a4bef8eb09d692b83e5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjQ5MTM0Ng==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/856#discussion_r452491346", "bodyText": "Seems to have been an automated change will revert", "author": "Nana-EC", "createdAt": "2020-07-09T21:08:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTA3NTMwMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTExNjEyMg==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/856#discussion_r451116122", "bodyText": "I think we have to use regular int to match the proto. With timestamps or sequence numbers we can save space because the main nodes generate them and we can be reasonably sure they'll be low in our lifetime. For chunk num and total they are user input so mirror node will break if a user types in a very high chunk number/total.", "author": "steven-sheehy", "createdAt": "2020-07-07T20:13:01Z", "path": "hedera-mirror-importer/src/main/resources/db/migration/V1.26.0__topic_message_fragmentation.sql", "diffHunk": "@@ -0,0 +1,14 @@\n+-------------------\n+-- Support topic message fragmentation by adding columns for ConsensusMessageChunkInfo\n+-------------------\n+\n+-- add payer account and valid start time columns for transaction id. Add chunk count and total columns.\n+alter table if exists topic_message\n+    add column if not exists chunk_num smallint null,", "originalCommit": "607bf4cb8455ec0085870a4bef8eb09d692b83e5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjQ5MTQyNQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/856#discussion_r452491425", "bodyText": "Good point", "author": "Nana-EC", "createdAt": "2020-07-09T21:09:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTExNjEyMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTExNzg5OA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/856#discussion_r451117898", "bodyText": "Would prefer valid_start_timestamp as we should standardize on _timestamp like we do for consensus_timestamp instead of _ns that we do in transaction table. Also the proto object is of type Timestamp and it matches that.", "author": "steven-sheehy", "createdAt": "2020-07-07T20:16:47Z", "path": "hedera-mirror-importer/src/main/resources/db/migration/V1.26.0__topic_message_fragmentation.sql", "diffHunk": "@@ -0,0 +1,14 @@\n+-------------------\n+-- Support topic message fragmentation by adding columns for ConsensusMessageChunkInfo\n+-------------------\n+\n+-- add payer account and valid start time columns for transaction id. Add chunk count and total columns.\n+alter table if exists topic_message\n+    add column if not exists chunk_num smallint null,\n+    add column if not exists chunk_total smallint null,\n+    add column if not exists payer_account_id entity_id null,\n+    add column if not exists valid_start_ns nanos_timestamp null;", "originalCommit": "607bf4cb8455ec0085870a4bef8eb09d692b83e5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjQ5NDc2NA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/856#discussion_r452494764", "bodyText": "Updated to valid_start_timestamp", "author": "Nana-EC", "createdAt": "2020-07-09T21:15:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTExNzg5OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjMzNTI5Mw==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/856#discussion_r452335293", "bodyText": "We don't need to explicitly set null values as they are the default. Though we should consider populating real data here to test all fields.", "author": "steven-sheehy", "createdAt": "2020-07-09T16:16:51Z", "path": "hedera-mirror-grpc/src/test/java/com/hedera/mirror/grpc/domain/DomainBuilder.java", "diffHunk": "@@ -93,7 +93,11 @@ void setup() {\n                 .runningHash(new byte[] {3, 4, 5})\n                 .sequenceNumber(++sequenceNumber)\n                 .topicNum(0)\n-                .runningHashVersion(2);\n+                .runningHashVersion(2)\n+                .payerAccountId(null)", "originalCommit": "87da46c57166db44fe48404c6baf3899eb763663", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjQ5NTk1NA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/856#discussion_r452495954", "bodyText": "True. Since we're expecting null to be default scenario this works and we can rely on tests specifically setting the chunking cases.", "author": "Nana-EC", "createdAt": "2020-07-09T21:18:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjMzNTI5Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjM0MzM4OQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/856#discussion_r452343389", "bodyText": "I'm not a fan of all these overloaded methods to create a topic message. The whole point of constructing the DomainBuilder was to avoid this by using a single method to construct and passing a consumer to customize extra fields.", "author": "steven-sheehy", "createdAt": "2020-07-09T16:29:58Z", "path": "hedera-mirror-grpc/src/test/java/com/hedera/mirror/grpc/service/TopicMessageServiceTest.java", "diffHunk": "@@ -684,19 +777,45 @@ private void missingMessagesFromListenerTest(TopicMessageFilter filter, Flux<Top\n                 .thenReturn(missingMessages);\n     }\n \n+    private List<TopicMessage> fragmentedTopicMessages(long sequenceNumberStart, int fragmentCount) {\n+        List<TopicMessage> topicMessages = new ArrayList<>();\n+        for (int i = 0; i < fragmentCount; i++) {\n+            long sequenceNumber = sequenceNumberStart + i;\n+            topicMessages.add(topicMessage(sequenceNumber, i + 1, fragmentCount,\n+                    Instant.EPOCH.plus(sequenceNumber, ChronoUnit.NANOS), 3L));\n+        }\n+\n+        return topicMessages;\n+    }\n+\n     private TopicMessage topicMessage(long sequenceNumber) {\n-        return TopicMessage.builder()\n-                .consensusTimestamp(Instant.EPOCH.plus(sequenceNumber, ChronoUnit.NANOS))\n-                .realmNum(0)\n-                .sequenceNumber(sequenceNumber)\n-                .build();\n+        return topicMessage(sequenceNumber, Instant.EPOCH.plus(sequenceNumber, ChronoUnit.NANOS));", "originalCommit": "87da46c57166db44fe48404c6baf3899eb763663", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjQ5Nzc5NQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/856#discussion_r452497795", "bodyText": "Sure I can revert given the suggestion to move the test to ConsensusControllerTest instead.", "author": "Nana-EC", "createdAt": "2020-07-09T21:22:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjM0MzM4OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjM2MzY1MA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/856#discussion_r452363650", "bodyText": "Would prefer payerAccountEntity.", "author": "steven-sheehy", "createdAt": "2020-07-09T17:03:58Z", "path": "hedera-mirror-grpc/src/main/java/com/hedera/mirror/grpc/domain/TopicMessage.java", "diffHunk": "@@ -72,23 +76,61 @@\n \n     private int topicNum;\n \n+    private Integer chunkNum;\n+\n+    private Integer chunkTotal;\n+\n+    @ToString.Exclude\n+    private Long payerAccountId;\n+\n+    @Getter(lazy = true)\n+    @Transient\n+    private com.hedera.mirror.grpc.domain.Entity payerDecodedAccountId = EncodedIdToEntityIdConverter.INSTANCE", "originalCommit": "87da46c57166db44fe48404c6baf3899eb763663", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjQ5OTM5NQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/856#discussion_r452499395", "bodyText": "Works for me", "author": "Nana-EC", "createdAt": "2020-07-09T21:25:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjM2MzY1MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjM2MzkxNQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/856#discussion_r452363915", "bodyText": "EncodedIdToEntityConverter since there's no EntityId class in grpc.", "author": "steven-sheehy", "createdAt": "2020-07-09T17:04:27Z", "path": "hedera-mirror-grpc/src/main/java/com/hedera/mirror/grpc/converter/EncodedIdToEntityIdConverter.java", "diffHunk": "@@ -0,0 +1,59 @@\n+package com.hedera.mirror.grpc.converter;\n+\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+\n+import javax.inject.Named;\n+import org.springframework.core.convert.converter.Converter;\n+import org.springframework.data.convert.WritingConverter;\n+\n+import com.hedera.mirror.grpc.domain.Entity;\n+import com.hedera.mirror.grpc.domain.EntityType;\n+\n+@Named\n+@WritingConverter\n+public class EncodedIdToEntityIdConverter implements Converter<Long, Entity> {", "originalCommit": "87da46c57166db44fe48404c6baf3899eb763663", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjQ5OTY4NA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/856#discussion_r452499684", "bodyText": "Works for me", "author": "Nana-EC", "createdAt": "2020-07-09T21:26:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjM2MzkxNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjM2OTY1OQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/856#discussion_r452369659", "bodyText": "Think the non-mock test is sufficient to verify fragmented messages. I would recommend this type of payload check be moved instead to ConsensusControllerTest as we're not currently testing that mapping.", "author": "steven-sheehy", "createdAt": "2020-07-09T17:14:24Z", "path": "hedera-mirror-grpc/src/test/java/com/hedera/mirror/grpc/service/TopicMessageServiceTest.java", "diffHunk": "@@ -643,6 +645,97 @@ void missingMessagesFromRetrieverAndListener() {\n                 .verify(Duration.ofMillis(700));\n     }\n \n+    @Test\n+    void fragmentedMessages() {", "originalCommit": "87da46c57166db44fe48404c6baf3899eb763663", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjQ5OTc0OQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/856#discussion_r452499749", "bodyText": "Cool. Moved to ConsensusControllerTest.", "author": "Nana-EC", "createdAt": "2020-07-09T21:26:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjM2OTY1OQ=="}], "type": "inlineReview"}, {"oid": "3b652222744dd4c55b464d02a792a8f60cf59c2f", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/3b652222744dd4c55b464d02a792a8f60cf59c2f", "message": "Addressed feedback\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2020-07-09T21:15:03Z", "type": "commit"}, {"oid": "f854b4816ebe7fee6e9fd1c2df09c2c5e56fa682", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/f854b4816ebe7fee6e9fd1c2df09c2c5e56fa682", "message": "Change validStartNs to validStartTimestamp in grpc\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2020-07-09T22:10:55Z", "type": "commit"}, {"oid": "46d57229c049a69318916a949654f52382c5bb4c", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/46d57229c049a69318916a949654f52382c5bb4c", "message": "Update test fragmentedMessagesGroupAcrossHistoricAndIncoming timestamps\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2020-07-09T22:26:32Z", "type": "commit"}]}