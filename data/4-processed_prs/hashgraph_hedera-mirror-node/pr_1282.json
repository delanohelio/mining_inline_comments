{"pr_number": 1282, "pr_title": "Improve gRPC missing message handling in TopicMessageService", "pr_createdAt": "2020-11-20T16:19:52Z", "pr_url": "https://github.com/hashgraph/hedera-mirror-node/pull/1282", "timeline": [{"oid": "6ae8837c6c7a21d14f69a11c6eaada076751588d", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/6ae8837c6c7a21d14f69a11c6eaada076751588d", "message": "new timeout mechanism\n\nSigned-off-by: Xin Li <xin.li@swirlds.com>", "committedDate": "2020-11-11T15:15:57Z", "type": "commit"}, {"oid": "be6ba65755aeb2bd746e068d8f93e18fcc8947f2", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/be6ba65755aeb2bd746e068d8f93e18fcc8947f2", "message": "reduce the number of chained flux operations, optimize filters\n\nSigned-off-by: Xin Li <xin.li@swirlds.com>", "committedDate": "2020-11-13T15:18:43Z", "type": "commit"}, {"oid": "af319dcb4e68d19aa3e32fa866d84d012ce992a1", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/af319dcb4e68d19aa3e32fa866d84d012ce992a1", "message": "revert TopicMessage back to use AtomicReference, fix integration test case\n\nSigned-off-by: Xin Li <xin.li@swirlds.com>", "committedDate": "2020-11-13T17:22:01Z", "type": "commit"}, {"oid": "f0dade1547d44a6820f5fc998b3278c7d5f9d803", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/f0dade1547d44a6820f5fc998b3278c7d5f9d803", "message": "clean up and fix integration test failures\n\nSigned-off-by: Xin Li <xin.li@swirlds.com>", "committedDate": "2020-11-17T16:26:10Z", "type": "commit"}, {"oid": "086e036aa6ffd37474ed063fb23032d8f6aa308f", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/086e036aa6ffd37474ed063fb23032d8f6aa308f", "message": "increase grpc container cpu and memory limits\n\nSigned-off-by: Xin Li <xin.li@swirlds.com>", "committedDate": "2020-11-17T16:27:36Z", "type": "commit"}, {"oid": "ae24d1350cee7dac7490ea507b34c92dc649b0eb", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/ae24d1350cee7dac7490ea507b34c92dc649b0eb", "message": "Merge branch 'master' into grpc-timeout", "committedDate": "2020-11-17T16:28:16Z", "type": "commit"}, {"oid": "5dc58cf600420ccbc36cf69a5ebd6d5b85218e32", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/5dc58cf600420ccbc36cf69a5ebd6d5b85218e32", "message": "sonacloud says code smell\n\nSigned-off-by: Xin Li <xin.li@swirlds.com>", "committedDate": "2020-11-17T16:51:24Z", "type": "commit"}, {"oid": "b36e2afb86dc469a81a61667b1f32bbc6dae31fe", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/b36e2afb86dc469a81a61667b1f32bbc6dae31fe", "message": "fix test failure\n\nSigned-off-by: Xin Li <xin.li@swirlds.com>", "committedDate": "2020-11-17T17:18:31Z", "type": "commit"}, {"oid": "206ca8a45658a88651a214016473c4ec0c9799b2", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/206ca8a45658a88651a214016473c4ec0c9799b2", "message": "Merge branch 'master' into grpc-improve-gap-handling", "committedDate": "2020-11-17T20:01:47Z", "type": "commit"}, {"oid": "1dbf35252202021577f574f7ce5cf5e8dfc32875", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/1dbf35252202021577f574f7ce5cf5e8dfc32875", "message": "address review feedback\n\nSigned-off-by: Xin Li <xin.li@swirlds.com>", "committedDate": "2020-11-18T23:07:41Z", "type": "commit"}, {"oid": "7d53af27c62a04d7f83cf9a76418c57d79c8a8a6", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/7d53af27c62a04d7f83cf9a76418c57d79c8a8a6", "message": "Merge branch 'grpc-optmization' into grpc-improve-gap-handling", "committedDate": "2020-11-19T04:57:53Z", "type": "commit"}, {"oid": "418bb4d986dd33943730a5569fb6da32b88d20bf", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/418bb4d986dd33943730a5569fb6da32b88d20bf", "message": "add unthrottled mode to TopicMessageRetriever and use it for full speed missing message retrieval in TopicMessageService\n\nSigned-off-by: Xin Li <xin.li@swirlds.com>", "committedDate": "2020-11-20T15:47:41Z", "type": "commit"}, {"oid": "c573c3e5790b9aeca9c2ade50ae812f12ba150b7", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/c573c3e5790b9aeca9c2ade50ae812f12ba150b7", "message": "Merge branch 'master' into grpc-improve-gap-handling\n\nSigned-off-by: Xin Li <xin.li@swirlds.com>", "committedDate": "2020-11-20T16:14:02Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzk1Njk2NA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1282#discussion_r527956964", "bodyText": "Can we add a DurationMin?", "author": "steven-sheehy", "createdAt": "2020-11-20T20:36:31Z", "path": "hedera-mirror-grpc/src/main/java/com/hedera/mirror/grpc/retriever/RetrieverProperties.java", "diffHunk": "@@ -45,4 +45,13 @@\n \n     @NotNull\n     private Duration timeout = Duration.ofSeconds(60L);\n+\n+    @Min(1000)\n+    private int unthrottledMaxPageSize = 5000;\n+\n+    @NotNull", "originalCommit": "c573c3e5790b9aeca9c2ade50ae812f12ba150b7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzk4NTY3NQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1282#discussion_r527985675", "bodyText": "sure", "author": "xin-hedera", "createdAt": "2020-11-20T21:40:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzk1Njk2NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzk1NzQxNg==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1282#discussion_r527957416", "bodyText": "Can we add a nested object to group these and simplify the naming?", "author": "steven-sheehy", "createdAt": "2020-11-20T20:37:33Z", "path": "hedera-mirror-grpc/src/main/java/com/hedera/mirror/grpc/retriever/RetrieverProperties.java", "diffHunk": "@@ -45,4 +45,13 @@\n \n     @NotNull\n     private Duration timeout = Duration.ofSeconds(60L);\n+\n+    @Min(1000)\n+    private int unthrottledMaxPageSize = 5000;", "originalCommit": "c573c3e5790b9aeca9c2ade50ae812f12ba150b7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzk4NTcxMw==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1282#discussion_r527985713", "bodyText": "will do", "author": "xin-hedera", "createdAt": "2020-11-20T21:40:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzk1NzQxNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzk2NzE5MQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1282#discussion_r527967191", "bodyText": "Is there a scenario where missing messages could return less than page size and not be complete?", "author": "steven-sheehy", "createdAt": "2020-11-20T20:59:56Z", "path": "hedera-mirror-grpc/src/main/java/com/hedera/mirror/grpc/retriever/PollingTopicMessageRetriever.java", "diffHunk": "@@ -98,19 +98,45 @@ public PollingTopicMessageRetriever(RetrieverProperties retrieverProperties,\n     private class PollingContext {\n \n         private final TopicMessageFilter filter;\n+        private final boolean throttled;\n+        private final Duration frequency;\n+        private final int maxPageSize;\n+        private final long numRepeats;\n         private final AtomicLong pageSize = new AtomicLong(0L);\n         private final Stopwatch stopwatch = Stopwatch.createStarted();\n         private final AtomicLong total = new AtomicLong(0L);\n         private volatile TopicMessage last;\n \n+        public PollingContext(TopicMessageFilter filter, boolean throttled) {\n+            this.filter = filter;\n+            this.throttled = throttled;\n+\n+            if (throttled) {\n+                numRepeats = Long.MAX_VALUE;\n+                frequency = retrieverProperties.getPollingFrequency();\n+                maxPageSize = retrieverProperties.getMaxPageSize();\n+            } else {\n+                numRepeats = retrieverProperties.getUnthrottledMaxPolls();\n+                frequency = retrieverProperties.getUnthrottledPollingFrequency();\n+                maxPageSize = retrieverProperties.getUnthrottledMaxPageSize();\n+            }\n+        }\n+\n         /**\n          * Checks if this publisher is complete by comparing if the number of results in the last page was less than the\n-         * page size. This avoids the extra query if we were to just check if last page was empty.\n+         * page size or if the limit has reached if it's set. This avoids the extra query if we were to just check\n+         * if last page was empty.\n          *\n          * @return whether all historic messages have been returned\n          */\n         boolean isComplete() {\n-            return pageSize.get() < retrieverProperties.getMaxPageSize();\n+            boolean limitHit = filter.hasLimit() && filter.getLimit() == total.get();\n+\n+            if (throttled) {\n+                return pageSize.get() < retrieverProperties.getMaxPageSize() || limitHit;", "originalCommit": "c573c3e5790b9aeca9c2ade50ae812f12ba150b7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzk4NjUzNw==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1282#discussion_r527986537", "bodyText": "yes. when tps is low, and the listener misses messages of multiple record files, one poll might get the missing messages of one record file from db, the number of messages might be less than the page size and still we need more polls to fill in the gap", "author": "xin-hedera", "createdAt": "2020-11-20T21:42:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzk2NzE5MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODAwMDE3Mg==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1282#discussion_r528000172", "bodyText": "I don't think that's true in practice as we use transactions to commit the entire record at once and we don't send to redis until that transaction is complete. So there should be an invariant that all messages before the message that triggers the missing messages flow are already in the database. But probably fine to keep this to be extra safe.", "author": "steven-sheehy", "createdAt": "2020-11-20T22:16:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzk2NzE5MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODAwNzY4Nw==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1282#discussion_r528007687", "bodyText": "umm, my understanding is we first publish all topic messages to the channel, then commit the db transaction.\nSqlEntityListener:\n\n  \n    \n      hedera-mirror-node/hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/parser/record/entity/sql/SqlEntityListener.java\n    \n    \n        Lines 183 to 199\n      in\n      a7d4932\n    \n    \n    \n    \n\n        \n          \n           private void executeBatches() { \n        \n\n        \n          \n               Connection connection = null; \n        \n\n        \n          \n            \n        \n\n        \n          \n               try { \n        \n\n        \n          \n                   connection = DataSourceUtils.getConnection(dataSource); \n        \n\n        \n          \n                   Stopwatch stopwatch = Stopwatch.createStarted(); \n        \n\n        \n          \n                   transactionPgCopy.copy(transactions, connection); \n        \n\n        \n          \n                   cryptoTransferPgCopy.copy(cryptoTransfers, connection); \n        \n\n        \n          \n                   nonFeeTransferPgCopy.copy(nonFeeTransfers, connection); \n        \n\n        \n          \n                   fileDataPgCopy.copy(fileData, connection); \n        \n\n        \n          \n                   contractResultPgCopy.copy(contractResults, connection); \n        \n\n        \n          \n                   liveHashPgCopy.copy(liveHashes, connection); \n        \n\n        \n          \n                   topicMessagePgCopy.copy(topicMessages, connection); \n        \n\n        \n          \n                   tokenTransferPgCopy.copy(tokenTransfers, connection); \n        \n\n        \n          \n                   persistEntities(); \n        \n\n        \n          \n                   log.info(\"Completed batch inserts in {}\", stopwatch); \n        \n\n        \n          \n                   eventPublisher.publishEvent(new EntityBatchSaveEvent(this)); \n        \n    \n  \n\n\nRedisEntityListener:\n\n  \n    \n      hedera-mirror-node/hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/parser/record/entity/redis/RedisEntityListener.java\n    \n    \n        Lines 83 to 92\n      in\n      a7d4932\n    \n    \n    \n    \n\n        \n          \n           @Override \n        \n\n        \n          \n           @EventListener \n        \n\n        \n          \n           public void onSave(EntityBatchSaveEvent event) { \n        \n\n        \n          \n               try { \n        \n\n        \n          \n                   if (isEnabled()) { \n        \n\n        \n          \n                       Stopwatch stopwatch = Stopwatch.createStarted(); \n        \n\n        \n          \n                       timer.record(() -> redisOperations.executePipelined(callback())); \n        \n\n        \n          \n                       log.info(\"Finished notifying {} messages in {}\", topicMessages.size(), stopwatch); \n        \n\n        \n          \n                   } \n        \n\n        \n          \n               } catch (Exception e) {", "author": "xin-hedera", "createdAt": "2020-11-20T22:38:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzk2NzE5MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODAwOTI0OA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1282#discussion_r528009248", "bodyText": "No, it's the exact opposite. Invoking eventPublisher.publishEvent(new EntityBatchSaveEvent(this)) after persisting to db will directly call RedisEntityListener.onSave().", "author": "steven-sheehy", "createdAt": "2020-11-20T22:42:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzk2NzE5MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODAxMDIyMw==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1282#discussion_r528010223", "bodyText": "Also note that SqlEntityListener has @Order(0) on it, so it will be invoked before @Order(3) RedisEntityListener via the CompositeEntityListener", "author": "steven-sheehy", "createdAt": "2020-11-20T22:45:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzk2NzE5MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODAxNjAwNQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1282#discussion_r528016005", "bodyText": "my opinion is the transaction COMMIT happens after all messages are published to redis.\n2020-11-20 22:58:45,754 INFO  [scheduling-3] c.h.m.i.p.r.e.s.SqlEntityListener Inserted 4 entities in 32.72 ms\n2020-11-20 22:58:45,754 INFO  [scheduling-3] c.h.m.i.p.r.e.s.SqlEntityListener Completed batch inserts in 40.80 ms\n2020-11-20 22:58:45,778 INFO  [scheduling-3] c.h.m.i.p.r.e.r.RedisEntityListener Finished notifying 0 messages in 22.80 ms\n2020-11-20 22:58:45,781 DEBUG [scheduling-3] o.s.o.j.JpaTransactionManager Found thread-bound EntityManager [SessionImpl(2014749906<open>)] for JPA transaction\n2020-11-20 22:58:45,781 DEBUG [scheduling-3] o.s.o.j.JpaTransactionManager Participating in existing transaction\n2020-11-20 22:58:45,784 DEBUG [scheduling-3] o.s.o.j.JpaTransactionManager Found thread-bound EntityManager [SessionImpl(2014749906<open>)] for JPA transaction\n2020-11-20 22:58:45,784 DEBUG [scheduling-3] o.s.o.j.JpaTransactionManager Participating in existing transaction\nHibernate: \n    update\n        t_application_status \n    set\n        status_value=? \n    where\n        status_code=?\n2020-11-20 22:58:45,788 INFO  [scheduling-3] c.h.m.i.p.r.RecordFileParser Finished parsing 1 transactions from record file /var/lib/hedera-mirror-importer/recordstreams/valid/2019-10-11T13_35_39.807083001Z.rcd in 106ms (9/s). Success: true\n2020-11-20 22:58:45,788 DEBUG [scheduling-3] o.s.o.j.JpaTransactionManager Initiating transaction commit\n2020-11-20 22:58:45,789 DEBUG [scheduling-3] o.s.o.j.JpaTransactionManager Committing JPA transaction on EntityManager [SessionImpl(2014749906<open>)]\n2020-11-20 22:58:45,794 DEBUG [scheduling-3] o.s.o.j.JpaTransactionManager Closing JPA EntityManager [SessionImpl(2014749906<open>)] after transaction```", "author": "xin-hedera", "createdAt": "2020-11-20T23:03:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzk2NzE5MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODAxODg0OA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1282#discussion_r528018848", "bodyText": "True, I guess the commit doesn't occur until the outer wrapped @Transactional method completes.", "author": "steven-sheehy", "createdAt": "2020-11-20T23:13:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzk2NzE5MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzk3NzkxNg==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1282#discussion_r527977916", "bodyText": "This equals 250K TPS. Perhaps we should lower the limits a bit. Also, 5K might be a bit high for page size depending upon how large the messages are. At 6K message size a 5K poll would return 30MB+ of data. Perhaps we should keep max page size at 1000 and just increase polling frequency?", "author": "steven-sheehy", "createdAt": "2020-11-20T21:24:51Z", "path": "docs/configuration.md", "diffHunk": "@@ -174,9 +174,12 @@ value, it is recommended to only populate overridden properties in the custom `a\n | `hedera.mirror.grpc.port`                                   | 5600             | The GRPC API port                                                                              |\n | `hedera.mirror.grpc.retriever.enabled`                      | true             | Whether to retrieve historical massages or not                                                 |\n | `hedera.mirror.grpc.retriever.maxPageSize`                  | 1000             | The maximum number of messages the retriever can return in a single call to the database       |\n-| `hedera.mirror.grpc.retriever.pollingFrequency`             | 2s               | How often to polling for historical messages. Can accept duration units like `50ms`, `10s` etc |\n+| `hedera.mirror.grpc.retriever.pollingFrequency`             | 2s               | How often to poll for historical messages. Can accept duration units like `50ms`, `10s` etc    |\n | `hedera.mirror.grpc.retriever.threadMultiplier`             | 4                | Multiplied by the CPU count to calculate the number of retriever threads                       |\n | `hedera.mirror.grpc.retriever.timeout`                      | 60s              | How long to wait between emission of messages before returning an error                        |\n+| `hedera.mirror.grpc.retriever.unthrottledMaxPageSize`       | 5000             | The maximum number of messages the retriever can return in a single call to the database when unthrottled |", "originalCommit": "c573c3e5790b9aeca9c2ade50ae812f12ba150b7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzk5MTI1OQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1282#discussion_r527991259", "bodyText": "it depends on how fast the db is and how fast our whole flux pipeline is. 20ms is how long we wait after the previous flux sequence is drained, it will not get to 50 db queries per second when each or some of queries return a lot of data.\nThe numbers I saw were around 20k/s with importer ingesting at 10k tps.", "author": "xin-hedera", "createdAt": "2020-11-20T21:54:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzk3NzkxNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzk4MTYwNg==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1282#discussion_r527981606", "bodyText": "What happens when unthrottled max polls is reached but there are still messages? PollingTopicMessageRetriever will complete but will TopicMessageServiceImpl ever complete? Will it error? We should add a test if possible.", "author": "steven-sheehy", "createdAt": "2020-11-20T21:31:00Z", "path": "hedera-mirror-grpc/src/main/java/com/hedera/mirror/grpc/retriever/PollingTopicMessageRetriever.java", "diffHunk": "@@ -98,19 +98,45 @@ public PollingTopicMessageRetriever(RetrieverProperties retrieverProperties,\n     private class PollingContext {\n \n         private final TopicMessageFilter filter;\n+        private final boolean throttled;\n+        private final Duration frequency;\n+        private final int maxPageSize;\n+        private final long numRepeats;\n         private final AtomicLong pageSize = new AtomicLong(0L);\n         private final Stopwatch stopwatch = Stopwatch.createStarted();\n         private final AtomicLong total = new AtomicLong(0L);\n         private volatile TopicMessage last;\n \n+        public PollingContext(TopicMessageFilter filter, boolean throttled) {\n+            this.filter = filter;\n+            this.throttled = throttled;\n+\n+            if (throttled) {\n+                numRepeats = Long.MAX_VALUE;\n+                frequency = retrieverProperties.getPollingFrequency();\n+                maxPageSize = retrieverProperties.getMaxPageSize();\n+            } else {\n+                numRepeats = retrieverProperties.getUnthrottledMaxPolls();", "originalCommit": "c573c3e5790b9aeca9c2ade50ae812f12ba150b7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzk5MjUwMA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1282#discussion_r527992500", "bodyText": "TopicMessageServiceImpl will error with IllegalStateException \"Encountered out of order messages\". I'll add a test for this scenario.", "author": "xin-hedera", "createdAt": "2020-11-20T21:57:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzk4MTYwNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzk5NzA2OA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1282#discussion_r527997068", "bodyText": "I see, because we always have the current message which triggered the missing message flow and concat that, it should generate that error always. I think we do have a test for that already.", "author": "steven-sheehy", "createdAt": "2020-11-20T22:08:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzk4MTYwNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzk4MTkwNA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1282#discussion_r527981904", "bodyText": "Should the throttled have a lower value than Long.MAX_VALUE\nIt's likely in the unthrottled cases the value would be less than that, especially with a default of 12", "author": "Nana-EC", "createdAt": "2020-11-20T21:31:43Z", "path": "hedera-mirror-grpc/src/main/java/com/hedera/mirror/grpc/retriever/PollingTopicMessageRetriever.java", "diffHunk": "@@ -98,19 +98,45 @@ public PollingTopicMessageRetriever(RetrieverProperties retrieverProperties,\n     private class PollingContext {\n \n         private final TopicMessageFilter filter;\n+        private final boolean throttled;\n+        private final Duration frequency;\n+        private final int maxPageSize;\n+        private final long numRepeats;\n         private final AtomicLong pageSize = new AtomicLong(0L);\n         private final Stopwatch stopwatch = Stopwatch.createStarted();\n         private final AtomicLong total = new AtomicLong(0L);\n         private volatile TopicMessage last;\n \n+        public PollingContext(TopicMessageFilter filter, boolean throttled) {\n+            this.filter = filter;\n+            this.throttled = throttled;\n+\n+            if (throttled) {\n+                numRepeats = Long.MAX_VALUE;", "originalCommit": "c573c3e5790b9aeca9c2ade50ae812f12ba150b7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzk4OTI3NA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1282#discussion_r527989274", "bodyText": "when throttled, the repeats of Long.MAX_VALUE matches the old behavior.\nthe old behavior is, the retriever is used to obtain historical messages at a throttled speed, e.g., 500/s\n\nif there are enough historical messages in db, we should let it repeat forever\nif the polling ends up getting all historical messages in db, a query from the db would return less than max page size rows, the context.isComplete() will be true, and the whole repeat will stop & the flux completes, then in TopicMessageService, the flux moves on to incomingMessages", "author": "xin-hedera", "createdAt": "2020-11-20T21:49:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzk4MTkwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODAyMDA1MQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1282#discussion_r528020051", "bodyText": "Yep, I realize the old behavior had this. Just noting that in a throttled case you might expect it to be less than the unthrottled case. That's fine though", "author": "Nana-EC", "createdAt": "2020-11-20T23:17:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzk4MTkwNA=="}], "type": "inlineReview"}, {"oid": "9de0d30feda9ae5c76c1cfc822991dc722b0800b", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/9de0d30feda9ae5c76c1cfc822991dc722b0800b", "message": "group the properties for unthrottled mode and add DurationMin to unthrottled pollingFrequency\n\nSigned-off-by: Xin Li <xin.li@swirlds.com>", "committedDate": "2020-11-21T04:06:38Z", "type": "commit"}, {"oid": "67302f30f3e66fa97be63e48ccb095b7ddbf8015", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/67302f30f3e66fa97be63e48ccb095b7ddbf8015", "message": "update doc and test cases\n\nSigned-off-by: Xin Li <xin.li@swirlds.com>", "committedDate": "2020-11-22T21:43:19Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODc4MDQ2NQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1282#discussion_r528780465", "bodyText": "@NotNull", "author": "steven-sheehy", "createdAt": "2020-11-23T15:20:50Z", "path": "hedera-mirror-grpc/src/main/java/com/hedera/mirror/grpc/retriever/RetrieverProperties.java", "diffHunk": "@@ -45,4 +46,19 @@\n \n     @NotNull\n     private Duration timeout = Duration.ofSeconds(60L);\n+", "originalCommit": "67302f30f3e66fa97be63e48ccb095b7ddbf8015", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODc4MDk5NA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1282#discussion_r528780994", "bodyText": "@NotNull", "author": "steven-sheehy", "createdAt": "2020-11-23T15:21:33Z", "path": "hedera-mirror-grpc/src/main/java/com/hedera/mirror/grpc/retriever/RetrieverProperties.java", "diffHunk": "@@ -45,4 +46,19 @@\n \n     @NotNull\n     private Duration timeout = Duration.ofSeconds(60L);\n+\n+    private UnthrottledProperties unthrottled = new UnthrottledProperties();\n+\n+    @Data\n+    public static class UnthrottledProperties {\n+\n+        @Min(1000)\n+        private int maxPageSize = 5000;\n+\n+        @Min(4)\n+        private long maxPolls = 12;\n+\n+        @DurationMin(millis = 10)", "originalCommit": "67302f30f3e66fa97be63e48ccb095b7ddbf8015", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "13b4b71fe418c1d1c4173e63e98d3a41952df55f", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/13b4b71fe418c1d1c4173e63e98d3a41952df55f", "message": "Fix property validation\n\nSigned-off-by: Steven Sheehy <steven.sheehy@hedera.com>", "committedDate": "2020-11-23T18:53:35Z", "type": "commit"}]}