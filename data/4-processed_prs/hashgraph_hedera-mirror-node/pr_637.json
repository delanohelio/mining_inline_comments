{"pr_number": 637, "pr_title": "Kubernetes", "pr_createdAt": "2020-03-31T17:47:14Z", "pr_url": "https://github.com/hashgraph/hedera-mirror-node/pull/637", "timeline": [{"oid": "bcad1a91604cf64c0a7eea71edc105dea1fc7b4c", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/bcad1a91604cf64c0a7eea71edc105dea1fc7b4c", "message": "Add initial Helm chart with importer and GRPC\n\nSigned-off-by: Steven Sheehy <steven.sheehy@hedera.com>", "committedDate": "2020-03-31T00:39:18Z", "type": "commit"}, {"oid": "c5555890a0a5e70b304297e057f1e8066f95b305", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/c5555890a0a5e70b304297e057f1e8066f95b305", "message": "Add REST API to Helm chart\n\nSigned-off-by: Steven Sheehy <steven.sheehy@hedera.com>", "committedDate": "2020-03-31T00:39:19Z", "type": "commit"}, {"oid": "20b94c87ed21658cf56fa7fd86370b884c8b70d5", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/20b94c87ed21658cf56fa7fd86370b884c8b70d5", "message": "Fix prettier corrupting helm files\n\nSigned-off-by: Steven Sheehy <steven.sheehy@hedera.com>", "committedDate": "2020-03-31T00:39:19Z", "type": "commit"}, {"oid": "9af005f75b0d3c7085ce9601410d19b08ddbeac8", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/9af005f75b0d3c7085ce9601410d19b08ddbeac8", "message": "Add HA to importer\n\nSigned-off-by: Steven Sheehy <steven.sheehy@hedera.com>", "committedDate": "2020-03-31T00:39:19Z", "type": "commit"}, {"oid": "72e2c77a748ee97e2d66c5c0b47c6896343cc014", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/72e2c77a748ee97e2d66c5c0b47c6896343cc014", "message": "Add Prometheus\n\nSigned-off-by: Steven Sheehy <steven.sheehy@hedera.com>", "committedDate": "2020-03-31T00:39:20Z", "type": "commit"}, {"oid": "9914303efdafb9a86e3e60c179dd5b7edc612c9a", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/9914303efdafb9a86e3e60c179dd5b7edc612c9a", "message": "Add Prometheus Adapter\n\nSigned-off-by: Steven Sheehy <steven.sheehy@hedera.com>", "committedDate": "2020-03-31T00:39:20Z", "type": "commit"}, {"oid": "446a7b3ea41ebd70288407123e097ccf5a3b57da", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/446a7b3ea41ebd70288407123e097ccf5a3b57da", "message": "Add Horizontal Pod Autoscaling to GRPC and REST\n\nSigned-off-by: Steven Sheehy <steven.sheehy@hedera.com>", "committedDate": "2020-03-31T00:39:20Z", "type": "commit"}, {"oid": "2dd13662043e538d360ac2820d2499408097483a", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/2dd13662043e538d360ac2820d2499408097483a", "message": "Add centralized logging via Loki\n\nSigned-off-by: Steven Sheehy <steven.sheehy@hedera.com>", "committedDate": "2020-03-31T00:39:20Z", "type": "commit"}, {"oid": "fe7ecc6155b65ecbf41e2e358a627bc5ce5f1f2c", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/fe7ecc6155b65ecbf41e2e358a627bc5ce5f1f2c", "message": "Add ability to refresh properties from configmap\n\nSigned-off-by: Steven Sheehy <steven.sheehy@hedera.com>", "committedDate": "2020-03-31T00:39:20Z", "type": "commit"}, {"oid": "b0d8662b441a156425d3830859dc735b6e2e0257", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/b0d8662b441a156425d3830859dc735b6e2e0257", "message": "Return proper response/code for REST when db is down\n\nSigned-off-by: Steven Sheehy <steven.sheehy@hedera.com>", "committedDate": "2020-03-31T00:48:58Z", "type": "commit"}, {"oid": "f6534281253c997968d6a4278a4cc0049ab9cd79", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/f6534281253c997968d6a4278a4cc0049ab9cd79", "message": "Fix busy retry in shared poller\n\nSigned-off-by: Steven Sheehy <steven.sheehy@hedera.com>", "committedDate": "2020-03-31T00:49:04Z", "type": "commit"}, {"oid": "5c173755fb6caedbb03cd3c7eabc8dd47b94a4ec", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/5c173755fb6caedbb03cd3c7eabc8dd47b94a4ec", "message": "Switch to postgresql-ha chart\n\nSigned-off-by: Steven Sheehy <steven.sheehy@hedera.com>", "committedDate": "2020-03-31T03:24:43Z", "type": "commit"}, {"oid": "985a57f6fee2f1d7f1e471a6fc4c94f78e0c0cfa", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/985a57f6fee2f1d7f1e471a6fc4c94f78e0c0cfa", "message": "Fix scaling down deployments on upgrade\n\nSigned-off-by: Steven Sheehy <steven.sheehy@hedera.com>", "committedDate": "2020-03-31T17:32:41Z", "type": "commit"}, {"oid": "3d2273ad7fbc6f02bead01432f8991ba4f18323f", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/3d2273ad7fbc6f02bead01432f8991ba4f18323f", "message": "Disable AlertManager for now\n\nSigned-off-by: Steven Sheehy <steven.sheehy@hedera.com>", "committedDate": "2020-03-31T17:46:14Z", "type": "commit"}, {"oid": "6f89c9d0f1edc18da1afc60d0808a9c51b78b2bb", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/6f89c9d0f1edc18da1afc60d0808a9c51b78b2bb", "message": "Merge remote-tracking branch 'origin/master' into kubernetes\n\nSigned-off-by: Steven Sheehy <steven.sheehy@hedera.com>", "committedDate": "2020-03-31T21:45:24Z", "type": "commit"}, {"oid": "46f9cb510d7d4f113092bfbcda67f3497a3d62c9", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/46f9cb510d7d4f113092bfbcda67f3497a3d62c9", "message": "Add dependent chart artifacts\n\nSigned-off-by: Steven Sheehy <steven.sheehy@hedera.com>", "committedDate": "2020-04-01T04:23:54Z", "type": "commit"}, {"oid": "46f9cb510d7d4f113092bfbcda67f3497a3d62c9", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/46f9cb510d7d4f113092bfbcda67f3497a3d62c9", "message": "Add dependent chart artifacts\n\nSigned-off-by: Steven Sheehy <steven.sheehy@hedera.com>", "committedDate": "2020-04-01T04:23:54Z", "type": "forcePushed"}, {"oid": "4c1cce8e1ba69dff56b3a7cbc5bb2e29e05805ba", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/4c1cce8e1ba69dff56b3a7cbc5bb2e29e05805ba", "message": "Fix tests\n\nSigned-off-by: Steven Sheehy <steven.sheehy@hedera.com>", "committedDate": "2020-04-01T04:48:21Z", "type": "forcePushed"}, {"oid": "52ef9d0735684611c8aad62f7625a5576f759fe1", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/52ef9d0735684611c8aad62f7625a5576f759fe1", "message": "Fix tests\n\nSigned-off-by: Steven Sheehy <steven.sheehy@hedera.com>", "committedDate": "2020-04-01T04:52:13Z", "type": "forcePushed"}, {"oid": "3a9b53bde87a9836e2c62068383d6c6eb83afab0", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/3a9b53bde87a9836e2c62068383d6c6eb83afab0", "message": "Fix tests\n\nSigned-off-by: Steven Sheehy <steven.sheehy@hedera.com>", "committedDate": "2020-04-01T04:55:24Z", "type": "commit"}, {"oid": "3a9b53bde87a9836e2c62068383d6c6eb83afab0", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/3a9b53bde87a9836e2c62068383d6c6eb83afab0", "message": "Fix tests\n\nSigned-off-by: Steven Sheehy <steven.sheehy@hedera.com>", "committedDate": "2020-04-01T04:55:24Z", "type": "forcePushed"}, {"oid": "40490d48ed4210450ac93848958711806c42ad09", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/40490d48ed4210450ac93848958711806c42ad09", "message": "Bump version to 0.8.1\n\nSigned-off-by: Steven Sheehy <steven.sheehy@hedera.com>", "committedDate": "2020-04-01T20:56:40Z", "type": "commit"}, {"oid": "f12766af499366c252b00bab86cf996817615c29", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/f12766af499366c252b00bab86cf996817615c29", "message": "Merge remote-tracking branch 'origin/master' into kubernetes", "committedDate": "2020-04-01T20:56:52Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk2NjAxMA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/637#discussion_r401966010", "bodyText": "nit: The above command.\nI read \"This command\" as referring to the command below", "author": "Nana-EC", "createdAt": "2020-04-01T23:21:45Z", "path": "charts/README.md", "diffHunk": "@@ -0,0 +1,34 @@\n+# Helm Chart\n+\n+Installs the Hedera Mirror Node Helm wrapper chart. This chart will install the three mirror node components:\n+\n+- [Hedera Mirror Importer](hedera-mirror-importer)\n+- [Hedera Mirror GRPC API](hedera-mirror-importer)\n+- [Hedera Mirror REST API](hedera-mirror-importer)\n+\n+## Requirements\n+\n+- [Helm 3](https://helm.sh)\n+- [Kubernetes 1.17+](https://kubernetes.io)\n+\n+## Install\n+\n+To install the wrapper chart with a release name of `mirror`:\n+\n+```shell script\n+$ helm upgrade --install mirror charts/hedera-mirror\n+```\n+\n+## Uninstall\n+\n+To remove all the Kubernetes components associated with the chart and delete the release:\n+\n+```shell script\n+$ helm delete mirror\n+```\n+\n+This command does not delete any of the underlying persistent volumes. To delete all the data associated with this release:", "originalCommit": "f12766af499366c252b00bab86cf996817615c29", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk2NjQ5Ng==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/637#discussion_r401966496", "bodyText": "q: Did you want to add a diagnostics section or add to the current diagnostics section the kubectl comments for viewing service status and basic logs", "author": "Nana-EC", "createdAt": "2020-04-01T23:23:16Z", "path": "charts/README.md", "diffHunk": "@@ -0,0 +1,34 @@\n+# Helm Chart\n+\n+Installs the Hedera Mirror Node Helm wrapper chart. This chart will install the three mirror node components:\n+\n+- [Hedera Mirror Importer](hedera-mirror-importer)\n+- [Hedera Mirror GRPC API](hedera-mirror-importer)\n+- [Hedera Mirror REST API](hedera-mirror-importer)\n+\n+## Requirements\n+\n+- [Helm 3](https://helm.sh)\n+- [Kubernetes 1.17+](https://kubernetes.io)\n+\n+## Install\n+\n+To install the wrapper chart with a release name of `mirror`:\n+\n+```shell script\n+$ helm upgrade --install mirror charts/hedera-mirror\n+```\n+\n+## Uninstall\n+\n+To remove all the Kubernetes components associated with the chart and delete the release:\n+\n+```shell script\n+$ helm delete mirror\n+```\n+\n+This command does not delete any of the underlying persistent volumes. To delete all the data associated with this release:\n+\n+```shell script\n+$ kubectl delete $(kubectl get pvc -o name)\n+```", "originalCommit": "f12766af499366c252b00bab86cf996817615c29", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjQ1NDk1Nw==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/637#discussion_r402454957", "bodyText": "Was going to add more docs in follow up as mentioned in description, but ok. Added", "author": "steven-sheehy", "createdAt": "2020-04-02T16:40:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk2NjQ5Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk2OTI2OA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/637#discussion_r401969268", "bodyText": "q: is there somewhere this is specified once and centrally so places like this can call them and not have string hard coded?", "author": "Nana-EC", "createdAt": "2020-04-01T23:32:00Z", "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/parser/record/PostgresWritingRecordParsedItemHandler.java", "diffHunk": "@@ -101,7 +101,7 @@ private void initConnectionAndStatements() throws ParserSQLException {\n         try {\n             connection = dataSource.getConnection();\n             connection.setAutoCommit(false); // do not auto-commit\n-            connection.setClientInfo(\"ApplicationName\", getClass().getCanonicalName());\n+            connection.setClientInfo(\"ApplicationName\", \"hedera-mirror-importer\");", "originalCommit": "f12766af499366c252b00bab86cf996817615c29", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjQ1NDU3NQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/637#discussion_r402454575", "bodyText": "I could inject it using @Value(\"${spring.application.name}\"), but don't think it's worth the effort. I reverted to using the class name but without the package.", "author": "steven-sheehy", "createdAt": "2020-04-02T16:40:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk2OTI2OA=="}], "type": "inlineReview"}, {"oid": "06d0456e80c1f5d1d242f219acb6bb3e8c485f6b", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/06d0456e80c1f5d1d242f219acb6bb3e8c485f6b", "message": "Bump Flyway connectRetries to avoid crashing importer on initial start\n\nSigned-off-by: Steven Sheehy <steven.sheehy@hedera.com>", "committedDate": "2020-04-02T16:13:07Z", "type": "commit"}, {"oid": "204ca5f7f71469c7012baf4e898e5cbbab768046", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/204ca5f7f71469c7012baf4e898e5cbbab768046", "message": "Review feedback\n\nSigned-off-by: Steven Sheehy <steven.sheehy@hedera.com>", "committedDate": "2020-04-02T16:39:16Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzQ0MTc4Mw==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/637#discussion_r403441783", "bodyText": "links need fixing.", "author": "apeksharma", "createdAt": "2020-04-04T08:15:39Z", "path": "charts/README.md", "diffHunk": "@@ -0,0 +1,65 @@\n+# Helm Chart\n+\n+Installs the Hedera Mirror Node Helm wrapper chart. This chart will install the three mirror node components:\n+\n+- [Hedera Mirror Importer](hedera-mirror-importer)\n+- [Hedera Mirror GRPC API](hedera-mirror-importer)", "originalCommit": "204ca5f7f71469c7012baf4e898e5cbbab768046", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDIwODg1Mw==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/637#discussion_r404208853", "bodyText": "All these links work for me. They're relative links. Try it here.", "author": "steven-sheehy", "createdAt": "2020-04-06T16:04:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzQ0MTc4Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDMxOTEzNg==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/637#discussion_r404319136", "bodyText": "all point to importer", "author": "apeksharma", "createdAt": "2020-04-06T18:59:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzQ0MTc4Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDM0MjgwMg==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/637#discussion_r404342802", "bodyText": "Ah, missed the obvious.", "author": "steven-sheehy", "createdAt": "2020-04-06T19:42:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzQ0MTc4Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzQ0MjI1OQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/637#discussion_r403442259", "bodyText": "We should consistently use either \"Hedera\" or \"Hedera Hashgraph\".\nWe use \"Hedera Mirror Node\" everywhere else including project's readme, so would prefer that.\nSame in Chart.yaml for rest api.", "author": "apeksharma", "createdAt": "2020-04-04T08:21:14Z", "path": "charts/hedera-mirror-grpc/Chart.yaml", "diffHunk": "@@ -0,0 +1,9 @@\n+apiVersion: v1\n+appVersion: 0.8.1\n+description: GRPC API for Hedera Hashgraph Mirror Nodes", "originalCommit": "204ca5f7f71469c7012baf4e898e5cbbab768046", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDIwOTYyOA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/637#discussion_r404209628", "bodyText": "I straight copied these lines from the pom.xml's. Do you want me to update those as well?", "author": "steven-sheehy", "createdAt": "2020-04-06T16:05:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzQ0MjI1OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDMxOTU5MA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/637#discussion_r404319590", "bodyText": "that'd be good :)", "author": "apeksharma", "createdAt": "2020-04-06T19:00:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzQ0MjI1OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzQ0MzQ3Ng==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/637#discussion_r403443476", "bodyText": "Earlier, prod logs were in /opt/restapi/logs, what command will i need to see the logs now?\nLet's update docs too.", "author": "apeksharma", "createdAt": "2020-04-04T08:35:53Z", "path": "hedera-mirror-rest/server.js", "diffHunk": "@@ -58,8 +58,7 @@ if (port === undefined || isNaN(Number(port))) {\n log4js.configure({\n   appenders: {\n     everything: {\n-      type: 'file',\n-      filename: '../logs/hedera_mirrornode_api_' + port + '.log' // ensure port is a legit number above\n+      type: 'stdout'", "originalCommit": "204ca5f7f71469c7012baf4e898e5cbbab768046", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDIxMDI2Ng==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/637#discussion_r404210266", "bodyText": "Good point, will update docs. Command will be pm2 logs <port>", "author": "steven-sheehy", "createdAt": "2020-04-06T16:06:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzQ0MzQ3Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzg0Nzk4OQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/637#discussion_r403847989", "bodyText": "Please add extra lines for improving readability here. For eg. https://github.com/helm/charts/blob/master/stable/chartmuseum/templates/NOTES.txt\nSimilarly for other NOTES.txt.", "author": "apeksharma", "createdAt": "2020-04-06T06:07:00Z", "path": "charts/hedera-mirror-grpc/templates/NOTES.txt", "diffHunk": "@@ -0,0 +1,13 @@\n+Get the GRPC service endpoint by running these commands:", "originalCommit": "204ca5f7f71469c7012baf4e898e5cbbab768046", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDIxMTA3Nw==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/637#discussion_r404211077", "bodyText": "This was the default output generated by helm create. Will add lines.", "author": "steven-sheehy", "createdAt": "2020-04-06T16:07:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzg0Nzk4OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzg3NDEzOA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/637#discussion_r403874138", "bodyText": "please add a comment here why importer is headless service", "author": "apeksharma", "createdAt": "2020-04-06T07:14:38Z", "path": "charts/hedera-mirror-importer/templates/service-headless.yaml", "diffHunk": "@@ -0,0 +1,13 @@\n+apiVersion: v1", "originalCommit": "204ca5f7f71469c7012baf4e898e5cbbab768046", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzg3NTkwOQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/637#discussion_r403875909", "bodyText": "nice.\nIs auto-scaling configurable on user params too? Say we find that grpc or rest is network bound rather than cpu, can it use a user metrics (say exposed on a port) to auto scale. Just curious.", "author": "apeksharma", "createdAt": "2020-04-06T07:18:26Z", "path": "charts/hedera-mirror-grpc/values.yaml", "diffHunk": "@@ -0,0 +1,104 @@\n+affinity:\n+  podAntiAffinity:\n+    preferredDuringSchedulingIgnoredDuringExecution:\n+      - weight: 100\n+        podAffinityTerm:\n+          topologyKey: kubernetes.io/hostname\n+          labelSelector:\n+            matchLabels:\n+              app.kubernetes.io/name: grpc\n+\n+annotations: {}\n+\n+config: {}\n+\n+fullnameOverride: \"\"\n+\n+global:\n+  namespaceOverride: \"\"\n+\n+hpa:", "originalCommit": "204ca5f7f71469c7012baf4e898e5cbbab768046", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDIxMjg5Mw==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/637#discussion_r404212893", "bodyText": "It can be configurable on any metric that we can collect. And in fact can be based upon multiple metrics, so we could keep cpu and add network metric, in your example.", "author": "steven-sheehy", "createdAt": "2020-04-06T16:09:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzg3NTkwOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzg4MjgwNA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/637#discussion_r403882804", "bodyText": "Should the name be hedera-mirror-grpc.serviceAccountName?\nIf service account is never used without rbac.enabled, we should be able to remove the serviceAccount.create?\nBoth true or false case be covered by single flag.\nrbac.enabled=false and serviceAccount.create=true seems not useful\nrbac.enabled=true and serviceAccount.create=false can lead to failure if new name is specified.\nRight now the 2x2x2 cases arising from rbac.enabled = {true,false}, serviceAccount.create={true,false}, and serviceAccount.name = {set/not set},\nand 2x2 case to just determine final value for serviceAccount.name .....seems more complex than needed.", "author": "apeksharma", "createdAt": "2020-04-06T07:32:07Z", "path": "charts/hedera-mirror-grpc/templates/rolebinding.yaml", "diffHunk": "@@ -0,0 +1,16 @@\n+{{- if .Values.rbac.enabled -}}\n+apiVersion: rbac.authorization.k8s.io/v1\n+kind: RoleBinding\n+metadata:\n+  labels:\n+    {{- include \"hedera-mirror-grpc.labels\" . | nindent 4 }}\n+  name: {{ include \"hedera-mirror-grpc.fullname\" . }}\n+  namespace: {{ include \"hedera-mirror-grpc.namespace\" . }}\n+roleRef:\n+  apiGroup: rbac.authorization.k8s.io\n+  kind: Role\n+  name: {{ include \"hedera-mirror-grpc.fullname\" . }}\n+subjects:\n+- kind: ServiceAccount", "originalCommit": "204ca5f7f71469c7012baf4e898e5cbbab768046", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDIzMTk1NQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/637#discussion_r404231955", "bodyText": "You're right, it should use hedera-mirror-grpc.serviceAccountName. Will address.\nYou can still use service accounts without rbac. If you don't supply a service account the pod will implicitly use the default service account. Some people may want to override the service account we create and supply their own. Also, the rbac.enabled and serviceAccount.create is the default generated by helm create and used by nearly every public chart. I think we should keep it as is unless you feel strongly.", "author": "steven-sheehy", "createdAt": "2020-04-06T16:37:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzg4MjgwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDMyMDU4Ng==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/637#discussion_r404320586", "bodyText": "i see. Thanks for the explanation.", "author": "apeksharma", "createdAt": "2020-04-06T19:02:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzg4MjgwNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzkwMzI1Mg==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/637#discussion_r403903252", "bodyText": "We should flag protect postgres' resource creation since they won't be initialized in prod and we are not going to migrate off cloud sql anytime soon. The flag itself can be true by default to have single command deployment (for anyone playing with mirror node).", "author": "apeksharma", "createdAt": "2020-04-06T08:10:00Z", "path": "charts/hedera-mirror/templates/configmap.yaml", "diffHunk": "@@ -0,0 +1,24 @@\n+# This file is temporarily a ConfigMap until I can make changes with the upstream chart", "originalCommit": "204ca5f7f71469c7012baf4e898e5cbbab768046", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDIxODgyMQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/637#discussion_r404218821", "bodyText": "Postgres already has a enabled flag postgresql.enabled defaulted to true and having an extra configmap doesn't hurt anything. But good point, can add around this file.", "author": "steven-sheehy", "createdAt": "2020-04-06T16:18:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzkwMzI1Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDMyMjIyMw==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/637#discussion_r404322223", "bodyText": "Missed that flag. All good.\nI don't mind extra configmaps as long as pods are not deployed when postgres is disabled.", "author": "apeksharma", "createdAt": "2020-04-06T19:05:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzkwMzI1Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzkwOTc3OQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/637#discussion_r403909779", "bodyText": "why do we need to checkin tgz files?\nDidn't see them checked-in in couple projects i saw.", "author": "apeksharma", "createdAt": "2020-04-06T08:21:13Z", "path": "charts/hedera-mirror/requirements.lock", "diffHunk": "@@ -0,0 +1,24 @@\n+dependencies:", "originalCommit": "204ca5f7f71469c7012baf4e898e5cbbab768046", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDIxNjQ1Mw==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/637#discussion_r404216453", "bodyText": "It's debatable, just like checking in go modules. Not checking them in means you have external dependencies that you have to download during CI or CD that could fail the build/deploy. If that repo ever goes away or is down or that version is pruned we wouldn't be able to deploy.\nAlso, we may or may not be packaging these charts and creating a HTTP chart repository and instead retrieving them directly from git. If so, every deployment would have to resolve the dependencies.", "author": "steven-sheehy", "createdAt": "2020-04-06T16:14:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzkwOTc3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDMyNjk5Mw==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/637#discussion_r404326993", "bodyText": "Fair enough reason to keep them. Please add it to README (or requirements.yaml. Some please where explorative souls can find it)\nI just believe in commenting the hack out of anything non-obvious, or debatable, or out of ordinary. :D\nIn this case, if it falls in debatable category, would appreciate if we add one.", "author": "apeksharma", "createdAt": "2020-04-06T19:13:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzkwOTc3OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDMyODY2MQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/637#discussion_r404328661", "bodyText": "Does it make sense since there is only one instance? If yes, please add a comment to the file too.", "author": "apeksharma", "createdAt": "2020-04-06T19:16:46Z", "path": "charts/hedera-mirror-importer/values.yaml", "diffHunk": "@@ -0,0 +1,111 @@\n+affinity:\n+  podAntiAffinity:\n+    preferredDuringSchedulingIgnoredDuringExecution:\n+      - weight: 100\n+        podAffinityTerm:\n+          topologyKey: kubernetes.io/hostname\n+          labelSelector:\n+            matchLabels:\n+              app.kubernetes.io/name: importer\n+\n+annotations: {}\n+\n+config:\n+  hedera:\n+    mirror:\n+      dataPath: /var/lib/hedera-mirror-importer\n+\n+fullnameOverride: \"\"\n+\n+global:\n+  namespaceOverride: \"\"\n+\n+image:\n+  pullPolicy: IfNotPresent\n+  repository: gcr.io/mirrornode/hedera-mirror-importer\n+  tag: 0.8.1\n+\n+imagePullSecrets: []\n+\n+labels:\n+  role: app\n+\n+livenessProbe:\n+  httpGet:\n+    path: /actuator/health\n+    port: http\n+  initialDelaySeconds: 60\n+  periodSeconds: 30\n+  timeoutSeconds: 2\n+\n+nameOverride: \"\"\n+\n+networkPolicy:\n+  enabled: false\n+\n+nodeSelector: {}\n+\n+persistence:\n+  accessModes:\n+    - ReadWriteOnce\n+  annotations: {}\n+  enabled: true\n+  size: 10Gi\n+  storageClass: standard\n+\n+podManagementPolicy: OrderedReady\n+\n+podSecurityContext:\n+  fsGroup: 1000\n+\n+priorityClassName: \"\"\n+\n+rbac:\n+  enabled: true\n+\n+readinessProbe:\n+  httpGet:\n+    path: /actuator/health\n+    port: http\n+  initialDelaySeconds: 60\n+  timeoutSeconds: 2\n+\n+replicas: 1\n+\n+resources:\n+  limits:\n+    cpu: 500m\n+    memory: 750Mi\n+  requests:\n+    cpu: 200m\n+    memory: 256Mi\n+\n+revisionHistoryLimit: 3\n+\n+securityContext:\n+  capabilities:\n+    drop: [ALL]\n+  readOnlyRootFilesystem: true\n+  runAsGroup: 1000\n+  runAsNonRoot: true\n+  runAsUser: 1000\n+\n+service:\n+  port: 8080\n+  type: ClusterIP\n+\n+serviceAccount:\n+  create: true\n+  # The name of the service account to use. If not set and create is true, a name is generated using the fullname template\n+  name:\n+\n+serviceMonitor:\n+  enabled: true\n+  interval: 30s\n+\n+terminationGracePeriodSeconds: 30\n+\n+tolerations: []\n+\n+updateStrategy:", "originalCommit": "204ca5f7f71469c7012baf4e898e5cbbab768046", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDM0MTc5MQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/637#discussion_r404341791", "bodyText": "Update strategy still applies to a single instance. For example, you can supply a surge to temporarily bring replicas to 2, wait for it go ready then delete old pod. Also, in prod we will have replicas=2 for redundancy.", "author": "steven-sheehy", "createdAt": "2020-04-06T19:40:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDMyODY2MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDMzMTI5Mw==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/637#discussion_r404331293", "bodyText": "beta version made me nervous. But seems like it has been in beta since 1.15 and the requirements to graduate are some extra testing and additional features. So i guess it's okay.", "author": "apeksharma", "createdAt": "2020-04-06T19:21:31Z", "path": "charts/hedera-mirror-importer/templates/pdb.yaml", "diffHunk": "@@ -0,0 +1,12 @@\n+apiVersion: policy/v1beta1", "originalCommit": "204ca5f7f71469c7012baf4e898e5cbbab768046", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQzNDgxMA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/637#discussion_r404434810", "bodyText": "Yes, feature graduation is a very well defined and rigorous process in Kubernetes.", "author": "steven-sheehy", "createdAt": "2020-04-06T22:50:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDMzMTI5Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDMzNzE4Mw==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/637#discussion_r404337183", "bodyText": "Please add class comment.\nIf there's a default example/source from where the code was forked, it'd be good to add that too. Just makes reviewing (or understanding code in general for anyone in future), lot easier.", "author": "apeksharma", "createdAt": "2020-04-06T19:32:26Z", "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/leader/LeaderAspect.java", "diffHunk": "@@ -0,0 +1,68 @@\n+package com.hedera.mirror.importer.leader;\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+\n+import lombok.extern.log4j.Log4j2;\n+import org.aspectj.lang.ProceedingJoinPoint;\n+import org.aspectj.lang.annotation.Around;\n+import org.aspectj.lang.annotation.Aspect;\n+import org.springframework.context.event.EventListener;\n+import org.springframework.core.annotation.Order;\n+import org.springframework.integration.leader.event.OnGrantedEvent;\n+import org.springframework.integration.leader.event.OnRevokedEvent;\n+\n+@Aspect\n+@Log4j2\n+@Order(1)\n+public class LeaderAspect {", "originalCommit": "204ca5f7f71469c7012baf4e898e5cbbab768046", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDMzOTc0Mg==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/637#discussion_r404339742", "bodyText": "Will add a javadoc. It's not forked, I wrote it. I used something similar at my last job, but can't link to that ;)", "author": "steven-sheehy", "createdAt": "2020-04-06T19:36:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDMzNzE4Mw=="}], "type": "inlineReview"}]}