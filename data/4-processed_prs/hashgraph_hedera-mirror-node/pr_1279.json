{"pr_number": 1279, "pr_title": "Enable log alerts and normalize log statements", "pr_createdAt": "2020-11-18T00:09:01Z", "pr_url": "https://github.com/hashgraph/hedera-mirror-node/pull/1279", "timeline": [{"oid": "43c5188707241816d8c88a6dea0b96c2858b2a36", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/43c5188707241816d8c88a6dea0b96c2858b2a36", "message": "Enable log alerts and normalize log statements\n\nSigned-off-by: Steven Sheehy <steven.sheehy@hedera.com>", "committedDate": "2020-11-18T00:08:43Z", "type": "commit"}, {"oid": "ef11a6ccf6800cf42858d43e3bee0306f495d943", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/ef11a6ccf6800cf42858d43e3bee0306f495d943", "message": "Minor tweaks\n\nSigned-off-by: Steven Sheehy <steven.sheehy@hedera.com>", "committedDate": "2020-11-18T20:20:51Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjM1MTE2Nw==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1279#discussion_r526351167", "bodyText": "should this port be configureable on it's own and easy to reference by others sections of the code or is okay to have it hard coded here?", "author": "Nana-EC", "createdAt": "2020-11-18T19:10:09Z", "path": "charts/hedera-mirror-common/values.yaml", "diffHunk": "@@ -9,13 +9,111 @@ loki:\n   enabled: true\n   loki:\n     config:\n+      ruler:\n+        alertmanager_url: http://{{ .Release.Name }}-prometheus-alertmanager:9093", "originalCommit": "43c5188707241816d8c88a6dea0b96c2858b2a36", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjQ3MDU2MQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1279#discussion_r526470561", "bodyText": "It's the default port within the alertmanager chart. It does have a value within that chart but child values are not available within parent charts. So I'd have to redefine it here and then reference that redefinition.\nTechnically the prometheus-alertmanager part is also customizable. At some point you can't account for every customization and have to assume defaults. Didn't think it's worth the effort.", "author": "steven-sheehy", "createdAt": "2020-11-18T22:38:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjM1MTE2Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjU3MDI2NQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1279#discussion_r526570265", "bodyText": "That's fine", "author": "Nana-EC", "createdAt": "2020-11-19T03:26:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjM1MTE2Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjM1Njc1OA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1279#discussion_r526356758", "bodyText": "String matching on logs seems brittle, as it can change between versions and there's no check to ensure this would be updated.\nIs it possible to apply an exception type filter here instead or in addition to some of these?\nWe might need to update some of the code in that case.", "author": "Nana-EC", "createdAt": "2020-11-18T19:19:23Z", "path": "charts/hedera-mirror-common/values.yaml", "diffHunk": "@@ -9,13 +9,111 @@ loki:\n   enabled: true\n   loki:\n     config:\n+      ruler:\n+        alertmanager_url: http://{{ .Release.Name }}-prometheus-alertmanager:9093\n+        enable_alertmanager_v2: true\n+        enable_api: true\n+        ring:\n+          kvstore:\n+            store: inmemory\n+        rule_path: /tmp/loki\n+        storage:\n+          type: local\n+          local:\n+            directory: /loki/rules\n       table_manager:\n         retention_deletes_enabled: true\n         retention_period: 2184h\n+    extraVolumeMounts:\n+      - name: rules\n+        mountPath: /loki/rules/fake\n+      - name: tmp\n+        mountPath: /tmp/loki\n+    extraVolumes:\n+      - name: rules\n+        configMap:\n+          defaultMode: 420\n+          name: loki-rules\n+      - name: tmp\n+        emptyDir: {}\n     networkPolicy:\n       enabled: true\n     persistence:\n       enabled: true\n+      size: 100Gi\n+    prometheusRules:\n+      # TODO: Enhance Loki to support watching for PrometheusRules via the Kubernetes API so we can declare these within their chart\n+      GrpcLogErrors:\n+        annotations:\n+          description: \"Logs for {{ $labels.namespace }}/{{ $labels.pod }} have reached {{ $value }} error messages/s in a 3m period\"\n+          summary: High rate of errors in logs\n+        enabled: true\n+        expr: >\n+          sum(rate({app_kubernetes_io_component=\"grpc\"}\n+            | regexp `(?P<timestamp>\\S+) (?P<level>\\S+) (?P<thread>\\S+) (?P<class>\\S+) (?P<message>.+)`\n+            | level = \"ERROR\"\n+            != \"reactor.core.publisher\"", "originalCommit": "43c5188707241816d8c88a6dea0b96c2858b2a36", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjQ2NTgxNw==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1279#discussion_r526465817", "bodyText": "See the note in the description:\n\nNote that the log alerts can probably be cleaned up quite a bit but I chose to keep them mostly the same with what we have for now\n\nI didn't create these alerts, they are existing and are what we notify off of in production. I'm not even sure how most of these ended up here as they're not logs that we explicitly print. So the argument of brittleness is still there with the existing approach but at least now they'll be checked in with the source code and versioned.\n\nIs it possible to apply an exception type filter here instead or in addition to some of these?\n\nI'm not sure what you mean. These are error level logs so they're usually the result of an exception already. I could add an |= \"Exception\" if that's what you're saying but that might miss logs that are error level and not exceptions. Again, it's not my alert so I'm not sure what scenarios this is covering so I just copied it.\nI think one of the problems with the existing alerts is that it didn't parse out the log level and java stacktraces are multi-line. So stacktraces might count multiple times towards the log metric for what is actually the same log statement. Hence why some of these strings might not be needed anymore since they might've been an element within the stacktrace.", "author": "steven-sheehy", "createdAt": "2020-11-18T22:28:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjM1Njc1OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjU3MDYwNg==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1279#discussion_r526570606", "bodyText": "Understood.\nLooks like we can do some more customization as needed in the future.", "author": "Nana-EC", "createdAt": "2020-11-19T03:27:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjM1Njc1OA=="}], "type": "inlineReview"}, {"oid": "d29c78a59de7936a5af86c2574a5f8add88e54a8", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/d29c78a59de7936a5af86c2574a5f8add88e54a8", "message": "Merge remote-tracking branch 'origin/master' into log-alerts\n\nSigned-off-by: Steven Sheehy <steven.sheehy@hedera.com>", "committedDate": "2020-11-19T21:53:37Z", "type": "commit"}]}