{"pr_number": 615, "pr_title": "Support REST API retrieval of topic message by topic id and sequence", "pr_createdAt": "2020-03-22T03:08:40Z", "pr_url": "https://github.com/hashgraph/hedera-mirror-node/pull/615", "timeline": [{"oid": "6d1cddb55ba69af4ff602b3f760a8955a5b62df0", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/6d1cddb55ba69af4ff602b3f760a8955a5b62df0", "message": "Initial changes for rest api to suppost topic message retrieval by topic and seqnum\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2020-03-22T03:00:07Z", "type": "commit"}, {"oid": "6dd65c9bff284e7bddc050f9565c78a766720c39", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/6dd65c9bff284e7bddc050f9565c78a766720c39", "message": "Merge w master to get PR 613 changes\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2020-03-23T17:21:02Z", "type": "commit"}, {"oid": "325fed88efc3cc3899ea160f965d133833ce5750", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/325fed88efc3cc3899ea160f965d133833ce5750", "message": "Cleaned up merge code and response format. Also added spec tests\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2020-03-23T22:22:02Z", "type": "commit"}, {"oid": "2604652ce0ecefde49a25fb24248ce146952cb73", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/2604652ce0ecefde49a25fb24248ce146952cb73", "message": "Added topic message tests and corrected transaction-id error message\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2020-03-23T22:49:43Z", "type": "commit"}, {"oid": "b04275014a11641795839c6abbfa4f0ee42bc3b5", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/b04275014a11641795839c6abbfa4f0ee42bc3b5", "message": "Remove next link logic\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2020-03-24T14:48:46Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzI5MTAwMQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/615#discussion_r397291001", "bodyText": "This error response is different than normal in that it doesn't contain \"_status\". Is this waiting on the other PR to be merged before addressing?", "author": "steven-sheehy", "createdAt": "2020-03-24T16:29:02Z", "path": "hedera-mirror-rest/__tests__/specs/topicmessage-06-idseq-invalid-path.spec.json", "diffHunk": "@@ -0,0 +1,22 @@\n+{\n+  \"description\": \"Topic messages for single message with invalid param values\",\n+  \"setup\": {\n+    \"accounts\": [],\n+    \"balances\": [],\n+    \"transactions\": [],\n+    \"cryptotransfers\": [],\n+    \"topicmessages\": []\n+  },\n+  \"url\": \"/api/v1/topic/0.0.-3/message/a\",\n+  \"responseStatus\": 400,\n+  \"responseJson\": {\n+    \"messages\": [", "originalCommit": "b04275014a11641795839c6abbfa4f0ee42bc3b5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzQwOTY4Nw==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/615#discussion_r397409687", "bodyText": "Yes", "author": "Nana-EC", "createdAt": "2020-03-24T19:32:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzI5MTAwMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzMwNDcwMQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/615#discussion_r397304701", "bodyText": "Would be better to not hardcode the error output and compare with the util method output", "author": "steven-sheehy", "createdAt": "2020-03-24T16:46:58Z", "path": "hedera-mirror-rest/__tests__/topicmessage.test.js", "diffHunk": "@@ -0,0 +1,61 @@\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+'use strict';\n+\n+const topicmessage = require('../topicmessage.js');\n+\n+beforeAll(async () => {\n+  jest.setTimeout(1000);\n+});\n+\n+afterAll(() => {});\n+\n+const invalidTimestamp = 'Invalid parameter: consensusTimestamp';\n+\n+// Start of tests\n+describe('topicmessage validateConsensusTimestampParam tests', () => {\n+  test('Verify validateConsensusTimestampParam returns correct result for -1234567890.000000001', () => {\n+    verifyInvalidConsensusTimestamp(\n+      topicmessage.validateConsensusTimestampParam(-1234567890.000000001),\n+      invalidTimestamp\n+    );\n+  });\n+  test('Verify validateConsensusTimestampParam returns correct result for abc', () => {\n+    verifyInvalidConsensusTimestamp(topicmessage.validateConsensusTimestampParam('abc'), invalidTimestamp);\n+  });\n+  test('Verify validateConsensusTimestampParam returns correct result for 1234567890', () => {\n+    verifyValidConsensusTimestamp(topicmessage.validateConsensusTimestampParam(1234567890));\n+  });\n+  test('Verify validateConsensusTimestampParam returns correct result for 123.0001', () => {\n+    verifyValidConsensusTimestamp(topicmessage.validateConsensusTimestampParam(123.0001));\n+  });\n+});\n+\n+const verifyValidConsensusTimestamp = val => {\n+  expect(val).toStrictEqual({code: 200, contents: 'OK', isValid: true});\n+};\n+\n+const verifyInvalidConsensusTimestamp = (val, message) => {\n+  expect(val).toStrictEqual({\n+    code: 400,", "originalCommit": "b04275014a11641795839c6abbfa4f0ee42bc3b5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzQxMDE0MA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/615#discussion_r397410140", "bodyText": "I'm not done with this file, wanted to get something close to end but not WIP out for review. Good point though", "author": "Nana-EC", "createdAt": "2020-03-24T19:32:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzMwNDcwMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzMwNTMyMg==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/615#discussion_r397305322", "bodyText": "Might be good idea to make the success response a static const object in util and use it everywhere", "author": "steven-sheehy", "createdAt": "2020-03-24T16:47:44Z", "path": "hedera-mirror-rest/__tests__/topicmessage.test.js", "diffHunk": "@@ -0,0 +1,61 @@\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+'use strict';\n+\n+const topicmessage = require('../topicmessage.js');\n+\n+beforeAll(async () => {\n+  jest.setTimeout(1000);\n+});\n+\n+afterAll(() => {});\n+\n+const invalidTimestamp = 'Invalid parameter: consensusTimestamp';\n+\n+// Start of tests\n+describe('topicmessage validateConsensusTimestampParam tests', () => {\n+  test('Verify validateConsensusTimestampParam returns correct result for -1234567890.000000001', () => {\n+    verifyInvalidConsensusTimestamp(\n+      topicmessage.validateConsensusTimestampParam(-1234567890.000000001),\n+      invalidTimestamp\n+    );\n+  });\n+  test('Verify validateConsensusTimestampParam returns correct result for abc', () => {\n+    verifyInvalidConsensusTimestamp(topicmessage.validateConsensusTimestampParam('abc'), invalidTimestamp);\n+  });\n+  test('Verify validateConsensusTimestampParam returns correct result for 1234567890', () => {\n+    verifyValidConsensusTimestamp(topicmessage.validateConsensusTimestampParam(1234567890));\n+  });\n+  test('Verify validateConsensusTimestampParam returns correct result for 123.0001', () => {\n+    verifyValidConsensusTimestamp(topicmessage.validateConsensusTimestampParam(123.0001));\n+  });\n+});\n+\n+const verifyValidConsensusTimestamp = val => {\n+  expect(val).toStrictEqual({code: 200, contents: 'OK', isValid: true});", "originalCommit": "b04275014a11641795839c6abbfa4f0ee42bc3b5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzQxMDIyNQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/615#discussion_r397410225", "bodyText": "Good idea", "author": "Nana-EC", "createdAt": "2020-03-24T19:33:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzMwNTMyMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzUxMDY4Nw==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/615#discussion_r397510687", "bodyText": "Done", "author": "Nana-EC", "createdAt": "2020-03-24T22:55:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzMwNTMyMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzM0MzgyMg==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/615#discussion_r397343822", "bodyText": "This index takes 28m to execute on testnet data. 50m with concurrently using psql. Have you tried with concurrently via flyway in dev? Should we write a java migration that does this asynchronously? Or should we just plan for 30m of downtime if management approves?", "author": "steven-sheehy", "createdAt": "2020-03-24T17:42:37Z", "path": "hedera-mirror-importer/src/main/resources/db/migration/V1.21__add_topicmessage_seqindex.sql", "diffHunk": "@@ -0,0 +1,6 @@\n+---\n+--- Add new topic_message indexes to enable initial rest api for individual topic messages\n+---\n+\n+create index if not exists topic_message__topic_num_realm_num_seqnum", "originalCommit": "b04275014a11641795839c6abbfa4f0ee42bc3b5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzUxNDM4NA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/615#discussion_r397514384", "bodyText": "Haven't had bandwidth to look into this part. Will look now.", "author": "Nana-EC", "createdAt": "2020-03-24T23:05:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzM0MzgyMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzM0NDg5MQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/615#discussion_r397344891", "bodyText": "Non-standard error response", "author": "steven-sheehy", "createdAt": "2020-03-24T17:44:13Z", "path": "hedera-mirror-rest/__tests__/specs/topicmessage-07-idseq-not-found.spec.json", "diffHunk": "@@ -0,0 +1,26 @@\n+{\n+  \"description\": \"Topic messages for single message with non matching response\",\n+  \"setup\": {\n+    \"accounts\": [\n+      {\n+        \"entity_num\": 7,\n+        \"entity_type\": 4\n+      }\n+    ],\n+    \"balances\": [],\n+    \"transactions\": [],\n+    \"cryptotransfers\": [],\n+    \"topicmessages\": [\n+      {\n+        \"timestamp\": \"1234567890000000001\",\n+        \"topic_num\": 7,\n+        \"seq_num\": 1\n+      }\n+    ]\n+  },\n+  \"url\": \"/api/v1/topic/7/message/2\",\n+  \"responseStatus\": 404,\n+  \"responseJson\": {\n+    \"message\": \"hcs message not found\"", "originalCommit": "b04275014a11641795839c6abbfa4f0ee42bc3b5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzQxMDkxMA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/615#discussion_r397410910", "bodyText": "Pulled this from /topic/message/:timestamp topic response. Will standardize it.", "author": "Nana-EC", "createdAt": "2020-03-24T19:34:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzM0NDg5MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzM0OTMwNg==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/615#discussion_r397349306", "bodyText": "A default would need to be added to application.yaml", "author": "steven-sheehy", "createdAt": "2020-03-24T17:50:59Z", "path": "hedera-mirror-rest/server.js", "diffHunk": "@@ -97,7 +97,8 @@ for (const api of [\n   {name: 'transactions', ttl: config.api.ttl.transactions},\n   {name: 'balances', ttl: config.api.ttl.balances},\n   {name: 'accounts', ttl: config.api.ttl.accounts},\n-  {name: 'events', ttl: config.api.ttl.events}\n+  {name: 'events', ttl: config.api.ttl.events},\n+  {name: 'topicmessages', ttl: config.api.ttl.topicmessages}", "originalCommit": "b04275014a11641795839c6abbfa4f0ee42bc3b5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzQzNjc0Nw==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/615#discussion_r397436747", "bodyText": "Left over logic from when I thought I was also covering the topic/:id/messages collection endpoint.\nWe don't seem to cache for single resource item requests so I'll remove this.", "author": "Nana-EC", "createdAt": "2020-03-24T20:22:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzM0OTMwNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzM5NTQ1OQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/615#discussion_r397395459", "bodyText": "We should also probably make this a unique index?", "author": "steven-sheehy", "createdAt": "2020-03-24T19:06:41Z", "path": "hedera-mirror-importer/src/main/resources/db/migration/V1.21__add_topicmessage_seqindex.sql", "diffHunk": "@@ -0,0 +1,6 @@\n+---\n+--- Add new topic_message indexes to enable initial rest api for individual topic messages\n+---\n+\n+create index if not exists topic_message__topic_num_realm_num_seqnum", "originalCommit": "b04275014a11641795839c6abbfa4f0ee42bc3b5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzUxMDYxNA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/615#discussion_r397510614", "bodyText": "Done", "author": "Nana-EC", "createdAt": "2020-03-24T22:55:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzM5NTQ1OQ=="}], "type": "inlineReview"}, {"oid": "fe49f71b81b33dba6043892161ed47c2ba462b6d", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/fe49f71b81b33dba6043892161ed47c2ba462b6d", "message": "Merge w rest integration coverage increase from master\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2020-03-24T19:26:01Z", "type": "commit"}, {"oid": "e06984ae52853ae0abc782bf1a3eb66f83c87110", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/e06984ae52853ae0abc782bf1a3eb66f83c87110", "message": "Standardized error format and moved some code to utils. Also added more tests\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2020-03-24T22:34:09Z", "type": "commit"}, {"oid": "c5a9777a61aa7e3de2abfac4bb313c5723d01fa0", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/c5a9777a61aa7e3de2abfac4bb313c5723d01fa0", "message": "Made index unique and centralized mroe test logic\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2020-03-24T22:54:28Z", "type": "commit"}, {"oid": "a8ee3deaef505fd1b7fb74c26a6f101ba5411423", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/a8ee3deaef505fd1b7fb74c26a6f101ba5411423", "message": "Removed duplicate message test as it's n/a with new index\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2020-03-24T23:52:49Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzU2NTAzMg==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/615#discussion_r397565032", "bodyText": "Please don't remove this. It's not testing uniqueness of db data, but of disparate service layers potentially returning dupes and checking if service filters them out.", "author": "steven-sheehy", "createdAt": "2020-03-25T01:52:21Z", "path": "hedera-mirror-grpc/src/test/java/com/hedera/mirror/grpc/service/TopicMessageServiceTest.java", "diffHunk": "@@ -480,32 +480,6 @@ void bothMessagesWithRealmNum() {\n                 .verify(Duration.ofMillis(500));\n     }\n \n-    @Test\n-    void duplicateMessages() {", "originalCommit": "a8ee3deaef505fd1b7fb74c26a6f101ba5411423", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzkyNDU4OQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/615#discussion_r397924589", "bodyText": "The test fails because you can't insert the duplicate messages with the new unique index of realm_num, topic_num and sequence_number.", "author": "Nana-EC", "createdAt": "2020-03-25T15:01:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzU2NTAzMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzkyNjAwMA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/615#discussion_r397926000", "bodyText": "The test would have to be modified or moved from this file to send back duplicates that don't reflect actual db duplicates in that case", "author": "Nana-EC", "createdAt": "2020-03-25T15:03:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzU2NTAzMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Nzk2MDUyNg==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/615#discussion_r397960526", "bodyText": "Ah, I see. We'll probably have to rewrite it as a mock test in the future. We can do that later.", "author": "steven-sheehy", "createdAt": "2020-03-25T15:46:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzU2NTAzMg=="}], "type": "inlineReview"}]}