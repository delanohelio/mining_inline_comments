{"pr_number": 1168, "pr_title": "Add support for case insensitive query params to REST API", "pr_createdAt": "2020-10-22T02:07:10Z", "pr_url": "https://github.com/hashgraph/hedera-mirror-node/pull/1168", "timeline": [{"oid": "2fc76589090c0f8316f419dbca3325b732d0db05", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/2fc76589090c0f8316f419dbca3325b732d0db05", "message": "Add support for case insensitive query params to REST API\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2020-10-24T03:02:08Z", "type": "commit"}, {"oid": "2fc76589090c0f8316f419dbca3325b732d0db05", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/2fc76589090c0f8316f419dbca3325b732d0db05", "message": "Add support for case insensitive query params to REST API\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2020-10-24T03:02:08Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjAyMzcwNg==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1168#discussion_r512023706", "bodyText": "Should TOKENID also be swapped to lowercase?", "author": "ijungmann", "createdAt": "2020-10-26T14:54:53Z", "path": "hedera-mirror-rest/constants.js", "diffHunk": "@@ -35,7 +35,7 @@ const filterKeys = {\n   TOKENID: 'tokenId',\n   TOKEN_ID: 'token.id',\n   CREDIT_TYPE: 'type',\n-  TRANSACTION_TYPE: 'transactionType',\n+  TRANSACTION_TYPE: 'transactiontype',", "originalCommit": "2fc76589090c0f8316f419dbca3325b732d0db05", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjA4NzY1NA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1168#discussion_r512087654", "bodyText": "Yeah, thanks", "author": "Nana-EC", "createdAt": "2020-10-26T16:16:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjAyMzcwNg=="}], "type": "inlineReview"}, {"oid": "d95bfb7ec277976ec89d35004f82176c8e1e9b30", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/d95bfb7ec277976ec89d35004f82176c8e1e9b30", "message": "Update tokenId case\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2020-10-26T16:15:58Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjEwNzM5MQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1168#discussion_r512107391", "bodyText": "Might make sense to add a comment here so that it's not lumped in as \"logging middleware\".", "author": "ijungmann", "createdAt": "2020-10-26T16:44:21Z", "path": "hedera-mirror-rest/server.js", "diffHunk": "@@ -102,6 +102,7 @@ app.use(cors());\n \n // logging middleware\n app.use(requestLogger);\n+app.use(requestQueryKeyFormatter);", "originalCommit": "d95bfb7ec277976ec89d35004f82176c8e1e9b30", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzA0MDczMA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1168#discussion_r513040730", "bodyText": "Moved up under a different log", "author": "Nana-EC", "createdAt": "2020-10-27T21:22:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjEwNzM5MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjM3MjIzMg==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1168#discussion_r512372232", "bodyText": "there is performance issue. in utils.js,\nconst buildFilterObject = (filters) => {\n  let filterObject = [];\n  if (filters === null) {\n    return null;\n  }\n\n  for (const [key, values] of Object.entries(filters)) {\nthe time complexity is O(n^2). this can be exploited by sending queries with a large number of query params.", "author": "xin-hedera", "createdAt": "2020-10-27T02:03:34Z", "path": "hedera-mirror-rest/middleware/requestHandler.js", "diffHunk": "@@ -25,6 +25,22 @@ const requestLogger = function (req, res, next) {\n   return next();\n };\n \n+/**\n+ * Support case insensitive retrieval from request parameters\n+ * @param req\n+ * @param res\n+ * @param next\n+ * @returns Query param value\n+ */\n+const requestQueryKeyFormatter = function (req, res, next) {\n+  req.query = new Proxy(req.query, {\n+    get: (target, name) => target[Object.keys(target).find((key) => key.toLowerCase() === name.toLowerCase())],", "originalCommit": "d95bfb7ec277976ec89d35004f82176c8e1e9b30", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjM3NTQ0Mg==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1168#discussion_r512375442", "bodyText": "this also does not handle the case where the same param appears in different lower-upper case combinations, e.g.,\ntimestamp=gt:100&Timestamp=lt:200\n\nexpress will parse it into {timestamp: 'gt:100', Timestamp: 'lt:200'}\nwith the middleware, req.query['timestamp'] will always return the first match, which is 'gt:100'", "author": "xin-hedera", "createdAt": "2020-10-27T02:15:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjM3MjIzMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzAzODI5Nw==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1168#discussion_r513038297", "bodyText": "Good points.\nI decided to go with a customer query parser.\nAlso changed for a for in which is more performant than Object.entries()", "author": "Nana-EC", "createdAt": "2020-10-27T21:17:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjM3MjIzMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjc4Nzg0MQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1168#discussion_r512787841", "bodyText": "Not a fan of returning all lowercase to the user when the docs will show the camel case. See my other comment for a possible solution with classes.", "author": "steven-sheehy", "createdAt": "2020-10-27T15:24:30Z", "path": "hedera-mirror-rest/__tests__/specs/token-info-02-invalid-id.spec.json", "diffHunk": "@@ -50,7 +50,7 @@\n     \"_status\": {\n       \"messages\": [\n         {\n-          \"message\": \"Invalid parameter: tokenId\"\n+          \"message\": \"Invalid parameter: tokenid\"", "originalCommit": "d95bfb7ec277976ec89d35004f82176c8e1e9b30", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzAzODgzNw==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1168#discussion_r513038837", "bodyText": "I agree it'd be nice to maintain camelCase for responses and docs.\nHowever, providing that and case insensitive has additional implementation overhead which I'm not sure is worth it right now.\nFor instance we'd have to ensure that someone who typed in tokenid/TokenId/Tokenid/tokenId still got the response message using tokenId.\nWhen we were case sensitive this was easy, but with case insensitive support the above requires extra mapping back to the camelCase form.\nWe should  lump it into the eventual refactor though, unless you have a quick suggestion with the existing logic.", "author": "Nana-EC", "createdAt": "2020-10-27T21:18:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjc4Nzg0MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjgwNDU1MQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1168#discussion_r512804551", "bodyText": "Creating a proxy seems like a much heavier weight approach than just calling lowercase when validating the parameter. Besides probably being slower as Xin points out, the use of a reflective wrapper object probably has some performance penalty.\nI would suggest moving away from the switch statement and use a more OO approach. We already have filter constants and logic spread around too many classes. It might be time to consolidate them into a class. Pseudo code:\n// filters.js\nvar filters = {};\n\nclass Filter {\n  constructor(name, validator, comparator) {\n    this.name = name;\n    this.validator = validator;\n    this.comparator = comparator;\n  }\n}\n\nfunc addFilter(tokenId) {\n  filters[tokenId.name.toLowerCase()] = tokenId;\n}\n\nfunc validate(key, value) {\n  const filter = filters[param.toLowerCase()];\n  if (filter) {\n    filter.validator(value);\n  }\n}\n\naddFilter(new Filter('tokenId', (value) => ...));\n...", "author": "steven-sheehy", "createdAt": "2020-10-27T15:43:09Z", "path": "hedera-mirror-rest/middleware/requestHandler.js", "diffHunk": "@@ -25,6 +25,22 @@ const requestLogger = function (req, res, next) {\n   return next();\n };\n \n+/**\n+ * Support case insensitive retrieval from request parameters\n+ * @param req\n+ * @param res\n+ * @param next\n+ * @returns Query param value\n+ */\n+const requestQueryKeyFormatter = function (req, res, next) {\n+  req.query = new Proxy(req.query, {", "originalCommit": "d95bfb7ec277976ec89d35004f82176c8e1e9b30", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjgzNDgxMQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1168#discussion_r512834811", "bodyText": "Yeah this is a good approach. I had opened a ticket a while ago to solve this with a 3rd party framework, but this might give us more control over the data flow through the API", "author": "Nana-EC", "createdAt": "2020-10-27T16:18:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjgwNDU1MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzAzOTQyOA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1168#discussion_r513039428", "bodyText": "I think this should go under #712\nI think we could combine this with the custom query filter I added to optimize the whole flow better.", "author": "Nana-EC", "createdAt": "2020-10-27T21:20:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjgwNDU1MQ=="}], "type": "inlineReview"}, {"oid": "9d55a50b4d0cb53e758a3f98dbccfa10d46aa6e8", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/9d55a50b4d0cb53e758a3f98dbccfa10d46aa6e8", "message": "Utilize custome express request parser\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2020-10-27T21:14:56Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzU1MzgyMQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1168#discussion_r513553821", "bodyText": "nit: Think this is a typo.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  // handle repeated values. Add to array if applicable of convert to array\n          \n          \n            \n                  // handle repeated values. Add to array if applicable or convert to array", "author": "ijungmann", "createdAt": "2020-10-28T15:47:17Z", "path": "hedera-mirror-rest/middleware/requestHandler.js", "diffHunk": "@@ -0,0 +1,63 @@\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+\n+'use strict';\n+\n+const qs = require('qs');\n+\n+const requestLogger = function (req, res, next) {\n+  logger.debug(`Client: [ ${req.ip} ] URL: ${req.originalUrl}`);\n+  return next();\n+};\n+\n+/**\n+ * Manage request query params to support case insensitive keys\n+ * Express default query parer uses qs, other option is querystring, both are case sensitive\n+ * Parse using default qs logic and use to populate a new map in which all keys are lowercased\n+ * @param queryString\n+ * @returns Query string map object\n+ */\n+const requestQueryParser = (queryString) => {\n+  // parse first to benefit from qs query handling\n+  const parsedQueryString = qs.parse(queryString);\n+\n+  const caseInsensitiveQueryString = {};\n+  for (const key of Object.keys(parsedQueryString)) {\n+    const lowerKey = key.toLowerCase();\n+    const currentValue = caseInsensitiveQueryString[lowerKey];\n+    if (currentValue) {\n+      // handle repeated values. Add to array if applicable of convert to array", "originalCommit": "9d55a50b4d0cb53e758a3f98dbccfa10d46aa6e8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzYyNTk3NA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1168#discussion_r513625974", "bodyText": "Fixed", "author": "Nana-EC", "createdAt": "2020-10-28T17:20:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzU1MzgyMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzU5MDE1Mw==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1168#discussion_r513590153", "bodyText": "this does not handle the case:\ntransactiontype=bar&transactionType=xyz&transactionType=ppp\n\nexpected: {transactiontype: ['bar', 'xyz', 'ppp']}\nactual: {transactiontype: ['bar', ['xyz', 'ppp']]}", "author": "xin-hedera", "createdAt": "2020-10-28T16:32:45Z", "path": "hedera-mirror-rest/middleware/requestHandler.js", "diffHunk": "@@ -0,0 +1,63 @@\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+\n+'use strict';\n+\n+const qs = require('qs');\n+\n+const requestLogger = function (req, res, next) {\n+  logger.debug(`Client: [ ${req.ip} ] URL: ${req.originalUrl}`);\n+  return next();\n+};\n+\n+/**\n+ * Manage request query params to support case insensitive keys\n+ * Express default query parer uses qs, other option is querystring, both are case sensitive\n+ * Parse using default qs logic and use to populate a new map in which all keys are lowercased\n+ * @param queryString\n+ * @returns Query string map object\n+ */\n+const requestQueryParser = (queryString) => {\n+  // parse first to benefit from qs query handling\n+  const parsedQueryString = qs.parse(queryString);\n+\n+  const caseInsensitiveQueryString = {};\n+  for (const key of Object.keys(parsedQueryString)) {\n+    const lowerKey = key.toLowerCase();\n+    const currentValue = caseInsensitiveQueryString[lowerKey];\n+    if (currentValue) {\n+      // handle repeated values. Add to array if applicable of convert to array\n+      if (Array.isArray(currentValue)) {\n+        caseInsensitiveQueryString[lowerKey].push(parsedQueryString[key]);\n+      } else {\n+        caseInsensitiveQueryString[lowerKey] = [currentValue, parsedQueryString[key]];\n+      }\n+    } else {\n+      caseInsensitiveQueryString[lowerKey] = parsedQueryString[key];\n+    }", "originalCommit": "9d55a50b4d0cb53e758a3f98dbccfa10d46aa6e8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzYyMDEyMg==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1168#discussion_r513620122", "bodyText": "Good catch. I need to concat in the case of arrays", "author": "Nana-EC", "createdAt": "2020-10-28T17:12:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzU5MDE1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzYyNTgxNA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1168#discussion_r513625814", "bodyText": "Added above as a test case and added a new test with multi key and case repetitions that verifies the handling of array value", "author": "Nana-EC", "createdAt": "2020-10-28T17:20:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzU5MDE1Mw=="}], "type": "inlineReview"}, {"oid": "4aa9e609c544620d9f44dc0c874e7121b1a50a92", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/4aa9e609c544620d9f44dc0c874e7121b1a50a92", "message": "Handled repeated but matching cases\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2020-10-28T17:18:53Z", "type": "commit"}]}