{"pr_number": 1165, "pr_title": "Fix postgresql deadlock in integration tests", "pr_createdAt": "2020-10-21T15:53:14Z", "pr_url": "https://github.com/hashgraph/hedera-mirror-node/pull/1165", "timeline": [{"oid": "e9d4cce5e8ba40721b2539712e87c33d40651e68", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/e9d4cce5e8ba40721b2539712e87c33d40651e68", "message": "do not run cleanup.sql BEFORE_TEST_METHOD to avoid postgresql deadlock with async post date range processing\n\nSigned-off-by: Xin Li <xin.li@swirlds.com>", "committedDate": "2020-10-21T15:04:46Z", "type": "commit"}, {"oid": "4e7fe84d8a36afcb1217a00ae2177b7966f53cb0", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/4e7fe84d8a36afcb1217a00ae2177b7966f53cb0", "message": "fix test case failure\n\nSigned-off-by: Xin Li <xin.li@swirlds.com>", "committedDate": "2020-10-21T21:06:27Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTcwMDM4Mw==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1165#discussion_r509700383", "bodyText": "This test fails in my local env but not in CircleCI runs. What happened is if the Sql annotations here do not match exactly those in IntegrationTest, springboot test will list all 3 sql scripts and cleanup.sql will run in AFTER_TEST_METHOD phase and errors out since it tries to truncate tables after V1.28.1", "author": "xin-hedera", "createdAt": "2020-10-21T21:11:11Z", "path": "hedera-mirror-importer/src/test/java/com/hedera/mirror/importer/migration/V1_28_1__Address_BookTest.java", "diffHunk": "@@ -48,7 +48,6 @@\n import com.hedera.mirror.importer.repository.FileDataRepository;\n \n @TestPropertySource(properties = \"spring.flyway.target=1.28.0\")\n-@Sql(executionPhase = Sql.ExecutionPhase.BEFORE_TEST_METHOD, scripts = \"classpath:db/scripts/cleanup_V1.28.1.sql\")", "originalCommit": "4e7fe84d8a36afcb1217a00ae2177b7966f53cb0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDI5MTQzOA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1165#discussion_r510291438", "bodyText": "There is an open ticket regarding this confusing behavior:\nhttps://bugs.openjdk.java.net/browse/JDK-8188040\nfor annotations which are both repeatable and inherited", "author": "xin-hedera", "createdAt": "2020-10-22T16:18:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTcwMDM4Mw=="}], "type": "inlineReview"}, {"oid": "3e8bed1c9294ef002f333d72e101224efc211275", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/3e8bed1c9294ef002f333d72e101224efc211275", "message": "Merge remote-tracking branch 'origin/master' into fix-postgresql-deadlock", "committedDate": "2020-10-22T16:22:23Z", "type": "commit"}, {"oid": "d928a26de342c80f7e0efb37ad0f43acd7f350bb", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/d928a26de342c80f7e0efb37ad0f43acd7f350bb", "message": "make AddressBookServiceImplTest extends IntegrationTest\n\nSigned-off-by: Xin Li <xin.li@swirlds.com>", "committedDate": "2020-10-22T16:31:14Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDMwMjAzMA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1165#discussion_r510302030", "bodyText": "ends up also explicitly acquire the highest level table lock on t_application_status since AddressBookServiceImplTest assumes empty address_book and address_book_entry tables. It's better and easier to maintain a single all-in-one cleanup script instead of creating test class specific cleanup scripts.\nThe lock should have the effect to serialize the t_applications_status update in both this script and the transaction in MirrorDateRangePropertiesProcessor", "author": "xin-hedera", "createdAt": "2020-10-22T16:33:49Z", "path": "hedera-mirror-importer/src/main/resources/db/scripts/cleanup.sql", "diffHunk": "@@ -9,8 +9,8 @@ TRUNCATE TABLE t_entities RESTART IDENTITY CASCADE;\n TRUNCATE TABLE transaction RESTART IDENTITY CASCADE;\n TRUNCATE TABLE topic_message RESTART IDENTITY CASCADE;\n TRUNCATE TABLE non_fee_transfer;\n-UPDATE t_application_status\n-SET status_value = NULL;\n+LOCK TABLE t_application_status IN ACCESS EXCLUSIVE MODE;", "originalCommit": "d928a26de342c80f7e0efb37ad0f43acd7f350bb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "8049f4222dc67a1e42ff46e3152822b0ec30be06", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/8049f4222dc67a1e42ff46e3152822b0ec30be06", "message": "change all @Sql in integration tests to BEFORE_TEST_METHOD phase\n\nSigned-off-by: Xin Li <xin.li@swirlds.com>", "committedDate": "2020-10-22T16:49:03Z", "type": "commit"}, {"oid": "95123d0fe6b83498b398c0337045fbadc8048b9b", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/95123d0fe6b83498b398c0337045fbadc8048b9b", "message": "revert changes to IntegrationTest since now cleanup.sql locks t_application_status table to serializes writes to it\n\nSigned-off-by: Xin Li <xin.li@swirlds.com>", "committedDate": "2020-10-22T17:17:10Z", "type": "commit"}]}