{"pr_number": 772, "pr_title": "Add option to archive verified signature files", "pr_createdAt": "2020-05-21T16:16:30Z", "pr_url": "https://github.com/hashgraph/hedera-mirror-node/pull/772", "timeline": [{"oid": "2692ffdc2e6ee78b72fbe29b1bc90e8a55b05555", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/2692ffdc2e6ee78b72fbe29b1bc90e8a55b05555", "message": "Add option to keep signatures\n\nSigned-off-by: Steven Sheehy <steven.sheehy@hedera.com>", "committedDate": "2020-05-21T15:58:45Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODc2MzIxNQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/772#discussion_r428763215", "bodyText": "Using parser specific properties in a generic utility class is a code smell. It also didn't allow for code reuse with the new downloader properties. Instead move this back to layer where it belongs even if it duplicates 4 lines of code. This duplication will be gone anyway once we integrate balance parsing into the new framework (#573).", "author": "steven-sheehy", "createdAt": "2020-05-21T16:21:10Z", "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/util/Utility.java", "diffHunk": "@@ -311,38 +310,21 @@ public static boolean hashIsEmpty(String hash) {\n         return StringUtils.isBlank(hash) || hash.equals(EMPTY_HASH);\n     }\n \n-    public static void moveFileToParsedDir(String filePath, ParserProperties parserProperties) {\n-        Path source = Path.of(filePath);\n-        String fileName = source.getFileName().toString();\n-        String dateSubDir = fileName.substring(0, 10).replace(\"-\", File.separator);\n-        Path destination = parserProperties.getParsedPath().resolve(dateSubDir).resolve(fileName);\n-        destination.getParent().toFile().mkdirs();\n+    // Moves a file in the form 2019-08-30T18_10_00.419072Z.rcd to destinationRoot/2019/08/30\n+    public static void archiveFile(File source, Path destinationRoot) {\n+        String filename = source.getName();\n+        String date = filename.substring(0, 10).replace(\"-\", File.separator);\n+        Path destination = destinationRoot.resolve(date);\n \n         try {\n-            Files.move(source, destination, StandardCopyOption.REPLACE_EXISTING);\n+            destination.toFile().mkdirs();\n+            Files.move(source.toPath(), destination.resolve(filename), StandardCopyOption.REPLACE_EXISTING);\n             log.trace(\"Moved {} to {}\", source, destination);\n         } catch (Exception e) {\n             log.error(\"Error moving file {} to {}\", source, destination, e);\n         }\n     }\n \n-    public static void deleteFile(String fileName) {\n-        try {\n-            Files.delete(new File(fileName).toPath());\n-            log.trace(\"Deleted file {}\", fileName);\n-        } catch (Exception e) {\n-            log.error(\"Error deleting file {}\", fileName);\n-        }\n-    }\n-\n-    public static void moveOrDeleteParsedFile(String fileName, ParserProperties parserProperties) {", "originalCommit": "2692ffdc2e6ee78b72fbe29b1bc90e8a55b05555", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODg1MDM1Nw==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/772#discussion_r428850357", "bodyText": "nit: you can be specific here and say 'balance signature files' since you are describing hedera.mirror.importer.downloader.balance.keepSignatures.\nIt's a given by the property name but the description out of context could be misunderstood for all signature files", "author": "Nana-EC", "createdAt": "2020-05-21T18:58:01Z", "path": "docs/configuration.md", "diffHunk": "@@ -34,6 +34,7 @@ value, it is recommended to only populate overridden properties in the custom `a\n | `hedera.mirror.importer.downloader.balance.batchSize`                | 15                      | The number of signature files to download per node before downloading the signed files         |\n | `hedera.mirror.importer.downloader.balance.enabled`                  | true                    | Whether to enable balance file downloads                                                       |\n | `hedera.mirror.importer.downloader.balance.frequency`                | 30s                     | The fixed period between invocations. Can accept duration units like `10s`, `2m` etc.          |\n+| `hedera.mirror.importer.downloader.balance.keepSignatures`           | false                   | Whether to keep signature files after successful verification. If false, files are deleted.    |", "originalCommit": "2692ffdc2e6ee78b72fbe29b1bc90e8a55b05555", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODg1MjY0NA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/772#discussion_r428852644", "bodyText": "nit: same nit above but for record", "author": "Nana-EC", "createdAt": "2020-05-21T19:02:22Z", "path": "docs/configuration.md", "diffHunk": "@@ -42,6 +43,7 @@ value, it is recommended to only populate overridden properties in the custom `a\n | `hedera.mirror.importer.downloader.record.batchSize`                 | 40                      | The number of signature files to download per node before downloading the signed files         |\n | `hedera.mirror.importer.downloader.record.enabled`                   | true                    | Whether to enable record file downloads                                                        |\n | `hedera.mirror.importer.downloader.record.frequency`                 | 500ms                   | The fixed period between invocations. Can accept duration units like `10s`, `2m` etc.          |\n+| `hedera.mirror.importer.downloader.record.keepSignatures`            | false                   | Whether to keep signature files after successful verification. If false, files are deleted.    |", "originalCommit": "2692ffdc2e6ee78b72fbe29b1bc90e8a55b05555", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "fcfbdf73da0b3afa49eadb4cd8d1638884df39d3", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/fcfbdf73da0b3afa49eadb4cd8d1638884df39d3", "message": "Address review\n\nSigned-off-by: Steven Sheehy <steven.sheehy@hedera.com>", "committedDate": "2020-05-21T21:49:13Z", "type": "commit"}]}