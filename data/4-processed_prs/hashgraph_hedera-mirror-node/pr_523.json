{"pr_number": 523, "pr_title": "Handle start and end time arithmetic overflow cases on topic subscribe", "pr_createdAt": "2020-02-04T21:02:26Z", "pr_url": "https://github.com/hashgraph/hedera-mirror-node/pull/523", "timeline": [{"oid": "6929e5e70b9ccbf5e2191e23f6b8a70c442dc06e", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/6929e5e70b9ccbf5e2191e23f6b8a70c442dc06e", "message": "Handle start and end time arithmetic overflow cases on topic subscribe\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2020-02-04T20:52:55Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTAwODA0MA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/523#discussion_r375008040", "bodyText": "Why was this deleted? It tests rows before start time are not returned.", "author": "steven-sheehy", "createdAt": "2020-02-05T00:58:05Z", "path": "hedera-mirror-grpc/src/test/java/com/hedera/mirror/grpc/repository/TopicMessageRepositoryTest.java", "diffHunk": "@@ -106,7 +106,6 @@ void findByFilterWithTopicNum() {\n \n     @Test\n     void findByFilterWithStartTime() {\n-        TopicMessage topicMessage1 = domainBuilder.topicMessage().block();", "originalCommit": "6929e5e70b9ccbf5e2191e23f6b8a70c442dc06e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTYyOTQ4OA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/523#discussion_r375629488", "bodyText": "Gotcha, I mistook it for an unused line since the topicMessage1 is never used.\nThere's no need for the assignment in that case.", "author": "Nana-EC", "createdAt": "2020-02-06T03:54:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTAwODA0MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTYzMDA5NA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/523#discussion_r375630094", "bodyText": "It's not unused. That line inserts into the database, validating that rows before start time are not returned. Please put it back.", "author": "steven-sheehy", "createdAt": "2020-02-06T03:57:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTAwODA0MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTAwODc2MQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/523#discussion_r375008761", "bodyText": "Why have one test for just start time overflow and another test that has both start and end time overflow? I would say the latter is sufficient.", "author": "steven-sheehy", "createdAt": "2020-02-05T01:00:53Z", "path": "hedera-mirror-grpc/src/test/java/com/hedera/mirror/grpc/repository/TopicMessageRepositoryTest.java", "diffHunk": "@@ -121,6 +120,22 @@ void findByFilterWithStartTime() {\n                 .verifyComplete();\n     }\n \n+    @Test\n+    void findByFilterWithStartTimeOverflow() {", "originalCommit": "6929e5e70b9ccbf5e2191e23f6b8a70c442dc06e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTYyOTY3NQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/523#discussion_r375629675", "bodyText": "Sure.", "author": "Nana-EC", "createdAt": "2020-02-06T03:55:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTAwODc2MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTAxMTIwOQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/523#discussion_r375011209", "bodyText": "My concern here is this approach has to be done for every query instead of just once inside ConsensusController to validate input. Exception generation and catching are orders of magnitude slower then normal java functions. And queries are now split into pages and run every 2s times Y subscribers, so might have more impact.", "author": "steven-sheehy", "createdAt": "2020-02-05T01:09:55Z", "path": "hedera-mirror-grpc/src/main/java/com/hedera/mirror/grpc/repository/TopicMessageRepositoryCustomImpl.java", "diffHunk": "@@ -47,11 +47,12 @@\n                 .and(\"topic_num\")\n                 .is(filter.getTopicNum())\n                 .and(\"consensus_timestamp\")\n-                .greaterThanOrEquals(instantToLongConverter.convert(filter.getStartTime()));\n+                .greaterThanOrEquals(instantToLongConverter.convertOrDefault(filter.getStartTime()));", "originalCommit": "6929e5e70b9ccbf5e2191e23f6b8a70c442dc06e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTYzMDkxNw==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/523#discussion_r375630917", "bodyText": "Gotcha, will move away from the exception catch logic then", "author": "Nana-EC", "createdAt": "2020-02-06T04:02:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTAxMTIwOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTYzNDA4Mg==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/523#discussion_r375634082", "bodyText": "Exception logic is fine if just done once, just not in a loop. Other approach would be to create an Instant that represents our max supported and just compare with isAfter/isBefore. Either way", "author": "steven-sheehy", "createdAt": "2020-02-06T04:20:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTAxMTIwOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTY0MzY3Ng==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/523#discussion_r375643676", "bodyText": "This was what I ended up doing", "author": "Nana-EC", "createdAt": "2020-02-06T05:14:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTAxMTIwOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTAxNDQ0Nw==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/523#discussion_r375014447", "bodyText": "This approach does not address all instances of InstantToLongConverter since the shared poller uses it as well. Would be better to centralize in controller.", "author": "steven-sheehy", "createdAt": "2020-02-05T01:22:07Z", "path": "hedera-mirror-grpc/src/main/java/com/hedera/mirror/grpc/repository/TopicMessageRepositoryCustomImpl.java", "diffHunk": "@@ -47,11 +47,12 @@\n                 .and(\"topic_num\")\n                 .is(filter.getTopicNum())\n                 .and(\"consensus_timestamp\")\n-                .greaterThanOrEquals(instantToLongConverter.convert(filter.getStartTime()));\n+                .greaterThanOrEquals(instantToLongConverter.convertOrDefault(filter.getStartTime()));\n \n-        if (filter.getEndTime() != null) {\n+        Long endTime = instantToLongConverter.convertOrDefault(filter.getEndTime());", "originalCommit": "6929e5e70b9ccbf5e2191e23f6b8a70c442dc06e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTYzMDk3OA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/523#discussion_r375630978", "bodyText": "Agreed. Got rid of extra method. Now every reference should be covered.", "author": "Nana-EC", "createdAt": "2020-02-06T04:02:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTAxNDQ0Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTYzODkwMA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/523#discussion_r375638900", "bodyText": "Will handle centralization in next commit as it would include modifying TopicMessageFilter class", "author": "Nana-EC", "createdAt": "2020-02-06T04:48:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTAxNDQ0Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTY0NDU4Mg==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/523#discussion_r375644582", "bodyText": "I see the centralization benefit about converting once.\nTo centralize however, it would require both TopicMessageFilter and TopicMessage times be converted to longs.\nThe result is all future arithmetic on them will be in the form of longs that represent nanoseconds and not utilizing the benefit on Instant object operations.\nI think leaving it as Instant leaves it easier to read and operate on the time in a way that's clear.\nLet me know if you feel strongly about centralizing or if I missed your intent here.", "author": "Nana-EC", "createdAt": "2020-02-06T05:18:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTAxNDQ0Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTY0NzM0Ng==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/523#discussion_r375647346", "bodyText": "Why would it require both TopicMessageFilter and TopicMessage times be converted to longs? Just check the proto timestamp if the seconds or nanos is less than 0 then set messageFilter.setStartTime(Instant.EPOCH) if so.  Likewise check if seconds+nanos > max that can fit in our long and skip setting filter.endTime if so.", "author": "steven-sheehy", "createdAt": "2020-02-06T05:32:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTAxNDQ0Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTY1OTAxMw==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/523#discussion_r375659013", "bodyText": "I think I see the mixup.\nYour centralization comment suggested you wanted there to be a central location for the convert() call. So that all the listeners would not have to call it as they do now.\nWhat you've suggested above was a consideration but doesn't achieve centralization of the convert() call.\nDoing the above will still require the InstantToLong conversion prior to the dbclient operation.\nMy last comment explained the effect of centralizing the convert() call in the controller and therefore having to handle times represented as Longs all the way to the repository call.\nI think what you meant was centralizing the initial overflow catch logic, which makes sense.\nI think we're on the same page now.\nI'll make the change", "author": "Nana-EC", "createdAt": "2020-02-06T06:26:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTAxNDQ0Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTAxNTMzNw==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/523#discussion_r375015337", "bodyText": "Not a fan of the extra method. The class implements Spring's Converter interface so it can be registered with Spring and used automatically within the framework. This extra method bypasses that. Though to be fair we are actually just calling it manually since Spring R2DBC doesn't currently support this, but in the future it could and we wouldn't need to call this manually in the repository.", "author": "steven-sheehy", "createdAt": "2020-02-05T01:25:33Z", "path": "hedera-mirror-grpc/src/main/java/com/hedera/mirror/grpc/converter/InstantToLongConverter.java", "diffHunk": "@@ -39,4 +39,12 @@ public Long convert(Instant instant) {\n         }\n         return Math.addExact(Math.multiplyExact(instant.getEpochSecond(), NANOS_PER_SECOND), instant.getNano());\n     }\n+\n+    public Long convertOrDefault(Instant instant) {", "originalCommit": "6929e5e70b9ccbf5e2191e23f6b8a70c442dc06e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTYzNzkwNQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/523#discussion_r375637905", "bodyText": "Removing extra method. Agreed", "author": "Nana-EC", "createdAt": "2020-02-06T04:42:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTAxNTMzNw=="}], "type": "inlineReview"}, {"oid": "6a3e9baa481a8cc3703f5c541a75d6052d69f983", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/6a3e9baa481a8cc3703f5c541a75d6052d69f983", "message": "Corrected approach by utilizing simple comparisons instead of exception handling\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2020-02-06T04:44:19Z", "type": "commit"}, {"oid": "474c46df6d132d129e7b584117671e55e6e05c38", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/474c46df6d132d129e7b584117671e55e6e05c38", "message": "Applied static final naming convention\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2020-02-06T05:07:11Z", "type": "commit"}, {"oid": "6dd67a20894ed543a628b21b1ebd1bd9fb9b4ba5", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/6dd67a20894ed543a628b21b1ebd1bd9fb9b4ba5", "message": "Scope start and endtime for query filter early on in  controller\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2020-02-06T13:43:57Z", "type": "commit"}, {"oid": "f86f4675506774c3a30fad74a6041401efbb14c7", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/f86f4675506774c3a30fad74a6041401efbb14c7", "message": "Merge branch 'master' into handlehcstimequeryoverflow\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2020-02-06T13:44:16Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjYzNDAyNQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/523#discussion_r376634025", "bodyText": "nit: Long.MAX_VALUE / NANOS_PER_SECOND * NANOS_PER_SECOND might be clearer", "author": "steven-sheehy", "createdAt": "2020-02-07T22:18:40Z", "path": "hedera-mirror-grpc/src/main/java/com/hedera/mirror/grpc/controller/ConsensusController.java", "diffHunk": "@@ -49,6 +51,8 @@\n @RequiredArgsConstructor\n public class ConsensusController extends ReactorConsensusServiceGrpc.ConsensusServiceImplBase {\n \n+    private static final long LONG_MAX_SECONDS = 9_223_372_036_000_000_000L;", "originalCommit": "f86f4675506774c3a30fad74a6041401efbb14c7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzMzMjM5Ng==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/523#discussion_r377332396", "bodyText": "Good point. Changed", "author": "Nana-EC", "createdAt": "2020-02-10T21:39:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjYzNDAyNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjYzODQwOA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/523#discussion_r376638408", "bodyText": "This is wrong.  Having  seconds=0 and nanos=999999999 will cause end time to not be set.", "author": "steven-sheehy", "createdAt": "2020-02-07T22:31:22Z", "path": "hedera-mirror-grpc/src/main/java/com/hedera/mirror/grpc/controller/ConsensusController.java", "diffHunk": "@@ -72,11 +76,23 @@ private TopicMessageFilter toFilter(ConsensusTopicQuery query) {\n                 .topicNum((int) query.getTopicID().getTopicNum());\n \n         if (query.hasConsensusStartTime()) {\n-            builder.startTime(ProtoUtil.fromTimestamp(query.getConsensusStartTime()));\n+            Timestamp startTimeStamp = query.getConsensusStartTime();\n+\n+            // scope pre epoch timestamps to epoch instant\n+            if (startTimeStamp.getSeconds() < 0 || startTimeStamp.getNanos() < 0) {\n+                builder.startTime(Instant.EPOCH);\n+            } else {\n+                builder.startTime(ProtoUtil.fromTimestamp(startTimeStamp));\n+            }\n         }\n \n         if (query.hasConsensusEndTime()) {\n-            builder.endTime(ProtoUtil.fromTimestamp(query.getConsensusEndTime()));\n+            Timestamp endTimeStamp = query.getConsensusEndTime();\n+\n+            // only set endTime if it's smaller than the seconds and nanoseconds in the Long.MAX value\n+            if (endTimeStamp.getSeconds() <= LONG_MAX_SECONDS && endTimeStamp.getNanos() <= LONG_MAX_NANOSECONDS) {", "originalCommit": "f86f4675506774c3a30fad74a6041401efbb14c7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzMzMjU4NQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/523#discussion_r377332585", "bodyText": "Good catch. I'm just gonna do a boundary check to ensure all cases", "author": "Nana-EC", "createdAt": "2020-02-10T21:40:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjYzODQwOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjYzODk1NA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/523#discussion_r376638954", "bodyText": "Please add a test to ConsensusControllerTest for these scenarios.", "author": "steven-sheehy", "createdAt": "2020-02-07T22:33:05Z", "path": "hedera-mirror-grpc/src/main/java/com/hedera/mirror/grpc/controller/ConsensusController.java", "diffHunk": "@@ -72,11 +76,23 @@ private TopicMessageFilter toFilter(ConsensusTopicQuery query) {\n                 .topicNum((int) query.getTopicID().getTopicNum());\n \n         if (query.hasConsensusStartTime()) {\n-            builder.startTime(ProtoUtil.fromTimestamp(query.getConsensusStartTime()));\n+            Timestamp startTimeStamp = query.getConsensusStartTime();", "originalCommit": "f86f4675506774c3a30fad74a6041401efbb14c7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzMzMjU0OQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/523#discussion_r377332549", "bodyText": "Added two, pre epoch and post max in the COntrollerTest", "author": "Nana-EC", "createdAt": "2020-02-10T21:40:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjYzODk1NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjY0MTcwNQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/523#discussion_r376641705", "bodyText": "nit: Long.MAX_VALUE % NANOS_PER_SECOND might be clearer", "author": "steven-sheehy", "createdAt": "2020-02-07T22:42:49Z", "path": "hedera-mirror-grpc/src/main/java/com/hedera/mirror/grpc/controller/ConsensusController.java", "diffHunk": "@@ -49,6 +51,8 @@\n @RequiredArgsConstructor\n public class ConsensusController extends ReactorConsensusServiceGrpc.ConsensusServiceImplBase {\n \n+    private static final long LONG_MAX_SECONDS = 9_223_372_036_000_000_000L;\n+    private static final int LONG_MAX_NANOSECONDS = 854_775_807;", "originalCommit": "f86f4675506774c3a30fad74a6041401efbb14c7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzMzMjQyMA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/523#discussion_r377332420", "bodyText": "Good point. Changed", "author": "Nana-EC", "createdAt": "2020-02-10T21:40:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjY0MTcwNQ=="}], "type": "inlineReview"}, {"oid": "d7f813a3e79387836572c0afa844d2921d5de9fe", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/d7f813a3e79387836572c0afa844d2921d5de9fe", "message": "Moved query time check into method and did boundary checks. Added tests\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2020-02-10T21:29:00Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzM5MTY2MQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/523#discussion_r377391661", "bodyText": "This should fail if endTimestamp is negative instead of assuming they want to never end", "author": "steven-sheehy", "createdAt": "2020-02-11T00:12:45Z", "path": "hedera-mirror-grpc/src/main/java/com/hedera/mirror/grpc/controller/ConsensusController.java", "diffHunk": "@@ -104,4 +121,13 @@ private Throwable unknownError(Throwable t) {\n         log.error(\"Unknown error subscribing to topic\", t);\n         return Status.INTERNAL.augmentDescription(t.getMessage()).asRuntimeException();\n     }\n+\n+    private boolean validEndTimeStamp(Timestamp endTimeStamp) {\n+        if (endTimeStamp == null) {\n+            return false;\n+        }\n+\n+        return (endTimeStamp.getSeconds() >= 0 && endTimeStamp.getSeconds() <= LONG_MAX_SECONDS) &&", "originalCommit": "d7f813a3e79387836572c0afa844d2921d5de9fe", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzQzOTIxMw==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/523#discussion_r377439213", "bodyText": "Addressed", "author": "Nana-EC", "createdAt": "2020-02-11T04:07:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzM5MTY2MQ=="}], "type": "inlineReview"}, {"oid": "8473ebd4ed6bcdad2cbf0871e8fcaada74930a4f", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/8473ebd4ed6bcdad2cbf0871e8fcaada74930a4f", "message": "Catch negative end times and throw error\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2020-02-11T01:49:54Z", "type": "commit"}, {"oid": "78a5c290797db77d09757cfbb9331ce90d614ec2", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/78a5c290797db77d09757cfbb9331ce90d614ec2", "message": "Added timestamputil and accompanying tests\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2020-02-11T04:06:28Z", "type": "commit"}, {"oid": "632472cce196428e645c256de25e9c9d1834f1a7", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/632472cce196428e645c256de25e9c9d1834f1a7", "message": "Performed validtimestamp check for starttime updated tests\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2020-02-11T04:55:44Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzcxNzMzMw==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/523#discussion_r377717333", "bodyText": "This looks like it will throw an IAE if startTimeStamp is negative, but we said negative timestamps should just default to epoch.", "author": "steven-sheehy", "createdAt": "2020-02-11T15:42:20Z", "path": "hedera-mirror-grpc/src/main/java/com/hedera/mirror/grpc/controller/ConsensusController.java", "diffHunk": "@@ -72,11 +74,23 @@ private TopicMessageFilter toFilter(ConsensusTopicQuery query) {\n                 .topicNum((int) query.getTopicID().getTopicNum());\n \n         if (query.hasConsensusStartTime()) {\n-            builder.startTime(ProtoUtil.fromTimestamp(query.getConsensusStartTime()));\n+            Timestamp startTimeStamp = query.getConsensusStartTime();\n+\n+            // scope pre epoch timestamps to epoch instant\n+            if (TimestampUtil.isValidTimeStamp(startTimeStamp)) {", "originalCommit": "632472cce196428e645c256de25e9c9d1834f1a7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzc5ODgxMw==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/523#discussion_r377798813", "bodyText": "That's a regression. startTimes out of the bound should indeed be bounded to EPOCH as we agreed and no exception thrown. That case should be for endTime only.", "author": "Nana-EC", "createdAt": "2020-02-11T17:53:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzcxNzMzMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzcyMzM1NQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/523#discussion_r377723355", "bodyText": "Not sure naming makes sense. A timestamp can be valid if greater than LONG_MAX_SECONDS, it's just not valid when we convert it to our internal representation of it as a long. It may make more sense to just move this logic to ProtoUtils.fromTimestamp(). A parameter can be added to control whether to take timestamp as is or do bounds checking.", "author": "steven-sheehy", "createdAt": "2020-02-11T15:51:11Z", "path": "hedera-mirror-grpc/src/main/java/com/hedera/mirror/grpc/util/TimestampUtil.java", "diffHunk": "@@ -0,0 +1,31 @@\n+package com.hedera.mirror.grpc.util;\n+\n+import com.hederahashgraph.api.proto.java.Timestamp;\n+import io.grpc.Status;\n+import lombok.AccessLevel;\n+import lombok.NoArgsConstructor;\n+import lombok.extern.log4j.Log4j2;\n+\n+@Log4j2\n+@NoArgsConstructor(access = AccessLevel.PRIVATE)\n+public final class TimestampUtil {\n+    private static final long NANOS_PER_SECOND = 1_000_000_000L;\n+    public static final long LONG_MAX_SECONDS = Long.MAX_VALUE / NANOS_PER_SECOND * NANOS_PER_SECOND;\n+    public static final int LONG_MAX_NANOSECONDS = (int) (Long.MAX_VALUE % NANOS_PER_SECOND);\n+\n+    public static boolean isValidTimeStamp(Timestamp endTimeStamp) {\n+        if (endTimeStamp == null) {\n+            return false;\n+        }\n+\n+        if (endTimeStamp.getSeconds() < 0 || endTimeStamp.getNanos() < 0) {\n+            log.warn(\"Negative endTimeStamp supplied\");\n+            throw Status.INVALID_ARGUMENT.augmentDescription(\"Negative endTimeStamp supplied\").asRuntimeException();\n+        }\n+\n+        // valid if seconds is less than max or if seconds is at max and nanoseconds are at or below max\n+        // 0 <= valid_time < LONG_MAX_SECONDS (9_223_372_036_000_000_000L) + LONG_MAX_NANOSECONDS (854_775_807)\n+        return (endTimeStamp.getSeconds() < LONG_MAX_SECONDS) ||", "originalCommit": "632472cce196428e645c256de25e9c9d1834f1a7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzc5OTAxNg==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/523#discussion_r377799016", "bodyText": "Moved this logic to ProtoUtil.\nI didn't like the extra parameter option as in the startTime case you want to check and then covert or scope . Then in the endTime case you want to check and throw and error for the client if it's out of bound.\nAs such it makes sense to have a check method (say isLongSupportedTimeStamp() ) and based in its result take the appropriate action for your given timestamp.", "author": "Nana-EC", "createdAt": "2020-02-11T17:53:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzcyMzM1NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzcyMzgzNg==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/523#discussion_r377723836", "bodyText": "Shouldn't be named endTimeStamp", "author": "steven-sheehy", "createdAt": "2020-02-11T15:51:57Z", "path": "hedera-mirror-grpc/src/main/java/com/hedera/mirror/grpc/util/TimestampUtil.java", "diffHunk": "@@ -0,0 +1,31 @@\n+package com.hedera.mirror.grpc.util;\n+\n+import com.hederahashgraph.api.proto.java.Timestamp;\n+import io.grpc.Status;\n+import lombok.AccessLevel;\n+import lombok.NoArgsConstructor;\n+import lombok.extern.log4j.Log4j2;\n+\n+@Log4j2\n+@NoArgsConstructor(access = AccessLevel.PRIVATE)\n+public final class TimestampUtil {\n+    private static final long NANOS_PER_SECOND = 1_000_000_000L;\n+    public static final long LONG_MAX_SECONDS = Long.MAX_VALUE / NANOS_PER_SECOND * NANOS_PER_SECOND;\n+    public static final int LONG_MAX_NANOSECONDS = (int) (Long.MAX_VALUE % NANOS_PER_SECOND);\n+\n+    public static boolean isValidTimeStamp(Timestamp endTimeStamp) {\n+        if (endTimeStamp == null) {", "originalCommit": "632472cce196428e645c256de25e9c9d1834f1a7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzc5ODU3Mg==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/523#discussion_r377798572", "bodyText": "File will be removed.", "author": "Nana-EC", "createdAt": "2020-02-11T17:53:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzcyMzgzNg=="}], "type": "inlineReview"}, {"oid": "5e37b4b9324b22adeac16a599f05ef503ba42c60", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/5e37b4b9324b22adeac16a599f05ef503ba42c60", "message": "Addreesed feedback. Moved isLongSupportedTimeStamp logic into ProtoUtil\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2020-02-11T17:52:53Z", "type": "commit"}, {"oid": "442bd4c98a6903c9823fc5f01723e1ceb6705987", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/442bd4c98a6903c9823fc5f01723e1ceb6705987", "message": "Merge branch 'master' into handlehcstimequeryoverflow\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2020-02-11T17:54:39Z", "type": "commit"}, {"oid": "eb5c6aeb4a562d7315247e42e999aad97131270e", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/eb5c6aeb4a562d7315247e42e999aad97131270e", "message": "Captured all cases of timestamp ranges, updated controller and tests\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2020-02-11T21:28:03Z", "type": "commit"}, {"oid": "60b78ebfbfb47a4820ee52fe6a3a679199baa633", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/60b78ebfbfb47a4820ee52fe6a3a679199baa633", "message": "Updated ConsensusControllerTest with below and above boundary cases for start and end times\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2020-02-11T21:51:58Z", "type": "commit"}, {"oid": "fac603fcbc54bbafe96b40e06bc15790b9ec8071", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/fac603fcbc54bbafe96b40e06bc15790b9ec8071", "message": "Simplified overflow chek by deferring to validator scenarios\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2020-02-12T05:57:22Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODM3MzY5NA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/523#discussion_r378373694", "bodyText": "Don't need to re-parse timestamp. Also can reduce if else to ternary:\nbuilder.startTime(startInstant.isBefore(Instant.EPOCH) ? Instant.EPOCH : startInstant);", "author": "steven-sheehy", "createdAt": "2020-02-12T16:41:53Z", "path": "hedera-mirror-grpc/src/main/java/com/hedera/mirror/grpc/controller/ConsensusController.java", "diffHunk": "@@ -72,11 +74,25 @@ private TopicMessageFilter toFilter(ConsensusTopicQuery query) {\n                 .topicNum((int) query.getTopicID().getTopicNum());\n \n         if (query.hasConsensusStartTime()) {\n-            builder.startTime(ProtoUtil.fromTimestamp(query.getConsensusStartTime()));\n+            Timestamp startTimeStamp = query.getConsensusStartTime();\n+            Instant startInstant = ProtoUtil.fromTimestamp(startTimeStamp);\n+\n+            if (startInstant.isBefore(Instant.EPOCH)) {\n+                builder.startTime(Instant.EPOCH);\n+            } else {\n+                builder.startTime(ProtoUtil.fromTimestamp(startTimeStamp));", "originalCommit": "fac603fcbc54bbafe96b40e06bc15790b9ec8071", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "60cb5bf1cfecd12b08f9d11b54964355419b745e", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/60cb5bf1cfecd12b08f9d11b54964355419b745e", "message": "Simplified check and fixed never ending test\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2020-02-12T18:35:14Z", "type": "commit"}, {"oid": "d4cff7ec7e16116cbd2d2ff14ca23efe355fe8d1", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/d4cff7ec7e16116cbd2d2ff14ca23efe355fe8d1", "message": "Centralized LONG_MAX_INSTANT, added more InstantToLongConverter tests and removed offending long running test\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2020-02-12T19:20:40Z", "type": "commit"}, {"oid": "8b14c14e2213124a4f2a88f15bc0fb8e8b68e656", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/8b14c14e2213124a4f2a88f15bc0fb8e8b68e656", "message": "Fixed offending tests causing long run\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2020-02-12T22:20:46Z", "type": "commit"}]}