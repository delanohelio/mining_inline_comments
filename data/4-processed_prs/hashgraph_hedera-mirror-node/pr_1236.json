{"pr_number": 1236, "pr_title": "Fix address book update always updating 102 file", "pr_createdAt": "2020-11-06T22:47:08Z", "pr_url": "https://github.com/hashgraph/hedera-mirror-node/pull/1236", "timeline": [{"oid": "fa51c55d0b5f2017fcdaacaeb556bbbf8b3491c8", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/fa51c55d0b5f2017fcdaacaeb556bbbf8b3491c8", "message": "Fix address book update always updating 102 file\n\nSigned-off-by: Steven Sheehy <steven.sheehy@hedera.com>", "committedDate": "2020-11-06T22:45:22Z", "type": "commit"}, {"oid": "14f99940ac470f82d7efeca7a9037146af4a9920", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/14f99940ac470f82d7efeca7a9037146af4a9920", "message": "Add address book migration\n\nSigned-off-by: Steven Sheehy <steven.sheehy@hedera.com>", "committedDate": "2020-11-09T20:51:39Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDIwMzcyNw==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1236#discussion_r520203727", "bodyText": "For complete coverage we could add a test case where both a 101 and 102 are updated, or where only one of them is updated. In either case it would verify the other addressBook entry isn't modified.", "author": "Nana-EC", "createdAt": "2020-11-10T00:16:36Z", "path": "hedera-mirror-importer/src/test/java/com/hedera/mirror/importer/addressbook/AddressBookServiceImplTest.java", "diffHunk": "@@ -366,6 +367,32 @@ void verifyAddressBookEndPointsAreSet() {\n         assertThat(prevAddressBook.getEndConsensusTimestamp()).isNotNull();\n     }\n \n+    @Test\n+    void verify101AddressBookEndPointsAreSet() {\n+        byte[] addressBookBytes = UPDATED.toByteArray();\n+        update(addressBookBytes, 0L, false);\n+\n+        // assert current addressBook is updated\n+        AddressBook addressBook = addressBookRepository.findLatestAddressBook(1L, 101L).get();\n+        assertThat(addressBook.getEntries()).hasSize(UPDATED.getNodeAddressCount());\n+        assertThat(addressBook.getStartConsensusTimestamp()).isNotNull();\n+        assertThat(addressBook.getEndConsensusTimestamp()).isNull();\n+\n+        byte[] newAddressBookBytes = FINAL.toByteArray();\n+        update(newAddressBookBytes, 10L, false);\n+        AddressBook newAddressBook = addressBookRepository.findLatestAddressBook(11L, 101L).get();\n+        assertAddressBook(newAddressBook, FINAL);\n+        assertAddressBookData(newAddressBookBytes, 10);\n+\n+        assertEquals(2, addressBookRepository.count());\n+        assertEquals(UPDATED.getNodeAddressCount() + FINAL.getNodeAddressCount(), addressBookEntryRepository.count());\n+\n+        // verify end consensus timestamp was set for previous address book\n+        AddressBook prevAddressBook = addressBookRepository.findById(1L).get();\n+        assertThat(prevAddressBook.getStartConsensusTimestamp()).isNotNull();\n+        assertThat(prevAddressBook.getEndConsensusTimestamp()).isNotNull();\n+    }\n+", "originalCommit": "14f99940ac470f82d7efeca7a9037146af4a9920", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDcyNjg4MA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1236#discussion_r520726880", "bodyText": "I added a verify101DoesntUpdate102 test case", "author": "steven-sheehy", "createdAt": "2020-11-10T17:08:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDIwMzcyNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDIwNTQ2Mg==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1236#discussion_r520205462", "bodyText": "Is there an easy way to incorporate the migration into an integration test like we do for the java migrations?\nThen you could have some test coverage for a mixture of scenarios\n\nOnly one 101 unclosed address book and one 102 incorrectly closed file\nA few 101 unclosed address books  with and a few 102 addressbooks files of which a few were incorrectly closed", "author": "Nana-EC", "createdAt": "2020-11-10T00:21:48Z", "path": "hedera-mirror-importer/src/main/resources/db/migration/V1.31.0__fix_address_book_102.sql", "diffHunk": "@@ -0,0 +1,7 @@\n+-- Recalculate all end timestamps since we accidentally set the 0.0.102 end timestamp instead of the 0.0.101's in GH1229\n+update address_book as ab", "originalCommit": "14f99940ac470f82d7efeca7a9037146af4a9920", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDcyNjY0MA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1236#discussion_r520726640", "bodyText": "It's not easy to test migrations. It requires an application context refresh (slowing overall test execution), a custom cleanup script to not break in the future and to only use raw SQL.\nIn this particular case since there's no DDL statements, we can get away with manually invoking the sql. I added a test case that does that.", "author": "steven-sheehy", "createdAt": "2020-11-10T17:07:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDIwNTQ2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDc5OTUzMQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1236#discussion_r520799531", "bodyText": "Gotcha. If this was more complex I would have suggested making it a java migration so testing would be made easier also.\nTests you added are satisfactory", "author": "Nana-EC", "createdAt": "2020-11-10T18:56:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDIwNTQ2Mg=="}], "type": "inlineReview"}, {"oid": "9476ffaba33b906c37f995604d38707829359f3d", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/9476ffaba33b906c37f995604d38707829359f3d", "message": "Address review feedback\n\nSigned-off-by: Steven Sheehy <steven.sheehy@hedera.com>", "committedDate": "2020-11-10T17:05:10Z", "type": "commit"}]}