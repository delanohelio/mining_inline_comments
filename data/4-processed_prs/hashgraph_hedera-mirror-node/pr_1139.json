{"pr_number": 1139, "pr_title": "Add transaction type filter to REST API ", "pr_createdAt": "2020-10-17T20:07:13Z", "pr_url": "https://github.com/hashgraph/hedera-mirror-node/pull/1139", "timeline": [{"oid": "657fe8525ad3ced1bf1e1b06358136881916a1b7", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/657fe8525ad3ced1bf1e1b06358136881916a1b7", "message": "REST: Enable Transaction Type Filter\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2020-10-17T19:59:04Z", "type": "commit"}, {"oid": "ce492868ddde039e6a91e8713d9f511ac76940bb", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/ce492868ddde039e6a91e8713d9f511ac76940bb", "message": "Cleaned up and Corrected getTransactionTypeQuery check for negative cases\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2020-10-19T17:21:02Z", "type": "commit"}, {"oid": "c4567666cab1901306b52106d015b2d196d9b5c4", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/c4567666cab1901306b52106d015b2d196d9b5c4", "message": "Remove unused isValidFilterKey\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2020-10-19T17:26:33Z", "type": "commit"}, {"oid": "03a52a2a583fb9e7dab26d8efe28c141453485ac", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/03a52a2a583fb9e7dab26d8efe28c141453485ac", "message": "Removed unused items from transactions.js\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2020-10-19T18:10:05Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODU4MzY0OA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1139#discussion_r508583648", "bodyText": "Is it possible to load these from the table lazily on first request and cache it instead of hardcoding here?", "author": "steven-sheehy", "createdAt": "2020-10-20T14:58:54Z", "path": "hedera-mirror-rest/constants.js", "diffHunk": "@@ -94,17 +101,58 @@ const defaultBucketNames = {\n \n const recordStreamPrefix = 'recordstreams/record';\n \n+const transactionTypes = {\n+  UNKNOWN: -1,", "originalCommit": "03a52a2a583fb9e7dab26d8efe28c141453485ac", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODgwNjQxMw==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1139#discussion_r508806413", "bodyText": "Yeah, I can add another service for transaction types", "author": "Nana-EC", "createdAt": "2020-10-20T20:07:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODU4MzY0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODgzMTY4Ng==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1139#discussion_r508831686", "bodyText": "Not a few line change and would add tests to make sure db query is good.\nI'm proposing to move this to a v0.22 ticket to unblock v0.21", "author": "Nana-EC", "createdAt": "2020-10-20T20:52:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODU4MzY0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODg3MzcyMQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1139#discussion_r508873721", "bodyText": "Moving this item to next release is fine", "author": "steven-sheehy", "createdAt": "2020-10-20T22:18:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODU4MzY0OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODU5NjE4NA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1139#discussion_r508596184", "bodyText": "I don't think it's a good user experience to silently fail and return all transactions if they mistype the transaction type. We should return an error if it's not one of the known types so they can adjust their criteria. Add a test for this scenario as well.", "author": "steven-sheehy", "createdAt": "2020-10-20T15:14:39Z", "path": "hedera-mirror-rest/utils.js", "diffHunk": "@@ -724,6 +733,22 @@ const parsePublicKey = (publicKey) => {\n   return decodedKey == null ? publicKey : decodedKey;\n };\n \n+const getTransactionTypeQuery = (parsedQueryParams) => {\n+  if (_.isNil(parsedQueryParams)) {\n+    return '';\n+  }\n+\n+  const transactionType = parsedQueryParams[constants.filterKeys.TRANSACTION_TYPE];\n+\n+  if (isValidTransactionType(transactionType)) {\n+    return `${constants.transactionColumns.TYPE}${opsMap.eq}${\n+      constants.transactionTypes[transactionType.toUpperCase()]\n+    }`;\n+  }\n+\n+  return '';", "originalCommit": "03a52a2a583fb9e7dab26d8efe28c141453485ac", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODc1OTg5Mw==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1139#discussion_r508759893", "bodyText": "Good point.\nWill throw", "author": "Nana-EC", "createdAt": "2020-10-20T18:45:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODU5NjE4NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODU5NzQzMA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1139#discussion_r508597430", "bodyText": "Add a lower case test.", "author": "steven-sheehy", "createdAt": "2020-10-20T15:16:12Z", "path": "hedera-mirror-rest/__tests__/utils.test.js", "diffHunk": "@@ -228,6 +228,33 @@ describe('Utils isValidNum tests', () => {\n   });\n });\n \n+describe('Utils isValidTransactionType tests', () => {\n+  test('Verify invalid for null', () => {\n+    expect(utils.isValidTransactionType(null)).toBe(false);\n+  });\n+  test('Verify invalid for empty input', () => {\n+    expect(utils.isValidTransactionType('')).toBe(false);\n+  });\n+  test('Verify invalid for invalid input', () => {\n+    expect(utils.isValidTransactionType('1234567890.000000001')).toBe(false);\n+  });\n+  test('Verify invalid for entity format shard', () => {\n+    expect(utils.isValidTransactionType('1.0.1')).toBe(false);\n+  });\n+  test('Verify invalid for negative num', () => {\n+    expect(utils.isValidTransactionType(-10)).toBe(false);\n+  });\n+  test('Verify invalid for 0', () => {\n+    expect(utils.isValidTransactionType(0)).toBe(false);\n+  });\n+  test('Verify valid for valid CONSENSUSSUBMITMESSAGE transaction type', () => {\n+    expect(utils.isValidTransactionType('CONSENSUSSUBMITMESSAGE')).toBe(true);\n+  });\n+  test('Verify valid for valid TOKENTRANSFERS transaction type', () => {\n+    expect(utils.isValidTransactionType('TOKENTRANSFERS')).toBe(true);", "originalCommit": "03a52a2a583fb9e7dab26d8efe28c141453485ac", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODgzMzczNQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1139#discussion_r508833735", "bodyText": "Added", "author": "Nana-EC", "createdAt": "2020-10-20T20:56:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODU5NzQzMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODYxMDUwNw==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1139#discussion_r508610507", "bodyText": "Our naming is all over the map. Is this query param case sensitive? I think we need to use camel case transactionType to try to be consistent.", "author": "steven-sheehy", "createdAt": "2020-10-20T15:28:37Z", "path": "hedera-mirror-rest/constants.js", "diffHunk": "@@ -33,16 +34,22 @@ const filterKeys = {\n   TIMESTAMP: 'timestamp',\n   TOKENID: 'tokenId',\n   TOKEN_ID: 'token.id',\n-  TYPE: 'type',\n+  CREDIT_TYPE: 'type',\n+  TRANSACTION_TYPE: 'transactiontype',", "originalCommit": "03a52a2a583fb9e7dab26d8efe28c141453485ac", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODcxMzk5OQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1139#discussion_r508713999", "bodyText": "I think right now it is case sensitive based on filterValidityChecks()\nFor a url query we should probably make all the filter keys case-insensitive when matching.", "author": "Nana-EC", "createdAt": "2020-10-20T17:34:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODYxMDUwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODc1ODA5NA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1139#discussion_r508758094", "bodyText": "There's a few ways to do this in a clean and easy to scale fashion\n\nUse a middle ware to ensure an expected case\nUse an additional framework for clear request path and query param management. I think I have a ticket for this.\n\nEither case is a larger and out of scope of this item. So I'll open a ticket to address that separately.", "author": "Nana-EC", "createdAt": "2020-10-20T18:43:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODYxMDUwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODg2NjI0OA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1139#discussion_r508866248", "bodyText": "As discussed went with hardcoding transactionType for now", "author": "Nana-EC", "createdAt": "2020-10-20T22:00:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODYxMDUwNw=="}], "type": "inlineReview"}, {"oid": "8e50023f4a8d5a436a95477e7375c17e7edb30ee", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/8e50023f4a8d5a436a95477e7375c17e7edb30ee", "message": "Added initial case insensitive support for transaction type query and test\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2020-10-20T20:55:20Z", "type": "commit"}, {"oid": "85412ae3bb6f5fd60c89d60bab7033f72541bde4", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/85412ae3bb6f5fd60c89d60bab7033f72541bde4", "message": "Hard code transactionType and update spec\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2020-10-20T21:57:58Z", "type": "commit"}, {"oid": "4b2ec17a26965be1710cb9135e4c2b42f59f1f83", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/4b2ec17a26965be1710cb9135e4c2b42f59f1f83", "message": "Add invalid transaction type integration test\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2020-10-20T22:42:44Z", "type": "commit"}]}