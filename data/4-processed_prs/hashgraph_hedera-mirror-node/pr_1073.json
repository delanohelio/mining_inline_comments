{"pr_number": 1073, "pr_title": "HTS: DB schema changes", "pr_createdAt": "2020-09-22T20:05:09Z", "pr_url": "https://github.com/hashgraph/hedera-mirror-node/pull/1073", "timeline": [{"oid": "990a395428dc529b9501d988d14078cf27b64792", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/990a395428dc529b9501d988d14078cf27b64792", "message": "DB Schema CHanges to Support HTS\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2020-09-22T19:56:55Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzAzMjk1Ng==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1073#discussion_r493032956", "bodyText": "Should be on consensus_timestamp only\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 on token_transfer (token_id desc, account_id desc, consensus_timestamp desc);\n          \n          \n            \n                 on token_transfer (consensus_timestamp desc);", "author": "Nana-EC", "createdAt": "2020-09-22T21:04:51Z", "path": "hedera-mirror-importer/src/main/resources/db/migration/V1.30.1__hts_support.sql", "diffHunk": "@@ -0,0 +1,117 @@\n+-------------------\n+-- Support hts transactions\n+-------------------\n+\n+-- Add new token entity type\n+insert into t_entity_types (id, name) values (5, 'token');\n+\n+-- Add new hts transaction body types\n+insert into t_transaction_types (proto_id, name) values\n+    (28, 'UNCHECKEDSUBMIT'),\n+    (29, 'TOKENCREATE'),\n+    (30, 'TOKENTRANSFER'),\n+    (31, 'TOKENFREEZE'),\n+    (32, 'TOKENUNFREEZE'),\n+    (33, 'TOKENGRANTKYC'),\n+    (34, 'TOKENREVOKEKYC'),\n+    (35, 'TOKENDELETE'),\n+    (36, 'TOKENUPDATE'),\n+    (37, 'TOKENMINT'),\n+    (38, 'TOKENBURN'),\n+    (39, 'TOKENWIPE');\n+\n+-- Add hts transaction result types\n+insert into t_transaction_results (proto_id, result) values\n+    (165, 'ACCOUNT_FROZEN_FOR_TOKEN'),\n+    (166, 'TOKENS_PER_ACCOUNT_LIMIT_EXCEEDED'),\n+    (167, 'INVALID_TOKEN_ID'),\n+    (168, 'INVALID_TOKEN_DIVISIBILITY'),\n+    (169, 'INVALID_TOKEN_FLOAT'),\n+    (170, 'INVALID_TREASURY_ACCOUNT_FOR_TOKEN'),\n+    (171, 'INVALID_TOKEN_SYMBOL'),\n+    (172, 'TOKEN_HAS_NO_FREEZE_KEY'),\n+    (173, 'TRANSFERS_NOT_ZERO_SUM_FOR_TOKEN'),\n+    (174, 'MISSING_TOKEN_SYMBOL'),\n+    (175, 'TOKEN_SYMBOL_TOO_LONG'),\n+    (176, 'TOKEN_SYMBOL_ALREADY_IN_USE'),\n+    (177, 'INVALID_TOKEN_REF'),\n+    (178, 'ACCOUNT_KYC_NOT_GRANTED_FOR_TOKEN'),\n+    (179, 'TOKEN_HAS_NO_KYC_KEY'),\n+    (180, 'INSUFFICIENT_TOKEN_BALANCE'),\n+    (181, 'TOKEN_WAS_DELETED'),\n+    (182, 'TOKEN_HAS_NO_SUPPLY_KEY'),\n+    (183, 'TOKEN_HAS_NO_WIPE_KEY'),\n+    (184, 'INVALID_TOKEN_MINT_AMOUNT'),\n+    (185, 'INVALID_TOKEN_BURN_AMOUNT'),\n+    (186, 'ACCOUNT_HAS_NO_TOKEN_RELATIONSHIP'),\n+    (187, 'CANNOT_WIPE_TOKEN_TREASURY_ACCOUNT'),\n+    (188, 'INVALID_KYC_KEY'),\n+    (189, 'INVALID_WIPE_KEY'),\n+    (190, 'INVALID_FREEZE_KEY'),\n+    (191, 'INVALID_SUPPLY_KEY'),\n+    (192, 'INVALID_TOKEN_EXPIRY'),\n+    (193, 'TOKEN_HAS_EXPIRED'),\n+    (194, 'TOKEN_IS_IMMUTABlE');\n+\n+-- Add token table to hold token properties\n+create table if not exists token\n+(\n+    token_id            entity_id               primary key,\n+    create_timestamp    bigint                  not null,\n+    divisibility        bigint                  not null,\n+    freeze_default      boolean                 not null,\n+    freeze_key          bytea,\n+    initial_supply      bigint                  not null,\n+    kyc_default         boolean                 not null,\n+    kyc_key             bytea,\n+    modify_timestamp    bigint,\n+    supply_key          bytea,\n+    symbol              character varying(100)  not null,\n+    treasury_account_id entity_id               not null,\n+    wipe_key            bytea\n+);\n+\n+--- Add token_account table to capture token-account info such as frozen, kyc and wipe status\n+create table if not exists token_account\n+(\n+    id                  serial              primary key,\n+    account_id          entity_id           not null,\n+    create_timestamp    bigint              not null,\n+    frozen              boolean             not null,\n+    kyc                 boolean             not null,\n+    modify_timestamp    bigint              not null,\n+    token_id            entity_id           not null,\n+    wiped               boolean             not null default false\n+);\n+\n+create unique index if not exists token_account__token_account on token_account(token_id, account_id);\n+\n+create index if not exists token_account__token_account_timestamp\n+     on token_account (token_id desc, account_id desc, create_timestamp desc);\n+\n+--- Add token_balance table to capture token account balances\n+create table if not exists token_balance\n+(\n+    consensus_timestamp bigint              primary key not null,\n+    account_id          entity_id           not null,\n+    balance             bigint              not null,\n+    token_id            entity_id           not null\n+);\n+\n+create index if not exists token_balance__token_account_timestamp\n+     on token_balance (token_id desc, account_id desc, consensus_timestamp desc);\n+\n+--- Add token_transfer\n+create table if not exists token_transfer\n+(\n+    token_id            entity_id,\n+    account_id          entity_id,\n+    consensus_timestamp bigint,\n+    amount              hbar_tinybars\n+);\n+\n+create index if not exists token_transfer__timestamp\n+     on token_transfer (token_id desc, account_id desc, consensus_timestamp desc);", "originalCommit": "990a395428dc529b9501d988d14078cf27b64792", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzAzMzUwMA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1073#discussion_r493033500", "bodyText": "Thought I had removed this to be left for Importer tasks to add.\nWill remove", "author": "Nana-EC", "createdAt": "2020-09-22T21:05:59Z", "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/converter/TokenIdConverter.java", "diffHunk": "@@ -0,0 +1,35 @@\n+package com.hedera.mirror.importer.converter;\n+\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+\n+import javax.inject.Named;\n+import org.springframework.boot.context.properties.ConfigurationPropertiesBinding;\n+\n+import com.hedera.mirror.importer.domain.EntityTypeEnum;\n+\n+@Named\n+@javax.persistence.Converter\n+@ConfigurationPropertiesBinding\n+public class TokenIdConverter extends AbstractEntityIdConverter {", "originalCommit": "990a395428dc529b9501d988d14078cf27b64792", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzAzNzc2NA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1073#discussion_r493037764", "bodyText": "Audit timestamps are usual in past tense, like Spring JPA's Auditable interface. Would prefer created_timestamp and modified_timestamp", "author": "steven-sheehy", "createdAt": "2020-09-22T21:14:48Z", "path": "hedera-mirror-importer/src/main/resources/db/migration/V1.30.1__hts_support.sql", "diffHunk": "@@ -0,0 +1,117 @@\n+-------------------\n+-- Support hts transactions\n+-------------------\n+\n+-- Add new token entity type\n+insert into t_entity_types (id, name) values (5, 'token');\n+\n+-- Add new hts transaction body types\n+insert into t_transaction_types (proto_id, name) values\n+    (28, 'UNCHECKEDSUBMIT'),\n+    (29, 'TOKENCREATE'),\n+    (30, 'TOKENTRANSFER'),\n+    (31, 'TOKENFREEZE'),\n+    (32, 'TOKENUNFREEZE'),\n+    (33, 'TOKENGRANTKYC'),\n+    (34, 'TOKENREVOKEKYC'),\n+    (35, 'TOKENDELETE'),\n+    (36, 'TOKENUPDATE'),\n+    (37, 'TOKENMINT'),\n+    (38, 'TOKENBURN'),\n+    (39, 'TOKENWIPE');\n+\n+-- Add hts transaction result types\n+insert into t_transaction_results (proto_id, result) values\n+    (165, 'ACCOUNT_FROZEN_FOR_TOKEN'),\n+    (166, 'TOKENS_PER_ACCOUNT_LIMIT_EXCEEDED'),\n+    (167, 'INVALID_TOKEN_ID'),\n+    (168, 'INVALID_TOKEN_DIVISIBILITY'),\n+    (169, 'INVALID_TOKEN_FLOAT'),\n+    (170, 'INVALID_TREASURY_ACCOUNT_FOR_TOKEN'),\n+    (171, 'INVALID_TOKEN_SYMBOL'),\n+    (172, 'TOKEN_HAS_NO_FREEZE_KEY'),\n+    (173, 'TRANSFERS_NOT_ZERO_SUM_FOR_TOKEN'),\n+    (174, 'MISSING_TOKEN_SYMBOL'),\n+    (175, 'TOKEN_SYMBOL_TOO_LONG'),\n+    (176, 'TOKEN_SYMBOL_ALREADY_IN_USE'),\n+    (177, 'INVALID_TOKEN_REF'),\n+    (178, 'ACCOUNT_KYC_NOT_GRANTED_FOR_TOKEN'),\n+    (179, 'TOKEN_HAS_NO_KYC_KEY'),\n+    (180, 'INSUFFICIENT_TOKEN_BALANCE'),\n+    (181, 'TOKEN_WAS_DELETED'),\n+    (182, 'TOKEN_HAS_NO_SUPPLY_KEY'),\n+    (183, 'TOKEN_HAS_NO_WIPE_KEY'),\n+    (184, 'INVALID_TOKEN_MINT_AMOUNT'),\n+    (185, 'INVALID_TOKEN_BURN_AMOUNT'),\n+    (186, 'ACCOUNT_HAS_NO_TOKEN_RELATIONSHIP'),\n+    (187, 'CANNOT_WIPE_TOKEN_TREASURY_ACCOUNT'),\n+    (188, 'INVALID_KYC_KEY'),\n+    (189, 'INVALID_WIPE_KEY'),\n+    (190, 'INVALID_FREEZE_KEY'),\n+    (191, 'INVALID_SUPPLY_KEY'),\n+    (192, 'INVALID_TOKEN_EXPIRY'),\n+    (193, 'TOKEN_HAS_EXPIRED'),\n+    (194, 'TOKEN_IS_IMMUTABlE');\n+\n+-- Add token table to hold token properties\n+create table if not exists token\n+(\n+    token_id            entity_id               primary key,\n+    create_timestamp    bigint                  not null,", "originalCommit": "990a395428dc529b9501d988d14078cf27b64792", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzEwMTk1Nw==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1073#discussion_r493101957", "bodyText": "Updated", "author": "Nana-EC", "createdAt": "2020-09-23T00:12:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzAzNzc2NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzAzODI1Mg==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1073#discussion_r493038252", "bodyText": "modified_timestamp should be not null and default to created_timestamp via code. This is pretty standard logic.", "author": "steven-sheehy", "createdAt": "2020-09-22T21:15:41Z", "path": "hedera-mirror-importer/src/main/resources/db/migration/V1.30.1__hts_support.sql", "diffHunk": "@@ -0,0 +1,117 @@\n+-------------------\n+-- Support hts transactions\n+-------------------\n+\n+-- Add new token entity type\n+insert into t_entity_types (id, name) values (5, 'token');\n+\n+-- Add new hts transaction body types\n+insert into t_transaction_types (proto_id, name) values\n+    (28, 'UNCHECKEDSUBMIT'),\n+    (29, 'TOKENCREATE'),\n+    (30, 'TOKENTRANSFER'),\n+    (31, 'TOKENFREEZE'),\n+    (32, 'TOKENUNFREEZE'),\n+    (33, 'TOKENGRANTKYC'),\n+    (34, 'TOKENREVOKEKYC'),\n+    (35, 'TOKENDELETE'),\n+    (36, 'TOKENUPDATE'),\n+    (37, 'TOKENMINT'),\n+    (38, 'TOKENBURN'),\n+    (39, 'TOKENWIPE');\n+\n+-- Add hts transaction result types\n+insert into t_transaction_results (proto_id, result) values\n+    (165, 'ACCOUNT_FROZEN_FOR_TOKEN'),\n+    (166, 'TOKENS_PER_ACCOUNT_LIMIT_EXCEEDED'),\n+    (167, 'INVALID_TOKEN_ID'),\n+    (168, 'INVALID_TOKEN_DIVISIBILITY'),\n+    (169, 'INVALID_TOKEN_FLOAT'),\n+    (170, 'INVALID_TREASURY_ACCOUNT_FOR_TOKEN'),\n+    (171, 'INVALID_TOKEN_SYMBOL'),\n+    (172, 'TOKEN_HAS_NO_FREEZE_KEY'),\n+    (173, 'TRANSFERS_NOT_ZERO_SUM_FOR_TOKEN'),\n+    (174, 'MISSING_TOKEN_SYMBOL'),\n+    (175, 'TOKEN_SYMBOL_TOO_LONG'),\n+    (176, 'TOKEN_SYMBOL_ALREADY_IN_USE'),\n+    (177, 'INVALID_TOKEN_REF'),\n+    (178, 'ACCOUNT_KYC_NOT_GRANTED_FOR_TOKEN'),\n+    (179, 'TOKEN_HAS_NO_KYC_KEY'),\n+    (180, 'INSUFFICIENT_TOKEN_BALANCE'),\n+    (181, 'TOKEN_WAS_DELETED'),\n+    (182, 'TOKEN_HAS_NO_SUPPLY_KEY'),\n+    (183, 'TOKEN_HAS_NO_WIPE_KEY'),\n+    (184, 'INVALID_TOKEN_MINT_AMOUNT'),\n+    (185, 'INVALID_TOKEN_BURN_AMOUNT'),\n+    (186, 'ACCOUNT_HAS_NO_TOKEN_RELATIONSHIP'),\n+    (187, 'CANNOT_WIPE_TOKEN_TREASURY_ACCOUNT'),\n+    (188, 'INVALID_KYC_KEY'),\n+    (189, 'INVALID_WIPE_KEY'),\n+    (190, 'INVALID_FREEZE_KEY'),\n+    (191, 'INVALID_SUPPLY_KEY'),\n+    (192, 'INVALID_TOKEN_EXPIRY'),\n+    (193, 'TOKEN_HAS_EXPIRED'),\n+    (194, 'TOKEN_IS_IMMUTABlE');\n+\n+-- Add token table to hold token properties\n+create table if not exists token\n+(\n+    token_id            entity_id               primary key,\n+    create_timestamp    bigint                  not null,\n+    divisibility        bigint                  not null,\n+    freeze_default      boolean                 not null,\n+    freeze_key          bytea,\n+    initial_supply      bigint                  not null,\n+    kyc_default         boolean                 not null,\n+    kyc_key             bytea,\n+    modify_timestamp    bigint,", "originalCommit": "990a395428dc529b9501d988d14078cf27b64792", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzEwMjMwMg==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1073#discussion_r493102302", "bodyText": "Good catch", "author": "Nana-EC", "createdAt": "2020-09-23T00:13:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzAzODI1Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzAzOTExMw==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1073#discussion_r493039113", "bodyText": "Can these two have an explicit default? I'm pretty sure since it's a required boolean that it will be defaulted to false implicitly so good to put an explicit.", "author": "steven-sheehy", "createdAt": "2020-09-22T21:17:26Z", "path": "hedera-mirror-importer/src/main/resources/db/migration/V1.30.1__hts_support.sql", "diffHunk": "@@ -0,0 +1,117 @@\n+-------------------\n+-- Support hts transactions\n+-------------------\n+\n+-- Add new token entity type\n+insert into t_entity_types (id, name) values (5, 'token');\n+\n+-- Add new hts transaction body types\n+insert into t_transaction_types (proto_id, name) values\n+    (28, 'UNCHECKEDSUBMIT'),\n+    (29, 'TOKENCREATE'),\n+    (30, 'TOKENTRANSFER'),\n+    (31, 'TOKENFREEZE'),\n+    (32, 'TOKENUNFREEZE'),\n+    (33, 'TOKENGRANTKYC'),\n+    (34, 'TOKENREVOKEKYC'),\n+    (35, 'TOKENDELETE'),\n+    (36, 'TOKENUPDATE'),\n+    (37, 'TOKENMINT'),\n+    (38, 'TOKENBURN'),\n+    (39, 'TOKENWIPE');\n+\n+-- Add hts transaction result types\n+insert into t_transaction_results (proto_id, result) values\n+    (165, 'ACCOUNT_FROZEN_FOR_TOKEN'),\n+    (166, 'TOKENS_PER_ACCOUNT_LIMIT_EXCEEDED'),\n+    (167, 'INVALID_TOKEN_ID'),\n+    (168, 'INVALID_TOKEN_DIVISIBILITY'),\n+    (169, 'INVALID_TOKEN_FLOAT'),\n+    (170, 'INVALID_TREASURY_ACCOUNT_FOR_TOKEN'),\n+    (171, 'INVALID_TOKEN_SYMBOL'),\n+    (172, 'TOKEN_HAS_NO_FREEZE_KEY'),\n+    (173, 'TRANSFERS_NOT_ZERO_SUM_FOR_TOKEN'),\n+    (174, 'MISSING_TOKEN_SYMBOL'),\n+    (175, 'TOKEN_SYMBOL_TOO_LONG'),\n+    (176, 'TOKEN_SYMBOL_ALREADY_IN_USE'),\n+    (177, 'INVALID_TOKEN_REF'),\n+    (178, 'ACCOUNT_KYC_NOT_GRANTED_FOR_TOKEN'),\n+    (179, 'TOKEN_HAS_NO_KYC_KEY'),\n+    (180, 'INSUFFICIENT_TOKEN_BALANCE'),\n+    (181, 'TOKEN_WAS_DELETED'),\n+    (182, 'TOKEN_HAS_NO_SUPPLY_KEY'),\n+    (183, 'TOKEN_HAS_NO_WIPE_KEY'),\n+    (184, 'INVALID_TOKEN_MINT_AMOUNT'),\n+    (185, 'INVALID_TOKEN_BURN_AMOUNT'),\n+    (186, 'ACCOUNT_HAS_NO_TOKEN_RELATIONSHIP'),\n+    (187, 'CANNOT_WIPE_TOKEN_TREASURY_ACCOUNT'),\n+    (188, 'INVALID_KYC_KEY'),\n+    (189, 'INVALID_WIPE_KEY'),\n+    (190, 'INVALID_FREEZE_KEY'),\n+    (191, 'INVALID_SUPPLY_KEY'),\n+    (192, 'INVALID_TOKEN_EXPIRY'),\n+    (193, 'TOKEN_HAS_EXPIRED'),\n+    (194, 'TOKEN_IS_IMMUTABlE');\n+\n+-- Add token table to hold token properties\n+create table if not exists token\n+(\n+    token_id            entity_id               primary key,\n+    create_timestamp    bigint                  not null,\n+    divisibility        bigint                  not null,\n+    freeze_default      boolean                 not null,\n+    freeze_key          bytea,\n+    initial_supply      bigint                  not null,\n+    kyc_default         boolean                 not null,\n+    kyc_key             bytea,\n+    modify_timestamp    bigint,\n+    supply_key          bytea,\n+    symbol              character varying(100)  not null,\n+    treasury_account_id entity_id               not null,\n+    wipe_key            bytea\n+);\n+\n+--- Add token_account table to capture token-account info such as frozen, kyc and wipe status\n+create table if not exists token_account\n+(\n+    id                  serial              primary key,\n+    account_id          entity_id           not null,\n+    create_timestamp    bigint              not null,\n+    frozen              boolean             not null,", "originalCommit": "990a395428dc529b9501d988d14078cf27b64792", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzA5OTM5NQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1073#discussion_r493099395", "bodyText": "It wouldn't be safe to set a default for kyc and frozen since the token itself defines the default that should be used, and it won't be the same for all tokens and it won't remain the same after creation.\nToken.freeze_default determines the first value token_account.frozen should take.\nA non null kyc_key in token implies token_account.kyc first value is true, its absence implies false.\nAlso the token details can change, as such frozen and kyc values need to be determined at TokenCreate insert time", "author": "Nana-EC", "createdAt": "2020-09-23T00:03:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzAzOTExMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzY4MjM2Nw==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1073#discussion_r493682367", "bodyText": "I think you're misunderstanding. It already is setting a default. You have a non-null boolean, it has to have a value by its very definition. It's either setting the default via code (if using primitive type or boxed with a non-null value) or if code is passing null the database will default to false for these fields. My comment is that we should go ahead and set an explicit default", "author": "steven-sheehy", "createdAt": "2020-09-23T15:22:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzAzOTExMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzczNDA3Nw==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1073#discussion_r493734077", "bodyText": "Gotcha, will set false then", "author": "Nana-EC", "createdAt": "2020-09-23T16:36:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzAzOTExMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzA0MjMxOQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1073#discussion_r493042319", "bodyText": "This index's fields are identical to the one above.", "author": "steven-sheehy", "createdAt": "2020-09-22T21:24:08Z", "path": "hedera-mirror-importer/src/main/resources/db/migration/V1.30.1__hts_support.sql", "diffHunk": "@@ -0,0 +1,117 @@\n+-------------------\n+-- Support hts transactions\n+-------------------\n+\n+-- Add new token entity type\n+insert into t_entity_types (id, name) values (5, 'token');\n+\n+-- Add new hts transaction body types\n+insert into t_transaction_types (proto_id, name) values\n+    (28, 'UNCHECKEDSUBMIT'),\n+    (29, 'TOKENCREATE'),\n+    (30, 'TOKENTRANSFER'),\n+    (31, 'TOKENFREEZE'),\n+    (32, 'TOKENUNFREEZE'),\n+    (33, 'TOKENGRANTKYC'),\n+    (34, 'TOKENREVOKEKYC'),\n+    (35, 'TOKENDELETE'),\n+    (36, 'TOKENUPDATE'),\n+    (37, 'TOKENMINT'),\n+    (38, 'TOKENBURN'),\n+    (39, 'TOKENWIPE');\n+\n+-- Add hts transaction result types\n+insert into t_transaction_results (proto_id, result) values\n+    (165, 'ACCOUNT_FROZEN_FOR_TOKEN'),\n+    (166, 'TOKENS_PER_ACCOUNT_LIMIT_EXCEEDED'),\n+    (167, 'INVALID_TOKEN_ID'),\n+    (168, 'INVALID_TOKEN_DIVISIBILITY'),\n+    (169, 'INVALID_TOKEN_FLOAT'),\n+    (170, 'INVALID_TREASURY_ACCOUNT_FOR_TOKEN'),\n+    (171, 'INVALID_TOKEN_SYMBOL'),\n+    (172, 'TOKEN_HAS_NO_FREEZE_KEY'),\n+    (173, 'TRANSFERS_NOT_ZERO_SUM_FOR_TOKEN'),\n+    (174, 'MISSING_TOKEN_SYMBOL'),\n+    (175, 'TOKEN_SYMBOL_TOO_LONG'),\n+    (176, 'TOKEN_SYMBOL_ALREADY_IN_USE'),\n+    (177, 'INVALID_TOKEN_REF'),\n+    (178, 'ACCOUNT_KYC_NOT_GRANTED_FOR_TOKEN'),\n+    (179, 'TOKEN_HAS_NO_KYC_KEY'),\n+    (180, 'INSUFFICIENT_TOKEN_BALANCE'),\n+    (181, 'TOKEN_WAS_DELETED'),\n+    (182, 'TOKEN_HAS_NO_SUPPLY_KEY'),\n+    (183, 'TOKEN_HAS_NO_WIPE_KEY'),\n+    (184, 'INVALID_TOKEN_MINT_AMOUNT'),\n+    (185, 'INVALID_TOKEN_BURN_AMOUNT'),\n+    (186, 'ACCOUNT_HAS_NO_TOKEN_RELATIONSHIP'),\n+    (187, 'CANNOT_WIPE_TOKEN_TREASURY_ACCOUNT'),\n+    (188, 'INVALID_KYC_KEY'),\n+    (189, 'INVALID_WIPE_KEY'),\n+    (190, 'INVALID_FREEZE_KEY'),\n+    (191, 'INVALID_SUPPLY_KEY'),\n+    (192, 'INVALID_TOKEN_EXPIRY'),\n+    (193, 'TOKEN_HAS_EXPIRED'),\n+    (194, 'TOKEN_IS_IMMUTABlE');\n+\n+-- Add token table to hold token properties\n+create table if not exists token\n+(\n+    token_id            entity_id               primary key,\n+    create_timestamp    bigint                  not null,\n+    divisibility        bigint                  not null,\n+    freeze_default      boolean                 not null,\n+    freeze_key          bytea,\n+    initial_supply      bigint                  not null,\n+    kyc_default         boolean                 not null,\n+    kyc_key             bytea,\n+    modify_timestamp    bigint,\n+    supply_key          bytea,\n+    symbol              character varying(100)  not null,\n+    treasury_account_id entity_id               not null,\n+    wipe_key            bytea\n+);\n+\n+--- Add token_account table to capture token-account info such as frozen, kyc and wipe status\n+create table if not exists token_account\n+(\n+    id                  serial              primary key,\n+    account_id          entity_id           not null,\n+    create_timestamp    bigint              not null,\n+    frozen              boolean             not null,\n+    kyc                 boolean             not null,\n+    modify_timestamp    bigint              not null,\n+    token_id            entity_id           not null,\n+    wiped               boolean             not null default false\n+);\n+\n+create unique index if not exists token_account__token_account on token_account(token_id, account_id);\n+\n+create index if not exists token_account__token_account_timestamp\n+     on token_account (token_id desc, account_id desc, create_timestamp desc);\n+\n+--- Add token_balance table to capture token account balances\n+create table if not exists token_balance\n+(\n+    consensus_timestamp bigint              primary key not null,\n+    account_id          entity_id           not null,\n+    balance             bigint              not null,\n+    token_id            entity_id           not null\n+);\n+\n+create index if not exists token_balance__token_account_timestamp\n+     on token_balance (token_id desc, account_id desc, consensus_timestamp desc);\n+\n+--- Add token_transfer\n+create table if not exists token_transfer\n+(\n+    token_id            entity_id,\n+    account_id          entity_id,\n+    consensus_timestamp bigint,\n+    amount              hbar_tinybars\n+);\n+\n+create index if not exists token_transfer__timestamp\n+     on token_transfer (token_id desc, account_id desc, consensus_timestamp desc);\n+\n+create index if not exists token_transfer__token_account_timestamp", "originalCommit": "990a395428dc529b9501d988d14078cf27b64792", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzEwMjM1NA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1073#discussion_r493102354", "bodyText": "Yeah caught it in my review also.  Should just be consensus_timestamp, updated", "author": "Nana-EC", "createdAt": "2020-09-23T00:13:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzA0MjMxOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzA0MzUzNg==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1073#discussion_r493043536", "bodyText": "Are we sure this index is needed? It's a superset of the other index making it pretty wasteful.", "author": "steven-sheehy", "createdAt": "2020-09-22T21:26:55Z", "path": "hedera-mirror-importer/src/main/resources/db/migration/V1.30.1__hts_support.sql", "diffHunk": "@@ -0,0 +1,117 @@\n+-------------------\n+-- Support hts transactions\n+-------------------\n+\n+-- Add new token entity type\n+insert into t_entity_types (id, name) values (5, 'token');\n+\n+-- Add new hts transaction body types\n+insert into t_transaction_types (proto_id, name) values\n+    (28, 'UNCHECKEDSUBMIT'),\n+    (29, 'TOKENCREATE'),\n+    (30, 'TOKENTRANSFER'),\n+    (31, 'TOKENFREEZE'),\n+    (32, 'TOKENUNFREEZE'),\n+    (33, 'TOKENGRANTKYC'),\n+    (34, 'TOKENREVOKEKYC'),\n+    (35, 'TOKENDELETE'),\n+    (36, 'TOKENUPDATE'),\n+    (37, 'TOKENMINT'),\n+    (38, 'TOKENBURN'),\n+    (39, 'TOKENWIPE');\n+\n+-- Add hts transaction result types\n+insert into t_transaction_results (proto_id, result) values\n+    (165, 'ACCOUNT_FROZEN_FOR_TOKEN'),\n+    (166, 'TOKENS_PER_ACCOUNT_LIMIT_EXCEEDED'),\n+    (167, 'INVALID_TOKEN_ID'),\n+    (168, 'INVALID_TOKEN_DIVISIBILITY'),\n+    (169, 'INVALID_TOKEN_FLOAT'),\n+    (170, 'INVALID_TREASURY_ACCOUNT_FOR_TOKEN'),\n+    (171, 'INVALID_TOKEN_SYMBOL'),\n+    (172, 'TOKEN_HAS_NO_FREEZE_KEY'),\n+    (173, 'TRANSFERS_NOT_ZERO_SUM_FOR_TOKEN'),\n+    (174, 'MISSING_TOKEN_SYMBOL'),\n+    (175, 'TOKEN_SYMBOL_TOO_LONG'),\n+    (176, 'TOKEN_SYMBOL_ALREADY_IN_USE'),\n+    (177, 'INVALID_TOKEN_REF'),\n+    (178, 'ACCOUNT_KYC_NOT_GRANTED_FOR_TOKEN'),\n+    (179, 'TOKEN_HAS_NO_KYC_KEY'),\n+    (180, 'INSUFFICIENT_TOKEN_BALANCE'),\n+    (181, 'TOKEN_WAS_DELETED'),\n+    (182, 'TOKEN_HAS_NO_SUPPLY_KEY'),\n+    (183, 'TOKEN_HAS_NO_WIPE_KEY'),\n+    (184, 'INVALID_TOKEN_MINT_AMOUNT'),\n+    (185, 'INVALID_TOKEN_BURN_AMOUNT'),\n+    (186, 'ACCOUNT_HAS_NO_TOKEN_RELATIONSHIP'),\n+    (187, 'CANNOT_WIPE_TOKEN_TREASURY_ACCOUNT'),\n+    (188, 'INVALID_KYC_KEY'),\n+    (189, 'INVALID_WIPE_KEY'),\n+    (190, 'INVALID_FREEZE_KEY'),\n+    (191, 'INVALID_SUPPLY_KEY'),\n+    (192, 'INVALID_TOKEN_EXPIRY'),\n+    (193, 'TOKEN_HAS_EXPIRED'),\n+    (194, 'TOKEN_IS_IMMUTABlE');\n+\n+-- Add token table to hold token properties\n+create table if not exists token\n+(\n+    token_id            entity_id               primary key,\n+    create_timestamp    bigint                  not null,\n+    divisibility        bigint                  not null,\n+    freeze_default      boolean                 not null,\n+    freeze_key          bytea,\n+    initial_supply      bigint                  not null,\n+    kyc_default         boolean                 not null,\n+    kyc_key             bytea,\n+    modify_timestamp    bigint,\n+    supply_key          bytea,\n+    symbol              character varying(100)  not null,\n+    treasury_account_id entity_id               not null,\n+    wipe_key            bytea\n+);\n+\n+--- Add token_account table to capture token-account info such as frozen, kyc and wipe status\n+create table if not exists token_account\n+(\n+    id                  serial              primary key,\n+    account_id          entity_id           not null,\n+    create_timestamp    bigint              not null,\n+    frozen              boolean             not null,\n+    kyc                 boolean             not null,\n+    modify_timestamp    bigint              not null,\n+    token_id            entity_id           not null,\n+    wiped               boolean             not null default false\n+);\n+\n+create unique index if not exists token_account__token_account on token_account(token_id, account_id);\n+\n+create index if not exists token_account__token_account_timestamp", "originalCommit": "990a395428dc529b9501d988d14078cf27b64792", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzEwMjM3NA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1073#discussion_r493102374", "bodyText": "Yeah good point. Can remove for now.", "author": "Nana-EC", "createdAt": "2020-09-23T00:13:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzA0MzUzNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzA3MTgyMQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1073#discussion_r493071821", "bodyText": "Add associated\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                account_id          entity_id           not null,\n          \n          \n            \n                account_id          entity_id           not null,\n          \n          \n            \n                associated          boolean           not null,", "author": "Nana-EC", "createdAt": "2020-09-22T22:36:23Z", "path": "hedera-mirror-importer/src/main/resources/db/migration/V1.30.1__hts_support.sql", "diffHunk": "@@ -0,0 +1,117 @@\n+-------------------\n+-- Support hts transactions\n+-------------------\n+\n+-- Add new token entity type\n+insert into t_entity_types (id, name) values (5, 'token');\n+\n+-- Add new hts transaction body types\n+insert into t_transaction_types (proto_id, name) values\n+    (28, 'UNCHECKEDSUBMIT'),\n+    (29, 'TOKENCREATE'),\n+    (30, 'TOKENTRANSFER'),\n+    (31, 'TOKENFREEZE'),\n+    (32, 'TOKENUNFREEZE'),\n+    (33, 'TOKENGRANTKYC'),\n+    (34, 'TOKENREVOKEKYC'),\n+    (35, 'TOKENDELETE'),\n+    (36, 'TOKENUPDATE'),\n+    (37, 'TOKENMINT'),\n+    (38, 'TOKENBURN'),\n+    (39, 'TOKENWIPE');\n+\n+-- Add hts transaction result types\n+insert into t_transaction_results (proto_id, result) values\n+    (165, 'ACCOUNT_FROZEN_FOR_TOKEN'),\n+    (166, 'TOKENS_PER_ACCOUNT_LIMIT_EXCEEDED'),\n+    (167, 'INVALID_TOKEN_ID'),\n+    (168, 'INVALID_TOKEN_DIVISIBILITY'),\n+    (169, 'INVALID_TOKEN_FLOAT'),\n+    (170, 'INVALID_TREASURY_ACCOUNT_FOR_TOKEN'),\n+    (171, 'INVALID_TOKEN_SYMBOL'),\n+    (172, 'TOKEN_HAS_NO_FREEZE_KEY'),\n+    (173, 'TRANSFERS_NOT_ZERO_SUM_FOR_TOKEN'),\n+    (174, 'MISSING_TOKEN_SYMBOL'),\n+    (175, 'TOKEN_SYMBOL_TOO_LONG'),\n+    (176, 'TOKEN_SYMBOL_ALREADY_IN_USE'),\n+    (177, 'INVALID_TOKEN_REF'),\n+    (178, 'ACCOUNT_KYC_NOT_GRANTED_FOR_TOKEN'),\n+    (179, 'TOKEN_HAS_NO_KYC_KEY'),\n+    (180, 'INSUFFICIENT_TOKEN_BALANCE'),\n+    (181, 'TOKEN_WAS_DELETED'),\n+    (182, 'TOKEN_HAS_NO_SUPPLY_KEY'),\n+    (183, 'TOKEN_HAS_NO_WIPE_KEY'),\n+    (184, 'INVALID_TOKEN_MINT_AMOUNT'),\n+    (185, 'INVALID_TOKEN_BURN_AMOUNT'),\n+    (186, 'ACCOUNT_HAS_NO_TOKEN_RELATIONSHIP'),\n+    (187, 'CANNOT_WIPE_TOKEN_TREASURY_ACCOUNT'),\n+    (188, 'INVALID_KYC_KEY'),\n+    (189, 'INVALID_WIPE_KEY'),\n+    (190, 'INVALID_FREEZE_KEY'),\n+    (191, 'INVALID_SUPPLY_KEY'),\n+    (192, 'INVALID_TOKEN_EXPIRY'),\n+    (193, 'TOKEN_HAS_EXPIRED'),\n+    (194, 'TOKEN_IS_IMMUTABlE');\n+\n+-- Add token table to hold token properties\n+create table if not exists token\n+(\n+    token_id            entity_id               primary key,\n+    create_timestamp    bigint                  not null,\n+    divisibility        bigint                  not null,\n+    freeze_default      boolean                 not null,\n+    freeze_key          bytea,\n+    initial_supply      bigint                  not null,\n+    kyc_default         boolean                 not null,\n+    kyc_key             bytea,\n+    modify_timestamp    bigint,\n+    supply_key          bytea,\n+    symbol              character varying(100)  not null,\n+    treasury_account_id entity_id               not null,\n+    wipe_key            bytea\n+);\n+\n+--- Add token_account table to capture token-account info such as frozen, kyc and wipe status\n+create table if not exists token_account\n+(\n+    id                  serial              primary key,\n+    account_id          entity_id           not null,", "originalCommit": "990a395428dc529b9501d988d14078cf27b64792", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzA3MjE4OA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1073#discussion_r493072188", "bodyText": "Updated 192 onwards with\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                (192, 'INVALID_TOKEN_EXPIRY'),\n          \n          \n            \n                (192, 'TOKEN_NAME_ALREADY_IN_USE'),\n          \n          \n            \n                    (193, 'MISSING_TOKEN_NAME'),\n          \n          \n            \n                    (194, 'TOKEN_NAME_TOO_LONG'),\n          \n          \n            \n                    (195, 'INVALID_WIPING_AMOUNT'),\n          \n          \n            \n                    (196, 'TOKEN_IS_IMMUTABlE'),\n          \n          \n            \n                    (197, 'TOKEN_ALREADY_ASSOCIATED_TO_ACCOUNT')", "author": "Nana-EC", "createdAt": "2020-09-22T22:37:23Z", "path": "hedera-mirror-importer/src/main/resources/db/migration/V1.30.1__hts_support.sql", "diffHunk": "@@ -0,0 +1,117 @@\n+-------------------\n+-- Support hts transactions\n+-------------------\n+\n+-- Add new token entity type\n+insert into t_entity_types (id, name) values (5, 'token');\n+\n+-- Add new hts transaction body types\n+insert into t_transaction_types (proto_id, name) values\n+    (28, 'UNCHECKEDSUBMIT'),\n+    (29, 'TOKENCREATE'),\n+    (30, 'TOKENTRANSFER'),\n+    (31, 'TOKENFREEZE'),\n+    (32, 'TOKENUNFREEZE'),\n+    (33, 'TOKENGRANTKYC'),\n+    (34, 'TOKENREVOKEKYC'),\n+    (35, 'TOKENDELETE'),\n+    (36, 'TOKENUPDATE'),\n+    (37, 'TOKENMINT'),\n+    (38, 'TOKENBURN'),\n+    (39, 'TOKENWIPE');\n+\n+-- Add hts transaction result types\n+insert into t_transaction_results (proto_id, result) values\n+    (165, 'ACCOUNT_FROZEN_FOR_TOKEN'),\n+    (166, 'TOKENS_PER_ACCOUNT_LIMIT_EXCEEDED'),\n+    (167, 'INVALID_TOKEN_ID'),\n+    (168, 'INVALID_TOKEN_DIVISIBILITY'),\n+    (169, 'INVALID_TOKEN_FLOAT'),\n+    (170, 'INVALID_TREASURY_ACCOUNT_FOR_TOKEN'),\n+    (171, 'INVALID_TOKEN_SYMBOL'),\n+    (172, 'TOKEN_HAS_NO_FREEZE_KEY'),\n+    (173, 'TRANSFERS_NOT_ZERO_SUM_FOR_TOKEN'),\n+    (174, 'MISSING_TOKEN_SYMBOL'),\n+    (175, 'TOKEN_SYMBOL_TOO_LONG'),\n+    (176, 'TOKEN_SYMBOL_ALREADY_IN_USE'),\n+    (177, 'INVALID_TOKEN_REF'),\n+    (178, 'ACCOUNT_KYC_NOT_GRANTED_FOR_TOKEN'),\n+    (179, 'TOKEN_HAS_NO_KYC_KEY'),\n+    (180, 'INSUFFICIENT_TOKEN_BALANCE'),\n+    (181, 'TOKEN_WAS_DELETED'),\n+    (182, 'TOKEN_HAS_NO_SUPPLY_KEY'),\n+    (183, 'TOKEN_HAS_NO_WIPE_KEY'),\n+    (184, 'INVALID_TOKEN_MINT_AMOUNT'),\n+    (185, 'INVALID_TOKEN_BURN_AMOUNT'),\n+    (186, 'ACCOUNT_HAS_NO_TOKEN_RELATIONSHIP'),\n+    (187, 'CANNOT_WIPE_TOKEN_TREASURY_ACCOUNT'),\n+    (188, 'INVALID_KYC_KEY'),\n+    (189, 'INVALID_WIPE_KEY'),\n+    (190, 'INVALID_FREEZE_KEY'),\n+    (191, 'INVALID_SUPPLY_KEY'),\n+    (192, 'INVALID_TOKEN_EXPIRY'),", "originalCommit": "990a395428dc529b9501d988d14078cf27b64792", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzA3MjU0NQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1073#discussion_r493072545", "bodyText": "Add\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                TOKENWIPE(39);\n          \n          \n            \n                TOKENWIPE(39),\n          \n          \n            \n                TOKENASSOCIATE(40),\n          \n          \n            \n                TOKENDISSOCIATE(41);", "author": "Nana-EC", "createdAt": "2020-09-22T22:38:26Z", "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/domain/TransactionTypeEnum.java", "diffHunk": "@@ -52,7 +52,19 @@\n     CONSENSUSCREATETOPIC(24),\n     CONSENSUSUPDATETOPIC(25),\n     CONSENSUSDELETETOPIC(26),\n-    CONSENSUSSUBMITMESSAGE(27);\n+    CONSENSUSSUBMITMESSAGE(27),\n+    UNCHECKEDSUBMIT(28),\n+    TOKENCREATE(29),\n+    TOKENTRANSFER(30),\n+    TOKENFREEZE(31),\n+    TOKENUNFREEZE(32),\n+    TOKENGRANTKYC(33),\n+    TOKENREVOKEKYC(34),\n+    TOKENDELETE(35),\n+    TOKENUPDATE(36),\n+    TOKENMINT(37),\n+    TOKENBURN(38),\n+    TOKENWIPE(39);", "originalCommit": "990a395428dc529b9501d988d14078cf27b64792", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "71fb7e82196d2b0318f1544d5c91c913c0f187bc", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/71fb7e82196d2b0318f1544d5c91c913c0f187bc", "message": "Added transaction types and responses and addressed feedback\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2020-09-23T00:13:00Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzY4OTk3NQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1073#discussion_r493689975", "bodyText": "Q: are token associate & token dissociate WIP items? I didn't see them in the published proto", "author": "xin-hedera", "createdAt": "2020-09-23T15:32:56Z", "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/domain/TransactionTypeEnum.java", "diffHunk": "@@ -52,7 +52,21 @@\n     CONSENSUSCREATETOPIC(24),\n     CONSENSUSUPDATETOPIC(25),\n     CONSENSUSDELETETOPIC(26),\n-    CONSENSUSSUBMITMESSAGE(27);\n+    CONSENSUSSUBMITMESSAGE(27),\n+    UNCHECKEDSUBMIT(28),\n+    TOKENCREATE(29),\n+    TOKENTRANSFER(30),\n+    TOKENFREEZE(31),\n+    TOKENUNFREEZE(32),\n+    TOKENGRANTKYC(33),\n+    TOKENREVOKEKYC(34),\n+    TOKENDELETE(35),\n+    TOKENUPDATE(36),\n+    TOKENMINT(37),\n+    TOKENBURN(38),\n+    TOKENWIPE(39),\n+    TOKENASSOCIATE(40),\n+    TOKENDISSOCIATE(41);", "originalCommit": "71fb7e82196d2b0318f1544d5c91c913c0f187bc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzcyOTQxMg==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1073#discussion_r493729412", "bodyText": "Yes WIP, PR should be coming out soon. Think I should leave it out till the new proto is pushed out?", "author": "Nana-EC", "createdAt": "2020-09-23T16:29:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzY4OTk3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzczNDUzOA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1073#discussion_r493734538", "bodyText": "I'll revert it to match what's in master so it matches a version, can update it whenever new proto comes out", "author": "Nana-EC", "createdAt": "2020-09-23T16:37:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzY4OTk3NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzY5OTY2OQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1073#discussion_r493699669", "bodyText": "can't use consensus_timestamp as primary key since it's not unique, there can be many rows with same consensus timestamp\nsimilar to account_balance, the primary key should be a combination key of consensus_timestamp, account_id, and token_id", "author": "xin-hedera", "createdAt": "2020-09-23T15:46:17Z", "path": "hedera-mirror-importer/src/main/resources/db/migration/V1.30.1__hts_support.sql", "diffHunk": "@@ -0,0 +1,121 @@\n+-------------------\n+-- Support hts transactions\n+-------------------\n+\n+-- Add new token entity type\n+insert into t_entity_types (id, name) values (5, 'token');\n+\n+-- Add new hts transaction body types\n+insert into t_transaction_types (proto_id, name) values\n+    (28, 'UNCHECKEDSUBMIT'),\n+    (29, 'TOKENCREATE'),\n+    (30, 'TOKENTRANSFER'),\n+    (31, 'TOKENFREEZE'),\n+    (32, 'TOKENUNFREEZE'),\n+    (33, 'TOKENGRANTKYC'),\n+    (34, 'TOKENREVOKEKYC'),\n+    (35, 'TOKENDELETE'),\n+    (36, 'TOKENUPDATE'),\n+    (37, 'TOKENMINT'),\n+    (38, 'TOKENBURN'),\n+    (39, 'TOKENWIPE'),\n+    (40, 'TOKENASSOCIATE'),\n+    (41, 'TOKENDISSOCIATE');\n+\n+-- Add hts transaction result types\n+insert into t_transaction_results (proto_id, result) values\n+    (165, 'ACCOUNT_FROZEN_FOR_TOKEN'),\n+    (166, 'TOKENS_PER_ACCOUNT_LIMIT_EXCEEDED'),\n+    (167, 'INVALID_TOKEN_ID'),\n+    (168, 'INVALID_TOKEN_DIVISIBILITY'),\n+    (169, 'INVALID_TOKEN_FLOAT'),\n+    (170, 'INVALID_TREASURY_ACCOUNT_FOR_TOKEN'),\n+    (171, 'INVALID_TOKEN_SYMBOL'),\n+    (172, 'TOKEN_HAS_NO_FREEZE_KEY'),\n+    (173, 'TRANSFERS_NOT_ZERO_SUM_FOR_TOKEN'),\n+    (174, 'MISSING_TOKEN_SYMBOL'),\n+    (175, 'TOKEN_SYMBOL_TOO_LONG'),\n+    (176, 'TOKEN_SYMBOL_ALREADY_IN_USE'),\n+    (177, 'INVALID_TOKEN_REF'),\n+    (178, 'ACCOUNT_KYC_NOT_GRANTED_FOR_TOKEN'),\n+    (179, 'TOKEN_HAS_NO_KYC_KEY'),\n+    (180, 'INSUFFICIENT_TOKEN_BALANCE'),\n+    (181, 'TOKEN_WAS_DELETED'),\n+    (182, 'TOKEN_HAS_NO_SUPPLY_KEY'),\n+    (183, 'TOKEN_HAS_NO_WIPE_KEY'),\n+    (184, 'INVALID_TOKEN_MINT_AMOUNT'),\n+    (185, 'INVALID_TOKEN_BURN_AMOUNT'),\n+    (186, 'ACCOUNT_HAS_NO_TOKEN_RELATIONSHIP'),\n+    (187, 'CANNOT_WIPE_TOKEN_TREASURY_ACCOUNT'),\n+    (188, 'INVALID_KYC_KEY'),\n+    (189, 'INVALID_WIPE_KEY'),\n+    (190, 'INVALID_FREEZE_KEY'),\n+    (191, 'INVALID_SUPPLY_KEY'),\n+    (192, 'TOKEN_NAME_ALREADY_IN_USE'),\n+    (193, 'MISSING_TOKEN_NAME'),\n+    (194, 'TOKEN_NAME_TOO_LONG'),\n+    (195, 'INVALID_WIPING_AMOUNT'),\n+    (196, 'TOKEN_IS_IMMUTABlE'),\n+    (197, 'TOKEN_ALREADY_ASSOCIATED_TO_ACCOUNT');\n+\n+-- Add token table to hold token properties\n+create table if not exists token\n+(\n+    token_id            entity_id               primary key,\n+    created_timestamp   bigint                  not null,\n+    divisibility        bigint                  not null,\n+    freeze_default      boolean                 not null,\n+    freeze_key          bytea,\n+    initial_supply      bigint                  not null,\n+    kyc_default         boolean                 not null,\n+    kyc_key             bytea,\n+    modified_timestamp  bigint                  not null,\n+    supply_key          bytea,\n+    symbol              character varying(100)  not null,\n+    treasury_account_id entity_id               not null,\n+    wipe_key            bytea\n+);\n+\n+--- Add token_account table to capture token-account info such as frozen, kyc and wipe status\n+create table if not exists token_account\n+(\n+    id                  serial              primary key,\n+    account_id          entity_id           not null,\n+    associated          boolean             not null default false,\n+    created_timestamp   bigint              not null,\n+    frozen              boolean             not null,\n+    kyc                 boolean             not null,\n+    modified_timestamp  bigint              not null,\n+    token_id            entity_id           not null,\n+    wiped               boolean             not null default false\n+);\n+\n+create unique index if not exists token_account__token_account on token_account(token_id, account_id);\n+\n+\n+--- Add token_balance table to capture token account balances\n+create table if not exists token_balance\n+(\n+    consensus_timestamp bigint              primary key not null,", "originalCommit": "71fb7e82196d2b0318f1544d5c91c913c0f187bc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzczNTA0Ng==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1073#discussion_r493735046", "bodyText": "You're correct, will add that\n    alter table if exists token_balance\n    add constraint token_balance__pk primary key (consensus_timestamp, token_id, account_id);", "author": "Nana-EC", "createdAt": "2020-09-23T16:38:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzY5OTY2OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzcwMzUzMw==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1073#discussion_r493703533", "bodyText": "Q: same as above, TOKEN_ALREADY_ASSOCIATED_TO_ACCOUNT is not in published proto", "author": "xin-hedera", "createdAt": "2020-09-23T15:51:33Z", "path": "hedera-mirror-importer/src/main/resources/db/migration/V1.30.1__hts_support.sql", "diffHunk": "@@ -0,0 +1,121 @@\n+-------------------\n+-- Support hts transactions\n+-------------------\n+\n+-- Add new token entity type\n+insert into t_entity_types (id, name) values (5, 'token');\n+\n+-- Add new hts transaction body types\n+insert into t_transaction_types (proto_id, name) values\n+    (28, 'UNCHECKEDSUBMIT'),\n+    (29, 'TOKENCREATE'),\n+    (30, 'TOKENTRANSFER'),\n+    (31, 'TOKENFREEZE'),\n+    (32, 'TOKENUNFREEZE'),\n+    (33, 'TOKENGRANTKYC'),\n+    (34, 'TOKENREVOKEKYC'),\n+    (35, 'TOKENDELETE'),\n+    (36, 'TOKENUPDATE'),\n+    (37, 'TOKENMINT'),\n+    (38, 'TOKENBURN'),\n+    (39, 'TOKENWIPE'),\n+    (40, 'TOKENASSOCIATE'),\n+    (41, 'TOKENDISSOCIATE');\n+\n+-- Add hts transaction result types\n+insert into t_transaction_results (proto_id, result) values\n+    (165, 'ACCOUNT_FROZEN_FOR_TOKEN'),\n+    (166, 'TOKENS_PER_ACCOUNT_LIMIT_EXCEEDED'),\n+    (167, 'INVALID_TOKEN_ID'),\n+    (168, 'INVALID_TOKEN_DIVISIBILITY'),\n+    (169, 'INVALID_TOKEN_FLOAT'),\n+    (170, 'INVALID_TREASURY_ACCOUNT_FOR_TOKEN'),\n+    (171, 'INVALID_TOKEN_SYMBOL'),\n+    (172, 'TOKEN_HAS_NO_FREEZE_KEY'),\n+    (173, 'TRANSFERS_NOT_ZERO_SUM_FOR_TOKEN'),\n+    (174, 'MISSING_TOKEN_SYMBOL'),\n+    (175, 'TOKEN_SYMBOL_TOO_LONG'),\n+    (176, 'TOKEN_SYMBOL_ALREADY_IN_USE'),\n+    (177, 'INVALID_TOKEN_REF'),\n+    (178, 'ACCOUNT_KYC_NOT_GRANTED_FOR_TOKEN'),\n+    (179, 'TOKEN_HAS_NO_KYC_KEY'),\n+    (180, 'INSUFFICIENT_TOKEN_BALANCE'),\n+    (181, 'TOKEN_WAS_DELETED'),\n+    (182, 'TOKEN_HAS_NO_SUPPLY_KEY'),\n+    (183, 'TOKEN_HAS_NO_WIPE_KEY'),\n+    (184, 'INVALID_TOKEN_MINT_AMOUNT'),\n+    (185, 'INVALID_TOKEN_BURN_AMOUNT'),\n+    (186, 'ACCOUNT_HAS_NO_TOKEN_RELATIONSHIP'),\n+    (187, 'CANNOT_WIPE_TOKEN_TREASURY_ACCOUNT'),\n+    (188, 'INVALID_KYC_KEY'),\n+    (189, 'INVALID_WIPE_KEY'),\n+    (190, 'INVALID_FREEZE_KEY'),\n+    (191, 'INVALID_SUPPLY_KEY'),\n+    (192, 'TOKEN_NAME_ALREADY_IN_USE'),\n+    (193, 'MISSING_TOKEN_NAME'),\n+    (194, 'TOKEN_NAME_TOO_LONG'),\n+    (195, 'INVALID_WIPING_AMOUNT'),\n+    (196, 'TOKEN_IS_IMMUTABlE'),\n+    (197, 'TOKEN_ALREADY_ASSOCIATED_TO_ACCOUNT');", "originalCommit": "71fb7e82196d2b0318f1544d5c91c913c0f187bc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzczOTA1Mg==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1073#discussion_r493739052", "bodyText": "I'll revert it to match what's in master so it matches a version, can update it whenever new proto comes out", "author": "Nana-EC", "createdAt": "2020-09-23T16:44:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzcwMzUzMw=="}], "type": "inlineReview"}, {"oid": "bd7e80dff2f44a4acdca51016011465a2ea16ce7", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/bd7e80dff2f44a4acdca51016011465a2ea16ce7", "message": "Reverted transaction types and codes to match current master\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2020-09-23T16:44:01Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzg0MTAwMg==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1073#discussion_r493841002", "bodyText": "This index is a subset of the below index. Can you reorder the below index to have consensus_timestamp as first and drop this index?", "author": "steven-sheehy", "createdAt": "2020-09-23T19:25:09Z", "path": "hedera-mirror-importer/src/main/resources/db/migration/V1.30.1__hts_support.sql", "diffHunk": "@@ -0,0 +1,120 @@\n+-------------------\n+-- Support hts transactions\n+-------------------\n+\n+-- Add new token entity type\n+insert into t_entity_types (id, name) values (5, 'token');\n+\n+-- Add new hts transaction body types\n+insert into t_transaction_types (proto_id, name) values\n+    (28, 'UNCHECKEDSUBMIT'),\n+    (29, 'TOKENCREATE'),\n+    (30, 'TOKENTRANSFER'),\n+    (31, 'TOKENFREEZE'),\n+    (32, 'TOKENUNFREEZE'),\n+    (33, 'TOKENGRANTKYC'),\n+    (34, 'TOKENREVOKEKYC'),\n+    (35, 'TOKENDELETE'),\n+    (36, 'TOKENUPDATE'),\n+    (37, 'TOKENMINT'),\n+    (38, 'TOKENBURN'),\n+    (39, 'TOKENWIPE');\n+\n+-- Add hts transaction result types\n+insert into t_transaction_results (proto_id, result) values\n+    (165, 'ACCOUNT_FROZEN_FOR_TOKEN'),\n+    (166, 'TOKENS_PER_ACCOUNT_LIMIT_EXCEEDED'),\n+    (167, 'INVALID_TOKEN_ID'),\n+    (168, 'INVALID_TOKEN_DIVISIBILITY'),\n+    (169, 'INVALID_TOKEN_FLOAT'),\n+    (170, 'INVALID_TREASURY_ACCOUNT_FOR_TOKEN'),\n+    (171, 'INVALID_TOKEN_SYMBOL'),\n+    (172, 'TOKEN_HAS_NO_FREEZE_KEY'),\n+    (173, 'TRANSFERS_NOT_ZERO_SUM_FOR_TOKEN'),\n+    (174, 'MISSING_TOKEN_SYMBOL'),\n+    (175, 'TOKEN_SYMBOL_TOO_LONG'),\n+    (176, 'TOKEN_SYMBOL_ALREADY_IN_USE'),\n+    (177, 'INVALID_TOKEN_REF'),\n+    (178, 'ACCOUNT_KYC_NOT_GRANTED_FOR_TOKEN'),\n+    (179, 'TOKEN_HAS_NO_KYC_KEY'),\n+    (180, 'INSUFFICIENT_TOKEN_BALANCE'),\n+    (181, 'TOKEN_WAS_DELETED'),\n+    (182, 'TOKEN_HAS_NO_SUPPLY_KEY'),\n+    (183, 'TOKEN_HAS_NO_WIPE_KEY'),\n+    (184, 'INVALID_TOKEN_MINT_AMOUNT'),\n+    (185, 'INVALID_TOKEN_BURN_AMOUNT'),\n+    (186, 'ACCOUNT_HAS_NO_TOKEN_RELATIONSHIP'),\n+    (187, 'CANNOT_WIPE_TOKEN_TREASURY_ACCOUNT'),\n+    (188, 'INVALID_KYC_KEY'),\n+    (189, 'INVALID_WIPE_KEY'),\n+    (190, 'INVALID_FREEZE_KEY'),\n+    (191, 'INVALID_SUPPLY_KEY'),\n+    (192, 'TOKEN_NAME_ALREADY_IN_USE'),\n+    (193, 'MISSING_TOKEN_NAME'),\n+    (194, 'TOKEN_NAME_TOO_LONG'),\n+    (195, 'INVALID_WIPING_AMOUNT'),\n+    (196, 'TOKEN_IS_IMMUTABlE');\n+\n+-- Add token table to hold token properties\n+create table if not exists token\n+(\n+    token_id            entity_id               primary key,\n+    created_timestamp   bigint                  not null,\n+    divisibility        bigint                  not null,\n+    freeze_default      boolean                 not null,\n+    freeze_key          bytea,\n+    initial_supply      bigint                  not null,\n+    kyc_default         boolean                 not null,\n+    kyc_key             bytea,\n+    modified_timestamp  bigint                  not null,\n+    supply_key          bytea,\n+    symbol              character varying(100)  not null,\n+    treasury_account_id entity_id               not null,\n+    wipe_key            bytea\n+);\n+\n+--- Add token_account table to capture token-account info such as frozen, kyc and wipe status\n+create table if not exists token_account\n+(\n+    id                  serial              primary key,\n+    account_id          entity_id           not null,\n+    created_timestamp   bigint              not null,\n+    frozen              boolean             not null default false,\n+    kyc                 boolean             not null default false,\n+    modified_timestamp  bigint              not null,\n+    token_id            entity_id           not null,\n+    wiped               boolean             not null default false\n+);\n+\n+create unique index if not exists token_account__token_account on token_account(token_id, account_id);\n+\n+\n+--- Add token_balance table to capture token account balances\n+create table if not exists token_balance\n+(\n+    consensus_timestamp bigint              not null,\n+    account_id          entity_id           not null,\n+    balance             bigint              not null,\n+    token_id            entity_id           not null\n+);\n+\n+alter table if exists token_balance\n+    add constraint token_balance__pk primary key (consensus_timestamp, token_id, account_id);\n+\n+create index if not exists token_balance__token_account_timestamp\n+     on token_balance (token_id desc, account_id desc, consensus_timestamp desc);\n+\n+--- Add token_transfer\n+create table if not exists token_transfer\n+(\n+    token_id            entity_id,\n+    account_id          entity_id,\n+    consensus_timestamp bigint,\n+    amount              hbar_tinybars\n+);\n+\n+create index if not exists token_transfer__timestamp\n+     on token_transfer (consensus_timestamp desc);", "originalCommit": "bd7e80dff2f44a4acdca51016011465a2ea16ce7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzg0MTMzMQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1073#discussion_r493841331", "bodyText": "These required booleans can have explicit defaults as well.", "author": "steven-sheehy", "createdAt": "2020-09-23T19:25:42Z", "path": "hedera-mirror-importer/src/main/resources/db/migration/V1.30.1__hts_support.sql", "diffHunk": "@@ -0,0 +1,120 @@\n+-------------------\n+-- Support hts transactions\n+-------------------\n+\n+-- Add new token entity type\n+insert into t_entity_types (id, name) values (5, 'token');\n+\n+-- Add new hts transaction body types\n+insert into t_transaction_types (proto_id, name) values\n+    (28, 'UNCHECKEDSUBMIT'),\n+    (29, 'TOKENCREATE'),\n+    (30, 'TOKENTRANSFER'),\n+    (31, 'TOKENFREEZE'),\n+    (32, 'TOKENUNFREEZE'),\n+    (33, 'TOKENGRANTKYC'),\n+    (34, 'TOKENREVOKEKYC'),\n+    (35, 'TOKENDELETE'),\n+    (36, 'TOKENUPDATE'),\n+    (37, 'TOKENMINT'),\n+    (38, 'TOKENBURN'),\n+    (39, 'TOKENWIPE');\n+\n+-- Add hts transaction result types\n+insert into t_transaction_results (proto_id, result) values\n+    (165, 'ACCOUNT_FROZEN_FOR_TOKEN'),\n+    (166, 'TOKENS_PER_ACCOUNT_LIMIT_EXCEEDED'),\n+    (167, 'INVALID_TOKEN_ID'),\n+    (168, 'INVALID_TOKEN_DIVISIBILITY'),\n+    (169, 'INVALID_TOKEN_FLOAT'),\n+    (170, 'INVALID_TREASURY_ACCOUNT_FOR_TOKEN'),\n+    (171, 'INVALID_TOKEN_SYMBOL'),\n+    (172, 'TOKEN_HAS_NO_FREEZE_KEY'),\n+    (173, 'TRANSFERS_NOT_ZERO_SUM_FOR_TOKEN'),\n+    (174, 'MISSING_TOKEN_SYMBOL'),\n+    (175, 'TOKEN_SYMBOL_TOO_LONG'),\n+    (176, 'TOKEN_SYMBOL_ALREADY_IN_USE'),\n+    (177, 'INVALID_TOKEN_REF'),\n+    (178, 'ACCOUNT_KYC_NOT_GRANTED_FOR_TOKEN'),\n+    (179, 'TOKEN_HAS_NO_KYC_KEY'),\n+    (180, 'INSUFFICIENT_TOKEN_BALANCE'),\n+    (181, 'TOKEN_WAS_DELETED'),\n+    (182, 'TOKEN_HAS_NO_SUPPLY_KEY'),\n+    (183, 'TOKEN_HAS_NO_WIPE_KEY'),\n+    (184, 'INVALID_TOKEN_MINT_AMOUNT'),\n+    (185, 'INVALID_TOKEN_BURN_AMOUNT'),\n+    (186, 'ACCOUNT_HAS_NO_TOKEN_RELATIONSHIP'),\n+    (187, 'CANNOT_WIPE_TOKEN_TREASURY_ACCOUNT'),\n+    (188, 'INVALID_KYC_KEY'),\n+    (189, 'INVALID_WIPE_KEY'),\n+    (190, 'INVALID_FREEZE_KEY'),\n+    (191, 'INVALID_SUPPLY_KEY'),\n+    (192, 'TOKEN_NAME_ALREADY_IN_USE'),\n+    (193, 'MISSING_TOKEN_NAME'),\n+    (194, 'TOKEN_NAME_TOO_LONG'),\n+    (195, 'INVALID_WIPING_AMOUNT'),\n+    (196, 'TOKEN_IS_IMMUTABlE');\n+\n+-- Add token table to hold token properties\n+create table if not exists token\n+(\n+    token_id            entity_id               primary key,\n+    created_timestamp   bigint                  not null,\n+    divisibility        bigint                  not null,\n+    freeze_default      boolean                 not null,", "originalCommit": "bd7e80dff2f44a4acdca51016011465a2ea16ce7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzg0MTk3NA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1073#discussion_r493841974", "bodyText": "A constraint also creates an index, otherwise it can't validate the constraint efficiently. This index can be dropped.", "author": "steven-sheehy", "createdAt": "2020-09-23T19:26:46Z", "path": "hedera-mirror-importer/src/main/resources/db/migration/V1.30.1__hts_support.sql", "diffHunk": "@@ -0,0 +1,120 @@\n+-------------------\n+-- Support hts transactions\n+-------------------\n+\n+-- Add new token entity type\n+insert into t_entity_types (id, name) values (5, 'token');\n+\n+-- Add new hts transaction body types\n+insert into t_transaction_types (proto_id, name) values\n+    (28, 'UNCHECKEDSUBMIT'),\n+    (29, 'TOKENCREATE'),\n+    (30, 'TOKENTRANSFER'),\n+    (31, 'TOKENFREEZE'),\n+    (32, 'TOKENUNFREEZE'),\n+    (33, 'TOKENGRANTKYC'),\n+    (34, 'TOKENREVOKEKYC'),\n+    (35, 'TOKENDELETE'),\n+    (36, 'TOKENUPDATE'),\n+    (37, 'TOKENMINT'),\n+    (38, 'TOKENBURN'),\n+    (39, 'TOKENWIPE');\n+\n+-- Add hts transaction result types\n+insert into t_transaction_results (proto_id, result) values\n+    (165, 'ACCOUNT_FROZEN_FOR_TOKEN'),\n+    (166, 'TOKENS_PER_ACCOUNT_LIMIT_EXCEEDED'),\n+    (167, 'INVALID_TOKEN_ID'),\n+    (168, 'INVALID_TOKEN_DIVISIBILITY'),\n+    (169, 'INVALID_TOKEN_FLOAT'),\n+    (170, 'INVALID_TREASURY_ACCOUNT_FOR_TOKEN'),\n+    (171, 'INVALID_TOKEN_SYMBOL'),\n+    (172, 'TOKEN_HAS_NO_FREEZE_KEY'),\n+    (173, 'TRANSFERS_NOT_ZERO_SUM_FOR_TOKEN'),\n+    (174, 'MISSING_TOKEN_SYMBOL'),\n+    (175, 'TOKEN_SYMBOL_TOO_LONG'),\n+    (176, 'TOKEN_SYMBOL_ALREADY_IN_USE'),\n+    (177, 'INVALID_TOKEN_REF'),\n+    (178, 'ACCOUNT_KYC_NOT_GRANTED_FOR_TOKEN'),\n+    (179, 'TOKEN_HAS_NO_KYC_KEY'),\n+    (180, 'INSUFFICIENT_TOKEN_BALANCE'),\n+    (181, 'TOKEN_WAS_DELETED'),\n+    (182, 'TOKEN_HAS_NO_SUPPLY_KEY'),\n+    (183, 'TOKEN_HAS_NO_WIPE_KEY'),\n+    (184, 'INVALID_TOKEN_MINT_AMOUNT'),\n+    (185, 'INVALID_TOKEN_BURN_AMOUNT'),\n+    (186, 'ACCOUNT_HAS_NO_TOKEN_RELATIONSHIP'),\n+    (187, 'CANNOT_WIPE_TOKEN_TREASURY_ACCOUNT'),\n+    (188, 'INVALID_KYC_KEY'),\n+    (189, 'INVALID_WIPE_KEY'),\n+    (190, 'INVALID_FREEZE_KEY'),\n+    (191, 'INVALID_SUPPLY_KEY'),\n+    (192, 'TOKEN_NAME_ALREADY_IN_USE'),\n+    (193, 'MISSING_TOKEN_NAME'),\n+    (194, 'TOKEN_NAME_TOO_LONG'),\n+    (195, 'INVALID_WIPING_AMOUNT'),\n+    (196, 'TOKEN_IS_IMMUTABlE');\n+\n+-- Add token table to hold token properties\n+create table if not exists token\n+(\n+    token_id            entity_id               primary key,\n+    created_timestamp   bigint                  not null,\n+    divisibility        bigint                  not null,\n+    freeze_default      boolean                 not null,\n+    freeze_key          bytea,\n+    initial_supply      bigint                  not null,\n+    kyc_default         boolean                 not null,\n+    kyc_key             bytea,\n+    modified_timestamp  bigint                  not null,\n+    supply_key          bytea,\n+    symbol              character varying(100)  not null,\n+    treasury_account_id entity_id               not null,\n+    wipe_key            bytea\n+);\n+\n+--- Add token_account table to capture token-account info such as frozen, kyc and wipe status\n+create table if not exists token_account\n+(\n+    id                  serial              primary key,\n+    account_id          entity_id           not null,\n+    created_timestamp   bigint              not null,\n+    frozen              boolean             not null default false,\n+    kyc                 boolean             not null default false,\n+    modified_timestamp  bigint              not null,\n+    token_id            entity_id           not null,\n+    wiped               boolean             not null default false\n+);\n+\n+create unique index if not exists token_account__token_account on token_account(token_id, account_id);\n+\n+\n+--- Add token_balance table to capture token account balances\n+create table if not exists token_balance\n+(\n+    consensus_timestamp bigint              not null,\n+    account_id          entity_id           not null,\n+    balance             bigint              not null,\n+    token_id            entity_id           not null\n+);\n+\n+alter table if exists token_balance\n+    add constraint token_balance__pk primary key (consensus_timestamp, token_id, account_id);\n+\n+create index if not exists token_balance__token_account_timestamp", "originalCommit": "bd7e80dff2f44a4acdca51016011465a2ea16ce7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzg3MDY5MA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1073#discussion_r493870690", "bodyText": "Yep, problem here is the constraint doesn't give the desired order, makes it asc by default where as w want desc for this table.\naccount_balance seemed to have the same issues and had to add both the pk and the index to sort desc", "author": "Nana-EC", "createdAt": "2020-09-23T20:19:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzg0MTk3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzg5Mjk4Ng==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1073#discussion_r493892986", "bodyText": "I believe you can efficiently scan a b-tree index defined as ascending backwards using ORDER BY DESC. The only reason you would want to define another index explicitly if some fields in the composite key are in different orders like x ASC, y DESC. Would be worthwhile to do a quick test to prove it as this can be a very large index in the future.", "author": "steven-sheehy", "createdAt": "2020-09-23T21:01:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzg0MTk3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzg5ODI0OQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1073#discussion_r493898249", "bodyText": "Yeah you're right, it can still be done efficiently as such.", "author": "Nana-EC", "createdAt": "2020-09-23T21:12:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzg0MTk3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzkxMDY1Mg==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1073#discussion_r493910652", "bodyText": "Results from a quick test: 2,052 MB account_balance table with 41,236,847 rows, using the /accounts query that pulls 1,000 rows.\nYour proposed option without the additional index is like 50-100 microseconds faster\nGiven like you pointed out the index grows with size I'm fine with dropping this additional index", "author": "Nana-EC", "createdAt": "2020-09-23T21:39:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzg0MTk3NA=="}], "type": "inlineReview"}, {"oid": "3f1e8985996618fa4e0ee81e6d3bb3e2f75c5dd7", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/3f1e8985996618fa4e0ee81e6d3bb3e2f75c5dd7", "message": "Dropped subset token_transfer index and added boolean defaults\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2020-09-23T20:29:51Z", "type": "commit"}, {"oid": "4ae45dbeaedb7aa25dbb431a453602d9e67b53b2", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/4ae45dbeaedb7aa25dbb431a453602d9e67b53b2", "message": "Dropped additional token_balance index\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2020-09-23T21:40:43Z", "type": "commit"}]}