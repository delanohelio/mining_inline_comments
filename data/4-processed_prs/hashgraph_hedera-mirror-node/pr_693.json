{"pr_number": 693, "pr_title": "Add Traefik API gateway", "pr_createdAt": "2020-04-17T17:58:37Z", "pr_url": "https://github.com/hashgraph/hedera-mirror-node/pull/693", "timeline": [{"oid": "bd80f225e9f83834af29ce84cb6b754f8e699da7", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/bd80f225e9f83834af29ce84cb6b754f8e699da7", "message": "Add Traefik API gateway\n\nSigned-off-by: Steven Sheehy <steven.sheehy@hedera.com>", "committedDate": "2020-04-17T17:56:37Z", "type": "commit"}, {"oid": "f3cda2d7c412894e83de1d7a4b599036f60b3115", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/f3cda2d7c412894e83de1d7a4b599036f60b3115", "message": "Separate middleware per API\n\nSigned-off-by: Steven Sheehy <steven.sheehy@hedera.com>", "committedDate": "2020-04-17T21:58:20Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDQ5NzUwNQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/693#discussion_r410497505", "bodyText": "nit: might be worth a small not on why --render-subchart-notes as it's not a regular property", "author": "Nana-EC", "createdAt": "2020-04-17T22:22:30Z", "path": "charts/README.md", "diffHunk": "@@ -16,7 +16,7 @@ Installs the Hedera Mirror Node Helm wrapper chart. This chart will install the\n To install the wrapper chart with a release name of `mirror`:\n \n ```shell script\n-$ helm upgrade --install mirror charts/hedera-mirror\n+$ helm upgrade --install --render-subchart-notes mirror charts/hedera-mirror", "originalCommit": "f3cda2d7c412894e83de1d7a4b599036f60b3115", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDUxMDMzNg==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/693#discussion_r410510336", "bodyText": "Actually, now that we access everything on the single load balancer we don't really need the sub chart notes that detail how to get access to the underlying services. I'll remove this flag and add note to wrapper notes.txt", "author": "steven-sheehy", "createdAt": "2020-04-17T23:13:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDQ5NzUwNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDUxNzI5NA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/693#discussion_r410517294", "bodyText": "This is done", "author": "steven-sheehy", "createdAt": "2020-04-17T23:46:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDQ5NzUwNQ=="}], "type": "inlineReview"}, {"oid": "e1ead25610e4c8da4bcb3d72f40b741784701334", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/e1ead25610e4c8da4bcb3d72f40b741784701334", "message": "Update documentation\n\nSigned-off-by: Steven Sheehy <steven.sheehy@hedera.com>", "committedDate": "2020-04-17T23:45:17Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDUwNTAxMg==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/693#discussion_r410505012", "bodyText": "do we need 5 middleware definitions?\nGiven each spec is 3-5 lines, would be neater and more manageable if we can directly add them here with comments.", "author": "apeksharma", "createdAt": "2020-04-17T22:50:42Z", "path": "charts/hedera-mirror-grpc/templates/middleware.yaml", "diffHunk": "@@ -0,0 +1,68 @@\n+{{- if .Values.ingress.middleware.enabled -}}\n+apiVersion: traefik.containo.us/v1alpha1\n+kind: Middleware\n+metadata:\n+  labels:\n+    {{- include \"hedera-mirror-grpc.labels\" . | nindent 4 }}\n+  name: {{ include \"hedera-mirror-grpc.fullname\" . }}\n+  namespace: {{ include \"hedera-mirror-grpc.namespace\" . }}\n+spec:\n+  chain:", "originalCommit": "f3cda2d7c412894e83de1d7a4b599036f60b3115", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDUyMTU2NQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/693#discussion_r410521565", "bodyText": "Not sure what you mean by directly adding them here. This is the only way to define middleware, using the CRD. The chain middleware requires a list of names, not a list of inlined implementations.", "author": "steven-sheehy", "createdAt": "2020-04-18T00:11:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDUwNTAxMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDUwODMzOA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/693#discussion_r410508338", "bodyText": "Would be best to avoid the burden of configuring every path if we have no reason to block any.\nIn case of grpc, i believe we can open up all paths(?).\nIs is possible to specify something like * here?", "author": "apeksharma", "createdAt": "2020-04-17T23:04:49Z", "path": "charts/hedera-mirror-grpc/values.yaml", "diffHunk": "@@ -30,6 +30,28 @@ image:\n \n imagePullSecrets: []\n \n+ingress:\n+  annotations:\n+    traefik.ingress.kubernetes.io/router.middlewares: '{{ include \"hedera-mirror-grpc.namespace\" . }}-{{ include \"hedera-mirror-grpc.fullname\" . }}@kubernetescrd'\n+  enabled: true\n+  hosts:\n+    - host: \"\"\n+      paths:\n+        - \"/com.hedera.mirror.api.proto.ConsensusService\"", "originalCommit": "f3cda2d7c412894e83de1d7a4b599036f60b3115", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDUyMDgwMA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/693#discussion_r410520800", "bodyText": "No, these paths are global as all paths are served on the same port. So you need some way to route rest vs grpc, hence above.", "author": "steven-sheehy", "createdAt": "2020-04-18T00:06:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDUwODMzOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDU5NDAzMA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/693#discussion_r410594030", "bodyText": "Well, to clarify I can put / here instead and Traefik will route to longer, more specific paths like /grafana and /api/v1 first. If the path doesn't match those it will redirect all remaining traffic to GRPC service where it may or may not be found. But think I prefer failing fast at proxy layer instead with more specific paths then potentially overloading service layer.\nWe can always revisit later when there's more paths. Two does not seem burdensome.", "author": "steven-sheehy", "createdAt": "2020-04-18T03:41:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDUwODMzOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDUxMDU4OA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/693#discussion_r410510588", "bodyText": "does helm has no way of sharing duplicates like these across subcharts?", "author": "apeksharma", "createdAt": "2020-04-17T23:14:49Z", "path": "charts/hedera-mirror-rest/templates/ingress.yaml", "diffHunk": "@@ -0,0 +1,38 @@\n+{{- if .Values.ingress.enabled -}}", "originalCommit": "f3cda2d7c412894e83de1d7a4b599036f60b3115", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDUyMTQwNw==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/693#discussion_r410521407", "bodyText": "Nope, not across charts at least", "author": "steven-sheehy", "createdAt": "2020-04-18T00:10:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDUxMDU4OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDUxMjM1Nw==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/693#discussion_r410512357", "bodyText": "Grafana would be internal only and authenticated. There should be no need to limit it. Seems a bit excessive early on since it's not clear if we are even gonna need it.", "author": "apeksharma", "createdAt": "2020-04-17T23:22:35Z", "path": "charts/hedera-mirror/templates/middleware-grafana.yaml", "diffHunk": "@@ -0,0 +1,85 @@\n+{{ $ingress := .Values.prometheus.grafana.ingress }}", "originalCommit": "f3cda2d7c412894e83de1d7a4b599036f60b3115", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDUyMTIzMg==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/693#discussion_r410521232", "bodyText": "It is already authenticated. I'm not sure why you would think viewing metrics, dashboards and logs is not needed. I can potentially see an argument for it not being exposed by default and requiring kubectl port-forward to manually expose, but that would make it more difficult for us to troubleshoot issues at 3am and impossible for other Hedera employees to view. Also, our current elastic dashboard is publically accessible.", "author": "steven-sheehy", "createdAt": "2020-04-18T00:09:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDUxMjM1Nw=="}], "type": "inlineReview"}, {"oid": "09433ca1e5bc24eb963262fb41d0118238eab354", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/09433ca1e5bc24eb963262fb41d0118238eab354", "message": "Add Traefik antiAffinity\n\nSigned-off-by: Steven Sheehy <steven.sheehy@hedera.com>", "committedDate": "2020-04-18T03:35:01Z", "type": "commit"}, {"oid": "e7ee150c1edf84a2d60717edae4ddee52624658a", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/e7ee150c1edf84a2d60717edae4ddee52624658a", "message": "Add Traefik Grafana dashboard\n\nSigned-off-by: Steven Sheehy <steven.sheehy@hedera.com>", "committedDate": "2020-04-18T21:08:25Z", "type": "commit"}]}