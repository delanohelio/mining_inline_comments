{"pr_number": 1320, "pr_title": "Optimize transaction query", "pr_createdAt": "2020-12-04T20:21:36Z", "pr_url": "https://github.com/hashgraph/hedera-mirror-node/pull/1320", "timeline": [{"oid": "39132909095bceadd0956006882eb50e661ae21e", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/39132909095bceadd0956006882eb50e661ae21e", "message": "optimize transaction query\n\nSigned-off-by: Xin Li <xin.li@swirlds.com>", "committedDate": "2020-12-04T20:16:01Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjM4MTEwOA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1320#discussion_r536381108", "bodyText": "q: Does this end up contributing to the #1295  bug where transactions for account that don't pay crypto transfer fees.\ni.e. will transactions now be filtered out as a result of this?", "author": "Nana-EC", "createdAt": "2020-12-04T21:09:52Z", "path": "hedera-mirror-rest/transactions.js", "diffHunk": "@@ -183,16 +195,21 @@ const getTransactionsInnerQuery = function (\n   transactionTypeQuery,\n   order\n ) {\n-  let whereClause = [accountQuery, tsQuery, resultTypeQuery, creditDebitQuery, transactionTypeQuery]\n-    .filter((q) => q !== '')\n-    .join(' AND ');\n-  whereClause = whereClause === '' ? '' : `WHERE ${whereClause}`;\n+  const whereClause = buildWhereClause(resultTypeQuery, transactionTypeQuery);\n+  const ctlWhereClause = buildWhereClause(accountQuery, tsQuery, creditDebitQuery);\n+\n   return `\n-    SELECT DISTINCT ctl.consensus_timestamp\n-    FROM crypto_transfer ctl\n-      JOIN transaction t ON t.consensus_ns = ctl.consensus_timestamp\n+    SELECT t.consensus_ns AS consensus_timestamp\n+    FROM transaction t\n+    JOIN (\n+            SELECT DISTINCT consensus_timestamp", "originalCommit": "39132909095bceadd0956006882eb50e661ae21e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjM5MjU4OA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1320#discussion_r536392588", "bodyText": "No. The new query should produce the same list of timestamps , which means for some system accounts transactions without crypto transfer list, they still won\u2019t show up in the transactions result.\nI\u2019ll fix that bug in a separate PR", "author": "xin-hedera", "createdAt": "2020-12-04T21:34:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjM4MTEwOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjQ0ODY0Ng==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1320#discussion_r536448646", "bodyText": "Sounds good", "author": "Nana-EC", "createdAt": "2020-12-04T23:46:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjM4MTEwOA=="}], "type": "inlineReview"}]}