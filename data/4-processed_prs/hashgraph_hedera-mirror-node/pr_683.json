{"pr_number": 683, "pr_title": "Push docker images on master and cleanup old images", "pr_createdAt": "2020-04-13T21:23:15Z", "pr_url": "https://github.com/hashgraph/hedera-mirror-node/pull/683", "timeline": [{"oid": "5764b2b79a6aa8ffcd52b6164a52e1a89ce17aff", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/5764b2b79a6aa8ffcd52b6164a52e1a89ce17aff", "message": "Push docker images on master and cleanup\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2020-04-13T21:19:05Z", "type": "commit"}, {"oid": "d8df482811345961abf62da7ef2732916702e277", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/d8df482811345961abf62da7ef2732916702e277", "message": "Used circle.docker.tag in deploy\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2020-04-13T21:53:01Z", "type": "commit"}, {"oid": "4588349382cce708e51f48bc2353e4667b9f76b8", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/4588349382cce708e51f48bc2353e4667b9f76b8", "message": "Use creationTime instead of useCurrentTimestamp\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2020-04-13T23:04:36Z", "type": "commit"}, {"oid": "13325ec032c443c70bb5da9b7c99f3b47477d3f7", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/13325ec032c443c70bb5da9b7c99f3b47477d3f7", "message": "Fixed bad substitution and updated prettyignore\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2020-04-13T23:16:33Z", "type": "commit"}, {"oid": "52a75d054d2b3650ac5411b127884a42bb540a37", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/52a75d054d2b3650ac5411b127884a42bb540a37", "message": "Added lastest tag config updated delete_before logic\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2020-04-14T00:25:46Z", "type": "commit"}, {"oid": "2f6b57e157ff4b3c8bb6187da8180714fba5c4dc", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/2f6b57e157ff4b3c8bb6187da8180714fba5c4dc", "message": "echoed image tag lists\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2020-04-14T00:49:25Z", "type": "commit"}, {"oid": "9bcc501c9dc5c2b5ca436ba3ddbfa7cf8ca07f9b", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/9bcc501c9dc5c2b5ca436ba3ddbfa7cf8ca07f9b", "message": "Added loop logic for multiple tags\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2020-04-14T01:04:45Z", "type": "commit"}, {"oid": "23672bf49917d88c26e810af2fef22de97e79f6f", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/23672bf49917d88c26e810af2fef22de97e79f6f", "message": "Try delete old images logic\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2020-04-14T02:36:48Z", "type": "commit"}, {"oid": "527e9112e27cecc2bb78e0b34314c6a3a3401642", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/527e9112e27cecc2bb78e0b34314c6a3a3401642", "message": "Added echo for each image\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2020-04-14T02:51:45Z", "type": "commit"}, {"oid": "284ae27b188b22ad01666977c39136439e8e1d3b", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/284ae27b188b22ad01666977c39136439e8e1d3b", "message": "Update  multiline comment\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2020-04-14T03:40:39Z", "type": "commit"}, {"oid": "d00eb4bda2f7bff82115c1b68c267b909feef417", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/d00eb4bda2f7bff82115c1b68c267b909feef417", "message": "Remove gcloud delete\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2020-04-14T04:03:31Z", "type": "commit"}, {"oid": "a409b8194df17f105297d3e29b44fee3b2bec861", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/a409b8194df17f105297d3e29b44fee3b2bec861", "message": "Remove digest echo for delete command\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2020-04-14T04:16:30Z", "type": "commit"}, {"oid": "6d6dd52bc198e03da1e859b5ead71ed4d370aa81", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/6d6dd52bc198e03da1e859b5ead71ed4d370aa81", "message": "Update for loop formatting\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2020-04-14T15:26:20Z", "type": "commit"}, {"oid": "9f2533644c5bbcf251baf976a9d1a462e88c122b", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/9f2533644c5bbcf251baf976a9d1a462e88c122b", "message": "Update reference logic\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2020-04-14T16:17:01Z", "type": "commit"}, {"oid": "6e86f14f8164a410611639e01292a2b208bea029", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/6e86f14f8164a410611639e01292a2b208bea029", "message": "Use circleci v2.1 reuseable commands\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2020-04-14T16:53:37Z", "type": "commit"}, {"oid": "6376920538217ef93aebf1926e1ab01f543f5b44", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/6376920538217ef93aebf1926e1ab01f543f5b44", "message": "Hold off on commands and references. Verify split loop and list\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2020-04-14T18:00:44Z", "type": "commit"}, {"oid": "c5fd1ed50c58222ea73ea6ed3c65da860a180bac", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/c5fd1ed50c58222ea73ea6ed3c65da860a180bac", "message": "Single line tags list and fix commands indentation\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2020-04-14T18:17:30Z", "type": "commit"}, {"oid": "cf699d1ece7e8ad0000721487f4550076008acd9", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/cf699d1ece7e8ad0000721487f4550076008acd9", "message": "Comment out non cleanup jobs\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2020-04-14T18:31:46Z", "type": "commit"}, {"oid": "9e52d102f5043c9cff505e62049d7b4507dc9576", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/9e52d102f5043c9cff505e62049d7b4507dc9576", "message": "Fix image path variable references\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2020-04-14T18:43:07Z", "type": "commit"}, {"oid": "cb92568c8341c9d8d4ed9e16ec1c8f0387552444", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/cb92568c8341c9d8d4ed9e16ec1c8f0387552444", "message": "Add config list print\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2020-04-14T19:15:45Z", "type": "commit"}, {"oid": "7392ba4a3c053645d31cbc5e64c052a7587dd7f1", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/7392ba4a3c053645d31cbc5e64c052a7587dd7f1", "message": "Remove untagged old test master images\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2020-04-14T19:30:41Z", "type": "commit"}, {"oid": "1d2e01f3ba90860eeb970e3991f3048978b7e966", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/1d2e01f3ba90860eeb970e3991f3048978b7e966", "message": "Restore service account and project set\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2020-04-14T19:34:34Z", "type": "commit"}, {"oid": "049cf59fe21ca9fecbf77e78a18ab9dd508295af", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/049cf59fe21ca9fecbf77e78a18ab9dd508295af", "message": "Verify image tag filtering list\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2020-04-14T19:44:45Z", "type": "commit"}, {"oid": "df762048fd775426c13bbf21d343d0953742dc18", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/df762048fd775426c13bbf21d343d0953742dc18", "message": "echo final filter command to verify time param\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2020-04-14T19:56:22Z", "type": "commit"}, {"oid": "c1e7bf2c8e791221fa56ba8e395971891d3f1e4d", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/c1e7bf2c8e791221fa56ba8e395971891d3f1e4d", "message": "Fixed filter string format issue\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2020-04-14T20:20:55Z", "type": "commit"}, {"oid": "32095720ee2860e7b8db23a2239fc57f5182aa18", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/32095720ee2860e7b8db23a2239fc57f5182aa18", "message": "Add echo for delete command\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2020-04-14T20:35:32Z", "type": "commit"}, {"oid": "0f5d0501a403dd2a8d92054e96082e555712fc50", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/0f5d0501a403dd2a8d92054e96082e555712fc50", "message": "dry run of 19 hours\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2020-04-14T20:39:53Z", "type": "commit"}, {"oid": "267c256e0ee0b0a0c4ed9ff8ed1d60bedf6932d5", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/267c256e0ee0b0a0c4ed9ff8ed1d60bedf6932d5", "message": "Cleanup layout Leave delete commented out\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2020-04-14T20:48:06Z", "type": "commit"}, {"oid": "d70c881b54e53323618e14bfa69a173b54ab5922", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/d70c881b54e53323618e14bfa69a173b54ab5922", "message": "Force new image push 1\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2020-04-14T21:09:30Z", "type": "commit"}, {"oid": "e48e06adfd1b071f37fa5cd986ee6458a35362b2", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/e48e06adfd1b071f37fa5cd986ee6458a35362b2", "message": "Dry run for 7 days\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2020-04-14T21:42:39Z", "type": "commit"}, {"oid": "d4c1d45d165956f0f3cc4a38a970781741678fb3", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/d4c1d45d165956f0f3cc4a38a970781741678fb3", "message": "Fixed array loop and test 1 hour ago cleanup\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2020-04-14T21:59:37Z", "type": "commit"}, {"oid": "0f0b2da8a705c072bdd028018ebb5a376231041a", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/0f0b2da8a705c072bdd028018ebb5a376231041a", "message": "Test 2 hour ago cleanup\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2020-04-14T23:08:06Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODUxMzc5MQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/683#discussion_r408513791", "bodyText": "to-do: Set to \"-7 days\"", "author": "Nana-EC", "createdAt": "2020-04-15T00:33:51Z", "path": ".circleci/config.yml", "diffHunk": "@@ -35,8 +35,40 @@ references:\n           POSTGRES_PASSWORD: mirror_node_pass\n           POSTGRES_USER: mirror_node\n \n+commands:\n+  gcloud_image_clean:\n+    description: \"Cleans up old master images\"\n+    parameters:\n+      imagepath:\n+        type: string\n+        default: \"importer\"\n+    steps:\n+      - run:\n+          name: \"Cleans up old master images\"\n+          command: |\n+            DELETE_BEFORE=$(date --utc -d \"-2 hours\" '+%FT%TZ')", "originalCommit": "0f0b2da8a705c072bdd028018ebb5a376231041a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODUxMzkxNA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/683#discussion_r408513914", "bodyText": "remove echo of command", "author": "Nana-EC", "createdAt": "2020-04-15T00:34:14Z", "path": ".circleci/config.yml", "diffHunk": "@@ -35,8 +35,40 @@ references:\n           POSTGRES_PASSWORD: mirror_node_pass\n           POSTGRES_USER: mirror_node\n \n+commands:\n+  gcloud_image_clean:\n+    description: \"Cleans up old master images\"\n+    parameters:\n+      imagepath:\n+        type: string\n+        default: \"importer\"\n+    steps:\n+      - run:\n+          name: \"Cleans up old master images\"\n+          command: |\n+            DELETE_BEFORE=$(date --utc -d \"-2 hours\" '+%FT%TZ')\n+            echo DELETE_BEFORE: ${DELETE_BEFORE}\n+            IMAGE_PATH=gcr.io/mirrornode/hedera-mirror-<< parameters.imagepath >>\n+            echo IMAGE_PATH: ${IMAGE_PATH}\n+            echo List tags command: gcloud container images list-tags ${IMAGE_PATH} \\", "originalCommit": "0f0b2da8a705c072bdd028018ebb5a376231041a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODUxNDA4MA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/683#discussion_r408514080", "bodyText": "remove \"echo Command: \" once filter logic is confirmed to do deletes", "author": "Nana-EC", "createdAt": "2020-04-15T00:34:56Z", "path": ".circleci/config.yml", "diffHunk": "@@ -35,8 +35,40 @@ references:\n           POSTGRES_PASSWORD: mirror_node_pass\n           POSTGRES_USER: mirror_node\n \n+commands:\n+  gcloud_image_clean:\n+    description: \"Cleans up old master images\"\n+    parameters:\n+      imagepath:\n+        type: string\n+        default: \"importer\"\n+    steps:\n+      - run:\n+          name: \"Cleans up old master images\"\n+          command: |\n+            DELETE_BEFORE=$(date --utc -d \"-2 hours\" '+%FT%TZ')\n+            echo DELETE_BEFORE: ${DELETE_BEFORE}\n+            IMAGE_PATH=gcr.io/mirrornode/hedera-mirror-<< parameters.imagepath >>\n+            echo IMAGE_PATH: ${IMAGE_PATH}\n+            echo List tags command: gcloud container images list-tags ${IMAGE_PATH} \\\n+              --limit=1000 \\\n+              --sort-by=TIMESTAMP \\\n+              --filter=\"'tags:image* AND timestamp.datetime < ${DELETE_BEFORE}'\" \\\n+              --format=\"'get(digest)'\"\n+            OLD_IMAGES=$(gcloud container images list-tags ${IMAGE_PATH} \\\n+              --limit=1000 \\\n+              --sort-by=TIMESTAMP \\\n+              --filter=\"tags:image* AND timestamp.datetime < ${DELETE_BEFORE}\" \\\n+              --format=\"get(digest)\")\n+            for digest in ${OLD_IMAGES[*]}; do\n+            (\n+              echo Delete image: \"${IMAGE_PATH}@${digest}\"\n+              echo Command: gcloud container images delete -q --force-delete-tags \"${IMAGE_PATH}@${digest}\"", "originalCommit": "0f0b2da8a705c072bdd028018ebb5a376231041a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTA1MzQ4Mw==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/683#discussion_r409053483", "bodyText": "Leaving for #689 to resolve", "author": "Nana-EC", "createdAt": "2020-04-15T18:38:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODUxNDA4MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODUxNDE2Mw==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/683#discussion_r408514163", "bodyText": "remove image-deploy-cleanup and leave only master", "author": "Nana-EC", "createdAt": "2020-04-15T00:35:18Z", "path": ".circleci/config.yml", "diffHunk": "@@ -66,7 +98,10 @@ workflows:\n             - build_rest\n           filters:\n             branches:\n-              ignore: /.*/\n+              only:\n+                - master\n+                # image-deploy-cleanup branch present for testing to be removed\n+                - image-deploy-cleanup", "originalCommit": "0f0b2da8a705c072bdd028018ebb5a376231041a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODUxNDI5MQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/683#discussion_r408514291", "bodyText": "set tag filter to be \"master-\" instead of current \"image\"", "author": "Nana-EC", "createdAt": "2020-04-15T00:35:52Z", "path": ".circleci/config.yml", "diffHunk": "@@ -35,8 +35,40 @@ references:\n           POSTGRES_PASSWORD: mirror_node_pass\n           POSTGRES_USER: mirror_node\n \n+commands:\n+  gcloud_image_clean:\n+    description: \"Cleans up old master images\"\n+    parameters:\n+      imagepath:\n+        type: string\n+        default: \"importer\"\n+    steps:\n+      - run:\n+          name: \"Cleans up old master images\"\n+          command: |\n+            DELETE_BEFORE=$(date --utc -d \"-2 hours\" '+%FT%TZ')\n+            echo DELETE_BEFORE: ${DELETE_BEFORE}\n+            IMAGE_PATH=gcr.io/mirrornode/hedera-mirror-<< parameters.imagepath >>\n+            echo IMAGE_PATH: ${IMAGE_PATH}\n+            echo List tags command: gcloud container images list-tags ${IMAGE_PATH} \\\n+              --limit=1000 \\\n+              --sort-by=TIMESTAMP \\\n+              --filter=\"'tags:image* AND timestamp.datetime < ${DELETE_BEFORE}'\" \\\n+              --format=\"'get(digest)'\"\n+            OLD_IMAGES=$(gcloud container images list-tags ${IMAGE_PATH} \\\n+              --limit=1000 \\\n+              --sort-by=TIMESTAMP \\\n+              --filter=\"tags:image* AND timestamp.datetime < ${DELETE_BEFORE}\" \\", "originalCommit": "0f0b2da8a705c072bdd028018ebb5a376231041a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "2601f68013d33373c5465ef9b412635e9511e2f9", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/2601f68013d33373c5465ef9b412635e9511e2f9", "message": "4 hours ago test\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2020-04-15T01:59:57Z", "type": "commit"}, {"oid": "528db9c12a7fa760a16a695c3dc0d6d7c8328022", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/528db9c12a7fa760a16a695c3dc0d6d7c8328022", "message": "6 hours test\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2020-04-15T04:15:06Z", "type": "commit"}, {"oid": "77b5a9a1bfd1e68d5106f6d35e06d08c50321f01", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/77b5a9a1bfd1e68d5106f6d35e06d08c50321f01", "message": "6 hours test 2\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2020-04-15T04:34:05Z", "type": "commit"}, {"oid": "e8c881984fc71d7f4097d5cfa044639b73d2abf5", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/e8c881984fc71d7f4097d5cfa044639b73d2abf5", "message": "14 hours test 1\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2020-04-15T13:36:34Z", "type": "commit"}, {"oid": "6f8cb5433d9c96eb1cc760ab8cda936867bdee70", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/6f8cb5433d9c96eb1cc760ab8cda936867bdee70", "message": "14 hours test 2\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2020-04-15T13:38:37Z", "type": "commit"}, {"oid": "7935c729ccf3172a280c80cd2b24d9ad82ca85f9", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/7935c729ccf3172a280c80cd2b24d9ad82ca85f9", "message": "14 hours test 3\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2020-04-15T13:49:12Z", "type": "commit"}, {"oid": "12b112d5c78b2d145955d48e15daead8ba68c7b6", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/12b112d5c78b2d145955d48e15daead8ba68c7b6", "message": "Use csv formatting to get digest and timestamp\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2020-04-15T15:01:51Z", "type": "commit"}, {"oid": "5ccda0c65616da534440e0a1686a742fa4eebeed", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/5ccda0c65616da534440e0a1686a742fa4eebeed", "message": "Escape cahrs for v2.1\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2020-04-15T15:20:38Z", "type": "commit"}, {"oid": "60598c66cd023e8d6af4e5adbae01e5b0b7e6e93", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/60598c66cd023e8d6af4e5adbae01e5b0b7e6e93", "message": "removed braces\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2020-04-15T15:35:01Z", "type": "commit"}, {"oid": "98f7d46f1976c514225e2d347cf13b599a4a7243", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/98f7d46f1976c514225e2d347cf13b599a4a7243", "message": "Modify date format\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2020-04-15T15:50:17Z", "type": "commit"}, {"oid": "b22efa885c02b5a9e639985263ad72b10f344775", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/b22efa885c02b5a9e639985263ad72b10f344775", "message": "Removed UTC config\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2020-04-15T16:01:48Z", "type": "commit"}, {"oid": "5bb0cccd5e82eca14940f9297e3ebb2ae920e29c", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/5bb0cccd5e82eca14940f9297e3ebb2ae920e29c", "message": "Add echo for bash env check\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2020-04-15T16:59:52Z", "type": "commit"}, {"oid": "f3ac941d92ea2066093e24815a957294cad9ec82", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/f3ac941d92ea2066093e24815a957294cad9ec82", "message": "Test filter timestamp formats\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2020-04-15T17:30:10Z", "type": "commit"}, {"oid": "9c7e56cccd6c017c36a96f6aa7876ea1c3197407", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/9c7e56cccd6c017c36a96f6aa7876ea1c3197407", "message": "Test filter timestamp formats 2\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2020-04-15T17:43:30Z", "type": "commit"}, {"oid": "25ed5923367e40c7ea1ec7a446273a38c13d1768", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/25ed5923367e40c7ea1ec7a446273a38c13d1768", "message": "7 days ago test\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2020-04-15T17:57:41Z", "type": "commit"}, {"oid": "2a2fcab53856d11f539bc2c291c815d164ab699e", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/2a2fcab53856d11f539bc2c291c815d164ab699e", "message": "2 days ago test\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2020-04-15T18:07:57Z", "type": "commit"}, {"oid": "f9d5281ca52f36879882d5ac664b86d67c1c1d76", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/f9d5281ca52f36879882d5ac664b86d67c1c1d76", "message": "Removed test branch logic\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2020-04-15T18:27:50Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTA4OTcwNw==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/683#discussion_r409089707", "bodyText": "just docker.version.tag and docker.latest.tag since tag's and push are orthogonal concepts. You can have tags without needing to push.\nRemove 'push' from the name.\nLet's rename to docker.tag.version and docker.tag.latest", "author": "apeksharma", "createdAt": "2020-04-15T19:42:07Z", "path": "pom.xml", "diffHunk": "@@ -55,6 +55,8 @@\n     <properties>\n         <disruptor.version>3.4.2</disruptor.version> <!-- Used for asynchronous logging -->\n         <docker.push.repository>gcr.io/mirrornode</docker.push.repository>\n+        <docker.push.version.tag>${project.version}</docker.push.version.tag>", "originalCommit": "f9d5281ca52f36879882d5ac664b86d67c1c1d76", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTIwOTc0NA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/683#discussion_r409209744", "bodyText": "Sure", "author": "Nana-EC", "createdAt": "2020-04-16T00:25:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTA4OTcwNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTA5MTYwMA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/683#discussion_r409091600", "bodyText": "no need for profile. Directly override docker.tag.version property from command line.\nhttps://stackoverflow.com/a/13709976/895111", "author": "apeksharma", "createdAt": "2020-04-15T19:45:53Z", "path": "pom.xml", "diffHunk": "@@ -84,6 +86,21 @@\n         </dependencies>\n     </dependencyManagement>\n \n+    <profiles>", "originalCommit": "f9d5281ca52f36879882d5ac664b86d67c1c1d76", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTIxMDY0MA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/683#discussion_r409210640", "bodyText": "I considered this first but went profile way. I can revert to that.", "author": "Nana-EC", "createdAt": "2020-04-16T00:28:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTA5MTYwMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTA5NTUzNg==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/683#discussion_r409095536", "bodyText": "Am okay with cleanup on every master commit.\nAlternate suggestion would be to cleanup once every 2 week when version is tagged.", "author": "apeksharma", "createdAt": "2020-04-15T19:53:33Z", "path": ".circleci/config.yml", "diffHunk": "@@ -75,6 +106,15 @@ workflows:\n               only: /.*/\n             tags:\n               only: /.*/\n+      - cleanup_images:\n+          requires:\n+            - publish_images\n+          filters:\n+            branches:\n+              only:\n+                - master", "originalCommit": "f9d5281ca52f36879882d5ac664b86d67c1c1d76", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTIxMjI3Mg==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/683#discussion_r409212272", "bodyText": "Doing every 2 weeks would mean for those 2 weeks the image counts just going up. Really depends on how many PR's we have going through.", "author": "Nana-EC", "createdAt": "2020-04-16T00:34:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTA5NTUzNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTA5NjM5NQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/683#discussion_r409096395", "bodyText": "should be 2\nhttps://circleci.com/docs/2.0/configuration-reference/#version-1", "author": "apeksharma", "createdAt": "2020-04-15T19:55:03Z", "path": ".circleci/config.yml", "diffHunk": "@@ -35,8 +35,38 @@ references:\n           POSTGRES_PASSWORD: mirror_node_pass\n           POSTGRES_USER: mirror_node\n \n+commands:\n+  gcloud_image_clean:\n+    description: \"Cleans up old master images\"\n+    parameters:\n+      imagepath:\n+        type: string\n+        default: \"importer\"\n+    steps:\n+      - run:\n+          name: \"Clean up old master images\"\n+          command: |\n+            echo $0\n+            DELETE_BEFORE=$(date -d \"-7 days\" '+%FT%T')\n+            echo DELETE_BEFORE: ${DELETE_BEFORE}\n+            IMAGE_PATH=gcr.io/mirrornode/hedera-mirror-<< parameters.imagepath >>\n+            echo IMAGE_PATH: ${IMAGE_PATH}\n+            OLD_IMAGES=$(gcloud container images list-tags ${IMAGE_PATH} \\\n+              --limit=1000 \\\n+              --sort-by=TIMESTAMP \\\n+              --filter=\"tags:master-* AND timestamp.datetime < '${DELETE_BEFORE}'\" \\\n+              --format=\"csv[no-heading](digest,timestamp)\")\n+            echo OLD_IMAGES: ${OLD_IMAGES}\n+            for image in ${OLD_IMAGES[*]}; do\n+            (\n+              IFS=, read digest timestamp \\<<< ${image}\n+              echo Delete image: \"${IMAGE_PATH}@${digest} created on ${timestamp}\"\n+              echo Command: gcloud container images delete -q --force-delete-tags \"${IMAGE_PATH}@${digest}\"\n+            )\n+            done\n+\n workflows:\n-  version: 2\n+  version: 2.1", "originalCommit": "f9d5281ca52f36879882d5ac664b86d67c1c1d76", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTIxNDE1NA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/683#discussion_r409214154", "bodyText": "This works as is. Is there a reason to go down? I had wanted to remove this but it wouldn't validate without the version.", "author": "Nana-EC", "createdAt": "2020-04-16T00:40:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTA5NjM5NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTIyNzkxMw==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/683#discussion_r409227913", "bodyText": "Did the revert", "author": "Nana-EC", "createdAt": "2020-04-16T01:30:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTA5NjM5NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTA5NzUxNw==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/683#discussion_r409097517", "bodyText": "line not needed.", "author": "apeksharma", "createdAt": "2020-04-15T19:57:09Z", "path": ".circleci/config.yml", "diffHunk": "@@ -235,5 +275,26 @@ jobs:\n       - *restore_maven_cache\n       - run:\n           name: Running maven deploy\n-          command: ./mvnw ${MAVEN_CLI_OPTS} deploy -DskipTests\n+          command: |\n+            DOCKERPUSHTAG=", "originalCommit": "f9d5281ca52f36879882d5ac664b86d67c1c1d76", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTIxNDI4NQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/683#discussion_r409214285", "bodyText": "Removing", "author": "Nana-EC", "createdAt": "2020-04-16T00:41:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTA5NzUxNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTA5OTEyNQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/683#discussion_r409099125", "bodyText": "After the pom profile is removed, we should override docker.tag.version here only if DOCKERPUSHTAG is set.\nnit: Rename the variable to DOCKER_TAG_VERSION_OVERRIDE", "author": "apeksharma", "createdAt": "2020-04-15T20:00:08Z", "path": ".circleci/config.yml", "diffHunk": "@@ -235,5 +275,26 @@ jobs:\n       - *restore_maven_cache\n       - run:\n           name: Running maven deploy\n-          command: ./mvnw ${MAVEN_CLI_OPTS} deploy -DskipTests\n+          command: |\n+            DOCKERPUSHTAG=\n+            if [ \"$CIRCLE_BRANCH\" = \"master\" ]; then\n+                DOCKERPUSHTAG=${CIRCLE_BRANCH}-${CIRCLE_SHA1}\n+            fi\n+            echo DOCKERPUSHTAG: ${DOCKERPUSHTAG}\n+            ./mvnw ${MAVEN_CLI_OPTS} deploy -DskipTests -Dcircle.docker.tag=${DOCKERPUSHTAG}", "originalCommit": "f9d5281ca52f36879882d5ac664b86d67c1c1d76", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTIxNDY4OA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/683#discussion_r409214688", "bodyText": "There's actually 2 items to override here - version and latest. I'll use a single variable to create the extra string for the command, which will only be set in the appropriate case", "author": "Nana-EC", "createdAt": "2020-04-16T00:42:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTA5OTEyNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTEwMzQ4Nw==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/683#discussion_r409103487", "bodyText": "what does this output?", "author": "apeksharma", "createdAt": "2020-04-15T20:08:10Z", "path": ".circleci/config.yml", "diffHunk": "@@ -35,8 +35,38 @@ references:\n           POSTGRES_PASSWORD: mirror_node_pass\n           POSTGRES_USER: mirror_node\n \n+commands:\n+  gcloud_image_clean:\n+    description: \"Cleans up old master images\"\n+    parameters:\n+      imagepath:\n+        type: string\n+        default: \"importer\"\n+    steps:\n+      - run:\n+          name: \"Clean up old master images\"\n+          command: |\n+            echo $0", "originalCommit": "f9d5281ca52f36879882d5ac664b86d67c1c1d76", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTIxNTI3Mg==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/683#discussion_r409215272", "bodyText": "Left over troubleshooting. Was checking console bash .\nRemoved", "author": "Nana-EC", "createdAt": "2020-04-16T00:44:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTEwMzQ4Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTEwNTE5NQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/683#discussion_r409105195", "bodyText": "you can add set -x at the top, very helpful in debugging. Then no need to echo each variable.\nWe can leave it there, no need to remove before committing since the output will be tiny and useful.", "author": "apeksharma", "createdAt": "2020-04-15T20:11:34Z", "path": ".circleci/config.yml", "diffHunk": "@@ -35,8 +35,38 @@ references:\n           POSTGRES_PASSWORD: mirror_node_pass\n           POSTGRES_USER: mirror_node\n \n+commands:\n+  gcloud_image_clean:\n+    description: \"Cleans up old master images\"\n+    parameters:\n+      imagepath:\n+        type: string\n+        default: \"importer\"\n+    steps:\n+      - run:\n+          name: \"Clean up old master images\"\n+          command: |\n+            echo $0\n+            DELETE_BEFORE=$(date -d \"-7 days\" '+%FT%T')\n+            echo DELETE_BEFORE: ${DELETE_BEFORE}", "originalCommit": "f9d5281ca52f36879882d5ac664b86d67c1c1d76", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTIxNTYwNg==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/683#discussion_r409215606", "bodyText": "Good idea", "author": "Nana-EC", "createdAt": "2020-04-16T00:46:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTEwNTE5NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTEwNzIzOA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/683#discussion_r409107238", "bodyText": "there is no need for a limit here in our case, so we should not put one.", "author": "apeksharma", "createdAt": "2020-04-15T20:15:19Z", "path": ".circleci/config.yml", "diffHunk": "@@ -35,8 +35,38 @@ references:\n           POSTGRES_PASSWORD: mirror_node_pass\n           POSTGRES_USER: mirror_node\n \n+commands:\n+  gcloud_image_clean:\n+    description: \"Cleans up old master images\"\n+    parameters:\n+      imagepath:\n+        type: string\n+        default: \"importer\"\n+    steps:\n+      - run:\n+          name: \"Clean up old master images\"\n+          command: |\n+            echo $0\n+            DELETE_BEFORE=$(date -d \"-7 days\" '+%FT%T')\n+            echo DELETE_BEFORE: ${DELETE_BEFORE}\n+            IMAGE_PATH=gcr.io/mirrornode/hedera-mirror-<< parameters.imagepath >>\n+            echo IMAGE_PATH: ${IMAGE_PATH}\n+            OLD_IMAGES=$(gcloud container images list-tags ${IMAGE_PATH} \\\n+              --limit=1000 \\", "originalCommit": "f9d5281ca52f36879882d5ac664b86d67c1c1d76", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTIxNTg1Mg==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/683#discussion_r409215852", "bodyText": "True, unlikely we'd hit our limit between the time master builds occur. I just like it as good practice on a query.", "author": "Nana-EC", "createdAt": "2020-04-16T00:47:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTEwNzIzOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTEwOTkwNg==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/683#discussion_r409109906", "bodyText": "When we tag a version, it'll create image with same sha, and tag an existing image (pushed as master-<sha>) with vX.Y.Z). Wouldn't --force-delete-tags` remove that image too? We want to keep around images for released versions.\nIrrespective, --force-delete-tags is dangerous in first iteration, let's remove it.", "author": "apeksharma", "createdAt": "2020-04-15T20:20:38Z", "path": ".circleci/config.yml", "diffHunk": "@@ -35,8 +35,38 @@ references:\n           POSTGRES_PASSWORD: mirror_node_pass\n           POSTGRES_USER: mirror_node\n \n+commands:\n+  gcloud_image_clean:\n+    description: \"Cleans up old master images\"\n+    parameters:\n+      imagepath:\n+        type: string\n+        default: \"importer\"\n+    steps:\n+      - run:\n+          name: \"Clean up old master images\"\n+          command: |\n+            echo $0\n+            DELETE_BEFORE=$(date -d \"-7 days\" '+%FT%T')\n+            echo DELETE_BEFORE: ${DELETE_BEFORE}\n+            IMAGE_PATH=gcr.io/mirrornode/hedera-mirror-<< parameters.imagepath >>\n+            echo IMAGE_PATH: ${IMAGE_PATH}\n+            OLD_IMAGES=$(gcloud container images list-tags ${IMAGE_PATH} \\\n+              --limit=1000 \\\n+              --sort-by=TIMESTAMP \\\n+              --filter=\"tags:master-* AND timestamp.datetime < '${DELETE_BEFORE}'\" \\\n+              --format=\"csv[no-heading](digest,timestamp)\")\n+            echo OLD_IMAGES: ${OLD_IMAGES}\n+            for image in ${OLD_IMAGES[*]}; do\n+            (\n+              IFS=, read digest timestamp \\<<< ${image}\n+              echo Delete image: \"${IMAGE_PATH}@${digest} created on ${timestamp}\"\n+              echo Command: gcloud container images delete -q --force-delete-tags \"${IMAGE_PATH}@${digest}\"", "originalCommit": "f9d5281ca52f36879882d5ac664b86d67c1c1d76", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTExMjk4Mw==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/683#discussion_r409112983", "bodyText": "A better way would be:\n\nuntag all master-<sha> older than 7 days.\nDelete all untagged images", "author": "apeksharma", "createdAt": "2020-04-15T20:26:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTEwOTkwNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTIyNjAyOQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/683#discussion_r409226029", "bodyText": "So that actually won't happen. The master tags are only added for the master branch.\nWhen you tag a version it actually doesn't have a circle ci branch, the value is empty.\nSee\nhttps://app.circleci.com/pipelines/github/hashgraph/hedera-mirror-node/1862/workflows/0afb9a24-135c-4646-9db0-5a0510c0e812/jobs/3948\nvs\nhttps://app.circleci.com/pipelines/github/hashgraph/hedera-mirror-node/1863/workflows/d306e28d-4fdb-4c4c-8d2b-59b18856bbd4/jobs/3954\nAlso no release version will have the same sha as master. Release version happen in their own branch with their own changes that won't match a master version\nSo when we tag a release the image tags will be as is x.y.z and latest tags will be added to a new image", "author": "Nana-EC", "createdAt": "2020-04-16T01:23:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTEwOTkwNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTIyNjE0OA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/683#discussion_r409226148", "bodyText": "Reason I don't want to delete untagged images is cause as we speak there's one release image that isn't tagged. Not sure if that was a mistake but it could happen.\nI'd rather intentionally delete tags when they are identifiable as master and release tags won't intersect.\nIt's a fair strategy though so I'll think on it.", "author": "Nana-EC", "createdAt": "2020-04-16T01:24:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTEwOTkwNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTI1MTE1Nw==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/683#discussion_r409251157", "bodyText": "I can't see a reason to keep untagged images in the repo. If an image has a reason to be in that repo, the reason should be its tag, like - master-<sha>, v0.9.0-rc1 or <reason> (for circumstances not discernible).\nIf there is an untagged image, let's delete it/tag it.\nFor the case i mentioned earlier, we tag v0.X.0-rc1 on master commits.\nSo i was wondering if the images pushed when (1) commit was merged into master and (2) on tagging the commit, would be same. I quickly tried testing it by pushing vTest on a commit of this PR's branch, but it resulted in different sha. I was expecting them to be same, but apparently they are not (maybe since at least the git.properties file differ).\nSo i guess it's okay.\nI'd still prefer not doing force deletes, rather untag them and then clear all untagged images. But i leave it to your's and steven's preferences.", "author": "apeksharma", "createdAt": "2020-04-16T02:56:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTEwOTkwNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTY2Mzc5Mg==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/683#discussion_r409663792", "bodyText": "Seriously, good point. I thought about it a bit more and revisited the docs and I think this is the cause of the discrepancies I was seeing.\n--force-delete-tags Deletes the image (and tags) from the input IMAGE_NAME:\nhttps://cloud.google.com/sdk/gcloud/reference/beta/container/images/delete\nUntagging old images for future delete might be the better way indeed. Thanks.\nLet me try this out. Next commit will have this change and support to test it out so bare with me", "author": "Nana-EC", "createdAt": "2020-04-16T15:50:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTEwOTkwNg=="}], "type": "inlineReview"}, {"oid": "56e0d77d708f5e81cc9ab22351455d9e98fb34ac", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/56e0d77d708f5e81cc9ab22351455d9e98fb34ac", "message": "Addressed feedback and added publsih test logic\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2020-04-16T01:29:38Z", "type": "commit"}, {"oid": "03763b1cf1b0bd693e6718e28e10e3c6b6e2930f", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/03763b1cf1b0bd693e6718e28e10e3c6b6e2930f", "message": "Removed branch publish test logic\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2020-04-16T01:37:36Z", "type": "commit"}, {"oid": "19091e1de2451c284b2e83937beb6a69553c76b6", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/19091e1de2451c284b2e83937beb6a69553c76b6", "message": "Add untag logic and modify delete to delete untagged\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2020-04-16T16:00:42Z", "type": "commit"}, {"oid": "face7169a04da01326ff2d82340092dd46a38090", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/face7169a04da01326ff2d82340092dd46a38090", "message": "24 hours untag test\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2020-04-16T16:50:05Z", "type": "commit"}, {"oid": "9aa2091b5c9b033b6a198a28c1efba5924f44108", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/9aa2091b5c9b033b6a198a28c1efba5924f44108", "message": "24 hours untag test 2\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2020-04-16T17:26:50Z", "type": "commit"}, {"oid": "0585ba0c44abf7701f0c3cce31e065c1a6e17c1e", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/0585ba0c44abf7701f0c3cce31e065c1a6e17c1e", "message": "Fix tag filter\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2020-04-16T17:50:36Z", "type": "commit"}, {"oid": "b5942c819449ac90f867cbd0ae952d6db4bf3953", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/b5942c819449ac90f867cbd0ae952d6db4bf3953", "message": "Real untag clean up 24 hours\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2020-04-16T18:10:21Z", "type": "commit"}, {"oid": "2bcda62f8ba20604f34786105250fb818bbb133b", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/2bcda62f8ba20604f34786105250fb818bbb133b", "message": "Add quiet option to untag\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2020-04-16T18:43:16Z", "type": "commit"}, {"oid": "0861861389d62064a330e1f8fd1cdf279a81d14b", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/0861861389d62064a330e1f8fd1cdf279a81d14b", "message": "Pull sha format for delete, no need for timestamp\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2020-04-16T20:44:04Z", "type": "commit"}, {"oid": "5152f1ba7ed6bd718e84f0734ecab59bb76a4b33", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/5152f1ba7ed6bd718e84f0734ecab59bb76a4b33", "message": "3 hours ago test\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2020-04-16T21:00:07Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTg0MjQ2OA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/683#discussion_r409842468", "bodyText": "We should add *.yaml as well", "author": "steven-sheehy", "createdAt": "2020-04-16T20:55:03Z", "path": "hedera-mirror-rest/.prettierignore", "diffHunk": "@@ -3,4 +3,5 @@ charts/**\n hedera-mirror-importer/**\n hedera-mirror-grpc/**\n hedera-mirror-datagenerator/**\n+*.yml", "originalCommit": "0861861389d62064a330e1f8fd1cdf279a81d14b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTg1Mzc1Mw==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/683#discussion_r409853753", "bodyText": "Should be set -ex to fail fast", "author": "steven-sheehy", "createdAt": "2020-04-16T21:17:27Z", "path": ".circleci/config.yml", "diffHunk": "@@ -35,6 +35,55 @@ references:\n           POSTGRES_PASSWORD: mirror_node_pass\n           POSTGRES_USER: mirror_node\n \n+commands:\n+  gcloud_image_untag:\n+    description: \"Untags old master images\"\n+    parameters:\n+      imagepath:\n+        type: string\n+        default: \"importer\"\n+    steps:\n+      - run:\n+          name: \"Untags old master images\"\n+          command: |\n+            set -x\n+            UNTAG_BEFORE=$(date -d \"-3 hours\" '+%FT%T')\n+            IMAGE_PATH=gcr.io/mirrornode/hedera-mirror-<< parameters.imagepath >>\n+            OLD_IMAGES=$(gcloud container images list-tags ${IMAGE_PATH} \\\n+              --limit=1000 \\\n+              --sort-by=TIMESTAMP \\\n+              --filter=\"tags:image-* AND timestamp.datetime < '${UNTAG_BEFORE}'\" \\\n+              --format=\"csv[no-heading](digest,tags,timestamp)\")\n+            for image in ${OLD_IMAGES[*]}; do\n+            (\n+              IFS=, read digest tag timestamp \\<<< ${image}\n+              gcloud container images untag -q \"${IMAGE_PATH}:${tag}\"\n+            )\n+            done\n+  gcloud_image_delete:\n+    description: \"Deletes old untagged images\"\n+    parameters:\n+      imagepath:\n+        type: string\n+        default: \"importer\"\n+    steps:\n+      - run:\n+          name: \"Deletes old untagged images\"\n+          command: |\n+            set -x", "originalCommit": "5152f1ba7ed6bd718e84f0734ecab59bb76a4b33", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTg1Mzc5NA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/683#discussion_r409853794", "bodyText": "Should be set -ex to fail fast", "author": "steven-sheehy", "createdAt": "2020-04-16T21:17:32Z", "path": ".circleci/config.yml", "diffHunk": "@@ -35,6 +35,55 @@ references:\n           POSTGRES_PASSWORD: mirror_node_pass\n           POSTGRES_USER: mirror_node\n \n+commands:\n+  gcloud_image_untag:\n+    description: \"Untags old master images\"\n+    parameters:\n+      imagepath:\n+        type: string\n+        default: \"importer\"\n+    steps:\n+      - run:\n+          name: \"Untags old master images\"\n+          command: |\n+            set -x", "originalCommit": "5152f1ba7ed6bd718e84f0734ecab59bb76a4b33", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTg2MDIzOA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/683#discussion_r409860238", "bodyText": "Technically we can just untag and then directly delete, right? Then we shouldn't really need gcloud_image_delete as all images should be tagged going forward. Would prefer to combine the two functions somehow.", "author": "steven-sheehy", "createdAt": "2020-04-16T21:30:55Z", "path": ".circleci/config.yml", "diffHunk": "@@ -35,6 +35,55 @@ references:\n           POSTGRES_PASSWORD: mirror_node_pass\n           POSTGRES_USER: mirror_node\n \n+commands:\n+  gcloud_image_untag:\n+    description: \"Untags old master images\"\n+    parameters:\n+      imagepath:\n+        type: string\n+        default: \"importer\"\n+    steps:\n+      - run:\n+          name: \"Untags old master images\"\n+          command: |\n+            set -x\n+            UNTAG_BEFORE=$(date -d \"-3 hours\" '+%FT%T')\n+            IMAGE_PATH=gcr.io/mirrornode/hedera-mirror-<< parameters.imagepath >>\n+            OLD_IMAGES=$(gcloud container images list-tags ${IMAGE_PATH} \\\n+              --limit=1000 \\\n+              --sort-by=TIMESTAMP \\\n+              --filter=\"tags:image-* AND timestamp.datetime < '${UNTAG_BEFORE}'\" \\\n+              --format=\"csv[no-heading](digest,tags,timestamp)\")\n+            for image in ${OLD_IMAGES[*]}; do\n+            (\n+              IFS=, read digest tag timestamp \\<<< ${image}\n+              gcloud container images untag -q \"${IMAGE_PATH}:${tag}\"", "originalCommit": "5152f1ba7ed6bd718e84f0734ecab59bb76a4b33", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTg3NzMzNA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/683#discussion_r409877334", "bodyText": "Can do.\nI had considered that but wanted to leave the opportunity of a few seconds passing by between untag and delete incase gcloud had issues.\nAlso I wanted the delete to be able to capture untagged images that were already untagged prior to this run e.g. say there's a failure to delete on one run but images were untagged. You'd want the next run to not be limited to images that are being untagged in the given run.\nI can make it one function but would recommend still 2 searches i.e 2 image lists", "author": "Nana-EC", "createdAt": "2020-04-16T22:09:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTg2MDIzOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDI5NDIyMQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/683#discussion_r410294221", "bodyText": "Thought about it a bit more and chatted offline.\nI think it's valuable to have them separate. If there's ever a case where some tags don't get deleted we'd want the delete step to pick them up on the next round and not be limited to only tags that were just untagged.\nLeaving as is.", "author": "Nana-EC", "createdAt": "2020-04-17T15:21:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTg2MDIzOA=="}], "type": "inlineReview"}, {"oid": "dc2f662230aae819bc88e7a39fa6b6fb6605427c", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/dc2f662230aae819bc88e7a39fa6b6fb6605427c", "message": " Address fedback and remove brnach logic\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2020-04-16T22:56:09Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDM5ODc3NA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/683#discussion_r410398774", "bodyText": "We probably don't need to cleanup images on tags, just master commits, right?", "author": "steven-sheehy", "createdAt": "2020-04-17T18:29:20Z", "path": ".circleci/config.yml", "diffHunk": "@@ -75,6 +125,15 @@ workflows:\n               only: /.*/\n             tags:\n               only: /.*/\n+      - cleanup_images:\n+          requires:\n+            - publish_images\n+          filters:\n+            branches:\n+              only:\n+                - master\n+            tags:\n+              only: /^.*/", "originalCommit": "dc2f662230aae819bc88e7a39fa6b6fb6605427c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDQ3NTc4Nw==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/683#discussion_r410475787", "bodyText": "Yeah just master.", "author": "Nana-EC", "createdAt": "2020-04-17T21:20:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDM5ODc3NA=="}], "type": "inlineReview"}, {"oid": "58a9f14357fe26cb99e5d0fb12e6ad051fe9b35a", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/58a9f14357fe26cb99e5d0fb12e6ad051fe9b35a", "message": "Removed tag filter for cleanup_images\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2020-04-17T21:24:17Z", "type": "commit"}]}