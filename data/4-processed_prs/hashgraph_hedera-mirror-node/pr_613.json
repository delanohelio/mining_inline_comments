{"pr_number": 613, "pr_title": "Add /topic/message/:consensusTimestamp API", "pr_createdAt": "2020-03-22T01:28:09Z", "pr_url": "https://github.com/hashgraph/hedera-mirror-node/pull/613", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjA0OTAzNg==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/613#discussion_r396049036", "bodyText": "Should be snake case to match the others: topic_id", "author": "steven-sheehy", "createdAt": "2020-03-22T02:56:07Z", "path": "hedera-mirror-rest/topic.js", "diffHunk": "@@ -0,0 +1,107 @@\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+'use strict';\n+const config = require('./config.js');\n+const utils = require('./utils.js');\n+\n+const validateParams = function(topicId, seqNum) {\n+  let badParams = [];\n+  if (!/^\\d{1,10}\\.\\d{1,10}\\.\\d{1,10}$/.test(topicId)) {\n+    badParams.push({message: `Invalid parameter: TOPIC_ID`});\n+  }\n+  if (!/^\\d+$/.test(seqNum)) {\n+    badParams.push({message: `Invalid parameter: SEQ_NUM`});\n+  }\n+  return utils.makeValidationResponse(badParams);\n+};\n+\n+const formatTopicMessageRow = function(topicId, row) {\n+  return {\n+    consensus_timestamp: parseInt(['consensus_timestamp']),\n+    topicId: topicId,", "originalCommit": "71eb68eb599c523b323923a00773c581d9038f90", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjA0OTExOQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/613#discussion_r396049119", "bodyText": "To match transactions API, we should format it the same way using utils.nsToSecNs", "author": "steven-sheehy", "createdAt": "2020-03-22T02:57:18Z", "path": "hedera-mirror-rest/topic.js", "diffHunk": "@@ -0,0 +1,107 @@\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+'use strict';\n+const config = require('./config.js');\n+const utils = require('./utils.js');\n+\n+const validateParams = function(topicId, seqNum) {\n+  let badParams = [];\n+  if (!/^\\d{1,10}\\.\\d{1,10}\\.\\d{1,10}$/.test(topicId)) {\n+    badParams.push({message: `Invalid parameter: TOPIC_ID`});\n+  }\n+  if (!/^\\d+$/.test(seqNum)) {\n+    badParams.push({message: `Invalid parameter: SEQ_NUM`});\n+  }\n+  return utils.makeValidationResponse(badParams);\n+};\n+\n+const formatTopicMessageRow = function(topicId, row) {\n+  return {\n+    consensus_timestamp: parseInt(['consensus_timestamp']),", "originalCommit": "71eb68eb599c523b323923a00773c581d9038f90", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjA0OTIzMw==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/613#discussion_r396049233", "bodyText": "We encode memo in other APIs to base64, so we should use that instead of hex for these byte[] fields. Also, base64 is more efficient in that it uses less characters: Hex will take two characters for each byte - Base64 takes 4 characters for every 3 bytes.", "author": "steven-sheehy", "createdAt": "2020-03-22T02:59:21Z", "path": "hedera-mirror-rest/topic.js", "diffHunk": "@@ -0,0 +1,107 @@\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+'use strict';\n+const config = require('./config.js');\n+const utils = require('./utils.js');\n+\n+const validateParams = function(topicId, seqNum) {\n+  let badParams = [];\n+  if (!/^\\d{1,10}\\.\\d{1,10}\\.\\d{1,10}$/.test(topicId)) {\n+    badParams.push({message: `Invalid parameter: TOPIC_ID`});\n+  }\n+  if (!/^\\d+$/.test(seqNum)) {\n+    badParams.push({message: `Invalid parameter: SEQ_NUM`});\n+  }\n+  return utils.makeValidationResponse(badParams);\n+};\n+\n+const formatTopicMessageRow = function(topicId, row) {\n+  return {\n+    consensus_timestamp: parseInt(['consensus_timestamp']),\n+    topicId: topicId,\n+    message: utils.toHexString(row['message']),", "originalCommit": "71eb68eb599c523b323923a00773c581d9038f90", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjA0OTQ5Ng==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/613#discussion_r396049496", "bodyText": "This should technically compare against config.hedera.mirror.shard and not assume shard is 0. It will be hard to track down all these places that hardcode shard later if we ever have multiple shards.", "author": "steven-sheehy", "createdAt": "2020-03-22T03:05:17Z", "path": "hedera-mirror-rest/topic.js", "diffHunk": "@@ -0,0 +1,107 @@\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+'use strict';\n+const config = require('./config.js');\n+const utils = require('./utils.js');\n+\n+const validateParams = function(topicId, seqNum) {\n+  let badParams = [];\n+  if (!/^\\d{1,10}\\.\\d{1,10}\\.\\d{1,10}$/.test(topicId)) {\n+    badParams.push({message: `Invalid parameter: TOPIC_ID`});\n+  }\n+  if (!/^\\d+$/.test(seqNum)) {\n+    badParams.push({message: `Invalid parameter: SEQ_NUM`});\n+  }\n+  return utils.makeValidationResponse(badParams);\n+};\n+\n+const formatTopicMessageRow = function(topicId, row) {\n+  return {\n+    consensus_timestamp: parseInt(['consensus_timestamp']),\n+    topicId: topicId,\n+    message: utils.toHexString(row['message']),\n+    running_hash: utils.toHexString(row['running_hash']),\n+    sequence_number: parseInt(row['sequence_number'])\n+  };\n+};\n+\n+const getMessage = function(topicId, seqNum, messageOnly, httpResponse) {\n+  const validationResult = validateParams(topicId, seqNum);\n+  if (!validationResult.isValid) {\n+    return new Promise((resolve, reject) => {\n+      resolve(validationResult);\n+    });\n+  }\n+\n+  let topicEntityId = utils.parseEntityId(topicId);\n+  if (parseInt(topicEntityId.shard) !== 0) {", "originalCommit": "71eb68eb599c523b323923a00773c581d9038f90", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjA0OTYzMw==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/613#discussion_r396049633", "bodyText": "nit: Should avoid string concatenation and use backticks for this and other logging statements: Multiple rows found for topicId ${topicId} and seqNum ${seqNum}", "author": "steven-sheehy", "createdAt": "2020-03-22T03:07:48Z", "path": "hedera-mirror-rest/topic.js", "diffHunk": "@@ -0,0 +1,107 @@\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+'use strict';\n+const config = require('./config.js');\n+const utils = require('./utils.js');\n+\n+const validateParams = function(topicId, seqNum) {\n+  let badParams = [];\n+  if (!/^\\d{1,10}\\.\\d{1,10}\\.\\d{1,10}$/.test(topicId)) {\n+    badParams.push({message: `Invalid parameter: TOPIC_ID`});\n+  }\n+  if (!/^\\d+$/.test(seqNum)) {\n+    badParams.push({message: `Invalid parameter: SEQ_NUM`});\n+  }\n+  return utils.makeValidationResponse(badParams);\n+};\n+\n+const formatTopicMessageRow = function(topicId, row) {\n+  return {\n+    consensus_timestamp: parseInt(['consensus_timestamp']),\n+    topicId: topicId,\n+    message: utils.toHexString(row['message']),\n+    running_hash: utils.toHexString(row['running_hash']),\n+    sequence_number: parseInt(row['sequence_number'])\n+  };\n+};\n+\n+const getMessage = function(topicId, seqNum, messageOnly, httpResponse) {\n+  const validationResult = validateParams(topicId, seqNum);\n+  if (!validationResult.isValid) {\n+    return new Promise((resolve, reject) => {\n+      resolve(validationResult);\n+    });\n+  }\n+\n+  let topicEntityId = utils.parseEntityId(topicId);\n+  if (parseInt(topicEntityId.shard) !== 0) {\n+    httpResponse.status(utils.httpStatusCodes.NOT_FOUND).send('not found');\n+    return;\n+  }\n+  const pgSqlQuery =\n+    'SELECT * FROM topic_message WHERE realm_num= ' +\n+    topicEntityId.realm +\n+    ' AND topic_num= ' +\n+    topicEntityId.num +\n+    ' AND sequence_number=' +\n+    seqNum;\n+  return pool.query(pgSqlQuery).then(results => {\n+    if (results.rows.length === 1) {\n+      let topicMessage = formatTopicMessageRow(topicId, results.rows[0]);\n+      if (messageOnly) {\n+        httpResponse.json(topicMessage.message);\n+      } else {\n+        httpResponse.json(topicMessage);\n+      }\n+    } else if (results.rows.length === 0) {\n+      httpResponse.status(utils.httpStatusCodes.NOT_FOUND).send('not found');\n+    } else {\n+      logger.error('Multiple rows found for topicId:' + topicId + ' seqNum:' + seqNum);", "originalCommit": "71eb68eb599c523b323923a00773c581d9038f90", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjA0OTcwOA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/613#discussion_r396049708", "bodyText": "Reminder to remove contents", "author": "steven-sheehy", "createdAt": "2020-03-22T03:09:15Z", "path": "hedera-mirror-rest/server.js", "diffHunk": "@@ -111,6 +112,9 @@ app.get(apiPrefix + '/transactions/:id', transactions.getOneTransaction);\n app.get(apiPrefix + '/balances', (req, res) => caches['balances'].getResponse(req, res, balances.getBalances));\n app.get(apiPrefix + '/accounts', (req, res) => caches['accounts'].getResponse(req, res, accounts.getAccounts));\n app.get(apiPrefix + '/accounts/:id', accounts.getOneAccount);\n+app.get(apiPrefix + '/topic/:topicId/message/:seqNum', topic.getMessageInfo);\n+app.get(apiPrefix + '/topic/:topicId/message/:seqNum/contents', topic.getMessageContents);", "originalCommit": "71eb68eb599c523b323923a00773c581d9038f90", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjA1MDA3Ng==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/613#discussion_r396050076", "bodyText": "nit: there's a results.rowCount field that gives you this value with better perf", "author": "Nana-EC", "createdAt": "2020-03-22T03:18:18Z", "path": "hedera-mirror-rest/topic.js", "diffHunk": "@@ -0,0 +1,107 @@\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+'use strict';\n+const config = require('./config.js');\n+const utils = require('./utils.js');\n+\n+const validateParams = function(topicId, seqNum) {\n+  let badParams = [];\n+  if (!/^\\d{1,10}\\.\\d{1,10}\\.\\d{1,10}$/.test(topicId)) {\n+    badParams.push({message: `Invalid parameter: TOPIC_ID`});\n+  }\n+  if (!/^\\d+$/.test(seqNum)) {\n+    badParams.push({message: `Invalid parameter: SEQ_NUM`});\n+  }\n+  return utils.makeValidationResponse(badParams);\n+};\n+\n+const formatTopicMessageRow = function(topicId, row) {\n+  return {\n+    consensus_timestamp: parseInt(['consensus_timestamp']),\n+    topicId: topicId,\n+    message: utils.toHexString(row['message']),\n+    running_hash: utils.toHexString(row['running_hash']),\n+    sequence_number: parseInt(row['sequence_number'])\n+  };\n+};\n+\n+const getMessage = function(topicId, seqNum, messageOnly, httpResponse) {\n+  const validationResult = validateParams(topicId, seqNum);\n+  if (!validationResult.isValid) {\n+    return new Promise((resolve, reject) => {\n+      resolve(validationResult);\n+    });\n+  }\n+\n+  let topicEntityId = utils.parseEntityId(topicId);\n+  if (parseInt(topicEntityId.shard) !== 0) {\n+    httpResponse.status(utils.httpStatusCodes.NOT_FOUND).send('not found');\n+    return;\n+  }\n+  const pgSqlQuery =\n+    'SELECT * FROM topic_message WHERE realm_num= ' +\n+    topicEntityId.realm +\n+    ' AND topic_num= ' +\n+    topicEntityId.num +\n+    ' AND sequence_number=' +\n+    seqNum;\n+  return pool.query(pgSqlQuery).then(results => {\n+    if (results.rows.length === 1) {", "originalCommit": "71eb68eb599c523b323923a00773c581d9038f90", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjA1MDE1OA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/613#discussion_r396050158", "bodyText": "You should add a limit = 1, to ensure you only get one result.\nI also had this message as overkill and took the first occurrence and warned on this instead of erroring.\nI think the limit would be best, I don't mind how you handle multiple if it happens.", "author": "Nana-EC", "createdAt": "2020-03-22T03:20:41Z", "path": "hedera-mirror-rest/topic.js", "diffHunk": "@@ -0,0 +1,107 @@\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+'use strict';\n+const config = require('./config.js');\n+const utils = require('./utils.js');\n+\n+const validateParams = function(topicId, seqNum) {\n+  let badParams = [];\n+  if (!/^\\d{1,10}\\.\\d{1,10}\\.\\d{1,10}$/.test(topicId)) {\n+    badParams.push({message: `Invalid parameter: TOPIC_ID`});\n+  }\n+  if (!/^\\d+$/.test(seqNum)) {\n+    badParams.push({message: `Invalid parameter: SEQ_NUM`});\n+  }\n+  return utils.makeValidationResponse(badParams);\n+};\n+\n+const formatTopicMessageRow = function(topicId, row) {\n+  return {\n+    consensus_timestamp: parseInt(['consensus_timestamp']),\n+    topicId: topicId,\n+    message: utils.toHexString(row['message']),\n+    running_hash: utils.toHexString(row['running_hash']),\n+    sequence_number: parseInt(row['sequence_number'])\n+  };\n+};\n+\n+const getMessage = function(topicId, seqNum, messageOnly, httpResponse) {\n+  const validationResult = validateParams(topicId, seqNum);\n+  if (!validationResult.isValid) {\n+    return new Promise((resolve, reject) => {\n+      resolve(validationResult);\n+    });\n+  }\n+\n+  let topicEntityId = utils.parseEntityId(topicId);\n+  if (parseInt(topicEntityId.shard) !== 0) {\n+    httpResponse.status(utils.httpStatusCodes.NOT_FOUND).send('not found');\n+    return;\n+  }\n+  const pgSqlQuery =\n+    'SELECT * FROM topic_message WHERE realm_num= ' +\n+    topicEntityId.realm +\n+    ' AND topic_num= ' +\n+    topicEntityId.num +\n+    ' AND sequence_number=' +\n+    seqNum;\n+  return pool.query(pgSqlQuery).then(results => {\n+    if (results.rows.length === 1) {\n+      let topicMessage = formatTopicMessageRow(topicId, results.rows[0]);\n+      if (messageOnly) {\n+        httpResponse.json(topicMessage.message);\n+      } else {\n+        httpResponse.json(topicMessage);\n+      }\n+    } else if (results.rows.length === 0) {\n+      httpResponse.status(utils.httpStatusCodes.NOT_FOUND).send('not found');\n+    } else {\n+      logger.error('Multiple rows found for topicId:' + topicId + ' seqNum:' + seqNum);", "originalCommit": "71eb68eb599c523b323923a00773c581d9038f90", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjA1MDMwNw==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/613#discussion_r396050307", "bodyText": "nit: Convention of other files is to pass in query and params i.e.\nconst pgSqlQuery =\n'SELECT * FROM topic_message WHERE realm_num= $1 AND topic_num= $2'\n\n' AND sequence_number= $3';\npool.query(pgSqlQuery, [topicEntityId.realm, topicEntityId.num, seqNum]).then...", "author": "Nana-EC", "createdAt": "2020-03-22T03:23:46Z", "path": "hedera-mirror-rest/topic.js", "diffHunk": "@@ -0,0 +1,107 @@\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+'use strict';\n+const config = require('./config.js');\n+const utils = require('./utils.js');\n+\n+const validateParams = function(topicId, seqNum) {\n+  let badParams = [];\n+  if (!/^\\d{1,10}\\.\\d{1,10}\\.\\d{1,10}$/.test(topicId)) {\n+    badParams.push({message: `Invalid parameter: TOPIC_ID`});\n+  }\n+  if (!/^\\d+$/.test(seqNum)) {\n+    badParams.push({message: `Invalid parameter: SEQ_NUM`});\n+  }\n+  return utils.makeValidationResponse(badParams);\n+};\n+\n+const formatTopicMessageRow = function(topicId, row) {\n+  return {\n+    consensus_timestamp: parseInt(['consensus_timestamp']),\n+    topicId: topicId,\n+    message: utils.toHexString(row['message']),\n+    running_hash: utils.toHexString(row['running_hash']),\n+    sequence_number: parseInt(row['sequence_number'])\n+  };\n+};\n+\n+const getMessage = function(topicId, seqNum, messageOnly, httpResponse) {\n+  const validationResult = validateParams(topicId, seqNum);\n+  if (!validationResult.isValid) {\n+    return new Promise((resolve, reject) => {\n+      resolve(validationResult);\n+    });\n+  }\n+\n+  let topicEntityId = utils.parseEntityId(topicId);\n+  if (parseInt(topicEntityId.shard) !== 0) {\n+    httpResponse.status(utils.httpStatusCodes.NOT_FOUND).send('not found');\n+    return;\n+  }\n+  const pgSqlQuery =\n+    'SELECT * FROM topic_message WHERE realm_num= ' +\n+    topicEntityId.realm +\n+    ' AND topic_num= ' +\n+    topicEntityId.num +\n+    ' AND sequence_number=' +\n+    seqNum;\n+  return pool.query(pgSqlQuery).then(results => {", "originalCommit": "71eb68eb599c523b323923a00773c581d9038f90", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "38576e2447dc81f21ccf2ec3a951b885689cff85", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/38576e2447dc81f21ccf2ec3a951b885689cff85", "message": "Add /message/:consensusTimestamp API.\n\nSigned-off-by: Apekshit Sharma <apekshit.sharma@hedera.com>", "committedDate": "2020-03-23T01:34:24Z", "type": "forcePushed"}, {"oid": "7ce92b339455e42cb2e044a046531597f9e8a8ad", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/7ce92b339455e42cb2e044a046531597f9e8a8ad", "message": "Add /message/:consensusTimestamp API\n\nCo-authored-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>\nSigned-off-by: Apekshit Sharma <apekshit.sharma@hedera.com>", "committedDate": "2020-03-23T01:42:53Z", "type": "commit"}, {"oid": "7ce92b339455e42cb2e044a046531597f9e8a8ad", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/7ce92b339455e42cb2e044a046531597f9e8a8ad", "message": "Add /message/:consensusTimestamp API\n\nCo-authored-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>\nSigned-off-by: Apekshit Sharma <apekshit.sharma@hedera.com>", "committedDate": "2020-03-23T01:42:53Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjIwNTY2MQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/613#discussion_r396205661", "bodyText": "q: it's a naming question but should we have named this 'topicmessage' instead of just 'message'?\ni.e. specific instead of general?\nJust a thought", "author": "Nana-EC", "createdAt": "2020-03-23T04:16:16Z", "path": "hedera-mirror-rest/server.js", "diffHunk": "@@ -105,12 +106,13 @@ let apiPrefix = '/api/v1';\n \n // routes\n app.get(apiPrefix + '/transactions', (req, res) =>\n-  caches['transactions'].getResponse(req, res, transactions.getTransactions)\n+        caches['transactions'].getResponse(req, res, transactions.getTransactions)\n );\n app.get(apiPrefix + '/transactions/:id', transactions.getOneTransaction);\n app.get(apiPrefix + '/balances', (req, res) => caches['balances'].getResponse(req, res, balances.getBalances));\n app.get(apiPrefix + '/accounts', (req, res) => caches['accounts'].getResponse(req, res, accounts.getAccounts));\n app.get(apiPrefix + '/accounts/:id', accounts.getOneAccount);\n+app.get(apiPrefix + '/message/:consensusTimestamp', message.getMessageByConsensusTimestamp);", "originalCommit": "7ce92b339455e42cb2e044a046531597f9e8a8ad", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjU5OTA4NQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/613#discussion_r396599085", "bodyText": "I changed it to /api/v1/topic/message/:consensusTimestamp. This will at least group it under a common path when we add /api/v1/topic/:id/message/:seqNum", "author": "steven-sheehy", "createdAt": "2020-03-23T16:48:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjIwNTY2MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjIwNTk4NA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/613#discussion_r396205984", "bodyText": "missing a unit test in utils.test.js for this method", "author": "Nana-EC", "createdAt": "2020-03-23T04:18:08Z", "path": "hedera-mirror-rest/utils.js", "diffHunk": "@@ -39,6 +40,11 @@ function isNumeric(n) {\n   return !isNaN(parseFloat(n)) && isFinite(n);\n }\n \n+const isValidTimestampParam = function(timestamp) {", "originalCommit": "7ce92b339455e42cb2e044a046531597f9e8a8ad", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjIwNjAyOQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/613#discussion_r396206029", "bodyText": "missing a unit test in utils.test.js for this method", "author": "Nana-EC", "createdAt": "2020-03-23T04:18:23Z", "path": "hedera-mirror-rest/utils.js", "diffHunk": "@@ -182,6 +189,18 @@ const parseEntityId = function(acc) {\n   return ret;\n };\n \n+const parseTimestampParam = function(timestampParam) {", "originalCommit": "7ce92b339455e42cb2e044a046531597f9e8a8ad", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjIwNjExOQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/613#discussion_r396206119", "bodyText": "missing a unit test in utils.test.js for this method", "author": "Nana-EC", "createdAt": "2020-03-23T04:18:54Z", "path": "hedera-mirror-rest/utils.js", "diffHunk": "@@ -140,9 +139,12 @@ const validateReq = function(req) {\n       }\n     }\n   }\n+  return makeValidationResponse(badParams);\n+};\n \n+const makeValidationResponse = function(badParams) {", "originalCommit": "7ce92b339455e42cb2e044a046531597f9e8a8ad", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjIxNDM3Mw==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/613#discussion_r396214373", "bodyText": "Running hash should also be base64", "author": "steven-sheehy", "createdAt": "2020-03-23T05:02:12Z", "path": "hedera-mirror-rest/message.js", "diffHunk": "@@ -0,0 +1,82 @@\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+'use strict';\n+const config = require('./config.js');\n+const utils = require('./utils.js');\n+\n+const MESSAGE_NOT_FOUND = {message: 'hcs message not found'};\n+\n+const validateParams = function(consensusTimestamp) {\n+  let badParams = [];\n+  if (!utils.isValidTimestampParam(consensusTimestamp)) {\n+    badParams.push({message: `Invalid parameter: consensusTimestamp`});\n+  }\n+  return utils.makeValidationResponse(badParams);\n+};\n+\n+/**\n+ * Format row in postgres query's result to object which is directly returned to user as json.\n+ */\n+const formatTopicMessageRow = function(row) {\n+  return {\n+    consensus_timestamp: utils.nsToSecNs(row['consensus_timestamp']),\n+    topic_id: `${config.shard}.${row['realm_num']}.${row['topic_num']}`,\n+    message: utils.encodeBase64(row['message']),\n+    running_hash: utils.toHexString(row['running_hash']),", "originalCommit": "7ce92b339455e42cb2e044a046531597f9e8a8ad", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjYzNjE5MQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/613#discussion_r396636191", "bodyText": "running_hash was left hex because kabuto also returns hash in hex-encoded format. Also, in crypto world, all hashes are always encoded in hex format, never in base64 format.\nIt's fine for now.\n@Nana-EC can you please change this to hex and same for the apis you are adding. Thanks.", "author": "apeksharma", "createdAt": "2020-03-23T17:41:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjIxNDM3Mw=="}], "type": "inlineReview"}, {"oid": "629e6356a90299f1132fd4722e9ba89831334d6c", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/629e6356a90299f1132fd4722e9ba89831334d6c", "message": "Address review feedback\n\nSigned-off-by: Steven Sheehy <steven.sheehy@hedera.com>", "committedDate": "2020-03-23T16:39:05Z", "type": "commit"}, {"oid": "9096d2c4faa3cfaa8a2b21bf42556fde91e52c37", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/9096d2c4faa3cfaa8a2b21bf42556fde91e52c37", "message": "Change to /api/v1/topic/message/<timestamp>\n\nSigned-off-by: Steven Sheehy <steven.sheehy@hedera.com>", "committedDate": "2020-03-23T16:47:36Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjYwMTY2MQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/613#discussion_r396601661", "bodyText": "nit: no need to change here but we should standardize on our error response format.\nIn transactions.js and accounts.js I see place where non json is returned. And in this PR we have messages : [{...}] and then message: {...} in other cases.\nI have a separate PR where I'm addressing this but just pointing it out here so both formats are presented.", "author": "Nana-EC", "createdAt": "2020-03-23T16:52:16Z", "path": "hedera-mirror-rest/__tests__/specs/topicmessage-02-timestamp-invalid.spec.json", "diffHunk": "@@ -0,0 +1,19 @@\n+{\n+  \"description\": \"Invalid consensus timestamp\",\n+  \"setup\": {\n+    \"accounts\": [],\n+    \"balances\": [],\n+    \"transactions\": [],\n+    \"cryptotransfers\": [],\n+    \"topicmessages\": []\n+  },\n+  \"url\": \"/api/v1/topic/message/123abc\",\n+  \"responseStatus\": 400,\n+  \"responseJson\": {\n+    \"messages\": [", "originalCommit": "9096d2c4faa3cfaa8a2b21bf42556fde91e52c37", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjYzNTAxNQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/613#discussion_r396635015", "bodyText": "feel free to change the 'interim' apis as you like :)\nmessages : [{...}] format is also returned for current apis when param validation fails.", "author": "apeksharma", "createdAt": "2020-03-23T17:40:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjYwMTY2MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjYwMzI0OA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/613#discussion_r396603248", "bodyText": "q: I can address in my PR but shouldn't we have parity with grpc here and require a valid entity for the expected topic? If so then tests should populate an entity.\nThis is also in my upcoming PR so I can add it if agreed.", "author": "Nana-EC", "createdAt": "2020-03-23T16:54:30Z", "path": "hedera-mirror-rest/__tests__/specs/topicmessage-01-timestamp-valid.spec.json", "diffHunk": "@@ -0,0 +1,35 @@\n+{\n+  \"description\": \"Get single message by valid consensus timestamp\",\n+  \"setup\": {\n+    \"accounts\": [],", "originalCommit": "9096d2c4faa3cfaa8a2b21bf42556fde91e52c37", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjYzMjgzNA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/613#discussion_r396632834", "bodyText": "if the code path being tested doesn't need a particular setup, that it's useless to add that setup.", "author": "apeksharma", "createdAt": "2020-03-23T17:36:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjYwMzI0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjY0NjIwOQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/613#discussion_r396646209", "bodyText": "I don't think it's necessary. The GRPC streaming API pays a performance penalty if we stream messages indefinitely for topics that don't/never exist. Adding it to REST we would just be paying a performance penalty every call regardless if it exists or not. We should always have an entity if we have a message.", "author": "steven-sheehy", "createdAt": "2020-03-23T17:56:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjYwMzI0OA=="}], "type": "inlineReview"}]}