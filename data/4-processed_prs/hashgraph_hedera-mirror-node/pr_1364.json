{"pr_number": 1364, "pr_title": "TimescaleDB: Add psql to timescaledb migration scripts", "pr_createdAt": "2020-12-16T07:29:57Z", "pr_url": "https://github.com/hashgraph/hedera-mirror-node/pull/1364", "timeline": [{"oid": "4793003946e27a93c437713e0a99e48ded63e1f7", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/4793003946e27a93c437713e0a99e48ded63e1f7", "message": "Updated for super and owner users\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2020-12-22T23:35:22Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTUwMzE0NA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1364#discussion_r549503144", "bodyText": "Would prefer the more explicit timescaledb", "author": "steven-sheehy", "createdAt": "2020-12-28T22:14:22Z", "path": "docker-compose.yml", "diffHunk": "@@ -67,3 +67,17 @@ services:\n     tty: true\n     ports:\n       - 5551:5551\n+\n+  tsdb:", "originalCommit": "07281b0582b9ee863a5acdf9c8ed95a83b56e5e0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTYwODc3MQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1364#discussion_r551608771", "bodyText": "Updated", "author": "Nana-EC", "createdAt": "2021-01-04T22:33:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTUwMzE0NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTUwMzI2Mw==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1364#discussion_r549503263", "bodyText": "I'd prefer not to add another top level file for such a purpose as the directory is already quite cluttered. The approach we use for monitor already should be sufficient for disabling timescaledb as well. Just set the replicas to 0.", "author": "steven-sheehy", "createdAt": "2020-12-28T22:14:59Z", "path": "docker-compose.override.yml", "diffHunk": "@@ -0,0 +1,4 @@\n+version: \"3.3\"", "originalCommit": "07281b0582b9ee863a5acdf9c8ed95a83b56e5e0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTQyNzYzMw==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1364#discussion_r551427633", "bodyText": "Good approach. I prefer this also", "author": "Nana-EC", "createdAt": "2021-01-04T16:35:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTUwMzI2Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTYwODg2MQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1364#discussion_r551608861", "bodyText": "Removed this file", "author": "Nana-EC", "createdAt": "2021-01-04T22:33:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTUwMzI2Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTUwMzk3Mw==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1364#discussion_r549503973", "bodyText": "Should rename init.sql to init_v1.sql (and any place that references it) for clarity.", "author": "steven-sheehy", "createdAt": "2020-12-28T22:18:13Z", "path": "hedera-mirror-importer/src/main/resources/db/scripts/init_v2.sql", "diffHunk": "@@ -0,0 +1,63 @@\n+-- init the timescale db mirror node db", "originalCommit": "07281b0582b9ee863a5acdf9c8ed95a83b56e5e0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTYwODkyNg==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1364#discussion_r551608926", "bodyText": "Updated", "author": "Nana-EC", "createdAt": "2021-01-04T22:33:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTUwMzk3Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTUwNDEwMQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1364#discussion_r549504101", "bodyText": "Why? Can't we use created_timestamp?", "author": "steven-sheehy", "createdAt": "2020-12-28T22:18:52Z", "path": "hedera-mirror-importer/src/main/resources/db/migration/v2/V2.0.0__time_scale_init.sql", "diffHunk": "@@ -415,6 +415,7 @@ comment on table token is 'Token entities';\n --- token_account\n create table if not exists token_account\n (\n+    id                 serial,", "originalCommit": "07281b0582b9ee863a5acdf9c8ed95a83b56e5e0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTU4NTcwNw==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1364#discussion_r551585707", "bodyText": "We can but this isn't for the chunk logic.\nThis was added to maintain consistency between the v1 and v2. Just like we preserve the id in the address_book_entry and record_file table.\nIn all 3 cases we'll aim to drop them in a future v2 migration.", "author": "Nana-EC", "createdAt": "2021-01-04T21:43:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTUwNDEwMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjExNzM1MA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1364#discussion_r552117350", "bodyText": "I see. I only checked the domain object which does not have the id modeled.  Instead it is using an @EmbeddedId with a composite primary key. You're right that the schema itself does have the id. This is a mistake. We should add a v1 migration to remove this id and undo the v2 change.", "author": "steven-sheehy", "createdAt": "2021-01-05T18:33:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTUwNDEwMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzAxNjc1OA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1364#discussion_r553016758", "bodyText": "Fixed this", "author": "Nana-EC", "createdAt": "2021-01-06T23:29:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTUwNDEwMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTUwNTYzOA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1364#discussion_r549505638", "bodyText": "Should use 5432 externally to avoid changing application config. To avoid port conflicts, instructions should specify disabling postgresql and enabling timescaledb. Instructions already mention how to run both by changing ports.", "author": "steven-sheehy", "createdAt": "2020-12-28T22:26:29Z", "path": "docker-compose.yml", "diffHunk": "@@ -67,3 +67,17 @@ services:\n     tty: true\n     ports:\n       - 5551:5551\n+\n+  tsdb:\n+    image: timescaledev/timescaledb-ha:pg12-ts2.0.0-rc3\n+    restart: unless-stopped\n+    stop_grace_period: 2m\n+    stop_signal: SIGTERM\n+    tty: true\n+    environment:\n+      POSTGRES_PASSWORD: mirror_node_pass\n+    volumes:\n+      - ./tsdb:/var/lib/postgresql/data\n+      - ./hedera-mirror-importer/src/main/resources/db/scripts/init_v2.sql/:/docker-entrypoint-initdb.d/init_v2.sql\n+    ports:\n+      - 6432:5432", "originalCommit": "07281b0582b9ee863a5acdf9c8ed95a83b56e5e0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTYwOTEzNg==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1364#discussion_r551609136", "bodyText": "Updated", "author": "Nana-EC", "createdAt": "2021-01-04T22:33:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTUwNTYzOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTUwNzUwMg==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1364#discussion_r549507502", "bodyText": "This line removal causes a rendering error", "author": "steven-sheehy", "createdAt": "2020-12-28T22:36:05Z", "path": "docs/operations.md", "diffHunk": "@@ -224,5 +290,4 @@ available\n - `/swagger/ui` - Metrics dashboard\n - `/swagger/stats` - Aggregated statistics\n - `/swagger/metrics` - Prometheus formatted metrics\n-", "originalCommit": "07281b0582b9ee863a5acdf9c8ed95a83b56e5e0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTYwOTE4OQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1364#discussion_r551609189", "bodyText": "Reverted", "author": "Nana-EC", "createdAt": "2021-01-04T22:33:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTUwNzUwMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTUwODIxOA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1364#discussion_r549508218", "bodyText": "This log mentions 'Old' but others mention 'Current' and variables are named OLD_*. Other logs should probably be updated to mention old to be consistent.", "author": "steven-sheehy", "createdAt": "2020-12-28T22:39:29Z", "path": "hedera-mirror-importer/src/main/resources/db/scripts/time-scale-migration/timeScaleDbMigration.sh", "diffHunk": "@@ -0,0 +1,87 @@\n+#!/usr/bin/env bash\n+echo \"BASH_VERSION: $BASH_VERSION\"\n+set -e\n+\n+. scripts/time-scale-migration/migration.config\n+\n+if [[ -z $OLD_DB_HOST ]]; then\n+    echo \"Current host name is not set. Please configure OLD_DB_HOST in migration.config file and rerun './timeScaleDbMigration.sh'\"\n+    exit 1\n+fi\n+\n+if [[ -z $OLD_DB_NAME ]]; then\n+    echo \"Current db name is not set. Please configure OLD_DB_NAME in migration.config file and rerun './timeScaleDbMigration.sh'\"\n+    exit 1\n+fi\n+\n+if [[ -z $OLD_DB_PORT ]]; then\n+    echo \"Current port is not set. Please configure OLD_DB_PORT in migration.config file and rerun './timeScaleDbMigration.sh'\"\n+    exit 1\n+fi\n+\n+if [[ -z $OLD_DB_USER ]]; then\n+    echo \"Current db primary user name is not set. Please configure OLD_DB_USER in migration.config file and rerun './timeScaleDbMigration.sh'\"\n+    exit 1\n+fi\n+\n+if [[ -z $OLD_PASSWORD ]]; then\n+    echo \"Old db primary user password is not set. Please configure OLD_PASSWORD in migration.config file and rerun './timeScaleDbMigration.sh'\"", "originalCommit": "07281b0582b9ee863a5acdf9c8ed95a83b56e5e0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTQzNTcwMQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1364#discussion_r551435701", "bodyText": "Will update to stay with just \"Old\" and \"New\"", "author": "Nana-EC", "createdAt": "2021-01-04T16:47:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTUwODIxOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTYwOTIzNg==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1364#discussion_r551609236", "bodyText": "Updated", "author": "Nana-EC", "createdAt": "2021-01-04T22:34:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTUwODIxOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTc2NDMyMQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1364#discussion_r549764321", "bodyText": "We should be consistent with how we name TimescaleDB. Timescale is the company and TimescaleDB is its product we are using. In some places we use dashes to separate words that should be together (time-scale), others capitalize the wrong letter (timeScaleDbMigration.sh, TimeScaleDB), shorten it to tsdb, and others we leave off the DB.", "author": "steven-sheehy", "createdAt": "2020-12-29T16:19:24Z", "path": "docs/operations.md", "diffHunk": "@@ -93,6 +93,72 @@ systemctl status hedera-mirror-importer.service\n sudo journalctl -fu hedera-mirror-importer.service\n ```\n \n+### v1 to v2 Data Migration\n+\n+To support time series logic the Mirror Node DB schema shifted from PostgeSQL (v1) to TimescaleDB (v2).\n+[Migrating from a Different PostgreSQL Database](https://docs.timescale.com/latest/getting-started/migrating-data#different-db) highlights the general recommended data migration steps when moving to TimescaleDB.\n+\n+For mirror node operators running v1 db schema, the following steps can be taken to upgrade to v2.\n+\n+1. Setup a new database container using TimeScale\n+\n+    To install using docker-compose, update the `docker-compose.override.yml` file to disable postgres instead of TimeScaleDB\n+\n+    ```yaml\n+    version: \"3.3\"\n+    services:\n+      db:\n+        entrypoint: [\"echo\", \"PostgreSQL db is disabled\"]\n+    ```\n+\n+    Start up the TimescaleDB service:\n+    ```shell script\n+    $ docker-compose up tsdb\n+    ```\n+\n+    Note: If the new db is running on the same server node as the original PostgeSQL db, then the port must be updated to something other than 5432.\n+    The `tsdb` port can be updated to a different port e.g. 6432 as follows:\n+    ```yaml\n+    ...\n+    services:\n+      ...\n+      tsdb:\n+        ports:\n+          - 6432:5432\n+    ```\n+\n+2. Create DB & Init Schema\n+\n+    The init script for v2 `hedera-mirror-importer/src/main/resources/db/scripts/init_v2.sql` may be used to create the database, users, schema, extensions and ensure all permissions are set.\n+    In the docker-compose case this file is already mounted under `/docker-entrypoint-initdb.d/` on the docker container and run on startup.\n+\n+    This may be run manually against the db node if not using docker-compose:\n+    ```shell script\n+    $ psql \"dbname=mirror_node host=localhost user=mirror_importer password=mirror_importer_pass port=6432\" -f hedera-mirror-importer/src/main/resources/db/scripts/init_v2.sql\n+    ```\n+\n+    > **_NOTE:_** The following steps assume the database, users and schema have been created as detailed above\n+\n+3. Configure migration properties\n+\n+    The configuration file `hedera-mirror-importer/src/main/resources/db/scripts/time-scale-migration/migration.config` contains db variables for easy running.\n+    These options include variables such as db names, passwords, users, hosts for both the existing db and the new db.\n+\n+    Update these values appropriately for your db setup.\n+\n+4. Run migration script\n+\n+    From the `hedera-mirror-importer/src/main/resources/db` directory run the `timeScaleDbMigration.sh` script\n+    ```shell script\n+    $ ./scripts/time-scale-migration/timeScaleDbMigration.sh\n+    ```\n+\n+   The script uses successive `psql` connections to backup, configure and restore data on the new database nodes.\n+   First it copies over the `flyway_schema_history` table, to maintain migration history.\n+   It then utilizes the migration sql script used by normal flyway operations to create the new tables and then creates the Timescale hyper tables based on these.", "originalCommit": "07281b0582b9ee863a5acdf9c8ed95a83b56e5e0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTQ0MDU1Mw==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1364#discussion_r551440553", "bodyText": "Will update to use TimescaleDB and timescaledb only", "author": "Nana-EC", "createdAt": "2021-01-04T16:55:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTc2NDMyMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTYwOTI4NA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1364#discussion_r551609284", "bodyText": "Updated", "author": "Nana-EC", "createdAt": "2021-01-04T22:34:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTc2NDMyMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTc2OTc5MQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1364#discussion_r549769791", "bodyText": "We shouldn't tell users to use containers for their database or to recommend only Docker Compose. It's fine if they want to install binaries on a VM or use Timescale's SaaS, for example. We should simply say that they need to start a new TimescaleDB server and then point them to our separate docs to use it in Docker Compose or in Helm, or see TimescaleDB install docs for other options.\nSince we don't have a docker compose doc, we should move the steps to configure TimescaleDB vs PostgreSQL in Docker Compose to a new top level Database section with database specific sub-sections.", "author": "steven-sheehy", "createdAt": "2020-12-29T16:35:41Z", "path": "docs/operations.md", "diffHunk": "@@ -93,6 +93,72 @@ systemctl status hedera-mirror-importer.service\n sudo journalctl -fu hedera-mirror-importer.service\n ```\n \n+### v1 to v2 Data Migration\n+\n+To support time series logic the Mirror Node DB schema shifted from PostgeSQL (v1) to TimescaleDB (v2).\n+[Migrating from a Different PostgreSQL Database](https://docs.timescale.com/latest/getting-started/migrating-data#different-db) highlights the general recommended data migration steps when moving to TimescaleDB.\n+\n+For mirror node operators running v1 db schema, the following steps can be taken to upgrade to v2.\n+\n+1. Setup a new database container using TimeScale", "originalCommit": "07281b0582b9ee863a5acdf9c8ed95a83b56e5e0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTQ2MjE5Ng==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1364#discussion_r551462196", "bodyText": "There's a section in Installation.md for PostgreSQL. I can note that as V1 and add a V2 section for TimescaleDB.\nWill refer to that from here, and with the removal of the override file this should be simpler", "author": "Nana-EC", "createdAt": "2021-01-04T17:34:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTc2OTc5MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTYwOTM0Mg==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1364#discussion_r551609342", "bodyText": "Updated", "author": "Nana-EC", "createdAt": "2021-01-04T22:34:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTc2OTc5MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTc3MTkyNg==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1364#discussion_r549771926", "bodyText": "Why is this necessary if we use create extension if not exists?", "author": "steven-sheehy", "createdAt": "2020-12-29T16:42:06Z", "path": "hedera-mirror-importer/src/main/resources/db/scripts/init_v2.sql", "diffHunk": "@@ -0,0 +1,63 @@\n+-- init the timescale db mirror node db\n+-- Change the values below if you are not installing via Docker\n+\n+\\set db_host 'localhost'\n+\\set db_port 6432\n+\\set db_name 'mirror_node'\n+\\set db_super_user 'postgres'\n+\\set db_owner 'mirror_node'\n+\\set owner_password 'mirror_node_pass'\n+\\set importer_user 'mirror_importer'\n+\\set importer_password 'mirror_importer_pass'\n+\\set grpc_user 'mirror_grpc'\n+\\set grpc_password 'mirror_grpc_pass'\n+\\set rest_user 'mirror_api'\n+\\set rest_password 'mirror_api_pass'\n+\\set schema_name 'mirrornode'\n+\n+-- create owner user\n+create user :db_owner with login createrole password :'owner_password';\n+\n+-- create primary user and db\n+create database :db_name with owner :db_owner;\n+\\c :db_name :db_owner\n+\n+-- create users\n+create user :importer_user with login password :'importer_password';\n+create role viewer;\n+create user :grpc_user with login password :'grpc_password' in role viewer;\n+create user :rest_user with login password :'rest_password' in role viewer;\n+\n+-- grant connect access to api users\n+grant connect on database :db_name to viewer;\n+\n+-- schema\n+create schema if not exists :schema_name authorization :db_owner;\n+grant usage on schema :schema_name to public;\n+\n+-- alter search path for given schema\n+alter user :db_owner set search_path = :schema_name, public;\n+alter user :importer_user set search_path = :schema_name, public;\n+alter user :grpc_user set search_path = :schema_name, public;\n+alter user :rest_user set search_path = :schema_name, public;\n+\n+-- grant select privileges on past and future tables and sequences to users\n+grant all privileges on all tables in schema :schema_name to :db_owner;\n+grant all privileges on all sequences in schema :schema_name to :db_owner;\n+grant select on all tables in schema :schema_name to :importer_user;\n+grant select on all tables in schema :schema_name to viewer;\n+grant select on all sequences in schema :schema_name to :importer_user;\n+grant select on all sequences in schema :schema_name to viewer;\n+alter default privileges in schema :schema_name grant select on tables to :importer_user;\n+alter default privileges in schema :schema_name grant select on tables to viewer;\n+alter default privileges in schema :schema_name grant select on sequences to :importer_user;\n+alter default privileges in schema :schema_name grant select on sequences to viewer;\n+\n+-- add extensions, ensuring they're available to new schema\n+-- drop extension if exists timescaledb;\n+\\c :db_name :db_super_user\n+drop extension if exists timescaledb;", "originalCommit": "07281b0582b9ee863a5acdf9c8ed95a83b56e5e0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTQ2OTI5NQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1364#discussion_r551469295", "bodyText": "The installed extension is not available to the new schema.\nTrying to install it for the new schema will fail since it's already installed.\nTherefore had to uninstall as super user reinstall in needed schema.", "author": "Nana-EC", "createdAt": "2021-01-04T17:48:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTc3MTkyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTU1ODE4Mg==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1364#discussion_r551558182", "bodyText": "Since the timescaledb extension was installed into the public schema it originally wasn't available to the new schema.\nI think I can work around this though and not need to delete and create.", "author": "Nana-EC", "createdAt": "2021-01-04T20:44:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTc3MTkyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTYwOTM3OQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1364#discussion_r551609379", "bodyText": "Fixed", "author": "Nana-EC", "createdAt": "2021-01-04T22:34:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTc3MTkyNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTc3NDE4NQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1364#discussion_r549774185", "bodyText": "DB owner shouldn't have createrole permission. For security, would be better if super user created all users/roles.", "author": "steven-sheehy", "createdAt": "2020-12-29T16:49:24Z", "path": "hedera-mirror-importer/src/main/resources/db/scripts/init_v2.sql", "diffHunk": "@@ -0,0 +1,63 @@\n+-- init the timescale db mirror node db\n+-- Change the values below if you are not installing via Docker\n+\n+\\set db_host 'localhost'\n+\\set db_port 6432\n+\\set db_name 'mirror_node'\n+\\set db_super_user 'postgres'\n+\\set db_owner 'mirror_node'\n+\\set owner_password 'mirror_node_pass'\n+\\set importer_user 'mirror_importer'\n+\\set importer_password 'mirror_importer_pass'\n+\\set grpc_user 'mirror_grpc'\n+\\set grpc_password 'mirror_grpc_pass'\n+\\set rest_user 'mirror_api'\n+\\set rest_password 'mirror_api_pass'\n+\\set schema_name 'mirrornode'\n+\n+-- create owner user\n+create user :db_owner with login createrole password :'owner_password';", "originalCommit": "07281b0582b9ee863a5acdf9c8ed95a83b56e5e0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTYwOTQzMQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1364#discussion_r551609431", "bodyText": "Fixed", "author": "Nana-EC", "createdAt": "2021-01-04T22:34:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTc3NDE4NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTc3Njg3Ng==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1364#discussion_r549776876", "bodyText": "Are these two lines necessary? DB owner should own everything in the database including stuff in the new schema.", "author": "steven-sheehy", "createdAt": "2020-12-29T16:57:51Z", "path": "hedera-mirror-importer/src/main/resources/db/scripts/init_v2.sql", "diffHunk": "@@ -0,0 +1,63 @@\n+-- init the timescale db mirror node db\n+-- Change the values below if you are not installing via Docker\n+\n+\\set db_host 'localhost'\n+\\set db_port 6432\n+\\set db_name 'mirror_node'\n+\\set db_super_user 'postgres'\n+\\set db_owner 'mirror_node'\n+\\set owner_password 'mirror_node_pass'\n+\\set importer_user 'mirror_importer'\n+\\set importer_password 'mirror_importer_pass'\n+\\set grpc_user 'mirror_grpc'\n+\\set grpc_password 'mirror_grpc_pass'\n+\\set rest_user 'mirror_api'\n+\\set rest_password 'mirror_api_pass'\n+\\set schema_name 'mirrornode'\n+\n+-- create owner user\n+create user :db_owner with login createrole password :'owner_password';\n+\n+-- create primary user and db\n+create database :db_name with owner :db_owner;\n+\\c :db_name :db_owner\n+\n+-- create users\n+create user :importer_user with login password :'importer_password';\n+create role viewer;\n+create user :grpc_user with login password :'grpc_password' in role viewer;\n+create user :rest_user with login password :'rest_password' in role viewer;\n+\n+-- grant connect access to api users\n+grant connect on database :db_name to viewer;\n+\n+-- schema\n+create schema if not exists :schema_name authorization :db_owner;\n+grant usage on schema :schema_name to public;\n+\n+-- alter search path for given schema\n+alter user :db_owner set search_path = :schema_name, public;\n+alter user :importer_user set search_path = :schema_name, public;\n+alter user :grpc_user set search_path = :schema_name, public;\n+alter user :rest_user set search_path = :schema_name, public;\n+\n+-- grant select privileges on past and future tables and sequences to users\n+grant all privileges on all tables in schema :schema_name to :db_owner;", "originalCommit": "07281b0582b9ee863a5acdf9c8ed95a83b56e5e0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTYwOTU3OQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1364#discussion_r551609579", "bodyText": "Not needed, updated.", "author": "Nana-EC", "createdAt": "2021-01-04T22:34:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTc3Njg3Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTc3NzI4Mw==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1364#discussion_r549777283", "bodyText": "For readability and future compatibility if we have more than one writeable user, perhaps we should create a readwrite role for importer to use? And rename viewer to readonly?\nWe can also probably create readwrite in role readonly so that it inherits read permissions and you only need to grant select/default privileges on the readonly role.", "author": "steven-sheehy", "createdAt": "2020-12-29T16:59:03Z", "path": "hedera-mirror-importer/src/main/resources/db/scripts/init_v2.sql", "diffHunk": "@@ -0,0 +1,63 @@\n+-- init the timescale db mirror node db\n+-- Change the values below if you are not installing via Docker\n+\n+\\set db_host 'localhost'\n+\\set db_port 6432\n+\\set db_name 'mirror_node'\n+\\set db_super_user 'postgres'\n+\\set db_owner 'mirror_node'\n+\\set owner_password 'mirror_node_pass'\n+\\set importer_user 'mirror_importer'\n+\\set importer_password 'mirror_importer_pass'\n+\\set grpc_user 'mirror_grpc'\n+\\set grpc_password 'mirror_grpc_pass'\n+\\set rest_user 'mirror_api'\n+\\set rest_password 'mirror_api_pass'\n+\\set schema_name 'mirrornode'\n+\n+-- create owner user\n+create user :db_owner with login createrole password :'owner_password';\n+\n+-- create primary user and db\n+create database :db_name with owner :db_owner;\n+\\c :db_name :db_owner\n+\n+-- create users\n+create user :importer_user with login password :'importer_password';\n+create role viewer;", "originalCommit": "07281b0582b9ee863a5acdf9c8ed95a83b56e5e0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTYwOTcwNA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1364#discussion_r551609704", "bodyText": "I like this, updated as such", "author": "Nana-EC", "createdAt": "2021-01-04T22:35:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTc3NzI4Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTc3OTc4OA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1364#discussion_r549779788", "bodyText": "I don't see how importer_user and viewer have any different permissions. It looks like to me they both can read/write. Has this been tested? I'm guessing the new schema inherited the default permissions of the public schema. You probably need to revoke permissions on the new schema first.", "author": "steven-sheehy", "createdAt": "2020-12-29T17:05:17Z", "path": "hedera-mirror-importer/src/main/resources/db/scripts/init_v2.sql", "diffHunk": "@@ -0,0 +1,63 @@\n+-- init the timescale db mirror node db\n+-- Change the values below if you are not installing via Docker\n+\n+\\set db_host 'localhost'\n+\\set db_port 6432\n+\\set db_name 'mirror_node'\n+\\set db_super_user 'postgres'\n+\\set db_owner 'mirror_node'\n+\\set owner_password 'mirror_node_pass'\n+\\set importer_user 'mirror_importer'\n+\\set importer_password 'mirror_importer_pass'\n+\\set grpc_user 'mirror_grpc'\n+\\set grpc_password 'mirror_grpc_pass'\n+\\set rest_user 'mirror_api'\n+\\set rest_password 'mirror_api_pass'\n+\\set schema_name 'mirrornode'\n+\n+-- create owner user\n+create user :db_owner with login createrole password :'owner_password';\n+\n+-- create primary user and db\n+create database :db_name with owner :db_owner;\n+\\c :db_name :db_owner\n+\n+-- create users\n+create user :importer_user with login password :'importer_password';\n+create role viewer;\n+create user :grpc_user with login password :'grpc_password' in role viewer;\n+create user :rest_user with login password :'rest_password' in role viewer;\n+\n+-- grant connect access to api users\n+grant connect on database :db_name to viewer;\n+\n+-- schema\n+create schema if not exists :schema_name authorization :db_owner;\n+grant usage on schema :schema_name to public;\n+\n+-- alter search path for given schema\n+alter user :db_owner set search_path = :schema_name, public;\n+alter user :importer_user set search_path = :schema_name, public;\n+alter user :grpc_user set search_path = :schema_name, public;\n+alter user :rest_user set search_path = :schema_name, public;\n+\n+-- grant select privileges on past and future tables and sequences to users\n+grant all privileges on all tables in schema :schema_name to :db_owner;\n+grant all privileges on all sequences in schema :schema_name to :db_owner;\n+grant select on all tables in schema :schema_name to :importer_user;", "originalCommit": "07281b0582b9ee863a5acdf9c8ed95a83b56e5e0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTYwOTg1MA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1364#discussion_r551609850", "bodyText": "rewrote this and tested, reader can only select, writer can insert etc", "author": "Nana-EC", "createdAt": "2021-01-04T22:35:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTc3OTc4OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTc4MjgyMA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1364#discussion_r549782820", "bodyText": "This file is a duplicate of V2.0.1__hyper_tables.sql. Why can't we simply invoke that?", "author": "steven-sheehy", "createdAt": "2020-12-29T17:15:13Z", "path": "hedera-mirror-importer/src/main/resources/db/scripts/time-scale-migration/createHyperTables.sql", "diffHunk": "@@ -0,0 +1,89 @@\n+-------------------\n+-- Create hyper tables from v1 schema, inserts from old table, add indexes", "originalCommit": "07281b0582b9ee863a5acdf9c8ed95a83b56e5e0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTQyNDI2Mw==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1364#discussion_r551424263", "bodyText": "Yes, looking at a way to share these.\nIssue is V2.0.1__hyper_tables.sql uses flyway placeholders which I don't think you can tap into outside of flyway.\nCurrently, either I remove the placeholders and remove the ability to config the chunk sizes or I do this code repetition.\nI could have a default value and then potentially pick up the placeholders if they are present. Thoughts?", "author": "Nana-EC", "createdAt": "2021-01-04T16:29:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTc4MjgyMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTQ0MTg3Ng==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1364#discussion_r551441876", "bodyText": "You invoke it from bash, right? Just use sed to replace as a temp file then invoke temp file.", "author": "steven-sheehy", "createdAt": "2021-01-04T16:57:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTc4MjgyMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTYxMDk3Ng==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1364#discussion_r551610976", "bodyText": "Good idea.\nUpdated.\nInitial did 2 sed's but will update to\nsed -e 's/${chunkTimeInterval}/'$CHUNK_INTERVAL_TIME'/g' -e 's/${chunkIdInterval}/'$CHUNK_INTERVAL_ID'/g' migration/v2/V2.0.1__hyper_tables.sql >scripts/timescaledb/createHyperTables.sql", "author": "Nana-EC", "createdAt": "2021-01-04T22:38:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTc4MjgyMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTc4MzI0OQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1364#discussion_r549783249", "bodyText": "Does it speed up things or help TimescaleDB if we order by primary key ascending?", "author": "steven-sheehy", "createdAt": "2020-12-29T17:16:26Z", "path": "hedera-mirror-importer/src/main/resources/db/scripts/time-scale-migration/csvBackupTables.sql", "diffHunk": "@@ -0,0 +1,47 @@\n+-------------------\n+-- Backup tables use efficient COPY process to CSV's\n+-------------------\n+\n+\\copy (select * from account_balance) to account_balance.csv delimiter ',' csv;", "originalCommit": "07281b0582b9ee863a5acdf9c8ed95a83b56e5e0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTU3MzE5Ng==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1364#discussion_r551573196", "bodyText": "Let me try, one way to speed up would be to drop indexes on the old db but I'm not sure we want to force that on migrators as they'd then also need to wait on the recreation of those indexes", "author": "Nana-EC", "createdAt": "2021-01-04T21:16:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTc4MzI0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTU4NDEwOQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1364#discussion_r551584109", "bodyText": "Tried it on my smaller data set and it actually made the migration take a few seconds longer, which I did not expect.\nWas actually thinking of simplifying this and just using the table name instead of the select statement, this sped it up a tiny bit.", "author": "Nana-EC", "createdAt": "2021-01-04T21:39:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTc4MzI0OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTc4NDExMA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1364#discussion_r549784110", "bodyText": "Why not simply add flyway_schema_history to backup/restore? I don't see why it needs to be treated special as Flyway is not running at any point during this migration.", "author": "steven-sheehy", "createdAt": "2020-12-29T17:19:03Z", "path": "hedera-mirror-importer/src/main/resources/db/scripts/time-scale-migration/timeScaleDbMigration.sh", "diffHunk": "@@ -0,0 +1,87 @@\n+#!/usr/bin/env bash\n+echo \"BASH_VERSION: $BASH_VERSION\"\n+set -e\n+\n+. scripts/time-scale-migration/migration.config\n+\n+if [[ -z $OLD_DB_HOST ]]; then\n+    echo \"Current host name is not set. Please configure OLD_DB_HOST in migration.config file and rerun './timeScaleDbMigration.sh'\"\n+    exit 1\n+fi\n+\n+if [[ -z $OLD_DB_NAME ]]; then\n+    echo \"Current db name is not set. Please configure OLD_DB_NAME in migration.config file and rerun './timeScaleDbMigration.sh'\"\n+    exit 1\n+fi\n+\n+if [[ -z $OLD_DB_PORT ]]; then\n+    echo \"Current port is not set. Please configure OLD_DB_PORT in migration.config file and rerun './timeScaleDbMigration.sh'\"\n+    exit 1\n+fi\n+\n+if [[ -z $OLD_DB_USER ]]; then\n+    echo \"Current db primary user name is not set. Please configure OLD_DB_USER in migration.config file and rerun './timeScaleDbMigration.sh'\"\n+    exit 1\n+fi\n+\n+if [[ -z $OLD_PASSWORD ]]; then\n+    echo \"Old db primary user password is not set. Please configure OLD_PASSWORD in migration.config file and rerun './timeScaleDbMigration.sh'\"\n+    exit 1\n+fi\n+\n+if [[ -z $NEW_DB_HOST ]]; then\n+    echo \"New host name is not set. Please configure NEW_DB_HOST in migration.config file and rerun './timeScaleDbMigration.sh'\"\n+    exit 1\n+fi\n+\n+if [[ -z $NEW_DB_NAME ]]; then\n+    echo \"New db name is not set. Please configure NEW_DB_NAME in migration.config file and rerun './timeScaleDbMigration.sh'\"\n+    exit 1\n+fi\n+\n+if [[ -z $NEW_DB_PORT ]]; then\n+    echo \"New db port is not set. Please configure NEW_DB_PORT in migration.config file and rerun './timeScaleDbMigration.sh'\"\n+    exit 1\n+fi\n+\n+if [[ -z $NEW_DB_USER ]]; then\n+    echo \"New db primary user name is not set. Please configure NEW_DB_USER in migration.config file and rerun './timeScaleDbMigration.sh'\"\n+    exit 1\n+fi\n+\n+if [[ -z $NEW_PASSWORD ]]; then\n+    echo \"New db primary user password is not set. Please configure NEW_PASSWORD in migration.config file and rerun './timeScaleDbMigration.sh'\"\n+    exit 1\n+fi\n+\n+start_time=\"$(date -u +%s)\"\n+# assumes 1. Valid populated current mirror node postgres db with appropriate user 2. New empty TimeScaleDb db host with appropriate user\n+echo \"Migrating Mirror Node Data from Postgres($OLD_DB_HOST:$OLD_DB_PORT) to TimeScaleDb($NEW_DB_HOST:$NEW_DB_PORT)...\"\n+\n+echo \"1. Backing up flyway table schema from Postgres($OLD_DB_HOST:$OLD_DB_PORT)...\"\n+PGPASSWORD=${OLD_PASSWORD} pg_dump -h $OLD_DB_HOST -p $OLD_DB_PORT -U $OLD_DB_USER --table public.flyway_schema_history -f mirror_node_${start_time}.bak mirror_node", "originalCommit": "07281b0582b9ee863a5acdf9c8ed95a83b56e5e0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTU2NzA4Nw==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1364#discussion_r551567087", "bodyText": "So this is simply to avoid having to write a script that explicitly does a create table for the flyway_schema_history table.\nSince I'm trying to reuse the V2.0.0__time_scale_init.sql I have to account for that table not being present as flyway creates it.\nSo it was either create an additional script file to run before step 5 or add logic to this script file to handle that.", "author": "Nana-EC", "createdAt": "2021-01-04T21:02:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTc4NDExMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTc4NDQ1OQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1364#discussion_r549784459", "bodyText": "Should consider removing some of these sequences if possible in the future.", "author": "steven-sheehy", "createdAt": "2020-12-29T17:20:06Z", "path": "hedera-mirror-importer/src/main/resources/db/scripts/time-scale-migration/alterSchema.sql", "diffHunk": "@@ -0,0 +1,14 @@\n+-------------------\n+-- alter tables by removing domains\n+-- update to custom schema\n+-------------------\n+\n+\\set newSchema mirrornode\n+-- Update schema from public to custom schema e.g mirrornode\n+alter table flyway_schema_history\n+    set schema :newSchema;\n+\n+-- update sequence start values\n+select setval('address_book_entry_id_seq', (select max(id) from address_book_entry));\n+select setval('record_file_id_seq', (select max(id) from record_file));", "originalCommit": "07281b0582b9ee863a5acdf9c8ed95a83b56e5e0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTQyNjI1NA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1364#discussion_r551426254", "bodyText": "Agreed", "author": "Nana-EC", "createdAt": "2021-01-04T16:32:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTc4NDQ1OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTYxMTU3Nw==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1364#discussion_r551611577", "bodyText": "I believe the plan is in a future v2 migration remove the id's from these tables and then remove the sequences", "author": "Nana-EC", "createdAt": "2021-01-04T22:40:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTc4NDQ1OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTc4NTg5Mw==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1364#discussion_r549785893", "bodyText": "Seems a bit verbose and duplicates TimescaleDB. What about scripts/timescaledb/migrate.sh?", "author": "steven-sheehy", "createdAt": "2020-12-29T17:24:48Z", "path": "docs/operations.md", "diffHunk": "@@ -93,6 +93,72 @@ systemctl status hedera-mirror-importer.service\n sudo journalctl -fu hedera-mirror-importer.service\n ```\n \n+### v1 to v2 Data Migration\n+\n+To support time series logic the Mirror Node DB schema shifted from PostgeSQL (v1) to TimescaleDB (v2).\n+[Migrating from a Different PostgreSQL Database](https://docs.timescale.com/latest/getting-started/migrating-data#different-db) highlights the general recommended data migration steps when moving to TimescaleDB.\n+\n+For mirror node operators running v1 db schema, the following steps can be taken to upgrade to v2.\n+\n+1. Setup a new database container using TimeScale\n+\n+    To install using docker-compose, update the `docker-compose.override.yml` file to disable postgres instead of TimeScaleDB\n+\n+    ```yaml\n+    version: \"3.3\"\n+    services:\n+      db:\n+        entrypoint: [\"echo\", \"PostgreSQL db is disabled\"]\n+    ```\n+\n+    Start up the TimescaleDB service:\n+    ```shell script\n+    $ docker-compose up tsdb\n+    ```\n+\n+    Note: If the new db is running on the same server node as the original PostgeSQL db, then the port must be updated to something other than 5432.\n+    The `tsdb` port can be updated to a different port e.g. 6432 as follows:\n+    ```yaml\n+    ...\n+    services:\n+      ...\n+      tsdb:\n+        ports:\n+          - 6432:5432\n+    ```\n+\n+2. Create DB & Init Schema\n+\n+    The init script for v2 `hedera-mirror-importer/src/main/resources/db/scripts/init_v2.sql` may be used to create the database, users, schema, extensions and ensure all permissions are set.\n+    In the docker-compose case this file is already mounted under `/docker-entrypoint-initdb.d/` on the docker container and run on startup.\n+\n+    This may be run manually against the db node if not using docker-compose:\n+    ```shell script\n+    $ psql \"dbname=mirror_node host=localhost user=mirror_importer password=mirror_importer_pass port=6432\" -f hedera-mirror-importer/src/main/resources/db/scripts/init_v2.sql\n+    ```\n+\n+    > **_NOTE:_** The following steps assume the database, users and schema have been created as detailed above\n+\n+3. Configure migration properties\n+\n+    The configuration file `hedera-mirror-importer/src/main/resources/db/scripts/time-scale-migration/migration.config` contains db variables for easy running.\n+    These options include variables such as db names, passwords, users, hosts for both the existing db and the new db.\n+\n+    Update these values appropriately for your db setup.\n+\n+4. Run migration script\n+\n+    From the `hedera-mirror-importer/src/main/resources/db` directory run the `timeScaleDbMigration.sh` script\n+    ```shell script\n+    $ ./scripts/time-scale-migration/timeScaleDbMigration.sh", "originalCommit": "07281b0582b9ee863a5acdf9c8ed95a83b56e5e0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTYxMTYxNA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1364#discussion_r551611614", "bodyText": "Updated", "author": "Nana-EC", "createdAt": "2021-01-04T22:40:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTc4NTg5Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTUwMjEwNA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1364#discussion_r551502104", "bodyText": "Does this not also need to be done for the importer_user?", "author": "ijungmann", "createdAt": "2021-01-04T18:53:35Z", "path": "hedera-mirror-importer/src/main/resources/db/scripts/init_v2.sql", "diffHunk": "@@ -0,0 +1,63 @@\n+-- init the timescale db mirror node db\n+-- Change the values below if you are not installing via Docker\n+\n+\\set db_host 'localhost'\n+\\set db_port 6432\n+\\set db_name 'mirror_node'\n+\\set db_super_user 'postgres'\n+\\set db_owner 'mirror_node'\n+\\set owner_password 'mirror_node_pass'\n+\\set importer_user 'mirror_importer'\n+\\set importer_password 'mirror_importer_pass'\n+\\set grpc_user 'mirror_grpc'\n+\\set grpc_password 'mirror_grpc_pass'\n+\\set rest_user 'mirror_api'\n+\\set rest_password 'mirror_api_pass'\n+\\set schema_name 'mirrornode'\n+\n+-- create owner user\n+create user :db_owner with login createrole password :'owner_password';\n+\n+-- create primary user and db\n+create database :db_name with owner :db_owner;\n+\\c :db_name :db_owner\n+\n+-- create users\n+create user :importer_user with login password :'importer_password';\n+create role viewer;\n+create user :grpc_user with login password :'grpc_password' in role viewer;\n+create user :rest_user with login password :'rest_password' in role viewer;\n+\n+-- grant connect access to api users\n+grant connect on database :db_name to viewer;", "originalCommit": "07281b0582b9ee863a5acdf9c8ed95a83b56e5e0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTU2NTU0OQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1364#discussion_r551565549", "bodyText": "Actually no, create user assumes login so connection is authorized, whereas role doesn't make that assumption so you have to explicitly grant it.\nGood question though, I had to verify documentation at https://www.postgresql.org/docs/9.6/sql-createuser.html", "author": "Nana-EC", "createdAt": "2021-01-04T20:59:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTUwMjEwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTU5NDc1Ng==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1364#discussion_r551594756", "bodyText": "Cool, I figured it had to work somehow, thanks for the clarification.", "author": "ijungmann", "createdAt": "2021-01-04T21:59:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTUwMjEwNA=="}], "type": "inlineReview"}, {"oid": "93450410dac36b0d805bfb446133d1b1881d167b", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/93450410dac36b0d805bfb446133d1b1881d167b", "message": "Improved sed process\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2021-01-04T22:50:01Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjAxNTg4Nw==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1364#discussion_r552015887", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  - ./hedera-mirror-importer/src/main/resources/db/scripts/init_v2.sql/:/docker-entrypoint-initdb.d/init_v2.sql\n          \n          \n            \n                  - ./hedera-mirror-importer/src/main/resources/db/scripts/init_v2.sql:/docker-entrypoint-initdb.d/init_v2.sql", "author": "xin-hedera", "createdAt": "2021-01-05T15:46:36Z", "path": "docker-compose.yml", "diffHunk": "@@ -67,3 +67,19 @@ services:\n     tty: true\n     ports:\n       - 5551:5551\n+\n+  timescaledb:\n+    deploy:\n+      replicas: 0\n+    image: timescaledev/timescaledb-ha:pg12-ts2.0.0-rc3\n+    restart: unless-stopped\n+    stop_grace_period: 2m\n+    stop_signal: SIGTERM\n+    tty: true\n+    environment:\n+      POSTGRES_PASSWORD: mirror_node_pass\n+    volumes:\n+      - ./timescaledb:/var/lib/postgresql/data\n+      - ./hedera-mirror-importer/src/main/resources/db/scripts/init_v2.sql/:/docker-entrypoint-initdb.d/init_v2.sql", "originalCommit": "62bb893cb898bf0fd47d0d38868c0ddb5dfd9ea5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjA3Nzg2Mw==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1364#discussion_r552077863", "bodyText": "Updated", "author": "Nana-EC", "createdAt": "2021-01-05T17:23:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjAxNTg4Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjA0MTUxNQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1364#discussion_r552041515", "bodyText": "in v1.32.1, this index is dropped and and index on transaction (payer_account_id, consensus_ns) is created", "author": "xin-hedera", "createdAt": "2021-01-05T16:25:11Z", "path": "hedera-mirror-importer/src/main/resources/db/migration/v2/V2.0.2__time_scale_index_init.sql", "diffHunk": "@@ -105,7 +91,9 @@ create unique index if not exists topic_message__topic_num_realm_num_seqnum\n -- have to add consensus_timestamp due to partitioning\n \n -- transaction\n-create index transaction__transaction_id\n+create index if not exists transaction__transaction_id\n     on transaction (valid_start_ns, payer_account_id);\n-create index transaction__payer_account_id\n+create index if not exists transaction__payer_account_id", "originalCommit": "62bb893cb898bf0fd47d0d38868c0ddb5dfd9ea5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjA3MTM4NA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1364#discussion_r552071384", "bodyText": "I thought I'd already pushed the if not exists addition.\nBut I'll add the index correction also. Thanks", "author": "Nana-EC", "createdAt": "2021-01-05T17:12:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjA0MTUxNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjA3NzgwOA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1364#discussion_r552077808", "bodyText": "Added", "author": "Nana-EC", "createdAt": "2021-01-05T17:23:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjA0MTUxNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjA0NDAzNg==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1364#discussion_r552044036", "bodyText": "nit: prefer primary constraint before indexes", "author": "xin-hedera", "createdAt": "2021-01-05T16:28:56Z", "path": "hedera-mirror-importer/src/main/resources/db/migration/v2/V2.0.2__time_scale_index_init.sql", "diffHunk": "@@ -20,13 +20,9 @@ create unique index if not exists account_balance_file__name\n alter table account_balance_file\n     add constraint account_balance_file_timestamp primary key (consensus_timestamp);", "originalCommit": "62bb893cb898bf0fd47d0d38868c0ddb5dfd9ea5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjA3NzY4OA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1364#discussion_r552077688", "bodyText": "Reorganized", "author": "Nana-EC", "createdAt": "2021-01-05T17:23:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjA0NDAzNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjA1MDI1Mw==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1364#discussion_r552050253", "bodyText": "in v1, token_id is the primary key, will changing it to an index in v2 drop the unique constraint?", "author": "xin-hedera", "createdAt": "2021-01-05T16:38:21Z", "path": "hedera-mirror-importer/src/main/resources/db/migration/v2/V2.0.2__time_scale_index_init.sql", "diffHunk": "@@ -76,14 +66,10 @@ create unique index if not exists entities_unq\n -- have to add id due to partitioning\n \n -- token\n-alter table if exists token\n-    add constraint token_timestamp primary key (created_timestamp);\n create index if not exists token_id\n     on token (token_id);", "originalCommit": "62bb893cb898bf0fd47d0d38868c0ddb5dfd9ea5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjA3MzkxNA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1364#discussion_r552073914", "bodyText": "Good catch, this should be a unique index to prevent duplicates.\nMaybe also unique across token_id and created_timestamp", "author": "Nana-EC", "createdAt": "2021-01-05T17:16:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjA1MDI1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjA3NzYyMg==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1364#discussion_r552077622", "bodyText": "Updated and added", "author": "Nana-EC", "createdAt": "2021-01-05T17:23:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjA1MDI1Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjA2NDc4Ng==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1364#discussion_r552064786", "bodyText": "there is a production release pushed yesterday: timescaledev/timescaledb-ha:pg12.5-ts2.0.0-p0", "author": "xin-hedera", "createdAt": "2021-01-05T17:01:41Z", "path": "docker-compose.yml", "diffHunk": "@@ -67,3 +67,19 @@ services:\n     tty: true\n     ports:\n       - 5551:5551\n+\n+  timescaledb:\n+    deploy:\n+      replicas: 0\n+    image: timescaledev/timescaledb-ha:pg12-ts2.0.0-rc3", "originalCommit": "62bb893cb898bf0fd47d0d38868c0ddb5dfd9ea5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjA3NDExMQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1364#discussion_r552074111", "bodyText": "Yes will be pushing this shortly, thanks", "author": "Nana-EC", "createdAt": "2021-01-05T17:17:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjA2NDc4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjA3NzU0Mg==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1364#discussion_r552077542", "bodyText": "Updated", "author": "Nana-EC", "createdAt": "2021-01-05T17:23:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjA2NDc4Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjA5MzAwOA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1364#discussion_r552093008", "bodyText": "Using the non-HA image. To keep it DRY, please change it to use the templated helm image from the statefulset", "author": "steven-sheehy", "createdAt": "2021-01-05T17:49:37Z", "path": "charts/hedera-mirror/templates/job-timescaledb-init.yaml", "diffHunk": "@@ -15,7 +15,7 @@ spec:\n     spec:\n       containers:\n         - name: init-mirrornode-db\n-          image: timescaledev/timescaledb-ha:pg12-ts2.0.0-rc3\n+          image: timescale/timescaledb:2.0.0-pg12", "originalCommit": "0742eadeff9377724f80ed3fe2f6bb4933f8596e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjEwNjkzMQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1364#discussion_r552106931", "bodyText": "5432?", "author": "steven-sheehy", "createdAt": "2021-01-05T18:14:44Z", "path": "hedera-mirror-importer/src/main/resources/db/scripts/init_v2.sql", "diffHunk": "@@ -0,0 +1,68 @@\n+-- init the timescale db mirror node db\n+-- Change the values below if you are not installing via Docker\n+\n+\\set db_host 'localhost'\n+\\set db_port 6432", "originalCommit": "0742eadeff9377724f80ed3fe2f6bb4933f8596e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjE0Nzg4Ng==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1364#discussion_r552147886", "bodyText": "Left over from local tests, will revert to 5432", "author": "Nana-EC", "createdAt": "2021-01-05T19:31:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjEwNjkzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzAxNjk0MQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1364#discussion_r553016941", "bodyText": "Reverted", "author": "Nana-EC", "createdAt": "2021-01-06T23:30:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjEwNjkzMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjExNDcyNA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1364#discussion_r552114724", "bodyText": "I don't think the importer ever deletes rows, right?", "author": "steven-sheehy", "createdAt": "2021-01-05T18:28:30Z", "path": "hedera-mirror-importer/src/main/resources/db/scripts/init_v2.sql", "diffHunk": "@@ -0,0 +1,68 @@\n+-- init the timescale db mirror node db\n+-- Change the values below if you are not installing via Docker\n+\n+\\set db_host 'localhost'\n+\\set db_port 6432\n+\\set db_name 'mirror_node'\n+\\set db_super_user 'postgres'\n+\\set db_owner 'mirror_node'\n+\\set owner_password 'mirror_node_pass'\n+\\set importer_user 'mirror_importer'\n+\\set importer_password 'mirror_importer_pass'\n+\\set grpc_user 'mirror_grpc'\n+\\set grpc_password 'mirror_grpc_pass'\n+\\set rest_user 'mirror_api'\n+\\set rest_password 'mirror_api_pass'\n+\\set schema_name 'mirrornode'\n+\n+-- create owner user\n+create user :db_owner with login password :'owner_password';\n+\n+-- create primary user and db\n+create database :db_name with owner :db_owner;\n+\n+-- create roles\n+create role readonly;\n+create role readwrite in role readonly;\n+\n+-- create users\n+create user :grpc_user with login password :'grpc_password' in role readonly;\n+create user :rest_user with login password :'rest_password' in role readonly;\n+create user :importer_user with login password :'importer_password' in role readwrite;\n+\n+-- connect with db owner to create schema and set schema user permissions\n+\\c :db_name :db_owner\n+create schema if not exists :schema_name authorization :db_owner;\n+grant usage on schema :schema_name to public;\n+\n+-- revoke default public permissions on schema\n+revoke create on schema :schema_name from public;\n+\n+-- grant connect and schema access to readonly role\n+grant connect on database :db_name to readonly;\n+grant usage on schema :schema_name to readonly;\n+\n+-- grant select privileges on tables to readonly\n+-- grant all privileges on all tables in schema :schema_name to :db_owner;\n+grant select on all tables in schema :schema_name to readonly;\n+alter default privileges in schema :schema_name grant select on tables to readonly;\n+\n+-- grant select privileges on sequences to readonly\n+-- grant all privileges on all sequences in schema :schema_name to :db_owner;\n+grant select on all sequences in schema :schema_name to readonly;\n+alter default privileges in schema :schema_name grant select on sequences to readonly;\n+\n+-- grant write privileges on sequences to readwrite\n+grant insert, update, delete on all tables in schema :schema_name to readwrite;", "originalCommit": "0742eadeff9377724f80ed3fe2f6bb4933f8596e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjE0Nzc5NA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1364#discussion_r552147794", "bodyText": "Correct, will remove delete", "author": "Nana-EC", "createdAt": "2021-01-05T19:31:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjExNDcyNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzAxNjk5Nw==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1364#discussion_r553016997", "bodyText": "Removed", "author": "Nana-EC", "createdAt": "2021-01-06T23:30:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjExNDcyNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjI2MzQzNA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1364#discussion_r552263434", "bodyText": "nit:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            In both cases the only setup required is to create the initial database, users, schema, extensions and ensure all\n          \n          \n            \n            In both cases the only setup required is to create the initial database, users, schema, and extensions, and ensure all", "author": "ijungmann", "createdAt": "2021-01-05T23:39:50Z", "path": "docs/installation.md", "diffHunk": "@@ -19,16 +19,29 @@ runnable Mirror Node JAR file in the `target` directory.\n ## Running Locally\n \n ### Database Setup\n+In addition to OpenJDK 11, you will need to install a database and initialize it.\n+The Mirror Node utilizes [PostgreSQL](https://postgresql.org) v9.6 or [TimescaleDB](https://docs.timescale.com/latest/main) v2 depending on the version of its database schema.\n \n-In addition to OpenJDK 11, you will need to install [PostgreSQL](https://postgresql.org) 9.6 and initialize it. The only\n-setup required is to create the initial database and owner since [Flyway](https://flywaydb.org) manages the database\n-schema. The SQL script located at `hedera-mirror-importer/src/main/resources/db/scripts/init.sql` can be used to\n-accomplish this. Edit the file and change the `db_name`, `db_user`, `db_password` `db_owner`, `grpc_user`, or\n-`grpc_password` as appropriate. Make sure the application [configuration](configuration.md) matches the values in the\n-script. Run the script as a DB admin user and check the output carefully to ensure no errors occurred.\n+In both cases the only setup required is to create the initial database, users, schema, extensions and ensure all", "originalCommit": "9f28e9da19a1fd2f148dfc972866c1c95def42aa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzAxMDg2OA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1364#discussion_r553010868", "bodyText": "This took me on an refreshing grammar clarification tangent.\nFirst, I thought \"I'm fine with the Oxford comma but not sure about the additional and\"\nThen post research I thought \"the and is useful and the Oxford comma isn't necessary since there's only 2 clauses i.e. creating ... and ensuring ...\"\nGoing go with the later, here's a useful link - https://www.grammarly.com/blog/comma/", "author": "Nana-EC", "createdAt": "2021-01-06T23:11:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjI2MzQzNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzAxNDE2OQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1364#discussion_r553014169", "bodyText": "Better yet.\n\nFor both databases, since Flyway will manage the database schema, the only required setup steps include:\n\ncreating the database, users, schema, and extensions.\nensuring all permissions are set.", "author": "Nana-EC", "createdAt": "2021-01-06T23:21:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjI2MzQzNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzQzOTY4Nw==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1364#discussion_r553439687", "bodyText": "Fair point, I can get a little heavy-handed with commas at times.  I like the solution you went with.", "author": "ijungmann", "createdAt": "2021-01-07T16:32:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjI2MzQzNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjI2NDU5NA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1364#discussion_r552264594", "bodyText": "Should these still be commented out?", "author": "ijungmann", "createdAt": "2021-01-05T23:43:17Z", "path": "docs/installation.md", "diffHunk": "@@ -95,14 +108,33 @@ Docker Compose scripts are provided and run all the mirror node components:\n Containers use the following persisted volumes:\n \n - `./db` on your local machine maps to `/var/lib/postgresql/data` in the containers. This contains the files for the\n-  PostgreSQL database. If the database container fails to initialise properly and the database fails to run, you will\n-  have to delete this folder prior to attempting a restart otherwise the database initialisation scripts will not be\n-  run.\n+  PostgreSQL/TimescaleDB database. If the database container fails to initialise properly and the database fails to run,\n+  you will have to delete this folder prior to attempting a restart otherwise the database initialisation scripts will\n+  not be run.\n \n - `./data` on your local machine maps to `/var/lib/hedera-mirror-importer` in the container. This contains files\n   downloaded from S3 or GCP. These are necessary not only for the database data to be persisted, but also so that the\n   parsing containers can access file obtained via the downloading containers\n \n+### Configuration\n+\n+#### TimescaleDB vs PostgreSQL\n+To utilize the TimescaleDB database over the default PostgreSQL database, disable the PostgreSQL container and enable the TimescaleDB container.\n+\n+To achieve this the `docker-compose.yml` can be updated as follows:\n+```yaml\n+    ...\n+    services:\n+      db:\n+        deploy:\n+          replicas: 0\n+      ...\n+      timescaledb:\n+        #    deploy:\n+        #      replicas: 0", "originalCommit": "9f28e9da19a1fd2f148dfc972866c1c95def42aa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Mjg5NTE2Mw==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1364#discussion_r552895163", "bodyText": "Yes, I'm suggesting to the user how they might enable timescaledb.\nMaybe I should be more explicit or maybe make this a strikethrough to show they should remove it instead", "author": "Nana-EC", "createdAt": "2021-01-06T18:40:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjI2NDU5NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Mjk1NjAxMA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1364#discussion_r552956010", "bodyText": "I'm okay with it as long as it's valid, just making sure this was correct.", "author": "ijungmann", "createdAt": "2021-01-06T20:53:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjI2NDU5NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzAxNzE1OA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1364#discussion_r553017158", "bodyText": "Added comments to be more explicit", "author": "Nana-EC", "createdAt": "2021-01-06T23:31:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjI2NDU5NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjI2NjM1MA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1364#discussion_r552266350", "bodyText": "nit:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            1. Setup a new TimescaleDB database\n          \n          \n            \n            1. Set up a new TimescaleDB database", "author": "ijungmann", "createdAt": "2021-01-05T23:47:40Z", "path": "docs/operations.md", "diffHunk": "@@ -93,6 +93,49 @@ systemctl status hedera-mirror-importer.service\n sudo journalctl -fu hedera-mirror-importer.service\n ```\n \n+### v1 to v2 Data Migration\n+\n+To support time series logic the Mirror Node DB schema shifted from PostgeSQL (v1) to TimescaleDB (v2).\n+[Migrating from a Different PostgreSQL Database](https://docs.timescale.com/latest/getting-started/migrating-data#different-db) highlights the general recommended data migration steps when moving to TimescaleDB.\n+\n+For mirror node operators running v1 db schema, the following steps can be taken to upgrade to v2.\n+\n+1. Setup a new TimescaleDB database", "originalCommit": "9f28e9da19a1fd2f148dfc972866c1c95def42aa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzAxNzE5MQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1364#discussion_r553017191", "bodyText": "Updated", "author": "Nana-EC", "createdAt": "2021-01-06T23:31:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjI2NjM1MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjI2ODMyMw==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1364#discussion_r552268323", "bodyText": "nit:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n               The script uses successive `psql` connections to backup, configure and restore data on the new database nodes.\n          \n          \n            \n               The script uses successive `psql` connections to back up, configure and restore data on the new database nodes.", "author": "ijungmann", "createdAt": "2021-01-05T23:49:47Z", "path": "docs/operations.md", "diffHunk": "@@ -93,6 +93,49 @@ systemctl status hedera-mirror-importer.service\n sudo journalctl -fu hedera-mirror-importer.service\n ```\n \n+### v1 to v2 Data Migration\n+\n+To support time series logic the Mirror Node DB schema shifted from PostgeSQL (v1) to TimescaleDB (v2).\n+[Migrating from a Different PostgreSQL Database](https://docs.timescale.com/latest/getting-started/migrating-data#different-db) highlights the general recommended data migration steps when moving to TimescaleDB.\n+\n+For mirror node operators running v1 db schema, the following steps can be taken to upgrade to v2.\n+\n+1. Setup a new TimescaleDB database\n+\n+    A new TimescaleDB server must be spun up.\n+\n+    Refer to Mirror Node [DB Installation](installation.md#database-setup) for manual instructions.\n+\n+    To use the Mirror Node configured docker container, simply run:\n+\n+    ```shell script\n+    $ docker-compose up timescaledb\n+    ```\n+\n+    Refer to [TimescaleDB Installation Instructions](https://docs.timescale.com/latest/getting-started/installation) for other installation options.\n+\n+    > **_NOTE:_** The following steps assume the database, users and schema have been created as detailed above\n+\n+2. Configure migration properties\n+\n+    The configuration file `hedera-mirror-importer/src/main/resources/db/scripts/timescaledb/migration.config` contains db variables for easy running.\n+    These options include variables such as db names, passwords, users, hosts for both the existing db and the new db.\n+\n+    Update these values appropriately for your db setup.\n+\n+3. Run migration script\n+\n+    From the `hedera-mirror-importer/src/main/resources/db` directory run the `migration.sh` script\n+    ```shell script\n+    $ ./scripts/timescaledb/migration.sh\n+    ```\n+\n+   The script uses successive `psql` connections to backup, configure and restore data on the new database nodes.", "originalCommit": "9f28e9da19a1fd2f148dfc972866c1c95def42aa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzAxNzIxNg==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1364#discussion_r553017216", "bodyText": "Updated", "author": "Nana-EC", "createdAt": "2021-01-06T23:31:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjI2ODMyMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjI2OTQ3NQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1364#discussion_r552269475", "bodyText": "nit: I believe hypertable is always one word.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n               It then utilizes the migration sql script used by normal flyway operations to create the new tables and then creates the Timescale hyper tables based on these.\n          \n          \n            \n               It then utilizes the migration sql script used by normal flyway operations to create the new tables and then creates the Timescale hypertables based on these.", "author": "ijungmann", "createdAt": "2021-01-05T23:53:41Z", "path": "docs/operations.md", "diffHunk": "@@ -93,6 +93,49 @@ systemctl status hedera-mirror-importer.service\n sudo journalctl -fu hedera-mirror-importer.service\n ```\n \n+### v1 to v2 Data Migration\n+\n+To support time series logic the Mirror Node DB schema shifted from PostgeSQL (v1) to TimescaleDB (v2).\n+[Migrating from a Different PostgreSQL Database](https://docs.timescale.com/latest/getting-started/migrating-data#different-db) highlights the general recommended data migration steps when moving to TimescaleDB.\n+\n+For mirror node operators running v1 db schema, the following steps can be taken to upgrade to v2.\n+\n+1. Setup a new TimescaleDB database\n+\n+    A new TimescaleDB server must be spun up.\n+\n+    Refer to Mirror Node [DB Installation](installation.md#database-setup) for manual instructions.\n+\n+    To use the Mirror Node configured docker container, simply run:\n+\n+    ```shell script\n+    $ docker-compose up timescaledb\n+    ```\n+\n+    Refer to [TimescaleDB Installation Instructions](https://docs.timescale.com/latest/getting-started/installation) for other installation options.\n+\n+    > **_NOTE:_** The following steps assume the database, users and schema have been created as detailed above\n+\n+2. Configure migration properties\n+\n+    The configuration file `hedera-mirror-importer/src/main/resources/db/scripts/timescaledb/migration.config` contains db variables for easy running.\n+    These options include variables such as db names, passwords, users, hosts for both the existing db and the new db.\n+\n+    Update these values appropriately for your db setup.\n+\n+3. Run migration script\n+\n+    From the `hedera-mirror-importer/src/main/resources/db` directory run the `migration.sh` script\n+    ```shell script\n+    $ ./scripts/timescaledb/migration.sh\n+    ```\n+\n+   The script uses successive `psql` connections to backup, configure and restore data on the new database nodes.\n+   First it copies over the `flyway_schema_history` table, to maintain migration history.\n+   It then utilizes the migration sql script used by normal flyway operations to create the new tables and then creates the Timescale hyper tables based on these.", "originalCommit": "9f28e9da19a1fd2f148dfc972866c1c95def42aa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzAxNzI2MA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1364#discussion_r553017260", "bodyText": "Fixed", "author": "Nana-EC", "createdAt": "2021-01-06T23:31:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjI2OTQ3NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjI3MDUyMw==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1364#discussion_r552270523", "bodyText": "nit:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            echo \"4. Creating new hyper tables on TimescaleDB($NEW_DB_HOST:$NEW_DB_PORT)...\"\n          \n          \n            \n            echo \"4. Creating new hypertables on TimescaleDB($NEW_DB_HOST:$NEW_DB_PORT)...\"", "author": "ijungmann", "createdAt": "2021-01-05T23:56:56Z", "path": "hedera-mirror-importer/src/main/resources/db/scripts/timescaledb/migration.sh", "diffHunk": "@@ -0,0 +1,98 @@\n+#!/usr/bin/env bash\n+echo \"BASH_VERSION: $BASH_VERSION\"\n+set -e\n+\n+. scripts/timescaledb/migration.config\n+\n+if [[ -z $OLD_DB_HOST ]]; then\n+    echo \"Old host name is not set. Please configure OLD_DB_HOST in migration.config file and rerun './scripts/timescaledb/migration.sh'\"\n+    exit 1\n+fi\n+\n+if [[ -z $OLD_DB_NAME ]]; then\n+    echo \"Old db name is not set. Please configure OLD_DB_NAME in migration.config file and rerun './scripts/timescaledb/migration.sh'\"\n+    exit 1\n+fi\n+\n+if [[ -z $OLD_DB_PORT ]]; then\n+    echo \"Old port is not set. Please configure OLD_DB_PORT in migration.config file and rerun './scripts/timescaledb/migration.sh'\"\n+    exit 1\n+fi\n+\n+if [[ -z $OLD_DB_USER ]]; then\n+    echo \"Old db primary user name is not set. Please configure OLD_DB_USER in migration.config file and rerun './scripts/timescaledb/migration.sh'\"\n+    exit 1\n+fi\n+\n+if [[ -z $OLD_PASSWORD ]]; then\n+    echo \"Old db primary user password is not set. Please configure OLD_PASSWORD in migration.config file and rerun './scripts/timescaledb/migration.sh'\"\n+    exit 1\n+fi\n+\n+if [[ -z $NEW_DB_HOST ]]; then\n+    echo \"New host name is not set. Please configure NEW_DB_HOST in migration.config file and rerun './scripts/timescaledb/migration.sh'\"\n+    exit 1\n+fi\n+\n+if [[ -z $NEW_DB_NAME ]]; then\n+    echo \"New db name is not set. Please configure NEW_DB_NAME in migration.config file and rerun './scripts/timescaledb/migration.sh'\"\n+    exit 1\n+fi\n+\n+if [[ -z $NEW_DB_PORT ]]; then\n+    echo \"New db port is not set. Please configure NEW_DB_PORT in migration.config file and rerun './scripts/timescaledb/migration.sh'\"\n+    exit 1\n+fi\n+\n+if [[ -z $NEW_DB_USER ]]; then\n+    echo \"New db primary user name is not set. Please configure NEW_DB_USER in migration.config file and rerun './scripts/timescaledb/migration.sh'\"\n+    exit 1\n+fi\n+\n+if [[ -z $NEW_PASSWORD ]]; then\n+    echo \"New db primary user password is not set. Please configure NEW_PASSWORD in migration.config file and rerun './scripts/timescaledb/migration.sh'\"\n+    exit 1\n+fi\n+\n+if [[ -z $CHUNK_INTERVAL_TIME ]]; then\n+    echo \"New db chunk interval time is not set. Please configure CHUNK_INTERVAL_TIME in migration.config file and rerun './scripts/timescaledb/migration.sh'\"\n+    exit 1\n+fi\n+\n+if [[ -z $CHUNK_INTERVAL_ID ]]; then\n+    echo \"New db chunk interval id is not set. Please configure CHUNK_INTERVAL_ID in migration.config file and rerun './scripts/timescaledb/migration.sh'\"\n+    exit 1\n+fi\n+\n+start_time=\"$(date -u +%s)\"\n+# assumes 1. Valid populated old mirror node postgres db with appropriate user 2. New empty TimescaleDB db host with appropriate user\n+echo \"Migrating Mirror Node Data from Postgres($OLD_DB_HOST:$OLD_DB_PORT) to TimescaleDB($NEW_DB_HOST:$NEW_DB_PORT)...\"\n+\n+echo \"1. Backing up flyway table schema from Postgres($OLD_DB_HOST:$OLD_DB_PORT)...\"\n+PGPASSWORD=${OLD_PASSWORD} pg_dump -h $OLD_DB_HOST -p $OLD_DB_PORT -U $OLD_DB_USER --table public.flyway_schema_history -f mirror_node_${start_time}.bak mirror_node\n+\n+echo \"2. Restoring flyway_schema_history to TimescaleDB($NEW_DB_HOST:$NEW_DB_PORT)...\"\n+PGPASSWORD=${NEW_PASSWORD} psql -h $NEW_DB_HOST -d $NEW_DB_NAME -p $NEW_DB_PORT -U $NEW_DB_USER <mirror_node_${start_time}.bak\n+\n+echo \"3. Create v2 table schemas in TimescaleDB($NEW_DB_HOST:$NEW_DB_PORT)...\"\n+PGPASSWORD=${NEW_PASSWORD} psql -h $NEW_DB_HOST -d $NEW_DB_NAME -p $NEW_DB_PORT -U $NEW_DB_USER <migration/v2/V2.0.0__time_scale_init.sql\n+\n+echo \"4. Creating new hyper tables on TimescaleDB($NEW_DB_HOST:$NEW_DB_PORT)...\"", "originalCommit": "9f28e9da19a1fd2f148dfc972866c1c95def42aa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzAxNzI4MQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1364#discussion_r553017281", "bodyText": "Fixed", "author": "Nana-EC", "createdAt": "2021-01-06T23:31:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjI3MDUyMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzQwMTgzMg==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1364#discussion_r553401832", "bodyText": "duplicate? the readiness test should have passed at line 23.\nsame on line 33", "author": "xin-hedera", "createdAt": "2021-01-07T15:32:55Z", "path": "charts/hedera-mirror/templates/job-timescaledb-init.yaml", "diffHunk": "@@ -2,41 +2,68 @@\n apiVersion: batch/v1\n kind: Job\n metadata:\n-  labels:\n-    {{- include \"hedera-mirror.labels\" . | nindent 4 }}\n+  labels: {{- include \"hedera-mirror.labels\" . | nindent 4 }}\n   name: {{ include \"hedera-mirror.dbHost\" . }}-init-job\n   namespace: {{ include \"hedera-mirror.namespace\" . }}\n   annotations:\n     \"helm.sh/hook\": post-install\n-    \"helm.sh/hook-delete-policy\": hook-succeeded\n spec:\n-  backoffLimit: 4\n+  backoffLimit: 1\n   template:\n     spec:\n       containers:\n         - name: init-mirrornode-db\n-          image: timescaledev/timescaledb-ha:pg12-ts2.0.0-rc3\n+          image: \"{{ .Values.timescaledb.image.repository }}:{{ .Values.timescaledb.image.tag }}\"\n           command:\n             - sh\n             - -c\n             - |\n               set -e\n \n               while ! pg_isready -U postgres -h {{ include \"hedera-mirror.dbHost\" . }}-data; do sleep 1; done;\n-              psql --echo-queries -d \"${ACCESS_SVC_CONNSTR_POSTGRES}\" --set ON_ERROR_STOP=1 -f ${DB_INIT_FILE}\n+              psql --echo-queries -d \"${ACCESS_SVC_CONNSTR_POSTGRES}\" --set ON_ERROR_STOP=1 -f ${DB_USERS_FILE}\n+              echo 'Completed db initialization and user creation for mirror node'\n+              sleep 5s\n+\n+              while ! pg_isready -U postgres -h {{ include \"hedera-mirror.dbHost\" . }}-data; do sleep 1; done;", "originalCommit": "2cebb0290c7aa90f89b8ede26c6550331fe2e284", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzQ2MDk2Mg==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1364#discussion_r553460962", "bodyText": "Intentionally duplicated  due to previous logic I was exploring but will remove as it's no longer needed", "author": "Nana-EC", "createdAt": "2021-01-07T17:07:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzQwMTgzMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzYwMzcyOA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1364#discussion_r553603728", "bodyText": "Removed, along with the sleeps", "author": "Nana-EC", "createdAt": "2021-01-07T21:38:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzQwMTgzMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzAyNDU1MA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1364#discussion_r553024550", "bodyText": "Instead of this, would prefer alter table if exists token_account add primary key (created_timestamp) to clearly mark this as the primary key and not just a unique field", "author": "steven-sheehy", "createdAt": "2021-01-06T23:57:15Z", "path": "hedera-mirror-importer/src/main/resources/db/migration/v1/V1.33.0__drop_token_account_id.sql", "diffHunk": "@@ -0,0 +1,19 @@\n+-------------------\n+-- Drop token_account id, replacing id primary key with unique index on (created_timestamp)\n+-------------------\n+alter table token_account\n+    drop constraint token_account_pkey;\n+create unique index if not exists token_account__created_timestamp", "originalCommit": "e0c60a1b749ff7d50edfa5face8757462dbbb508", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzUxNTIyMg==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1364#discussion_r553515222", "bodyText": "Yep, will update", "author": "Nana-EC", "createdAt": "2021-01-07T18:46:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzAyNDU1MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzYwMzc4Ng==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1364#discussion_r553603786", "bodyText": "Updated", "author": "Nana-EC", "createdAt": "2021-01-07T21:38:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzAyNDU1MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzAyNDYwOQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1364#discussion_r553024609", "bodyText": "if exists", "author": "steven-sheehy", "createdAt": "2021-01-06T23:57:27Z", "path": "hedera-mirror-importer/src/main/resources/db/migration/v1/V1.33.0__drop_token_account_id.sql", "diffHunk": "@@ -0,0 +1,19 @@\n+-------------------\n+-- Drop token_account id, replacing id primary key with unique index on (created_timestamp)\n+-------------------\n+alter table token_account", "originalCommit": "e0c60a1b749ff7d50edfa5face8757462dbbb508", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzUxNTMwOQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1364#discussion_r553515309", "bodyText": "Will add", "author": "Nana-EC", "createdAt": "2021-01-07T18:46:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzAyNDYwOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzYwMzg1MA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1364#discussion_r553603850", "bodyText": "Added", "author": "Nana-EC", "createdAt": "2021-01-07T21:38:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzAyNDYwOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzAyNjUzOQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1364#discussion_r553026539", "bodyText": "We don't currently have a unique index with this 3 tuple. I only see one for token_id, account_id.", "author": "steven-sheehy", "createdAt": "2021-01-07T00:04:22Z", "path": "hedera-mirror-importer/src/main/resources/db/migration/v2/V2.0.2__time_scale_index_init.sql", "diffHunk": "@@ -76,15 +66,11 @@ create unique index if not exists entities_unq\n -- have to add id due to partitioning\n \n -- token\n-alter table if exists token\n-    add constraint token_timestamp primary key (created_timestamp);\n-create index if not exists token_id\n-    on token (token_id);\n+create unique index if not exists token__id_timestamp\n+    on token (token_id, created_timestamp);\n \n -- token_account\n-alter table if exists token_account\n-    add constraint token_account_timestamp primary key (created_timestamp);\n-create unique index if not exists token_account__token_account\n+create unique index if not exists token_account__token_account_timestamp\n     on token_account (token_id, account_id, created_timestamp);", "originalCommit": "e0c60a1b749ff7d50edfa5face8757462dbbb508", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzQ3MjY3Ng==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1364#discussion_r553472676", "bodyText": "We do not in v1, however in v2 any column that's used for chunking has to be in the indexes of a table due to partitioning requirements.\n\"To define an index as UNIQUE or PRIMARY KEY, the time column and, if it exists, the partitioning column must be part of the index.\"\nSee https://docs.timescale.com/latest/using-timescaledb/schema-management#indexing-best-practices", "author": "Nana-EC", "createdAt": "2021-01-07T17:26:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzAyNjUzOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzAyODU2NA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1364#discussion_r553028564", "bodyText": "I understand we removed these primary keys because create hypertable creates similar indexes. Do the indexes created by TimescaleDB also mark them as primary key? If not, is it something we can do after using the constraint it creates?", "author": "steven-sheehy", "createdAt": "2021-01-07T00:11:29Z", "path": "hedera-mirror-importer/src/main/resources/db/migration/v2/V2.0.2__time_scale_index_init.sql", "diffHunk": "@@ -76,15 +66,11 @@ create unique index if not exists entities_unq\n -- have to add id due to partitioning\n \n -- token\n-alter table if exists token\n-    add constraint token_timestamp primary key (created_timestamp);\n-create index if not exists token_id\n-    on token (token_id);\n+create unique index if not exists token__id_timestamp\n+    on token (token_id, created_timestamp);\n \n -- token_account\n-alter table if exists token_account", "originalCommit": "e0c60a1b749ff7d50edfa5face8757462dbbb508", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzUwMjA4NA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1364#discussion_r553502084", "bodyText": "The indexes created by TimescaleDB are not primary keys.\nThe are just basic index.\nThis means to make it a primary key after the fact we'd have to\n\nin V2.0.2__time_scale_index_init.sql add a primary key and drop the index created by TimescaleDB\nset create_default_indexes param in create_hypertable to false in V2.0.1__hyper_tables.sql and just create the primary key here in V2.0.2__time_scale_index_init.sql\nUpdate V2.0.0__time_scale_init.sql with primary key flags in the table create.\n\nContinuing the attempt to keep all constraint creations in file V2.0.2__time_scale_index_init.sql so I'll go with option 2 as is for other tables in this file.", "author": "Nana-EC", "createdAt": "2021-01-07T18:20:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzAyODU2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzUxNjM1Nw==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1364#discussion_r553516357", "bodyText": "Will do for all tables. This will break a few tests add the primary key has moved from id to timestamp in some cases", "author": "Nana-EC", "createdAt": "2021-01-07T18:48:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzAyODU2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzYwNDQwMw==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1364#discussion_r553604403", "bodyText": "Added all missing primary keys and did a comparison to v1 to make sure they were in sync", "author": "Nana-EC", "createdAt": "2021-01-07T21:40:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzAyODU2NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzQ0NDUyOQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1364#discussion_r553444529", "bodyText": "a) this should be a primary key b) create_hypertable should already create this for us", "author": "steven-sheehy", "createdAt": "2021-01-07T16:39:58Z", "path": "hedera-mirror-importer/src/main/resources/db/migration/v2/V2.0.2__time_scale_index_init.sql", "diffHunk": "@@ -105,7 +91,9 @@ create unique index if not exists topic_message__topic_num_realm_num_seqnum\n -- have to add consensus_timestamp due to partitioning\n \n -- transaction\n-create index transaction__transaction_id\n+create index if not exists transaction__transaction_id\n     on transaction (valid_start_ns, payer_account_id);\n-create index transaction__payer_account_id\n-    on transaction (payer_account_id);\n+create index if not exists transaction__payer_account_id_consensus_ns\n+    on transaction (payer_account_id, consensus_ns);\n+create index if not exists transaction_consensus_ns", "originalCommit": "2cebb0290c7aa90f89b8ede26c6550331fe2e284", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzQ2OTQwOQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1364#discussion_r553469409", "bodyText": "Left over, yes create_hypertable will add index for consensus_ns", "author": "Nana-EC", "createdAt": "2021-01-07T17:21:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzQ0NDUyOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzYwNTAyMQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1364#discussion_r553605021", "bodyText": "Removed and removed consensus_ns from transaction__payer_account_id index as it's not required to be added", "author": "Nana-EC", "createdAt": "2021-01-07T21:41:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzQ0NDUyOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzQ0NTk1NA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1364#discussion_r553445954", "bodyText": "This index does not exist in v1. created_timestamp is already unique and should not be added to another field to make a composite key. There should just be an unique index on token_id", "author": "steven-sheehy", "createdAt": "2021-01-07T16:42:22Z", "path": "hedera-mirror-importer/src/main/resources/db/migration/v2/V2.0.2__time_scale_index_init.sql", "diffHunk": "@@ -76,15 +66,11 @@ create unique index if not exists entities_unq\n -- have to add id due to partitioning\n \n -- token\n-alter table if exists token\n-    add constraint token_timestamp primary key (created_timestamp);\n-create index if not exists token_id\n-    on token (token_id);\n+create unique index if not exists token__id_timestamp\n+    on token (token_id, created_timestamp);", "originalCommit": "2cebb0290c7aa90f89b8ede26c6550331fe2e284", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzUxNzIxOA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1364#discussion_r553517218", "bodyText": "Same notion as before, it didn't exist in v1 but needs to in v2 because of partitioning requirements", "author": "Nana-EC", "createdAt": "2021-01-07T18:50:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzQ0NTk1NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzY0MDcwMA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1364#discussion_r553640700", "bodyText": "In PostgreSQL, this would greatly increase the size of the index unnecessarily and cause memory churn. I'm guessing TimescaleDB is more efficient and is smart enough to not duplicate the index information. If not, we should consider making this a non-unique index in the future and rely on the main nodes for data constraints.", "author": "steven-sheehy", "createdAt": "2021-01-07T22:55:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzQ0NTk1NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzQ0NzU5Mw==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1364#discussion_r553447593", "bodyText": "Since we're dropping the constraint it might also transitively drop the index. Can we verify that the token_id still has a unique index after this?", "author": "steven-sheehy", "createdAt": "2021-01-07T16:45:02Z", "path": "hedera-mirror-importer/src/main/resources/db/migration/v1/V1.33.0__drop_token_account_id.sql", "diffHunk": "@@ -0,0 +1,19 @@\n+-------------------\n+-- Drop token_account id, replacing id primary key with unique index on (created_timestamp)\n+-------------------\n+alter table token_account\n+    drop constraint token_account_pkey;", "originalCommit": "2cebb0290c7aa90f89b8ede26c6550331fe2e284", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzU3NTE3Nw==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1364#discussion_r553575177", "bodyText": "Verified unique index still remains", "author": "Nana-EC", "createdAt": "2021-01-07T20:38:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzQ0NzU5Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzQ0ODY0NA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1364#discussion_r553448644", "bodyText": "These need to be added to config docs.", "author": "steven-sheehy", "createdAt": "2021-01-07T16:46:44Z", "path": "hedera-mirror-importer/src/main/resources/application.yml", "diffHunk": "@@ -5,10 +5,13 @@ hedera:\n         host: 127.0.0.1\n         loadBalance: true\n         name: mirror_node\n+        owner: mirror_node", "originalCommit": "2cebb0290c7aa90f89b8ede26c6550331fe2e284", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzYwNTQ3MA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1364#discussion_r553605470", "bodyText": "Added to config doc", "author": "Nana-EC", "createdAt": "2021-01-07T21:42:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzQ0ODY0NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzQ1MDg2Ng==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1364#discussion_r553450866", "bodyText": "We don't need to project every file in the secret. Just mount the entire secret as you were doing. This way is brittle and verbose.", "author": "steven-sheehy", "createdAt": "2021-01-07T16:50:31Z", "path": "charts/hedera-mirror/templates/job-timescaledb-init.yaml", "diffHunk": "@@ -2,41 +2,68 @@\n apiVersion: batch/v1\n kind: Job\n metadata:\n-  labels:\n-    {{- include \"hedera-mirror.labels\" . | nindent 4 }}\n+  labels: {{- include \"hedera-mirror.labels\" . | nindent 4 }}\n   name: {{ include \"hedera-mirror.dbHost\" . }}-init-job\n   namespace: {{ include \"hedera-mirror.namespace\" . }}\n   annotations:\n     \"helm.sh/hook\": post-install\n-    \"helm.sh/hook-delete-policy\": hook-succeeded\n spec:\n-  backoffLimit: 4\n+  backoffLimit: 1\n   template:\n     spec:\n       containers:\n         - name: init-mirrornode-db\n-          image: timescaledev/timescaledb-ha:pg12-ts2.0.0-rc3\n+          image: \"{{ .Values.timescaledb.image.repository }}:{{ .Values.timescaledb.image.tag }}\"\n           command:\n             - sh\n             - -c\n             - |\n               set -e\n \n               while ! pg_isready -U postgres -h {{ include \"hedera-mirror.dbHost\" . }}-data; do sleep 1; done;\n-              psql --echo-queries -d \"${ACCESS_SVC_CONNSTR_POSTGRES}\" --set ON_ERROR_STOP=1 -f ${DB_INIT_FILE}\n+              psql --echo-queries -d \"${ACCESS_SVC_CONNSTR_POSTGRES}\" --set ON_ERROR_STOP=1 -f ${DB_USERS_FILE}\n+              echo 'Completed db initialization and user creation for mirror node'\n+              sleep 5s\n+\n+              while ! pg_isready -U postgres -h {{ include \"hedera-mirror.dbHost\" . }}-data; do sleep 1; done;\n+              psql --echo-queries -d \"${ACCESS_SVC_CONNSTR_MIRRORNODE}\" --set ON_ERROR_STOP=1 -f ${DB_SCHEMA_FILE}\n+              echo 'Completed db schema initialization'\n+              sleep 5s\n+\n+              while ! pg_isready -U postgres -h {{ include \"hedera-mirror.dbHost\" . }}-data; do sleep 1; done;\n+              psql --echo-queries -d \"${ACCESS_SVC_CONNSTR_POSTGRES}\" --set ON_ERROR_STOP=1 -f ${DB_PATH_FILE}\n+              echo 'Completed db search path setting'\n+\n+              echo 'Completed db initialization for mirror node'\n           env:\n             - name: ACCESS_SVC_CONNSTR_POSTGRES\n               value: host={{ include \"hedera-mirror.dbHost\" . }} user=postgres connect_timeout=3 sslmode=disable password={{ .Values.timescaledb.credentials.accessNode.superuser }}\n-            - name: DB_INIT_FILE\n-              value: /usr/etc/db-init/init.sql\n+            - name: ACCESS_SVC_CONNSTR_MIRRORNODE\n+              value: host={{ include \"hedera-mirror.dbHost\" . }} dbname={{ .Values.importer.config.hedera.mirror.importer.db.name }} user={{ .Values.importer.config.hedera.mirror.importer.db.owner }} connect_timeout=3 sslmode=disable password={{ .Values.importer.config.hedera.mirror.importer.db.ownerPassword }}\n+            - name: DB_USERS_FILE\n+              value: /usr/etc/db-init/users_v2.sql\n+            - name: DB_SCHEMA_FILE\n+              value: /usr/etc/db-init/schema_v2.sql\n+            - name: DB_PATH_FILE\n+              value: /usr/etc/db-init/path_v2.sql\n           volumeMounts:\n-            - name: timescale-db-init-volume\n+            - name: timescaledb-init-volume\n               mountPath: /usr/etc/db-init\n       volumes:\n-        - name: timescale-db-init-volume\n-          secret:\n-            defaultMode: 420\n-            secretName: {{ include \"hedera-mirror.dbHost\" . }}-init\n-      restartPolicy: OnFailure\n-  ttlSecondsAfterFinished: 600\n-  {{- end -}}\n+        - name: timescaledb-init-volume\n+          projected:\n+            sources:\n+              - secret:\n+                  name: {{ include \"hedera-mirror.dbHost\" . }}-init\n+                  items:", "originalCommit": "2cebb0290c7aa90f89b8ede26c6550331fe2e284", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzYwNTU2MQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1364#discussion_r553605561", "bodyText": "Reverted to what I had before", "author": "Nana-EC", "createdAt": "2021-01-07T21:42:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzQ1MDg2Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzQ1MzQxOA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1364#discussion_r553453418", "bodyText": "These don't provide any value as env variables since they're only invoked once, they just make it more verbose. If anything, a initDir=/usr/etc/db-init variable inline in the script would help to keep it more DRY and readable.", "author": "steven-sheehy", "createdAt": "2021-01-07T16:54:47Z", "path": "charts/hedera-mirror/templates/job-timescaledb-init.yaml", "diffHunk": "@@ -2,41 +2,68 @@\n apiVersion: batch/v1\n kind: Job\n metadata:\n-  labels:\n-    {{- include \"hedera-mirror.labels\" . | nindent 4 }}\n+  labels: {{- include \"hedera-mirror.labels\" . | nindent 4 }}\n   name: {{ include \"hedera-mirror.dbHost\" . }}-init-job\n   namespace: {{ include \"hedera-mirror.namespace\" . }}\n   annotations:\n     \"helm.sh/hook\": post-install\n-    \"helm.sh/hook-delete-policy\": hook-succeeded\n spec:\n-  backoffLimit: 4\n+  backoffLimit: 1\n   template:\n     spec:\n       containers:\n         - name: init-mirrornode-db\n-          image: timescaledev/timescaledb-ha:pg12-ts2.0.0-rc3\n+          image: \"{{ .Values.timescaledb.image.repository }}:{{ .Values.timescaledb.image.tag }}\"\n           command:\n             - sh\n             - -c\n             - |\n               set -e\n \n               while ! pg_isready -U postgres -h {{ include \"hedera-mirror.dbHost\" . }}-data; do sleep 1; done;\n-              psql --echo-queries -d \"${ACCESS_SVC_CONNSTR_POSTGRES}\" --set ON_ERROR_STOP=1 -f ${DB_INIT_FILE}\n+              psql --echo-queries -d \"${ACCESS_SVC_CONNSTR_POSTGRES}\" --set ON_ERROR_STOP=1 -f ${DB_USERS_FILE}\n+              echo 'Completed db initialization and user creation for mirror node'\n+              sleep 5s\n+\n+              while ! pg_isready -U postgres -h {{ include \"hedera-mirror.dbHost\" . }}-data; do sleep 1; done;\n+              psql --echo-queries -d \"${ACCESS_SVC_CONNSTR_MIRRORNODE}\" --set ON_ERROR_STOP=1 -f ${DB_SCHEMA_FILE}\n+              echo 'Completed db schema initialization'\n+              sleep 5s\n+\n+              while ! pg_isready -U postgres -h {{ include \"hedera-mirror.dbHost\" . }}-data; do sleep 1; done;\n+              psql --echo-queries -d \"${ACCESS_SVC_CONNSTR_POSTGRES}\" --set ON_ERROR_STOP=1 -f ${DB_PATH_FILE}\n+              echo 'Completed db search path setting'\n+\n+              echo 'Completed db initialization for mirror node'\n           env:\n             - name: ACCESS_SVC_CONNSTR_POSTGRES\n               value: host={{ include \"hedera-mirror.dbHost\" . }} user=postgres connect_timeout=3 sslmode=disable password={{ .Values.timescaledb.credentials.accessNode.superuser }}\n-            - name: DB_INIT_FILE\n-              value: /usr/etc/db-init/init.sql\n+            - name: ACCESS_SVC_CONNSTR_MIRRORNODE\n+              value: host={{ include \"hedera-mirror.dbHost\" . }} dbname={{ .Values.importer.config.hedera.mirror.importer.db.name }} user={{ .Values.importer.config.hedera.mirror.importer.db.owner }} connect_timeout=3 sslmode=disable password={{ .Values.importer.config.hedera.mirror.importer.db.ownerPassword }}\n+            - name: DB_USERS_FILE", "originalCommit": "2cebb0290c7aa90f89b8ede26c6550331fe2e284", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzYwNTc3NQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1364#discussion_r553605775", "bodyText": "Added a DB_INIT_DIR variable and used inline as recommended", "author": "Nana-EC", "createdAt": "2021-01-07T21:43:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzQ1MzQxOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzQ1NTA5Ng==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1364#discussion_r553455096", "bodyText": "Why are we removing this? Don't we want to remove the job after success?", "author": "steven-sheehy", "createdAt": "2021-01-07T16:57:30Z", "path": "charts/hedera-mirror/templates/job-timescaledb-init.yaml", "diffHunk": "@@ -2,41 +2,68 @@\n apiVersion: batch/v1\n kind: Job\n metadata:\n-  labels:\n-    {{- include \"hedera-mirror.labels\" . | nindent 4 }}\n+  labels: {{- include \"hedera-mirror.labels\" . | nindent 4 }}\n   name: {{ include \"hedera-mirror.dbHost\" . }}-init-job\n   namespace: {{ include \"hedera-mirror.namespace\" . }}\n   annotations:\n     \"helm.sh/hook\": post-install\n-    \"helm.sh/hook-delete-policy\": hook-succeeded", "originalCommit": "2cebb0290c7aa90f89b8ede26c6550331fe2e284", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzQ1NjQzOQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1364#discussion_r553456439", "bodyText": "Was debugging and removed this so I could see the logs from the pod, will restore", "author": "Nana-EC", "createdAt": "2021-01-07T16:59:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzQ1NTA5Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzYzNjQ1Mw==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1364#discussion_r553636453", "bodyText": "I think it's a mistake that file_data.consensus_timestamp is not a primary key in v1 and v2. Can do in follow up if you like.", "author": "steven-sheehy", "createdAt": "2021-01-07T22:44:12Z", "path": "hedera-mirror-importer/src/main/resources/db/migration/v2/V2.0.2__time_scale_index_init.sql", "diffHunk": "@@ -40,31 +42,29 @@ create index if not exists crypto_transfer__entity_id_consensus_timestamp\n     where entity_id != 98;\n -- id corresponding to treasury address 0.0.98\n \n--- file_data\n-create index if not exists file_data__consensus\n-    on file_data (consensus_timestamp desc);\n+-- file_data, desc index on consensus_timestamp already created by hypertable", "originalCommit": "afc7f1fe8e465b2e66893af83a68fd31a08951a8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzY3NTE3Mg==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1364#discussion_r553675172", "bodyText": "Added this primary key", "author": "Nana-EC", "createdAt": "2021-01-08T00:44:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzYzNjQ1Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzYzNjUyNQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1364#discussion_r553636525", "bodyText": "I think it's a mistake that live_hash.consensus_timestamp is not a primary key in v1 and v2. Can do in follow up if you like.", "author": "steven-sheehy", "createdAt": "2021-01-07T22:44:25Z", "path": "hedera-mirror-importer/src/main/resources/db/migration/v2/V2.0.2__time_scale_index_init.sql", "diffHunk": "@@ -40,31 +42,29 @@ create index if not exists crypto_transfer__entity_id_consensus_timestamp\n     where entity_id != 98;\n -- id corresponding to treasury address 0.0.98\n \n--- file_data\n-create index if not exists file_data__consensus\n-    on file_data (consensus_timestamp desc);\n+-- file_data, desc index on consensus_timestamp already created by hypertable\n \n--- live_hash\n-create index if not exists livehashes__consensus\n-    on live_hash (consensus_timestamp desc);\n+-- live_hash, desc index on consensus_timestamp already created by hypertable", "originalCommit": "afc7f1fe8e465b2e66893af83a68fd31a08951a8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzY3NTE2OA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1364#discussion_r553675168", "bodyText": "Added this primary key", "author": "Nana-EC", "createdAt": "2021-01-08T00:44:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzYzNjUyNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzY0MjE1OQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1364#discussion_r553642159", "bodyText": "In Helm templates, these variables are not scoped to yaml blocks but to the current context. Thus, you can stay DRY and just define all these once at the top of the file.", "author": "steven-sheehy", "createdAt": "2021-01-07T22:58:49Z", "path": "charts/hedera-mirror/templates/secret-timescaledb.yaml", "diffHunk": "@@ -4,27 +4,87 @@ kind: Secret\n metadata:\n   labels:\n     {{- include \"hedera-mirror.labels\" . | nindent 4 }}\n-  name: {{ printf \"%s-timescaledb-init\" .Release.Name  }}\n+  name: {{ include \"hedera-mirror.dbHost\" . }}-init\n   namespace: {{ include \"hedera-mirror.namespace\" . }}\n type: Opaque\n stringData:\n-  init.sql: |-\n+  users_v2.sql: |-\n     {{- $dbName := .Values.importer.config.hedera.mirror.importer.db.name }}\n+    {{- $dbOwner := .Values.importer.config.hedera.mirror.importer.db.owner }}\n+    {{- $dbOwnerPassword := .Values.importer.config.hedera.mirror.importer.db.ownerPassword }}\n     {{- $importerUser := .Values.importer.config.hedera.mirror.importer.db.username }}\n     {{- $importerPassword := .Values.importer.config.hedera.mirror.importer.db.password }}\n     {{- $grpcUsername := .Values.grpc.config.hedera.mirror.grpc.db.username }}\n     {{- $grpcPassword := .Values.grpc.config.hedera.mirror.grpc.db.password }}\n     {{- $restUser := .Values.global.rest.username }}\n     {{- $restPassword := .Values.global.rest.password }}\n-    create database {{ $dbName }};\n+\n+    -- create owner user\n+    create user {{ $dbOwner }} with login password '{{ $dbOwnerPassword }}';\n+\n+    -- create primary user and db\n+    create database {{ $dbName }} with owner {{ $dbOwner }};\n+\n+    -- create roles\n+    create role readonly;\n+    create role readwrite in role readonly;\n+\n+    -- create users\n+    create user {{ $grpcUsername }} with login password '{{ $grpcPassword }}' in role readonly;\n+    create user {{ $restUser }} with login password '{{ $restPassword }}' in role readonly;\n+    create user {{ $importerUser }} with login password '{{ $importerPassword }}' in role readwrite;\n+\n+    -- drop timescaledb extension for future install to ensure availability in custom schema\n+    drop extension if exists timescaledb cascade;\n+  schema_v2.sql: |-\n+    {{- $dbName := .Values.importer.config.hedera.mirror.importer.db.name }}", "originalCommit": "afc7f1fe8e465b2e66893af83a68fd31a08951a8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzY3NTE2MQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1364#discussion_r553675161", "bodyText": "Good to know, moved them all up under the top file", "author": "Nana-EC", "createdAt": "2021-01-08T00:44:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzY0MjE1OQ=="}], "type": "inlineReview"}, {"oid": "f6c688b130313141fca2f4e727e192d7c825fd3e", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/f6c688b130313141fca2f4e727e192d7c825fd3e", "message": "Add psql to timescaledb migration scripts\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2021-01-08T16:09:30Z", "type": "commit"}, {"oid": "2a52fc729ef5b57ef02d2b3b8abd3cc49e453e4d", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/2a52fc729ef5b57ef02d2b3b8abd3cc49e453e4d", "message": "Improved comments on script\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2021-01-08T16:09:30Z", "type": "commit"}, {"oid": "1cdddc072c8e19ea4444b445903fa832a8135d39", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/1cdddc072c8e19ea4444b445903fa832a8135d39", "message": "Simplify logic and reuse flyway migration script\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2021-01-08T16:09:30Z", "type": "commit"}, {"oid": "858fe90556fc4ed7cc5a4095dfd64d0bfd81ecee", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/858fe90556fc4ed7cc5a4095dfd64d0bfd81ecee", "message": "Add documentation\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2021-01-08T16:09:31Z", "type": "commit"}, {"oid": "06e6003123ed11f338e1d28afb44a08e68cf48d7", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/06e6003123ed11f338e1d28afb44a08e68cf48d7", "message": "Updated for super and owner users\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2021-01-08T16:09:31Z", "type": "commit"}, {"oid": "3907bb503d645d07c69e180186557b345433bc00", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/3907bb503d645d07c69e180186557b345433bc00", "message": "CLeaned up docs\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2021-01-08T16:09:31Z", "type": "commit"}, {"oid": "b04b0d27963f58d03ad0cf44b3a59b7e5c1a3152", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/b04b0d27963f58d03ad0cf44b3a59b7e5c1a3152", "message": "Cleaned up docs\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2021-01-08T16:09:31Z", "type": "commit"}, {"oid": "73e5c562a7732910bbaeb436d473801fd05daf34", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/73e5c562a7732910bbaeb436d473801fd05daf34", "message": "Add logic to reuse V2.0.1__hyper_tables.sql\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2021-01-08T16:09:31Z", "type": "commit"}, {"oid": "bb0185b21f744fa3788043127024bc618ed04185", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/bb0185b21f744fa3788043127024bc618ed04185", "message": "Improved sed process\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2021-01-08T16:09:31Z", "type": "commit"}, {"oid": "b48698a5dc69158b3fa7bc50882808dfad2644ad", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/b48698a5dc69158b3fa7bc50882808dfad2644ad", "message": "Removed duplicate indexes and updated chart dependencies\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2021-01-08T16:09:31Z", "type": "commit"}, {"oid": "aacfb30059c4a46aa40c9c01a590c76f4708e11b", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/aacfb30059c4a46aa40c9c01a590c76f4708e11b", "message": "Utilize GA v2.0.0 of timescaledb\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2021-01-08T16:09:31Z", "type": "commit"}, {"oid": "a5d272367365f76eb3cf9b08f1c64cfd4bdb0d09", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/a5d272367365f76eb3cf9b08f1c64cfd4bdb0d09", "message": "Addressed feedback on indexes\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2021-01-08T16:09:31Z", "type": "commit"}, {"oid": "f1afacfc31d7a4a0405d021f049b1e8c78372b5a", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/f1afacfc31d7a4a0405d021f049b1e8c78372b5a", "message": "Fix helm repo and add templated reference for image tag\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2021-01-08T16:09:31Z", "type": "commit"}, {"oid": "c243aab7998f5cf1b77d33a4c0c160525f968f6c", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/c243aab7998f5cf1b77d33a4c0c160525f968f6c", "message": "Remove id column and add dbOwner support in v1\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2021-01-08T16:09:31Z", "type": "commit"}, {"oid": "5c3383dd5f4749b4650d3593b5e4a098fd8c2ce8", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/5c3383dd5f4749b4650d3593b5e4a098fd8c2ce8", "message": "Updated timescale db init job with new schema\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2021-01-08T16:09:31Z", "type": "commit"}, {"oid": "6ecd5311d4e7ca8623be4506fffe6873082f408b", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/6ecd5311d4e7ca8623be4506fffe6873082f408b", "message": "Addressed documentation feedback\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2021-01-08T16:09:31Z", "type": "commit"}, {"oid": "f47e5a9ccb5ae76688ee85aa9960d2a6ed7382de", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/f47e5a9ccb5ae76688ee85aa9960d2a6ed7382de", "message": "Remove sequence update of token_account from alterSchema.sql\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2021-01-08T16:09:31Z", "type": "commit"}, {"oid": "3ed4fe340136021236dce1181758b15107a66165", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/3ed4fe340136021236dce1181758b15107a66165", "message": "Addressed index feedback and update config docs\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2021-01-08T16:12:20Z", "type": "commit"}, {"oid": "48df1413edda3696b8b4934f3d58dee85827e1f3", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/48df1413edda3696b8b4934f3d58dee85827e1f3", "message": "Updated index name\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2021-01-08T16:12:20Z", "type": "commit"}, {"oid": "714fb97637f3a3a82f7cd4019f4662f31a453789", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/714fb97637f3a3a82f7cd4019f4662f31a453789", "message": "Streamlined variables in secret and added live_hash and file_data primary keys\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2021-01-08T16:12:20Z", "type": "commit"}, {"oid": "c0b32de90be8cf4f724abcb250ac386bf21cb534", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/c0b32de90be8cf4f724abcb250ac386bf21cb534", "message": "Add missing primary keys on live_hash and file_data in v1 schema\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2021-01-08T16:12:20Z", "type": "commit"}, {"oid": "2af65594d6539bcd3b37f09a7284fa2acee8aa55", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/2af65594d6539bcd3b37f09a7284fa2acee8aa55", "message": "Drop non-unique duplicate indexes\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2021-01-08T16:12:20Z", "type": "commit"}, {"oid": "2af65594d6539bcd3b37f09a7284fa2acee8aa55", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/2af65594d6539bcd3b37f09a7284fa2acee8aa55", "message": "Drop non-unique duplicate indexes\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2021-01-08T16:12:20Z", "type": "forcePushed"}]}