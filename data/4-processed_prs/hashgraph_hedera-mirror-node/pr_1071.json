{"pr_number": 1071, "pr_title": "Replace account_realm_num and account_num with  account_id in account_balance table", "pr_createdAt": "2020-09-21T23:01:08Z", "pr_url": "https://github.com/hashgraph/hedera-mirror-node/pull/1071", "timeline": [{"oid": "00f32ea13f5c32efb1443c01ccdbdef27d77c0fa", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/00f32ea13f5c32efb1443c01ccdbdef27d77c0fa", "message": "Replace account_reallm_num and account_num with  account_id in account_balance table\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2020-09-21T22:52:52Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQyMjc2OQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1071#discussion_r492422769", "bodyText": "Serializationversionid should  probably be updated.", "author": "steven-sheehy", "createdAt": "2020-09-22T00:49:32Z", "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/domain/AccountBalance.java", "diffHunk": "@@ -57,8 +62,8 @@ public boolean isNew() {\n \n         private long consensusTimestamp;\n \n-        private int accountNum;\n-\n-        private int accountRealmNum;\n+        @Convert(converter = AccountIdConverter.class)", "originalCommit": "00f32ea13f5c32efb1443c01ccdbdef27d77c0fa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjkyNzkxOA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1071#discussion_r492927918", "bodyText": "Updated", "author": "Nana-EC", "createdAt": "2020-09-22T17:56:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQyMjc2OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQyMzU2NQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1071#discussion_r492423565", "bodyText": "Would prefer constraints start with table name like the below index does", "author": "steven-sheehy", "createdAt": "2020-09-22T00:52:47Z", "path": "hedera-mirror-importer/src/main/resources/db/migration/V1.30.0__balance_entity_id.sql", "diffHunk": "@@ -0,0 +1,29 @@\n+-------------------\n+-- Update account_balance to use single entity_id column instead of account_realm_num and account_num\n+-------------------\n+\n+-- Drop pk and index that used account_realm_num and account_num. Drop first to make migration quicker\n+alter table account_balance drop constraint pk__account_balances;\n+drop index if exists idx__account_balances__account_then_timestamp;\n+\n+--  Add account_id entity_id column and set based on existing account_realm_num and account_num\n+alter table if exists account_balance\n+    add column account_id entity_id null;\n+\n+update account_balance\n+    set account_id = encodeEntityId(0, account_realm_num, account_num);\n+\n+alter table if exists account_balance\n+    alter column account_id set not null;\n+\n+-- Drop account_realm_num and account_num\n+alter table if exists account_balance\n+    drop column if exists account_realm_num,\n+    drop column if exists account_num;\n+\n+-- Add new pk and index using account_id\n+alter table account_balance\n+    add constraint pk__account_balance primary key (consensus_timestamp, account_id);", "originalCommit": "00f32ea13f5c32efb1443c01ccdbdef27d77c0fa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjkyNzc2MQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1071#discussion_r492927761", "bodyText": "Updated to account_balance__pk", "author": "Nana-EC", "createdAt": "2020-09-22T17:55:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQyMzU2NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mjc2OTY2OQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1071#discussion_r492769669", "bodyText": "The response json didn't change, acc doesn't have an id field so this check is always false, should revert the changes", "author": "xin-hedera", "createdAt": "2020-09-22T14:15:10Z", "path": "hedera-mirror-rest/__tests__/accounts.test.js", "diffHunk": "@@ -51,9 +51,8 @@ const validateAccNumRange = function (accounts, low, high) {\n   let ret = true;\n   let offender = null;\n   for (const acc of accounts.accounts) {\n-    const accNum = acc.account.split('.')[2];\n-    if (accNum < low || accNum > high) {\n-      offender = accNum;\n+    if (acc.id < low || acc.id > high) {\n+      offender = acc.id;", "originalCommit": "00f32ea13f5c32efb1443c01ccdbdef27d77c0fa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjkyNzY5NA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1071#discussion_r492927694", "bodyText": "Reverted", "author": "Nana-EC", "createdAt": "2020-09-22T17:55:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mjc2OTY2OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mjc3ODUzNA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1071#discussion_r492778534", "bodyText": "nit: extra space before e.id", "author": "xin-hedera", "createdAt": "2020-09-22T14:26:13Z", "path": "hedera-mirror-rest/accounts.js", "diffHunk": "@@ -49,18 +49,14 @@ const processRow = function (row) {\n const getAccountQueryPrefix = function () {\n   return `select ab.balance as account_balance,\n        ab.consensus_timestamp as consensus_timestamp,\n-       ${config.shard} as entity_shard,\n-       coalesce(ab.account_realm_num, e.entity_realm) as entity_realm,\n-       coalesce(ab.account_num, e.entity_num) as entity_num,\n+       coalesce(ab.account_id, e.id) as entity_id,\n        e.exp_time_ns,\n        e.auto_renew_period,\n        e.key,\n        e.deleted\n     from account_balance ab\n     full outer join t_entities e on (\n-        ${config.shard} = e.entity_shard\n-        and ab.account_realm_num = e.entity_realm\n-        and ab.account_num =  e.entity_num\n+        ab.account_id =  e.id", "originalCommit": "00f32ea13f5c32efb1443c01ccdbdef27d77c0fa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjkyNzU2NQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1071#discussion_r492927565", "bodyText": "Removed", "author": "Nana-EC", "createdAt": "2020-09-22T17:55:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mjc3ODUzNA=="}], "type": "inlineReview"}, {"oid": "1708aafde80a489f8f08da767440d62bd6aae67d", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/1708aafde80a489f8f08da767440d62bd6aae67d", "message": "Addressed feedback\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2020-09-22T17:51:45Z", "type": "commit"}]}