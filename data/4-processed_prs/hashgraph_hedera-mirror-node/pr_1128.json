{"pr_number": 1128, "pr_title": "Rosetta: Cache operation types & statuses", "pr_createdAt": "2020-10-14T07:27:41Z", "pr_url": "https://github.com/hashgraph/hedera-mirror-node/pull/1128", "timeline": [{"oid": "25b4c6c24cfd3e045ce3189c74b9777e7b1de95c", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/25b4c6c24cfd3e045ce3189c74b9777e7b1de95c", "message": "feat(hedera-mirror-rosetta): cache operation types & statuses\n\nSigned-off-by: failfmi <oscurocalma@gmail.com>", "committedDate": "2020-10-14T07:08:16Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDc5OTI5NA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1128#discussion_r504799294", "bodyText": "map isn't thread safe. This should probably have some double checked locking pattern to ensure the map doesn't get corrupted if multiple threads write to it during initialization.", "author": "steven-sheehy", "createdAt": "2020-10-14T16:06:36Z", "path": "hedera-mirror-rosetta/app/persistence/transaction/transaction.go", "diffHunk": "@@ -98,29 +100,49 @@ func NewTransactionRepository(dbClient *gorm.DB) *TransactionRepository {\n }\n \n // Types returns map of all Transaction Types\n-// TODO implement cache instead of retrieving this everytime form DB\n-func (tr *TransactionRepository) Types() map[int]string {\n+func (tr *TransactionRepository) Types() (map[int]string, *rTypes.Error) {\n+\tif tr.types != nil {\n+\t\treturn tr.types, nil\n+\t}\n+\n \ttypesArray := tr.retrieveTransactionTypes()\n-\ttMap := make(map[int]string)\n+\tif len(typesArray) == 0 {\n+\t\tlog.Println(\"No Transaction Types were found in the database.\")\n+\t\treturn nil, errors.Errors[errors.OperationTypesNotFound]\n+\t}\n+\n+\ttr.types = make(map[int]string)", "originalCommit": "25b4c6c24cfd3e045ce3189c74b9777e7b1de95c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDgwMDIxMA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1128#discussion_r504800210", "bodyText": "Same comment about thread safety", "author": "steven-sheehy", "createdAt": "2020-10-14T16:07:54Z", "path": "hedera-mirror-rosetta/app/persistence/transaction/transaction.go", "diffHunk": "@@ -98,29 +100,49 @@ func NewTransactionRepository(dbClient *gorm.DB) *TransactionRepository {\n }\n \n // Types returns map of all Transaction Types\n-// TODO implement cache instead of retrieving this everytime form DB\n-func (tr *TransactionRepository) Types() map[int]string {\n+func (tr *TransactionRepository) Types() (map[int]string, *rTypes.Error) {\n+\tif tr.types != nil {\n+\t\treturn tr.types, nil\n+\t}\n+\n \ttypesArray := tr.retrieveTransactionTypes()\n-\ttMap := make(map[int]string)\n+\tif len(typesArray) == 0 {\n+\t\tlog.Println(\"No Transaction Types were found in the database.\")\n+\t\treturn nil, errors.Errors[errors.OperationTypesNotFound]\n+\t}\n+\n+\ttr.types = make(map[int]string)\n \tfor _, t := range typesArray {\n-\t\ttMap[t.ProtoID] = t.Name\n+\t\ttr.types[t.ProtoID] = t.Name\n \t}\n-\treturn tMap\n+\treturn tr.types, nil\n }\n \n // Statuses returns map of all Transaction Results\n-// TODO implement cache instead of retrieving this everytime form DB\n-func (tr *TransactionRepository) Statuses() map[int]string {\n+func (tr *TransactionRepository) Statuses() (map[int]string, *rTypes.Error) {\n+\tif tr.statuses != nil {\n+\t\treturn tr.statuses, nil\n+\t}\n+\n \trArray := tr.retrieveTransactionResults()\n-\trMap := make(map[int]string)\n+\tif len(rArray) == 0 {\n+\t\tlog.Println(\"No Transaction Results were found in the database.\")\n+\t\treturn nil, errors.Errors[errors.OperationStatusesNotFound]\n+\t}\n+\n+\ttr.statuses = make(map[int]string)\n \tfor _, s := range rArray {\n-\t\trMap[s.ProtoID] = s.Result\n+\t\ttr.statuses[s.ProtoID] = s.Result", "originalCommit": "25b4c6c24cfd3e045ce3189c74b9777e7b1de95c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "c57506f49a7df67d24e1679c08b0136f6e846f08", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/c57506f49a7df67d24e1679c08b0136f6e846f08", "message": "fix(hedera-mirror-rosetta): map -> sync.Map\n\nSigned-off-by: failfmi <oscurocalma@gmail.com>", "committedDate": "2020-10-14T17:58:11Z", "type": "commit"}, {"oid": "88c5e4ea67b1a0cf62ac97cee3ba540d950c06ac", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/88c5e4ea67b1a0cf62ac97cee3ba540d950c06ac", "message": "fix(hedera-mirror-rosetta): initialize once, update if fetched\n\nSigned-off-by: failfmi <oscurocalma@gmail.com>", "committedDate": "2020-10-14T18:25:38Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDkzNTYxNw==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1128#discussion_r504935617", "bodyText": "suggestion: it's better to use sync.Once to guarantee statues /  types is only retrieved once when the first time it's needed, then can just return a normal map since it's all read operations", "author": "xin-hedera", "createdAt": "2020-10-14T19:56:04Z", "path": "hedera-mirror-rosetta/app/persistence/transaction/transaction.go", "diffHunk": "@@ -98,29 +103,51 @@ func NewTransactionRepository(dbClient *gorm.DB) *TransactionRepository {\n }\n \n // Types returns map of all Transaction Types\n-// TODO implement cache instead of retrieving this everytime form DB\n-func (tr *TransactionRepository) Types() map[int]string {\n+func (tr *TransactionRepository) Types() (*sync.Map, *rTypes.Error) {", "originalCommit": "88c5e4ea67b1a0cf62ac97cee3ba540d950c06ac", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "d6a0b29395d3778de439b3e57e2368ad04af985e", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/d6a0b29395d3778de439b3e57e2368ad04af985e", "message": "fix(hedera-mirror-rosetta): sync.Map -> sync.Once with regular map\n\nSigned-off-by: failfmi <oscurocalma@gmail.com>", "committedDate": "2020-10-15T06:53:22Z", "type": "commit"}, {"oid": "270b4d13d18f84d2911b023132848619fd5fde96", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/270b4d13d18f84d2911b023132848619fd5fde96", "message": "refactor(hedera-mirror-rosetta): fetch -> retrieve\n\nSigned-off-by: failfmi <oscurocalma@gmail.com>", "committedDate": "2020-10-15T07:30:47Z", "type": "commit"}, {"oid": "6896fecbd09753ac9aa6d1c5d6abc4b5a76eba37", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/6896fecbd09753ac9aa6d1c5d6abc4b5a76eba37", "message": "fix(hedera-mirror-rosetta): wrong function call\n\nSigned-off-by: failfmi <oscurocalma@gmail.com>", "committedDate": "2020-10-15T07:39:48Z", "type": "commit"}, {"oid": "1a2bcf34e8754efd6718b1b50469171fb0db3a1f", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/1a2bcf34e8754efd6718b1b50469171fb0db3a1f", "message": "fix(hedera-mirror-rosetta): panic message\n\nSigned-off-by: failfmi <oscurocalma@gmail.com>", "committedDate": "2020-10-15T07:42:50Z", "type": "commit"}, {"oid": "695813ed88dba53449063bc723e046af2df48ee8", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/695813ed88dba53449063bc723e046af2df48ee8", "message": "fix(hedera-mirror-rosetta): do only map init\n\nSigned-off-by: failfmi <oscurocalma@gmail.com>", "committedDate": "2020-10-15T08:06:41Z", "type": "commit"}]}