{"pr_number": 1356, "pr_title": "Lazy load transaction types for REST", "pr_createdAt": "2020-12-14T06:55:59Z", "pr_url": "https://github.com/hashgraph/hedera-mirror-node/pull/1356", "timeline": [{"oid": "12305b292d3dfc712971ef32e110599ee8c2bfc1", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/12305b292d3dfc712971ef32e110599ee8c2bfc1", "message": "Lazy load transaction types for REST\n\nSigned-off-by: Ian Jungmann <ian.jungmann@hedera.com>", "committedDate": "2020-12-14T06:53:53Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjE1MTU1OQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1356#discussion_r542151559", "bodyText": "Move this back down.", "author": "ijungmann", "createdAt": "2020-12-14T06:57:20Z", "path": "hedera-mirror-rest/utils.js", "diffHunk": "@@ -746,9 +747,9 @@ const getTransactionTypeQuery = (parsedQueryParams) => {\n   }\n \n   if (isValidTransactionType(transactionType)) {\n-    return `${constants.transactionColumns.TYPE}${opsMap.eq}${\n-      constants.transactionTypes[transactionType.toUpperCase()]\n-    }`;\n+    return `${constants.transactionColumns.TYPE}${opsMap.eq}${constants.transactionTypes.get(\n+      transactionType.toUpperCase()", "originalCommit": "12305b292d3dfc712971ef32e110599ee8c2bfc1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjE1MTgwMQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1356#discussion_r542151801", "bodyText": "Remove this, was for other PR/task", "author": "ijungmann", "createdAt": "2020-12-14T06:57:52Z", "path": "hedera-mirror-rest/transactions.js", "diffHunk": "@@ -304,9 +304,9 @@ const getOneTransaction = async (req, res) => {\n     FROM transaction t\n     JOIN t_transaction_results ttr ON ttr.proto_id = t.result\n     JOIN t_transaction_types ttt ON ttt.proto_id = t.type\n-    JOIN crypto_transfer ctl ON  ctl.consensus_timestamp = t.consensus_ns\n+    LEFT JOIN crypto_transfer ctl ON  ctl.consensus_timestamp = t.consensus_ns", "originalCommit": "12305b292d3dfc712971ef32e110599ee8c2bfc1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "ac2d065c3c840a796fec46b463504f613ea680c0", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/ac2d065c3c840a796fec46b463504f613ea680c0", "message": "Code cleanup\n\nSigned-off-by: Ian Jungmann <ian.jungmann@hedera.com>", "committedDate": "2020-12-14T17:53:07Z", "type": "commit"}, {"oid": "e6d57e4340ca51ec1dff68914c34a06f9738a1a2", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/e6d57e4340ca51ec1dff68914c34a06f9738a1a2", "message": "Code cleanup\n\nSigned-off-by: Ian Jungmann <ian.jungmann@hedera.com>", "committedDate": "2020-12-14T18:00:58Z", "type": "commit"}, {"oid": "fbbcb153d5b4d0f30b4a3bab2199cbbdbade33e7", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/fbbcb153d5b4d0f30b4a3bab2199cbbdbade33e7", "message": "Move transactionTypes loading to separate file\n\nSigned-off-by: Ian Jungmann <ian.jungmann@hedera.com>", "committedDate": "2020-12-14T18:51:42Z", "type": "commit"}, {"oid": "57cd3e54cbe214fc9f15891a6292e96ba7be2fe1", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/57cd3e54cbe214fc9f15891a6292e96ba7be2fe1", "message": "Move transactionTypes loading to separate file\n\nSigned-off-by: Ian Jungmann <ian.jungmann@hedera.com>", "committedDate": "2020-12-14T18:57:04Z", "type": "commit"}, {"oid": "797daad33bd542cf2bb59ff0b1f458ea562eb080", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/797daad33bd542cf2bb59ff0b1f458ea562eb080", "message": "Fix tests to work with needed DB\n\nSigned-off-by: Ian Jungmann <ian.jungmann@hedera.com>", "committedDate": "2020-12-14T21:22:25Z", "type": "commit"}, {"oid": "6345bce338116c11a89cc5b22518ef61512957b6", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/6345bce338116c11a89cc5b22518ef61512957b6", "message": "Refactoring\n\nSigned-off-by: Ian Jungmann <ian.jungmann@hedera.com>", "committedDate": "2020-12-14T21:57:33Z", "type": "commit"}, {"oid": "a9fb75f53fa3eac0c94f40003e50d301332b8686", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/a9fb75f53fa3eac0c94f40003e50d301332b8686", "message": "Refactoring\n\nSigned-off-by: Ian Jungmann <ian.jungmann@hedera.com>", "committedDate": "2020-12-14T22:00:23Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mjg0NjU4NQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1356#discussion_r542846585", "bodyText": "Not 100% on this name, I originally just had it as transactionTypes, but having transactionsTypes.transactionTypes.get() seemed hard to read.", "author": "ijungmann", "createdAt": "2020-12-14T22:02:25Z", "path": "hedera-mirror-rest/transactionTypes.js", "diffHunk": "@@ -0,0 +1,41 @@\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+\n+'use strict';\n+\n+const transactionTypesMap = new Map();", "originalCommit": "a9fb75f53fa3eac0c94f40003e50d301332b8686", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzU1OTY3Nw==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1356#discussion_r543559677", "bodyText": "transactionTypesMap works for me. Or transactionTypeProtoIdMap if you want to be explicit.", "author": "Nana-EC", "createdAt": "2020-12-15T17:52:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mjg0NjU4NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mzc0MTc1OA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1356#discussion_r543741758", "bodyText": "My other recommendation transactionsTypes.get() would solve this conundrum.", "author": "steven-sheehy", "createdAt": "2020-12-15T22:44:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mjg0NjU4NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzgxMzYwNw==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1356#discussion_r543813607", "bodyText": "Keeping as transactionTypesMap, reworked to not expose.", "author": "ijungmann", "createdAt": "2020-12-16T01:39:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mjg0NjU4NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mjg0NzY3OA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1356#discussion_r542847678", "bodyText": "If there's a particular order these need to be in I will shuffle.  Goes for all of the imports after as well.", "author": "ijungmann", "createdAt": "2020-12-14T22:03:29Z", "path": "hedera-mirror-rest/__tests__/integration.test.js", "diffHunk": "@@ -51,15 +51,20 @@ const transactions = require('../transactions.js');\n const server = require('../server');\n const integrationDbOps = require('./integrationDbOps.js');\n const integrationDomainOps = require('./integrationDomainOps.js');\n+const utils = require('../utils');\n const {S3Ops} = require('./integrationS3Ops');\n const config = require('../config');\n const {cloudProviders} = require('../constants');\n+const transactionTypes = require('../transactionTypes');\n+const {InvalidArgumentError} = require('../errors/invalidArgumentError');\n+const constants = require('../constants');", "originalCommit": "a9fb75f53fa3eac0c94f40003e50d301332b8686", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzU1NzQxOA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1356#discussion_r543557418", "bodyText": "nit: I like to put external libraries first and then local files after.\nAlso amongst local files I try to go alphabetically at each depth  in terms of directories.\nI don't mind the the order of directory depth so far as they are grouped.\nFor instance if I was rearranging I might do the below\n// external libraries\nconst S3 = require('aws-sdk/clients/s3');\nconst crypto = require('crypto');\nconst fs = require('fs');\nconst _ = require('lodash');\nconst path = require('path');\nconst request = require('supertest');\n\nconst integrationDbOps = require('./integrationDbOps.js');\nconst integrationDomainOps = require('./integrationDomainOps.js');\nconst config = require('../config');\nconst {cloudProviders} = require('../constants');\nconst EntityId = require('../entityId');\nconst {InvalidArgumentError} = require('../errors/invalidArgumentError');\nconst {S3Ops} = require('./integrationS3Ops');\nconst server = require('../server');\nconst transactions = require('../transactions.js');\nconst transactionTypes = require('../transactionTypes');\nconst utils = require('../utils');\nAll of these are nit suggestions since you asked.", "author": "Nana-EC", "createdAt": "2020-12-15T17:49:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mjg0NzY3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDc2MTE3NQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1356#discussion_r544761175", "bodyText": "I'm assuming const {InvalidArgumentError} = require('../errors/invalidArgumentError'); should be third in that second list because of its directory depth, correct?  Otherwise I follow and will do.", "author": "ijungmann", "createdAt": "2020-12-17T02:19:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mjg0NzY3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDc2MTk2MQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1356#discussion_r544761961", "bodyText": "Reordered.", "author": "ijungmann", "createdAt": "2020-12-17T02:21:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mjg0NzY3OA=="}], "type": "inlineReview"}, {"oid": "e54e4f7f82385fee4497ee521e97ce78ed0d7f78", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/e54e4f7f82385fee4497ee521e97ce78ed0d7f78", "message": "Refactor\n\nSigned-off-by: Ian Jungmann <ian.jungmann@hedera.com>", "committedDate": "2020-12-14T22:06:09Z", "type": "commit"}, {"oid": "c302319b9bfd15553c1eacb71eae80857188f1d3", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/c302319b9bfd15553c1eacb71eae80857188f1d3", "message": "Fix license issue\n\nSigned-off-by: Ian Jungmann <ian.jungmann@hedera.com>", "committedDate": "2020-12-14T22:20:17Z", "type": "commit"}, {"oid": "cf0d648583996b9491364d188e59c05e4c163a18", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/cf0d648583996b9491364d188e59c05e4c163a18", "message": "Add a comment\n\nSigned-off-by: Ian Jungmann <ian.jungmann@hedera.com>", "committedDate": "2020-12-14T22:25:44Z", "type": "commit"}, {"oid": "4cae40be24f0ca0fbee1e0e44c9b8ff44ecd6acf", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/4cae40be24f0ca0fbee1e0e44c9b8ff44ecd6acf", "message": "Merge branch 'master' into rest_lazy_load_transaction_types", "committedDate": "2020-12-15T01:18:56Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzU2MTMyMw==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1356#discussion_r543561323", "bodyText": "Can you add a trace log here, similar to the other requests\n  if (logger.isTraceEnabled()) {\n    logger.trace(`getTransactionTypes query: ${transactionTypesQuery}`);\n  }", "author": "Nana-EC", "createdAt": "2020-12-15T17:55:11Z", "path": "hedera-mirror-rest/transactionTypes.js", "diffHunk": "@@ -0,0 +1,42 @@\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node REST API\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+'use strict';\n+\n+const transactionTypesQuery = 'SELECT proto_id, name FROM t_transaction_types';\n+\n+const transactionTypesMap = new Map();\n+\n+const loadTransactionTypes = function () {\n+  pool", "originalCommit": "4cae40be24f0ca0fbee1e0e44c9b8ff44ecd6acf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDc2NDI3MQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1356#discussion_r544764271", "bodyText": "Added", "author": "ijungmann", "createdAt": "2020-12-17T02:27:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzU2MTMyMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzU2Mzc1Mw==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1356#discussion_r543563753", "bodyText": "nit: add a comment highlighting that the map is transaction type (String) -> ProtoId (Integer)", "author": "Nana-EC", "createdAt": "2020-12-15T17:58:25Z", "path": "hedera-mirror-rest/transactionTypes.js", "diffHunk": "@@ -0,0 +1,42 @@\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node REST API\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+'use strict';\n+\n+const transactionTypesQuery = 'SELECT proto_id, name FROM t_transaction_types';\n+\n+const transactionTypesMap = new Map();", "originalCommit": "4cae40be24f0ca0fbee1e0e44c9b8ff44ecd6acf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDc1NDg3NA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1356#discussion_r544754874", "bodyText": "Comment added", "author": "ijungmann", "createdAt": "2020-12-17T02:00:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzU2Mzc1Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzU2NTA3Mw==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1356#discussion_r543565073", "bodyText": "I forget if there's a way to overload the get() function.\nIf there is or instead of a get expose a separate function that will do the toUpperCase conversion and then call transactionTypesMap.get() that would help.", "author": "Nana-EC", "createdAt": "2020-12-15T18:00:15Z", "path": "hedera-mirror-rest/utils.js", "diffHunk": "@@ -95,7 +96,7 @@ const isValidEncoding = (query) => {\n };\n \n const isValidTransactionType = (transactionType) => {\n-  return _.isString(transactionType) && constants.transactionTypes[transactionType.toUpperCase()] !== undefined;\n+  return _.isString(transactionType) && transactionTypesMap.get(transactionType.toUpperCase()) !== undefined;", "originalCommit": "4cae40be24f0ca0fbee1e0e44c9b8ff44ecd6acf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDc2NDQ3Mw==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1356#discussion_r544764473", "bodyText": "Added toUpperCase inside of the new get() method in transactionTypeName", "author": "ijungmann", "createdAt": "2020-12-17T02:28:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzU2NTA3Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzczNjA0Nw==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1356#discussion_r543736047", "bodyText": "We've standardized on lowercase SQl statements.", "author": "steven-sheehy", "createdAt": "2020-12-15T22:33:37Z", "path": "hedera-mirror-rest/transactionTypes.js", "diffHunk": "@@ -0,0 +1,42 @@\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node REST API\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+'use strict';\n+\n+const transactionTypesQuery = 'SELECT proto_id, name FROM t_transaction_types';", "originalCommit": "4cae40be24f0ca0fbee1e0e44c9b8ff44ecd6acf", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzczNzIwNA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1356#discussion_r543737204", "bodyText": "Use new style function syntax.", "author": "steven-sheehy", "createdAt": "2020-12-15T22:35:53Z", "path": "hedera-mirror-rest/transactionTypes.js", "diffHunk": "@@ -0,0 +1,42 @@\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node REST API\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+'use strict';\n+\n+const transactionTypesQuery = 'SELECT proto_id, name FROM t_transaction_types';\n+\n+const transactionTypesMap = new Map();\n+\n+const loadTransactionTypes = function () {", "originalCommit": "4cae40be24f0ca0fbee1e0e44c9b8ff44ecd6acf", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzczODg4Mw==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1356#discussion_r543738883", "bodyText": "Would be less coupled and not slow down startup to lazy load this on-demand. See my note about replacing explicit load with implicit load via get().", "author": "steven-sheehy", "createdAt": "2020-12-15T22:39:13Z", "path": "hedera-mirror-rest/server.js", "diffHunk": "@@ -104,6 +105,9 @@ app.set('query parser', requestQueryParser);\n \n serveSwaggerDocs(app);\n \n+// load transaction types from DB\n+loadTransactionTypes();", "originalCommit": "4cae40be24f0ca0fbee1e0e44c9b8ff44ecd6acf", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mzc0MTQ4NA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1356#discussion_r543741484", "bodyText": "We shouldn't expose a mutable map since people can potentially modify this. Recommend a single method be exposed get(string) that lazy loads the internal map.", "author": "steven-sheehy", "createdAt": "2020-12-15T22:44:26Z", "path": "hedera-mirror-rest/transactionTypes.js", "diffHunk": "@@ -0,0 +1,42 @@\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node REST API\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+'use strict';\n+\n+const transactionTypesQuery = 'SELECT proto_id, name FROM t_transaction_types';\n+\n+const transactionTypesMap = new Map();\n+\n+const loadTransactionTypes = function () {\n+  pool\n+    .query(transactionTypesQuery)\n+    .catch((err) => {\n+      throw new DbError(err.message);\n+    })\n+    .then((results) => {\n+      for (const row of results.rows) {\n+        transactionTypesMap.set(row.name, row.proto_id);\n+      }\n+    });\n+};\n+\n+module.exports = {\n+  transactionTypesMap,", "originalCommit": "4cae40be24f0ca0fbee1e0e44c9b8ff44ecd6acf", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mzc1MTIxMA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1356#discussion_r543751210", "bodyText": "this is async, though the function is called at process startup, there is no guarantee that when the map is looked up for a transaction type, the data is fully populated.", "author": "xin-hedera", "createdAt": "2020-12-15T23:03:46Z", "path": "hedera-mirror-rest/transactionTypes.js", "diffHunk": "@@ -0,0 +1,42 @@\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node REST API\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+'use strict';\n+\n+const transactionTypesQuery = 'SELECT proto_id, name FROM t_transaction_types';\n+\n+const transactionTypesMap = new Map();\n+\n+const loadTransactionTypes = function () {\n+  pool\n+    .query(transactionTypesQuery)\n+    .catch((err) => {\n+      throw new DbError(err.message);\n+    })\n+    .then((results) => {\n+      for (const row of results.rows) {\n+        transactionTypesMap.set(row.name, row.proto_id);\n+      }", "originalCommit": "4cae40be24f0ca0fbee1e0e44c9b8ff44ecd6acf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDc2NDc1OA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1356#discussion_r544764758", "bodyText": "Should be fixed now.", "author": "ijungmann", "createdAt": "2020-12-17T02:29:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mzc1MTIxMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mzc1MzM4OQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1356#discussion_r543753389", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              return _.isString(transactionType) && transactionTypesMap.get(transactionType.toUpperCase()) !== undefined;\n          \n          \n            \n              return _.isString(transactionType) && transactionTypesMap.has(transactionType.toUpperCase());", "author": "xin-hedera", "createdAt": "2020-12-15T23:08:28Z", "path": "hedera-mirror-rest/utils.js", "diffHunk": "@@ -95,7 +96,7 @@ const isValidEncoding = (query) => {\n };\n \n const isValidTransactionType = (transactionType) => {\n-  return _.isString(transactionType) && constants.transactionTypes[transactionType.toUpperCase()] !== undefined;\n+  return _.isString(transactionType) && transactionTypesMap.get(transactionType.toUpperCase()) !== undefined;", "originalCommit": "4cae40be24f0ca0fbee1e0e44c9b8ff44ecd6acf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDc2NTI5NA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1356#discussion_r544765294", "bodyText": "Good idea, but this was refactored to take advantage of the new get() logic inside TransactionTypes", "author": "ijungmann", "createdAt": "2020-12-17T02:30:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mzc1MzM4OQ=="}], "type": "inlineReview"}, {"oid": "1ea9a37a63249e65d7b1f5a6be0ee38e324196b0", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/1ea9a37a63249e65d7b1f5a6be0ee38e324196b0", "message": "Rework transactionTypes to not expose map\n\nSigned-off-by: Ian Jungmann <ian.jungmann@hedera.com>", "committedDate": "2020-12-16T01:36:10Z", "type": "commit"}, {"oid": "34d74c86bd23bb7e640a2674a47a34305a3cd546", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/34d74c86bd23bb7e640a2674a47a34305a3cd546", "message": "Change transactions.js to use new transactionTypes format\n\nSigned-off-by: Ian Jungmann <ian.jungmann@hedera.com>", "committedDate": "2020-12-16T01:37:04Z", "type": "commit"}, {"oid": "448e74635b3b1f8a80f9e490afa012cfff9b605e", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/448e74635b3b1f8a80f9e490afa012cfff9b605e", "message": "Rework utils\n\nSigned-off-by: Ian Jungmann <ian.jungmann@hedera.com>", "committedDate": "2020-12-16T01:38:18Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mzg1NDg2MA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1356#discussion_r543854860", "bodyText": "this will not work as intended:\n\nloadTransactionTypes immediately returns and nodejs engine won't pause and switch to other tasks, so transactionTypesMap.size is still 0 at line 30\nit's possible when db query is slow, multiple calls to get will all see transactionTypesMap.size === 0, this will cause multiple db queries for the transaction types\n\nwe should use a promise to hold the db query\nlet promise;\n\nconst get = async (transactionTypeName) => {\n  if (!promise) {\n    promise = pool.query(transactionTypesQuery);\n  }\n\n  try {\n    const result = await promise;\n    if (transactionTypesMap.size === 0) {\n      result.rows.forEach((row) => transactionTypesMap.set(row.name, row.proto_id));\n    }\n\n    return transactionTypesMap.get(transactionTypeName.toUpperCase());\n  } catch (err) {\n    // error handling\n  }\n}", "author": "xin-hedera", "createdAt": "2020-12-16T02:47:38Z", "path": "hedera-mirror-rest/transactionTypes.js", "diffHunk": "@@ -0,0 +1,51 @@\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node REST API\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+'use strict';\n+\n+const transactionTypesQuery = 'select proto_id, name from t_transaction_types';\n+\n+const transactionTypesMap = new Map();\n+\n+const get = async (transactionTypeName) => {\n+  if (transactionTypesMap.size === 0) {\n+    loadTransactionTypes();\n+  }\n+  return transactionTypesMap.get(transactionTypeName.toUpperCase());\n+};", "originalCommit": "448e74635b3b1f8a80f9e490afa012cfff9b605e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mzg2MzUwNw==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1356#discussion_r543863507", "bodyText": "Yeah, I half-did this and saw that tests are failing and have been playing with ways to correct it.  I'll give this a go, I was playing with promises myself and was getting something working but it involved an explosion of async/await across many files.", "author": "ijungmann", "createdAt": "2020-12-16T02:58:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mzg1NDg2MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mzg3Mzc4MQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1356#discussion_r543873781", "bodyText": "So this is definitely working but I'm seeing the same issue where this leads to a ton of needed async/await statements.  Is there a cleaner way to handle this (I'm still getting the hang of the async/await concepts), or short of a large refactor is that the only way to solve this?", "author": "ijungmann", "createdAt": "2020-12-16T03:11:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mzg1NDg2MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mzg3ODMxNg==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1356#discussion_r543878316", "bodyText": "the alternative for not using async/await in places where get() is called is promise chain and that may look worse. personally I prefer async / await, the code is easier to read.", "author": "xin-hedera", "createdAt": "2020-12-16T03:18:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mzg1NDg2MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDQ0MjI4MA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1356#discussion_r544442280", "bodyText": "I don't think get itself needs to be async as once it's loaded once it's from then on synchronous. So it should hide the asynchronicity from the caller by awaiting internally only if needed if map is empty.", "author": "steven-sheehy", "createdAt": "2020-12-16T16:30:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mzg1NDg2MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDQ1NTY4Nw==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1356#discussion_r544455687", "bodyText": "javascript doesn't seem to support it. if a part of the flow is async, the whole flow becomes async.", "author": "xin-hedera", "createdAt": "2020-12-16T16:47:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mzg1NDg2MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDc3MTYzOQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1356#discussion_r544771639", "bodyText": "Used the above code and walked through the async/await chain to make it happy, effectively a good chunk of the transaction.js and utils.js functions had to become async as a result, as did some tests and validation functions.  Still figuring out how to work around some of the code smells, but it should work as expected now.", "author": "ijungmann", "createdAt": "2020-12-17T02:48:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mzg1NDg2MA=="}], "type": "inlineReview"}, {"oid": "a369746b71d815428ec97495f4ad94a5d6de799e", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/a369746b71d815428ec97495f4ad94a5d6de799e", "message": "Reworking lazy loading to handle async\n\nSigned-off-by: Ian Jungmann <ian.jungmann@hedera.com>", "committedDate": "2020-12-16T07:07:35Z", "type": "commit"}, {"oid": "4a96c83127b973ace7da99ed3678cf8a65727f69", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/4a96c83127b973ace7da99ed3678cf8a65727f69", "message": "Remove logs\n\nSigned-off-by: Ian Jungmann <ian.jungmann@hedera.com>", "committedDate": "2020-12-16T07:09:06Z", "type": "commit"}, {"oid": "a3a3e6d2f90f5db5d856c26a9e345d643be91723", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/a3a3e6d2f90f5db5d856c26a9e345d643be91723", "message": "Attempt 1 to fix tests\n\nSigned-off-by: Ian Jungmann <ian.jungmann@hedera.com>", "committedDate": "2020-12-16T07:10:43Z", "type": "commit"}, {"oid": "70435469a733219a5f0eeef0e98e0286b2c1730f", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/70435469a733219a5f0eeef0e98e0286b2c1730f", "message": "Remove log\n\nSigned-off-by: Ian Jungmann <ian.jungmann@hedera.com>", "committedDate": "2020-12-16T07:15:08Z", "type": "commit"}, {"oid": "eaf12c45a1ecd88be8bc0cc9813c342b7cc3e489", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/eaf12c45a1ecd88be8bc0cc9813c342b7cc3e489", "message": "Everything is async now\n\nSigned-off-by: Ian Jungmann <ian.jungmann@hedera.com>", "committedDate": "2020-12-16T22:15:31Z", "type": "commit"}, {"oid": "9ae62cb2e18a843e2d3e2545d98010342b11f840", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/9ae62cb2e18a843e2d3e2545d98010342b11f840", "message": "Code smell fixes\n\nSigned-off-by: Ian Jungmann <ian.jungmann@hedera.com>", "committedDate": "2020-12-16T22:23:34Z", "type": "commit"}, {"oid": "04814d14db107894ad39ff817978a2c2e064a5c5", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/04814d14db107894ad39ff817978a2c2e064a5c5", "message": "Trying to get around code smell\n\nSigned-off-by: Ian Jungmann <ian.jungmann@hedera.com>", "committedDate": "2020-12-16T22:58:32Z", "type": "commit"}, {"oid": "b878296f22b716c88f1e3f2221185add08bae1b4", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/b878296f22b716c88f1e3f2221185add08bae1b4", "message": "Merge with master\n\nSigned-off-by: Ian Jungmann <ian.jungmann@hedera.com>", "committedDate": "2020-12-17T00:10:47Z", "type": "commit"}, {"oid": "6c30347aff09550a623d24099de05857dbfb5a1d", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/6c30347aff09550a623d24099de05857dbfb5a1d", "message": "Code smells\n\nSigned-off-by: Ian Jungmann <ian.jungmann@hedera.com>", "committedDate": "2020-12-17T00:23:33Z", "type": "commit"}, {"oid": "8a986dbe55f0ce7fa503531b8c2f1413c02b22b4", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/8a986dbe55f0ce7fa503531b8c2f1413c02b22b4", "message": "Removing some asyncs\n\nSigned-off-by: Ian Jungmann <ian.jungmann@hedera.com>", "committedDate": "2020-12-17T01:31:08Z", "type": "commit"}, {"oid": "d9a7097a92afe6ea4e46c49baaa0182a96a91ff2", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/d9a7097a92afe6ea4e46c49baaa0182a96a91ff2", "message": "Remove log\n\nSigned-off-by: Ian Jungmann <ian.jungmann@hedera.com>", "committedDate": "2020-12-17T01:43:14Z", "type": "commit"}, {"oid": "0ac66af2f82d705aa300cbc8840e7c3f25c94dff", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/0ac66af2f82d705aa300cbc8840e7c3f25c94dff", "message": "Alphabetize modules\n\nSigned-off-by: Ian Jungmann <ian.jungmann@hedera.com>", "committedDate": "2020-12-17T02:21:07Z", "type": "commit"}, {"oid": "8254ea4d0c048b373ef6d4987c1f038cc5b4d367", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/8254ea4d0c048b373ef6d4987c1f038cc5b4d367", "message": "Add trace messager\n\nSigned-off-by: Ian Jungmann <ian.jungmann@hedera.com>", "committedDate": "2020-12-17T02:27:36Z", "type": "commit"}, {"oid": "1fdb41fe8b4b9b13af07a22f4786f46d00d660df", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/1fdb41fe8b4b9b13af07a22f4786f46d00d660df", "message": "Copy paste error\n\nSigned-off-by: Ian Jungmann <ian.jungmann@hedera.com>", "committedDate": "2020-12-17T02:35:03Z", "type": "commit"}, {"oid": "3b471f80d99d97db13365691392cf7a3b97d5976", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/3b471f80d99d97db13365691392cf7a3b97d5976", "message": "Documentation change\n\nSigned-off-by: Ian Jungmann <ian.jungmann@hedera.com>", "committedDate": "2020-12-17T02:47:18Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDc4MzYyMQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1356#discussion_r544783621", "bodyText": "considering promise = null; before throwing DbError so a transient error will not cause all following dependent calls to fail.\nthis allows the subsequent calls of get() to retry the db query.", "author": "xin-hedera", "createdAt": "2020-12-17T03:24:05Z", "path": "hedera-mirror-rest/transactionTypes.js", "diffHunk": "@@ -0,0 +1,52 @@\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node REST API\n+ * \u200b\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+'use strict';\n+\n+const {DbError} = require('./errors/dbError');\n+\n+const transactionTypesQuery = 'select proto_id, name from t_transaction_types';\n+\n+// Transaction Type (String) -> ProtoId (Integer)\n+const transactionTypesMap = new Map();\n+\n+let promise;\n+\n+const get = async (transactionTypeName) => {\n+  if (!promise) {\n+    if (logger.isTraceEnabled()) {\n+      logger.trace(`getTransactionTypes query: ${transactionTypesQuery}`);\n+    }\n+    promise = pool.query(transactionTypesQuery);\n+  }\n+\n+  try {\n+    const result = await promise;\n+    if (transactionTypesMap.size === 0) {\n+      result.rows.forEach((row) => transactionTypesMap.set(row.name, row.proto_id));\n+    }\n+    return transactionTypesMap.get(transactionTypeName.toUpperCase());\n+  } catch (err) {\n+    throw new DbError(err.message);\n+  }", "originalCommit": "3b471f80d99d97db13365691392cf7a3b97d5976", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTIwODk0Mw==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1356#discussion_r545208943", "bodyText": "Good idea, added.", "author": "ijungmann", "createdAt": "2020-12-17T16:06:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDc4MzYyMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDc4Nzk2Mw==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1356#discussion_r544787963", "bodyText": "these positive tests assert nothing, you can change toBe('') to e.g. toBe('oops') and they'll still pass.\nadding async/await will make it work:\n  test('DB integration test - utils.getTransactionTypeQuery - Verify null query params', async () => {\n    await expect(utils.getTransactionTypeQuery(null)).resolves.toBe('');\n  });", "author": "xin-hedera", "createdAt": "2020-12-17T03:37:42Z", "path": "hedera-mirror-rest/__tests__/integration.test.js", "diffHunk": "@@ -186,15 +191,79 @@ test('DB integration test - transactions.reqToSql - no query string - 3 txn 9 xf\n   ]);\n });\n \n+describe('DB integration test - utils.getTransactionTypeQuery', () => {\n+  test('DB integration test - utils.getTransactionTypeQuery - Verify null query params', () => {\n+    expect(utils.getTransactionTypeQuery(null)).resolves.toBe('');\n+  });\n+  test('DB integration test - utils.getTransactionTypeQuery - Verify undefined query params', () => {\n+    expect(utils.getTransactionTypeQuery(undefined)).resolves.toBe('');\n+  });\n+  test('DB integration test - utils.getTransactionTypeQuery - Verify empty query params', () => {\n+    expect(utils.getTransactionTypeQuery({})).resolves.toBe('');\n+  });", "originalCommit": "3b471f80d99d97db13365691392cf7a3b97d5976", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTIzMjk0NQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1356#discussion_r545232945", "bodyText": "Fixed these, also reordered the positive tests below a bit to fit this style.", "author": "ijungmann", "createdAt": "2020-12-17T16:38:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDc4Nzk2Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDc4ODc3Ng==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1356#discussion_r544788776", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              test('DB integration test - utils.getTransactionTypeQuery - Verify empty transaction type query', () => {\n          \n          \n            \n                expect(() => utils.getTransactionTypeQuery({[constants.filterKeys.TRANSACTION_TYPE]: ''})).rejects.toThrowError(\n          \n          \n            \n                  InvalidArgumentError\n          \n          \n            \n                );\n          \n          \n            \n              });\n          \n          \n            \n              test('DB integration test - utils.getTransactionTypeQuery - Verify empty transaction type query', async () => {\n          \n          \n            \n                await expect(utils.getTransactionTypeQuery({[constants.filterKeys.TRANSACTION_TYPE]: ''})).rejects.toThrowError(\n          \n          \n            \n                  InvalidArgumentError\n          \n          \n            \n                );\n          \n          \n            \n              });", "author": "xin-hedera", "createdAt": "2020-12-17T03:40:22Z", "path": "hedera-mirror-rest/__tests__/integration.test.js", "diffHunk": "@@ -186,15 +191,79 @@ test('DB integration test - transactions.reqToSql - no query string - 3 txn 9 xf\n   ]);\n });\n \n+describe('DB integration test - utils.getTransactionTypeQuery', () => {\n+  test('DB integration test - utils.getTransactionTypeQuery - Verify null query params', () => {\n+    expect(utils.getTransactionTypeQuery(null)).resolves.toBe('');\n+  });\n+  test('DB integration test - utils.getTransactionTypeQuery - Verify undefined query params', () => {\n+    expect(utils.getTransactionTypeQuery(undefined)).resolves.toBe('');\n+  });\n+  test('DB integration test - utils.getTransactionTypeQuery - Verify empty query params', () => {\n+    expect(utils.getTransactionTypeQuery({})).resolves.toBe('');\n+  });\n+  test('DB integration test - utils.getTransactionTypeQuery - Verify empty transaction type query', () => {\n+    expect(() => utils.getTransactionTypeQuery({[constants.filterKeys.TRANSACTION_TYPE]: ''})).rejects.toThrowError(\n+      InvalidArgumentError\n+    );\n+  });", "originalCommit": "3b471f80d99d97db13365691392cf7a3b97d5976", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTI1MDE3MA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1356#discussion_r545250170", "bodyText": "Fixed", "author": "ijungmann", "createdAt": "2020-12-17T17:01:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDc4ODc3Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDc4OTIyMA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1356#discussion_r544789220", "bodyText": "same as above", "author": "xin-hedera", "createdAt": "2020-12-17T03:41:49Z", "path": "hedera-mirror-rest/__tests__/integration.test.js", "diffHunk": "@@ -186,15 +191,79 @@ test('DB integration test - transactions.reqToSql - no query string - 3 txn 9 xf\n   ]);\n });\n \n+describe('DB integration test - utils.getTransactionTypeQuery', () => {\n+  test('DB integration test - utils.getTransactionTypeQuery - Verify null query params', () => {\n+    expect(utils.getTransactionTypeQuery(null)).resolves.toBe('');\n+  });\n+  test('DB integration test - utils.getTransactionTypeQuery - Verify undefined query params', () => {\n+    expect(utils.getTransactionTypeQuery(undefined)).resolves.toBe('');\n+  });\n+  test('DB integration test - utils.getTransactionTypeQuery - Verify empty query params', () => {\n+    expect(utils.getTransactionTypeQuery({})).resolves.toBe('');\n+  });\n+  test('DB integration test - utils.getTransactionTypeQuery - Verify empty transaction type query', () => {\n+    expect(() => utils.getTransactionTypeQuery({[constants.filterKeys.TRANSACTION_TYPE]: ''})).rejects.toThrowError(\n+      InvalidArgumentError\n+    );\n+  });\n+  test('DB integration test - utils.getTransactionTypeQuery - Verify non applicable transaction type query', () => {\n+    expect(() =>\n+      utils.getTransactionTypeQuery({[constants.filterKeys.TRANSACTION_TYPE]: 'newtransaction'})\n+    ).rejects.toThrowError(InvalidArgumentError);\n+  });", "originalCommit": "3b471f80d99d97db13365691392cf7a3b97d5976", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTIzMzAxNQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1356#discussion_r545233015", "bodyText": "Corrected.", "author": "ijungmann", "createdAt": "2020-12-17T16:38:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDc4OTIyMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDc5NTY0Ng==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1356#discussion_r544795646", "bodyText": "this causes all 'spec based' integration tests to fail. either use constants.cloudProviders.S3 or\nconst {cloudProviders, filterKeys} = require('../constants');", "author": "xin-hedera", "createdAt": "2020-12-17T04:02:29Z", "path": "hedera-mirror-rest/__tests__/integration.test.js", "diffHunk": "@@ -40,20 +40,25 @@\n  * Tests are then run in code below (find TESTS all caps) and by comparing requests/responses from the server to data\n  * in the specs/ dir.\n  */\n-const path = require('path');\n-const request = require('supertest');\n-const fs = require('fs');\n-const _ = require('lodash');\n+// external libraries\n const S3 = require('aws-sdk/clients/s3');\n const crypto = require('crypto');\n-const EntityId = require('../entityId');\n-const transactions = require('../transactions.js');\n-const server = require('../server');\n+const fs = require('fs');\n+const _ = require('lodash');\n+const path = require('path');\n+const request = require('supertest');\n+\n const integrationDbOps = require('./integrationDbOps.js');\n const integrationDomainOps = require('./integrationDomainOps.js');\n const {S3Ops} = require('./integrationS3Ops');\n const config = require('../config');\n-const {cloudProviders} = require('../constants');\n+const constants = require('../constants');", "originalCommit": "3b471f80d99d97db13365691392cf7a3b97d5976", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTIxMDczNA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1356#discussion_r545210734", "bodyText": "Ah, apparently for a while I was importing cloudProviders in one line, and all of constants in another, and did not notice.  Went with{cloudProviders, filterKeys} , fixed now", "author": "ijungmann", "createdAt": "2020-12-17T16:09:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDc5NTY0Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDc5NjY3Mw==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1356#discussion_r544796673", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            const verifyInvalidFilters = async (filters) => {\n          \n          \n            \n              await expect(async () => {\n          \n          \n            \n                await utils.validateAndParseFilters(filters);\n          \n          \n            \n              }).rejects.toThrowErrorMatchingSnapshot();\n          \n          \n            \n            const verifyInvalidFilters = async (filters) => {\n          \n          \n            \n              await expect(utils.validateAndParseFilters(filters)).rejects.toThrowErrorMatchingSnapshot();", "author": "xin-hedera", "createdAt": "2020-12-17T04:06:06Z", "path": "hedera-mirror-rest/__tests__/utilsFilters.test.js", "diffHunk": "@@ -226,14 +225,14 @@ describe('utils validateAndParseFilters tests', () => {\n       utils.buildComparatorFilter(constants.filterKeys.ENCODING, 'utf-8'),\n     ];\n \n-    expect(() => {\n-      utils.validateAndParseFilters(filters);\n+    expect(async () => {\n+      await utils.validateAndParseFilters(filters);\n     }).not.toThrow();\n   });\n });\n \n-const verifyInvalidFilters = (filters) => {\n-  expect(() => {\n-    utils.validateAndParseFilters(filters);\n-  }).toThrowErrorMatchingSnapshot();\n+const verifyInvalidFilters = async (filters) => {\n+  await expect(async () => {\n+    await utils.validateAndParseFilters(filters);\n+  }).rejects.toThrowErrorMatchingSnapshot();", "originalCommit": "3b471f80d99d97db13365691392cf7a3b97d5976", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTI1ODA4Ng==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1356#discussion_r545258086", "bodyText": "Changed", "author": "ijungmann", "createdAt": "2020-12-17T17:13:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDc5NjY3Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDc5OTQzNg==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1356#discussion_r544799436", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                expect(async () => {\n          \n          \n            \n                  await utils.validateAndParseFilters(filters);\n          \n          \n            \n                }).not.toThrow();\n          \n          \n            \n              await expect(utils.validateAndParseFilters(filters)).resolves.toBeUndefined();", "author": "xin-hedera", "createdAt": "2020-12-17T04:14:46Z", "path": "hedera-mirror-rest/__tests__/utilsFilters.test.js", "diffHunk": "@@ -226,14 +225,14 @@ describe('utils validateAndParseFilters tests', () => {\n       utils.buildComparatorFilter(constants.filterKeys.ENCODING, 'utf-8'),\n     ];\n \n-    expect(() => {\n-      utils.validateAndParseFilters(filters);\n+    expect(async () => {\n+      await utils.validateAndParseFilters(filters);\n     }).not.toThrow();", "originalCommit": "3b471f80d99d97db13365691392cf7a3b97d5976", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTI1ODIxNw==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1356#discussion_r545258217", "bodyText": "Fixed.", "author": "ijungmann", "createdAt": "2020-12-17T17:13:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDc5OTQzNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDgwMDA1OA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1356#discussion_r544800058", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              test('Verify validateAndParseFilters for valid filters does not throw exception', () => {\n          \n          \n            \n              test('Verify validateAndParseFilters for valid filters does not throw exception', async () => {", "author": "xin-hedera", "createdAt": "2020-12-17T04:16:52Z", "path": "hedera-mirror-rest/__tests__/utilsFilters.test.js", "diffHunk": "@@ -203,8 +203,7 @@ describe('utils validateAndParseFilters tests', () => {\n       utils.buildComparatorFilter(constants.filterKeys.ACCOUNT_PUBLICKEY, '3c3d546321ff6f63d701d2ec5c2'),\n       utils.buildComparatorFilter(constants.filterKeys.ACCOUNT_BALANCE, '23456789012345678901234'),\n     ];\n-\n-    verifyInvalidFilters(filters);\n+    await verifyInvalidFilters(filters);\n   });\n \n   test('Verify validateAndParseFilters for valid filters does not throw exception', () => {", "originalCommit": "3b471f80d99d97db13365691392cf7a3b97d5976", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTI1ODI5MQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1356#discussion_r545258291", "bodyText": "Added", "author": "ijungmann", "createdAt": "2020-12-17T17:13:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDgwMDA1OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDgwNjE1NQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1356#discussion_r544806155", "bodyText": "this looks better:\nconst protoId = await transactionTypes.get(transactionType);\nif (protoId !== undefined) {\n  return `${constants.transactionColumns.TYPE}${opsMap.eq}${protoId}`;\n}\nthen the function isValidTransactionType can be removed", "author": "xin-hedera", "createdAt": "2020-12-17T04:36:44Z", "path": "hedera-mirror-rest/utils.js", "diffHunk": "@@ -749,11 +750,8 @@ const getTransactionTypeQuery = (parsedQueryParams) => {\n   if (_.isNil(transactionType)) {\n     return '';\n   }\n-\n-  if (isValidTransactionType(transactionType)) {\n-    return `${constants.transactionColumns.TYPE}${opsMap.eq}${\n-      constants.transactionTypes[transactionType.toUpperCase()]\n-    }`;\n+  if (await isValidTransactionType(transactionType)) {\n+    return `${constants.transactionColumns.TYPE}${opsMap.eq}${await transactionTypes.get(transactionType)}`;", "originalCommit": "3b471f80d99d97db13365691392cf7a3b97d5976", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTI2ODk1Ng==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1356#discussion_r545268956", "bodyText": "I agree that looks better, should it still do an isString() check?", "author": "ijungmann", "createdAt": "2020-12-17T17:28:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDgwNjE1NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTI3NzUzNg==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1356#discussion_r545277536", "bodyText": "Added as is for now.", "author": "ijungmann", "createdAt": "2020-12-17T17:40:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDgwNjE1NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTI3ODE2MA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1356#discussion_r545278160", "bodyText": "nope in my opinion", "author": "xin-hedera", "createdAt": "2020-12-17T17:41:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDgwNjE1NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTEzNzY2MA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1356#discussion_r545137660", "bodyText": "this function can be removed, see my other comment at line 754", "author": "xin-hedera", "createdAt": "2020-12-17T14:36:38Z", "path": "hedera-mirror-rest/utils.js", "diffHunk": "@@ -94,8 +95,8 @@ const isValidEncoding = (query) => {\n   return query === constants.characterEncoding.BASE64 || isValidUtf8Encoding(query);\n };\n \n-const isValidTransactionType = (transactionType) => {\n-  return _.isString(transactionType) && constants.transactionTypes[transactionType.toUpperCase()] !== undefined;\n+const isValidTransactionType = async (transactionType) => {", "originalCommit": "3b471f80d99d97db13365691392cf7a3b97d5976", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTI3NjY1OA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1356#discussion_r545276658", "bodyText": "The function is still used by filterValidityChecks, I can move the logic into there but considering most of the other validation checks have their own functions (and it would require some test refactoring), I would think it makes sense to keep it as is.", "author": "ijungmann", "createdAt": "2020-12-17T17:39:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTEzNzY2MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTM0Mjk2NA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1356#discussion_r545342964", "bodyText": "sure", "author": "xin-hedera", "createdAt": "2020-12-17T19:21:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTEzNzY2MA=="}], "type": "inlineReview"}, {"oid": "2930a826fafcb0c09cb6a4e1b29d0d05e03c4174", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/2930a826fafcb0c09cb6a4e1b29d0d05e03c4174", "message": "Handle promise in catch statement\n\nSigned-off-by: Ian Jungmann <ian.jungmann@hedera.com>", "committedDate": "2020-12-17T16:06:09Z", "type": "commit"}, {"oid": "870482fb8cc2ce32a64f795b57c0f1b8dab7560a", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/870482fb8cc2ce32a64f795b57c0f1b8dab7560a", "message": "Fix int specs tests with module\n\nSigned-off-by: Ian Jungmann <ian.jungmann@hedera.com>", "committedDate": "2020-12-17T16:07:50Z", "type": "commit"}, {"oid": "cc4d39906be133994736f76f372b4ec2722edf5b", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/cc4d39906be133994736f76f372b4ec2722edf5b", "message": "Fix utils.getTransactionTypeQuery tests\n\nSigned-off-by: Ian Jungmann <ian.jungmann@hedera.com>", "committedDate": "2020-12-17T16:38:20Z", "type": "commit"}, {"oid": "f143923407c044833137e47c4672d1d1c639ca61", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/f143923407c044833137e47c4672d1d1c639ca61", "message": "Fix utilsFilters.test\n\nSigned-off-by: Ian Jungmann <ian.jungmann@hedera.com>", "committedDate": "2020-12-17T17:13:10Z", "type": "commit"}, {"oid": "31f14947fa327f79c3202dcacf33370c18f0299c", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/31f14947fa327f79c3202dcacf33370c18f0299c", "message": "Refactor get transaction type in utils\n\nSigned-off-by: Ian Jungmann <ian.jungmann@hedera.com>", "committedDate": "2020-12-17T17:40:22Z", "type": "commit"}, {"oid": "31f14947fa327f79c3202dcacf33370c18f0299c", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/31f14947fa327f79c3202dcacf33370c18f0299c", "message": "Refactor get transaction type in utils\n\nSigned-off-by: Ian Jungmann <ian.jungmann@hedera.com>", "committedDate": "2020-12-17T17:40:22Z", "type": "forcePushed"}]}