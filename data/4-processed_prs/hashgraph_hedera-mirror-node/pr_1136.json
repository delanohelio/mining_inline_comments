{"pr_number": 1136, "pr_title": "Rosetta: Unit test Account, Block, Mempool & Network API Services", "pr_createdAt": "2020-10-16T14:07:42Z", "pr_url": "https://github.com/hashgraph/hedera-mirror-node/pull/1136", "timeline": [{"oid": "c2bfff4b233e395cbc20f7ac04a6dde7df5da47a", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/c2bfff4b233e395cbc20f7ac04a6dde7df5da47a", "message": "Tests: Account, Block, Mempool, Network API Services (#149)\n\nSigned-off-by: Georgi Yazovaliyski <georgi.yazovaliiski@gmail.com>\r\nSigned-off-by: Daniel Ivanov <daniel.k.ivanov95@gmail.com>\r\nSigned-off-by: Daniel <Daniel.K.Ivanov95@gmail.com>", "committedDate": "2020-10-16T13:43:22Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzg5MzM3Ng==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1136#discussion_r507893376", "bodyText": "should check the values in the Errors slice equal", "author": "xin-hedera", "createdAt": "2020-10-19T16:34:39Z", "path": "hedera-mirror-rosetta/app/services/network/network_service_test.go", "diffHunk": "@@ -0,0 +1,247 @@\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ *\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+\n+package network\n+\n+import (\n+\t\"github.com/coinbase/rosetta-sdk-go/server\"\n+\trTypes \"github.com/coinbase/rosetta-sdk-go/types\"\n+\t\"github.com/hashgraph/hedera-mirror-node/hedera-mirror-rosetta/app/domain/types\"\n+\t\"github.com/hashgraph/hedera-mirror-node/hedera-mirror-rosetta/app/errors\"\n+\t\"github.com/hashgraph/hedera-mirror-node/hedera-mirror-rosetta/app/services/base\"\n+\t\"github.com/hashgraph/hedera-mirror-node/hedera-mirror-rosetta/tests/mocks/repository\"\n+\t\"github.com/hashgraph/hedera-mirror-node/hedera-mirror-rosetta/tools/maphelper\"\n+\t\"github.com/stretchr/testify/assert\"\n+\t\"testing\"\n+)\n+\n+func getSubject() server.NetworkAPIServicer {\n+\tbaseService := base.NewBaseService(repository.MBlockRepository, repository.MTransactionRepository)\n+\treturn networkAPIService(baseService)\n+}\n+\n+func dummyGenesisBlock() *types.Block {\n+\treturn &types.Block{\n+\t\tIndex:               1,\n+\t\tHash:                \"0x123jsjs\",\n+\t\tConsensusStartNanos: 1000000,\n+\t\tConsensusEndNanos:   20000000,\n+\t\tParentIndex:         0,\n+\t\tParentHash:          \"\",\n+\t}\n+}\n+\n+func dummyLatestBlock() *types.Block {\n+\treturn &types.Block{\n+\t\tIndex:               2,\n+\t\tHash:                \"0x1323jsjs\",\n+\t\tConsensusStartNanos: 40000000,\n+\t\tConsensusEndNanos:   70000000,\n+\t\tParentIndex:         1,\n+\t\tParentHash:          \"0x123jsjs\",\n+\t}\n+}\n+\n+func networkAPIService(base base.BaseService) server.NetworkAPIServicer {\n+\treturn NewNetworkAPIService(\n+\t\tbase,\n+\t\trepository.MAddressBookEntryRepository,\n+\t\t&rTypes.NetworkIdentifier{\n+\t\t\tBlockchain: \"SomeBlockchain\",\n+\t\t\tNetwork:    \"SomeNetwork\",\n+\t\t\tSubNetworkIdentifier: &rTypes.SubNetworkIdentifier{\n+\t\t\t\tNetwork:  \"SomeSubNetwork\",\n+\t\t\t\tMetadata: nil,\n+\t\t\t},\n+\t\t},\n+\t\t&rTypes.Version{\n+\t\t\tRosettaVersion:    \"1\",\n+\t\t\tNodeVersion:       \"1\",\n+\t\t\tMiddlewareVersion: nil,\n+\t\t\tMetadata:          nil,\n+\t\t},\n+\t)\n+}\n+\n+func TestNewNetworkAPIService(t *testing.T) {\n+\trepository.Setup()\n+\tassert.IsType(t, &NetworkAPIService{}, getSubject())\n+}\n+\n+func TestNetworkList(t *testing.T) {\n+\t// given:\n+\texpectedResult := &rTypes.NetworkListResponse{\n+\t\tNetworkIdentifiers: []*rTypes.NetworkIdentifier{\n+\t\t\t{\n+\t\t\t\tBlockchain: \"SomeBlockchain\",\n+\t\t\t\tNetwork:    \"SomeNetwork\",\n+\t\t\t\tSubNetworkIdentifier: &rTypes.SubNetworkIdentifier{\n+\t\t\t\t\tNetwork:  \"SomeSubNetwork\",\n+\t\t\t\t\tMetadata: nil,\n+\t\t\t\t},\n+\t\t\t},\n+\t\t},\n+\t}\n+\n+\trepository.Setup()\n+\n+\t// when:\n+\tres, e := getSubject().NetworkList(nil, nil)\n+\n+\t// then:\n+\tassert.Equal(t, expectedResult, res)\n+\tassert.Nil(t, e)\n+}\n+\n+func TestNetworkOptions(t *testing.T) {\n+\t// given:\n+\texpectedResult := &rTypes.NetworkOptionsResponse{\n+\t\tVersion: &rTypes.Version{\n+\t\t\tRosettaVersion:    \"1\",\n+\t\t\tNodeVersion:       \"1\",\n+\t\t\tMiddlewareVersion: nil,\n+\t\t\tMetadata:          nil,\n+\t\t},\n+\t\tAllow: &rTypes.Allow{\n+\t\t\tOperationStatuses: []*rTypes.OperationStatus{\n+\t\t\t\t{\n+\t\t\t\t\tStatus:     \"Pending\",\n+\t\t\t\t\tSuccessful: true,\n+\t\t\t\t},\n+\t\t\t},\n+\t\t\tOperationTypes:          []string{\"Transfer\"},\n+\t\t\tErrors:                  maphelper.GetErrorValuesFromStringErrorMap(errors.Errors),\n+\t\t\tHistoricalBalanceLookup: true,\n+\t\t},\n+\t}\n+\n+\trepository.Setup()\n+\trepository.MTransactionRepository.On(\"Statuses\").Return(map[int]string{1: \"Pending\"}, repository.NilError)\n+\trepository.MTransactionRepository.On(\"TypesAsArray\").Return([]string{\"Transfer\"}, repository.NilError)\n+\n+\t// when:\n+\tres, e := getSubject().NetworkOptions(nil, nil)\n+\n+\t// then:\n+\tassert.Equal(t, expectedResult.Version, res.Version)\n+\tassert.Equal(t, expectedResult.Allow.HistoricalBalanceLookup, res.Allow.HistoricalBalanceLookup)\n+\tassert.Equal(t, expectedResult.Allow.OperationStatuses, res.Allow.OperationStatuses)\n+\tassert.Equal(t, expectedResult.Allow.OperationTypes, res.Allow.OperationTypes)\n+\tassert.Equal(t, len(expectedResult.Allow.Errors), len(res.Allow.Errors))", "originalCommit": "c2bfff4b233e395cbc20f7ac04a6dde7df5da47a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODUyOTM1Ng==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1136#discussion_r508529356", "bodyText": "Done. I added a new comparing function for the rosetta error arrays, which correctly checks the validity of this assertion.", "author": "georgiyazovaliiski", "createdAt": "2020-10-20T13:58:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzg5MzM3Ng=="}], "type": "inlineReview"}, {"oid": "def3c7e8f0f892d74c0b50a2c818289b45505e3b", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/def3c7e8f0f892d74c0b50a2c818289b45505e3b", "message": "Assertion of equal, unordered Error elements function\n\nSigned-off-by: Georgi Yazovaliyski <georgi.yazovaliiski@gmail.com>", "committedDate": "2020-10-20T08:12:20Z", "type": "commit"}, {"oid": "cde549244da3a6c93c13c8a7b858707e5b478844", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/cde549244da3a6c93c13c8a7b858707e5b478844", "message": "remove unnecessary assertion\n\nSigned-off-by: Georgi Yazovaliyski <georgi.yazovaliiski@gmail.com>", "committedDate": "2020-10-20T08:13:01Z", "type": "commit"}, {"oid": "32fde97e1799c56cf9fc37dabadfc563b658f743", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/32fde97e1799c56cf9fc37dabadfc563b658f743", "message": "Refactor Equals method\n\nSigned-off-by: Georgi Yazovaliyski <georgi.yazovaliiski@gmail.com>", "committedDate": "2020-10-20T09:19:05Z", "type": "commit"}, {"oid": "0de14c302e0a1596121e26970e708152a1e2cf21", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/0de14c302e0a1596121e26970e708152a1e2cf21", "message": "efficiency refactor\n\nSigned-off-by: Georgi Yazovaliyski <georgi.yazovaliiski@gmail.com>", "committedDate": "2020-10-20T09:24:48Z", "type": "commit"}, {"oid": "0ea66a387458bd3915345544f2300309197f64fc", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/0ea66a387458bd3915345544f2300309197f64fc", "message": "remove unnecessary test\n\nSigned-off-by: Georgi Yazovaliyski <georgi.yazovaliiski@gmail.com>", "committedDate": "2020-10-20T10:17:27Z", "type": "commit"}, {"oid": "13c49fee2a151bfb650ae0fa77084f283a66a6c2", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/13c49fee2a151bfb650ae0fa77084f283a66a6c2", "message": "Error comparison method rename\n\nSigned-off-by: Georgi Yazovaliyski <georgi.yazovaliiski@gmail.com>", "committedDate": "2020-10-20T13:32:55Z", "type": "commit"}, {"oid": "79d5b6580e7757a708653cfe67da18c9146a57ef", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/79d5b6580e7757a708653cfe67da18c9146a57ef", "message": "Merge pull request #155 from LimeChain/tests/data-api-unit-tests-rework\n\nPR Comments resolution", "committedDate": "2020-10-20T13:56:01Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODUzODAxMA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1136#discussion_r508538010", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \tassert.True(t, errorsAreEqual(expectedResult.Allow.Errors, res.Allow.Errors))\n          \n          \n            \n            \tassert.ElementsMatch(t, expectedResult.Allow.Errors, res.Allow.Errors);", "author": "xin-hedera", "createdAt": "2020-10-20T14:06:30Z", "path": "hedera-mirror-rosetta/app/services/network/network_service_test.go", "diffHunk": "@@ -0,0 +1,268 @@\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ *\n+ * Copyright (C) 2019 - 2020 Hedera Hashgraph, LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+\n+package network\n+\n+import (\n+\t\"github.com/coinbase/rosetta-sdk-go/server\"\n+\trTypes \"github.com/coinbase/rosetta-sdk-go/types\"\n+\t\"github.com/hashgraph/hedera-mirror-node/hedera-mirror-rosetta/app/domain/types\"\n+\t\"github.com/hashgraph/hedera-mirror-node/hedera-mirror-rosetta/app/errors\"\n+\t\"github.com/hashgraph/hedera-mirror-node/hedera-mirror-rosetta/app/services/base\"\n+\t\"github.com/hashgraph/hedera-mirror-node/hedera-mirror-rosetta/tests/mocks/repository\"\n+\t\"github.com/hashgraph/hedera-mirror-node/hedera-mirror-rosetta/tools/maphelper\"\n+\t\"github.com/stretchr/testify/assert\"\n+\t\"reflect\"\n+\t\"testing\"\n+)\n+\n+func getSubject() server.NetworkAPIServicer {\n+\tbaseService := base.NewBaseService(repository.MBlockRepository, repository.MTransactionRepository)\n+\treturn networkAPIService(baseService)\n+}\n+\n+func dummyGenesisBlock() *types.Block {\n+\treturn &types.Block{\n+\t\tIndex:               1,\n+\t\tHash:                \"0x123jsjs\",\n+\t\tConsensusStartNanos: 1000000,\n+\t\tConsensusEndNanos:   20000000,\n+\t\tParentIndex:         0,\n+\t\tParentHash:          \"\",\n+\t}\n+}\n+\n+func dummyLatestBlock() *types.Block {\n+\treturn &types.Block{\n+\t\tIndex:               2,\n+\t\tHash:                \"0x1323jsjs\",\n+\t\tConsensusStartNanos: 40000000,\n+\t\tConsensusEndNanos:   70000000,\n+\t\tParentIndex:         1,\n+\t\tParentHash:          \"0x123jsjs\",\n+\t}\n+}\n+\n+func networkAPIService(base base.BaseService) server.NetworkAPIServicer {\n+\treturn NewNetworkAPIService(\n+\t\tbase,\n+\t\trepository.MAddressBookEntryRepository,\n+\t\t&rTypes.NetworkIdentifier{\n+\t\t\tBlockchain: \"SomeBlockchain\",\n+\t\t\tNetwork:    \"SomeNetwork\",\n+\t\t\tSubNetworkIdentifier: &rTypes.SubNetworkIdentifier{\n+\t\t\t\tNetwork:  \"SomeSubNetwork\",\n+\t\t\t\tMetadata: nil,\n+\t\t\t},\n+\t\t},\n+\t\t&rTypes.Version{\n+\t\t\tRosettaVersion:    \"1\",\n+\t\t\tNodeVersion:       \"1\",\n+\t\t\tMiddlewareVersion: nil,\n+\t\t\tMetadata:          nil,\n+\t\t},\n+\t)\n+}\n+\n+func TestNewNetworkAPIService(t *testing.T) {\n+\trepository.Setup()\n+\tassert.IsType(t, &NetworkAPIService{}, getSubject())\n+}\n+\n+func TestNetworkList(t *testing.T) {\n+\t// given:\n+\texpectedResult := &rTypes.NetworkListResponse{\n+\t\tNetworkIdentifiers: []*rTypes.NetworkIdentifier{\n+\t\t\t{\n+\t\t\t\tBlockchain: \"SomeBlockchain\",\n+\t\t\t\tNetwork:    \"SomeNetwork\",\n+\t\t\t\tSubNetworkIdentifier: &rTypes.SubNetworkIdentifier{\n+\t\t\t\t\tNetwork:  \"SomeSubNetwork\",\n+\t\t\t\t\tMetadata: nil,\n+\t\t\t\t},\n+\t\t\t},\n+\t\t},\n+\t}\n+\n+\trepository.Setup()\n+\n+\t// when:\n+\tres, e := getSubject().NetworkList(nil, nil)\n+\n+\t// then:\n+\tassert.Equal(t, expectedResult, res)\n+\tassert.Nil(t, e)\n+}\n+\n+func TestNetworkOptions(t *testing.T) {\n+\t// given:\n+\texpectedResult := &rTypes.NetworkOptionsResponse{\n+\t\tVersion: &rTypes.Version{\n+\t\t\tRosettaVersion:    \"1\",\n+\t\t\tNodeVersion:       \"1\",\n+\t\t\tMiddlewareVersion: nil,\n+\t\t\tMetadata:          nil,\n+\t\t},\n+\t\tAllow: &rTypes.Allow{\n+\t\t\tOperationStatuses: []*rTypes.OperationStatus{\n+\t\t\t\t{\n+\t\t\t\t\tStatus:     \"Pending\",\n+\t\t\t\t\tSuccessful: true,\n+\t\t\t\t},\n+\t\t\t},\n+\t\t\tOperationTypes:          []string{\"Transfer\"},\n+\t\t\tErrors:                  maphelper.GetErrorValuesFromStringErrorMap(errors.Errors),\n+\t\t\tHistoricalBalanceLookup: true,\n+\t\t},\n+\t}\n+\n+\trepository.Setup()\n+\trepository.MTransactionRepository.On(\"Statuses\").Return(map[int]string{1: \"Pending\"}, repository.NilError)\n+\trepository.MTransactionRepository.On(\"TypesAsArray\").Return([]string{\"Transfer\"}, repository.NilError)\n+\n+\t// when:\n+\tres, e := getSubject().NetworkOptions(nil, nil)\n+\n+\t// then:\n+\tassert.Equal(t, expectedResult.Version, res.Version)\n+\tassert.Equal(t, expectedResult.Allow.HistoricalBalanceLookup, res.Allow.HistoricalBalanceLookup)\n+\tassert.Equal(t, expectedResult.Allow.OperationStatuses, res.Allow.OperationStatuses)\n+\tassert.Equal(t, expectedResult.Allow.OperationTypes, res.Allow.OperationTypes)\n+\tassert.True(t, errorsAreEqual(expectedResult.Allow.Errors, res.Allow.Errors))", "originalCommit": "79d5b6580e7757a708653cfe67da18c9146a57ef", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "23f7dffe63f3dc84dae72a2ccb98696432704b29", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/23f7dffe63f3dc84dae72a2ccb98696432704b29", "message": "ElementsMatch\n\nSigned-off-by: Georgi Yazovaliyski <georgi.yazovaliiski@gmail.com>", "committedDate": "2020-10-20T14:31:37Z", "type": "commit"}]}