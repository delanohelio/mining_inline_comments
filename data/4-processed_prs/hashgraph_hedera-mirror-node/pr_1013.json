{"pr_number": 1013, "pr_title": "Ignore NodeAddress fields not set in protobuf", "pr_createdAt": "2020-09-02T22:52:19Z", "pr_url": "https://github.com/hashgraph/hedera-mirror-node/pull/1013", "timeline": [{"oid": "67f046aec3bd360e0beef496b63de118c81c7fcf", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/67f046aec3bd360e0beef496b63de118c81c7fcf", "message": "ignore NodeAddress fields not set in protobuf\n\nSigned-off-by: Xin Li <xin.li@swirlds.com>", "committedDate": "2020-09-02T22:47:49Z", "type": "commit"}, {"oid": "c8d969f28a851ee463399b402e39bea7068c85f1", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/c8d969f28a851ee463399b402e39bea7068c85f1", "message": "use different nodeCertHash ande RSAPubKey for different nodes in test\n\nSigned-off-by: Xin Li <xin.li@swirlds.com>", "committedDate": "2020-09-03T14:39:59Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzA4MDExNg==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1013#discussion_r483080116", "bodyText": "Is this a valid scenario? When would we ever pass in a null NodeAddressBook? Should this rather throw?", "author": "Nana-EC", "createdAt": "2020-09-03T15:47:59Z", "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/addressbook/AddressBookServiceImpl.java", "diffHunk": "@@ -220,26 +225,52 @@ private AddressBook buildAddressBook(byte[] addressBookBytes, long consensusTime\n      */\n     private Collection<AddressBookEntry> retrieveNodeAddressesFromAddressBook(NodeAddressBook nodeAddressBook,\n                                                                               long consensusTimestamp) {\n-        ImmutableList.Builder<AddressBookEntry> builder = ImmutableList.builder();\n-\n-        if (nodeAddressBook != null) {\n-            for (com.hederahashgraph.api.proto.java.NodeAddress nodeAddressProto : nodeAddressBook\n-                    .getNodeAddressList()) {\n-                AddressBookEntry addressBookEntry = AddressBookEntry.builder()\n-                        .consensusTimestamp(consensusTimestamp)\n-                        .memo(nodeAddressProto.getMemo().toStringUtf8())\n-                        .ip(nodeAddressProto.getIpAddress().toStringUtf8())\n-                        .port(nodeAddressProto.getPortno())\n-                        .publicKey(nodeAddressProto.getRSAPubKey())\n-                        .nodeCertHash(nodeAddressProto.getNodeCertHash().toByteArray())\n-                        .nodeId(nodeAddressProto.getNodeId())\n-                        .nodeAccountId(EntityId.of(nodeAddressProto.getNodeAccountId()))\n-                        .build();\n-                builder.add(addressBookEntry);\n-            }\n+        if (nodeAddressBook == null) {", "originalCommit": "c8d969f28a851ee463399b402e39bea7068c85f1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzExODM0OQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1013#discussion_r483118349", "bodyText": "The change here is a refactor of the original negative check nodeAddressBook != null.\nIndeed the check is redundant since the only place retrieveNodeAddressesFromAddressBook is called has already made sure nodeAddressBook is not NULL. I'll remove the null check here then.", "author": "xin-hedera", "createdAt": "2020-09-03T16:46:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzA4MDExNg=="}], "type": "inlineReview"}, {"oid": "5b47fb9ed2cb967a83408b38b013bd2e4563dd9c", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/5b47fb9ed2cb967a83408b38b013bd2e4563dd9c", "message": "remove redundant null check\n\nSigned-off-by: Xin Li <xin.li@swirlds.com>", "committedDate": "2020-09-03T17:24:37Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzE1MjcxNw==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1013#discussion_r483152717", "bodyText": "I don't think the implementation of this is correct. It's also unnecessarily complex and uses reflection. Both nodeId and port are primitives, so the hasField() implementation returns true if they don't equal the default value (which is zero for both). However, zero is still a valid value for these fields so we still want to set it if it's zero (e.g. testnet's node 0-3).\nI think we can revert to previous logic and use some smarter conditional logic to control them being set. For port, I think it's safe to assume that the main nodes aren't going to use port zero so we can just not set it if it's zero. For nodeId, we can first collect all nodeIds into a set and only set nodeId if the size of that set is greater than one.", "author": "steven-sheehy", "createdAt": "2020-09-03T17:48:18Z", "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/addressbook/AddressBookServiceImpl.java", "diffHunk": "@@ -220,26 +225,48 @@ private AddressBook buildAddressBook(byte[] addressBookBytes, long consensusTime\n      */\n     private Collection<AddressBookEntry> retrieveNodeAddressesFromAddressBook(NodeAddressBook nodeAddressBook,\n                                                                               long consensusTimestamp) {\n-        ImmutableList.Builder<AddressBookEntry> builder = ImmutableList.builder();\n-\n-        if (nodeAddressBook != null) {\n-            for (com.hederahashgraph.api.proto.java.NodeAddress nodeAddressProto : nodeAddressBook\n-                    .getNodeAddressList()) {\n-                AddressBookEntry addressBookEntry = AddressBookEntry.builder()\n-                        .consensusTimestamp(consensusTimestamp)\n-                        .memo(nodeAddressProto.getMemo().toStringUtf8())\n-                        .ip(nodeAddressProto.getIpAddress().toStringUtf8())\n-                        .port(nodeAddressProto.getPortno())\n-                        .publicKey(nodeAddressProto.getRSAPubKey())\n-                        .nodeCertHash(nodeAddressProto.getNodeCertHash().toByteArray())\n-                        .nodeId(nodeAddressProto.getNodeId())\n-                        .nodeAccountId(EntityId.of(nodeAddressProto.getNodeAccountId()))\n-                        .build();\n-                builder.add(addressBookEntry);\n-            }\n+        ImmutableList.Builder<AddressBookEntry> listBuilder = ImmutableList.builder();\n+\n+        for (NodeAddress nodeAddressProto : nodeAddressBook.getNodeAddressList()) {\n+            AddressBookEntry.AddressBookEntryBuilder builder = AddressBookEntry.builder()\n+                    .consensusTimestamp(consensusTimestamp);\n+\n+            nodeAddressFieldDescriptors.stream()\n+                    .filter(nodeAddressProto::hasField)", "originalCommit": "5b47fb9ed2cb967a83408b38b013bd2e4563dd9c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzY3MjI3OQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1013#discussion_r483672279", "bodyText": "thanks. reverted the changes and implemented the new logic", "author": "xin-hedera", "createdAt": "2020-09-04T14:57:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzE1MjcxNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzE1NDIwNA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1013#discussion_r483154204", "bodyText": "This test and addressBookWithEmptyAddressBookEntryFields() are very hard to understand and not maintainable. It'd be much simpler to just NodeAddressBook.newBuilder().ip()...build() all fields manually except nodeId and port then assert the current address book has null for those fields.", "author": "steven-sheehy", "createdAt": "2020-09-03T17:50:58Z", "path": "hedera-mirror-importer/src/test/java/com/hedera/mirror/importer/addressbook/AddressBookServiceImplTest.java", "diffHunk": "@@ -335,9 +344,103 @@ void verifyAddressBookEndPointsAreSet() {\n         assertThat(prevAddressBook.getEndConsensusTimestamp()).isNotNull();\n     }\n \n+    @Test\n+    void verifyAddressBookWithEmptyAddressBookEntryFields() {", "originalCommit": "5b47fb9ed2cb967a83408b38b013bd2e4563dd9c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzY3MjM0OQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1013#discussion_r483672349", "bodyText": "test cases updated", "author": "xin-hedera", "createdAt": "2020-09-04T14:57:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzE1NDIwNA=="}], "type": "inlineReview"}, {"oid": "d312b9aa619e825426319782df3a58209eec4954", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/d312b9aa619e825426319782df3a58209eec4954", "message": "Revert \"ignore NodeAddress fields not set in protobuf\"\n\nThis reverts commit 67f046aec3bd360e0beef496b63de118c81c7fcf.\n\nSigned-off-by: Xin Li <xin.li@swirlds.com>", "committedDate": "2020-09-04T01:57:51Z", "type": "commit"}, {"oid": "9258f326f104c4442806cd590137e680a15e97b2", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/9258f326f104c4442806cd590137e680a15e97b2", "message": "set port number to null if in protobuf it's 0; set all nodeID to null if they are the same\n\nSigned-off-by: Xin Li <xin.li@swirlds.com>", "committedDate": "2020-09-04T04:34:43Z", "type": "commit"}, {"oid": "9e061ff67c36d0e563d2c9da5c9396cfa18057c5", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/9e061ff67c36d0e563d2c9da5c9396cfa18057c5", "message": "verify address book entries\n\nSigned-off-by: Xin Li <xin.li@swirlds.com>", "committedDate": "2020-09-04T13:50:50Z", "type": "commit"}]}