{"pr_number": 698, "pr_title": "Fix topic messages REST route", "pr_createdAt": "2020-04-20T21:45:06Z", "pr_url": "https://github.com/hashgraph/hedera-mirror-node/pull/698", "timeline": [{"oid": "6d341da7763293d9e287aa55db88544f8615782c", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/6d341da7763293d9e287aa55db88544f8615782c", "message": "Fix topic messages REST route\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2020-04-20T21:40:02Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTc3Nzc0Mw==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/698#discussion_r411777743", "bodyText": "nits: no need of 's' in middle words (messages, transactions).\norderFilterValues \u2192 'orderBy' (order is not filter)\ntopicMessagesFormatFilterValues \u2192 topicMessageFormat (response format is not a filter)\ntransactionResultFilterValues \u2192 transactionResultFilter\ntransactionsTypeFilterValues \u2192 cryptoTransferType (transactionType has different connotation in rest of our stack)", "author": "apeksharma", "createdAt": "2020-04-21T00:14:50Z", "path": "hedera-mirror-rest/constants.js", "diffHunk": "@@ -40,8 +40,32 @@ const entityColumns = {\n \n const responseDataLabel = 'mirrorRestData';\n \n+const orderFilterValues = {\n+  ASC: 'asc',\n+  DESC: 'desc',\n+};\n+\n+// topic messages filter options\n+const topicMessagesFormatFilterValues = {\n+  BINARY: 'binary',\n+  TEXT: 'text',\n+};\n+\n+const transactionsResultFilterValues = {\n+  SUCCESS: 'success',\n+  FAIL: 'fail',\n+};\n+\n+const transactionsTypeFilterValues = {", "originalCommit": "6d341da7763293d9e287aa55db88544f8615782c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTg3Njc4NA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/698#discussion_r411876784", "bodyText": "Sure.", "author": "Nana-EC", "createdAt": "2020-04-21T05:20:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTc3Nzc0Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjM5OTk5NA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/698#discussion_r412399994", "bodyText": "orderFilterValues looks unchanged. np, can be done later.", "author": "apeksharma", "createdAt": "2020-04-21T18:39:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTc3Nzc0Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTc4MDUxMQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/698#discussion_r411780511", "bodyText": "function is not being used anywhere.", "author": "apeksharma", "createdAt": "2020-04-21T00:23:22Z", "path": "hedera-mirror-rest/utils.js", "diffHunk": "@@ -75,6 +64,22 @@ const isValidNum = (num) => {\n   return /^\\d{1,16}$/.test(num) && num > 0 && num <= Number.MAX_SAFE_INTEGER;\n };\n \n+const isValidMessageQuery = (query) => {", "originalCommit": "6d341da7763293d9e287aa55db88544f8615782c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTg3NjkzMw==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/698#discussion_r411876933", "bodyText": "Yeah left over from the split.", "author": "Nana-EC", "createdAt": "2020-04-21T05:20:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTc4MDUxMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTc4MTE0Mw==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/698#discussion_r411781143", "bodyText": "Please also change other 'asc'/'desc' strings in this file to use constants.orderFilterValues too.", "author": "apeksharma", "createdAt": "2020-04-21T00:25:24Z", "path": "hedera-mirror-rest/utils.js", "diffHunk": "@@ -113,44 +118,44 @@ const filterValidityChecks = function (param, op, val) {\n   }\n \n   // Validate operator\n-  if (!/^(gte?|lte?|eq|ne)$/.test(op)) {\n+  if (!isValidOperatorQuery(op)) {\n     return ret;\n   }\n \n   // Validate the value\n   switch (param) {\n-    case filterKeys.ACCOUNT_ID:\n+    case constants.filterKeys.ACCOUNT_ID:\n       // Accepted forms: shard.realm.num or num\n       ret = isValidEntityNum(val);\n       break;\n-    case filterKeys.TIMESTAMP:\n+    case constants.filterKeys.TIMESTAMP:\n       ret = isValidTimestampParam(val);\n       break;\n-    case filterKeys.ACCOUNT_BALANCE:\n+    case constants.filterKeys.ACCOUNT_BALANCE:\n       // Accepted forms: Upto 50 billion\n-      ret = /^\\d{1,19}$/.test(val);\n+      ret = isValidAccountBalanceQuery(val);\n       break;\n-    case filterKeys.ACCOUNT_PUBLICKEY:\n+    case constants.filterKeys.ACCOUNT_PUBLICKEY:\n       // Acceptable forms: exactly 64 characters or +12 bytes (DER encoded)\n-      ret = /^[0-9a-fA-F]{64}$/.test(val) || /^[0-9a-fA-F]{88}$/.test(val);\n+      ret = isValidPublicKeyQuery(val);\n       break;\n-    case filterKeys.LIMIT:\n+    case constants.filterKeys.LIMIT:\n       // Acceptable forms: upto 4 digits\n       ret = isValidLimitNum(val);\n       break;\n-    case filterKeys.ORDER:\n+    case constants.filterKeys.ORDER:\n       // Acceptable words: asc or desc\n-      ret = ['asc', 'desc'].includes(val);\n+      ret = Object.values(constants.orderFilterValues).includes(val);", "originalCommit": "6d341da7763293d9e287aa55db88544f8615782c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTg4ODA1NQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/698#discussion_r411888055", "bodyText": "Done", "author": "Nana-EC", "createdAt": "2020-04-21T05:50:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTc4MTE0Mw=="}], "type": "inlineReview"}, {"oid": "bfcfea8b828d0439b5ac652ea39157094e3972ad", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/bfcfea8b828d0439b5ac652ea39157094e3972ad", "message": "Addressed feedback on namings\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2020-04-21T05:48:34Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjI5NTY5MQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/698#discussion_r412295691", "bodyText": "nit: const", "author": "steven-sheehy", "createdAt": "2020-04-21T15:55:45Z", "path": "hedera-mirror-rest/server.js", "diffHunk": "@@ -19,20 +19,15 @@\n  */\n 'uses strict';\n \n+// external libraries\n const express = require('express');\n const {addAsync} = require('@awaitjs/express');\n const bodyParser = require('body-parser');\n-let Pool;\n-if (process.env.NODE_ENV !== 'test') {\n-  Pool = require('pg').Pool;\n-} else {\n-  Pool = require('./__tests__/mockpool.js'); // Use a mocked up DB for jest unit tests\n-}\n-const app = addAsync(express());\n const cors = require('cors');\n const log4js = require('log4js');\n-const logger = log4js.getLogger();\n+var compression = require('compression');", "originalCommit": "bfcfea8b828d0439b5ac652ea39157094e3972ad", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjM2MTQ0Ng==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/698#discussion_r412361446", "bodyText": "Fixed", "author": "Nana-EC", "createdAt": "2020-04-21T17:43:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjI5NTY5MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjMwNzkwMA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/698#discussion_r412307900", "bodyText": "/topic/:id/message. Also update tests with the same.", "author": "steven-sheehy", "createdAt": "2020-04-21T16:30:45Z", "path": "hedera-mirror-rest/server.js", "diffHunk": "@@ -110,8 +113,8 @@ app.getAsync(apiPrefix + '/topic/message/:consensusTimestamp', topicmessage.getM\n app.getAsync(apiPrefix + '/topic/:id/message/:sequencenumber', topicmessage.getMessageByTopicAndSequenceRequest);\n app.getAsync(apiPrefix + '/topics/:id/messages/:sequencenumber', topicmessage.getMessageByTopicAndSequenceRequest);\n \n-app.getAsync(apiPrefix + '/topics/:id', topicmessage.getTopicMessages);\n-app.getAsync(apiPrefix + '/topic/:id', topicmessage.getTopicMessages);\n+app.getAsync(apiPrefix + '/topics/:id/messages', topicmessage.getTopicMessages);\n+app.getAsync(apiPrefix + '/topic/:id/messages', topicmessage.getTopicMessages);", "originalCommit": "bfcfea8b828d0439b5ac652ea39157094e3972ad", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjM1NzYyMQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/698#discussion_r412357621", "bodyText": "I disagree on this one. We're dealing with a collection here so the plural name makes sense and is consistent with the rest of the API.\nI definitely subscribe to the standard of REST API endpoints should be plural unless the entity is singular in nature", "author": "Nana-EC", "createdAt": "2020-04-21T17:38:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjMwNzkwMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjM4NzYzNw==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/698#discussion_r412387637", "bodyText": "Had a group discussion on this.\nWill open a ticket to address inconsistencies of singular vs plural on the topic endpoints.\nPlan here is to leave as is as next spring the likelihood is to make everything plural", "author": "Nana-EC", "createdAt": "2020-04-21T18:20:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjMwNzkwMA=="}], "type": "inlineReview"}, {"oid": "a370dc60f1fc3899c01e040a5b5ca13fd232d4f5", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/a370dc60f1fc3899c01e040a5b5ca13fd232d4f5", "message": "Addressed nit on var\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2020-04-21T17:43:13Z", "type": "commit"}]}