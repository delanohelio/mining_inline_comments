{"pr_number": 1125, "pr_title": "HTS: Token REST API", "pr_createdAt": "2020-10-12T18:47:08Z", "pr_url": "https://github.com/hashgraph/hedera-mirror-node/pull/1125", "timeline": [{"oid": "96edec3173c4031e07ac896756df6f2c84ebd25f", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/96edec3173c4031e07ac896756df6f2c84ebd25f", "message": "HTS: REST Token Info\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2020-10-15T03:28:07Z", "type": "commit"}, {"oid": "8bf9b9478fec118f78f8597100400db2aa4f9bc8", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/8bf9b9478fec118f78f8597100400db2aa4f9bc8", "message": "Added format test\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2020-10-15T03:34:13Z", "type": "commit"}, {"oid": "8bf9b9478fec118f78f8597100400db2aa4f9bc8", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/8bf9b9478fec118f78f8597100400db2aa4f9bc8", "message": "Added format test\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2020-10-15T03:34:13Z", "type": "forcePushed"}, {"oid": "858c11b050aa8ac1efe584009623327190ed7902", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/858c11b050aa8ac1efe584009623327190ed7902", "message": "Update token info row formating\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2020-10-15T03:56:08Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTYxOTc0Mg==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1125#discussion_r505619742", "bodyText": "I thought Xin's PR renamed this to entities? Are these all accounts or are some tokens? Can you please always put the types so it's clear. I think these are defaulting to account type.", "author": "steven-sheehy", "createdAt": "2020-10-15T15:06:27Z", "path": "hedera-mirror-rest/__tests__/specs/token-info-01-no-args.spec.json", "diffHunk": "@@ -0,0 +1,63 @@\n+{\n+  \"description\": \"Token info api call for a given token\",\n+  \"setup\": {\n+    \"accounts\": [", "originalCommit": "858c11b050aa8ac1efe584009623327190ed7902", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTcwNjgzNQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1125#discussion_r505706835", "bodyText": "Yeah, left over logic missed in merge. Will update.\nLooks like not all the token specs are using entities.\nSo I might update those too", "author": "Nana-EC", "createdAt": "2020-10-15T17:12:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTYxOTc0Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTYyMjQ0MA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1125#discussion_r505622440", "bodyText": "Alphabetic sort of keys, please. Even primary keys.", "author": "steven-sheehy", "createdAt": "2020-10-15T15:09:39Z", "path": "hedera-mirror-rest/tokens.js", "diffHunk": "@@ -103,6 +108,28 @@ const formatTokenRow = (row) => {\n   };\n };\n \n+const formatTokenInfoRow = (row) => {\n+  return {\n+    token_id: EntityId.fromString(row.token_id).toString(),", "originalCommit": "858c11b050aa8ac1efe584009623327190ed7902", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTcwNjkzNA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1125#discussion_r505706934", "bodyText": "Can do", "author": "Nana-EC", "createdAt": "2020-10-15T17:12:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTYyMjQ0MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTYyNDYwOQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1125#discussion_r505624609", "bodyText": "This is weird and inefficient. Why do we not have a separate fromNumber(num) that can handle null?", "author": "steven-sheehy", "createdAt": "2020-10-15T15:12:22Z", "path": "hedera-mirror-rest/tokens.js", "diffHunk": "@@ -103,6 +108,28 @@ const formatTokenRow = (row) => {\n   };\n };\n \n+const formatTokenInfoRow = (row) => {\n+  return {\n+    token_id: EntityId.fromString(row.token_id).toString(),\n+    symbol: row.symbol,\n+    treasury_account_id: EntityId.fromString(row.treasury_account_id).toString(),\n+    freeze_default: row.freeze_default,\n+    admin_key: utils.encodeKey(row.key),\n+    kyc_key: utils.encodeKey(row.kyc_key),\n+    freeze_key: utils.encodeKey(row.freeze_key),\n+    supply_key: utils.encodeKey(row.supply_key),\n+    wipe_key: utils.encodeKey(row.wipe_key),\n+    created_timestamp: utils.nsToSecNs(row.created_timestamp),\n+    decimals: row.decimals,\n+    initial_supply: row.initial_supply,\n+    total_supply: row.total_supply,\n+    expiry_timestamp: row.exp_time_ns,\n+    auto_renew_account:\n+      row.auto_renew_account_id === null ? null : EntityId.fromString(row.auto_renew_account_id.toString()).toString(),", "originalCommit": "858c11b050aa8ac1efe584009623327190ed7902", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTcwNzE4Ng==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1125#discussion_r505707186", "bodyText": "Yeah, better to move into that function or have one that handles num", "author": "Nana-EC", "createdAt": "2020-10-15T17:12:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTYyNDYwOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTcwNzk4OQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1125#discussion_r505707989", "bodyText": "I don't think explicitly toString() is needed, since auto_renew_account_id is of type bigint, pg pool will present it as string. So the value is either null or the encoded entity ID string.", "author": "xin-hedera", "createdAt": "2020-10-15T17:14:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTYyNDYwOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTcyNjg0OA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1125#discussion_r505726848", "bodyText": "We'd still need a conversion to string in the non null case.\nI'll configure the fromInt and update the Entity.toString() to handle nullable for more general usage", "author": "Nana-EC", "createdAt": "2020-10-15T17:45:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTYyNDYwOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTgwMTg0Nw==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1125#discussion_r505801847", "bodyText": "So all the response values are indeed String, hence why Xin updated the fromString method.\nI've added a isNullable param for table columns that may be null.\nAlso added the fromInt method that can be used which fromString utilizes", "author": "Nana-EC", "createdAt": "2020-10-15T19:54:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTYyNDYwOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTY0NjMyMQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1125#discussion_r505646321", "bodyText": "should use results.rows.length. rowCount is not really rows.length, though for this query, they have the same value. https://node-postgres.com/api/result\nnit: it's easier to read in this way:\nif (results.rows.length !== 1) {\n  throw new NotFoundError();\n}\n\n// normal processing", "author": "xin-hedera", "createdAt": "2020-10-15T15:41:43Z", "path": "hedera-mirror-rest/tokens.js", "diffHunk": "@@ -336,7 +383,28 @@ const getTokenBalances = async (req, res) => {\n     });\n };\n \n+const getToken = async (pgSqlQuery, pgSqlParams) => {\n+  if (logger.isTraceEnabled()) {\n+    logger.trace(`getTokenInfo query: ${pgSqlQuery}, params: ${pgSqlParams}`);\n+  }\n+\n+  return pool\n+    .query(pgSqlQuery, pgSqlParams)\n+    .catch((err) => {\n+      throw new DbError(err.message);\n+    })\n+    .then((results) => {\n+      if (results.rowCount === 1) {", "originalCommit": "858c11b050aa8ac1efe584009623327190ed7902", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTcwNzMwNA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1125#discussion_r505707304", "bodyText": "Will take your suggestion", "author": "Nana-EC", "createdAt": "2020-10-15T17:12:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTY0NjMyMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTY0ODgzOA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1125#discussion_r505648838", "bodyText": "it's changed to tokenId in token balances API", "author": "xin-hedera", "createdAt": "2020-10-15T15:45:12Z", "path": "hedera-mirror-rest/__tests__/specs/token-info-02-invalid-id.spec.json", "diffHunk": "@@ -0,0 +1,54 @@\n+{\n+  \"description\": \"Token info api call for a given token\",\n+  \"setup\": {\n+    \"accounts\": [\n+      {\n+        \"entity_num\": 1\n+      },\n+      {\n+        \"entity_num\": 1135\n+      },\n+      {\n+        \"entity_realm\": 7,\n+        \"entity_num\": 25301\n+      },\n+      {\n+        \"entity_realm\": 23,\n+        \"entity_num\": 45678\n+      }\n+    ],\n+    \"tokens\": [\n+      {\n+        \"token_id\": \"0.0.1\",\n+        \"symbol\": \"FIRSTMOVERLPDJH\"\n+      },\n+      {\n+        \"token_id\": \"0.0.1135\",\n+        \"symbol\": \"ORIGINALRDKSE\"\n+      },\n+      {\n+        \"token_id\": \"0.7.25301\",\n+        \"symbol\": \"MIRRORTOKEN\"\n+      },\n+      {\n+        \"token_id\": \"0.23.45678\",\n+        \"symbol\": \"HEDERACOIN\"\n+      }\n+    ],\n+    \"balances\": [],\n+    \"transactions\": [],\n+    \"cryptotransfers\": [],\n+    \"tokentransfers\": []\n+  },\n+  \"url\": \"/api/v1/tokens/abc\",\n+  \"responseStatus\": 400,\n+  \"responseJson\": {\n+    \"_status\": {\n+      \"messages\": [\n+        {\n+          \"message\": \"Invalid parameter: token.id\"", "originalCommit": "858c11b050aa8ac1efe584009623327190ed7902", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTcwNzUzNQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1125#discussion_r505707535", "bodyText": "Will update, missed this as part of merge", "author": "Nana-EC", "createdAt": "2020-10-15T17:13:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTY0ODgzOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTcxNjA5MA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1125#discussion_r505716090", "bodyText": "Actually, this is referring to the path param not the query param.\nThe /tokens endpoint still uses the token.id noted in constants.filterKeys.TOKEN_ID which as we noted would be used when multiple entities are used in a query. So I won't remove that constant", "author": "Nana-EC", "createdAt": "2020-10-15T17:28:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTY0ODgzOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTcxNzc0MA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1125#discussion_r505717740", "bodyText": "I added a constants.filterKeys.TOKENID that can be used and cases where there are multi entity filters would still want to use the constants.filterKeys.TOKEN_ID", "author": "Nana-EC", "createdAt": "2020-10-15T17:30:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTY0ODgzOA=="}], "type": "inlineReview"}, {"oid": "ff4e1f138b4a4d967c9530ea1cdf5b69d12875e6", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/ff4e1f138b4a4d967c9530ea1cdf5b69d12875e6", "message": "Updated Entity fromString to handle nulls and added fromInt method. Address other feeedback also\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2020-10-15T19:59:44Z", "type": "commit"}]}