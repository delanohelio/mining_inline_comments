{"pr_number": 726, "pr_title": "Added running_hash_version migration", "pr_createdAt": "2020-04-29T20:23:26Z", "pr_url": "https://github.com/hashgraph/hedera-mirror-node/pull/726", "timeline": [{"oid": "207809aa02b4419543dc979ecc3aacfa4c8edabf", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/207809aa02b4419543dc979ecc3aacfa4c8edabf", "message": "Migrate db to add runningHashVersion\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2020-04-29T20:18:14Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzYwMjk3NQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/726#discussion_r417602975", "bodyText": "Thinking of maybe changing this to 'hedera.service.v05-deployDate' & 'hedera.service.runningHashDefaultVersion'", "author": "Nana-EC", "createdAt": "2020-04-29T20:50:19Z", "path": "docs/configuration.md", "diffHunk": "@@ -68,6 +68,8 @@ value, it is recommended to only populate overridden properties in the custom `a\n | `hedera.mirror.importer.parser.record.persist.nonFeeTransfers`       | false                   | Persist non-fee transfers for transactions that explicitly request hbar transfers              |\n | `hedera.mirror.importer.parser.record.persist.systemFiles`           | true                    | Persist only system files (number lower than `1000`) to the database                           |\n | `hedera.mirror.importer.parser.record.persist.transactionBytes`      | false                   | Persist raw transaction bytes to the database                                                  |\n+| `hedera.mirror.importer.r5-rc4-deployDate`                           | 1588636800000000001     | The deployment date of the r5-rc4 version which introduced the running hash version            |", "originalCommit": "207809aa02b4419543dc979ecc3aacfa4c8edabf", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzYwMzQxMg==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/726#discussion_r417603412", "bodyText": "Will remove to ensure it's correctly set at deployment time. Will leave tests", "author": "Nana-EC", "createdAt": "2020-04-29T20:51:08Z", "path": "hedera-mirror-importer/src/main/resources/application.yml", "diffHunk": "@@ -9,6 +9,9 @@ hedera:\n         restPassword: mirror_api_pass\n         restUsername: mirror_api\n         username: mirror_node\n+      # service r5-rc4 deployDate in consensus_timestamp format e.g. 1588636800000000001, must be set for v1.23.1 migration\n+      r5-rc4-deployDate: 1588636800000000001", "originalCommit": "207809aa02b4419543dc979ecc3aacfa4c8edabf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzYxMzUzMw==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/726#discussion_r417613533", "bodyText": "How will you ensure it's properly set? Does it fail if unset?", "author": "steven-sheehy", "createdAt": "2020-04-29T21:09:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzYwMzQxMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzYxODkxNw==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/726#discussion_r417618917", "bodyText": "Thought I could remove but looks like I can't. It fails if unset. Setting to the expected testnet deployment for now", "author": "Nana-EC", "createdAt": "2020-04-29T21:20:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzYwMzQxMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzYyMDEyMQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/726#discussion_r417620121", "bodyText": "Don't we want it to fail? We want all the tests to have a default so they don't fail but we want deploys to fail.", "author": "steven-sheehy", "createdAt": "2020-04-29T21:22:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzYwMzQxMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzU5OTgzOA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/726#discussion_r417599838", "bodyText": "I don't think a runningHashDefaultVersion provides any value. I assume it was added in case a 3rd party runs this much later when a runningHashVersion=3+ is available? But in that case the migration logic is wrong either way as it doesn't differentiate v2 from v3 rows properly.", "author": "steven-sheehy", "createdAt": "2020-04-29T20:44:30Z", "path": "docs/configuration.md", "diffHunk": "@@ -68,6 +68,8 @@ value, it is recommended to only populate overridden properties in the custom `a\n | `hedera.mirror.importer.parser.record.persist.nonFeeTransfers`       | false                   | Persist non-fee transfers for transactions that explicitly request hbar transfers              |\n | `hedera.mirror.importer.parser.record.persist.systemFiles`           | true                    | Persist only system files (number lower than `1000`) to the database                           |\n | `hedera.mirror.importer.parser.record.persist.transactionBytes`      | false                   | Persist raw transaction bytes to the database                                                  |\n+| `hedera.mirror.importer.r5-rc4-deployDate`                           | 1588636800000000001     | The deployment date of the r5-rc4 version which introduced the running hash version            |\n+| `hedera.mirror.importer.runningHashDefaultVersion`                   | 2                       | The default running hash version used by service. Is 2 as of r5-rc4                            |", "originalCommit": "207809aa02b4419543dc979ecc3aacfa4c8edabf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzYxOTkwNg==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/726#discussion_r417619906", "bodyText": "Yeah exactly. Added in case migration happens much later and the version is now > 2.\nWould it be better to remove this altogether and just hard code 2 or make the current version of 1 also configurable?", "author": "Nana-EC", "createdAt": "2020-04-29T21:22:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzU5OTgzOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzY1ODMwOA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/726#discussion_r417658308", "bodyText": "Removed", "author": "Nana-EC", "createdAt": "2020-04-29T22:51:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzU5OTgzOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzYwMzE1Mw==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/726#discussion_r417603153", "bodyText": "Should be named after the field being added and not the release name. Maybe hedera.mirror.importer.runningHashVersionAdded. Comments should mention it's a Unix timestamp not a date. Not sure default needs to be nanosecond resolution.", "author": "steven-sheehy", "createdAt": "2020-04-29T20:50:41Z", "path": "docs/configuration.md", "diffHunk": "@@ -68,6 +68,8 @@ value, it is recommended to only populate overridden properties in the custom `a\n | `hedera.mirror.importer.parser.record.persist.nonFeeTransfers`       | false                   | Persist non-fee transfers for transactions that explicitly request hbar transfers              |\n | `hedera.mirror.importer.parser.record.persist.systemFiles`           | true                    | Persist only system files (number lower than `1000`) to the database                           |\n | `hedera.mirror.importer.parser.record.persist.transactionBytes`      | false                   | Persist raw transaction bytes to the database                                                  |\n+| `hedera.mirror.importer.r5-rc4-deployDate`                           | 1588636800000000001     | The deployment date of the r5-rc4 version which introduced the running hash version            |", "originalCommit": "207809aa02b4419543dc979ecc3aacfa4c8edabf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzYyMDkyNQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/726#discussion_r417620925", "bodyText": "Good suggestion. I made it nanosecond resolution cause of the row level comparison made of consensustimestamps. I didn't want there to be any need for data types conversion or confusion during the migration", "author": "Nana-EC", "createdAt": "2020-04-29T21:24:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzYwMzE1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzYyNzA1MQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/726#discussion_r417627051", "bodyText": "Merging this suggestion and Appy's below to go with 'hcsRunningHashV2AddedTimestamp'", "author": "Nana-EC", "createdAt": "2020-04-29T21:36:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzYwMzE1Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzYwNDEyOQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/726#discussion_r417604129", "bodyText": "alter table if exists", "author": "steven-sheehy", "createdAt": "2020-04-29T20:52:24Z", "path": "hedera-mirror-importer/src/main/resources/db/migration/V1.23.1__add_topicmessage_runninghashversion.sql", "diffHunk": "@@ -0,0 +1,5 @@\n+-- add the running_hash_version column conditionally\n+alter table topic_message add column if not exists running_hash_version smallint null;", "originalCommit": "207809aa02b4419543dc979ecc3aacfa4c8edabf", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzYwNDMwOQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/726#discussion_r417604309", "bodyText": "int like the schema", "author": "steven-sheehy", "createdAt": "2020-04-29T20:52:43Z", "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/domain/TopicMessage.java", "diffHunk": "@@ -44,4 +44,6 @@\n     private long sequenceNumber;\n \n     private int topicNum;\n+\n+    private long runningHashVersion;", "originalCommit": "207809aa02b4419543dc979ecc3aacfa4c8edabf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzYzMDkzOA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/726#discussion_r417630938", "bodyText": "I thought that too but the transaction receipt proto returns this as long, so I opted for that and converting at write time.\nCan flip it", "author": "Nana-EC", "createdAt": "2020-04-29T21:44:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzYwNDMwOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzYwNTcyMw==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/726#discussion_r417605723", "bodyText": "Mixing case with previous statement. Prefer all lowercase to match majority of other migrations", "author": "steven-sheehy", "createdAt": "2020-04-29T20:55:15Z", "path": "hedera-mirror-importer/src/main/resources/db/migration/V1.23.1__add_topicmessage_runninghashversion.sql", "diffHunk": "@@ -0,0 +1,5 @@\n+-- add the running_hash_version column conditionally\n+alter table topic_message add column if not exists running_hash_version smallint null;\n+\n+-- set rows with empty running_hash_version to 1 if r5-rc4 is not yet released and to the default value if it is\n+UPDATE topic_message SET running_hash_version = CASE WHEN consensus_timestamp < ${r5-rc4-deployDate} THEN 1 ELSE ${runningHashDefaultVersion} END WHERE running_hash_version IS NULL;", "originalCommit": "207809aa02b4419543dc979ecc3aacfa4c8edabf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzYzMTEyNQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/726#discussion_r417631125", "bodyText": "Also prefer lowercase myself. Missed this in my cleanup", "author": "Nana-EC", "createdAt": "2020-04-29T21:44:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzYwNTcyMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzYwNzA3Mg==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/726#discussion_r417607072", "bodyText": "Column should be constrained to be not null by the end of this migration. Can add an additional statement to add the constraint or can set to not null here and set a default of 0 or -1.", "author": "steven-sheehy", "createdAt": "2020-04-29T20:57:47Z", "path": "hedera-mirror-importer/src/main/resources/db/migration/V1.23.1__add_topicmessage_runninghashversion.sql", "diffHunk": "@@ -0,0 +1,5 @@\n+-- add the running_hash_version column conditionally\n+alter table topic_message add column if not exists running_hash_version smallint null;", "originalCommit": "207809aa02b4419543dc979ecc3aacfa4c8edabf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzYzNDA2Nw==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/726#discussion_r417634067", "bodyText": "Good suggestion. Will add the constraint", "author": "Nana-EC", "createdAt": "2020-04-29T21:51:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzYwNzA3Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzY1ODcxMw==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/726#discussion_r417658713", "bodyText": "This enforced some changes to grpc end for writing. Will leave rest of logic for PR that will expose this in the API's", "author": "Nana-EC", "createdAt": "2020-04-29T22:52:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzYwNzA3Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzYwODI3MQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/726#discussion_r417608271", "bodyText": "Missing similar change in integrationDbOps.js", "author": "steven-sheehy", "createdAt": "2020-04-29T21:00:04Z", "path": "hedera-mirror-rest/config/.node-flywaydb.integration.conf", "diffHunk": "@@ -1,14 +1,16 @@\n module.exports = {\n     flywayArgs: {\n         'placeholders.api-user': 'mirror_api'\n-        ,'placeholders.api-password': 'mirror_api_pass'\n-        ,'placeholders.db-name': 'mirror_node_integration'\n-        ,'placeholders.db-user': 'mirror_node'\n+        , 'placeholders.api-password': 'mirror_api_pass'", "originalCommit": "207809aa02b4419543dc979ecc3aacfa4c8edabf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzY1ODg3Mg==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/726#discussion_r417658872", "bodyText": "Added thanks", "author": "Nana-EC", "createdAt": "2020-04-29T22:53:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzYwODI3MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzYwODcyMg==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/726#discussion_r417608722", "bodyText": "Missing similar change in datagenerator", "author": "steven-sheehy", "createdAt": "2020-04-29T21:00:54Z", "path": "hedera-mirror-importer/src/main/resources/application.yml", "diffHunk": "@@ -64,6 +67,8 @@ spring:\n       api-user: ${hedera.mirror.importer.db.restUsername}\n       db-name: ${hedera.mirror.importer.db.name}\n       db-user: ${hedera.mirror.importer.db.username}\n+      r5-rc4-deployDate: ${hedera.mirror.importer.r5-rc4-deployDate}", "originalCommit": "207809aa02b4419543dc979ecc3aacfa4c8edabf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzY1ODk3MQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/726#discussion_r417658971", "bodyText": "Added", "author": "Nana-EC", "createdAt": "2020-04-29T22:53:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzYwODcyMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzYxMDIxMw==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/726#discussion_r417610213", "bodyText": "This doesn't normalize 0 to 1 in case this is deployed before R5 or when processing pre-R5 transactions during catch up.", "author": "steven-sheehy", "createdAt": "2020-04-29T21:03:35Z", "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/parser/record/RecordItemParser.java", "diffHunk": "@@ -202,7 +202,7 @@ private void insertConsensusTopicMessage(ConsensusSubmitMessageTransactionBody t\n                 Utility.timeStampInNanos(transactionRecord.getConsensusTimestamp()),\n                 transactionBody.getMessage().toByteArray(), (int) topicId.getRealmNum(),\n                 receipt.getTopicRunningHash().toByteArray(), receipt.getTopicSequenceNumber(),\n-                (int) topicId.getTopicNum());\n+                (int) topicId.getTopicNum(), receipt.getTopicRunningHashVersion());", "originalCommit": "207809aa02b4419543dc979ecc3aacfa4c8edabf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzY1OTA1Nw==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/726#discussion_r417659057", "bodyText": "Added normalize logic", "author": "Nana-EC", "createdAt": "2020-04-29T22:53:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzYxMDIxMw=="}], "type": "inlineReview"}, {"oid": "5cc441880265a7923ad5ee8a9517bc75d9b68368", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/5cc441880265a7923ad5ee8a9517bc75d9b68368", "message": "Set time to May 5th, at 19:00 UTC and updated config name\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2020-04-29T21:17:34Z", "type": "commit"}, {"oid": "30c05725aa3658ca9bb5396ef5d367d9186c6ff8", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/30c05725aa3658ca9bb5396ef5d367d9186c6ff8", "message": "Address feedback on naming and constraints\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2020-04-29T22:45:53Z", "type": "commit"}, {"oid": "f3bfbfdb1fd00512156d99b79273c38e93a3dc24", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/f3bfbfdb1fd00512156d99b79273c38e93a3dc24", "message": "Merged record to entity refactor\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2020-04-29T22:50:06Z", "type": "commit"}, {"oid": "0251807ccc4fceabea84c488956ca6745e17dd36", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/0251807ccc4fceabea84c488956ca6745e17dd36", "message": "Fixed repeated runing_hash column\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2020-04-29T22:58:20Z", "type": "commit"}, {"oid": "9d9ae7310f0265e609b99db39486be0f047fdb05", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/9d9ae7310f0265e609b99db39486be0f047fdb05", "message": "Removed value of topicRunningHashV2AddedTimestamp to enforce deployment time set\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2020-04-29T23:10:31Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzcwMzg5Mw==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/726#discussion_r417703893", "bodyText": "I wouldn't think this line would be necessary.", "author": "steven-sheehy", "createdAt": "2020-04-30T01:23:57Z", "path": "hedera-mirror-importer/src/test/resources/application-default.yml", "diffHunk": "@@ -12,7 +12,12 @@ hedera:\n         exclude:\n           - entity: 0.0.999\n       network: TESTNET\n+      # timestamp service added running hash v2 in Unix timestamp format e.g. 1588705200000000000, must be set for v1.23.1 migration\n+      topicRunningHashV2AddedTimestamp: 1588705200000000000\n spring:\n   task:\n     scheduling:\n       enabled: false\n+  flyway:\n+    placeholders:\n+      topicRunningHashV2AddedTimestamp: ${hedera.mirror.importer.topicRunningHashV2AddedTimestamp}", "originalCommit": "9d9ae7310f0265e609b99db39486be0f047fdb05", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzcxMzA5OA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/726#discussion_r417713098", "bodyText": "set to 0", "author": "apeksharma", "createdAt": "2020-04-30T02:00:52Z", "path": "hedera-mirror-grpc/src/test/resources/application-default.yml", "diffHunk": "@@ -36,3 +36,4 @@ spring:\n       api-user: mirror_api\n       db-name: ${hedera.mirror.grpc.db.name}\n       db-user: ${hedera.mirror.grpc.db.username}\n+      topicRunningHashV2AddedTimestamp: 1588705200000000000", "originalCommit": "9d9ae7310f0265e609b99db39486be0f047fdb05", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzcxMzIyNA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/726#discussion_r417713224", "bodyText": "set to 0", "author": "apeksharma", "createdAt": "2020-04-30T02:01:23Z", "path": "hedera-mirror-datagenerator/src/main/resources/application.yml", "diffHunk": "@@ -59,3 +59,4 @@ spring:\n       api-user: ${hedera.mirror.datagenerator.db.restUsername}\n       db-name: ${hedera.mirror.datagenerator.db.name}\n       db-user: ${hedera.mirror.datagenerator.db.username}\n+      topicRunningHashV2AddedTimestamp: 1588705200000000000", "originalCommit": "9d9ae7310f0265e609b99db39486be0f047fdb05", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzcyMjYxOQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/726#discussion_r417722619", "bodyText": "This configuration represents time of an event which hasn't happened yet. It shouldn't have a value unless the real value is known.\nUse 0 to represent undefined.\nMigration\nupdate topic_message\nset running_hash_version =\n    case\n        when ${topicRunningHashV2AddedTimestamp} == 0 then 1\n        else case \n            when consensus_timestamp < ${topicRunningHashV2AddedTimestamp} then 1\n            else 2\n        end\n    end\nwhere running_hash_version is null;\n\nThen set the config to 0 for all tests since they start with clean db.", "author": "apeksharma", "createdAt": "2020-04-30T02:40:10Z", "path": "docs/configuration.md", "diffHunk": "@@ -69,6 +69,7 @@ value, it is recommended to only populate overridden properties in the custom `a\n | `hedera.mirror.importer.parser.record.persist.systemFiles`           | true                    | Persist only system files (number lower than `1000`) to the database                           |\n | `hedera.mirror.importer.parser.record.persist.transactionBytes`      | false                   | Persist raw transaction bytes to the database                                                  |\n | `hedera.mirror.importer.parser.record.sql.batchSize`                 | 100                     | When inserting transactions into db, executeBatches() is called every these many transactions  |\n+| `hedera.mirror.importer.topicRunningHashV2AddedTimestamp`            | 1588636800000000001     | The Unix timestamp when topic message running hash v2 was introduced                           |", "originalCommit": "9d9ae7310f0265e609b99db39486be0f047fdb05", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODEyMjgxNQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/726#discussion_r418122815", "bodyText": "This is already captured by the current logic. undefined is captured by not defining the value by default in the application.yml file used for deployment.\nI'm not sure we want to set a default 0 there and have people forget to set it.\nOn the test side the logic as is also sufficient. Setting to 0 hides the fact that versions 1 & 2 will exist in the db. We want to naturally get that reflection of production data as tests run with historic and new messages.\nAlso once we've confirmed the deployment time this value will be set appropriately.\nGonna think on this more but that's my current thinking.", "author": "Nana-EC", "createdAt": "2020-04-30T16:06:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzcyMjYxOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzcyMzM5Nw==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/726#discussion_r417723397", "bodyText": "comment can be made more useful\n\"Used for setting running hash version of topic messages when migrating from v1 to v2. If non-zero, all messages with consensusTimestamp >= this value will be marked version 2, and those less will be marked version 1. If zero, all messages are marked version 1\"", "author": "apeksharma", "createdAt": "2020-04-30T02:43:37Z", "path": "hedera-mirror-importer/src/main/resources/application.yml", "diffHunk": "@@ -9,6 +9,8 @@ hedera:\n         restPassword: mirror_api_pass\n         restUsername: mirror_api\n         username: mirror_node\n+      # service v05 AddedTimestamp in consensus_timestamp format e.g. 1588636800000000001, must be set for v1.23.1 migration", "originalCommit": "9d9ae7310f0265e609b99db39486be0f047fdb05", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODEyNTA4OQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/726#discussion_r418125089", "bodyText": "Will update in a future PR but  will apply to the v0.10.0 patch", "author": "Nana-EC", "createdAt": "2020-04-30T16:10:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzcyMzM5Nw=="}], "type": "inlineReview"}]}