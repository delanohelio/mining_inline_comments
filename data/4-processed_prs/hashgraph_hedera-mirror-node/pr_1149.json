{"pr_number": 1149, "pr_title": "Rosetta: Github Workflow (build, test, codecov, cli-validation)", "pr_createdAt": "2020-10-19T11:35:43Z", "pr_url": "https://github.com/hashgraph/hedera-mirror-node/pull/1149", "timeline": [{"oid": "7c0495f41275619360c2a00059e8cd2a3371fd2a", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/7c0495f41275619360c2a00059e8cd2a3371fd2a", "message": "Infra/rosetta workflow (#153)\n\nSigned-off-by: Daniel Ivanov <daniel.k.ivanov95@gmail.com>\r\nSigned-off-by: Daniel <Daniel.K.Ivanov95@gmail.com>", "committedDate": "2020-10-19T11:30:15Z", "type": "commit"}, {"oid": "b517770b7d54368f474b736f8dbea7521473e374", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/b517770b7d54368f474b736f8dbea7521473e374", "message": "remove gitignore changes\n\nSigned-off-by: Daniel Ivanov <daniel.k.ivanov95@gmail.com>", "committedDate": "2020-10-19T11:33:33Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzgyMzg4Nw==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1149#discussion_r507823887", "bodyText": "nit: Couple extra spaces", "author": "steven-sheehy", "createdAt": "2020-10-19T14:59:54Z", "path": ".github/workflows/rosetta-api.yml", "diffHunk": "@@ -0,0 +1,54 @@\n+name: Rosetta API\n+\n+on: pull_request\n+\n+env:\n+    working-directory: ./hedera-mirror-rosetta", "originalCommit": "b517770b7d54368f474b736f8dbea7521473e374", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzgyNDA0Nw==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1149#discussion_r507824047", "bodyText": "This seems brittle and slow. Can we add a health check to the Dockerfile and wait for it to become ready here? Health check should curl the Rosetta API, I would think.", "author": "steven-sheehy", "createdAt": "2020-10-19T15:00:04Z", "path": ".github/workflows/rosetta-api.yml", "diffHunk": "@@ -0,0 +1,54 @@\n+name: Rosetta API\n+\n+on: pull_request\n+\n+env:\n+    working-directory: ./hedera-mirror-rosetta\n+    image-tag: mirror-node\n+\n+jobs:\n+  build:\n+    runs-on: ubuntu-latest\n+    steps:\n+      - uses: actions/checkout@v2\n+      - uses: actions/setup-go@v2\n+        name: Setup GO Env\n+        with:\n+          go-version: '1.13'\n+      - name: Build hedera-mirror-rosetta\n+        run: go build -i -o rosetta cmd/*\n+        working-directory: ${{env.working-directory}}\n+      - name: Upload Binary as artifact\n+        uses: actions/upload-artifact@master\n+        with:\n+          name: hedera-mirror-rosetta\n+          path: ${{ env.working-directory }}/rosetta\n+          if-no-files-found: error\n+  test:\n+    runs-on: ubuntu-latest\n+    steps:\n+      - uses: actions/checkout@v2\n+      - uses: actions/setup-go@v2\n+        name: Setup GO Env\n+        with:\n+          go-version: '1.13'\n+      - name: Run Unit Tests with Coverage\n+        run: go test ./... -coverpkg=./... -race -coverprofile=coverage.txt -covermode=atomic\n+        working-directory: ${{env.working-directory}}\n+      - name: Upload Coverage report to CodeCov\n+        run: bash <(curl -s https://codecov.io/bash)\n+        working-directory: ${{env.working-directory}}\n+  cli-validation:\n+    runs-on: ubuntu-latest\n+    steps:\n+      - uses: actions/checkout@v2\n+      - name: Build Mirror Node\n+        run: docker build --tag=${{env.image-tag}} .\n+        working-directory: ${{env.working-directory}}/build\n+      - name: Run Mirror Node\n+        run: docker run -d -p 5700:5700 ${{env.image-tag}}\n+      - name: Wait for Mirror Node to start (60s)\n+        run: sleep 60", "originalCommit": "b517770b7d54368f474b736f8dbea7521473e374", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODUzNjE5Mg==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1149#discussion_r508536192", "bodyText": "new wait-for-node script was added", "author": "Daniel-K-Ivanov", "createdAt": "2020-10-20T14:04:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzgyNDA0Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzgyNjc1Mg==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1149#discussion_r507826752", "bodyText": "Should have a task that adds go module caching", "author": "steven-sheehy", "createdAt": "2020-10-19T15:03:31Z", "path": ".github/workflows/rosetta-api.yml", "diffHunk": "@@ -0,0 +1,54 @@\n+name: Rosetta API\n+\n+on: pull_request\n+\n+env:\n+    working-directory: ./hedera-mirror-rosetta\n+    image-tag: mirror-node\n+\n+jobs:\n+  build:\n+    runs-on: ubuntu-latest\n+    steps:\n+      - uses: actions/checkout@v2\n+      - uses: actions/setup-go@v2\n+        name: Setup GO Env\n+        with:\n+          go-version: '1.13'\n+      - name: Build hedera-mirror-rosetta", "originalCommit": "b517770b7d54368f474b736f8dbea7521473e374", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzgyNjkzOA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1149#discussion_r507826938", "bodyText": "Should have a task that adds go module caching", "author": "steven-sheehy", "createdAt": "2020-10-19T15:03:46Z", "path": ".github/workflows/rosetta-api.yml", "diffHunk": "@@ -0,0 +1,54 @@\n+name: Rosetta API\n+\n+on: pull_request\n+\n+env:\n+    working-directory: ./hedera-mirror-rosetta\n+    image-tag: mirror-node\n+\n+jobs:\n+  build:\n+    runs-on: ubuntu-latest\n+    steps:\n+      - uses: actions/checkout@v2\n+      - uses: actions/setup-go@v2\n+        name: Setup GO Env\n+        with:\n+          go-version: '1.13'\n+      - name: Build hedera-mirror-rosetta\n+        run: go build -i -o rosetta cmd/*\n+        working-directory: ${{env.working-directory}}\n+      - name: Upload Binary as artifact\n+        uses: actions/upload-artifact@master\n+        with:\n+          name: hedera-mirror-rosetta\n+          path: ${{ env.working-directory }}/rosetta\n+          if-no-files-found: error\n+  test:\n+    runs-on: ubuntu-latest\n+    steps:\n+      - uses: actions/checkout@v2\n+      - uses: actions/setup-go@v2\n+        name: Setup GO Env\n+        with:\n+          go-version: '1.13'\n+      - name: Run Unit Tests with Coverage", "originalCommit": "b517770b7d54368f474b736f8dbea7521473e374", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzgyNzY4Ng==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1149#discussion_r507827686", "bodyText": "Do you have a link to this report?", "author": "steven-sheehy", "createdAt": "2020-10-19T15:04:50Z", "path": ".github/workflows/rosetta-api.yml", "diffHunk": "@@ -0,0 +1,54 @@\n+name: Rosetta API\n+\n+on: pull_request\n+\n+env:\n+    working-directory: ./hedera-mirror-rosetta\n+    image-tag: mirror-node\n+\n+jobs:\n+  build:\n+    runs-on: ubuntu-latest\n+    steps:\n+      - uses: actions/checkout@v2\n+      - uses: actions/setup-go@v2\n+        name: Setup GO Env\n+        with:\n+          go-version: '1.13'\n+      - name: Build hedera-mirror-rosetta\n+        run: go build -i -o rosetta cmd/*\n+        working-directory: ${{env.working-directory}}\n+      - name: Upload Binary as artifact\n+        uses: actions/upload-artifact@master\n+        with:\n+          name: hedera-mirror-rosetta\n+          path: ${{ env.working-directory }}/rosetta\n+          if-no-files-found: error\n+  test:\n+    runs-on: ubuntu-latest\n+    steps:\n+      - uses: actions/checkout@v2\n+      - uses: actions/setup-go@v2\n+        name: Setup GO Env\n+        with:\n+          go-version: '1.13'\n+      - name: Run Unit Tests with Coverage\n+        run: go test ./... -coverpkg=./... -race -coverprofile=coverage.txt -covermode=atomic\n+        working-directory: ${{env.working-directory}}\n+      - name: Upload Coverage report to CodeCov\n+        run: bash <(curl -s https://codecov.io/bash)", "originalCommit": "b517770b7d54368f474b736f8dbea7521473e374", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODU0NDY2MA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1149#discussion_r508544660", "bodyText": "I suppose that you are referring to:\n\nhttps://codecov.io/gh/hashgraph/hedera-mirror-node/branch/cicd%2Frosetta\n\nLatest commit:\n\nhttps://codecov.io/gh/hashgraph/hedera-mirror-node/tree/cicd%2Frosetta/hedera-mirror-rosetta\n\nActual uploaded report:\n\nhttps://codecov.io/api/gh/hashgraph/hedera-mirror-node/download/build?path=v4/raw/2020-10-20/C22318D8C79BEE934DEC507C38D4B845/05f1a621a291ae81c72a13fb6aac15642944715d/2f77ac08-004b-402e-8376-b13efa4d4ed2.txt", "author": "Daniel-K-Ivanov", "createdAt": "2020-10-20T14:14:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzgyNzY4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODYxNjY5OQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1149#discussion_r508616699", "bodyText": "Thanks", "author": "steven-sheehy", "createdAt": "2020-10-20T15:33:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzgyNzY4Ng=="}], "type": "inlineReview"}, {"oid": "5b82437a62fe4ea423d32eb53eb4623e55ac05e1", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/5b82437a62fe4ea423d32eb53eb4623e55ac05e1", "message": "remove spaces\n\nSigned-off-by: Daniel Ivanov <daniel.k.ivanov95@gmail.com>", "committedDate": "2020-10-20T06:47:44Z", "type": "commit"}, {"oid": "a94ccbd2bddcdde9f1165442563647f1650b356f", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/a94ccbd2bddcdde9f1165442563647f1650b356f", "message": "add bash script for waiting for node to start\n\nSigned-off-by: Daniel Ivanov <daniel.k.ivanov95@gmail.com>", "committedDate": "2020-10-20T07:42:44Z", "type": "commit"}, {"oid": "b96629c5edc1128f04f987bb6b4459643b389877", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/b96629c5edc1128f04f987bb6b4459643b389877", "message": "change step name\n\nSigned-off-by: Daniel Ivanov <daniel.k.ivanov95@gmail.com>", "committedDate": "2020-10-20T07:45:49Z", "type": "commit"}, {"oid": "05f1a621a291ae81c72a13fb6aac15642944715d", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/05f1a621a291ae81c72a13fb6aac15642944715d", "message": "fix wait for node script + update docs\n\nSigned-off-by: Daniel Ivanov <daniel.k.ivanov95@gmail.com>", "committedDate": "2020-10-20T14:02:48Z", "type": "commit"}, {"oid": "e7a44075b293209c552279c7d55b7082e0768801", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/e7a44075b293209c552279c7d55b7082e0768801", "message": "Ci(hedera-mirror-rosetta): Update Dockerfile + modules (#159)\n\nSigned-off-by: failfmi <oscurocalma@gmail.com>", "committedDate": "2020-10-26T11:27:31Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjcyODUzOA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1149#discussion_r512728538", "bodyText": "Can you add ${{ secrets.CACHE_VERSION }}? This was a recent addition to the java workflow to workaround GitHub never removing entries from the cache and it growing unbounded. We can clear the cache without a code change periodically with this variable.\nkey: ${{ runner.os }}-go-${{ secrets.CACHE_VERSION }}-${{ hashFiles('**/go.sum') }}", "author": "steven-sheehy", "createdAt": "2020-10-27T14:15:25Z", "path": ".github/workflows/rosetta-api.yml", "diffHunk": "@@ -0,0 +1,68 @@\n+name: Rosetta API\n+\n+on: pull_request\n+\n+env:\n+  working-directory: ./hedera-mirror-rosetta\n+  image-tag: mirror-node\n+\n+jobs:\n+  build:\n+    runs-on: ubuntu-latest\n+    steps:\n+      - uses: actions/checkout@v2\n+      - uses: actions/setup-go@v2\n+        name: Setup GO Env\n+        with:\n+          go-version: '1.13'\n+      - name: Cache Go modules\n+        uses: actions/cache@v2\n+        with:\n+          path: ~/go/pkg/mod\n+          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}", "originalCommit": "e7a44075b293209c552279c7d55b7082e0768801", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjczNjcyMA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1149#discussion_r512736720", "bodyText": "This task is failing. Can you check?", "author": "steven-sheehy", "createdAt": "2020-10-27T14:24:54Z", "path": ".github/workflows/rosetta-api.yml", "diffHunk": "@@ -0,0 +1,68 @@\n+name: Rosetta API\n+\n+on: pull_request\n+\n+env:\n+  working-directory: ./hedera-mirror-rosetta\n+  image-tag: mirror-node\n+\n+jobs:\n+  build:\n+    runs-on: ubuntu-latest\n+    steps:\n+      - uses: actions/checkout@v2\n+      - uses: actions/setup-go@v2\n+        name: Setup GO Env\n+        with:\n+          go-version: '1.13'\n+      - name: Cache Go modules\n+        uses: actions/cache@v2\n+        with:\n+          path: ~/go/pkg/mod\n+          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}\n+          restore-keys: |\n+            ${{ runner.os }}-go-\n+      - name: Build hedera-mirror-rosetta\n+        run: go build -i -o rosetta cmd/*\n+        working-directory: ${{env.working-directory}}\n+      - name: Upload Binary as artifact\n+        uses: actions/upload-artifact@master\n+        with:\n+          name: hedera-mirror-rosetta\n+          path: ${{ env.working-directory }}/rosetta\n+          if-no-files-found: error\n+  test:\n+    runs-on: ubuntu-latest\n+    steps:\n+      - uses: actions/checkout@v2\n+      - uses: actions/setup-go@v2\n+        name: Setup GO Env\n+        with:\n+          go-version: '1.13'\n+      - name: Cache Go modules\n+        uses: actions/cache@v2\n+        with:\n+          path: ~/go/pkg/mod\n+          key: ${{ runner.os }}-go-test-${{ hashFiles('**/go.sum') }}\n+          restore-keys: |\n+            ${{ runner.os }}-go-test-\n+      - name: Run Unit Tests with Coverage\n+        run: go test ./... -coverpkg=./... -race -coverprofile=coverage.txt -covermode=atomic\n+        working-directory: ${{env.working-directory}}\n+      - name: Upload Coverage report to CodeCov\n+        run: bash <(curl -s https://codecov.io/bash)\n+        working-directory: ${{env.working-directory}}\n+  cli-validation:", "originalCommit": "e7a44075b293209c552279c7d55b7082e0768801", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjgwNzM4MA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1149#discussion_r512807380", "bodyText": "Yes, this will fail until the PR with block updates is merged and then pulled on this branch.", "author": "failfmi", "createdAt": "2020-10-27T15:46:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjczNjcyMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjc0MDYyNg==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1149#discussion_r512740626", "bodyText": "set -eu -o pipefail", "author": "steven-sheehy", "createdAt": "2020-10-27T14:29:18Z", "path": "hedera-mirror-rosetta/scripts/wait-for-mirror-node.sh", "diffHunk": "@@ -0,0 +1,58 @@\n+#!/bin/bash\n+", "originalCommit": "e7a44075b293209c552279c7d55b7082e0768801", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjc2NjI3NQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1149#discussion_r512766275", "bodyText": "Validating a different Dockerfile than the one that goes to production defeats the purpose of validation. This file is guaranteed to get out of sync with the other file, especially since they're both so complicated with the all in one nature of it.\nI see your comment about We tried to make the all in one docker file \"generic\" in terms of the target it was building (current source or master). Did you try using build args to make the target branch configurable like below?\nFROM golang:1.13 as builder\nARG GIT_BRANCH=rosetta\nWORKDIR /tmp\nRUN git clone https://github.com/hashgraph/hedera-mirror-node.git\nWORKDIR /tmp/hedera-mirror-node/hedera-mirror-rosetta\nRUN git checkout \"${GIT_BRANCH}\"\nRUN go build -o rosetta-executable ./cmd\nThen you can run  docker build --build-arg GIT_BRANCH=$GITHUB_REF . in the GitHub Action. I tried this locally with the Dockefile and it seems to work fine for this purpose. This approach allows you to use git to test both local code and master and not rely on docker COPY.", "author": "steven-sheehy", "createdAt": "2020-10-27T14:59:14Z", "path": "hedera-mirror-rosetta/scripts/validation/Dockerfile", "diffHunk": "@@ -0,0 +1,87 @@\n+# This Dockerfile configuration is used to build", "originalCommit": "e7a44075b293209c552279c7d55b7082e0768801", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "a2d641c9b42dcc827d6d19714ecfc9d0a36fe071", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/a2d641c9b42dcc827d6d19714ecfc9d0a36fe071", "message": "build(rosetta): make dockerfile generic\n\nSigned-off-by: failfmi <oscurocalma@gmail.com>", "committedDate": "2020-10-27T16:43:40Z", "type": "commit"}, {"oid": "043e6e10d99926e819f2ce78ff175efe2328e3e8", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/043e6e10d99926e819f2ce78ff175efe2328e3e8", "message": "gaction(rosetta): clarify build on branch\n\nSigned-off-by: failfmi <oscurocalma@gmail.com>", "committedDate": "2020-10-27T16:52:20Z", "type": "commit"}, {"oid": "a9edc2769a6d51c0e6bcf1861a06016786d94f4a", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/a9edc2769a6d51c0e6bcf1861a06016786d94f4a", "message": "validation(rosetta): update ref to branch\n\nSigned-off-by: failfmi <oscurocalma@gmail.com>", "committedDate": "2020-10-27T16:57:09Z", "type": "commit"}, {"oid": "3b8cc289e92290e0e78f7443f925a17fa51aa015", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/3b8cc289e92290e0e78f7443f925a17fa51aa015", "message": "rosetta: wait-for-mirror-node.sh\n\nSigned-off-by: failfmi <oscurocalma@gmail.com>", "committedDate": "2020-10-27T17:15:32Z", "type": "commit"}]}