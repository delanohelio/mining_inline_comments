{"pr_number": 1251, "pr_title": "Add monitor charts", "pr_createdAt": "2020-11-09T21:25:41Z", "pr_url": "https://github.com/hashgraph/hedera-mirror-node/pull/1251", "timeline": [{"oid": "3deea342be252a38c76ad2c41fd6eeaa835529ae", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/3deea342be252a38c76ad2c41fd6eeaa835529ae", "message": "helm charts for hedera-mirror-monitor\n\nSigned-off-by: Xin Li <xin.li@swirlds.com>", "committedDate": "2020-11-09T18:47:08Z", "type": "commit"}, {"oid": "373553de9415d58231113c1970d7795706a91fd5", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/373553de9415d58231113c1970d7795706a91fd5", "message": "add headless service for service monitor\n\nSigned-off-by: Xin Li <xin.li@swirlds.com>", "committedDate": "2020-11-09T20:22:33Z", "type": "commit"}, {"oid": "83b3336a18bcc9cfc6f21919f4b414d0f6aa78e2", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/83b3336a18bcc9cfc6f21919f4b414d0f6aa78e2", "message": "update notes\n\nSigned-off-by: Xin Li <xin.li@swirlds.com>", "committedDate": "2020-11-09T20:25:46Z", "type": "commit"}, {"oid": "1e2a6c849983bc9b3f8a2222155af568df692a9b", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/1e2a6c849983bc9b3f8a2222155af568df692a9b", "message": "podMonitor, add monitor to hedera-mirror\n\nSigned-off-by: Xin Li <xin.li@swirlds.com>", "committedDate": "2020-11-09T21:01:48Z", "type": "commit"}, {"oid": "0ebe78692f4adbcc87fbc183521fbd2399f53164", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/0ebe78692f4adbcc87fbc183521fbd2399f53164", "message": "add monitor to docker-compose.yml\n\nSigned-off-by: Xin Li <xin.li@swirlds.com>", "committedDate": "2020-11-09T21:13:49Z", "type": "commit"}, {"oid": "1350306f6395e34be1b1125e42130263fc427a37", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/1350306f6395e34be1b1125e42130263fc427a37", "message": "name -> component\n\nSigned-off-by: Xin Li <xin.li@swirlds.com>", "committedDate": "2020-11-09T21:16:34Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDEzMzMwMQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1251#discussion_r520133301", "bodyText": "Maybe we should disable this by default since we want to make it easy for people to get up and running without requiring any config? Or can we set replicas=0 to effectively disable?", "author": "steven-sheehy", "createdAt": "2020-11-09T21:31:49Z", "path": "docker-compose.yml", "diffHunk": "@@ -40,6 +40,14 @@ services:\n       - ./data:/var/lib/hedera-mirror-importer\n       - ./application.yml:/usr/etc/hedera-mirror-importer/application.yml\n \n+  monitor:", "originalCommit": "1350306f6395e34be1b1125e42130263fc427a37", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDIzNTg5Nw==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1251#discussion_r520235897", "bodyText": "replicas defaults to 0 in deployment.yaml when replicas is not set in values", "author": "xin-hedera", "createdAt": "2020-11-10T01:55:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDEzMzMwMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDI1MjU0OQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1251#discussion_r520252549", "bodyText": "Eh? I was referring to the docker-compose file. The rule is the docker compose should be runnable as is without any config.\nPlease undo deployment change.", "author": "steven-sheehy", "createdAt": "2020-11-10T02:50:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDEzMzMwMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDEzNDU2MA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1251#discussion_r520134560", "bodyText": "Can you test if we can lower this? It should start up much quicker than grpc which requires redis and postgresql.", "author": "steven-sheehy", "createdAt": "2020-11-09T21:34:10Z", "path": "charts/hedera-mirror-monitor/values.yaml", "diffHunk": "@@ -0,0 +1,144 @@\n+affinity:\n+  podAntiAffinity:\n+    preferredDuringSchedulingIgnoredDuringExecution:\n+      - weight: 100\n+        podAffinityTerm:\n+          topologyKey: kubernetes.io/hostname\n+          labelSelector:\n+            matchLabels:\n+              app.kubernetes.io/component: monitor\n+\n+annotations: {}\n+\n+config:\n+  hedera:\n+    mirror:\n+      monitor: {}\n+\n+fullnameOverride: \"\"\n+\n+global:\n+  namespaceOverride: \"\"\n+\n+image:\n+  pullPolicy: IfNotPresent\n+  repository: gcr.io/mirrornode/hedera-mirror-monitor\n+  tag: \"\"  # Default to the chart's app version\n+\n+imagePullSecrets: []\n+\n+labels: {}\n+\n+livenessProbe:\n+  httpGet:\n+    path: /actuator/health/liveness\n+    port: http\n+  initialDelaySeconds: 100\n+  periodSeconds: 10\n+  timeoutSeconds: 2\n+\n+nodeSelector: {}\n+\n+podMonitor:\n+  enabled: false\n+  interval: 30s\n+\n+podSecurityContext:\n+  fsGroup: 1000\n+\n+priorityClassName: \"\"\n+\n+prometheusRules:\n+  enabled: false\n+  MonitorHighCPU:\n+    annotations:\n+      description: \"{{ $labels.namespace }}/{{ $labels.pod }} CPU usage reached {{ $value | humanizePercentage }}%\"\n+      summary: \"Mirror Monitor CPU usage exceeds 80%\"\n+    enabled: true\n+    expr: sum(process_cpu_usage{application=\"hedera-mirror-monitor\"}) by (namespace, pod) / sum(system_cpu_count{application=\"hedera-mirror-monitor\"}) by (namespace, pod) > 0.8\n+    for: 5m\n+    labels:\n+      severity: critical\n+\n+  MonitorHighMemory:\n+    annotations:\n+      description: \"{{ $labels.namespace }}/{{ $labels.pod }} memory usage reached {{ $value | humanizePercentage }}%\"\n+      summary: \"Mirror Monitor memory usage exceeds 80%\"\n+    enabled: true\n+    expr: sum(jvm_memory_used_bytes{application=\"hedera-mirror-monitor\"}) by (namespace, pod) / sum(jvm_memory_max_bytes{application=\"hedera-mirror-monitor\"}) by (namespace, pod) > 0.8\n+    for: 5m\n+    labels:\n+      severity: critical\n+\n+  MonitorLog4j2Errors:\n+    annotations:\n+      description: \"{{ $labels.namespace }}/{{ $labels.pod }} encountered {{ $value }} exceptions in a 2m period\"\n+      summary: \"High rate of log4j2 errors\"\n+    enabled: true\n+    expr: sum(increase(log4j2_events_total{application=\"hedera-mirror-monitor\", level=\"error\"}[2m])) by (namespace, pod) >= 2\n+    for: 3m\n+    labels:\n+      severity: critical\n+\n+  MonitorPublishErrors:\n+    annotations:\n+      description: \"{{ $value | humanizePercentage }}% Error rate publishing {{ $labels.type }} transactions from {{ $labels.namespace }}/{{ $labels.pod }}\"\n+      summary: \"Publish error rate exceeds 5%\"\n+    enabled: true\n+    expr: sum(rate(hedera_mirror_monitor_publish_seconds_sum{application=\"hedera-mirror-monitor\",status!=\"SUCCESS\"}[2m])) by (namespace, pod, type) / sum(rate(hedera_mirror_monitor_publish_seconds_count{application=\"hedera-mirror-monitor\"}[2m])) by (namespace, pod, type) > 0.05\n+    for: 2m\n+    labels:\n+      severity: critical\n+\n+  MonitorPublishLatency:\n+    annotations:\n+      description: \"Publish latency exceeded {{ $value | humanizeDuration }} for {{ $labels.type }} transaction for {{ $labels.namespace }}/{{ $labels.pod }}\"\n+      summary: \"Publish latency exceeds 4s\"\n+    enabled: true\n+    expr: sum(rate(hedera_mirror_monitor_publish_seconds_sum{application=\"hedera-mirror-monitor\"}[2m])) by (namespace, pod, type) / sum(rate(hedera_mirror_monitor_publish_seconds_count{application=\"hedera-mirror-monitor\"}[2m])) by (namespace, pod, type) > 4\n+    for: 2m\n+    labels:\n+      severity: critical\n+\n+rbac:\n+  enabled: true\n+\n+readinessProbe:\n+  httpGet:\n+    path: /actuator/health/readiness\n+    port: http\n+  initialDelaySeconds: 100", "originalCommit": "1350306f6395e34be1b1125e42130263fc427a37", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDEzNDc5OA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1251#discussion_r520134798", "bodyText": "Can you test if we can lower this? It should start up much quicker than grpc which requires redis and postgresql.", "author": "steven-sheehy", "createdAt": "2020-11-09T21:34:35Z", "path": "charts/hedera-mirror-monitor/values.yaml", "diffHunk": "@@ -0,0 +1,144 @@\n+affinity:\n+  podAntiAffinity:\n+    preferredDuringSchedulingIgnoredDuringExecution:\n+      - weight: 100\n+        podAffinityTerm:\n+          topologyKey: kubernetes.io/hostname\n+          labelSelector:\n+            matchLabels:\n+              app.kubernetes.io/component: monitor\n+\n+annotations: {}\n+\n+config:\n+  hedera:\n+    mirror:\n+      monitor: {}\n+\n+fullnameOverride: \"\"\n+\n+global:\n+  namespaceOverride: \"\"\n+\n+image:\n+  pullPolicy: IfNotPresent\n+  repository: gcr.io/mirrornode/hedera-mirror-monitor\n+  tag: \"\"  # Default to the chart's app version\n+\n+imagePullSecrets: []\n+\n+labels: {}\n+\n+livenessProbe:\n+  httpGet:\n+    path: /actuator/health/liveness\n+    port: http\n+  initialDelaySeconds: 100", "originalCommit": "1350306f6395e34be1b1125e42130263fc427a37", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDE1MDY1OQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1251#discussion_r520150659", "bodyText": "I don't have the time for gRPC, but this is the number for monitor:\n2020-11-09 21:05:34,976 INFO  [main ] c.h.m.m.MonitorApplication Started MonitorApplication in 103.402 seconds (JVM running for 117.219)\n\nThe startup is really slow. If we want to cut the initial delay, we have to either look at why it's slow or increase the cpu limit of the container.", "author": "xin-hedera", "createdAt": "2020-11-09T22:05:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDEzNDc5OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDE1MzAyOQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1251#discussion_r520153029", "bodyText": "Ok, let's leave it as is. Just wanted to make sure these values were accurate and sounds like they are.", "author": "steven-sheehy", "createdAt": "2020-11-09T22:10:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDEzNDc5OA=="}], "type": "inlineReview"}, {"oid": "dd2fe0c3aedf4a2022dc45f30811403c42ea911d", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/dd2fe0c3aedf4a2022dc45f30811403c42ea911d", "message": "address review feedback\n\nSigned-off-by: Xin Li <xin.li@swirlds.com>", "committedDate": "2020-11-10T01:52:19Z", "type": "commit"}, {"oid": "b1a9517c26a064db9fcea4783eacbb7a4f037af2", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/b1a9517c26a064db9fcea4783eacbb7a4f037af2", "message": "revert changes to deployment.yaml\n\nSigned-off-by: Xin Li <xin.li@swirlds.com>", "committedDate": "2020-11-10T03:16:26Z", "type": "commit"}, {"oid": "d7a7fd6666ffd8b413e27f39a3ea87a67c2f46f5", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/d7a7fd6666ffd8b413e27f39a3ea87a67c2f46f5", "message": "set deploy.replicas = 0 for monitor in docker-compose.yml\n\nSigned-off-by: Xin Li <xin.li@swirlds.com>", "committedDate": "2020-11-10T03:23:40Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDI4MDg0Mw==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1251#discussion_r520280843", "bodyText": "This if/else can be removed. Only reason it's there for gRPC is because it has an HPA and the HPA manages the value of the replicas field. Can simply be replicas: {{ .Values.replicas }}. Please also put a default of 1 in the values.yaml.", "author": "steven-sheehy", "createdAt": "2020-11-10T04:36:05Z", "path": "charts/hedera-mirror-monitor/templates/deployment.yaml", "diffHunk": "@@ -0,0 +1,70 @@\n+apiVersion: apps/v1\n+kind: Deployment\n+metadata:\n+  annotations:\n+    {{- toYaml .Values.annotations | nindent 4 }}\n+  labels:\n+    {{- include \"hedera-mirror-monitor.labels\" . | nindent 4 }}\n+  name: {{ include \"hedera-mirror-monitor.fullname\" . }}\n+  namespace: {{ include \"hedera-mirror-monitor.namespace\" . }}\n+spec:\n+  {{- if .Values.replicas }}", "originalCommit": "dd2fe0c3aedf4a2022dc45f30811403c42ea911d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDYzMzM0MQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1251#discussion_r520633341", "bodyText": "sure", "author": "xin-hedera", "createdAt": "2020-11-10T15:05:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDI4MDg0Mw=="}], "type": "inlineReview"}, {"oid": "bdac47c72711ab687a62c34ab422fffbd6e697ae", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/bdac47c72711ab687a62c34ab422fffbd6e697ae", "message": "set monitor deployment replicas default to 1\n\nSigned-off-by: Xin Li <xin.li@swirlds.com>", "committedDate": "2020-11-10T15:16:38Z", "type": "commit"}]}