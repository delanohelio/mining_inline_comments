{"pr_number": 765, "pr_title": "Add runningHashVersion to REST and GRPC APIs", "pr_createdAt": "2020-05-16T23:02:20Z", "pr_url": "https://github.com/hashgraph/hedera-mirror-node/pull/765", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjY4Njk3NA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/765#discussion_r426686974", "bodyText": "Mapping a transport specific payload to a non-transport specific domain object is the responsibility of the controller layer. We may want to reuse this domain object for different transports. If you just need code reuse for the test, change the access from private to package-private.", "author": "steven-sheehy", "createdAt": "2020-05-18T14:55:25Z", "path": "hedera-mirror-grpc/src/main/java/com/hedera/mirror/grpc/controller/ConsensusController.java", "diffHunk": "@@ -101,15 +100,6 @@ private TopicMessageFilter toFilter(ConsensusTopicQuery query) {\n         return builder.build();\n     }\n \n-    private ConsensusTopicResponse toResponse(TopicMessage topicMessage) {", "originalCommit": "5ea59bf256e7d2177982c79b32e6d430b350532f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzA4MDU0Ng==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/765#discussion_r427080546", "bodyText": "that's good.", "author": "apeksharma", "createdAt": "2020-05-19T07:17:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjY4Njk3NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjY4OTMzNQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/765#discussion_r426689335", "bodyText": "The next value would be 5, not 9", "author": "steven-sheehy", "createdAt": "2020-05-18T14:58:25Z", "path": "hedera-mirror-protobuf/src/main/proto/com/hedera/mirror/api/proto/ConsensusService.proto", "diffHunk": "@@ -51,6 +51,8 @@ message ConsensusTopicResponse {\n     bytes runningHash = 3; // The running hash (SHA384) of every message.\n \n     uint64 sequenceNumber = 4; // Starts at 1 for first submitted message. Incremented on each submitted message.\n+\n+    uint64 runningHashVersion = 9; // Version of the SHA-384 digest used to update the running hash.", "originalCommit": "5ea59bf256e7d2177982c79b32e6d430b350532f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzA4MzI0Mg==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/765#discussion_r427083242", "bodyText": "ahh, sorry about that.", "author": "apeksharma", "createdAt": "2020-05-19T07:23:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjY4OTMzNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjY5MTExMg==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/765#discussion_r426691112", "bodyText": "Should be moved to middleware folder", "author": "steven-sheehy", "createdAt": "2020-05-18T15:00:49Z", "path": "hedera-mirror-rest/server.js", "diffHunk": "@@ -94,6 +94,12 @@ app.use(bodyParser.json());\n app.use(compression());\n app.use(cors());\n \n+// logging middleware\n+app.use(function (req, res, next) {", "originalCommit": "5ea59bf256e7d2177982c79b32e6d430b350532f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzExMzIxMA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/765#discussion_r427113210", "bodyText": "that's new. cool.", "author": "apeksharma", "createdAt": "2020-05-19T08:15:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjY5MTExMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjY5ODc2Ng==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/765#discussion_r426698766", "bodyText": "Please avoid all argument constructors unless there's just a couple arguments. You should instead prefer builder or setters. Only reason this object has an all args constructor is for use with the builder (and only reason it's not builder only I think is for JPA). We should disable public use of that constructor with @AllArgsConstructor(access = AccessLevel.PRIVATE).\nReason is at larger argument lengths it becomes harder to determine if you're setting the correct value, especially if multiple have the same type. This is a source of subtle bugs. It also makes it much hard to merge other people's changes in and refactor. For example, when we both added fields to RecordItem (which uses all args constructor) in recent PRs it was difficult for me to merge.", "author": "steven-sheehy", "createdAt": "2020-05-18T15:11:27Z", "path": "hedera-mirror-grpc/src/test/java/com/hedera/mirror/grpc/jmeter/handler/ConnectionHandler.java", "diffHunk": "@@ -81,12 +81,7 @@ public void insertTopicMessage(int newTopicsMessageCount, long topicNum, Instant\n             long sequenceNum = nextSequenceNum + i;\n             Instant temp = startTime.plus(sequenceNum, ChronoUnit.NANOS);\n             Long consensusTimestamp = converter.convert(temp);\n-            TopicMessage topicMessage = new TopicMessage();\n-            topicMessage.setConsensusTimestamp(consensusTimestamp);\n-            topicMessage.setSequenceNumber(sequenceNum);\n-            topicMessage.setMessage(BYTES);\n-            topicMessage.setRunningHash(BYTES);\n-            topicMessage.setRealmNum(0);\n+            TopicMessage topicMessage = new TopicMessage(consensusTimestamp, BYTES, 0, BYTES, sequenceNum, 0, 2);", "originalCommit": "5ea59bf256e7d2177982c79b32e6d430b350532f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzA4Mjg2NQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/765#discussion_r427082865", "bodyText": "changed to builder.\nAlthough i heavily use cmd + p in intellij for args lookup, i agree that beyond 4-5 args is not good.", "author": "apeksharma", "createdAt": "2020-05-19T07:22:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjY5ODc2Ng=="}], "type": "inlineReview"}, {"oid": "12f64f6fca8e04f636e46f75823c8a4169db243f", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/12f64f6fca8e04f636e46f75823c8a4169db243f", "message": "address review\n\nSigned-off-by: Apekshit Sharma <apekshit.sharma@hedera.com>", "committedDate": "2020-05-19T08:14:55Z", "type": "commit"}, {"oid": "12f64f6fca8e04f636e46f75823c8a4169db243f", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/12f64f6fca8e04f636e46f75823c8a4169db243f", "message": "address review\n\nSigned-off-by: Apekshit Sharma <apekshit.sharma@hedera.com>", "committedDate": "2020-05-19T08:14:55Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzQwMTkxMw==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/765#discussion_r427401913", "bodyText": "Actually I don't think we want *.\nIt's bad practice cause then it exposes new fields that may be internal only.\nExplicitly state the fields you want", "author": "Nana-EC", "createdAt": "2020-05-19T15:39:34Z", "path": "hedera-mirror-rest/topicmessage.js", "diffHunk": "@@ -113,26 +117,30 @@ const processGetMessageByConsensusTimestampRequest = (req, res) => {\n };\n \n /**\n+ * Handler function for /:id/messages/:sequencenumber API.\n  * Extracts and validates topic and sequence params and creates db query statement in preparation for db call to get message\n+ * @return {Promise} Promise for PostgreSQL query\n  */\n-const processGetMessageByTopicAndSequenceRequest = (req, res) => {\n+const getMessageByTopicAndSequenceRequest = async (req, res) => {\n   const topicId = req.params.id;\n   const seqNum = req.params.sequencenumber;\n   validateGetSequenceMessageParams(topicId, seqNum);\n \n   // handle topic stated as x.y.z vs z e.g. topic 7 vs topic 0.0.7. Defaults realm to 0 if not stated\n   const entity = utils.parseEntityId(topicId);\n-  const pgSqlQuery =\n-    'select consensus_timestamp, realm_num, topic_num, message, running_hash, sequence_number' +\n-    ' from topic_message where realm_num = $1 and topic_num = $2 and sequence_number = $3 limit 1';\n+  const pgSqlQuery = `select * from topic_message where realm_num = $1 and topic_num = $2 and sequence_number = $3 limit 1`;", "originalCommit": "12f64f6fca8e04f636e46f75823c8a4169db243f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzQwNTUwNA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/765#discussion_r427405504", "bodyText": "I like * unless we know there's some larger fields that we don't want to return (e.g. performance reason). It won't expose internal fields since we explicitly map them to json in formatTopicMessageRow.", "author": "steven-sheehy", "createdAt": "2020-05-19T15:44:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzQwMTkxMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzQ3MTg4Mg==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/765#discussion_r427471882", "bodyText": "same reason for the change.\nAs long as correctness and perf are ensured, i like eye candy.", "author": "apeksharma", "createdAt": "2020-05-19T17:23:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzQwMTkxMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzQwMjA4Mw==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/765#discussion_r427402083", "bodyText": "Same comment", "author": "Nana-EC", "createdAt": "2020-05-19T15:39:49Z", "path": "hedera-mirror-rest/topicmessage.js", "diffHunk": "@@ -179,9 +187,7 @@ const processGetTopicMessages = (req, res) => {\n \n const extractSqlFromTopicMessagesRequest = (topicId, filters) => {\n   const entity = utils.parseEntityId(topicId);\n-  let pgSqlQuery =\n-    'select consensus_timestamp, realm_num, topic_num, message, running_hash, sequence_number' +\n-    ' from topic_message where realm_num = $1 and topic_num = $2';\n+  let pgSqlQuery = `select * from topic_message where realm_num = $1 and topic_num = $2`;", "originalCommit": "12f64f6fca8e04f636e46f75823c8a4169db243f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "5feda68f78e10426bb1efe8d1ebebead25deb886", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/5feda68f78e10426bb1efe8d1ebebead25deb886", "message": "fix minor bug\n\nSigned-off-by: Apekshit Sharma <apekshit.sharma@hedera.com>", "committedDate": "2020-05-19T17:29:36Z", "type": "commit"}]}