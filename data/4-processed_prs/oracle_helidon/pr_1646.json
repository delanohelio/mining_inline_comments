{"pr_number": 1646, "pr_title": "WebClient used in SE examples and tests", "pr_createdAt": "2020-04-15T12:42:07Z", "pr_url": "https://github.com/oracle/helidon/pull/1646", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTExNjM4MQ==", "url": "https://github.com/oracle/helidon/pull/1646#discussion_r409116381", "bodyText": "Maybe these could be changed to just throws Exception ? Or maybe like Tomas said we need to come-up with a small utility and wrap the exceptions.", "author": "romain-grecourt", "createdAt": "2020-04-15T20:33:02Z", "path": "security/integration/webserver/src/test/java/io/helidon/security/integration/webserver/WebSecurityTests.java", "diffHunk": "@@ -50,28 +51,31 @@\n     static final String AUDIT_MESSAGE_FORMAT = \"Unit test message format\";\n     static UnitTestAuditProvider myAuditProvider;\n     static WebServer server;\n-    private static Client authFeatureClient;\n-    private static Client client;\n+    private static WebClient securitySetup;\n+    private static WebClient webClient;\n \n     @BeforeAll\n     static void buildClients() {\n-        authFeatureClient = ClientBuilder.newClient()\n-                .register(HttpAuthenticationFeature.universalBuilder().build());\n-        client = ClientBuilder.newClient();\n+        Security security = Security.builder()\n+                .addProvider(HttpBasicAuthProvider.builder().build())\n+                .build();\n+\n+        securitySetup = WebClient.builder()\n+                .register(WebClientSecurity.create(security))\n+                .build();\n+\n+        webClient = WebClient.create();\n     }\n \n     @AfterAll\n     static void stopIt() throws InterruptedException {\n-        authFeatureClient.close();\n-        client.close();\n-\n         WebSecurityTestUtil.stopServer(server);\n     }\n \n     abstract String serverBaseUri();\n \n     @Test\n-    void basicTestJohn() {\n+    void basicTestJohn() throws ExecutionException, InterruptedException {", "originalCommit": "9a08ddcce2e42e083122a91a2addf3a48b30ac10", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "f8d10b96ccbce13144840c2903b601f3a00094f4", "url": "https://github.com/oracle/helidon/commit/f8d10b96ccbce13144840c2903b601f3a00094f4", "message": "WebClient used in SE examples and tests\n\nSigned-off-by: David Kral <david.k.kral@oracle.com>", "committedDate": "2020-04-27T11:27:21Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDY5MDkxNg==", "url": "https://github.com/oracle/helidon/pull/1646#discussion_r420690916", "bodyText": "Assertions must be in the test method.\nIf the assertion fails, the test is reported as failed with exception.\nIf the assertion is in test method and fails, the test is reported as failed assertion.", "author": "tomas-langer", "createdAt": "2020-05-06T10:31:24Z", "path": "examples/employee-app/src/test/java/io/helidon/service/employee/MainTest.java", "diffHunk": "@@ -57,24 +64,35 @@ public static void stopServer() throws Exception {\n \n     @Test\n     public void testHelloWorld() throws Exception {\n-        HttpURLConnection conn;\n-\n-        conn = getURLConnection(\"GET\", \"/employees\");\n-        Assertions.assertEquals(200, conn.getResponseCode(), \"HTTP response2\");\n+        webClient.get()\n+                .path(\"/employees\")\n+                .request()\n+                .thenAccept(response -> {\n+                    response.close();\n+                    Assertions.assertEquals(Http.Status.OK_200, response.status(), \"HTTP response2\");", "originalCommit": "9ecc5d3a4d2056241d074edeed45c6f7c9858d41", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTQyNjQ5Mg==", "url": "https://github.com/oracle/helidon/pull/1646#discussion_r421426492", "bodyText": "I will change this in follow up issue. #1748", "author": "Verdent", "createdAt": "2020-05-07T11:15:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDY5MDkxNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDY5MTE5OA==", "url": "https://github.com/oracle/helidon/pull/1646#discussion_r420691198", "bodyText": "May be more readable to hide complexity in a helper method, e.g. WebClientResponse invokeSync(\"/employee\")", "author": "tomas-langer", "createdAt": "2020-05-06T10:32:01Z", "path": "examples/employee-app/src/test/java/io/helidon/service/employee/MainTest.java", "diffHunk": "@@ -57,24 +64,35 @@ public static void stopServer() throws Exception {\n \n     @Test\n     public void testHelloWorld() throws Exception {\n-        HttpURLConnection conn;\n-\n-        conn = getURLConnection(\"GET\", \"/employees\");\n-        Assertions.assertEquals(200, conn.getResponseCode(), \"HTTP response2\");\n+        webClient.get()", "originalCommit": "9ecc5d3a4d2056241d074edeed45c6f7c9858d41", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTQyNjY5MA==", "url": "https://github.com/oracle/helidon/pull/1646#discussion_r421426690", "bodyText": "I will change this in follow up issue. #1748", "author": "Verdent", "createdAt": "2020-05-07T11:15:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDY5MTE5OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDY5OTY1MQ==", "url": "https://github.com/oracle/helidon/pull/1646#discussion_r420699651", "bodyText": ".uri should be on a separate line", "author": "tomas-langer", "createdAt": "2020-05-06T10:48:29Z", "path": "examples/grpc/security-outbound/src/main/java/io/helidon/grpc/examples/security/outbound/SecureServer.java", "diffHunk": "@@ -220,34 +214,47 @@ private void setGreeting(Greet.SetGreetingRequest request, StreamObserver<Greet.\n \n             // Obtain the security context from the current gRPC context\n             SecurityContext securityContext = GrpcSecurity.SECURITY_CONTEXT.get();\n+            Context context = Context.builder().id(\"example\").build();\n+            context.register(securityContext);\n \n             // Use the admin user's credentials call the \"upper\" ReST endpoint which will call\n             // the \"Upper\" method on the secure gRPC StringService.\n-            Response response = client.target(\"http://127.0.0.1:\" + webServer.port())\n-                                      .path(\"upper\")\n-                                      .queryParam(\"value\", name)\n-                                      .request()\n-                                      .property(ClientSecurity.PROPERTY_CONTEXT, securityContext)\n-                                      .property(HttpBasicAuthProvider.EP_PROPERTY_OUTBOUND_USER, \"Ted\")\n-                                      .property(HttpBasicAuthProvider.EP_PROPERTY_OUTBOUND_PASSWORD, \"secret\")\n-                                      .get();\n-\n-            if (response.getStatus() == 200) {\n-                greeting = response.readEntity(String.class);\n-                complete(observer, Greet.SetGreetingResponse.newBuilder().setGreeting(greeting).build());\n+            client.get().uri(\"http://127.0.0.1:\" + webServer.port())", "originalCommit": "9ecc5d3a4d2056241d074edeed45c6f7c9858d41", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDk3MzYyNQ==", "url": "https://github.com/oracle/helidon/pull/1646#discussion_r420973625", "bodyText": "done", "author": "Verdent", "createdAt": "2020-05-06T17:41:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDY5OTY1MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDcwODA1OQ==", "url": "https://github.com/oracle/helidon/pull/1646#discussion_r420708059", "bodyText": "use flow all the way, when client is not reused.", "author": "tomas-langer", "createdAt": "2020-05-06T11:05:25Z", "path": "webserver/webserver/src/test/java/io/helidon/webserver/Status204Test.java", "diffHunk": "@@ -59,12 +52,18 @@ public void stopServer() throws Exception {\n     }\n \n     @Test\n-    public void callPutAndGet() {\n-        WebTarget target = ClientBuilder.newClient()\n-                                        .target(\"http://localhost:\" + server.port());\n-        Response response = target.request().put(Entity.entity(\"test call\", MediaType.TEXT_PLAIN));\n-        assertThat(response.getStatus(), is(204));\n-        String s = target.request().get(String.class);\n-        assertThat(s, is(\"test\"));\n+    public void callPutAndGet() throws Exception {\n+        WebClient webClient = WebClient.builder()\n+                .baseUri(\"http://localhost:\" + server.port())", "originalCommit": "9ecc5d3a4d2056241d074edeed45c6f7c9858d41", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDk3Mzc2NA==", "url": "https://github.com/oracle/helidon/pull/1646#discussion_r420973764", "bodyText": "I can't do that since I need WebClient instance to make another call in the flow.", "author": "Verdent", "createdAt": "2020-05-06T17:41:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDcwODA1OQ=="}], "type": "inlineReview"}, {"oid": "440372f0da62902c3ed3bbcb7fb3a5ad0a52f7b4", "url": "https://github.com/oracle/helidon/commit/440372f0da62902c3ed3bbcb7fb3a5ad0a52f7b4", "message": "Tomas suggestions implemented\n\nSigned-off-by: David Kral <david.k.kral@oracle.com>", "committedDate": "2020-05-06T17:39:36Z", "type": "forcePushed"}, {"oid": "36eba3e94a7e0e9891c0f3327564b44c6f687083", "url": "https://github.com/oracle/helidon/commit/36eba3e94a7e0e9891c0f3327564b44c6f687083", "message": "WebClient used in SE examples and tests\n\nSigned-off-by: David Kral <david.k.kral@oracle.com>", "committedDate": "2020-05-07T11:03:57Z", "type": "commit"}, {"oid": "2296f38198fc02c7d405fc07e63b8ab046f552c3", "url": "https://github.com/oracle/helidon/commit/2296f38198fc02c7d405fc07e63b8ab046f552c3", "message": "MessageQueueService fix\n\nSigned-off-by: David Kral <david.k.kral@oracle.com>", "committedDate": "2020-05-07T11:03:59Z", "type": "commit"}, {"oid": "8bf80711cec2d2e07602f19a4b833e666eaa863a", "url": "https://github.com/oracle/helidon/commit/8bf80711cec2d2e07602f19a4b833e666eaa863a", "message": "Tomas suggestions implemented\n\nSigned-off-by: David Kral <david.k.kral@oracle.com>", "committedDate": "2020-05-07T11:03:59Z", "type": "commit"}, {"oid": "1f6c8129c770562c4e1a329f95ecce451a924055", "url": "https://github.com/oracle/helidon/commit/1f6c8129c770562c4e1a329f95ecce451a924055", "message": "rebased on the master with media support changes\n\nSigned-off-by: David Kral <david.k.kral@oracle.com>", "committedDate": "2020-05-07T11:28:10Z", "type": "commit"}, {"oid": "1f6c8129c770562c4e1a329f95ecce451a924055", "url": "https://github.com/oracle/helidon/commit/1f6c8129c770562c4e1a329f95ecce451a924055", "message": "rebased on the master with media support changes\n\nSigned-off-by: David Kral <david.k.kral@oracle.com>", "committedDate": "2020-05-07T11:28:10Z", "type": "forcePushed"}]}