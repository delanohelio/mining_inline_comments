{"pr_number": 1314, "pr_title": "Fixed issues with IDCS and OIDC provider - 1.x", "pr_createdAt": "2020-01-17T13:56:54Z", "pr_url": "https://github.com/oracle/helidon/pull/1314", "timeline": [{"oid": "6b399c7722085155a350ccfa3bc16bca9f18f699", "url": "https://github.com/oracle/helidon/commit/6b399c7722085155a350ccfa3bc16bca9f18f699", "message": "IDCS and OIDC fixes.", "committedDate": "2020-01-17T14:01:00Z", "type": "forcePushed"}, {"oid": "a710d4c012c18bdd2d99bf71de859f46856650fb", "url": "https://github.com/oracle/helidon/commit/a710d4c012c18bdd2d99bf71de859f46856650fb", "message": "IDCS and OIDC fixes.", "committedDate": "2020-01-17T14:42:49Z", "type": "forcePushed"}, {"oid": "a610012ed197177781791ba17d129bac91453a03", "url": "https://github.com/oracle/helidon/commit/a610012ed197177781791ba17d129bac91453a03", "message": "IDCS and OIDC fixes.", "committedDate": "2020-01-17T15:04:15Z", "type": "commit"}, {"oid": "a610012ed197177781791ba17d129bac91453a03", "url": "https://github.com/oracle/helidon/commit/a610012ed197177781791ba17d129bac91453a03", "message": "IDCS and OIDC fixes.", "committedDate": "2020-01-17T15:04:15Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODIyMDAxMg==", "url": "https://github.com/oracle/helidon/pull/1314#discussion_r368220012", "bodyText": "I think this is a very important feature, especially when the app will run from Kubernetes and might get an override config seeded. Probably you should feature this more prominently in other places as well and you might also change the default from a user home example to a more Kubernetes-ish one.", "author": "FWiesner", "createdAt": "2020-01-18T10:35:48Z", "path": "examples/microprofile/idcs/src/main/java/io/helidon/examples/microprofile/security/idcs/IdcsMain.java", "diffHunk": "@@ -35,13 +38,29 @@ private IdcsMain() {\n      * @throws IOException when logging configuration fails\n      */\n     public static void main(String[] args) throws IOException {\n-        LogManager.getLogManager().readConfiguration(IdcsMain.class.getResourceAsStream(\"/logging.properties\"));\n-        Server.create().start();\n+        Server.builder()\n+                .config(buildConfig())\n+                .build()\n+                .start();\n \n         System.out.println(\"Endpoints:\");\n         System.out.println(\"Login\");\n         System.out.println(\"  http://localhost:7987/rest/login\");\n         System.out.println(\"Full security with scopes and roles (see IdcsResource.java)\");\n         System.out.println(\"  http://localhost:7987/rest/scopes\");\n+        System.out.println(\"A protected reactive service (see application.yaml - security.web-server)\");\n+        System.out.println(\"  http://localhost:7987/reactive\");\n+        System.out.println(\"A protected static resource (see application.yaml - security.web-server\");\n+        System.out.println(\"  http://localhost:7987/web/resource.html\");\n+    }\n+\n+    private static Config buildConfig() {\n+        return Config.builder()\n+                .sources(\n+                        // you can use this file to override the defaults that are built-in\n+                        file(System.getProperty(\"user.home\") + \"/helidon/conf/examples.yaml\").optional(),\n+                        // in jar file (see src/main/resources/application.yaml)\n+                        classpath(\"application.yaml\"))\n+                .build();", "originalCommit": "a610012ed197177781791ba17d129bac91453a03", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODQ2ODk2Mw==", "url": "https://github.com/oracle/helidon/pull/1314#discussion_r368468963", "bodyText": "We do plan to update our example to use meta configuration with description of how to override.\nThis is really for our developers - so we do not include our security setup specific URLs to the source base.\nThere are examples specifically for configuration that show the capabilities.\nTo use this in a k8s with config maps, the change is simple - just replace the path in the code with the file path the config map is mounted to...", "author": "tomas-langer", "createdAt": "2020-01-20T10:20:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODIyMDAxMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODIyMDA1Nw==", "url": "https://github.com/oracle/helidon/pull/1314#discussion_r368220057", "bodyText": "does the empty abac key do something? If so, please add a comment. Otherwise probably remove it", "author": "FWiesner", "createdAt": "2020-01-18T10:37:08Z", "path": "examples/microprofile/idcs/src/main/resources/application.yaml", "diffHunk": "@@ -34,18 +34,27 @@ security:\n     frontend-uri: \"http://localhost:7987\"\n     proxy-host: \"if you need proxy\"\n   providers:\n-  - abac:\n-  - oidc:\n-      client-id: \"${ALIAS=security.properties.idcs-client-id}\"\n-      client-secret: \"${ALIAS=security.properties.idcs-client-secret}\"\n-      identity-uri: \"${ALIAS=security.properties.idcs-uri}\"\n-      # A prefix used for custom scopes\n-      scope-audience: \"http://localhost:7987/test-application\"\n-      proxy-host: \"${ALIAS=security.properties.proxy-host}\"\n-      frontend-uri: \"${ALIAS=security.properties.frontend-uri}\"\n-      # Retrieve roles\n-      idcs-roles: true\n+    - abac:", "originalCommit": "a610012ed197177781791ba17d129bac91453a03", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODQ2OTE5Mg==", "url": "https://github.com/oracle/helidon/pull/1314#discussion_r368469192", "bodyText": "yes it does - it adds the ABAC provider to the list of security providers used", "author": "tomas-langer", "createdAt": "2020-01-20T10:20:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODIyMDA1Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODQ3MTAxNg==", "url": "https://github.com/oracle/helidon/pull/1314#discussion_r368471016", "bodyText": "I have added a comment to each of these used with OIDC/IDCS in examples", "author": "tomas-langer", "createdAt": "2020-01-20T10:24:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODIyMDA1Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODIyMDEzNA==", "url": "https://github.com/oracle/helidon/pull/1314#discussion_r368220134", "bodyText": "no idea whether this is defined by MicroProfile or native Helidon, but why don't you accept an array of paths here to use the same configuration multiple times?", "author": "FWiesner", "createdAt": "2020-01-18T10:39:08Z", "path": "examples/security/idcs-login/src/main/resources/application.yaml", "diffHunk": "@@ -46,11 +46,13 @@ security:\n         client-id: \"${ALIAS=security.properties.idcs-client-id}\"\n         client-secret: \"${ALIAS=security.properties.idcs-client-secret}\"\n         identity-uri: \"${ALIAS=security.properties.idcs-uri}\"\n-      cache-config:\n-        cache-timeout-millis: 100000\n   web-server:\n     # protected paths on the web server - do not include paths served by Jersey, as those are protected directly\n     paths:\n-    - path: \"/rest/profile\"\n-      methods: [\"get\"]\n-      authenticate: true\n+      - path: \"/rest/profile\"", "originalCommit": "a610012ed197177781791ba17d129bac91453a03", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODQ3NDIyMA==", "url": "https://github.com/oracle/helidon/pull/1314#discussion_r368474220", "bodyText": "That is not implemented (and it is Helidon SE security integration).\nIf you feel this is useful, you can submit an enhancement issue.", "author": "tomas-langer", "createdAt": "2020-01-20T10:30:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODIyMDEzNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODQ4MzI5NQ==", "url": "https://github.com/oracle/helidon/pull/1314#discussion_r368483295", "bodyText": "will do", "author": "FWiesner", "createdAt": "2020-01-20T10:50:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODIyMDEzNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODIyMDIwNQ==", "url": "https://github.com/oracle/helidon/pull/1314#discussion_r368220205", "bodyText": "same as on the other PR... I wonder whether there should be an orElse to warn the developer", "author": "FWiesner", "createdAt": "2020-01-18T10:40:58Z", "path": "security/providers/abac/src/main/java/io/helidon/security/providers/abac/AbacProvider.java", "diffHunk": "@@ -224,39 +234,53 @@ private void validateCustom(EndpointConfig epConfig, Errors.Collector collector)\n     }\n \n     private void validateConfig(EndpointConfig config, Errors.Collector collector) {\n-        config.config(\"abac\")\n-                .ifPresent(abacConfig -> abacConfig.asMap()\n-                        .ifPresent(theMap -> {\n-                            int attributes = 0;\n-                            int unsupported = 0;\n-                            List<String> unsupportedKeys = new LinkedList<>();\n-\n-                            for (String key : theMap.keySet()) {\n-                                attributes++;\n-                                if (!supportedConfigKeys.contains(key)) {\n-                                    unsupported++;\n-                                    unsupportedKeys.add(key);\n-                                }\n-                            }\n+        config.config(CONFIG_KEY)", "originalCommit": "a610012ed197177781791ba17d129bac91453a03", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODQ3NTQ2Mg==", "url": "https://github.com/oracle/helidon/pull/1314#discussion_r368475462", "bodyText": "I am not sure I understand - the ABAC provider does not require any configuration, so there is not much to do here.", "author": "tomas-langer", "createdAt": "2020-01-20T10:33:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODIyMDIwNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODQ4NDkyMg==", "url": "https://github.com/oracle/helidon/pull/1314#discussion_r368484922", "bodyText": "well, say some developer has the same thought about the empty abac key in the application.yaml as what my reaction was. Normally an empty key - especially when you come from Spring Boot - is having the connotation of a no-op. So, if you remove the abac key it would be helpful to get at least on FINE or FINER a warning that tells you that ABAC support is turned off", "author": "FWiesner", "createdAt": "2020-01-20T10:53:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODIyMDIwNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODUzMjYzMg==", "url": "https://github.com/oracle/helidon/pull/1314#discussion_r368532632", "bodyText": "It works slightly differently.\nIf you add the abac key to the configuration, security would pick the security provider up and configure it.\nIf remove the abac key from configuration, security will never try to initialize the ABAC provider.", "author": "tomas-langer", "createdAt": "2020-01-20T12:54:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODIyMDIwNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODU5NjExNA==", "url": "https://github.com/oracle/helidon/pull/1314#discussion_r368596114", "bodyText": "yes. But many people will expect that\n   abac:\nwould be a no-op.\nWith Spring the pattern normally is\n  abac:\n    enabled: true\nwhich is more explicit", "author": "FWiesner", "createdAt": "2020-01-20T15:09:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODIyMDIwNQ=="}], "type": "inlineReview"}, {"oid": "b6063e3ea6c341eb2fbcb3c5d89524d2c83418df", "url": "https://github.com/oracle/helidon/commit/b6063e3ea6c341eb2fbcb3c5d89524d2c83418df", "message": "Review changes", "committedDate": "2020-01-20T10:34:48Z", "type": "commit"}]}