{"pr_number": 800, "pr_title": "PARQUET-1884: Encryption branch merge in master", "pr_createdAt": "2020-07-13T05:55:29Z", "pr_url": "https://github.com/apache/parquet-mr/pull/800", "timeline": [{"oid": "4516e97be61309ad7cda958d14d60cdcd6650de1", "url": "https://github.com/apache/parquet-mr/commit/4516e97be61309ad7cda958d14d60cdcd6650de1", "message": "PARQUET-1228: Format Structures encryption (#613)", "committedDate": "2020-07-28T10:32:37Z", "type": "commit"}, {"oid": "f85a96280cfd98d5f3eb09f846f76ee1eb1634f5", "url": "https://github.com/apache/parquet-mr/commit/f85a96280cfd98d5f3eb09f846f76ee1eb1634f5", "message": "PARQUET-1286: Crypto package (#614)", "committedDate": "2020-07-28T10:32:37Z", "type": "commit"}, {"oid": "42dfc343807f16563b2265ccb4ada49a86d86dd7", "url": "https://github.com/apache/parquet-mr/commit/42dfc343807f16563b2265ccb4ada49a86d86dd7", "message": "PARQUET-1818: Fix bloom/encryption collision in format-structures (#771)", "committedDate": "2020-07-28T10:32:37Z", "type": "commit"}, {"oid": "71ad811a8ea7938869ea36eac3e2ee381efdd774", "url": "https://github.com/apache/parquet-mr/commit/71ad811a8ea7938869ea36eac3e2ee381efdd774", "message": "PARQUET-1817: Crypto Properties Factory (#769)", "committedDate": "2020-07-28T10:32:37Z", "type": "commit"}, {"oid": "b60f4a4880e1d6b20638eec3e20db06cb171bdc8", "url": "https://github.com/apache/parquet-mr/commit/b60f4a4880e1d6b20638eec3e20db06cb171bdc8", "message": "PARQUET-1229: Parquet MR encryption (#776)", "committedDate": "2020-07-28T10:41:17Z", "type": "commit"}, {"oid": "dcf7d7edacb8dc7c41903dca94d20ff0809235b9", "url": "https://github.com/apache/parquet-mr/commit/dcf7d7edacb8dc7c41903dca94d20ff0809235b9", "message": "PARQUET-1807: Encryption: Interop and Function test suite for Java version (#782)\n\nAdd a test for writing and reading parquet in a number of encryption\r\nand decryption configurations.\r\nAdd interop test that reads files from parquet-testing GitHub\r\nrepository, that were written by parquet-cpp.\r\nThis adds parquet-testing repo as a submodule.", "committedDate": "2020-07-28T10:41:17Z", "type": "commit"}, {"oid": "22a5ae1ea8d7ef3b93d037932c3de4a14a1e41cf", "url": "https://github.com/apache/parquet-mr/commit/22a5ae1ea8d7ef3b93d037932c3de4a14a1e41cf", "message": "PARQUET-1373: Encryption key tools (#615)\n\n* comments\r\n* update key tools\r\n* double wrap for minimizing KMS calls\r\n* Add information about KMS instance ID to footer metadata. Then on file reading, KMS instance ID doesn't have to be provided in properties, but can be read from the metadata.\r\nAdd RemoteKmsClient abstract class to assist implementing KMSClients for remote KMSs, that are accessed using URL.\r\nMake DoubleWrappedKeyManager inherit from WrappedKeyManager and make FileKeyManager an abstract class. Add a static factory method to FileKeyManager to initialize an appropriate KSMClient and Key manager.\r\nKMS URL should be specified in properties either directly or in a list. KMS instance ID is either default, or should be specified in properties or read from footer metadata.\r\n* major update - key rotation, crypto factory, etc\r\n* Change caches of EnvelopeKeyManager and EnvelopeKeyRetriever to be per token.\r\nKmsClient is per token and read/write KEK caches too.\r\nAdd default token value for InMemoryKMS, which has no tokens.\r\nUse concurrentHashMap for caches with computeIfAbsent.\r\nAdd expiration using to the caches - both time-based and on-demand.\r\nOn expiration delete the per-token entries from caches.\r\nAdd method for cache invalidation per token.\r\nAdd abstract methods to be implemented by RemoteKmsClients.\r\n* add in-memory KMS\r\n* Change RemoteKmsClient exceptions to IOException\r\ninstead of the higher-level ParquetCryptoRuntimeException.\r\nChange to constant names to uppercase.\r\n* Add sample VaultClient.\r\n* interface changes\r\n* Add okHttp3 dependency for VaultClient sample.\r\n* wrapping changes\r\n* Use JSON serialization for key material.\r\n* separate write and read path, update caching\r\n* improved refactoring\r\n* key rotation improvements\r\n* Add TestPropertiesDrivenEncryption\r\n* get and resfresh token for all KMS clients\r\n* minor changes\r\n* Use ConcurrentHashMap for caches\r\n* caching and store updates\r\n* Rename some encryption/decryption configurations and make the test parameterized\r\nto test combinations of isKeyMaterialExternalStorage, isDoubleWrapping, isWrapLocally.\r\nAdd RemoteKmsClient mock for remote wrapping.\r\n* add removeCacheEntriesForAllTokens\r\n* Make common method setCommonKMSProperties and extract classname strings from classes\r\n* Change TestPropertiesDrivenEncryption to accomodate latest API changes.\r\n* Remove StringUtils\r\n* address review comments\r\n* key material documentation\r\n* Boolean objects\r\n\r\nCo-authored-by: Maya Anderson <mayaa@il.ibm.com>", "committedDate": "2020-07-28T10:52:22Z", "type": "commit"}, {"oid": "22a5ae1ea8d7ef3b93d037932c3de4a14a1e41cf", "url": "https://github.com/apache/parquet-mr/commit/22a5ae1ea8d7ef3b93d037932c3de4a14a1e41cf", "message": "PARQUET-1373: Encryption key tools (#615)\n\n* comments\r\n* update key tools\r\n* double wrap for minimizing KMS calls\r\n* Add information about KMS instance ID to footer metadata. Then on file reading, KMS instance ID doesn't have to be provided in properties, but can be read from the metadata.\r\nAdd RemoteKmsClient abstract class to assist implementing KMSClients for remote KMSs, that are accessed using URL.\r\nMake DoubleWrappedKeyManager inherit from WrappedKeyManager and make FileKeyManager an abstract class. Add a static factory method to FileKeyManager to initialize an appropriate KSMClient and Key manager.\r\nKMS URL should be specified in properties either directly or in a list. KMS instance ID is either default, or should be specified in properties or read from footer metadata.\r\n* major update - key rotation, crypto factory, etc\r\n* Change caches of EnvelopeKeyManager and EnvelopeKeyRetriever to be per token.\r\nKmsClient is per token and read/write KEK caches too.\r\nAdd default token value for InMemoryKMS, which has no tokens.\r\nUse concurrentHashMap for caches with computeIfAbsent.\r\nAdd expiration using to the caches - both time-based and on-demand.\r\nOn expiration delete the per-token entries from caches.\r\nAdd method for cache invalidation per token.\r\nAdd abstract methods to be implemented by RemoteKmsClients.\r\n* add in-memory KMS\r\n* Change RemoteKmsClient exceptions to IOException\r\ninstead of the higher-level ParquetCryptoRuntimeException.\r\nChange to constant names to uppercase.\r\n* Add sample VaultClient.\r\n* interface changes\r\n* Add okHttp3 dependency for VaultClient sample.\r\n* wrapping changes\r\n* Use JSON serialization for key material.\r\n* separate write and read path, update caching\r\n* improved refactoring\r\n* key rotation improvements\r\n* Add TestPropertiesDrivenEncryption\r\n* get and resfresh token for all KMS clients\r\n* minor changes\r\n* Use ConcurrentHashMap for caches\r\n* caching and store updates\r\n* Rename some encryption/decryption configurations and make the test parameterized\r\nto test combinations of isKeyMaterialExternalStorage, isDoubleWrapping, isWrapLocally.\r\nAdd RemoteKmsClient mock for remote wrapping.\r\n* add removeCacheEntriesForAllTokens\r\n* Make common method setCommonKMSProperties and extract classname strings from classes\r\n* Change TestPropertiesDrivenEncryption to accomodate latest API changes.\r\n* Remove StringUtils\r\n* address review comments\r\n* key material documentation\r\n* Boolean objects\r\n\r\nCo-authored-by: Maya Anderson <mayaa@il.ibm.com>", "committedDate": "2020-07-28T10:52:22Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTU0NTM5Ng==", "url": "https://github.com/apache/parquet-mr/pull/800#discussion_r461545396", "bodyText": "jdk is already listed, this one is not required", "author": "gszadovszky", "createdAt": "2020-07-28T12:37:02Z", "path": ".travis.yml", "diffHunk": "@@ -1,4 +1,5 @@\n language: java\n+jdk: openjdk8", "originalCommit": "22a5ae1ea8d7ef3b93d037932c3de4a14a1e41cf", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTU1MzA4MA==", "url": "https://github.com/apache/parquet-mr/pull/800#discussion_r461553080", "bodyText": "Please, add double spaces to the end of the lines to enforce newlines. (Maybe it was my mistake during the rebase that they were removed.)\n(You may check the result by reviewing the rendering of the file on the github UI.)", "author": "gszadovszky", "createdAt": "2020-07-28T12:49:29Z", "path": "parquet-hadoop/README.md", "diffHunk": "@@ -239,6 +239,12 @@ conf.set(\"parquet.bloom.filter.expected.ndv#column.path\", 200)\n **Description:** Whether to write out page level checksums.  \n **Default value:** `true`\n \n+---\n+\n+**Property:** `parquet.crypto.factory.class`  \n+**Description:** Class implementing EncryptionPropertiesFactory.", "originalCommit": "22a5ae1ea8d7ef3b93d037932c3de4a14a1e41cf", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}