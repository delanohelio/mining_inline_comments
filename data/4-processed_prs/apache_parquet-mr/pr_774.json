{"pr_number": 774, "pr_title": "PARQUET-1821: Add 'column-size' command to parquet-cli and parquet-tools", "pr_createdAt": "2020-03-19T16:25:37Z", "pr_url": "https://github.com/apache/parquet-mr/pull/774", "timeline": [{"oid": "f12c04b9bba3fb6274308f587cd3634fc9c6308d", "url": "https://github.com/apache/parquet-mr/commit/f12c04b9bba3fb6274308f587cd3634fc9c6308d", "message": "PARQUET-1821: Add 'column-size' command to parquet-cli and parquet-tools", "committedDate": "2020-03-20T13:41:08Z", "type": "forcePushed"}, {"oid": "30e451b80fd81433ddabeb666bda89ab8b43d50c", "url": "https://github.com/apache/parquet-mr/commit/30e451b80fd81433ddabeb666bda89ab8b43d50c", "message": "PARQUET-1821: Add 'column-size' command to parquet-cli and parquet-tools", "committedDate": "2020-03-20T13:44:18Z", "type": "forcePushed"}, {"oid": "749e5dfff61e1dbbe050dc9ad6916f366bbd8b08", "url": "https://github.com/apache/parquet-mr/commit/749e5dfff61e1dbbe050dc9ad6916f366bbd8b08", "message": "PARQUET-1821: Add 'column-size' command to parquet-cli and parquet-tools", "committedDate": "2020-03-20T14:09:00Z", "type": "commit"}, {"oid": "749e5dfff61e1dbbe050dc9ad6916f366bbd8b08", "url": "https://github.com/apache/parquet-mr/commit/749e5dfff61e1dbbe050dc9ad6916f366bbd8b08", "message": "PARQUET-1821: Add 'column-size' command to parquet-cli and parquet-tools", "committedDate": "2020-03-20T14:09:00Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODQ0ODI2Ng==", "url": "https://github.com/apache/parquet-mr/pull/774#discussion_r398448266", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                // If user inputted columns, only print out size for those columns\n          \n          \n            \n                // If user defined columns, only print out size for those columns", "author": "gszadovszky", "createdAt": "2020-03-26T10:01:14Z", "path": "parquet-cli/src/main/java/org/apache/parquet/cli/commands/ColumnSizeCommand.java", "diffHunk": "@@ -0,0 +1,132 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.parquet.cli.commands;\n+\n+import com.beust.jcommander.Parameter;\n+import com.beust.jcommander.Parameters;\n+import com.google.common.base.Preconditions;\n+import com.google.common.collect.Lists;\n+import org.apache.avro.file.SeekableInput;\n+import org.apache.hadoop.conf.Configuration;\n+import org.apache.hadoop.fs.FileSystem;\n+import org.apache.hadoop.fs.Path;\n+import org.apache.parquet.cli.BaseCommand;\n+import org.apache.parquet.cli.util.Formats;\n+import org.apache.parquet.format.converter.ParquetMetadataConverter;\n+import org.apache.parquet.hadoop.ParquetFileReader;\n+import org.apache.parquet.hadoop.metadata.BlockMetaData;\n+import org.apache.parquet.hadoop.metadata.ColumnChunkMetaData;\n+import org.apache.parquet.hadoop.metadata.ParquetMetadata;\n+import org.slf4j.Logger;\n+\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.OutputStream;\n+import java.nio.charset.StandardCharsets;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+@Parameters(commandDescription=\"Print the column sizes of a parquet file\")\n+public class ColumnSizeCommand extends BaseCommand {\n+\n+  public ColumnSizeCommand(Logger console) {\n+    super(console);\n+  }\n+\n+  @Parameter(description = \"<parquet path>\")\n+  String target;\n+\n+  @Parameter(\n+    names = {\"-c\", \"--column\", \"--columns\"},\n+    description = \"List of columns\",\n+    required = false)\n+  List<String> columns;\n+\n+  @Override\n+  @SuppressWarnings(\"unchecked\")\n+  public int run() throws IOException {\n+    Preconditions.checkArgument(target != null,\n+      \"A Parquet file is required.\");\n+\n+    Path inputFile = new Path(target);\n+    Map<String, Long> columnSizes = getColumnSizeInBytes(inputFile);\n+    Map<String, Float> columnPercentage = getColumnPercentage(columnSizes);\n+\n+    // If user inputted columns, only print out size for those columns", "originalCommit": "749e5dfff61e1dbbe050dc9ad6916f366bbd8b08", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODQ1ODQzMw==", "url": "https://github.com/apache/parquet-mr/pull/774#discussion_r398458433", "bodyText": "I think this behavior is misleading. What if the columns in the file are id and identity and you want to query the size of the column id?\nI would suggest checking equality and simply print the result instead of summarizing.", "author": "gszadovszky", "createdAt": "2020-03-26T10:17:39Z", "path": "parquet-cli/src/main/java/org/apache/parquet/cli/commands/ColumnSizeCommand.java", "diffHunk": "@@ -0,0 +1,132 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.parquet.cli.commands;\n+\n+import com.beust.jcommander.Parameter;\n+import com.beust.jcommander.Parameters;\n+import com.google.common.base.Preconditions;\n+import com.google.common.collect.Lists;\n+import org.apache.avro.file.SeekableInput;\n+import org.apache.hadoop.conf.Configuration;\n+import org.apache.hadoop.fs.FileSystem;\n+import org.apache.hadoop.fs.Path;\n+import org.apache.parquet.cli.BaseCommand;\n+import org.apache.parquet.cli.util.Formats;\n+import org.apache.parquet.format.converter.ParquetMetadataConverter;\n+import org.apache.parquet.hadoop.ParquetFileReader;\n+import org.apache.parquet.hadoop.metadata.BlockMetaData;\n+import org.apache.parquet.hadoop.metadata.ColumnChunkMetaData;\n+import org.apache.parquet.hadoop.metadata.ParquetMetadata;\n+import org.slf4j.Logger;\n+\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.OutputStream;\n+import java.nio.charset.StandardCharsets;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+@Parameters(commandDescription=\"Print the column sizes of a parquet file\")\n+public class ColumnSizeCommand extends BaseCommand {\n+\n+  public ColumnSizeCommand(Logger console) {\n+    super(console);\n+  }\n+\n+  @Parameter(description = \"<parquet path>\")\n+  String target;\n+\n+  @Parameter(\n+    names = {\"-c\", \"--column\", \"--columns\"},\n+    description = \"List of columns\",\n+    required = false)\n+  List<String> columns;\n+\n+  @Override\n+  @SuppressWarnings(\"unchecked\")\n+  public int run() throws IOException {\n+    Preconditions.checkArgument(target != null,\n+      \"A Parquet file is required.\");\n+\n+    Path inputFile = new Path(target);\n+    Map<String, Long> columnSizes = getColumnSizeInBytes(inputFile);\n+    Map<String, Float> columnPercentage = getColumnPercentage(columnSizes);\n+\n+    // If user inputted columns, only print out size for those columns\n+    if (columns != null && columns.size() > 0) {\n+      for (String inputColumn : columns) {\n+        long size = 0;\n+        float percentage = 0;\n+        for (String column : columnSizes.keySet()) {", "originalCommit": "749e5dfff61e1dbbe050dc9ad6916f366bbd8b08", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODY0MTkwMw==", "url": "https://github.com/apache/parquet-mr/pull/774#discussion_r398641903", "bodyText": "Good finding! What if we change to 'if (column.equals(inputColumn) || column.startsWith(inputColumn + \".\"))'?\nIn some use cases, I see a parent field can have 50+ child fields. If a user wants to see that parent field, it would be cumbersome to input 50+ fields in the command.", "author": "shangxinli", "createdAt": "2020-03-26T15:01:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODQ1ODQzMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTE1MjY0NA==", "url": "https://github.com/apache/parquet-mr/pull/774#discussion_r399152644", "bodyText": "It sounds good to me. It should be documented in the command line, though.", "author": "gszadovszky", "createdAt": "2020-03-27T10:00:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODQ1ODQzMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODQ2MjA5Mg==", "url": "https://github.com/apache/parquet-mr/pull/774#discussion_r398462092", "bodyText": "I think, one of -c, --column or --columns is missing from here", "author": "gszadovszky", "createdAt": "2020-03-26T10:23:26Z", "path": "parquet-cli/src/main/java/org/apache/parquet/cli/commands/ColumnSizeCommand.java", "diffHunk": "@@ -0,0 +1,132 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.parquet.cli.commands;\n+\n+import com.beust.jcommander.Parameter;\n+import com.beust.jcommander.Parameters;\n+import com.google.common.base.Preconditions;\n+import com.google.common.collect.Lists;\n+import org.apache.avro.file.SeekableInput;\n+import org.apache.hadoop.conf.Configuration;\n+import org.apache.hadoop.fs.FileSystem;\n+import org.apache.hadoop.fs.Path;\n+import org.apache.parquet.cli.BaseCommand;\n+import org.apache.parquet.cli.util.Formats;\n+import org.apache.parquet.format.converter.ParquetMetadataConverter;\n+import org.apache.parquet.hadoop.ParquetFileReader;\n+import org.apache.parquet.hadoop.metadata.BlockMetaData;\n+import org.apache.parquet.hadoop.metadata.ColumnChunkMetaData;\n+import org.apache.parquet.hadoop.metadata.ParquetMetadata;\n+import org.slf4j.Logger;\n+\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.OutputStream;\n+import java.nio.charset.StandardCharsets;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+@Parameters(commandDescription=\"Print the column sizes of a parquet file\")\n+public class ColumnSizeCommand extends BaseCommand {\n+\n+  public ColumnSizeCommand(Logger console) {\n+    super(console);\n+  }\n+\n+  @Parameter(description = \"<parquet path>\")\n+  String target;\n+\n+  @Parameter(\n+    names = {\"-c\", \"--column\", \"--columns\"},\n+    description = \"List of columns\",\n+    required = false)\n+  List<String> columns;\n+\n+  @Override\n+  @SuppressWarnings(\"unchecked\")\n+  public int run() throws IOException {\n+    Preconditions.checkArgument(target != null,\n+      \"A Parquet file is required.\");\n+\n+    Path inputFile = new Path(target);\n+    Map<String, Long> columnSizes = getColumnSizeInBytes(inputFile);\n+    Map<String, Float> columnPercentage = getColumnPercentage(columnSizes);\n+\n+    // If user inputted columns, only print out size for those columns\n+    if (columns != null && columns.size() > 0) {\n+      for (String inputColumn : columns) {\n+        long size = 0;\n+        float percentage = 0;\n+        for (String column : columnSizes.keySet()) {\n+          if (column.startsWith(inputColumn)) {\n+            size += columnSizes.get(column);\n+            percentage += columnPercentage.get(column);\n+          }\n+        }\n+        console.info(inputColumn + \"->\" + \" Size In Bytes: \" + size + \" Size In Percentage: \" + percentage);\n+      }\n+    } else {\n+      for (String column : columnSizes.keySet()) {\n+        console.info(column + \"->\" + \" Size In Bytes: \" + columnSizes.get(column)\n+          + \" Size In Percentage: \" + columnPercentage.get(column));\n+      }\n+    }\n+\n+    return 0;\n+  }\n+\n+  @Override\n+  public List<String> getExamples() {\n+    return Lists.newArrayList(\n+        \"# Print every column size in byte and percentage for a Parquet file\",\n+        \"sample.parquet\",\n+        \"sample.parquet col_1 col_2\",\n+        \"sample.parquet col_1 col_2.sub_col_a\"", "originalCommit": "749e5dfff61e1dbbe050dc9ad6916f366bbd8b08", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODY0NTMzNg==", "url": "https://github.com/apache/parquet-mr/pull/774#discussion_r398645336", "bodyText": "Got it.", "author": "shangxinli", "createdAt": "2020-03-26T15:05:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODQ2MjA5Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODQ2Njg2MQ==", "url": "https://github.com/apache/parquet-mr/pull/774#discussion_r398466861", "bodyText": "This is not percentage but ratio.", "author": "gszadovszky", "createdAt": "2020-03-26T10:31:17Z", "path": "parquet-cli/src/main/java/org/apache/parquet/cli/commands/ColumnSizeCommand.java", "diffHunk": "@@ -0,0 +1,132 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.parquet.cli.commands;\n+\n+import com.beust.jcommander.Parameter;\n+import com.beust.jcommander.Parameters;\n+import com.google.common.base.Preconditions;\n+import com.google.common.collect.Lists;\n+import org.apache.avro.file.SeekableInput;\n+import org.apache.hadoop.conf.Configuration;\n+import org.apache.hadoop.fs.FileSystem;\n+import org.apache.hadoop.fs.Path;\n+import org.apache.parquet.cli.BaseCommand;\n+import org.apache.parquet.cli.util.Formats;\n+import org.apache.parquet.format.converter.ParquetMetadataConverter;\n+import org.apache.parquet.hadoop.ParquetFileReader;\n+import org.apache.parquet.hadoop.metadata.BlockMetaData;\n+import org.apache.parquet.hadoop.metadata.ColumnChunkMetaData;\n+import org.apache.parquet.hadoop.metadata.ParquetMetadata;\n+import org.slf4j.Logger;\n+\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.OutputStream;\n+import java.nio.charset.StandardCharsets;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+@Parameters(commandDescription=\"Print the column sizes of a parquet file\")\n+public class ColumnSizeCommand extends BaseCommand {\n+\n+  public ColumnSizeCommand(Logger console) {\n+    super(console);\n+  }\n+\n+  @Parameter(description = \"<parquet path>\")\n+  String target;\n+\n+  @Parameter(\n+    names = {\"-c\", \"--column\", \"--columns\"},\n+    description = \"List of columns\",\n+    required = false)\n+  List<String> columns;\n+\n+  @Override\n+  @SuppressWarnings(\"unchecked\")\n+  public int run() throws IOException {\n+    Preconditions.checkArgument(target != null,\n+      \"A Parquet file is required.\");\n+\n+    Path inputFile = new Path(target);\n+    Map<String, Long> columnSizes = getColumnSizeInBytes(inputFile);\n+    Map<String, Float> columnPercentage = getColumnPercentage(columnSizes);\n+\n+    // If user inputted columns, only print out size for those columns\n+    if (columns != null && columns.size() > 0) {\n+      for (String inputColumn : columns) {\n+        long size = 0;\n+        float percentage = 0;\n+        for (String column : columnSizes.keySet()) {\n+          if (column.startsWith(inputColumn)) {\n+            size += columnSizes.get(column);\n+            percentage += columnPercentage.get(column);\n+          }\n+        }\n+        console.info(inputColumn + \"->\" + \" Size In Bytes: \" + size + \" Size In Percentage: \" + percentage);\n+      }\n+    } else {\n+      for (String column : columnSizes.keySet()) {\n+        console.info(column + \"->\" + \" Size In Bytes: \" + columnSizes.get(column)\n+          + \" Size In Percentage: \" + columnPercentage.get(column));\n+      }\n+    }\n+\n+    return 0;\n+  }\n+\n+  @Override\n+  public List<String> getExamples() {\n+    return Lists.newArrayList(\n+        \"# Print every column size in byte and percentage for a Parquet file\",\n+        \"sample.parquet\",\n+        \"sample.parquet col_1 col_2\",\n+        \"sample.parquet col_1 col_2.sub_col_a\"\n+    );\n+  }\n+\n+  // Make it public to allow some automation tools to call it\n+  public Map<String, Long> getColumnSizeInBytes(Path inputFile) throws IOException {\n+    Map<String, Long> colSizes = new HashMap<>();\n+    ParquetMetadata pmd = ParquetFileReader.readFooter(new Configuration(), inputFile, ParquetMetadataConverter.NO_FILTER);\n+\n+    for (BlockMetaData block : pmd.getBlocks()) {\n+      for (ColumnChunkMetaData column : block.getColumns()) {\n+        String colName = column.getPath().toDotString();\n+        colSizes.put(colName, column.getTotalSize() + colSizes.getOrDefault(colName, 0L));\n+      }\n+    }\n+\n+    return colSizes;\n+  }\n+\n+  // Make it public to allow some automation tools to call it\n+  public Map<String, Float> getColumnPercentage(Map<String, Long> colSizes) {\n+    long totalSize = colSizes.values().stream().reduce(0L, Long::sum);\n+    Map<String, Float> colPercentage = new HashMap<>();\n+\n+    for (Map.Entry<String, Long> entry : colSizes.entrySet()) {\n+      colPercentage.put(entry.getKey(), ((float) entry.getValue()) / ((float) totalSize));", "originalCommit": "749e5dfff61e1dbbe050dc9ad6916f366bbd8b08", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODY0ODI2Nw==", "url": "https://github.com/apache/parquet-mr/pull/774#discussion_r398648267", "bodyText": "changed to ratio", "author": "shangxinli", "createdAt": "2020-03-26T15:08:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODQ2Njg2MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODQ3MTA0Mw==", "url": "https://github.com/apache/parquet-mr/pull/774#discussion_r398471043", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                \"where <input> is the parquet file to calculate teh column size\" +\n          \n          \n            \n                \"     [<column> ...] are the columns in the case sensitive dot format\" +\n          \n          \n            \n                \"     to be calculated, for example a.b.c. If no columns are input, all the\" +\n          \n          \n            \n                \"     columns will be printed out\"\n          \n          \n            \n                \"where <input> is the parquet file to calculate the column size\" +\n          \n          \n            \n                \"     [<column> ...] are the columns in the case sensitive dot format\" +\n          \n          \n            \n                \"     to be calculated, for example a.b.c. If no columns are set, all the\" +\n          \n          \n            \n                \"     columns will be printed out\"", "author": "gszadovszky", "createdAt": "2020-03-26T10:38:13Z", "path": "parquet-tools/src/main/java/org/apache/parquet/tools/command/ColumnSizeCommand.java", "diffHunk": "@@ -0,0 +1,121 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.parquet.tools.command;\n+\n+import org.apache.commons.cli.CommandLine;\n+import org.apache.hadoop.conf.Configuration;\n+import org.apache.hadoop.fs.Path;\n+import org.apache.parquet.format.converter.ParquetMetadataConverter;\n+import org.apache.parquet.hadoop.ParquetFileReader;\n+import org.apache.parquet.hadoop.metadata.BlockMetaData;\n+import org.apache.parquet.hadoop.metadata.ColumnChunkMetaData;\n+import org.apache.parquet.hadoop.metadata.ParquetMetadata;\n+import org.apache.parquet.tools.Main;\n+\n+import java.io.IOException;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+public class ColumnSizeCommand extends ArgsOnlyCommand {\n+\n+  public static final String[] USAGE = new String[] {\n+    \"<input>\",\n+    \"where <input> is the parquet file to calculate teh column size\" +\n+    \"     [<column> ...] are the columns in the case sensitive dot format\" +\n+    \"     to be calculated, for example a.b.c. If no columns are input, all the\" +\n+    \"     columns will be printed out\"", "originalCommit": "749e5dfff61e1dbbe050dc9ad6916f366bbd8b08", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODQ3MjE5Nw==", "url": "https://github.com/apache/parquet-mr/pull/774#discussion_r398472197", "bodyText": "See my comment at cli.", "author": "gszadovszky", "createdAt": "2020-03-26T10:40:07Z", "path": "parquet-tools/src/main/java/org/apache/parquet/tools/command/ColumnSizeCommand.java", "diffHunk": "@@ -0,0 +1,121 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.parquet.tools.command;\n+\n+import org.apache.commons.cli.CommandLine;\n+import org.apache.hadoop.conf.Configuration;\n+import org.apache.hadoop.fs.Path;\n+import org.apache.parquet.format.converter.ParquetMetadataConverter;\n+import org.apache.parquet.hadoop.ParquetFileReader;\n+import org.apache.parquet.hadoop.metadata.BlockMetaData;\n+import org.apache.parquet.hadoop.metadata.ColumnChunkMetaData;\n+import org.apache.parquet.hadoop.metadata.ParquetMetadata;\n+import org.apache.parquet.tools.Main;\n+\n+import java.io.IOException;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+public class ColumnSizeCommand extends ArgsOnlyCommand {\n+\n+  public static final String[] USAGE = new String[] {\n+    \"<input>\",\n+    \"where <input> is the parquet file to calculate teh column size\" +\n+    \"     [<column> ...] are the columns in the case sensitive dot format\" +\n+    \"     to be calculated, for example a.b.c. If no columns are input, all the\" +\n+    \"     columns will be printed out\"\n+  };\n+\n+  /**\n+   * Biggest number of columns we can calculate.\n+   */\n+  private static final int MAX_COL_NUM = 100;\n+\n+  public ColumnSizeCommand() {\n+    super(1, 1 + MAX_COL_NUM);\n+  }\n+\n+  @Override\n+  public String[] getUsageDescription() {\n+    return USAGE;\n+  }\n+\n+  @Override\n+  public String getCommandDescription() {\n+    return \"Print out the size in bytes and percentage of column(s) in the input Parquet file\";\n+  }\n+\n+  @Override\n+  public void execute(CommandLine options) throws Exception {\n+    super.execute(options);\n+    List<String> args = options.getArgList();\n+    Path inputFile = new Path(args.get(0));\n+\n+    Map<String, Long> columnSizes = getColumnSizeInBytes(inputFile);\n+    Map<String, Float> columnPercentage = getColumnPercentage(columnSizes);\n+\n+    if (args.size() > 1) {\n+      for (String inputColumn : args.subList(1, args.size())) {\n+        long size = 0;\n+        float percentage = 0;\n+        for (String column : columnSizes.keySet()) {\n+          if (column.startsWith(inputColumn)) {", "originalCommit": "749e5dfff61e1dbbe050dc9ad6916f366bbd8b08", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODY0ODgwNA==", "url": "https://github.com/apache/parquet-mr/pull/774#discussion_r398648804", "bodyText": "Thanks.", "author": "shangxinli", "createdAt": "2020-03-26T15:09:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODQ3MjE5Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODQ3MjI5NA==", "url": "https://github.com/apache/parquet-mr/pull/774#discussion_r398472294", "bodyText": "See my comment at cli.", "author": "gszadovszky", "createdAt": "2020-03-26T10:40:15Z", "path": "parquet-tools/src/main/java/org/apache/parquet/tools/command/ColumnSizeCommand.java", "diffHunk": "@@ -0,0 +1,121 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.parquet.tools.command;\n+\n+import org.apache.commons.cli.CommandLine;\n+import org.apache.hadoop.conf.Configuration;\n+import org.apache.hadoop.fs.Path;\n+import org.apache.parquet.format.converter.ParquetMetadataConverter;\n+import org.apache.parquet.hadoop.ParquetFileReader;\n+import org.apache.parquet.hadoop.metadata.BlockMetaData;\n+import org.apache.parquet.hadoop.metadata.ColumnChunkMetaData;\n+import org.apache.parquet.hadoop.metadata.ParquetMetadata;\n+import org.apache.parquet.tools.Main;\n+\n+import java.io.IOException;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+public class ColumnSizeCommand extends ArgsOnlyCommand {\n+\n+  public static final String[] USAGE = new String[] {\n+    \"<input>\",\n+    \"where <input> is the parquet file to calculate teh column size\" +\n+    \"     [<column> ...] are the columns in the case sensitive dot format\" +\n+    \"     to be calculated, for example a.b.c. If no columns are input, all the\" +\n+    \"     columns will be printed out\"\n+  };\n+\n+  /**\n+   * Biggest number of columns we can calculate.\n+   */\n+  private static final int MAX_COL_NUM = 100;\n+\n+  public ColumnSizeCommand() {\n+    super(1, 1 + MAX_COL_NUM);\n+  }\n+\n+  @Override\n+  public String[] getUsageDescription() {\n+    return USAGE;\n+  }\n+\n+  @Override\n+  public String getCommandDescription() {\n+    return \"Print out the size in bytes and percentage of column(s) in the input Parquet file\";\n+  }\n+\n+  @Override\n+  public void execute(CommandLine options) throws Exception {\n+    super.execute(options);\n+    List<String> args = options.getArgList();\n+    Path inputFile = new Path(args.get(0));\n+\n+    Map<String, Long> columnSizes = getColumnSizeInBytes(inputFile);\n+    Map<String, Float> columnPercentage = getColumnPercentage(columnSizes);\n+\n+    if (args.size() > 1) {\n+      for (String inputColumn : args.subList(1, args.size())) {\n+        long size = 0;\n+        float percentage = 0;\n+        for (String column : columnSizes.keySet()) {\n+          if (column.startsWith(inputColumn)) {\n+            size += columnSizes.get(column);\n+            percentage += columnPercentage.get(column);\n+          }\n+        }\n+        Main.out.println(inputColumn + \"->\" + \" Size In Bytes: \" + size + \" Size In Percentage: \" + percentage);\n+      }\n+    } else {\n+      for (String column : columnSizes.keySet()) {\n+        Main.out.println(column + \"->\" + \" Size In Bytes: \" + columnSizes.get(column)\n+          + \" Size In Percentage: \" + columnPercentage.get(column));\n+      }\n+    }\n+  }\n+\n+  // Make it public to allow some automation tools to call it\n+  public Map<String, Long> getColumnSizeInBytes(Path inputFile) throws IOException {\n+    Map<String, Long> colSizes = new HashMap<>();\n+    ParquetMetadata pmd = ParquetFileReader.readFooter(new Configuration(), inputFile, ParquetMetadataConverter.NO_FILTER);\n+\n+    for (BlockMetaData block : pmd.getBlocks()) {\n+      for (ColumnChunkMetaData column : block.getColumns()) {\n+        String colName = column.getPath().toDotString();\n+        colSizes.put(colName, column.getTotalSize() + colSizes.getOrDefault(colName, 0L));\n+      }\n+    }\n+\n+    return colSizes;\n+  }\n+\n+  // Make it public to allow some automation tools to call it\n+  public Map<String, Float> getColumnPercentage(Map<String, Long> colSizes) {\n+    long totalSize = colSizes.values().stream().reduce(0L, Long::sum);\n+    Map<String, Float> colPercentage = new HashMap<>();\n+\n+    for (Map.Entry<String, Long> entry : colSizes.entrySet()) {\n+      colPercentage.put(entry.getKey(), ((float) entry.getValue()) / ((float) totalSize));", "originalCommit": "749e5dfff61e1dbbe050dc9ad6916f366bbd8b08", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODY0ODg1NQ==", "url": "https://github.com/apache/parquet-mr/pull/774#discussion_r398648855", "bodyText": "Thanks.", "author": "shangxinli", "createdAt": "2020-03-26T15:09:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODQ3MjI5NA=="}], "type": "inlineReview"}, {"oid": "6b9327444535cfcab2184f138ca440d8c822c6d0", "url": "https://github.com/apache/parquet-mr/commit/6b9327444535cfcab2184f138ca440d8c822c6d0", "message": "Update parquet-cli/src/main/java/org/apache/parquet/cli/commands/ColumnSizeCommand.java\n\nCo-Authored-By: Gabor Szadovszky <gabor@apache.org>", "committedDate": "2020-03-26T14:36:47Z", "type": "commit"}, {"oid": "2c19fab8b7810113862bc4d656f2c422f534533f", "url": "https://github.com/apache/parquet-mr/commit/2c19fab8b7810113862bc4d656f2c422f534533f", "message": "Update parquet-tools/src/main/java/org/apache/parquet/tools/command/ColumnSizeCommand.java\n\nCo-Authored-By: Gabor Szadovszky <gabor@apache.org>", "committedDate": "2020-03-26T14:46:09Z", "type": "commit"}, {"oid": "e3f2cac3c8a954f4a20fb1026507a011d5151aff", "url": "https://github.com/apache/parquet-mr/commit/e3f2cac3c8a954f4a20fb1026507a011d5151aff", "message": "Address feedback", "committedDate": "2020-03-26T18:02:51Z", "type": "commit"}, {"oid": "e3f2cac3c8a954f4a20fb1026507a011d5151aff", "url": "https://github.com/apache/parquet-mr/commit/e3f2cac3c8a954f4a20fb1026507a011d5151aff", "message": "Address feedback", "committedDate": "2020-03-26T18:02:51Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTE1Mzk1Mw==", "url": "https://github.com/apache/parquet-mr/pull/774#discussion_r399153953", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    \"sample.parquet -column col_2\",\n          \n          \n            \n                    \"sample.parquet -columns col_1 col_2\",\n          \n          \n            \n                    \"sample.parquet -columns col_1 col_2.sub_col_a\"\n          \n          \n            \n                    \"sample.parquet --column col_2\",\n          \n          \n            \n                    \"sample.parquet --columns col_1 col_2\",\n          \n          \n            \n                    \"sample.parquet --columns col_1 col_2.sub_col_a\"", "author": "gszadovszky", "createdAt": "2020-03-27T10:02:26Z", "path": "parquet-cli/src/main/java/org/apache/parquet/cli/commands/ColumnSizeCommand.java", "diffHunk": "@@ -0,0 +1,134 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.parquet.cli.commands;\n+\n+import com.beust.jcommander.Parameter;\n+import com.beust.jcommander.Parameters;\n+import com.google.common.base.Preconditions;\n+import com.google.common.collect.Lists;\n+import org.apache.avro.file.SeekableInput;\n+import org.apache.hadoop.conf.Configuration;\n+import org.apache.hadoop.fs.FileSystem;\n+import org.apache.hadoop.fs.Path;\n+import org.apache.parquet.cli.BaseCommand;\n+import org.apache.parquet.cli.util.Formats;\n+import org.apache.parquet.format.converter.ParquetMetadataConverter;\n+import org.apache.parquet.hadoop.ParquetFileReader;\n+import org.apache.parquet.hadoop.metadata.BlockMetaData;\n+import org.apache.parquet.hadoop.metadata.ColumnChunkMetaData;\n+import org.apache.parquet.hadoop.metadata.ParquetMetadata;\n+import org.slf4j.Logger;\n+\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.OutputStream;\n+import java.nio.charset.StandardCharsets;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+@Parameters(commandDescription=\"Print the column sizes of a parquet file\")\n+public class ColumnSizeCommand extends BaseCommand {\n+\n+  public ColumnSizeCommand(Logger console) {\n+    super(console);\n+  }\n+\n+  @Parameter(description = \"<parquet path>\")\n+  String target;\n+\n+  @Parameter(\n+    names = {\"-c\", \"--column\", \"--columns\"},\n+    description = \"List of columns\",\n+    required = false)\n+  List<String> columns;\n+\n+  @Override\n+  @SuppressWarnings(\"unchecked\")\n+  public int run() throws IOException {\n+    Preconditions.checkArgument(target != null,\n+      \"A Parquet file is required.\");\n+\n+    Path inputFile = new Path(target);\n+    Map<String, Long> columnSizes = getColumnSizeInBytes(inputFile);\n+    Map<String, Float> columnRatio = getColumnRatio(columnSizes);\n+\n+    // If user defined columns, only print out size for those columns\n+    if (columns != null && columns.size() > 0) {\n+      for (String inputColumn : columns) {\n+        long size = 0;\n+        float ratio = 0;\n+        for (String column : columnSizes.keySet()) {\n+          if (column.equals(inputColumn) || column.startsWith(inputColumn + \".\")) {\n+            size += columnSizes.get(column);\n+            ratio += columnRatio.get(column);\n+          }\n+        }\n+        console.info(inputColumn + \"->\" + \" Size In Bytes: \" + size + \" Size In Ratio: \" + ratio);\n+      }\n+    } else {\n+      for (String column : columnSizes.keySet()) {\n+        console.info(column + \"->\" + \" Size In Bytes: \" + columnSizes.get(column)\n+          + \" Size In Ratio: \" + columnRatio.get(column));\n+      }\n+    }\n+\n+    return 0;\n+  }\n+\n+  @Override\n+  public List<String> getExamples() {\n+    return Lists.newArrayList(\n+        \"# Print every column size in byte and ratio for a Parquet file\",\n+        \"sample.parquet\",\n+        \"sample.parquet -c col_1\",\n+        \"sample.parquet -column col_2\",\n+        \"sample.parquet -columns col_1 col_2\",\n+        \"sample.parquet -columns col_1 col_2.sub_col_a\"", "originalCommit": "e3f2cac3c8a954f4a20fb1026507a011d5151aff", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "e60f0a5f724aa36a72d8c6a0b5fb9dc76f61b2aa", "url": "https://github.com/apache/parquet-mr/commit/e60f0a5f724aa36a72d8c6a0b5fb9dc76f61b2aa", "message": "Update parquet-cli/src/main/java/org/apache/parquet/cli/commands/ColumnSizeCommand.java\n\nCo-Authored-By: Gabor Szadovszky <gabor@apache.org>", "committedDate": "2020-03-27T14:30:33Z", "type": "commit"}, {"oid": "1be782b2f1609d9aa6386d48aacfd64c622d0035", "url": "https://github.com/apache/parquet-mr/commit/1be782b2f1609d9aa6386d48aacfd64c622d0035", "message": "Add comments for column path in help document", "committedDate": "2020-03-27T14:55:19Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTc3MTU3Mg==", "url": "https://github.com/apache/parquet-mr/pull/774#discussion_r399771572", "bodyText": "Instead of having this file, we can use a JUnit rule: \n  \n    \n      parquet-mr/parquet-cli/src/test/java/org/apache/parquet/cli/commands/FileTest.java\n    \n    \n         Line 42\n      in\n      c3e1a84\n    \n    \n    \n    \n\n        \n          \n           public TemporaryFolder tempFolder = new TemporaryFolder(); \n        \n    \n  \n\n\nThen we can do: temporaryFolder.newFile(\"test.parquet\");\nWould be nice to keep this consistent", "author": "Fokko", "createdAt": "2020-03-29T09:36:37Z", "path": "parquet-tools/src/test/java/org/apache/parquet/tools/command/TestColumnSizeCommand.java", "diffHunk": "@@ -0,0 +1,88 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.parquet.tools.command;\n+\n+import org.apache.hadoop.conf.Configuration;\n+import org.apache.hadoop.fs.Path;\n+import org.apache.parquet.example.data.simple.SimpleGroup;\n+import org.apache.parquet.hadoop.ParquetWriter;\n+import org.apache.parquet.hadoop.example.ExampleParquetWriter;\n+import org.apache.parquet.hadoop.example.GroupWriteSupport;\n+import org.apache.parquet.schema.MessageType;\n+import org.apache.parquet.schema.PrimitiveType;\n+import org.junit.Test;\n+\n+import java.io.IOException;\n+import java.nio.file.Files;\n+import java.util.Map;\n+import java.util.Random;\n+\n+import static org.apache.parquet.schema.PrimitiveType.PrimitiveTypeName.INT32;\n+import static org.apache.parquet.schema.PrimitiveType.PrimitiveTypeName.INT64;\n+import static org.apache.parquet.schema.Type.Repetition.REQUIRED;\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertTrue;\n+\n+public class TestColumnSizeCommand {\n+\n+  private final int numRecord = 10000;\n+  private ColumnSizeCommand command = new ColumnSizeCommand();\n+  private Configuration conf = new Configuration();\n+\n+  @Test\n+  public void testColumnSize() throws Exception {\n+    String inputFile = createParquetFile(\"input\");\n+    Map<String, Long> columnSizeInBytes = command.getColumnSizeInBytes(new Path(inputFile));\n+    assertEquals(columnSizeInBytes.size(), 2);\n+    assertTrue(columnSizeInBytes.get(\"DocId\") > columnSizeInBytes.get(\"Num\"));\n+    Map<String, Float> columnRatio = command.getColumnRatio(columnSizeInBytes);\n+    assertTrue(columnRatio.get(\"DocId\") > columnRatio.get(\"Num\"));\n+  }\n+\n+  private String createParquetFile(String prefix) throws IOException {\n+    MessageType schema = new MessageType(\"schema\",\n+      new PrimitiveType(REQUIRED, INT64, \"DocId\"),\n+      new PrimitiveType(REQUIRED, INT32, \"Num\"));\n+\n+    conf.set(GroupWriteSupport.PARQUET_EXAMPLE_SCHEMA, schema.toString());\n+\n+    String file = createTempFile(prefix);\n+    ExampleParquetWriter.Builder builder = ExampleParquetWriter.builder(new Path(file)).withConf(conf);\n+    Random rnd = new Random();\n+    try (ParquetWriter writer = builder.build()) {\n+      for (int i = 0; i < numRecord; i++) {\n+        SimpleGroup g = new SimpleGroup(schema);\n+        g.add(\"DocId\", rnd.nextLong());\n+        g.add(\"Num\", rnd.nextInt());\n+        writer.write(g);\n+      }\n+    }\n+\n+    return file;\n+  }\n+\n+  private static String createTempFile(String prefix) {", "originalCommit": "1be782b2f1609d9aa6386d48aacfd64c622d0035", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTgxNDk5Nw==", "url": "https://github.com/apache/parquet-mr/pull/774#discussion_r399814997", "bodyText": "Sounds good!", "author": "shangxinli", "createdAt": "2020-03-29T15:42:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTc3MTU3Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTc3MTY0Nw==", "url": "https://github.com/apache/parquet-mr/pull/774#discussion_r399771647", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    Main.out.println(inputColumn + \"->\" + \" Size In Bytes: \" + size + \" Size In Ratio: \" + ratio);\n          \n          \n            \n                    Main.out.println(inputColumn + \"-> Size In Bytes: \" + size + \" Size In Ratio: \" + ratio);", "author": "Fokko", "createdAt": "2020-03-29T09:37:27Z", "path": "parquet-tools/src/main/java/org/apache/parquet/tools/command/ColumnSizeCommand.java", "diffHunk": "@@ -0,0 +1,121 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.parquet.tools.command;\n+\n+import org.apache.commons.cli.CommandLine;\n+import org.apache.hadoop.conf.Configuration;\n+import org.apache.hadoop.fs.Path;\n+import org.apache.parquet.format.converter.ParquetMetadataConverter;\n+import org.apache.parquet.hadoop.ParquetFileReader;\n+import org.apache.parquet.hadoop.metadata.BlockMetaData;\n+import org.apache.parquet.hadoop.metadata.ColumnChunkMetaData;\n+import org.apache.parquet.hadoop.metadata.ParquetMetadata;\n+import org.apache.parquet.tools.Main;\n+\n+import java.io.IOException;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+public class ColumnSizeCommand extends ArgsOnlyCommand {\n+\n+  public static final String[] USAGE = new String[] {\n+    \"<input>\",\n+    \"where <input> is the parquet file to calculate the column size\" +\n+    \"     [<column> ...] are the columns in the case sensitive dot format\" +\n+    \"     to be calculated, for example a.b.c. If an input column is intermediate\" +\n+    \"     column, all the child columns will be printed out. If no columns are\" +\n+    \"     set, all the columns will be printed out.\"\n+  };\n+\n+  /**\n+   * Biggest number of columns we can calculate.\n+   */\n+  private static final int MAX_COL_NUM = 100;\n+\n+  public ColumnSizeCommand() {\n+    super(1, 1 + MAX_COL_NUM);\n+  }\n+\n+  @Override\n+  public String[] getUsageDescription() {\n+    return USAGE;\n+  }\n+\n+  @Override\n+  public String getCommandDescription() {\n+    return \"Print out the size in bytes and ratio of column(s) in the input Parquet file\";\n+  }\n+\n+  @Override\n+  public void execute(CommandLine options) throws Exception {\n+    super.execute(options);\n+    List<String> args = options.getArgList();\n+    Path inputFile = new Path(args.get(0));\n+\n+    Map<String, Long> columnSizes = getColumnSizeInBytes(inputFile);\n+    Map<String, Float> columnRatio = getColumnRatio(columnSizes);\n+\n+    if (args.size() > 1) {\n+      for (String inputColumn : args.subList(1, args.size())) {\n+        long size = 0;\n+        float ratio = 0;\n+        for (String column : columnSizes.keySet()) {\n+          if (column.equals(inputColumn) || column.startsWith(inputColumn + \".\")) {\n+            size += columnSizes.get(column);\n+            ratio += columnRatio.get(column);\n+          }\n+        }\n+        Main.out.println(inputColumn + \"->\" + \" Size In Bytes: \" + size + \" Size In Ratio: \" + ratio);", "originalCommit": "1be782b2f1609d9aa6386d48aacfd64c622d0035", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTc3MTczNw==", "url": "https://github.com/apache/parquet-mr/pull/774#discussion_r399771737", "bodyText": "See comment in TestColumnSizeCommand.java \ud83d\udc4d", "author": "Fokko", "createdAt": "2020-03-29T09:38:23Z", "path": "parquet-cli/src/test/java/org/apache/parquet/cli/commands/ColumnSizeCommandTest.java", "diffHunk": "@@ -0,0 +1,99 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.parquet.cli.commands;\n+\n+import org.apache.hadoop.conf.Configuration;\n+import org.apache.hadoop.fs.Path;\n+import org.apache.parquet.example.data.simple.SimpleGroup;\n+import org.apache.parquet.hadoop.ParquetWriter;\n+import org.apache.parquet.hadoop.example.ExampleParquetWriter;\n+import org.apache.parquet.hadoop.example.GroupWriteSupport;\n+import org.apache.parquet.schema.MessageType;\n+import org.apache.parquet.schema.PrimitiveType;\n+import org.junit.Assert;\n+import org.junit.Test;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.nio.file.Files;\n+import java.util.Arrays;\n+import java.util.Map;\n+import java.util.Random;\n+\n+import static org.apache.parquet.schema.PrimitiveType.PrimitiveTypeName.INT32;\n+import static org.apache.parquet.schema.PrimitiveType.PrimitiveTypeName.INT64;\n+import static org.apache.parquet.schema.Type.Repetition.REQUIRED;\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertTrue;\n+\n+public class ColumnSizeCommandTest extends ParquetFileTest {\n+\n+  private final int numRecord = 10000;\n+  private ColumnSizeCommand command = new ColumnSizeCommand(createLogger());\n+  private Configuration conf = new Configuration();\n+\n+  @Test\n+  public void testColumnSizeCommand() throws IOException {\n+    File file = parquetFile();\n+    ColumnSizeCommand command = new ColumnSizeCommand(createLogger());\n+    command.target = file.getAbsolutePath();\n+    command.setConf(new Configuration());\n+    Assert.assertEquals(0, command.run());\n+  }\n+\n+  @Test\n+  public void testColumnSize() throws Exception {\n+    String inputFile = createParquetFile(\"input\");\n+    Map<String, Long> columnSizeInBytes = command.getColumnSizeInBytes(new Path(inputFile));\n+    assertEquals(columnSizeInBytes.size(), 2);\n+    assertTrue(columnSizeInBytes.get(\"DocId\") > columnSizeInBytes.get(\"Num\"));\n+    Map<String, Float> columnRatio = command.getColumnRatio(columnSizeInBytes);\n+    assertTrue(columnRatio.get(\"DocId\") > columnRatio.get(\"Num\"));\n+  }\n+\n+  private String createParquetFile(String prefix) throws IOException {\n+    MessageType schema = new MessageType(\"schema\",\n+      new PrimitiveType(REQUIRED, INT64, \"DocId\"),\n+      new PrimitiveType(REQUIRED, INT32, \"Num\"));\n+\n+    conf.set(GroupWriteSupport.PARQUET_EXAMPLE_SCHEMA, schema.toString());\n+\n+    String file = createTempFile(prefix);\n+    ExampleParquetWriter.Builder builder = ExampleParquetWriter.builder(new Path(file)).withConf(conf);\n+    Random rnd = new Random();\n+    try (ParquetWriter writer = builder.build()) {\n+      for (int i = 0; i < numRecord; i++) {\n+        SimpleGroup g = new SimpleGroup(schema);\n+        g.add(\"DocId\", rnd.nextLong());\n+        g.add(\"Num\", rnd.nextInt());\n+        writer.write(g);\n+      }\n+    }\n+\n+    return file;\n+  }\n+\n+  private static String createTempFile(String prefix) {\n+    try {\n+      return Files.createTempDirectory(prefix).toAbsolutePath().toString() + \"/test.parquet\";", "originalCommit": "1be782b2f1609d9aa6386d48aacfd64c622d0035", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTgxNzM0NA==", "url": "https://github.com/apache/parquet-mr/pull/774#discussion_r399817344", "bodyText": "Sounds good!", "author": "shangxinli", "createdAt": "2020-03-29T16:01:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTc3MTczNw=="}], "type": "inlineReview"}, {"oid": "d6ca2b75c88166dbb2aa4185692dc7e3e529b227", "url": "https://github.com/apache/parquet-mr/commit/d6ca2b75c88166dbb2aa4185692dc7e3e529b227", "message": "Update parquet-tools/src/main/java/org/apache/parquet/tools/command/ColumnSizeCommand.java\n\nCo-Authored-By: Fokko Driesprong <fokko@driesprong.frl>", "committedDate": "2020-03-29T15:29:50Z", "type": "commit"}, {"oid": "01ebbdf6b6a3583a60697e341e82b046aa1bb2d8", "url": "https://github.com/apache/parquet-mr/commit/01ebbdf6b6a3583a60697e341e82b046aa1bb2d8", "message": "Address feedback", "committedDate": "2020-03-29T15:55:27Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDA0MjM4Ng==", "url": "https://github.com/apache/parquet-mr/pull/774#discussion_r400042386", "bodyText": "prefix is never used and so it is misleading.\nTravis fails because parquetFile() uses the class name to create the file while there are two test methods invoking it. The file already exist after executing the second test method.\nI would suggest correcting the super class implementation by generating a unique file name each time parquetFile is invoked.", "author": "gszadovszky", "createdAt": "2020-03-30T09:16:46Z", "path": "parquet-cli/src/test/java/org/apache/parquet/cli/commands/ColumnSizeCommandTest.java", "diffHunk": "@@ -0,0 +1,91 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.parquet.cli.commands;\n+\n+import org.apache.hadoop.conf.Configuration;\n+import org.apache.hadoop.fs.Path;\n+import org.apache.parquet.example.data.simple.SimpleGroup;\n+import org.apache.parquet.hadoop.ParquetWriter;\n+import org.apache.parquet.hadoop.example.ExampleParquetWriter;\n+import org.apache.parquet.hadoop.example.GroupWriteSupport;\n+import org.apache.parquet.schema.MessageType;\n+import org.apache.parquet.schema.PrimitiveType;\n+import org.junit.Assert;\n+import org.junit.Test;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.nio.file.Files;\n+import java.util.Arrays;\n+import java.util.Map;\n+import java.util.Random;\n+\n+import static org.apache.parquet.schema.PrimitiveType.PrimitiveTypeName.INT32;\n+import static org.apache.parquet.schema.PrimitiveType.PrimitiveTypeName.INT64;\n+import static org.apache.parquet.schema.Type.Repetition.REQUIRED;\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertTrue;\n+\n+public class ColumnSizeCommandTest extends ParquetFileTest {\n+\n+  private final int numRecord = 10000;\n+  private ColumnSizeCommand command = new ColumnSizeCommand(createLogger());\n+  private Configuration conf = new Configuration();\n+\n+  @Test\n+  public void testColumnSizeCommand() throws IOException {\n+    File file = parquetFile();\n+    ColumnSizeCommand command = new ColumnSizeCommand(createLogger());\n+    command.target = file.getAbsolutePath();\n+    command.setConf(new Configuration());\n+    Assert.assertEquals(0, command.run());\n+  }\n+\n+  @Test\n+  public void testColumnSize() throws Exception {\n+    String inputFile = createParquetFile(\"input\");\n+    Map<String, Long> columnSizeInBytes = command.getColumnSizeInBytes(new Path(inputFile));\n+    assertEquals(columnSizeInBytes.size(), 2);\n+    assertTrue(columnSizeInBytes.get(\"DocId\") > columnSizeInBytes.get(\"Num\"));\n+    Map<String, Float> columnRatio = command.getColumnRatio(columnSizeInBytes);\n+    assertTrue(columnRatio.get(\"DocId\") > columnRatio.get(\"Num\"));\n+  }\n+\n+  private String createParquetFile(String prefix) throws IOException {", "originalCommit": "01ebbdf6b6a3583a60697e341e82b046aa1bb2d8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDA0MjY0NA==", "url": "https://github.com/apache/parquet-mr/pull/774#discussion_r400042644", "bodyText": "prefix is not used and so it is misleading.", "author": "gszadovszky", "createdAt": "2020-03-30T09:17:13Z", "path": "parquet-tools/src/test/java/org/apache/parquet/tools/command/TestColumnSizeCommand.java", "diffHunk": "@@ -0,0 +1,94 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.parquet.tools.command;\n+\n+import org.apache.hadoop.conf.Configuration;\n+import org.apache.hadoop.fs.Path;\n+import org.apache.parquet.example.data.simple.SimpleGroup;\n+import org.apache.parquet.hadoop.ParquetWriter;\n+import org.apache.parquet.hadoop.example.ExampleParquetWriter;\n+import org.apache.parquet.hadoop.example.GroupWriteSupport;\n+import org.apache.parquet.schema.MessageType;\n+import org.apache.parquet.schema.PrimitiveType;\n+import org.junit.Rule;\n+import org.junit.Test;\n+import org.junit.rules.TemporaryFolder;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.util.Map;\n+import java.util.Random;\n+\n+import static org.apache.parquet.schema.PrimitiveType.PrimitiveTypeName.INT32;\n+import static org.apache.parquet.schema.PrimitiveType.PrimitiveTypeName.INT64;\n+import static org.apache.parquet.schema.Type.Repetition.REQUIRED;\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertTrue;\n+\n+public class TestColumnSizeCommand {\n+\n+  private final int numRecord = 10000;\n+  private ColumnSizeCommand command = new ColumnSizeCommand();\n+  private Configuration conf = new Configuration();\n+\n+  @Rule\n+  public TemporaryFolder tempFolder = new TemporaryFolder();\n+\n+  @Test\n+  public void testColumnSize() throws Exception {\n+    String inputFile = createParquetFile(\"input\");\n+    Map<String, Long> columnSizeInBytes = command.getColumnSizeInBytes(new Path(inputFile));\n+    assertEquals(columnSizeInBytes.size(), 2);\n+    assertTrue(columnSizeInBytes.get(\"DocId\") > columnSizeInBytes.get(\"Num\"));\n+    Map<String, Float> columnRatio = command.getColumnRatio(columnSizeInBytes);\n+    assertTrue(columnRatio.get(\"DocId\") > columnRatio.get(\"Num\"));\n+  }\n+\n+  private String createParquetFile(String prefix) throws IOException {", "originalCommit": "01ebbdf6b6a3583a60697e341e82b046aa1bb2d8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "801ed79846e0b84152314f29a5655d12721e35e7", "url": "https://github.com/apache/parquet-mr/commit/801ed79846e0b84152314f29a5655d12721e35e7", "message": "Fix building error", "committedDate": "2020-03-30T21:36:45Z", "type": "commit"}, {"oid": "801ed79846e0b84152314f29a5655d12721e35e7", "url": "https://github.com/apache/parquet-mr/commit/801ed79846e0b84152314f29a5655d12721e35e7", "message": "Fix building error", "committedDate": "2020-03-30T21:36:45Z", "type": "forcePushed"}]}