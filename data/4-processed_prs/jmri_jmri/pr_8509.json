{"pr_number": 8509, "pr_title": "Add unique MQTT Client ID", "pr_createdAt": "2020-05-09T00:29:59Z", "pr_url": "https://github.com/JMRI/JMRI/pull/8509", "timeline": [{"oid": "b83971d21b5ae77d8142142350131caa88bf0acc", "url": "https://github.com/JMRI/JMRI/commit/b83971d21b5ae77d8142142350131caa88bf0acc", "message": "Add unique MQTT Client ID\n\nAppend the current profile's unique ID to the end of the MQTT Client ID\nto allow multiple JMRI instances to connect to the same MQTT broker", "committedDate": "2020-05-09T00:25:58Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQzMTMxOQ==", "url": "https://github.com/JMRI/JMRI/pull/8509#discussion_r422431319", "bodyText": "This will not ensure sufficient uniqueness, since if two JMRI instances are running the same profile, they will use the same profile ID. (The JMRI profile ID system is designed to allowed for this.)\nYou want to use jmri.util.node.NodeIdentity.networkIdentity() instead of jmri.profile.ProfileManager.getDefault().getActiveProfile().getUniqueId().", "author": "rhwood", "createdAt": "2020-05-09T00:36:43Z", "path": "java/src/jmri/jmrix/mqtt/MqttAdapter.java", "diffHunk": "@@ -61,7 +61,7 @@ public void connect() throws IOException {\n                 options.put(option2Name, new Option(\"MQTT channel :\", new String[]{baseTopic, DEFAULT_BASETOPIC}));\n             }\n \n-            String clientID = CLID + \"-\" + this.getUserName();\n+            String clientID = CLID + \"-\" + this.getUserName() + \"-\" + jmri.profile.ProfileManager.getDefault().getActiveProfile().getUniqueId();", "originalCommit": "b83971d21b5ae77d8142142350131caa88bf0acc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQzMTQ5OA==", "url": "https://github.com/JMRI/JMRI/pull/8509#discussion_r422431498", "bodyText": "(This change will also resolve the static analysis failures.)", "author": "rhwood", "createdAt": "2020-05-09T00:37:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQzMTMxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQzNDEyOA==", "url": "https://github.com/JMRI/JMRI/pull/8509#discussion_r422434128", "bodyText": "networkIdentity() returns a 26 character string on my system, from a quick look at the source code I am assuming this is a fixed length on all systems, the maximum client ID length allowed by the MQTT protocol is 23 characters.\nThe networkIdentity()  ID begins with \"jmri-\" if this prefix were excluded then networkIdentity() could be used as the Client ID, which from my reading of the source code for network identity would result in essentially the concatenation of the mac address and profile ID which should ensure uniqueness.", "author": "AndTH", "createdAt": "2020-05-09T00:56:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQzMTMxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQ4MjI0Mw==", "url": "https://github.com/JMRI/JMRI/pull/8509#discussion_r422482243", "bodyText": "The network identity is \"jmri-\" + MAC address (12 characters) + \"-\" + profile ID (8 characters).\nhttp://docs.oasis-open.org/mqtt/mqtt/v3.1.1/os/mqtt-v3.1.1-os.html#_Toc398718031 has minimum requirements for an acceptable client ID, which also exclude the use of dashes (as well as minimally allow 23 characters in the ID). An MQTT server may allow a longer ID and other characters than those specified.\nSo your proposal (and what JMRI had) is also not ensured to be valid name.\nTo make a safe name that is ensured to be valid, I would use:\nString clientID = (NodeIdentity.networkIdentity() + getSystemPrefix()).replaceAll(\"/[^A-Za-z0-9 ]/\", \"\");\nif (clientID.length() > 23) {\n    clientID = clientID.subString(clientID.length() - 23);\n}\n\nNote that I am truncating from the left, not the right, in an attempt to allow:\n\nSingle JMRI instance to have 2 or more MQTT connections to a single MQTT server\nSingle computer to run multiple JMRI instances with connections to a single MQTT server (assuming each instance is using different profile)\nMultiple computers running a JMRI instance triggered from copies of the same profile to a single MQTT server", "author": "rhwood", "createdAt": "2020-05-09T10:52:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQzMTMxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjUwMzgxNQ==", "url": "https://github.com/JMRI/JMRI/pull/8509#discussion_r422503815", "bodyText": "This works with the following modified regex (removed leading and trailing /)  \"[^A-Za-z0-9 ]\" as it did not remove the -\u2018s with them in.", "author": "AndTH", "createdAt": "2020-05-09T14:43:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQzMTMxOQ=="}], "type": "inlineReview"}, {"oid": "5644493f9a89f61b937a5e8619749fd639b44c05", "url": "https://github.com/JMRI/JMRI/commit/5644493f9a89f61b937a5e8619749fd639b44c05", "message": "Improve uniqueness of MQTT client ID\n\nUpdated to address comments in Pull Request\n\nImprove uniqueness of MQTT client ID by utilising maching/network\naddressing.\nAdded code to ensure the newly generated client ID meets the guaranteed\nminimum requirements of a MQTT broker in length and character set.", "committedDate": "2020-05-10T11:29:01Z", "type": "commit"}, {"oid": "b3e3b80d6af1a2b79322348d305ec36259e9c810", "url": "https://github.com/JMRI/JMRI/commit/b3e3b80d6af1a2b79322348d305ec36259e9c810", "message": "remove unused field CLID\n\nremove definition of the now unused field CLID", "committedDate": "2020-05-10T12:02:20Z", "type": "commit"}]}