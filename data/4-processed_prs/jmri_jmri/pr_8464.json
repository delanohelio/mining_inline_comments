{"pr_number": 8464, "pr_title": "Fixes running test, if CoS is enabled. Fixes Apply Changes in Debugger.", "pr_createdAt": "2020-04-30T23:08:59Z", "pr_url": "https://github.com/JMRI/JMRI/pull/8464", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODM0NzAyMQ==", "url": "https://github.com/JMRI/JMRI/pull/8464#discussion_r418347021", "bodyText": "The configuration that follows the lines you are removing here is configuration for the goal in question.  I don't think this works in general.", "author": "pabender", "createdAt": "2020-04-30T23:35:12Z", "path": "pom.xml", "diffHunk": "@@ -662,15 +760,15 @@\n                 </configuration>\n             </plugin>\n             <plugin>\n+                <!-- Warning: do not put this plugin's configuration before surefire plugin one. The sequence\n+                     in which the surefire and jacoco goals run is important -->\n                 <groupId>org.jacoco</groupId>\n                 <artifactId>jacoco-maven-plugin</artifactId>\n                 <version>${jacoco.version}</version>\n                 <executions>\n                     <execution>\n                         <id>prepare-agent</id>\n-                        <goals>\n-                            <goal>prepare-agent</goal>\n-                        </goals>\n+                        <!-- Do not bind any goals, let a profile to do it conditionally -->", "originalCommit": "2b05b300b57499c6f76d40273516594323008673", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODQxNjcxMg==", "url": "https://github.com/JMRI/JMRI/pull/8464#discussion_r418416712", "bodyText": "Apologies I do not understand the comment:  The configuration you said is being removed is the only place in pom.xml that contains -unit.exec string.\nStill, with this removal in place, the command line command mvn -Dtest=XNetReplyTest test prints out:\n[DEBUG] === PROJECT BUILD PLAN ================================================\n[DEBUG] -----------------------------------------------------------------------\n[DEBUG] Goal:          org.jacoco:jacoco-maven-plugin:0.8.5:prepare-agent (prepare-agent)\n[DEBUG] Style:         Regular\n[DEBUG] Configuration: <?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<configuration>\n  <address>${jacoco.address}</address>\n  <append>true</append>\n  <classDumpDir>${jacoco.classDumpDir}</classDumpDir>\n  <destFile default-value=\"${project.build.directory}/jacoco.exec\">/space/src/jmri/fixes2/JMRI/target//jacoco-unit.exec</destFile>\n  <dumpOnExit>${jacoco.dumpOnExit}</dumpOnExit>\n  <exclClassLoaders>${jacoco.exclClassLoaders}</exclClassLoaders>\n  <inclBootstrapClasses>${jacoco.inclBootstrapClasses}</inclBootstrapClasses>\n  <inclNoLocationClasses>${jacoco.inclNoLocationClasses}</inclNoLocationClasses>\n  <jmx>${jacoco.jmx}</jmx>\n  <output>${jacoco.output}</output>\n  <pluginArtifactMap>${plugin.artifactMap}</pluginArtifactMap>\n  <port>${jacoco.port}</port>\n  <project>${project}</project>\n  <propertyName>surefire.argLine</propertyName>\n  <sessionId>${jacoco.sessionId}</sessionId>\n  <skip default-value=\"false\">${jacoco.skip}</skip>\n</configuration>\n\n\nThe configuration is IMHO not a property of a goal, but property of the execution instance with the given ID. The goal is \"only\" bound to that execution ID.\nLater, the execution says:\n[DEBUG] Configuring mojo 'org.jacoco:jacoco-maven-plugin:0.8.5:prepare-agent' with basic configurator -->\n[DEBUG]   (f) append = true\n[DEBUG]   (f) destFile = /space/src/jmri/fixes2/JMRI/target/jacoco-unit.exec\n\nMaybe I didn't understood what you said was removed or what bad effect that removal has ?", "author": "svatoun", "createdAt": "2020-05-01T04:55:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODM0NzAyMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODQyODY2OQ==", "url": "https://github.com/JMRI/JMRI/pull/8464#discussion_r418428669", "bodyText": "As long as this is working, I am fine with it.  The change I requested was to have the default-cli configuration restored for merge", "author": "pabender", "createdAt": "2020-05-01T06:00:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODM0NzAyMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODQ0MDE3MA==", "url": "https://github.com/JMRI/JMRI/pull/8464#discussion_r418440170", "bodyText": "As long as this is working, I am fine with it. The change I requested was to have the default-cli configuration restored for merge\n\nStill I'd like to understand what did you see removed:\n\nThe configuration that follows the lines you are removing here is configuration for the goal in question. I don't think this works in general.", "author": "svatoun", "createdAt": "2020-05-01T06:58:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODM0NzAyMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODM0NzIwNw==", "url": "https://github.com/JMRI/JMRI/pull/8464#discussion_r418347207", "bodyText": "again, this is configuration for the specific goal in the specific context", "author": "pabender", "createdAt": "2020-04-30T23:35:50Z", "path": "pom.xml", "diffHunk": "@@ -679,9 +777,7 @@\n                     </execution>\n                     <execution>\n                         <id>prepare-agent-integration</id>\n-                        <goals>\n-                            <goal>prepare-agent</goal>\n-                        </goals>\n+                        <!-- Do not bind any goals, let a profile to do it conditionally -->", "originalCommit": "2b05b300b57499c6f76d40273516594323008673", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODM0NzkyNA==", "url": "https://github.com/JMRI/JMRI/pull/8464#discussion_r418347924", "bodyText": "This may be ok, but it may also cause duplicate processing of data in the test report.  The merging needs to take place after ALL tests complete.\nAdding the command line configuration does something different.  It allows you to run the jacoco:merge goal from the command line and have it work as expected.  It needs to stay in place.", "author": "pabender", "createdAt": "2020-04-30T23:38:11Z", "path": "pom.xml", "diffHunk": "@@ -706,7 +802,12 @@\n                         </configuration>\n                     </execution>\n                     <execution>\n-                        <id>default-cli</id>\n+                        <!-- Do a merge after unit tests complete, to cover the case that only goals up to 'test' phase", "originalCommit": "2b05b300b57499c6f76d40273516594323008673", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODM1ODk0MQ==", "url": "https://github.com/JMRI/JMRI/pull/8464#discussion_r418358941", "bodyText": "just to clarify, as long as the tests are passing, the only change I have requested is that the default-cli execution for jacoco:merge be restored.", "author": "pabender", "createdAt": "2020-05-01T00:17:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODM0NzkyNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODQzNjU3MA==", "url": "https://github.com/JMRI/JMRI/pull/8464#discussion_r418436570", "bodyText": "just to clarify, as long as the tests are passing, the only change I have requested is that the default-cli execution for jacoco:merge be restored.\n\nI see; when run from commandline directly as jacoco:merge (as you suggested in #8457), the configuration is missing - an error happens. I beg your pardon, but given that Jacoco coverage runs automatically (during tests) - the user does not enter anything, just mvn test, and with my fix, jacoco:merge runs also automatically during the tests ....\n... what is the use-case the user would maually call mvn jacoco:merge ? I just couldn't find a use-case, but sure can be - and the goal ought not error.\nBUT:\nThe original default-cli execution ID binds to generate-resources if no phase is present; that means the merge goal is run before any of the tests can be run.\nAn additional merge runs if one uses command line suggested in #8457. On unclean builds (without explicit clean),\n\nthe data from the previous test run are merged,\ntests are run\nthe data from this test run are merged.\n\nThe execution from master branch:\nmvn -B test integration-test failsafe:verify  (taken from travis.sh) yields:\n[INFO] Scanning for projects...\n...\n[INFO] --- jacoco-maven-plugin:0.8.5:prepare-agent (prepare-agent) @ jmri ---\n[INFO] --- jacoco-maven-plugin:0.8.5:prepare-agent (prepare-agent-integration) @ jmri ---\n[INFO] --- jacoco-maven-plugin:0.8.5:merge (default-cli) @ jmri ---\n>>> [INFO] Loading execution data file /space/src/jmri/fixes2/JMRI/target/jacoco-unit.exec\n>>> [INFO] Loading execution data file /space/src/jmri/fixes2/JMRI/target/jacoco-it.exec\n>>> [INFO] Loading execution data file /space/src/jmri/fixes2/JMRI/target/jacoco.exec\n>>> [INFO] Writing merged execution data to /space/src/jmri/fixes2/JMRI/target/jacoco.exec\n[INFO] --- maven-resources-plugin:2.6:resources (default-resources) @ jmri ---\n[INFO] --- maven-compiler-plugin:3.8.1:compile (default-compile) @ jmri ---\n...\n[INFO] --- maven-compiler-plugin:3.8.1:testCompile (default-testCompile) @ jmri ---\n...\n[INFO] --- maven-surefire-plugin:2.22.0:test (default-test) @ jmri ---\n[INFO] -------------------------------------------------------\n[INFO]  T E S T S\n[INFO] -------------------------------------------------------\n[INFO] --- build-helper-maven-plugin:3.0.0:timestamp-property (timestamp-property) @ jmri ---\n[INFO] --- jacoco-maven-plugin:0.8.5:prepare-agent (prepare-agent) @ jmri ---\n[INFO] --- jacoco-maven-plugin:0.8.5:prepare-agent (prepare-agent-integration) @ jmri ---\n[INFO] --- jacoco-maven-plugin:0.8.5:merge (default-cli) @ jmri ---\n>>> [INFO] Loading execution data file /space/src/jmri/fixes2/JMRI/target/jacoco-unit.exec\n>>> [INFO] Loading execution data file /space/src/jmri/fixes2/JMRI/target/jacoco-it.exec\n>>> [INFO] Loading execution data file /space/src/jmri/fixes2/JMRI/target/jacoco.exec\n>>> [INFO] Writing merged execution data to /space/src/jmri/fixes2/JMRI/target/jacoco.exec\n[INFO] --- maven-failsafe-plugin:2.22.0:integration-test (default) @ jmri ---\n[INFO] \n[INFO] -------------------------------------------------------\n[INFO]  T E S T S\n[INFO] -------------------------------------------------------\n...\n[INFO] --- maven-failsafe-plugin:2.22.0:verify (default-cli) @ jmri ---\n[INFO] ------------------------------------------------------------------------\n[INFO] BUILD SUCCESS\n[INFO] ------------------------------------------------------------------------\n\n\nNote that the .exec files may be actually merged twice. Also note that mvn integration-test does not merge in jacoco-it.exec after integration tests complete, and before failsafe:verify target.\nIf you have concerns about merging the data sets twice, what about this twice merged, but not finalized (with integration test results) data, present in the master ?\nIt's probably because the jacoco:report binds by default to verify phase.\nI am not a travis or jmri build expert, sorry. Can someone explain me where the mvn verify or specifically the jacoco:check target is executed during the JMRI travis builds ?", "author": "svatoun", "createdAt": "2020-05-01T06:41:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODM0NzkyNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODQ0Mjg1MQ==", "url": "https://github.com/JMRI/JMRI/pull/8464#discussion_r418442851", "bodyText": "I am not a travis or jmri build expert, sorry. Can someone explain me where the mvn verify or specifically the jacoco:check target is executed during the JMRI travis builds ?\n\nSorry, found: mvn verify in one of travis.sh branches - good ! So there's a 3rd merge before jacoco:report in the master.\nApologies: Travis CI merges everything in time. It's just run mvn test integration-test which does not (in the master).", "author": "svatoun", "createdAt": "2020-05-01T07:12:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODM0NzkyNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODUyMTM3NA==", "url": "https://github.com/JMRI/JMRI/pull/8464#discussion_r418521374", "bodyText": "Please restore the previous fileset.", "author": "pabender", "createdAt": "2020-05-01T12:28:45Z", "path": "pom.xml", "diffHunk": "@@ -795,7 +795,8 @@\n                                 <fileSet>\n                                     <directory>${jacoco.reportDir}</directory>\n                                     <includes>\n-                                        <File>**/*.exec</File>\n+                                        <File>**/jacoco.exec</File>\n+                                        <File>**/*-it.exec</File>", "originalCommit": "d7816a6552bd95c95cf4fcffc56ff7d49101019d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODUzMzQxMA==", "url": "https://github.com/JMRI/JMRI/pull/8464#discussion_r418533410", "bodyText": "Practically, it's just a corner optimization to avoid multiple lines for the same test session in the final jacoco.exec. If that's OK, I'll happily remove it to get coverage, apply changes and potentialy CoS working again; I value the work hours spent on this issue too much to get them just nixed.\nPlease confirm.", "author": "svatoun", "createdAt": "2020-05-01T13:08:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODUyMTM3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODYwMDY1NQ==", "url": "https://github.com/JMRI/JMRI/pull/8464#discussion_r418600655", "bodyText": "I don\u2019t think it is a huge problem having multiple copies in the output.  It won\u2019t increase the coverage reported.", "author": "pabender", "createdAt": "2020-05-01T15:46:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODUyMTM3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODY0MTE1Mw==", "url": "https://github.com/JMRI/JMRI/pull/8464#discussion_r418641153", "bodyText": "ACK, reverted  d7816a6", "author": "svatoun", "createdAt": "2020-05-01T17:17:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODUyMTM3NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODUyMTQ0NQ==", "url": "https://github.com/JMRI/JMRI/pull/8464#discussion_r418521445", "bodyText": "Please restore the previous fileset", "author": "pabender", "createdAt": "2020-05-01T12:29:03Z", "path": "pom.xml", "diffHunk": "@@ -816,7 +817,8 @@\n                                 <fileSet>\n                                     <directory>${jacoco.reportDir}</directory>\n                                     <includes>\n-                                        <File>**/*.exec</File>\n+                                        <File>**/jacoco.exec</File>\n+                                        <File>**/*-unit.exec</File>", "originalCommit": "d7816a6552bd95c95cf4fcffc56ff7d49101019d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "2b05b300b57499c6f76d40273516594323008673", "url": "https://github.com/JMRI/JMRI/commit/2b05b300b57499c6f76d40273516594323008673", "message": "Fixes running test, if CoS is enabled. Fixes Apply Changes in Debugger.", "committedDate": "2020-04-30T22:00:23Z", "type": "forcePushed"}, {"oid": "54d947df3760a73e03e1800c932e86a021a2d642", "url": "https://github.com/JMRI/JMRI/commit/54d947df3760a73e03e1800c932e86a021a2d642", "message": "Fixes running test, if CoS is enabled. Fixes Apply Changes in Debugger.", "committedDate": "2020-05-03T17:47:59Z", "type": "commit"}, {"oid": "54d947df3760a73e03e1800c932e86a021a2d642", "url": "https://github.com/JMRI/JMRI/commit/54d947df3760a73e03e1800c932e86a021a2d642", "message": "Fixes running test, if CoS is enabled. Fixes Apply Changes in Debugger.", "committedDate": "2020-05-03T17:47:59Z", "type": "forcePushed"}]}