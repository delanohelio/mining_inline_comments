{"pr_number": 1723, "pr_title": "Extend archive module to support TTL and delay", "pr_createdAt": "2020-06-03T02:23:53Z", "pr_url": "https://github.com/Netflix/conductor/pull/1723", "timeline": [{"oid": "7589295d398b944a596d71bd67aea4e697b87423", "url": "https://github.com/Netflix/conductor/commit/7589295d398b944a596d71bd67aea4e697b87423", "message": "Added workflow status listener to archive workflows with TTL", "committedDate": "2020-06-03T02:47:23Z", "type": "commit"}, {"oid": "5e5b040f814c1d8d07a78c30dd04f264b26e8d3e", "url": "https://github.com/Netflix/conductor/commit/5e5b040f814c1d8d07a78c30dd04f264b26e8d3e", "message": "Disable async indexing on create workflow", "committedDate": "2020-06-03T02:47:23Z", "type": "commit"}, {"oid": "c82c7a3c0ce74ed73a5f48c0a66826d82d88fe7f", "url": "https://github.com/Netflix/conductor/commit/c82c7a3c0ce74ed73a5f48c0a66826d82d88fe7f", "message": "Delayed archiving", "committedDate": "2020-06-03T02:47:23Z", "type": "commit"}, {"oid": "39a7c97fd0e8a3ca16eee6c42134f711536f2437", "url": "https://github.com/Netflix/conductor/commit/39a7c97fd0e8a3ca16eee6c42134f711536f2437", "message": "Minor refactoring", "committedDate": "2020-06-03T02:47:23Z", "type": "commit"}, {"oid": "51209930d464c7116e6218e6440aa3b2bc407667", "url": "https://github.com/Netflix/conductor/commit/51209930d464c7116e6218e6440aa3b2bc407667", "message": "Fix unit test", "committedDate": "2020-06-03T03:07:37Z", "type": "commit"}, {"oid": "51209930d464c7116e6218e6440aa3b2bc407667", "url": "https://github.com/Netflix/conductor/commit/51209930d464c7116e6218e6440aa3b2bc407667", "message": "Fix unit test", "committedDate": "2020-06-03T03:07:37Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzMyOTg0MA==", "url": "https://github.com/Netflix/conductor/pull/1723#discussion_r447329840", "bodyText": "Exposing a configuration without an ability to actually configure sounds very counter-intuitive. I believe that it would be better to just use the async update delay property directly.", "author": "apanicker-nflx", "createdAt": "2020-06-30T00:10:55Z", "path": "core/src/main/java/com/netflix/conductor/core/config/Configuration.java", "diffHunk": "@@ -105,6 +105,14 @@\n     String EVENT_EXECUTION_PERSISTENCE_TTL_SECS_PROPERTY_NAME = \"workflow.event.execution.persistence.ttl.seconds\";\n     int EVENT_EXECUTION_PERSISTENCE_TTL_SECS_DEFAULT_VALUE = 0;\n \n+    String WORKFLOW_ARCHIVAL_TTL_SECS_PROPERTY_NAME = \"workflow.archival.ttl.seconds\";\n+    int WORKFLOW_ARCHIVAL_TTL_SECS_DEFAULT_VALUE = 0;\n+\n+    String WORKFLOW_ARCHIVAL_DELAY_SECS_PROPERTY_NAME = \"workflow.archival.delay.seconds\";", "originalCommit": "51209930d464c7116e6218e6440aa3b2bc407667", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzg1NTQ3MQ==", "url": "https://github.com/Netflix/conductor/pull/1723#discussion_r447855471", "bodyText": "Property workflow.archival.delay.seconds can be configured and it takes getAsyncUpdateDelay() as default value. In an ideal scenario, where the index delay queue size is near zero, this property can be same value as getAsyncUpdateDelay(). When the index delay queue increases due to the unavailability of worker threads/ES throttles then indexes might not be created for updating and so in those cases, this property can provide some buffer time for delays.", "author": "mdepak", "createdAt": "2020-06-30T17:24:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzMyOTg0MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzMzMDA1Mw==", "url": "https://github.com/Netflix/conductor/pull/1723#discussion_r447330053", "bodyText": "Consider using getAsyncUpdateDelay directly over this indirection to reduce confusion.", "author": "apanicker-nflx", "createdAt": "2020-06-30T00:11:32Z", "path": "core/src/main/java/com/netflix/conductor/core/config/Configuration.java", "diffHunk": "@@ -317,6 +325,28 @@ default String getElasticSearchDocumentTypeOverride() {\n             ELASTIC_SEARCH_DOCUMENT_TYPE_OVERRIDE_DEFAULT_VALUE);\n     }\n \n+    /**\n+     * @return The time to live in seconds for workflow archiving module. Currently, only RedisExecutionDAO supports it.\n+     */\n+    default int getWorkflowArchivalTTL() {\n+        return getIntProperty(WORKFLOW_ARCHIVAL_TTL_SECS_PROPERTY_NAME, WORKFLOW_ARCHIVAL_TTL_SECS_DEFAULT_VALUE);\n+    }\n+\n+    /**\n+     * @return the time to delay the archival of workflow\n+     */\n+    default int getWorkflowArchivalDelay() {", "originalCommit": "51209930d464c7116e6218e6440aa3b2bc407667", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzMzMTkxMA==", "url": "https://github.com/Netflix/conductor/pull/1723#discussion_r447331910", "bodyText": "Since the removal of the workflow only uses the workflowId in the run method below in line 105, the object size can be reduced tremendously by only saving the worklfowId as part of the instance.", "author": "apanicker-nflx", "createdAt": "2020-06-30T00:17:24Z", "path": "contribs/src/main/java/com/netflix/conductor/contribs/listener/ArchivingWithTTLWorkflowStatusListener.java", "diffHunk": "@@ -0,0 +1,114 @@\n+/*\n+ * Copyright 2020 Netflix, Inc.\n+ * <p>\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ * <p>\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ * <p>\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.netflix.conductor.contribs.listener;\n+\n+import com.netflix.conductor.common.run.Workflow;\n+import com.netflix.conductor.core.config.Configuration;\n+import com.netflix.conductor.core.execution.WorkflowStatusListener;\n+import com.netflix.conductor.core.orchestration.ExecutionDAOFacade;\n+import com.netflix.conductor.metrics.Monitors;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import javax.annotation.PreDestroy;\n+import javax.inject.Inject;\n+import java.util.concurrent.ScheduledThreadPoolExecutor;\n+import java.util.concurrent.TimeUnit;\n+\n+public class ArchivingWithTTLWorkflowStatusListener implements WorkflowStatusListener {\n+    private static final Logger LOGGER = LoggerFactory.getLogger(ArchivingWorkflowStatusListener.class);\n+\n+    private final ExecutionDAOFacade executionDAOFacade;\n+    private final int archiveTTLSeconds;\n+    private final int delayArchiveSeconds;\n+    private final ScheduledThreadPoolExecutor scheduledThreadPoolExecutor;\n+\n+    @Inject\n+    public ArchivingWithTTLWorkflowStatusListener(ExecutionDAOFacade executionDAOFacade, Configuration config) {\n+        this.executionDAOFacade = executionDAOFacade;\n+        this.archiveTTLSeconds = config.getWorkflowArchivalTTL();\n+        this.delayArchiveSeconds = config.getWorkflowArchivalDelay();\n+\n+        this.scheduledThreadPoolExecutor = new ScheduledThreadPoolExecutor(config.getWorkflowArchivalDelayQueueWorkerThreadCount(),\n+                (runnable, executor) -> {\n+                    LOGGER.warn(\"Request {} to delay archiving index dropped in executor {}\", runnable, executor);\n+                    Monitors.recordDiscardedArchivalCount();\n+                });\n+        this.scheduledThreadPoolExecutor.setRemoveOnCancelPolicy(true);\n+    }\n+\n+    @PreDestroy\n+    public void shutdownExecutorService() {\n+        try {\n+            LOGGER.info(\"Gracefully shutdown executor service\");\n+            scheduledThreadPoolExecutor.shutdown();\n+            if (scheduledThreadPoolExecutor.awaitTermination(delayArchiveSeconds, TimeUnit.SECONDS)) {\n+                LOGGER.debug(\"tasks completed, shutting down\");\n+            } else {\n+                LOGGER.warn(\"Forcing shutdown after waiting for {} seconds\", delayArchiveSeconds);\n+                scheduledThreadPoolExecutor.shutdownNow();\n+            }\n+        } catch (InterruptedException ie) {\n+            LOGGER.warn(\"Shutdown interrupted, invoking shutdownNow on scheduledThreadPoolExecutor for delay queue\");\n+            scheduledThreadPoolExecutor.shutdownNow();\n+            Thread.currentThread().interrupt();\n+        }\n+    }\n+\n+    @Override\n+    public void onWorkflowCompleted(Workflow workflow) {\n+        LOGGER.info(\"Archiving workflow {} on completion \", workflow.getWorkflowId());\n+        if (delayArchiveSeconds > 0) {\n+            scheduledThreadPoolExecutor.schedule(new DelayArchiveWorkflow(workflow, executionDAOFacade), delayArchiveSeconds, TimeUnit.SECONDS);\n+        } else {\n+            this.executionDAOFacade.removeWorkflowWithExpiry(workflow.getWorkflowId(), true, archiveTTLSeconds);\n+            Monitors.recordWorkflowArchived(workflow.getWorkflowName(), workflow.getStatus());\n+        }\n+    }\n+\n+    @Override\n+    public void onWorkflowTerminated(Workflow workflow) {\n+        LOGGER.info(\"Archiving workflow {} on termination\", workflow.getWorkflowId());\n+        if (delayArchiveSeconds > 0) {\n+            scheduledThreadPoolExecutor.schedule(new DelayArchiveWorkflow(workflow, executionDAOFacade), delayArchiveSeconds, TimeUnit.SECONDS);\n+        } else {\n+            this.executionDAOFacade.removeWorkflowWithExpiry(workflow.getWorkflowId(), true, archiveTTLSeconds);\n+            Monitors.recordWorkflowArchived(workflow.getWorkflowName(), workflow.getStatus());\n+        }\n+    }\n+\n+    private class DelayArchiveWorkflow implements Runnable {\n+        private final Workflow workflow;", "originalCommit": "51209930d464c7116e6218e6440aa3b2bc407667", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzg0OTEzOA==", "url": "https://github.com/Netflix/conductor/pull/1723#discussion_r447849138", "bodyText": "Thanks for the suggestion. This will significantly reduce the memory consumption of the archival delay queue.", "author": "mdepak", "createdAt": "2020-06-30T17:14:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzMzMTkxMA=="}], "type": "inlineReview"}, {"oid": "36e222fbe6dc04779d87a7adc0bb3b69381379a1", "url": "https://github.com/Netflix/conductor/commit/36e222fbe6dc04779d87a7adc0bb3b69381379a1", "message": "Minor refactoring in delayed workflow archival", "committedDate": "2020-06-30T17:26:26Z", "type": "commit"}]}