{"pr_number": 747, "pr_title": "JENA-1900: Ensure only one Log4j2Plugins.dat file shaded", "pr_createdAt": "2020-05-21T20:16:11Z", "pr_url": "https://github.com/apache/jena/pull/747", "timeline": [{"oid": "675e2130ddca6488f374995f6efd38fc05d8a247", "url": "https://github.com/apache/jena/commit/675e2130ddca6488f374995f6efd38fc05d8a247", "message": "JENA-1900: Ensure only one Log4j2Plugins.dat file shaded", "committedDate": "2020-05-21T16:35:35Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODg5MDU3Nw==", "url": "https://github.com/apache/jena/pull/747#discussion_r428890577", "bodyText": "Fix logging config mistake - should set for \"org.apache.shiro\" (silences two log lines as the server starts).", "author": "afs", "createdAt": "2020-05-21T20:17:55Z", "path": "jena-fuseki2/apache-jena-fuseki/log4j2.properties", "diffHunk": "@@ -47,8 +47,8 @@ logger.jetty.name  = org.eclipse.jetty\n logger.jetty.level = WARN\n \n # Hide bug in Shiro 1.5.0\n-logger.shiro.name = org.apache.shiro.realm.text.IniRealm\n-logger.shiro.level = ERROR", "originalCommit": "675e2130ddca6488f374995f6efd38fc05d8a247", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODg5MjY0MQ==", "url": "https://github.com/apache/jena/pull/747#discussion_r428892641", "bodyText": "Exclude org.apache.logging.log4j:log4j-web -- it isn't necessary running as a single app in Jetty because there isn't a stop.unload issue. But it does contain another Log4j2Plugins.dat and this was the problem - shaing picked one, not merged them.\nThe general fix - the 3rd party shade transformer - didn't work reliably so the simple fix is to exclude the artifact in jena-fuseki-fulljar. The transformer is also very version sensitive.\nThe emergence fix script put in the log4j-core Log4j2Plugins.dat and does not include the log4j-web additions -- so evidence that the log4j-web isn't needed.", "author": "afs", "createdAt": "2020-05-21T20:22:08Z", "path": "jena-fuseki2/jena-fuseki-fulljar/pom.xml", "diffHunk": "@@ -38,6 +38,12 @@\n       <groupId>org.apache.jena</groupId>\n       <artifactId>jena-fuseki-webapp</artifactId>\n       <version>${project.version}</version>\n+      <exclusions>\n+        <exclusion>\n+          <groupId>org.apache.logging.log4j</groupId>\n+          <artifactId>log4j-web</artifactId>", "originalCommit": "675e2130ddca6488f374995f6efd38fc05d8a247", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODg5MzA0Mw==", "url": "https://github.com/apache/jena/pull/747#discussion_r428893043", "bodyText": "Logging setup when run on a java9+ JVM was outputting a warning. See LOG4J2-2537.", "author": "afs", "createdAt": "2020-05-21T20:22:58Z", "path": "jena-fuseki2/jena-fuseki-fulljar/pom.xml", "diffHunk": "@@ -73,15 +79,26 @@\n \n   <build>\n     <plugins>\n-\n       <plugin>\n         <groupId>org.apache.maven.plugins</groupId>\n         <artifactId>maven-shade-plugin</artifactId>\n         <configuration>\n           <shadedArtifactAttached>false</shadedArtifactAttached>\n           <transformers>\n+            <!--\n+                 https://issues.apache.org/jira/browse/LOG4J2-954 - fixed at 3.0.0\n+                 Multiple Log4j2Plugins.dat\n+                 jena-fuseki-fulljar picks up one Log4j2Plugins.dat from \n+                 org.apache.logging.log4j:log4j-core and, unless excluded,\n+                 one via jena-fuseki-webapp which has org.apache.logging.log4j:log4j-core-web\n+                 If it becomes necessary, see: https://github.com/edwgiz/maven-shaded-log4j-transformer\n+            -->\n             <transformer implementation=\"org.apache.maven.plugins.shade.resource.ManifestResourceTransformer\">\n               <mainClass>org.apache.jena.fuseki.cmd.FusekiCmd</mainClass>\n+              <!-- https://issues.apache.org/jira/browse/LOG4J2-2537  -->\n+              <manifestEntries>\n+                <Multi-Release>true</Multi-Release>\n+              </manifestEntries>", "originalCommit": "675e2130ddca6488f374995f6efd38fc05d8a247", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODg5Mzc5Ng==", "url": "https://github.com/apache/jena/pull/747#discussion_r428893796", "bodyText": "In trying to get the 3rd party shade transformer to work, upgrading the shade plugin and the log4j2 version were necessary so evenif not required after all, the x.x.1 updates are left in.", "author": "afs", "createdAt": "2020-05-21T20:24:30Z", "path": "pom.xml", "diffHunk": "@@ -54,7 +54,8 @@\n     <ver.junit>4.12</ver.junit>  \n \n     <ver.slf4j>1.7.30</ver.slf4j>\n-    <ver.log4j2>2.13.1</ver.log4j2>\n+    <ver.log4j2>2.13.3</ver.log4j2>\n+    <ver.shade-plugin>3.2.3</ver.shade-plugin>", "originalCommit": "675e2130ddca6488f374995f6efd38fc05d8a247", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}