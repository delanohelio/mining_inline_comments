{"pr_number": 884, "pr_title": "JENA-2012: Test for UTF-16 high-low surrogates pairs", "pr_createdAt": "2020-12-08T18:15:19Z", "pr_url": "https://github.com/apache/jena/pull/884", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODc0MjExMQ==", "url": "https://github.com/apache/jena/pull/884#discussion_r538742111", "bodyText": "\ud83d\udc4d\nI checked for a method that does something like this on Apache Commons Text, and Apache Commons Lang, but there's none. I thought some user would have requested that, interesting.", "author": "kinow", "createdAt": "2020-12-08T19:22:05Z", "path": "jena-arq/src/main/java/org/apache/jena/sparql/lang/ParserBase.java", "diffHunk": "@@ -190,6 +190,24 @@ protected Node stripSign(Node node) {\n         return NodeFactory.createLiteral(lex, lang, dt) ;\n     }\n \n+    protected void checkString(String string, int line, int column) {\n+        for ( int i = 0 ; i < string.length() ; i++ ) {\n+            // Not \"codePointAt\" which does surrogate processing.\n+            char ch = string.charAt(i);\n+            // Check surrogate pairs are pairs.\n+            if ( Character.isHighSurrogate(ch) ) {\n+                i++;\n+                if ( i == string.length() )\n+                    throw new QueryParseException(\"Bad surrogate pair (end of string)\", line, column);\n+                char ch1 = string.charAt(i);\n+                if ( ! Character.isLowSurrogate(ch1) ) {\n+                    throw new QueryParseException(\"Bad surrogate pair (high surrogate not followed by low surrogate)\", line, column);\n+                }\n+            } else if ( Character.isLowSurrogate(ch) )\n+                throw new QueryParseException(\"Bad surrogate pair (low surrogate without high surrogate)\", line, column);\n+        }\n+    }", "originalCommit": "0473c3252f2022b2c1357e75935f41d52b397d34", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODc0MjMwMw==", "url": "https://github.com/apache/jena/pull/884#discussion_r538742303", "bodyText": "Delete? \u261d\ufe0f", "author": "kinow", "createdAt": "2020-12-08T19:22:18Z", "path": "jena-base/src/main/java/org/apache/jena/atlas/io/InStreamUTF8.java", "diffHunk": "@@ -144,7 +144,18 @@ public final int advance()\n     public static final int advance(InputStreamBuffered input) {\n         int x = input.advance() ;\n         if ( x == -1 ) return -1 ;\n-        return advance(input, x) ;\n+\n+        int codepoint = advance(input, x) ;\n+        //System.out.printf(\"U+%04X\\n\", codepoint);\n+\n+        if ( false ) {\n+//          if ( codepoint > Character.MAX_VALUE ) {\n+//              throw new AtlasException(\"Out of range character (must use a surrogate pair)\");\n+//          }", "originalCommit": "0473c3252f2022b2c1357e75935f41d52b397d34", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODg0Njc1Mg==", "url": "https://github.com/apache/jena/pull/884#discussion_r538846752", "bodyText": "OK - removed the commented text, rearrange and \"if(false)\" and \"Character.isDefined\" (that is a switch between being a pure UTF-8 decoder and one that only accepts characters in the Unicode version that Java supports).\n(I'd forgotten that this class would get into the PR!)", "author": "afs", "createdAt": "2020-12-08T22:13:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODc0MjMwMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODc0MjM4Ng==", "url": "https://github.com/apache/jena/pull/884#discussion_r538742386", "bodyText": "Delete? \u261d\ufe0f", "author": "kinow", "createdAt": "2020-12-08T19:22:28Z", "path": "jena-cmds/src/main/java/riotcmd/utf8.java", "diffHunk": "@@ -60,7 +60,8 @@ public static void main(String... args) {\n                     } else\n                         colNum++ ;\n                     if ( !Character.isDefined(ch) )\n-                        throw new AtlasException(String.format(\"No such codepoint: 0x%04X\", ch)) ;\n+                        //throw new AtlasException(String.format(\"No such codepoint: 0x%04X\", ch)) ;", "originalCommit": "0473c3252f2022b2c1357e75935f41d52b397d34", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODg0NDAxMg==", "url": "https://github.com/apache/jena/pull/884#discussion_r538844012", "bodyText": "Done (this gives the test of being within the unicode version supported, not just any UTF-8 sequence).", "author": "afs", "createdAt": "2020-12-08T22:08:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODc0MjM4Ng=="}], "type": "inlineReview"}, {"oid": "02f031ca15f620dbd9fee7fbc123c7357c23f8fe", "url": "https://github.com/apache/jena/commit/02f031ca15f620dbd9fee7fbc123c7357c23f8fe", "message": "JENA-2012: Test for UTF-16 high-low surrogates pairs", "committedDate": "2020-12-08T22:08:30Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTE0ODk1NQ==", "url": "https://github.com/apache/jena/pull/884#discussion_r539148955", "bodyText": "Nit, the bracket style is pretty inconsistent here, I don't have a strong preference for using brackets when the if branch only has a single line but it would be nice to be consistent throughout the method\nFor example the outer if uses {} because it has a multi-line block but its corresponding else if doesn't\nSimilarly the inner if are both single line blocks but one uses {} and one doesn't", "author": "rvesse", "createdAt": "2020-12-09T09:33:36Z", "path": "jena-arq/src/main/java/org/apache/jena/sparql/lang/ParserBase.java", "diffHunk": "@@ -190,6 +190,24 @@ protected Node stripSign(Node node) {\n         return NodeFactory.createLiteral(lex, lang, dt) ;\n     }\n \n+    protected void checkString(String string, int line, int column) {\n+        for ( int i = 0 ; i < string.length() ; i++ ) {\n+            // Not \"codePointAt\" which does surrogate processing.\n+            char ch = string.charAt(i);\n+            // Check surrogate pairs are pairs.\n+            if ( Character.isHighSurrogate(ch) ) {\n+                i++;\n+                if ( i == string.length() )\n+                    throw new QueryParseException(\"Bad surrogate pair (end of string)\", line, column);\n+                char ch1 = string.charAt(i);\n+                if ( ! Character.isLowSurrogate(ch1) ) {\n+                    throw new QueryParseException(\"Bad surrogate pair (high surrogate not followed by low surrogate)\", line, column);\n+                }\n+            } else if ( Character.isLowSurrogate(ch) )\n+                throw new QueryParseException(\"Bad surrogate pair (low surrogate without high surrogate)\", line, column);\n+        }", "originalCommit": "02f031ca15f620dbd9fee7fbc123c7357c23f8fe", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTE1NTkwMQ==", "url": "https://github.com/apache/jena/pull/884#discussion_r539155901", "bodyText": "Point taken. Changed.", "author": "afs", "createdAt": "2020-12-09T09:42:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTE0ODk1NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTE0OTcxMQ==", "url": "https://github.com/apache/jena/pull/884#discussion_r539149711", "bodyText": "Any reason why this is now just a log message rather than an error as it was previously?", "author": "rvesse", "createdAt": "2020-12-09T09:34:37Z", "path": "jena-cmds/src/main/java/riotcmd/utf8.java", "diffHunk": "@@ -60,7 +60,7 @@ public static void main(String... args) {\n                     } else\n                         colNum++ ;\n                     if ( !Character.isDefined(ch) )\n-                        throw new AtlasException(String.format(\"No such codepoint: 0x%04X\", ch)) ;\n+                        System.out.printf(\"No such codepoint: 0x%04X\\n\", ch);", "originalCommit": "02f031ca15f620dbd9fee7fbc123c7357c23f8fe", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTE2MDY0MA==", "url": "https://github.com/apache/jena/pull/884#discussion_r539160640", "bodyText": "Previous there was also a Character.isDefined in InStreamUTF8 and also a bad test that excluded surrogate use.\nIt is like this so first error does not terminate the command. Of course, it may flip to many errors!\nWhen trying it out (on the rdf-tests data which is not large), stopping on the first error was unhelpful because the errors were in several bytes (surrogate pairs by the time it got to here).", "author": "afs", "createdAt": "2020-12-09T09:49:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTE0OTcxMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTQwMjE2Mg==", "url": "https://github.com/apache/jena/pull/884#discussion_r539402162", "bodyText": "Makes perfect sense", "author": "rvesse", "createdAt": "2020-12-09T15:27:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTE0OTcxMQ=="}], "type": "inlineReview"}, {"oid": "c3a0cc6b9ba3ed6bd4c0d35e700a5665b58650c2", "url": "https://github.com/apache/jena/commit/c3a0cc6b9ba3ed6bd4c0d35e700a5665b58650c2", "message": "JENA-2012: Test for UTF-16 high-low surrogates pairs", "committedDate": "2020-12-09T09:49:40Z", "type": "forcePushed"}, {"oid": "a40b6c7e5679ea40ea10cd79aa8d613dacdd4504", "url": "https://github.com/apache/jena/commit/a40b6c7e5679ea40ea10cd79aa8d613dacdd4504", "message": "JENA-2012: Test for UTF-16 high-low surrogates pairs", "committedDate": "2020-12-09T09:54:00Z", "type": "commit"}, {"oid": "a40b6c7e5679ea40ea10cd79aa8d613dacdd4504", "url": "https://github.com/apache/jena/commit/a40b6c7e5679ea40ea10cd79aa8d613dacdd4504", "message": "JENA-2012: Test for UTF-16 high-low surrogates pairs", "committedDate": "2020-12-09T09:54:00Z", "type": "forcePushed"}]}