{"pr_number": 787, "pr_title": "JENA-1950 Replace Nashorn with GraalVM-based JavaScript engine", "pr_createdAt": "2020-08-26T17:17:25Z", "pr_url": "https://github.com/apache/jena/pull/787", "timeline": [{"oid": "1de7d2da3a58188aaf4fa9529b4b47ec1f26fff6", "url": "https://github.com/apache/jena/commit/1de7d2da3a58188aaf4fa9529b4b47ec1f26fff6", "message": "JENA-1950 Replace Nashorn with GraalVM-based JavaScript engine", "committedDate": "2020-08-26T17:16:22Z", "type": "commit"}, {"oid": "6e131fd769c6cf3a1ccff361e0aeedb5abb51e0f", "url": "https://github.com/apache/jena/commit/6e131fd769c6cf3a1ccff361e0aeedb5abb51e0f", "message": "Move GraalVM dependencies before test dependencies", "committedDate": "2020-08-26T17:21:29Z", "type": "commit"}, {"oid": "55a3354a5deaf40761f5e93efc673d5dd0b4f8dd", "url": "https://github.com/apache/jena/commit/55a3354a5deaf40761f5e93efc673d5dd0b4f8dd", "message": "Make Graal VM a provided dependency", "committedDate": "2020-09-15T19:10:46Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTM3OTQ0Mg==", "url": "https://github.com/apache/jena/pull/787#discussion_r489379442", "bodyText": "I think this should be <optional>true</optional>.\nMy understanding is that the the effect is much the same. It is about the meaning indicated. \"provided\" is for environment capabilities used by this project (e.g running in a application container), \"optional\" is indicating downstream that a capability can be added.\ne.g.\nhttp://maven.40175.n5.nabble.com/lt-scope-gt-provided-lt-scope-gt-vs-lt-optional-gt-true-lt-optional-gt-td2852244.html\nDoes anyone have deeper experience?", "author": "afs", "createdAt": "2020-09-16T11:56:40Z", "path": "jena-arq/pom.xml", "diffHunk": "@@ -111,6 +111,18 @@\n       <artifactId>commons-lang3</artifactId>\n     </dependency>\n \n+    <dependency>\n+      <groupId>org.graalvm.js</groupId>\n+      <artifactId>js</artifactId>\n+      <scope>provided</scope>", "originalCommit": "55a3354a5deaf40761f5e93efc673d5dd0b4f8dd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjUxMzkyMg==", "url": "https://github.com/apache/jena/pull/787#discussion_r492513922", "bodyText": "Actually, ARQ can be compiled on JDK < 15 without any Graal dependencies, and even on JDK 15 they can be mere test dependencies. Maybe it would rather make sense to include them as compile dependencies in Fuseki? @afs, what do you think?", "author": "strangepleasures", "createdAt": "2020-09-22T07:04:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTM3OTQ0Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzAyNzExMA==", "url": "https://github.com/apache/jena/pull/787#discussion_r493027110", "bodyText": "Making them <scope>test</scope> makes sense. At the moment, I think have the tests need this to test an optional feature is acceptable.\nIncluding in Fuseki is another matter. scope=compile would mean the Jena project is shipping the GraalVM engine which itself is GPL2+classpath exception and not acceptable.\nhttp://www.apache.org/legal/resolved.html#optional\nWhile we can't ship it ourselves, we should provide instructions and scripts on how to add GraalVM.\nThere is a separate matter that GraalVM is quite large.\nPMC email:\nhttps://lists.apache.org/thread.html/raf8f65ee6451181560d36b98c6332677a751f86abf4abda2230d3240%40%3Cdev.jena.apache.org%3E", "author": "afs", "createdAt": "2020-09-22T20:53:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTM3OTQ0Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzE5NDgxMA==", "url": "https://github.com/apache/jena/pull/787#discussion_r493194810", "bodyText": "I created another PR for that: #801", "author": "strangepleasures", "createdAt": "2020-09-23T04:47:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTM3OTQ0Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTM4MDE2NA==", "url": "https://github.com/apache/jena/pull/787#discussion_r489380164", "bodyText": "I would remove the \"else\" branch.\nIf on Java 8, this warning comes out whereas before there wasn't one.\nThe JDK prints warns its warning anyway on Java11 and Java14:\n\n\"Warning: Nashorn engine is planned to be removed from a future JDK release\"\n\nso we get two.", "author": "afs", "createdAt": "2020-09-16T11:58:02Z", "path": "jena-arq/src/main/java/org/apache/jena/sparql/function/js/JSEngine.java", "diffHunk": "@@ -55,24 +50,31 @@ public static JSEngine createFromFile(String functionLibFile) {\n         return new JSEngine(null, functionLibFile);\n     }\n     \n-    /*package*/ JSEngine(String functions, String functionLibFile) { \n-        this.functions = functions;\n-        this.functionLibFile = functionLibFile;\n+    /*package*/ JSEngine(String functions, String functionLibFile) {\n         invoc = build(functions, functionLibFile);\n     }\n \n     private static Invocable build(String functions, String functionLibFile) {\n         if ( functions == null && functionLibFile == null )\n-            throw new ARQException(\"Both script string and script filename are null\"); \n+            throw new ARQException(\"Both script string and script filename are null\");\n \n         ScriptEngineManager manager = new ScriptEngineManager();\n-        ScriptEngine scriptEngine = manager.getEngineByName(\"nashorn\");\n-        \n+        ScriptEngine scriptEngine = manager.getEngineByName(\"javascript\");\n+        if (scriptEngine == null) {\n+            throw new ARQException(\"Could not load JavaScript script engine. \" +\n+                    \"Make sure that org.graalvm.js:js and org.graalvm.js:js-scriptengine are added to the class path\");\n+        }\n+\n+        if (scriptEngine.getFactory().getEngineName().equals(\"Graal.js\")) {\n+            scriptEngine.getContext().setAttribute(\"polyglot.js.nashorn-compat\", true, ScriptContext.ENGINE_SCOPE);\n+        } else if (scriptEngine.getFactory().getNames().contains(\"Nashorn\")) {\n+            Log.warn(JSEngine.class, \"Nashorn will be permanently removed in JDK 15. Consider switching to Graal VM.\");", "originalCommit": "55a3354a5deaf40761f5e93efc673d5dd0b4f8dd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTUyNjExMg==", "url": "https://github.com/apache/jena/pull/787#discussion_r489526112", "bodyText": "makes sense", "author": "strangepleasures", "createdAt": "2020-09-16T15:25:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTM4MDE2NA=="}], "type": "inlineReview"}, {"oid": "c257ef6eb50f882d30cce6cb99fcc18df47d91a1", "url": "https://github.com/apache/jena/commit/c257ef6eb50f882d30cce6cb99fcc18df47d91a1", "message": "Make Graal VM dependencies optional", "committedDate": "2020-09-16T15:28:54Z", "type": "commit"}, {"oid": "c5b0dc3522d496d0918af6a0243efd52e3e7ee7a", "url": "https://github.com/apache/jena/commit/c5b0dc3522d496d0918af6a0243efd52e3e7ee7a", "message": "Remove Nashorn deprecation warning", "committedDate": "2020-09-16T15:29:35Z", "type": "commit"}]}