{"pr_number": 1033, "pr_title": "Bulk block file import", "pr_createdAt": "2020-06-03T02:56:00Z", "pr_url": "https://github.com/hyperledger/besu/pull/1033", "timeline": [{"oid": "46784265db379599c242078c8e3437b0657d87cb", "url": "https://github.com/hyperledger/besu/commit/46784265db379599c242078c8e3437b0657d87cb", "message": "Bulk block file import\n\nExtend the `blocks import` subcommand to accept multiple files in the\ncommand line and import them in the same batch.\n\nSigned-off-by: Danno Ferrin <danno.ferrin@gmail.com>", "committedDate": "2020-06-03T02:55:31Z", "type": "commit"}, {"oid": "0b40c4f060be05d46e4d3239bd8b6b10c50c1e8b", "url": "https://github.com/hyperledger/besu/commit/0b40c4f060be05d46e4d3239bd8b6b10c50c1e8b", "message": "spotless\n\nSigned-off-by: Danno Ferrin <danno.ferrin@gmail.com>", "committedDate": "2020-06-03T03:31:52Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDYyMTExNg==", "url": "https://github.com/hyperledger/besu/pull/1033#discussion_r434621116", "bodyText": "Would it be worth it to indicate that this is a developer mistake and ask for a bug report? I think this can only happen if there's an enumerated block format that we didn't make a case clause for here.", "author": "RatanRSur", "createdAt": "2020-06-03T14:42:14Z", "path": "besu/src/main/java/org/hyperledger/besu/cli/subcommands/blocks/BlocksSubCommand.java", "diffHunk": "@@ -150,37 +159,48 @@ public void run() {\n     @Override\n     public void run() {\n       parentCommand.parentCommand.configureLogging(false);\n-      LOG.info(\"Import {} block data from {}\", format, blocksImportFile);\n \n       checkCommand(parentCommand);\n       checkNotNull(parentCommand.rlpBlockImporter);\n       checkNotNull(parentCommand.jsonBlockImporterFactory);\n-\n+      if (blockImportFileOption.isEmpty()) {\n+        throw new ParameterException(spec.commandLine(), \"No files specified to import.\");\n+      }\n+      LOG.info(\"Import {} block data from {} files\", format, blockImportFiles.size());\n       final Optional<MetricsService> metricsService = initMetrics(parentCommand);\n \n-      try {\n-        // As blocksImportFile even if initialized as null is injected by PicoCLI and param is\n-        // mandatory. So we are sure it's always not null, we can remove the warning.\n-        //noinspection ConstantConditions\n-        final Path path = blocksImportFile.toPath();\n-        final BesuController<?> controller = createController();\n-        switch (format) {\n-          case RLP:\n-            importRlpBlocks(controller, path);\n-            break;\n-          case JSON:\n-            importJsonBlocks(controller, path);\n-            break;\n-          default:\n-            throw new ParameterException(\n-                spec.commandLine(), \"Unsupported format: \" + format.toString());\n+      try (final BesuController<?> controller = createController()) {\n+        for (final Path path : blockImportFiles) {\n+          try {\n+            LOG.info(\"Importing from {}\", path);\n+\n+            switch (format) {\n+              case RLP:\n+                importRlpBlocks(controller, path);\n+                break;\n+              case JSON:\n+                importJsonBlocks(controller, path);\n+                break;\n+              default:\n+                throw new ParameterException(\n+                    spec.commandLine(), \"Unsupported format: \" + format.toString());", "originalCommit": "0b40c4f060be05d46e4d3239bd8b6b10c50c1e8b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDYzMjU2OQ==", "url": "https://github.com/hyperledger/besu/pull/1033#discussion_r434632569", "bodyText": "Despite the green text I didn't write this block, it's the beneficiary of being indented in a for loop.\nBut if the concern is developer mistake for new unenumerated formats the better approach IMHO is to remove the default block and have the build break at compile time and make the author consciously think about what they want to happen.  Being an enum Java will let us not have a default if we fully enumerate the enum.", "author": "shemnon", "createdAt": "2020-06-03T14:57:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDYyMTExNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDYzMzIxOA==", "url": "https://github.com/hyperledger/besu/pull/1033#discussion_r434633218", "bodyText": "Sounds good to me", "author": "RatanRSur", "createdAt": "2020-06-03T14:58:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDYyMTExNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDYyMjkyNQ==", "url": "https://github.com/hyperledger/besu/pull/1033#discussion_r434622925", "bodyText": "So we continue on if one of the files isn't found? If the typical use case is to supply block files that have contiguous blocks, as a user I would prefer a bail on the first indication of trouble.", "author": "RatanRSur", "createdAt": "2020-06-03T14:44:49Z", "path": "besu/src/main/java/org/hyperledger/besu/cli/subcommands/blocks/BlocksSubCommand.java", "diffHunk": "@@ -150,37 +159,48 @@ public void run() {\n     @Override\n     public void run() {\n       parentCommand.parentCommand.configureLogging(false);\n-      LOG.info(\"Import {} block data from {}\", format, blocksImportFile);\n \n       checkCommand(parentCommand);\n       checkNotNull(parentCommand.rlpBlockImporter);\n       checkNotNull(parentCommand.jsonBlockImporterFactory);\n-\n+      if (blockImportFileOption.isEmpty()) {\n+        throw new ParameterException(spec.commandLine(), \"No files specified to import.\");\n+      }\n+      LOG.info(\"Import {} block data from {} files\", format, blockImportFiles.size());\n       final Optional<MetricsService> metricsService = initMetrics(parentCommand);\n \n-      try {\n-        // As blocksImportFile even if initialized as null is injected by PicoCLI and param is\n-        // mandatory. So we are sure it's always not null, we can remove the warning.\n-        //noinspection ConstantConditions\n-        final Path path = blocksImportFile.toPath();\n-        final BesuController<?> controller = createController();\n-        switch (format) {\n-          case RLP:\n-            importRlpBlocks(controller, path);\n-            break;\n-          case JSON:\n-            importJsonBlocks(controller, path);\n-            break;\n-          default:\n-            throw new ParameterException(\n-                spec.commandLine(), \"Unsupported format: \" + format.toString());\n+      try (final BesuController<?> controller = createController()) {\n+        for (final Path path : blockImportFiles) {\n+          try {\n+            LOG.info(\"Importing from {}\", path);\n+\n+            switch (format) {\n+              case RLP:\n+                importRlpBlocks(controller, path);\n+                break;\n+              case JSON:\n+                importJsonBlocks(controller, path);\n+                break;\n+              default:\n+                throw new ParameterException(\n+                    spec.commandLine(), \"Unsupported format: \" + format.toString());\n+            }\n+          } catch (final FileNotFoundException e) {\n+            if (blockImportFiles.size() == 1) {\n+              throw new ExecutionException(\n+                  spec.commandLine(), \"Could not find file to import: \" + path);\n+            } else {\n+              LOG.error(\"Could not find file to import: {}\", path);\n+            }", "originalCommit": "0b40c4f060be05d46e4d3239bd8b6b10c50c1e8b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDYyNzU3Mw==", "url": "https://github.com/hyperledger/besu/pull/1033#discussion_r434627573", "bodyText": "This code represents what other clients do. They only halt if one file is presented and plow through if multiple files are presented (but share every error).  It's a feature we need to run this on hive efficiently.\nOne use case is one set represents a consensus fork and the next set has overlapping block numbers, but different and correct blocks.  Or if one file would up orphaned by the end and the next file contains the live chain head.", "author": "shemnon", "createdAt": "2020-06-03T14:50:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDYyMjkyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDYzMDEyNA==", "url": "https://github.com/hyperledger/besu/pull/1033#discussion_r434630124", "bodyText": "Ah, ok. So we need to continue on in the case where there's an import failure but what about the FileNotFoundException? Do we need plow through that as well in order to conform?", "author": "RatanRSur", "createdAt": "2020-06-03T14:54:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDYyMjkyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDYzMzY1Mg==", "url": "https://github.com/hyperledger/besu/pull/1033#discussion_r434633652", "bodyText": "Yes. An error will be logged, user error could be a buggy auto-generated scripts that used to work.", "author": "shemnon", "createdAt": "2020-06-03T14:59:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDYyMjkyNQ=="}], "type": "inlineReview"}, {"oid": "cd419f262345ae0e037b81e6e5b85c519dcb39f7", "url": "https://github.com/hyperledger/besu/commit/cd419f262345ae0e037b81e6e5b85c519dcb39f7", "message": "remove default block\n\nSigned-off-by: Danno Ferrin <danno.ferrin@gmail.com>", "committedDate": "2020-06-03T14:54:36Z", "type": "commit"}, {"oid": "ea11d955d72150d01ba17373b5073369899f1bce", "url": "https://github.com/hyperledger/besu/commit/ea11d955d72150d01ba17373b5073369899f1bce", "message": "Merge branch 'master' into bulkimport", "committedDate": "2020-06-03T15:03:00Z", "type": "commit"}]}