{"pr_number": 333, "pr_title": "[BESU-182] Add tests to FilterParameter to demonstrate loading topics from JSON", "pr_createdAt": "2020-01-27T20:33:51Z", "pr_url": "https://github.com/hyperledger/besu/pull/333", "timeline": [{"oid": "733a57aa0e6bb35e310993eb47aa28d75175825d", "url": "https://github.com/hyperledger/besu/commit/733a57aa0e6bb35e310993eb47aa28d75175825d", "message": "Add tests to FilterParameter to demonstrate loading topics from JSON\n\nDemonstrate that filter topics in JSON format consistent with eth_newFilter RPC requests\nwill be correctly loaded into the FilterParameter topics.\n\nPrevious tests were loading from an internal structure, which makes it difficult to see\ncoverage of scenarios.\n\n - [] - matches anything\n\n - [A] matches A in the first position, and anything after\n\n - [A, B] - A in first position, and B in second position, then anything after\n\n - [null, B] - matches anything in first position, and B in second position, and anything after.\n\n - [[A,B],[A,B]] - Matches A OR B in first position, and A OR B in second position, and anything after.\n\nJira: [BESU-182]\nSigned-off-by: Paul Harris <paul.harris@consensys.net>", "committedDate": "2020-01-24T05:23:04Z", "type": "commit"}, {"oid": "1c79119aca1703a471d21f945671f30fe035a33f", "url": "https://github.com/hyperledger/besu/commit/1c79119aca1703a471d21f945671f30fe035a33f", "message": "Merge branch 'master' into BESU-182", "committedDate": "2020-01-27T20:34:11Z", "type": "commit"}, {"oid": "ea7b5620a4a2e162fc569dcfb145ea6af350d1f8", "url": "https://github.com/hyperledger/besu/commit/ea7b5620a4a2e162fc569dcfb145ea6af350d1f8", "message": "[BESU-182] apply spotless formatting to regression test changes\n\nSigned-off-by: Paul Harris <paul.harris@consensys.net>", "committedDate": "2020-01-27T21:15:26Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTUwNTE2NQ==", "url": "https://github.com/hyperledger/besu/pull/333#discussion_r371505165", "bodyText": "nit: can this be String.format(\"%040X\") (or whatever works for hex?)", "author": "rain-on", "createdAt": "2020-01-27T21:56:55Z", "path": "ethereum/api/src/test/java/org/hyperledger/besu/ethereum/api/jsonrpc/internal/parameters/FilterParameterTest.java", "diffHunk": "@@ -35,6 +35,14 @@\n import org.junit.Test;\n \n public class FilterParameterTest {\n+  private static final String TOPIC_TWO =\n+      \"0x0000000000000000000000000000000000000000000000000000000000000002\";", "originalCommit": "ea7b5620a4a2e162fc569dcfb145ea6af350d1f8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTUwNTUxOQ==", "url": "https://github.com/hyperledger/besu/pull/333#discussion_r371505519", "bodyText": "nit: not your problem - but this is probably a pre-formatted string, which takes an address and Topics?", "author": "rain-on", "createdAt": "2020-01-27T21:57:45Z", "path": "ethereum/api/src/test/java/org/hyperledger/besu/ethereum/api/jsonrpc/internal/parameters/FilterParameterTest.java", "diffHunk": "@@ -69,13 +77,15 @@ public void jsonWithSingleAddressShouldSerializeSuccessfully() throws Exception\n   @Test\n   public void jsonWithSingleAddressAndSingleTopicShouldSerializeSuccessfully() throws Exception {\n     final String jsonWithSingleAddress =\n-        \"{\\\"jsonrpc\\\":\\\"2.0\\\",\\\"method\\\":\\\"eth_getLogs\\\",\\\"params\\\":[{\\\"address\\\":\\\"0x0\\\", \\\"topics\\\":\\\"0x0000000000000000000000000000000000000000000000000000000000000002\\\" }],\\\"id\\\":1}\";\n+        \"{\\\"jsonrpc\\\":\\\"2.0\\\",\\\"method\\\":\\\"eth_getLogs\\\",\\\"params\\\":[{\\\"address\\\":\\\"0x0\\\", \"", "originalCommit": "ea7b5620a4a2e162fc569dcfb145ea6af350d1f8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTUxODU0NQ==", "url": "https://github.com/hyperledger/besu/pull/333#discussion_r371518545", "bodyText": "so i only touched this string to remove the duplication of 0x02...", "author": "rolfyone", "createdAt": "2020-01-27T22:28:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTUwNTUxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTUyMjMyNQ==", "url": "https://github.com/hyperledger/besu/pull/333#discussion_r371522325", "bodyText": "\ud83d\udc4d", "author": "rain-on", "createdAt": "2020-01-27T22:37:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTUwNTUxOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTUxMzY5MA==", "url": "https://github.com/hyperledger/besu/pull/333#discussion_r371513690", "bodyText": "nit: the naming is as good as the rest of Besu tests, but I always worry when I see \"correctly\" in tests, what is correctly? This is effectively going to be our requirements doc, so it needs to be explicit about the expected outcome.\neg. emptyListTopicStringDecodesToZeroLengthTopicList ... ok ... that's not great either. :/", "author": "rain-on", "createdAt": "2020-01-27T22:16:29Z", "path": "ethereum/api/src/test/java/org/hyperledger/besu/ethereum/api/jsonrpc/internal/parameters/FilterParameterTest.java", "diffHunk": "@@ -224,6 +243,91 @@ public void emptyListAsSubTopicDecodesCorrectly() throws JsonProcessingException\n             emptyList());\n   }\n \n+  @Test\n+  public void emptyListOfTopicsDecodesCorrectly() throws java.io.IOException {", "originalCommit": "ea7b5620a4a2e162fc569dcfb145ea6af350d1f8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTUxNTA4OQ==", "url": "https://github.com/hyperledger/besu/pull/333#discussion_r371515089", "bodyText": "nit: personally would prefer to see \"emptyList()\" ... but maybe that's arbitrary :)", "author": "rain-on", "createdAt": "2020-01-27T22:19:51Z", "path": "ethereum/api/src/test/java/org/hyperledger/besu/ethereum/api/jsonrpc/internal/parameters/FilterParameterTest.java", "diffHunk": "@@ -224,6 +243,91 @@ public void emptyListAsSubTopicDecodesCorrectly() throws JsonProcessingException\n             emptyList());\n   }\n \n+  @Test\n+  public void emptyListOfTopicsDecodesCorrectly() throws java.io.IOException {\n+    final FilterParameter filterParameter = readJsonAsFilterParameter(\"{\\\"topics\\\":[]}\");\n+\n+    assertThat(filterParameter.getTopics().size()).isEqualTo(0);\n+  }\n+\n+  @Test\n+  public void emptyListOfTopicsNestedDecodesCorrectly() throws java.io.IOException {\n+    final FilterParameter filterParameter = readJsonAsFilterParameter(\"{\\\"topics\\\":[[]]}\");\n+\n+    assertThat(filterParameter.getTopics()).containsExactly(List.of());", "originalCommit": "ea7b5620a4a2e162fc569dcfb145ea6af350d1f8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTUxNzc1Nw==", "url": "https://github.com/hyperledger/besu/pull/333#discussion_r371517757", "bodyText": "nit: is it overkill to use a StringJoiner to make this pretty?", "author": "rain-on", "createdAt": "2020-01-27T22:26:23Z", "path": "ethereum/api/src/test/java/org/hyperledger/besu/ethereum/api/jsonrpc/internal/parameters/FilterParameterTest.java", "diffHunk": "@@ -224,6 +243,91 @@ public void emptyListAsSubTopicDecodesCorrectly() throws JsonProcessingException\n             emptyList());\n   }\n \n+  @Test\n+  public void emptyListOfTopicsDecodesCorrectly() throws java.io.IOException {\n+    final FilterParameter filterParameter = readJsonAsFilterParameter(\"{\\\"topics\\\":[]}\");\n+\n+    assertThat(filterParameter.getTopics().size()).isEqualTo(0);\n+  }\n+\n+  @Test\n+  public void emptyListOfTopicsNestedDecodesCorrectly() throws java.io.IOException {\n+    final FilterParameter filterParameter = readJsonAsFilterParameter(\"{\\\"topics\\\":[[]]}\");\n+\n+    assertThat(filterParameter.getTopics()).containsExactly(List.of());\n+  }\n+\n+  @Test\n+  public void singleTopicDecodesCorrectly() throws java.io.IOException {\n+    final FilterParameter filterParameter =\n+        readJsonAsFilterParameter(\"{\\\"topics\\\":[\\\"\" + TOPIC_TWO + \"\\\"]}\");\n+\n+    assertThat(filterParameter.getTopics())\n+        .containsExactly(List.of(LogTopic.fromHexString(TOPIC_TWO)));\n+  }\n+\n+  @Test\n+  public void singleNestedTopicDecodesCorrectly() throws java.io.IOException {\n+    final FilterParameter filterParameter =\n+        readJsonAsFilterParameter(\"{\\\"topics\\\":[[\\\"\" + TOPIC_TWO + \"\\\"]]}\");\n+\n+    assertThat(filterParameter.getTopics())\n+        .containsExactly(List.of(LogTopic.fromHexString(TOPIC_TWO)));\n+  }\n+\n+  @Test\n+  public void twoTopicsDecodesCorrectly() throws java.io.IOException {\n+    final FilterParameter filterParameter =\n+        readJsonAsFilterParameter(\"{\\\"topics\\\":[\\\"\" + TOPIC_TWO + \"\\\", \\\"\" + TOPIC_THREE + \"\\\"]}\");\n+\n+    assertThat(filterParameter.getTopics())\n+        .containsExactly(\n+            List.of(LogTopic.fromHexString(TOPIC_TWO)),\n+            List.of(LogTopic.fromHexString(TOPIC_THREE)));\n+  }\n+\n+  @Test\n+  public void twoTopicsInFirstPositionDecodesCorrectly() throws java.io.IOException {\n+    final FilterParameter filterParameter =\n+        readJsonAsFilterParameter(\n+            \"{\\\"topics\\\":[[\\\"\" + TOPIC_TWO + \"\\\", \\\"\" + TOPIC_THREE + \"\\\"]]}\");\n+\n+    assertThat(filterParameter.getTopics())\n+        .containsExactly(\n+            List.of(LogTopic.fromHexString(TOPIC_TWO), LogTopic.fromHexString(TOPIC_THREE)));\n+  }\n+\n+  @Test\n+  public void nullInFirstPositionDecodesCorrectly() throws java.io.IOException {\n+    final FilterParameter filterParameter =\n+        readJsonAsFilterParameter(\"{\\\"topics\\\":[null, \\\"\" + TOPIC_THREE + \"\\\"]}\");\n+\n+    assertThat(filterParameter.getTopics())\n+        .containsExactly(singletonList(null), List.of(LogTopic.fromHexString(TOPIC_THREE)));\n+  }\n+\n+  @Test\n+  public void twoTopicsInFirstAndSecondPositionDecodesCorrectly() throws java.io.IOException {\n+    final FilterParameter filterParameter =\n+        readJsonAsFilterParameter(\n+            \"{\\\"topics\\\":[\"", "originalCommit": "ea7b5620a4a2e162fc569dcfb145ea6af350d1f8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTUxOTE2Ng==", "url": "https://github.com/hyperledger/besu/pull/333#discussion_r371519166", "bodyText": "so my original problem was that I couldn't read the tests.... this makes it pretty explicit, I can simplify it down and reduce that if you like...", "author": "rolfyone", "createdAt": "2020-01-27T22:29:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTUxNzc1Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTUyMzgyMw==", "url": "https://github.com/hyperledger/besu/pull/333#discussion_r371523823", "bodyText": "new StringJoiner(\"[\", \"\\\",\\\", \"]\") might do kinda what you want? (then do a joiner.build)", "author": "rain-on", "createdAt": "2020-01-27T22:41:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTUxNzc1Nw=="}], "type": "inlineReview"}, {"oid": "2e78c8d16b5b4fb5132cbb24647f28c275d5b563", "url": "https://github.com/hyperledger/besu/commit/2e78c8d16b5b4fb5132cbb24647f28c275d5b563", "message": "[BESU-182] changes per review comments.\n\nSigned-off-by: Paul Harris <paul.harris@consensys.net>", "committedDate": "2020-01-27T23:39:01Z", "type": "commit"}, {"oid": "a2dcdb07b212d218c0d8b19dd68b5ea82efbe3ef", "url": "https://github.com/hyperledger/besu/commit/a2dcdb07b212d218c0d8b19dd68b5ea82efbe3ef", "message": "[BESU-182] changes per review comments.\n\nSigned-off-by: Paul Harris <paul.harris@consensys.net>", "committedDate": "2020-01-27T23:50:34Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTU1NDMxMw==", "url": "https://github.com/hyperledger/besu/pull/333#discussion_r371554313", "bodyText": "Method naming in this test class is the format [premise] should [outcome].\nI'd suggest a name such as emptyTopicsListShouldDeserializeAsEmptyList()", "author": "CjHare", "createdAt": "2020-01-28T00:18:50Z", "path": "ethereum/api/src/test/java/org/hyperledger/besu/ethereum/api/jsonrpc/internal/parameters/FilterParameterTest.java", "diffHunk": "@@ -224,6 +238,83 @@ public void emptyListAsSubTopicDecodesCorrectly() throws JsonProcessingException\n             emptyList());\n   }\n \n+  @Test\n+  public void emptyListOfTopicsInJsonGivesInEmptyListInFilterParameter()", "originalCommit": "a2dcdb07b212d218c0d8b19dd68b5ea82efbe3ef", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTU1NDY1OA==", "url": "https://github.com/hyperledger/besu/pull/333#discussion_r371554658", "bodyText": "Maybe nestedEmptyTopicsListShouldDeserializeAsEmptyList()?\n(also it is more usual for unqualified exceptions e.g. IOException)", "author": "CjHare", "createdAt": "2020-01-28T00:20:11Z", "path": "ethereum/api/src/test/java/org/hyperledger/besu/ethereum/api/jsonrpc/internal/parameters/FilterParameterTest.java", "diffHunk": "@@ -224,6 +238,83 @@ public void emptyListAsSubTopicDecodesCorrectly() throws JsonProcessingException\n             emptyList());\n   }\n \n+  @Test\n+  public void emptyListOfTopicsInJsonGivesInEmptyListInFilterParameter()\n+      throws java.io.IOException {\n+    final FilterParameter filterParameter = readJsonAsFilterParameter(\"{\\\"topics\\\":[]}\");\n+\n+    assertThat(filterParameter.getTopics().size()).isEqualTo(0);\n+  }\n+\n+  @Test\n+  public void emptyListOfTopicsNestedGivesEmptyListInTopics() throws java.io.IOException {", "originalCommit": "a2dcdb07b212d218c0d8b19dd68b5ea82efbe3ef", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "1aa0bbd20c7eb203c8ad8ca5bbc2fd91fc4b3059", "url": "https://github.com/hyperledger/besu/commit/1aa0bbd20c7eb203c8ad8ca5bbc2fd91fc4b3059", "message": "[BESU-182] changes per review comments.\n\nSigned-off-by: Paul Harris <paul.harris@consensys.net>", "committedDate": "2020-01-28T02:10:43Z", "type": "commit"}]}