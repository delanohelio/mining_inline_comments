{"pr_number": 340, "pr_title": "[BESU-185] - CLI Option to enable TLS client auth for JSON-RPC HTTP", "pr_createdAt": "2020-01-29T07:23:06Z", "pr_url": "https://github.com/hyperledger/besu/pull/340", "timeline": [{"oid": "82f8c5a3d0d23eb2eef50c4f069d35268e6f91dc", "url": "https://github.com/hyperledger/besu/commit/82f8c5a3d0d23eb2eef50c4f069d35268e6f91dc", "message": "[BESU-185] - CLI Option to enable TLS client auth for JSON-RPC HTTP\n\nFollowing options are added\n\n--rpc-http-tls-client-auth-enabled  - Enable TLS client authentication for the JSON-RPC HTTP service (default: false)\n--rpc-http-tls-known-clients-file - Path to file containing client's certificate common name and fingerprint for client authentication.\n--rpc-http-tls-ca-clients-enabled - Enable to accept clients certificate signed by a valid CA for client authentication (default: false)\n\nSigned-off-by: Usman Saleem <usman@usmans.info>", "committedDate": "2020-01-29T07:21:39Z", "type": "commit"}, {"oid": "e921b37f09f42aa896dec51d985e6152cb91b603", "url": "https://github.com/hyperledger/besu/commit/e921b37f09f42aa896dec51d985e6152cb91b603", "message": "errorprone fixes\nSigned-off-by: Usman Saleem <usman@usmans.info>", "committedDate": "2020-01-29T08:31:27Z", "type": "commit"}, {"oid": "48ce63db29e4c4e767ec92694fb763da459ec74c", "url": "https://github.com/hyperledger/besu/commit/48ce63db29e4c4e767ec92694fb763da459ec74c", "message": "besu command unit tests for tls options\n\nSigned-off-by: Usman Saleem <usman@usmans.info>", "committedDate": "2020-01-29T09:13:29Z", "type": "commit"}, {"oid": "988e2a70a3455ba80ff2efd2f53acd6f8f82a246", "url": "https://github.com/hyperledger/besu/commit/988e2a70a3455ba80ff2efd2f53acd6f8f82a246", "message": "errorprone reported fix\n\nSigned-off-by: Usman Saleem <usman@usmans.info>", "committedDate": "2020-01-29T10:39:40Z", "type": "commit"}, {"oid": "388b1c13e7375fa65cc3959da07adb4b617ce50d", "url": "https://github.com/hyperledger/besu/commit/388b1c13e7375fa65cc3959da07adb4b617ce50d", "message": "adding license header\n\nSigned-off-by: Usman Saleem <usman@usmans.info>", "committedDate": "2020-01-29T11:50:41Z", "type": "commit"}, {"oid": "32b454268f11052acc2721d32b59f5afa3fddd2f", "url": "https://github.com/hyperledger/besu/commit/32b454268f11052acc2721d32b59f5afa3fddd2f", "message": "Merge remote-tracking branch 'upstream/master' into rpc_tls_client_auth\n\nSigned-off-by: Usman Saleem <usman@usmans.info>", "committedDate": "2020-01-29T21:07:54Z", "type": "commit"}, {"oid": "1863a5f3969a953cbc872dff989f29789645cb3f", "url": "https://github.com/hyperledger/besu/commit/1863a5f3969a953cbc872dff989f29789645cb3f", "message": "minor refactoring in unit tests\n\nSigned-off-by: Usman Saleem <usman@usmans.info>", "committedDate": "2020-01-29T21:36:37Z", "type": "commit"}, {"oid": "6d44adee69e7d455f33135f3f7f5b69d9988e1e2", "url": "https://github.com/hyperledger/besu/commit/6d44adee69e7d455f33135f3f7f5b69d9988e1e2", "message": "Extracting out tls client auth unit tests in a seperate class\n\nSigned-off-by: Usman Saleem <usman@usmans.info>", "committedDate": "2020-01-29T23:56:33Z", "type": "commit"}, {"oid": "6322e9f9165d7490160a2665d0d3cbc11cba829b", "url": "https://github.com/hyperledger/besu/commit/6322e9f9165d7490160a2665d0d3cbc11cba829b", "message": "Adding unit test to assert ca signed clients\n\nSigned-off-by: Usman Saleem <usman@usmans.info>", "committedDate": "2020-01-30T00:28:22Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mjc1OTgxMA==", "url": "https://github.com/hyperledger/besu/pull/340#discussion_r372759810", "bodyText": "Any reason we need to copy the input params?  It seems odd.  I feel there should be a comment explaining why (it may be a library thing, and it would be worth pointing out) or consider just mutating the options in place.", "author": "shemnon", "createdAt": "2020-01-30T04:58:21Z", "path": "ethereum/api/src/main/java/org/hyperledger/besu/ethereum/api/jsonrpc/JsonRpcHttpService.java", "diffHunk": "@@ -279,34 +281,47 @@ private HttpServerOptions getHttpServerOptions() {\n     return applyTlsConfig(httpServerOptions);\n   }\n \n-  private HttpServerOptions applyTlsConfig(final HttpServerOptions httpServerOptions) {\n-    config\n-        .getTlsConfiguration()\n+  private HttpServerOptions applyTlsConfig(final HttpServerOptions input) {\n+    if (config.getTlsConfiguration().isEmpty()) {\n+      return input;\n+    }\n+\n+    final TlsConfiguration tlsConfiguration = config.getTlsConfiguration().get();\n+    final HttpServerOptions httpServerOptions = new HttpServerOptions(input);", "originalCommit": "6322e9f9165d7490160a2665d0d3cbc11cba829b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mjc2MjQwNw==", "url": "https://github.com/hyperledger/besu/pull/340#discussion_r372762407", "bodyText": "I personally am happy with mutating the original HttpServerOptions, some devs prefer that input params must not be mutated and a clone should be created.", "author": "usmansaleem", "createdAt": "2020-01-30T05:12:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mjc1OTgxMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mjc2MjkwMg==", "url": "https://github.com/hyperledger/besu/pull/340#discussion_r372762902", "bodyText": "Pushing in changes shortly that mutates original HttpServerOption instead.", "author": "usmansaleem", "createdAt": "2020-01-30T05:15:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mjc1OTgxMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mjc1OTg2Mw==", "url": "https://github.com/hyperledger/besu/pull/340#discussion_r372759863", "bodyText": "Same copy question above.", "author": "shemnon", "createdAt": "2020-01-30T04:58:36Z", "path": "ethereum/api/src/main/java/org/hyperledger/besu/ethereum/api/jsonrpc/JsonRpcHttpService.java", "diffHunk": "@@ -279,34 +281,47 @@ private HttpServerOptions getHttpServerOptions() {\n     return applyTlsConfig(httpServerOptions);\n   }\n \n-  private HttpServerOptions applyTlsConfig(final HttpServerOptions httpServerOptions) {\n-    config\n-        .getTlsConfiguration()\n+  private HttpServerOptions applyTlsConfig(final HttpServerOptions input) {\n+    if (config.getTlsConfiguration().isEmpty()) {\n+      return input;\n+    }\n+\n+    final TlsConfiguration tlsConfiguration = config.getTlsConfiguration().get();\n+    final HttpServerOptions httpServerOptions = new HttpServerOptions(input);\n+    try {\n+      httpServerOptions\n+          .setSsl(true)\n+          .setPfxKeyCertOptions(\n+              new PfxOptions()\n+                  .setPath(tlsConfiguration.getKeyStorePath().toString())\n+                  .setPassword(tlsConfiguration.getKeyStorePassword()));\n+\n+      if (tlsConfiguration.getClientAuthConfiguration().isEmpty()) {\n+        return httpServerOptions;\n+      }\n+\n+      return applyTlsClientAuth(\n+          tlsConfiguration.getClientAuthConfiguration().get(), httpServerOptions);\n+    } catch (final RuntimeException re) {\n+      throw new JsonRpcServiceException(\n+          String.format(\n+              \"TLS options failed to initialize for Ethereum JSON RPC listener: %s\",\n+              re.getMessage()));\n+    }\n+  }\n+\n+  private HttpServerOptions applyTlsClientAuth(\n+      final TlsClientAuthConfiguration clientAuthConfiguration, final HttpServerOptions input) {\n+    final HttpServerOptions httpServerOptions = new HttpServerOptions(input);", "originalCommit": "6322e9f9165d7490160a2665d0d3cbc11cba829b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "5e5833232fb78e56a491e30b5c28cfe17f023bbb", "url": "https://github.com/hyperledger/besu/commit/5e5833232fb78e56a491e30b5c28cfe17f023bbb", "message": "review suggestions\n\nSigned-off-by: Usman Saleem <usman@usmans.info>", "committedDate": "2020-01-30T05:20:05Z", "type": "commit"}]}