{"pr_number": 1392, "pr_title": "Add debug_standardTraceBlockToFile JSON RPC method", "pr_createdAt": "2020-09-23T16:24:35Z", "pr_url": "https://github.com/hyperledger/besu/pull/1392", "timeline": [{"oid": "bcbb84e63ea6d0876870fb623a2a5151385ec06d", "url": "https://github.com/hyperledger/besu/commit/bcbb84e63ea6d0876870fb623a2a5151385ec06d", "message": "add debug_standardTraceBlockToFile JSON RPC method\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>", "committedDate": "2020-09-23T16:18:03Z", "type": "commit"}, {"oid": "d332694f46ca845b0d8476d3066d809c8398df65", "url": "https://github.com/hyperledger/besu/commit/d332694f46ca845b0d8476d3066d809c8398df65", "message": "update CHANGELOG.md\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>", "committedDate": "2020-09-23T16:36:57Z", "type": "commit"}, {"oid": "bdba868a6b418c078bf3ad6240169139d03bfe95", "url": "https://github.com/hyperledger/besu/commit/bdba868a6b418c078bf3ad6240169139d03bfe95", "message": "Merge branch 'master' into feature/add-standard-trace-block-to-file", "committedDate": "2020-09-23T16:37:33Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzczNTU5MQ==", "url": "https://github.com/hyperledger/besu/pull/1392#discussion_r493735591", "bodyText": "Since it's been moved out of EVM tool perhaps a different name, StandardJsonTracer?", "author": "shemnon", "createdAt": "2020-09-23T16:39:07Z", "path": "ethereum/core/src/main/java/org/hyperledger/besu/ethereum/vm/EVMToolTracer.java", "diffHunk": "@@ -34,30 +32,42 @@\n import org.apache.tuweni.bytes.Bytes;\n import org.apache.tuweni.units.bigints.UInt256;\n \n-class EVMToolTracer implements OperationTracer {\n+public class EVMToolTracer implements OperationTracer {", "originalCommit": "bdba868a6b418c078bf3ad6240169139d03bfe95", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDI4ODcxNA==", "url": "https://github.com/hyperledger/besu/pull/1392#discussion_r494288714", "bodyText": "Done", "author": "matkt", "createdAt": "2020-09-24T12:48:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzczNTU5MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzczOTM2Nw==", "url": "https://github.com/hyperledger/besu/pull/1392#discussion_r493739367", "bodyText": "Use standard getter/setters", "author": "shemnon", "createdAt": "2020-09-23T16:45:07Z", "path": "ethereum/api/src/main/java/org/hyperledger/besu/ethereum/api/jsonrpc/internal/parameters/TransactionTraceParams.java", "diffHunk": "@@ -14,30 +14,53 @@\n  */\n package org.hyperledger.besu.ethereum.api.jsonrpc.internal.parameters;\n \n+import org.hyperledger.besu.ethereum.core.Hash;\n import org.hyperledger.besu.ethereum.debug.TraceOptions;\n \n-import com.fasterxml.jackson.annotation.JsonCreator;\n+import java.util.Optional;\n+import javax.annotation.Nullable;\n+\n import com.fasterxml.jackson.annotation.JsonIgnoreProperties;\n import com.fasterxml.jackson.annotation.JsonProperty;\n+import com.fasterxml.jackson.databind.annotation.JsonDeserialize;\n+import com.fasterxml.jackson.databind.annotation.JsonSerialize;\n+import org.immutables.value.Value;\n \n+@Value.Immutable\n+@JsonSerialize(as = ImmutableTransactionTraceParams.class)\n+@JsonDeserialize(as = ImmutableTransactionTraceParams.class)\n @JsonIgnoreProperties(ignoreUnknown = true)\n-public class TransactionTraceParams {\n-\n-  private final boolean disableStorage;\n-  private final boolean disableMemory;\n-  private final boolean disableStack;\n-\n-  @JsonCreator()\n-  public TransactionTraceParams(\n-      @JsonProperty(\"disableStorage\") final boolean disableStorage,\n-      @JsonProperty(\"disableMemory\") final boolean disableMemory,\n-      @JsonProperty(\"disableStack\") final boolean disableStack) {\n-    this.disableStorage = disableStorage;\n-    this.disableMemory = disableMemory;\n-    this.disableStack = disableStack;\n+public interface TransactionTraceParams {\n+\n+  @JsonProperty(\"txHash\")\n+  @Nullable\n+  String transactionHash();", "originalCommit": "bdba868a6b418c078bf3ad6240169139d03bfe95", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDI4ODc3Nw==", "url": "https://github.com/hyperledger/besu/pull/1392#discussion_r494288777", "bodyText": "Done", "author": "matkt", "createdAt": "2020-09-24T12:48:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzczOTM2Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzczOTY4NQ==", "url": "https://github.com/hyperledger/besu/pull/1392#discussion_r493739685", "bodyText": "This will need to be renamed, or dropped.", "author": "shemnon", "createdAt": "2020-09-23T16:45:38Z", "path": "ethereum/api/src/main/java/org/hyperledger/besu/ethereum/api/jsonrpc/internal/parameters/TransactionTraceParams.java", "diffHunk": "@@ -14,30 +14,53 @@\n  */\n package org.hyperledger.besu.ethereum.api.jsonrpc.internal.parameters;\n \n+import org.hyperledger.besu.ethereum.core.Hash;\n import org.hyperledger.besu.ethereum.debug.TraceOptions;\n \n-import com.fasterxml.jackson.annotation.JsonCreator;\n+import java.util.Optional;\n+import javax.annotation.Nullable;\n+\n import com.fasterxml.jackson.annotation.JsonIgnoreProperties;\n import com.fasterxml.jackson.annotation.JsonProperty;\n+import com.fasterxml.jackson.databind.annotation.JsonDeserialize;\n+import com.fasterxml.jackson.databind.annotation.JsonSerialize;\n+import org.immutables.value.Value;\n \n+@Value.Immutable\n+@JsonSerialize(as = ImmutableTransactionTraceParams.class)\n+@JsonDeserialize(as = ImmutableTransactionTraceParams.class)\n @JsonIgnoreProperties(ignoreUnknown = true)\n-public class TransactionTraceParams {\n-\n-  private final boolean disableStorage;\n-  private final boolean disableMemory;\n-  private final boolean disableStack;\n-\n-  @JsonCreator()\n-  public TransactionTraceParams(\n-      @JsonProperty(\"disableStorage\") final boolean disableStorage,\n-      @JsonProperty(\"disableMemory\") final boolean disableMemory,\n-      @JsonProperty(\"disableStack\") final boolean disableStack) {\n-    this.disableStorage = disableStorage;\n-    this.disableMemory = disableMemory;\n-    this.disableStack = disableStack;\n+public interface TransactionTraceParams {\n+\n+  @JsonProperty(\"txHash\")\n+  @Nullable\n+  String transactionHash();\n+\n+  @JsonProperty(value = \"disableStorage\")\n+  @Value.Default\n+  default boolean disableStorage() {\n+    return false;\n+  }\n+\n+  @JsonProperty(value = \"disableMemory\")\n+  @Value.Default\n+  default boolean disableMemory() {\n+    return false;\n+  }\n+\n+  @JsonProperty(value = \"disableStack\")\n+  @Value.Default\n+  default boolean disableStack() {\n+    return false;\n+  }\n+\n+  default TraceOptions traceOptions() {\n+    return new TraceOptions(!disableStorage(), !disableMemory(), !disableStack());\n   }\n \n-  public TraceOptions traceOptions() {\n-    return new TraceOptions(!disableStorage, !disableMemory, !disableStack);\n+  default Optional<Hash> getTransactionHash() {", "originalCommit": "bdba868a6b418c078bf3ad6240169139d03bfe95", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDI4ODgxOQ==", "url": "https://github.com/hyperledger/besu/pull/1392#discussion_r494288819", "bodyText": "Done", "author": "matkt", "createdAt": "2020-09-24T12:48:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzczOTY4NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzc0MTYwMg==", "url": "https://github.com/hyperledger/besu/pull/1392#discussion_r493741602", "bodyText": "Do we want these going to tmp?  perhaps our data root under traces?", "author": "shemnon", "createdAt": "2020-09-23T16:48:56Z", "path": "ethereum/api/src/main/java/org/hyperledger/besu/ethereum/api/jsonrpc/internal/processor/TransactionTracer.java", "diffHunk": "@@ -46,7 +61,71 @@ public TransactionTracer(final BlockReplay blockReplay) {\n                   tracer,\n                   new BlockHashLookup(header, blockchain),\n                   false);\n-          return new TransactionTrace(transaction, result, tracer.getTraceFrames());\n+          timer.stop();\n+          return new TransactionTrace(\n+              transaction, result, tracer.getTraceFrames(), timer.elapsed(TimeUnit.NANOSECONDS));\n+        });\n+  }\n+\n+  public Optional<TransactionTrace> traceTransaction(\n+      final Hash blockHash, final Hash transactionHash, final EVMToolTracer tracer) {\n+    return blockReplay.beforeTransactionInBlock(\n+        blockHash,\n+        transactionHash,\n+        (transaction, header, blockchain, mutableWorldState, transactionProcessor) -> {\n+          final Stopwatch timer = Stopwatch.createStarted();\n+          final Result result =\n+              transactionProcessor.processTransaction(\n+                  blockchain,\n+                  mutableWorldState.updater(),\n+                  header,\n+                  transaction,\n+                  header.getCoinbase(),\n+                  tracer,\n+                  new BlockHashLookup(header, blockchain),\n+                  false,\n+                  new TransactionValidationParams.Builder().allowFutureNonce(true).build());\n+\n+          timer.stop();\n+          return new TransactionTrace(\n+              transaction, result, new ArrayList<>(), timer.elapsed(TimeUnit.NANOSECONDS));\n         });\n   }\n+\n+  public List<String> traceTransactionToFile(\n+      final Hash blockHash,\n+      final List<Transaction> transactions,\n+      final Optional<TransactionTraceParams> transactionTraceParams) {\n+    final List<String> traces = new ArrayList<>();\n+    try {\n+      final Optional<Hash> selectedHash =\n+          transactionTraceParams.flatMap(TransactionTraceParams::getTransactionHash);\n+      final boolean showMemory =\n+          transactionTraceParams.map(TransactionTraceParams::disableMemory).orElse(true);\n+      for (int i = 0; i < transactions.size(); i++) {\n+        final Transaction transaction = transactions.get(i);\n+        if (selectedHash.isEmpty()\n+            || selectedHash.filter(isEqual(transaction.getHash())).isPresent()) {\n+          final File tmpFile =", "originalCommit": "bdba868a6b418c078bf3ad6240169139d03bfe95", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDI5MDYxNg==", "url": "https://github.com/hyperledger/besu/pull/1392#discussion_r494290616", "bodyText": "I don't have a strong opinion on it. I did this to be consistent with the other clients. But I just changed to put it in the data/traces now", "author": "matkt", "createdAt": "2020-09-24T12:51:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzc0MTYwMg=="}], "type": "inlineReview"}, {"oid": "50255af8e93df0aaac67ddee16548f79ac68265d", "url": "https://github.com/hyperledger/besu/commit/50255af8e93df0aaac67ddee16548f79ac68265d", "message": "fix review issues\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>", "committedDate": "2020-09-24T12:46:54Z", "type": "commit"}, {"oid": "38046dacf9fca384ca33b81c2102936342ab6ae9", "url": "https://github.com/hyperledger/besu/commit/38046dacf9fca384ca33b81c2102936342ab6ae9", "message": "fix review issues\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>", "committedDate": "2020-09-24T12:47:21Z", "type": "commit"}, {"oid": "c45752e92d40607de595998a9789770a9fdf9663", "url": "https://github.com/hyperledger/besu/commit/c45752e92d40607de595998a9789770a9fdf9663", "message": "Merge branch 'master' into feature/add-standard-trace-block-to-file", "committedDate": "2020-09-24T12:51:16Z", "type": "commit"}, {"oid": "9742da8f3986a511b32a1be23f969b8fbb1581b6", "url": "https://github.com/hyperledger/besu/commit/9742da8f3986a511b32a1be23f969b8fbb1581b6", "message": "fix pipeline\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>", "committedDate": "2020-09-24T14:12:10Z", "type": "commit"}, {"oid": "76cbd6300b8ccf881077ce85463a7d9239168258", "url": "https://github.com/hyperledger/besu/commit/76cbd6300b8ccf881077ce85463a7d9239168258", "message": "Merge branch 'master' into feature/add-standard-trace-block-to-file", "committedDate": "2020-09-25T12:04:04Z", "type": "commit"}, {"oid": "2309566343460edeb19f2606299bbcdbe6500f03", "url": "https://github.com/hyperledger/besu/commit/2309566343460edeb19f2606299bbcdbe6500f03", "message": "Merge branch 'master' into feature/add-standard-trace-block-to-file", "committedDate": "2020-09-28T09:22:20Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTk5ODQyMQ==", "url": "https://github.com/hyperledger/besu/pull/1392#discussion_r495998421", "bodyText": "This should be moved to the 1.6.0-RC1 section once merged.", "author": "shemnon", "createdAt": "2020-09-28T14:50:16Z", "path": "CHANGELOG.md", "diffHunk": "@@ -4,6 +4,7 @@\n \n ### Additions and Improvements\n * The new version of the [web3js-eea library (v0.10)](https://github.com/PegaSysEng/web3js-eea) supports the onchain privacy group management changes made in Besu v1.5.3.     \n+* Added `debug_standardTraceBlockToFile` JSON-RPC API. This API accepts a block hash and will replay the block. It returns a list of files containing the result of the trace (one file per transaction). [\\#1392](https://github.com/hyperledger/besu/pull/1392)", "originalCommit": "2309566343460edeb19f2606299bbcdbe6500f03", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "b4cffef63b52a3a3fd54e1a35bdca16389d19fe9", "url": "https://github.com/hyperledger/besu/commit/b4cffef63b52a3a3fd54e1a35bdca16389d19fe9", "message": "update CHANGELOG.md\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>", "committedDate": "2020-09-28T16:43:51Z", "type": "commit"}, {"oid": "799674fc545cec48f1a550ee04c829e91a06112a", "url": "https://github.com/hyperledger/besu/commit/799674fc545cec48f1a550ee04c829e91a06112a", "message": "Merge branch 'upstream/master' into feature/add-standard-trace-block-to-file\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>", "committedDate": "2020-09-28T16:49:54Z", "type": "commit"}]}