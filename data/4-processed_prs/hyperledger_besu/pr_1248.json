{"pr_number": 1248, "pr_title": "Add admin_logsRemoveCache end point", "pr_createdAt": "2020-07-23T16:46:47Z", "pr_url": "https://github.com/hyperledger/besu/pull/1248", "timeline": [{"oid": "dad8dae8bd6601bfe0d3f620036ffdc2f657b702", "url": "https://github.com/hyperledger/besu/commit/dad8dae8bd6601bfe0d3f620036ffdc2f657b702", "message": "#1066 Switched to use unprefixed hex strings for memory and stack values\n\nSigned-off-by: David Mechler <david.mechler@consensys.net>", "committedDate": "2020-06-26T13:37:13Z", "type": "commit"}, {"oid": "01430e770da93ea19171e1a9683daec7c10677f4", "url": "https://github.com/hyperledger/besu/commit/01430e770da93ea19171e1a9683daec7c10677f4", "message": "Merge branch 'master' of github.com:hyperledger/besu", "committedDate": "2020-06-26T16:53:26Z", "type": "commit"}, {"oid": "aac3bd6d4d5c6f16a4ef1e8c1cf7fb3fd8346b7d", "url": "https://github.com/hyperledger/besu/commit/aac3bd6d4d5c6f16a4ef1e8c1cf7fb3fd8346b7d", "message": "Merge branch 'master' of github.com:hyperledger/besu", "committedDate": "2020-06-30T17:04:49Z", "type": "commit"}, {"oid": "17aa301cff4a1192efb3a0d3e53e05995dafa744", "url": "https://github.com/hyperledger/besu/commit/17aa301cff4a1192efb3a0d3e53e05995dafa744", "message": "Disable flaky tests per Ben Burns(Yeti) request\n\nSigned-off-by: David Mechler <david.mechler@consensys.net>", "committedDate": "2020-06-30T20:58:04Z", "type": "commit"}, {"oid": "4a987ae3bd51de708b0f230a26b56785142ec06f", "url": "https://github.com/hyperledger/besu/commit/4a987ae3bd51de708b0f230a26b56785142ec06f", "message": "Merge branch 'master' of github.com:hyperledger/besu", "committedDate": "2020-06-30T23:43:03Z", "type": "commit"}, {"oid": "520d3172fad19bb6ff7055c44b6ddce524ee8bce", "url": "https://github.com/hyperledger/besu/commit/520d3172fad19bb6ff7055c44b6ddce524ee8bce", "message": "Revert last commit and enable ignored tests.\n\nSigned-off-by: David Mechler <david.mechler@consensys.net>", "committedDate": "2020-06-30T23:45:44Z", "type": "commit"}, {"oid": "0e61d8699e37f65780ac5985fb841cbb31920ee8", "url": "https://github.com/hyperledger/besu/commit/0e61d8699e37f65780ac5985fb841cbb31920ee8", "message": "Merge branch 'master' of github.com:hyperledger/besu", "committedDate": "2020-07-01T19:10:35Z", "type": "commit"}, {"oid": "6fc3bf9be8452f237c8a1eb0b96ede151c8a2427", "url": "https://github.com/hyperledger/besu/commit/6fc3bf9be8452f237c8a1eb0b96ede151c8a2427", "message": "Merge branch 'master' of github.com:hyperledger/besu", "committedDate": "2020-07-06T18:44:24Z", "type": "commit"}, {"oid": "47c82ed2dbbf9d1c31e0f60fe0f963d8c16a7362", "url": "https://github.com/hyperledger/besu/commit/47c82ed2dbbf9d1c31e0f60fe0f963d8c16a7362", "message": "#1157 - updated to create 2 agents so that proper bonding can occur\n\nSigned-off-by: David Mechler <david.mechler@consensys.net>", "committedDate": "2020-07-06T21:11:34Z", "type": "commit"}, {"oid": "9742c60a6d08924106055868d933b06ec6b41b1f", "url": "https://github.com/hyperledger/besu/commit/9742c60a6d08924106055868d933b06ec6b41b1f", "message": "Merge branch 'master' into master", "committedDate": "2020-07-06T21:26:30Z", "type": "commit"}, {"oid": "a13be1b0ddac0a3972c0b2af59fe86479c22bc02", "url": "https://github.com/hyperledger/besu/commit/a13be1b0ddac0a3972c0b2af59fe86479c22bc02", "message": "Merge branch 'master' into master", "committedDate": "2020-07-06T23:16:30Z", "type": "commit"}, {"oid": "5d8dfe6f80d2ea9a337126b79042207a9a555041", "url": "https://github.com/hyperledger/besu/commit/5d8dfe6f80d2ea9a337126b79042207a9a555041", "message": "Merge branch 'master' of github.com:hyperledger/besu", "committedDate": "2020-07-07T13:05:21Z", "type": "commit"}, {"oid": "4c6163d1472d16f60b32ec038ce81cb3abfea6e3", "url": "https://github.com/hyperledger/besu/commit/4c6163d1472d16f60b32ec038ce81cb3abfea6e3", "message": "Merge branch 'master' of github.com:hyperledger/besu", "committedDate": "2020-07-08T15:26:54Z", "type": "commit"}, {"oid": "11873402ff1e78d9f0d1edfe3ef0bc4557878133", "url": "https://github.com/hyperledger/besu/commit/11873402ff1e78d9f0d1edfe3ef0bc4557878133", "message": "Merge branch 'master' of github.com:hyperledger/besu", "committedDate": "2020-07-09T13:20:06Z", "type": "commit"}, {"oid": "a92d67821b55776d6c1625f40e713d2214fad6f4", "url": "https://github.com/hyperledger/besu/commit/a92d67821b55776d6c1625f40e713d2214fad6f4", "message": "#1162 - Updated test to mock the local peer PING packet creation so that the hash can be managed.\n\nSigned-off-by: David Mechler <david.mechler@consensys.net>", "committedDate": "2020-07-09T13:27:29Z", "type": "commit"}, {"oid": "b0db56c0bedcd3266e88cb41ef7a2e16fcb63908", "url": "https://github.com/hyperledger/besu/commit/b0db56c0bedcd3266e88cb41ef7a2e16fcb63908", "message": "Merge branch 'master' of github.com:hyperledger/besu", "committedDate": "2020-07-14T15:19:03Z", "type": "commit"}, {"oid": "e301b49061e1b443b2da32ae83b7075632f84518", "url": "https://github.com/hyperledger/besu/commit/e301b49061e1b443b2da32ae83b7075632f84518", "message": "Added admin_logsRepairCache end point\n\nSigned-off-by: David Mechler <david.mechler@consensys.net>", "committedDate": "2020-07-16T15:58:11Z", "type": "commit"}, {"oid": "133485e7d254442ac043fdcb8353cd72420fca11", "url": "https://github.com/hyperledger/besu/commit/133485e7d254442ac043fdcb8353cd72420fca11", "message": "Merge branch 'master' of github.com:hyperledger/besu", "committedDate": "2020-07-16T15:58:24Z", "type": "commit"}, {"oid": "7d6690d84c242eb5f0bbd1d9863f82a07646a16f", "url": "https://github.com/hyperledger/besu/commit/7d6690d84c242eb5f0bbd1d9863f82a07646a16f", "message": "Added admin_logsRepairCache end point\n\nSigned-off-by: David Mechler <david.mechler@consensys.net>", "committedDate": "2020-07-16T15:59:53Z", "type": "commit"}, {"oid": "ae4776c263bcc77548973645f8cc9b62e38b654b", "url": "https://github.com/hyperledger/besu/commit/ae4776c263bcc77548973645f8cc9b62e38b654b", "message": "Merge branch 'master' into master", "committedDate": "2020-07-16T16:54:14Z", "type": "commit"}, {"oid": "8d09e0340beef2421d0f4272ab5d13918c29f196", "url": "https://github.com/hyperledger/besu/commit/8d09e0340beef2421d0f4272ab5d13918c29f196", "message": "Remove p2p network code per PR comments\n\nSigned-off-by: David Mechler <david.mechler@consensys.net>", "committedDate": "2020-07-16T18:04:11Z", "type": "commit"}, {"oid": "99a2d6fb0c5596fc72631fce7d7063dc6c29a57c", "url": "https://github.com/hyperledger/besu/commit/99a2d6fb0c5596fc72631fce7d7063dc6c29a57c", "message": "Merge branch 'master' of github.com:hyperledger/besu", "committedDate": "2020-07-16T18:51:56Z", "type": "commit"}, {"oid": "315149c134ab7f3f70701ed89e28f4c9d1a4954d", "url": "https://github.com/hyperledger/besu/commit/315149c134ab7f3f70701ed89e28f4c9d1a4954d", "message": "Updates from PR comments\n\nSigned-off-by: David Mechler <david.mechler@consensys.net>", "committedDate": "2020-07-16T19:56:25Z", "type": "commit"}, {"oid": "2b70082c6dd14ce51dd6bd63d96a875126795390", "url": "https://github.com/hyperledger/besu/commit/2b70082c6dd14ce51dd6bd63d96a875126795390", "message": "Spotless Apply fixes\n\nSigned-off-by: David Mechler <david.mechler@consensys.net>", "committedDate": "2020-07-16T21:07:30Z", "type": "commit"}, {"oid": "f32a56c946022de71be4087c542044c96ec7bed6", "url": "https://github.com/hyperledger/besu/commit/f32a56c946022de71be4087c542044c96ec7bed6", "message": "PR updates\n\nSigned-off-by: David Mechler <david.mechler@consensys.net>", "committedDate": "2020-07-17T00:59:56Z", "type": "commit"}, {"oid": "0a9c73d8c69750635a0ccbcac69a347e8b4c3949", "url": "https://github.com/hyperledger/besu/commit/0a9c73d8c69750635a0ccbcac69a347e8b4c3949", "message": "Admin force cache refresh when called through end point per PR comments\n\nSigned-off-by: David Mechler <david.mechler@consensys.net>", "committedDate": "2020-07-17T17:09:38Z", "type": "commit"}, {"oid": "2bba686aa081d3b1d63af237f605a36a76b9753a", "url": "https://github.com/hyperledger/besu/commit/2bba686aa081d3b1d63af237f605a36a76b9753a", "message": "Pr updates\n\nSigned-off-by: David Mechler <david.mechler@consensys.net>", "committedDate": "2020-07-20T12:49:02Z", "type": "commit"}, {"oid": "4494a7b4e19b35c1250d52ee5e39e2e57b62f8cd", "url": "https://github.com/hyperledger/besu/commit/4494a7b4e19b35c1250d52ee5e39e2e57b62f8cd", "message": "Merge branch 'master' of github.com:hyperledger/besu into TKT-1171", "committedDate": "2020-07-20T16:16:03Z", "type": "commit"}, {"oid": "cf4e1b1070f185ee833769bdd52e193731df6afd", "url": "https://github.com/hyperledger/besu/commit/cf4e1b1070f185ee833769bdd52e193731df6afd", "message": "TKT-1171 - Added admin_logsRemoveCache end point\n\nSigned-off-by: David Mechler <david.mechler@consensys.net>", "committedDate": "2020-07-22T16:55:02Z", "type": "commit"}, {"oid": "1dc987ed58cebd4265dc97e89d17ba098d8ff75f", "url": "https://github.com/hyperledger/besu/commit/1dc987ed58cebd4265dc97e89d17ba098d8ff75f", "message": "Merge branch 'master' of github.com:hyperledger/besu into TKT-1171", "committedDate": "2020-07-22T16:55:20Z", "type": "commit"}, {"oid": "89e3d6b357af4286f55db67ff8f9c82dbfd966dc", "url": "https://github.com/hyperledger/besu/commit/89e3d6b357af4286f55db67ff8f9c82dbfd966dc", "message": "Fix minor issue in TransactionLogBloomCacher.ensurePreviousSegmentsArePresent; Fixes for AdminLogsRemoveCache\n\nSigned-off-by: David Mechler <david.mechler@consensys.net>", "committedDate": "2020-07-23T16:38:18Z", "type": "commit"}, {"oid": "afe80c009ab2ded03becdade0ba6857e0150b303", "url": "https://github.com/hyperledger/besu/commit/afe80c009ab2ded03becdade0ba6857e0150b303", "message": "Merge branch 'master' of github.com:hyperledger/besu into TKT-1171", "committedDate": "2020-07-23T16:38:34Z", "type": "commit"}, {"oid": "2d28e31ce0b454997c3a35ff6a2753b5752fa466", "url": "https://github.com/hyperledger/besu/commit/2d28e31ce0b454997c3a35ff6a2753b5752fa466", "message": "Merge branch 'master' into TKT-1171", "committedDate": "2020-07-23T20:55:02Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTk3NDUwNA==", "url": "https://github.com/hyperledger/besu/pull/1248#discussion_r459974504", "bodyText": "It's optional but I wonder if reducing this line like that would not be interesting.\nfilter(\n     // Only keep filters where the \"to\" block could include the block in the event\n     filter -> filter.getToBlock().getNumber().filter(number ->\n              number>= event.getBlock().getHeader().getNumber()\n     ).isPresent())\n.forEach(...", "author": "matkt", "createdAt": "2020-07-24T10:30:55Z", "path": "ethereum/api/src/main/java/org/hyperledger/besu/ethereum/api/jsonrpc/internal/filter/FilterManager.java", "diffHunk": "@@ -168,9 +167,9 @@ public void recordBlockEvent(final BlockAddedEvent event) {\n         .filter(\n             // Only keep filters where the \"to\" block could include the block in the event\n             filter -> {\n-              final OptionalLong maybeToBlockNumber = filter.getToBlock().getNumber();\n+              final Optional<Long> maybeToBlockNumber = filter.getToBlock().getNumber();\n               return maybeToBlockNumber.isEmpty()\n-                  || maybeToBlockNumber.getAsLong() >= event.getBlock().getHeader().getNumber();\n+                  || maybeToBlockNumber.get() >= event.getBlock().getHeader().getNumber();", "originalCommit": "2d28e31ce0b454997c3a35ff6a2753b5752fa466", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTk3NjYzNA==", "url": "https://github.com/hyperledger/besu/pull/1248#discussion_r459976634", "bodyText": "it seems to me that you can use that BlockHeader.GENESIS_BLOCK_NUMBER here", "author": "matkt", "createdAt": "2020-07-24T10:36:03Z", "path": "ethereum/api/src/main/java/org/hyperledger/besu/ethereum/api/jsonrpc/internal/methods/AdminLogsRemoveCache.java", "diffHunk": "@@ -0,0 +1,101 @@\n+/*\n+ * Copyright ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ *\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+package org.hyperledger.besu.ethereum.api.jsonrpc.internal.methods;\n+\n+import org.hyperledger.besu.ethereum.api.jsonrpc.RpcMethod;\n+import org.hyperledger.besu.ethereum.api.jsonrpc.internal.JsonRpcRequestContext;\n+import org.hyperledger.besu.ethereum.api.jsonrpc.internal.parameters.BlockParameter;\n+import org.hyperledger.besu.ethereum.api.jsonrpc.internal.response.JsonRpcError;\n+import org.hyperledger.besu.ethereum.api.jsonrpc.internal.response.JsonRpcErrorResponse;\n+import org.hyperledger.besu.ethereum.api.jsonrpc.internal.response.JsonRpcResponse;\n+import org.hyperledger.besu.ethereum.api.jsonrpc.internal.response.JsonRpcSuccessResponse;\n+import org.hyperledger.besu.ethereum.api.query.BlockchainQueries;\n+import org.hyperledger.besu.ethereum.api.query.TransactionLogBloomCacher;\n+\n+import java.util.Map;\n+import java.util.Optional;\n+\n+public class AdminLogsRemoveCache implements JsonRpcMethod {\n+  private final BlockchainQueries blockchainQueries;\n+\n+  public AdminLogsRemoveCache(final BlockchainQueries blockchainQueries) {\n+    this.blockchainQueries = blockchainQueries;\n+  }\n+\n+  @Override\n+  public String getName() {\n+    return RpcMethod.ADMIN_LOGS_REMOVE_CACHE.getMethodName();\n+  }\n+\n+  @Override\n+  public JsonRpcResponse response(final JsonRpcRequestContext requestContext) {\n+    final Optional<BlockParameter> startBlockParameter =\n+        requestContext.getOptionalParameter(0, BlockParameter.class);\n+    final Optional<BlockParameter> stopBlockParameter =\n+        requestContext.getOptionalParameter(1, BlockParameter.class);\n+\n+    final long startBlock;\n+    if (startBlockParameter.isEmpty() || startBlockParameter.get().isEarliest()) {\n+      startBlock = 0;", "originalCommit": "2d28e31ce0b454997c3a35ff6a2753b5752fa466", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "ae8ff451d36fcaaf8708d8cab7fafedf3a17b563", "url": "https://github.com/hyperledger/besu/commit/ae8ff451d36fcaaf8708d8cab7fafedf3a17b563", "message": "Merge branch 'master' into TKT-1171", "committedDate": "2020-07-24T12:04:14Z", "type": "commit"}, {"oid": "c68ec8031fa5633208f01684629a549d913272a5", "url": "https://github.com/hyperledger/besu/commit/c68ec8031fa5633208f01684629a549d913272a5", "message": "PR updates\n\nSigned-off-by: David Mechler <david.mechler@consensys.net>", "committedDate": "2020-07-24T12:09:43Z", "type": "commit"}, {"oid": "bcd283e8d702571ec93823732837961b51b35038", "url": "https://github.com/hyperledger/besu/commit/bcd283e8d702571ec93823732837961b51b35038", "message": "Merge branch 'TKT-1171' of github.com:davemec/besu into TKT-1171", "committedDate": "2020-07-24T12:09:54Z", "type": "commit"}, {"oid": "8075da30fb8f16081ddd80ea281065f2bb179ae1", "url": "https://github.com/hyperledger/besu/commit/8075da30fb8f16081ddd80ea281065f2bb179ae1", "message": "PR updates\n\nSigned-off-by: David Mechler <david.mechler@consensys.net>", "committedDate": "2020-07-24T12:30:57Z", "type": "commit"}]}