{"pr_number": 1649, "pr_title": "Add extra info in log messages to help with flaky test ", "pr_createdAt": "2020-12-02T08:03:00Z", "pr_url": "https://github.com/hyperledger/besu/pull/1649", "timeline": [{"oid": "1619e86ec9d60b67d35d215f6c2ef57aeddc9764", "url": "https://github.com/hyperledger/besu/commit/1619e86ec9d60b67d35d215f6c2ef57aeddc9764", "message": "extra logging including pid\n\nSigned-off-by: Sally MacFarlane <sally.macfarlane@consensys.net>", "committedDate": "2020-12-02T04:14:38Z", "type": "commit"}, {"oid": "8b91384231a137d3491075b9b70aaaae6628d47f", "url": "https://github.com/hyperledger/besu/commit/8b91384231a137d3491075b9b70aaaae6628d47f", "message": "extra logging\n\nSigned-off-by: Sally MacFarlane <sally.macfarlane@consensys.net>", "committedDate": "2020-12-02T08:00:23Z", "type": "commit"}, {"oid": "99c3c1e5943e8690a5bc953b65c5dedb96b55a4a", "url": "https://github.com/hyperledger/besu/commit/99c3c1e5943e8690a5bc953b65c5dedb96b55a4a", "message": "Merge branch 'master' of https://github.com/hyperledger/besu into flaky-test-await-peer-count", "committedDate": "2020-12-02T08:00:27Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDU2NTIxMQ==", "url": "https://github.com/hyperledger/besu/pull/1649#discussion_r534565211", "bodyText": "can we put a try-catch block around the awaitPeerDiscovery and if fail - dump the actual peers\n(this would require creating a transaction in the dsl which wraps Ethereum.adminPeers - similar to NetPeerCountTransaction)", "author": "rain-on", "createdAt": "2020-12-03T00:01:43Z", "path": "acceptance-tests/dsl/src/main/java/org/hyperledger/besu/tests/acceptance/dsl/node/cluster/Cluster.java", "diffHunk": "@@ -87,12 +87,19 @@ public void start(final List<? extends RunnableNode> nodes) {\n \n     nodes\n         .parallelStream()\n-        .filter(node -> bootnode.map(boot -> boot != node).orElse(true))\n+        .filter(\n+            node -> {\n+              LOG.info(\"starting non-bootnode {}\", node.getName());\n+              return bootnode.map(boot -> boot != node).orElse(true);\n+            })\n         .forEach(this::startNode);\n \n     if (clusterConfiguration.isAwaitPeerDiscovery()) {\n       for (final RunnableNode node : nodes) {\n-        LOG.info(\"Awaiting peer discovery for node {}\", node.getName());\n+        LOG.info(\n+            \"Awaiting peer discovery for node {}, expecting {} peers\",\n+            node.getName(),\n+            nodes.size() - 1);", "originalCommit": "99c3c1e5943e8690a5bc953b65c5dedb96b55a4a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDY1OTY5OQ==", "url": "https://github.com/hyperledger/besu/pull/1649#discussion_r534659699", "bodyText": "because it's an assert I think it would involve some pretty major refactoring", "author": "macfarla", "createdAt": "2020-12-03T04:29:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDU2NTIxMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDY3MzQzMw==", "url": "https://github.com/hyperledger/besu/pull/1649#discussion_r534673433", "bodyText": ":( That's the killer piece of info in some respects - but all good - getting this in is worth it.", "author": "rain-on", "createdAt": "2020-12-03T05:12:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDU2NTIxMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDU2NjEzNg==", "url": "https://github.com/hyperledger/besu/pull/1649#discussion_r534566136", "bodyText": "doing this in a custom fork-join pool can be done like:\nForkJoinPool forkJoinPool = new ForkJoinPool(nodes.size() - 1); forkJoiNPool.submit(nodes.parallelStream() ....\nThat removes a dependency on the \"system wide\" thread pool, which removes a dependency which might be causing problems,", "author": "rain-on", "createdAt": "2020-12-03T00:04:15Z", "path": "acceptance-tests/dsl/src/main/java/org/hyperledger/besu/tests/acceptance/dsl/node/cluster/Cluster.java", "diffHunk": "@@ -87,12 +87,19 @@ public void start(final List<? extends RunnableNode> nodes) {\n \n     nodes\n         .parallelStream()\n-        .filter(node -> bootnode.map(boot -> boot != node).orElse(true))\n+        .filter(", "originalCommit": "99c3c1e5943e8690a5bc953b65c5dedb96b55a4a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDY2MDY0NQ==", "url": "https://github.com/hyperledger/besu/pull/1649#discussion_r534660645", "bodyText": "would it make sense to do this as a separate PR in case it causes problems? Cluster is used by lots of tests", "author": "macfarla", "createdAt": "2020-12-03T04:32:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDU2NjEzNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDY3MzI5NA==", "url": "https://github.com/hyperledger/besu/pull/1649#discussion_r534673294", "bodyText": "sure - we can do that.", "author": "rain-on", "createdAt": "2020-12-03T05:12:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDU2NjEzNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDY3NDcwMA==", "url": "https://github.com/hyperledger/besu/pull/1649#discussion_r534674700", "bodyText": "there are some tests that start cluster with one node - and sometimes there's more than one bootnode. so it's not that neat.", "author": "macfarla", "createdAt": "2020-12-03T05:16:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDU2NjEzNg=="}], "type": "inlineReview"}, {"oid": "1fa032d2fa5b6575ea9b68c2911587348c18e216", "url": "https://github.com/hyperledger/besu/commit/1fa032d2fa5b6575ea9b68c2911587348c18e216", "message": "Merge branch 'master' of https://github.com/hyperledger/besu into flaky-test-await-peer-count", "committedDate": "2020-12-03T04:29:52Z", "type": "commit"}]}