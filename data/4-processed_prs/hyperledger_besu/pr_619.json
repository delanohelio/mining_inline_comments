{"pr_number": 619, "pr_title": "[EIP-1559] Step 1 - Apply block structure modification", "pr_createdAt": "2020-03-31T13:52:54Z", "pr_url": "https://github.com/hyperledger/besu/pull/619", "timeline": [{"oid": "ba37fd0efcba2de4ea34c979060ff361a1fe9798", "url": "https://github.com/hyperledger/besu/commit/ba37fd0efcba2de4ea34c979060ff361a1fe9798", "message": "Added changelog entries for PR:\n- https://github.com/hyperledger/besu/pull/430\n- https://github.com/hyperledger/besu/pull/440\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>", "committedDate": "2020-03-12T09:09:40Z", "type": "commit"}, {"oid": "872f9cc4e93b90829961ebe6e599c51af43c95a7", "url": "https://github.com/hyperledger/besu/commit/872f9cc4e93b90829961ebe6e599c51af43c95a7", "message": "Merge remote-tracking branch 'upstream/master'\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>\n\n# Conflicts:\n#\tCHANGELOG.md", "committedDate": "2020-03-13T08:25:43Z", "type": "commit"}, {"oid": "e417b30e90cb0b33940adb1bee6a9dc8953c4abd", "url": "https://github.com/hyperledger/besu/commit/e417b30e90cb0b33940adb1bee6a9dc8953c4abd", "message": "Merge remote-tracking branch 'upstream/master'\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>", "committedDate": "2020-03-16T09:10:11Z", "type": "commit"}, {"oid": "a2fb831c87dae221c92a9f9ec7705500717f1e77", "url": "https://github.com/hyperledger/besu/commit/a2fb831c87dae221c92a9f9ec7705500717f1e77", "message": "Merge remote-tracking branch 'upstream/master'\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>", "committedDate": "2020-03-17T09:17:25Z", "type": "commit"}, {"oid": "c07ed7de515e1e25ea22ef38b59bf8337086812e", "url": "https://github.com/hyperledger/besu/commit/c07ed7de515e1e25ea22ef38b59bf8337086812e", "message": "Merge remote-tracking branch 'upstream/master'\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>", "committedDate": "2020-03-17T15:26:18Z", "type": "commit"}, {"oid": "1c1e22fe5a81e6a748b338a2ebedaaa53a00f04d", "url": "https://github.com/hyperledger/besu/commit/1c1e22fe5a81e6a748b338a2ebedaaa53a00f04d", "message": "Merge remote-tracking branch 'upstream/master'\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>", "committedDate": "2020-03-18T08:29:25Z", "type": "commit"}, {"oid": "ee10a2590d8e23b95a40c946a2927730714c4793", "url": "https://github.com/hyperledger/besu/commit/ee10a2590d8e23b95a40c946a2927730714c4793", "message": "Merge remote-tracking branch 'upstream/master'\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>", "committedDate": "2020-03-19T16:27:54Z", "type": "commit"}, {"oid": "40cd31d7b48aab7b285524661ac17168c0d38467", "url": "https://github.com/hyperledger/besu/commit/40cd31d7b48aab7b285524661ac17168c0d38467", "message": "Merge remote-tracking branch 'upstream/master'\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>", "committedDate": "2020-03-23T10:35:38Z", "type": "commit"}, {"oid": "e96c01a8ca248ded2aa4f22a6f56d9119cabebf2", "url": "https://github.com/hyperledger/besu/commit/e96c01a8ca248ded2aa4f22a6f56d9119cabebf2", "message": "Merge remote-tracking branch 'upstream/master'\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>", "committedDate": "2020-03-25T08:04:10Z", "type": "commit"}, {"oid": "2c782ba4617a68e42def01737bdc6950ff7f9f53", "url": "https://github.com/hyperledger/besu/commit/2c782ba4617a68e42def01737bdc6950ff7f9f53", "message": "Merge remote-tracking branch 'upstream/master'\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>", "committedDate": "2020-03-31T09:26:18Z", "type": "commit"}, {"oid": "854ed2a6c863415636cd24a0519de23e9471c9fc", "url": "https://github.com/hyperledger/besu/commit/854ed2a6c863415636cd24a0519de23e9471c9fc", "message": "### Description\nBlockHeader object needs to be modified in order to add the new field (baseFee) as specified in the EIP.\nWe should take care about the RLP encoding/decoding of this structure since it has to include or not the new fields depending on whether we are pre fork or post fork.\n\n- Update `core.BlockHeader.java`\n    - Add `baseFee`\n    - Update `readFrom` method for RLP decoding\n    - Update `writeTo` method for RLP encoding\n- Update `plugin.data.BlockHeader.java`\n    - Add `getBaseFee` method\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>", "committedDate": "2020-03-31T13:50:37Z", "type": "commit"}, {"oid": "522c93b058589ad0c4d01249f465dd419a2a8368", "url": "https://github.com/hyperledger/besu/commit/522c93b058589ad0c4d01249f465dd419a2a8368", "message": "Merge branch 'master' into step-1-base-fee-block-header", "committedDate": "2020-04-01T07:57:14Z", "type": "commit"}, {"oid": "481b6d3d4743808d221f5f32321ac7149045b07f", "url": "https://github.com/hyperledger/besu/commit/481b6d3d4743808d221f5f32321ac7149045b07f", "message": "TODO Add CLI command line flag `--Xeip1559-enabled`.\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>", "committedDate": "2020-04-01T15:24:35Z", "type": "commit"}, {"oid": "c06ed3260754bada09462fa99892622c2eff119f", "url": "https://github.com/hyperledger/besu/commit/c06ed3260754bada09462fa99892622c2eff119f", "message": "TODO Add CLI command line flag `--Xeip1559-enabled`.\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>", "committedDate": "2020-04-01T16:09:51Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTg0MTcyMQ==", "url": "https://github.com/hyperledger/besu/pull/619#discussion_r401841721", "bodyText": "Should this be guarded with the feature flag?  Either on the parameter or the constructor.", "author": "shemnon", "createdAt": "2020-04-01T19:01:23Z", "path": "ethereum/core/src/main/java/org/hyperledger/besu/ethereum/core/BlockHeader.java", "diffHunk": "@@ -142,33 +144,50 @@ public void writeTo(final RLPOutput out) {\n     out.writeBytes(extraData);\n     out.writeBytes(mixHash);\n     out.writeLong(nonce);\n-\n+    if (baseFee != null) {", "originalCommit": "c06ed3260754bada09462fa99892622c2eff119f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjI2NjkyMw==", "url": "https://github.com/hyperledger/besu/pull/619#discussion_r402266923", "bodyText": "Sure. I will do that when step 0 gets merged.", "author": "abdelhamidbakhta", "createdAt": "2020-04-02T12:16:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTg0MTcyMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjM1OTU5NA==", "url": "https://github.com/hyperledger/besu/pull/619#discussion_r402359594", "bodyText": "Done in 7d7f59b", "author": "abdelhamidbakhta", "createdAt": "2020-04-02T14:31:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTg0MTcyMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTg0MjEwNg==", "url": "https://github.com/hyperledger/besu/pull/619#discussion_r401842106", "bodyText": "This too should be feature flag guarded.  So it it isn't enabled we will get RLP errors if they try to use it w/o the flag.", "author": "shemnon", "createdAt": "2020-04-01T19:01:59Z", "path": "ethereum/core/src/main/java/org/hyperledger/besu/ethereum/core/BlockHeader.java", "diffHunk": "@@ -142,33 +144,50 @@ public void writeTo(final RLPOutput out) {\n     out.writeBytes(extraData);\n     out.writeBytes(mixHash);\n     out.writeLong(nonce);\n-\n+    if (baseFee != null) {\n+      out.writeLongScalar(baseFee);\n+    }\n     out.endList();\n   }\n \n   public static BlockHeader readFrom(\n       final RLPInput input, final BlockHeaderFunctions blockHeaderFunctions) {\n     input.enterList();\n-    final BlockHeader blockHeader =\n-        new BlockHeader(\n-            Hash.wrap(input.readBytes32()),\n-            Hash.wrap(input.readBytes32()),\n-            Address.readFrom(input),\n-            Hash.wrap(input.readBytes32()),\n-            Hash.wrap(input.readBytes32()),\n-            Hash.wrap(input.readBytes32()),\n-            LogsBloomFilter.readFrom(input),\n-            Difficulty.of(input.readUInt256Scalar()),\n-            input.readLongScalar(),\n-            input.readLongScalar(),\n-            input.readLongScalar(),\n-            input.readLongScalar(),\n-            input.readBytes(),\n-            Hash.wrap(input.readBytes32()),\n-            input.readLong(),\n-            blockHeaderFunctions);\n+    final Hash parentHash = Hash.wrap(input.readBytes32());\n+    final Hash ommersHash = Hash.wrap(input.readBytes32());\n+    final Address coinbase = Address.readFrom(input);\n+    final Hash stateRoot = Hash.wrap(input.readBytes32());\n+    final Hash transactionsRoot = Hash.wrap(input.readBytes32());\n+    final Hash receiptsRoot = Hash.wrap(input.readBytes32());\n+    final LogsBloomFilter logsBloom = LogsBloomFilter.readFrom(input);\n+    final Difficulty difficulty = Difficulty.of(input.readUInt256Scalar());\n+    final long number = input.readLongScalar();\n+    final long gasLimit = input.readLongScalar();\n+    final long gasUsed = input.readLongScalar();\n+    final long timestamp = input.readLongScalar();\n+    final Bytes extraData = input.readBytes();\n+    final Hash mixHash = Hash.wrap(input.readBytes32());\n+    final long nonce = input.readLong();\n+    final Long baseFee = input.isEndOfCurrentList() ? null : input.readLongScalar();", "originalCommit": "c06ed3260754bada09462fa99892622c2eff119f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjI2Njk2Mw==", "url": "https://github.com/hyperledger/besu/pull/619#discussion_r402266963", "bodyText": "Sure. I will do that when step 0 gets merged.", "author": "abdelhamidbakhta", "createdAt": "2020-04-02T12:17:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTg0MjEwNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjM1OTc1NA==", "url": "https://github.com/hyperledger/besu/pull/619#discussion_r402359754", "bodyText": "Done in 7d7f59b", "author": "abdelhamidbakhta", "createdAt": "2020-04-02T14:31:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTg0MjEwNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTg0MzY1Ng==", "url": "https://github.com/hyperledger/besu/pull/619#discussion_r401843656", "bodyText": "Should be tagged @Unstable\nShould be a default method, returning null\nAlso, perhaps Optional<Long> instead of just Long?  Always empty when the BASEFEE isn't relevant?  If so the default is Optional.empty()", "author": "shemnon", "createdAt": "2020-04-01T19:04:48Z", "path": "plugin-api/src/main/java/org/hyperledger/besu/plugin/data/BlockHeader.java", "diffHunk": "@@ -154,4 +154,11 @@\n    * @return The Keccak 256-bit hash of this header.\n    */\n   Hash getBlockHash();\n+\n+  /**\n+   * The BASEFEE of this header.\n+   *\n+   * @return TheBASEFEE of this header.\n+   */\n+  Long getBaseFee();", "originalCommit": "c06ed3260754bada09462fa99892622c2eff119f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjI2NDE1NA==", "url": "https://github.com/hyperledger/besu/pull/619#discussion_r402264154", "bodyText": "Done. Added Unstable annotation and moved to Optional<Long>with default Optional.empty()", "author": "abdelhamidbakhta", "createdAt": "2020-04-02T12:11:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTg0MzY1Ng=="}], "type": "inlineReview"}, {"oid": "f385963fb358b46119e83ad8a5f8b5d4f7cadfec", "url": "https://github.com/hyperledger/besu/commit/f385963fb358b46119e83ad8a5f8b5d4f7cadfec", "message": "Merge remote-tracking branch 'upstream/master' into step-1-base-fee-block-header\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>", "committedDate": "2020-04-02T12:01:16Z", "type": "commit"}, {"oid": "5eab92582a43cd93dbb748fa0f5486f1a8dce54b", "url": "https://github.com/hyperledger/besu/commit/5eab92582a43cd93dbb748fa0f5486f1a8dce54b", "message": "Added unstable annotation for getBaseFee. Moved from long to `Optional<Long>`\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>", "committedDate": "2020-04-02T12:10:22Z", "type": "commit"}, {"oid": "b9e23e28d1110fe77a644fd077b5544759dd68f4", "url": "https://github.com/hyperledger/besu/commit/b9e23e28d1110fe77a644fd077b5544759dd68f4", "message": "Spotless apply\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>", "committedDate": "2020-04-02T12:15:59Z", "type": "commit"}, {"oid": "482cd3b2e2819dfc78add3ec00d7fb6c6f08228e", "url": "https://github.com/hyperledger/besu/commit/482cd3b2e2819dfc78add3ec00d7fb6c6f08228e", "message": "Fixed error\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>", "committedDate": "2020-04-02T12:18:12Z", "type": "commit"}, {"oid": "d4bb79fc7392aeeeaf7c4a60c2c6239e2eb71215", "url": "https://github.com/hyperledger/besu/commit/d4bb79fc7392aeeeaf7c4a60c2c6239e2eb71215", "message": "fix plugin API hash\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>", "committedDate": "2020-04-02T12:26:04Z", "type": "commit"}, {"oid": "cbe9081be47a8c62d85ba9123347c87de1f949f9", "url": "https://github.com/hyperledger/besu/commit/cbe9081be47a8c62d85ba9123347c87de1f949f9", "message": "Merge remote-tracking branch 'upstream/master' into step-1-base-fee-block-header\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>", "committedDate": "2020-04-02T14:27:32Z", "type": "commit"}, {"oid": "7d7f59b2d35fcf6fb4ec6853a732de388a52859e", "url": "https://github.com/hyperledger/besu/commit/7d7f59b2d35fcf6fb4ec6853a732de388a52859e", "message": "RLP encoding / decoding operations are guarded with the feature flag.\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>", "committedDate": "2020-04-02T14:30:58Z", "type": "commit"}, {"oid": "68b665c05addc3433096adc81b4e001633ae1150", "url": "https://github.com/hyperledger/besu/commit/68b665c05addc3433096adc81b4e001633ae1150", "message": "spotless apply\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>", "committedDate": "2020-04-02T14:33:51Z", "type": "commit"}, {"oid": "a8c89ed52c66616a4e62ab2eb82c9e38c8a4be38", "url": "https://github.com/hyperledger/besu/commit/a8c89ed52c66616a4e62ab2eb82c9e38c8a4be38", "message": "Merge branch 'master' into step-1-base-fee-block-header", "committedDate": "2020-04-02T16:45:22Z", "type": "commit"}, {"oid": "e063040739cec0fa2fdd2fecfbbbe989e0458651", "url": "https://github.com/hyperledger/besu/commit/e063040739cec0fa2fdd2fecfbbbe989e0458651", "message": "Merge remote-tracking branch 'upstream/master' into step-1-base-fee-block-header\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>\n\n# Conflicts:\n#\tplugin-api/build.gradle", "committedDate": "2020-04-03T08:26:35Z", "type": "commit"}]}