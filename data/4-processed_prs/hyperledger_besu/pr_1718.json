{"pr_number": 1718, "pr_title": "Go quorum configuration", "pr_createdAt": "2020-12-16T05:03:10Z", "pr_url": "https://github.com/hyperledger/besu/pull/1718", "timeline": [{"oid": "663500d305c8a10109b93e8d387124f260ed7021", "url": "https://github.com/hyperledger/besu/commit/663500d305c8a10109b93e8d387124f260ed7021", "message": "add goquorum privacy configuration\n\nSigned-off-by: Stefan Pingel <stefan.pingel@consensys.net>", "committedDate": "2020-12-16T04:59:35Z", "type": "commit"}, {"oid": "28b341b70cd172a0229fda340542cf0224aeb042", "url": "https://github.com/hyperledger/besu/commit/28b341b70cd172a0229fda340542cf0224aeb042", "message": "add goquorum privacy configuration\n\nSigned-off-by: Stefan Pingel <stefan.pingel@consensys.net>", "committedDate": "2020-12-16T04:59:56Z", "type": "commit"}, {"oid": "d00e51b29f4459e3107ef01dc14f814abe462769", "url": "https://github.com/hyperledger/besu/commit/d00e51b29f4459e3107ef01dc14f814abe462769", "message": "Merge branch 'master' into GoQuorumConfiguration", "committedDate": "2020-12-16T05:04:32Z", "type": "commit"}, {"oid": "e0991a894ca200a948340408a6bb4e550a5184e6", "url": "https://github.com/hyperledger/besu/commit/e0991a894ca200a948340408a6bb4e550a5184e6", "message": "add goquorum privacy configuration\n\nSigned-off-by: Stefan Pingel <stefan.pingel@consensys.net>", "committedDate": "2020-12-16T05:15:03Z", "type": "commit"}, {"oid": "4f18e8298275d4f74786d9389d8fdd0e899a5fd9", "url": "https://github.com/hyperledger/besu/commit/4f18e8298275d4f74786d9389d8fdd0e899a5fd9", "message": "add goquorum privacy configuration\n\nSigned-off-by: Stefan Pingel <stefan.pingel@consensys.net>", "committedDate": "2020-12-16T08:23:57Z", "type": "commit"}, {"oid": "3af46d3352b2f11d829f46be646cb02d476625bd", "url": "https://github.com/hyperledger/besu/commit/3af46d3352b2f11d829f46be646cb02d476625bd", "message": "Merge branch 'master' into GoQuorumConfiguration", "committedDate": "2020-12-16T22:36:27Z", "type": "commit"}, {"oid": "35a05300c001f9b1f0e2898213ee4404db710b05", "url": "https://github.com/hyperledger/besu/commit/35a05300c001f9b1f0e2898213ee4404db710b05", "message": "add tests and error message\n\nSigned-off-by: Stefan Pingel <stefan.pingel@consensys.net>", "committedDate": "2020-12-16T23:57:33Z", "type": "commit"}, {"oid": "f7b0d65b12f458aaabc5b22bc392aae6646e35da", "url": "https://github.com/hyperledger/besu/commit/f7b0d65b12f458aaabc5b22bc392aae6646e35da", "message": "Merge branch 'GoQuorumConfiguration' of github.com:pinges/besu into GoQuorumConfiguration", "committedDate": "2020-12-16T23:57:47Z", "type": "commit"}, {"oid": "41ff27eedf2d6318ff090154f227a5904e5615d8", "url": "https://github.com/hyperledger/besu/commit/41ff27eedf2d6318ff090154f227a5904e5615d8", "message": "remove comment\n\nSigned-off-by: Stefan Pingel <stefan.pingel@consensys.net>", "committedDate": "2020-12-16T23:59:56Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDcyMDA5Mg==", "url": "https://github.com/hyperledger/besu/pull/1718#discussion_r544720092", "bodyText": "s/Dile/File", "author": "macfarla", "createdAt": "2020-12-17T00:26:05Z", "path": "besu/src/test/java/org/hyperledger/besu/cli/BesuCommandTest.java", "diffHunk": "@@ -3987,10 +3987,44 @@ public void quorumInteropEnabledSucceedsWithGasPriceSetToZero() throws IOExcepti\n         \"--genesis-file\",\n         genesisFile.toString(),\n         \"--min-gas-price\",\n-        \"0\");\n+        \"0\",\n+        \"--privacy-public-key-file\",\n+        ENCLAVE_PUBLIC_KEY_PATH);\n     assertThat(commandErrorOutput.toString()).isEmpty();\n   }\n \n+  @Test\n+  public void quorumInteropEnabledFailsIfEnclaveKeyFileDoesNotExist() throws IOException {\n+    final Path genesisFile =\n+        createFakeGenesisFile(VALID_GENESIS_QUORUM_INTEROP_ENABLED_WITH_CHAINID);\n+    parseCommand(\n+        \"--goquorum-compatibility-enabled\",\n+        \"--genesis-file\",\n+        genesisFile.toString(),\n+        \"--min-gas-price\",\n+        \"0\",\n+        \"--privacy-public-key-file\",\n+        \"ThisDileDoesNotExist\");", "originalCommit": "41ff27eedf2d6318ff090154f227a5904e5615d8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDc0NzQ0NQ==", "url": "https://github.com/hyperledger/besu/pull/1718#discussion_r544747445", "bodyText": "Done", "author": "pinges", "createdAt": "2020-12-17T01:39:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDcyMDA5Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDcyMDkwOA==", "url": "https://github.com/hyperledger/besu/pull/1718#discussion_r544720908", "bodyText": "this is a no change, right?", "author": "macfarla", "createdAt": "2020-12-17T00:28:11Z", "path": "enclave/src/main/java/org/hyperledger/besu/enclave/EnclaveFactory.java", "diffHunk": "@@ -48,6 +48,22 @@ public Enclave createVertxEnclave(final URI enclaveUri) {\n     return new Enclave(vertxTransmitter);\n   }\n \n+  public Enclave createVertxEnclave(\n+      final URI enclaveUri,\n+      final Path privacyKeyStoreFile,\n+      final Path privacyKeyStorePasswordFile,\n+      final Path privacyAllowlistFile) {\n+\n+    final HttpClientOptions clientOptions =\n+        createTlsClientOptions(\n+            enclaveUri, privacyKeyStoreFile, privacyKeyStorePasswordFile, privacyAllowlistFile);\n+\n+    final RequestTransmitter vertxTransmitter =\n+        new VertxRequestTransmitter(vertx.createHttpClient(clientOptions));\n+\n+    return new Enclave(vertxTransmitter);\n+  }\n+", "originalCommit": "41ff27eedf2d6318ff090154f227a5904e5615d8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDc0NTA3Mg==", "url": "https://github.com/hyperledger/besu/pull/1718#discussion_r544745072", "bodyText": "This has not changed, it might have moved in the file?", "author": "pinges", "createdAt": "2020-12-17T01:33:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDcyMDkwOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDcyMTM4MQ==", "url": "https://github.com/hyperledger/besu/pull/1718#discussion_r544721381", "bodyText": "what happens if privacy-public-key-file isn't specified?", "author": "macfarla", "createdAt": "2020-12-17T00:29:30Z", "path": "besu/src/test/java/org/hyperledger/besu/cli/BesuCommandTest.java", "diffHunk": "@@ -3987,10 +3987,44 @@ public void quorumInteropEnabledSucceedsWithGasPriceSetToZero() throws IOExcepti\n         \"--genesis-file\",\n         genesisFile.toString(),\n         \"--min-gas-price\",\n-        \"0\");\n+        \"0\",\n+        \"--privacy-public-key-file\",\n+        ENCLAVE_PUBLIC_KEY_PATH);", "originalCommit": "41ff27eedf2d6318ff090154f227a5904e5615d8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDc0NDU0Mg==", "url": "https://github.com/hyperledger/besu/pull/1718#discussion_r544744542", "bodyText": "We decided (Madeline and me) that we would enable private Txs when we are compatible with GoQuorum, so we need the enclave key. In the future we might have a flag that disables private Txs ...\nIn short: we fail!", "author": "pinges", "createdAt": "2020-12-17T01:31:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDcyMTM4MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDc0NDU4OA==", "url": "https://github.com/hyperledger/besu/pull/1718#discussion_r544744588", "bodyText": "And why did we need to update a test that has nothing to do privacy?", "author": "lucassaldanha", "createdAt": "2020-12-17T01:31:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDcyMTM4MQ=="}], "type": "inlineReview"}, {"oid": "e63d065397b73227f34d917fc9d681fe855734bc", "url": "https://github.com/hyperledger/besu/commit/e63d065397b73227f34d917fc9d681fe855734bc", "message": "Merge branch 'master' into GoQuorumConfiguration", "committedDate": "2020-12-17T01:31:55Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDc0MzgwMw==", "url": "https://github.com/hyperledger/besu/pull/1718#discussion_r544743803", "bodyText": "NIT: It would be nice to encapsulate all this logic to read the key into its own method. Something like readEnclaveKey or similar.", "author": "lucassaldanha", "createdAt": "2020-12-17T01:29:46Z", "path": "besu/src/main/java/org/hyperledger/besu/cli/BesuCommand.java", "diffHunk": "@@ -1502,10 +1505,46 @@ private BesuCommand configure() throws Exception {\n         .ifPresent(p -> ensureAllNodesAreInAllowlist(staticNodes, p));\n     metricsConfiguration = metricsConfiguration();\n \n+    if (isGoQuorumCompatibilityMode) {\n+      configureGoQuorumPrivacy();\n+    }\n+\n     logger.info(\"Security Module: {}\", securityModuleName);\n     return this;\n   }\n \n+  private void configureGoQuorumPrivacy() {\n+\n+    GoQuorumPrivacyParameters.isEnabled = true;\n+    final EnclaveFactory enclaveFactory = new EnclaveFactory(Vertx.vertx());\n+    if (privacyKeyStoreFile != null) {\n+      GoQuorumPrivacyParameters.goQuorumEnclave =\n+          enclaveFactory.createGoQuorumEnclave(\n+              privacyUrl,\n+              privacyKeyStoreFile,\n+              privacyKeyStorePasswordFile,\n+              privacyTlsKnownEnclaveFile);\n+    } else {\n+      GoQuorumPrivacyParameters.goQuorumEnclave = enclaveFactory.createGoQuorumEnclave(privacyUrl);\n+    }\n+    final String key;\n+    try {\n+      key = Files.asCharSource(privacyPublicKeyFile, UTF_8).read();\n+    } catch (final Exception e) {\n+      throw new ParameterException(\n+          this.commandLine,\n+          \"--privacy-public-key-file must be set when goquorum-compatibility-enabled is set to true.\",\n+          e);\n+    }\n+    if (key.length() != 44) {\n+      throw new IllegalArgumentException(\n+          \"Contents of enclave public key file needs to be 44 characters long to decode to a valid 32 byte public key.\");\n+    }\n+    // throws exception if invalid base 64\n+    Base64.getDecoder().decode(key);", "originalCommit": "41ff27eedf2d6318ff090154f227a5904e5615d8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDc0OTA2NQ==", "url": "https://github.com/hyperledger/besu/pull/1718#discussion_r544749065", "bodyText": "Done", "author": "pinges", "createdAt": "2020-12-17T01:44:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDc0MzgwMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDc0NDIzOQ==", "url": "https://github.com/hyperledger/besu/pull/1718#discussion_r544744239", "bodyText": "NIT: it would be nice to see this logic into its own method. Something like createGoQuorumEnclave or similar.", "author": "lucassaldanha", "createdAt": "2020-12-17T01:31:03Z", "path": "besu/src/main/java/org/hyperledger/besu/cli/BesuCommand.java", "diffHunk": "@@ -1502,10 +1505,46 @@ private BesuCommand configure() throws Exception {\n         .ifPresent(p -> ensureAllNodesAreInAllowlist(staticNodes, p));\n     metricsConfiguration = metricsConfiguration();\n \n+    if (isGoQuorumCompatibilityMode) {\n+      configureGoQuorumPrivacy();\n+    }\n+\n     logger.info(\"Security Module: {}\", securityModuleName);\n     return this;\n   }\n \n+  private void configureGoQuorumPrivacy() {\n+\n+    GoQuorumPrivacyParameters.isEnabled = true;\n+    final EnclaveFactory enclaveFactory = new EnclaveFactory(Vertx.vertx());\n+    if (privacyKeyStoreFile != null) {\n+      GoQuorumPrivacyParameters.goQuorumEnclave =\n+          enclaveFactory.createGoQuorumEnclave(\n+              privacyUrl,\n+              privacyKeyStoreFile,\n+              privacyKeyStorePasswordFile,\n+              privacyTlsKnownEnclaveFile);\n+    } else {\n+      GoQuorumPrivacyParameters.goQuorumEnclave = enclaveFactory.createGoQuorumEnclave(privacyUrl);\n+    }", "originalCommit": "41ff27eedf2d6318ff090154f227a5904e5615d8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDc0NTA2OQ==", "url": "https://github.com/hyperledger/besu/pull/1718#discussion_r544745069", "bodyText": "Inconsistency in using -- before the commands. Either we use the prefix in both or we don't use in either.", "author": "lucassaldanha", "createdAt": "2020-12-17T01:33:24Z", "path": "besu/src/main/java/org/hyperledger/besu/cli/BesuCommand.java", "diffHunk": "@@ -1502,10 +1505,46 @@ private BesuCommand configure() throws Exception {\n         .ifPresent(p -> ensureAllNodesAreInAllowlist(staticNodes, p));\n     metricsConfiguration = metricsConfiguration();\n \n+    if (isGoQuorumCompatibilityMode) {\n+      configureGoQuorumPrivacy();\n+    }\n+\n     logger.info(\"Security Module: {}\", securityModuleName);\n     return this;\n   }\n \n+  private void configureGoQuorumPrivacy() {\n+\n+    GoQuorumPrivacyParameters.isEnabled = true;\n+    final EnclaveFactory enclaveFactory = new EnclaveFactory(Vertx.vertx());\n+    if (privacyKeyStoreFile != null) {\n+      GoQuorumPrivacyParameters.goQuorumEnclave =\n+          enclaveFactory.createGoQuorumEnclave(\n+              privacyUrl,\n+              privacyKeyStoreFile,\n+              privacyKeyStorePasswordFile,\n+              privacyTlsKnownEnclaveFile);\n+    } else {\n+      GoQuorumPrivacyParameters.goQuorumEnclave = enclaveFactory.createGoQuorumEnclave(privacyUrl);\n+    }\n+    final String key;\n+    try {\n+      key = Files.asCharSource(privacyPublicKeyFile, UTF_8).read();\n+    } catch (final Exception e) {\n+      throw new ParameterException(\n+          this.commandLine,\n+          \"--privacy-public-key-file must be set when goquorum-compatibility-enabled is set to true.\",", "originalCommit": "e63d065397b73227f34d917fc9d681fe855734bc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDc1MDUwMg==", "url": "https://github.com/hyperledger/besu/pull/1718#discussion_r544750502", "bodyText": "Done", "author": "pinges", "createdAt": "2020-12-17T01:48:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDc0NTA2OQ=="}], "type": "inlineReview"}, {"oid": "894bf9b8ce2b3343eed8c8d8ebd62aa646462477", "url": "https://github.com/hyperledger/besu/commit/894bf9b8ce2b3343eed8c8d8ebd62aa646462477", "message": "changes after review comments\n\nSigned-off-by: Stefan Pingel <stefan.pingel@consensys.net>", "committedDate": "2020-12-17T01:54:21Z", "type": "commit"}, {"oid": "80ba077dc0817c6cdba30a033b0a83026406ba72", "url": "https://github.com/hyperledger/besu/commit/80ba077dc0817c6cdba30a033b0a83026406ba72", "message": "changes after review comments\n\nSigned-off-by: Stefan Pingel <stefan.pingel@consensys.net>", "committedDate": "2020-12-17T02:42:04Z", "type": "commit"}]}