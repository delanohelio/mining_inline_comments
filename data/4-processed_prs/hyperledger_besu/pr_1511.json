{"pr_number": 1511, "pr_title": "Remove Unnecessary LimitedNewPooledTransactionHashesMessage", "pr_createdAt": "2020-11-02T17:24:26Z", "pr_url": "https://github.com/hyperledger/besu/pull/1511", "timeline": [{"oid": "97d1828843cded121bccd65d9c8ab818f4b50ce0", "url": "https://github.com/hyperledger/besu/commit/97d1828843cded121bccd65d9c8ab818f4b50ce0", "message": "move message size limitation to transaction message sender\n\nSigned-off-by: Ratan Rai Sur <ratan.r.sur@gmail.com>", "committedDate": "2020-11-02T17:15:51Z", "type": "commit"}, {"oid": "338e71750e8c9625656a01caff49cef44c9a5c21", "url": "https://github.com/hyperledger/besu/commit/338e71750e8c9625656a01caff49cef44c9a5c21", "message": "remove test\n\nSigned-off-by: Ratan Rai Sur <ratan.r.sur@gmail.com>", "committedDate": "2020-11-02T17:21:12Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODM4Mjk2MA==", "url": "https://github.com/hyperledger/besu/pull/1511#discussion_r518382960", "bodyText": "I guess this needs to be a constant?", "author": "atoulme", "createdAt": "2020-11-05T21:35:56Z", "path": "ethereum/eth/src/main/java/org/hyperledger/besu/ethereum/eth/transactions/PendingTransactionsMessageSender.java", "diffHunk": "@@ -37,16 +37,17 @@ public void sendTransactionsToPeers() {\n   }\n \n   private void sendTransactionsToPeer(final EthPeer peer) {\n-    final Set<Hash> allTxToSend = transactionTracker.claimTransactionsToSendToPeer(peer);\n-    while (!allTxToSend.isEmpty()) {\n-      final LimitedNewPooledTransactionHashesMessages limitedTransactionsMessages =\n-          LimitedNewPooledTransactionHashesMessages.createLimited(allTxToSend);\n-      allTxToSend.removeAll(limitedTransactionsMessages.getIncludedTransactions());\n-      try {\n-        peer.send(limitedTransactionsMessages.getTransactionsMessage());\n-      } catch (final PeerNotConnected e) {\n-        return;\n-      }\n-    }\n+    Iterables.partition(\n+            transactionTracker.claimTransactionsToSendToPeer(peer),\n+            4096 // implementation determined limit for how many hashes to send at once", "originalCommit": "338e71750e8c9625656a01caff49cef44c9a5c21", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODM4NTA0NQ==", "url": "https://github.com/hyperledger/besu/pull/1511#discussion_r518385045", "bodyText": "the original code would return early if the peer was disconnected.\nDo we want to check if the peer is still connected before sending?", "author": "atoulme", "createdAt": "2020-11-05T21:39:55Z", "path": "ethereum/eth/src/main/java/org/hyperledger/besu/ethereum/eth/transactions/PendingTransactionsMessageSender.java", "diffHunk": "@@ -37,16 +37,17 @@ public void sendTransactionsToPeers() {\n   }\n \n   private void sendTransactionsToPeer(final EthPeer peer) {\n-    final Set<Hash> allTxToSend = transactionTracker.claimTransactionsToSendToPeer(peer);\n-    while (!allTxToSend.isEmpty()) {\n-      final LimitedNewPooledTransactionHashesMessages limitedTransactionsMessages =\n-          LimitedNewPooledTransactionHashesMessages.createLimited(allTxToSend);\n-      allTxToSend.removeAll(limitedTransactionsMessages.getIncludedTransactions());\n-      try {\n-        peer.send(limitedTransactionsMessages.getTransactionsMessage());\n-      } catch (final PeerNotConnected e) {\n-        return;\n-      }\n-    }\n+    Iterables.partition(\n+            transactionTracker.claimTransactionsToSendToPeer(peer),\n+            4096 // implementation determined limit for how many hashes to send at once\n+            )\n+        .forEach(\n+            hashes -> {\n+              try {\n+                peer.send(NewPooledTransactionHashesMessage.create(hashes));\n+              } catch (final PeerNotConnected __) {\n+                // if the peer isn't connected anymore, don't do anything", "originalCommit": "338e71750e8c9625656a01caff49cef44c9a5c21", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "90703303fe87b9c629100df792d9564a239d99a5", "url": "https://github.com/hyperledger/besu/commit/90703303fe87b9c629100df792d9564a239d99a5", "message": "early exit\n\nSigned-off-by: Ratan Rai Sur <ratan.r.sur@gmail.com>", "committedDate": "2020-11-09T14:22:51Z", "type": "commit"}, {"oid": "d762eedb66cb137d4857eb2d9f21a82e1176a60c", "url": "https://github.com/hyperledger/besu/commit/d762eedb66cb137d4857eb2d9f21a82e1176a60c", "message": "use constant\n\nSigned-off-by: Ratan Rai Sur <ratan.r.sur@gmail.com>", "committedDate": "2020-11-09T14:25:08Z", "type": "commit"}, {"oid": "532d1ec759686588edb4efd3d8d1e30493a4ea70", "url": "https://github.com/hyperledger/besu/commit/532d1ec759686588edb4efd3d8d1e30493a4ea70", "message": "Merge branch 'master' into remove-limited-class", "committedDate": "2020-11-10T01:51:29Z", "type": "commit"}]}