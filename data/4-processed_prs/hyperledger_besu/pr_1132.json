{"pr_number": 1132, "pr_title": "Added configurable block reward and recipient for IBFT2", "pr_createdAt": "2020-06-22T23:16:32Z", "pr_url": "https://github.com/hyperledger/besu/pull/1132", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzg4NTE2MA==", "url": "https://github.com/hyperledger/besu/pull/1132#discussion_r443885160", "bodyText": "nit: getBlocKReward/getBlockReward", "author": "jframe", "createdAt": "2020-06-22T23:51:12Z", "path": "consensus/ibft/src/main/java/org/hyperledger/besu/consensus/ibft/IbftProtocolSchedule.java", "diffHunk": "@@ -60,16 +59,24 @@ public static ProtocolSchedule create(final GenesisConfigOptions config) {\n   }\n \n   private static ProtocolSpecBuilder applyIbftChanges(\n-      final long secondsBetweenBlocks, final ProtocolSpecBuilder builder) {\n-    return builder\n-        .blockHeaderValidatorBuilder(ibftBlockHeaderValidator(secondsBetweenBlocks))\n-        .ommerHeaderValidatorBuilder(ibftBlockHeaderValidator(secondsBetweenBlocks))\n+      final IbftConfigOptions ibftConfig, final ProtocolSpecBuilder builder) {\n+\n+    builder\n+        .blockHeaderValidatorBuilder(ibftBlockHeaderValidator(ibftConfig.getBlockPeriodSeconds()))\n+        .ommerHeaderValidatorBuilder(ibftBlockHeaderValidator(ibftConfig.getBlockPeriodSeconds()))\n         .blockBodyValidatorBuilder(MainnetBlockBodyValidator::new)\n         .blockValidatorBuilder(MainnetBlockValidator::new)\n         .blockImporterBuilder(MainnetBlockImporter::new)\n         .difficultyCalculator((time, parent, protocolContext) -> BigInteger.ONE)\n-        .blockReward(Wei.ZERO)\n+        .blockReward(Wei.of(ibftConfig.getBlocKReward()))", "originalCommit": "8fbe58db9448409985a97bb63252cc51df1d774f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDY0MTc5Ng==", "url": "https://github.com/hyperledger/besu/pull/1132#discussion_r444641796", "bodyText": "done", "author": "rain-on", "createdAt": "2020-06-24T04:47:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzg4NTE2MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzg4NjEwMg==", "url": "https://github.com/hyperledger/besu/pull/1132#discussion_r443886102", "bodyText": "Should the block reward be specified as a hex value in the config?", "author": "jframe", "createdAt": "2020-06-22T23:54:44Z", "path": "consensus/ibft/src/main/java/org/hyperledger/besu/consensus/ibft/IbftProtocolSchedule.java", "diffHunk": "@@ -60,16 +59,24 @@ public static ProtocolSchedule create(final GenesisConfigOptions config) {\n   }\n \n   private static ProtocolSpecBuilder applyIbftChanges(\n-      final long secondsBetweenBlocks, final ProtocolSpecBuilder builder) {\n-    return builder\n-        .blockHeaderValidatorBuilder(ibftBlockHeaderValidator(secondsBetweenBlocks))\n-        .ommerHeaderValidatorBuilder(ibftBlockHeaderValidator(secondsBetweenBlocks))\n+      final IbftConfigOptions ibftConfig, final ProtocolSpecBuilder builder) {\n+\n+    builder\n+        .blockHeaderValidatorBuilder(ibftBlockHeaderValidator(ibftConfig.getBlockPeriodSeconds()))\n+        .ommerHeaderValidatorBuilder(ibftBlockHeaderValidator(ibftConfig.getBlockPeriodSeconds()))\n         .blockBodyValidatorBuilder(MainnetBlockBodyValidator::new)\n         .blockValidatorBuilder(MainnetBlockValidator::new)\n         .blockImporterBuilder(MainnetBlockImporter::new)\n         .difficultyCalculator((time, parent, protocolContext) -> BigInteger.ONE)\n-        .blockReward(Wei.ZERO)\n+        .blockReward(Wei.of(ibftConfig.getBlocKReward()))", "originalCommit": "8fbe58db9448409985a97bb63252cc51df1d774f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDY0MjM4MA==", "url": "https://github.com/hyperledger/besu/pull/1132#discussion_r444642380", "bodyText": "Not sure - all other numbers in this section are decimal ... so tempted to stick with that? There doesn't seem to be much of a definitive approach...", "author": "rain-on", "createdAt": "2020-06-24T04:50:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzg4NjEwMg=="}], "type": "inlineReview"}, {"oid": "5770d7a750fa05414478a6a3171778d732b20d6c", "url": "https://github.com/hyperledger/besu/commit/5770d7a750fa05414478a6a3171778d732b20d6c", "message": "Added configurable block reward and recipient for IBFT2\n\nSigned-off-by: Trent Mohay <trent.mohay@consensys.net>", "committedDate": "2020-06-24T00:53:55Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDY0NTY1Mg==", "url": "https://github.com/hyperledger/besu/pull/1132#discussion_r444645652", "bodyText": "Do we need a test with multiple validators receiving a fixed reward? Though that get complicated so might not be worth it.", "author": "jframe", "createdAt": "2020-06-24T05:03:21Z", "path": "acceptance-tests/tests/src/test/java/org/hyperledger/besu/tests/acceptance/ibft2/Ibft2BlockRewardPaymentAcceptanceTest.java", "diffHunk": "@@ -0,0 +1,83 @@\n+/*\n+ * Copyright ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ *\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+package org.hyperledger.besu.tests.acceptance.ibft2;\n+\n+import static java.util.Collections.singletonList;\n+\n+import org.hyperledger.besu.ethereum.core.Address;\n+import org.hyperledger.besu.tests.acceptance.dsl.AcceptanceTestBase;\n+import org.hyperledger.besu.tests.acceptance.dsl.account.Account;\n+import org.hyperledger.besu.tests.acceptance.dsl.blockchain.Amount;\n+import org.hyperledger.besu.tests.acceptance.dsl.node.BesuNode;\n+\n+import java.io.IOException;\n+import java.math.BigInteger;\n+import java.util.Optional;\n+\n+import org.junit.Test;\n+\n+public class Ibft2BlockRewardPaymentAcceptanceTest extends AcceptanceTestBase {\n+\n+  @Test\n+  public void validatorsArePaidBlockReward() throws IOException {", "originalCommit": "8c462698450381ff2d9f7c36e237e327a9fd4262", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDY3NjIxMg==", "url": "https://github.com/hyperledger/besu/pull/1132#discussion_r444676212", "bodyText": "Yeah, it got scary when you start saying \"how do you know\"? I.e. it depends on rounds, and blocks...\nmaybe you just wait until 2 validators have been paid (something ... anything) - no API exists in the DSL to do that, but sure we can make it work", "author": "rain-on", "createdAt": "2020-06-24T06:39:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDY0NTY1Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDY0Njk1Mg==", "url": "https://github.com/hyperledger/besu/pull/1132#discussion_r444646952", "bodyText": "Don't think this need eth as a suffix, no other fields do that. Should be clear enough that it's eth.", "author": "jframe", "createdAt": "2020-06-24T05:08:07Z", "path": "config/src/main/java/org/hyperledger/besu/config/IbftConfigOptions.java", "diffHunk": "@@ -75,6 +77,14 @@ public int getFutureMessagesMaxDistance() {\n         ibftConfigRoot, \"futuremessagesmaxdistance\", DEFAULT_FUTURE_MESSAGES_MAX_DISTANCE);\n   }\n \n+  public Optional<String> getMiningBeneficiary() {\n+    return JsonUtil.getString(ibftConfigRoot, \"miningbeneficiary\");\n+  }\n+\n+  public long getBlockRewardEth() {\n+    return JsonUtil.getLong(ibftConfigRoot, \"blockrewardeth\", DEFAULT_IBFT_BLOCK_REWARD_ETH);", "originalCommit": "8c462698450381ff2d9f7c36e237e327a9fd4262", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDY3NjU3NA==", "url": "https://github.com/hyperledger/besu/pull/1132#discussion_r444676574", "bodyText": "done", "author": "rain-on", "createdAt": "2020-06-24T06:40:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDY0Njk1Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDY0ODM1Mw==", "url": "https://github.com/hyperledger/besu/pull/1132#discussion_r444648353", "bodyText": "Rather the default was left as 0 as what most people will use and just modify the blockreward for the block reward AT", "author": "jframe", "createdAt": "2020-06-24T05:13:26Z", "path": "acceptance-tests/tests/src/test/resources/ibft/ibft.json", "diffHunk": "@@ -10,7 +10,8 @@\n     \"ibft2\": {\n       \"blockperiodseconds\": 1,\n       \"epochlength\": 30000,\n-      \"requesttimeoutseconds\": 5\n+      \"requesttimeoutseconds\": 5,\n+      \"blockrewardeth\": 5", "originalCommit": "8c462698450381ff2d9f7c36e237e327a9fd4262", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDY3NzQ2Nw==", "url": "https://github.com/hyperledger/besu/pull/1132#discussion_r444677467", "bodyText": "Yeah agreed - but it's REALLY hard to do - given no existing tests prove that the validator's not paid, I figured this was ok?", "author": "rain-on", "createdAt": "2020-06-24T06:42:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDY0ODM1Mw=="}], "type": "inlineReview"}, {"oid": "b5d6c551cf3874de1bd7f19f576020f6d8344ca9", "url": "https://github.com/hyperledger/besu/commit/b5d6c551cf3874de1bd7f19f576020f6d8344ca9", "message": "Rebuild PR\n\nSigned-off-by: Trent Mohay <trent.mohay@consensys.net>", "committedDate": "2020-06-25T03:30:55Z", "type": "forcePushed"}, {"oid": "0a37329870c7694d619a6f5a42c3fa599c52f86e", "url": "https://github.com/hyperledger/besu/commit/0a37329870c7694d619a6f5a42c3fa599c52f86e", "message": "Rebuild PR\n\nSigned-off-by: Trent Mohay <trent.mohay@consensys.net>", "committedDate": "2020-06-25T03:40:00Z", "type": "commit"}, {"oid": "0a37329870c7694d619a6f5a42c3fa599c52f86e", "url": "https://github.com/hyperledger/besu/commit/0a37329870c7694d619a6f5a42c3fa599c52f86e", "message": "Rebuild PR\n\nSigned-off-by: Trent Mohay <trent.mohay@consensys.net>", "committedDate": "2020-06-25T03:40:00Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTI5NjYzNQ==", "url": "https://github.com/hyperledger/besu/pull/1132#discussion_r445296635", "bodyText": "Can you also add a test for block rewards with a decimal number", "author": "jframe", "createdAt": "2020-06-25T04:13:41Z", "path": "config/src/test/java/org/hyperledger/besu/config/JsonGenesisConfigOptionsTest.java", "diffHunk": "@@ -116,4 +116,40 @@ public void configWithAnIbftWithNoValidatorsListedIsValid() {\n     assertThat(configOptions.getTransitions().getIbftForks().get(1).getValidators().get().size())\n         .isEqualTo(1);\n   }\n+\n+  @Test\n+  public void configWithValidIbftBlockRewardIsParsable() {", "originalCommit": "0a37329870c7694d619a6f5a42c3fa599c52f86e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTMwNDg4NQ==", "url": "https://github.com/hyperledger/besu/pull/1132#discussion_r445304885", "bodyText": "yeah sure.", "author": "rain-on", "createdAt": "2020-06-25T04:49:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTI5NjYzNQ=="}], "type": "inlineReview"}, {"oid": "c685c1c7cef4de174c85cdbd6349be836e9e1871", "url": "https://github.com/hyperledger/besu/commit/c685c1c7cef4de174c85cdbd6349be836e9e1871", "message": "Add decimal test\n\nSigned-off-by: Trent Mohay <trent.mohay@consensys.net>", "committedDate": "2020-06-25T04:49:49Z", "type": "commit"}]}