{"pr_number": 1156, "pr_title": "Add cluster ip for Kubernetes Nat Manager", "pr_createdAt": "2020-06-26T14:35:15Z", "pr_url": "https://github.com/hyperledger/besu/pull/1156", "timeline": [{"oid": "0de3ebeb40bfe45e0804bbb5d659bdc7c7dab430", "url": "https://github.com/hyperledger/besu/commit/0de3ebeb40bfe45e0804bbb5d659bdc7c7dab430", "message": "add cluster ip for nat manager\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>", "committedDate": "2020-06-26T14:08:06Z", "type": "commit"}, {"oid": "53387c169c72b5ffb2b545cebbf971b4376a8320", "url": "https://github.com/hyperledger/besu/commit/53387c169c72b5ffb2b545cebbf971b4376a8320", "message": "Merge branch 'upstream/master' into feature/cluster-ip-for-nat-manager\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>", "committedDate": "2020-06-26T14:43:43Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjI4MzU3MQ==", "url": "https://github.com/hyperledger/besu/pull/1156#discussion_r446283571", "bodyText": "Don't use String.format, use standard logging placeholder instead.", "author": "abdelhamidbakhta", "createdAt": "2020-06-26T16:23:13Z", "path": "nat/src/main/java/org/hyperledger/besu/nat/NatService.java", "diffHunk": "@@ -88,10 +96,14 @@ public void start() {\n         getNatManager().orElseThrow().start();\n       } catch (Exception e) {\n         LOG.debug(\n-            \"Nat manager failed to configure itself automatically due to the following reason \"\n-                + e.getMessage()\n-                + \". NONE mode will be used\");\n-        disableNatManager();\n+            String.format(", "originalCommit": "53387c169c72b5ffb2b545cebbf971b4376a8320", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjI5MzQ3OA==", "url": "https://github.com/hyperledger/besu/pull/1156#discussion_r446293478", "bodyText": "Done", "author": "matkt", "createdAt": "2020-06-26T16:42:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjI4MzU3MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjI4NTEzNg==", "url": "https://github.com/hyperledger/besu/pull/1156#discussion_r446285136", "bodyText": "Not worth creating a class for such a simple implementation IMO. You can inject the code as a lambda directly.", "author": "abdelhamidbakhta", "createdAt": "2020-06-26T16:26:16Z", "path": "nat/src/main/java/org/hyperledger/besu/nat/kubernetes/service/ClusterIpBasedDetector.java", "diffHunk": "@@ -0,0 +1,35 @@\n+/*\n+ * Copyright ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ *\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+package org.hyperledger.besu.nat.kubernetes.service;\n+\n+import org.hyperledger.besu.nat.core.IpDetector;\n+\n+import java.util.Optional;\n+\n+import io.kubernetes.client.models.V1Service;\n+\n+public class ClusterIpBasedDetector implements IpDetector {", "originalCommit": "53387c169c72b5ffb2b545cebbf971b4376a8320", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjI5Mzg0OA==", "url": "https://github.com/hyperledger/besu/pull/1156#discussion_r446293848", "bodyText": "Good catch", "author": "matkt", "createdAt": "2020-06-26T16:43:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjI4NTEzNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjI4NTMxNQ==", "url": "https://github.com/hyperledger/besu/pull/1156#discussion_r446285315", "bodyText": "Return a lambda instead IMO", "author": "abdelhamidbakhta", "createdAt": "2020-06-26T16:26:35Z", "path": "nat/src/main/java/org/hyperledger/besu/nat/kubernetes/KubernetesNatManager.java", "diffHunk": "@@ -152,4 +144,16 @@ protected void doStop() {\n   public CompletableFuture<List<NatPortMapping>> getPortMappings() {\n     return CompletableFuture.completedFuture(forwardedPorts);\n   }\n+\n+  private IpDetector getIpDetector(final V1Service v1Service) throws NatInitializationException {\n+    final String serviceType = v1Service.getSpec().getType();\n+    switch (KubernetesServiceType.fromName(serviceType)) {\n+      case CLUSTER_IP:\n+        return new ClusterIpBasedDetector(v1Service);", "originalCommit": "53387c169c72b5ffb2b545cebbf971b4376a8320", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjI5Mzg5OQ==", "url": "https://github.com/hyperledger/besu/pull/1156#discussion_r446293899", "bodyText": "Done", "author": "matkt", "createdAt": "2020-06-26T16:43:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjI4NTMxNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjI4NjY1Mw==", "url": "https://github.com/hyperledger/besu/pull/1156#discussion_r446286653", "bodyText": "Use assertThatThrownBy instead.\nExample here: \n  \n    \n      besu/besu/src/test/java/org/hyperledger/besu/chainexport/RlpBlockExporterTest.java\n    \n    \n         Line 213\n      in\n      71f2872\n    \n    \n    \n    \n\n        \n          \n           assertThatThrownBy(() -> exporter.exportBlocks(outputPath, Optional.of(-1L), Optional.empty()))", "author": "abdelhamidbakhta", "createdAt": "2020-06-26T16:29:17Z", "path": "nat/src/test/java/org/hyperledger/besu/nat/NatServiceTest.java", "diffHunk": "@@ -197,6 +197,24 @@ public void assertThatManagerSwitchToNoneForInvalidNatEnvironment()\n     assertThat(natService.queryLocalIPAddress(fallbackLocalIp)).isEqualTo(fallbackLocalIp);\n   }\n \n+  @Test(expected = RuntimeException.class)", "originalCommit": "53387c169c72b5ffb2b545cebbf971b4376a8320", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjI5NTI3Ng==", "url": "https://github.com/hyperledger/besu/pull/1156#discussion_r446295276", "bodyText": "Updated", "author": "matkt", "createdAt": "2020-06-26T16:45:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjI4NjY1Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjI4NjgwOA==", "url": "https://github.com/hyperledger/besu/pull/1156#discussion_r446286808", "bodyText": "final ?", "author": "abdelhamidbakhta", "createdAt": "2020-06-26T16:29:34Z", "path": "nat/src/test/java/org/hyperledger/besu/nat/docker/DockerNatManagerTest.java", "diffHunk": "@@ -61,7 +63,14 @@ public void assertThatExternalIPIsEqualToRemoteHost()\n   @Test\n   public void assertThatExternalIPIsEqualToDefaultHostIfIpDetectorCannotRetrieveIP()\n       throws ExecutionException, InterruptedException {\n-    when(hostBasedIpDetector.detectExternalIp()).thenReturn(Optional.empty());\n+    NatManager natManager =", "originalCommit": "53387c169c72b5ffb2b545cebbf971b4376a8320", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjI5NTU3NQ==", "url": "https://github.com/hyperledger/besu/pull/1156#discussion_r446295575", "bodyText": "You right . Done", "author": "matkt", "createdAt": "2020-06-26T16:46:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjI4NjgwOA=="}], "type": "inlineReview"}, {"oid": "02a9b1bc1c548f2c2ecac3ba2649f9c8c79b0a34", "url": "https://github.com/hyperledger/besu/commit/02a9b1bc1c548f2c2ecac3ba2649f9c8c79b0a34", "message": "fix review issues\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>", "committedDate": "2020-06-26T16:45:02Z", "type": "commit"}, {"oid": "1db8b0a94737fb99c71d5459d297d9e92af0e4f4", "url": "https://github.com/hyperledger/besu/commit/1db8b0a94737fb99c71d5459d297d9e92af0e4f4", "message": "Merge branch 'upstream/master' into feature/cluster-ip-for-nat-manager\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>", "committedDate": "2020-06-29T08:10:04Z", "type": "commit"}, {"oid": "90eecea52f2920181a280908f0f877dddce55cf5", "url": "https://github.com/hyperledger/besu/commit/90eecea52f2920181a280908f0f877dddce55cf5", "message": "change Xnat-kube-pod-name to Xnat-kube-service-name\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>", "committedDate": "2020-07-01T12:16:26Z", "type": "commit"}, {"oid": "3e9e56b8bd8c2fe53f3b41113f16d04d1964a03d", "url": "https://github.com/hyperledger/besu/commit/3e9e56b8bd8c2fe53f3b41113f16d04d1964a03d", "message": "Merge commit 'master' into feature/cluster-ip-for-nat-manager\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>", "committedDate": "2020-07-01T12:19:05Z", "type": "commit"}, {"oid": "2fb0de10d0b6fe2181edb35ed2f4f40e51c0ede5", "url": "https://github.com/hyperledger/besu/commit/2fb0de10d0b6fe2181edb35ed2f4f40e51c0ede5", "message": "fix test\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>", "committedDate": "2020-07-01T12:41:58Z", "type": "commit"}, {"oid": "8a60dae78dd54db69b275e16f6f1dfdcf05bcd47", "url": "https://github.com/hyperledger/besu/commit/8a60dae78dd54db69b275e16f6f1dfdcf05bcd47", "message": "add flag for the nat method fallback mechanism\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>", "committedDate": "2020-07-01T15:53:34Z", "type": "commit"}, {"oid": "4322991a482792ad54f402080b1c4ba2b4d4010d", "url": "https://github.com/hyperledger/besu/commit/4322991a482792ad54f402080b1c4ba2b4d4010d", "message": "fix typo\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>", "committedDate": "2020-07-01T16:46:49Z", "type": "commit"}]}