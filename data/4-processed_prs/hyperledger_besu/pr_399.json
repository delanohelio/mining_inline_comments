{"pr_number": 399, "pr_title": "Improving Acceptance Test logging", "pr_createdAt": "2020-02-13T07:12:06Z", "pr_url": "https://github.com/hyperledger/besu/pull/399", "timeline": [{"oid": "387ffbf1b7f6e343817391e2a49522569c368b4b", "url": "https://github.com/hyperledger/besu/commit/387ffbf1b7f6e343817391e2a49522569c368b4b", "message": "Improve logging for Acceptance Tests\n\nAdd test and process origin information to each log line\nRoute the logs to per-test files\nAdd detail to the logs\nLog on error corner cases\n\nSigned-off-by: Horacio Mijail Anton Quiles <hmijail@gmail.com>", "committedDate": "2020-02-13T07:02:24Z", "type": "commit"}, {"oid": "7ae3b4272f53e502813527daab3587ba5b2369f1", "url": "https://github.com/hyperledger/besu/commit/7ae3b4272f53e502813527daab3587ba5b2369f1", "message": "Spotless, minor merge conflicts\n\nSigned-off-by: Horacio Mijail Anton Quiles <hmijail@gmail.com>", "committedDate": "2020-02-13T07:02:24Z", "type": "commit"}, {"oid": "bccb75c7ed0130e25c4311e4224099d37dbb8529", "url": "https://github.com/hyperledger/besu/commit/bccb75c7ed0130e25c4311e4224099d37dbb8529", "message": "Delete logs of successful tests\n\nConfigurable, delete by default\n\nSigned-off-by: Horacio Mijail Anton Quiles <hmijail@gmail.com>", "committedDate": "2020-02-13T07:02:24Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTE3NzU1Ng==", "url": "https://github.com/hyperledger/besu/pull/399#discussion_r379177556", "bodyText": "Is there any reason not to have the static modifier for the logger?\n(that would be in keeping with the reference being uppercase)", "author": "CjHare", "createdAt": "2020-02-13T23:32:01Z", "path": "acceptance-tests/dsl/src/main/java/org/hyperledger/besu/tests/acceptance/dsl/AcceptanceTestBase.java", "diffHunk": "@@ -41,9 +41,19 @@\n import org.hyperledger.besu.tests.acceptance.dsl.transaction.privacy.PrivacyTransactions;\n import org.hyperledger.besu.tests.acceptance.dsl.transaction.web3.Web3Transactions;\n \n+import java.io.File;\n+\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.apache.logging.log4j.ThreadContext;\n import org.junit.After;\n+import org.junit.Rule;\n+import org.junit.rules.TestName;\n+import org.junit.rules.TestWatcher;\n+import org.junit.runner.Description;\n \n public class AcceptanceTestBase {\n+  protected final Logger LOG = LogManager.getLogger();", "originalCommit": "bccb75c7ed0130e25c4311e4224099d37dbb8529", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDQ0NjUyNg==", "url": "https://github.com/hyperledger/besu/pull/399#discussion_r380446526", "bodyText": "Discussed and done.", "author": "hmijail", "createdAt": "2020-02-18T04:09:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTE3NzU1Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTE3ODQ0Mw==", "url": "https://github.com/hyperledger/besu/pull/399#discussion_r379178443", "bodyText": "You could put the error string into a local String variable and use Log4j lazy variable substitution.\ne.g.\nfinal String errorMessage = \" \"Uncaught exception in thread \\\"{}\\\"\";", "author": "CjHare", "createdAt": "2020-02-13T23:34:27Z", "path": "acceptance-tests/dsl/src/main/java/org/hyperledger/besu/tests/acceptance/dsl/AcceptanceTestBase.java", "diffHunk": "@@ -98,6 +108,55 @@ protected AcceptanceTestBase() {\n     permissionedNodeBuilder = new PermissionedNodeBuilder();\n   }\n \n+  static {\n+    System.setProperty(\"log4j2.isThreadContextMapInheritable\", \"true\");\n+  }\n+\n+  @Rule public final TestName name = new TestName();\n+\n+  @Rule\n+  public TestWatcher log_eraser =\n+      new TestWatcher() {\n+\n+        @Override\n+        protected void starting(final Description description) {\n+          ThreadContext.put(\"test\", description.getMethodName());\n+          ThreadContext.put(\"class\", description.getClassName());\n+          Thread.currentThread()", "originalCommit": "bccb75c7ed0130e25c4311e4224099d37dbb8529", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDQ0NjU2NA==", "url": "https://github.com/hyperledger/besu/pull/399#discussion_r380446564", "bodyText": "Discussed and done.", "author": "hmijail", "createdAt": "2020-02-18T04:09:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTE3ODQ0Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTE3ODk4MQ==", "url": "https://github.com/hyperledger/besu/pull/399#discussion_r379178981", "bodyText": "acctests.keepLogs seems misleading as a variable, as it only applies to successful test executions, not the failed ones?", "author": "CjHare", "createdAt": "2020-02-13T23:35:59Z", "path": "acceptance-tests/dsl/src/main/java/org/hyperledger/besu/tests/acceptance/dsl/AcceptanceTestBase.java", "diffHunk": "@@ -98,6 +108,55 @@ protected AcceptanceTestBase() {\n     permissionedNodeBuilder = new PermissionedNodeBuilder();\n   }\n \n+  static {\n+    System.setProperty(\"log4j2.isThreadContextMapInheritable\", \"true\");\n+  }\n+\n+  @Rule public final TestName name = new TestName();\n+\n+  @Rule\n+  public TestWatcher log_eraser =\n+      new TestWatcher() {\n+\n+        @Override\n+        protected void starting(final Description description) {\n+          ThreadContext.put(\"test\", description.getMethodName());\n+          ThreadContext.put(\"class\", description.getClassName());\n+          Thread.currentThread()\n+              .setUncaughtExceptionHandler(\n+                  (thread, error) ->\n+                      LOG.error(\n+                          \"Uncaught exception in thread \\\"\" + thread.getName() + \"\\\"\", error));\n+          Thread.setDefaultUncaughtExceptionHandler(\n+              (thread, error) ->\n+                  LOG.error(\"Uncaught exception in thread \\\"\" + thread.getName() + \"\\\"\", error));\n+        }\n+\n+        @Override\n+        protected void failed(final Throwable e, final Description description) {\n+          // add the result at the end of the log so it is self-sufficient\n+          LOG.error(\n+              \"==========================================================================================\");\n+          LOG.error(\"Test failed. Reported Throwable at the point of failure:\", e);\n+        }\n+\n+        @Override\n+        protected void succeeded(final Description description) {\n+          // if so configured, delete logs of successful tests\n+          if (!Boolean.getBoolean(\"acctests.keepLogs\")) {", "originalCommit": "bccb75c7ed0130e25c4311e4224099d37dbb8529", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDQ0Njc0OQ==", "url": "https://github.com/hyperledger/besu/pull/399#discussion_r380446749", "bodyText": "Would acctests.keepAllLogs be better?", "author": "hmijail", "createdAt": "2020-02-18T04:10:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTE3ODk4MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTYyNzYxNw==", "url": "https://github.com/hyperledger/besu/pull/399#discussion_r381627617", "bodyText": "Wouldn't something like acctests.discardlLogs make sense, then you could remove the logical inversion?", "author": "CjHare", "createdAt": "2020-02-20T00:36:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTE3ODk4MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTY4NTA5Mw==", "url": "https://github.com/hyperledger/besu/pull/399#discussion_r381685093", "bodyText": "The default behavior as currently coded is to keep logs of failing tests and delete logs of successful tests.\nThe intended behavior of this variable is to keep all test logs, both failing and successful.\nPlease suggest a default behavior and which modifier to use :)", "author": "hmijail", "createdAt": "2020-02-20T02:37:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTE3ODk4MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjQwMDk5NA==", "url": "https://github.com/hyperledger/besu/pull/399#discussion_r382400994", "bodyText": "If failed test logs are kept either way, then is it correct to say that this variable is only about keeping logs for successful / passing tests?\nIf so, then a name like accosts.keepLogsOfPassingTests?", "author": "CjHare", "createdAt": "2020-02-21T05:14:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTE3ODk4MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjkzMzE5MA==", "url": "https://github.com/hyperledger/besu/pull/399#discussion_r382933190", "bodyText": "Sounds good, done.", "author": "hmijail", "createdAt": "2020-02-22T18:52:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTE3ODk4MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTE3OTg3Mw==", "url": "https://github.com/hyperledger/besu/pull/399#discussion_r379179873", "bodyText": "Aren't you loosing the name of the node here (that name being assigned by the test being executed)?", "author": "CjHare", "createdAt": "2020-02-13T23:38:52Z", "path": "acceptance-tests/dsl/src/main/java/org/hyperledger/besu/tests/acceptance/dsl/node/ProcessBesuNodeRunner.java", "diffHunk": "@@ -298,11 +310,16 @@ private void printOutput(final BesuNode node, final Process process) {\n         new BufferedReader(new InputStreamReader(process.getInputStream(), UTF_8))) {\n       String line = in.readLine();\n       while (line != null) {\n-        PROCESS_LOG.info(\"{}: {}\", node.getName(), line);\n+        // would be nice to pass up the log level of the incoming log line\n+        PROCESS_LOG.info(line);", "originalCommit": "bccb75c7ed0130e25c4311e4224099d37dbb8529", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDYxNzU0NQ==", "url": "https://github.com/hyperledger/besu/pull/399#discussion_r380617545", "bodyText": "Yes, it is removed here and instead added in log4j2.xml from the ThreadContext.", "author": "hmijail", "createdAt": "2020-02-18T11:35:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTE3OTg3Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTYyNzY4Mg==", "url": "https://github.com/hyperledger/besu/pull/399#discussion_r381627682", "bodyText": "fair enough", "author": "CjHare", "createdAt": "2020-02-20T00:36:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTE3OTg3Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTE4MDIzMQ==", "url": "https://github.com/hyperledger/besu/pull/399#discussion_r379180231", "bodyText": "Does this also change the logging levels of the third party dependencies e.g Vertx?", "author": "CjHare", "createdAt": "2020-02-13T23:39:47Z", "path": "acceptance-tests/dsl/src/main/java/org/hyperledger/besu/tests/acceptance/dsl/node/ThreadBesuNodeRunner.java", "diffHunk": "@@ -197,9 +205,15 @@ public void startNode(final BesuNode node) {\n             .besuPluginContext(new BesuPluginContextImpl())\n             .build();\n \n+    // in testing, we don't mind logging on success, but we want max info on failures\n+    // log level is normally set in BesuCommand, which is bypassed here. So let's just set it.\n+    // This still leaves out the vertx system properties set in Besu.main().\n+    Configurator.setAllLevels(\"\", Level.DEBUG);", "originalCommit": "bccb75c7ed0130e25c4311e4224099d37dbb8529", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTE5MjI1NQ==", "url": "https://github.com/hyperledger/besu/pull/399#discussion_r379192255", "bodyText": "This overrides all log4j configuration, including any config files the user has setup.  If we want to enable debug logging we should just change the log4j2.xml file used by acceptance tests.  Then users running locally could still use system properties to use a custom config and use settings they prefer.", "author": "ajsutton", "createdAt": "2020-02-14T00:21:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTE4MDIzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDYxODg4MQ==", "url": "https://github.com/hyperledger/besu/pull/399#discussion_r380618881", "bodyText": "This is just what BesuCommand.configureLogging() does too. The purpose is to enable DEBUG logging, and since the ThreadBesuNodeRunner bypasses BesuCommand, I couldn't find other simple way to do this.\nAnyway, my understanding is that ThreadBesuNodeRunner is rather on its way out, and in sidechains-besu we indeed no longer use it. So I will just remove this change.", "author": "hmijail", "createdAt": "2020-02-18T11:38:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTE4MDIzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDkwNzA1MA==", "url": "https://github.com/hyperledger/besu/pull/399#discussion_r380907050", "bodyText": "BesuCommand.configureLogging does that only when the user has specifically set a log level on the command line (ie the user has requested the change).  It was deliberately changed to not set a default level so it doesn't override any external log4j config files.\nThreadBesuNodeRunner makes it much easier to test changes to production code - without it you need to run gradle installDist after every change. With it you can just rerun the test in IntelliJ. I haven't heard of plans to remove it and thought it was in use by a number of people to make development faster.", "author": "ajsutton", "createdAt": "2020-02-18T20:07:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTE4MDIzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTEyNTIxNg==", "url": "https://github.com/hyperledger/besu/pull/399#discussion_r381125216", "bodyText": "FWIW, gradle acceptanceTest seems to imply installDist anyway.", "author": "hmijail", "createdAt": "2020-02-19T07:54:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTE4MDIzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTU4MTQzMw==", "url": "https://github.com/hyperledger/besu/pull/399#discussion_r381581433", "bodyText": "Yes, because running in gradle will use the process runner.  The threaded runner is designed to make it easy to run in IntelliJ where installDist is not automatically run.", "author": "ajsutton", "createdAt": "2020-02-19T22:24:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTE4MDIzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTYyODg1Mg==", "url": "https://github.com/hyperledger/besu/pull/399#discussion_r381628852", "bodyText": "ThreadBesuNodeRunner also allows easy IDE step through Besu source during execution of the AT.\nPlans to delete the thread runner from Besu are also news to me, is this from a RocketChat thread I missed?", "author": "CjHare", "createdAt": "2020-02-20T00:40:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTE4MDIzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTY4MzA4Ng==", "url": "https://github.com/hyperledger/besu/pull/399#discussion_r381683086", "bodyText": "What I meant is that if IntelliJ is set to use its gradle runner integration (which I think is the default), then both gradle and IntelliJ work as expected, no matter if using the threaded runner or the process runner. Meaning that installDist should not be needed in any case, as far as I can see.\nRe: plans to delete: I didn't say \"delete\", but maybe I still worded that too strongly? My understanding from when we talked was that the threaded runner might change the behavior or the node, and so it's better to use the process runner - meaning that the default advice is to use the process runner.", "author": "hmijail", "createdAt": "2020-02-20T02:33:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTE4MDIzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTY4NTczNw==", "url": "https://github.com/hyperledger/besu/pull/399#discussion_r381685737", "bodyText": "Anyway, at this point this sounds like a red herring. I'm happy to drop this modification.", "author": "hmijail", "createdAt": "2020-02-20T02:38:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTE4MDIzMQ=="}], "type": "inlineReview"}, {"oid": "0c834a762c129b463fee14174a5047d13e428d29", "url": "https://github.com/hyperledger/besu/commit/0c834a762c129b463fee14174a5047d13e428d29", "message": "Address comments\n\nSigned-off-by: Horacio Mijail Anton Quiles <hmijail@gmail.com>", "committedDate": "2020-02-19T07:44:47Z", "type": "commit"}, {"oid": "3f78b325c887156778967b913cd2b8c45954e156", "url": "https://github.com/hyperledger/besu/commit/3f78b325c887156778967b913cd2b8c45954e156", "message": "Fix naming convention of other loggers\n\nSigned-off-by: Horacio Mijail Anton Quiles <hmijail@gmail.com>", "committedDate": "2020-02-20T11:31:39Z", "type": "commit"}, {"oid": "e4e933a9d2d0775317ed1e2cd4e6e0c8540348ac", "url": "https://github.com/hyperledger/besu/commit/e4e933a9d2d0775317ed1e2cd4e6e0c8540348ac", "message": "Address comment on system property name\n\nSigned-off-by: Horacio Mijail Anton Quiles <hmijail@gmail.com>", "committedDate": "2020-02-22T18:50:56Z", "type": "commit"}, {"oid": "ba54b173598b1127063606495f74d332e46bbcf8", "url": "https://github.com/hyperledger/besu/commit/ba54b173598b1127063606495f74d332e46bbcf8", "message": "Make Besu process' logging be the same level as the test's\n\nSigned-off-by: Horacio Mijail Anton Quiles <hmijail@gmail.com>", "committedDate": "2020-02-22T18:54:24Z", "type": "commit"}, {"oid": "e35c0c12fafe76e0273f6ae74a00b2c014e78b3e", "url": "https://github.com/hyperledger/besu/commit/e35c0c12fafe76e0273f6ae74a00b2c014e78b3e", "message": "Merge branch 'master' into Improve-logging-2\n\nSigned-off-by: Horacio Mijail Anton Quiles <hmijail@gmail.com>", "committedDate": "2020-03-24T06:17:01Z", "type": "commit"}]}