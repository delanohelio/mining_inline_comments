{"pr_number": 8319, "pr_title": "Integration tests for SAML Metadata endpoint", "pr_createdAt": "2020-05-13T02:49:36Z", "pr_url": "https://github.com/wso2/product-is/pull/8319", "timeline": [{"oid": "b6d9a47bb0f2c75311b286f44721a30abd0fe07b", "url": "https://github.com/wso2/product-is/commit/b6d9a47bb0f2c75311b286f44721a30abd0fe07b", "message": "Integration tests for SAML Metadata endpoint", "committedDate": "2020-05-13T01:40:23Z", "type": "commit"}, {"oid": "88a80f0cc87781ce03cb09df221d521ed3b0544d", "url": "https://github.com/wso2/product-is/commit/88a80f0cc87781ce03cb09df221d521ed3b0544d", "message": "Format the code and rename some variables", "committedDate": "2020-05-13T02:44:08Z", "type": "commit"}, {"oid": "cae4f4964ebcf0f6196d01fb9eb36619f9ddbdc6", "url": "https://github.com/wso2/product-is/commit/cae4f4964ebcf0f6196d01fb9eb36619f9ddbdc6", "message": "Change test description", "committedDate": "2020-05-13T02:47:20Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDE1MTcwNA==", "url": "https://github.com/wso2/product-is/pull/8319#discussion_r424151704", "bodyText": "At the beginning of a for loop a new line is not required. Shall we remove this? WDYT?", "author": "ShanChathusanda93", "createdAt": "2020-05-13T03:25:21Z", "path": "modules/integration/tests-integration/tests-backend/src/test/java/org/wso2/identity/integration/test/saml/SAMLMetadataTestCase.java", "diffHunk": "@@ -0,0 +1,110 @@\n+/*\n+ * Copyright (c) 2020, WSO2 Inc. (http://www.wso2.org) All Rights Reserved.\n+ *\n+ * WSO2 Inc. licenses this file to you under the Apache License,\n+ *  Version 2.0 (the \"License\"); you may not use this file except\n+ * in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.wso2.identity.integration.test.saml;\n+\n+import org.apache.http.HttpResponse;\n+import org.apache.http.client.HttpClient;\n+import org.apache.http.client.methods.HttpGet;\n+import org.apache.http.impl.client.HttpClientBuilder;\n+import org.json.JSONArray;\n+import org.json.JSONException;\n+import org.testng.Assert;\n+import org.testng.annotations.BeforeClass;\n+import org.testng.annotations.Test;\n+import org.wso2.carbon.tenant.mgt.stub.TenantMgtAdminServiceExceptionException;\n+import org.wso2.identity.integration.common.clients.TenantManagementServiceClient;\n+import org.wso2.identity.integration.common.utils.ISIntegrationTest;\n+import org.wso2.identity.integration.test.utils.DataExtractUtil;\n+import org.json.JSONObject;\n+import org.json.XML;\n+\n+import java.io.IOException;\n+\n+public class SAMLMetadataTestCase extends ISIntegrationTest {\n+\n+    private static final String SUPER_TENANT_URL = \"https://localhost:9853/identity/metadata/saml2\";\n+    private static final String TENANT_URL = \"https://localhost:9853/t/wso2.com/identity/metadata/saml2\";\n+    private static final String SAML_METADATA_ENDPOINT_TENANT = \"https://localhost:9853/samlsso?tenantDomain=wso2.com\";\n+    private static final String SAML_METADATA_ENDPOINT_SUPER_TENANT = \"https://localhost:9853/samlsso\";\n+    private static final String SAMLARTRESOLVE_ENDPOINT = \"https://localhost:9853/samlartresolve\";\n+    private TenantManagementServiceClient tenantServiceClient;\n+\n+    @BeforeClass(alwaysRun = true)\n+    public void testInit() throws Exception {\n+\n+        super.init();\n+        tenantServiceClient = new TenantManagementServiceClient(isServer.getContextUrls().getBackEndUrl(),\n+                sessionCookie);\n+    }\n+\n+    @Test(groups = \"wso2.is\", description = \"This test method will test SAML Metadata endpoints.\")\n+    public void getSAMLMetadata() throws IOException, TenantMgtAdminServiceExceptionException, JSONException {\n+\n+        testResponseContent(SUPER_TENANT_URL, SAML_METADATA_ENDPOINT_SUPER_TENANT);\n+        tenantServiceClient.addTenant(\"wso2.com\", \"John\", \"password\",\n+                \"john@friends.com\", \"John\", \"Smith\");\n+        testResponseContent(TENANT_URL, SAML_METADATA_ENDPOINT_TENANT);\n+    }\n+\n+    private void testResponseContent(String locationURL, String samlMetadataEndpoint)\n+            throws IOException, JSONException {\n+\n+        HttpClient client = HttpClientBuilder.create().build();\n+        HttpResponse httpResponse = sendGetRequest(client, locationURL);\n+        String content = DataExtractUtil.getContentData(httpResponse);\n+        Assert.assertNotNull(content);\n+        JSONArray singleLogoutServices = XML.toJSONObject(content).getJSONObject(\"EntityDescriptor\").getJSONObject(\n+                \"IDPSSODescriptor\").getJSONArray(\"SingleLogoutService\");\n+\n+        for (int i = 0; i < singleLogoutServices.length(); i++) {\n+", "originalCommit": "cae4f4964ebcf0f6196d01fb9eb36619f9ddbdc6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDE1NTkzNg==", "url": "https://github.com/wso2/product-is/pull/8319#discussion_r424155936", "bodyText": "Fixed ed4daed", "author": "GANGANI", "createdAt": "2020-05-13T03:44:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDE1MTcwNA=="}], "type": "inlineReview"}, {"oid": "ed4daeda51db12ad05cd8d718640a10f984fe877", "url": "https://github.com/wso2/product-is/commit/ed4daeda51db12ad05cd8d718640a10f984fe877", "message": "Remove unwanted new lines", "committedDate": "2020-05-13T03:43:39Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDE2Mzc3Nw==", "url": "https://github.com/wso2/product-is/pull/8319#discussion_r424163777", "bodyText": "private static final String SAML_METADATA_ENDPOINT_SUPER_TENANT = \"https://localhost:9853/samlsso\";\nBetter if we name this as SAML_SSO_ENDPOINT_SUPER_TENANT and change the TENANT_URL and SUPER_TENANT_URL to SAML_METADATA_ENDPOINT_TENANT and SAML_METADATA_ENDPOINT_SUPER_TENANT respectively", "author": "chamathns", "createdAt": "2020-05-13T04:19:31Z", "path": "modules/integration/tests-integration/tests-backend/src/test/java/org/wso2/identity/integration/test/saml/SAMLMetadataTestCase.java", "diffHunk": "@@ -0,0 +1,108 @@\n+/*\n+ * Copyright (c) 2020, WSO2 Inc. (http://www.wso2.org) All Rights Reserved.\n+ *\n+ * WSO2 Inc. licenses this file to you under the Apache License,\n+ *  Version 2.0 (the \"License\"); you may not use this file except\n+ * in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.wso2.identity.integration.test.saml;\n+\n+import org.apache.http.HttpResponse;\n+import org.apache.http.client.HttpClient;\n+import org.apache.http.client.methods.HttpGet;\n+import org.apache.http.impl.client.HttpClientBuilder;\n+import org.json.JSONArray;\n+import org.json.JSONException;\n+import org.testng.Assert;\n+import org.testng.annotations.BeforeClass;\n+import org.testng.annotations.Test;\n+import org.wso2.carbon.tenant.mgt.stub.TenantMgtAdminServiceExceptionException;\n+import org.wso2.identity.integration.common.clients.TenantManagementServiceClient;\n+import org.wso2.identity.integration.common.utils.ISIntegrationTest;\n+import org.wso2.identity.integration.test.utils.DataExtractUtil;\n+import org.json.JSONObject;\n+import org.json.XML;\n+\n+import java.io.IOException;\n+\n+public class SAMLMetadataTestCase extends ISIntegrationTest {\n+\n+    private static final String SUPER_TENANT_URL = \"https://localhost:9853/identity/metadata/saml2\";\n+    private static final String TENANT_URL = \"https://localhost:9853/t/wso2.com/identity/metadata/saml2\";\n+    private static final String SAML_METADATA_ENDPOINT_TENANT = \"https://localhost:9853/samlsso?tenantDomain=wso2.com\";", "originalCommit": "ed4daeda51db12ad05cd8d718640a10f984fe877", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDE2OTI2Mg==", "url": "https://github.com/wso2/product-is/pull/8319#discussion_r424169262", "bodyText": "Fixed 6ab5725", "author": "GANGANI", "createdAt": "2020-05-13T04:44:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDE2Mzc3Nw=="}], "type": "inlineReview"}, {"oid": "6ab572585a54837ade63020646e1add912218583", "url": "https://github.com/wso2/product-is/commit/6ab572585a54837ade63020646e1add912218583", "message": "Rename some variables", "committedDate": "2020-05-13T04:43:32Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDE4MTMwNQ==", "url": "https://github.com/wso2/product-is/pull/8319#discussion_r424181305", "bodyText": "IIRC, we can run the same test for tenant case, rather than adding a new tenant.\nThere are tenants already available.\n@ashensw @Abilashini can you help with this", "author": "malithie", "createdAt": "2020-05-13T05:30:39Z", "path": "modules/integration/tests-integration/tests-backend/src/test/java/org/wso2/identity/integration/test/saml/SAMLMetadataTestCase.java", "diffHunk": "@@ -0,0 +1,108 @@\n+/*\n+ * Copyright (c) 2020, WSO2 Inc. (http://www.wso2.org) All Rights Reserved.\n+ *\n+ * WSO2 Inc. licenses this file to you under the Apache License,\n+ *  Version 2.0 (the \"License\"); you may not use this file except\n+ * in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.wso2.identity.integration.test.saml;\n+\n+import org.apache.http.HttpResponse;\n+import org.apache.http.client.HttpClient;\n+import org.apache.http.client.methods.HttpGet;\n+import org.apache.http.impl.client.HttpClientBuilder;\n+import org.json.JSONArray;\n+import org.json.JSONException;\n+import org.testng.Assert;\n+import org.testng.annotations.BeforeClass;\n+import org.testng.annotations.Test;\n+import org.wso2.carbon.tenant.mgt.stub.TenantMgtAdminServiceExceptionException;\n+import org.wso2.identity.integration.common.clients.TenantManagementServiceClient;\n+import org.wso2.identity.integration.common.utils.ISIntegrationTest;\n+import org.wso2.identity.integration.test.utils.DataExtractUtil;\n+import org.json.JSONObject;\n+import org.json.XML;\n+\n+import java.io.IOException;\n+\n+public class SAMLMetadataTestCase extends ISIntegrationTest {\n+\n+    private static final String SAML_METADATA_ENDPOINT_SUPER_TENANT = \"https://localhost:9853/identity/metadata/saml2\";\n+    private static final String SAML_METADATA_ENDPOINT_TENANT = \"https://localhost:9853/t/wso2.com/identity/metadata/saml2\";\n+    private static final String SAML_SSO_ENDPOINT_TENANT = \"https://localhost:9853/samlsso?tenantDomain=wso2.com\";\n+    private static final String SAML_SSO_ENDPOINT_SUPER_TENANT = \"https://localhost:9853/samlsso\";\n+    private static final String SAMLARTRESOLVE_ENDPOINT = \"https://localhost:9853/samlartresolve\";\n+    private TenantManagementServiceClient tenantServiceClient;\n+\n+    @BeforeClass(alwaysRun = true)\n+    public void testInit() throws Exception {\n+\n+        super.init();\n+        tenantServiceClient = new TenantManagementServiceClient(isServer.getContextUrls().getBackEndUrl(),\n+                sessionCookie);\n+    }\n+\n+    @Test(groups = \"wso2.is\", description = \"This test method will test SAML Metadata endpoints.\")\n+    public void getSAMLMetadata() throws IOException, TenantMgtAdminServiceExceptionException, JSONException {\n+\n+        testResponseContent(SAML_METADATA_ENDPOINT_SUPER_TENANT, SAML_SSO_ENDPOINT_SUPER_TENANT);\n+        tenantServiceClient.addTenant(\"wso2.com\", \"John\", \"password\",\n+                \"john@friends.com\", \"John\", \"Smith\");\n+        testResponseContent(SAML_METADATA_ENDPOINT_TENANT, SAML_SSO_ENDPOINT_TENANT);", "originalCommit": "6ab572585a54837ade63020646e1add912218583", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDI4MDY2NA==", "url": "https://github.com/wso2/product-is/pull/8319#discussion_r424280664", "bodyText": "Fixed e7205b2", "author": "GANGANI", "createdAt": "2020-05-13T08:56:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDE4MTMwNQ=="}], "type": "inlineReview"}, {"oid": "e7205b2ba56c81240aaa592dd2aea29221f75c4b", "url": "https://github.com/wso2/product-is/commit/e7205b2ba56c81240aaa592dd2aea29221f75c4b", "message": "Remove new tenant creation", "committedDate": "2020-05-13T08:48:04Z", "type": "commit"}, {"oid": "84bbe62616f1cb3ec229e8949a650e7a85acf984", "url": "https://github.com/wso2/product-is/commit/84bbe62616f1cb3ec229e8949a650e7a85acf984", "message": "Test SAML Metadata endpoint for super tenant with carbon.super path param", "committedDate": "2020-05-13T10:18:29Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDM2NzMxNg==", "url": "https://github.com/wso2/product-is/pull/8319#discussion_r424367316", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        \"https://localhost:9853//t/carbon.super/identity/metadata/saml2\";\n          \n          \n            \n                        \"https://localhost:9853/t/carbon.super/identity/metadata/saml2\";", "author": "mefarazath", "createdAt": "2020-05-13T11:33:24Z", "path": "modules/integration/tests-integration/tests-backend/src/test/java/org/wso2/identity/integration/test/saml/SAMLMetadataTestCase.java", "diffHunk": "@@ -0,0 +1,99 @@\n+/*\n+ * Copyright (c) 2020, WSO2 Inc. (http://www.wso2.org) All Rights Reserved.\n+ *\n+ * WSO2 Inc. licenses this file to you under the Apache License,\n+ *  Version 2.0 (the \"License\"); you may not use this file except\n+ * in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.wso2.identity.integration.test.saml;\n+\n+import org.apache.http.HttpResponse;\n+import org.apache.http.client.HttpClient;\n+import org.apache.http.client.methods.HttpGet;\n+import org.apache.http.impl.client.HttpClientBuilder;\n+import org.json.JSONArray;\n+import org.json.JSONException;\n+import org.testng.Assert;\n+import org.testng.annotations.Test;\n+import org.wso2.carbon.tenant.mgt.stub.TenantMgtAdminServiceExceptionException;\n+import org.wso2.identity.integration.common.utils.ISIntegrationTest;\n+import org.wso2.identity.integration.test.utils.DataExtractUtil;\n+import org.json.JSONObject;\n+import org.json.XML;\n+\n+import java.io.IOException;\n+\n+public class SAMLMetadataTestCase extends ISIntegrationTest {\n+\n+    private static final String SAML_METADATA_ENDPOINT_SUPER_TENANT = \"https://localhost:9853/identity/metadata/saml2\";\n+    private static final String SAML_METADATA_ENDPOINT_TENANT =\n+            \"https://localhost:9853/t/wso2.com/identity/metadata/saml2\";\n+    private static final String SAML_METADATA_ENDPOINT_WITH_SUPER_TENANT_AS_PATH_PARAM =\n+            \"https://localhost:9853//t/carbon.super/identity/metadata/saml2\";", "originalCommit": "84bbe62616f1cb3ec229e8949a650e7a85acf984", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDQwMDQwMA==", "url": "https://github.com/wso2/product-is/pull/8319#discussion_r424400400", "bodyText": "Fixed 615aad3", "author": "GANGANI", "createdAt": "2020-05-13T12:33:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDM2NzMxNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDM3MTYzNw==", "url": "https://github.com/wso2/product-is/pull/8319#discussion_r424371637", "bodyText": "Shall we add a message for the null case", "author": "Abilashini", "createdAt": "2020-05-13T11:41:51Z", "path": "modules/integration/tests-integration/tests-backend/src/test/java/org/wso2/identity/integration/test/saml/SAMLMetadataTestCase.java", "diffHunk": "@@ -0,0 +1,99 @@\n+/*\n+ * Copyright (c) 2020, WSO2 Inc. (http://www.wso2.org) All Rights Reserved.\n+ *\n+ * WSO2 Inc. licenses this file to you under the Apache License,\n+ *  Version 2.0 (the \"License\"); you may not use this file except\n+ * in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.wso2.identity.integration.test.saml;\n+\n+import org.apache.http.HttpResponse;\n+import org.apache.http.client.HttpClient;\n+import org.apache.http.client.methods.HttpGet;\n+import org.apache.http.impl.client.HttpClientBuilder;\n+import org.json.JSONArray;\n+import org.json.JSONException;\n+import org.testng.Assert;\n+import org.testng.annotations.Test;\n+import org.wso2.carbon.tenant.mgt.stub.TenantMgtAdminServiceExceptionException;\n+import org.wso2.identity.integration.common.utils.ISIntegrationTest;\n+import org.wso2.identity.integration.test.utils.DataExtractUtil;\n+import org.json.JSONObject;\n+import org.json.XML;\n+\n+import java.io.IOException;\n+\n+public class SAMLMetadataTestCase extends ISIntegrationTest {\n+\n+    private static final String SAML_METADATA_ENDPOINT_SUPER_TENANT = \"https://localhost:9853/identity/metadata/saml2\";\n+    private static final String SAML_METADATA_ENDPOINT_TENANT =\n+            \"https://localhost:9853/t/wso2.com/identity/metadata/saml2\";\n+    private static final String SAML_METADATA_ENDPOINT_WITH_SUPER_TENANT_AS_PATH_PARAM =\n+            \"https://localhost:9853//t/carbon.super/identity/metadata/saml2\";\n+    private static final String SAML_SSO_ENDPOINT_TENANT = \"https://localhost:9853/samlsso?tenantDomain=wso2.com\";\n+    private static final String SAML_SSO_ENDPOINT_SUPER_TENANT = \"https://localhost:9853/samlsso\";\n+    private static final String SAMLARTRESOLVE_ENDPOINT = \"https://localhost:9853/samlartresolve\";\n+\n+    @Test(groups = \"wso2.is\", description = \"This test method will test SAML Metadata endpoints.\")\n+    public void getSAMLMetadata() throws IOException, TenantMgtAdminServiceExceptionException, JSONException {\n+\n+        testResponseContent(SAML_METADATA_ENDPOINT_SUPER_TENANT, SAML_SSO_ENDPOINT_SUPER_TENANT);\n+        testResponseContent(SAML_METADATA_ENDPOINT_WITH_SUPER_TENANT_AS_PATH_PARAM, SAML_SSO_ENDPOINT_SUPER_TENANT);\n+        testResponseContent(SAML_METADATA_ENDPOINT_TENANT, SAML_SSO_ENDPOINT_TENANT);\n+    }\n+\n+    private void testResponseContent(String samlMetadataEndpoint, String samlEndpoint)\n+            throws IOException, JSONException {\n+\n+        HttpClient client = HttpClientBuilder.create().build();\n+        HttpResponse httpResponse = sendGetRequest(client, samlMetadataEndpoint);\n+        String content = DataExtractUtil.getContentData(httpResponse);\n+        Assert.assertNotNull(content);", "originalCommit": "84bbe62616f1cb3ec229e8949a650e7a85acf984", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDQwMDMyNA==", "url": "https://github.com/wso2/product-is/pull/8319#discussion_r424400324", "bodyText": "Fixed 615aad3", "author": "GANGANI", "createdAt": "2020-05-13T12:33:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDM3MTYzNw=="}], "type": "inlineReview"}, {"oid": "615aad369e02f588fa1836383528faea0b3ca014", "url": "https://github.com/wso2/product-is/commit/615aad369e02f588fa1836383528faea0b3ca014", "message": "Correct url and add message for content null case", "committedDate": "2020-05-13T12:32:26Z", "type": "commit"}]}