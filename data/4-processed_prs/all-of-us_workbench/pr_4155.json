{"pr_number": 4155, "pr_title": "[risk=no][RW-5566] Add CDR Version to dataset query export comment", "pr_createdAt": "2020-10-13T20:10:46Z", "pr_url": "https://github.com/all-of-us/workbench/pull/4155", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDgxMDg0OQ==", "url": "https://github.com/all-of-us/workbench/pull/4155#discussion_r504810849", "bodyText": "Scope creep, but I would recommend just using a JSON blob in the comment, since it's easier for us to scan later if we need to, and we can .add fields more easily without ti becoming unwieldy to change.\nOr maybe we add an invisible .aou/queryManifest.json to the bucket and do this there.\nI'm just really uncomfortable embedding such time-sensitive information in a user-writable place.", "author": "jaycarlton", "createdAt": "2020-10-14T16:23:54Z", "path": "api/src/main/java/org/pmiops/workbench/dataset/DataSetServiceImpl.java", "diffHunk": "@@ -908,12 +911,9 @@ private static String generateNotebookUserCode(\n     String namespace = \"dataset_\" + qualifier + \"_\" + domainAsString + \"_\";\n     // Comments in R and Python have the same syntax\n     String descriptiveComment =\n-        new StringBuilder(\"# This query represents dataset \\\"\")\n-            .append(dataSetName)\n-            .append(\"\\\" for domain \\\"\")\n-            .append(domainAsString)\n-            .append(\"\\\"\")\n-            .toString();\n+        String.format(\n+            \"# This query represents dataset \\\"%s\\\" for domain \\\"%s\\\" and was generated for %s\",", "originalCommit": "dc7d449a519aeb7ee0c0d9055fe1e507b7615840", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTQ5NjAzOA==", "url": "https://github.com/all-of-us/workbench/pull/4155#discussion_r505496038", "bodyText": "Discussed offline, and I agree this is one starting point, but I'm still wary of embedding metadata casually like this in a user-editable and non-scannable format. We can use a regex to see things like this if we're scanning a notebook, but that means the pattern is a contract.", "author": "jaycarlton", "createdAt": "2020-10-15T12:21:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDgxMDg0OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDgxMjczNA==", "url": "https://github.com/all-of-us/workbench/pull/4155#discussion_r504812734", "bodyText": "We should also include the workspace and notebook name in the comment, as this will get copied and pasted. The email of the researcher would also be helpful in order to establish provenance.\nAs written, they'll have to contact support to find the actual source of the query, and if we only include names, it's going to be even harder (since they don't uniquely identify datasets and domain names may change from one CDR version to the next (though rarely)).", "author": "jaycarlton", "createdAt": "2020-10-14T16:26:48Z", "path": "api/src/main/java/org/pmiops/workbench/dataset/DataSetServiceImpl.java", "diffHunk": "@@ -908,12 +911,9 @@ private static String generateNotebookUserCode(\n     String namespace = \"dataset_\" + qualifier + \"_\" + domainAsString + \"_\";\n     // Comments in R and Python have the same syntax\n     String descriptiveComment =\n-        new StringBuilder(\"# This query represents dataset \\\"\")\n-            .append(dataSetName)\n-            .append(\"\\\" for domain \\\"\")\n-            .append(domainAsString)\n-            .append(\"\\\"\")\n-            .toString();\n+        String.format(\n+            \"# This query represents dataset \\\"%s\\\" for domain \\\"%s\\\" and was generated for %s\",\n+            dataSetName, domainAsString, cdrVersionName);", "originalCommit": "dc7d449a519aeb7ee0c0d9055fe1e507b7615840", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTQ5Njc0MQ==", "url": "https://github.com/all-of-us/workbench/pull/4155#discussion_r505496741", "bodyText": "I'd discuss with product other likely entries here and double check that the sentence format still makes sense as you add things. Our users can all read JSON, and would be less likely to delete or edit it.", "author": "jaycarlton", "createdAt": "2020-10-15T12:22:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDgxMjczNA=="}], "type": "inlineReview"}, {"oid": "a63f62b57f203028258d96ac5b660609d9d8d851", "url": "https://github.com/all-of-us/workbench/commit/a63f62b57f203028258d96ac5b660609d9d8d851", "message": "Fix DataSetControllerBQTest", "committedDate": "2020-10-14T18:25:37Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTUwMDcyMg==", "url": "https://github.com/all-of-us/workbench/pull/4155#discussion_r505500722", "bodyText": "Can we name this something other than \"null\"? That's confusing me.", "author": "jaycarlton", "createdAt": "2020-10-15T12:29:00Z", "path": "api/src/bigquerytest/java/org/pmiops/workbench/api/DataSetControllerBQTest.java", "diffHunk": "@@ -374,6 +374,13 @@ public void testGenerateCodePython() {\n \n   @Test\n   public void testGenerateCodeR() {\n+    String expected =\n+        String.format(\n+            \"library(bigrquery)\\n\"\n+                + \"\\n# This query represents dataset \\\"null\\\" for domain \\\"condition\\\" and was generated for %s\\n\"", "originalCommit": "3e597a44544985e64d2a987146353cf0d67d0fcf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTU0MzEzMQ==", "url": "https://github.com/all-of-us/workbench/pull/4155#discussion_r505543131", "bodyText": "done", "author": "jmthibault79", "createdAt": "2020-10-15T13:30:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTUwMDcyMg=="}], "type": "inlineReview"}, {"oid": "41c48c63ec3205d905a8ea2e02db1166ab40e64e", "url": "https://github.com/all-of-us/workbench/commit/41c48c63ec3205d905a8ea2e02db1166ab40e64e", "message": "Add CDR Version to dataset query export comment", "committedDate": "2020-10-15T12:45:59Z", "type": "commit"}, {"oid": "c06ac55147eaa0e2f5a4b48602f5068d9da85f9a", "url": "https://github.com/all-of-us/workbench/commit/c06ac55147eaa0e2f5a4b48602f5068d9da85f9a", "message": "lint", "committedDate": "2020-10-15T12:45:59Z", "type": "commit"}, {"oid": "e48661e4d3762767dd0fb11df4a6c65d2096d797", "url": "https://github.com/all-of-us/workbench/commit/e48661e4d3762767dd0fb11df4a6c65d2096d797", "message": "Fix DataSetControllerBQTest", "committedDate": "2020-10-15T12:45:59Z", "type": "commit"}, {"oid": "21488c0e24348dbc2d282e82628e84fab958704e", "url": "https://github.com/all-of-us/workbench/commit/21488c0e24348dbc2d282e82628e84fab958704e", "message": "string.format", "committedDate": "2020-10-15T12:46:00Z", "type": "commit"}, {"oid": "492a1eef62c22d1d04f289ab53ec3cda8951cb3a", "url": "https://github.com/all-of-us/workbench/commit/492a1eef62c22d1d04f289ab53ec3cda8951cb3a", "message": "lint", "committedDate": "2020-10-15T12:46:00Z", "type": "commit"}, {"oid": "9ec942e61b56377ddd63312beca035b220e75269", "url": "https://github.com/all-of-us/workbench/commit/9ec942e61b56377ddd63312beca035b220e75269", "message": "give the dataset a name", "committedDate": "2020-10-15T12:46:00Z", "type": "commit"}, {"oid": "9ec942e61b56377ddd63312beca035b220e75269", "url": "https://github.com/all-of-us/workbench/commit/9ec942e61b56377ddd63312beca035b220e75269", "message": "give the dataset a name", "committedDate": "2020-10-15T12:46:00Z", "type": "forcePushed"}]}