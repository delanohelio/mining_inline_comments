{"pr_number": 3324, "pr_title": "[RW-4500][risk=low]Institution affiliation: distinguish between two institution agreement\u2026", "pr_createdAt": "2020-03-31T19:29:30Z", "pr_url": "https://github.com/all-of-us/workbench/pull/3324", "timeline": [{"oid": "e293f487cb6a01d0eb19b8e82c27d70e1aece85e", "url": "https://github.com/all-of-us/workbench/commit/e293f487cb6a01d0eb19b8e82c27d70e1aece85e", "message": "Institution affiliation: distinguish between two institution agreement types", "committedDate": "2020-03-31T19:25:02Z", "type": "commit"}, {"oid": "a868777ab3b89e958484769f4885a93029806d50", "url": "https://github.com/all-of-us/workbench/commit/a868777ab3b89e958484769f4885a93029806d50", "message": "spotless and add comments", "committedDate": "2020-03-31T19:36:14Z", "type": "commit"}, {"oid": "ae787d170f1cf472b8969a8b698df5a9b9b85917", "url": "https://github.com/all-of-us/workbench/commit/ae787d170f1cf472b8969a8b698df5a9b9b85917", "message": "resolve conflict", "committedDate": "2020-03-31T19:45:48Z", "type": "commit"}, {"oid": "583eac0fcc47782c3f6a8a548f92b802d72d44b0", "url": "https://github.com/all-of-us/workbench/commit/583eac0fcc47782c3f6a8a548f92b802d72d44b0", "message": "correc file name", "committedDate": "2020-03-31T19:47:40Z", "type": "commit"}, {"oid": "c75147335efc391f8dd375654a565bd6941b7720", "url": "https://github.com/all-of-us/workbench/commit/c75147335efc391f8dd375654a565bd6941b7720", "message": "Fix ui Test", "committedDate": "2020-03-31T22:56:46Z", "type": "commit"}, {"oid": "78525454158dfae0bbd4234332bf73214f0a79ec", "url": "https://github.com/all-of-us/workbench/commit/78525454158dfae0bbd4234332bf73214f0a79ec", "message": "Fix backend test", "committedDate": "2020-04-01T02:24:40Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTg5NzcyNw==", "url": "https://github.com/all-of-us/workbench/pull/3324#discussion_r401897727", "bodyText": "Change to something to reflect that it's the Institution's Data Use Agreement Type.  Maybe InstitutionDuaType ?", "author": "jmthibault79", "createdAt": "2020-04-01T20:44:06Z", "path": "api/src/main/resources/workbench-api.yaml", "diffHunk": "@@ -5669,6 +5668,14 @@ definitions:\n     - EDUCATIONAL_INSTITUTION\n     - HEALTH_CENTER_NON_PROFIT\n     - OTHER\n+\n+  AgreementType:", "originalCommit": "78525454158dfae0bbd4234332bf73214f0a79ec", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTg5ODk4MA==", "url": "https://github.com/all-of-us/workbench/pull/3324#discussion_r401898980", "bodyText": "\"Type of DUA\"\n\"restricted to a defined set of specific researchers\"", "author": "jmthibault79", "createdAt": "2020-04-01T20:46:36Z", "path": "api/src/main/resources/workbench-api.yaml", "diffHunk": "@@ -5669,6 +5668,14 @@ definitions:\n     - EDUCATIONAL_INSTITUTION\n     - HEALTH_CENTER_NON_PROFIT\n     - OTHER\n+\n+  AgreementType:\n+    type: string\n+    description: 'Type of Agreement Institution has signed, Applicable to all employees or restricted to  just few'", "originalCommit": "78525454158dfae0bbd4234332bf73214f0a79ec", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTkwMDYzMw==", "url": "https://github.com/all-of-us/workbench/pull/3324#discussion_r401900633", "bodyText": "something with dua in the name", "author": "jmthibault79", "createdAt": "2020-04-01T20:49:41Z", "path": "api/db/changelog/db.changelog-134-institution-agreement.xml", "diffHunk": "@@ -0,0 +1,12 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n+<databaseChangeLog\n+  xmlns=\"http://www.liquibase.org/xml/ns/dbchangelog/1.9\"\n+  xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n+  xsi:schemaLocation=\"http://www.liquibase.org/xml/ns/dbchangelog/1.9\n+                      http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-1.9.xsd\">\n+  <changeSet author=\"nsaxena\" id=\"changelog-134-institution-agreement\">\n+      <addColumn tableName=\"institution\">\n+        <column name=\"agreement_type_enum\" type=\"tinyint\"/>", "originalCommit": "78525454158dfae0bbd4234332bf73214f0a79ec", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTkwMTQ1OA==", "url": "https://github.com/all-of-us/workbench/pull/3324#discussion_r401901458", "bodyText": "thanks for cleanup!", "author": "jmthibault79", "createdAt": "2020-04-01T20:51:24Z", "path": "api/src/main/resources/workbench-api.yaml", "diffHunk": "@@ -5563,9 +5563,7 @@ definitions:\n     type: object\n     description: 'Represents an institution which has been approved to validate researchers\n       who wish to use the system, including the email patterns which we use to validate\n-      users.\n-\n-'\n+      users.'", "originalCommit": "78525454158dfae0bbd4234332bf73214f0a79ec", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTkwMTgxMw==", "url": "https://github.com/all-of-us/workbench/pull/3324#discussion_r401901813", "bodyText": "\"Type of DUA\"\n\"restricted to a defined set of specific researchers\"", "author": "jmthibault79", "createdAt": "2020-04-01T20:52:05Z", "path": "api/src/main/resources/workbench-api.yaml", "diffHunk": "@@ -5582,15 +5580,14 @@ definitions:\n       organizationTypeEnum:\n         \"$ref\": \"#/definitions/OrganizationType\"\n         description: 'The Organization Type of this institution if it is one of the\n-          enumerated OrganizationTypes, or OrganizationType.OTHER if it is not\n-\n-'\n+          enumerated OrganizationTypes, or OrganizationType.OTHER if it is not'\n       organizationTypeOtherText:\n         type: string\n         description: 'The detailed Organization Type of this institution, as text,\n-          if its enumerated type is OTHER\n-\n-'\n+          if its enumerated type is OTHER'\n+      agreementTypeEnum:\n+        \"$ref\": \"#/definitions/AgreementType\"\n+        description: 'Type of Agreement Institution has signed, Master or restricted to few employees'", "originalCommit": "78525454158dfae0bbd4234332bf73214f0a79ec", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTkxMzI3Ng==", "url": "https://github.com/all-of-us/workbench/pull/3324#discussion_r401913276", "bodyText": "remove this line to demonstrate that null is converted to MASTER on round-trip", "author": "jmthibault79", "createdAt": "2020-04-01T21:13:56Z", "path": "api/src/test/java/org/pmiops/workbench/institution/InstitutionServiceTest.java", "diffHunk": "@@ -41,15 +42,19 @@\n   @Autowired private VerifiedInstitutionalAffiliationDao verifiedInstitutionalAffiliationDao;\n \n   private final Institution testInst =\n-      new Institution().shortName(\"test\").displayName(\"this is a test\");\n+      new Institution()\n+          .shortName(\"test\")\n+          .displayName(\"this is a test\")\n+          .agreementTypeEnum(AgreementType.MASTER);", "originalCommit": "78525454158dfae0bbd4234332bf73214f0a79ec", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTkxODAzOQ==", "url": "https://github.com/all-of-us/workbench/pull/3324#discussion_r401918039", "bodyText": "Please add these ProfileControllerTests:\n\nemail validation success when agreementType is NULL\nemail validation success when agreementType is MASTER\nemail validation failure when agreementType is RESTRICTED and the email matches domain\nemail validation failure when agreementType is MASTER and the email does not match domain", "author": "jmthibault79", "createdAt": "2020-04-01T21:23:35Z", "path": "api/src/test/java/org/pmiops/workbench/api/ProfileControllerTest.java", "diffHunk": "@@ -57,6 +57,7 @@\n import org.pmiops.workbench.model.AccessBypassRequest;\n import org.pmiops.workbench.model.AccessModule;\n import org.pmiops.workbench.model.Address;\n+import org.pmiops.workbench.model.AgreementType;", "originalCommit": "78525454158dfae0bbd4234332bf73214f0a79ec", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTkxOTU2MQ==", "url": "https://github.com/all-of-us/workbench/pull/3324#discussion_r401919561", "bodyText": "Please add these InstitutionServiceTests:\n\nvalidation success when agreementType is NULL and the contact email matches a domain\nsomething to demonstrate that agreementType is what determines how we validate email, rather than the presence of address or domains.  i.e. don't match against an email address if agreementType is MASTER", "author": "jmthibault79", "createdAt": "2020-04-01T21:26:18Z", "path": "api/src/test/java/org/pmiops/workbench/institution/InstitutionServiceTest.java", "diffHunk": "@@ -18,6 +18,7 @@\n import org.pmiops.workbench.db.model.DbVerifiedInstitutionalAffiliation;\n import org.pmiops.workbench.exceptions.ConflictException;\n import org.pmiops.workbench.exceptions.NotFoundException;\n+import org.pmiops.workbench.model.AgreementType;", "originalCommit": "78525454158dfae0bbd4234332bf73214f0a79ec", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjMzNDc3MA==", "url": "https://github.com/all-of-us/workbench/pull/3324#discussion_r402334770", "bodyText": "there is already a test for that test_emailValidation_mismatch", "author": "NehaBroad", "createdAt": "2020-04-02T13:58:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTkxOTU2MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjMzNjE3OQ==", "url": "https://github.com/all-of-us/workbench/pull/3324#discussion_r402336179", "bodyText": "I will add more for Restricted and NULL", "author": "NehaBroad", "createdAt": "2020-04-02T14:00:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTkxOTU2MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjU0Mjc3Mg==", "url": "https://github.com/all-of-us/workbench/pull/3324#discussion_r402542772", "bodyText": "Let's chat on Slack about point 2 here", "author": "jmthibault79", "createdAt": "2020-04-02T18:59:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTkxOTU2MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTkyMTk1Mw==", "url": "https://github.com/all-of-us/workbench/pull/3324#discussion_r401921953", "bodyText": "VUMC", "author": "jmthibault79", "createdAt": "2020-04-01T21:30:57Z", "path": "ui/src/app/pages/login/account-creation/account-creation-institution.spec.tsx", "diffHunk": "@@ -145,17 +149,49 @@ it('should validate email affiliation when inst and email are specified', async(\n   // Once we blur the input, the API request is sent. Since asdf.com is not a member, it will\n   // block form submission.\n   getEmailInput(wrapper).simulate('blur');\n+\n   await waitOneTickAndUpdate(wrapper);\n   expect(getInstance(wrapper).validate()['checkEmailResponse'])\n     .toContain('Email address is not a member of the selected institution');\n+\n+  expect(getEmailErrorMessage(wrapper).getDOMNode().textContent).toBe(\n+    'The institution has authorized access only to select members.' +\n+    'Please click here to request to be added to the institution'\n+  );\n+});\n+\n+it('should validate email affiliation when inst and email domain are specified', async() => {\n+  const wrapper = component();\n+  await waitOneTickAndUpdate(wrapper);\n+\n+  // Choose 'Broad' and enter an email address.", "originalCommit": "78525454158dfae0bbd4234332bf73214f0a79ec", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTkyMjQ3OQ==", "url": "https://github.com/all-of-us/workbench/pull/3324#discussion_r401922479", "bodyText": "this is a little confusing.  does the original asdf work?", "author": "jmthibault79", "createdAt": "2020-04-01T21:32:00Z", "path": "ui/src/app/pages/login/account-creation/account-creation-institution.spec.tsx", "diffHunk": "@@ -179,7 +215,7 @@ it('should trigger email check when email is filled in before choosing instituti\n   const wrapper = component();\n   await waitOneTickAndUpdate(wrapper);\n \n-  getEmailInput(wrapper).simulate('change', {target: {value: 'asdf@broadinstitute.org'}});\n+  getEmailInput(wrapper).simulate('change', {target: {value: 'institution@broadinstitute.org'}});", "originalCommit": "78525454158dfae0bbd4234332bf73214f0a79ec", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjMzNTU2Nw==", "url": "https://github.com/all-of-us/workbench/pull/3324#discussion_r402335567", "bodyText": "no since Broad has Restricted agreement", "author": "NehaBroad", "createdAt": "2020-04-02T13:59:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTkyMjQ3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjU0MTg3Ng==", "url": "https://github.com/all-of-us/workbench/pull/3324#discussion_r402541876", "bodyText": "I mean: please change the emailAddresses[] in the test data so it's clear that they refer to people and not institutions", "author": "jmthibault79", "createdAt": "2020-04-02T18:57:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTkyMjQ3OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTkyMzA0Mw==", "url": "https://github.com/all-of-us/workbench/pull/3324#discussion_r401923043", "bodyText": "(or null)", "author": "jmthibault79", "createdAt": "2020-04-01T21:33:10Z", "path": "ui/src/app/pages/login/account-creation/account-creation-institution.tsx", "diffHunk": "@@ -195,6 +195,28 @@ export class AccountCreationInstitution extends React.Component<Props, State> {\n     this.setState(fp.set(['profile', 'contactEmail'], contactEmail));\n   }\n \n+  get displayEmailErrorMessage() {\n+    const {institutions,\n+    profile: {\n+      verifiedInstitutionalAffiliation\n+    }} = this.state;\n+    if (verifiedInstitutionalAffiliation && verifiedInstitutionalAffiliation.institutionShortName) {\n+      const selectedInstitutionObj = fp.find((institution) =>\n+          institution.shortName === verifiedInstitutionalAffiliation.institutionShortName, institutions);\n+\n+      // If Instution has signed Restricted agreement and the email id is not in allowed email ids list\n+      if (selectedInstitutionObj.agreementTypeEnum === AgreementType.RESTRICTED) {\n+        return <div data-test-id='email-error-message' style={{color: colors.danger}}>\n+          The institution has authorized access only to select members.<br/>\n+          Please <a href='https://www.researchallofus.org/apply/' target='_blank'>\n+          click here</a> to request to be added to the institution</div>;\n+      }\n+      // If institution has MASTER agreement and the domain is not in the allowed list", "originalCommit": "78525454158dfae0bbd4234332bf73214f0a79ec", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTkyNDUxMQ==", "url": "https://github.com/all-of-us/workbench/pull/3324#discussion_r401924511", "bodyText": "good new test \ud83d\udc4d", "author": "jmthibault79", "createdAt": "2020-04-01T21:36:16Z", "path": "ui/src/app/pages/login/account-creation/account-creation-institution.spec.tsx", "diffHunk": "@@ -145,17 +149,49 @@ it('should validate email affiliation when inst and email are specified', async(\n   // Once we blur the input, the API request is sent. Since asdf.com is not a member, it will\n   // block form submission.\n   getEmailInput(wrapper).simulate('blur');\n+\n   await waitOneTickAndUpdate(wrapper);\n   expect(getInstance(wrapper).validate()['checkEmailResponse'])\n     .toContain('Email address is not a member of the selected institution');\n+\n+  expect(getEmailErrorMessage(wrapper).getDOMNode().textContent).toBe(\n+    'The institution has authorized access only to select members.' +\n+    'Please click here to request to be added to the institution'\n+  );\n+});\n+\n+it('should validate email affiliation when inst and email domain are specified', async() => {", "originalCommit": "78525454158dfae0bbd4234332bf73214f0a79ec", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "7804135712b87ae829c05e92a96ed29135ec7335", "url": "https://github.com/all-of-us/workbench/commit/7804135712b87ae829c05e92a96ed29135ec7335", "message": "PR Comments: Change name agreementType to DuaType and add test to include restricted", "committedDate": "2020-04-03T19:08:28Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzI1NDA2Ng==", "url": "https://github.com/all-of-us/workbench/pull/3324#discussion_r403254066", "bodyText": "changing name to dua_type to be more consistent with other columns like organization_type", "author": "NehaBroad", "createdAt": "2020-04-03T19:09:36Z", "path": "api/db/changelog/db.changelog-134-institution-data-user-agreement.xml", "diffHunk": "@@ -0,0 +1,12 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n+<databaseChangeLog\n+  xmlns=\"http://www.liquibase.org/xml/ns/dbchangelog/1.9\"\n+  xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n+  xsi:schemaLocation=\"http://www.liquibase.org/xml/ns/dbchangelog/1.9\n+                      http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-1.9.xsd\">\n+  <changeSet author=\"nsaxena\" id=\"changelog-134-institution-data-user-agreement\">\n+      <addColumn tableName=\"institution\">\n+        <column name=\"dua_type_enum\" type=\"tinyint\"/>", "originalCommit": "7804135712b87ae829c05e92a96ed29135ec7335", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "c5b74d8ca99e1b0fee2f868cb93c076dc2fbaf26", "url": "https://github.com/all-of-us/workbench/commit/c5b74d8ca99e1b0fee2f868cb93c076dc2fbaf26", "message": "remove static file that got added by mistake", "committedDate": "2020-04-03T19:10:54Z", "type": "commit"}, {"oid": "c5c74a43719874029e290fc3f3eb32a73ff57b7b", "url": "https://github.com/all-of-us/workbench/commit/c5c74a43719874029e290fc3f3eb32a73ff57b7b", "message": "Fix UI", "committedDate": "2020-04-04T02:50:15Z", "type": "commit"}, {"oid": "9c6ed4f48fbbebfdde9487cd2a63526ce8799cec", "url": "https://github.com/all-of-us/workbench/commit/9c6ed4f48fbbebfdde9487cd2a63526ce8799cec", "message": "PR Comments: Update comments and update contact email", "committedDate": "2020-04-04T02:55:02Z", "type": "commit"}, {"oid": "48e60a6fbdcdb2ff66f6a194a6480fdd8b35047c", "url": "https://github.com/all-of-us/workbench/commit/48e60a6fbdcdb2ff66f6a194a6480fdd8b35047c", "message": "fix test", "committedDate": "2020-04-04T03:03:30Z", "type": "commit"}, {"oid": "97dddb6c9d961669a259f5a166e6e9a86cc18d1b", "url": "https://github.com/all-of-us/workbench/commit/97dddb6c9d961669a259f5a166e6e9a86cc18d1b", "message": "rebase", "committedDate": "2020-04-04T03:10:46Z", "type": "commit"}, {"oid": "796f6d495fff9fb6c5c5a949ab9596add9f1ac16", "url": "https://github.com/all-of-us/workbench/commit/796f6d495fff9fb6c5c5a949ab9596add9f1ac16", "message": "SpotlessApply", "committedDate": "2020-04-04T03:35:58Z", "type": "commit"}, {"oid": "0e808554966f110983b987ee77d963e370bf8237", "url": "https://github.com/all-of-us/workbench/commit/0e808554966f110983b987ee77d963e370bf8237", "message": "adding new test for email validation with dua null", "committedDate": "2020-04-07T15:46:48Z", "type": "commit"}]}