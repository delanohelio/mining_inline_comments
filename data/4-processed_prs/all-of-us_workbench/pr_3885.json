{"pr_number": 3885, "pr_title": "[RW-5114][risk=no] Update hierarchy page ", "pr_createdAt": "2020-08-14T19:00:34Z", "pr_url": "https://github.com/all-of-us/workbench/pull/3885", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTYxMDU4Mg==", "url": "https://github.com/all-of-us/workbench/pull/3885#discussion_r471610582", "bodyText": "Should we add check for selectionsIds being null or undefined?", "author": "NehaBroad", "createdAt": "2020-08-17T16:53:26Z", "path": "ui/src/app/cohort-search/list-search-v2/list-search-v2.component.tsx", "diffHunk": "@@ -411,7 +411,12 @@ export const ListSearchV2 = withCurrentWorkspace()(\n             </tbody>\n           </table>}\n           {!standardOnly && !displayData.length && <div>No results found</div>}\n-          <Button type='primary' style={{borderRadius: '5px', float: 'right', marginTop: '1rem'}}>Finish & Review</Button>\n+          <Button type='primary'\n+                  style={{borderRadius: '5px', float: 'right', marginTop: '1rem'}}\n+                  disabled={selectedIds.length === 0}", "originalCommit": "16b7206b8f76035e932bf3ff5e71a669b20221c2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTYzNDI2Mw==", "url": "https://github.com/all-of-us/workbench/pull/3885#discussion_r471634263", "bodyText": "nit we can move this in a function as we are using this condition twice (at 442) attributesSelection || showModifiersSlide", "author": "NehaBroad", "createdAt": "2020-08-17T17:18:20Z", "path": "ui/src/app/cohort-search/selection-list/selection-list.component.tsx", "diffHunk": "@@ -310,111 +329,143 @@ export class SelectionListModalVersion extends React.Component<Props> {\n   }\n }\n \n-export const SelectionList = withCurrentCohortCriteria()(class extends React.Component<Props, State> {\n-  constructor(props: Props) {\n-    super(props);\n-    this.state = {\n-      modifierButtonText: 'APPLY MODIFIERS',\n-      showModifiersSlide: false\n-    };\n-  }\n-\n-  componentDidUpdate(prevProps: Readonly<Props>): void {\n-    if (!this.props.criteria && !!prevProps.criteria) {\n-      this.setState({\n+export const SelectionList = fp.flow(withCurrentCohortCriteria(), withCurrentCohortSearchContext())(\n+  class extends React.Component<Props, State> {\n+    subscription: Subscription;\n+    constructor(props: Props) {\n+      super(props);\n+      this.state = {\n+        attributesSelection: undefined,\n         modifierButtonText: 'APPLY MODIFIERS',\n         showModifiersSlide: false\n+      };\n+    }\n+\n+    componentDidMount(): void {\n+      this.subscription = attributesSelectionStore.subscribe(attributesSelection => {\n+        this.setState({attributesSelection});\n+        if (!!attributesSelection) {\n+          setSidebarActiveIconStore.next('criteria');\n+        }\n       });\n     }\n-  }\n \n-  get showModifiers() {\n-    return ![DomainType.PHYSICALMEASUREMENT, DomainType.PERSON, DomainType.SURVEY].includes(this.props.domain);\n-  }\n+    componentDidUpdate(prevProps: Readonly<Props>): void {\n+      if (!this.props.criteria && !!prevProps.criteria) {\n+        this.setState({\n+          modifierButtonText: 'APPLY MODIFIERS',\n+          showModifiersSlide: false\n+        });\n+      }\n+    }\n \n-  get showNext() {\n-    return this.showModifiers && this.props.view !== 'modifiers';\n-  }\n+    get showModifiers() {\n+      return ![DomainType.PHYSICALMEASUREMENT, DomainType.PERSON, DomainType.SURVEY].includes(this.props.domain);\n+    }\n \n-  get showBack() {\n-    return this.showModifiers && this.props.view === 'modifiers';\n-  }\n+    get showNext() {\n+      return this.showModifiers && this.props.view !== 'modifiers';\n+    }\n \n-  showOr(index, selection) {\n-    return index > 0 && selection.domainId !== DomainType.PERSON.toString();\n-  }\n+    get showBack() {\n+      return this.showModifiers && this.props.view === 'modifiers';\n+    }\n \n-  renderCriteria() {\n-    const {criteria} = this.props;\n-    const g = fp.groupBy('isStandard', criteria);\n-    return <div style={{paddingLeft: '0.5rem', paddingBottom: '4rem'}}>\n-      {g['true'] && g['true'].length > 0 && this.renderCriteriaGroup(g['true'] , 'Standard Groups')}\n-      {g['false'] && g['false'].length > 0 && this.renderCriteriaGroup(g['false'], 'Source code Groups')}\n-    </div>;\n-  }\n+    showOr(index, selection) {\n+      return index > 0 && selection.domainId !== DomainType.PERSON.toString();\n+    }\n \n-  removeCriteria(criteriaToDel) {\n-    const updateList =  fp.remove(\n-      (selection) => selection.parameterId === criteriaToDel.parameterId, this.props.criteria);\n-    currentCohortCriteriaStore.next(updateList);\n-  }\n+    renderCriteria() {\n+      const {criteria} = this.props;\n+      const g = fp.groupBy('isStandard', criteria);\n+      return <div style={{paddingLeft: '0.5rem', paddingBottom: '4rem'}}>\n+        {g['true'] && g['true'].length > 0 && this.renderCriteriaGroup(g['true'] , 'Standard Groups')}\n+        {g['false'] && g['false'].length > 0 && this.renderCriteriaGroup(g['false'], 'Source code Groups')}\n+      </div>;\n+    }\n \n-  renderCriteriaGroup(criteriaGroup, header) {\n-    return  <React.Fragment>\n-      <h3> {header}</h3>\n-      <hr style={{marginRight: '0.5rem'}}/>\n-      {criteriaGroup && criteriaGroup.map((criteria, index) =>\n-        <SelectionInfo key={index}\n-                       index={index}\n-                       selection={criteria}\n-                       removeSelection={() => this.removeCriteria(criteria)}/>\n-\n-      )}\n-    </React.Fragment> ;\n-  }\n+    removeCriteria(criteriaToDel) {\n+      const updateList = fp.remove((selection) => selection.parameterId === criteriaToDel.parameterId, this.props.criteria);\n+      currentCohortCriteriaStore.next(updateList);\n+    }\n+\n+    renderCriteriaGroup(criteriaGroup, header) {\n+      return  <React.Fragment>\n+        <h3> {header}</h3>\n+        <hr style={{marginRight: '0.5rem'}}/>\n+        {criteriaGroup && criteriaGroup.map((criteria, index) =>\n+          <SelectionInfo key={index}\n+                         index={index}\n+                         selection={criteria}\n+                         removeSelection={() => this.removeCriteria(criteria)}/>\n \n-  applyModifier(modifiers) {\n-    if (modifiers) {\n-      const modifierButtonText = '(' + modifiers.length + ')  MODIFIERS APPLIED';\n-      this.setState({showModifiersSlide: false, modifierButtonText: modifierButtonText});\n-    } else {\n-      this.setState({showModifiersSlide: false, modifierButtonText: 'APPLY MODIFIERS'});\n+        )}\n+      </React.Fragment> ;\n     }\n-  }\n \n-  get showModifierButton() {\n-    const {criteria} = this.props;\n-    return criteria && criteria.length > 0 &&\n-      criteria[0].domainId !== DomainType.PHYSICALMEASUREMENT.toString()\n-      && criteria[0].domainId !== DomainType.PERSON.toString();\n-  }\n+    applyModifier(modifiers) {\n+      if (modifiers) {\n+        const modifierButtonText = '(' + modifiers.length + ')  MODIFIERS APPLIED';\n+        this.setState({showModifiersSlide: false, modifierButtonText: modifierButtonText});\n+      } else {\n+        this.setState({showModifiersSlide: false, modifierButtonText: 'APPLY MODIFIERS'});\n+      }\n+    }\n \n-  render() {\n-    const {back, criteria} = this.props;\n-    const {modifierButtonText, showModifiersSlide} = this.state;\n-    return <div>\n-        {!showModifiersSlide ?  <React.Fragment>\n-          <h3 style={{...styles.sectionTitle, marginTop: 0}}>Add selected criteria to cohort</h3>\n-          <div style={{paddingTop: '0.5rem', position: 'relative'}}>\n-            <div style={styles.selectionContainer}>\n-              {this.renderCriteria()}\n-              {this.showModifierButton && <div style={{paddingLeft: '0.6rem'}}>\n-                <Button type='secondaryOnDarkBackground' style={styles.modifierButton}\n-                        onClick={() => this.setState({showModifiersSlide: true})}>\n-                  {modifierButtonText}\n-                </Button>\n-              </div>}\n+    get showModifierButton() {\n+      const {criteria} = this.props;\n+      return criteria && criteria.length > 0 &&\n+        criteria[0].domainId !== DomainType.PHYSICALMEASUREMENT.toString()\n+        && criteria[0].domainId !== DomainType.PERSON.toString();\n+    }\n+\n+    render() {\n+      const {back, criteria} = this.props;\n+      const {attributesSelection, modifierButtonText, showModifiersSlide} = this.state;\n+      return <div>\n+        <FlexRow style={styles.navIcons}>\n+          {(attributesSelection || showModifiersSlide) &&", "originalCommit": "16b7206b8f76035e932bf3ff5e71a669b20221c2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTcxMDY1Mg==", "url": "https://github.com/all-of-us/workbench/pull/3885#discussion_r471710652", "bodyText": "Done", "author": "dolbeew", "createdAt": "2020-08-17T18:53:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTYzNDI2Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTY1NDI4NA==", "url": "https://github.com/all-of-us/workbench/pull/3885#discussion_r471654284", "bodyText": "Nit: can you please add brackets, because of so many conditions its a little difficult to read", "author": "NehaBroad", "createdAt": "2020-08-17T17:40:58Z", "path": "ui/src/app/cohort-search/tree-node/tree-node.component.tsx", "diffHunk": "@@ -292,7 +292,9 @@ export class TreeNode extends React.Component<TreeNodeProps, TreeNodeState> {\n       setAttributes} = this.props;\n     const {children, error, expanded, hover, loading, searchMatch} = this.state;\n     const nodeChildren = domainId === DomainType.PHYSICALMEASUREMENT.toString() ? node.children : children;\n-    const selected = selectedIds.includes(this.paramId) || groupSelections.includes(parentId);\n+    const selected = serverConfigStore.getValue().enableCohortBuilderV2\n+      ? currentCohortCriteriaStore.getValue().some(crit => crit.parameterId === this.paramId)\n+      : selectedIds.includes(this.paramId) || groupSelections.includes(parentId);", "originalCommit": "16b7206b8f76035e932bf3ff5e71a669b20221c2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTczODY3Mw==", "url": "https://github.com/all-of-us/workbench/pull/3885#discussion_r471738673", "bodyText": "Not sure if this is what you meant, but I tried to make it a little more readable. Also added a parentId check we were missing for the V2 UI.", "author": "dolbeew", "createdAt": "2020-08-17T19:51:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTY1NDI4NA=="}], "type": "inlineReview"}, {"oid": "fb08deca54a4811cbd24f4a9f68efe1666187b64", "url": "https://github.com/all-of-us/workbench/commit/fb08deca54a4811cbd24f4a9f68efe1666187b64", "message": "RW-5114 fix removal of selections", "committedDate": "2020-08-17T20:04:14Z", "type": "commit"}, {"oid": "f1c2003be9c3c85007f2c253528b021be18d1382", "url": "https://github.com/all-of-us/workbench/commit/f1c2003be9c3c85007f2c253528b021be18d1382", "message": "RW-5114 adjust searchbar styles", "committedDate": "2020-08-17T20:04:14Z", "type": "commit"}, {"oid": "20898fc155443caf463e7728829c0022d42b96e3", "url": "https://github.com/all-of-us/workbench/commit/20898fc155443caf463e7728829c0022d42b96e3", "message": "RW-5114 implement save criteria function", "committedDate": "2020-08-17T20:04:14Z", "type": "commit"}, {"oid": "fd0bb623cce38f0cbd6fb8ab7ab8f676a44616c8", "url": "https://github.com/all-of-us/workbench/commit/fd0bb623cce38f0cbd6fb8ab7ab8f676a44616c8", "message": "RW-5114 add store for opening sidebar", "committedDate": "2020-08-17T20:04:14Z", "type": "commit"}, {"oid": "f7e6d9a8c534fb891184fc57e8cd6987f9e42857", "url": "https://github.com/all-of-us/workbench/commit/f7e6d9a8c534fb891184fc57e8cd6987f9e42857", "message": "RW-5114 move attributes to selection-list component", "committedDate": "2020-08-17T20:04:14Z", "type": "commit"}, {"oid": "c735b0441437ed7cc14248bbe798a70197657970", "url": "https://github.com/all-of-us/workbench/commit/c735b0441437ed7cc14248bbe798a70197657970", "message": "RW-5114 fix ui tests", "committedDate": "2020-08-17T20:04:14Z", "type": "commit"}, {"oid": "04f8d0d0c51e43ad8b0d654e79631b3d9aa5c7de", "url": "https://github.com/all-of-us/workbench/commit/04f8d0d0c51e43ad8b0d654e79631b3d9aa5c7de", "message": "RW-5114 minor tree fixes", "committedDate": "2020-08-17T20:04:14Z", "type": "commit"}, {"oid": "595efe3c284acc3c726a09a7b3749d5c49cd8563", "url": "https://github.com/all-of-us/workbench/commit/595efe3c284acc3c726a09a7b3749d5c49cd8563", "message": "RW-5114 pr feedback", "committedDate": "2020-08-17T20:04:14Z", "type": "commit"}, {"oid": "595efe3c284acc3c726a09a7b3749d5c49cd8563", "url": "https://github.com/all-of-us/workbench/commit/595efe3c284acc3c726a09a7b3749d5c49cd8563", "message": "RW-5114 pr feedback", "committedDate": "2020-08-17T20:04:14Z", "type": "forcePushed"}]}