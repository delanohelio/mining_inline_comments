{"pr_number": 4281, "pr_title": "[RW-5418][RW-5754] UpdateRuntime UI", "pr_createdAt": "2020-11-12T17:39:13Z", "pr_url": "https://github.com/all-of-us/workbench/pull/4281", "timeline": [{"oid": "991f1bd5e590a73c9435aec8ab728362b4cc7ad9", "url": "https://github.com/all-of-us/workbench/commit/991f1bd5e590a73c9435aec8ab728362b4cc7ad9", "message": "refactor runtime config", "committedDate": "2020-11-05T17:02:04Z", "type": "commit"}, {"oid": "50330c3294e18cce8c76c4d73a20f95ef526357c", "url": "https://github.com/all-of-us/workbench/commit/50330c3294e18cce8c76c4d73a20f95ef526357c", "message": "bit messy but the diff calc shoudl be correct", "committedDate": "2020-11-05T20:39:17Z", "type": "commit"}, {"oid": "d95189ec28c353a6bc58dbf73f1af4deb533b449", "url": "https://github.com/all-of-us/workbench/commit/d95189ec28c353a6bc58dbf73f1af4deb533b449", "message": "WIP - can calculate diffs along with textual descriptions", "committedDate": "2020-11-09T04:49:17Z", "type": "commit"}, {"oid": "5116ebf57e151783fcf727fc6f17517000c3da02", "url": "https://github.com/all-of-us/workbench/commit/5116ebf57e151783fcf727fc6f17517000c3da02", "message": "merge + adding cost estimator to confirmation page", "committedDate": "2020-11-09T18:45:52Z", "type": "commit"}, {"oid": "58ab8afbb48249d8006af77c106d58064ec46347", "url": "https://github.com/all-of-us/workbench/commit/58ab8afbb48249d8006af77c106d58064ec46347", "message": "fix diff description", "committedDate": "2020-11-09T18:48:23Z", "type": "commit"}, {"oid": "01d0fba7db3397533d4866bad880ce4317af8b26", "url": "https://github.com/all-of-us/workbench/commit/01d0fba7db3397533d4866bad880ce4317af8b26", "message": "calling the actual updateRuntime API in the right scenarios", "committedDate": "2020-11-10T04:07:57Z", "type": "commit"}, {"oid": "ac415e5bc136032ee159ad9f61c5ef7b2f4e3405", "url": "https://github.com/all-of-us/workbench/commit/ac415e5bc136032ee159ad9f61c5ef7b2f4e3405", "message": "add first test - sending out delete on needs_delete", "committedDate": "2020-11-10T18:13:07Z", "type": "commit"}, {"oid": "cea518bd07487b15de76c8ee1ac3b7e041748246", "url": "https://github.com/all-of-us/workbench/commit/cea518bd07487b15de76c8ee1ac3b7e041748246", "message": "add unit tests", "committedDate": "2020-11-12T17:14:56Z", "type": "commit"}, {"oid": "6ec0903db2d3166680e3494614bbceb77fdcc4b6", "url": "https://github.com/all-of-us/workbench/commit/6ec0903db2d3166680e3494614bbceb77fdcc4b6", "message": "refactor warning sign", "committedDate": "2020-11-12T17:38:31Z", "type": "commit"}, {"oid": "a70850403d32b65d00aceecc9a2f1c5e902ee134", "url": "https://github.com/all-of-us/workbench/commit/a70850403d32b65d00aceecc9a2f1c5e902ee134", "message": "fix unit tests", "committedDate": "2020-11-12T23:11:49Z", "type": "commit"}, {"oid": "084bbc8719f7b7bf39bc0f2db57d10597879fe9b", "url": "https://github.com/all-of-us/workbench/commit/084bbc8719f7b7bf39bc0f2db57d10597879fe9b", "message": "address comment", "committedDate": "2020-11-12T23:16:48Z", "type": "commit"}, {"oid": "341209797b8d3dce170bc97f085129dc2b5f86d6", "url": "https://github.com/all-of-us/workbench/commit/341209797b8d3dce170bc97f085129dc2b5f86d6", "message": "self review", "committedDate": "2020-11-13T01:07:16Z", "type": "commit"}, {"oid": "cc36157216fe144a58f0aa5944406ba75572b89d", "url": "https://github.com/all-of-us/workbench/commit/cc36157216fe144a58f0aa5944406ba75572b89d", "message": "do not compare machine types", "committedDate": "2020-11-13T02:26:03Z", "type": "commit"}, {"oid": "0f1a0748550a84079aebea7c7db77e9430593499", "url": "https://github.com/all-of-us/workbench/commit/0f1a0748550a84079aebea7c7db77e9430593499", "message": "yarn lint", "committedDate": "2020-11-13T02:31:03Z", "type": "commit"}, {"oid": "8c6a7d4ed4d4eb60debaa068e1b763fd1a751b89", "url": "https://github.com/all-of-us/workbench/commit/8c6a7d4ed4d4eb60debaa068e1b763fd1a751b89", "message": "lint", "committedDate": "2020-11-13T02:39:30Z", "type": "commit"}, {"oid": "4608b3643dde225ebe9b2d2ab944eca170afd951", "url": "https://github.com/all-of-us/workbench/commit/4608b3643dde225ebe9b2d2ab944eca170afd951", "message": "cannot make buttons into function components", "committedDate": "2020-11-13T03:09:59Z", "type": "commit"}, {"oid": "6f27f4517dbe8f4be09516e85b2662b42c71aafe", "url": "https://github.com/all-of-us/workbench/commit/6f27f4517dbe8f4be09516e85b2662b42c71aafe", "message": "merge master - potential breakage", "committedDate": "2020-11-13T05:23:03Z", "type": "commit"}, {"oid": "4da7ee31bcc386346692b5fa4450e6f0503966e9", "url": "https://github.com/all-of-us/workbench/commit/4da7ee31bcc386346692b5fa4450e6f0503966e9", "message": "fix merge failures", "committedDate": "2020-11-13T16:27:58Z", "type": "commit"}, {"oid": "dd18c04e22e9bfe2cb8139376c916b6b135340c3", "url": "https://github.com/all-of-us/workbench/commit/dd18c04e22e9bfe2cb8139376c916b6b135340c3", "message": "close sidebar on udpate", "committedDate": "2020-11-13T20:31:08Z", "type": "commit"}, {"oid": "f1e2a24a6c29b409ede368311b1b5b143b0b4663", "url": "https://github.com/all-of-us/workbench/commit/f1e2a24a6c29b409ede368311b1b5b143b0b4663", "message": "finishing touches", "committedDate": "2020-11-13T20:57:40Z", "type": "commit"}, {"oid": "ff2c0c74b0b1330024040ccc107ab732dfa4bd9a", "url": "https://github.com/all-of-us/workbench/commit/ff2c0c74b0b1330024040ccc107ab732dfa4bd9a", "message": "lint fix", "committedDate": "2020-11-16T16:54:11Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDM3NDczMQ==", "url": "https://github.com/all-of-us/workbench/pull/4281#discussion_r524374731", "bodyText": "lol, I called this something different, so whoever merges first is going to cause a conflict for the other person. this is a better name than mine though.", "author": "als364", "createdAt": "2020-11-16T15:55:53Z", "path": "ui/src/app/components/help-sidebar.tsx", "diffHunk": "@@ -744,7 +744,7 @@ export const HelpSidebar = fp.flow(\n               }\n             </div>}\n             {activeIcon === 'runtime' && <div style={contentStyle('runtime')}>\n-              {<RuntimePanel/>}\n+              {<RuntimePanel onUpdate={() => setSidebarState(false)} />}", "originalCommit": "f1e2a24a6c29b409ede368311b1b5b143b0b4663", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDQ3Nzg4NA==", "url": "https://github.com/all-of-us/workbench/pull/4281#discussion_r524477884", "bodyText": "I think we should try to merge yours in first. It'll be easier to merge a smaller changset into a larger one.", "author": "ericsong", "createdAt": "2020-11-16T18:19:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDM3NDczMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDM5Njc3OQ==", "url": "https://github.com/all-of-us/workbench/pull/4281#discussion_r524396779", "bodyText": "pickMainDiskSize isn't async so this won't do anything", "author": "als364", "createdAt": "2020-11-16T16:25:22Z", "path": "ui/src/app/pages/analysis/runtime-panel.spec.tsx", "diffHunk": "@@ -126,15 +149,14 @@ describe('RuntimePanel', () => {\n \n   it('should allow creation with GCE config', async() => {\n     runtimeApiStub.runtime = null;\n-    act(() => { runtimeStore.set({runtime: null, workspaceNamespace: workspaceStubs[0].namespace}) });\n+    act(() => { runtimeStore.set({runtime: null, workspaceNamespace: workspaceStubs[0].namespace}); });\n \n     const wrapper = component();\n-    await handleUseEffect(wrapper);\n     await waitOneTickAndUpdate(wrapper);\n \n     await pickMainCpu(wrapper, 8);\n     await pickMainRam(wrapper, 52);\n-    pickMainDiskSize(wrapper, 75);\n+    await pickMainDiskSize(wrapper, 75);", "originalCommit": "f1e2a24a6c29b409ede368311b1b5b143b0b4663", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDM5NzQ3Ng==", "url": "https://github.com/all-of-us/workbench/pull/4281#discussion_r524397476", "bodyText": "There's already a waitOneTickAndUpdate in pickDropdownOption, which is called by pickComputeType - if that needs an extra tick then put the call inside pickDropdownOption", "author": "als364", "createdAt": "2020-11-16T16:26:22Z", "path": "ui/src/app/pages/analysis/runtime-panel.spec.tsx", "diffHunk": "@@ -287,14 +304,15 @@ describe('RuntimePanel', () => {\n     act(() => { runtimeStore.set({runtime: null, workspaceNamespace: workspaceStubs[0].namespace}) });\n \n     const wrapper = component();\n-    await handleUseEffect(wrapper);\n     await waitOneTickAndUpdate(wrapper);\n \n     // Take the preset, make a change, then revert.\n     await pickPreset(wrapper, runtimePresets.generalAnalysis);\n     await pickComputeType(wrapper, ComputeType.Dataproc);\n+    await waitOneTickAndUpdate(wrapper);", "originalCommit": "f1e2a24a6c29b409ede368311b1b5b143b0b4663", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDQxMTc2Ng==", "url": "https://github.com/all-of-us/workbench/pull/4281#discussion_r524411766", "bodyText": "likewise, if this is necessary after pickMainDiskSize then it should be incorporated into pickNumberInput", "author": "als364", "createdAt": "2020-11-16T16:45:19Z", "path": "ui/src/app/pages/analysis/runtime-panel.spec.tsx", "diffHunk": "@@ -319,47 +336,226 @@ describe('RuntimePanel', () => {\n     expect(memoryOptions.map(m => m.text())).toEqual(['7.2', '30', '52']);\n   });\n \n-  it('should toggle the disabled state of the update button when the configuration changes', async() => {\n+  it('should disable the Update button if there are no changes and runtime is running', async() => {\n     const wrapper = component();\n-    await handleUseEffect(wrapper);\n     await waitOneTickAndUpdate(wrapper);\n \n-    const updateButton = () => wrapper.find(Button).find({'aria-label': 'Update'}).first();\n-    expect(updateButton().prop('disabled')).toBeTruthy();\n+    expect(wrapper.find(Button).find({'aria-label': 'Update'}).first().prop('disabled')).toBeTruthy();\n+  });\n+\n+  it('should enable the Update button if there are updates that do not require delete and runtime is running - increase disk size', async() => {\n+    const wrapper = component();\n+    await waitOneTickAndUpdate(wrapper);\n+\n+    await pickMainDiskSize(wrapper, getMainDiskSize(wrapper) + 10);\n+    await waitOneTickAndUpdate(wrapper);", "originalCommit": "f1e2a24a6c29b409ede368311b1b5b143b0b4663", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDQxNjY0Ng==", "url": "https://github.com/all-of-us/workbench/pull/4281#discussion_r524416646", "bodyText": "opt: it is possibly worth making a 'click button by aria-label' function a la mustClickCreateButton, especially since you use this multiple times", "author": "als364", "createdAt": "2020-11-16T16:51:06Z", "path": "ui/src/app/pages/analysis/runtime-panel.spec.tsx", "diffHunk": "@@ -319,47 +336,226 @@ describe('RuntimePanel', () => {\n     expect(memoryOptions.map(m => m.text())).toEqual(['7.2', '30', '52']);\n   });\n \n-  it('should toggle the disabled state of the update button when the configuration changes', async() => {\n+  it('should disable the Update button if there are no changes and runtime is running', async() => {\n     const wrapper = component();\n-    await handleUseEffect(wrapper);\n     await waitOneTickAndUpdate(wrapper);\n \n-    const updateButton = () => wrapper.find(Button).find({'aria-label': 'Update'}).first();\n-    expect(updateButton().prop('disabled')).toBeTruthy();\n+    expect(wrapper.find(Button).find({'aria-label': 'Update'}).first().prop('disabled')).toBeTruthy();\n+  });\n+\n+  it('should enable the Update button if there are updates that do not require delete and runtime is running - increase disk size', async() => {\n+    const wrapper = component();\n+    await waitOneTickAndUpdate(wrapper);\n+\n+    await pickMainDiskSize(wrapper, getMainDiskSize(wrapper) + 10);\n+    await waitOneTickAndUpdate(wrapper);\n+    expect(wrapper.find(Button).find({'aria-label': 'Update'}).first().prop('disabled')).toBeFalsy();\n+  });\n+\n+  it('should enable the Update button if there are updates that do not require delete and runtime is running - number of workers', async() => {\n+    const runtime = {...runtimeApiStub.runtime, gceConfig: null, dataprocConfig: mockDataprocConfig, configurationType: RuntimeConfigurationType.UserOverride};\n+    act(() => {runtimeStore.set({runtime: runtime, workspaceNamespace: workspaceStubs[0].namespace}); });\n+\n+    const wrapper = component();\n+    await waitOneTickAndUpdate(wrapper);\n+\n+    await pickNumWorkers(wrapper, getNumWorkers(wrapper) + 2);\n+    await waitOneTickAndUpdate(wrapper);\n+\n+    expect(wrapper.find(Button).find({'aria-label': 'Update'}).first().prop('disabled')).toBeFalsy();\n+  });\n+\n+  it('should enable the Update button if there are updates that do not require delete and runtime is running - number of preemptible workers', async() => {\n+    const runtime = {...runtimeApiStub.runtime, gceConfig: null, dataprocConfig: mockDataprocConfig};\n+    runtimeStore.set({runtime: runtime, workspaceNamespace: workspaceStubs[0].namespace});\n+\n+    const wrapper = component();\n+    await waitOneTickAndUpdate(wrapper);\n+\n+    await pickNumPreemptibleWorkers(wrapper, getNumPreemptibleWorkers(wrapper) + 2);\n+    await waitOneTickAndUpdate(wrapper);\n+\n+    expect(wrapper.find(Button).find({'aria-label': 'Update'}).first().prop('disabled')).toBeFalsy();\n+  });\n+\n+  it('should render the Next button if there are updates that require delete and runtime is running - Compute Type', async() => {\n+    const wrapper = component();\n+    await waitOneTickAndUpdate(wrapper);\n+\n+    await pickComputeType(wrapper, ComputeType.Dataproc);\n+\n+    expect(wrapper.find(Button).find({'aria-label': 'Next'}).first().prop('disabled')).toBeFalsy();\n+  });\n+\n+  it('should render the Next button if there are updates that require delete and runtime is running - CPU', async() => {\n+    const wrapper = component();\n+    await waitOneTickAndUpdate(wrapper);\n+\n+    await pickMainCpu(wrapper, getMainCpu(wrapper) + 4);\n+\n+    expect(wrapper.find(Button).find({'aria-label': 'Next'}).first().prop('disabled')).toBeFalsy();\n+  });\n+\n+  it('should render the Next button if there are updates that require delete and runtime is running - Memory', async() => {\n+    const wrapper = component();\n+    await waitOneTickAndUpdate(wrapper);\n+\n+    // 15 GB -> 26 GB\n+    await pickMainRam(wrapper, 26);\n+\n+    expect(wrapper.find(Button).find({'aria-label': 'Next'}).first().prop('disabled')).toBeFalsy();\n+  });\n+\n+  it('should render the Next button if there are updates that require delete and runtime is running - Decrease Disk', async() => {\n+    const wrapper = component();\n+    await waitOneTickAndUpdate(wrapper);\n+\n+    await pickMainDiskSize(wrapper, getMainDiskSize(wrapper) - 5);\n+    await waitOneTickAndUpdate(wrapper);\n+\n+    expect(wrapper.find(Button).find({'aria-label': 'Next'}).first().prop('disabled')).toBeFalsy();\n+  });\n+\n+  it('should render the Next button if there are updates that require delete and runtime is running - Worker CPU', async() => {\n+    const runtime = {...runtimeApiStub.runtime, gceConfig: null, dataprocConfig: mockDataprocConfig};\n+    runtimeStore.set({runtime: runtime, workspaceNamespace: workspaceStubs[0].namespace});\n+\n+    const wrapper = component();\n+    await waitOneTickAndUpdate(wrapper);\n+\n+    // 4 -> 8\n+    await pickWorkerCpu(wrapper, 8);\n+\n+    expect(wrapper.find(Button).find({'aria-label': 'Next'}).first().prop('disabled')).toBeFalsy();\n+  });\n+\n+  it('should render the Next button if there are updates that require delete and runtime is running - Worker RAM', async() => {\n+    const runtime = {...runtimeApiStub.runtime, gceConfig: null, dataprocConfig: mockDataprocConfig};\n+    runtimeStore.set({runtime: runtime, workspaceNamespace: workspaceStubs[0].namespace});\n+\n+    const wrapper = component();\n+    await waitOneTickAndUpdate(wrapper);\n+\n+    // 15 -> 26\n+    await pickWorkerRam(wrapper, 26);\n+    await waitOneTickAndUpdate(wrapper);\n+\n+    expect(wrapper.find(Button).find({'aria-label': 'Next'}).first().prop('disabled')).toBeFalsy();\n+  });\n+\n+  it('should render the Next button if there are updates that require delete and runtime is running - Worker Disk', async() => {\n+    const runtime = {...runtimeApiStub.runtime, gceConfig: null, dataprocConfig: mockDataprocConfig};\n+    runtimeStore.set({runtime: runtime, workspaceNamespace: workspaceStubs[0].namespace});\n+\n+    const wrapper = component();\n+    await pickWorkerDiskSize(wrapper, getWorkerDiskSize(wrapper) + 10);\n+    await waitOneTickAndUpdate(wrapper);\n+\n+    expect(wrapper.find(Button).find({'aria-label': 'Next'}).first().prop('disabled')).toBeFalsy();\n+  });\n+\n+  it('hitting cancel from the Confirm panel should revert to the edit panel without losing inputs', async() => {\n+    const runtime = {...runtimeApiStub.runtime, gceConfig: null, dataprocConfig: mockDataprocConfig};\n+    runtimeStore.set({runtime: runtime, workspaceNamespace: workspaceStubs[0].namespace});\n+\n+    const wrapper = component();\n+    await waitOneTickAndUpdate(wrapper);\n+\n+    await pickMainDiskSize(wrapper, 75);\n+    await pickMainCpu(wrapper, 8);\n+    await pickMainRam(wrapper, 30);\n+    await pickWorkerCpu(wrapper, 16);\n+    await pickWorkerRam(wrapper, 60);\n+    await pickNumPreemptibleWorkers(wrapper, 3);\n+    await pickNumWorkers(wrapper, 5);\n+    await pickWorkerDiskSize(wrapper, 100);\n+\n+    act(() => {\n+      wrapper.find(Button).find({'aria-label': 'Next'}).first().simulate('click');\n+    });\n+    await waitOneTickAndUpdate(wrapper);\n+\n+    act(() => {\n+      wrapper.find(Button).find({'aria-label': 'Cancel'}).first().simulate('click');\n+    });\n+    await waitOneTickAndUpdate(wrapper);\n+\n+    expect(getMainDiskSize(wrapper)).toBe(75);\n+    expect(getMainCpu(wrapper)).toBe(8);\n+    expect(getMainRam(wrapper)).toBe(30);\n+    expect(getWorkerCpu(wrapper)).toBe(16);\n+    expect(getWorkerRam(wrapper)).toBe(60);\n+    expect(getNumPreemptibleWorkers(wrapper)).toBe(3);\n+    expect(getNumWorkers(wrapper)).toBe(5);\n+    expect(getWorkerDiskSize(wrapper)).toBe(100);\n+  });\n+\n+  it('should disable Update button if Runtime is in between states', async() => {\n+    const runtime = {...runtimeApiStub.runtime, gceConfig: null, dataprocConfig: mockDataprocConfig, status: RuntimeStatus.Creating};\n+    runtimeStore.set({runtime: runtime, workspaceNamespace: workspaceStubs[0].namespace});\n+\n+    const wrapper = component();\n+    await pickMainDiskSize(wrapper, getMainDiskSize(wrapper) + 20);\n+\n+    expect(wrapper.find(Button).find({'aria-label': 'Update'}).first().prop('disabled')).toBeTruthy();\n+  });\n+\n+  it('should send an updateRuntime API call if runtime changes do not require a delete', async() => {\n+    const wrapper = component();\n+    await waitOneTickAndUpdate(wrapper);\n+\n+    const updateSpy = jest.spyOn(runtimeApi(), 'updateRuntime');\n+    const deleteSpy = jest.spyOn(runtimeApi(), 'deleteRuntime');\n+\n+    await pickMainDiskSize(wrapper, getMainDiskSize(wrapper) + 20);\n+\n+    act(() => {", "originalCommit": "f1e2a24a6c29b409ede368311b1b5b143b0b4663", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTU3NjIyNQ==", "url": "https://github.com/all-of-us/workbench/pull/4281#discussion_r525576225", "bodyText": "good idea", "author": "ericsong", "createdAt": "2020-11-17T22:47:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDQxNjY0Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDQxNzIxNQ==", "url": "https://github.com/all-of-us/workbench/pull/4281#discussion_r524417215", "bodyText": "nit: use 'should' language", "author": "als364", "createdAt": "2020-11-16T16:51:47Z", "path": "ui/src/app/pages/analysis/runtime-panel.spec.tsx", "diffHunk": "@@ -319,47 +336,226 @@ describe('RuntimePanel', () => {\n     expect(memoryOptions.map(m => m.text())).toEqual(['7.2', '30', '52']);\n   });\n \n-  it('should toggle the disabled state of the update button when the configuration changes', async() => {\n+  it('should disable the Update button if there are no changes and runtime is running', async() => {\n     const wrapper = component();\n-    await handleUseEffect(wrapper);\n     await waitOneTickAndUpdate(wrapper);\n \n-    const updateButton = () => wrapper.find(Button).find({'aria-label': 'Update'}).first();\n-    expect(updateButton().prop('disabled')).toBeTruthy();\n+    expect(wrapper.find(Button).find({'aria-label': 'Update'}).first().prop('disabled')).toBeTruthy();\n+  });\n+\n+  it('should enable the Update button if there are updates that do not require delete and runtime is running - increase disk size', async() => {\n+    const wrapper = component();\n+    await waitOneTickAndUpdate(wrapper);\n+\n+    await pickMainDiskSize(wrapper, getMainDiskSize(wrapper) + 10);\n+    await waitOneTickAndUpdate(wrapper);\n+    expect(wrapper.find(Button).find({'aria-label': 'Update'}).first().prop('disabled')).toBeFalsy();\n+  });\n+\n+  it('should enable the Update button if there are updates that do not require delete and runtime is running - number of workers', async() => {\n+    const runtime = {...runtimeApiStub.runtime, gceConfig: null, dataprocConfig: mockDataprocConfig, configurationType: RuntimeConfigurationType.UserOverride};\n+    act(() => {runtimeStore.set({runtime: runtime, workspaceNamespace: workspaceStubs[0].namespace}); });\n+\n+    const wrapper = component();\n+    await waitOneTickAndUpdate(wrapper);\n+\n+    await pickNumWorkers(wrapper, getNumWorkers(wrapper) + 2);\n+    await waitOneTickAndUpdate(wrapper);\n+\n+    expect(wrapper.find(Button).find({'aria-label': 'Update'}).first().prop('disabled')).toBeFalsy();\n+  });\n+\n+  it('should enable the Update button if there are updates that do not require delete and runtime is running - number of preemptible workers', async() => {\n+    const runtime = {...runtimeApiStub.runtime, gceConfig: null, dataprocConfig: mockDataprocConfig};\n+    runtimeStore.set({runtime: runtime, workspaceNamespace: workspaceStubs[0].namespace});\n+\n+    const wrapper = component();\n+    await waitOneTickAndUpdate(wrapper);\n+\n+    await pickNumPreemptibleWorkers(wrapper, getNumPreemptibleWorkers(wrapper) + 2);\n+    await waitOneTickAndUpdate(wrapper);\n+\n+    expect(wrapper.find(Button).find({'aria-label': 'Update'}).first().prop('disabled')).toBeFalsy();\n+  });\n+\n+  it('should render the Next button if there are updates that require delete and runtime is running - Compute Type', async() => {\n+    const wrapper = component();\n+    await waitOneTickAndUpdate(wrapper);\n+\n+    await pickComputeType(wrapper, ComputeType.Dataproc);\n+\n+    expect(wrapper.find(Button).find({'aria-label': 'Next'}).first().prop('disabled')).toBeFalsy();\n+  });\n+\n+  it('should render the Next button if there are updates that require delete and runtime is running - CPU', async() => {\n+    const wrapper = component();\n+    await waitOneTickAndUpdate(wrapper);\n+\n+    await pickMainCpu(wrapper, getMainCpu(wrapper) + 4);\n+\n+    expect(wrapper.find(Button).find({'aria-label': 'Next'}).first().prop('disabled')).toBeFalsy();\n+  });\n+\n+  it('should render the Next button if there are updates that require delete and runtime is running - Memory', async() => {\n+    const wrapper = component();\n+    await waitOneTickAndUpdate(wrapper);\n+\n+    // 15 GB -> 26 GB\n+    await pickMainRam(wrapper, 26);\n+\n+    expect(wrapper.find(Button).find({'aria-label': 'Next'}).first().prop('disabled')).toBeFalsy();\n+  });\n+\n+  it('should render the Next button if there are updates that require delete and runtime is running - Decrease Disk', async() => {\n+    const wrapper = component();\n+    await waitOneTickAndUpdate(wrapper);\n+\n+    await pickMainDiskSize(wrapper, getMainDiskSize(wrapper) - 5);\n+    await waitOneTickAndUpdate(wrapper);\n+\n+    expect(wrapper.find(Button).find({'aria-label': 'Next'}).first().prop('disabled')).toBeFalsy();\n+  });\n+\n+  it('should render the Next button if there are updates that require delete and runtime is running - Worker CPU', async() => {\n+    const runtime = {...runtimeApiStub.runtime, gceConfig: null, dataprocConfig: mockDataprocConfig};\n+    runtimeStore.set({runtime: runtime, workspaceNamespace: workspaceStubs[0].namespace});\n+\n+    const wrapper = component();\n+    await waitOneTickAndUpdate(wrapper);\n+\n+    // 4 -> 8\n+    await pickWorkerCpu(wrapper, 8);\n+\n+    expect(wrapper.find(Button).find({'aria-label': 'Next'}).first().prop('disabled')).toBeFalsy();\n+  });\n+\n+  it('should render the Next button if there are updates that require delete and runtime is running - Worker RAM', async() => {\n+    const runtime = {...runtimeApiStub.runtime, gceConfig: null, dataprocConfig: mockDataprocConfig};\n+    runtimeStore.set({runtime: runtime, workspaceNamespace: workspaceStubs[0].namespace});\n+\n+    const wrapper = component();\n+    await waitOneTickAndUpdate(wrapper);\n+\n+    // 15 -> 26\n+    await pickWorkerRam(wrapper, 26);\n+    await waitOneTickAndUpdate(wrapper);\n+\n+    expect(wrapper.find(Button).find({'aria-label': 'Next'}).first().prop('disabled')).toBeFalsy();\n+  });\n+\n+  it('should render the Next button if there are updates that require delete and runtime is running - Worker Disk', async() => {\n+    const runtime = {...runtimeApiStub.runtime, gceConfig: null, dataprocConfig: mockDataprocConfig};\n+    runtimeStore.set({runtime: runtime, workspaceNamespace: workspaceStubs[0].namespace});\n+\n+    const wrapper = component();\n+    await pickWorkerDiskSize(wrapper, getWorkerDiskSize(wrapper) + 10);\n+    await waitOneTickAndUpdate(wrapper);\n+\n+    expect(wrapper.find(Button).find({'aria-label': 'Next'}).first().prop('disabled')).toBeFalsy();\n+  });\n+\n+  it('hitting cancel from the Confirm panel should revert to the edit panel without losing inputs', async() => {\n+    const runtime = {...runtimeApiStub.runtime, gceConfig: null, dataprocConfig: mockDataprocConfig};\n+    runtimeStore.set({runtime: runtime, workspaceNamespace: workspaceStubs[0].namespace});\n+\n+    const wrapper = component();\n+    await waitOneTickAndUpdate(wrapper);\n+\n+    await pickMainDiskSize(wrapper, 75);\n+    await pickMainCpu(wrapper, 8);\n+    await pickMainRam(wrapper, 30);\n+    await pickWorkerCpu(wrapper, 16);\n+    await pickWorkerRam(wrapper, 60);\n+    await pickNumPreemptibleWorkers(wrapper, 3);\n+    await pickNumWorkers(wrapper, 5);\n+    await pickWorkerDiskSize(wrapper, 100);\n+\n+    act(() => {\n+      wrapper.find(Button).find({'aria-label': 'Next'}).first().simulate('click');\n+    });\n+    await waitOneTickAndUpdate(wrapper);\n+\n+    act(() => {\n+      wrapper.find(Button).find({'aria-label': 'Cancel'}).first().simulate('click');\n+    });\n+    await waitOneTickAndUpdate(wrapper);\n+\n+    expect(getMainDiskSize(wrapper)).toBe(75);\n+    expect(getMainCpu(wrapper)).toBe(8);\n+    expect(getMainRam(wrapper)).toBe(30);\n+    expect(getWorkerCpu(wrapper)).toBe(16);\n+    expect(getWorkerRam(wrapper)).toBe(60);\n+    expect(getNumPreemptibleWorkers(wrapper)).toBe(3);\n+    expect(getNumWorkers(wrapper)).toBe(5);\n+    expect(getWorkerDiskSize(wrapper)).toBe(100);\n+  });\n+\n+  it('should disable Update button if Runtime is in between states', async() => {\n+    const runtime = {...runtimeApiStub.runtime, gceConfig: null, dataprocConfig: mockDataprocConfig, status: RuntimeStatus.Creating};\n+    runtimeStore.set({runtime: runtime, workspaceNamespace: workspaceStubs[0].namespace});\n+\n+    const wrapper = component();\n+    await pickMainDiskSize(wrapper, getMainDiskSize(wrapper) + 20);\n+\n+    expect(wrapper.find(Button).find({'aria-label': 'Update'}).first().prop('disabled')).toBeTruthy();\n+  });\n+\n+  it('should send an updateRuntime API call if runtime changes do not require a delete', async() => {\n+    const wrapper = component();\n+    await waitOneTickAndUpdate(wrapper);\n+\n+    const updateSpy = jest.spyOn(runtimeApi(), 'updateRuntime');\n+    const deleteSpy = jest.spyOn(runtimeApi(), 'deleteRuntime');\n+\n+    await pickMainDiskSize(wrapper, getMainDiskSize(wrapper) + 20);\n+\n+    act(() => {\n+      wrapper.find(Button).find({'aria-label': 'Update'}).first().simulate('click');\n+    });\n+    await waitOneTickAndUpdate(wrapper);\n+\n+    expect(updateSpy).toHaveBeenCalled();\n+    expect(deleteSpy).toHaveBeenCalledTimes(0);\n+  });\n+\n+  it('should send a delete call if an update requires delete', async() => {\n+    const wrapper = component();\n+    await waitOneTickAndUpdate(wrapper);\n+\n+    const spy = jest.spyOn(runtimeApi(), 'deleteRuntime');\n \n     wrapper.find('#runtime-cpu .p-dropdown').first().simulate('click');\n-    wrapper.find('.p-dropdown-item').find({'aria-label': 8}).first().simulate('click');\n-    expect(updateButton().prop('disabled')).toBeFalsy();\n \n-    wrapper.find('#runtime-ram').first().find('.p-dropdown-item').first().simulate('click');\n-    wrapper.find('.p-dropdown-item').find({'aria-label': 4}).first().simulate('click');\n-    expect(updateButton().prop('disabled')).toBeTruthy();\n+    act(() => {\n+      wrapper.find('.p-dropdown-item').find({'aria-label': 8}).first().simulate('click');\n+    });\n+    await waitOneTickAndUpdate(wrapper);\n \n-    wrapper.find('#runtime-ram .p-dropdown').first().simulate('click');\n-    wrapper.find('.p-dropdown-item').find({'aria-label': 26}).first().simulate('click');\n-    expect(updateButton().prop('disabled')).toBeFalsy();\n+    act(() => {\n+      wrapper.find(Button).find({'aria-label': 'Next'}).first().simulate('click');\n+    });\n+    await waitOneTickAndUpdate(wrapper);\n \n-    wrapper.find('#runtime-ram .p-dropdown').first().simulate('click');\n-    wrapper.find('.p-dropdown-item').find({'aria-label': 15}).first().simulate('click');\n-    expect(updateButton().prop('disabled')).toBeTruthy();\n+    act(() => {\n+      wrapper.find(Button).find({'aria-label': 'Update'}).first().simulate('click');\n+    });\n+    await waitOneTickAndUpdate(wrapper);\n \n-    wrapper.find('#runtime-ram .p-dropdown').first().simulate('click');\n-    wrapper.find('.p-dropdown-item').find({'aria-label': 15}).first().simulate('click');\n-    expect(updateButton().prop('disabled')).toBeTruthy();\n+    expect(spy).toHaveBeenCalled();\n+  });\n \n-    wrapper.find('#runtime-compute .p-dropdown').first().simulate('click');\n-    wrapper.find('.p-dropdown-item').find({'aria-label': 'Dataproc Cluster'}).first().simulate('click');\n-    expect(updateButton().prop('disabled')).toBeFalsy();\n+  it('create button is shown if runtime is deleted', async() => {", "originalCommit": "f1e2a24a6c29b409ede368311b1b5b143b0b4663", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDQ0MzUyOA==", "url": "https://github.com/all-of-us/workbench/pull/4281#discussion_r524443528", "bodyText": "What does this name mean?", "author": "als364", "createdAt": "2020-11-16T17:25:49Z", "path": "ui/src/app/utils/leo-runtime-initializer.tsx", "diffHunk": "@@ -83,6 +83,7 @@ export interface LeoRuntimeInitializerOptions {\n   maxResumeCount?: number;\n   maxServerErrorCount?: number;\n   targetRuntime?: Runtime;\n+  resolutionCond?: (Runtime) => boolean;", "originalCommit": "ff2c0c74b0b1330024040ccc107ab732dfa4bd9a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTU4MDIzOQ==", "url": "https://github.com/all-of-us/workbench/pull/4281#discussion_r525580239", "bodyText": "it's a function that must return true in order for the polling to \"resolve\" and exit. I added it so we can resolve on conditions other than just \"== Running\"", "author": "ericsong", "createdAt": "2020-11-17T22:55:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDQ0MzUyOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjE4NjcyNA==", "url": "https://github.com/all-of-us/workbench/pull/4281#discussion_r526186724", "bodyText": "hm, hard to name something like that. Perhaps something like stopPollingPredicate?", "author": "als364", "createdAt": "2020-11-18T15:40:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDQ0MzUyOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDQ4NTcxMQ==", "url": "https://github.com/all-of-us/workbench/pull/4281#discussion_r524485711", "bodyText": "Does this interact strangely with the call on L374?", "author": "als364", "createdAt": "2020-11-16T18:32:08Z", "path": "ui/src/app/utils/runtime-utils.tsx", "diffHunk": "@@ -133,11 +344,33 @@ export const useCustomRuntime = (currentWorkspaceNamespace):\n       // TODO: It is likely more correct here to use the LeoRuntimeInitializer wait for the runtime\n       // to reach a terminal status before attempting deletion.\n       try {\n-        if (runtime && runtime.status !== RuntimeStatus.Deleted) {\n-          await runtimeApi().deleteRuntime(currentWorkspaceNamespace, {\n-            signal: aborter.signal\n-          });\n+        if (runtime) {\n+          const runtimeDiffTypes = getRuntimeDiffs(runtime, requestedRuntime).map(diff => diff.differenceType);\n+\n+          if (runtimeDiffTypes.includes(RuntimeDiffState.NEEDS_DELETE)) {\n+            if (runtime.status !== RuntimeStatus.Deleted) {\n+              await runtimeApi().deleteRuntime(currentWorkspaceNamespace, {\n+                signal: aborter.signal\n+              });\n+            }\n+          } else if (runtimeDiffTypes.includes(RuntimeDiffState.CAN_UPDATE)) {\n+            if (runtime.status === RuntimeStatus.Running || runtime.status === RuntimeStatus.Stopped) {\n+              await runtimeApi().updateRuntime(currentWorkspaceNamespace, {runtime: requestedRuntime});\n+              // Calling updateRuntime will not immediately set the Runtime status to not Running so the\n+              // default initializer will resolve on its first call. The polling below first checks for the\n+              // non Running status before initializing the default one that checks for Running status\n+              await LeoRuntimeInitializer.initialize({", "originalCommit": "ff2c0c74b0b1330024040ccc107ab732dfa4bd9a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTU4Mjk5Nw==", "url": "https://github.com/all-of-us/workbench/pull/4281#discussion_r525582997", "bodyText": "the initializer on  L374 should only start after this one has completed. (intentionally)", "author": "ericsong", "createdAt": "2020-11-17T23:01:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDQ4NTcxMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDQ5MzYzMQ==", "url": "https://github.com/all-of-us/workbench/pull/4281#discussion_r524493631", "bodyText": "Hm, how is this one not exported, but getRuntimeConfigDiffs is? Isn't this backwards?", "author": "calbach", "createdAt": "2020-11-16T18:45:17Z", "path": "ui/src/app/utils/runtime-utils.tsx", "diffHunk": "@@ -1,29 +1,240 @@\n import {runtimeApi} from 'app/services/swagger-fetch-clients';\n-import {switchCase} from 'app/utils';\n-import { withAsyncErrorHandling } from 'app/utils';\n-import {\n-  ExceededActionCountError,\n-  LeoRuntimeInitializationAbortedError,\n-  LeoRuntimeInitializer,\n-} from 'app/utils/leo-runtime-initializer';\n-import {\n-  compoundRuntimeOpStore,\n-  markCompoundRuntimeOperationCompleted,\n-  registerCompoundRuntimeOperation,\n-  runtimeStore,\n-  useStore\n-} from 'app/utils/stores';\n-import {Runtime, RuntimeStatus} from 'generated/fetch';\n+import {switchCase, withAsyncErrorHandling} from 'app/utils';\n+import {ExceededActionCountError, LeoRuntimeInitializationAbortedError, LeoRuntimeInitializer, } from 'app/utils/leo-runtime-initializer';\n+import {compoundRuntimeOpStore, markCompoundRuntimeOperationCompleted, registerCompoundRuntimeOperation, runtimeStore, useStore} from 'app/utils/stores';\n+import {DataprocConfig, Runtime, RuntimeStatus} from 'generated/fetch';\n import * as fp from 'lodash/fp';\n \n import * as React from 'react';\n+import {ComputeType, findMachineByName, Machine} from './machines';\n \n const {useState, useEffect} = React;\n \n export enum RuntimeStatusRequest {\n   Delete = 'Delete'\n }\n \n+export interface RuntimeDiff {\n+  desc: string;\n+  previous: string;\n+  new: string;\n+  differenceType: RuntimeDiffState;\n+}\n+\n+export enum RuntimeDiffState {\n+  NO_CHANGE,\n+  CAN_UPDATE,\n+  NEEDS_DELETE\n+}\n+\n+export interface RuntimeConfig {\n+  computeType: ComputeType;\n+  machine: Machine;\n+  diskSize: number;\n+  dataprocConfig: DataprocConfig;\n+}\n+\n+function compareComputeTypes(oldRuntime: RuntimeConfig, newRuntime: RuntimeConfig): RuntimeDiff {\n+  return {\n+    desc: 'Change Compute Type',\n+    previous: oldRuntime.computeType,\n+    new: newRuntime.computeType,\n+    differenceType: oldRuntime.computeType === newRuntime.computeType ?\n+      RuntimeDiffState.NO_CHANGE : RuntimeDiffState.NEEDS_DELETE\n+  };\n+}\n+\n+function compareMachineCpu(oldRuntime: RuntimeConfig, newRuntime: RuntimeConfig): RuntimeDiff {\n+  const oldCpu = oldRuntime.machine.cpu;\n+  const newCpu = newRuntime.machine.cpu;\n+\n+  return {\n+    desc: (newCpu < oldCpu ?  'Decrease' : 'Increase') + ' Number of CPUs',\n+    previous: oldCpu.toString(),\n+    new: newCpu.toString(),\n+    differenceType: oldCpu === newCpu ? RuntimeDiffState.NO_CHANGE : RuntimeDiffState.NEEDS_DELETE\n+  };\n+}\n+\n+function compareMachineMemory(oldRuntime: RuntimeConfig, newRuntime: RuntimeConfig): RuntimeDiff {\n+  const oldMemory = oldRuntime.machine.memory;\n+  const newMemory = newRuntime.machine.memory;\n+\n+  return {\n+    desc: (newMemory < oldMemory ?  'Decrease' : 'Increase') + ' Memory',\n+    previous: oldMemory.toString() + ' GB',\n+    new: newMemory.toString() + ' GB',\n+    differenceType: oldMemory === newMemory ? RuntimeDiffState.NO_CHANGE : RuntimeDiffState.NEEDS_DELETE\n+  };\n+}\n+\n+function compareDiskSize(oldRuntime: RuntimeConfig, newRuntime: RuntimeConfig): RuntimeDiff {\n+  let desc = 'Disk Size';\n+  let diffType;\n+\n+  if (newRuntime.diskSize < oldRuntime.diskSize) {\n+    desc = 'Decease ' + desc;\n+    diffType = RuntimeDiffState.NEEDS_DELETE;\n+  } else if (newRuntime.diskSize > oldRuntime.diskSize) {\n+    desc = 'Increase ' + desc;\n+    diffType = RuntimeDiffState.CAN_UPDATE;\n+  } else {\n+    diffType = RuntimeDiffState.NO_CHANGE;\n+  }\n+\n+  return {\n+    desc: desc,\n+    previous: oldRuntime.diskSize.toString() + ' GB',\n+    new: newRuntime.diskSize.toString() + ' GB',\n+    differenceType: diffType\n+  };\n+}\n+\n+function compareDataprocMasterDiskSize(oldRuntime: RuntimeConfig, newRuntime: RuntimeConfig): RuntimeDiff {\n+  if (oldRuntime.dataprocConfig === null || newRuntime.dataprocConfig === null) {\n+    return null;\n+  }\n+\n+  const oldDiskSize = oldRuntime.dataprocConfig.masterDiskSize || 0;\n+  const newDiskSize = newRuntime.dataprocConfig.masterDiskSize || 0;\n+\n+  let desc = 'Dataproc Master Machine Disk Size';\n+  let diffType;\n+\n+  if (newDiskSize < oldDiskSize) {\n+    desc = 'Decease ' + desc;\n+    diffType = RuntimeDiffState.NEEDS_DELETE;\n+  } else if (newDiskSize > oldDiskSize) {\n+    desc = 'Increase ' + desc;\n+    diffType = RuntimeDiffState.CAN_UPDATE;\n+  } else {\n+    diffType = RuntimeDiffState.NO_CHANGE;\n+  }\n+\n+  return {\n+    desc: desc,\n+    previous: oldDiskSize.toString() + ' GB',\n+    new: newDiskSize.toString() + ' GB',\n+    differenceType: diffType\n+  };\n+}\n+\n+function compareWorkerCpu(oldRuntime: RuntimeConfig, newRuntime: RuntimeConfig): RuntimeDiff {\n+  if (!oldRuntime.dataprocConfig || !newRuntime.dataprocConfig) {\n+    return null;\n+  }\n+\n+  const oldCpu = findMachineByName(oldRuntime.dataprocConfig.workerMachineType).cpu;\n+  const newCpu = findMachineByName(newRuntime.dataprocConfig.workerMachineType).cpu;\n+\n+  return {\n+    desc: (newCpu < oldCpu ?  'Decrease' : 'Increase') + ' Number of CPUs',\n+    previous: oldCpu.toString(),\n+    new: newCpu.toString(),\n+    differenceType: oldCpu === newCpu ? RuntimeDiffState.NO_CHANGE : RuntimeDiffState.NEEDS_DELETE\n+  };\n+}\n+\n+function compareWorkerMemory(oldRuntime: RuntimeConfig, newRuntime: RuntimeConfig): RuntimeDiff {\n+  if (!oldRuntime.dataprocConfig || !newRuntime.dataprocConfig) {\n+    return null;\n+  }\n+\n+  const oldMemory = findMachineByName(oldRuntime.dataprocConfig.workerMachineType).memory;\n+  const newMemory = findMachineByName(newRuntime.dataprocConfig.workerMachineType).memory;\n+\n+  return {\n+    desc: (newMemory < oldMemory ?  'Decrease' : 'Increase') + ' Memory',\n+    previous: oldMemory.toString() + ' GB',\n+    new: newMemory.toString() + ' GB',\n+    differenceType: oldMemory === newMemory ? RuntimeDiffState.NO_CHANGE : RuntimeDiffState.NEEDS_DELETE\n+  };\n+}\n+\n+\n+function compareDataprocWorkerDiskSize(oldRuntime: RuntimeConfig, newRuntime: RuntimeConfig): RuntimeDiff {\n+  if (oldRuntime.dataprocConfig === null || newRuntime.dataprocConfig === null) {\n+    return null;\n+  }\n+\n+  const oldDiskSize = oldRuntime.dataprocConfig.workerDiskSize || 0;\n+  const newDiskSize = newRuntime.dataprocConfig.workerDiskSize || 0;\n+\n+  return {\n+    desc: (newDiskSize < oldDiskSize ?  'Decrease' : 'Increase') + ' Change Worker Machine Type',\n+    previous: oldDiskSize.toString() + ' GB',\n+    new: newDiskSize.toString() + ' GB',\n+    differenceType: oldDiskSize === newDiskSize ?\n+      RuntimeDiffState.NO_CHANGE : RuntimeDiffState.NEEDS_DELETE\n+  };\n+}\n+\n+function compareDataprocNumberOfPreemptibleWorkers(oldRuntime: RuntimeConfig, newRuntime: RuntimeConfig): RuntimeDiff {\n+  if (oldRuntime.dataprocConfig === null || newRuntime.dataprocConfig === null) {\n+    return null;\n+  }\n+\n+  const oldNumWorkers = oldRuntime.dataprocConfig.numberOfPreemptibleWorkers || 0;\n+  const newNumWorkers = newRuntime.dataprocConfig.numberOfPreemptibleWorkers || 0;\n+\n+  return {\n+    desc: (newNumWorkers < oldNumWorkers ?  'Decrease' : 'Increase') + ' Number of Preemptible Workers',\n+    previous: oldNumWorkers.toString(),\n+    new: newNumWorkers.toString(),\n+    differenceType: oldNumWorkers === newNumWorkers ?\n+      RuntimeDiffState.NO_CHANGE : RuntimeDiffState.CAN_UPDATE\n+  };\n+}\n+\n+function compareDataprocNumberOfWorkers(oldRuntime: RuntimeConfig, newRuntime: RuntimeConfig): RuntimeDiff {\n+  if (oldRuntime.dataprocConfig === null || newRuntime.dataprocConfig === null) {\n+    return null;\n+  }\n+\n+  const oldNumWorkers = oldRuntime.dataprocConfig.numberOfWorkers || 0;\n+  const newNumWorkers = newRuntime.dataprocConfig.numberOfWorkers || 0;\n+\n+  return {\n+    desc: (newNumWorkers < oldNumWorkers ?  'Decrease' : 'Increase') + ' Number of Workers',\n+    previous: oldNumWorkers.toString(),\n+    new: newNumWorkers.toString(),\n+    differenceType: oldNumWorkers === newNumWorkers ?\n+      RuntimeDiffState.NO_CHANGE : RuntimeDiffState.CAN_UPDATE\n+  };\n+}\n+\n+export const getRuntimeConfigDiffs = (oldRuntime: RuntimeConfig, newRuntime: RuntimeConfig): RuntimeDiff[] => {\n+  const compareFns = [compareComputeTypes, compareDiskSize, compareMachineCpu,\n+    compareMachineMemory, compareDataprocMasterDiskSize, compareWorkerCpu, compareWorkerMemory,\n+    compareDataprocNumberOfPreemptibleWorkers, compareDataprocNumberOfWorkers, compareDataprocWorkerDiskSize];\n+\n+  return compareFns.map(compareFn => compareFn(oldRuntime, newRuntime))\n+    .filter(diff => diff !== null)\n+    .filter(diff => diff.differenceType !== RuntimeDiffState.NO_CHANGE);\n+};\n+\n+function getRuntimeDiffs(oldRuntime: Runtime, newRuntime: Runtime): RuntimeDiff[] {", "originalCommit": "ff2c0c74b0b1330024040ccc107ab732dfa4bd9a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjI0ODE0NA==", "url": "https://github.com/all-of-us/workbench/pull/4281#discussion_r526248144", "bodyText": "I export getRuntimeConfigDiffs because the RuntimeConfig object is easier to use in the UI. The Runtime diff function was actually only created because I don't have access to the RuntimeConfig object within the useCustomRuntime so I had to find a way to map between the two.", "author": "ericsong", "createdAt": "2020-11-18T16:55:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDQ5MzYzMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDQ5NTE2Mw==", "url": "https://github.com/all-of-us/workbench/pull/4281#discussion_r524495163", "bodyText": "nit: A tree structure of these functions might be slightly easier to follow here IMO. e.g.\ncompareRuntimeConfigs():\n  return [...compareMachines(), ...compareCompute(), ...compareDataproc()]\n\ncompareMachines():\n  return [compareCpu(), compareMemory()]\n\netc...", "author": "calbach", "createdAt": "2020-11-16T18:47:41Z", "path": "ui/src/app/utils/runtime-utils.tsx", "diffHunk": "@@ -1,29 +1,240 @@\n import {runtimeApi} from 'app/services/swagger-fetch-clients';\n-import {switchCase} from 'app/utils';\n-import { withAsyncErrorHandling } from 'app/utils';\n-import {\n-  ExceededActionCountError,\n-  LeoRuntimeInitializationAbortedError,\n-  LeoRuntimeInitializer,\n-} from 'app/utils/leo-runtime-initializer';\n-import {\n-  compoundRuntimeOpStore,\n-  markCompoundRuntimeOperationCompleted,\n-  registerCompoundRuntimeOperation,\n-  runtimeStore,\n-  useStore\n-} from 'app/utils/stores';\n-import {Runtime, RuntimeStatus} from 'generated/fetch';\n+import {switchCase, withAsyncErrorHandling} from 'app/utils';\n+import {ExceededActionCountError, LeoRuntimeInitializationAbortedError, LeoRuntimeInitializer, } from 'app/utils/leo-runtime-initializer';\n+import {compoundRuntimeOpStore, markCompoundRuntimeOperationCompleted, registerCompoundRuntimeOperation, runtimeStore, useStore} from 'app/utils/stores';\n+import {DataprocConfig, Runtime, RuntimeStatus} from 'generated/fetch';\n import * as fp from 'lodash/fp';\n \n import * as React from 'react';\n+import {ComputeType, findMachineByName, Machine} from './machines';\n \n const {useState, useEffect} = React;\n \n export enum RuntimeStatusRequest {\n   Delete = 'Delete'\n }\n \n+export interface RuntimeDiff {\n+  desc: string;\n+  previous: string;\n+  new: string;\n+  differenceType: RuntimeDiffState;\n+}\n+\n+export enum RuntimeDiffState {\n+  NO_CHANGE,\n+  CAN_UPDATE,\n+  NEEDS_DELETE\n+}\n+\n+export interface RuntimeConfig {\n+  computeType: ComputeType;\n+  machine: Machine;\n+  diskSize: number;\n+  dataprocConfig: DataprocConfig;\n+}\n+\n+function compareComputeTypes(oldRuntime: RuntimeConfig, newRuntime: RuntimeConfig): RuntimeDiff {\n+  return {\n+    desc: 'Change Compute Type',\n+    previous: oldRuntime.computeType,\n+    new: newRuntime.computeType,\n+    differenceType: oldRuntime.computeType === newRuntime.computeType ?\n+      RuntimeDiffState.NO_CHANGE : RuntimeDiffState.NEEDS_DELETE\n+  };\n+}\n+\n+function compareMachineCpu(oldRuntime: RuntimeConfig, newRuntime: RuntimeConfig): RuntimeDiff {\n+  const oldCpu = oldRuntime.machine.cpu;\n+  const newCpu = newRuntime.machine.cpu;\n+\n+  return {\n+    desc: (newCpu < oldCpu ?  'Decrease' : 'Increase') + ' Number of CPUs',\n+    previous: oldCpu.toString(),\n+    new: newCpu.toString(),\n+    differenceType: oldCpu === newCpu ? RuntimeDiffState.NO_CHANGE : RuntimeDiffState.NEEDS_DELETE\n+  };\n+}\n+\n+function compareMachineMemory(oldRuntime: RuntimeConfig, newRuntime: RuntimeConfig): RuntimeDiff {\n+  const oldMemory = oldRuntime.machine.memory;\n+  const newMemory = newRuntime.machine.memory;\n+\n+  return {\n+    desc: (newMemory < oldMemory ?  'Decrease' : 'Increase') + ' Memory',\n+    previous: oldMemory.toString() + ' GB',\n+    new: newMemory.toString() + ' GB',\n+    differenceType: oldMemory === newMemory ? RuntimeDiffState.NO_CHANGE : RuntimeDiffState.NEEDS_DELETE\n+  };\n+}\n+\n+function compareDiskSize(oldRuntime: RuntimeConfig, newRuntime: RuntimeConfig): RuntimeDiff {\n+  let desc = 'Disk Size';\n+  let diffType;\n+\n+  if (newRuntime.diskSize < oldRuntime.diskSize) {\n+    desc = 'Decease ' + desc;\n+    diffType = RuntimeDiffState.NEEDS_DELETE;\n+  } else if (newRuntime.diskSize > oldRuntime.diskSize) {\n+    desc = 'Increase ' + desc;\n+    diffType = RuntimeDiffState.CAN_UPDATE;\n+  } else {\n+    diffType = RuntimeDiffState.NO_CHANGE;\n+  }\n+\n+  return {\n+    desc: desc,\n+    previous: oldRuntime.diskSize.toString() + ' GB',\n+    new: newRuntime.diskSize.toString() + ' GB',\n+    differenceType: diffType\n+  };\n+}\n+\n+function compareDataprocMasterDiskSize(oldRuntime: RuntimeConfig, newRuntime: RuntimeConfig): RuntimeDiff {\n+  if (oldRuntime.dataprocConfig === null || newRuntime.dataprocConfig === null) {\n+    return null;\n+  }\n+\n+  const oldDiskSize = oldRuntime.dataprocConfig.masterDiskSize || 0;\n+  const newDiskSize = newRuntime.dataprocConfig.masterDiskSize || 0;\n+\n+  let desc = 'Dataproc Master Machine Disk Size';\n+  let diffType;\n+\n+  if (newDiskSize < oldDiskSize) {\n+    desc = 'Decease ' + desc;\n+    diffType = RuntimeDiffState.NEEDS_DELETE;\n+  } else if (newDiskSize > oldDiskSize) {\n+    desc = 'Increase ' + desc;\n+    diffType = RuntimeDiffState.CAN_UPDATE;\n+  } else {\n+    diffType = RuntimeDiffState.NO_CHANGE;\n+  }\n+\n+  return {\n+    desc: desc,\n+    previous: oldDiskSize.toString() + ' GB',\n+    new: newDiskSize.toString() + ' GB',\n+    differenceType: diffType\n+  };\n+}\n+\n+function compareWorkerCpu(oldRuntime: RuntimeConfig, newRuntime: RuntimeConfig): RuntimeDiff {\n+  if (!oldRuntime.dataprocConfig || !newRuntime.dataprocConfig) {\n+    return null;\n+  }\n+\n+  const oldCpu = findMachineByName(oldRuntime.dataprocConfig.workerMachineType).cpu;\n+  const newCpu = findMachineByName(newRuntime.dataprocConfig.workerMachineType).cpu;\n+\n+  return {\n+    desc: (newCpu < oldCpu ?  'Decrease' : 'Increase') + ' Number of CPUs',\n+    previous: oldCpu.toString(),\n+    new: newCpu.toString(),\n+    differenceType: oldCpu === newCpu ? RuntimeDiffState.NO_CHANGE : RuntimeDiffState.NEEDS_DELETE\n+  };\n+}\n+\n+function compareWorkerMemory(oldRuntime: RuntimeConfig, newRuntime: RuntimeConfig): RuntimeDiff {\n+  if (!oldRuntime.dataprocConfig || !newRuntime.dataprocConfig) {\n+    return null;\n+  }\n+\n+  const oldMemory = findMachineByName(oldRuntime.dataprocConfig.workerMachineType).memory;\n+  const newMemory = findMachineByName(newRuntime.dataprocConfig.workerMachineType).memory;\n+\n+  return {\n+    desc: (newMemory < oldMemory ?  'Decrease' : 'Increase') + ' Memory',\n+    previous: oldMemory.toString() + ' GB',\n+    new: newMemory.toString() + ' GB',\n+    differenceType: oldMemory === newMemory ? RuntimeDiffState.NO_CHANGE : RuntimeDiffState.NEEDS_DELETE\n+  };\n+}\n+\n+\n+function compareDataprocWorkerDiskSize(oldRuntime: RuntimeConfig, newRuntime: RuntimeConfig): RuntimeDiff {\n+  if (oldRuntime.dataprocConfig === null || newRuntime.dataprocConfig === null) {\n+    return null;\n+  }\n+\n+  const oldDiskSize = oldRuntime.dataprocConfig.workerDiskSize || 0;\n+  const newDiskSize = newRuntime.dataprocConfig.workerDiskSize || 0;\n+\n+  return {\n+    desc: (newDiskSize < oldDiskSize ?  'Decrease' : 'Increase') + ' Change Worker Machine Type',\n+    previous: oldDiskSize.toString() + ' GB',\n+    new: newDiskSize.toString() + ' GB',\n+    differenceType: oldDiskSize === newDiskSize ?\n+      RuntimeDiffState.NO_CHANGE : RuntimeDiffState.NEEDS_DELETE\n+  };\n+}\n+\n+function compareDataprocNumberOfPreemptibleWorkers(oldRuntime: RuntimeConfig, newRuntime: RuntimeConfig): RuntimeDiff {\n+  if (oldRuntime.dataprocConfig === null || newRuntime.dataprocConfig === null) {\n+    return null;\n+  }\n+\n+  const oldNumWorkers = oldRuntime.dataprocConfig.numberOfPreemptibleWorkers || 0;\n+  const newNumWorkers = newRuntime.dataprocConfig.numberOfPreemptibleWorkers || 0;\n+\n+  return {\n+    desc: (newNumWorkers < oldNumWorkers ?  'Decrease' : 'Increase') + ' Number of Preemptible Workers',\n+    previous: oldNumWorkers.toString(),\n+    new: newNumWorkers.toString(),\n+    differenceType: oldNumWorkers === newNumWorkers ?\n+      RuntimeDiffState.NO_CHANGE : RuntimeDiffState.CAN_UPDATE\n+  };\n+}\n+\n+function compareDataprocNumberOfWorkers(oldRuntime: RuntimeConfig, newRuntime: RuntimeConfig): RuntimeDiff {\n+  if (oldRuntime.dataprocConfig === null || newRuntime.dataprocConfig === null) {\n+    return null;\n+  }\n+\n+  const oldNumWorkers = oldRuntime.dataprocConfig.numberOfWorkers || 0;\n+  const newNumWorkers = newRuntime.dataprocConfig.numberOfWorkers || 0;\n+\n+  return {\n+    desc: (newNumWorkers < oldNumWorkers ?  'Decrease' : 'Increase') + ' Number of Workers',\n+    previous: oldNumWorkers.toString(),\n+    new: newNumWorkers.toString(),\n+    differenceType: oldNumWorkers === newNumWorkers ?\n+      RuntimeDiffState.NO_CHANGE : RuntimeDiffState.CAN_UPDATE\n+  };\n+}\n+\n+export const getRuntimeConfigDiffs = (oldRuntime: RuntimeConfig, newRuntime: RuntimeConfig): RuntimeDiff[] => {\n+  const compareFns = [compareComputeTypes, compareDiskSize, compareMachineCpu,", "originalCommit": "ff2c0c74b0b1330024040ccc107ab732dfa4bd9a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjI0NTgxNQ==", "url": "https://github.com/all-of-us/workbench/pull/4281#discussion_r526245815", "bodyText": "not sure if I did quite what you were looking for but I split it up into two lists", "author": "ericsong", "createdAt": "2020-11-18T16:53:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDQ5NTE2Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDQ5NzA1NA==", "url": "https://github.com/all-of-us/workbench/pull/4281#discussion_r524497054", "bodyText": "There's a good amount of duplication between some of these, e.g. standard and preemtible where you could probably share most of the implementation and just pass an extra label through", "author": "calbach", "createdAt": "2020-11-16T18:50:47Z", "path": "ui/src/app/utils/runtime-utils.tsx", "diffHunk": "@@ -1,29 +1,240 @@\n import {runtimeApi} from 'app/services/swagger-fetch-clients';\n-import {switchCase} from 'app/utils';\n-import { withAsyncErrorHandling } from 'app/utils';\n-import {\n-  ExceededActionCountError,\n-  LeoRuntimeInitializationAbortedError,\n-  LeoRuntimeInitializer,\n-} from 'app/utils/leo-runtime-initializer';\n-import {\n-  compoundRuntimeOpStore,\n-  markCompoundRuntimeOperationCompleted,\n-  registerCompoundRuntimeOperation,\n-  runtimeStore,\n-  useStore\n-} from 'app/utils/stores';\n-import {Runtime, RuntimeStatus} from 'generated/fetch';\n+import {switchCase, withAsyncErrorHandling} from 'app/utils';\n+import {ExceededActionCountError, LeoRuntimeInitializationAbortedError, LeoRuntimeInitializer, } from 'app/utils/leo-runtime-initializer';\n+import {compoundRuntimeOpStore, markCompoundRuntimeOperationCompleted, registerCompoundRuntimeOperation, runtimeStore, useStore} from 'app/utils/stores';\n+import {DataprocConfig, Runtime, RuntimeStatus} from 'generated/fetch';\n import * as fp from 'lodash/fp';\n \n import * as React from 'react';\n+import {ComputeType, findMachineByName, Machine} from './machines';\n \n const {useState, useEffect} = React;\n \n export enum RuntimeStatusRequest {\n   Delete = 'Delete'\n }\n \n+export interface RuntimeDiff {\n+  desc: string;\n+  previous: string;\n+  new: string;\n+  differenceType: RuntimeDiffState;\n+}\n+\n+export enum RuntimeDiffState {\n+  NO_CHANGE,\n+  CAN_UPDATE,\n+  NEEDS_DELETE\n+}\n+\n+export interface RuntimeConfig {\n+  computeType: ComputeType;\n+  machine: Machine;\n+  diskSize: number;\n+  dataprocConfig: DataprocConfig;\n+}\n+\n+function compareComputeTypes(oldRuntime: RuntimeConfig, newRuntime: RuntimeConfig): RuntimeDiff {\n+  return {\n+    desc: 'Change Compute Type',\n+    previous: oldRuntime.computeType,\n+    new: newRuntime.computeType,\n+    differenceType: oldRuntime.computeType === newRuntime.computeType ?\n+      RuntimeDiffState.NO_CHANGE : RuntimeDiffState.NEEDS_DELETE\n+  };\n+}\n+\n+function compareMachineCpu(oldRuntime: RuntimeConfig, newRuntime: RuntimeConfig): RuntimeDiff {\n+  const oldCpu = oldRuntime.machine.cpu;\n+  const newCpu = newRuntime.machine.cpu;\n+\n+  return {\n+    desc: (newCpu < oldCpu ?  'Decrease' : 'Increase') + ' Number of CPUs',\n+    previous: oldCpu.toString(),\n+    new: newCpu.toString(),\n+    differenceType: oldCpu === newCpu ? RuntimeDiffState.NO_CHANGE : RuntimeDiffState.NEEDS_DELETE\n+  };\n+}\n+\n+function compareMachineMemory(oldRuntime: RuntimeConfig, newRuntime: RuntimeConfig): RuntimeDiff {\n+  const oldMemory = oldRuntime.machine.memory;\n+  const newMemory = newRuntime.machine.memory;\n+\n+  return {\n+    desc: (newMemory < oldMemory ?  'Decrease' : 'Increase') + ' Memory',\n+    previous: oldMemory.toString() + ' GB',\n+    new: newMemory.toString() + ' GB',\n+    differenceType: oldMemory === newMemory ? RuntimeDiffState.NO_CHANGE : RuntimeDiffState.NEEDS_DELETE\n+  };\n+}\n+\n+function compareDiskSize(oldRuntime: RuntimeConfig, newRuntime: RuntimeConfig): RuntimeDiff {\n+  let desc = 'Disk Size';\n+  let diffType;\n+\n+  if (newRuntime.diskSize < oldRuntime.diskSize) {\n+    desc = 'Decease ' + desc;\n+    diffType = RuntimeDiffState.NEEDS_DELETE;\n+  } else if (newRuntime.diskSize > oldRuntime.diskSize) {\n+    desc = 'Increase ' + desc;\n+    diffType = RuntimeDiffState.CAN_UPDATE;\n+  } else {\n+    diffType = RuntimeDiffState.NO_CHANGE;\n+  }\n+\n+  return {\n+    desc: desc,\n+    previous: oldRuntime.diskSize.toString() + ' GB',\n+    new: newRuntime.diskSize.toString() + ' GB',\n+    differenceType: diffType\n+  };\n+}\n+\n+function compareDataprocMasterDiskSize(oldRuntime: RuntimeConfig, newRuntime: RuntimeConfig): RuntimeDiff {\n+  if (oldRuntime.dataprocConfig === null || newRuntime.dataprocConfig === null) {\n+    return null;\n+  }\n+\n+  const oldDiskSize = oldRuntime.dataprocConfig.masterDiskSize || 0;\n+  const newDiskSize = newRuntime.dataprocConfig.masterDiskSize || 0;\n+\n+  let desc = 'Dataproc Master Machine Disk Size';\n+  let diffType;\n+\n+  if (newDiskSize < oldDiskSize) {\n+    desc = 'Decease ' + desc;\n+    diffType = RuntimeDiffState.NEEDS_DELETE;\n+  } else if (newDiskSize > oldDiskSize) {\n+    desc = 'Increase ' + desc;\n+    diffType = RuntimeDiffState.CAN_UPDATE;\n+  } else {\n+    diffType = RuntimeDiffState.NO_CHANGE;\n+  }\n+\n+  return {\n+    desc: desc,\n+    previous: oldDiskSize.toString() + ' GB',\n+    new: newDiskSize.toString() + ' GB',\n+    differenceType: diffType\n+  };\n+}\n+\n+function compareWorkerCpu(oldRuntime: RuntimeConfig, newRuntime: RuntimeConfig): RuntimeDiff {\n+  if (!oldRuntime.dataprocConfig || !newRuntime.dataprocConfig) {\n+    return null;\n+  }\n+\n+  const oldCpu = findMachineByName(oldRuntime.dataprocConfig.workerMachineType).cpu;\n+  const newCpu = findMachineByName(newRuntime.dataprocConfig.workerMachineType).cpu;\n+\n+  return {\n+    desc: (newCpu < oldCpu ?  'Decrease' : 'Increase') + ' Number of CPUs',\n+    previous: oldCpu.toString(),\n+    new: newCpu.toString(),\n+    differenceType: oldCpu === newCpu ? RuntimeDiffState.NO_CHANGE : RuntimeDiffState.NEEDS_DELETE\n+  };\n+}\n+\n+function compareWorkerMemory(oldRuntime: RuntimeConfig, newRuntime: RuntimeConfig): RuntimeDiff {\n+  if (!oldRuntime.dataprocConfig || !newRuntime.dataprocConfig) {\n+    return null;\n+  }\n+\n+  const oldMemory = findMachineByName(oldRuntime.dataprocConfig.workerMachineType).memory;\n+  const newMemory = findMachineByName(newRuntime.dataprocConfig.workerMachineType).memory;\n+\n+  return {\n+    desc: (newMemory < oldMemory ?  'Decrease' : 'Increase') + ' Memory',\n+    previous: oldMemory.toString() + ' GB',\n+    new: newMemory.toString() + ' GB',\n+    differenceType: oldMemory === newMemory ? RuntimeDiffState.NO_CHANGE : RuntimeDiffState.NEEDS_DELETE\n+  };\n+}\n+\n+\n+function compareDataprocWorkerDiskSize(oldRuntime: RuntimeConfig, newRuntime: RuntimeConfig): RuntimeDiff {\n+  if (oldRuntime.dataprocConfig === null || newRuntime.dataprocConfig === null) {\n+    return null;\n+  }\n+\n+  const oldDiskSize = oldRuntime.dataprocConfig.workerDiskSize || 0;\n+  const newDiskSize = newRuntime.dataprocConfig.workerDiskSize || 0;\n+\n+  return {\n+    desc: (newDiskSize < oldDiskSize ?  'Decrease' : 'Increase') + ' Change Worker Machine Type',\n+    previous: oldDiskSize.toString() + ' GB',\n+    new: newDiskSize.toString() + ' GB',\n+    differenceType: oldDiskSize === newDiskSize ?\n+      RuntimeDiffState.NO_CHANGE : RuntimeDiffState.NEEDS_DELETE\n+  };\n+}\n+\n+function compareDataprocNumberOfPreemptibleWorkers(oldRuntime: RuntimeConfig, newRuntime: RuntimeConfig): RuntimeDiff {", "originalCommit": "ff2c0c74b0b1330024040ccc107ab732dfa4bd9a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTU5NzA3NA==", "url": "https://github.com/all-of-us/workbench/pull/4281#discussion_r525597074", "bodyText": "I actually started out with a more reusable approach but I found that the current implementation is easier to work with and think about since every \"diff\" maps to a single function. IMO, the lower complexity is worth the extra verbosity.", "author": "ericsong", "createdAt": "2020-11-17T23:37:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDQ5NzA1NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDQ5ODA2NQ==", "url": "https://github.com/all-of-us/workbench/pull/4281#discussion_r524498065", "bodyText": "Do you have clarity around what the product behavior should be when someone switches from GCE -> Dataproc?\nIs it supposed to show the new worker machine type as part of the diff? Or no?", "author": "calbach", "createdAt": "2020-11-16T18:52:38Z", "path": "ui/src/app/utils/runtime-utils.tsx", "diffHunk": "@@ -1,29 +1,240 @@\n import {runtimeApi} from 'app/services/swagger-fetch-clients';\n-import {switchCase} from 'app/utils';\n-import { withAsyncErrorHandling } from 'app/utils';\n-import {\n-  ExceededActionCountError,\n-  LeoRuntimeInitializationAbortedError,\n-  LeoRuntimeInitializer,\n-} from 'app/utils/leo-runtime-initializer';\n-import {\n-  compoundRuntimeOpStore,\n-  markCompoundRuntimeOperationCompleted,\n-  registerCompoundRuntimeOperation,\n-  runtimeStore,\n-  useStore\n-} from 'app/utils/stores';\n-import {Runtime, RuntimeStatus} from 'generated/fetch';\n+import {switchCase, withAsyncErrorHandling} from 'app/utils';\n+import {ExceededActionCountError, LeoRuntimeInitializationAbortedError, LeoRuntimeInitializer, } from 'app/utils/leo-runtime-initializer';\n+import {compoundRuntimeOpStore, markCompoundRuntimeOperationCompleted, registerCompoundRuntimeOperation, runtimeStore, useStore} from 'app/utils/stores';\n+import {DataprocConfig, Runtime, RuntimeStatus} from 'generated/fetch';\n import * as fp from 'lodash/fp';\n \n import * as React from 'react';\n+import {ComputeType, findMachineByName, Machine} from './machines';\n \n const {useState, useEffect} = React;\n \n export enum RuntimeStatusRequest {\n   Delete = 'Delete'\n }\n \n+export interface RuntimeDiff {\n+  desc: string;\n+  previous: string;\n+  new: string;\n+  differenceType: RuntimeDiffState;\n+}\n+\n+export enum RuntimeDiffState {\n+  NO_CHANGE,\n+  CAN_UPDATE,\n+  NEEDS_DELETE\n+}\n+\n+export interface RuntimeConfig {\n+  computeType: ComputeType;\n+  machine: Machine;\n+  diskSize: number;\n+  dataprocConfig: DataprocConfig;\n+}\n+\n+function compareComputeTypes(oldRuntime: RuntimeConfig, newRuntime: RuntimeConfig): RuntimeDiff {\n+  return {\n+    desc: 'Change Compute Type',\n+    previous: oldRuntime.computeType,\n+    new: newRuntime.computeType,\n+    differenceType: oldRuntime.computeType === newRuntime.computeType ?\n+      RuntimeDiffState.NO_CHANGE : RuntimeDiffState.NEEDS_DELETE\n+  };\n+}\n+\n+function compareMachineCpu(oldRuntime: RuntimeConfig, newRuntime: RuntimeConfig): RuntimeDiff {\n+  const oldCpu = oldRuntime.machine.cpu;\n+  const newCpu = newRuntime.machine.cpu;\n+\n+  return {\n+    desc: (newCpu < oldCpu ?  'Decrease' : 'Increase') + ' Number of CPUs',\n+    previous: oldCpu.toString(),\n+    new: newCpu.toString(),\n+    differenceType: oldCpu === newCpu ? RuntimeDiffState.NO_CHANGE : RuntimeDiffState.NEEDS_DELETE\n+  };\n+}\n+\n+function compareMachineMemory(oldRuntime: RuntimeConfig, newRuntime: RuntimeConfig): RuntimeDiff {\n+  const oldMemory = oldRuntime.machine.memory;\n+  const newMemory = newRuntime.machine.memory;\n+\n+  return {\n+    desc: (newMemory < oldMemory ?  'Decrease' : 'Increase') + ' Memory',\n+    previous: oldMemory.toString() + ' GB',\n+    new: newMemory.toString() + ' GB',\n+    differenceType: oldMemory === newMemory ? RuntimeDiffState.NO_CHANGE : RuntimeDiffState.NEEDS_DELETE\n+  };\n+}\n+\n+function compareDiskSize(oldRuntime: RuntimeConfig, newRuntime: RuntimeConfig): RuntimeDiff {\n+  let desc = 'Disk Size';\n+  let diffType;\n+\n+  if (newRuntime.diskSize < oldRuntime.diskSize) {\n+    desc = 'Decease ' + desc;\n+    diffType = RuntimeDiffState.NEEDS_DELETE;\n+  } else if (newRuntime.diskSize > oldRuntime.diskSize) {\n+    desc = 'Increase ' + desc;\n+    diffType = RuntimeDiffState.CAN_UPDATE;\n+  } else {\n+    diffType = RuntimeDiffState.NO_CHANGE;\n+  }\n+\n+  return {\n+    desc: desc,\n+    previous: oldRuntime.diskSize.toString() + ' GB',\n+    new: newRuntime.diskSize.toString() + ' GB',\n+    differenceType: diffType\n+  };\n+}\n+\n+function compareDataprocMasterDiskSize(oldRuntime: RuntimeConfig, newRuntime: RuntimeConfig): RuntimeDiff {\n+  if (oldRuntime.dataprocConfig === null || newRuntime.dataprocConfig === null) {\n+    return null;\n+  }\n+\n+  const oldDiskSize = oldRuntime.dataprocConfig.masterDiskSize || 0;\n+  const newDiskSize = newRuntime.dataprocConfig.masterDiskSize || 0;\n+\n+  let desc = 'Dataproc Master Machine Disk Size';\n+  let diffType;\n+\n+  if (newDiskSize < oldDiskSize) {\n+    desc = 'Decease ' + desc;\n+    diffType = RuntimeDiffState.NEEDS_DELETE;\n+  } else if (newDiskSize > oldDiskSize) {\n+    desc = 'Increase ' + desc;\n+    diffType = RuntimeDiffState.CAN_UPDATE;\n+  } else {\n+    diffType = RuntimeDiffState.NO_CHANGE;\n+  }\n+\n+  return {\n+    desc: desc,\n+    previous: oldDiskSize.toString() + ' GB',\n+    new: newDiskSize.toString() + ' GB',\n+    differenceType: diffType\n+  };\n+}\n+\n+function compareWorkerCpu(oldRuntime: RuntimeConfig, newRuntime: RuntimeConfig): RuntimeDiff {\n+  if (!oldRuntime.dataprocConfig || !newRuntime.dataprocConfig) {\n+    return null;\n+  }\n+\n+  const oldCpu = findMachineByName(oldRuntime.dataprocConfig.workerMachineType).cpu;\n+  const newCpu = findMachineByName(newRuntime.dataprocConfig.workerMachineType).cpu;\n+\n+  return {\n+    desc: (newCpu < oldCpu ?  'Decrease' : 'Increase') + ' Number of CPUs',\n+    previous: oldCpu.toString(),\n+    new: newCpu.toString(),\n+    differenceType: oldCpu === newCpu ? RuntimeDiffState.NO_CHANGE : RuntimeDiffState.NEEDS_DELETE\n+  };\n+}\n+\n+function compareWorkerMemory(oldRuntime: RuntimeConfig, newRuntime: RuntimeConfig): RuntimeDiff {\n+  if (!oldRuntime.dataprocConfig || !newRuntime.dataprocConfig) {", "originalCommit": "ff2c0c74b0b1330024040ccc107ab732dfa4bd9a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTU5NDY5MQ==", "url": "https://github.com/all-of-us/workbench/pull/4281#discussion_r525594691", "bodyText": "The mocks actually do have an example of going from GCE -> Dataproc and it doesn't have the new Dataproc config in the diff but I'll ping Shimon and Lou since I think it would be useful to add.\nHowever, even if we want that feature, I'm thinking we should address it in a different ticket to reduce the scope of the current PR.", "author": "ericsong", "createdAt": "2020-11-17T23:31:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDQ5ODA2NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDQ5ODk5NA==", "url": "https://github.com/all-of-us/workbench/pull/4281#discussion_r524498994", "bodyText": "nit: most of the existing functions in here use const foo = () => {} style. Would probably match this for consistency.", "author": "calbach", "createdAt": "2020-11-16T18:54:11Z", "path": "ui/src/app/utils/runtime-utils.tsx", "diffHunk": "@@ -1,29 +1,240 @@\n import {runtimeApi} from 'app/services/swagger-fetch-clients';\n-import {switchCase} from 'app/utils';\n-import { withAsyncErrorHandling } from 'app/utils';\n-import {\n-  ExceededActionCountError,\n-  LeoRuntimeInitializationAbortedError,\n-  LeoRuntimeInitializer,\n-} from 'app/utils/leo-runtime-initializer';\n-import {\n-  compoundRuntimeOpStore,\n-  markCompoundRuntimeOperationCompleted,\n-  registerCompoundRuntimeOperation,\n-  runtimeStore,\n-  useStore\n-} from 'app/utils/stores';\n-import {Runtime, RuntimeStatus} from 'generated/fetch';\n+import {switchCase, withAsyncErrorHandling} from 'app/utils';\n+import {ExceededActionCountError, LeoRuntimeInitializationAbortedError, LeoRuntimeInitializer, } from 'app/utils/leo-runtime-initializer';\n+import {compoundRuntimeOpStore, markCompoundRuntimeOperationCompleted, registerCompoundRuntimeOperation, runtimeStore, useStore} from 'app/utils/stores';\n+import {DataprocConfig, Runtime, RuntimeStatus} from 'generated/fetch';\n import * as fp from 'lodash/fp';\n \n import * as React from 'react';\n+import {ComputeType, findMachineByName, Machine} from './machines';\n \n const {useState, useEffect} = React;\n \n export enum RuntimeStatusRequest {\n   Delete = 'Delete'\n }\n \n+export interface RuntimeDiff {\n+  desc: string;\n+  previous: string;\n+  new: string;\n+  differenceType: RuntimeDiffState;\n+}\n+\n+export enum RuntimeDiffState {\n+  NO_CHANGE,\n+  CAN_UPDATE,\n+  NEEDS_DELETE\n+}\n+\n+export interface RuntimeConfig {\n+  computeType: ComputeType;\n+  machine: Machine;\n+  diskSize: number;\n+  dataprocConfig: DataprocConfig;\n+}\n+\n+function compareComputeTypes(oldRuntime: RuntimeConfig, newRuntime: RuntimeConfig): RuntimeDiff {\n+  return {\n+    desc: 'Change Compute Type',\n+    previous: oldRuntime.computeType,\n+    new: newRuntime.computeType,\n+    differenceType: oldRuntime.computeType === newRuntime.computeType ?\n+      RuntimeDiffState.NO_CHANGE : RuntimeDiffState.NEEDS_DELETE\n+  };\n+}\n+\n+function compareMachineCpu(oldRuntime: RuntimeConfig, newRuntime: RuntimeConfig): RuntimeDiff {\n+  const oldCpu = oldRuntime.machine.cpu;\n+  const newCpu = newRuntime.machine.cpu;\n+\n+  return {\n+    desc: (newCpu < oldCpu ?  'Decrease' : 'Increase') + ' Number of CPUs',\n+    previous: oldCpu.toString(),\n+    new: newCpu.toString(),\n+    differenceType: oldCpu === newCpu ? RuntimeDiffState.NO_CHANGE : RuntimeDiffState.NEEDS_DELETE\n+  };\n+}\n+\n+function compareMachineMemory(oldRuntime: RuntimeConfig, newRuntime: RuntimeConfig): RuntimeDiff {\n+  const oldMemory = oldRuntime.machine.memory;\n+  const newMemory = newRuntime.machine.memory;\n+\n+  return {\n+    desc: (newMemory < oldMemory ?  'Decrease' : 'Increase') + ' Memory',\n+    previous: oldMemory.toString() + ' GB',\n+    new: newMemory.toString() + ' GB',\n+    differenceType: oldMemory === newMemory ? RuntimeDiffState.NO_CHANGE : RuntimeDiffState.NEEDS_DELETE\n+  };\n+}\n+\n+function compareDiskSize(oldRuntime: RuntimeConfig, newRuntime: RuntimeConfig): RuntimeDiff {\n+  let desc = 'Disk Size';\n+  let diffType;\n+\n+  if (newRuntime.diskSize < oldRuntime.diskSize) {\n+    desc = 'Decease ' + desc;\n+    diffType = RuntimeDiffState.NEEDS_DELETE;\n+  } else if (newRuntime.diskSize > oldRuntime.diskSize) {\n+    desc = 'Increase ' + desc;\n+    diffType = RuntimeDiffState.CAN_UPDATE;\n+  } else {\n+    diffType = RuntimeDiffState.NO_CHANGE;\n+  }\n+\n+  return {\n+    desc: desc,\n+    previous: oldRuntime.diskSize.toString() + ' GB',\n+    new: newRuntime.diskSize.toString() + ' GB',\n+    differenceType: diffType\n+  };\n+}\n+\n+function compareDataprocMasterDiskSize(oldRuntime: RuntimeConfig, newRuntime: RuntimeConfig): RuntimeDiff {\n+  if (oldRuntime.dataprocConfig === null || newRuntime.dataprocConfig === null) {\n+    return null;\n+  }\n+\n+  const oldDiskSize = oldRuntime.dataprocConfig.masterDiskSize || 0;\n+  const newDiskSize = newRuntime.dataprocConfig.masterDiskSize || 0;\n+\n+  let desc = 'Dataproc Master Machine Disk Size';\n+  let diffType;\n+\n+  if (newDiskSize < oldDiskSize) {\n+    desc = 'Decease ' + desc;\n+    diffType = RuntimeDiffState.NEEDS_DELETE;\n+  } else if (newDiskSize > oldDiskSize) {\n+    desc = 'Increase ' + desc;\n+    diffType = RuntimeDiffState.CAN_UPDATE;\n+  } else {\n+    diffType = RuntimeDiffState.NO_CHANGE;\n+  }\n+\n+  return {\n+    desc: desc,\n+    previous: oldDiskSize.toString() + ' GB',\n+    new: newDiskSize.toString() + ' GB',\n+    differenceType: diffType\n+  };\n+}\n+\n+function compareWorkerCpu(oldRuntime: RuntimeConfig, newRuntime: RuntimeConfig): RuntimeDiff {\n+  if (!oldRuntime.dataprocConfig || !newRuntime.dataprocConfig) {\n+    return null;\n+  }\n+\n+  const oldCpu = findMachineByName(oldRuntime.dataprocConfig.workerMachineType).cpu;\n+  const newCpu = findMachineByName(newRuntime.dataprocConfig.workerMachineType).cpu;\n+\n+  return {\n+    desc: (newCpu < oldCpu ?  'Decrease' : 'Increase') + ' Number of CPUs',\n+    previous: oldCpu.toString(),\n+    new: newCpu.toString(),\n+    differenceType: oldCpu === newCpu ? RuntimeDiffState.NO_CHANGE : RuntimeDiffState.NEEDS_DELETE\n+  };\n+}\n+\n+function compareWorkerMemory(oldRuntime: RuntimeConfig, newRuntime: RuntimeConfig): RuntimeDiff {\n+  if (!oldRuntime.dataprocConfig || !newRuntime.dataprocConfig) {\n+    return null;\n+  }\n+\n+  const oldMemory = findMachineByName(oldRuntime.dataprocConfig.workerMachineType).memory;\n+  const newMemory = findMachineByName(newRuntime.dataprocConfig.workerMachineType).memory;\n+\n+  return {\n+    desc: (newMemory < oldMemory ?  'Decrease' : 'Increase') + ' Memory',\n+    previous: oldMemory.toString() + ' GB',\n+    new: newMemory.toString() + ' GB',\n+    differenceType: oldMemory === newMemory ? RuntimeDiffState.NO_CHANGE : RuntimeDiffState.NEEDS_DELETE\n+  };\n+}\n+\n+\n+function compareDataprocWorkerDiskSize(oldRuntime: RuntimeConfig, newRuntime: RuntimeConfig): RuntimeDiff {\n+  if (oldRuntime.dataprocConfig === null || newRuntime.dataprocConfig === null) {\n+    return null;\n+  }\n+\n+  const oldDiskSize = oldRuntime.dataprocConfig.workerDiskSize || 0;\n+  const newDiskSize = newRuntime.dataprocConfig.workerDiskSize || 0;\n+\n+  return {\n+    desc: (newDiskSize < oldDiskSize ?  'Decrease' : 'Increase') + ' Change Worker Machine Type',\n+    previous: oldDiskSize.toString() + ' GB',\n+    new: newDiskSize.toString() + ' GB',\n+    differenceType: oldDiskSize === newDiskSize ?\n+      RuntimeDiffState.NO_CHANGE : RuntimeDiffState.NEEDS_DELETE\n+  };\n+}\n+\n+function compareDataprocNumberOfPreemptibleWorkers(oldRuntime: RuntimeConfig, newRuntime: RuntimeConfig): RuntimeDiff {\n+  if (oldRuntime.dataprocConfig === null || newRuntime.dataprocConfig === null) {\n+    return null;\n+  }\n+\n+  const oldNumWorkers = oldRuntime.dataprocConfig.numberOfPreemptibleWorkers || 0;\n+  const newNumWorkers = newRuntime.dataprocConfig.numberOfPreemptibleWorkers || 0;\n+\n+  return {\n+    desc: (newNumWorkers < oldNumWorkers ?  'Decrease' : 'Increase') + ' Number of Preemptible Workers',\n+    previous: oldNumWorkers.toString(),\n+    new: newNumWorkers.toString(),\n+    differenceType: oldNumWorkers === newNumWorkers ?\n+      RuntimeDiffState.NO_CHANGE : RuntimeDiffState.CAN_UPDATE\n+  };\n+}\n+\n+function compareDataprocNumberOfWorkers(oldRuntime: RuntimeConfig, newRuntime: RuntimeConfig): RuntimeDiff {\n+  if (oldRuntime.dataprocConfig === null || newRuntime.dataprocConfig === null) {\n+    return null;\n+  }\n+\n+  const oldNumWorkers = oldRuntime.dataprocConfig.numberOfWorkers || 0;\n+  const newNumWorkers = newRuntime.dataprocConfig.numberOfWorkers || 0;\n+\n+  return {\n+    desc: (newNumWorkers < oldNumWorkers ?  'Decrease' : 'Increase') + ' Number of Workers',\n+    previous: oldNumWorkers.toString(),\n+    new: newNumWorkers.toString(),\n+    differenceType: oldNumWorkers === newNumWorkers ?\n+      RuntimeDiffState.NO_CHANGE : RuntimeDiffState.CAN_UPDATE\n+  };\n+}\n+\n+export const getRuntimeConfigDiffs = (oldRuntime: RuntimeConfig, newRuntime: RuntimeConfig): RuntimeDiff[] => {\n+  const compareFns = [compareComputeTypes, compareDiskSize, compareMachineCpu,\n+    compareMachineMemory, compareDataprocMasterDiskSize, compareWorkerCpu, compareWorkerMemory,\n+    compareDataprocNumberOfPreemptibleWorkers, compareDataprocNumberOfWorkers, compareDataprocWorkerDiskSize];\n+\n+  return compareFns.map(compareFn => compareFn(oldRuntime, newRuntime))\n+    .filter(diff => diff !== null)\n+    .filter(diff => diff.differenceType !== RuntimeDiffState.NO_CHANGE);\n+};\n+\n+function getRuntimeDiffs(oldRuntime: Runtime, newRuntime: Runtime): RuntimeDiff[] {\n+  return getRuntimeConfigDiffs(toRuntimeConfig(oldRuntime), toRuntimeConfig(newRuntime));\n+}\n+\n+function toRuntimeConfig(runtime: Runtime): RuntimeConfig {", "originalCommit": "ff2c0c74b0b1330024040ccc107ab732dfa4bd9a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDUwMDY2Nw==", "url": "https://github.com/all-of-us/workbench/pull/4281#discussion_r524500667", "bodyText": "Running -> Updating?", "author": "calbach", "createdAt": "2020-11-16T18:56:43Z", "path": "ui/src/app/utils/runtime-utils.tsx", "diffHunk": "@@ -133,11 +344,33 @@ export const useCustomRuntime = (currentWorkspaceNamespace):\n       // TODO: It is likely more correct here to use the LeoRuntimeInitializer wait for the runtime\n       // to reach a terminal status before attempting deletion.\n       try {\n-        if (runtime && runtime.status !== RuntimeStatus.Deleted) {\n-          await runtimeApi().deleteRuntime(currentWorkspaceNamespace, {\n-            signal: aborter.signal\n-          });\n+        if (runtime) {\n+          const runtimeDiffTypes = getRuntimeDiffs(runtime, requestedRuntime).map(diff => diff.differenceType);\n+\n+          if (runtimeDiffTypes.includes(RuntimeDiffState.NEEDS_DELETE)) {\n+            if (runtime.status !== RuntimeStatus.Deleted) {\n+              await runtimeApi().deleteRuntime(currentWorkspaceNamespace, {\n+                signal: aborter.signal\n+              });\n+            }\n+          } else if (runtimeDiffTypes.includes(RuntimeDiffState.CAN_UPDATE)) {\n+            if (runtime.status === RuntimeStatus.Running || runtime.status === RuntimeStatus.Stopped) {\n+              await runtimeApi().updateRuntime(currentWorkspaceNamespace, {runtime: requestedRuntime});\n+              // Calling updateRuntime will not immediately set the Runtime status to not Running so the", "originalCommit": "ff2c0c74b0b1330024040ccc107ab732dfa4bd9a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjI1OTU0Nw==", "url": "https://github.com/all-of-us/workbench/pull/4281#discussion_r526259547", "bodyText": "Not sure. In practice, I've only seen it go right to Stopping but Updating is probably the right behavior. I'll reach out to Terra to ask about what the expected behavior here is.", "author": "ericsong", "createdAt": "2020-11-18T17:11:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDUwMDY2Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDUwMTM3Ng==", "url": "https://github.com/all-of-us/workbench/pull/4281#discussion_r524501376", "bodyText": "Is this guaranteed to happen? How long does this actually take, and is it possible we won't observe this?", "author": "calbach", "createdAt": "2020-11-16T18:57:54Z", "path": "ui/src/app/utils/runtime-utils.tsx", "diffHunk": "@@ -133,11 +344,33 @@ export const useCustomRuntime = (currentWorkspaceNamespace):\n       // TODO: It is likely more correct here to use the LeoRuntimeInitializer wait for the runtime\n       // to reach a terminal status before attempting deletion.\n       try {\n-        if (runtime && runtime.status !== RuntimeStatus.Deleted) {\n-          await runtimeApi().deleteRuntime(currentWorkspaceNamespace, {\n-            signal: aborter.signal\n-          });\n+        if (runtime) {\n+          const runtimeDiffTypes = getRuntimeDiffs(runtime, requestedRuntime).map(diff => diff.differenceType);\n+\n+          if (runtimeDiffTypes.includes(RuntimeDiffState.NEEDS_DELETE)) {\n+            if (runtime.status !== RuntimeStatus.Deleted) {\n+              await runtimeApi().deleteRuntime(currentWorkspaceNamespace, {\n+                signal: aborter.signal\n+              });\n+            }\n+          } else if (runtimeDiffTypes.includes(RuntimeDiffState.CAN_UPDATE)) {\n+            if (runtime.status === RuntimeStatus.Running || runtime.status === RuntimeStatus.Stopped) {\n+              await runtimeApi().updateRuntime(currentWorkspaceNamespace, {runtime: requestedRuntime});\n+              // Calling updateRuntime will not immediately set the Runtime status to not Running so the\n+              // default initializer will resolve on its first call. The polling below first checks for the\n+              // non Running status before initializing the default one that checks for Running status", "originalCommit": "ff2c0c74b0b1330024040ccc107ab732dfa4bd9a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzE4NzU3Mw==", "url": "https://github.com/all-of-us/workbench/pull/4281#discussion_r527187573", "bodyText": "If we go with this for now (looks like the patchInProgress variable is not being returned), then please either set a time limit on this polling OR change the condition to be !== RUNNING || noChangesNeeded, where changes needed can be a function of diffing r and requestedRuntime. This catches the case where the update gets applied but we somehow fail to observe any kind of status change.", "author": "calbach", "createdAt": "2020-11-19T20:46:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDUwMTM3Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDUwMjM3OQ==", "url": "https://github.com/all-of-us/workbench/pull/4281#discussion_r524502379", "bodyText": "If we have to do this approach (we should check with Leo to understand whether this is expected and whether the behavior can be changed), I think we would also want to have some kind of upper bound timer here. e.g. also check for time having elapsed at this point", "author": "calbach", "createdAt": "2020-11-16T18:59:37Z", "path": "ui/src/app/utils/runtime-utils.tsx", "diffHunk": "@@ -133,11 +344,33 @@ export const useCustomRuntime = (currentWorkspaceNamespace):\n       // TODO: It is likely more correct here to use the LeoRuntimeInitializer wait for the runtime\n       // to reach a terminal status before attempting deletion.\n       try {\n-        if (runtime && runtime.status !== RuntimeStatus.Deleted) {\n-          await runtimeApi().deleteRuntime(currentWorkspaceNamespace, {\n-            signal: aborter.signal\n-          });\n+        if (runtime) {\n+          const runtimeDiffTypes = getRuntimeDiffs(runtime, requestedRuntime).map(diff => diff.differenceType);\n+\n+          if (runtimeDiffTypes.includes(RuntimeDiffState.NEEDS_DELETE)) {\n+            if (runtime.status !== RuntimeStatus.Deleted) {\n+              await runtimeApi().deleteRuntime(currentWorkspaceNamespace, {\n+                signal: aborter.signal\n+              });\n+            }\n+          } else if (runtimeDiffTypes.includes(RuntimeDiffState.CAN_UPDATE)) {\n+            if (runtime.status === RuntimeStatus.Running || runtime.status === RuntimeStatus.Stopped) {\n+              await runtimeApi().updateRuntime(currentWorkspaceNamespace, {runtime: requestedRuntime});\n+              // Calling updateRuntime will not immediately set the Runtime status to not Running so the\n+              // default initializer will resolve on its first call. The polling below first checks for the\n+              // non Running status before initializing the default one that checks for Running status\n+              await LeoRuntimeInitializer.initialize({\n+                workspaceNamespace,\n+                targetRuntime: requestedRuntime,\n+                resolutionCond: r => r.status !== RuntimeStatus.Running,", "originalCommit": "ff2c0c74b0b1330024040ccc107ab732dfa4bd9a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDUwMzg4OA==", "url": "https://github.com/all-of-us/workbench/pull/4281#discussion_r524503888", "bodyText": "nit: I'd characterize this as test, fake, or stub data rather than a mock. Generally I prefer reserving the term mock to refer to actual  testing mocks to avoid confusion.\nopt: IN this case, I might just name it defaultGceConfig to match the other naming below", "author": "calbach", "createdAt": "2020-11-16T19:02:05Z", "path": "ui/src/testing/stubs/runtime-api-stub.ts", "diffHunk": "@@ -8,18 +9,29 @@ import {\n } from 'generated/fetch';\n import {stubNotImplementedError} from 'testing/stubs/stub-utils';\n \n+export const mockGceConfig: GceConfig = {", "originalCommit": "ff2c0c74b0b1330024040ccc107ab732dfa4bd9a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDUwNDc2Mw==", "url": "https://github.com/all-of-us/workbench/pull/4281#discussion_r524504763", "bodyText": "hm. Why is this the result? Please comment if it's needed", "author": "calbach", "createdAt": "2020-11-16T19:03:41Z", "path": "ui/src/testing/stubs/runtime-api-stub.ts", "diffHunk": "@@ -50,6 +62,13 @@ export class RuntimeApiStub extends RuntimeApi {\n     });\n   }\n \n+  updateRuntime(workspaceNamespace: string, options?: any): Promise<{}> {\n+    return new Promise<{}>(resolve => {\n+      this.runtime.status = RuntimeStatus.Running;", "originalCommit": "ff2c0c74b0b1330024040ccc107ab732dfa4bd9a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjI3NTgyMg==", "url": "https://github.com/all-of-us/workbench/pull/4281#discussion_r526275822", "bodyText": "I did this so that it reflects what's currently happening in the product. Could be a bug so I'll reach out to Terra to see what's going on.", "author": "ericsong", "createdAt": "2020-11-18T17:31:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDUwNDc2Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDUwNTQ5NA==", "url": "https://github.com/all-of-us/workbench/pull/4281#discussion_r524505494", "bodyText": "I would shallow copy here. I made defaultRuntime a function to avoid tests interfering with one another by mutating the runtime value.", "author": "calbach", "createdAt": "2020-11-16T19:04:47Z", "path": "ui/src/testing/stubs/runtime-api-stub.ts", "diffHunk": "@@ -8,18 +9,29 @@ import {\n } from 'generated/fetch';\n import {stubNotImplementedError} from 'testing/stubs/stub-utils';\n \n+export const mockGceConfig: GceConfig = {\n+  diskSize: 80,\n+  machineType: 'n1-standard-4'\n+};\n+\n+export const mockDataprocConfig: DataprocConfig = {\n+  masterMachineType: 'n1-standard-4',\n+  masterDiskSize: 80,\n+  workerDiskSize: 40,\n+  workerMachineType: 'n1-standard-4',\n+  numberOfWorkers: 1,\n+  numberOfPreemptibleWorkers: 2,\n+  numberOfWorkerLocalSSDs: 0\n+};\n+\n export const defaultRuntime = () => ({\n   runtimeName: 'Runtime Name',\n   googleProject: 'Namespace',\n   status: RuntimeStatus.Running,\n   createdDate: '08/08/2018',\n   toolDockerImage: 'broadinstitute/terra-jupyter-aou:1.0.999',\n   configurationType: RuntimeConfigurationType.GeneralAnalysis,\n-  dataprocConfig: {\n-    masterMachineType: 'n1-standard-4',\n-    masterDiskSize: 80,\n-    numberOfWorkers: 0\n-  }\n+  gceConfig: mockGceConfig", "originalCommit": "ff2c0c74b0b1330024040ccc107ab732dfa4bd9a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDUwNjU4NQ==", "url": "https://github.com/all-of-us/workbench/pull/4281#discussion_r524506585", "bodyText": "nice..", "author": "calbach", "createdAt": "2020-11-16T19:06:43Z", "path": "ui/src/app/pages/analysis/runtime-panel.tsx", "diffHunk": "@@ -508,12 +527,24 @@ export const RuntimePanel = fp.flow(\n   const [selectedCompute, setSelectedCompute] = useState<ComputeType>(initialCompute);\n   const [selectedDataprocConfig, setSelectedDataprocConfig] = useState<DataprocConfig | null>(dataprocConfig);\n \n-  const selectedMachineType = selectedMachine && selectedMachine.name;\n   const runtimeExists = (status && status !== RuntimeStatus.Deleted) || !!pendingRuntime;\n-  const runtimeChanged = !fp.equals(selectedMachine, initialMasterMachine) ||\n-    selectedDiskSize !== diskSize ||\n-    !fp.equals(selectedDataprocConfig, dataprocConfig) ||\n-    !fp.equals(selectedCompute, initialCompute);\n+\n+  const initialRuntimeConfig = {\n+    computeType: initialCompute,\n+    machine: initialMasterMachine,\n+    diskSize: diskSize,\n+    dataprocConfig: dataprocConfig\n+  };\n+\n+  const newRuntimeConfig = {\n+    computeType: selectedCompute,\n+    machine: selectedMachine,\n+    diskSize: selectedDiskSize,\n+    dataprocConfig: selectedDataprocConfig\n+  };\n+\n+  const runtimeDiffs = getRuntimeConfigDiffs(initialRuntimeConfig, newRuntimeConfig);\n+  const runtimeChanged = runtimeDiffs.length > 0;", "originalCommit": "ff2c0c74b0b1330024040ccc107ab732dfa4bd9a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDUwODEwMQ==", "url": "https://github.com/all-of-us/workbench/pull/4281#discussion_r524508101", "bodyText": "nit: 6 dots? Is this in the mocks? I'd say no more than 3, if we need ellipses at all here.", "author": "calbach", "createdAt": "2020-11-16T19:09:28Z", "path": "ui/src/app/pages/analysis/runtime-panel.tsx", "diffHunk": "@@ -591,33 +767,19 @@ export const RuntimePanel = fp.flow(\n                      style={{width: '10rem'}}\n                      options={[ComputeType.Standard, ComputeType.Dataproc]}\n                      value={selectedCompute || ComputeType.Standard}\n-                     onChange={({value}) => setSelectedCompute(value)}\n+                     onChange={({value}) => {setSelectedCompute(value); }}\n                      />\n            {\n              selectedCompute === ComputeType.Dataproc &&\n-             <DataProcConfigSelector onChange={setSelectedDataprocConfig} dataprocConfig={selectedDataprocConfig} />\n+             <DataProcConfigSelector onChange={config => setSelectedDataprocConfig(config)} dataprocConfig={selectedDataprocConfig} />\n            }\n          </FlexColumn>\n        </div>\n-       {runtimeExists && runtimeChanged && <FlexRow\n-           style={{\n-             alignItems: 'center',\n-             backgroundColor: colorWithWhiteness(colors.warning, .9),\n-             border: `1px solid ${colors.warning}`,\n-             borderRadius: '5px',\n-             color: colors.dark,\n-             marginTop: '.5rem',\n-             padding: '.5rem 0px'\n-           }}\n-       >\n-         <ClrIcon\n-             style={{color: colors.warning, marginLeft: '.5rem'}}\n-             shape={'warning-standard'}\n-             size={16}\n-             class={'is-solid'}\n-         />\n-         <div style={{marginLeft: '.5rem'}}>You've made changes that require recreating your environment to take effect.</div>\n-       </FlexRow>}\n+       {runtimeExists && runtimeChanged &&\n+         <WarningMessage>\n+            <div>You've made changes that require recreating your environment to take effect.....</div>", "originalCommit": "ff2c0c74b0b1330024040ccc107ab732dfa4bd9a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDUxMTE3NA==", "url": "https://github.com/all-of-us/workbench/pull/4281#discussion_r524511174", "bodyText": "I don't think \"Number\" should be capitalized here. Not sure whether this matches the mocks or not - if it does, happy to make my objection to Lou and/or Shimon", "author": "calbach", "createdAt": "2020-11-16T19:14:55Z", "path": "ui/src/app/utils/runtime-utils.tsx", "diffHunk": "@@ -1,29 +1,240 @@\n import {runtimeApi} from 'app/services/swagger-fetch-clients';\n-import {switchCase} from 'app/utils';\n-import { withAsyncErrorHandling } from 'app/utils';\n-import {\n-  ExceededActionCountError,\n-  LeoRuntimeInitializationAbortedError,\n-  LeoRuntimeInitializer,\n-} from 'app/utils/leo-runtime-initializer';\n-import {\n-  compoundRuntimeOpStore,\n-  markCompoundRuntimeOperationCompleted,\n-  registerCompoundRuntimeOperation,\n-  runtimeStore,\n-  useStore\n-} from 'app/utils/stores';\n-import {Runtime, RuntimeStatus} from 'generated/fetch';\n+import {switchCase, withAsyncErrorHandling} from 'app/utils';\n+import {ExceededActionCountError, LeoRuntimeInitializationAbortedError, LeoRuntimeInitializer, } from 'app/utils/leo-runtime-initializer';\n+import {compoundRuntimeOpStore, markCompoundRuntimeOperationCompleted, registerCompoundRuntimeOperation, runtimeStore, useStore} from 'app/utils/stores';\n+import {DataprocConfig, Runtime, RuntimeStatus} from 'generated/fetch';\n import * as fp from 'lodash/fp';\n \n import * as React from 'react';\n+import {ComputeType, findMachineByName, Machine} from './machines';\n \n const {useState, useEffect} = React;\n \n export enum RuntimeStatusRequest {\n   Delete = 'Delete'\n }\n \n+export interface RuntimeDiff {\n+  desc: string;\n+  previous: string;\n+  new: string;\n+  differenceType: RuntimeDiffState;\n+}\n+\n+export enum RuntimeDiffState {\n+  NO_CHANGE,\n+  CAN_UPDATE,\n+  NEEDS_DELETE\n+}\n+\n+export interface RuntimeConfig {\n+  computeType: ComputeType;\n+  machine: Machine;\n+  diskSize: number;\n+  dataprocConfig: DataprocConfig;\n+}\n+\n+function compareComputeTypes(oldRuntime: RuntimeConfig, newRuntime: RuntimeConfig): RuntimeDiff {\n+  return {\n+    desc: 'Change Compute Type',\n+    previous: oldRuntime.computeType,\n+    new: newRuntime.computeType,\n+    differenceType: oldRuntime.computeType === newRuntime.computeType ?\n+      RuntimeDiffState.NO_CHANGE : RuntimeDiffState.NEEDS_DELETE\n+  };\n+}\n+\n+function compareMachineCpu(oldRuntime: RuntimeConfig, newRuntime: RuntimeConfig): RuntimeDiff {\n+  const oldCpu = oldRuntime.machine.cpu;\n+  const newCpu = newRuntime.machine.cpu;\n+\n+  return {\n+    desc: (newCpu < oldCpu ?  'Decrease' : 'Increase') + ' Number of CPUs',", "originalCommit": "ff2c0c74b0b1330024040ccc107ab732dfa4bd9a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTU5MjA5Nw==", "url": "https://github.com/all-of-us/workbench/pull/4281#discussion_r525592097", "bodyText": "They only had a few examples specified. I changed the casing for all of the diffs to be lowercase except for \"CPUs\".", "author": "ericsong", "createdAt": "2020-11-17T23:24:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDUxMTE3NA=="}], "type": "inlineReview"}, {"oid": "c4fcd9fe8cc655e648b1fdbda9227fd1cbb9a356", "url": "https://github.com/all-of-us/workbench/commit/c4fcd9fe8cc655e648b1fdbda9227fd1cbb9a356", "message": "merge master", "committedDate": "2020-11-16T20:47:36Z", "type": "commit"}, {"oid": "da103119248e690a832a15a14b389444c88ef360", "url": "https://github.com/all-of-us/workbench/commit/da103119248e690a832a15a14b389444c88ef360", "message": "merging - WIP", "committedDate": "2020-11-17T17:03:35Z", "type": "commit"}, {"oid": "30b1dddcd216f9e60e57deb17504434159656a4f", "url": "https://github.com/all-of-us/workbench/commit/30b1dddcd216f9e60e57deb17504434159656a4f", "message": "code review", "committedDate": "2020-11-18T21:09:28Z", "type": "commit"}, {"oid": "12b05f4dafc98317f7368b88aa5ece18a0e11d5a", "url": "https://github.com/all-of-us/workbench/commit/12b05f4dafc98317f7368b88aa5ece18a0e11d5a", "message": "lint", "committedDate": "2020-11-18T21:19:00Z", "type": "commit"}, {"oid": "9a0fe0e3965335b27bfe3816640c538a529a8730", "url": "https://github.com/all-of-us/workbench/commit/9a0fe0e3965335b27bfe3816640c538a529a8730", "message": "merge master", "committedDate": "2020-11-18T21:20:51Z", "type": "commit"}, {"oid": "0c976a978b2ec8057cd876d87019b7dfd8d94f7b", "url": "https://github.com/all-of-us/workbench/commit/0c976a978b2ec8057cd876d87019b7dfd8d94f7b", "message": "fix duplicate button bug", "committedDate": "2020-11-18T21:24:46Z", "type": "commit"}, {"oid": "b0ff556625e2655f54d362f69f3e53c28b49d8a3", "url": "https://github.com/all-of-us/workbench/commit/b0ff556625e2655f54d362f69f3e53c28b49d8a3", "message": "forgot to update a test", "committedDate": "2020-11-18T22:24:18Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjQ4MjkwNQ==", "url": "https://github.com/all-of-us/workbench/pull/4281#discussion_r526482905", "bodyText": "nit: revert", "author": "calbach", "createdAt": "2020-11-18T23:07:09Z", "path": "ui/src/app/components/help-sidebar.tsx", "diffHunk": "@@ -341,6 +341,7 @@ interface Props {\n   profileState: any;\n   setSidebarState: Function;\n   shareFunction: Function;\n+", "originalCommit": "b0ff556625e2655f54d362f69f3e53c28b49d8a3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjQ4MzE1Mg==", "url": "https://github.com/all-of-us/workbench/pull/4281#discussion_r526483152", "bodyText": "Please also restore timers here:     jest.useRealTimers();", "author": "calbach", "createdAt": "2020-11-18T23:07:52Z", "path": "ui/src/app/pages/analysis/runtime-panel.spec.tsx", "diffHunk": "@@ -51,55 +50,74 @@ describe('RuntimePanel', () => {\n       cdrVersionListResponse,\n       onUpdate: () => {}\n     };\n+\n+    jest.useFakeTimers();\n   });\n \n   afterEach(() => {", "originalCommit": "b0ff556625e2655f54d362f69f3e53c28b49d8a3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjQ4Mzk5MQ==", "url": "https://github.com/all-of-us/workbench/pull/4281#discussion_r526483991", "bodyText": "I'm a bit confused by this helper. It looks like it's just getting the input value, and it's identical to getNumberInput - would probably merge these together and just call it getInputValue", "author": "calbach", "createdAt": "2020-11-18T23:10:08Z", "path": "ui/src/app/pages/analysis/runtime-panel.spec.tsx", "diffHunk": "@@ -51,55 +50,74 @@ describe('RuntimePanel', () => {\n       cdrVersionListResponse,\n       onUpdate: () => {}\n     };\n+\n+    jest.useFakeTimers();\n   });\n \n   afterEach(() => {\n     act(() => clearCompoundRuntimeOperations());\n   });\n \n+  const getDropdownOption = (wrapper, id) => {", "originalCommit": "b0ff556625e2655f54d362f69f3e53c28b49d8a3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjQ4NjE2OQ==", "url": "https://github.com/all-of-us/workbench/pull/4281#discussion_r526486169", "bodyText": "hmm.. why does this and the next test require deletion? Changing the machine type shouldn't require it", "author": "calbach", "createdAt": "2020-11-18T23:15:45Z", "path": "ui/src/app/pages/analysis/runtime-panel.spec.tsx", "diffHunk": "@@ -348,30 +365,187 @@ describe('RuntimePanel', () => {\n     expect(memoryOptions.map(m => m.text())).toEqual(['7.2', '30', '52']);\n   });\n \n-  it('should toggle the disabled state of the update button when the configuration changes', async() => {\n+  it('should disable the Update button if there are no changes and runtime is running', async() => {\n+    const wrapper = await component();\n+\n+    expect(wrapper.find(Button).find({'aria-label': 'Update'}).first().prop('disabled')).toBeTruthy();\n+  });\n+\n+  it('should enable the Update button if there are updates that do not require delete and runtime is running - increase disk size', async() => {\n     const wrapper = await component();\n \n-    const updateButton = () => wrapper.find(Button).find({'aria-label': 'Update'}).first();\n-    // Initial state: n1-standard-4, 4 CPU 15 RAM\n-    expect(updateButton().prop('disabled')).toBeTruthy();\n+    await pickMainDiskSize(wrapper, getMainDiskSize(wrapper) + 10);\n+    expect(wrapper.find(Button).find({'aria-label': 'Update'}).first().prop('disabled')).toBeFalsy();\n+  });\n \n-    await pickMainCpu(wrapper, 8);\n-    expect(updateButton().prop('disabled')).toBeFalsy();\n+  it('should enable the Update button if there are updates that do not require delete and runtime is running - number of workers', async() => {\n+    const runtime = {...runtimeApiStub.runtime, gceConfig: null, dataprocConfig: defaultDataprocConfig(), configurationType: RuntimeConfigurationType.UserOverride};\n+    act(() => {runtimeStore.set({runtime: runtime, workspaceNamespace: workspaceStubs[0].namespace}); });\n \n-    await pickMainCpu(wrapper, 4);\n-    expect(updateButton().prop('disabled')).toBeTruthy();\n+    const wrapper = await component();\n \n-    await pickMainRam(wrapper, 26);\n-    expect(updateButton().prop('disabled')).toBeFalsy();\n+    await pickNumWorkers(wrapper, getNumWorkers(wrapper) + 2);\n \n-    await pickMainRam(wrapper, 15);\n-    expect(updateButton().prop('disabled')).toBeTruthy();\n+    expect(wrapper.find(Button).find({'aria-label': 'Update'}).first().prop('disabled')).toBeFalsy();\n+  });\n+\n+  it('should enable the Update button if there are updates that do not require delete and runtime is running - number of preemptible workers', async() => {\n+    const runtime = {...runtimeApiStub.runtime, gceConfig: null, dataprocConfig: defaultDataprocConfig()};\n+    runtimeStore.set({runtime: runtime, workspaceNamespace: workspaceStubs[0].namespace});\n+\n+    const wrapper = await component();\n+\n+    await pickNumPreemptibleWorkers(wrapper, getNumPreemptibleWorkers(wrapper) + 2);\n+\n+    expect(wrapper.find(Button).find({'aria-label': 'Update'}).first().prop('disabled')).toBeFalsy();\n+  });\n+\n+  it('should render the Next button if there are updates that require delete and runtime is running - Compute Type', async() => {\n+    const wrapper = await component();\n \n     await pickComputeType(wrapper, ComputeType.Dataproc);\n-    expect(updateButton().prop('disabled')).toBeFalsy();\n \n-    await pickComputeType(wrapper, ComputeType.Standard);\n-    expect(updateButton().prop('disabled')).toBeTruthy();\n+    expect(wrapper.find(Button).find({'aria-label': 'Next'}).first().prop('disabled')).toBeFalsy();\n+  });\n+\n+  it('should render the Next button if there are updates that require delete and runtime is running - CPU', async() => {", "originalCommit": "b0ff556625e2655f54d362f69f3e53c28b49d8a3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjk2MDU5OQ==", "url": "https://github.com/all-of-us/workbench/pull/4281#discussion_r526960599", "bodyText": "Ah, I was basing this off the behavior that I observed in the Terra application but I misinterpreted what I was seeing. There, changing the CPU/memory requires the \"Next\" workflow even though the cluster does not need to be recreated.\nIt looks like they have 3 different UIs depending on the kind of change you are making.\n\nUpdate with no warning (for changes that do not require even a reboot?)\nNext/Update with a reboot warning\nNext/Update with loss of data warning\n\nIn my implementation, I only have two different UIs and I grouped the latter two together whereas I should have grouped the first two.", "author": "ericsong", "createdAt": "2020-11-19T15:08:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjQ4NjE2OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjQ4Njg2NA==", "url": "https://github.com/all-of-us/workbench/pull/4281#discussion_r526486864", "bodyText": "These two act statements shouldn't be needed, but also - should be able to use your helper function mustClickButton here", "author": "calbach", "createdAt": "2020-11-18T23:17:34Z", "path": "ui/src/app/pages/analysis/runtime-panel.spec.tsx", "diffHunk": "@@ -348,30 +365,187 @@ describe('RuntimePanel', () => {\n     expect(memoryOptions.map(m => m.text())).toEqual(['7.2', '30', '52']);\n   });\n \n-  it('should toggle the disabled state of the update button when the configuration changes', async() => {\n+  it('should disable the Update button if there are no changes and runtime is running', async() => {\n+    const wrapper = await component();\n+\n+    expect(wrapper.find(Button).find({'aria-label': 'Update'}).first().prop('disabled')).toBeTruthy();\n+  });\n+\n+  it('should enable the Update button if there are updates that do not require delete and runtime is running - increase disk size', async() => {\n     const wrapper = await component();\n \n-    const updateButton = () => wrapper.find(Button).find({'aria-label': 'Update'}).first();\n-    // Initial state: n1-standard-4, 4 CPU 15 RAM\n-    expect(updateButton().prop('disabled')).toBeTruthy();\n+    await pickMainDiskSize(wrapper, getMainDiskSize(wrapper) + 10);\n+    expect(wrapper.find(Button).find({'aria-label': 'Update'}).first().prop('disabled')).toBeFalsy();\n+  });\n \n-    await pickMainCpu(wrapper, 8);\n-    expect(updateButton().prop('disabled')).toBeFalsy();\n+  it('should enable the Update button if there are updates that do not require delete and runtime is running - number of workers', async() => {\n+    const runtime = {...runtimeApiStub.runtime, gceConfig: null, dataprocConfig: defaultDataprocConfig(), configurationType: RuntimeConfigurationType.UserOverride};\n+    act(() => {runtimeStore.set({runtime: runtime, workspaceNamespace: workspaceStubs[0].namespace}); });\n \n-    await pickMainCpu(wrapper, 4);\n-    expect(updateButton().prop('disabled')).toBeTruthy();\n+    const wrapper = await component();\n \n-    await pickMainRam(wrapper, 26);\n-    expect(updateButton().prop('disabled')).toBeFalsy();\n+    await pickNumWorkers(wrapper, getNumWorkers(wrapper) + 2);\n \n-    await pickMainRam(wrapper, 15);\n-    expect(updateButton().prop('disabled')).toBeTruthy();\n+    expect(wrapper.find(Button).find({'aria-label': 'Update'}).first().prop('disabled')).toBeFalsy();\n+  });\n+\n+  it('should enable the Update button if there are updates that do not require delete and runtime is running - number of preemptible workers', async() => {\n+    const runtime = {...runtimeApiStub.runtime, gceConfig: null, dataprocConfig: defaultDataprocConfig()};\n+    runtimeStore.set({runtime: runtime, workspaceNamespace: workspaceStubs[0].namespace});\n+\n+    const wrapper = await component();\n+\n+    await pickNumPreemptibleWorkers(wrapper, getNumPreemptibleWorkers(wrapper) + 2);\n+\n+    expect(wrapper.find(Button).find({'aria-label': 'Update'}).first().prop('disabled')).toBeFalsy();\n+  });\n+\n+  it('should render the Next button if there are updates that require delete and runtime is running - Compute Type', async() => {\n+    const wrapper = await component();\n \n     await pickComputeType(wrapper, ComputeType.Dataproc);\n-    expect(updateButton().prop('disabled')).toBeFalsy();\n \n-    await pickComputeType(wrapper, ComputeType.Standard);\n-    expect(updateButton().prop('disabled')).toBeTruthy();\n+    expect(wrapper.find(Button).find({'aria-label': 'Next'}).first().prop('disabled')).toBeFalsy();\n+  });\n+\n+  it('should render the Next button if there are updates that require delete and runtime is running - CPU', async() => {\n+    const wrapper = await component();\n+\n+    await pickMainCpu(wrapper, getMainCpu(wrapper) + 4);\n+\n+    expect(wrapper.find(Button).find({'aria-label': 'Next'}).first().prop('disabled')).toBeFalsy();\n+  });\n+\n+  it('should render the Next button if there are updates that require delete and runtime is running - Memory', async() => {\n+    const wrapper = await component();\n+\n+    // 15 GB -> 26 GB\n+    await pickMainRam(wrapper, 26);\n+\n+    expect(wrapper.find(Button).find({'aria-label': 'Next'}).first().prop('disabled')).toBeFalsy();\n+  });\n+\n+  it('should render the Next button if there are updates that require delete and runtime is running - Decrease Disk', async() => {\n+    const wrapper = await component();\n+\n+    await pickMainDiskSize(wrapper, getMainDiskSize(wrapper) - 5);\n+\n+    expect(wrapper.find(Button).find({'aria-label': 'Next'}).first().prop('disabled')).toBeFalsy();\n+  });\n+\n+  it('should render the Next button if there are updates that require delete and runtime is running - Worker CPU', async() => {\n+    const runtime = {...runtimeApiStub.runtime, gceConfig: null, dataprocConfig: defaultDataprocConfig()};\n+    runtimeStore.set({runtime: runtime, workspaceNamespace: workspaceStubs[0].namespace});\n+\n+    const wrapper = await component();\n+\n+    // 4 -> 8\n+    await pickWorkerCpu(wrapper, 8);\n+\n+    expect(wrapper.find(Button).find({'aria-label': 'Next'}).first().prop('disabled')).toBeFalsy();\n+  });\n+\n+  it('should render the Next button if there are updates that require delete and runtime is running - Worker RAM', async() => {\n+    const runtime = {...runtimeApiStub.runtime, gceConfig: null, dataprocConfig: defaultDataprocConfig()};\n+    runtimeStore.set({runtime: runtime, workspaceNamespace: workspaceStubs[0].namespace});\n+\n+    const wrapper = await component();\n+\n+    // 15 -> 26\n+    await pickWorkerRam(wrapper, 26);\n+\n+    expect(wrapper.find(Button).find({'aria-label': 'Next'}).first().prop('disabled')).toBeFalsy();\n+  });\n+\n+  it('should render the Next button if there are updates that require delete and runtime is running - Worker Disk', async() => {\n+    const runtime = {...runtimeApiStub.runtime, gceConfig: null, dataprocConfig: defaultDataprocConfig()};\n+    runtimeStore.set({runtime: runtime, workspaceNamespace: workspaceStubs[0].namespace});\n+\n+    const wrapper = await component();\n+    await pickWorkerDiskSize(wrapper, getWorkerDiskSize(wrapper) + 10);\n+\n+    expect(wrapper.find(Button).find({'aria-label': 'Next'}).first().prop('disabled')).toBeFalsy();\n+  });\n+\n+  it('should retain original inputs when hitting cancel from the Confirm panel', async() => {\n+    const runtime = {...runtimeApiStub.runtime, gceConfig: null, dataprocConfig: defaultDataprocConfig()};\n+    runtimeStore.set({runtime: runtime, workspaceNamespace: workspaceStubs[0].namespace});\n+\n+    const wrapper = await component();\n+\n+    await pickMainDiskSize(wrapper, 75);\n+    await pickMainCpu(wrapper, 8);\n+    await pickMainRam(wrapper, 30);\n+    await pickWorkerCpu(wrapper, 16);\n+    await pickWorkerRam(wrapper, 60);\n+    await pickNumPreemptibleWorkers(wrapper, 3);\n+    await pickNumWorkers(wrapper, 5);\n+    await pickWorkerDiskSize(wrapper, 100);\n+\n+    act(() => {", "originalCommit": "b0ff556625e2655f54d362f69f3e53c28b49d8a3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjQ4NzI2OQ==", "url": "https://github.com/all-of-us/workbench/pull/4281#discussion_r526487269", "bodyText": "opt: IMO it is cleaner to just check the resulting value in the runtimeApiStub.runtime here, rather than using mocks/spies - but maybe this is not realistic if you don't have any detectable immediate changes in the fake as a result of applying an update", "author": "calbach", "createdAt": "2020-11-18T23:18:38Z", "path": "ui/src/app/pages/analysis/runtime-panel.spec.tsx", "diffHunk": "@@ -348,30 +365,187 @@ describe('RuntimePanel', () => {\n     expect(memoryOptions.map(m => m.text())).toEqual(['7.2', '30', '52']);\n   });\n \n-  it('should toggle the disabled state of the update button when the configuration changes', async() => {\n+  it('should disable the Update button if there are no changes and runtime is running', async() => {\n+    const wrapper = await component();\n+\n+    expect(wrapper.find(Button).find({'aria-label': 'Update'}).first().prop('disabled')).toBeTruthy();\n+  });\n+\n+  it('should enable the Update button if there are updates that do not require delete and runtime is running - increase disk size', async() => {\n     const wrapper = await component();\n \n-    const updateButton = () => wrapper.find(Button).find({'aria-label': 'Update'}).first();\n-    // Initial state: n1-standard-4, 4 CPU 15 RAM\n-    expect(updateButton().prop('disabled')).toBeTruthy();\n+    await pickMainDiskSize(wrapper, getMainDiskSize(wrapper) + 10);\n+    expect(wrapper.find(Button).find({'aria-label': 'Update'}).first().prop('disabled')).toBeFalsy();\n+  });\n \n-    await pickMainCpu(wrapper, 8);\n-    expect(updateButton().prop('disabled')).toBeFalsy();\n+  it('should enable the Update button if there are updates that do not require delete and runtime is running - number of workers', async() => {\n+    const runtime = {...runtimeApiStub.runtime, gceConfig: null, dataprocConfig: defaultDataprocConfig(), configurationType: RuntimeConfigurationType.UserOverride};\n+    act(() => {runtimeStore.set({runtime: runtime, workspaceNamespace: workspaceStubs[0].namespace}); });\n \n-    await pickMainCpu(wrapper, 4);\n-    expect(updateButton().prop('disabled')).toBeTruthy();\n+    const wrapper = await component();\n \n-    await pickMainRam(wrapper, 26);\n-    expect(updateButton().prop('disabled')).toBeFalsy();\n+    await pickNumWorkers(wrapper, getNumWorkers(wrapper) + 2);\n \n-    await pickMainRam(wrapper, 15);\n-    expect(updateButton().prop('disabled')).toBeTruthy();\n+    expect(wrapper.find(Button).find({'aria-label': 'Update'}).first().prop('disabled')).toBeFalsy();\n+  });\n+\n+  it('should enable the Update button if there are updates that do not require delete and runtime is running - number of preemptible workers', async() => {\n+    const runtime = {...runtimeApiStub.runtime, gceConfig: null, dataprocConfig: defaultDataprocConfig()};\n+    runtimeStore.set({runtime: runtime, workspaceNamespace: workspaceStubs[0].namespace});\n+\n+    const wrapper = await component();\n+\n+    await pickNumPreemptibleWorkers(wrapper, getNumPreemptibleWorkers(wrapper) + 2);\n+\n+    expect(wrapper.find(Button).find({'aria-label': 'Update'}).first().prop('disabled')).toBeFalsy();\n+  });\n+\n+  it('should render the Next button if there are updates that require delete and runtime is running - Compute Type', async() => {\n+    const wrapper = await component();\n \n     await pickComputeType(wrapper, ComputeType.Dataproc);\n-    expect(updateButton().prop('disabled')).toBeFalsy();\n \n-    await pickComputeType(wrapper, ComputeType.Standard);\n-    expect(updateButton().prop('disabled')).toBeTruthy();\n+    expect(wrapper.find(Button).find({'aria-label': 'Next'}).first().prop('disabled')).toBeFalsy();\n+  });\n+\n+  it('should render the Next button if there are updates that require delete and runtime is running - CPU', async() => {\n+    const wrapper = await component();\n+\n+    await pickMainCpu(wrapper, getMainCpu(wrapper) + 4);\n+\n+    expect(wrapper.find(Button).find({'aria-label': 'Next'}).first().prop('disabled')).toBeFalsy();\n+  });\n+\n+  it('should render the Next button if there are updates that require delete and runtime is running - Memory', async() => {\n+    const wrapper = await component();\n+\n+    // 15 GB -> 26 GB\n+    await pickMainRam(wrapper, 26);\n+\n+    expect(wrapper.find(Button).find({'aria-label': 'Next'}).first().prop('disabled')).toBeFalsy();\n+  });\n+\n+  it('should render the Next button if there are updates that require delete and runtime is running - Decrease Disk', async() => {\n+    const wrapper = await component();\n+\n+    await pickMainDiskSize(wrapper, getMainDiskSize(wrapper) - 5);\n+\n+    expect(wrapper.find(Button).find({'aria-label': 'Next'}).first().prop('disabled')).toBeFalsy();\n+  });\n+\n+  it('should render the Next button if there are updates that require delete and runtime is running - Worker CPU', async() => {\n+    const runtime = {...runtimeApiStub.runtime, gceConfig: null, dataprocConfig: defaultDataprocConfig()};\n+    runtimeStore.set({runtime: runtime, workspaceNamespace: workspaceStubs[0].namespace});\n+\n+    const wrapper = await component();\n+\n+    // 4 -> 8\n+    await pickWorkerCpu(wrapper, 8);\n+\n+    expect(wrapper.find(Button).find({'aria-label': 'Next'}).first().prop('disabled')).toBeFalsy();\n+  });\n+\n+  it('should render the Next button if there are updates that require delete and runtime is running - Worker RAM', async() => {\n+    const runtime = {...runtimeApiStub.runtime, gceConfig: null, dataprocConfig: defaultDataprocConfig()};\n+    runtimeStore.set({runtime: runtime, workspaceNamespace: workspaceStubs[0].namespace});\n+\n+    const wrapper = await component();\n+\n+    // 15 -> 26\n+    await pickWorkerRam(wrapper, 26);\n+\n+    expect(wrapper.find(Button).find({'aria-label': 'Next'}).first().prop('disabled')).toBeFalsy();\n+  });\n+\n+  it('should render the Next button if there are updates that require delete and runtime is running - Worker Disk', async() => {\n+    const runtime = {...runtimeApiStub.runtime, gceConfig: null, dataprocConfig: defaultDataprocConfig()};\n+    runtimeStore.set({runtime: runtime, workspaceNamespace: workspaceStubs[0].namespace});\n+\n+    const wrapper = await component();\n+    await pickWorkerDiskSize(wrapper, getWorkerDiskSize(wrapper) + 10);\n+\n+    expect(wrapper.find(Button).find({'aria-label': 'Next'}).first().prop('disabled')).toBeFalsy();\n+  });\n+\n+  it('should retain original inputs when hitting cancel from the Confirm panel', async() => {\n+    const runtime = {...runtimeApiStub.runtime, gceConfig: null, dataprocConfig: defaultDataprocConfig()};\n+    runtimeStore.set({runtime: runtime, workspaceNamespace: workspaceStubs[0].namespace});\n+\n+    const wrapper = await component();\n+\n+    await pickMainDiskSize(wrapper, 75);\n+    await pickMainCpu(wrapper, 8);\n+    await pickMainRam(wrapper, 30);\n+    await pickWorkerCpu(wrapper, 16);\n+    await pickWorkerRam(wrapper, 60);\n+    await pickNumPreemptibleWorkers(wrapper, 3);\n+    await pickNumWorkers(wrapper, 5);\n+    await pickWorkerDiskSize(wrapper, 100);\n+\n+    act(() => {\n+      wrapper.find(Button).find({'aria-label': 'Next'}).first().simulate('click');\n+    });\n+    await waitOneTickAndUpdate(wrapper);\n+\n+    act(() => {\n+      wrapper.find(Button).find({'aria-label': 'Cancel'}).first().simulate('click');\n+    });\n+    await waitOneTickAndUpdate(wrapper);\n+\n+    expect(getMainDiskSize(wrapper)).toBe(75);\n+    expect(getMainCpu(wrapper)).toBe(8);\n+    expect(getMainRam(wrapper)).toBe(30);\n+    expect(getWorkerCpu(wrapper)).toBe(16);\n+    expect(getWorkerRam(wrapper)).toBe(60);\n+    expect(getNumPreemptibleWorkers(wrapper)).toBe(3);\n+    expect(getNumWorkers(wrapper)).toBe(5);\n+    expect(getWorkerDiskSize(wrapper)).toBe(100);\n+  });\n+\n+  it('should disable Update button if Runtime is in between states', async() => {\n+    const runtime = {...runtimeApiStub.runtime, gceConfig: null, dataprocConfig: defaultDataprocConfig(), status: RuntimeStatus.Creating};\n+    runtimeStore.set({runtime: runtime, workspaceNamespace: workspaceStubs[0].namespace});\n+\n+    const wrapper = await component();\n+    await pickMainDiskSize(wrapper, getMainDiskSize(wrapper) + 20);\n+\n+    expect(wrapper.find(Button).find({'aria-label': 'Update'}).first().prop('disabled')).toBeTruthy();\n+  });\n+\n+  it('should send an updateRuntime API call if runtime changes do not require a delete', async() => {\n+    const wrapper = await component();\n+\n+    const updateSpy = jest.spyOn(runtimeApi(), 'updateRuntime');", "originalCommit": "b0ff556625e2655f54d362f69f3e53c28b49d8a3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjQ4NzY4NA==", "url": "https://github.com/all-of-us/workbench/pull/4281#discussion_r526487684", "bodyText": "Here it should be possible to just check the Deleting status on the runtime", "author": "calbach", "createdAt": "2020-11-18T23:19:42Z", "path": "ui/src/app/pages/analysis/runtime-panel.spec.tsx", "diffHunk": "@@ -348,30 +365,187 @@ describe('RuntimePanel', () => {\n     expect(memoryOptions.map(m => m.text())).toEqual(['7.2', '30', '52']);\n   });\n \n-  it('should toggle the disabled state of the update button when the configuration changes', async() => {\n+  it('should disable the Update button if there are no changes and runtime is running', async() => {\n+    const wrapper = await component();\n+\n+    expect(wrapper.find(Button).find({'aria-label': 'Update'}).first().prop('disabled')).toBeTruthy();\n+  });\n+\n+  it('should enable the Update button if there are updates that do not require delete and runtime is running - increase disk size', async() => {\n     const wrapper = await component();\n \n-    const updateButton = () => wrapper.find(Button).find({'aria-label': 'Update'}).first();\n-    // Initial state: n1-standard-4, 4 CPU 15 RAM\n-    expect(updateButton().prop('disabled')).toBeTruthy();\n+    await pickMainDiskSize(wrapper, getMainDiskSize(wrapper) + 10);\n+    expect(wrapper.find(Button).find({'aria-label': 'Update'}).first().prop('disabled')).toBeFalsy();\n+  });\n \n-    await pickMainCpu(wrapper, 8);\n-    expect(updateButton().prop('disabled')).toBeFalsy();\n+  it('should enable the Update button if there are updates that do not require delete and runtime is running - number of workers', async() => {\n+    const runtime = {...runtimeApiStub.runtime, gceConfig: null, dataprocConfig: defaultDataprocConfig(), configurationType: RuntimeConfigurationType.UserOverride};\n+    act(() => {runtimeStore.set({runtime: runtime, workspaceNamespace: workspaceStubs[0].namespace}); });\n \n-    await pickMainCpu(wrapper, 4);\n-    expect(updateButton().prop('disabled')).toBeTruthy();\n+    const wrapper = await component();\n \n-    await pickMainRam(wrapper, 26);\n-    expect(updateButton().prop('disabled')).toBeFalsy();\n+    await pickNumWorkers(wrapper, getNumWorkers(wrapper) + 2);\n \n-    await pickMainRam(wrapper, 15);\n-    expect(updateButton().prop('disabled')).toBeTruthy();\n+    expect(wrapper.find(Button).find({'aria-label': 'Update'}).first().prop('disabled')).toBeFalsy();\n+  });\n+\n+  it('should enable the Update button if there are updates that do not require delete and runtime is running - number of preemptible workers', async() => {\n+    const runtime = {...runtimeApiStub.runtime, gceConfig: null, dataprocConfig: defaultDataprocConfig()};\n+    runtimeStore.set({runtime: runtime, workspaceNamespace: workspaceStubs[0].namespace});\n+\n+    const wrapper = await component();\n+\n+    await pickNumPreemptibleWorkers(wrapper, getNumPreemptibleWorkers(wrapper) + 2);\n+\n+    expect(wrapper.find(Button).find({'aria-label': 'Update'}).first().prop('disabled')).toBeFalsy();\n+  });\n+\n+  it('should render the Next button if there are updates that require delete and runtime is running - Compute Type', async() => {\n+    const wrapper = await component();\n \n     await pickComputeType(wrapper, ComputeType.Dataproc);\n-    expect(updateButton().prop('disabled')).toBeFalsy();\n \n-    await pickComputeType(wrapper, ComputeType.Standard);\n-    expect(updateButton().prop('disabled')).toBeTruthy();\n+    expect(wrapper.find(Button).find({'aria-label': 'Next'}).first().prop('disabled')).toBeFalsy();\n+  });\n+\n+  it('should render the Next button if there are updates that require delete and runtime is running - CPU', async() => {\n+    const wrapper = await component();\n+\n+    await pickMainCpu(wrapper, getMainCpu(wrapper) + 4);\n+\n+    expect(wrapper.find(Button).find({'aria-label': 'Next'}).first().prop('disabled')).toBeFalsy();\n+  });\n+\n+  it('should render the Next button if there are updates that require delete and runtime is running - Memory', async() => {\n+    const wrapper = await component();\n+\n+    // 15 GB -> 26 GB\n+    await pickMainRam(wrapper, 26);\n+\n+    expect(wrapper.find(Button).find({'aria-label': 'Next'}).first().prop('disabled')).toBeFalsy();\n+  });\n+\n+  it('should render the Next button if there are updates that require delete and runtime is running - Decrease Disk', async() => {\n+    const wrapper = await component();\n+\n+    await pickMainDiskSize(wrapper, getMainDiskSize(wrapper) - 5);\n+\n+    expect(wrapper.find(Button).find({'aria-label': 'Next'}).first().prop('disabled')).toBeFalsy();\n+  });\n+\n+  it('should render the Next button if there are updates that require delete and runtime is running - Worker CPU', async() => {\n+    const runtime = {...runtimeApiStub.runtime, gceConfig: null, dataprocConfig: defaultDataprocConfig()};\n+    runtimeStore.set({runtime: runtime, workspaceNamespace: workspaceStubs[0].namespace});\n+\n+    const wrapper = await component();\n+\n+    // 4 -> 8\n+    await pickWorkerCpu(wrapper, 8);\n+\n+    expect(wrapper.find(Button).find({'aria-label': 'Next'}).first().prop('disabled')).toBeFalsy();\n+  });\n+\n+  it('should render the Next button if there are updates that require delete and runtime is running - Worker RAM', async() => {\n+    const runtime = {...runtimeApiStub.runtime, gceConfig: null, dataprocConfig: defaultDataprocConfig()};\n+    runtimeStore.set({runtime: runtime, workspaceNamespace: workspaceStubs[0].namespace});\n+\n+    const wrapper = await component();\n+\n+    // 15 -> 26\n+    await pickWorkerRam(wrapper, 26);\n+\n+    expect(wrapper.find(Button).find({'aria-label': 'Next'}).first().prop('disabled')).toBeFalsy();\n+  });\n+\n+  it('should render the Next button if there are updates that require delete and runtime is running - Worker Disk', async() => {\n+    const runtime = {...runtimeApiStub.runtime, gceConfig: null, dataprocConfig: defaultDataprocConfig()};\n+    runtimeStore.set({runtime: runtime, workspaceNamespace: workspaceStubs[0].namespace});\n+\n+    const wrapper = await component();\n+    await pickWorkerDiskSize(wrapper, getWorkerDiskSize(wrapper) + 10);\n+\n+    expect(wrapper.find(Button).find({'aria-label': 'Next'}).first().prop('disabled')).toBeFalsy();\n+  });\n+\n+  it('should retain original inputs when hitting cancel from the Confirm panel', async() => {\n+    const runtime = {...runtimeApiStub.runtime, gceConfig: null, dataprocConfig: defaultDataprocConfig()};\n+    runtimeStore.set({runtime: runtime, workspaceNamespace: workspaceStubs[0].namespace});\n+\n+    const wrapper = await component();\n+\n+    await pickMainDiskSize(wrapper, 75);\n+    await pickMainCpu(wrapper, 8);\n+    await pickMainRam(wrapper, 30);\n+    await pickWorkerCpu(wrapper, 16);\n+    await pickWorkerRam(wrapper, 60);\n+    await pickNumPreemptibleWorkers(wrapper, 3);\n+    await pickNumWorkers(wrapper, 5);\n+    await pickWorkerDiskSize(wrapper, 100);\n+\n+    act(() => {\n+      wrapper.find(Button).find({'aria-label': 'Next'}).first().simulate('click');\n+    });\n+    await waitOneTickAndUpdate(wrapper);\n+\n+    act(() => {\n+      wrapper.find(Button).find({'aria-label': 'Cancel'}).first().simulate('click');\n+    });\n+    await waitOneTickAndUpdate(wrapper);\n+\n+    expect(getMainDiskSize(wrapper)).toBe(75);\n+    expect(getMainCpu(wrapper)).toBe(8);\n+    expect(getMainRam(wrapper)).toBe(30);\n+    expect(getWorkerCpu(wrapper)).toBe(16);\n+    expect(getWorkerRam(wrapper)).toBe(60);\n+    expect(getNumPreemptibleWorkers(wrapper)).toBe(3);\n+    expect(getNumWorkers(wrapper)).toBe(5);\n+    expect(getWorkerDiskSize(wrapper)).toBe(100);\n+  });\n+\n+  it('should disable Update button if Runtime is in between states', async() => {\n+    const runtime = {...runtimeApiStub.runtime, gceConfig: null, dataprocConfig: defaultDataprocConfig(), status: RuntimeStatus.Creating};\n+    runtimeStore.set({runtime: runtime, workspaceNamespace: workspaceStubs[0].namespace});\n+\n+    const wrapper = await component();\n+    await pickMainDiskSize(wrapper, getMainDiskSize(wrapper) + 20);\n+\n+    expect(wrapper.find(Button).find({'aria-label': 'Update'}).first().prop('disabled')).toBeTruthy();\n+  });\n+\n+  it('should send an updateRuntime API call if runtime changes do not require a delete', async() => {\n+    const wrapper = await component();\n+\n+    const updateSpy = jest.spyOn(runtimeApi(), 'updateRuntime');\n+    const deleteSpy = jest.spyOn(runtimeApi(), 'deleteRuntime');\n+\n+    await pickMainDiskSize(wrapper, getMainDiskSize(wrapper) + 20);\n+\n+    await mustClickButton(wrapper, 'Update');\n+\n+    expect(updateSpy).toHaveBeenCalled();\n+    expect(deleteSpy).toHaveBeenCalledTimes(0);\n+  });\n+\n+  it('should send a delete call if an update requires delete', async() => {\n+    const wrapper = await component();\n+\n+    const spy = jest.spyOn(runtimeApi(), 'deleteRuntime');\n+\n+    await pickMainCpu(wrapper, 8);\n+\n+    await mustClickButton(wrapper, 'Next');\n+    await mustClickButton(wrapper, 'Update');\n+\n+    expect(spy).toHaveBeenCalled();", "originalCommit": "b0ff556625e2655f54d362f69f3e53c28b49d8a3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjQ5MzY4Mw==", "url": "https://github.com/all-of-us/workbench/pull/4281#discussion_r526493683", "bodyText": "What I was more suggesting is that you break the uniformity of these function signatures, so that they more directly interact with the values they care about. For example, this method maybe something like:\n[\n  compareComputeTypes(oldRuntime.computeType, newRuntime.computeType),\n  compareMachineCpu(oldRuntime.machine.cpu, ...)\n]\n\nThis way the lower level functions are a bit more tightly scoped.\nI would also put the filtering up one level so you don't need to duplicate it", "author": "calbach", "createdAt": "2020-11-18T23:36:18Z", "path": "ui/src/app/utils/runtime-utils.tsx", "diffHunk": "@@ -1,29 +1,219 @@\n import {runtimeApi} from 'app/services/swagger-fetch-clients';\n-import {switchCase} from 'app/utils';\n-import { withAsyncErrorHandling } from 'app/utils';\n-import {\n-  ExceededActionCountError,\n-  LeoRuntimeInitializationAbortedError,\n-  LeoRuntimeInitializer,\n-} from 'app/utils/leo-runtime-initializer';\n-import {\n-  compoundRuntimeOpStore,\n-  markCompoundRuntimeOperationCompleted,\n-  registerCompoundRuntimeOperation,\n-  runtimeStore,\n-  useStore\n-} from 'app/utils/stores';\n-import {Runtime, RuntimeStatus} from 'generated/fetch';\n+import {switchCase, withAsyncErrorHandling} from 'app/utils';\n+import {ExceededActionCountError, LeoRuntimeInitializationAbortedError, LeoRuntimeInitializer, } from 'app/utils/leo-runtime-initializer';\n+import {compoundRuntimeOpStore, markCompoundRuntimeOperationCompleted, registerCompoundRuntimeOperation, runtimeStore, useStore} from 'app/utils/stores';\n+import {DataprocConfig, Runtime, RuntimeStatus} from 'generated/fetch';\n import * as fp from 'lodash/fp';\n \n import * as React from 'react';\n+import {ComputeType, findMachineByName, Machine} from './machines';\n \n const {useState, useEffect} = React;\n \n export enum RuntimeStatusRequest {\n   Delete = 'Delete'\n }\n \n+export interface RuntimeDiff {\n+  desc: string;\n+  previous: string;\n+  new: string;\n+  differenceType: RuntimeDiffState;\n+}\n+\n+export enum RuntimeDiffState {\n+  NO_CHANGE,\n+  CAN_UPDATE,\n+  NEEDS_DELETE\n+}\n+\n+export interface RuntimeConfig {\n+  computeType: ComputeType;\n+  machine: Machine;\n+  diskSize: number;\n+  dataprocConfig: DataprocConfig;\n+}\n+\n+const compareComputeTypes = (oldRuntime: RuntimeConfig, newRuntime: RuntimeConfig): RuntimeDiff => {\n+  return {\n+    desc: 'Change compute type',\n+    previous: oldRuntime.computeType,\n+    new: newRuntime.computeType,\n+    differenceType: oldRuntime.computeType === newRuntime.computeType ?\n+      RuntimeDiffState.NO_CHANGE : RuntimeDiffState.NEEDS_DELETE\n+  };\n+};\n+\n+const compareMachineCpu = (oldRuntime: RuntimeConfig, newRuntime: RuntimeConfig): RuntimeDiff => {\n+  const oldCpu = oldRuntime.machine.cpu;\n+  const newCpu = newRuntime.machine.cpu;\n+\n+  return {\n+    desc: (newCpu < oldCpu ?  'Decrease' : 'Increase') + ' number of CPUs',\n+    previous: oldCpu.toString(),\n+    new: newCpu.toString(),\n+    differenceType: oldCpu === newCpu ? RuntimeDiffState.NO_CHANGE : RuntimeDiffState.NEEDS_DELETE\n+  };\n+};\n+\n+const compareMachineMemory = (oldRuntime: RuntimeConfig, newRuntime: RuntimeConfig): RuntimeDiff => {\n+  const oldMemory = oldRuntime.machine.memory;\n+  const newMemory = newRuntime.machine.memory;\n+\n+  return {\n+    desc: (newMemory < oldMemory ?  'Decrease' : 'Increase') + ' memory',\n+    previous: oldMemory.toString() + ' GB',\n+    new: newMemory.toString() + ' GB',\n+    differenceType: oldMemory === newMemory ? RuntimeDiffState.NO_CHANGE : RuntimeDiffState.NEEDS_DELETE\n+  };\n+};\n+\n+const compareDiskSize = (oldRuntime: RuntimeConfig, newRuntime: RuntimeConfig): RuntimeDiff => {\n+  let desc = 'Disk Size';\n+  let diffType;\n+\n+  if (newRuntime.diskSize < oldRuntime.diskSize) {\n+    desc = 'Decease ' + desc;\n+    diffType = RuntimeDiffState.NEEDS_DELETE;\n+  } else if (newRuntime.diskSize > oldRuntime.diskSize) {\n+    desc = 'Increase ' + desc;\n+    diffType = RuntimeDiffState.CAN_UPDATE;\n+  } else {\n+    diffType = RuntimeDiffState.NO_CHANGE;\n+  }\n+\n+  return {\n+    desc: desc,\n+    previous: oldRuntime.diskSize.toString() + ' GB',\n+    new: newRuntime.diskSize.toString() + ' GB',\n+    differenceType: diffType\n+  };\n+};\n+\n+const compareWorkerCpu = (oldRuntime: RuntimeConfig, newRuntime: RuntimeConfig): RuntimeDiff => {\n+  if (!oldRuntime.dataprocConfig || !newRuntime.dataprocConfig) {\n+    return null;\n+  }\n+\n+  const oldCpu = findMachineByName(oldRuntime.dataprocConfig.workerMachineType).cpu;\n+  const newCpu = findMachineByName(newRuntime.dataprocConfig.workerMachineType).cpu;\n+\n+  return {\n+    desc: (newCpu < oldCpu ?  'Decrease' : 'Increase') + ' number of CPUs',\n+    previous: oldCpu.toString(),\n+    new: newCpu.toString(),\n+    differenceType: oldCpu === newCpu ? RuntimeDiffState.NO_CHANGE : RuntimeDiffState.NEEDS_DELETE\n+  };\n+};\n+\n+const compareWorkerMemory = (oldRuntime: RuntimeConfig, newRuntime: RuntimeConfig): RuntimeDiff => {\n+  if (!oldRuntime.dataprocConfig || !newRuntime.dataprocConfig) {\n+    return null;\n+  }\n+\n+  const oldMemory = findMachineByName(oldRuntime.dataprocConfig.workerMachineType).memory;\n+  const newMemory = findMachineByName(newRuntime.dataprocConfig.workerMachineType).memory;\n+\n+  return {\n+    desc: (newMemory < oldMemory ?  'Decrease' : 'Increase') + ' memory',\n+    previous: oldMemory.toString() + ' GB',\n+    new: newMemory.toString() + ' GB',\n+    differenceType: oldMemory === newMemory ? RuntimeDiffState.NO_CHANGE : RuntimeDiffState.NEEDS_DELETE\n+  };\n+};\n+\n+const compareDataprocWorkerDiskSize = (oldRuntime: RuntimeConfig, newRuntime: RuntimeConfig): RuntimeDiff => {\n+  if (oldRuntime.dataprocConfig === null || newRuntime.dataprocConfig === null) {\n+    return null;\n+  }\n+\n+  const oldDiskSize = oldRuntime.dataprocConfig.workerDiskSize || 0;\n+  const newDiskSize = newRuntime.dataprocConfig.workerDiskSize || 0;\n+\n+  return {\n+    desc: (newDiskSize < oldDiskSize ?  'Decrease' : 'Increase') + ' worker disk size',\n+    previous: oldDiskSize.toString() + ' GB',\n+    new: newDiskSize.toString() + ' GB',\n+    differenceType: oldDiskSize === newDiskSize ?\n+      RuntimeDiffState.NO_CHANGE : RuntimeDiffState.NEEDS_DELETE\n+  };\n+};\n+\n+const compareDataprocNumberOfPreemptibleWorkers = (oldRuntime: RuntimeConfig, newRuntime: RuntimeConfig): RuntimeDiff => {\n+  if (oldRuntime.dataprocConfig === null || newRuntime.dataprocConfig === null) {\n+    return null;\n+  }\n+\n+  const oldNumWorkers = oldRuntime.dataprocConfig.numberOfPreemptibleWorkers || 0;\n+  const newNumWorkers = newRuntime.dataprocConfig.numberOfPreemptibleWorkers || 0;\n+\n+  return {\n+    desc: (newNumWorkers < oldNumWorkers ?  'Decrease' : 'Increase') + ' number of preemptible workers',\n+    previous: oldNumWorkers.toString(),\n+    new: newNumWorkers.toString(),\n+    differenceType: oldNumWorkers === newNumWorkers ?\n+      RuntimeDiffState.NO_CHANGE : RuntimeDiffState.CAN_UPDATE\n+  };\n+};\n+\n+const compareDataprocNumberOfWorkers = (oldRuntime: RuntimeConfig, newRuntime: RuntimeConfig): RuntimeDiff => {\n+  if (oldRuntime.dataprocConfig === null || newRuntime.dataprocConfig === null) {\n+    return null;\n+  }\n+\n+  const oldNumWorkers = oldRuntime.dataprocConfig.numberOfWorkers || 0;\n+  const newNumWorkers = newRuntime.dataprocConfig.numberOfWorkers || 0;\n+\n+  return {\n+    desc: (newNumWorkers < oldNumWorkers ?  'Decrease' : 'Increase') + ' number of workers',\n+    previous: oldNumWorkers.toString(),\n+    new: newNumWorkers.toString(),\n+    differenceType: oldNumWorkers === newNumWorkers ?\n+      RuntimeDiffState.NO_CHANGE : RuntimeDiffState.CAN_UPDATE\n+  };\n+};\n+\n+const compareDataprocConfig = (oldRuntime, newRuntime) => {\n+  return [compareWorkerCpu, compareWorkerMemory, compareDataprocWorkerDiskSize,\n+    compareDataprocNumberOfPreemptibleWorkers, compareDataprocNumberOfWorkers]\n+    .map(compareFn => compareFn(oldRuntime, newRuntime))\n+    .filter(diff => diff !== null)\n+    .filter(diff => diff.differenceType !== RuntimeDiffState.NO_CHANGE);\n+};\n+\n+const compareMachineConfig = (oldRuntime, newRuntime) => {\n+  return [compareComputeTypes, compareMachineCpu, compareMachineMemory, compareDiskSize]", "originalCommit": "b0ff556625e2655f54d362f69f3e53c28b49d8a3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzA0NDIwNA==", "url": "https://github.com/all-of-us/workbench/pull/4281#discussion_r527044204", "bodyText": "I see. I kind of like having the uniform function signature since it offloads the logic (however simple) of knowing how to access the relevant field to each function rather than in the calling function. In this way, the caller can view all of the comparison functions as the same and do things like the map.", "author": "ericsong", "createdAt": "2020-11-19T16:55:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjQ5MzY4Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjQ5NTMwNQ==", "url": "https://github.com/all-of-us/workbench/pull/4281#discussion_r526495305", "bodyText": "nit: indentation", "author": "calbach", "createdAt": "2020-11-18T23:40:28Z", "path": "ui/src/app/pages/analysis/runtime-panel.tsx", "diffHunk": "@@ -699,18 +821,13 @@ export const RuntimePanel = fp.flow(\n       />],\n       [PanelContent.Customize, () => <Fragment>\n         <div style={styles.controlSection}>\n-          <CostEstimator\n-              freeCreditsRemaining={creatorFreeCreditsRemaining}\n-              profile={profile}\n-              runtimeParameters={{\n-                computeType: selectedCompute,\n-                diskSize: selectedDiskSize,\n-                machineType: selectedMachineType,\n-                dataprocConfig: selectedDataprocConfig\n-              }}\n-              runtimeChanged={runtimeChanged}\n-              workspace={workspace}\n+          <CostInfo runtimeChanged={runtimeChanged}\n+                                runtimeConfig={newRuntimeConfig}", "originalCommit": "b0ff556625e2655f54d362f69f3e53c28b49d8a3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjQ5NjY3OA==", "url": "https://github.com/all-of-us/workbench/pull/4281#discussion_r526496678", "bodyText": "This is big enough that I'd probably just define a private function component here, e.g. see ConfirmPolicy, CreatePanel. I realize you don't get the benefits of the closure, but there's a lot of local state in this function, so defining explicit inputs is probably a positive.\nYou should be able to pass a component as a prop, e.g. for the next/create/update buttons, as I'm guessing this is the main concern.\n<ConfirmUpdate\n  updateButton={renderUpdateButton()}\n  ... />", "author": "calbach", "createdAt": "2020-11-18T23:44:02Z", "path": "ui/src/app/pages/analysis/runtime-panel.tsx", "diffHunk": "@@ -653,12 +666,136 @@ export const RuntimePanel = fp.flow(\n     return <Spinner style={{width: '100%', marginTop: '5rem'}}/>;\n   }\n \n+  const createRuntimeRequest = (runtime: RuntimeConfig) => {\n+    const runtimeRequest: Runtime = runtime.computeType === ComputeType.Dataproc ? {\n+      dataprocConfig: {\n+        ...runtime.dataprocConfig,\n+        masterMachineType: runtime.machine.name,\n+        masterDiskSize: runtime.diskSize\n+      }\n+    } : runtime.computeType === ComputeType.Standard ? {\n+      gceConfig: {\n+        machineType: runtime.machine.name,\n+        diskSize: runtime.diskSize\n+      }\n+    } : null;\n+\n+    // If the selected runtime matches a preset, plumb through the appropriate configuration type.\n+    runtimeRequest.configurationType = fp.get(\n+      'runtimeTemplate.configurationType',\n+      fp.find(\n+        ({runtimeTemplate}) => presetEquals(runtimeRequest, runtimeTemplate),\n+        runtimePresets)\n+    ) || RuntimeConfigurationType.UserOverride;\n+\n+    return runtimeRequest;\n+  };\n+\n+  const renderUpdateButton = () => {\n+    return <Button\n+      aria-label='Update'\n+      disabled={\n+        !runtimeChanged\n+        // Casting to RuntimeStatus here because it can't easily be done at the destructuring level\n+        // where we get 'status' from\n+        || ![RuntimeStatus.Running, RuntimeStatus.Stopped].includes(status as RuntimeStatus)\n+      }\n+      onClick={() => {\n+        setRequestedRuntime(createRuntimeRequest(newRuntimeConfig));\n+        onUpdate();\n+      }}>\n+      Update\n+    </Button>;\n+  };\n+\n+  const renderCreateButton = () => {\n+    return <Button\n+      aria-label='Create'\n+      onClick={() => {\n+        setRequestedRuntime(createRuntimeRequest(newRuntimeConfig));\n+      }}>\n+      Create\n+    </Button>;\n+  };\n+\n+  const renderNextButton = () => {\n+    return <Button\n+      aria-label='Next'\n+      onClick={() => {\n+        setPanelContent(PanelContent.Confirm);\n+      }}>\n+      Next\n+    </Button>;\n+  };\n+\n+  const renderConfirmUpdate = () => {", "originalCommit": "b0ff556625e2655f54d362f69f3e53c28b49d8a3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjUwMzk1NQ==", "url": "https://github.com/all-of-us/workbench/pull/4281#discussion_r526503955", "bodyText": "The update API supports changing the machine type, so why does this require a delete?", "author": "calbach", "createdAt": "2020-11-19T00:03:40Z", "path": "ui/src/app/utils/runtime-utils.tsx", "diffHunk": "@@ -1,29 +1,219 @@\n import {runtimeApi} from 'app/services/swagger-fetch-clients';\n-import {switchCase} from 'app/utils';\n-import { withAsyncErrorHandling } from 'app/utils';\n-import {\n-  ExceededActionCountError,\n-  LeoRuntimeInitializationAbortedError,\n-  LeoRuntimeInitializer,\n-} from 'app/utils/leo-runtime-initializer';\n-import {\n-  compoundRuntimeOpStore,\n-  markCompoundRuntimeOperationCompleted,\n-  registerCompoundRuntimeOperation,\n-  runtimeStore,\n-  useStore\n-} from 'app/utils/stores';\n-import {Runtime, RuntimeStatus} from 'generated/fetch';\n+import {switchCase, withAsyncErrorHandling} from 'app/utils';\n+import {ExceededActionCountError, LeoRuntimeInitializationAbortedError, LeoRuntimeInitializer, } from 'app/utils/leo-runtime-initializer';\n+import {compoundRuntimeOpStore, markCompoundRuntimeOperationCompleted, registerCompoundRuntimeOperation, runtimeStore, useStore} from 'app/utils/stores';\n+import {DataprocConfig, Runtime, RuntimeStatus} from 'generated/fetch';\n import * as fp from 'lodash/fp';\n \n import * as React from 'react';\n+import {ComputeType, findMachineByName, Machine} from './machines';\n \n const {useState, useEffect} = React;\n \n export enum RuntimeStatusRequest {\n   Delete = 'Delete'\n }\n \n+export interface RuntimeDiff {\n+  desc: string;\n+  previous: string;\n+  new: string;\n+  differenceType: RuntimeDiffState;\n+}\n+\n+export enum RuntimeDiffState {\n+  NO_CHANGE,\n+  CAN_UPDATE,\n+  NEEDS_DELETE\n+}\n+\n+export interface RuntimeConfig {\n+  computeType: ComputeType;\n+  machine: Machine;\n+  diskSize: number;\n+  dataprocConfig: DataprocConfig;\n+}\n+\n+const compareComputeTypes = (oldRuntime: RuntimeConfig, newRuntime: RuntimeConfig): RuntimeDiff => {\n+  return {\n+    desc: 'Change compute type',\n+    previous: oldRuntime.computeType,\n+    new: newRuntime.computeType,\n+    differenceType: oldRuntime.computeType === newRuntime.computeType ?\n+      RuntimeDiffState.NO_CHANGE : RuntimeDiffState.NEEDS_DELETE\n+  };\n+};\n+\n+const compareMachineCpu = (oldRuntime: RuntimeConfig, newRuntime: RuntimeConfig): RuntimeDiff => {\n+  const oldCpu = oldRuntime.machine.cpu;\n+  const newCpu = newRuntime.machine.cpu;\n+\n+  return {\n+    desc: (newCpu < oldCpu ?  'Decrease' : 'Increase') + ' number of CPUs',\n+    previous: oldCpu.toString(),\n+    new: newCpu.toString(),\n+    differenceType: oldCpu === newCpu ? RuntimeDiffState.NO_CHANGE : RuntimeDiffState.NEEDS_DELETE", "originalCommit": "b0ff556625e2655f54d362f69f3e53c28b49d8a3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjUyNDM0MQ==", "url": "https://github.com/all-of-us/workbench/pull/4281#discussion_r526524341", "bodyText": "The create button from the Create panel is supposed to close the panel (by invoking onUpdate), may have been lost in the merge conflicts", "author": "calbach", "createdAt": "2020-11-19T01:04:13Z", "path": "ui/src/app/pages/analysis/runtime-panel.tsx", "diffHunk": "@@ -653,12 +666,136 @@ export const RuntimePanel = fp.flow(\n     return <Spinner style={{width: '100%', marginTop: '5rem'}}/>;\n   }\n \n+  const createRuntimeRequest = (runtime: RuntimeConfig) => {\n+    const runtimeRequest: Runtime = runtime.computeType === ComputeType.Dataproc ? {\n+      dataprocConfig: {\n+        ...runtime.dataprocConfig,\n+        masterMachineType: runtime.machine.name,\n+        masterDiskSize: runtime.diskSize\n+      }\n+    } : runtime.computeType === ComputeType.Standard ? {\n+      gceConfig: {\n+        machineType: runtime.machine.name,\n+        diskSize: runtime.diskSize\n+      }\n+    } : null;\n+\n+    // If the selected runtime matches a preset, plumb through the appropriate configuration type.\n+    runtimeRequest.configurationType = fp.get(\n+      'runtimeTemplate.configurationType',\n+      fp.find(\n+        ({runtimeTemplate}) => presetEquals(runtimeRequest, runtimeTemplate),\n+        runtimePresets)\n+    ) || RuntimeConfigurationType.UserOverride;\n+\n+    return runtimeRequest;\n+  };\n+\n+  const renderUpdateButton = () => {\n+    return <Button\n+      aria-label='Update'\n+      disabled={\n+        !runtimeChanged\n+        // Casting to RuntimeStatus here because it can't easily be done at the destructuring level\n+        // where we get 'status' from\n+        || ![RuntimeStatus.Running, RuntimeStatus.Stopped].includes(status as RuntimeStatus)\n+      }\n+      onClick={() => {\n+        setRequestedRuntime(createRuntimeRequest(newRuntimeConfig));\n+        onUpdate();\n+      }}>\n+      Update\n+    </Button>;\n+  };\n+\n+  const renderCreateButton = () => {\n+    return <Button\n+      aria-label='Create'\n+      onClick={() => {\n+        setRequestedRuntime(createRuntimeRequest(newRuntimeConfig));\n+      }}>", "originalCommit": "b0ff556625e2655f54d362f69f3e53c28b49d8a3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjUyNTkyNg==", "url": "https://github.com/all-of-us/workbench/pull/4281#discussion_r526525926", "bodyText": "Huh - wait. This actually isn't clear in the mocks, but I thought that the confirmation page would appear in all cases (whether this was an update OR a delete/recreate). I don't feel strongly on this though, did you discuss this point with Lou / Shimon already?", "author": "calbach", "createdAt": "2020-11-19T01:09:06Z", "path": "ui/src/app/pages/analysis/runtime-panel.tsx", "diffHunk": "@@ -775,16 +878,12 @@ export const RuntimePanel = fp.flow(\n            aria-label='Delete Environment'\n            disabled={![RuntimeStatus.Running, RuntimeStatus.Stopped].includes(status as RuntimeStatus)}\n            onClick={() => setPanelContent(PanelContent.Delete)}>Delete Environment</Link>\n-         <UpdateRuntimeButton\n-           disabled={shouldDisableUpdateButton(runtimeChanged, runtimeExists, status)}\n-           label={runtimeExists ? 'Update' : 'Create'}\n-           onUpdate={() => onUpdate()}\n-           selectedDiskSize={selectedDiskSize}\n-           selectedMachineType={selectedMachineType}\n-           selectedDataprocConfig={selectedDataprocConfig}\n-           setRequestedRuntime={(value) => setRequestedRuntime(value)}\n-         />\n+         {!runtimeExists ? renderCreateButton() :\n+           runtimeDiffs.map(diff => diff.differenceType).includes(RuntimeDiffState.NEEDS_DELETE) ? renderNextButton() :", "originalCommit": "b0ff556625e2655f54d362f69f3e53c28b49d8a3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjUyNjI2OQ==", "url": "https://github.com/all-of-us/workbench/pull/4281#discussion_r526526269", "bodyText": "This can be a follow-up, but I would have thought that the message here would be different in the update vs delete case.", "author": "calbach", "createdAt": "2020-11-19T01:10:04Z", "path": "ui/src/app/pages/analysis/runtime-panel.tsx", "diffHunk": "@@ -739,33 +856,19 @@ export const RuntimePanel = fp.flow(\n                      style={{width: '10rem'}}\n                      options={[ComputeType.Standard, ComputeType.Dataproc]}\n                      value={selectedCompute || ComputeType.Standard}\n-                     onChange={({value}) => setSelectedCompute(value)}\n+                     onChange={({value}) => {setSelectedCompute(value); }}\n                      />\n            {\n              selectedCompute === ComputeType.Dataproc &&\n-             <DataProcConfigSelector onChange={setSelectedDataprocConfig} dataprocConfig={selectedDataprocConfig} />\n+             <DataProcConfigSelector onChange={config => setSelectedDataprocConfig(config)} dataprocConfig={selectedDataprocConfig} />\n            }\n          </FlexColumn>\n        </div>\n-       {runtimeExists && runtimeChanged && <FlexRow\n-           style={{\n-             alignItems: 'center',\n-             backgroundColor: colorWithWhiteness(colors.warning, .9),\n-             border: `1px solid ${colors.warning}`,\n-             borderRadius: '5px',\n-             color: colors.dark,\n-             marginTop: '.5rem',\n-             padding: '.5rem 0px'\n-           }}\n-       >\n-         <ClrIcon\n-             style={{color: colors.warning, marginLeft: '.5rem'}}\n-             shape={'warning-standard'}\n-             size={16}\n-             class={'is-solid'}\n-         />\n-         <div style={{marginLeft: '.5rem'}}>You've made changes that require recreating your environment to take effect.</div>\n-       </FlexRow>}\n+       {runtimeExists && runtimeChanged &&\n+         <WarningMessage>\n+            <div>You've made changes that require recreating your environment to take effect.</div>", "originalCommit": "b0ff556625e2655f54d362f69f3e53c28b49d8a3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjUyNjc5NQ==", "url": "https://github.com/all-of-us/workbench/pull/4281#discussion_r526526795", "bodyText": "This needs to be disabled inthe same manner as the update button", "author": "calbach", "createdAt": "2020-11-19T01:11:42Z", "path": "ui/src/app/pages/analysis/runtime-panel.tsx", "diffHunk": "@@ -653,12 +666,136 @@ export const RuntimePanel = fp.flow(\n     return <Spinner style={{width: '100%', marginTop: '5rem'}}/>;\n   }\n \n+  const createRuntimeRequest = (runtime: RuntimeConfig) => {\n+    const runtimeRequest: Runtime = runtime.computeType === ComputeType.Dataproc ? {\n+      dataprocConfig: {\n+        ...runtime.dataprocConfig,\n+        masterMachineType: runtime.machine.name,\n+        masterDiskSize: runtime.diskSize\n+      }\n+    } : runtime.computeType === ComputeType.Standard ? {\n+      gceConfig: {\n+        machineType: runtime.machine.name,\n+        diskSize: runtime.diskSize\n+      }\n+    } : null;\n+\n+    // If the selected runtime matches a preset, plumb through the appropriate configuration type.\n+    runtimeRequest.configurationType = fp.get(\n+      'runtimeTemplate.configurationType',\n+      fp.find(\n+        ({runtimeTemplate}) => presetEquals(runtimeRequest, runtimeTemplate),\n+        runtimePresets)\n+    ) || RuntimeConfigurationType.UserOverride;\n+\n+    return runtimeRequest;\n+  };\n+\n+  const renderUpdateButton = () => {\n+    return <Button\n+      aria-label='Update'\n+      disabled={\n+        !runtimeChanged\n+        // Casting to RuntimeStatus here because it can't easily be done at the destructuring level\n+        // where we get 'status' from\n+        || ![RuntimeStatus.Running, RuntimeStatus.Stopped].includes(status as RuntimeStatus)\n+      }\n+      onClick={() => {\n+        setRequestedRuntime(createRuntimeRequest(newRuntimeConfig));\n+        onUpdate();\n+      }}>\n+      Update\n+    </Button>;\n+  };\n+\n+  const renderCreateButton = () => {\n+    return <Button\n+      aria-label='Create'\n+      onClick={() => {\n+        setRequestedRuntime(createRuntimeRequest(newRuntimeConfig));\n+      }}>\n+      Create\n+    </Button>;\n+  };\n+\n+  const renderNextButton = () => {\n+    return <Button", "originalCommit": "b0ff556625e2655f54d362f69f3e53c28b49d8a3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "4f667dead844a6ec3d6a522dbae5d953fed585ec", "url": "https://github.com/all-of-us/workbench/commit/4f667dead844a6ec3d6a522dbae5d953fed585ec", "message": "code review", "committedDate": "2020-11-19T16:58:55Z", "type": "commit"}, {"oid": "a90aa65060772f24c77b9258577caf4bca53908f", "url": "https://github.com/all-of-us/workbench/commit/a90aa65060772f24c77b9258577caf4bca53908f", "message": "Always go to Next confirmation panel. Show different warning message depending on type of changes", "committedDate": "2020-11-19T19:08:05Z", "type": "commit"}, {"oid": "396c9930f4d74779d97c71e428d18160b395801c", "url": "https://github.com/all-of-us/workbench/commit/396c9930f4d74779d97c71e428d18160b395801c", "message": "lint and test fix", "committedDate": "2020-11-19T19:09:25Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzE0NDE3MQ==", "url": "https://github.com/all-of-us/workbench/pull/4281#discussion_r527144171", "bodyText": "This selector seems too broad, and could be broken by unrelated future changes on the page - would try to grab a uniquely identifiable parent element (via id or data-test-id) to ensure this is looking at the right thing. Can do repeated .find()s if needed, e.g. wrapper.find({'data-test-id': 'some-parent-id'}).find(TextColumn)", "author": "calbach", "createdAt": "2020-11-19T19:29:59Z", "path": "ui/src/app/pages/analysis/runtime-panel.spec.tsx", "diffHunk": "@@ -365,106 +363,117 @@ describe('RuntimePanel', () => {\n     expect(memoryOptions.map(m => m.text())).toEqual(['7.2', '30', '52']);\n   });\n \n-  it('should disable the Update button if there are no changes and runtime is running', async() => {\n+  it('should disable the Next button if there are no changes and runtime is running', async() => {\n     const wrapper = await component();\n \n-    expect(wrapper.find(Button).find({'aria-label': 'Update'}).first().prop('disabled')).toBeTruthy();\n+    expect(wrapper.find(Button).find({'aria-label': 'Next'}).first().prop('disabled')).toBeTruthy();\n   });\n \n-  it('should enable the Update button if there are updates that do not require delete and runtime is running - increase disk size', async() => {\n+  it('should warn user about reboot if there are updates that require one - increase disk size', async() => {\n     const wrapper = await component();\n \n     await pickMainDiskSize(wrapper, getMainDiskSize(wrapper) + 10);\n-    expect(wrapper.find(Button).find({'aria-label': 'Update'}).first().prop('disabled')).toBeFalsy();\n+    mustClickButton(wrapper, 'Next');\n+\n+    expect(wrapper.find(TextColumn).text().includes('reboot')).toBeTruthy();\n   });\n \n-  it('should enable the Update button if there are updates that do not require delete and runtime is running - number of workers', async() => {\n+  it('should warn user about reboot if there are updates that require one - number of workers', async() => {\n     const runtime = {...runtimeApiStub.runtime, gceConfig: null, dataprocConfig: defaultDataprocConfig(), configurationType: RuntimeConfigurationType.UserOverride};\n-    act(() => {runtimeStore.set({runtime: runtime, workspaceNamespace: workspaceStubs[0].namespace}); });\n+    runtimeStore.set({runtime: runtime, workspaceNamespace: workspaceStubs[0].namespace});\n \n     const wrapper = await component();\n \n     await pickNumWorkers(wrapper, getNumWorkers(wrapper) + 2);\n+    mustClickButton(wrapper, 'Next');\n \n-    expect(wrapper.find(Button).find({'aria-label': 'Update'}).first().prop('disabled')).toBeFalsy();\n+    expect(wrapper.find(TextColumn).text().includes('reboot')).toBeTruthy();", "originalCommit": "396c9930f4d74779d97c71e428d18160b395801c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzE0Njc4OA==", "url": "https://github.com/all-of-us/workbench/pull/4281#discussion_r527146788", "bodyText": "nit: does this need to be function? Seems like it would suffice to just make this a const", "author": "calbach", "createdAt": "2020-11-19T19:34:24Z", "path": "ui/src/app/pages/analysis/runtime-panel.tsx", "diffHunk": "@@ -691,15 +763,17 @@ export const RuntimePanel = fp.flow(\n     return runtimeRequest;\n   };\n \n+  const runtimeCanBeUpdated = () => {", "originalCommit": "396c9930f4d74779d97c71e428d18160b395801c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzE0Nzc2MA==", "url": "https://github.com/all-of-us/workbench/pull/4281#discussion_r527147760", "bodyText": "nit: avoid relative", "author": "calbach", "createdAt": "2020-11-19T19:35:55Z", "path": "ui/src/app/pages/analysis/runtime-panel.spec.tsx", "diffHunk": "@@ -18,6 +18,7 @@ import {waitOneTickAndUpdate} from 'testing/react-test-helpers';\n import {cdrVersionListResponse, CdrVersionsStubVariables} from 'testing/stubs/cdr-versions-api-stub';\n import {defaultDataprocConfig, RuntimeApiStub} from 'testing/stubs/runtime-api-stub';\n import {WorkspacesApiStub, workspaceStubs} from 'testing/stubs/workspaces-api-stub';\n+import {TextColumn} from '../../components/text-column';", "originalCommit": "396c9930f4d74779d97c71e428d18160b395801c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzE4ODk0Nw==", "url": "https://github.com/all-of-us/workbench/pull/4281#discussion_r527188947", "bodyText": "In the mocks, the text of the update button is different in each case. Fine if this gets tracked in the follow-up ticket though.", "author": "calbach", "createdAt": "2020-11-19T20:49:32Z", "path": "ui/src/app/pages/analysis/runtime-panel.tsx", "diffHunk": "@@ -590,6 +590,78 @@ const CreatePanel = ({creatorFreeCreditsRemaining, preset, profile, setPanelCont\n   </div>;\n };\n \n+const ConfirmUpdatePanel = ({initialRuntimeConfig, newRuntimeConfig, onCancel, updateButton}) => {\n+  const runtimeDiffs = getRuntimeConfigDiffs(initialRuntimeConfig, newRuntimeConfig);\n+  const needsDelete = runtimeDiffs.map(diff => diff.differenceType).includes(RuntimeDiffState.NEEDS_DELETE);\n+\n+  return <React.Fragment>\n+    <div style={styles.controlSection}>\n+      <h3 style={{...styles.baseHeader, ...styles.sectionHeader, marginTop: '.1rem', marginBottom: '.2rem'}}>Editing your environment</h3>\n+      <div>\n+        You're about to apply the following changes to your environment:\n+      </div>\n+      <ul>\n+        {runtimeDiffs.map(diff =>\n+          <li>\n+            {diff.desc} from <b>{diff.previous}</b> to <b>{diff.new}</b>\n+          </li>\n+        )}\n+      </ul>\n+      <FlexRow style={{marginTop: '.5rem'}}>\n+        <div style={{marginRight: '1rem'}}>\n+          <b style={{fontSize: 10}}>New estimated cost</b>\n+          <div style={{...styles.costPredictor, padding: '.25rem .5rem'}}>\n+            <CostEstimator runtimeParameters={newRuntimeConfig}/>\n+          </div>\n+        </div>\n+        <div>\n+          <b style={{fontSize: 10}}>Previous estimated cost</b>\n+          <div style={{...styles.costPredictor,\n+            padding: '.25rem .5rem',\n+            color: 'grey',\n+            backgroundColor: ''}}>\n+            <CostEstimator runtimeParameters={initialRuntimeConfig} costTextColor='grey'/>\n+          </div>\n+        </div>\n+      </FlexRow>\n+    </div>\n+\n+    <WarningMessage>\n+      <TextColumn>\n+        {needsDelete ? <React.Fragment>\n+          <div>\n+            You've made changes that can only take effect upon deletion and re-creation of\n+            your cloud environment.\n+          </div>\n+          <div style={{marginTop: '0.5rem'}}>\n+            Any in-memory state and local file modifications will be erased. Data stored in\n+            workspace buckets is never affected by changes to your cloud environment.\n+          </div>\n+        </React.Fragment> : <React.Fragment>\n+          <div>\n+            These changes require a reboot of your environment to take effect.\n+          </div>\n+          <div style={{marginTop: '0.5rem'}}>\n+            Any in-memory state will be erased, but local file modifications will be preserved.\n+            Data stored in workspace buckets is never affected by changes to your cloud environment.\n+          </div>\n+        </React.Fragment>}\n+      </TextColumn>\n+    </WarningMessage>\n+\n+    <FlexRow style={{justifyContent: 'flex-end', marginTop: '.75rem'}}>\n+      <Button\n+        type='secondary'\n+        aria-label='Cancel'\n+        style={{marginRight: '.25rem'}}\n+        onClick={onCancel}>\n+        Cancel\n+      </Button>\n+      {updateButton}", "originalCommit": "396c9930f4d74779d97c71e428d18160b395801c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzI1NDQxOQ==", "url": "https://github.com/all-of-us/workbench/pull/4281#discussion_r527254419", "bodyText": "console.error                                                                                                                                                                        \n    Warning: Each child in a list should have a unique \"key\" prop", "author": "calbach", "createdAt": "2020-11-19T22:45:22Z", "path": "ui/src/app/pages/analysis/runtime-panel.tsx", "diffHunk": "@@ -551,49 +590,83 @@ const CreatePanel = ({creatorFreeCreditsRemaining, preset, profile, setPanelCont\n   </div>;\n };\n \n-const UpdateRuntimeButton = ({\n-   disabled,\n-   label,\n-   onUpdate,\n-   selectedDiskSize,\n-   selectedMachineType,\n-   selectedDataprocConfig,\n-   setRequestedRuntime\n-}) => {\n-  return <Button\n-      aria-label={label}\n-      disabled={disabled}\n-      onClick={() => {\n-        const runtimeToRequest: Runtime = selectedDataprocConfig ? {\n-          dataprocConfig: {\n-            ...selectedDataprocConfig,\n-            masterMachineType: selectedMachineType,\n-            masterDiskSize: selectedDiskSize\n-          }\n-        } : {\n-          gceConfig: {\n-            machineType: selectedMachineType,\n-            diskSize: selectedDiskSize\n-          }\n-        };\n-\n-        // If the selected runtime matches a preset, plumb through the appropriate configuration type.\n-        runtimeToRequest.configurationType = fp.get(\n-          'runtimeTemplate.configurationType',\n-          fp.find(\n-            ({runtimeTemplate}) => presetEquals(runtimeToRequest, runtimeTemplate),\n-            runtimePresets)\n-        ) || RuntimeConfigurationType.UserOverride;\n-        setRequestedRuntime(runtimeToRequest);\n-        onUpdate();\n-      }}>{label}</Button>;\n+const ConfirmUpdatePanel = ({initialRuntimeConfig, newRuntimeConfig, onCancel, updateButton}) => {\n+  const runtimeDiffs = getRuntimeConfigDiffs(initialRuntimeConfig, newRuntimeConfig);\n+  const needsDelete = runtimeDiffs.map(diff => diff.differenceType).includes(RuntimeDiffState.NEEDS_DELETE);\n+\n+  return <React.Fragment>\n+    <div style={styles.controlSection}>\n+      <h3 style={{...styles.baseHeader, ...styles.sectionHeader, marginTop: '.1rem', marginBottom: '.2rem'}}>Editing your environment</h3>\n+      <div>\n+        You're about to apply the following changes to your environment:\n+      </div>\n+      <ul>\n+        {runtimeDiffs.map(diff =>\n+          <li>", "originalCommit": "396c9930f4d74779d97c71e428d18160b395801c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzI1NTIyMg==", "url": "https://github.com/all-of-us/workbench/pull/4281#discussion_r527255222", "bodyText": "Missing await on all these, leading to act() warnings in the test:\nconsole.error                                                                                                                                                                        \n    Warning: You seem to have overlapping act() calls, this is not supported. Be sure to await previous act() calls before making a new one.", "author": "calbach", "createdAt": "2020-11-19T22:47:02Z", "path": "ui/src/app/pages/analysis/runtime-panel.spec.tsx", "diffHunk": "@@ -348,30 +363,190 @@ describe('RuntimePanel', () => {\n     expect(memoryOptions.map(m => m.text())).toEqual(['7.2', '30', '52']);\n   });\n \n-  it('should toggle the disabled state of the update button when the configuration changes', async() => {\n+  it('should disable the Next button if there are no changes and runtime is running', async() => {\n     const wrapper = await component();\n \n-    const updateButton = () => wrapper.find(Button).find({'aria-label': 'Update'}).first();\n-    // Initial state: n1-standard-4, 4 CPU 15 RAM\n-    expect(updateButton().prop('disabled')).toBeTruthy();\n+    expect(wrapper.find(Button).find({'aria-label': 'Next'}).first().prop('disabled')).toBeTruthy();\n+  });\n \n-    await pickMainCpu(wrapper, 8);\n-    expect(updateButton().prop('disabled')).toBeFalsy();\n+  it('should warn user about reboot if there are updates that require one - increase disk size', async() => {\n+    const wrapper = await component();\n+\n+    await pickMainDiskSize(wrapper, getMainDiskSize(wrapper) + 10);\n+    mustClickButton(wrapper, 'Next');\n+\n+    expect(wrapper.find(TextColumn).text().includes('reboot')).toBeTruthy();\n+  });\n+\n+  it('should warn user about reboot if there are updates that require one - number of workers', async() => {\n+    const runtime = {...runtimeApiStub.runtime, gceConfig: null, dataprocConfig: defaultDataprocConfig(), configurationType: RuntimeConfigurationType.UserOverride};\n+    runtimeStore.set({runtime: runtime, workspaceNamespace: workspaceStubs[0].namespace});\n+\n+    const wrapper = await component();\n+\n+    await pickNumWorkers(wrapper, getNumWorkers(wrapper) + 2);\n+    mustClickButton(wrapper, 'Next');\n+\n+    expect(wrapper.find(TextColumn).text().includes('reboot')).toBeTruthy();\n+  });\n+\n+  it('should warn user about reboot if there are updates that require one - number of preemptible workers', async() => {\n+    const runtime = {...runtimeApiStub.runtime, gceConfig: null, dataprocConfig: defaultDataprocConfig()};\n+    runtimeStore.set({runtime: runtime, workspaceNamespace: workspaceStubs[0].namespace});\n+\n+    const wrapper = await component();\n+\n+    await pickNumPreemptibleWorkers(wrapper, getNumPreemptibleWorkers(wrapper) + 2);\n+    mustClickButton(wrapper, 'Next');\n+\n+    expect(wrapper.find(TextColumn).text().includes('reboot')).toBeTruthy();\n+  });\n+\n+  it('should warn user about reboot if there are updates that require one - CPU', async() => {\n+    const wrapper = await component();\n+\n+    await pickMainCpu(wrapper, getMainCpu(wrapper) + 4);\n+    mustClickButton(wrapper, 'Next');\n \n-    await pickMainCpu(wrapper, 4);\n-    expect(updateButton().prop('disabled')).toBeTruthy();\n+    expect(wrapper.find(TextColumn).text().includes('reboot')).toBeTruthy();\n+  });\n+\n+  it('should warn user about reboot if there are updates that require one - Memory', async() => {\n+    const wrapper = await component();\n \n+    // 15 GB -> 26 GB\n     await pickMainRam(wrapper, 26);\n-    expect(updateButton().prop('disabled')).toBeFalsy();\n+    mustClickButton(wrapper, 'Next');\n \n-    await pickMainRam(wrapper, 15);\n-    expect(updateButton().prop('disabled')).toBeTruthy();\n+    expect(wrapper.find(TextColumn).text().includes('reboot')).toBeTruthy();\n+  });\n+\n+  it('should warn user about deletion if there are updates that require one - Compute Type', async() => {\n+    const wrapper = await component();\n \n     await pickComputeType(wrapper, ComputeType.Dataproc);\n-    expect(updateButton().prop('disabled')).toBeFalsy();\n+    mustClickButton(wrapper, 'Next');\n \n-    await pickComputeType(wrapper, ComputeType.Standard);\n-    expect(updateButton().prop('disabled')).toBeTruthy();\n+    expect(wrapper.find(TextColumn).text().includes('deletion')).toBeTruthy();\n+  });\n+\n+  it('should warn user about deletion if there are updates that require one - Decrease Disk', async() => {\n+    const wrapper = await component();\n+\n+    await pickMainDiskSize(wrapper, getMainDiskSize(wrapper) - 5);\n+    mustClickButton(wrapper, 'Next');\n+\n+    expect(wrapper.find(TextColumn).text().includes('deletion')).toBeTruthy();\n+  });\n+\n+  it('should warn the user about deletion if there are updates that require one - Worker CPU', async() => {\n+    const runtime = {...runtimeApiStub.runtime, gceConfig: null, dataprocConfig: defaultDataprocConfig()};\n+    runtimeStore.set({runtime: runtime, workspaceNamespace: workspaceStubs[0].namespace});\n+\n+    const wrapper = await component();\n+\n+    // 4 -> 8\n+    await pickWorkerCpu(wrapper, 8);\n+    mustClickButton(wrapper, 'Next');\n+\n+    expect(wrapper.find(TextColumn).text().includes('deletion')).toBeTruthy();\n+  });\n+\n+  it('should warn the user about deletion if there are updates that require one - Worker RAM', async() => {\n+    const runtime = {...runtimeApiStub.runtime, gceConfig: null, dataprocConfig: defaultDataprocConfig()};\n+    runtimeStore.set({runtime: runtime, workspaceNamespace: workspaceStubs[0].namespace});\n+\n+    const wrapper = await component();\n+\n+    // 15 -> 26\n+    await pickWorkerRam(wrapper, 26);\n+    mustClickButton(wrapper, 'Next');\n+\n+    expect(wrapper.find(TextColumn).text().includes('deletion')).toBeTruthy();\n+  });\n+\n+  it('should warn the user about deletion if there are updates that require one - Worker Disk', async() => {\n+    const runtime = {...runtimeApiStub.runtime, gceConfig: null, dataprocConfig: defaultDataprocConfig()};\n+    runtimeStore.set({runtime: runtime, workspaceNamespace: workspaceStubs[0].namespace});\n+\n+    const wrapper = await component();\n+    await pickWorkerDiskSize(wrapper, getWorkerDiskSize(wrapper) + 10);\n+    mustClickButton(wrapper, 'Next');\n+\n+    expect(wrapper.find(TextColumn).text().includes('deletion')).toBeTruthy();\n+  });\n+\n+  it('should retain original inputs when hitting cancel from the Confirm panel', async() => {\n+    const runtime = {...runtimeApiStub.runtime, gceConfig: null, dataprocConfig: defaultDataprocConfig()};\n+    runtimeStore.set({runtime: runtime, workspaceNamespace: workspaceStubs[0].namespace});\n+\n+    const wrapper = await component();\n+\n+    await pickMainDiskSize(wrapper, 75);\n+    await pickMainCpu(wrapper, 8);\n+    await pickMainRam(wrapper, 30);\n+    await pickWorkerCpu(wrapper, 16);\n+    await pickWorkerRam(wrapper, 60);\n+    await pickNumPreemptibleWorkers(wrapper, 3);\n+    await pickNumWorkers(wrapper, 5);\n+    await pickWorkerDiskSize(wrapper, 100);\n+\n+    mustClickButton(wrapper, 'Next');", "originalCommit": "396c9930f4d74779d97c71e428d18160b395801c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "0aeac23b9ed4c4c70be024c6785b411211248b8f", "url": "https://github.com/all-of-us/workbench/commit/0aeac23b9ed4c4c70be024c6785b411211248b8f", "message": "code review; polling; warning fixes", "committedDate": "2020-11-20T04:47:56Z", "type": "commit"}]}