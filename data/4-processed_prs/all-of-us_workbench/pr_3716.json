{"pr_number": 3716, "pr_title": "[RW-4430][RISK=NO]  UI: add Age at Event as modifier to Surveys", "pr_createdAt": "2020-06-25T21:09:09Z", "pr_url": "https://github.com/all-of-us/workbench/pull/3716", "timeline": [{"oid": "e48577d8faaf189d0ff50cee5583893a4c39a4e1", "url": "https://github.com/all-of-us/workbench/commit/e48577d8faaf189d0ff50cee5583893a4c39a4e1", "message": "UI: Show AGE modifier for Survey", "committedDate": "2020-06-25T21:07:38Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjIzNjg1NQ==", "url": "https://github.com/all-of-us/workbench/pull/3716#discussion_r446236855", "bodyText": "Opt: It could be simpler if we check for Surveys here, then we could remove the line below:\nconst formState = this.modifiersForSurvey;", "author": "dolbeew", "createdAt": "2020-06-26T14:58:54Z", "path": "ui/src/app/cohort-search/modifier-page/modifier-page.component.tsx", "diffHunk": "@@ -250,7 +251,7 @@ export const ModifierPage = withCurrentWorkspace()(\n \n     async componentDidMount() {\n       const {workspace: {cdrVersionId}} = this.props;\n-      const {formState} = this.state;\n+      let {formState} = this.state;", "originalCommit": "e48577d8faaf189d0ff50cee5583893a4c39a4e1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjIzNzY2Ng==", "url": "https://github.com/all-of-us/workbench/pull/3716#discussion_r446237666", "bodyText": "Remove if making the above change", "author": "dolbeew", "createdAt": "2020-06-26T15:00:13Z", "path": "ui/src/app/cohort-search/modifier-page/modifier-page.component.tsx", "diffHunk": "@@ -306,10 +307,19 @@ export const ModifierPage = withCurrentWorkspace()(\n         formState.push(encounters);\n         this.setState({visitCounts});\n       }\n+      formState = this.modifiersForSurvey;", "originalCommit": "e48577d8faaf189d0ff50cee5583893a4c39a4e1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjIzODg5OQ==", "url": "https://github.com/all-of-us/workbench/pull/3716#discussion_r446238899", "bodyText": "We also need to filter the form here for Surveys. When I added a Survey item, then went back in to edit the item, all three modifier fields showed in the form.", "author": "dolbeew", "createdAt": "2020-06-26T15:02:18Z", "path": "ui/src/app/cohort-search/modifier-page/modifier-page.component.tsx", "diffHunk": "@@ -306,10 +307,19 @@ export const ModifierPage = withCurrentWorkspace()(\n         formState.push(encounters);\n         this.setState({visitCounts});\n       }\n+      formState = this.modifiersForSurvey;\n       this.setState({formState});\n       this.getExisting();\n     }\n \n+    get modifiersForSurvey() {\n+      const {formState} = this.state;\n+      const {searchContext: {domain}} = this.props;\n+      if (domain === DomainType.SURVEY) {\n+        return formState.filter(form => SURVEY_MODIFIERS.indexOf(form.name) > -1);\n+      }\n+      return formState;\n+    }\n     getExisting() {\n       const {searchContext} = this.props;\n       const {formState} = this.state;", "originalCommit": "e48577d8faaf189d0ff50cee5583893a4c39a4e1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjI0Njc0OA==", "url": "https://github.com/all-of-us/workbench/pull/3716#discussion_r446246748", "bodyText": "Thanks for adding this! CB is in pretty bad shape in regards to UI testing.", "author": "dolbeew", "createdAt": "2020-06-26T15:16:02Z", "path": "ui/src/app/cohort-search/modifier-page/modifier-page.component.spec.tsx", "diffHunk": "@@ -1,12 +1,62 @@\n-import {shallow} from 'enzyme';\n+import {mount, shallow} from 'enzyme';\n \n+import {cohortBuilderApi, registerApiClient} from 'app/services/swagger-fetch-clients';\n+import {currentWorkspaceStore, serverConfigStore, urlParamsStore} from 'app/utils/navigation';\n+import {\n+  CohortBuilderApi, CohortsApi, DomainType, ModifierType,\n+  WorkspacesApi\n+} from 'generated/fetch';\n import * as React from 'react';\n+import {waitOneTickAndUpdate} from 'testing/react-test-helpers';\n+import {CohortBuilderServiceStub} from 'testing/stubs/cohort-builder-service-stub';\n+import {CohortsApiStub} from 'testing/stubs/cohorts-api-stub';\n+import {WorkspaceStubVariables} from 'testing/stubs/workspaces-api-stub';\n+import {workspaceDataStub, WorkspacesApiStub} from 'testing/stubs/workspaces-api-stub';\n import {ModifierPage} from './modifier-page.component';\n \n \n describe('ListModifierPage', () => {\n+  beforeEach(() => {\n+    registerApiClient(WorkspacesApi, new WorkspacesApiStub());\n+    registerApiClient(CohortBuilderApi, new CohortBuilderServiceStub());\n+\n+    urlParamsStore.next({\n+      ns: WorkspaceStubVariables.DEFAULT_WORKSPACE_NS,\n+      wsid: WorkspaceStubVariables.DEFAULT_WORKSPACE_ID\n+    });\n+    currentWorkspaceStore.next(workspaceDataStub);\n+    serverConfigStore.next({\n+      enableEventDateModifier: true,\n+      gsuiteDomain: 'fake-research-aou.org',\n+      projectId: 'aaa',\n+      publicApiKeyForErrorReports: 'aaa',\n+      enableEraCommons: true,\n+    });\n+  });\n+\n   it('should render', () => {\n     const wrapper = shallow(<ModifierPage disabled={() => {}} wizard={{}}/>);\n     expect(wrapper.exists()).toBeTruthy();\n   });\n+\n+  it('should display Only Age Event modifier for SURVEY', async() => {", "originalCommit": "e48577d8faaf189d0ff50cee5583893a4c39a4e1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "56e638af4d2366987b7f234048dcfed8b8ffe60b", "url": "https://github.com/all-of-us/workbench/commit/56e638af4d2366987b7f234048dcfed8b8ffe60b", "message": "PR comments: Fix edit and move check", "committedDate": "2020-06-29T17:52:35Z", "type": "commit"}]}