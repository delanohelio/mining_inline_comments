{"pr_number": 4198, "pr_title": "[risk=moderate][RW-4852] New auth utils to centralize all Authority checks", "pr_createdAt": "2020-10-21T22:40:46Z", "pr_url": "https://github.com/all-of-us/workbench/pull/4198", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTc3MTM4Mg==", "url": "https://github.com/all-of-us/workbench/pull/4198#discussion_r509771382", "bodyText": "Corrected this one to be RESEARCHERDATAVIEW", "author": "jmthibault79", "createdAt": "2020-10-21T22:41:27Z", "path": "ui/src/app/components/side-nav.tsx", "diffHunk": "@@ -331,47 +332,47 @@ export class SideNav extends React.Component<SideNavProps, SideNavState> {\n         />\n       }\n       {\n-        profile.authorities.includes(Authority.ACCESSCONTROLADMIN) && this.state.showAdminOptions && <SideNavItem\n+        hasAuthorityForPage(profile, AuthGuardedPage.USER_ADMIN) && this.state.showAdminOptions && <SideNavItem\n           content={'User Admin'}\n           onToggleSideNav={() => this.props.onToggleSideNav()}\n           href={'/admin/user'}\n           active={this.props.userAdminActive}\n         />\n       }\n       {\n-        profile.authorities.includes(Authority.ACCESSCONTROLADMIN) && this.state.showAdminOptions && <SideNavItem\n+        hasAuthorityForPage(profile, AuthGuardedPage.USER_AUDIT) && this.state.showAdminOptions && <SideNavItem\n             content={'User Audit'}\n             onToggleSideNav={() => this.props.onToggleSideNav()}\n             href={'/admin/user-audit/'}\n             active={this.props.userAuditActive}\n         />\n       }\n       {\n-        profile.authorities.includes(Authority.COMMUNICATIONSADMIN) && this.state.showAdminOptions && <SideNavItem\n+        hasAuthorityForPage(profile, AuthGuardedPage.SERVICE_BANNER) && this.state.showAdminOptions && <SideNavItem\n             content={'Service Banners'}\n             onToggleSideNav={() => this.props.onToggleSideNav()}\n             href={'/admin/banner'}\n             active={this.props.bannerAdminActive}\n         />\n       }\n       {\n-        profile.authorities.includes(Authority.RESEARCHERDATAVIEW) && this.state.showAdminOptions && <SideNavItem\n+        hasAuthorityForPage(profile, AuthGuardedPage.WORKSPACE_ADMIN) && this.state.showAdminOptions && <SideNavItem\n             content={'Workspaces'}\n             onToggleSideNav={() => this.props.onToggleSideNav()}\n             href={'admin/workspaces'}\n             active={this.props.workspaceAdminActive}\n         />\n       }\n       {\n-        profile.authorities.includes(Authority.ACCESSCONTROLADMIN) && this.state.showAdminOptions && <SideNavItem", "originalCommit": "91c0371f86d2dae1795a34bc7b74b10f67476493", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTc3MzExMg==", "url": "https://github.com/all-of-us/workbench/pull/4198#discussion_r509773112", "bodyText": "Thank you for centralizing this. Could you also add the following logic while we're here to address this long-standing UI bug? https://precisionmedicineinitiative.atlassian.net/browse/RW-4852\nprofile.authorities.includes(Authority.DEVELOPER) || ...", "author": "calbach", "createdAt": "2020-10-21T22:44:28Z", "path": "ui/src/app/utils/auth.tsx", "diffHunk": "@@ -0,0 +1,30 @@\n+// utilities around Authority and page-based authorization\n+\n+import {Authority, Profile} from 'generated/fetch';\n+\n+// Admin pages guarded by a particular Authority\n+enum AuthGuardedPage {\n+    USER_ADMIN,\n+    USER_AUDIT,\n+    WORKSPACE_ADMIN,\n+    WORKSPACE_AUDIT,\n+    SERVICE_BANNER,\n+    INSTITUTION_ADMIN,\n+}\n+\n+const authorityByPage: Map<AuthGuardedPage, Authority> = new Map([\n+    [AuthGuardedPage.USER_ADMIN, Authority.ACCESSCONTROLADMIN],\n+    [AuthGuardedPage.USER_AUDIT, Authority.ACCESSCONTROLADMIN],\n+    [AuthGuardedPage.WORKSPACE_ADMIN, Authority.RESEARCHERDATAVIEW],\n+    [AuthGuardedPage.WORKSPACE_AUDIT, Authority.RESEARCHERDATAVIEW],\n+    [AuthGuardedPage.SERVICE_BANNER, Authority.COMMUNICATIONSADMIN],\n+    [AuthGuardedPage.INSTITUTION_ADMIN, Authority.INSTITUTIONADMIN],\n+]);\n+\n+const hasAuthorityForPage = (profile: Profile, page: AuthGuardedPage): boolean =>\n+    profile.authorities.includes(authorityByPage.get(page));", "originalCommit": "91c0371f86d2dae1795a34bc7b74b10f67476493", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "9e94a750d006bbd553171e502a6d9a5215a64236", "url": "https://github.com/all-of-us/workbench/commit/9e94a750d006bbd553171e502a6d9a5215a64236", "message": "Guard all actions by hasAuthorityForAction() and include DEVELOPER\nupdate side-nav to use new auth utils", "committedDate": "2020-10-22T15:33:50Z", "type": "commit"}, {"oid": "96d41dfc49abe1692fe583f766132d657aee6595", "url": "https://github.com/all-of-us/workbench/commit/96d41dfc49abe1692fe583f766132d657aee6595", "message": "workspace-about-spec", "committedDate": "2020-10-22T15:34:01Z", "type": "commit"}, {"oid": "96d41dfc49abe1692fe583f766132d657aee6595", "url": "https://github.com/all-of-us/workbench/commit/96d41dfc49abe1692fe583f766132d657aee6595", "message": "workspace-about-spec", "committedDate": "2020-10-22T15:34:01Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDI4NDUwNQ==", "url": "https://github.com/all-of-us/workbench/pull/4198#discussion_r510284505", "bodyText": "can't simplify to .some(adminMenuAuthorities.has) because the default signature for some() has extra params", "author": "jmthibault79", "createdAt": "2020-10-22T16:08:14Z", "path": "ui/src/app/utils/auth.tsx", "diffHunk": "@@ -0,0 +1,52 @@\n+// utilities around Authority and page-based authorization\n+\n+import {Authority, Profile} from 'generated/fetch';\n+\n+// Admin actions guarded by a particular Authority\n+enum AuthGuardedAction {\n+    SHOW_ADMIN_MENU,\n+    USER_ADMIN,\n+    USER_AUDIT,\n+    WORKSPACE_ADMIN,\n+    WORKSPACE_AUDIT,\n+    SERVICE_BANNER,\n+    INSTITUTION_ADMIN,\n+    PUBLISH_WORKSPACE,\n+}\n+\n+// The full set of Authorities which guard admin-menu actions\n+const adminMenuAuthorities = new Set([\n+  Authority.ACCESSCONTROLADMIN,\n+  Authority.RESEARCHERDATAVIEW,\n+  Authority.COMMUNICATIONSADMIN,\n+  Authority.INSTITUTIONADMIN,\n+]);\n+\n+const authorityByPage: Map<AuthGuardedAction, Authority> = new Map([\n+    [AuthGuardedAction.USER_ADMIN, Authority.ACCESSCONTROLADMIN],\n+    [AuthGuardedAction.USER_AUDIT, Authority.ACCESSCONTROLADMIN],\n+    [AuthGuardedAction.WORKSPACE_ADMIN, Authority.RESEARCHERDATAVIEW],\n+    [AuthGuardedAction.WORKSPACE_AUDIT, Authority.RESEARCHERDATAVIEW],\n+    [AuthGuardedAction.SERVICE_BANNER, Authority.COMMUNICATIONSADMIN],\n+    [AuthGuardedAction.INSTITUTION_ADMIN, Authority.INSTITUTIONADMIN],\n+    [AuthGuardedAction.PUBLISH_WORKSPACE, Authority.FEATUREDWORKSPACEADMIN],\n+]);\n+\n+const hasAuthorityForAction = (profile: Profile, action: AuthGuardedAction): boolean => {\n+  // DEVELOPER is the super-Authority which includes all others\n+  if (profile.authorities.includes(Authority.DEVELOPER)) {\n+    return true;\n+  }\n+\n+  // return true if we have any of the menu-displaying authorities\n+  if (action === AuthGuardedAction.SHOW_ADMIN_MENU) {\n+    return profile.authorities.some(auth => adminMenuAuthorities.has(auth));", "originalCommit": "96d41dfc49abe1692fe583f766132d657aee6595", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDMyOTExNw==", "url": "https://github.com/all-of-us/workbench/pull/4198#discussion_r510329117", "bodyText": "We should move this to the workspace admin page eventually - I filed https://precisionmedicineinitiative.atlassian.net/browse/RW-5786", "author": "calbach", "createdAt": "2020-10-22T17:17:22Z", "path": "ui/src/app/pages/workspace/workspace-about.tsx", "diffHunk": "@@ -204,12 +204,16 @@ export const WorkspaceAbout = fp.flow(withUserProfile(), withUrlParams(), withCd\n     return <div style={styles.mainPage}>\n       <FlexColumn style={{margin: '1rem', width: '98%'}}>\n         <ResearchPurpose data-test-id='researchPurpose'/>\n-        {profile.authorities.includes(Authority.FEATUREDWORKSPACEADMIN) &&\n-        <div style={{display: 'flex', justifyContent: 'flex-end'}}>\n-            <Button disabled={publishing} type='secondary'\n-                    onClick={() => this.publishUnpublishWorkspace(false)}>Unpublish</Button>\n-            <Button onClick={() => this.publishUnpublishWorkspace(true)}\n-                    disabled={publishing} style={{marginLeft: '0.5rem'}}>Publish</Button>\n+        {hasAuthorityForAction(profile, AuthGuardedAction.PUBLISH_WORKSPACE) &&\n+          <div style={{display: 'flex', justifyContent: 'flex-end'}}>", "originalCommit": "96d41dfc49abe1692fe583f766132d657aee6595", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDMzMDExMA==", "url": "https://github.com/all-of-us/workbench/pull/4198#discussion_r510330110", "bodyText": "nit: auth usually means authentication, authorization, or both. Here I think it means authority instead, I would probably rename the file to authorities.tsx to be more explicit and avoid a third disambiguation", "author": "calbach", "createdAt": "2020-10-22T17:19:01Z", "path": "ui/src/app/utils/auth.tsx", "diffHunk": "@@ -0,0 +1,52 @@\n+// utilities around Authority and page-based authorization", "originalCommit": "96d41dfc49abe1692fe583f766132d657aee6595", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDM0Mzc0Mw==", "url": "https://github.com/all-of-us/workbench/pull/4198#discussion_r510343743", "bodyText": "good call", "author": "jmthibault79", "createdAt": "2020-10-22T17:41:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDMzMDExMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDMzMDI1OA==", "url": "https://github.com/all-of-us/workbench/pull/4198#discussion_r510330258", "bodyText": "nit: per above comment, I would spell this out as AuthorityGuardedAction", "author": "calbach", "createdAt": "2020-10-22T17:19:17Z", "path": "ui/src/app/utils/auth.tsx", "diffHunk": "@@ -0,0 +1,52 @@\n+// utilities around Authority and page-based authorization\n+\n+import {Authority, Profile} from 'generated/fetch';\n+\n+// Admin actions guarded by a particular Authority\n+enum AuthGuardedAction {", "originalCommit": "96d41dfc49abe1692fe583f766132d657aee6595", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "c4f3eaaa1111d6e9c481731625b95033a15cb85d", "url": "https://github.com/all-of-us/workbench/commit/c4f3eaaa1111d6e9c481731625b95033a15cb85d", "message": "better naming", "committedDate": "2020-10-22T17:46:23Z", "type": "commit"}]}