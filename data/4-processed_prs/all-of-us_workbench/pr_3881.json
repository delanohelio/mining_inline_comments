{"pr_number": 3881, "pr_title": "[no ticket][risk=no] Puppeteer Jupyter notebook tests", "pr_createdAt": "2020-08-13T21:58:18Z", "pr_url": "https://github.com/all-of-us/workbench/pull/3881", "timeline": [{"oid": "1df33acb338ce79c6f9e7e4bd80acb3cc0430ac6", "url": "https://github.com/all-of-us/workbench/commit/1df33acb338ce79c6f9e7e4bd80acb3cc0430ac6", "message": "update notebook tests", "committedDate": "2020-08-13T23:36:13Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDkxMTE2Nw==", "url": "https://github.com/all-of-us/workbench/pull/3881#discussion_r470911167", "bodyText": "unnecessary check because next step is find then delete notebook clone.", "author": "aweng98", "createdAt": "2020-08-15T00:08:21Z", "path": "e2e/tests/notebook/notebook-actions.spec.ts", "diffHunk": "@@ -85,14 +79,11 @@ describe('Jupyter notebook tests', () => {\n \n       await workspaceAnalysisPage.duplicateNotebook(notebookName);\n \n-      // Verify duplicate notebook exists\n+      // Delete notebooks\n       const duplNotebookName = `Duplicate of ${notebookName}`;\n-      const resourceCard = new DataResourceCard(page);\n-      const duplNotebookExists = await resourceCard.cardExists(duplNotebookName, CardType.Notebook);\n-      expect(duplNotebookExists).toBe(true);", "originalCommit": "d1228702bef4d3599d26169ad614869f614bd6ce", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDkxMTYyMA==", "url": "https://github.com/all-of-us/workbench/pull/3881#discussion_r470911620", "bodyText": "assertions are done after delete notebooks. this is to make sure delete always happen even if assertion fail.\napplied this new pattern in other notebook tests as well.", "author": "aweng98", "createdAt": "2020-08-15T00:11:17Z", "path": "e2e/tests/notebook/import-r-lib.spec.ts", "diffHunk": "@@ -0,0 +1,84 @@\n+import DataPage, {TabLabelAlias} from 'app/page/data-page';\n+import {Language} from 'app/text-labels';\n+import * as fs from 'fs';\n+import {config} from 'resources/workbench-config';\n+import {makeRandomName} from 'utils/str-utils';\n+import {findWorkspace, signIn} from 'utils/test-utils';\n+import {CellType} from 'app/page/notebook-cell';\n+\n+// Notebook server start may take a long time. Set maximum test running time to 20 minutes.\n+jest.setTimeout(20 * 60 * 1000);\n+\n+describe('Import R libraries', () => {\n+\n+  beforeEach(async () => {\n+    await signIn(page);\n+  });\n+\n+  test('Print sys environment details', async () => {\n+    let rCodeSnippet;\n+    try {\n+      rCodeSnippet = fs.readFileSync('resources/r-code/sys-print.txt', 'utf8');\n+    } catch(e) {\n+      throw new Error(e);\n+    }\n+\n+    const workspaceCard = await findWorkspace(page);\n+    await workspaceCard.clickWorkspaceName();\n+\n+    const dataPage = new DataPage(page);\n+    const notebookName = makeRandomName('print-sys');\n+    const notebook = await dataPage.createNotebook(notebookName, Language.R);\n+\n+    const cellIndex = 1;\n+    const outputText = await notebook.runCodeCell(cellIndex, {code: rCodeSnippet});\n+    console.log(`Code cell [${cellIndex}] output: \\n${outputText}`);\n+\n+    // Delete notebook\n+    const analysisPage = await notebook.goAnalysisPage();\n+    await dataPage.openTab(TabLabelAlias.Analysis);\n+    await analysisPage.deleteNotebook(notebookName);\n+\n+    // UserEmail and Google-bucket is expected to be printed out.\n+    const email = config.userEmail\n+    expect(outputText).toEqual(expect.stringMatching(email));\n+    expect(outputText).toEqual(expect.stringMatching('gs://fc-secure-'))", "originalCommit": "d1228702bef4d3599d26169ad614869f614bd6ce", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTYxNTA0Ng==", "url": "https://github.com/all-of-us/workbench/pull/3881#discussion_r471615046", "bodyText": "nit: don't need this variable, just return", "author": "calbach", "createdAt": "2020-08-17T17:01:06Z", "path": "e2e/app/page/dataset-save-modal.ts", "diffHunk": "@@ -71,4 +78,22 @@ export default class DatasetSaveModal extends Modal {\n     return newDatasetName;\n   }\n \n+  /**\n+   * Click 'See Code Preview' button. Returns code contents.\n+   */\n+  async previewCode(): Promise<string> {\n+    // Click 'See Code Preview' button.\n+    const previewButton = await Button.findByName(this.page, {name: 'See Code Preview'}, this);\n+    await previewButton.click();\n+    await waitUntilChanged(this.page, await previewButton.asElementHandle());\n+\n+    // Find Preview Code\n+    const selector = `${this.getXpath()}//textarea[@data-test-id=\"code-text-box\"]`;\n+    const previewTextArea = new Textarea(this.page, selector);\n+    // Has 'disabled' property\n+    await waitForPropertyExists(this.page, selector, 'disabled');\n+    const previewText = await previewTextArea.getTextContent();", "originalCommit": "d1228702bef4d3599d26169ad614869f614bd6ce", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTY0MTU0NA==", "url": "https://github.com/all-of-us/workbench/pull/3881#discussion_r471641544", "bodyText": "\u2714\ufe0e", "author": "aweng98", "createdAt": "2020-08-17T17:24:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTYxNTA0Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTYxNTQ2Nw==", "url": "https://github.com/all-of-us/workbench/pull/3881#discussion_r471615467", "bodyText": "The constructor indicates this is option, but the type here does not. Which should it be?", "author": "calbach", "createdAt": "2020-08-17T17:01:53Z", "path": "e2e/app/page/notebook-cell.ts", "diffHunk": "@@ -0,0 +1,152 @@\n+import {ElementHandle, Frame, Page} from 'puppeteer';\n+import {getPropValue} from 'utils/element-utils';\n+\n+export enum CellType {\n+  // To append to css selector\n+  Code = '.code_cell',\n+  Markdown = '.text_cell',\n+  Any = '',\n+}\n+\n+export default class NotebookCell {\n+\n+  private readonly page: Page;\n+  private iframe: Frame; // Jupyter notebook in iframe\n+  private cellIndex: number;", "originalCommit": "d1228702bef4d3599d26169ad614869f614bd6ce", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTYxNTk5Ng==", "url": "https://github.com/all-of-us/workbench/pull/3881#discussion_r471615996", "bodyText": "I don't think this variable assignment should be needed:\nconstructor(private page: Page, private cellType: CellType, private cellIndex = ..) {}", "author": "calbach", "createdAt": "2020-08-17T17:02:50Z", "path": "e2e/app/page/notebook-cell.ts", "diffHunk": "@@ -0,0 +1,152 @@\n+import {ElementHandle, Frame, Page} from 'puppeteer';\n+import {getPropValue} from 'utils/element-utils';\n+\n+export enum CellType {\n+  // To append to css selector\n+  Code = '.code_cell',\n+  Markdown = '.text_cell',\n+  Any = '',\n+}\n+\n+export default class NotebookCell {\n+\n+  private readonly page: Page;\n+  private iframe: Frame; // Jupyter notebook in iframe\n+  private cellIndex: number;\n+  private readonly cellType: CellType;\n+\n+\n+  constructor(page: Page, cellType: CellType, cellIndex?: number) {", "originalCommit": "d1228702bef4d3599d26169ad614869f614bd6ce", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTYxODY4Ng==", "url": "https://github.com/all-of-us/workbench/pull/3881#discussion_r471618686", "bodyText": "index", "author": "calbach", "createdAt": "2020-08-17T17:05:16Z", "path": "e2e/app/page/notebook-cell.ts", "diffHunk": "@@ -0,0 +1,152 @@\n+import {ElementHandle, Frame, Page} from 'puppeteer';\n+import {getPropValue} from 'utils/element-utils';\n+\n+export enum CellType {\n+  // To append to css selector\n+  Code = '.code_cell',\n+  Markdown = '.text_cell',\n+  Any = '',\n+}\n+\n+export default class NotebookCell {\n+\n+  private readonly page: Page;\n+  private iframe: Frame; // Jupyter notebook in iframe\n+  private cellIndex: number;\n+  private readonly cellType: CellType;\n+\n+\n+  constructor(page: Page, cellType: CellType, cellIndex?: number) {\n+    this.page = page;\n+    this.cellIndex = cellIndex;\n+    this.cellType = cellType;\n+  }\n+\n+  async getIFrame(): Promise<Frame> {\n+    if (this.iframe === undefined) {\n+      const frame = await this.page.waitForSelector('iframe[src*=\"notebooks\"]');\n+      this.iframe = await frame.contentFrame();\n+    }\n+    return this.iframe;\n+  }\n+\n+  /**\n+   * Set focus in notebook cell.\n+   * @param {number} indx Cell index number.\n+   */\n+  async focusCell(indx?: number): Promise<ElementHandle> {", "originalCommit": "d1228702bef4d3599d26169ad614869f614bd6ce", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTYyMTY5Mw==", "url": "https://github.com/all-of-us/workbench/pull/3881#discussion_r471621693", "bodyText": "Does this change this container to point to a different element on the page? Would it be better to just return a different handle to another cell, rather than letting this be mutable?\nFor example, an issue with this is that you haven't updated cellType to reflect the new cell", "author": "calbach", "createdAt": "2020-08-17T17:07:50Z", "path": "e2e/app/page/notebook-cell.ts", "diffHunk": "@@ -0,0 +1,152 @@\n+import {ElementHandle, Frame, Page} from 'puppeteer';\n+import {getPropValue} from 'utils/element-utils';\n+\n+export enum CellType {\n+  // To append to css selector\n+  Code = '.code_cell',\n+  Markdown = '.text_cell',\n+  Any = '',\n+}\n+\n+export default class NotebookCell {\n+\n+  private readonly page: Page;\n+  private iframe: Frame; // Jupyter notebook in iframe\n+  private cellIndex: number;\n+  private readonly cellType: CellType;\n+\n+\n+  constructor(page: Page, cellType: CellType, cellIndex?: number) {\n+    this.page = page;\n+    this.cellIndex = cellIndex;\n+    this.cellType = cellType;\n+  }\n+\n+  async getIFrame(): Promise<Frame> {\n+    if (this.iframe === undefined) {\n+      const frame = await this.page.waitForSelector('iframe[src*=\"notebooks\"]');\n+      this.iframe = await frame.contentFrame();\n+    }\n+    return this.iframe;\n+  }\n+\n+  /**\n+   * Set focus in notebook cell.", "originalCommit": "d1228702bef4d3599d26169ad614869f614bd6ce", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTYyMjQ2Nw==", "url": "https://github.com/all-of-us/workbench/pull/3881#discussion_r471622467", "bodyText": "Not -1? Is this a 1-based index? 0-based is probably better.", "author": "calbach", "createdAt": "2020-08-17T17:08:31Z", "path": "e2e/app/page/notebook-cell.ts", "diffHunk": "@@ -0,0 +1,152 @@\n+import {ElementHandle, Frame, Page} from 'puppeteer';\n+import {getPropValue} from 'utils/element-utils';\n+\n+export enum CellType {\n+  // To append to css selector\n+  Code = '.code_cell',\n+  Markdown = '.text_cell',\n+  Any = '',\n+}\n+\n+export default class NotebookCell {\n+\n+  private readonly page: Page;\n+  private iframe: Frame; // Jupyter notebook in iframe\n+  private cellIndex: number;\n+  private readonly cellType: CellType;\n+\n+\n+  constructor(page: Page, cellType: CellType, cellIndex?: number) {\n+    this.page = page;\n+    this.cellIndex = cellIndex;\n+    this.cellType = cellType;\n+  }\n+\n+  async getIFrame(): Promise<Frame> {\n+    if (this.iframe === undefined) {\n+      const frame = await this.page.waitForSelector('iframe[src*=\"notebooks\"]');\n+      this.iframe = await frame.contentFrame();\n+    }\n+    return this.iframe;\n+  }\n+\n+  /**\n+   * Set focus in notebook cell.\n+   * @param {number} indx Cell index number.\n+   */\n+  async focusCell(indx?: number): Promise<ElementHandle> {\n+    if (indx !== undefined) {\n+      this.cellIndex = indx;\n+    }\n+    if (this.cellIndex === undefined) {\n+      return this.focusLastCell();\n+    }\n+    const selector = `${this.cellSelector(this.getCellIndex())} .CodeMirror-code`;\n+    const frame = await this.getIFrame();\n+    const cell = await frame.waitForSelector(selector, {visible: true});\n+    await cell.click({delay: 10}); // focus\n+    return cell;\n+  }\n+\n+  /**\n+   * Set focus in last cell.\n+   */\n+  async focusLastCell(): Promise<ElementHandle> {\n+    const selector = `${this.cellSelector()} .CodeMirror-code`;\n+    const frame = await this.getIFrame();\n+    const cells = await frame.$$(selector);\n+    this.cellIndex = cells.length;", "originalCommit": "d1228702bef4d3599d26169ad614869f614bd6ce", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTY1NzE0MQ==", "url": "https://github.com/all-of-us/workbench/pull/3881#discussion_r471657141", "bodyText": "It is 1-based index. I chose this convention because the count in cell prompt starts from 1. I wanted to avoid any confusion.", "author": "aweng98", "createdAt": "2020-08-17T17:46:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTYyMjQ2Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTYyMzUxOQ==", "url": "https://github.com/all-of-us/workbench/pull/3881#discussion_r471623519", "bodyText": "cellIndex should be documented somewhere. For example, it's not clear to me whether this index includes both code and output cells.", "author": "calbach", "createdAt": "2020-08-17T17:09:24Z", "path": "e2e/app/page/notebook-cell.ts", "diffHunk": "@@ -0,0 +1,152 @@\n+import {ElementHandle, Frame, Page} from 'puppeteer';\n+import {getPropValue} from 'utils/element-utils';\n+\n+export enum CellType {\n+  // To append to css selector\n+  Code = '.code_cell',\n+  Markdown = '.text_cell',\n+  Any = '',\n+}\n+\n+export default class NotebookCell {\n+\n+  private readonly page: Page;\n+  private iframe: Frame; // Jupyter notebook in iframe\n+  private cellIndex: number;\n+  private readonly cellType: CellType;\n+\n+\n+  constructor(page: Page, cellType: CellType, cellIndex?: number) {\n+    this.page = page;\n+    this.cellIndex = cellIndex;", "originalCommit": "d1228702bef4d3599d26169ad614869f614bd6ce", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTYyNTAwNQ==", "url": "https://github.com/all-of-us/workbench/pull/3881#discussion_r471625005", "bodyText": "I would probably make some of these private for clarity. I doubt there's a need to use this outside this class.", "author": "calbach", "createdAt": "2020-08-17T17:10:39Z", "path": "e2e/app/page/notebook-cell.ts", "diffHunk": "@@ -0,0 +1,152 @@\n+import {ElementHandle, Frame, Page} from 'puppeteer';\n+import {getPropValue} from 'utils/element-utils';\n+\n+export enum CellType {\n+  // To append to css selector\n+  Code = '.code_cell',\n+  Markdown = '.text_cell',\n+  Any = '',\n+}\n+\n+export default class NotebookCell {\n+\n+  private readonly page: Page;\n+  private iframe: Frame; // Jupyter notebook in iframe\n+  private cellIndex: number;\n+  private readonly cellType: CellType;\n+\n+\n+  constructor(page: Page, cellType: CellType, cellIndex?: number) {\n+    this.page = page;\n+    this.cellIndex = cellIndex;\n+    this.cellType = cellType;\n+  }\n+\n+  async getIFrame(): Promise<Frame> {\n+    if (this.iframe === undefined) {\n+      const frame = await this.page.waitForSelector('iframe[src*=\"notebooks\"]');\n+      this.iframe = await frame.contentFrame();\n+    }\n+    return this.iframe;\n+  }\n+\n+  /**\n+   * Set focus in notebook cell.\n+   * @param {number} indx Cell index number.\n+   */\n+  async focusCell(indx?: number): Promise<ElementHandle> {\n+    if (indx !== undefined) {\n+      this.cellIndex = indx;\n+    }\n+    if (this.cellIndex === undefined) {\n+      return this.focusLastCell();\n+    }\n+    const selector = `${this.cellSelector(this.getCellIndex())} .CodeMirror-code`;\n+    const frame = await this.getIFrame();\n+    const cell = await frame.waitForSelector(selector, {visible: true});\n+    await cell.click({delay: 10}); // focus\n+    return cell;\n+  }\n+\n+  /**\n+   * Set focus in last cell.\n+   */\n+  async focusLastCell(): Promise<ElementHandle> {\n+    const selector = `${this.cellSelector()} .CodeMirror-code`;\n+    const frame = await this.getIFrame();\n+    const cells = await frame.$$(selector);\n+    this.cellIndex = cells.length;\n+    const cell = cells[cells.length - 1];\n+    await cell.click({delay: 10}); // focus\n+    return cell;\n+  }\n+\n+  /**\n+   * Returns cell run result. Result is either stdout or stderr.\n+   * @param {number} timeOut The timeout time in milliseconds.\n+   */\n+  async getRunResult(timeOut: number = 30 * 1000): Promise<string> {\n+    return await Promise.race([\n+      this.getRunResultSuccessText(timeOut),\n+      this.getRunResultErrorText(timeOut),\n+    ]);\n+  }\n+\n+  /**\n+   * Gets cell output texts.\n+   * @param {number} timeOut The timeout time in milliseconds.\n+   */\n+  async getRunResultSuccessText(timeOut?: number): Promise<string> {\n+    const element = await this.findOutputElement(timeOut);\n+    const value = await getPropValue<string>(element, 'innerText');\n+    await element.dispose();\n+    return value.trim();\n+  }\n+\n+  /**\n+   * Gets cell output error.\n+   * @param {number} timeOut The timeout time in milliseconds.\n+   */\n+  async getRunResultErrorText(timeOut?: number): Promise<string> {\n+    const element = await this.findOutputErrorElement(timeOut);\n+    const value = await getPropValue<string>(element, 'innerText');\n+    await element.dispose();\n+    console.error(`Run cell output error: \\n${value}`);\n+    return value.trim();\n+  }\n+\n+  /**\n+   * Find cell output_area element.\n+   * @param {number} timeOut The timeout time in milliseconds.\n+   */\n+  async findOutputElement(timeOut?: number): Promise<ElementHandle> {\n+    const selector = `${this.outputAreaSelector(this.getCellIndex())}:not(.output_error)`;\n+    const iframe = await this.getIFrame();\n+    await iframe.waitForSelector(selector, {visible: true, timeout: timeOut});\n+    const elements = await iframe.$$(selector);\n+    return elements[elements.length - 1];\n+  }\n+\n+  /**\n+   * Find cell output_area error.\n+   * @param {number} timeOut The timeout time in milliseconds.\n+   */\n+  async findOutputErrorElement(timeOut?: number): Promise<ElementHandle> {\n+    const selector = `${this.outputAreaSelector(this.getCellIndex())}.output_error`;\n+    const iframe = await this.getIFrame();\n+    return iframe.waitForSelector(selector, {visible: true, timeout: timeOut});\n+  }\n+\n+  getCellIndex(): number {\n+    return this.cellIndex;\n+  }\n+\n+  outputAreaSelector(indx?: number): string {\n+    return `${this.cellSelector(indx)} .output_subarea`;\n+  }\n+\n+  /**\n+   * Returns css selector for cell.\n+   * @param {number} indx Cell index.\n+   */\n+  cellSelector(indx?: number): string {", "originalCommit": "d1228702bef4d3599d26169ad614869f614bd6ce", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTY4ODk1Mw==", "url": "https://github.com/all-of-us/workbench/pull/3881#discussion_r471688953", "bodyText": "\u2714\ufe0e", "author": "aweng98", "createdAt": "2020-08-17T18:32:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTYyNTAwNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTYyNjQ1Mw==", "url": "https://github.com/all-of-us/workbench/pull/3881#discussion_r471626453", "bodyText": "cellIndex is optional. What does this do then?", "author": "calbach", "createdAt": "2020-08-17T17:11:54Z", "path": "e2e/app/page/notebook-page.ts", "diffHunk": "@@ -28,145 +28,165 @@ export enum KernelStatus {\n }\n \n export default class NotebookPage extends AuthenticatedPage {\n-  private codeCell: CodeCell;\n \n   constructor(page: Page, private readonly documentTitle) {\n     super(page);\n   }\n \n   async isLoaded(): Promise<boolean> {\n     try {\n-      const frame = await this.frame();\n-      this.codeCell = new CodeCell(frame);\n-      // Wait up to 2 minutes.\n-      await Promise.all([\n-        waitForDocumentTitle(this.page, this.documentTitle),\n-        frame.waitForSelector(CssSelector.runCellButton, {visible: true}),\n-        frame.waitForSelector(CodeCellSelector.codeCell, {visible: true}),\n-        frame.waitForSelector(CssSelector.kernelIcon, {visible: true})\n-      ]);\n+      await waitForDocumentTitle(this.page, this.documentTitle);\n+      await this.waitForKernelIdle();\n       return true;\n     } catch (e) {\n-      console.log(`NotebookPage isLoaded() encountered ${e}`);\n+      console.error(`NotebookPage isLoaded() encountered ${e}`);\n       return false;\n     }\n   }\n \n   /**\n-   * Click \"Notebook\" link, goto Workspace Analysis tab. This function does not handle Unsaved Changes confirmation.\n+   * Click \"Notebook\" link, goto Workspace Analysis page.\n+   * This function does not handle Unsaved Changes confirmation.\n    */\n-  async goBackAnalysisPage(): Promise<WorkspaceAnalysisPage> {\n+  async goAnalysisPage(): Promise<WorkspaceAnalysisPage> {\n+    const selector = '//a[text()=\"Notebooks\"]';\n     const navPromise = this.page.waitForNavigation({ waitUntil: ['load', 'domcontentloaded', 'networkidle0'] });\n-    await this.notebookLink().then( (link) => link.click());\n+    await this.page.waitForXPath(selector, {visible: true}).then( (link) => link.click());\n     await navPromise;\n     await waitWhileLoading(this.page);\n     const analysisPage = new WorkspaceAnalysisPage(this.page);\n     await analysisPage.waitForLoad();\n     return analysisPage;\n   }\n \n-  async notebookLink(): Promise<ElementHandle> {\n-    const selector = '//a[text()=\"Notebooks\"]';\n-    return this.page.waitForXPath(selector, {visible: true});\n-  }\n-\n   /**\n-   * Click Run button in toolbar. It run focused cell and insert a new cell below.\n+   * Run focused cell and insert a new cell below. Click Run button in toolbar.\n    */\n-  async runButton(): Promise<void> {\n-    return this.frame()\n-      .then( (iframe) => iframe.waitForSelector(CssSelector.runCellButton, {visible: true}))\n-      .then( (butn) => butn.click() );\n+  async run(): Promise<void> {\n+    const frame = await this.getIframe();\n+    const runButton = await frame.waitForSelector(CssSelector.runCellButton, {visible: true});\n+    await runButton.click();\n+    await runButton.dispose();\n   }\n \n   /**\n-   * Click Save button in toolbar.\n+   * Save notebook. Click Save button in toolbar.\n    */\n-  async saveNotebook(): Promise<void> {\n-    return this.frame()\n-      .then( (iframe) => iframe.waitForSelector(CssSelector.saveNotebookButton, {visible: true}))\n-      .then( (butn) => butn.click() );\n+  async save(): Promise<void> {\n+    const frame = await this.getIframe();\n+    const saveButton = await frame.waitForSelector(CssSelector.saveNotebookButton, {visible: true});\n+    await saveButton.click();\n+    await saveButton.dispose();\n   }\n \n   /**\n    * Wait for notebook kernel becomes ready (idle).\n    */\n-  async waitForKernelIdle(timeOut?: number): Promise<boolean> {\n-    const iconSelector = `${CssSelector.kernelIcon}.kernel_idle_icon`;\n+  async waitForKernelIdle(timeOut?: number): Promise<void> {\n+    const idleIconSelector = `${CssSelector.kernelIcon}.kernel_idle_icon`;\n     const notifSelector = '#notification_kernel';\n-    const frame = await this.frame();\n+    const frame = await this.getIframe();\n     try {\n       await Promise.all([\n-        frame.waitForSelector(iconSelector, {visible: true, timeout: timeOut}),\n+        frame.waitForSelector(idleIconSelector, {visible: true, timeout: timeOut}),\n         frame.waitForSelector(notifSelector, {hidden: true, timeout: timeOut}),\n-      ])\n-      return true;\n+      ]);\n     } catch (e) {\n-      return false;\n+      console.error(`Notebook kernel is: ${await this.kernelStatus()}`);\n+      throw new Error(`waitForKernelIdle encountered ${e}`);\n     }\n   }\n \n-  async kernelStatus(): Promise<KernelStatus | null> {\n-    const elemt = await this.frame().then( (frame) => frame.waitForSelector(CssSelector.kernelIcon, {visible: true}));\n+  async kernelStatus(): Promise<KernelStatus | string> {\n+    const frame = await this.getIframe();\n+    const elemt = await frame.waitForSelector(CssSelector.kernelIcon, {visible: true});\n     const value = await getPropValue<string>(elemt, 'title');\n     await elemt.dispose();\n     Object.keys(KernelStatus).forEach(key => {\n       if (KernelStatus[key] === value) {\n         return key;\n       }\n     })\n-    return null;\n+    return value;\n   }\n \n   async getKernelName(): Promise<string> {\n-    const frame = await this.frame();\n+    const frame = await this.getIframe();\n     const elemt = await frame.waitForSelector(CssSelector.kernelName, {visible: true});\n     const value = await getPropValue<string>(elemt, 'textContent');\n     await elemt.dispose();\n-    return value;\n+    return value.trim();\n   }\n \n   /**\n    * Click Run button in toolbar. It run focused cell and insert a new cell below.\n+   *\n    * @param {number} cellIndex Code Cell index. (index number starts from 1)\n-   * @param {string} code New code.\n-   * @return {string} Output string.\n+   * @param {string} code The code to run.\n+   * @param {number} timeOut The timeout time in milliseconds.\n+   *\n    */\n-  async runCodeCell(cellIndex: number, opts: { code?: string, timeOut?: number }): Promise<string> {\n-    await this.codeCell.selectCell(cellIndex, opts.code);\n-    await this.runButton();\n+  async runCodeCell(cellIndex?: number, opts: { code?: string, timeOut?: number } = {}): Promise<string> {\n+    const cell = await this.findCell(cellIndex);", "originalCommit": "d1228702bef4d3599d26169ad614869f614bd6ce", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTYyODYzNg==", "url": "https://github.com/all-of-us/workbench/pull/3881#discussion_r471628636", "bodyText": ".py and .R seem like more accurate file extensions here", "author": "calbach", "createdAt": "2020-08-17T17:13:40Z", "path": "e2e/resources/python-code/import-libs.txt", "diffHunk": "@@ -0,0 +1,23 @@\n+import dateutil", "originalCommit": "d1228702bef4d3599d26169ad614869f614bd6ce", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTY1MjQyNQ==", "url": "https://github.com/all-of-us/workbench/pull/3881#discussion_r471652425", "bodyText": "\u2714\ufe0e", "author": "aweng98", "createdAt": "2020-08-17T17:37:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTYyODYzNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTYyOTM1OQ==", "url": "https://github.com/all-of-us/workbench/pull/3881#discussion_r471629359", "bodyText": "Why bother catching this only to immediately rethrow it?", "author": "calbach", "createdAt": "2020-08-17T17:14:18Z", "path": "e2e/tests/notebook/import-python-lib.spec.ts", "diffHunk": "@@ -0,0 +1,76 @@\n+import {findWorkspace, signIn} from 'utils/test-utils';\n+import DataPage, {TabLabelAlias} from 'app/page/data-page';\n+import {makeRandomName} from 'utils/str-utils';\n+import {config} from 'resources/workbench-config';\n+import * as fs from 'fs';\n+\n+// Notebook server start may take a long time. Set maximum test running time to 20 minutes.\n+jest.setTimeout(20 * 60 * 1000);\n+\n+describe('Import Python libraries', () => {\n+\n+  beforeEach(async () => {\n+    await signIn(page);\n+  });\n+\n+  test('Import os', async () => {\n+    let codeSnippet;\n+    try {\n+      codeSnippet = fs.readFileSync('resources/python-code/import-os.txt', 'utf8');\n+    } catch(e) {\n+      throw new Error(e);", "originalCommit": "d1228702bef4d3599d26169ad614869f614bd6ce", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTY1Mjk2OQ==", "url": "https://github.com/all-of-us/workbench/pull/3881#discussion_r471652969", "bodyText": "\u2714\ufe0e Removed try/catch. It didn't make any sense.", "author": "aweng98", "createdAt": "2020-08-17T17:38:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTYyOTM1OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTYzMjMxNg==", "url": "https://github.com/all-of-us/workbench/pull/3881#discussion_r471632316", "bodyText": "Should we just have a second file for each of these inputs that includes the expected output?\nAlternatively, should we have each of these snippets output a specific string on success? e.g. \"success\", to make this checking more consistent?", "author": "calbach", "createdAt": "2020-08-17T17:16:40Z", "path": "e2e/tests/notebook/import-python-lib.spec.ts", "diffHunk": "@@ -0,0 +1,76 @@\n+import {findWorkspace, signIn} from 'utils/test-utils';\n+import DataPage, {TabLabelAlias} from 'app/page/data-page';\n+import {makeRandomName} from 'utils/str-utils';\n+import {config} from 'resources/workbench-config';\n+import * as fs from 'fs';\n+\n+// Notebook server start may take a long time. Set maximum test running time to 20 minutes.\n+jest.setTimeout(20 * 60 * 1000);\n+\n+describe('Import Python libraries', () => {\n+\n+  beforeEach(async () => {\n+    await signIn(page);\n+  });\n+\n+  test('Import os', async () => {\n+    let codeSnippet;\n+    try {\n+      codeSnippet = fs.readFileSync('resources/python-code/import-os.txt', 'utf8');\n+    } catch(e) {\n+      throw new Error(e);\n+    }\n+\n+    const workspaceCard = await findWorkspace(page);\n+    await workspaceCard.clickWorkspaceName();\n+\n+    const dataPage = new DataPage(page);\n+    const notebookName = makeRandomName('import-os');\n+    const notebook = await dataPage.createNotebook(notebookName);\n+    await notebook.waitForKernelIdle();\n+\n+    const cellIndex = 1;\n+    const outputText = await notebook.runCodeCell(cellIndex, {code: codeSnippet});\n+\n+    // Delete notebook\n+    const analysisPage = await notebook.goAnalysisPage();\n+    await dataPage.openTab(TabLabelAlias.Analysis);\n+    await analysisPage.deleteNotebook(notebookName);\n+\n+    // Partial values check: UserEmail and python3 path is expected to be printed out.\n+    const partialArray = [\n+      '/usr/local/bin/python3',", "originalCommit": "d1228702bef4d3599d26169ad614869f614bd6ce", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTg1MTU3Mg==", "url": "https://github.com/all-of-us/workbench/pull/3881#discussion_r471851572", "bodyText": "expected code output vary per workspace.\nprint(os.getenv('OWNER_EMAIL'))\nprint(os.getenv('WORKSPACE_CDR'))\nprint(os.getenv('WORKSPACE_NAMESPACE'))\nprint(os.getenv('GOOGLE_PROJECT')) # same as WORKSPACE_NAMESPACE\nprint(os.getenv('CLUSTER_NAME'))\nprint(os.getenv('WORKSPACE_BUCKET'))", "author": "aweng98", "createdAt": "2020-08-18T00:50:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTYzMjMxNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjQzOTc2Ng==", "url": "https://github.com/all-of-us/workbench/pull/3881#discussion_r472439766", "bodyText": "Having a consistent \"success\" output should still be possible, for example:\nassert os.getenv('OWNER_EMAIL')\nassert os.getenv('WORKSPACE_CDR')\nassert os.getenv('WORKSPACE_NAMESPACE')\nassert os.getenv('GOOGLE_PROJECT') # same as WORKSPACE_NAMESPACE\nassert os.getenv('CLUSTER_NAME')\nassert os.getenv('WORKSPACE_BUCKET')\n\nprint('success')", "author": "calbach", "createdAt": "2020-08-18T19:47:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTYzMjMxNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTYzMzg1MQ==", "url": "https://github.com/all-of-us/workbench/pull/3881#discussion_r471633851", "bodyText": "Please move most of this to a helper. This is 95% identical to the other test method", "author": "calbach", "createdAt": "2020-08-17T17:18:02Z", "path": "e2e/tests/notebook/import-python-lib.spec.ts", "diffHunk": "@@ -0,0 +1,76 @@\n+import {findWorkspace, signIn} from 'utils/test-utils';\n+import DataPage, {TabLabelAlias} from 'app/page/data-page';\n+import {makeRandomName} from 'utils/str-utils';\n+import {config} from 'resources/workbench-config';\n+import * as fs from 'fs';\n+\n+// Notebook server start may take a long time. Set maximum test running time to 20 minutes.\n+jest.setTimeout(20 * 60 * 1000);\n+\n+describe('Import Python libraries', () => {\n+\n+  beforeEach(async () => {\n+    await signIn(page);\n+  });\n+\n+  test('Import os', async () => {\n+    let codeSnippet;\n+    try {\n+      codeSnippet = fs.readFileSync('resources/python-code/import-os.txt', 'utf8');\n+    } catch(e) {\n+      throw new Error(e);\n+    }\n+\n+    const workspaceCard = await findWorkspace(page);\n+    await workspaceCard.clickWorkspaceName();\n+\n+    const dataPage = new DataPage(page);\n+    const notebookName = makeRandomName('import-os');\n+    const notebook = await dataPage.createNotebook(notebookName);\n+    await notebook.waitForKernelIdle();\n+\n+    const cellIndex = 1;\n+    const outputText = await notebook.runCodeCell(cellIndex, {code: codeSnippet});\n+\n+    // Delete notebook\n+    const analysisPage = await notebook.goAnalysisPage();\n+    await dataPage.openTab(TabLabelAlias.Analysis);\n+    await analysisPage.deleteNotebook(notebookName);\n+\n+    // Partial values check: UserEmail and python3 path is expected to be printed out.\n+    const partialArray = [\n+      '/usr/local/bin/python3',\n+      config.userEmail,\n+    ];\n+    const outputTextArray = outputText.split(/\\n/);\n+    expect(outputTextArray).toEqual(expect.arrayContaining(partialArray));\n+  });\n+\n+  test('Import common lib', async () => {\n+    let codeSnippet;", "originalCommit": "d1228702bef4d3599d26169ad614869f614bd6ce", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTYzNTIwMQ==", "url": "https://github.com/all-of-us/workbench/pull/3881#discussion_r471635201", "bodyText": "Won't this affect any test which gets run after this one?", "author": "calbach", "createdAt": "2020-08-17T17:19:09Z", "path": "e2e/tests/notebook/import-r-lib.spec.ts", "diffHunk": "@@ -0,0 +1,84 @@\n+import DataPage, {TabLabelAlias} from 'app/page/data-page';\n+import {Language} from 'app/text-labels';\n+import * as fs from 'fs';\n+import {config} from 'resources/workbench-config';\n+import {makeRandomName} from 'utils/str-utils';\n+import {findWorkspace, signIn} from 'utils/test-utils';\n+import {CellType} from 'app/page/notebook-cell';\n+\n+// Notebook server start may take a long time. Set maximum test running time to 20 minutes.\n+jest.setTimeout(20 * 60 * 1000);", "originalCommit": "d1228702bef4d3599d26169ad614869f614bd6ce", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTY1NTAxMA==", "url": "https://github.com/all-of-us/workbench/pull/3881#discussion_r471655010", "bodyText": "no, affects only tests in this file.", "author": "aweng98", "createdAt": "2020-08-17T17:42:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTYzNTIwMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTYzNjIwMw==", "url": "https://github.com/all-of-us/workbench/pull/3881#discussion_r471636203", "bodyText": "Please eliminate duplicate code here as well", "author": "calbach", "createdAt": "2020-08-17T17:19:56Z", "path": "e2e/tests/notebook/import-r-lib.spec.ts", "diffHunk": "@@ -0,0 +1,84 @@\n+import DataPage, {TabLabelAlias} from 'app/page/data-page';\n+import {Language} from 'app/text-labels';\n+import * as fs from 'fs';\n+import {config} from 'resources/workbench-config';\n+import {makeRandomName} from 'utils/str-utils';\n+import {findWorkspace, signIn} from 'utils/test-utils';\n+import {CellType} from 'app/page/notebook-cell';\n+\n+// Notebook server start may take a long time. Set maximum test running time to 20 minutes.\n+jest.setTimeout(20 * 60 * 1000);\n+\n+describe('Import R libraries', () => {\n+\n+  beforeEach(async () => {\n+    await signIn(page);\n+  });\n+\n+  test('Print sys environment details', async () => {\n+    let rCodeSnippet;\n+    try {\n+      rCodeSnippet = fs.readFileSync('resources/r-code/sys-print.txt', 'utf8');\n+    } catch(e) {\n+      throw new Error(e);\n+    }\n+\n+    const workspaceCard = await findWorkspace(page);\n+    await workspaceCard.clickWorkspaceName();\n+\n+    const dataPage = new DataPage(page);\n+    const notebookName = makeRandomName('print-sys');\n+    const notebook = await dataPage.createNotebook(notebookName, Language.R);\n+\n+    const cellIndex = 1;\n+    const outputText = await notebook.runCodeCell(cellIndex, {code: rCodeSnippet});\n+    console.log(`Code cell [${cellIndex}] output: \\n${outputText}`);\n+\n+    // Delete notebook\n+    const analysisPage = await notebook.goAnalysisPage();\n+    await dataPage.openTab(TabLabelAlias.Analysis);\n+    await analysisPage.deleteNotebook(notebookName);\n+\n+    // UserEmail and Google-bucket is expected to be printed out.\n+    const email = config.userEmail\n+    expect(outputText).toEqual(expect.stringMatching(email));\n+    expect(outputText).toEqual(expect.stringMatching('gs://fc-secure-'))\n+  });\n+\n+  test('Import common lib', async () => {\n+    let rCodeSnippet;", "originalCommit": "d1228702bef4d3599d26169ad614869f614bd6ce", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "25904b810730e3283cb95c60a86ce752456d216b", "url": "https://github.com/all-of-us/workbench/commit/25904b810730e3283cb95c60a86ce752456d216b", "message": "new notebook tests", "committedDate": "2020-08-18T03:34:01Z", "type": "forcePushed"}, {"oid": "b1ed9146427059465634d8f6c55f2dcb353100b0", "url": "https://github.com/all-of-us/workbench/commit/b1ed9146427059465634d8f6c55f2dcb353100b0", "message": "new notebook tests", "committedDate": "2020-08-18T18:33:22Z", "type": "commit"}, {"oid": "4adcb42453ad5a8c3c50ae386972a68e01cb8a6e", "url": "https://github.com/all-of-us/workbench/commit/4adcb42453ad5a8c3c50ae386972a68e01cb8a6e", "message": "check selected property in focus function", "committedDate": "2020-08-18T18:33:22Z", "type": "commit"}, {"oid": "db7b1ebfb55d73be9350eeee3ed3e661cbd2eeab", "url": "https://github.com/all-of-us/workbench/commit/db7b1ebfb55d73be9350eeee3ed3e661cbd2eeab", "message": "revert authenticated-page", "committedDate": "2020-08-18T18:35:15Z", "type": "commit"}, {"oid": "db7b1ebfb55d73be9350eeee3ed3e661cbd2eeab", "url": "https://github.com/all-of-us/workbench/commit/db7b1ebfb55d73be9350eeee3ed3e661cbd2eeab", "message": "revert authenticated-page", "committedDate": "2020-08-18T18:35:15Z", "type": "forcePushed"}, {"oid": "0d68c9bfd3420206f0df277b85b757a0175a8385", "url": "https://github.com/all-of-us/workbench/commit/0d68c9bfd3420206f0df277b85b757a0175a8385", "message": "small change", "committedDate": "2020-08-18T18:40:37Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjQ0MDcyMA==", "url": "https://github.com/all-of-us/workbench/pull/3881#discussion_r472440720", "bodyText": "I still think there's too much duplication. The only difference between these methods should be the input file. Even the output should be identical if you follow my other suggestion - else the helper can simply return the outputText and just handle the assertions in the test.", "author": "calbach", "createdAt": "2020-08-18T19:49:43Z", "path": "e2e/tests/notebook/import-python-lib.spec.ts", "diffHunk": "@@ -0,0 +1,50 @@\n+import {findWorkspace, signIn} from 'utils/test-utils';\n+import DataPage from 'app/page/data-page';\n+import {makeRandomName} from 'utils/str-utils';\n+import {config} from 'resources/workbench-config';\n+\n+// Notebook server start may take a long time. Set maximum test running time to 20 minutes.\n+jest.setTimeout(20 * 60 * 1000);\n+\n+describe('Import Python libraries', () => {\n+\n+  beforeEach(async () => {\n+    await signIn(page);\n+  });\n+\n+  test('Import os', async () => {\n+    const workspaceCard = await findWorkspace(page);\n+    await workspaceCard.clickWorkspaceName();\n+\n+    const dataPage = new DataPage(page);\n+    const notebookName = makeRandomName('import-os');\n+    const notebook = await dataPage.createNotebook(notebookName);\n+    const outputText = await notebook.runCodeCell(1, {codeFile: 'resources/python-code/import-os.py'});\n+\n+    await notebook.deleteNotebook(notebookName);\n+\n+    // Partial values check: UserEmail and python3 path is expected to be printed out.\n+    // rest of output strings vary per workspace.\n+    const partialArray = [\n+      '/usr/local/bin/python3',\n+      config.userEmail,\n+    ];\n+    const outputTextArray = outputText.split(/\\n/);\n+    expect(outputTextArray).toEqual(expect.arrayContaining(partialArray));\n+  });\n+\n+  test('Import common lib', async () => {\n+    const workspaceCard = await findWorkspace(page);", "originalCommit": "0d68c9bfd3420206f0df277b85b757a0175a8385", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjQ0MTgzMg==", "url": "https://github.com/all-of-us/workbench/pull/3881#discussion_r472441832", "bodyText": "To be clear, the numbers shown in the Jupyter UI are not cell indices. They correspond to the execution history of the notebook. For example, you can execute the 4th cell before you execute the first one. If you do this, your notebook will look like:\n[2] cell0\n    cell1\n    cell2\n[1] cell3\n\nWhen you start the notebook, no cell will have this label. If you always execute the notebook in a linear fashion, then they will look like they are just 1-indexed cell labels, so I can see how this could be confusing to someone who is debugging the test.\nPersonally, I would still prefer 0-indexed here. This is probably what I would assume the test code would do, rather than yielding to the UI.", "author": "calbach", "createdAt": "2020-08-18T19:51:49Z", "path": "e2e/app/page/notebook-cell.ts", "diffHunk": "@@ -0,0 +1,177 @@\n+import {ElementHandle, Frame, Page} from 'puppeteer';\n+import {getPropValue} from 'utils/element-utils';\n+\n+export enum CellType {\n+  // To append to css selector\n+  Code = '.code_cell',\n+  Markdown = '.text_cell',\n+  Any = '',\n+}\n+\n+/**\n+ * Notebook Cell represents the root element that contains both the code input and output cells.\n+ */\n+export default class NotebookCell {\n+\n+  private readonly page: Page;\n+  private iframe: Frame; // Jupyter notebook iframe\n+  private cellIndex: number; // 1-based cell index because notebook cell prompt index starts from 1.", "originalCommit": "0d68c9bfd3420206f0df277b85b757a0175a8385", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzExNzI3MA==", "url": "https://github.com/all-of-us/workbench/pull/3881#discussion_r473117270", "bodyText": "Can I change your mind about 0-based cellIndex?\nI think 0-based cellIndex would be confusing to test author (non-dev QA engineer). For example, to find the first cell, code would have been written as\nnew NotebookCell(page, CellType.Code, 0); - to find cell0.\nThis code makes sense, take out guesswork:\nnew NotebookCell(page, CellType.Code, 1); - to find cell0.\nTo find the 4th cell, code is\nnew NotebookCell(page, CellType.Code, 4); - to find cell3.\nSo, it is the cell sequences in UI determines what the index to use. The numbers in cell prompt [1], [2] do not matter because they're not used at all in finding a cell.\nIn notebook-cell.ts, I'm using css :nth-child selector to find a cell. Css rule dictates the index of the first child is 1. If using 0-based index, I would have to subtract 1 from the index. It can be confusing.", "author": "aweng98", "createdAt": "2020-08-19T15:28:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjQ0MTgzMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzI4MzcyNw==", "url": "https://github.com/all-of-us/workbench/pull/3881#discussion_r473283727", "bodyText": "If I understand your argument, you're saying that you're making it easy for non-coders by using 1-based indexing which they are probably more familiar with than 0-indexing. If so, this is just doing a disservice to them: just use standard coding practices so they can learn the standards. The nth-child CSS selector is an implementation detail that the test writer does not need to concern themselves with.\nSo, I'm not convinced. But also I don't feel strongly enough to block the review. Fine to merge for now, happy to discuss more if you are not convinced whether this is worth changing in a follow-up.", "author": "calbach", "createdAt": "2020-08-19T19:57:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjQ0MTgzMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjQ0MzMzNw==", "url": "https://github.com/all-of-us/workbench/pull/3881#discussion_r472443337", "bodyText": "My constructor comment I don't think was addressed: inline private here to avoid boilerplate?", "author": "calbach", "createdAt": "2020-08-18T19:54:45Z", "path": "e2e/app/page/notebook-cell.ts", "diffHunk": "@@ -0,0 +1,177 @@\n+import {ElementHandle, Frame, Page} from 'puppeteer';\n+import {getPropValue} from 'utils/element-utils';\n+\n+export enum CellType {\n+  // To append to css selector\n+  Code = '.code_cell',\n+  Markdown = '.text_cell',\n+  Any = '',\n+}\n+\n+/**\n+ * Notebook Cell represents the root element that contains both the code input and output cells.\n+ */\n+export default class NotebookCell {\n+\n+  private readonly page: Page;\n+  private iframe: Frame; // Jupyter notebook iframe\n+  private cellIndex: number; // 1-based cell index because notebook cell prompt index starts from 1.\n+  private readonly cellType: CellType; // Markdown or Code cell.\n+\n+  /**\n+   *\n+   * @param {Page} page Puppeteer Page.\n+   * @param {CellType} cellType Cell type: Code or Markdown cell. Default value is Code cell.\n+   * @param {number} cellIndex 1-based cell index. Default value is 1.\n+   */\n+  constructor(page: Page, cellType: CellType = CellType.Code, cellIndex: number = 1) {", "originalCommit": "0d68c9bfd3420206f0df277b85b757a0175a8385", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzA4MjU3OQ==", "url": "https://github.com/all-of-us/workbench/pull/3881#discussion_r473082579", "bodyText": "\u2714\ufe0e (overlooked first time)", "author": "aweng98", "createdAt": "2020-08-19T14:41:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjQ0MzMzNw=="}], "type": "inlineReview"}, {"oid": "29cc73c525f3beb3b38ceeccf344e40e5afe754f", "url": "https://github.com/all-of-us/workbench/commit/29cc73c525f3beb3b38ceeccf344e40e5afe754f", "message": "rework notebook tests", "committedDate": "2020-08-19T19:02:39Z", "type": "commit"}, {"oid": "1e8bceb4abcbae007fa8bebcd482ff7989a04042", "url": "https://github.com/all-of-us/workbench/commit/1e8bceb4abcbae007fa8bebcd482ff7989a04042", "message": "r test fix", "committedDate": "2020-08-19T19:24:13Z", "type": "commit"}]}