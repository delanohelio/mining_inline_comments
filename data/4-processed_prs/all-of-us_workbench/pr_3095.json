{"pr_number": 3095, "pr_title": "[RW-4315][risk=no] Workaround for Count Metrics", "pr_createdAt": "2020-02-05T19:31:18Z", "pr_url": "https://github.com/all-of-us/workbench/pull/3095", "timeline": [{"oid": "39d6a6cb4f58e698b96a34153f0eee4a2a14fe5a", "url": "https://github.com/all-of-us/workbench/commit/39d6a6cb4f58e698b96a34153f0eee4a2a14fe5a", "message": "got test working", "committedDate": "2020-02-05T01:35:40Z", "type": "commit"}, {"oid": "d6d637c244c28e1db42f25958dd65af8b47f55fd", "url": "https://github.com/all-of-us/workbench/commit/d6d637c244c28e1db42f25958dd65af8b47f55fd", "message": "tighten loops", "committedDate": "2020-02-05T01:47:46Z", "type": "commit"}, {"oid": "68bd8cf89374d3a03d51b45fad8482107d44318c", "url": "https://github.com/all-of-us/workbench/commit/68bd8cf89374d3a03d51b45fad8482107d44318c", "message": "add cron job reporting demo", "committedDate": "2020-02-05T19:22:43Z", "type": "commit"}, {"oid": "b866678206d89887574f7b6dc26bea6b419695f2", "url": "https://github.com/all-of-us/workbench/commit/b866678206d89887574f7b6dc26bea6b419695f2", "message": "spotless", "committedDate": "2020-02-05T19:23:22Z", "type": "commit"}, {"oid": "db914bf758d29a64de3d1f6d3f1f232c8da99d61", "url": "https://github.com/all-of-us/workbench/commit/db914bf758d29a64de3d1f6d3f1f232c8da99d61", "message": "Merge branch 'master' into jaycarlton/logBasedMetrics", "committedDate": "2020-02-05T21:43:43Z", "type": "commit"}, {"oid": "4aa0b0cb67d13e7dfd26cf6a4dd2256642670f39", "url": "https://github.com/all-of-us/workbench/commit/4aa0b0cb67d13e7dfd26cf6a4dd2256642670f39", "message": "provide another service", "committedDate": "2020-02-05T21:47:35Z", "type": "commit"}, {"oid": "a8f90295603069a531a127f5f1aee182d1cf9db5", "url": "https://github.com/all-of-us/workbench/commit/a8f90295603069a531a127f5f1aee182d1cf9db5", "message": "test fix", "committedDate": "2020-02-06T15:51:08Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTkyOTE2MQ==", "url": "https://github.com/all-of-us/workbench/pull/3095#discussion_r375929161", "bodyText": "setup*", "author": "ericsong", "createdAt": "2020-02-06T16:09:05Z", "path": "api/src/test/java/org/pmiops/workbench/monitoring/LogsBasedMetricsServiceTest.java", "diffHunk": "@@ -0,0 +1,132 @@\n+package org.pmiops.workbench.monitoring;\n+\n+import static com.google.common.truth.Truth.assertThat;\n+import static org.mockito.Mockito.doReturn;\n+import static org.mockito.Mockito.verify;\n+\n+import com.google.cloud.MonitoredResource;\n+import com.google.cloud.logging.LogEntry;\n+import com.google.cloud.logging.Logging;\n+import com.google.cloud.logging.Payload.JsonPayload;\n+import com.google.cloud.logging.Payload.Type;\n+import com.google.cloud.logging.Severity;\n+import com.google.common.collect.ImmutableMap;\n+import com.google.common.collect.ImmutableSet;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+import java.util.stream.Collectors;\n+import java.util.stream.StreamSupport;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.mockito.ArgumentCaptor;\n+import org.mockito.Captor;\n+import org.pmiops.workbench.model.DataAccessLevel;\n+import org.pmiops.workbench.model.WorkspaceActiveStatus;\n+import org.pmiops.workbench.monitoring.labels.MetricLabel;\n+import org.pmiops.workbench.monitoring.views.EventMetric;\n+import org.pmiops.workbench.monitoring.views.GaugeMetric;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.boot.test.context.TestConfiguration;\n+import org.springframework.boot.test.mock.mockito.MockBean;\n+import org.springframework.context.annotation.Import;\n+import org.springframework.test.context.junit4.SpringRunner;\n+\n+@RunWith(SpringRunner.class)\n+public class LogsBasedMetricsServiceTest {\n+\n+  private static MonitoredResource MONITORED_RESOURCE =\n+      MonitoredResource.newBuilder(\"resource_type_woot\")\n+          .addLabel(\"height\", \"3 apples tall\")\n+          .addLabel(\"area_code\", \"90210\")\n+          .build();\n+  @MockBean Logging mockLogging;\n+  @MockBean StackdriverStatsExporterService mockStackdriverStatsExporterService;\n+\n+  @Captor ArgumentCaptor<Iterable<LogEntry>> logEntriesCaptor;\n+  @Autowired LogsBasedMetricService logsBasedMetricService;\n+\n+  @TestConfiguration\n+  @Import({LogsBasedMetricServiceImpl.class})\n+  static class Configuration {}\n+\n+  @Before\n+  public void settup() {", "originalCommit": "a8f90295603069a531a127f5f1aee182d1cf9db5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "525ef9c4fc337ed00172043fe9dfc667ebd8b9b5", "url": "https://github.com/all-of-us/workbench/commit/525ef9c4fc337ed00172043fe9dfc667ebd8b9b5", "message": "fix mocks", "committedDate": "2020-02-06T19:58:07Z", "type": "commit"}, {"oid": "652ce39f34b198a6440f06836ee46c1f5eb963b9", "url": "https://github.com/all-of-us/workbench/commit/652ce39f34b198a6440f06836ee46c1f5eb963b9", "message": "spotless", "committedDate": "2020-02-06T20:37:34Z", "type": "commit"}]}