{"pr_number": 3654, "pr_title": "run java-unit-tests in parallel in CircleCI", "pr_createdAt": "2020-06-09T16:15:51Z", "pr_url": "https://github.com/all-of-us/workbench/pull/3654", "timeline": [{"oid": "9ab617b3abd12b54024ae6d3dd0cf7fd30df767e", "url": "https://github.com/all-of-us/workbench/commit/9ab617b3abd12b54024ae6d3dd0cf7fd30df767e", "message": "undo last commit", "committedDate": "2020-06-09T17:12:56Z", "type": "forcePushed"}, {"oid": "2625fafe2fb6ff572616b12dcb6ad36ec9da40e4", "url": "https://github.com/all-of-us/workbench/commit/2625fafe2fb6ff572616b12dcb6ad36ec9da40e4", "message": "run java-unit-tests in parallel in CircleCI", "committedDate": "2020-06-09T17:19:22Z", "type": "commit"}, {"oid": "2625fafe2fb6ff572616b12dcb6ad36ec9da40e4", "url": "https://github.com/all-of-us/workbench/commit/2625fafe2fb6ff572616b12dcb6ad36ec9da40e4", "message": "run java-unit-tests in parallel in CircleCI", "committedDate": "2020-06-09T17:19:22Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzYwNjY0NA==", "url": "https://github.com/all-of-us/workbench/pull/3654#discussion_r437606644", "bodyText": "Great! Can you also please show an example of a full path before and after this conversion?", "author": "jaycarlton", "createdAt": "2020-06-09T17:41:24Z", "path": ".circleci/config.yml", "diffHunk": "@@ -298,18 +299,43 @@ jobs:\n       - run:\n           name: Validate Swagger definitions\n           working_directory: ~/workbench/api\n-          command: ./project.rb validate-swagger --project-prop verboseTestLogging=yes\n+          command: |\n+            if [ \"$CIRCLE_NODE_INDEX\" == 0 ]; then\n+              ./project.rb validate-swagger --project-prop verboseTestLogging=yes\n+            fi\n       - run:\n           name: Run Java unit tests\n           working_directory: ~/workbench/api\n-          command: ./project.rb test\n+          # See: https://circleci.com/docs/2.0/language-java/#sample-configuration\n+          # Short explanation on commands:\n+          #   Find all unit tests recursively in \"api/src/test/java/\" directories.\n+          #   Strips off \"src/test/java/\" substring;\n+          #   Replaces all path separator \"/\" with \".\";\n+          #   Removes file extensions.\n+          #   Append \"--tests\" in front of file name.\n+          command: |", "originalCommit": "2625fafe2fb6ff572616b12dcb6ad36ec9da40e4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzcyMzkyNA==", "url": "https://github.com/all-of-us/workbench/pull/3654#discussion_r437723924", "bodyText": "Done.", "author": "aweng98", "createdAt": "2020-06-09T21:08:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzYwNjY0NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzYwNzMwOA==", "url": "https://github.com/all-of-us/workbench/pull/3654#discussion_r437607308", "bodyText": "Thinking out loud: Could you make a wrapper command called single_node_run that takes in the command to run (inside the if) as a parameter? Not for this PR.", "author": "jaycarlton", "createdAt": "2020-06-09T17:42:27Z", "path": ".circleci/config.yml", "diffHunk": "@@ -298,18 +299,43 @@ jobs:\n       - run:\n           name: Validate Swagger definitions\n           working_directory: ~/workbench/api\n-          command: ./project.rb validate-swagger --project-prop verboseTestLogging=yes\n+          command: |\n+            if [ \"$CIRCLE_NODE_INDEX\" == 0 ]; then", "originalCommit": "2625fafe2fb6ff572616b12dcb6ad36ec9da40e4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzcxMzkzMQ==", "url": "https://github.com/all-of-us/workbench/pull/3654#discussion_r437713931", "bodyText": "yes. it is possible. Command that takes a steps type parameter.\nhttps://circleci.com/docs/2.0/reusing-config/#steps", "author": "aweng98", "createdAt": "2020-06-09T20:53:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzYwNzMwOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzY4NzMyOA==", "url": "https://github.com/all-of-us/workbench/pull/3654#discussion_r437687328", "bodyText": "FYI, if you're testing this, note that this command isn't doing anything right now. https://precisionmedicineinitiative.atlassian.net/browse/RW-5073. No change is needed here, though.", "author": "jaycarlton", "createdAt": "2020-06-09T20:07:05Z", "path": ".circleci/config.yml", "diffHunk": "@@ -298,18 +299,43 @@ jobs:\n       - run:\n           name: Validate Swagger definitions\n           working_directory: ~/workbench/api\n-          command: ./project.rb validate-swagger --project-prop verboseTestLogging=yes\n+          command: |\n+            if [ \"$CIRCLE_NODE_INDEX\" == 0 ]; then\n+              ./project.rb validate-swagger --project-prop verboseTestLogging=yes", "originalCommit": "2625fafe2fb6ff572616b12dcb6ad36ec9da40e4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzcyNTMyNw==", "url": "https://github.com/all-of-us/workbench/pull/3654#discussion_r437725327", "bodyText": "good to know.", "author": "aweng98", "createdAt": "2020-06-09T21:11:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzY4NzMyOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzY4Nzk0NA==", "url": "https://github.com/all-of-us/workbench/pull/3654#discussion_r437687944", "bodyText": "nit: Can you move the java & gradle version checks to their own step if they're necessary? I guess I was thinking that's specified by the image, so maybe we don't need it here too?", "author": "jaycarlton", "createdAt": "2020-06-09T20:08:17Z", "path": ".circleci/config.yml", "diffHunk": "@@ -298,18 +299,43 @@ jobs:\n       - run:\n           name: Validate Swagger definitions\n           working_directory: ~/workbench/api\n-          command: ./project.rb validate-swagger --project-prop verboseTestLogging=yes\n+          command: |\n+            if [ \"$CIRCLE_NODE_INDEX\" == 0 ]; then\n+              ./project.rb validate-swagger --project-prop verboseTestLogging=yes\n+            fi\n       - run:\n           name: Run Java unit tests\n           working_directory: ~/workbench/api\n-          command: ./project.rb test\n+          # See: https://circleci.com/docs/2.0/language-java/#sample-configuration\n+          # Short explanation on commands:\n+          #   Find all unit tests recursively in \"api/src/test/java/\" directories.\n+          #   Strips off \"src/test/java/\" substring;\n+          #   Replaces all path separator \"/\" with \".\";\n+          #   Removes file extensions.\n+          #   Append \"--tests\" in front of file name.\n+          command: |\n+            CLASSNAMES=$(circleci tests glob \"src/test/java/**/*Test.java\" \"src/test/java/**/*Test.kt\" \\\n+              | cut -c 1- \\\n+              | sed 's@src/test/java/@@' \\\n+              | sed 's@/@.@g' \\\n+              | sed 's/\\.[^.]*$//' \\\n+              | circleci tests split --split-by=timings --timings-type=classname --index=$CIRCLE_NODE_INDEX)\n+            GRADLE_ARGS=$(echo $CLASSNAMES | awk '{for (i=1; i<=NF; i++) print \"--tests\", $i}')\n+            java -version && gradle -v && gradle test $GRADLE_ARGS", "originalCommit": "2625fafe2fb6ff572616b12dcb6ad36ec9da40e4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzcyNDQ2Mw==", "url": "https://github.com/all-of-us/workbench/pull/3654#discussion_r437724463", "bodyText": "removed java -version && gradle -v substring. I thought it would be good to have for info, but you're right, it is already in docker image. No need to show here.", "author": "aweng98", "createdAt": "2020-06-09T21:09:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzY4Nzk0NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzY4ODI0NA==", "url": "https://github.com/all-of-us/workbench/pull/3654#discussion_r437688244", "bodyText": "nit: is there a better name for ui-build-test?", "author": "jaycarlton", "createdAt": "2020-06-09T20:08:53Z", "path": ".circleci/config.yml", "diffHunk": "@@ -561,7 +587,7 @@ workflows:\n       # Always run basic test/lint/compilation (open PRs, master merge).\n       # Note: by default tags are not picked up.\n       - api-local-test\n-      - api-build-test\n+      - api-unit-test\n       - ui-build-test", "originalCommit": "2625fafe2fb6ff572616b12dcb6ad36ec9da40e4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzcyNDk4NQ==", "url": "https://github.com/all-of-us/workbench/pull/3654#discussion_r437724985", "bodyText": "\ud83e\udd14 ui-bvt? At IBM, BVT is universally accepted short name for \"Build Verification Tests\". But word of caution, I don't find any team in Broad use it.", "author": "aweng98", "createdAt": "2020-06-09T21:10:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzY4ODI0NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzczNTAyNA==", "url": "https://github.com/all-of-us/workbench/pull/3654#discussion_r437735024", "bodyText": "I think build is implied. I don't know of any non-build tests we'd be doing here (except linting).\nWhat do you call this suite? Maybe angular-test?", "author": "jaycarlton", "createdAt": "2020-06-09T21:32:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzY4ODI0NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzczNzIwOA==", "url": "https://github.com/all-of-us/workbench/pull/3654#discussion_r437737208", "bodyText": "It checks for both compilation and runs the unit tests. Full compilation is not required to run the unit tests, so I don't agree that it's implicit, though I'd be fine with just ui-test. angular-test would be inaccurate.", "author": "calbach", "createdAt": "2020-06-09T21:37:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzY4ODI0NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzczNzQyMA==", "url": "https://github.com/all-of-us/workbench/pull/3654#discussion_r437737420", "bodyText": "I see the other was renamed to unit. That would be fine here as well, ui-unit-test", "author": "calbach", "createdAt": "2020-06-09T21:38:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzY4ODI0NA=="}], "type": "inlineReview"}, {"oid": "47fa824621aabfa8c05a6c9637f28776518c6f7b", "url": "https://github.com/all-of-us/workbench/commit/47fa824621aabfa8c05a6c9637f28776518c6f7b", "message": "PR feedback [SKIP CI]", "committedDate": "2020-06-09T21:13:54Z", "type": "commit"}]}