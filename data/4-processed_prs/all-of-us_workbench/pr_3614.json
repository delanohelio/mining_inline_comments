{"pr_number": 3614, "pr_title": "[no ticket][risk=no] Puppeteer test code refactor", "pr_createdAt": "2020-05-22T00:26:10Z", "pr_url": "https://github.com/all-of-us/workbench/pull/3614", "timeline": [{"oid": "1fd8637f4af240911abba15230e14d9b86743b0c", "url": "https://github.com/all-of-us/workbench/commit/1fd8637f4af240911abba15230e14d9b86743b0c", "message": "test code refactor", "committedDate": "2020-05-22T00:23:36Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODk4OTIwMA==", "url": "https://github.com/all-of-us/workbench/pull/3614#discussion_r428989200", "bodyText": "I changed it to 10s but it has been the source for couple failed runs today. Making timeOut bigger.", "author": "aweng98", "createdAt": "2020-05-22T00:52:02Z", "path": "e2e/jest.test-setup.ts", "diffHunk": "@@ -7,7 +7,7 @@ beforeEach(async () => {\n   await page.setUserAgent(userAgent);\n   // Refer to https://github.com/puppeteer/puppeteer/blob/master/docs/api.md#pagesetdefaultnavigationtimeouttimeout\n   await page.setDefaultNavigationTimeout(70000);\n-  await page.setDefaultTimeout(10000);\n+  await page.setDefaultTimeout(50000);", "originalCommit": "1fd8637f4af240911abba15230e14d9b86743b0c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODk4OTgwMA==", "url": "https://github.com/all-of-us/workbench/pull/3614#discussion_r428989800", "bodyText": "I think containsText is a better name. :)", "author": "aweng98", "createdAt": "2020-05-22T00:54:38Z", "path": "e2e/app/page/base-page.ts", "diffHunk": "@@ -42,142 +41,11 @@ export default abstract class BasePage {\n     return this.page.$eval(`${cssSelector}`, elem => elem.textContent.trim())\n   }\n \n-  /**\n-   * Click on element then wait for page navigation.\n-   * @param {ElementHandle | BaseElement} clickElement\n-   */\n-  async clickAndWait(clickElement: ElementHandle | BaseElement) {\n-    return Promise.all([\n-      this.page.waitForNavigation({waitUntil: ['domcontentloaded', 'networkidle0']}),\n-      clickElement.click(),\n-    ]);\n-  }\n-\n-  /**\n-   * Wait until page URL to match a regular expression.\n-   * @param {string} text - URL regular expression\n-   */\n-  async waitUntilUrlMatch(text: string) {\n-    return await this.page.waitForFunction(txt => {\n-      const href = window.location.href;\n-      return href.includes(txt);\n-    }, {}, text);\n-  }\n-\n-  /**\n-   * Wait until document title to be a particular string.\n-   * @param {string} expectedTitle - The expected title of the document\n-   */\n-  async waitForTitle(title: string) {\n-    return await this.page.waitForFunction(t => {\n-      const actualTitle = document.title;\n-      return actualTitle === t;\n-    }, {}, title);\n-  }\n-\n-  /**\n-   * Wait until document title to match a regular expression.\n-   * @param {string} text\n-   */\n-  async waitUntilTitleMatch(title: string) {\n-    return await this.page.waitForFunction((t) => {\n-      const actualTitle = document.title;\n-      return actualTitle.includes(t);\n-    }, {}, title)\n-  }\n-\n-  /**\n-   * Wait until the selector is visible.\n-   * @param {string} cssSelector The CSS selector\n-   */\n-  async waitForVisible(cssSelector: string) {\n-    return await this.page.waitForFunction(selector => {\n-      const elem = document.querySelector(selector);\n-      const isVisible = elem.offsetWidth || elem.offsetHeight || elem.getClientRects().length;\n-      return !!isVisible;\n-    }, {}, cssSelector);\n-  }\n-\n-  /**\n-   * Wait while the selector is visible. Stops waiting when no longer has visible contents.\n-   * @param {string} cssSelector The CSS selector\n-   */\n-  async waitForHidden(cssSelector: string) {\n-    return await this.page.waitForFunction(selector => {\n-      const elem = document.querySelector(selector);\n-      const isVisible = elem.offsetWidth || elem.offsetHeight || elem.getClientRects().length;\n-      return !isVisible;\n-    }, {}, cssSelector);\n-  }\n-\n-  /**\n-   * Wait for the elements count to be a particular value\n-   * @param {string} cssSelector - The css selector for the element\n-   * @param {number} expectedCount - The expected number of elements\n-   */\n-  async waitForNumberElements(cssSelector: string, expectedCount: number) {\n-    return await this.page.waitForFunction((selector, count) => {\n-      return document.querySelectorAll(selector).length === count;\n-    }, {}, cssSelector, expectedCount);\n-  }\n-\n-  /**\n-   * Wait for the elements count to be greater than a particular value\n-   * @param {string} cssSelector - The css selector for the element\n-   * @param {number} greaterThanCount - The expected number of elements\n-   */\n-  async waitForNumberElementsIsBiggerThan(cssSelector: string, greaterThanCount: number) {\n-    return await this.page.waitForFunction((selector, count) => {\n-      return document.querySelectorAll(selector).length > count;\n-    }, {}, cssSelector, greaterThanCount);\n-  }\n-\n-  /**\n-   * Look for visible texts on the page.\n-   * @param {string} texts Partial texts to look for\n-   */\n-  async waitForTextExists(texts: string) {\n-    return await this.page.waitForFunction(matchText => {\n-      const bodyText = document.querySelector('body').innerText;\n-      return bodyText.includes(matchText)\n-    }, {}, texts);\n-  }\n-\n-  /**\n-   * Wait for the element found from the selector has a particular attribute value pair\n-   * @param {string} cssSelector - The selector for the element on the page\n-   * @param {string} attribute - The attribute name\n-   * @param {string} value - The attribute value to match\n-   */\n-  async waitUntilContainsAttributeValue(cssSelector, attribute, value) {\n-    return await this.page.waitForFunction((selector, attributeName, attributeValue) => {\n-      const element = document.querySelector(selector);\n-      return element.attributes[attributeName] && element.attributes[attributeName].value === attributeValue;\n-    }, {}, cssSelector, attribute, value);\n-  }\n-\n-  /**\n-   * Wait for exact text to match.\n-   * @param page\n-   * @param cssSelector\n-   * @param expectedText\n-   */\n-  async waitForText(cssSelector: string, expectedText: string) {\n-    await this.page.waitForFunction( (css, expText) => {\n-      const t = document.querySelector(css);\n-      if (t !== undefined) {\n-        return t.innerText === expText;\n-      }\n-    }, {}, cssSelector, expectedText);\n-\n-    await this.page.waitForSelector(cssSelector, { visible: true });\n-  }\n-\n   /**\n    * Find texts in DOM.\n    * @param txt\n    */\n-  async findText(txt: string): Promise<boolean> {\n+  async containsText(txt: string): Promise<boolean> {", "originalCommit": "1fd8637f4af240911abba15230e14d9b86743b0c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODk5MDExNg==", "url": "https://github.com/all-of-us/workbench/pull/3614#discussion_r428990116", "bodyText": "Unused because no more Invitation Key.", "author": "aweng98", "createdAt": "2020-05-22T00:55:55Z", "path": "e2e/app/page/create-account-page.ts", "diffHunk": "@@ -155,14 +163,6 @@ export default class CreateAccountPage extends BasePage {\n     await roleSelect.select(INSTITUTION_ROLE_VALUE.UNDERGRADUATE_STUDENT);\n   }\n \n-  // Step 2: Fill out Invitation key\n-  async fillOutInvitationKey(invitationKey: string) {\n-    await this.getInvitationKeyInput()\n-    .then(invitationKeyInput => invitationKeyInput.type(invitationKey))\n-    .then(() => this.getNextButton())\n-    .then(submitButton => submitButton.click());\n-  }", "originalCommit": "1fd8637f4af240911abba15230e14d9b86743b0c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODk5MTAwNQ==", "url": "https://github.com/all-of-us/workbench/pull/3614#discussion_r428991005", "bodyText": "un-skip before merge.", "author": "aweng98", "createdAt": "2020-05-22T00:59:39Z", "path": "e2e/tests/workspace/workspace-clone.spec.ts", "diffHunk": "@@ -1,11 +1,11 @@\n import WorkspacesPage from 'app/page/workspaces-page';\n-import {signIn} from 'utils/app-utils';\n+import {signIn} from 'utils/test-utils';\n import {WorkspaceAccessLevel, WorkspaceAction} from 'app/page-identifiers';\n import DataPage from 'app/page/data-page';\n import WorkspaceCard from 'app/component/workspace-card';\n import * as fp from 'lodash/fp';\n \n-describe('Clone workspace', () => {\n+describe.skip('Clone workspace', () => {", "originalCommit": "1fd8637f4af240911abba15230e14d9b86743b0c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODk5MTA0NQ==", "url": "https://github.com/all-of-us/workbench/pull/3614#discussion_r428991045", "bodyText": "un-skip before merge.", "author": "aweng98", "createdAt": "2020-05-22T00:59:52Z", "path": "e2e/tests/workspace/workspace-create.spec.ts", "diffHunk": "@@ -1,13 +1,12 @@\n import Link from 'app/element/link';\n import DataPage from 'app/page/data-page';\n import WorkspacesPage, {FIELD} from 'app/page/workspaces-page';\n-import {signIn} from 'utils/app-utils';\n+import {signIn, performActions} from 'utils/test-utils';\n import Button from 'app/element/button';\n import * as testData from 'resources/data/workspace-data';\n-import {performActions} from 'utils/test-utils';\n import {makeWorkspaceName} from 'utils/str-utils';\n \n-describe('Creating new workspaces', () => {\n+describe.skip('Creating new workspaces', () => {", "originalCommit": "1fd8637f4af240911abba15230e14d9b86743b0c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODk5NTkwOQ==", "url": "https://github.com/all-of-us/workbench/pull/3614#discussion_r428995909", "bodyText": "what do you mean?", "author": "NehaBroad", "createdAt": "2020-05-22T01:20:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODk5MTA0NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODk5ODExMw==", "url": "https://github.com/all-of-us/workbench/pull/3614#discussion_r428998113", "bodyText": "I skipped clone and create workspaces tests for the PR. I will undo skip first then merge to master.", "author": "aweng98", "createdAt": "2020-05-22T01:31:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODk5MTA0NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODk5MzA2MA==", "url": "https://github.com/all-of-us/workbench/pull/3614#discussion_r428993060", "bodyText": "The AoU logo is visible on signed out/account creation pages as well", "author": "NehaBroad", "createdAt": "2020-05-22T01:08:12Z", "path": "e2e/app/page/authenticated-page.ts", "diffHunk": "@@ -21,9 +20,13 @@ export default abstract class AuthenticatedPage extends BasePage {\n   }\n \n   protected async isSignedIn(): Promise<boolean> {\n-    await this.page.waitForSelector(SELECTOR.signedInIndicator);\n-    await this.page.waitForSelector(SELECTOR.logo, {visible: true});\n-    return true;\n+    try {\n+      await this.page.waitForSelector(SELECTOR.signedInIndicator);\n+      await this.page.waitForSelector(SELECTOR.logo, {visible: true});", "originalCommit": "1fd8637f4af240911abba15230e14d9b86743b0c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODk5NzA3Nw==", "url": "https://github.com/all-of-us/workbench/pull/3614#discussion_r428997077", "bodyText": "you're correctly. I updated signedInIndicator  to be app-signed-in.", "author": "aweng98", "createdAt": "2020-05-22T01:26:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODk5MzA2MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODk5Mzc2Nw==", "url": "https://github.com/all-of-us/workbench/pull/3614#discussion_r428993767", "bodyText": "can you try this like:\nPromise.all([...])\n.then(values => {\nreturn true\n})\n.catch(error => {\nconsole.error(Message);return false\n});", "author": "NehaBroad", "createdAt": "2020-05-22T01:11:32Z", "path": "e2e/app/page/create-account-page.ts", "diffHunk": "@@ -52,14 +54,16 @@ export default class CreateAccountPage extends BasePage {\n   }\n \n   async isLoaded(): Promise<boolean> {\n-    await this.waitForTextExists('Sign In');\n-    return true;\n-  }\n-\n-  async getInvitationKeyInput(): Promise<Textbox> {\n-    const textbox = new Textbox(this.page);\n-    await textbox.withCss('#invitationKey');\n-    return textbox;\n+    try {\n+      await Promise.all([\n+        waitForText(this.page, 'Please read through the entire agreement to continue'),\n+        this.page.waitForXPath('//*[@data-test-id=\"account-creation-tos\"]', {visible: true}),\n+      ])", "originalCommit": "1fd8637f4af240911abba15230e14d9b86743b0c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODk5NDQxOQ==", "url": "https://github.com/all-of-us/workbench/pull/3614#discussion_r428994419", "bodyText": "eg  with await async function f() {\nlet promise = new Promise((resolve, reject) => {\nsetTimeout(() => resolve(\"done!\"), 1000)\n});\nlet result = await promise; // wait until the promise resolves (*)\nalert(result); // \"done!\"\n}", "author": "NehaBroad", "createdAt": "2020-05-22T01:14:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODk5Mzc2Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODk5NTU4Mg==", "url": "https://github.com/all-of-us/workbench/pull/3614#discussion_r428995582", "bodyText": "will it be ok if the request will happen in any order?", "author": "NehaBroad", "createdAt": "2020-05-22T01:19:33Z", "path": "e2e/app/page/workspace-edit-page.ts", "diffHunk": "@@ -279,12 +281,16 @@ export default class WorkspaceEditPage extends AuthenticatedPage {\n \n   async isLoaded(): Promise<boolean> {\n     try {\n-      await this.waitUntilTitleMatch(PAGE.TITLE);\n-      await this.getWorkspaceNameTextbox();\n-      await new SelectMenu(this.page, LABEL_ALIAS.SELECT_BILLING).getSelectedValue();\n-      await this.getCreateWorkspaceButton();\n+      await Promise.all([\n+        waitForDocumentTitle(this.page, PAGE.TITLE),", "originalCommit": "1fd8637f4af240911abba15230e14d9b86743b0c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODk5Nzc2Ng==", "url": "https://github.com/all-of-us/workbench/pull/3614#discussion_r428997766", "bodyText": "yes. what matters is that they're all present.", "author": "aweng98", "createdAt": "2020-05-22T01:29:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODk5NTU4Mg=="}], "type": "inlineReview"}, {"oid": "2d1f237d803c87b3603470a928c5b643ccee0d29", "url": "https://github.com/all-of-us/workbench/commit/2d1f237d803c87b3603470a928c5b643ccee0d29", "message": "PR feedback", "committedDate": "2020-05-22T01:33:23Z", "type": "commit"}]}