{"pr_number": 3025, "pr_title": "[RW-4091][RISK=NO]Change content header for cloud task request TO APPLCIATION/JSON", "pr_createdAt": "2020-01-23T16:29:33Z", "pr_url": "https://github.com/all-of-us/workbench/pull/3025", "timeline": [{"oid": "26a8178d6509e2d08081a78e63bbd74fcef5efd2", "url": "https://github.com/all-of-us/workbench/commit/26a8178d6509e2d08081a78e63bbd74fcef5efd2", "message": "Interceptor for Cloud task", "committedDate": "2020-01-21T22:48:08Z", "type": "commit"}, {"oid": "7f955a912ea817bb77e6e93e7fa7dae782a49051", "url": "https://github.com/all-of-us/workbench/commit/7f955a912ea817bb77e6e93e7fa7dae782a49051", "message": "removing unwanted code", "committedDate": "2020-01-21T23:08:05Z", "type": "commit"}, {"oid": "64aede134dcf08d47cb6ef1febbe14e4a2f05dda", "url": "https://github.com/all-of-us/workbench/commit/64aede134dcf08d47cb6ef1febbe14e4a2f05dda", "message": "add comments", "committedDate": "2020-01-21T23:33:10Z", "type": "commit"}, {"oid": "e537a46f4d6720de3daf2ef5523738cbfed9947a", "url": "https://github.com/all-of-us/workbench/commit/e537a46f4d6720de3daf2ef5523738cbfed9947a", "message": "Push correct java test file", "committedDate": "2020-01-22T21:40:07Z", "type": "commit"}, {"oid": "894f942e821d1544029eef7384b809fb2640ca0a", "url": "https://github.com/all-of-us/workbench/commit/894f942e821d1544029eef7384b809fb2640ca0a", "message": "Spotless", "committedDate": "2020-01-23T13:49:49Z", "type": "commit"}, {"oid": "f82b2faced155bc5ebf665e2f6f60243f15d8a90", "url": "https://github.com/all-of-us/workbench/commit/f82b2faced155bc5ebf665e2f6f60243f15d8a90", "message": "change contenty-type for cloud task to json", "committedDate": "2020-01-23T16:26:41Z", "type": "commit"}, {"oid": "e27504b7e4baf5dbf02f5a27cfb645961929b918", "url": "https://github.com/all-of-us/workbench/commit/e27504b7e4baf5dbf02f5a27cfb645961929b918", "message": "rebase", "committedDate": "2020-01-23T16:32:37Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDIzMTYwNQ==", "url": "https://github.com/all-of-us/workbench/pull/3025#discussion_r370231605", "bodyText": "Is there a reason to do this ByteString conversion? With us moving to JSON, I would expect this to pass in a json.toString style thing, rather than a bytestring conversion? Do we need to do this for the AppEngineHttpRequest? (Or will it implicitly handle the conversion from string to encoded string?)\n(Also, do you know where the docs for this are? All I've found is https://developers.google.com/resources/api-libraries/documentation/cloudtasks/v2/java/latest/com/google/api/services/cloudtasks/v2/model/AppEngineHttpRequest.html#setBody-java.lang.String- or https://cloud.google.com/appengine/docs/python/taskqueue/push/creating-handlers#reading_request_headers which doesn't have a putHeaders method or a builder method)", "author": "s-rubenstein", "createdAt": "2020-01-23T16:43:39Z", "path": "api/src/main/java/org/pmiops/workbench/api/OfflineRdrExportController.java", "diffHunk": "@@ -108,18 +109,20 @@ private void groupIdsAndPushTask(List<Long> idList, String taskUri) {\n \n   private void createAndPushTask(List<Long> ids, String queuePath, String taskUri) {\n     List<String> idsAsString = ids.stream().map(id -> id.toString()).collect(Collectors.toList());\n+    Gson gson = new Gson();\n+    String daysJson = gson.toJson(ids);\n     try (CloudTasksClient client = CloudTasksClient.create()) {\n       String commaSepList = String.join(IDS_STRING_SPLIT, idsAsString);\n-      Task.Builder taskBuilder =\n-          Task.newBuilder()\n-              .setAppEngineHttpRequest(\n-                  AppEngineHttpRequest.newBuilder()\n-                      .setRelativeUri(taskUri)\n-                      .setBody(ByteString.copyFrom(commaSepList.getBytes()))\n-                      .setHttpMethod(HttpMethod.POST)\n-                      .build());\n+      AppEngineHttpRequest req =\n+          AppEngineHttpRequest.newBuilder()\n+              .setRelativeUri(taskUri)\n+              .setBody(ByteString.copyFromUtf8(daysJson))", "originalCommit": "e27504b7e4baf5dbf02f5a27cfb645961929b918", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDIzNDk3NQ==", "url": "https://github.com/all-of-us/workbench/pull/3025#discussion_r370234975", "bodyText": "The documentation for appenginetaTask header is pretty bad or not up to date. I referred to https://cloud.google.com/appengine/docs/standard/python/taskqueue/push/creating-handlers however i could not get a clear way to set header as it is immutable object. After going thru the source code for cloud task i could find this method putHeader", "author": "NehaBroad", "createdAt": "2020-01-23T16:49:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDIzMTYwNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDIzNTI2NQ==", "url": "https://github.com/all-of-us/workbench/pull/3025#discussion_r370235265", "bodyText": "Regarding the type, cloud task accept the Body type to be ByteString, while calling the TaskHandler it converts the ByteString to JSON", "author": "NehaBroad", "createdAt": "2020-01-23T16:50:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDIzMTYwNQ=="}], "type": "inlineReview"}]}