{"pr_number": 4005, "pr_title": "[RW-5462][risk=no] Endpoint for COPE survey versions", "pr_createdAt": "2020-09-14T20:56:17Z", "pr_url": "https://github.com/all-of-us/workbench/pull/4005", "timeline": [{"oid": "962a7968a27633de1986c7a7ae70af8fcb3c9b90", "url": "https://github.com/all-of-us/workbench/commit/962a7968a27633de1986c7a7ae70af8fcb3c9b90", "message": "RW-5462 initial commit", "committedDate": "2020-09-14T20:33:10Z", "type": "commit"}, {"oid": "3fa692b81e7bf61e53ec26f9ac402a5215a13ceb", "url": "https://github.com/all-of-us/workbench/commit/3fa692b81e7bf61e53ec26f9ac402a5215a13ceb", "message": "RW-5462 adding tests", "committedDate": "2020-09-14T20:33:10Z", "type": "commit"}, {"oid": "b80ca6d2fd13a56d2ff4924ea92d1f3f1f93877c", "url": "https://github.com/all-of-us/workbench/commit/b80ca6d2fd13a56d2ff4924ea92d1f3f1f93877c", "message": "RW-5462 spotless", "committedDate": "2020-09-14T23:47:51Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODMwNDQ0NA==", "url": "https://github.com/all-of-us/workbench/pull/4005#discussion_r488304444", "bodyText": "Should we also add a negative test say if itemCount is null?", "author": "NehaBroad", "createdAt": "2020-09-15T00:06:04Z", "path": "api/src/test/java/org/pmiops/workbench/cdr/dao/CBCriteriaDaoTest.java", "diffHunk": "@@ -365,4 +366,84 @@ public void findMenuOptions() {\n     assertThat(option9.getType()).isEqualTo(\"PPI\");\n     assertThat(option9.getStandard()).isFalse();\n   }\n+\n+  @Test\n+  public void findSurveyVersionByQuestionConceptId() {\n+    jdbcTemplate.execute(\n+        \"create table cb_survey_version(survey_id integer, concept_id integer, version varchar(50), display_order integer)\");\n+    jdbcTemplate.execute(\n+        \"create table cb_survey_attribute(id integer, question_concept_id integer, answer_concept_id integer, survey_id integer, item_count integer)\");\n+    jdbcTemplate.execute(\n+        \"insert into cb_survey_version(survey_id, concept_id, version, display_order) values (100, 1333342, 'May 2020', 1)\");\n+    jdbcTemplate.execute(\n+        \"insert into cb_survey_version(survey_id, concept_id, version, display_order) values (101, 1333342, 'June 2020', 2)\");\n+    jdbcTemplate.execute(\n+        \"insert into cb_survey_version(survey_id, concept_id, version, display_order) values (102, 1333342, 'July 2020', 3)\");\n+    jdbcTemplate.execute(\n+        \"insert into cb_survey_attribute(id, question_concept_id, answer_concept_id, survey_id, item_count) values (1, 715713, 0, 100, 291)\");\n+    jdbcTemplate.execute(\n+        \"insert into cb_survey_attribute(id, question_concept_id, answer_concept_id, survey_id, item_count) values (2, 715713, 0, 101, 148)\");\n+    jdbcTemplate.execute(\n+        \"insert into cb_survey_attribute(id, question_concept_id, answer_concept_id, survey_id, item_count) values (3, 715713, 0, 102, 150)\");\n+    jdbcTemplate.execute(\n+        \"insert into cb_survey_attribute(id, question_concept_id, answer_concept_id, survey_id, item_count) values (4, 715713, 903096, 100, 154)\");\n+    jdbcTemplate.execute(\n+        \"insert into cb_survey_attribute(id, question_concept_id, answer_concept_id, survey_id, item_count) values (5, 715713, 903096, 101, 82)\");\n+    jdbcTemplate.execute(\n+        \"insert into cb_survey_attribute(id, question_concept_id, answer_concept_id, survey_id, item_count) values (6, 715713, 903096, 102, 31)\");\n+    List<DbSurveyVersion> dbSurveyVersions =\n+        cbCriteriaDao.findSurveyVersionByQuestionConceptId(1333342L, 715713L);\n+    assertThat(dbSurveyVersions).hasSize(3);\n+    assertThat(dbSurveyVersions.get(0).getSurveyId()).isEqualTo(100);\n+    assertThat(dbSurveyVersions.get(0).getVersion()).isEqualTo(\"May 2020\");\n+    assertThat(dbSurveyVersions.get(0).getItemCount()).isEqualTo(445);\n+    assertThat(dbSurveyVersions.get(1).getSurveyId()).isEqualTo(101);\n+    assertThat(dbSurveyVersions.get(1).getVersion()).isEqualTo(\"June 2020\");\n+    assertThat(dbSurveyVersions.get(1).getItemCount()).isEqualTo(230);\n+    assertThat(dbSurveyVersions.get(2).getSurveyId()).isEqualTo(102);\n+    assertThat(dbSurveyVersions.get(2).getVersion()).isEqualTo(\"July 2020\");\n+    assertThat(dbSurveyVersions.get(2).getItemCount()).isEqualTo(181);\n+    jdbcTemplate.execute(\"drop table cb_survey_version\");\n+    jdbcTemplate.execute(\"drop table cb_survey_attribute\");\n+  }\n+\n+  @Test\n+  public void findSurveyVersionByQuestionConceptIdAndAnswerConceptId() {", "originalCommit": "b80ca6d2fd13a56d2ff4924ea92d1f3f1f93877c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODMwOTU1Ng==", "url": "https://github.com/all-of-us/workbench/pull/4005#discussion_r488309556", "bodyText": "nvm i am assuming itemCount will have nullable=false constraint", "author": "NehaBroad", "createdAt": "2020-09-15T00:23:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODMwNDQ0NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODMwNjA0Nw==", "url": "https://github.com/all-of-us/workbench/pull/4005#discussion_r488306047", "bodyText": "Question: here we have sum(csa.item_count) vs just returning csa.item_count in method findSurveyVersionByQuestionConceptIdAndAnswerConceptId ,\nIs it because  for findSurveyVersionByQuestionConceptId,  its aggregating the item_count of all answers for question_id passed?", "author": "NehaBroad", "createdAt": "2020-09-15T00:12:00Z", "path": "api/src/main/java/org/pmiops/workbench/cdr/dao/CBCriteriaDao.java", "diffHunk": "@@ -249,4 +250,35 @@\n           \"select distinct domain_id as domain, type, is_standard as standard from cb_criteria order by domain, type, is_standard\",\n       nativeQuery = true)\n   List<DbMenuOption> findMenuOptions();\n+\n+  @Query(\n+      value =\n+          \"select surveyId, version, itemCount from( \"\n+              + \"select csv.survey_id as surveyId, csv.version as version, sum(csa.item_count) as itemCount, csv.display_order \"", "originalCommit": "b80ca6d2fd13a56d2ff4924ea92d1f3f1f93877c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODcxMzY3Mg==", "url": "https://github.com/all-of-us/workbench/pull/4005#discussion_r488713672", "bodyText": "correct.", "author": "freemabd", "createdAt": "2020-09-15T14:28:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODMwNjA0Nw=="}], "type": "inlineReview"}]}