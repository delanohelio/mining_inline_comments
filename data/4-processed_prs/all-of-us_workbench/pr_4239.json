{"pr_number": 4239, "pr_title": "[no ticket][risk=no] Create Puppeteer test results JSON file with jest-stare", "pr_createdAt": "2020-11-02T17:43:37Z", "pr_url": "https://github.com/all-of-us/workbench/pull/4239", "timeline": [{"oid": "39836d740bd8450076d1b3780ee2cd9ca4c17a44", "url": "https://github.com/all-of-us/workbench/commit/39836d740bd8450076d1b3780ee2cd9ca4c17a44", "message": "jest-stare lib", "committedDate": "2020-11-02T17:42:52Z", "type": "commit"}, {"oid": "3310868e53c2aa7ef527e0f159dc990eb7a2214c", "url": "https://github.com/all-of-us/workbench/commit/3310868e53c2aa7ef527e0f159dc990eb7a2214c", "message": "skip most tests", "committedDate": "2020-11-02T19:53:40Z", "type": "commit"}, {"oid": "70a52fd9feb0a5b3e0427e747af6a0058367b26f", "url": "https://github.com/all-of-us/workbench/commit/70a52fd9feb0a5b3e0427e747af6a0058367b26f", "message": "mv combined json", "committedDate": "2020-11-02T20:05:54Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjI0MzY4MA==", "url": "https://github.com/all-of-us/workbench/pull/4239#discussion_r516243680", "bodyText": "skipped most tests for testing quicker. Changes will be reverted back before merge.", "author": "aweng98", "createdAt": "2020-11-02T20:45:09Z", "path": "e2e/tests/cohorts/cohorts-create.spec.ts", "diffHunk": "@@ -11,7 +11,7 @@ import {findOrCreateWorkspace, signIn} from 'utils/test-utils';\n import {waitForText, waitWhileLoading} from 'utils/waits-utils';\n \n \n-describe('User can create new Cohorts', () => {\n+describe.skip('User can create new Cohorts', () => {", "originalCommit": "70a52fd9feb0a5b3e0427e747af6a0058367b26f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjI0ODkwNA==", "url": "https://github.com/all-of-us/workbench/pull/4239#discussion_r516248904", "bodyText": "FYI: ftest or fdescribe I believe should work here, i.e. \"focus\" this test and skip the others - probably a lot easier than skipping all", "author": "calbach", "createdAt": "2020-11-02T20:55:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjI0MzY4MA=="}], "type": "inlineReview"}, {"oid": "1a0bf146f0901b7629cd3cb8b5bdedd5d3ba25ea", "url": "https://github.com/all-of-us/workbench/commit/1a0bf146f0901b7629cd3cb8b5bdedd5d3ba25ea", "message": "remove jest-junit", "committedDate": "2020-11-02T21:21:07Z", "type": "commit"}, {"oid": "663110a8c94e3caf0569d2a65c7b1ec25cd6cb34", "url": "https://github.com/all-of-us/workbench/commit/663110a8c94e3caf0569d2a65c7b1ec25cd6cb34", "message": "unskip tests", "committedDate": "2020-11-02T21:33:55Z", "type": "commit"}, {"oid": "66e3fc1778619bb7690c7f31ee2b3b649ed54c5b", "url": "https://github.com/all-of-us/workbench/commit/66e3fc1778619bb7690c7f31ee2b3b649ed54c5b", "message": "unskip tests", "committedDate": "2020-11-02T21:35:05Z", "type": "commit"}, {"oid": "22076d41433b09122f2981d6b1ae4e9bcaacab87", "url": "https://github.com/all-of-us/workbench/commit/22076d41433b09122f2981d6b1ae4e9bcaacab87", "message": "ci config format", "committedDate": "2020-11-02T21:36:44Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjI0OTI3Mg==", "url": "https://github.com/all-of-us/workbench/pull/4239#discussion_r516249272", "bodyText": "nit: please line wrap", "author": "calbach", "createdAt": "2020-11-02T20:56:40Z", "path": ".circleci/config.yml", "diffHunk": "@@ -301,6 +301,16 @@ commands:\n             circleci tests glob \"tests/**/*.spec.ts\" | circleci tests split --split-by=timings > /tmp/tests-to-run\n             yarn test:ci $(cat /tmp/tests-to-run)\n           no_output_timeout: 15m\n+      - run:\n+          name: Create circleci_parameters.json\n+          working_directory: ~/workbench/e2e\n+          command: |\n+            echo \"{ \\\"circleBranch\\\": \\\"${CIRCLE_BRANCH}\\\", \\\"circleJob\\\": \\\"${CIRCLE_JOB}\\\", \\\"circleBuild\\\": \\\"${CIRCLE_BUILD_NUM}\\\", \\\"circleBuildUrl\\\": \\\"${CIRCLE_BUILD_URL}\\\", \\\"circleNodeIndex\\\": \\\"${CIRCLE_NODE_INDEX}\\\" }\" \\", "originalCommit": "3310868e53c2aa7ef527e0f159dc990eb7a2214c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjczOTc2NA==", "url": "https://github.com/all-of-us/workbench/pull/4239#discussion_r516739764", "bodyText": "Done", "author": "aweng98", "createdAt": "2020-11-03T15:11:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjI0OTI3Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjI2OTQ3MQ==", "url": "https://github.com/all-of-us/workbench/pull/4239#discussion_r516269471", "bodyText": "nit: I would not re-encode the file names here in the description, e.g. \"Add CircleCI job data to Junit test results\".", "author": "calbach", "createdAt": "2020-11-02T21:39:02Z", "path": ".circleci/config.yml", "diffHunk": "@@ -301,6 +301,16 @@ commands:\n             circleci tests glob \"tests/**/*.spec.ts\" | circleci tests split --split-by=timings > /tmp/tests-to-run\n             yarn test:ci $(cat /tmp/tests-to-run)\n           no_output_timeout: 15m\n+      - run:\n+          name: Create circleci_parameters.json\n+          working_directory: ~/workbench/e2e\n+          command: |\n+            echo \"{ \\\"circleBranch\\\": \\\"${CIRCLE_BRANCH}\\\", \\\"circleJob\\\": \\\"${CIRCLE_JOB}\\\", \\\"circleBuild\\\": \\\"${CIRCLE_BUILD_NUM}\\\", \\\"circleBuildUrl\\\": \\\"${CIRCLE_BUILD_URL}\\\", \\\"circleNodeIndex\\\": \\\"${CIRCLE_NODE_INDEX}\\\" }\" \\\n+              > ./logs/circleci_parameters.json\n+      - run:\n+          name: Combine circleci_parameters.json and test-results.json", "originalCommit": "3310868e53c2aa7ef527e0f159dc990eb7a2214c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjc0MDQ5MA==", "url": "https://github.com/all-of-us/workbench/pull/4239#discussion_r516740490", "bodyText": "Done", "author": "aweng98", "createdAt": "2020-11-03T15:12:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjI2OTQ3MQ=="}], "type": "inlineReview"}, {"oid": "b1ffaba57cf434f9a78cab324e7d9b57cb9b2581", "url": "https://github.com/all-of-us/workbench/commit/b1ffaba57cf434f9a78cab324e7d9b57cb9b2581", "message": "PR feedback", "committedDate": "2020-11-03T15:16:53Z", "type": "commit"}, {"oid": "2ca8bfeafe4afd4cad869bc68cdeefeb8c483e46", "url": "https://github.com/all-of-us/workbench/commit/2ca8bfeafe4afd4cad869bc68cdeefeb8c483e46", "message": "add arg when: always in run-puppeteer-job", "committedDate": "2020-11-03T17:28:58Z", "type": "commit"}, {"oid": "9d33c6c323b10d2ab6f998fca2856abc60b1ffb0", "url": "https://github.com/all-of-us/workbench/commit/9d33c6c323b10d2ab6f998fca2856abc60b1ffb0", "message": "remove whitespaces in json", "committedDate": "2020-11-04T20:46:26Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzcwMDkwMA==", "url": "https://github.com/all-of-us/workbench/pull/4239#discussion_r517700900", "bodyText": "Why? If you really need to do this, can you just pass the \"-c\" flag to fq instead?", "author": "calbach", "createdAt": "2020-11-04T23:56:12Z", "path": ".circleci/config.yml", "diffHunk": "@@ -300,6 +301,33 @@ commands:\n             circleci tests glob \"tests/**/*.spec.ts\" | circleci tests split --split-by=timings > /tmp/tests-to-run\n             yarn test:ci $(cat /tmp/tests-to-run)\n           no_output_timeout: 15m\n+      - run:\n+          name: Create circleci_parameters.json\n+          working_directory: ~/workbench/e2e\n+          command: |\n+            echo \"{ \\\n+              \\\"circleBranch\\\": \\\"${CIRCLE_BRANCH}\\\", \\\n+              \\\"circleJob\\\": \\\"${CIRCLE_JOB}\\\", \\\n+              \\\"circleBuild\\\": \\\"${CIRCLE_BUILD_NUM}\\\", \\\n+              \\\"circleBuildUrl\\\": \\\"${CIRCLE_BUILD_URL}\\\", \\\n+              \\\"circleNodeIndex\\\": \\\"${CIRCLE_NODE_INDEX}\\\" \\\n+              }\" \\\n+              > ./logs/circleci_parameters.json\n+          when: always\n+      - run:\n+          name: Add CircleCI job data to test results json before upload json to storage bucket\n+          working_directory: ~/workbench/e2e/logs\n+          command: |\n+            NEW_JSON=circleci-build-${CIRCLE_BUILD_NUM}-${CIRCLE_NODE_INDEX}-test-results.json\n+            jq -s '.[0] * .[1]' test-results.json circleci_parameters.json > ${NEW_JSON}\n+            # Remove all whitespaces", "originalCommit": "9d33c6c323b10d2ab6f998fca2856abc60b1ffb0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzcwMTM5NQ==", "url": "https://github.com/all-of-us/workbench/pull/4239#discussion_r517701395", "bodyText": "This has implicit side-effects on other gcloud commands, in general I recommend avoiding setting this in most cases. This line also should not be necessary at all for running the following gsutil command. I would remove it and the project name.\nIf you still have problems after this, please let me know, but you can instead pass an explicit project ID flag to gsutil.", "author": "calbach", "createdAt": "2020-11-04T23:57:46Z", "path": ".circleci/config.yml", "diffHunk": "@@ -300,6 +301,33 @@ commands:\n             circleci tests glob \"tests/**/*.spec.ts\" | circleci tests split --split-by=timings > /tmp/tests-to-run\n             yarn test:ci $(cat /tmp/tests-to-run)\n           no_output_timeout: 15m\n+      - run:\n+          name: Create circleci_parameters.json\n+          working_directory: ~/workbench/e2e\n+          command: |\n+            echo \"{ \\\n+              \\\"circleBranch\\\": \\\"${CIRCLE_BRANCH}\\\", \\\n+              \\\"circleJob\\\": \\\"${CIRCLE_JOB}\\\", \\\n+              \\\"circleBuild\\\": \\\"${CIRCLE_BUILD_NUM}\\\", \\\n+              \\\"circleBuildUrl\\\": \\\"${CIRCLE_BUILD_URL}\\\", \\\n+              \\\"circleNodeIndex\\\": \\\"${CIRCLE_NODE_INDEX}\\\" \\\n+              }\" \\\n+              > ./logs/circleci_parameters.json\n+          when: always\n+      - run:\n+          name: Add CircleCI job data to test results json before upload json to storage bucket\n+          working_directory: ~/workbench/e2e/logs\n+          command: |\n+            NEW_JSON=circleci-build-${CIRCLE_BUILD_NUM}-${CIRCLE_NODE_INDEX}-test-results.json\n+            jq -s '.[0] * .[1]' test-results.json circleci_parameters.json > ${NEW_JSON}\n+            # Remove all whitespaces\n+            cat ${NEW_JSON} | tr '\\n' ' ' > tmp.json && mv tmp.json ${NEW_JSON}\n+            # Upload json to storage bucket\n+            PROJECT_NAME=all-of-us-workbench-test\n+            STORAGE_BUCKET=gs://circleci-puppeteer-test-results\n+            gcloud config set project ${PROJECT_NAME}", "originalCommit": "9d33c6c323b10d2ab6f998fca2856abc60b1ffb0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODI3MTU0NQ==", "url": "https://github.com/all-of-us/workbench/pull/4239#discussion_r518271545", "bodyText": "\ud83d\udc4d\nAddressing latest feedback: Use jq -c, and gsuite cp works after removing set project. Thank you CH.", "author": "aweng98", "createdAt": "2020-11-05T18:28:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzcwMTM5NQ=="}], "type": "inlineReview"}, {"oid": "e553ad95a42657e0a988c02e21017165a7e469ac", "url": "https://github.com/all-of-us/workbench/commit/e553ad95a42657e0a988c02e21017165a7e469ac", "message": "remove set project_id", "committedDate": "2020-11-05T17:42:24Z", "type": "commit"}]}