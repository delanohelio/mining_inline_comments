{"pr_number": 3611, "pr_title": "[no ticket][risk=no] Running puppeteer tests in circleci", "pr_createdAt": "2020-05-21T17:50:43Z", "pr_url": "https://github.com/all-of-us/workbench/pull/3611", "timeline": [{"oid": "b902c9af70c4c343d67be52c0fa3cce368e73bc8", "url": "https://github.com/all-of-us/workbench/commit/b902c9af70c4c343d67be52c0fa3cce368e73bc8", "message": "changes for running puppeteer tests in circleci", "committedDate": "2020-05-21T17:49:42Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODgxNTU0Mw==", "url": "https://github.com/all-of-us/workbench/pull/3611#discussion_r428815543", "bodyText": "Rename getAllCards and getAnyCard methods to have consistent method names convention.", "author": "aweng98", "createdAt": "2020-05-21T17:53:13Z", "path": "e2e/app/component/workspace-card.ts", "diffHunk": "@@ -27,16 +27,16 @@ export default class WorkspaceCard {\n    * @param {Page} page\n    * @throws TimeoutError if fails to find Card.\n    */\n-  static async getAllCards(page: Page): Promise<WorkspaceCard[]> {\n+  static async findAllCards(page: Page): Promise<WorkspaceCard[]> {", "originalCommit": "b902c9af70c4c343d67be52c0fa3cce368e73bc8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODgxNjQ0NQ==", "url": "https://github.com/all-of-us/workbench/pull/3611#discussion_r428816445", "bodyText": "no longer using this email.", "author": "aweng98", "createdAt": "2020-05-21T17:54:47Z", "path": "e2e/resources/workbench-config.ts", "diffHunk": "@@ -4,11 +4,9 @@ import * as fp from 'lodash/fp';\n const env = process.env.WORKBENCH_ENV || 'dev';\n \n const userCredential = {\n-  contactEmail: 'hermione.owner@quality.firecloud.org',", "originalCommit": "b902c9af70c4c343d67be52c0fa3cce368e73bc8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODgxNzAxNA==", "url": "https://github.com/all-of-us/workbench/pull/3611#discussion_r428817014", "bodyText": "tweaks to run this test against local ui server in circleci", "author": "aweng98", "createdAt": "2020-05-21T17:55:49Z", "path": "e2e/tests/workspace/workspace-clone.spec.ts", "diffHunk": "@@ -84,12 +90,20 @@ describe('Clone workspace', () => {\n       // strips out dash from workspace name\n       expect(workspaceDataUrl).toContain(cloneWorkspaceName.replace(/-/g, ''));\n \n+      // starting a new incognito page\n+      await page.deleteCookie(...await page.cookies());\n       await jestPuppeteer.resetBrowser();\n-      const newPage = await browser.newPage();\n+      await page.waitFor(2000);\n+      const newBrowser = await browser.createIncognitoBrowserContext();\n+      const newPage = await newBrowser.newPage();\n+      const userAgent = 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/81.0.4044.138 Safari/537.36';\n+      await newPage.setUserAgent(userAgent);\n       await signIn(newPage);", "originalCommit": "b902c9af70c4c343d67be52c0fa3cce368e73bc8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODgyOTI3NQ==", "url": "https://github.com/all-of-us/workbench/pull/3611#discussion_r428829275", "bodyText": "save page html and take a screenshot when test fails.", "author": "aweng98", "createdAt": "2020-05-21T18:18:15Z", "path": "e2e/puppeteer-custom-environment.ts", "diffHunk": "@@ -21,24 +21,46 @@ class PuppeteerCustomEnvironment extends PuppeteerEnvironment {\n   async handleTestEvent(event, state) {\n     switch (event.name) {\n     case 'test_fn_failure':\n-      console.log('test failed: \\t', event.test.name);\n       if (state.currentlyRunningTest.invocations > retryTimes) {\n-        const testName = state.currentlyRunningTest.name.replace(/\\s/g, ''); // remove whitespaces\n+        console.error(`Failed test:  \"${event.test.name}\"`);\n+        const testName = fp.startCase(state.currentlyRunningTest.name).replace(/[^A-Z0-9]+/ig, '');\n         const screenshotDir = 'logs/screenshot';\n         await fs.ensureDir(screenshotDir);\n           // move create-filename to helper.ts\n         const timestamp = new Date().getTime();\n-        const fileName = `${testName}_${timestamp}.png`\n+        const fileName = `${testName}_${timestamp}.png`;\n+\n         const screenshotFile = `${screenshotDir}/${fileName}`;\n         await this.global.page.screenshot({path: screenshotFile, fullPage: true});\n-        console.error(`Test \"${event.test.name}\" failed. Saved screenshot ${screenshotFile}.`);\n+        console.error(`Saved screenshot ${screenshotFile}`);\n+\n+        const htmlFileName = `${testName}_${timestamp}.html`;\n+        await this.savePageToFile(htmlFileName);", "originalCommit": "b902c9af70c4c343d67be52c0fa3cce368e73bc8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODg1NzI2Mw==", "url": "https://github.com/all-of-us/workbench/pull/3611#discussion_r428857263", "bodyText": "@als364 This change is it. Others are cleanup and improvement. \ud83d\ude42Thanks for the quick turnaround.", "author": "aweng98", "createdAt": "2020-05-21T19:11:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODgyOTI3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODg1NzcwNQ==", "url": "https://github.com/all-of-us/workbench/pull/3611#discussion_r428857705", "bodyText": "thank you!", "author": "als364", "createdAt": "2020-05-21T19:12:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODgyOTI3NQ=="}], "type": "inlineReview"}]}