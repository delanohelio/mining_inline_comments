{"pr_number": 2984, "pr_title": "[RW-4228][Risk=no] Add cluster resources to static hosted files", "pr_createdAt": "2020-01-08T22:21:49Z", "pr_url": "https://github.com/all-of-us/workbench/pull/2984", "timeline": [{"oid": "8916014d807c7b12c7ca07a2e945be22893da57f", "url": "https://github.com/all-of-us/workbench/commit/8916014d807c7b12c7ca07a2e945be22893da57f", "message": "Add to static hosted files", "committedDate": "2020-01-08T22:21:06Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDQ3Mzc5NA==", "url": "https://github.com/all-of-us/workbench/pull/2984#discussion_r364473794", "bodyText": "We should either remove the files from /cluster-resources, or copy the files here as part of the build step and .gitignore these. Currently the file is duplicated in source.", "author": "calbach", "createdAt": "2020-01-08T22:25:03Z", "path": "api/src/main/webapp/static/activity-checker-extension.js", "diffHunk": "@@ -0,0 +1,45 @@\n+// Sends a message to the parent frame every second that user activity is detected", "originalCommit": "8916014d807c7b12c7ca07a2e945be22893da57f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDQ3NzM4Mg==", "url": "https://github.com/all-of-us/workbench/pull/2984#discussion_r364477382", "bodyText": "I can do the copy. There was a requirement to keep them served to GCS, so I didn't want to mess with that code.", "author": "s-rubenstein", "createdAt": "2020-01-08T22:35:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDQ3Mzc5NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDQ3NDQ3OQ==", "url": "https://github.com/all-of-us/workbench/pull/2984#discussion_r364474479", "bodyText": "I don't think this one will be needed anymore.", "author": "calbach", "createdAt": "2020-01-08T22:26:58Z", "path": "api/cluster-resources/build.rb", "diffHunk": "@@ -27,6 +27,9 @@ def build_snippets_menu()\n \n   FileUtils.mkdir_p \"generated\"\n   File.write(\"generated/aou-snippets-menu.js\", tmpl)", "originalCommit": "8916014d807c7b12c7ca07a2e945be22893da57f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDgwNDk3MA==", "url": "https://github.com/all-of-us/workbench/pull/2984#discussion_r364804970", "bodyText": "The ticket states:\nNote: cluster-resources must continue to be pushed to GCS following this change. Teardown of this approach will follow later.\n\nI wanted to do minimal changes to that deploy for now, and refactor when we removed that as a requirement. I think we still need this if we want to push that file to GCS.", "author": "s-rubenstein", "createdAt": "2020-01-09T15:33:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDQ3NDQ3OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDQ3NjU3NQ==", "url": "https://github.com/all-of-us/workbench/pull/2984#discussion_r364476575", "bodyText": "I just remembered we should probably include this set of http headers: \n  \n    \n      workbench/ui/app.yaml\n    \n    \n        Lines 11 to 15\n      in\n      e70ef35\n    \n    \n    \n    \n\n        \n          \n           http_headers: \n        \n\n        \n          \n             Strict-Transport-Security: \"max-age=31536000; includeSubDomains; preload\" \n        \n\n        \n          \n             X-XSS-Protection: 1 \n        \n\n        \n          \n             X-Content-Type-Options: \"nosniff\" \n        \n\n        \n          \n             Content-Security-Policy: \"default-src 'none'; frame-ancestors 'none'; report-uri /content-security-report\" \n        \n    \n  \n\n\nThis would probably push us towards pulling in the whole static/ directory to avoid repeating these on every include element.", "author": "calbach", "createdAt": "2020-01-08T22:32:51Z", "path": "api/src/main/webapp/WEB-INF/appengine-web.xml.template", "diffHunk": "@@ -26,6 +25,15 @@\n     <handler file=\"server_unavailable.html\" />\n   </static-error-handlers>\n \n+  <static-files>\n+    <include path=\"static/activity-checker-extension.js\" />", "originalCommit": "8916014d807c7b12c7ca07a2e945be22893da57f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "006edaaf6340fa1f161bbd701139cc7fdea17762", "url": "https://github.com/all-of-us/workbench/commit/006edaaf6340fa1f161bbd701139cc7fdea17762", "message": "Copy on build and ignore files to avoid duplication", "committedDate": "2020-01-09T15:31:45Z", "type": "commit"}, {"oid": "55d297c329ed541c025f7c1989167e5fb544afb7", "url": "https://github.com/all-of-us/workbench/commit/55d297c329ed541c025f7c1989167e5fb544afb7", "message": "Add policy headers", "committedDate": "2020-01-09T16:09:30Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDg2MDU3Nw==", "url": "https://github.com/all-of-us/workbench/pull/2984#discussion_r364860577", "bodyText": "I would move this into deploy_app instead, somewhere around L1579 (before appengineStage). This copy needs to happen every time before we build the GAE app for deployment, so it should be more closely coupled to that step", "author": "calbach", "createdAt": "2020-01-09T17:12:00Z", "path": "api/libproject/devstart.rb", "diffHunk": "@@ -1503,6 +1503,7 @@ def deploy_gcs_artifacts(cmd_name, args)\n \n   Dir.chdir(\"cluster-resources\") do\n     common.run_inline(%W{./build.rb build-snippets-menu})\n+    common.run_inline(%W{./build.rb generate-static-files})", "originalCommit": "55d297c329ed541c025f7c1989167e5fb544afb7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDg2MTQyOQ==", "url": "https://github.com/all-of-us/workbench/pull/2984#discussion_r364861429", "bodyText": "Thanks for adding the README", "author": "calbach", "createdAt": "2020-01-09T17:13:43Z", "path": "api/src/main/webapp/static/README.md", "diffHunk": "@@ -0,0 +1,8 @@\n+#Static Files in AppEngine", "originalCommit": "55d297c329ed541c025f7c1989167e5fb544afb7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDg2MzE5NA==", "url": "https://github.com/all-of-us/workbench/pull/2984#discussion_r364863194", "bodyText": "Can you verify that this is picking up aou-snippets-menu.js? Pretty sure you need ** to pickup subdirs. Alternative fix would be to just to not mirror the generated/ dir there, just copy it straight into /static. That seems fine, if not correct to me, since all of these static files are copied in during the build time anyways - the fact that this one file is generated is no longer relevant.", "author": "calbach", "createdAt": "2020-01-09T17:17:38Z", "path": "api/src/main/webapp/WEB-INF/appengine-web.xml.template", "diffHunk": "@@ -26,6 +25,20 @@\n     <handler file=\"server_unavailable.html\" />\n   </static-error-handlers>\n \n+  <static-files>\n+    <include path=\"static/*\">", "originalCommit": "55d297c329ed541c025f7c1989167e5fb544afb7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDg3NzIxNw==", "url": "https://github.com/all-of-us/workbench/pull/2984#discussion_r364877217", "bodyText": "You're right, it is not making it. I will ** it anyway, since we should allow subdirectories, but also get rid of the generated subdir", "author": "s-rubenstein", "createdAt": "2020-01-09T17:49:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDg2MzE5NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDg2MzkwMA==", "url": "https://github.com/all-of-us/workbench/pull/2984#discussion_r364863900", "bodyText": "Since we're globbig the directory, won't this be served as a static resource? If so, I might suggest moving this to either api/doc or cluster-resources/README.md", "author": "calbach", "createdAt": "2020-01-09T17:19:09Z", "path": "api/src/main/webapp/static/README.md", "diffHunk": "@@ -0,0 +1,8 @@\n+#Static Files in AppEngine\n+We host a number of public static files in GAE for cluster creation. These files are copied at build time from our cluster resources directory. Eventually (when we no longer support bucket extensions), these files should move into this directory and we should no longer gitignore them from here.\n+", "originalCommit": "55d297c329ed541c025f7c1989167e5fb544afb7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDg3NzU5Nw==", "url": "https://github.com/all-of-us/workbench/pull/2984#discussion_r364877597", "bodyText": "This will be served as a static resource, but I think that's probably okay? I'd prefer to have it where the files are. Unless you have strong feelings against it being served? (I can also add it as a specific exclude?)", "author": "s-rubenstein", "createdAt": "2020-01-09T17:50:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDg2MzkwMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDg4NjAxNQ==", "url": "https://github.com/all-of-us/workbench/pull/2984#discussion_r364886015", "bodyText": "Good idea - exclude sounds reasonable", "author": "calbach", "createdAt": "2020-01-09T18:10:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDg2MzkwMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDg2NDc3Mg==", "url": "https://github.com/all-of-us/workbench/pull/2984#discussion_r364864772", "bodyText": "nit: if you move the README out, you can just ignore the whole directory", "author": "calbach", "createdAt": "2020-01-09T17:20:55Z", "path": ".gitignore", "diffHunk": "@@ -20,6 +20,11 @@ cron-emulator-err.log\n /api/src/main/webapp/WEB-INF/cron.yaml\n /api/src/main/webapp/WEB-INF/sa-key.json\n /api/src/main/webapp/WEB-INF/gsuite-admin-sa.json\n+/api/src/main/webapp/static/generated/*\n+/api/src/main/webapp/static/activity-checker-extension.js", "originalCommit": "55d297c329ed541c025f7c1989167e5fb544afb7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "1fb5de42d3e8e0b1a3567aff5bf6774bfdbe5ffc", "url": "https://github.com/all-of-us/workbench/commit/1fb5de42d3e8e0b1a3567aff5bf6774bfdbe5ffc", "message": "Exclude readme and move static file copying", "committedDate": "2020-01-09T18:22:11Z", "type": "commit"}]}