{"pr_number": 4357, "pr_title": "[no ticket][risk=no] Puppeteer: Flaky tests fixes", "pr_createdAt": "2020-12-05T04:04:02Z", "pr_url": "https://github.com/all-of-us/workbench/pull/4357", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzEwMTM4MQ==", "url": "https://github.com/all-of-us/workbench/pull/4357#discussion_r537101381", "bodyText": "refactored isLoaded function for RW-6005 workaround.", "author": "aweng98", "createdAt": "2020-12-06T18:57:07Z", "path": "e2e/app/page/home-page.ts", "diffHunk": "@@ -20,24 +20,25 @@ export default class HomePage extends AuthenticatedPage {\n   }\n \n   async isLoaded(): Promise<boolean> {\n-    await Promise.all([\n-      waitForDocumentTitle(this.page, PageTitle),\n-      waitWhileLoading(this.page)\n+    await waitForDocumentTitle(this.page, PageTitle);", "originalCommit": "1392d8863e2d7772fa5ff06683fa373bdbe50d0a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzEwMTU0Nw==", "url": "https://github.com/all-of-us/workbench/pull/4357#discussion_r537101547", "bodyText": "waitForKernelIdle already is in waitForLoad", "author": "aweng98", "createdAt": "2020-12-06T18:58:05Z", "path": "e2e/app/page/notebook-preview-page.ts", "diffHunk": "@@ -37,7 +37,6 @@ export default class NotebookPreviewPage extends AuthenticatedPage {\n \n     const notebookPage = new NotebookPage(this.page, notebookName);\n     await notebookPage.waitForLoad();\n-    await notebookPage.waitForKernelIdle();", "originalCommit": "1392d8863e2d7772fa5ff06683fa373bdbe50d0a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzEwMTc1NQ==", "url": "https://github.com/all-of-us/workbench/pull/4357#discussion_r537101755", "bodyText": "Fix signInAs function to remove unused page parameter", "author": "aweng98", "createdAt": "2020-12-06T18:59:27Z", "path": "e2e/utils/test-utils.ts", "diffHunk": "@@ -27,17 +27,15 @@ export async function signIn(page: Page, userId?: string, passwd?: string): Prom\n \n /**\n  * Login in new Incognito page.\n- * @param page\n  * @param {string} userId\n  * @param {string} passwd\n  */\n-// @ts-ignore\n-export async function signInAs(page: Page, userId: string, passwd: string, opts: {reset?: boolean} = {}): Promise<Page> {\n+export async function signInAs(userId: string, passwd: string, opts: {reset?: boolean} = {}): Promise<Page> {", "originalCommit": "1392d8863e2d7772fa5ff06683fa373bdbe50d0a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzYyMjkwMA==", "url": "https://github.com/all-of-us/workbench/pull/4357#discussion_r537622900", "bodyText": "nit: I don't think O needs to be uppercased.\nAlso, I would add the time unit suffix so it's clear if this is milliseconds, seconds, nanoseconds, etc.", "author": "ericsong", "createdAt": "2020-12-07T16:01:42Z", "path": "e2e/app/page/notebook-page.ts", "diffHunk": "@@ -237,6 +243,11 @@ export default class NotebookPage extends AuthenticatedPage {\n     return frame.contentFrame();\n   }\n \n+  private async findRunButton(timeOut?: number): Promise<ElementHandle> {", "originalCommit": "ff49f854f70a0908624eec2723270f35368e38ce", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzY5MTA5MQ==", "url": "https://github.com/all-of-us/workbench/pull/4357#discussion_r537691091", "bodyText": "parameter timeout is in a lot of functions. to keep it consistent, I'll make a separate PR to append the suffix.", "author": "aweng98", "createdAt": "2020-12-07T17:30:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzYyMjkwMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzYyMzc3Mw==", "url": "https://github.com/all-of-us/workbench/pull/4357#discussion_r537623773", "bodyText": "nit: Reload*ing* seems a little more accurate since it's going to execute the action itself (and it's not asking the user to do so).", "author": "ericsong", "createdAt": "2020-12-07T16:02:47Z", "path": "e2e/app/page/notebook-page.ts", "diffHunk": "@@ -45,7 +45,13 @@ export default class NotebookPage extends AuthenticatedPage {\n \n   async isLoaded(): Promise<boolean> {\n     await waitForDocumentTitle(this.page, this.documentTitle);\n-    await this.waitForKernelIdle(30000);\n+    try {\n+      await this.findRunButton(120000);\n+    } catch (err) {\n+      console.log(`Reload \"${this.documentTitle}\" because cannot find the Run button`);", "originalCommit": "ff49f854f70a0908624eec2723270f35368e38ce", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzY4ODkwMA==", "url": "https://github.com/all-of-us/workbench/pull/4357#discussion_r537688900", "bodyText": "right, done!", "author": "aweng98", "createdAt": "2020-12-07T17:27:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzYyMzc3Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzYyNTM3OA==", "url": "https://github.com/all-of-us/workbench/pull/4357#discussion_r537625378", "bodyText": "does this need to be changed to let?", "author": "ericsong", "createdAt": "2020-12-07T16:04:49Z", "path": "e2e/tests/notebook/reader-copy-to-workspace.spec.ts", "diffHunk": "@@ -33,7 +34,7 @@ describe('Workspace reader Jupyter notebook action tests', () => {\n   test('Workspace reader copy notebook to another workspace', async () => {\n     const workspaceName = await createWorkspace(page).then(card => card.clickWorkspaceName());\n \n-    const dataPage = new WorkspaceDataPage(page);\n+    let dataPage = new WorkspaceDataPage(page);", "originalCommit": "ff49f854f70a0908624eec2723270f35368e38ce", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzY5MjExMA==", "url": "https://github.com/all-of-us/workbench/pull/4357#discussion_r537692110", "bodyText": "it is initiated twice. at line 55.", "author": "aweng98", "createdAt": "2020-12-07T17:31:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzYyNTM3OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzYyODAwNw==", "url": "https://github.com/all-of-us/workbench/pull/4357#discussion_r537628007", "bodyText": "should we just create/find a workspace in a beforeAll function? I'm not sure if its always the case that tests will run in sequence, especially if we add parallelization.", "author": "ericsong", "createdAt": "2020-12-07T16:07:57Z", "path": "e2e/tests/workspace/workspace-edit.spec.ts", "diffHunk": "@@ -11,6 +11,10 @@ describe('Editing workspace via workspace card snowman menu', () => {\n     await signIn(page);\n   });\n \n+  // Reuse same Workspace for all tests in this file to reduce test playback time.\n+  // Workspace to be created in first test. If first test fails, next test will create it.\n+  let workspaceName: string;", "originalCommit": "6bf63c920175bb17fd5ff3baa7a8b4c35c3634b1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzY5MjUwOQ==", "url": "https://github.com/all-of-us/workbench/pull/4357#discussion_r537692509", "bodyText": "In Jest, tests in same file will always run. in serial order.", "author": "aweng98", "createdAt": "2020-12-07T17:32:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzYyODAwNw=="}], "type": "inlineReview"}, {"oid": "2689d914c66e4b26ae338966785fc093940237c1", "url": "https://github.com/all-of-us/workbench/commit/2689d914c66e4b26ae338966785fc093940237c1", "message": "fix flaky tests", "committedDate": "2020-12-07T17:42:44Z", "type": "forcePushed"}, {"oid": "e4dcf1b7639d0e7f69fa108575e3fd9b389b8940", "url": "https://github.com/all-of-us/workbench/commit/e4dcf1b7639d0e7f69fa108575e3fd9b389b8940", "message": "fix flaky tests", "committedDate": "2020-12-07T17:46:50Z", "type": "commit"}, {"oid": "4ad3eec98855a4cb91f0f8fecd01c8624db655df", "url": "https://github.com/all-of-us/workbench/commit/4ad3eec98855a4cb91f0f8fecd01c8624db655df", "message": "rebase master", "committedDate": "2020-12-07T17:47:34Z", "type": "commit"}, {"oid": "4ad3eec98855a4cb91f0f8fecd01c8624db655df", "url": "https://github.com/all-of-us/workbench/commit/4ad3eec98855a4cb91f0f8fecd01c8624db655df", "message": "rebase master", "committedDate": "2020-12-07T17:47:34Z", "type": "forcePushed"}, {"oid": "f35bf4c6def48773da0b0330ab387e11f7c9194f", "url": "https://github.com/all-of-us/workbench/commit/f35bf4c6def48773da0b0330ab387e11f7c9194f", "message": "timeOut parameter renamed", "committedDate": "2020-12-07T17:53:24Z", "type": "commit"}]}