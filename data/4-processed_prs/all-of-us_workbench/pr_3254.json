{"pr_number": 3254, "pr_title": "[RW-4139][risk=no] CircleCI config change to run Puppeteer tests on master merges", "pr_createdAt": "2020-03-14T14:42:09Z", "pr_url": "https://github.com/all-of-us/workbench/pull/3254", "timeline": [{"oid": "45a4c3d5d3e5d7604fd32a085b7d17c88cc2b5dd", "url": "https://github.com/all-of-us/workbench/commit/45a4c3d5d3e5d7604fd32a085b7d17c88cc2b5dd", "message": "circle config change to run Puppeteer tests on master merges", "committedDate": "2020-03-14T14:40:16Z", "type": "commit"}, {"oid": "b730913b60fcf1de6470354d777fedffd1e745e1", "url": "https://github.com/all-of-us/workbench/commit/b730913b60fcf1de6470354d777fedffd1e745e1", "message": "comment out job master filter", "committedDate": "2020-03-14T14:45:46Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjU5NDIxOA==", "url": "https://github.com/all-of-us/workbench/pull/3254#discussion_r392594218", "bodyText": "The logs folder is going to be created in a follow-up PR for test results and screenshots.", "author": "aweng98", "createdAt": "2020-03-14T14:56:14Z", "path": ".circleci/config.yml", "diffHunk": "@@ -257,7 +257,52 @@ jobs:\n           root: .\n           paths:\n             - ui\n-\n+  \n+  puppeteer-e2e-test:\n+    docker:\n+      - image: circleci/node:12.16.1\n+    working_directory: ~/workbench\n+    steps:\n+      - checkout\n+      - run:\n+          name: Fetch Submodules\n+          command: git submodule update --init --recursive\n+      - restore_cache:\n+          keys:\n+          - ui-cache-{{ checksum \"~/workbench/e2e/yarn.lock\" }}\n+          - ui-cache-\n+      - run: \n+          working_directory: ~/workbench/e2e\n+          command: yarn cache clean && yarn install --verbose --frozen-lockfile\n+      - save_cache:\n+          paths:\n+            - ~/.cache/yarn\n+          key: ui-cache-{{ checksum \"~/workbench/e2e/yarn.lock\" }}\n+      - run:\n+          working_directory: ~/workbench/e2e\n+          name: Install Headless Chrome dependencies\n+          command: |\n+            sudo apt-get install -yq \\\n+              gconf-service libasound2 libatk1.0-0 libatk-bridge2.0-0 libc6 libcairo2 libcups2 libdbus-1-3 \\\n+              libexpat1 libfontconfig1 libgcc1 libgconf-2-4 libgdk-pixbuf2.0-0 libglib2.0-0 libgtk-3-0 libnspr4 \\\n+              libpango-1.0-0 libpangocairo-1.0-0 libstdc++6 libx11-6 libx11-xcb1 libxcb1 libxcomposite1 libxcursor1 \\\n+              libxdamage1 libxext6 libxfixes3 libxi6 libxrandr2 libxrender1 libxss1 libxtst6 ca-certificates \\\n+              fonts-liberation libappindicator1 libnss3 lsb-release xdg-utils wget\n+      - run:\n+          name: Update environment variables\n+          command: |\n+            echo 'export USER_NAME=$PUPPETEER_TEST_USER' >> $BASH_ENV\n+            echo 'export PASSWORD=$PUPPETEER_TEST_USER_PASSWORD' >> $BASH_ENV\n+            echo 'export INVITATION_KEY=$PUPPETEER_TEST_REGISTRATION_KEY' >> $BASH_ENV\n+            echo 'export CONTACT_EMAIL=hermione.owner@quality.firecloud.org' >> $BASH_ENV\n+            source $BASH_ENV\n+      - run:\n+          name: Run e2e tests (Puppeteer and Jest)\n+          working_directory: ~/workbench/e2e\n+          command: yarn --silent test:ci\n+      - store_artifacts:\n+          path: e2e/logs", "originalCommit": "b730913b60fcf1de6470354d777fedffd1e745e1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjU5NDI3OQ==", "url": "https://github.com/all-of-us/workbench/pull/3254#discussion_r392594279", "bodyText": "Remove this line. Uncomment line #414 - 419 before PR merge.", "author": "aweng98", "createdAt": "2020-03-14T14:56:54Z", "path": ".circleci/config.yml", "diffHunk": "@@ -356,6 +401,7 @@ workflows:\n       - ui-build-test\n       - api-bigquery-test\n       - api-integration-test\n+      - puppeteer-e2e-test # to test Puppeteer tests start and run. To be removed before PR merge.", "originalCommit": "b730913b60fcf1de6470354d777fedffd1e745e1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzc1MDg2MA==", "url": "https://github.com/all-of-us/workbench/pull/3254#discussion_r393750860", "bodyText": "More thoughts about this line: If it is run for every commit, I can get more runs to find out, isolate any test that could be flaky.", "author": "aweng98", "createdAt": "2020-03-17T15:10:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjU5NDI3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzk2MjA3OQ==", "url": "https://github.com/all-of-us/workbench/pull/3254#discussion_r393962079", "bodyText": "Would prefer we don't do that, this will generate noise on unrelated PRs.", "author": "calbach", "createdAt": "2020-03-17T20:51:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjU5NDI3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDM3NDcyNw==", "url": "https://github.com/all-of-us/workbench/pull/3254#discussion_r394374727", "bodyText": "\ud83d\udc4dline removed.", "author": "aweng98", "createdAt": "2020-03-18T14:11:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjU5NDI3OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzIzODQ0Ng==", "url": "https://github.com/all-of-us/workbench/pull/3254#discussion_r393238446", "bodyText": "Can we bake some of these into the dockerfile? This seems like it would be a large amount of files to install every time.", "author": "s-rubenstein", "createdAt": "2020-03-16T18:43:19Z", "path": ".circleci/config.yml", "diffHunk": "@@ -257,7 +257,52 @@ jobs:\n           root: .\n           paths:\n             - ui\n-\n+  \n+  puppeteer-e2e-test:\n+    docker:\n+      - image: circleci/node:12.16.1\n+    working_directory: ~/workbench\n+    steps:\n+      - checkout\n+      - run:\n+          name: Fetch Submodules\n+          command: git submodule update --init --recursive\n+      - restore_cache:\n+          keys:\n+          - ui-cache-{{ checksum \"~/workbench/e2e/yarn.lock\" }}\n+          - ui-cache-\n+      - run: \n+          working_directory: ~/workbench/e2e\n+          command: yarn cache clean && yarn install --verbose --frozen-lockfile\n+      - save_cache:\n+          paths:\n+            - ~/.cache/yarn\n+          key: ui-cache-{{ checksum \"~/workbench/e2e/yarn.lock\" }}\n+      - run:\n+          working_directory: ~/workbench/e2e\n+          name: Install Headless Chrome dependencies\n+          command: |\n+            sudo apt-get install -yq \\", "originalCommit": "b730913b60fcf1de6470354d777fedffd1e745e1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzk1ODM0MA==", "url": "https://github.com/all-of-us/workbench/pull/3254#discussion_r393958340", "bodyText": "I'd be surprised if there isn't a prebuilt Circle image which has these. Try circleci/node:12.16.1-browsers", "author": "calbach", "createdAt": "2020-03-17T20:44:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzIzODQ0Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDM4MjM3OA==", "url": "https://github.com/all-of-us/workbench/pull/3254#discussion_r394382378", "bodyText": "I saw node:<version>-browsers image too. I chose not to use it because image installs Firefox and Chrome/chromedriver. Test run in Chromium headless. So installed files are not exactly what test need and provided more than what test need. No preference from me as long as image works.  Do folks still prefer node:<version>-browsers?\nSo I tried circleci/node:13.10.1-browsers image and test ran in headless mode so I think it is okay to use that a node:<version>-browswer image.", "author": "aweng98", "createdAt": "2020-03-18T14:21:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzIzODQ0Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDQ4NTY2NA==", "url": "https://github.com/all-of-us/workbench/pull/3254#discussion_r394485664", "bodyText": "Thanks, this is good. We just don't want to maintain this long list of package installs if we can avoid it. Image size of prebuilt Circle images is not really a concern since Circle automatically caches them all.", "author": "calbach", "createdAt": "2020-03-18T16:37:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzIzODQ0Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzIzODkwNA==", "url": "https://github.com/all-of-us/workbench/pull/3254#discussion_r393238904", "bodyText": "Could you add the puppeteer tests to the staging deploy job as well? We should probably block releases on this?", "author": "s-rubenstein", "createdAt": "2020-03-16T18:44:15Z", "path": ".circleci/config.yml", "diffHunk": "@@ -398,6 +450,7 @@ workflows:\n             - api-deps-check\n             - api-integration-test", "originalCommit": "b730913b60fcf1de6470354d777fedffd1e745e1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzcyMTc1NQ==", "url": "https://github.com/all-of-us/workbench/pull/3254#discussion_r393721755", "bodyText": "Could you add the puppeteer tests to the staging deploy job as well? We should probably block releases on this?\n\nThis sounds like the right approach on the surface (at least until we can run these tests hermetically pre-merge, which would provide a strong guarantee that \"any merged code passes our e2e tests\"). We should probably let this burn in for awhile before potentially disrupting our release process. This sounds like a good point to discuss in the design doc (@aweng98 can you add a link to the design from RW-4139?) and potentially discuss at tomorrow's eng sync.", "author": "gjuggler", "createdAt": "2020-03-17T14:30:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzIzODkwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzkxNDg3Ng==", "url": "https://github.com/all-of-us/workbench/pull/3254#discussion_r393914876", "bodyText": "My recommendation is take some time to learn more about tests, test framework and Puppeteer. Let's keep it simple and non-disruptive. Only enable this job for test-deploying and non-blocking deploy and releases.", "author": "aweng98", "createdAt": "2020-03-17T19:21:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzIzODkwNA=="}], "type": "inlineReview"}, {"oid": "3d3e7f5d760a51d1258bd198a9a2221d524603e0", "url": "https://github.com/all-of-us/workbench/commit/3d3e7f5d760a51d1258bd198a9a2221d524603e0", "message": "PR feedback", "committedDate": "2020-03-17T14:21:47Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzk2MzAxNw==", "url": "https://github.com/all-of-us/workbench/pull/3254#discussion_r393963017", "bodyText": "This doesn't seem like it needs to be configurable via an env var.", "author": "calbach", "createdAt": "2020-03-17T20:52:22Z", "path": ".circleci/config.yml", "diffHunk": "@@ -257,7 +257,54 @@ jobs:\n           root: .\n           paths:\n             - ui\n-\n+  \n+  puppeteer-e2e-test:\n+    docker:\n+      - image: circleci/node:12.16.1\n+        environment:\n+          NODE_ENV: development\n+    working_directory: ~/workbench\n+    steps:\n+      - checkout\n+      - run:\n+          name: Fetch Submodules\n+          command: git submodule update --init --recursive\n+      - restore_cache:\n+          keys:\n+          - ui-cache-{{ checksum \"~/workbench/e2e/yarn.lock\" }}\n+          - ui-cache-\n+      - run: \n+          working_directory: ~/workbench/e2e\n+          command: yarn cache clean && yarn install --verbose --frozen-lockfile\n+      - save_cache:\n+          paths:\n+            - ~/.cache/yarn\n+          key: ui-cache-{{ checksum \"~/workbench/e2e/yarn.lock\" }}\n+      - run:\n+          working_directory: ~/workbench/e2e\n+          name: Install Headless Chrome dependencies\n+          command: |\n+            sudo apt-get install -yq \\\n+              gconf-service libasound2 libatk1.0-0 libatk-bridge2.0-0 libc6 libcairo2 libcups2 libdbus-1-3 \\\n+              libexpat1 libfontconfig1 libgcc1 libgconf-2-4 libgdk-pixbuf2.0-0 libglib2.0-0 libgtk-3-0 libnspr4 \\\n+              libpango-1.0-0 libpangocairo-1.0-0 libstdc++6 libx11-6 libx11-xcb1 libxcb1 libxcomposite1 libxcursor1 \\\n+              libxdamage1 libxext6 libxfixes3 libxi6 libxrandr2 libxrender1 libxss1 libxtst6 ca-certificates \\\n+              fonts-liberation libappindicator1 libnss3 lsb-release xdg-utils wget\n+      - run:\n+          name: Update environment variables\n+          command: |\n+            echo 'export USER_NAME=$PUPPETEER_TEST_USER' >> $BASH_ENV\n+            echo 'export PASSWORD=$PUPPETEER_TEST_USER_PASSWORD' >> $BASH_ENV\n+            echo 'export INVITATION_KEY=$PUPPETEER_TEST_REGISTRATION_KEY' >> $BASH_ENV\n+            echo 'export CONTACT_EMAIL=hermione.owner@quality.firecloud.org' >> $BASH_ENV", "originalCommit": "3d3e7f5d760a51d1258bd198a9a2221d524603e0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDM3NDAzOQ==", "url": "https://github.com/all-of-us/workbench/pull/3254#discussion_r394374039", "bodyText": "right. it's not a \"secret\" value. I'll remove it here and refactor in next PR.", "author": "aweng98", "createdAt": "2020-03-18T14:10:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzk2MzAxNw=="}], "type": "inlineReview"}, {"oid": "cdf801f5021b944808ab0509367f12ec679e38d0", "url": "https://github.com/all-of-us/workbench/commit/cdf801f5021b944808ab0509367f12ec679e38d0", "message": "revert last commit", "committedDate": "2020-03-18T02:43:49Z", "type": "commit"}, {"oid": "cdf801f5021b944808ab0509367f12ec679e38d0", "url": "https://github.com/all-of-us/workbench/commit/cdf801f5021b944808ab0509367f12ec679e38d0", "message": "revert last commit", "committedDate": "2020-03-18T02:43:49Z", "type": "forcePushed"}, {"oid": "0674689439f7bd8191cb44804b927aa4c5188012", "url": "https://github.com/all-of-us/workbench/commit/0674689439f7bd8191cb44804b927aa4c5188012", "message": "last test", "committedDate": "2020-03-18T02:46:35Z", "type": "commit"}, {"oid": "434026057601e742302ffb55b897299529dee013", "url": "https://github.com/all-of-us/workbench/commit/434026057601e742302ffb55b897299529dee013", "message": "runInBand", "committedDate": "2020-03-18T03:07:32Z", "type": "commit"}, {"oid": "b454c5b1271fbe6c85eb43b134a7f8ff657359db", "url": "https://github.com/all-of-us/workbench/commit/b454c5b1271fbe6c85eb43b134a7f8ff657359db", "message": "maxWorker is 2 again", "committedDate": "2020-03-18T14:04:08Z", "type": "commit"}, {"oid": "1acf9b71faa2c134b46775ce25cbe561210d4480", "url": "https://github.com/all-of-us/workbench/commit/1acf9b71faa2c134b46775ce25cbe561210d4480", "message": "try node-browser image", "committedDate": "2020-03-18T14:27:27Z", "type": "commit"}, {"oid": "0d553fd31452509aedc54d501822e216ffd8f104", "url": "https://github.com/all-of-us/workbench/commit/0d553fd31452509aedc54d501822e216ffd8f104", "message": "comment out headless dependencies", "committedDate": "2020-03-18T14:56:05Z", "type": "commit"}, {"oid": "019922c7f18c9cee91b9bbaeb508e63934796739", "url": "https://github.com/all-of-us/workbench/commit/019922c7f18c9cee91b9bbaeb508e63934796739", "message": "removed commented code", "committedDate": "2020-03-18T15:12:35Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDQ4NzQ4OQ==", "url": "https://github.com/all-of-us/workbench/pull/3254#discussion_r394487489", "bodyText": "Please name this key differently here and below:\ne.g.\n- e2e-cache-{{ checksum ... }}\n- e2e-cache-\n\nThis is not caching the same thing as the above UI tests", "author": "calbach", "createdAt": "2020-03-18T16:39:48Z", "path": ".circleci/config.yml", "diffHunk": "@@ -257,7 +257,52 @@ jobs:\n           root: .\n           paths:\n             - ui\n-\n+  \n+  puppeteer-e2e-test:\n+    docker:\n+      - image: circleci/node:12.16.1\n+    working_directory: ~/workbench\n+    steps:\n+      - checkout\n+      - run:\n+          name: Fetch Submodules\n+          command: git submodule update --init --recursive\n+      - restore_cache:\n+          keys:\n+          - ui-cache-{{ checksum \"~/workbench/e2e/yarn.lock\" }}", "originalCommit": "b730913b60fcf1de6470354d777fedffd1e745e1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "43103076abfa50ffaaea8d8d07d67b435f042c20", "url": "https://github.com/all-of-us/workbench/commit/43103076abfa50ffaaea8d8d07d67b435f042c20", "message": "rename cache", "committedDate": "2020-03-18T16:57:32Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDQzMzY5Nw==", "url": "https://github.com/all-of-us/workbench/pull/3254#discussion_r394433697", "bodyText": "Can you add a comment here describing this workflow a bit (e.g. \"Runs the suite of Puppeteer end-to-end QA tests, pointed at the test Workbench environment.\") and possibly add a cross-link to the relevant Jira ticket or design doc?", "author": "gjuggler", "createdAt": "2020-03-18T15:27:26Z", "path": ".circleci/config.yml", "diffHunk": "@@ -257,7 +257,44 @@ jobs:\n           root: .\n           paths:\n             - ui\n-\n+  \n+  puppeteer-e2e-test:", "originalCommit": "019922c7f18c9cee91b9bbaeb508e63934796739", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDU2OTExMQ==", "url": "https://github.com/all-of-us/workbench/pull/3254#discussion_r394569111", "bodyText": "That's easy. doing so doesn't over-comment code, right? I do have a comment at line #405 in workflows section, although not worded same.", "author": "aweng98", "createdAt": "2020-03-18T18:51:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDQzMzY5Nw=="}], "type": "inlineReview"}, {"oid": "1b39b349b7606b998c7858c70e89778b5da290b2", "url": "https://github.com/all-of-us/workbench/commit/1b39b349b7606b998c7858c70e89778b5da290b2", "message": "add comments", "committedDate": "2020-03-20T16:35:47Z", "type": "commit"}, {"oid": "fa735ebab68c882049786ccef238df531247721e", "url": "https://github.com/all-of-us/workbench/commit/fa735ebab68c882049786ccef238df531247721e", "message": "fix bad comments", "committedDate": "2020-03-20T16:47:32Z", "type": "commit"}]}