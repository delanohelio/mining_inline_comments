{"pr_number": 3435, "pr_title": "[no ticket][risk=no] CircleCI Names and anchors for common steps", "pr_createdAt": "2020-04-17T22:56:25Z", "pr_url": "https://github.com/all-of-us/workbench/pull/3435", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDUwNzE1NA==", "url": "https://github.com/all-of-us/workbench/pull/3435#discussion_r410507154", "bodyText": "This comment is probably what originally lead to confusion here. This is talking about a very specific issue the original implementer probably hit, to explain why an extra parameter is needed below, but does little to explain what this check is actually doing.\nI'd just delete this comment and update the name to match your variable \"Ensure branch has API source changes\"", "author": "calbach", "createdAt": "2020-04-17T22:59:37Z", "path": ".circleci/config.yml", "diffHunk": "@@ -1,35 +1,39 @@\n version: 2\n \n-defaults: &defaults\n-  docker:\n-    - image: allofustest/workbench:buildimage-0.0.16\n-  working_directory: ~/workbench\n-java_defaults: &java_defaults\n-  <<: *defaults\n-  environment:\n-    # As best I can tell (dmohs, 7 Feb '17), this is the only way to set a memory limit that Java\n-    # processes executed within CircleCI's docker containers will respect. Very helpful resource:\n-    # https://circleci.com/blog/how-to-handle-java-oom-errors/\n-    #\n-    # In Feb 2017, this was set to 3G. But in Feb 2019 (RW-2194) we started seeing OOM errors,\n-    # so we bumped this down further to 2G.\n-    JAVA_TOOL_OPTIONS: -Xmx2g\n-    TERM: dumb\n-\n+anchors:\n+  defaults: &defaults\n+    docker:\n+      - image: allofustest/workbench:buildimage-0.0.16\n+    working_directory: ~/workbench\n+  ensure_branch_has_api_changes: &ensure_branch_has_api_changes\n+    name: Ensure Branch is on Origin\n+    #Circle is bad about setting up your remotes for you, you must use origin/", "originalCommit": "2e3cd9e3f74b17d61fba4818ec96bfd5ded2afb7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDk3NzIxMw==", "url": "https://github.com/all-of-us/workbench/pull/3435#discussion_r410977213", "bodyText": "Yeah, trying to understand where the remotes came in distracted me from the actual code.", "author": "jaycarlton", "createdAt": "2020-04-19T19:47:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDUwNzE1NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDUwNzQ1Nw==", "url": "https://github.com/all-of-us/workbench/pull/3435#discussion_r410507457", "bodyText": "was this backtick intentional?", "author": "calbach", "createdAt": "2020-04-17T23:00:55Z", "path": ".circleci/config.yml", "diffHunk": "@@ -154,25 +155,15 @@ jobs:\n     <<: *java_defaults\n     steps:\n       - checkout\n-      - run:\n-          name: Fetch Submodules\n-          command: git submodule update --init --recursive\n-      - run:\n-          #Circle is bad about setting up your remotes for you, you must use origin/\n-          command: |\n-            if [ ${CIRCLE_BRANCH} != \"\" ] && [ ${CIRCLE_BRANCH} != \"master\" ] && [ $(git diff --name-only $(git merge-base origin/master ${CIRCLE_BRANCH}) | grep api/ | wc -l | xargs) == 0 ]; then\n-              echo No relevant changes on non-master branch, skipping\n-              circleci step halt\n-            fi\n+      - run: *update_git_submodules\n+      - run: *ensure_branch_has_api_changes\n       - restore_cache:\n           keys:\n           - api-integration-cache-{{ checksum \"~/workbench/api/build.gradle\" }}\n-          - api-integration-cache-\n-      - run:\n-          working_directory: ~/workbench\n-          # Used to call gsutil from the circle environment.\n-          command: ci/activate_creds.sh api/circle-sa-key.json\n+          - api-integration-cache-`", "originalCommit": "2e3cd9e3f74b17d61fba4818ec96bfd5ded2afb7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDk3NzAzNw==", "url": "https://github.com/all-of-us/workbench/pull/3435#discussion_r410977037", "bodyText": "No, good catch. I'm apparently too hard on Mac keyboards and they've started rebelling on me.", "author": "jaycarlton", "createdAt": "2020-04-19T19:46:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDUwNzQ1Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDUwNzU1Mg==", "url": "https://github.com/all-of-us/workbench/pull/3435#discussion_r410507552", "bodyText": "anchor?", "author": "calbach", "createdAt": "2020-04-17T23:01:19Z", "path": ".circleci/config.yml", "diffHunk": "@@ -295,21 +275,22 @@ jobs:\n     steps:\n       - checkout\n       - run:\n-          name: Fetch Submodules\n+          name: Update Git Submodules", "originalCommit": "2e3cd9e3f74b17d61fba4818ec96bfd5ded2afb7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDk3NzEzMg==", "url": "https://github.com/all-of-us/workbench/pull/3435#discussion_r410977132", "bodyText": "yep", "author": "jaycarlton", "createdAt": "2020-04-19T19:46:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDUwNzU1Mg=="}], "type": "inlineReview"}, {"oid": "a315ed19efcda37d6b67b893022e78e675173c00", "url": "https://github.com/all-of-us/workbench/commit/a315ed19efcda37d6b67b893022e78e675173c00", "message": "add names to steps for Circle UI labels", "committedDate": "2020-04-19T19:44:21Z", "type": "commit"}, {"oid": "1d32c71963757c3000053c463117d70c69c5feb3", "url": "https://github.com/all-of-us/workbench/commit/1d32c71963757c3000053c463117d70c69c5feb3", "message": "sp", "committedDate": "2020-04-19T19:44:21Z", "type": "commit"}, {"oid": "c2f6271620ba7f87acf6192786b726346832f3d4", "url": "https://github.com/all-of-us/workbench/commit/c2f6271620ba7f87acf6192786b726346832f3d4", "message": "moar anchors", "committedDate": "2020-04-19T19:44:21Z", "type": "commit"}, {"oid": "77ee27db6adedbfd359cc36e6cd675165807795c", "url": "https://github.com/all-of-us/workbench/commit/77ee27db6adedbfd359cc36e6cd675165807795c", "message": "cleanup", "committedDate": "2020-04-19T19:44:21Z", "type": "commit"}, {"oid": "aa45efe83f6ee909c0a479d78527fd59ad4ece24", "url": "https://github.com/all-of-us/workbench/commit/aa45efe83f6ee909c0a479d78527fd59ad4ece24", "message": "better title", "committedDate": "2020-04-19T19:44:21Z", "type": "commit"}, {"oid": "adea528bf32a28b38da46f4347a06a1be1d55ebb", "url": "https://github.com/all-of-us/workbench/commit/adea528bf32a28b38da46f4347a06a1be1d55ebb", "message": "review fixes", "committedDate": "2020-04-19T19:47:28Z", "type": "commit"}, {"oid": "adea528bf32a28b38da46f4347a06a1be1d55ebb", "url": "https://github.com/all-of-us/workbench/commit/adea528bf32a28b38da46f4347a06a1be1d55ebb", "message": "review fixes", "committedDate": "2020-04-19T19:47:28Z", "type": "forcePushed"}]}