{"pr_number": 3704, "pr_title": "[RW-5125][risk=no] Update grep regex patters in CircleCI", "pr_createdAt": "2020-06-23T14:12:47Z", "pr_url": "https://github.com/all-of-us/workbench/pull/3704", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDI2MzUwMg==", "url": "https://github.com/all-of-us/workbench/pull/3704#discussion_r444263502", "bodyText": "I kinda want to take this logic out of this file and put it in a script that we just call here.\nIt's conceivable that a .txt file could influence the behavior of the product, though I don't know of any current examples of this.\nEventually I'd like to move to a model where the first job determines what future jobs to run. That is, we wouldn't see a green checkmark for halted jobs; it would just never have run at all.\nIs there a way to halt with another symbol (like it does for skipped tests)? Seems like I looked at one point.", "author": "jaycarlton", "createdAt": "2020-06-23T14:23:00Z", "path": ".circleci/config.yml", "diffHunk": "@@ -107,7 +107,9 @@ commands:\n           command: |\n             if [ ${CIRCLE_BRANCH} != \"\" ] &&\n               [ ${CIRCLE_BRANCH} != \"master\" ] &&\n-              ! git diff --name-only $(git merge-base origin/master ${CIRCLE_BRANCH}) | grep -qvE '(.md$)|(.pdf$)'; then\n+              ! git diff --name-only $(git merge-base origin/master ${CIRCLE_BRANCH}) \\\n+                | grep -qvE '(.md)|(.pdf)|(.png)|(.svg)|(Test.java)|(Test.kt)|(.mp4)|(.log)|(.txt)'; then", "originalCommit": "52de7348ff238cfce3738ee45bb7191fc1e620d1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDI2NDIyMA==", "url": "https://github.com/all-of-us/workbench/pull/3704#discussion_r444264220", "bodyText": "Have you tested what happens when we make a PR against a non-master branch? I've occasionally felt the need to do this (e.g. when lots of reviewers are on vacation). Do we just not run CircleCI jobs?", "author": "jaycarlton", "createdAt": "2020-06-23T14:23:51Z", "path": ".circleci/config.yml", "diffHunk": "@@ -107,7 +107,9 @@ commands:\n           command: |\n             if [ ${CIRCLE_BRANCH} != \"\" ] &&\n               [ ${CIRCLE_BRANCH} != \"master\" ] &&\n-              ! git diff --name-only $(git merge-base origin/master ${CIRCLE_BRANCH}) | grep -qvE '(.md$)|(.pdf$)'; then\n+              ! git diff --name-only $(git merge-base origin/master ${CIRCLE_BRANCH}) \\", "originalCommit": "52de7348ff238cfce3738ee45bb7191fc1e620d1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDI2NTkyMA==", "url": "https://github.com/all-of-us/workbench/pull/3704#discussion_r444265920", "bodyText": "Can you put all these extensions into an environment var called E2E_IGNORE_PATTERNS? Can we use this approach for all our jobs?", "author": "jaycarlton", "createdAt": "2020-06-23T14:26:01Z", "path": ".circleci/config.yml", "diffHunk": "@@ -107,7 +107,9 @@ commands:\n           command: |\n             if [ ${CIRCLE_BRANCH} != \"\" ] &&\n               [ ${CIRCLE_BRANCH} != \"master\" ] &&\n-              ! git diff --name-only $(git merge-base origin/master ${CIRCLE_BRANCH}) | grep -qvE '(.md$)|(.pdf$)'; then\n+              ! git diff --name-only $(git merge-base origin/master ${CIRCLE_BRANCH}) \\\n+                | grep -qvE '(.md)|(.pdf)|(.png)|(.svg)|(Test.java)|(Test.kt)|(.mp4)|(.log)|(.txt)'; then", "originalCommit": "52de7348ff238cfce3738ee45bb7191fc1e620d1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDU2NTU4Ng==", "url": "https://github.com/all-of-us/workbench/pull/3704#discussion_r444565586", "bodyText": "Checking for PR branch if [ ${CIRCLE_BRANCH} != \"\" ] && [ ${CIRCLE_BRANCH} != \"master\" ] is now replaced by pr-skip-ci.sh.\nThe grep regex patterns is in e2e-job-ignore-patterns.txt.", "author": "aweng98", "createdAt": "2020-06-23T23:38:40Z", "path": ".circleci/config.yml", "diffHunk": "@@ -100,18 +100,19 @@ commands:\n           name: Update git submodules\n           command: git submodule update --init --recursive\n \n-  halt_job_noncode_changes:\n-    description: \"Halt job and succeed early if no code changes on non-master branch\"\n+  halt_if_code_unchanged:\n+    description: \"Halt job if no code changed\"\n     steps:\n       - run:\n           command: |\n-            if [ ${CIRCLE_BRANCH} != \"\" ] &&\n-              [ ${CIRCLE_BRANCH} != \"master\" ] &&\n-              ! git diff --name-only $(git merge-base origin/master ${CIRCLE_BRANCH}) | grep -qvE '(.md$)|(.pdf$)'; then\n-                echo \"No code changes on non-master branch. halting job.\"\n-                circleci step halt\n+            if ! git diff --name-only $(git merge-base origin/master ${CIRCLE_BRANCH}) | grep -qvFf .circleci/e2e-job-ignore-patterns.txt; then\n+              echo \"Application code have not changed. halting job.\"\n+              circleci step halt\n+            else\n+              git diff --name-only $(git merge-base origin/master ${CIRCLE_BRANCH}) | grep -vFf .circleci/e2e-job-ignore-patterns.txt\n+              echo \"job continuing.\"\n             fi", "originalCommit": "ac14b44bab1745104fb252f1d2513e05995b5754", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDk4MzMzMQ==", "url": "https://github.com/all-of-us/workbench/pull/3704#discussion_r444983331", "bodyText": "Very nice. I like how you didn't have to update a docker image to add your script. I was worried it would be worse.", "author": "jaycarlton", "createdAt": "2020-06-24T15:31:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDU2NTU4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDk5NDk3OA==", "url": "https://github.com/all-of-us/workbench/pull/3704#discussion_r444994978", "bodyText": "So, the else part in shell script is just to show you that non-matching files are the reason job is continuing. I can remove it if you like.", "author": "aweng98", "createdAt": "2020-06-24T15:48:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDU2NTU4Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDU2NTkxOA==", "url": "https://github.com/all-of-us/workbench/pull/3704#discussion_r444565918", "bodyText": "Unrelated to CircleCI config change, but it's related to running e2e tests in CircleCI. Abort job early if 3 tests have failed.", "author": "aweng98", "createdAt": "2020-06-23T23:40:00Z", "path": "e2e/package.json", "diffHunk": "@@ -9,7 +9,7 @@\n     \"test\": \"cross-env WORKBENCH_ENV=dev jest --maxWorkers=3\",\n     \"test:debug\": \"cross-env WORKBENCH_ENV=dev HEADLESS=false jest --detectOpenHandles\",\n     \"test-local\": \"cross-env WORKBENCH_ENV=local jest --maxWorkers=2\",\n-    \"test:ci\": \"cross-env NODE_ENV=development CI=true jest --ci --maxWorkers=2 --forceExit\",\n+    \"test:ci\": \"cross-env NODE_ENV=development CI=true jest --ci --maxWorkers=1\",", "originalCommit": "ac14b44bab1745104fb252f1d2513e05995b5754", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "c0fe71f85f0fd55189e2b06bd6845f55c16e3c07", "url": "https://github.com/all-of-us/workbench/commit/c0fe71f85f0fd55189e2b06bd6845f55c16e3c07", "message": "put grep regex patterns in a file", "committedDate": "2020-06-23T23:54:01Z", "type": "commit"}, {"oid": "c0fe71f85f0fd55189e2b06bd6845f55c16e3c07", "url": "https://github.com/all-of-us/workbench/commit/c0fe71f85f0fd55189e2b06bd6845f55c16e3c07", "message": "put grep regex patterns in a file", "committedDate": "2020-06-23T23:54:01Z", "type": "forcePushed"}, {"oid": "73a295bf418496cc016249d5425bc8dbb820916d", "url": "https://github.com/all-of-us/workbench/commit/73a295bf418496cc016249d5425bc8dbb820916d", "message": "puppettester3", "committedDate": "2020-06-24T14:43:34Z", "type": "commit"}, {"oid": "17191d79d9099e45a620add54746e38f63a9af66", "url": "https://github.com/all-of-us/workbench/commit/17191d79d9099e45a620add54746e38f63a9af66", "message": "enable e2e job", "committedDate": "2020-06-24T15:12:44Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDk3OTkxOA==", "url": "https://github.com/all-of-us/workbench/pull/3704#discussion_r444979918", "bodyText": "Awesome! I didn't see where you checked this in.", "author": "jaycarlton", "createdAt": "2020-06-24T15:26:55Z", "path": ".circleci/config.yml", "diffHunk": "@@ -604,11 +604,11 @@ workflows:\n           requires:\n             - ui-unit-test\n       # On master merges, run Puppeteer e2e tests after ui and api deployed to \"test\" env successfully.\n-      # - puppeteer-e2e-test:\n-          # filters: *filter_only_master_branch\n-          # requires:\n-            # - api-deploy-to-test\n-            # - ui-deploy-to-test\n+      - puppeteer-e2e-test:\n+          filters: *filter_only_master_branch", "originalCommit": "17191d79d9099e45a620add54746e38f63a9af66", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDk4MDk4Mg==", "url": "https://github.com/all-of-us/workbench/pull/3704#discussion_r444980982", "bodyText": "Oh, it's the same PR.", "author": "jaycarlton", "createdAt": "2020-06-24T15:28:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDk3OTkxOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDk4MjQ4Mw==", "url": "https://github.com/all-of-us/workbench/pull/3704#discussion_r444982483", "bodyText": "Are you scanning the PR description for a Jira Ticket number?\nI thought CircleCI already had a away to disable it for all but pull requests, but I remember we decided not to do that anymore for some reason.", "author": "jaycarlton", "createdAt": "2020-06-24T15:30:17Z", "path": ".circleci/pr-skip-ci.sh", "diffHunk": "@@ -0,0 +1,15 @@\n+#!/bin/bash\n+set -e\n+\n+# This script makes CircleCI exit a non pull-request job.\n+\n+echo \"CIRCLE_PULL_REQUEST: ${CIRCLE_PULL_REQUEST}\"\n+regexp=\"[[:digit:]]\\+$\"", "originalCommit": "17191d79d9099e45a620add54746e38f63a9af66", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDk5MjI1Mw==", "url": "https://github.com/all-of-us/workbench/pull/3704#discussion_r444992253", "bodyText": "No, not scanning PR description for ticket number.\nThe CircleCI setting to pull on PR only is still enabled, no change there.", "author": "aweng98", "createdAt": "2020-06-24T15:44:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDk4MjQ4Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDk4NDM5OQ==", "url": "https://github.com/all-of-us/workbench/pull/3704#discussion_r444984399", "bodyText": "If you're doing any screenshot comparison tests (which are kind of a pain), then some of these formats might need to be included. Likewise, if an image's dimensions change, it could make a button inaccessible, etc. So this may be a little strict.", "author": "jaycarlton", "createdAt": "2020-06-24T15:32:59Z", "path": ".circleci/e2e-job-ignore-patterns.txt", "diffHunk": "@@ -0,0 +1,10 @@\n+.md\n+.jpg", "originalCommit": "17191d79d9099e45a620add54746e38f63a9af66", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDk5MzkyMw==", "url": "https://github.com/all-of-us/workbench/pull/3704#discussion_r444993923", "bodyText": "Good point. Screenshot comparison testing is on the longer term road map.", "author": "aweng98", "createdAt": "2020-06-24T15:47:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDk4NDM5OQ=="}], "type": "inlineReview"}]}