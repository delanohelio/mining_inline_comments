{"pr_number": 3557, "pr_title": "[risk=no][RW-4928] Don't check Inst Affil on Profile Edit", "pr_createdAt": "2020-05-07T17:30:30Z", "pr_url": "https://github.com/all-of-us/workbench/pull/3557", "timeline": [{"oid": "1d63ce048f4f1c7d85d4c093a7597cf957d45626", "url": "https://github.com/all-of-us/workbench/commit/1d63ce048f4f1c7d85d4c093a7597cf957d45626", "message": "lint", "committedDate": "2020-05-08T15:59:14Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjMxMzYyMA==", "url": "https://github.com/all-of-us/workbench/pull/3557#discussion_r422313620", "bodyText": "null-safe check, so it prevents addition and removal as well as updates", "author": "jmthibault79", "createdAt": "2020-05-08T18:54:35Z", "path": "api/src/main/java/org/pmiops/workbench/api/ProfileController.java", "diffHunk": "@@ -309,14 +318,12 @@ private void validateUpdatedProfile(Profile updatedProfile, Profile prevProfile)\n       // See RW-1488.\n       throw new BadRequestException(\"Changing username is not supported\");\n     }\n-    if (updatedProfile.getVerifiedInstitutionalAffiliation() != null\n-        && !updatedProfile\n-            .getVerifiedInstitutionalAffiliation()\n-            .getInstitutionDisplayName()\n-            .equals(\n-                prevProfile.getVerifiedInstitutionalAffiliation().getInstitutionDisplayName())) {\n-      // See RW-1488.\n-      throw new BadRequestException(\"Changing institution is not currently supported\");\n+    final VerifiedInstitutionalAffiliation updatedAffil =\n+        updatedProfile.getVerifiedInstitutionalAffiliation();\n+    final VerifiedInstitutionalAffiliation prevAffil =\n+        prevProfile.getVerifiedInstitutionalAffiliation();\n+    if (!Objects.equals(updatedAffil, prevAffil)) {", "originalCommit": "8c45a388ec8458d739a0378fefcb7872735607ed", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjMxNDMyNg==", "url": "https://github.com/all-of-us/workbench/pull/3557#discussion_r422314326", "bodyText": "keeping the message here because it's a sign something has gone wrong if a real user sees it", "author": "jmthibault79", "createdAt": "2020-05-08T18:56:00Z", "path": "ui/src/app/pages/profile/profile-page.tsx", "diffHunk": "@@ -346,27 +338,30 @@ export const ProfilePage = withUserProfile()(class extends React.Component<\n                   valueKey: 'verifiedInstitutionalAffiliation.institutionDisplayName',\n                   disabled: true\n                 })}\n-                {!profile.verifiedInstitutionalAffiliation && <div style={{color: colors.danger}}>\n-                  Institution cannot be empty. Please contact admin\n-                </div>}\n+                {requireInstitutionalVerification && !profile.verifiedInstitutionalAffiliation &&\n+                  <div style={{color: colors.danger}}>\n+                    Institution cannot be empty. Please contact admin.", "originalCommit": "8c45a388ec8458d739a0378fefcb7872735607ed", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "8c617591b60ac1a4daf6219ceabfda9e6721113a", "url": "https://github.com/all-of-us/workbench/commit/8c617591b60ac1a4daf6219ceabfda9e6721113a", "message": "Because verified institutional affiliation can't be changed, we should not check for it\n- move one component behind feature flag\n- Don't update VIA on backend\n\n- Disable Inst Role editing", "committedDate": "2020-05-11T12:43:43Z", "type": "commit"}, {"oid": "8c617591b60ac1a4daf6219ceabfda9e6721113a", "url": "https://github.com/all-of-us/workbench/commit/8c617591b60ac1a4daf6219ceabfda9e6721113a", "message": "Because verified institutional affiliation can't be changed, we should not check for it\n- move one component behind feature flag\n- Don't update VIA on backend\n\n- Disable Inst Role editing", "committedDate": "2020-05-11T12:43:43Z", "type": "forcePushed"}, {"oid": "7672ccecf81cf03bb4301b3a043baf15a81d546c", "url": "https://github.com/all-of-us/workbench/commit/7672ccecf81cf03bb4301b3a043baf15a81d546c", "message": "lint", "committedDate": "2020-05-11T13:02:26Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQzOTcwMw==", "url": "https://github.com/all-of-us/workbench/pull/3557#discussion_r422439703", "bodyText": "nit: please adopt consistent formatting with names for other tests in this file: _changeForbidden would seem best.", "author": "gjuggler", "createdAt": "2020-05-09T01:51:29Z", "path": "api/src/test/java/org/pmiops/workbench/api/ProfileControllerTest.java", "diffHunk": "@@ -756,6 +756,63 @@ public void testMe_verifiedInstitutionalAffiliation_invalidEmail() {\n     createUser();\n   }\n \n+  @Test(expected = BadRequestException.class)\n+  public void updateVerifiedInstitutionalAffiliation_change_forbidden() {", "originalCommit": "8c45a388ec8458d739a0378fefcb7872735607ed", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQ0MDM5MQ==", "url": "https://github.com/all-of-us/workbench/pull/3557#discussion_r422440391", "bodyText": "I suspect we'll eventually need to rewrite logic very similar to this when we build out API support for admins to change a user's institutional affiliation \u2013 but it's not too much code, and may well be better placed somewhere else for that purpose anyway.", "author": "gjuggler", "createdAt": "2020-05-09T02:00:16Z", "path": "api/src/main/java/org/pmiops/workbench/db/dao/UserServiceImpl.java", "diffHunk": "@@ -412,29 +411,12 @@ public DbUser createUser(\n    * dbExistingVerifiedInstitutionalAffiliation and update it with Institution role and other text\n    *\n    * @param dbUser\n-   * @param dbVerifiedAffiliation\n    * @return\n    */\n   @Override\n-  public DbUser updateUserWithConflictHandling(\n-      DbUser dbUser, DbVerifiedInstitutionalAffiliation dbVerifiedAffiliation) {\n+  public DbUser updateUserWithConflictHandling(DbUser dbUser) {\n     try {\n       dbUser = userDao.save(dbUser);\n-      boolean requireInstitutionalVerification =", "originalCommit": "8c45a388ec8458d739a0378fefcb7872735607ed", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzgxNzU3OQ==", "url": "https://github.com/all-of-us/workbench/pull/3557#discussion_r423817579", "bodyText": "agreed", "author": "jmthibault79", "createdAt": "2020-05-12T15:16:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQ0MDM5MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQ0MDYyMw==", "url": "https://github.com/all-of-us/workbench/pull/3557#discussion_r422440623", "bodyText": "nit: this assertion (also repeated in the 'delete' test below) seems tangential to this test's purpose, and possibly redundant. Do we lose much by removing it?", "author": "gjuggler", "createdAt": "2020-05-09T02:02:52Z", "path": "api/src/test/java/org/pmiops/workbench/api/ProfileControllerTest.java", "diffHunk": "@@ -756,6 +756,63 @@ public void testMe_verifiedInstitutionalAffiliation_invalidEmail() {\n     createUser();\n   }\n \n+  @Test(expected = BadRequestException.class)\n+  public void updateVerifiedInstitutionalAffiliation_change_forbidden() {\n+    config.featureFlags.requireInstitutionalVerification = true;\n+\n+    final VerifiedInstitutionalAffiliation original = createVerifiedInstitutionalAffiliation();\n+\n+    createAccountRequest.getProfile().setVerifiedInstitutionalAffiliation(original);\n+\n+    createUser();\n+\n+    Profile profile = profileController.getMe().getBody();\n+    assertThat(profile.getVerifiedInstitutionalAffiliation()).isEqualTo(original);", "originalCommit": "8c45a388ec8458d739a0378fefcb7872735607ed", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzgxODEzMw==", "url": "https://github.com/all-of-us/workbench/pull/3557#discussion_r423818133", "bodyText": "this is a leftover from a previous version - I can remove", "author": "jmthibault79", "createdAt": "2020-05-12T15:17:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQ0MDYyMw=="}], "type": "inlineReview"}, {"oid": "fbd642ab12f868714e0de29f42173f9704cb620b", "url": "https://github.com/all-of-us/workbench/commit/fbd642ab12f868714e0de29f42173f9704cb620b", "message": "test cleanup", "committedDate": "2020-05-12T15:20:47Z", "type": "commit"}]}