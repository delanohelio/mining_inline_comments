{"pr_number": 3738, "pr_title": "[RW-5062][risk=no] Implement full DataSetMapper", "pr_createdAt": "2020-07-01T20:53:14Z", "pr_url": "https://github.com/all-of-us/workbench/pull/3738", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTAzNzk0Ng==", "url": "https://github.com/all-of-us/workbench/pull/3738#discussion_r449037946", "bodyText": "Can this be .map(cohortMapper::dbModelToClient)", "author": "NehaBroad", "createdAt": "2020-07-02T14:21:27Z", "path": "api/src/main/java/org/pmiops/workbench/cohorts/CohortService.java", "diffHunk": "@@ -1,19 +1,28 @@\n package org.pmiops.workbench.cohorts;\n \n import java.util.List;\n+import java.util.stream.Collectors;\n import org.pmiops.workbench.db.dao.CohortDao;\n import org.pmiops.workbench.db.model.DbCohort;\n+import org.pmiops.workbench.model.Cohort;\n+import org.springframework.beans.factory.annotation.Autowired;\n import org.springframework.stereotype.Service;\n \n @Service\n public class CohortService {\n-  private CohortDao cohortDao;\n+  private final CohortDao cohortDao;\n+  private final CohortMapper cohortMapper;\n \n-  public CohortService(CohortDao cohortDao) {\n+  @Autowired\n+  public CohortService(CohortDao cohortDao, CohortMapper cohortMapper) {\n     this.cohortDao = cohortDao;\n+    this.cohortMapper = cohortMapper;\n   }\n \n-  public List<DbCohort> findAll(List<Long> cohortIds) {\n-    return (List<DbCohort>) cohortDao.findAll(cohortIds);\n+  public List<Cohort> findAll(List<Long> cohortIds) {\n+    return ((List<DbCohort>) cohortDao.findAll(cohortIds))\n+        .stream()\n+            .map(dbCohort -> cohortMapper.dbModelToClient(dbCohort))", "originalCommit": "fb9c9d419f20c755414a86e0059392e231105ac8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTA1MzAzMw==", "url": "https://github.com/all-of-us/workbench/pull/3738#discussion_r449053033", "bodyText": "Done.", "author": "freemabd", "createdAt": "2020-07-02T14:42:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTAzNzk0Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTA0MjkxNQ==", "url": "https://github.com/all-of-us/workbench/pull/3738#discussion_r449042915", "bodyText": "Rather than individual elements since DataDictionaryEntry has equal and hashcode can we just have assertThat(dbDataDictionaryEntry).isEqual(dataDictionaryEntry)?", "author": "NehaBroad", "createdAt": "2020-07-02T14:28:22Z", "path": "api/src/test/java/org/pmiops/workbench/dataset/DataSetMapperTest.java", "diffHunk": "@@ -0,0 +1,194 @@\n+package org.pmiops.workbench.dataset;\n+\n+import static com.google.common.truth.Truth.assertThat;\n+import static org.mockito.Mockito.doReturn;\n+\n+import com.google.common.collect.ImmutableList;\n+import java.sql.Timestamp;\n+import java.time.Instant;\n+import java.util.Collections;\n+import java.util.stream.Collectors;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.pmiops.workbench.api.Etags;\n+import org.pmiops.workbench.cdr.ConceptBigQueryService;\n+import org.pmiops.workbench.cohorts.CohortMapperImpl;\n+import org.pmiops.workbench.cohorts.CohortService;\n+import org.pmiops.workbench.concept.ConceptService;\n+import org.pmiops.workbench.conceptset.ConceptSetMapperImpl;\n+import org.pmiops.workbench.conceptset.ConceptSetService;\n+import org.pmiops.workbench.db.dao.CohortDao;\n+import org.pmiops.workbench.db.dao.ConceptSetDao;\n+import org.pmiops.workbench.db.dao.UserDao;\n+import org.pmiops.workbench.db.model.DbCdrVersion;\n+import org.pmiops.workbench.db.model.DbCohort;\n+import org.pmiops.workbench.db.model.DbConceptSet;\n+import org.pmiops.workbench.db.model.DbDataDictionaryEntry;\n+import org.pmiops.workbench.db.model.DbDataset;\n+import org.pmiops.workbench.db.model.DbDatasetValue;\n+import org.pmiops.workbench.db.model.DbStorageEnums;\n+import org.pmiops.workbench.model.Cohort;\n+import org.pmiops.workbench.model.ConceptSet;\n+import org.pmiops.workbench.model.DataDictionaryEntry;\n+import org.pmiops.workbench.model.DataSet;\n+import org.pmiops.workbench.model.Domain;\n+import org.pmiops.workbench.model.PrePackagedConceptSetEnum;\n+import org.pmiops.workbench.utils.mappers.CommonMappers;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.boot.test.context.TestConfiguration;\n+import org.springframework.boot.test.mock.mockito.MockBean;\n+import org.springframework.context.annotation.Import;\n+import org.springframework.test.context.junit4.SpringRunner;\n+\n+@RunWith(SpringRunner.class)\n+public class DataSetMapperTest {\n+\n+  private DbDataset dbDataset;\n+  private DbDataDictionaryEntry dbDataDictionaryEntry;\n+\n+  @Autowired private DataSetMapper dataSetMapper;\n+  @Autowired private ConceptSetDao mockConceptSetDao;\n+  @Autowired private CohortDao mockCohortDao;\n+\n+  @TestConfiguration\n+  @Import({\n+    DataSetMapperImpl.class,\n+    CommonMappers.class,\n+    ConceptSetService.class,\n+    ConceptSetMapperImpl.class,\n+    CohortService.class,\n+    CohortMapperImpl.class\n+  })\n+  @MockBean({\n+    ConceptSetDao.class,\n+    ConceptBigQueryService.class,\n+    ConceptService.class,\n+    CohortDao.class,\n+    UserDao.class\n+  })\n+  static class Configuration {}\n+\n+  @Before\n+  public void setUp() {\n+    dbDataset =\n+        DbDataset.builder()\n+            .addVersion(1)\n+            .addDataSetId(101L)\n+            .addName(\"All Blue-eyed Blondes\")\n+            .addIncludesAllParticipants(false)\n+            .addDescription(\"All Blue-eyed Blondes\")\n+            .addLastModifiedTime(Timestamp.from(Instant.now()))\n+            .addWorkspaceId(1L)\n+            .addPrePackagedConceptSets(\n+                DbStorageEnums.prePackagedConceptSetsToStorage(PrePackagedConceptSetEnum.NONE))\n+            .addCohortIds(ImmutableList.of(1L))\n+            .addConceptSetIds(ImmutableList.of(1L))\n+            .addValues(\n+                ImmutableList.of(\n+                    new DbDatasetValue(\n+                        DbStorageEnums.domainToStorage(Domain.CONDITION).toString(), \"value\")))\n+            .build();\n+    DbConceptSet dbConceptSet = new DbConceptSet();\n+    dbConceptSet.setConceptSetId(1L);\n+    DbCohort dbCohort = new DbCohort();\n+    dbCohort.setCohortId(1L);\n+\n+    doReturn(Collections.singletonList(dbConceptSet))\n+        .when(mockConceptSetDao)\n+        .findAll(dbDataset.getConceptSetIds());\n+    doReturn(Collections.singletonList(dbCohort))\n+        .when(mockCohortDao)\n+        .findAll(dbDataset.getCohortIds());\n+\n+    DbCdrVersion cdrVersion = new DbCdrVersion();\n+    cdrVersion.setCdrVersionId(1L);\n+    dbDataDictionaryEntry = new DbDataDictionaryEntry();\n+    dbDataDictionaryEntry.setCdrVersion(cdrVersion);\n+    dbDataDictionaryEntry.setDefinedTime(Timestamp.from(Instant.now()));\n+    dbDataDictionaryEntry.setDataProvenance(\"p\");\n+    dbDataDictionaryEntry.setRelevantOmopTable(\"person\");\n+    dbDataDictionaryEntry.setFieldName(\"field\");\n+    dbDataDictionaryEntry.setOmopCdmStandardOrCustomField(\"field\");\n+    dbDataDictionaryEntry.setDescription(\"desc\");\n+    dbDataDictionaryEntry.setFieldType(\"type\");\n+    dbDataDictionaryEntry.setSourcePpiModule(\"s\");\n+    dbDataDictionaryEntry.setTransformedByRegisteredTierPrivacyMethods(false);\n+  }\n+\n+  @Test\n+  public void dbModelToClientLight() {\n+    final DataSet toClientDataSet = dataSetMapper.dbModelToClientLight(dbDataset);\n+    assertDbModelToClientLight(toClientDataSet, dbDataset);\n+  }\n+\n+  @Test\n+  public void dbModelToClientDataSet() {\n+    final DataSet toClientDataSet = dataSetMapper.dbModelToClient(dbDataset);\n+    assertDbModelToClient(toClientDataSet, dbDataset);\n+  }\n+\n+  @Test\n+  public void dbModelToClientDataDictionaryEntry() {\n+    final DataDictionaryEntry toClientDataDictionaryEntry =\n+        dataSetMapper.dbModelToClient(dbDataDictionaryEntry);\n+    assertDbModelToClient(toClientDataDictionaryEntry, dbDataDictionaryEntry);\n+  }\n+\n+  private void assertDbModelToClient(DataSet dataSet, DbDataset dbDataset) {\n+    assertThat(dbDataset.getCohortIds())\n+        .isEqualTo(dataSet.getCohorts().stream().map(Cohort::getId).collect(Collectors.toList()));\n+    assertThat(dbDataset.getConceptSetIds())\n+        .isEqualTo(\n+            dataSet.getConceptSets().stream().map(ConceptSet::getId).collect(Collectors.toList()));\n+    assertThat(dbDataset.getValues())\n+        .isEqualTo(\n+            dataSet.getDomainValuePairs().stream()\n+                .map(\n+                    dvp ->\n+                        new DbDatasetValue(\n+                            DbStorageEnums.domainToStorage(dvp.getDomain()).toString(),\n+                            dvp.getValue()))\n+                .collect(Collectors.toList()));\n+    assertDbModelToClientLight(dataSet, dbDataset);\n+  }\n+\n+  private void assertDbModelToClientLight(DataSet dataSet, DbDataset dbDataset) {\n+    assertThat(dbDataset.getDataSetId()).isEqualTo(dataSet.getId());\n+    assertThat(dbDataset.getVersion()).isEqualTo(Etags.toVersion(dataSet.getEtag()));\n+    assertThat(dbDataset.getName()).isEqualTo(dataSet.getName());\n+    assertThat(dbDataset.getIncludesAllParticipants())\n+        .isEqualTo(dataSet.getIncludesAllParticipants());\n+    assertThat(dbDataset.getDescription()).isEqualTo(dataSet.getDescription());\n+    assertThat(dbDataset.getWorkspaceId()).isEqualTo(dataSet.getWorkspaceId());\n+    assertThat(dbDataset.getLastModifiedTime().toInstant().toEpochMilli())\n+        .isEqualTo(dataSet.getLastModifiedTime());\n+    assertThat(dbDataset.getPrePackagedConceptSet())\n+        .isEqualTo(\n+            DbStorageEnums.prePackagedConceptSetsToStorage(dataSet.getPrePackagedConceptSet()));\n+  }\n+\n+  private void assertDbModelToClient(\n+      DataDictionaryEntry dataDictionaryEntry, DbDataDictionaryEntry dbDataDictionaryEntry) {\n+    assertThat(dbDataDictionaryEntry.getCdrVersion().getCdrVersionId())", "originalCommit": "fb9c9d419f20c755414a86e0059392e231105ac8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTA1NjMwNA==", "url": "https://github.com/all-of-us/workbench/pull/3738#discussion_r449056304", "bodyText": "dbDataDictionaryEntry and dataDictionaryEntry are different types. The equal and hashcode defined in DataDictionaryEntry is only for comparison to objects of type DataDictionaryEntry not DbDataDictionaryEntry", "author": "freemabd", "createdAt": "2020-07-02T14:47:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTA0MjkxNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTA2NjY5Mw==", "url": "https://github.com/all-of-us/workbench/pull/3738#discussion_r449066693", "bodyText": "Oh man i just missed that :D i thought its the same type DataDictionaryEntry", "author": "NehaBroad", "createdAt": "2020-07-02T15:02:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTA0MjkxNQ=="}], "type": "inlineReview"}, {"oid": "4f08feb413023798acbbacf232b542cb430ee1b1", "url": "https://github.com/all-of-us/workbench/commit/4f08feb413023798acbbacf232b542cb430ee1b1", "message": "RW-5062 adding test for datasetmapper", "committedDate": "2020-07-02T16:11:12Z", "type": "commit"}, {"oid": "682f2747a520d2f4b300ffebbbdf16f593db3158", "url": "https://github.com/all-of-us/workbench/commit/682f2747a520d2f4b300ffebbbdf16f593db3158", "message": "RW-5062 adding test for datasetmapper", "committedDate": "2020-07-02T16:11:12Z", "type": "commit"}, {"oid": "a88b34a049775fcd1b0b66b429b752376a6521ca", "url": "https://github.com/all-of-us/workbench/commit/a88b34a049775fcd1b0b66b429b752376a6521ca", "message": "RW-5062 adding test for datasetmapper", "committedDate": "2020-07-02T16:11:12Z", "type": "commit"}, {"oid": "ebd0bd29493eeafe89f58f39358f732ff4b531ba", "url": "https://github.com/all-of-us/workbench/commit/ebd0bd29493eeafe89f58f39358f732ff4b531ba", "message": "RW-5062 implementing mapper", "committedDate": "2020-07-02T16:11:12Z", "type": "commit"}, {"oid": "1937ca2b84c77d678edb3c50db06107aa5bed45d", "url": "https://github.com/all-of-us/workbench/commit/1937ca2b84c77d678edb3c50db06107aa5bed45d", "message": "RW-5062 implemented datasetmapper and updating tests.", "committedDate": "2020-07-02T16:11:12Z", "type": "commit"}, {"oid": "eb1308eaefe8326d2402718aaa1e9a968f2742fe", "url": "https://github.com/all-of-us/workbench/commit/eb1308eaefe8326d2402718aaa1e9a968f2742fe", "message": "RW-5062 updating tests", "committedDate": "2020-07-02T16:11:12Z", "type": "commit"}, {"oid": "4da561951a3fe5e727b8b4f5519f96a7507ab5e5", "url": "https://github.com/all-of-us/workbench/commit/4da561951a3fe5e727b8b4f5519f96a7507ab5e5", "message": "RW-5062 cleanup", "committedDate": "2020-07-02T16:11:12Z", "type": "commit"}, {"oid": "658cfb81759e1233ad1ce5abb9bd5a19905bc5da", "url": "https://github.com/all-of-us/workbench/commit/658cfb81759e1233ad1ce5abb9bd5a19905bc5da", "message": "RW-5062 cleanup", "committedDate": "2020-07-02T16:11:12Z", "type": "commit"}, {"oid": "df36aa4220d2c18c4246f8c3d695651f88ff9c8b", "url": "https://github.com/all-of-us/workbench/commit/df36aa4220d2c18c4246f8c3d695651f88ff9c8b", "message": "RW-5062 fixing compile error.", "committedDate": "2020-07-02T16:11:12Z", "type": "commit"}, {"oid": "655c1d4f97c7e4c7fa5538547c82578ea740b985", "url": "https://github.com/all-of-us/workbench/commit/655c1d4f97c7e4c7fa5538547c82578ea740b985", "message": "RW-5062 removing unused services", "committedDate": "2020-07-02T16:11:12Z", "type": "commit"}, {"oid": "87b966648058746858ea24b0b489c1c18ab087cf", "url": "https://github.com/all-of-us/workbench/commit/87b966648058746858ea24b0b489c1c18ab087cf", "message": "RW-5062 fix lambda expression", "committedDate": "2020-07-02T16:11:12Z", "type": "commit"}, {"oid": "87b966648058746858ea24b0b489c1c18ab087cf", "url": "https://github.com/all-of-us/workbench/commit/87b966648058746858ea24b0b489c1c18ab087cf", "message": "RW-5062 fix lambda expression", "committedDate": "2020-07-02T16:11:12Z", "type": "forcePushed"}]}