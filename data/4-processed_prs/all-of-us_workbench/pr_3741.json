{"pr_number": 3741, "pr_title": "[risk=no][RW-4361] remove requireInstitutionalVerification feature flag from UI and config", "pr_createdAt": "2020-07-02T13:48:53Z", "pr_url": "https://github.com/all-of-us/workbench/pull/3741", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTAyNDkwOQ==", "url": "https://github.com/all-of-us/workbench/pull/3741#discussion_r449024909", "bodyText": "email is no longer handled in this file.  See account-creation-institution and its spec", "author": "jmthibault79", "createdAt": "2020-07-02T14:02:41Z", "path": "ui/src/app/pages/login/account-creation/account-creation.spec.tsx", "diffHunk": "@@ -102,81 +102,6 @@ it('should handle username validity if name is valid', () => {\n   expect(wrapper.exists('#usernameError')).toBeFalsy();\n });\n \n-it('should handle invalid Email', () => {", "originalCommit": "6c930494b011f2fe3272eb0ff9b1b84d0ef3ea80", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTAyNTQyNQ==", "url": "https://github.com/all-of-us/workbench/pull/3741#discussion_r449025425", "bodyText": "Academic vs Non-Academic Affiliation is not a concept which exists in new-style affiliation", "author": "jmthibault79", "createdAt": "2020-07-02T14:03:29Z", "path": "ui/src/app/pages/login/account-creation/account-creation.spec.tsx", "diffHunk": "@@ -102,81 +102,6 @@ it('should handle username validity if name is valid', () => {\n   expect(wrapper.exists('#usernameError')).toBeFalsy();\n });\n \n-it('should handle invalid Email', () => {\n-  const wrapper = component();\n-  expect(wrapper.exists('#contactEmail')).toBeTruthy();\n-  expect(wrapper.exists('#invalidEmailError')).toBeFalsy();\n-  wrapper.find('input#contactEmail').simulate('change',\n-      {target: {value: 'username@'}});\n-  expect(wrapper.exists('#invalidEmailError')).toBeFalsy();\n-});\n-\n-// TODO remove after we switch to verified institutional affiliation\n-it('should display Institution name and role option by default', () => {\n-  serverConfigStore.next({...defaultConfig, requireInstitutionalVerification: false});\n-  const wrapper = component();\n-  const institutionName = wrapper.find('[data-test-id=\"institutionname\"]');\n-  expect(institutionName).toBeTruthy();\n-  const institutionRole = wrapper.find('[data-test-id=\"institutionRole\"]');\n-  expect(institutionRole).toBeTruthy();\n-  expect(institutionRole.find('li').length).toBe(AccountCreationOptions.roles.length);\n-  expect(institutionRole.find('li').get(0).props.children).toBe(AccountCreationOptions.roles[0].label);\n-});\n-\n-// TODO remove after we switch to verified institutional affiliation\n-it('should display Affiliation information if No is selected', () => {", "originalCommit": "6c930494b011f2fe3272eb0ff9b1b84d0ef3ea80", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTAyNzEyOQ==", "url": "https://github.com/all-of-us/workbench/pull/3741#discussion_r449027129", "bodyText": "This is not related to institutional affiliation and was added after the comment", "author": "jmthibault79", "createdAt": "2020-07-02T14:05:51Z", "path": "ui/src/app/pages/login/account-creation/account-creation.tsx", "diffHunk": "@@ -101,80 +95,31 @@ export interface AccountCreationState {\n   invalidEmail: boolean;\n   profile: Profile;\n   showAllFieldsRequiredError: boolean;\n+  showMostInterestedInKnowingBlurb: boolean;\n   usernameCheckInProgress: boolean;\n   usernameConflictError: boolean;\n-  // TODO(RW-4361): remove all after this point, after we switch to verified institutional affiliation\n-  rolesOptions: any;\n-  showInstitution: boolean;\n-  showNonAcademicAffiliationRole: boolean;\n-  showNonAcademicAffiliationOther: boolean;\n-  showMostInterestedInKnowingBlurb: boolean;", "originalCommit": "6c930494b011f2fe3272eb0ff9b1b84d0ef3ea80", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTAzMzkwNg==", "url": "https://github.com/all-of-us/workbench/pull/3741#discussion_r449033906", "bodyText": "these also refer to old-style affiliation", "author": "jmthibault79", "createdAt": "2020-07-02T14:15:45Z", "path": "ui/src/app/pages/login/account-creation/account-creation.tsx", "diffHunk": "@@ -239,55 +184,8 @@ export class AccountCreation extends React.Component<AccountCreationProps, Accou\n     this.setState(fp.set(['profile', 'address', attribute], value));\n   }\n \n-  updateInstitutionAffiliation(attribute: string, value) {", "originalCommit": "6c930494b011f2fe3272eb0ff9b1b84d0ef3ea80", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTAzNTkzMA==", "url": "https://github.com/all-of-us/workbench/pull/3741#discussion_r449035930", "bodyText": "handled by (existing) account-creation-institution.spec", "author": "jmthibault79", "createdAt": "2020-07-02T14:18:48Z", "path": "ui/src/app/pages/login/account-creation/account-creation.spec.tsx", "diffHunk": "@@ -102,81 +102,6 @@ it('should handle username validity if name is valid', () => {\n   expect(wrapper.exists('#usernameError')).toBeFalsy();\n });\n \n-it('should handle invalid Email', () => {\n-  const wrapper = component();\n-  expect(wrapper.exists('#contactEmail')).toBeTruthy();\n-  expect(wrapper.exists('#invalidEmailError')).toBeFalsy();\n-  wrapper.find('input#contactEmail').simulate('change',\n-      {target: {value: 'username@'}});\n-  expect(wrapper.exists('#invalidEmailError')).toBeFalsy();\n-});\n-\n-// TODO remove after we switch to verified institutional affiliation\n-it('should display Institution name and role option by default', () => {", "originalCommit": "6c930494b011f2fe3272eb0ff9b1b84d0ef3ea80", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTAzNjE2MQ==", "url": "https://github.com/all-of-us/workbench/pull/3741#discussion_r449036161", "bodyText": "account-creation-institution spec", "author": "jmthibault79", "createdAt": "2020-07-02T14:19:05Z", "path": "ui/src/app/pages/login/account-creation/account-creation.spec.tsx", "diffHunk": "@@ -102,81 +102,6 @@ it('should handle username validity if name is valid', () => {\n   expect(wrapper.exists('#usernameError')).toBeFalsy();\n });\n \n-it('should handle invalid Email', () => {\n-  const wrapper = component();\n-  expect(wrapper.exists('#contactEmail')).toBeTruthy();\n-  expect(wrapper.exists('#invalidEmailError')).toBeFalsy();\n-  wrapper.find('input#contactEmail').simulate('change',\n-      {target: {value: 'username@'}});\n-  expect(wrapper.exists('#invalidEmailError')).toBeFalsy();\n-});\n-\n-// TODO remove after we switch to verified institutional affiliation\n-it('should display Institution name and role option by default', () => {\n-  serverConfigStore.next({...defaultConfig, requireInstitutionalVerification: false});\n-  const wrapper = component();\n-  const institutionName = wrapper.find('[data-test-id=\"institutionname\"]');\n-  expect(institutionName).toBeTruthy();\n-  const institutionRole = wrapper.find('[data-test-id=\"institutionRole\"]');\n-  expect(institutionRole).toBeTruthy();\n-  expect(institutionRole.find('li').length).toBe(AccountCreationOptions.roles.length);\n-  expect(institutionRole.find('li').get(0).props.children).toBe(AccountCreationOptions.roles[0].label);\n-});\n-\n-// TODO remove after we switch to verified institutional affiliation\n-it('should display Affiliation information if No is selected', () => {\n-  serverConfigStore.next({...defaultConfig, requireInstitutionalVerification: false});\n-  const wrapper = component();\n-  const institutionAffilationOption = wrapper.find('[data-test-id=\"show-institution-no\"]')\n-    .find('input');\n-  expect(institutionAffilationOption).toBeTruthy();\n-  institutionAffilationOption.simulate('click');\n-  const affiliationDropDown = wrapper.find('Dropdown');\n-  const affiliationOptions = affiliationDropDown.find('DropdownItem');\n-  expect(affiliationOptions.length).toBe(AccountCreationOptions.nonAcademicAffiliations.length);\n-  expect(affiliationOptions.find('li').get(0).props.children)\n-    .toBe(AccountCreationOptions.nonAcademicAffiliations[0].label);\n-});\n-\n-// TODO remove after we switch to verified institutional affiliation\n-it('should display Affiliation Roles should change as per affiliation', () => {", "originalCommit": "6c930494b011f2fe3272eb0ff9b1b84d0ef3ea80", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTAzNzU4NQ==", "url": "https://github.com/all-of-us/workbench/pull/3741#discussion_r449037585", "bodyText": "rm (verification = false) test.  diff continues with the rest of the true test", "author": "jmthibault79", "createdAt": "2020-07-02T14:21:00Z", "path": "ui/src/app/pages/login/sign-in.spec.tsx", "diffHunk": "@@ -80,45 +80,15 @@ describe('SignInReact', () => {\n     const templateImage = wrapper.find('[data-test-id=\"sign-in-page\"]');\n   });\n \n-  it('should handle sign-up flow without institutional verification', () => {\n+  it('should handle sign-up flow', () => {\n     // This test is meant to validate the high-level flow through the sign-in component by checking\n     // that each step of the user registration flow is correctly rendered in order.\n     //\n     // As this is simply a high-level test of this component's ability to render each sub-component,\n     // we use Enzyme's shallow rendering to avoid needing to deal with the DOM-level details of\n     // each of the sub-components. Tests within the 'account-creation' folder should cover those\n     // details.\n-    props.serverConfig = {...defaultConfig, requireInstitutionalVerification: false};", "originalCommit": "6c930494b011f2fe3272eb0ff9b1b84d0ef3ea80", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTAzODI0OQ==", "url": "https://github.com/all-of-us/workbench/pull/3741#discussion_r449038249", "bodyText": "flag was false before.  now it's true and there's an extra page", "author": "jmthibault79", "createdAt": "2020-07-02T14:21:51Z", "path": "ui/src/app/pages/login/sign-in.spec.tsx", "diffHunk": "@@ -161,6 +131,7 @@ describe('SignInReact', () => {\n     expect(steps).toEqual([\n       SignInStep.LANDING,\n       SignInStep.TERMS_OF_SERVICE,\n+      SignInStep.INSTITUTIONAL_AFFILIATION,", "originalCommit": "6c930494b011f2fe3272eb0ff9b1b84d0ef3ea80", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTAzOTI4MQ==", "url": "https://github.com/all-of-us/workbench/pull/3741#discussion_r449039281", "bodyText": "not clear why this was here.  DUCC should not be affected by this.", "author": "jmthibault79", "createdAt": "2020-07-02T14:23:20Z", "path": "ui/src/app/pages/profile/data-user-code-of-conduct.spec.tsx", "diffHunk": "@@ -10,7 +10,7 @@ import {waitOneTickAndUpdate} from '../../../testing/react-test-helpers';\n \n const defaultConfig = {\n   gsuiteDomain: 'researchallofus.org',\n-  requireInstitutionalVerification: false,", "originalCommit": "6c930494b011f2fe3272eb0ff9b1b84d0ef3ea80", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTA0MDQyOA==", "url": "https://github.com/all-of-us/workbench/pull/3741#discussion_r449040428", "bodyText": "probably should have flag-protected the section above this.  So it's been always-true for a while already.  oops.", "author": "jmthibault79", "createdAt": "2020-07-02T14:24:54Z", "path": "ui/src/app/pages/profile/profile-page.tsx", "diffHunk": "@@ -447,7 +447,7 @@ export const ProfilePage = withUserProfile()(class extends React.Component<\n                   valueKey: 'verifiedInstitutionalAffiliation.institutionDisplayName',\n                   disabled: true\n                 })}\n-                {requireInstitutionalVerification && !profile.verifiedInstitutionalAffiliation &&\n+                {!profile.verifiedInstitutionalAffiliation &&", "originalCommit": "6c930494b011f2fe3272eb0ff9b1b84d0ef3ea80", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "e0cfba9a942107b05d7e9ae242a06e588cbf3778", "url": "https://github.com/all-of-us/workbench/commit/e0cfba9a942107b05d7e9ae242a06e588cbf3778", "message": "rm feature flag", "committedDate": "2020-07-02T15:33:58Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTEwNzI3OQ==", "url": "https://github.com/all-of-us/workbench/pull/3741#discussion_r449107279", "bodyText": "IIRC this represents some older behavior.  It's not currently correct.", "author": "jmthibault79", "createdAt": "2020-07-02T15:46:49Z", "path": "api/src/main/java/org/pmiops/workbench/db/dao/UserServiceImpl.java", "diffHunk": "@@ -408,8 +408,8 @@ public DbUser createUser(\n   }\n \n   /**\n-   * Save updated dbUser object if requireInstitutionalVerification is enabled: Get the existing", "originalCommit": "e0cfba9a942107b05d7e9ae242a06e588cbf3778", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTExMTU3Nw==", "url": "https://github.com/all-of-us/workbench/pull/3741#discussion_r449111577", "bodyText": "email is now on the institution page", "author": "jmthibault79", "createdAt": "2020-07-02T15:50:20Z", "path": "ui/src/app/pages/login/account-creation/account-creation.tsx", "diffHunk": "@@ -98,83 +92,32 @@ export interface AccountCreationProps {\n export interface AccountCreationState {\n   creatingAccount: boolean;\n   errors: any;\n-  invalidEmail: boolean;\n   profile: Profile;\n   showAllFieldsRequiredError: boolean;\n+  showMostInterestedInKnowingBlurb: boolean;\n   usernameCheckInProgress: boolean;\n   usernameConflictError: boolean;\n-  // TODO(RW-4361): remove all after this point, after we switch to verified institutional affiliation\n-  rolesOptions: any;\n-  showInstitution: boolean;\n-  showNonAcademicAffiliationRole: boolean;\n-  showNonAcademicAffiliationOther: boolean;\n-  showMostInterestedInKnowingBlurb: boolean;\n-  institutionName: string;\n-  institutionRole: string;\n-  nonAcademicAffiliation: string;\n-  nonAcademicAffiliationRole: string;\n-  nonAcademicAffiliationOther: string;\n }\n \n export class AccountCreation extends React.Component<AccountCreationProps, AccountCreationState> {\n   private usernameCheckTimeout: NodeJS.Timer;\n \n   constructor(props: AccountCreationProps) {\n-    // What's going on with this assertion: the account creation form only edits a single\n-    // institutional affiliation entry, even though it's a repeated field. This component has\n-    // a convention of requiring the Profile set in props to have a single, empty institutional\n-    // affiliation already populated, for editing by this form. See sign-in.tsx where the \"empty\"\n-    // profile object is created.\n-    // TODO(RW-4361): remove after we switch to verified institutional affiliation\n-    if (!serverConfigStore.getValue().requireInstitutionalVerification &&\n-      props.profile.institutionalAffiliations.length !== 1) {\n-      throw new Error('Profile must be pre-allocated with 1 institutional affiliation.');\n-    }\n     super(props);\n     this.state = this.createInitialState();\n   }\n \n-  async componentDidMount() {\n-    // TODO(RW-4361): Remove after we switch to verified institutional affiliation\n-    if (!serverConfigStore.getValue().requireInstitutionalVerification) {\n-      this.updateNonAcademicAffiliationRoles(\n-        this.state.profile.institutionalAffiliations[0].nonAcademicAffiliation);\n-      this.selectNonAcademicAffiliationRoles(\n-        this.state.profile.institutionalAffiliations[0].role);\n-    }\n-  }\n-\n   createInitialState(): AccountCreationState {\n     const state: AccountCreationState = {\n+      creatingAccount: false,\n       errors: undefined,\n       profile: this.props.profile,\n-      usernameCheckInProgress: false,\n-      usernameConflictError: false,\n-      creatingAccount: false,\n       showAllFieldsRequiredError: false,\n-      invalidEmail: false,", "originalCommit": "e0cfba9a942107b05d7e9ae242a06e588cbf3778", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "dbf359fbe2d09db7c535b15d4f6ca5d4270970d5", "url": "https://github.com/all-of-us/workbench/commit/dbf359fbe2d09db7c535b15d4f6ca5d4270970d5", "message": "rm from demographic-survey.spec", "committedDate": "2020-07-02T17:26:57Z", "type": "commit"}, {"oid": "dbfdff328316a7aa60e349874707247ef5389b4a", "url": "https://github.com/all-of-us/workbench/commit/dbfdff328316a7aa60e349874707247ef5389b4a", "message": "tmp rm account-creation", "committedDate": "2020-07-02T17:29:39Z", "type": "commit"}, {"oid": "7f815029bf5abace552bce7c675baabee71f461d", "url": "https://github.com/all-of-us/workbench/commit/7f815029bf5abace552bce7c675baabee71f461d", "message": "rm old-affiliation code and tests", "committedDate": "2020-07-02T17:29:43Z", "type": "commit"}, {"oid": "312eaf64d324f6fa0e8218999c0a365d66a6cc86", "url": "https://github.com/all-of-us/workbench/commit/312eaf64d324f6fa0e8218999c0a365d66a6cc86", "message": "rm from pages and tests", "committedDate": "2020-07-02T17:30:28Z", "type": "commit"}, {"oid": "4af144c9c13ed39c4e639a121c7f3f3490173ac5", "url": "https://github.com/all-of-us/workbench/commit/4af144c9c13ed39c4e639a121c7f3f3490173ac5", "message": "lint", "committedDate": "2020-07-02T17:30:31Z", "type": "commit"}, {"oid": "55571aa290d680aa73b4c9e0d57986847aa82557", "url": "https://github.com/all-of-us/workbench/commit/55571aa290d680aa73b4c9e0d57986847aa82557", "message": "rm from demographic", "committedDate": "2020-07-02T17:30:32Z", "type": "commit"}, {"oid": "9f97247a351fb07181ef7b9910c727c3e5881322", "url": "https://github.com/all-of-us/workbench/commit/9f97247a351fb07181ef7b9910c727c3e5881322", "message": "set to true", "committedDate": "2020-07-02T17:30:32Z", "type": "commit"}, {"oid": "7d49d5b381efdc3923b8aa4497c719a2e7304683", "url": "https://github.com/all-of-us/workbench/commit/7d49d5b381efdc3923b8aa4497c719a2e7304683", "message": "rm email", "committedDate": "2020-07-02T17:30:33Z", "type": "commit"}, {"oid": "89125ca542e721fefcec1df660f56dec88e56460", "url": "https://github.com/all-of-us/workbench/commit/89125ca542e721fefcec1df660f56dec88e56460", "message": "correct comment", "committedDate": "2020-07-02T17:30:34Z", "type": "commit"}, {"oid": "c3b135a2f8ae56df310440af79b325e1db9b57d2", "url": "https://github.com/all-of-us/workbench/commit/c3b135a2f8ae56df310440af79b325e1db9b57d2", "message": "rm feature flag", "committedDate": "2020-07-02T17:30:34Z", "type": "commit"}, {"oid": "c3b135a2f8ae56df310440af79b325e1db9b57d2", "url": "https://github.com/all-of-us/workbench/commit/c3b135a2f8ae56df310440af79b325e1db9b57d2", "message": "rm feature flag", "committedDate": "2020-07-02T17:30:34Z", "type": "forcePushed"}]}