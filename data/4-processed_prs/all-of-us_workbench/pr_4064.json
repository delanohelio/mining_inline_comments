{"pr_number": 4064, "pr_title": "[risk=low][RW-5560][RW-5561] Cross-CDR UX for Copy Concept Set and Notebook to Workspace ", "pr_createdAt": "2020-09-25T00:22:27Z", "pr_url": "https://github.com/all-of-us/workbench/pull/4064", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDY4ODA0NQ==", "url": "https://github.com/all-of-us/workbench/pull/4064#discussion_r494688045", "bodyText": "mostly copied from the mocks", "author": "jmthibault79", "createdAt": "2020-09-25T00:53:04Z", "path": "ui/src/app/components/copy-modal.tsx", "diffHunk": "@@ -21,54 +24,127 @@ const ResourceTypeHomeTabs = new Map()\n   .set(ResourceType.DATASET, 'data');\n \n export interface Props {\n+  cdrVersionListResponse: CdrVersionListResponse;\n   fromWorkspaceNamespace: string;\n-  fromWorkspaceName: string;\n+  fromWorkspaceFCName: string;\n   fromResourceName: string;\n+  fromCdrVersionId: string;\n   onClose: Function;\n   onCopy: Function;\n   resourceType: ResourceType;\n   saveFunction: (CopyRequest) => Promise<FileDetail | ConceptSet>;\n }\n \n interface State {\n-  writeableWorkspaces: Array<Workspace>;\n+  workspaceOptions: Array<Object>;\n   destination: Workspace;\n   newName: string;\n   requestState: RequestState;\n-  errorMsg: string;\n+  saveErrorMsg: string;\n   loading: boolean;\n+  cdrMismatch: string;\n }\n \n-const boldStyle = {\n-  fontWeight: 600\n-};\n+const styles = reactStyles({\n+  bold: {\n+    fontWeight: 600\n+  },\n+  conceptSetCdrMismatch: {", "originalCommit": "cf4f0c7adf9eeae1a7025c6948a71d82cf76fb54", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "ed14959e3b796c2643fcf59b613e88d8a20ecc4e", "url": "https://github.com/all-of-us/workbench/commit/ed14959e3b796c2643fcf59b613e88d8a20ecc4e", "message": "RW-5560 RW-5561 cross-CDR copy UX for Notebook and Concept Set", "committedDate": "2020-09-25T16:43:33Z", "type": "forcePushed"}, {"oid": "869ef443640cc6b44b775fcf4f5cff057189e093", "url": "https://github.com/all-of-us/workbench/commit/869ef443640cc6b44b775fcf4f5cff057189e093", "message": "RW-5560 RW-5561 cross-CDR copy UX for Notebook and Concept Set", "committedDate": "2020-09-25T17:20:25Z", "type": "forcePushed"}, {"oid": "6de0d125ad1733ac316f62b16dac830f1b9882e0", "url": "https://github.com/all-of-us/workbench/commit/6de0d125ad1733ac316f62b16dac830f1b9882e0", "message": "e2e test for Copy Concept Set", "committedDate": "2020-10-08T20:28:18Z", "type": "forcePushed"}, {"oid": "dae51896787472665ab4e8a8a77a8712c8dc489d", "url": "https://github.com/all-of-us/workbench/commit/dae51896787472665ab4e8a8a77a8712c8dc489d", "message": "rebase", "committedDate": "2020-10-08T21:12:42Z", "type": "forcePushed"}, {"oid": "ca12bd4da332dea3ca5e6f36c512a714630e3db8", "url": "https://github.com/all-of-us/workbench/commit/ca12bd4da332dea3ca5e6f36c512a714630e3db8", "message": "restore previous functionality (which worked)", "committedDate": "2020-10-09T12:45:28Z", "type": "forcePushed"}, {"oid": "9edfafe3d98017d220ce1bf15ead82c26ee08399", "url": "https://github.com/all-of-us/workbench/commit/9edfafe3d98017d220ce1bf15ead82c26ee08399", "message": "e2e test for Copy Concept Set", "committedDate": "2020-10-09T12:51:39Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDExMzE4NA==", "url": "https://github.com/all-of-us/workbench/pull/4064#discussion_r504113184", "bodyText": "extracted from the existing test, for reuse", "author": "jmthibault79", "createdAt": "2020-10-13T16:54:57Z", "path": "e2e/tests/conceptsets/copy-to-workspace.spec.ts", "diffHunk": "@@ -7,8 +7,30 @@ import {SaveOption} from 'app/page/conceptset-save-modal';\n import WorkspaceDataPage from 'app/page/workspace-data-page';\n import {LinkText, ResourceCard} from 'app/text-labels';\n import {makeRandomName} from 'utils/str-utils';\n-import {findWorkspace, signIn} from 'utils/test-utils';\n-\n+import {createWorkspace, signIn} from 'utils/test-utils';\n+import {config} from 'resources/workbench-config';\n+\n+async function createConceptSet(srcWorkspaceCard: WorkspaceCard) {", "originalCommit": "9edfafe3d98017d220ce1bf15ead82c26ee08399", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "6dfeb1a84fee9864b8565a943555f5de1972b69b", "url": "https://github.com/all-of-us/workbench/commit/6dfeb1a84fee9864b8565a943555f5de1972b69b", "message": "RW-5560 RW-5561 cross-CDR copy UX for Notebook and Concept Set", "committedDate": "2020-10-13T18:02:18Z", "type": "commit"}, {"oid": "fc89565bf62ff6dd4ba8820e18602a34b6bf99a5", "url": "https://github.com/all-of-us/workbench/commit/fc89565bf62ff6dd4ba8820e18602a34b6bf99a5", "message": "unit tests", "committedDate": "2020-10-13T18:02:19Z", "type": "commit"}, {"oid": "fd6759bd88856d7664bacdb25455b3053c6bb607", "url": "https://github.com/all-of-us/workbench/commit/fd6759bd88856d7664bacdb25455b3053c6bb607", "message": "e2e test for Copy Concept Set", "committedDate": "2020-10-13T18:02:19Z", "type": "commit"}, {"oid": "9b1ab0acbfc6de4136a86806827b37c33f493a10", "url": "https://github.com/all-of-us/workbench/commit/9b1ab0acbfc6de4136a86806827b37c33f493a10", "message": "Add ConceptSetRestrictionText", "committedDate": "2020-10-13T18:02:20Z", "type": "commit"}, {"oid": "e7b84f136ec6498ef596f9d72386e4014dbc84a2", "url": "https://github.com/all-of-us/workbench/commit/e7b84f136ec6498ef596f9d72386e4014dbc84a2", "message": "refactor copy-notebook test", "committedDate": "2020-10-13T18:02:20Z", "type": "commit"}, {"oid": "6fc8c5cba10802657abf00f66c0e9fe4d7fae6ed", "url": "https://github.com/all-of-us/workbench/commit/6fc8c5cba10802657abf00f66c0e9fe4d7fae6ed", "message": "copy alt cdr version", "committedDate": "2020-10-13T18:02:20Z", "type": "commit"}, {"oid": "6fc8c5cba10802657abf00f66c0e9fe4d7fae6ed", "url": "https://github.com/all-of-us/workbench/commit/6fc8c5cba10802657abf00f66c0e9fe4d7fae6ed", "message": "copy alt cdr version", "committedDate": "2020-10-13T18:02:20Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDE2NjE4MA==", "url": "https://github.com/all-of-us/workbench/pull/4064#discussion_r504166180", "bodyText": "So this can be used for successful and attempted copies", "author": "jmthibault79", "createdAt": "2020-10-13T18:20:08Z", "path": "e2e/app/component/copy-modal.ts", "diffHunk": "@@ -19,12 +19,12 @@ export default class CopyModal extends Modal {\n     return new Textbox(this.page, `${this.getXpath()}//*[contains(text(), \"Name\")]/ancestor::node()[1]/input[@type=\"text\"]`);\n   }\n \n- /**\n-  *\n-  * @param {string} workspaceName Destination Workspace name.\n-  * @param {string} newName New name.\n-  */\n-  async copyToAnotherWorkspace(workspaceName: string, newName?: string): Promise<void> {\n+  /**\n+   *\n+   * @param {string} workspaceName Destination Workspace name.\n+   * @param {string} newName New name.\n+   */\n+  async beginCopyToAnotherWorkspace(workspaceName: string, newName?: string): Promise<void> {", "originalCommit": "6fc8c5cba10802657abf00f66c0e9fe4d7fae6ed", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDE2NjcyNw==", "url": "https://github.com/all-of-us/workbench/pull/4064#discussion_r504166727", "bodyText": "TODO: refactor the kitchen-sink findWorkspace().  All we are using it for here is workspace creation.", "author": "jmthibault79", "createdAt": "2020-10-13T18:21:11Z", "path": "e2e/tests/conceptsets/copy-to-workspace.spec.ts", "diffHunk": "@@ -18,41 +40,26 @@ describe('Copy Concept Set to another workspace', () => {\n \n   /**\n    * Test:\n-   * - Copy Concept Set from one workspace to another workspace.\n+   * - Copy Concept Set from one workspace to another workspace when both have the same CDR Version.\n    */\n-  test('Workspace OWNER can copy Concept Set', async () => {\n+  test('Workspace OWNER can copy Concept Set when CDR Versions match', async () => {\n \n-    // Need a source and a destination workspace.\n+    // Create a source and a destination workspace with the same CDR Version.\n \n-    const destWorkspaceCard: WorkspaceCard = await findWorkspace(page, {create: true});", "originalCommit": "6fc8c5cba10802657abf00f66c0e9fe4d7fae6ed", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDE2NzA5Mw==", "url": "https://github.com/all-of-us/workbench/pull/4064#discussion_r504167093", "bodyText": "common code for two tests, copied from the original test", "author": "jmthibault79", "createdAt": "2020-10-13T18:21:50Z", "path": "e2e/tests/notebook/owner-copy-to-workspace.spec.ts", "diffHunk": "@@ -3,73 +3,79 @@ import Modal from 'app/component/modal';\n import WorkspaceDataPage from 'app/page/workspace-data-page';\n import {LinkText, ResourceCard} from 'app/text-labels';\n import {makeRandomName} from 'utils/str-utils';\n-import {findWorkspace, signIn} from 'utils/test-utils';\n+import {createWorkspace, findWorkspace, signIn} from 'utils/test-utils';\n+import {config} from 'resources/workbench-config';\n \n // Notebook server start may take a long time. Set maximum test running time to 20 minutes.\n jest.setTimeout(20 * 60 * 1000);\n \n+/**\n+ * Test:\n+ * - Create new Workspace as the copy-to destination Workspace.\n+ * - Create new Workspace as copy-from Workspace and create new notebook in this Workspace.\n+ * - Run code to print WORKSPACE_NAMESPACE. It should match Workspace namespace from Workspace URL.\n+ * - Copy notebook to destination Workspace and give copied notebook a new name.\n+ * - Verify copied notebook is in destination Workspace.\n+ * - Open copied notebook and run code to print WORKSPACE_NAMESPACE. It should match destination Workspace namespace.\n+ * - Delete notebooks.\n+ */\n+async function copyNotebookTest(srcCdrVersionName: string, destCdrVersionName: string) {", "originalCommit": "6fc8c5cba10802657abf00f66c0e9fe4d7fae6ed", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDE2NzM1NQ==", "url": "https://github.com/all-of-us/workbench/pull/4064#discussion_r504167355", "bodyText": "Adapted from the creation path of findWorkspace()", "author": "jmthibault79", "createdAt": "2020-10-13T18:22:20Z", "path": "e2e/utils/test-utils.ts", "diffHunk": "@@ -178,6 +179,20 @@ export async function performAction(\n \n }\n \n+export async function createWorkspace(page: Page, cdrVersionName: string = config.defaultCdrVersionName): Promise<WorkspaceCard> {", "originalCommit": "6fc8c5cba10802657abf00f66c0e9fe4d7fae6ed", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "06c224880f5350ff4f10db12498d646c62c9e7a4", "url": "https://github.com/all-of-us/workbench/commit/06c224880f5350ff4f10db12498d646c62c9e7a4", "message": "styling fix", "committedDate": "2020-10-13T18:49:09Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDcwODMzOQ==", "url": "https://github.com/all-of-us/workbench/pull/4064#discussion_r504708339", "bodyText": "opt: consider using an fp.cond here - I believe it would eliminate the need for an early return and would tie together the 3 conditions as \"one of these can occur\"", "author": "petesantos", "createdAt": "2020-10-14T14:08:56Z", "path": "ui/src/app/components/copy-modal.tsx", "diffHunk": "@@ -218,27 +276,57 @@ class CopyModalComponent extends React.Component<Props, State> {\n     }\n   }\n \n-  setDestination(destination: Workspace) {\n+  // OK to copy a notebook with a mismatch, but show a warning message\n+  setNotebookCdrMismatchWarning(destination: Workspace, fromCdrVersionId: string) {\n+    const warningMsg = `The selected destination workspace uses a different dataset version ` +\n+        `(${this.cdrName(destination.cdrVersionId)}) than the current workspace (${this.cdrName(fromCdrVersionId)}). ` +\n+        'Edits may be required to ensure your analysis is functional and accurate.';\n+    this.setState({ cdrMismatch: warningMsg, destination: destination });\n+  }\n+\n+  // not OK to copy a Concept Set with a mismatch.  Show an error message and prevent copy\n+  setConceptSetCdrMismatchError(destination: Workspace, fromCdrVersionId: string) {\n+    const errorMsg = `Can\u2019t copy to that workspace. It uses a different dataset version ` +\n+        `(${this.cdrName(destination.cdrVersionId)}) than the current workspace (${this.cdrName(fromCdrVersionId)}).`;\n+    this.setState({ cdrMismatch: errorMsg, destination: null });\n+  }\n+\n+  validateAndSetDestination(destination: Workspace) {\n+    const {fromCdrVersionId, resourceType} = this.props;\n+\n     this.clearCopyError();\n-    this.setState({destination: destination});\n+\n+    if (fromCdrVersionId === destination.cdrVersionId) {\n+      this.setState({cdrMismatch: '', destination: destination});\n+      return;\n+    }\n+\n+    if (resourceType === ResourceType.NOTEBOOK) {\n+      this.setNotebookCdrMismatchWarning(destination, fromCdrVersionId);\n+    } else if (resourceType === ResourceType.CONCEPTSET) {\n+      this.setConceptSetCdrMismatchError(destination, fromCdrVersionId);\n+    }", "originalCommit": "06c224880f5350ff4f10db12498d646c62c9e7a4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDc4Mzk2NQ==", "url": "https://github.com/all-of-us/workbench/pull/4064#discussion_r504783965", "bodyText": "I attempted to do so, but this caused my e2e tests to fail.  This attempt is commit ea710b5", "author": "jmthibault79", "createdAt": "2020-10-14T15:45:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDcwODMzOQ=="}], "type": "inlineReview"}, {"oid": "7152af17886f89821dec19e8ee66ffbe4ef3e5d1", "url": "https://github.com/all-of-us/workbench/commit/7152af17886f89821dec19e8ee66ffbe4ef3e5d1", "message": "lint", "committedDate": "2020-10-14T14:32:39Z", "type": "commit"}, {"oid": "ea710b52279e4e34f07b67eaf3cdd761ddeead7b", "url": "https://github.com/all-of-us/workbench/commit/ea710b52279e4e34f07b67eaf3cdd761ddeead7b", "message": "use fp.cond to set error", "committedDate": "2020-10-14T14:36:59Z", "type": "commit"}, {"oid": "213f969edee8dd14d810c3bd143a61f0bb205688", "url": "https://github.com/all-of-us/workbench/commit/213f969edee8dd14d810c3bd143a61f0bb205688", "message": "Revert \"use fp.cond to set error\"\n\nThis reverts commit ea710b52279e4e34f07b67eaf3cdd761ddeead7b.", "committedDate": "2020-10-14T15:43:40Z", "type": "commit"}]}