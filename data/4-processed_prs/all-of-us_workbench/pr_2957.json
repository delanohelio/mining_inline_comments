{"pr_number": 2957, "pr_title": "[RW-3932][Risk=low] Add the admin banner page", "pr_createdAt": "2020-01-02T16:40:19Z", "pr_url": "https://github.com/all-of-us/workbench/pull/2957", "timeline": [{"oid": "c5756b1a607a95fdb505b422cee4303100642fc5", "url": "https://github.com/all-of-us/workbench/commit/c5756b1a607a95fdb505b422cee4303100642fc5", "message": "Add the admin banner page", "committedDate": "2020-01-02T16:38:01Z", "type": "commit"}, {"oid": "c555d4e840f6677802132718393108e40c2e1b72", "url": "https://github.com/all-of-us/workbench/commit/c555d4e840f6677802132718393108e40c2e1b72", "message": "Fix linting and add banner active", "committedDate": "2020-01-02T17:25:11Z", "type": "commit"}, {"oid": "4e438e30a575f1df783e442f6fa7a54092658fb7", "url": "https://github.com/all-of-us/workbench/commit/4e438e30a575f1df783e442f6fa7a54092658fb7", "message": "Fix UI linting", "committedDate": "2020-01-02T17:34:16Z", "type": "commit"}, {"oid": "02d671bd274f41800e37c3aab236c01c19e8d8b5", "url": "https://github.com/all-of-us/workbench/commit/02d671bd274f41800e37c3aab236c01c19e8d8b5", "message": "Add validation", "committedDate": "2020-01-02T18:19:58Z", "type": "commit"}, {"oid": "4304973a668f0ab019832763126cb9f239069907", "url": "https://github.com/all-of-us/workbench/commit/4304973a668f0ab019832763126cb9f239069907", "message": "Add API tests for status alert controllers", "committedDate": "2020-01-02T19:39:57Z", "type": "commit"}, {"oid": "e8482d90c1555eb6acde43c2f0a38744e9dda781", "url": "https://github.com/all-of-us/workbench/commit/e8482d90c1555eb6acde43c2f0a38744e9dda781", "message": "Fix linting", "committedDate": "2020-01-02T19:40:34Z", "type": "commit"}, {"oid": "d5a906967ed8cb6442da40f2d7746a425b1bc2ad", "url": "https://github.com/all-of-us/workbench/commit/d5a906967ed8cb6442da40f2d7746a425b1bc2ad", "message": "Fix linting again", "committedDate": "2020-01-02T20:10:45Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MjYwNDM5Nw==", "url": "https://github.com/all-of-us/workbench/pull/2957#discussion_r362604397", "bodyText": "I assume the things removed and not replaced were duplicative with the things in profile? And I don't suppose anyone remembers why they were pulled out...", "author": "als364", "createdAt": "2020-01-02T19:45:58Z", "path": "ui/src/app/components/side-nav.tsx", "diffHunk": "@@ -197,36 +198,35 @@ class SideNavItem extends React.Component<SideNavItemProps, SideNavItemState> {\n }\n \n export interface SideNavProps {\n+  profile: Profile;\n+  bannerAdminActive: boolean;\n   homeActive: boolean;\n-  workspacesActive: boolean;\n   libraryActive: boolean;\n+  onToggleSideNav: Function;\n   profileActive: boolean;\n   userAdminActive: boolean;\n-  hasDataAccess: boolean;\n-  hasAccessModuleAdmin: boolean;\n-  aouAccountEmailAddress: string;\n-  contactEmailAddress: string;\n-  givenName: string;", "originalCommit": "4304973a668f0ab019832763126cb9f239069907", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MjYxNzI5NA==", "url": "https://github.com/all-of-us/workbench/pull/2957#discussion_r362617294", "bodyText": "Yes, they were duplicative, and I don't think anyone remembers... this is old code from the start of the project basically.", "author": "s-rubenstein", "createdAt": "2020-01-02T20:25:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MjYwNDM5Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MjYwNTEwNA==", "url": "https://github.com/all-of-us/workbench/pull/2957#discussion_r362605104", "bodyText": "nice!", "author": "als364", "createdAt": "2020-01-02T19:47:54Z", "path": "ui/src/app/pages/admin/admin-banner.tsx", "diffHunk": "@@ -0,0 +1,133 @@\n+import {Component} from '@angular/core';\n+import {BoldHeader, Header} from 'app/components/headers';\n+import {TextArea, TextInput} from 'app/components/inputs';\n+import {statusAlertApi} from 'app/services/swagger-fetch-clients';\n+import colors from 'app/styles/colors';\n+import {ReactWrapperBase} from 'app/utils';\n+import * as React from 'react';\n+import ReactSwitch from 'react-switch';\n+import * as validate from 'validate.js';\n+import {TooltipTrigger} from \"../../components/popups\";\n+\n+const styles = {\n+  smallHeaderStyles: {\n+    fontSize: 14,\n+    fontWeight: 600\n+  }\n+};\n+\n+\n+interface AdminBannerState {\n+  bannerDescription: string;\n+  bannerEnabled: boolean;\n+  bannerHeadline: string;\n+  readMoreLink: string;\n+}\n+const required = {presence: {allowEmpty: false}};\n+const notTooLong = maxLength => ({", "originalCommit": "4304973a668f0ab019832763126cb9f239069907", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MjYxNzU0NQ==", "url": "https://github.com/all-of-us/workbench/pull/2957#discussion_r362617545", "bodyText": "I stole it from the Profile page, so... thank you, but I can't take too much credit.", "author": "s-rubenstein", "createdAt": "2020-01-02T20:26:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MjYwNTEwNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MjYwNzg4MQ==", "url": "https://github.com/all-of-us/workbench/pull/2957#discussion_r362607881", "bodyText": "Is the linter enforcing this formatting? I'd rather see something like\n    {\n        bannerDescription,\n        bannerHeadline,\n        readMoreLink\n    },\n    validators,\n    {\n        [...]\n    }\n)```", "author": "als364", "createdAt": "2020-01-02T19:55:52Z", "path": "ui/src/app/pages/admin/admin-banner.tsx", "diffHunk": "@@ -0,0 +1,133 @@\n+import {Component} from '@angular/core';\n+import {BoldHeader, Header} from 'app/components/headers';\n+import {TextArea, TextInput} from 'app/components/inputs';\n+import {statusAlertApi} from 'app/services/swagger-fetch-clients';\n+import colors from 'app/styles/colors';\n+import {ReactWrapperBase} from 'app/utils';\n+import * as React from 'react';\n+import ReactSwitch from 'react-switch';\n+import * as validate from 'validate.js';\n+import {TooltipTrigger} from \"../../components/popups\";\n+\n+const styles = {\n+  smallHeaderStyles: {\n+    fontSize: 14,\n+    fontWeight: 600\n+  }\n+};\n+\n+\n+interface AdminBannerState {\n+  bannerDescription: string;\n+  bannerEnabled: boolean;\n+  bannerHeadline: string;\n+  readMoreLink: string;\n+}\n+const required = {presence: {allowEmpty: false}};\n+const notTooLong = maxLength => ({\n+  length: {\n+    maximum: maxLength,\n+    tooLong: 'must be %{count} characters or less'\n+  }\n+});\n+const validators = {\n+  bannerDescription: {...required, ...notTooLong(4000)},\n+  bannerHeadline: {...required, ...notTooLong(200)},\n+  readMoreLink: {...notTooLong(200)},\n+};\n+export class AdminBanner extends React.Component<{}, AdminBannerState> {\n+  constructor(props) {\n+    super(props);\n+    this.state = {\n+      bannerDescription: '',\n+      bannerEnabled: false,\n+      bannerHeadline: '',\n+      readMoreLink: ''\n+    };\n+  }\n+\n+  componentDidMount(): void {\n+    statusAlertApi().getStatusAlert()\n+      .then(statusAlert => this.setState({\n+        bannerDescription: statusAlert.message,\n+        bannerEnabled: statusAlert.title !== null && statusAlert.title !== '',\n+        bannerHeadline: statusAlert.title,\n+        readMoreLink: statusAlert.link\n+      }));\n+  }\n+\n+  handleBannerToggle(checked: boolean) {\n+    this.setState({bannerEnabled: !this.state.bannerEnabled});\n+    if (checked) {\n+      statusAlertApi().postStatusAlert({\n+        title: this.state.bannerHeadline,\n+        message: this.state.bannerDescription,\n+        link: this.state.readMoreLink\n+      });\n+    } else {\n+      statusAlertApi().postStatusAlert({\n+        title: '',\n+        message: '',\n+        link: ''\n+      });\n+      this.setState({\n+        bannerDescription: '',\n+        bannerHeadline: '',\n+        readMoreLink: ''\n+      });\n+    }\n+  }\n+\n+  render() {\n+    const {bannerDescription, bannerEnabled, bannerHeadline, readMoreLink} = this.state;\n+    const errors = validate({", "originalCommit": "4304973a668f0ab019832763126cb9f239069907", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MjYxNzcyOQ==", "url": "https://github.com/all-of-us/workbench/pull/2957#discussion_r362617729", "bodyText": "Will change! I think this is fine either way.", "author": "s-rubenstein", "createdAt": "2020-01-02T20:26:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MjYwNzg4MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MjYxNDU5Ng==", "url": "https://github.com/all-of-us/workbench/pull/2957#discussion_r362614596", "bodyText": "What does this multiple-as-in-a-row do?", "author": "als364", "createdAt": "2020-01-02T20:16:58Z", "path": "ui/src/app/pages/signed-in/component.ts", "diffHunk": "@@ -84,21 +74,12 @@ export class SignedInComponent implements OnInit, OnDestroy, AfterViewInit {\n   ngOnInit(): void {\n     this.serverConfigService.getConfig().subscribe((config) => {\n       this.profileLoadingSub = this.profileStorageService.profile$.subscribe((profile) => {\n-        this.hasDataAccess = hasRegisteredAccess(profile.dataAccessLevel);\n-        if (this.hasDataAccess) {\n+        this.profile = profile as unknown as FetchProfile;", "originalCommit": "4304973a668f0ab019832763126cb9f239069907", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MjYxNzk0Ng==", "url": "https://github.com/all-of-us/workbench/pull/2957#discussion_r362617946", "bodyText": "This is converting from generated/angular, and generated/fetch. (Its a painful workaround to get around the typing.", "author": "s-rubenstein", "createdAt": "2020-01-02T20:27:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MjYxNDU5Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MjYxOTIzMQ==", "url": "https://github.com/all-of-us/workbench/pull/2957#discussion_r362619231", "bodyText": "yuck.", "author": "als364", "createdAt": "2020-01-02T20:31:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MjYxNDU5Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MjYxOTcyOA==", "url": "https://github.com/all-of-us/workbench/pull/2957#discussion_r362619728", "bodyText": "Yeah, I kinda hate it. Actually, let me see if the compiler is unhappy with removing it.", "author": "s-rubenstein", "createdAt": "2020-01-02T20:33:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MjYxNDU5Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MjYyMDMzMg==", "url": "https://github.com/all-of-us/workbench/pull/2957#discussion_r362620332", "bodyText": "Yeah, compiler complains without it.", "author": "s-rubenstein", "createdAt": "2020-01-02T20:35:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MjYxNDU5Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MjYxNDg3OA==", "url": "https://github.com/all-of-us/workbench/pull/2957#discussion_r362614878", "bodyText": "I know you didn't name this in this PR but this function name is confusing and I'm wondering if there's a better name for it", "author": "als364", "createdAt": "2020-01-02T20:17:58Z", "path": "ui/src/app/pages/signed-in/component.ts", "diffHunk": "@@ -84,21 +74,12 @@ export class SignedInComponent implements OnInit, OnDestroy, AfterViewInit {\n   ngOnInit(): void {\n     this.serverConfigService.getConfig().subscribe((config) => {\n       this.profileLoadingSub = this.profileStorageService.profile$.subscribe((profile) => {\n-        this.hasDataAccess = hasRegisteredAccess(profile.dataAccessLevel);\n-        if (this.hasDataAccess) {\n+        this.profile = profile as unknown as FetchProfile;\n+        if (hasRegisteredAccessFetch(this.profile.dataAccessLevel)) {", "originalCommit": "4304973a668f0ab019832763126cb9f239069907", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MjYxODIwNQ==", "url": "https://github.com/all-of-us/workbench/pull/2957#discussion_r362618205", "bodyText": "I think eventually it will be hasRegisteredAccess, its just this way until we can get rid of the angular version. (Maybe we should rename the angular one and make this hasRegisteredAccess?)", "author": "s-rubenstein", "createdAt": "2020-01-02T20:28:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MjYxNDg3OA=="}], "type": "inlineReview"}, {"oid": "cb7ed1042f3d1b36e85cf4d495bbdfe12b96e8c3", "url": "https://github.com/all-of-us/workbench/commit/cb7ed1042f3d1b36e85cf4d495bbdfe12b96e8c3", "message": "PR feedback", "committedDate": "2020-01-02T20:30:43Z", "type": "commit"}]}