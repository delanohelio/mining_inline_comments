{"pr_number": 3359, "pr_title": "[RW-3955][risk=moderate] Add preprod env configuration", "pr_createdAt": "2020-04-07T03:07:50Z", "pr_url": "https://github.com/all-of-us/workbench/pull/3359", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODE1NTYwNQ==", "url": "https://github.com/all-of-us/workbench/pull/3359#discussion_r408155605", "bodyText": "Nice catch.", "author": "s-rubenstein", "createdAt": "2020-04-14T13:55:42Z", "path": "api/libproject/devstart.rb", "diffHunk": "@@ -1090,10 +1099,11 @@ def create_auth_domain(cmd_name, args)\n   token = token.chomp\n   header = \"Authorization: Bearer #{token}\"\n   content_type = \"Content-type: application/json\"\n+  api_base_url = get_server_config(op.opts.project)[\"apiBaseUrl\"]\n \n   domain_name = get_auth_domain(op.opts.project)\n   common.run_inline %W{curl -X POST -H #{header} -H #{content_type} -d {}\n-     https://api-dot-#{op.opts.project}.appspot.com/v1/auth-domain/#{domain_name}}\n+     #{api_base_url}/v1/auth-domain/#{domain_name}}", "originalCommit": "063633bd03295939044cea0015bb604a04996e61", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODI4MjM5Ng==", "url": "https://github.com/all-of-us/workbench/pull/3359#discussion_r408282396", "bodyText": "Credit goes to @ericsong on that one", "author": "calbach", "createdAt": "2020-04-14T16:43:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODE1NTYwNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODIyMDU4NQ==", "url": "https://github.com/all-of-us/workbench/pull/3359#discussion_r408220585", "bodyText": "Just thinking out loud, but it seems odd to me that Angular should know anything about which environment it's in.", "author": "jaycarlton", "createdAt": "2020-04-14T15:17:58Z", "path": "ui/angular.json", "diffHunk": "@@ -149,6 +165,9 @@\n             \"stable\": {\n               \"browserTarget\": \"aou-workbench-ui:build:stable\"\n             },\n+            \"preprod\": {", "originalCommit": "063633bd03295939044cea0015bb604a04996e61", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODI5MjEzOQ==", "url": "https://github.com/all-of-us/workbench/pull/3359#discussion_r408292139", "bodyText": "Fundamentally, a build of the UI minimally needs to know what API host to talk to - I don't think there's anything odd about that.\nBeyond that, there are practical constants that are complied in, such as the oauth client ID and name of the environment. There are various improvements which could be made as to how these are included, but they are a \"build-time\" concern at the very least.", "author": "calbach", "createdAt": "2020-04-14T16:58:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODIyMDU4NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODIyMTM5Mw==", "url": "https://github.com/all-of-us/workbench/pull/3359#discussion_r408221393", "bodyText": "Can we not just have a .stackdriverKeys/* or something for this? I realize they're public, but it still feels funny having these checked in.", "author": "jaycarlton", "createdAt": "2020-04-14T15:19:00Z", "path": ".gitallowed", "diffHunk": "@@ -7,11 +7,13 @@\n 657299777109-kvb5qafr70bl01i6bnpgsiq5nt6v1o8u.apps.googleusercontent.com\n 56507752110-ovdus1lkreopsfhlovejvfgmsosveda6.apps.googleusercontent.com\n 684273740878-d7i68in5d9hqr6n9mfvrdh53snekp79f.apps.googleusercontent.com\n+589109405884-bmoj9ra8849rqeepuamk8jpu102iq363.apps.googleusercontent.com\n 63939010390-aj0r8hro7r8lkt7a45gissu3m73ietl2.apps.googleusercontent.com\n \n # Public API keys for Stackdriver. These also must be sent client-side.\n AIzaSyBSPcQ0FcR99GLXaqX4Ujpoj3JUDSP689g\n AIzaSyA4gOEvyJRkhIbW0x0Y7PkIowOSIK_Tous\n AIzaSyB44pugxPbfevF_fb7GichIv9D9ee5-nNk\n AIzaSyAkMIMIzUwv02RBK-A7cE1PbPpDJ2MTNtk\n+AIzaSyA5Q0xqZdyaHUIUjZFqpim26wQFO0JqIRw", "originalCommit": "063633bd03295939044cea0015bb604a04996e61", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODI4MjE3MQ==", "url": "https://github.com/all-of-us/workbench/pull/3359#discussion_r408282171", "bodyText": "I don't understand the suggestion. Please review the purpose of this specially named file: https://github.com/awslabs/git-secrets#ignoring-false-positives", "author": "calbach", "createdAt": "2020-04-14T16:43:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODIyMTM5Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDMwOTI1NQ==", "url": "https://github.com/all-of-us/workbench/pull/3359#discussion_r420309255", "bodyText": "Oh, OK. I thought they were file paths.", "author": "jaycarlton", "createdAt": "2020-05-05T18:11:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODIyMTM5Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTY4OTg1Mg==", "url": "https://github.com/all-of-us/workbench/pull/3359#discussion_r411689852", "bodyText": "@calbach I hope I'm not breaking etiquette by adding this commit.\nDo you think it would be possible for me to push this config and attempt to test out https://precisionmedicineinitiative.atlassian.net/browse/RW-4757 on preprod? It's not critical, but will be nice to confirm it's working.", "author": "gjuggler", "createdAt": "2020-04-20T21:02:13Z", "path": "api/config/config_preprod.json", "diffHunk": "@@ -97,7 +97,7 @@\n     \"enableSumoLogicEventHandling\": true,\n     \"useKeylessDelegatedCredentials\": false,\n     \"sendFreeTierAlertEmails\": true,\n-    \"enableMoodleV2Api\": false,\n+    \"enableMoodleV2Api\": true,", "originalCommit": "2ac549708133f33a1d1f6fc860f2927dd4462710", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTc3OTgyNw==", "url": "https://github.com/all-of-us/workbench/pull/3359#discussion_r411779827", "bodyText": "\ud83d\ude32\nNah, that's fine. I figured I'd need to sync this back up with reality once it's finally ready to merge, so that saved me one flag to chase down. I'll do a redeploy today, I'm overdue.\nHowever, the environment is still borked, with a hopeful fix after Terra's release tomorrow afternoon. It will be challenging to do a meaningful test until that happens, though you might be able to glean some information with bypasses, manual URL generation, and log interpretation.", "author": "calbach", "createdAt": "2020-04-21T00:21:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTY4OTg1Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTgwMTUwOQ==", "url": "https://github.com/all-of-us/workbench/pull/3359#discussion_r411801509", "bodyText": "Thanks \u2013\u00a0ah, I didn't realize you're still chasing down some Terra issues. I may just look to validate the change in prod then; overall risk feels pretty low given it's tested fine in lower envs and the access module is turned off anyway.", "author": "gjuggler", "createdAt": "2020-04-21T01:26:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTY4OTg1Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTgzMjgwMA==", "url": "https://github.com/all-of-us/workbench/pull/3359#discussion_r411832800", "bodyText": "Sounds good - I'll hold of on the redeploy then", "author": "calbach", "createdAt": "2020-04-21T03:00:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTY4OTg1Mg=="}], "type": "inlineReview"}, {"oid": "c801cc70c61fca9098d4fd5d3cdec9b3bdc8413e", "url": "https://github.com/all-of-us/workbench/commit/c801cc70c61fca9098d4fd5d3cdec9b3bdc8413e", "message": "Preprod configuration squashed", "committedDate": "2020-05-04T18:22:27Z", "type": "commit"}, {"oid": "31aef6ada47bdde084be3ac5df89b32eb1e810c7", "url": "https://github.com/all-of-us/workbench/commit/31aef6ada47bdde084be3ac5df89b32eb1e810c7", "message": "Flag updates", "committedDate": "2020-05-04T18:47:04Z", "type": "forcePushed"}, {"oid": "eaf77329425310d172d6b0069dca4c737904e147", "url": "https://github.com/all-of-us/workbench/commit/eaf77329425310d172d6b0069dca4c737904e147", "message": "Rebased flag updates", "committedDate": "2020-05-05T00:10:52Z", "type": "commit"}, {"oid": "eaf77329425310d172d6b0069dca4c737904e147", "url": "https://github.com/all-of-us/workbench/commit/eaf77329425310d172d6b0069dca4c737904e147", "message": "Rebased flag updates", "committedDate": "2020-05-05T00:10:52Z", "type": "forcePushed"}, {"oid": "01f0e23c77278d8023427cca10aed4655eccac04", "url": "https://github.com/all-of-us/workbench/commit/01f0e23c77278d8023427cca10aed4655eccac04", "message": "sync preprod UI env", "committedDate": "2020-05-05T17:39:11Z", "type": "commit"}]}