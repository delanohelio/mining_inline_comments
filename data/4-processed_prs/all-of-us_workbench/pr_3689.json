{"pr_number": 3689, "pr_title": "[RW-4383][risk=no] Puppeteer test: Export notebook in R language", "pr_createdAt": "2020-06-18T23:53:02Z", "pr_url": "https://github.com/all-of-us/workbench/pull/3689", "timeline": [{"oid": "22c6fe8cb507f2cc095dabd451592d19ee8f0679", "url": "https://github.com/all-of-us/workbench/commit/22c6fe8cb507f2cc095dabd451592d19ee8f0679", "message": "export notebook in R language", "committedDate": "2020-06-18T23:50:24Z", "type": "commit"}, {"oid": "ffc74bdabda35b5fcd661ad78ca8c2b83c3c34f2", "url": "https://github.com/all-of-us/workbench/commit/ffc74bdabda35b5fcd661ad78ca8c2b83c3c34f2", "message": "more update", "committedDate": "2020-06-19T01:29:19Z", "type": "commit"}, {"oid": "ab935dc79689daef12c89770dd04b8c1239a9e66", "url": "https://github.com/all-of-us/workbench/commit/ab935dc79689daef12c89770dd04b8c1239a9e66", "message": "revert jest.test-setup.ts change", "committedDate": "2020-06-19T01:31:55Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjU4ODY4Mg==", "url": "https://github.com/all-of-us/workbench/pull/3689#discussion_r442588682", "bodyText": "If someone needs to pause test execution and look for why errored on page,  simply uncomment await jestPuppeteer.debug(); to allow the inspection of page manually.\nLog error if errored. so I know it is related to the screenshot.\nExample:", "author": "aweng98", "createdAt": "2020-06-19T01:48:42Z", "path": "e2e/app/element/base-element.ts", "diffHunk": "@@ -29,10 +29,17 @@ export default class BaseElement extends Container {\n    * @param {WaitForSelectorOptions} waitOptions\n    */\n   async waitForXPath(waitOptions: WaitForSelectorOptions = {visible: true}): Promise<this> {\n-    if (this.element === undefined) {\n-      this.element = await this.page.waitForXPath(this.xpath, waitOptions);\n+    try {\n+      if (this.element === undefined) {\n+        this.element = await this.page.waitForXPath(this.xpath, waitOptions);\n+      }\n+      return this;\n+    } catch (err) {\n+      console.error(`waitForXpath() encountered ${err}`);\n+      // Debugging pause\n+      // await jestPuppeteer.debug();\n+      throw err;", "originalCommit": "ab935dc79689daef12c89770dd04b8c1239a9e66", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjU4OTEyNQ==", "url": "https://github.com/all-of-us/workbench/pull/3689#discussion_r442589125", "bodyText": "Inconsistency in casing. o is lowercase in of. Uppercase O in Of. \ud83d\ude14", "author": "aweng98", "createdAt": "2020-06-19T01:50:41Z", "path": "e2e/app/page/cohort-criteria-modal.ts", "diffHunk": "@@ -29,6 +29,14 @@ export enum PhysicalMeasurementsCriteria {\n   WheelChairUser = 'Wheelchair user at enrollment',\n }\n \n+export enum Ethnicity {\n+  NotHispanicOrLatino = 'Not Hispanic or Latino',\n+  HispanicOrLatino = 'Hispanic or Latino',\n+  RaceEthnicityNoneOfThese = 'Race Ethnicity None Of These',\n+  PreferNotToAnswer = 'Prefer Not To Answer',\n+  Skip = 'Skip',\n+}", "originalCommit": "ab935dc79689daef12c89770dd04b8c1239a9e66", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzA3NjQwNw==", "url": "https://github.com/all-of-us/workbench/pull/3689#discussion_r443076407", "bodyText": "nit: too many spaces", "author": "calbach", "createdAt": "2020-06-19T23:26:04Z", "path": "e2e/app/page/cohort-criteria-modal.ts", "diffHunk": "@@ -128,4 +145,11 @@ export default class CohortCriteriaModal extends Dialog {\n     return participantResult;\n   }\n \n+  async addEthnicity(ethnicities: Ethnicity[]): Promise<void> {\n+    for  (const ethnicity of  ethnicities) {", "originalCommit": "ab935dc79689daef12c89770dd04b8c1239a9e66", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzA4NTE0MQ==", "url": "https://github.com/all-of-us/workbench/pull/3689#discussion_r443085141", "bodyText": "corrected.", "author": "aweng98", "createdAt": "2020-06-20T00:37:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzA3NjQwNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzA3NjU5Nw==", "url": "https://github.com/all-of-us/workbench/pull/3689#discussion_r443076597", "bodyText": "the parens around (any) look wrong to me here; am I missing something?", "author": "calbach", "createdAt": "2020-06-19T23:27:13Z", "path": "e2e/app/page/data-page.ts", "diffHunk": "@@ -56,14 +56,17 @@ export default class DataPage extends AuthenticatedPage {\n    * Select DATA, ANALYSIS or ABOUT page tab.\n    * @param {TabLabelAlias} tabName\n    */\n-  async openTab(tabName: TabLabelAlias, opts: {waitPageChange?: boolean} = {}): Promise<void> {\n+  async openTab(tabName: TabLabelAlias, opts: {waitPageChange?: boolean} = {}): Promise<(any)> {", "originalCommit": "ab935dc79689daef12c89770dd04b8c1239a9e66", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzA4NjEwOA==", "url": "https://github.com/all-of-us/workbench/pull/3689#discussion_r443086108", "bodyText": "I didn't notice this before. I think tslint added it automatically.\nupdate function return to Promise<[void, Response] | void>.", "author": "aweng98", "createdAt": "2020-06-20T00:46:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzA3NjU5Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzA3NjY1Ng==", "url": "https://github.com/all-of-us/workbench/pull/3689#discussion_r443076656", "bodyText": "presumably this was for debugging - remove?", "author": "calbach", "createdAt": "2020-06-19T23:27:39Z", "path": "e2e/app/page/dataset-save-modal.ts", "diffHunk": "@@ -41,9 +41,10 @@ export default class DatasetSaveModal extends Dialog {\n \n     if (isExportToNotebook) {\n       // Export to notebook\n-      const notebookNameTextbox = new Textbox(this.page, '//*[@data-test-id=\"notebook-name-input\"]');\n+      const notebookNameTextbox = new Textbox(this.page, `${this.getXpath()}//*[@data-test-id=\"notebook-name-input\"]`);\n       await notebookNameTextbox.type(notebookName);\n-      const radioBtn = await RadioButton.findByName(this.page, {name: language});\n+      console.log(`Notebook language: ` + language);", "originalCommit": "ab935dc79689daef12c89770dd04b8c1239a9e66", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzA4NjMzMw==", "url": "https://github.com/all-of-us/workbench/pull/3689#discussion_r443086333", "bodyText": "Intentional. I thought good to know what lang was notebook created in.", "author": "aweng98", "createdAt": "2020-06-20T00:48:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzA3NjY1Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzA3NjgxMg==", "url": "https://github.com/all-of-us/workbench/pull/3689#discussion_r443076812", "bodyText": "Adding a bunch of these makes me a bit worried about maintenance. Is there a reason these needed to be added here? vs just waiting for the next button to become clickable/undisabled?", "author": "calbach", "createdAt": "2020-06-19T23:28:52Z", "path": "e2e/tests/datasets/dataset-create.spec.ts", "diffHunk": "@@ -102,7 +103,9 @@ describe('Create Dataset', () => {\n     const dataSetName = await saveModal.saveDataset();\n \n     // Verify create successful.\n-    await dataPage.openTab(TabLabelAlias.Datasets);\n+    await dataPage.openTab(TabLabelAlias.Datasets, {waitPageChange: false});\n+    await waitWhileLoading(page);", "originalCommit": "ab935dc79689daef12c89770dd04b8c1239a9e66", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzA4OTY0MA==", "url": "https://github.com/all-of-us/workbench/pull/3689#discussion_r443089640", "bodyText": "Admittedly, this is not 'clean code'.\nwaitWhileLoading function checks for existences of spinners spinning for up to one second. Each time a call to function is made, it adds one extra second in playback time when no spinner was found.\nthru observation, app UI performance is unreliable. A conscious decision was made to make tests more resilient to failures related to page's readiness. It is a tradeoff between having longer playback time and \"flaky\" tests.", "author": "aweng98", "createdAt": "2020-06-20T01:27:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzA3NjgxMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzA3NzIzOA==", "url": "https://github.com/all-of-us/workbench/pull/3689#discussion_r443077238", "bodyText": "analysis", "author": "calbach", "createdAt": "2020-06-19T23:31:32Z", "path": "e2e/tests/datasets/export-to-notebook.spec.ts", "diffHunk": "@@ -77,8 +79,96 @@ describe('Create Dataset', () => {\n \n     // Delete Dataset.\n     await dataPage.openTab(TabLabelAlias.Data);\n-    await dataPage.openTab(TabLabelAlias.Datasets);\n+    await waitWhileLoading(page);\n+\n+    await dataPage.openTab(TabLabelAlias.Datasets, {waitPageChange: false});\n+    await waitWhileLoading(page);\n+\n     await dataPage.deleteDataset(newDatasetName);\n+  });\n+\n+  /**\n+   * Create new Cohort thru Dataset Build page. Cohort built from demographics -> Ethnicity.\n+   * Create new Dataset with Cohort, then export to notebook in R language.\n+   * Delete Cohort, Dataset, and Notebook.\n+   */\n+  test('Export dataset to notebook in R programming language', async () => {\n+    const workspaceCard = await findWorkspace(page);\n+    const workspaceName = await workspaceCard.clickWorkspaceName();\n+\n+    // Click Add Datasets button\n+    const dataPage = new DataPage(page);\n+    const datasetBuildPage = await dataPage.clickAddDatasetButton();\n+    const cohortBuildPage = await datasetBuildPage.clickAddCohortsButton();\n+\n+    // Include Participants Group 1: Add Criteria: Ethnicity\n+    const group1 = cohortBuildPage.findIncludeParticipantsGroup('Group 1');\n+    const modal = await group1.includeEthnicity();\n+    await modal.addEthnicity([Ethnicity.HispanicOrLatino, Ethnicity.NotHispanicOrLatino]);\n+    await modal.clickFinishButton();\n+\n+    // Check Group 1 Count.\n+    const group1Count = await group1.getGroupCount();\n+    const group1CountInt = Number(group1Count.replace(/,/g, ''));\n+    expect(group1CountInt).toBeGreaterThan(1);\n+    console.log('Include Participants Group 1: ' + group1CountInt);\n+\n+    // Save new Cohort.\n+    const newCohortName = await cohortBuildPage.saveCohortAs();\n+    await waitForText(page, 'Cohort Saved Successfully');\n+    console.log(`Created Cohort \"${newCohortName}\"`);\n+\n+    const cohortActionsPage = new CohortActionsPage(page);\n+    await cohortActionsPage.clickCreateDatasetButton();\n+\n+    await datasetBuildPage.selectCohorts([newCohortName]);\n+    await datasetBuildPage.selectConceptSets(['Demographics']);\n+    await datasetBuildPage.clickSaveAndAnalyzeButton();\n+\n+    const newNotebookName = makeRandomName();\n+    const saveModal = new DatasetSaveModal(page);\n+    const newDatasetName = await saveModal.saveDataset({isExportToNotebook: true, notebookName: newNotebookName, language: Language.R});\n+    await waitWhileLoading(page);\n+\n+    // Verify Notebook preview. Not going to start the Jupyter notebook.\n+    const notebookPreviewPage = new NotebookPreviewPage(page);\n+    await notebookPreviewPage.waitForLoad();\n+    const currentPageUrl = await page.url();\n+    expect(currentPageUrl).toContain(`notebooks/preview/${newNotebookName}.ipynb`);\n+\n+    const code = await notebookPreviewPage.getFormattedCode();\n+    expect(code).toContain('library(bigrquery)');\n+\n+    // Navigate to Workpace Data page.\n+    const notebooksLink = await Link.findByName(page, {name: workspaceName});\n+    await notebooksLink.clickAndWait();\n+    await dataPage.waitForLoad();\n+\n+    // Delete test data sequence is: Delete Notebook, then Dataset, finally Cohort.\n+    // Delete Notebook\n+    await dataPage.openTab(TabLabelAlias.Analysis);\n+    await waitWhileLoading(page);\n+\n+    const analysiPage = new AnalysisPage(page);", "originalCommit": "ab935dc79689daef12c89770dd04b8c1239a9e66", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzA5MDIyNA==", "url": "https://github.com/all-of-us/workbench/pull/3689#discussion_r443090224", "bodyText": "corrected.", "author": "aweng98", "createdAt": "2020-06-20T01:35:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzA3NzIzOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzA3NzM4MA==", "url": "https://github.com/all-of-us/workbench/pull/3689#discussion_r443077380", "bodyText": "nice, this is pretty easy to read through", "author": "calbach", "createdAt": "2020-06-19T23:32:30Z", "path": "e2e/tests/datasets/export-to-notebook.spec.ts", "diffHunk": "@@ -77,8 +79,96 @@ describe('Create Dataset', () => {\n \n     // Delete Dataset.\n     await dataPage.openTab(TabLabelAlias.Data);\n-    await dataPage.openTab(TabLabelAlias.Datasets);\n+    await waitWhileLoading(page);\n+\n+    await dataPage.openTab(TabLabelAlias.Datasets, {waitPageChange: false});\n+    await waitWhileLoading(page);\n+\n     await dataPage.deleteDataset(newDatasetName);\n+  });\n+\n+  /**\n+   * Create new Cohort thru Dataset Build page. Cohort built from demographics -> Ethnicity.\n+   * Create new Dataset with Cohort, then export to notebook in R language.\n+   * Delete Cohort, Dataset, and Notebook.\n+   */\n+  test('Export dataset to notebook in R programming language', async () => {", "originalCommit": "ab935dc79689daef12c89770dd04b8c1239a9e66", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzA4OTY4OQ==", "url": "https://github.com/all-of-us/workbench/pull/3689#discussion_r443089689", "bodyText": "Thanks. I'll try do more like this in future.", "author": "aweng98", "createdAt": "2020-06-20T01:28:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzA3NzM4MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzA3NzY5NQ==", "url": "https://github.com/all-of-us/workbench/pull/3689#discussion_r443077695", "bodyText": "136 characters is really excessive... Is the linter not active here?\nIn this case I would wrap the object since it's a pretty important part of the test:\nconst newDatasetName = await saveModal.saveDataset({\n  isExportToNotebook: true,\n  notebookName: newNotebookName,\n  language: Language.R\n});", "author": "calbach", "createdAt": "2020-06-19T23:34:52Z", "path": "e2e/tests/datasets/export-to-notebook.spec.ts", "diffHunk": "@@ -77,8 +79,96 @@ describe('Create Dataset', () => {\n \n     // Delete Dataset.\n     await dataPage.openTab(TabLabelAlias.Data);\n-    await dataPage.openTab(TabLabelAlias.Datasets);\n+    await waitWhileLoading(page);\n+\n+    await dataPage.openTab(TabLabelAlias.Datasets, {waitPageChange: false});\n+    await waitWhileLoading(page);\n+\n     await dataPage.deleteDataset(newDatasetName);\n+  });\n+\n+  /**\n+   * Create new Cohort thru Dataset Build page. Cohort built from demographics -> Ethnicity.\n+   * Create new Dataset with Cohort, then export to notebook in R language.\n+   * Delete Cohort, Dataset, and Notebook.\n+   */\n+  test('Export dataset to notebook in R programming language', async () => {\n+    const workspaceCard = await findWorkspace(page);\n+    const workspaceName = await workspaceCard.clickWorkspaceName();\n+\n+    // Click Add Datasets button\n+    const dataPage = new DataPage(page);\n+    const datasetBuildPage = await dataPage.clickAddDatasetButton();\n+    const cohortBuildPage = await datasetBuildPage.clickAddCohortsButton();\n+\n+    // Include Participants Group 1: Add Criteria: Ethnicity\n+    const group1 = cohortBuildPage.findIncludeParticipantsGroup('Group 1');\n+    const modal = await group1.includeEthnicity();\n+    await modal.addEthnicity([Ethnicity.HispanicOrLatino, Ethnicity.NotHispanicOrLatino]);\n+    await modal.clickFinishButton();\n+\n+    // Check Group 1 Count.\n+    const group1Count = await group1.getGroupCount();\n+    const group1CountInt = Number(group1Count.replace(/,/g, ''));\n+    expect(group1CountInt).toBeGreaterThan(1);\n+    console.log('Include Participants Group 1: ' + group1CountInt);\n+\n+    // Save new Cohort.\n+    const newCohortName = await cohortBuildPage.saveCohortAs();\n+    await waitForText(page, 'Cohort Saved Successfully');\n+    console.log(`Created Cohort \"${newCohortName}\"`);\n+\n+    const cohortActionsPage = new CohortActionsPage(page);\n+    await cohortActionsPage.clickCreateDatasetButton();\n+\n+    await datasetBuildPage.selectCohorts([newCohortName]);\n+    await datasetBuildPage.selectConceptSets(['Demographics']);\n+    await datasetBuildPage.clickSaveAndAnalyzeButton();\n+\n+    const newNotebookName = makeRandomName();\n+    const saveModal = new DatasetSaveModal(page);\n+    const newDatasetName = await saveModal.saveDataset({isExportToNotebook: true, notebookName: newNotebookName, language: Language.R});", "originalCommit": "ab935dc79689daef12c89770dd04b8c1239a9e66", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzA5MDA3Ng==", "url": "https://github.com/all-of-us/workbench/pull/3689#discussion_r443090076", "bodyText": "140 char is the max limit.\nwrapped and renamed parameter names to be shorter.\nconst newDatasetName = await saveModal.saveDataset({\n      exportToNotebook: true,\n      notebookName: newNotebookName,\n      lang: Language.R\n });\n    await waitWhileLoading(page);", "author": "aweng98", "createdAt": "2020-06-20T01:33:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzA3NzY5NQ=="}], "type": "inlineReview"}, {"oid": "6dd66685ff9039d05fe8a390671844b09b7bcc0d", "url": "https://github.com/all-of-us/workbench/commit/6dd66685ff9039d05fe8a390671844b09b7bcc0d", "message": "PR feedback", "committedDate": "2020-06-20T01:36:38Z", "type": "commit"}]}