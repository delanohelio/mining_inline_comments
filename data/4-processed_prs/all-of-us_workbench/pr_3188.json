{"pr_number": 3188, "pr_title": "[RW-4462][risk=low] Add GCS traffic and hook up delete-cluster button to WS admin page.", "pr_createdAt": "2020-02-26T14:10:46Z", "pr_url": "https://github.com/all-of-us/workbench/pull/3188", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDU0OTI5Nw==", "url": "https://github.com/all-of-us/workbench/pull/3188#discussion_r384549297", "bodyText": "This header is going to show up even if we haven't searched a project. When I wrote this page I deliberately made sure it wouldn't. Not the biggest deal for an internal page though.", "author": "als364", "createdAt": "2020-02-26T15:02:39Z", "path": "ui/src/app/pages/admin/admin-workspace.tsx", "diffHunk": "@@ -130,23 +199,14 @@ export class AdminWorkspace extends React.Component<{}, State> {\n           Search\n         </Button>\n       </FlexRow>\n-      {\n-        workspace && <FlexColumn>\n-          <h3>Workspace Admin Actions</h3>\n-          <FlexRow style={{justifyContent: 'space-between'}}>\n-            <Button>Shut down all VMs</Button>\n-            <Button>Disable workspace</Button>\n-            <Button>Disable all collaborators</Button>\n-            <Button>Exclude from public directory</Button>\n-            <Button>Log administrative comment</Button>\n-            <Button>Publish workspace</Button>\n-          </FlexRow>\n-        </FlexColumn>\n-      }\n-      {workspace && resources.workspaceObjects && resources.cloudStorage && collaborators &&\n-        <FlexRow>\n-          <FlexColumn style={styles.wideWithMargin}>\n-            <h3>Basic Information</h3>\n+\n+      {loadingData && <SpinnerOverlay />}\n+\n+      <h2>Workspace</h2>", "originalCommit": "47fe5de63c5626e7d93071e6d516dcb73f9966f1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDg5NDYyMQ==", "url": "https://github.com/all-of-us/workbench/pull/3188#discussion_r384894621", "bodyText": "Good point \u2013\u00a0fixed.", "author": "gjuggler", "createdAt": "2020-02-27T03:24:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDU0OTI5Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDU3NTM1OA==", "url": "https://github.com/all-of-us/workbench/pull/3188#discussion_r384575358", "bodyText": "Why six hours specifically?", "author": "als364", "createdAt": "2020-02-26T15:39:52Z", "path": "api/src/main/java/org/pmiops/workbench/workspaceadmin/WorkspaceAdminController.java", "diffHunk": "@@ -26,6 +35,10 @@\n \n @RestController\n public class WorkspaceAdminController implements WorkspaceAdminApiDelegate {\n+\n+  private static final Duration TRAILING_TIME_TO_QUERY = Duration.ofHours(6);", "originalCommit": "47fe5de63c5626e7d93071e6d516dcb73f9966f1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDczMTExOQ==", "url": "https://github.com/all-of-us/workbench/pull/3188#discussion_r384731119", "bodyText": "Dunno \u2013\u00a0it felt like a reasonable historical period to catch any recent blips of activity. I'd originally had 2 days, but that meant that a short window of activity got smushed into a very narrow peak, which was often hard to see.", "author": "gjuggler", "createdAt": "2020-02-26T19:58:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDU3NTM1OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDU3NTUxMA==", "url": "https://github.com/all-of-us/workbench/pull/3188#discussion_r384575510", "bodyText": "Extraneous (unless you meant to put javadoc and forgot)", "author": "als364", "createdAt": "2020-02-26T15:40:06Z", "path": "api/src/main/java/org/pmiops/workbench/workspaceadmin/WorkspaceAdminController.java", "diffHunk": "@@ -34,18 +47,43 @@\n \n   @Autowired\n   public WorkspaceAdminController(\n+      CloudMonitoringService cloudMonitoringService,\n       FireCloudService fireCloudService,\n       LeonardoNotebooksClient leonardoNotebooksClient,\n       WorkspaceAdminService workspaceAdminService,\n       WorkspaceMapper workspaceMapper,\n       WorkspaceService workspaceService) {\n+    this.cloudMonitoringService = cloudMonitoringService;\n     this.fireCloudService = fireCloudService;\n     this.leonardoNotebooksClient = leonardoNotebooksClient;\n     this.workspaceAdminService = workspaceAdminService;\n     this.workspaceMapper = workspaceMapper;\n     this.workspaceService = workspaceService;\n   }\n \n+  /** */", "originalCommit": "47fe5de63c5626e7d93071e6d516dcb73f9966f1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDg2NzY1Ng==", "url": "https://github.com/all-of-us/workbench/pull/3188#discussion_r384867656", "bodyText": "Done", "author": "gjuggler", "createdAt": "2020-02-27T01:35:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDU3NTUxMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDU3ODcyMg==", "url": "https://github.com/all-of-us/workbench/pull/3188#discussion_r384578722", "bodyText": "At least one of these could probably done as a stream instead of an old-school foreach loop. Though I do vaguely recall nested streams being obnoxious to deal with.", "author": "als364", "createdAt": "2020-02-26T15:44:32Z", "path": "api/src/main/java/org/pmiops/workbench/workspaceadmin/WorkspaceAdminController.java", "diffHunk": "@@ -34,18 +47,43 @@\n \n   @Autowired\n   public WorkspaceAdminController(\n+      CloudMonitoringService cloudMonitoringService,\n       FireCloudService fireCloudService,\n       LeonardoNotebooksClient leonardoNotebooksClient,\n       WorkspaceAdminService workspaceAdminService,\n       WorkspaceMapper workspaceMapper,\n       WorkspaceService workspaceService) {\n+    this.cloudMonitoringService = cloudMonitoringService;\n     this.fireCloudService = fireCloudService;\n     this.leonardoNotebooksClient = leonardoNotebooksClient;\n     this.workspaceAdminService = workspaceAdminService;\n     this.workspaceMapper = workspaceMapper;\n     this.workspaceService = workspaceService;\n   }\n \n+  /** */\n+  @Override\n+  @AuthorityRequired({Authority.WORKSPACES_VIEW})\n+  public ResponseEntity<CloudStorageTraffic> getCloudStorageTraffic(String workspaceNamespace) {\n+    CloudStorageTraffic response = new CloudStorageTraffic().receivedBytes(new ArrayList<>());\n+\n+    for (TimeSeries timeSeries :", "originalCommit": "47fe5de63c5626e7d93071e6d516dcb73f9966f1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDg2ODI2NQ==", "url": "https://github.com/all-of-us/workbench/pull/3188#discussion_r384868265", "bodyText": "Yehhhh I almost did that, but the nested bit made me shy away and stick with a trusty for loop.", "author": "gjuggler", "createdAt": "2020-02-27T01:38:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDU3ODcyMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDU4MTE3OA==", "url": "https://github.com/all-of-us/workbench/pull/3188#discussion_r384581178", "bodyText": "oh god is this really how spotless wants it", "author": "als364", "createdAt": "2020-02-26T15:47:54Z", "path": "api/src/test/java/org/pmiops/workbench/workspaceadmin/WorkspaceAdminControllerTest.java", "diffHunk": "@@ -157,6 +158,31 @@ public void getFederatedWorkspaceDetails_404sWhenNotFound() {\n     assertThat(response.getStatusCodeValue()).isEqualTo(404);\n   }\n \n+  @Test\n+  public void getCloudStorageTraffic_sortsPointsByTimestamp() {\n+    TimeSeries timeSeries =", "originalCommit": "47fe5de63c5626e7d93071e6d516dcb73f9966f1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDU4MTQ0MQ==", "url": "https://github.com/all-of-us/workbench/pull/3188#discussion_r384581441", "bodyText": "If it is, could you at least put a full blank line between statements for readability", "author": "als364", "createdAt": "2020-02-26T15:48:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDU4MTE3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDg2ODM2MQ==", "url": "https://github.com/all-of-us/workbench/pull/3188#discussion_r384868361", "bodyText": "Yeah protobuf builders are apparently the worst. Done.", "author": "gjuggler", "createdAt": "2020-02-27T01:38:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDU4MTE3OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDU4NDY3Ng==", "url": "https://github.com/all-of-us/workbench/pull/3188#discussion_r384584676", "bodyText": "This should also be disabled if the person doesn't have the authority to delete clusters (SECURITY_ADMIN).", "author": "als364", "createdAt": "2020-02-26T15:52:52Z", "path": "ui/src/app/pages/admin/admin-workspace.tsx", "diffHunk": "@@ -267,17 +335,39 @@ export class AdminWorkspace extends React.Component<{}, State> {\n             <PurpleLabel style={styles.narrowWithMargin}>Status</PurpleLabel>\n           </FlexRow>\n           {resources.clusters.map((cluster, i) =>\n-              <FlexRow>\n+              <FlexRow key={i}>\n                 <div style={styles.narrowWithMargin}>{cluster.clusterName}</div>\n                 <div style={styles.narrowWithMargin}>{cluster.googleProject}</div>\n                 <div style={styles.narrowWithMargin}>{new Date(cluster.createdDate).toDateString()}</div>\n                 <div style={styles.narrowWithMargin}>{new Date(cluster.dateAccessed).toDateString()}</div>\n                 <div style={styles.narrowWithMargin}>{cluster.status}</div>\n-                <Button>Disable</Button>\n+                <Button onClick={() =>\n+                  this.setState({clusterToDelete: cluster, confirmDeleteCluster: true})}\n+                  disabled={clusterToDelete && clusterToDelete.clusterName === cluster.clusterName}>", "originalCommit": "47fe5de63c5626e7d93071e6d516dcb73f9966f1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDg5NDk0OA==", "url": "https://github.com/all-of-us/workbench/pull/3188#discussion_r384894948", "bodyText": "Yeah \u2013 I didn't want to deal with piping the Profile into this component as part of this PR, but that will be a helpful follow-up. I'll add a comment to RW-4461 which might be a reasonable place to track it.", "author": "gjuggler", "createdAt": "2020-02-27T03:25:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDU4NDY3Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDU4NjgxNA==", "url": "https://github.com/all-of-us/workbench/pull/3188#discussion_r384586814", "bodyText": "If one of these 503s, this function will short circuit and we will get an infinite spinner. Again as it's an internal page it's not that big a deal, but it could be nice to have it say 'oops it 503'd' instead of just spinning forever when you're looking at it at 3am.", "author": "als364", "createdAt": "2020-02-26T15:55:39Z", "path": "ui/src/app/pages/admin/admin-workspace.tsx", "diffHunk": "@@ -56,22 +54,24 @@ export class AdminWorkspace extends React.Component<{}, State> {\n \n     this.state = {\n       googleProject: '',\n-      workspace: null,\n-      collaborators: [],\n-      resources: {},\n+      workspaceDetails: {},\n+      cloudStorageTraffic: null,\n     };\n   }\n \n-  getFederatedWorkspaceInformation() {\n-    workspaceAdminApi().getFederatedWorkspaceDetails(this.state.googleProject).then(\n-      response => {\n-        this.setState({\n-          workspace: response.workspace,\n-          collaborators: response.collaborators,\n-          resources: response.resources\n-        });\n-      }\n-    );\n+  async getFederatedWorkspaceInformation() {\n+    this.setState({\n+      loadingData: true,\n+    });\n+\n+    // Fire off both requests in parallel\n+    const workspaceDetailsPromise = workspaceAdminApi().getFederatedWorkspaceDetails(this.state.googleProject);\n+    const cloudStorageTrafficPromise = workspaceAdminApi().getCloudStorageTraffic(this.state.googleProject);\n+    // Wait for both promises to complete before updating state.\n+    const workspaceDetails = await workspaceDetailsPromise;\n+    const cloudStorageTraffic = await cloudStorageTrafficPromise;", "originalCommit": "47fe5de63c5626e7d93071e6d516dcb73f9966f1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDg2OTQzMA==", "url": "https://github.com/all-of-us/workbench/pull/3188#discussion_r384869430", "bodyText": "Good point \u2013 added something basic here. I'm still deeply unsatisfied with our options for lightweight error display; if there were a 1-line way to show a toast notification for an error response code, I'd use that in a heartbeat. We have a long history of ignored error-handling stories \u2013\u00a0see RW-1976, RW-2877, RW-4406, and my recently filed RW-4392. I'm planning to push a bit harder on this once we're post-launch. It really feels like the kind of fundamental building block we should have.", "author": "gjuggler", "createdAt": "2020-02-27T01:42:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDU4NjgxNA=="}], "type": "inlineReview"}, {"oid": "28bbdccefaa5d32ab3aa39a8cc8e206a3e7662e1", "url": "https://github.com/all-of-us/workbench/commit/28bbdccefaa5d32ab3aa39a8cc8e206a3e7662e1", "message": "WS admin page: add GCS traffic graph and support for deleting a cluster.", "committedDate": "2020-02-27T03:30:50Z", "type": "commit"}, {"oid": "7e59c689cfcc6a6aa18cdc68bdce0a7452338a45", "url": "https://github.com/all-of-us/workbench/commit/7e59c689cfcc6a6aa18cdc68bdce0a7452338a45", "message": "Move GCS query duration into the service method.", "committedDate": "2020-02-27T03:30:50Z", "type": "commit"}, {"oid": "9c4ec30c9d7881f74ab7cb799dc10f5486e4cbbc", "url": "https://github.com/all-of-us/workbench/commit/9c4ec30c9d7881f74ab7cb799dc10f5486e4cbbc", "message": "A couple more fixes found during self-review.", "committedDate": "2020-02-27T03:30:50Z", "type": "commit"}, {"oid": "bd70bdb3f55ab0bd8d592e3ca697c68bc92af4f0", "url": "https://github.com/all-of-us/workbench/commit/bd70bdb3f55ab0bd8d592e3ca697c68bc92af4f0", "message": "More tweaks from self-review.", "committedDate": "2020-02-27T03:30:50Z", "type": "commit"}, {"oid": "9e9974bda8bb09c214fa4d1a2dc3d23e83b309ce", "url": "https://github.com/all-of-us/workbench/commit/9e9974bda8bb09c214fa4d1a2dc3d23e83b309ce", "message": "PR feedback", "committedDate": "2020-02-27T03:30:51Z", "type": "commit"}, {"oid": "0b6ad31b4508c435247da710957806385a772bc6", "url": "https://github.com/all-of-us/workbench/commit/0b6ad31b4508c435247da710957806385a772bc6", "message": "Post-rebase fixes.", "committedDate": "2020-02-27T03:50:22Z", "type": "commit"}, {"oid": "0b6ad31b4508c435247da710957806385a772bc6", "url": "https://github.com/all-of-us/workbench/commit/0b6ad31b4508c435247da710957806385a772bc6", "message": "Post-rebase fixes.", "committedDate": "2020-02-27T03:50:22Z", "type": "forcePushed"}, {"oid": "ab96aa60a63d6d805423f19f72c1b2ef86b0bbc4", "url": "https://github.com/all-of-us/workbench/commit/ab96aa60a63d6d805423f19f72c1b2ef86b0bbc4", "message": "Small build fix.", "committedDate": "2020-02-27T14:43:07Z", "type": "commit"}]}