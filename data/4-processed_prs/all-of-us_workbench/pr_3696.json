{"pr_number": 3696, "pr_title": "[RW-4696][RW-5013][risk=no] Initial workspace sharing puppeteer test", "pr_createdAt": "2020-06-21T04:33:22Z", "pr_url": "https://github.com/all-of-us/workbench/pull/3696", "timeline": [{"oid": "92e118e0da98364a5dccea293a58acf592e9d1c4", "url": "https://github.com/all-of-us/workbench/commit/92e118e0da98364a5dccea293a58acf592e9d1c4", "message": "Fixes / cleanups", "committedDate": "2020-06-22T23:33:00Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDI2NDgwNA==", "url": "https://github.com/all-of-us/workbench/pull/3696#discussion_r444264804", "bodyText": "Can you change to ShareModal extends Dialog so common methods are not duplicated?", "author": "aweng98", "createdAt": "2020-06-23T14:24:34Z", "path": "e2e/app/component/share-modal.ts", "diffHunk": "@@ -0,0 +1,107 @@\n+import Container from 'app/container';\n+import {ElementHandle, Page} from 'puppeteer';\n+import {WorkspaceAccessLevel} from 'app/page-identifiers';\n+import {ElementType} from 'app/xpath-options';\n+import Button from 'app/element/button';\n+import Textbox from 'app/element/textbox';\n+import ClrIcon from 'app/element/clr-icon-link';\n+\n+\n+export enum ButtonLabel {\n+  Cancel = 'Cancel',\n+  Save = 'Save'\n+}\n+\n+const Selector = {\n+  defaultDialog: '//*[@role=\"dialog\"]',\n+}\n+\n+export default class ShareModal extends Container {", "originalCommit": "ab20ec04daecd8bb0c23caedbb24ee0343afb604", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTkwNzkyNg==", "url": "https://github.com/all-of-us/workbench/pull/3696#discussion_r445907926", "bodyText": "Done", "author": "calbach", "createdAt": "2020-06-26T00:28:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDI2NDgwNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDI2Njg3NQ==", "url": "https://github.com/all-of-us/workbench/pull/3696#discussion_r444266875", "bodyText": "nit: Line #84 is unnecessary here because the click() takes care the finding element too.\nasync click(options?: ClickOptions): Promise<void> {\n    return (await this.asElementHandle()).click(options);\n  }", "author": "aweng98", "createdAt": "2020-06-23T14:27:15Z", "path": "e2e/app/component/share-modal.ts", "diffHunk": "@@ -0,0 +1,107 @@\n+import Container from 'app/container';\n+import {ElementHandle, Page} from 'puppeteer';\n+import {WorkspaceAccessLevel} from 'app/page-identifiers';\n+import {ElementType} from 'app/xpath-options';\n+import Button from 'app/element/button';\n+import Textbox from 'app/element/textbox';\n+import ClrIcon from 'app/element/clr-icon-link';\n+\n+\n+export enum ButtonLabel {\n+  Cancel = 'Cancel',\n+  Save = 'Save'\n+}\n+\n+const Selector = {\n+  defaultDialog: '//*[@role=\"dialog\"]',\n+}\n+\n+export default class ShareModal extends Container {\n+\n+  constructor(page: Page, xpath: string = Selector.defaultDialog) {\n+    super(page, xpath);\n+  }\n+\n+  async shareWithUser(username: string, level: WorkspaceAccessLevel): Promise<void> {\n+    const searchBox = await this.waitForSearchBox();\n+    await searchBox.type(username);\n+\n+    const addCollab = await this.waitForAddCollaboratorIcon();\n+    await addCollab.click();\n+\n+    const roleInput = await this.waitForRoleSelectorForUser(username);\n+    await roleInput.click();\n+\n+    const ownerOpt = await this.waitForRoleOption(level);\n+    await ownerOpt.click();\n+\n+    await this.clickButton(ButtonLabel.Save);\n+    await this.waitUntilDialogIsClosed();\n+  }\n+\n+  async removeUser(username: string): Promise<void> {\n+    const rmCollab = await this.page.waitForXPath(\n+      `${this.collabRowXPath(username)}//clr-icon[@shape=\"minus-circle\"]`);\n+    await rmCollab.click();\n+\n+    await this.clickButton(ButtonLabel.Save);\n+    await this.waitUntilDialogIsClosed();\n+    return;\n+  }\n+\n+  /**\n+   * Creates an xpath to a share \"row\" for a given user within the modal. This\n+   * can be combined with a child selector to pull out a control for a user.\n+   */\n+  private collabRowXPath(username: string): string {\n+    // We dip into child contents to find the collab user row element parent.\n+    // .//div filters by a relative path to the parent row.\n+    return `//*[@data-test-id=\"collab-user-row\" and .//div[` +\n+        `@data-test-id=\"collab-user-email\" and contains(text(),\"${username}\")]]`;\n+  }\n+\n+  async clickButton(buttonLabel: ButtonLabel): Promise<void> {\n+    const button = await this.waitForButton(buttonLabel);\n+    await button.waitUntilEnabled();\n+    return button.click();\n+  }\n+\n+  async waitForButton(buttonLabel: ButtonLabel): Promise<Button> {\n+    return Button.findByName(this.page, {containsText: buttonLabel, type: ElementType.Button}, this);\n+  }\n+\n+  async waitForSearchBox(): Promise<Textbox> {\n+    return Textbox.findByName(this.page, {name: 'Find Collaborators'}, this);\n+  }\n+\n+  async waitForAddCollaboratorIcon(): Promise<ClrIcon> {\n+    return ClrIcon.findByName(this.page, {iconShape: 'plus-circle'}, this);\n+  }\n+\n+  async waitForRoleSelectorForUser(username: string): Promise<Textbox> {\n+    const box = new Textbox(\n+      this.page, `${this.collabRowXPath(username)}//input[@type=\"text\"]`);\n+    await box.waitForXPath({visible: true});", "originalCommit": "ab20ec04daecd8bb0c23caedbb24ee0343afb604", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTkwNzI2OA==", "url": "https://github.com/all-of-us/workbench/pull/3696#discussion_r445907268", "bodyText": "Hmm.. is that obvious? I'm not sure I would have expected that calling click() indirectly also waits for the element to become visible.", "author": "calbach", "createdAt": "2020-06-26T00:25:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDI2Njg3NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDI3MDYzMg==", "url": "https://github.com/all-of-us/workbench/pull/3696#discussion_r444270632", "bodyText": "nit: If this class extends Dialog, you can also adds ${this.getXpath()} at the beginning of xpath to ensure element is located in dialog.", "author": "aweng98", "createdAt": "2020-06-23T14:31:52Z", "path": "e2e/app/component/share-modal.ts", "diffHunk": "@@ -0,0 +1,107 @@\n+import Container from 'app/container';\n+import {ElementHandle, Page} from 'puppeteer';\n+import {WorkspaceAccessLevel} from 'app/page-identifiers';\n+import {ElementType} from 'app/xpath-options';\n+import Button from 'app/element/button';\n+import Textbox from 'app/element/textbox';\n+import ClrIcon from 'app/element/clr-icon-link';\n+\n+\n+export enum ButtonLabel {\n+  Cancel = 'Cancel',\n+  Save = 'Save'\n+}\n+\n+const Selector = {\n+  defaultDialog: '//*[@role=\"dialog\"]',\n+}\n+\n+export default class ShareModal extends Container {\n+\n+  constructor(page: Page, xpath: string = Selector.defaultDialog) {\n+    super(page, xpath);\n+  }\n+\n+  async shareWithUser(username: string, level: WorkspaceAccessLevel): Promise<void> {\n+    const searchBox = await this.waitForSearchBox();\n+    await searchBox.type(username);\n+\n+    const addCollab = await this.waitForAddCollaboratorIcon();\n+    await addCollab.click();\n+\n+    const roleInput = await this.waitForRoleSelectorForUser(username);\n+    await roleInput.click();\n+\n+    const ownerOpt = await this.waitForRoleOption(level);\n+    await ownerOpt.click();\n+\n+    await this.clickButton(ButtonLabel.Save);\n+    await this.waitUntilDialogIsClosed();\n+  }\n+\n+  async removeUser(username: string): Promise<void> {\n+    const rmCollab = await this.page.waitForXPath(\n+      `${this.collabRowXPath(username)}//clr-icon[@shape=\"minus-circle\"]`);\n+    await rmCollab.click();\n+\n+    await this.clickButton(ButtonLabel.Save);\n+    await this.waitUntilDialogIsClosed();\n+    return;\n+  }\n+\n+  /**\n+   * Creates an xpath to a share \"row\" for a given user within the modal. This\n+   * can be combined with a child selector to pull out a control for a user.\n+   */\n+  private collabRowXPath(username: string): string {\n+    // We dip into child contents to find the collab user row element parent.\n+    // .//div filters by a relative path to the parent row.\n+    return `//*[@data-test-id=\"collab-user-row\" and .//div[` +", "originalCommit": "ab20ec04daecd8bb0c23caedbb24ee0343afb604", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTkwODEzNg==", "url": "https://github.com/all-of-us/workbench/pull/3696#discussion_r445908136", "bodyText": "Done", "author": "calbach", "createdAt": "2020-06-26T00:29:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDI3MDYzMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDI3MTgyMQ==", "url": "https://github.com/all-of-us/workbench/pull/3696#discussion_r444271821", "bodyText": "waitForXPath() needs {visible: true} option here to ensure element is visible.", "author": "aweng98", "createdAt": "2020-06-23T14:33:23Z", "path": "e2e/app/page/workspace-about-page.ts", "diffHunk": "@@ -33,4 +36,37 @@ export default class WorkspaceAboutPage extends AuthenticatedPage{\n     return waitForAttributeEquality(page, {xpath: selector}, 'aria-selected', 'true');\n   }\n \n+  async findUserInCollaboratorList(username: string): Promise<WorkspaceAccessLevel> {\n+    // At least one collab should eventually render, i.e. the current user.\n+    const collabXPath = `//*[starts-with(@data-test-id,\"workspaceUser-\")]`;\n+    await this.page.waitForXPath(collabXPath);", "originalCommit": "ab20ec04daecd8bb0c23caedbb24ee0343afb604", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTkwNzcwMA==", "url": "https://github.com/all-of-us/workbench/pull/3696#discussion_r445907700", "bodyText": "Done", "author": "calbach", "createdAt": "2020-06-26T00:27:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDI3MTgyMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDI3NjM1Mg==", "url": "https://github.com/all-of-us/workbench/pull/3696#discussion_r444276352", "bodyText": "waitWhileLoading needs await.", "author": "aweng98", "createdAt": "2020-06-23T14:38:55Z", "path": "e2e/tests/workspace/workspace-share.spec.ts", "diffHunk": "@@ -0,0 +1,50 @@\n+import Link from 'app/element/link';\n+import {findWorkspace, signIn, waitWhileLoading} from 'utils/test-utils';\n+import {WorkspaceAccessLevel} from 'app/page-identifiers';\n+import WorkspaceAboutPage from 'app/page/workspace-about-page';\n+import {config} from 'resources/workbench-config';\n+\n+describe('Share workspace', () => {\n+\n+  beforeEach(async () => {\n+    await signIn(page);\n+  });\n+\n+  // Assume there is at least one workspace preexist\n+  describe('From the workspace about page', () => {\n+    test('As OWNER, user can share a workspace', async () => {\n+      const workspaceCard = await findWorkspace(page);\n+      await workspaceCard.clickWorkspaceName();\n+\n+      const notebooksLink = await Link.findByName(page, {name: 'About'});\n+      await notebooksLink.clickAndWait();\n+\n+      const aboutPage = new WorkspaceAboutPage(page);\n+      await aboutPage.waitForLoad();\n+\n+      // This test is not hermetic - if the collaborator is already on this\n+      // workspace, just remove them before continuing.\n+      let accessLevel = await aboutPage.findUserInCollaboratorList(config.collaboratorUsername);\n+      if (accessLevel !== null) {\n+        await (await aboutPage.openShareModal()).removeUser(config.collaboratorUsername);\n+        waitWhileLoading(page);", "originalCommit": "ab20ec04daecd8bb0c23caedbb24ee0343afb604", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTkwNzg3MA==", "url": "https://github.com/all-of-us/workbench/pull/3696#discussion_r445907870", "bodyText": "oops, thanks", "author": "calbach", "createdAt": "2020-06-26T00:27:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDI3NjM1Mg=="}], "type": "inlineReview"}, {"oid": "2f8db26ca855d3dcebac174a9a3c8d1af4543c45", "url": "https://github.com/all-of-us/workbench/commit/2f8db26ca855d3dcebac174a9a3c8d1af4543c45", "message": "Initial workspace sharing puppeteer test", "committedDate": "2020-06-26T00:21:49Z", "type": "commit"}, {"oid": "1da0b388e338761350a816fe152b5cb53f7a6bbc", "url": "https://github.com/all-of-us/workbench/commit/1da0b388e338761350a816fe152b5cb53f7a6bbc", "message": "Fixes / cleanups", "committedDate": "2020-06-26T00:21:49Z", "type": "commit"}, {"oid": "7bcc8d69a35d6b12e7a5be993eab83ce7eef1212", "url": "https://github.com/all-of-us/workbench/commit/7bcc8d69a35d6b12e7a5be993eab83ce7eef1212", "message": "cmoments", "committedDate": "2020-06-26T00:21:49Z", "type": "commit"}, {"oid": "f2acecf6d7899eeb69235f5f169900d70e989852", "url": "https://github.com/all-of-us/workbench/commit/f2acecf6d7899eeb69235f5f169900d70e989852", "message": "PR fixes", "committedDate": "2020-06-26T00:29:37Z", "type": "commit"}, {"oid": "f2acecf6d7899eeb69235f5f169900d70e989852", "url": "https://github.com/all-of-us/workbench/commit/f2acecf6d7899eeb69235f5f169900d70e989852", "message": "PR fixes", "committedDate": "2020-06-26T00:29:37Z", "type": "forcePushed"}, {"oid": "4907e3c69d5ded17e5562d7a801deb3669755c4b", "url": "https://github.com/all-of-us/workbench/commit/4907e3c69d5ded17e5562d7a801deb3669755c4b", "message": "more fixes", "committedDate": "2020-06-26T00:45:04Z", "type": "commit"}, {"oid": "a5b56fbcd01a3efcd3338c5ef31bb751c56c6f65", "url": "https://github.com/all-of-us/workbench/commit/a5b56fbcd01a3efcd3338c5ef31bb751c56c6f65", "message": "react-select :/", "committedDate": "2020-06-27T01:21:47Z", "type": "commit"}, {"oid": "40b6d36972efaa7c1945f5335a5a521ec6205f0b", "url": "https://github.com/all-of-us/workbench/commit/40b6d36972efaa7c1945f5335a5a521ec6205f0b", "message": "hover not actually needd", "committedDate": "2020-06-27T01:24:33Z", "type": "commit"}]}