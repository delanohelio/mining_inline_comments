{"pr_number": 3838, "pr_title": "[RW-5229][risk=no] Restrict special characters that break concept search", "pr_createdAt": "2020-07-30T20:25:30Z", "pr_url": "https://github.com/all-of-us/workbench/pull/3838", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzI1NzYwMA==", "url": "https://github.com/all-of-us/workbench/pull/3838#discussion_r463257600", "bodyText": "Are there Unicode characters that get downgraded into these that need to be checked as well?", "author": "jaycarlton", "createdAt": "2020-07-30T20:39:14Z", "path": "ui/src/app/pages/data/concept/concept-homepage.tsx", "diffHunk": "@@ -554,7 +570,10 @@ export const ConceptHomepage = withCurrentWorkspace()(\n               <TextInput style={styles.searchBar} data-test-id='concept-search-input'\n                          placeholder='Search concepts in domain'\n                          value={currentInputString}\n-                         onChange={(e) => this.setState({currentInputString: e})}\n+                         onChange={(e) => this.setState({\n+                           currentInputString: e,\n+                           forbiddenCharactersEntered: /[~\\-@()\\[\\]|<>]/g.test(e)", "originalCommit": "f63467a8c37bdc53386876ddb2cbdab476f99643", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "443578f0489fb618513a322727055885757fc2a1", "url": "https://github.com/all-of-us/workbench/commit/443578f0489fb618513a322727055885757fc2a1", "message": "RW-5229 restrict special characters that break concept search", "committedDate": "2020-08-04T16:00:59Z", "type": "commit"}, {"oid": "941b369a57e8ce91b11ceaf3252b67c83c1d0553", "url": "https://github.com/all-of-us/workbench/commit/941b369a57e8ce91b11ceaf3252b67c83c1d0553", "message": "RW-5229 add test for restricted characters", "committedDate": "2020-08-04T16:00:59Z", "type": "commit"}, {"oid": "0fc57cdfecf7e42cfb04dc1f8ec42970af73e00c", "url": "https://github.com/all-of-us/workbench/commit/0fc57cdfecf7e42cfb04dc1f8ec42970af73e00c", "message": "RW-5229 add validate function", "committedDate": "2020-08-05T05:31:30Z", "type": "commit"}, {"oid": "0fc57cdfecf7e42cfb04dc1f8ec42970af73e00c", "url": "https://github.com/all-of-us/workbench/commit/0fc57cdfecf7e42cfb04dc1f8ec42970af73e00c", "message": "RW-5229 add validate function", "committedDate": "2020-08-05T05:31:30Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTkyMTQ1NQ==", "url": "https://github.com/all-of-us/workbench/pull/3838#discussion_r465921455", "bodyText": "I guess since you have the ability to embed \" and ( ) you have to parse each character instead of using regex. I know this is a product decision on unifying this search with CB and DSB, but we should make this reusable by other components.", "author": "freemabd", "createdAt": "2020-08-05T18:28:36Z", "path": "ui/src/app/pages/data/concept/concept-homepage.tsx", "diffHunk": "@@ -310,14 +318,69 @@ export const ConceptHomepage = withCurrentWorkspace()(\n       }\n     }\n \n+    validateInputForMySQL() {\n+      const {currentInputString} = this.state;\n+      const inputErrors = new Set(); // use Set to prevent duplicate messages\n+      let openParensCount = 0;\n+      let unclosedQuotes = false;\n+      for (let i = 0; i < currentInputString.length; i++) {\n+        const character = currentInputString[i];\n+        if (character === '\"') {\n+          unclosedQuotes = !unclosedQuotes;\n+          continue;\n+        }\n+        if (unclosedQuotes) {\n+          // inside a quote, no need to validate further\n+          continue;\n+        }\n+        // Check for characters that break search\n+        if ('~@[]|<>'.indexOf(character) > -1) {\n+          inputErrors.add('The following characters are not allowed in the search string: ~ @ [ ] | < >');\n+          continue;\n+        }\n+        // Check for trailing + or -\n+        if ('+-'.indexOf(character) > -1 && (currentInputString[i + 1] === ' ' || currentInputString[i + 1] === undefined)) {\n+          inputErrors.add(`Trailing ${character} characters are not allowed in the search string`);\n+          continue;\n+        }\n+        const parenPosition = '()'.indexOf(character);\n+        if (parenPosition === -1) {\n+          // Parens are the last character check, so we can continue if it's something else\n+          continue;\n+        }\n+        if (parenPosition === 0) {\n+          openParensCount++; // increment the number of unclosed parens\n+        } else {\n+          if (openParensCount === 0) {\n+            // too many closing parens\n+            inputErrors.add('There are too many ) characters in the search string');\n+            continue;\n+          }\n+          openParensCount--; // decrement the number of unclosed parens\n+        }\n+      }\n+      if (openParensCount > 0) {\n+        // unclosed paren\n+        inputErrors.add('There is an unclosed ( in the search string');\n+      }\n+      if (unclosedQuotes) {\n+        // unclosed quote\n+        inputErrors.add('There is an unclosed \" in the search string');\n+      }\n+      this.setState({inputErrors: Array.from(inputErrors)});\n+      return inputErrors.size === 0; // return true if no errors\n+    }\n+", "originalCommit": "0fc57cdfecf7e42cfb04dc1f8ec42970af73e00c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTk0NTU0MQ==", "url": "https://github.com/all-of-us/workbench/pull/3838#discussion_r465945541", "bodyText": "AFAIK there's no way to detect an imbalance of quotes or parens using regex. The SO solution we discussed seems to just strip out anything except letters, numbers and underscores.\nYeah, whenever we unify the tools, will definitely make this (or whatever validation we end up using) reusable.", "author": "dolbeew", "createdAt": "2020-08-05T19:13:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTkyMTQ1NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTk1MjYwMw==", "url": "https://github.com/all-of-us/workbench/pull/3838#discussion_r465952603", "bodyText": "I think we just need to write up what all apps currently do and then present it to the PMs and see if we can get consensus", "author": "jscherdin", "createdAt": "2020-08-05T19:26:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTkyMTQ1NQ=="}], "type": "inlineReview"}]}