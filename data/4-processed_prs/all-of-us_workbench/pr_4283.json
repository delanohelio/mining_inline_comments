{"pr_number": 4283, "pr_title": "[risk=low][RW-5564] Default to latest CDR on Workspace dupe and show upgrade message", "pr_createdAt": "2020-11-12T18:21:55Z", "pr_url": "https://github.com/all-of-us/workbench/pull/4283", "timeline": [{"oid": "fbbd7ed5aa2f4a6b0ac215aa654805dfd94e7933", "url": "https://github.com/all-of-us/workbench/commit/fbbd7ed5aa2f4a6b0ac215aa654805dfd94e7933", "message": "copy props and always preselect the default CDR Version", "committedDate": "2020-11-12T17:18:45Z", "type": "commit"}, {"oid": "d1c547a34a94262a5c4bdc1227a51a2b53a766d3", "url": "https://github.com/all-of-us/workbench/commit/d1c547a34a94262a5c4bdc1227a51a2b53a766d3", "message": "app/utils/cdr-versions", "committedDate": "2020-11-12T17:46:49Z", "type": "commit"}, {"oid": "1585bd96b6ff10b8a05e88802688f80e7776f801", "url": "https://github.com/all-of-us/workbench/commit/1585bd96b6ff10b8a05e88802688f80e7776f801", "message": "New CdrVersionUpgrade component", "committedDate": "2020-11-12T17:46:54Z", "type": "commit"}, {"oid": "61b2a737b4a74b68af28a8f712322f439e508eec", "url": "https://github.com/all-of-us/workbench/commit/61b2a737b4a74b68af28a8f712322f439e508eec", "message": "lint", "committedDate": "2020-11-12T18:07:27Z", "type": "commit"}, {"oid": "5872b5e7a0f4c4cfd7ce1290dfecb10069a93e56", "url": "https://github.com/all-of-us/workbench/commit/5872b5e7a0f4c4cfd7ce1290dfecb10069a93e56", "message": "rm extraneous warning components - TBD!", "committedDate": "2020-11-12T18:10:48Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjMyOTI0Mg==", "url": "https://github.com/all-of-us/workbench/pull/4283#discussion_r522329242", "bodyText": "the next PR will also look for a new \"are you sure?\" popup here", "author": "jmthibault79", "createdAt": "2020-11-12T18:36:53Z", "path": "e2e/tests/workspace/workspace-duplicate.spec.ts", "diffHunk": "@@ -76,4 +77,85 @@ describe('Duplicate workspace', () => {\n       await dataPage.deleteWorkspace();\n     });\n \n+  test('OWNER can duplicate workspace to an older CDR Version via Workspace card', async () => {\n+    const workspaceCard: WorkspaceCard = await createWorkspace(page, config.defaultCdrVersionName);\n+    const originalWorkspaceName = await workspaceCard.getWorkspaceName();\n+\n+    await workspaceCard.asElementHandle().hover();\n+    // Click on Ellipsis menu \"Duplicate\" option.\n+    await workspaceCard.selectSnowmanMenu(Option.Duplicate);\n+\n+    // Fill out Workspace Name should be just enough for successful duplication\n+    const workspacesPage = new WorkspacesPage(page);\n+    await (await workspacesPage.getWorkspaceNameTextbox()).clear();\n+    const duplicateWorkspaceName = await workspacesPage.fillOutWorkspaceName();\n+\n+    // change CDR Version\n+    await workspacesPage.selectCdrVersion(config.altCdrVersionName);", "originalCommit": "5872b5e7a0f4c4cfd7ce1290dfecb10069a93e56", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "3841d3cd74f5de394885597f20364c4cb2279ca0", "url": "https://github.com/all-of-us/workbench/commit/3841d3cd74f5de394885597f20364c4cb2279ca0", "message": "spacing", "committedDate": "2020-11-12T18:40:02Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjMzMTgxMQ==", "url": "https://github.com/all-of-us/workbench/pull/4283#discussion_r522331811", "bodyText": "Also fixes a bug: Duplication screen showed \"Duplicate of Duplicate of My Workspace\"", "author": "jmthibault79", "createdAt": "2020-11-12T18:40:56Z", "path": "ui/src/app/pages/workspace/workspace-edit.tsx", "diffHunk": "@@ -315,7 +346,8 @@ export const WorkspaceEdit = fp.flow(withRouteConfigData(), withCurrentWorkspace\n      * \"reviewRequested\" flag, which depend on the workspace state & edit mode.\n      */\n     createInitialWorkspaceState(): Workspace {\n-      let workspace: Workspace = this.props.workspace;\n+      // copy the props into a new object so our modifications here don't affect them\n+      let workspace: Workspace = {...this.props.workspace};", "originalCommit": "5872b5e7a0f4c4cfd7ce1290dfecb10069a93e56", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjMzMjcyNQ==", "url": "https://github.com/all-of-us/workbench/pull/4283#discussion_r522332725", "bodyText": "unrelated", "author": "jmthibault79", "createdAt": "2020-11-12T18:42:32Z", "path": "ui/src/app/utils/authorities.spec.tsx", "diffHunk": "@@ -10,7 +10,7 @@ const accessAuth = {...ProfileStubVariables.PROFILE_STUB, authorities: [Authorit\n const devAuth = {...ProfileStubVariables.PROFILE_STUB, authorities: [Authority.DEVELOPER]}\n const featuredWsAuth = {...ProfileStubVariables.PROFILE_STUB, authorities: [Authority.FEATUREDWORKSPACEADMIN]}\n \n-describe('auth', () => {\n+describe('authorities', () => {", "originalCommit": "5872b5e7a0f4c4cfd7ce1290dfecb10069a93e56", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "59161b85e8ee49b22c94ddf62933c5fc6e3501fa", "url": "https://github.com/all-of-us/workbench/commit/59161b85e8ee49b22c94ddf62933c5fc6e3501fa", "message": "lint", "committedDate": "2020-11-12T18:45:45Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzIxMDg1Nw==", "url": "https://github.com/all-of-us/workbench/pull/4283#discussion_r523210857", "bodyText": "nit: are the extra parens needed?", "author": "petesantos", "createdAt": "2020-11-13T20:38:27Z", "path": "ui/src/app/pages/workspace/workspace-edit.tsx", "diffHunk": "@@ -366,13 +398,9 @@ export const WorkspaceEdit = fp.flow(withRouteConfigData(), withCurrentWorkspace\n         workspace.researchPurpose.reviewRequested = false;\n       }\n \n-      const selectedCdrIsLive = this.getLiveCdrVersions().some(\n-        cdr => cdr.cdrVersionId === workspace.cdrVersionId);\n       // We preselect the default CDR version when a new workspace is being\n-      // created (via create or duplicate), but leave as-is if the selected CDR\n-      // version is live.\n-      if (this.isMode(WorkspaceEditMode.Create) ||\n-        (this.isMode(WorkspaceEditMode.Duplicate) && !selectedCdrIsLive)) {\n+      // created (via create or duplicate)\n+      if (this.isMode(WorkspaceEditMode.Create) || (this.isMode(WorkspaceEditMode.Duplicate))) {", "originalCommit": "59161b85e8ee49b22c94ddf62933c5fc6e3501fa", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzIzNDA4MA==", "url": "https://github.com/all-of-us/workbench/pull/4283#discussion_r523234080", "bodyText": "nit: is the full text needed for the test? Would the originalWorkspaceName be enough?", "author": "petesantos", "createdAt": "2020-11-13T21:10:32Z", "path": "e2e/tests/workspace/workspace-duplicate.spec.ts", "diffHunk": "@@ -76,4 +77,85 @@ describe('Duplicate workspace', () => {\n       await dataPage.deleteWorkspace();\n     });\n \n+  test('OWNER can duplicate workspace to an older CDR Version via Workspace card', async () => {\n+    const workspaceCard: WorkspaceCard = await createWorkspace(page, config.defaultCdrVersionName);\n+    const originalWorkspaceName = await workspaceCard.getWorkspaceName();\n+\n+    await workspaceCard.asElementHandle().hover();\n+    // Click on Ellipsis menu \"Duplicate\" option.\n+    await workspaceCard.selectSnowmanMenu(Option.Duplicate);\n+\n+    // Fill out Workspace Name should be just enough for successful duplication\n+    const workspacesPage = new WorkspacesPage(page);\n+    await (await workspacesPage.getWorkspaceNameTextbox()).clear();\n+    const duplicateWorkspaceName = await workspacesPage.fillOutWorkspaceName();\n+\n+    // change CDR Version\n+    await workspacesPage.selectCdrVersion(config.altCdrVersionName);\n+\n+    const finishButton = await workspacesPage.getDuplicateWorkspaceButton();\n+    await finishButton.waitUntilEnabled();\n+    await workspacesPage.clickCreateFinishButton(finishButton);\n+\n+    // Duplicate workspace Data page is loaded.\n+    const dataPage = new WorkspaceDataPage(page);\n+    await dataPage.waitForLoad();\n+    expect(page.url()).toContain(duplicateWorkspaceName.replace(/-/g, '')); // Remove dash from workspace name\n+\n+    // Delete duplicate workspace via Workspace card in Your Workspaces page.\n+    await Navigation.navMenu(page, NavLink.YOUR_WORKSPACES);\n+    await workspacesPage.waitForLoad();\n+\n+    await WorkspaceCard.deleteWorkspace(page, duplicateWorkspaceName);\n+\n+    // Verify Delete action was successful.\n+    expect(await WorkspaceCard.findCard(page, duplicateWorkspaceName)).toBeFalsy();\n+\n+    // Delete original workspace via Workspace card\n+    await WorkspaceCard.deleteWorkspace(page, originalWorkspaceName);\n+    expect(await WorkspaceCard.findCard(page, originalWorkspaceName)).toBeFalsy();\n+  });\n+\n+  test('OWNER can duplicate workspace to a newer CDR Version via Workspace card', async () => {\n+    const workspaceCard: WorkspaceCard = await createWorkspace(page, config.altCdrVersionName);\n+    const originalWorkspaceName = await workspaceCard.getWorkspaceName();\n+\n+    await workspaceCard.asElementHandle().hover();\n+    // Click on Ellipsis menu \"Duplicate\" option.\n+    await workspaceCard.selectSnowmanMenu(Option.Duplicate);\n+\n+    // Fill out Workspace Name should be just enough for successful duplication\n+    const workspacesPage = new WorkspacesPage(page);\n+    await (await workspacesPage.getWorkspaceNameTextbox()).clear();\n+    const duplicateWorkspaceName = await workspacesPage.fillOutWorkspaceName();\n+\n+    // change CDR Version\n+    await workspacesPage.selectCdrVersion(config.defaultCdrVersionName);\n+\n+    const upgradeMessage = await workspacesPage.getCdrVersionUpgradeMessage();\n+    expect(upgradeMessage).toContain(`You're duplicating the workspace \"${originalWorkspaceName}\" to upgrade from`);", "originalCommit": "59161b85e8ee49b22c94ddf62933c5fc6e3501fa", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzIzNzk4OA==", "url": "https://github.com/all-of-us/workbench/pull/4283#discussion_r523237988", "bodyText": "nit: Same comment as above. The only reason I call it out is to prevent needing to change the test for minor language changes.", "author": "petesantos", "createdAt": "2020-11-13T21:19:47Z", "path": "ui/src/app/pages/workspace/workspace-edit.spec.tsx", "diffHunk": "@@ -216,6 +215,43 @@ describe('WorkspaceEdit', () => {\n     expect(navigate).toHaveBeenCalledTimes(1);\n   });\n \n+  it('defaults to upgrading the CDR Version when duplicating a workspace with an older CDR Version', async() => {\n+    // init the workspace to a non-default CDR version value\n+    const altCdrWorkspace = {...workspace, cdrVersionId: CdrVersionsStubVariables.ALT_WORKSPACE_CDR_VERSION_ID}\n+    currentWorkspaceStore.next(altCdrWorkspace);\n+\n+    // duplication will involve a CDR version upgrade by default\n+    routeConfigDataStore.next({mode: WorkspaceEditMode.Duplicate});\n+\n+    const wrapper = component();\n+    await waitOneTickAndUpdate(wrapper);\n+\n+    const cdrSelection = wrapper.find('[data-test-id=\"select-cdr-version\"]').find('select').props().value;\n+\n+    // default CDR version, not the existing workspace's alt CDR version\n+    expect(cdrSelection).toBe(CdrVersionsStubVariables.DEFAULT_WORKSPACE_CDR_VERSION_ID);\n+\n+    const expectedUpgradeMessage1 = `You're duplicating the workspace \"${altCdrWorkspace.name}\" to upgrade from`;", "originalCommit": "59161b85e8ee49b22c94ddf62933c5fc6e3501fa", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "e5dc108ddd596da6c3ad9dee7da875f84a3eb847", "url": "https://github.com/all-of-us/workbench/commit/e5dc108ddd596da6c3ad9dee7da875f84a3eb847", "message": "don't need these parens", "committedDate": "2020-11-13T21:34:33Z", "type": "commit"}, {"oid": "9f3db945efd45ebeb030672f9377b858569931ff", "url": "https://github.com/all-of-us/workbench/commit/9f3db945efd45ebeb030672f9377b858569931ff", "message": "small test updates", "committedDate": "2020-11-13T21:36:22Z", "type": "commit"}]}