{"pr_number": 4223, "pr_title": "[RW-5797][RW-5798][RW-5800][risk=no] Bug fixes for presets and dataproc", "pr_createdAt": "2020-10-29T06:03:35Z", "pr_url": "https://github.com/all-of-us/workbench/pull/4223", "timeline": [{"oid": "18a76eaa441cafbac91ded6598eaba977da12b07", "url": "https://github.com/all-of-us/workbench/commit/18a76eaa441cafbac91ded6598eaba977da12b07", "message": "Initial preset and dataproc fixes", "committedDate": "2020-10-29T00:55:00Z", "type": "commit"}, {"oid": "4d7ca59b7056cb18b15be8b3e1c98b62db754510", "url": "https://github.com/all-of-us/workbench/commit/4d7ca59b7056cb18b15be8b3e1c98b62db754510", "message": "Initial tests", "committedDate": "2020-10-29T05:52:05Z", "type": "commit"}, {"oid": "96bf867563998b7dbc8807b0301de8a63e7a1a2d", "url": "https://github.com/all-of-us/workbench/commit/96bf867563998b7dbc8807b0301de8a63e7a1a2d", "message": "lint", "committedDate": "2020-10-29T05:54:40Z", "type": "commit"}, {"oid": "729a1ee029e011815e61106ef4feb8aed1c66bcc", "url": "https://github.com/all-of-us/workbench/commit/729a1ee029e011815e61106ef4feb8aed1c66bcc", "message": "cleanup", "committedDate": "2020-10-29T06:02:44Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDM2MTEyNg==", "url": "https://github.com/all-of-us/workbench/pull/4223#discussion_r514361126", "bodyText": "nit: remove 'from'", "author": "als364", "createdAt": "2020-10-29T15:42:08Z", "path": "ui/src/app/pages/analysis/runtime-panel.tsx", "diffHunk": "@@ -141,10 +152,18 @@ const DataProcConfigSelector = ({onChange, dataprocConfig})  => {\n   } = dataprocConfig || {};\n   const initialMachine = findMachineByName(workerMachineType);\n   const [selectedNumWorkers, setSelectedNumWorkers] = useState<number>(numberOfWorkers);\n-  const [selectedPreemtible, setUpdatedPreemptible] = useState<number>(numberOfPreemptibleWorkers);\n+  const [selectedPreemtible, setSelectedPreemptible] = useState<number>(numberOfPreemptibleWorkers);\n   const [selectedWorkerMachine, setSelectedWorkerMachine] = useState<Machine>(initialMachine);\n   const [selectedDiskSize, setSelectedDiskSize] = useState<number>(workerDiskSize);\n \n+  // If the dataprocConfig prop changes from externally, reset the selectors accordingly.", "originalCommit": "729a1ee029e011815e61106ef4feb8aed1c66bcc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "575f07c61ff12b3f2c7adb86778248c8327d0a18", "url": "https://github.com/all-of-us/workbench/commit/575f07c61ff12b3f2c7adb86778248c8327d0a18", "message": "tests", "committedDate": "2020-10-30T00:29:30Z", "type": "commit"}, {"oid": "4f8d0351c8cee8ba4f3b7df213f4cdfa5e0c249d", "url": "https://github.com/all-of-us/workbench/commit/4f8d0351c8cee8ba4f3b7df213f4cdfa5e0c249d", "message": "comment fix", "committedDate": "2020-10-30T00:31:09Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDY0MjQxMw==", "url": "https://github.com/all-of-us/workbench/pull/4223#discussion_r514642413", "bodyText": "Pulled out these helpers to reduce test boilerplate.", "author": "calbach", "createdAt": "2020-10-30T00:32:09Z", "path": "ui/src/app/pages/analysis/runtime-panel.spec.tsx", "diffHunk": "@@ -51,6 +55,48 @@ describe('RuntimePanel', () => {\n     };\n   });\n \n+  const pickDropdownOption = async(wrapper, id, label) => {\n+    act(() => { wrapper.find(id).first().simulate('click') });\n+    const item = wrapper.find(`${id} .p-dropdown-item`).find({'aria-label': label}).first()\n+    expect(item.exists()).toBeTruthy();\n+\n+    act(() => { item.simulate('click') });\n+\n+    // In some cases, picking an option may require some waiting, e.g. for\n+    // rerendering of RAM options based on CPU selection.\n+    await waitOneTickAndUpdate(wrapper);\n+  };\n+\n+  const enterNumberInput = (wrapper, id, value) => {\n+    // TODO: Find a way to invoke this without props.\n+    act(() => { wrapper.find(id).first().prop('onChange')({value} as any)});\n+  };\n+\n+  const pickMainCpu = (wrapper, cpu) => pickDropdownOption(wrapper, '#runtime-cpu', cpu);", "originalCommit": "4f8d0351c8cee8ba4f3b7df213f4cdfa5e0c249d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDY0MjY0OQ==", "url": "https://github.com/all-of-us/workbench/pull/4223#discussion_r514642649", "bodyText": "unit tests caught a bug of mine here", "author": "calbach", "createdAt": "2020-10-30T00:33:15Z", "path": "ui/src/app/pages/analysis/runtime-panel.tsx", "diffHunk": "@@ -141,10 +152,18 @@ const DataProcConfigSelector = ({onChange, dataprocConfig})  => {\n   } = dataprocConfig || {};\n   const initialMachine = findMachineByName(workerMachineType);\n   const [selectedNumWorkers, setSelectedNumWorkers] = useState<number>(numberOfWorkers);\n-  const [selectedPreemtible, setUpdatedPreemptible] = useState<number>(numberOfPreemptibleWorkers);\n+  const [selectedPreemtible, setSelectedPreemptible] = useState<number>(numberOfPreemptibleWorkers);\n   const [selectedWorkerMachine, setSelectedWorkerMachine] = useState<Machine>(initialMachine);\n   const [selectedDiskSize, setSelectedDiskSize] = useState<number>(workerDiskSize);\n \n+  // If the dataprocConfig prop changes externally, reset the selectors accordingly.\n+  useEffect(() => {\n+    setSelectedNumWorkers(numberOfWorkers);", "originalCommit": "4f8d0351c8cee8ba4f3b7df213f4cdfa5e0c249d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDY0MjczMw==", "url": "https://github.com/all-of-us/workbench/pull/4223#discussion_r514642733", "bodyText": "More shadowing issues made this uglier", "author": "calbach", "createdAt": "2020-10-30T00:33:39Z", "path": "ui/src/app/pages/analysis/runtime-panel.tsx", "diffHunk": "@@ -232,30 +250,35 @@ export const RuntimePanel = fp.flow(withCurrentWorkspace(), withCdrVersions())((\n                       <React.Fragment>\n                         {\n                           fp.flow(\n-                            fp.filter(['displayName', 'General Analysis']),\n+                            fp.filter(({runtimeTemplate}) => hasMicroarrayData || !runtimeTemplate.dataprocConfig),\n                             fp.toPairs,\n                             fp.map(([i, preset]) => {\n                               return <MenuItem\n                               style={styles.presetMenuItem}\n                               key={i}\n+                              aria-label={preset.displayName}\n                               onClick={() => {\n                                 // renaming to avoid shadowing\n                                 const {runtimeTemplate} = preset;\n-                                const {presetDiskSize, presetMachineName} = fp.cond([\n-                                  [() => !!runtimeTemplate.gceConfig, ({gceConfig: {bootDiskSize, machineType}}) => ({\n-                                    presetDiskSize: bootDiskSize,\n-                                    presetMachineName: machineType\n+                                const {presetDiskSize, presetMachineName, presetCompute} = fp.cond([\n+                                  // Can't destructure due to shadowing.\n+                                  [() => !!runtimeTemplate.gceConfig, (tmpl: Runtime) => ({", "originalCommit": "4f8d0351c8cee8ba4f3b7df213f4cdfa5e0c249d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDY0Mjk3NQ==", "url": "https://github.com/all-of-us/workbench/pull/4223#discussion_r514642975", "bodyText": "Added this test override to allow coverage of popup UI elements.", "author": "calbach", "createdAt": "2020-10-30T00:34:32Z", "path": "ui/src/app/components/popups.tsx", "diffHunk": "@@ -29,6 +29,22 @@ const styles = {\n   }\n };\n \n+// Enable stubbing out dimensions for testing purposes. Enzyme does not have", "originalCommit": "4f8d0351c8cee8ba4f3b7df213f4cdfa5e0c249d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}