{"pr_number": 4080, "pr_title": "[RW-5662][risk=no] Puppeteer Fix flaky Cohort UI test", "pr_createdAt": "2020-09-28T22:59:40Z", "pr_url": "https://github.com/all-of-us/workbench/pull/4080", "timeline": [{"oid": "7ca55c459d91e5c64958f292d74a4096165c6cab", "url": "https://github.com/all-of-us/workbench/commit/7ca55c459d91e5c64958f292d74a4096165c6cab", "message": "update select menu xpath selector", "committedDate": "2020-09-28T22:51:18Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjI4MjAxMQ==", "url": "https://github.com/all-of-us/workbench/pull/4080#discussion_r496282011", "bodyText": "tslint fix", "author": "aweng98", "createdAt": "2020-09-28T23:02:14Z", "path": "e2e/tests/notebook/notebook-download.spec.ts", "diffHunk": "@@ -14,8 +14,8 @@ describe('Jupyter notebook download test', () => {\n   const testDownloadModal = async (modal: NotebookDownloadModal): Promise<void> => {\n     const checkDownloadDisabledState = async (wantDisabled: boolean) => {\n       expect(await waitForFn(async () => {\n-        let downloadBtn = await modal.getDownloadButton();\n-        return wantDisabled == await getPropValue<boolean>(downloadBtn, 'disabled');\n+        const downloadBtn = await modal.getDownloadButton();\n+        return wantDisabled === await getPropValue<boolean>(downloadBtn, 'disabled');", "originalCommit": "7ca55c459d91e5c64958f292d74a4096165c6cab", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjI4MzI3MQ==", "url": "https://github.com/all-of-us/workbench/pull/4080#discussion_r496283271", "bodyText": "The other change is fine, but the == was intentional, I'd like to treat nulls as false. If you want to switch this to ===, please also make it !!(await getPropValue<boolean>(downloadBtn, 'disabled')); Unless you're 100% confident that your helper method properly handles this case.\nAlso, if there's lint guidance you're following - is it not also part of our presubmit?", "author": "calbach", "createdAt": "2020-09-28T23:06:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjI4MjAxMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjMwMjI4MQ==", "url": "https://github.com/all-of-us/workbench/pull/4080#discussion_r496302281", "bodyText": "no presubmit check task at this time. I manually run yarn lint:fix.", "author": "aweng98", "createdAt": "2020-09-29T00:09:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjI4MjAxMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjI4NTA4Mw==", "url": "https://github.com/all-of-us/workbench/pull/4080#discussion_r496285083", "bodyText": "The help-sidebar is not exclusively used for cohorts and #selection-list is specific to cohorts, so this is not a reasonable default. It may cover all current use cases, but if so it's because cohorts are the only test coverage we have involving the help sidebar.\nI would add another helper like selectionXpath or cohortSelectionXpathand use that from individual methods instead. In general, it would also be nice if the identifiers were named more specifically, but this is an issue with the element IDs as well.", "author": "calbach", "createdAt": "2020-09-28T23:12:19Z", "path": "e2e/app/component/help-sidebar.ts", "diffHunk": "@@ -10,7 +10,7 @@ import {ElementType} from 'app/xpath-options';\n import {waitWhileLoading} from 'utils/test-utils';\n import {waitForNumericalString} from 'utils/waits-utils';\n \n-const defaultXpath = '//*[@id=\"help-sidebar\"]';\n+const defaultXpath = '//*[@id=\"help-sidebar\"]//*[@id=\"selection-list\"]';", "originalCommit": "7ca55c459d91e5c64958f292d74a4096165c6cab", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "df35aa243be5597a6cac5097fe249b83a63b4fd4", "url": "https://github.com/all-of-us/workbench/commit/df35aa243be5597a6cac5097fe249b83a63b4fd4", "message": "PR feedback", "committedDate": "2020-09-28T23:53:24Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjI5ODc5NA==", "url": "https://github.com/all-of-us/workbench/pull/4080#discussion_r496298794", "bodyText": "This is not what I meant; this is still problematic because when we inevitably add methods to the HelpSidebar component which do non-cohorts things (like opening the data dictionary), they will just fail with this Xpath. Likewise, in other contexts the cohorts methods will not work.", "author": "calbach", "createdAt": "2020-09-28T23:58:00Z", "path": "e2e/app/page/cohort-search-page.ts", "diffHunk": "@@ -132,7 +132,7 @@ export default class CohortSearchPage extends AuthenticatedPage {\n     await finishAndReviewButton.click();\n \n     // Click Save Criteria button in sidebar\n-    const helpSidebar = new HelpSidebar(this.page);\n+    const helpSidebar = new HelpSidebar(this.page, '//*[@id=\"help-sidebar\"]//*[@id=\"selection-list\"]');", "originalCommit": "df35aa243be5597a6cac5097fe249b83a63b4fd4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjMwMDA4MQ==", "url": "https://github.com/all-of-us/workbench/pull/4080#discussion_r496300081", "bodyText": "It would be more involved and more refactoring. await SelectMenu.findByName(this.page, {ancestorLevel: 0}, this); or buildXPath function take a Container object for Parent instead of xpath string.", "author": "aweng98", "createdAt": "2020-09-29T00:02:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjI5ODc5NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjMyMjI0Nw==", "url": "https://github.com/all-of-us/workbench/pull/4080#discussion_r496322247", "bodyText": "Hmm I see. btw, should xPathOptions support specifying a specific xpath as an option? I was looking for this on my last PR, but it seems it would have been useful here as well.\nPlease leave a TODO here or on help-sidebar and then perhaps @dolbeew has other ideas about how to clean this up. If left as-is, someone is going to try to reuse this component later and get an unfortunate surprise.", "author": "calbach", "createdAt": "2020-09-29T01:26:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjI5ODc5NA=="}], "type": "inlineReview"}, {"oid": "d459afdf1ce30bccd2ce6da2b8bb58a8bd417326", "url": "https://github.com/all-of-us/workbench/commit/d459afdf1ce30bccd2ce6da2b8bb58a8bd417326", "message": "change buildXpath function", "committedDate": "2020-09-29T14:14:20Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njc1NzUxNg==", "url": "https://github.com/all-of-us/workbench/pull/4080#discussion_r496757516", "bodyText": "How about this approach? Excluding elements that have class name p-disabled.", "author": "aweng98", "createdAt": "2020-09-29T14:20:15Z", "path": "e2e/app/xpath-builders.ts", "diffHunk": "@@ -62,7 +62,7 @@ export function buildXPath(xOpts: XPathOptions, container?: Container): string {\n     selector = `${textExpr}//${type}`;\n     break;\n   case ElementType.Dropdown:\n-    selector = `${textExpr}${nodeLevel}//*[contains(concat(\" \", normalize-space(@class), \" \"), \" p-dropdown \")]`;\n+    selector = `${textExpr}${nodeLevel}//*[${classNameContains('p-dropdown')} and not(${classNameContains('p-disabled')})]`;", "originalCommit": "d459afdf1ce30bccd2ce6da2b8bb58a8bd417326", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjkyMDU4Mw==", "url": "https://github.com/all-of-us/workbench/pull/4080#discussion_r496920583", "bodyText": "Thanks for the additional attempt, but I think this is probably slightly worse than the previous approach: p-disabled doesn't relate to the content, and it will likely be removed from these child components in the near future.\nOne potential fix here is to refactor the help sidebar s.t. we avoid rendering other tabs instead of just hiding them. This would make the implementation better as well. @dolbeew can you think of any issues this might cause?", "author": "calbach", "createdAt": "2020-09-29T17:37:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njc1NzUxNg=="}], "type": "inlineReview"}]}