{"pr_number": 3948, "pr_title": "[risk=no][RW-4896] New User Profile e2e tests", "pr_createdAt": "2020-09-01T15:52:35Z", "pr_url": "https://github.com/all-of-us/workbench/pull/3948", "timeline": [{"oid": "60073c4cb5313f433c83e0fb03625838a1bb2230", "url": "https://github.com/all-of-us/workbench/commit/60073c4cb5313f433c83e0fb03625838a1bb2230", "message": "Improve User Profile test coverage", "committedDate": "2020-09-01T14:51:28Z", "type": "commit"}, {"oid": "24f5c9cec48d93f1b52ba4d883696b2ccf09abe1", "url": "https://github.com/all-of-us/workbench/commit/24f5c9cec48d93f1b52ba4d883696b2ccf09abe1", "message": "Use dataTestId wherever possible", "committedDate": "2020-09-01T14:51:28Z", "type": "commit"}, {"oid": "66a17c311323d9dc957b8165d00f5c0d965d9a0e", "url": "https://github.com/all-of-us/workbench/commit/66a17c311323d9dc957b8165d00f5c0d965d9a0e", "message": "add a missing required field test", "committedDate": "2020-09-01T15:51:17Z", "type": "commit"}, {"oid": "e42755050e7d5ec3c4ada17d94693a0ef6a2fddc", "url": "https://github.com/all-of-us/workbench/commit/e42755050e7d5ec3c4ada17d94693a0ef6a2fddc", "message": "Element", "committedDate": "2020-09-01T15:53:23Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTMxMzcwMA==", "url": "https://github.com/all-of-us/workbench/pull/3948#discussion_r481313700", "bodyText": "refinding all elements are not necessary.", "author": "aweng98", "createdAt": "2020-09-01T17:29:38Z", "path": "e2e/tests/profile/profile-page.spec.ts", "diffHunk": "@@ -1,26 +1,123 @@\n-import HomePage from 'app/page/home-page';\n import ProfilePage from 'app/page/profile-page';\n import {signIn} from 'utils/test-utils';\n import navigation, {NavLink} from 'app/component/navigation';\n+import {makeString, makeUrl} from 'utils/str-utils';\n+import Button from '../../app/element/button';\n \n describe('Profile', () => {\n+  // initialized in beforeEach()\n+  let profilePage: ProfilePage;\n+\n+  async function waitForSaveButton(isActive: boolean): Promise<Button> {\n+    const button = await profilePage.getSaveProfileButton();\n+    const isCursorEnabled = ! (await button.isCursorNotAllowed());\n+    expect(isCursorEnabled).toBe(isActive);\n+    return button;\n+  }\n \n   beforeEach(async () => {\n     await signIn(page);\n+    await navigation.navMenu(page, NavLink.PROFILE);\n+    profilePage = new ProfilePage(page);\n+    await profilePage.waitForLoad();\n+\n+    // Verify \"Save Profile\" button is disabled first time page is opened.\n+    await waitForSaveButton(false);\n   });\n \n+  test('Edit single field of existing user profile', async () => {\n+    const testText = makeString(50);\n \n-  test('Check First and Last name fields on Profile page', async () => {\n-    const homePage = new HomePage(page);\n-    await homePage.waitForLoad();\n-    await navigation.navMenu(page, NavLink.PROFILE);\n-    const profilePage = new ProfilePage(page);\n-    const fname = await (await profilePage.getFirstName()).getValue();\n-    const lname = await (await profilePage.getLastName()).getValue();\n-    // check last and first name textbox is not empty\n-    expect(fname).toMatch(new RegExp(/^[a-zA-Z]+/));\n-    expect(lname).toMatch(new RegExp(/^[a-zA-Z]+/));\n-    expect(lname).not.toEqual(fname);\n+    // Type in Research Background textarea\n+    let researchBackground = await profilePage.getResearchBackgroundTextarea();\n+    await researchBackground.paste(testText);\n+\n+    // profile update should enable Save button\n+    const saveButton = await waitForSaveButton(true);\n+    await saveButton.click();\n+    await profilePage.waitForLoad();\n+\n+    researchBackground = await profilePage.getResearchBackgroundTextarea();\n+    expect(await researchBackground.getValue()).toBe(testText);\n   });\n \n+  test('Edit all fields of existing user profile', async () => {\n+    const testTextFirstName = makeString(10);\n+    const testTextLastName = makeString(10);\n+    const testTextURL = makeUrl(10);\n+    const testTextResearchBackground = makeString(10);\n+    const testTextAddress1 = makeString(10);\n+    const testTextAddress2 = makeString(10);\n+    const testTextCity = makeString(10);\n+    const testTextState = makeString(10);\n+    const testTextZip = makeString(10);\n+    const testTextCountry = makeString(10);\n+\n+    let firstName = await profilePage.getFirstNameInput();\n+    let lastName = await profilePage.getLastNameInput();\n+    let url = await profilePage.getProfessionalUrlInput();\n+    let researchBackground = await profilePage.getResearchBackgroundTextarea();\n+    let address1 = await profilePage.getAddress1Input();\n+    let address2 = await profilePage.getAddress2Input();\n+    let city = await profilePage.getCityInput();\n+    let state = await profilePage.getStateInput();\n+    let zip = await profilePage.getZipCodeInput();\n+    let country = await profilePage.getCountryInput();\n+\n+    await firstName.type(testTextFirstName);\n+    await lastName.type(testTextLastName);\n+    await url.type(testTextURL);\n+    await researchBackground.type(testTextResearchBackground);\n+    await address1.type(testTextAddress1);\n+    await address2.type(testTextAddress2);\n+    await city.type(testTextCity);\n+    await state.type(testTextState);\n+    await zip.type(testTextZip);\n+    await country.type(testTextCountry);\n+\n+    // profile update should enable Save button\n+    const saveButton = await waitForSaveButton(true);\n+    await saveButton.click();\n+    await profilePage.waitForLoad();\n+\n+    firstName = await profilePage.getFirstNameInput();\n+    lastName = await profilePage.getLastNameInput();\n+    url = await profilePage.getProfessionalUrlInput();\n+    researchBackground = await profilePage.getResearchBackgroundTextarea();\n+    address1 = await profilePage.getAddress1Input();\n+    address2 = await profilePage.getAddress2Input();\n+    city = await profilePage.getCityInput();\n+    state = await profilePage.getStateInput();\n+    zip = await profilePage.getZipCodeInput();\n+    country = await profilePage.getCountryInput();", "originalCommit": "e42755050e7d5ec3c4ada17d94693a0ef6a2fddc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTMxNDAxMg==", "url": "https://github.com/all-of-us/workbench/pull/3948#discussion_r481314012", "bodyText": "no relative path in import. ../../ can be removed.", "author": "aweng98", "createdAt": "2020-09-01T17:30:09Z", "path": "e2e/tests/profile/profile-page.spec.ts", "diffHunk": "@@ -1,26 +1,123 @@\n-import HomePage from 'app/page/home-page';\n import ProfilePage from 'app/page/profile-page';\n import {signIn} from 'utils/test-utils';\n import navigation, {NavLink} from 'app/component/navigation';\n+import {makeString, makeUrl} from 'utils/str-utils';\n+import Button from '../../app/element/button';", "originalCommit": "e42755050e7d5ec3c4ada17d94693a0ef6a2fddc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTMxNDY2Ng==", "url": "https://github.com/all-of-us/workbench/pull/3948#discussion_r481314666", "bodyText": "type app instead .. in import statements. do not use relative path.", "author": "aweng98", "createdAt": "2020-09-01T17:31:19Z", "path": "e2e/app/page/profile-page.ts", "diffHunk": "@@ -1,25 +1,32 @@\n-import {Page} from 'puppeteer';\n+import {Page, WaitForSelectorOptions} from 'puppeteer';\n import Textbox from 'app/element/textbox';\n import AuthenticatedPage from 'app/page/authenticated-page';\n import {waitWhileLoading} from 'utils/test-utils';\n import {waitForDocumentTitle, waitForUrl} from 'utils/waits-utils';\n+import Button from '../element/button';\n+import Textarea from '../element/textarea';\n+import BaseElement from '../element/base-element';", "originalCommit": "e42755050e7d5ec3c4ada17d94693a0ef6a2fddc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTMxNTQzNw==", "url": "https://github.com/all-of-us/workbench/pull/3948#discussion_r481315437", "bodyText": "One disadvantage of not using text labels to find elements is no checking of text labels.", "author": "aweng98", "createdAt": "2020-09-01T17:32:46Z", "path": "e2e/app/page/profile-page.ts", "diffHunk": "@@ -1,25 +1,32 @@\n-import {Page} from 'puppeteer';\n+import {Page, WaitForSelectorOptions} from 'puppeteer';\n import Textbox from 'app/element/textbox';\n import AuthenticatedPage from 'app/page/authenticated-page';\n import {waitWhileLoading} from 'utils/test-utils';\n import {waitForDocumentTitle, waitForUrl} from 'utils/waits-utils';\n+import Button from '../element/button';\n+import Textarea from '../element/textarea';\n+import BaseElement from '../element/base-element';\n \n export const PageTitle = 'Profile';\n \n export const LabelAlias = {\n-  FirstName: 'First Name',\n-  LastName: 'Last Name',\n-  ContactEmail: 'Contact Email',\n-  CurrentPosition: 'Your Current Position',\n-  Organization: 'Your Organization',\n-  CurrentResearchWork: 'Current Research Work',\n-  AboutYou: 'About You',\n-  Institution: 'Institution',\n-  Role: 'Role',\n-  DiscardChanges: 'Discard Changes',", "originalCommit": "e42755050e7d5ec3c4ada17d94693a0ef6a2fddc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTM3MzgwMA==", "url": "https://github.com/all-of-us/workbench/pull/3948#discussion_r481373800", "bodyText": "Which is preferred / best practices?\nThe advantage of the testDataId is that we can change labels without changing tests ... but the disadvantage is that we may accidentally change labels and not catch it.", "author": "jmthibault79", "createdAt": "2020-09-01T19:14:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTMxNTQzNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTMxNTgwOA==", "url": "https://github.com/all-of-us/workbench/pull/3948#discussion_r481315808", "bodyText": "export is not needed if DataTestIdAlias isn't going to be imported by any outside file.", "author": "aweng98", "createdAt": "2020-09-01T17:33:26Z", "path": "e2e/app/page/profile-page.ts", "diffHunk": "@@ -1,25 +1,32 @@\n-import {Page} from 'puppeteer';\n+import {Page, WaitForSelectorOptions} from 'puppeteer';\n import Textbox from 'app/element/textbox';\n import AuthenticatedPage from 'app/page/authenticated-page';\n import {waitWhileLoading} from 'utils/test-utils';\n import {waitForDocumentTitle, waitForUrl} from 'utils/waits-utils';\n+import Button from '../element/button';\n+import Textarea from '../element/textarea';\n+import BaseElement from '../element/base-element';\n \n export const PageTitle = 'Profile';\n \n export const LabelAlias = {\n-  FirstName: 'First Name',\n-  LastName: 'Last Name',\n-  ContactEmail: 'Contact Email',\n-  CurrentPosition: 'Your Current Position',\n-  Organization: 'Your Organization',\n-  CurrentResearchWork: 'Current Research Work',\n-  AboutYou: 'About You',\n-  Institution: 'Institution',\n-  Role: 'Role',\n-  DiscardChanges: 'Discard Changes',\n+  ResearchBackground: 'Your research background, experience and research interests',\n   SaveProfile: 'Save Profile',\n };\n \n+\n+export const DataTestIdAlias = {", "originalCommit": "e42755050e7d5ec3c4ada17d94693a0ef6a2fddc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTMxNzgwOA==", "url": "https://github.com/all-of-us/workbench/pull/3948#discussion_r481317808", "bodyText": "await waitForText(this.page, text) can be used to find texts on page.", "author": "aweng98", "createdAt": "2020-09-01T17:37:07Z", "path": "e2e/app/page/profile-page.ts", "diffHunk": "@@ -40,12 +47,64 @@ export default class ProfilePage extends AuthenticatedPage {\n     }\n   }\n \n-  async getFirstName(): Promise<Textbox> {\n-    return await Textbox.findByName(this.page, {name: LabelAlias.FirstName});\n+  async getFirstNameInput(): Promise<Textbox> {\n+    return Textbox.findByName(this.page, {dataTestId: DataTestIdAlias.FirstName});\n+  }\n+\n+  async getLastNameInput(): Promise<Textbox> {\n+    return Textbox.findByName(this.page, {dataTestId: DataTestIdAlias.LastName});\n+  }\n+\n+  async getProfessionalUrlInput(): Promise<Textbox> {\n+    return Textbox.findByName(this.page, {dataTestId: DataTestIdAlias.ProfessionalUrl});\n+  }\n+\n+  async getResearchBackgroundTextarea(): Promise<Textarea> {\n+    return Textarea.findByName(this.page, {normalizeSpace: LabelAlias.ResearchBackground});\n+  }\n+\n+  async getAddress1Input(): Promise<Textbox> {\n+    return Textbox.findByName(this.page, {dataTestId: DataTestIdAlias.Address1});\n+  }\n+\n+  async getAddress2Input(): Promise<Textbox> {\n+    return Textbox.findByName(this.page, {dataTestId: DataTestIdAlias.Address2});\n   }\n \n-  async getLastName(): Promise<Textbox> {\n-    return await Textbox.findByName(this.page, {name: LabelAlias.LastName});\n+  async getCityInput(): Promise<Textbox> {\n+    return Textbox.findByName(this.page, {dataTestId: DataTestIdAlias.City});\n   }\n \n+  async getStateInput(): Promise<Textbox> {\n+    return Textbox.findByName(this.page, {dataTestId: DataTestIdAlias.State});\n+  }\n+\n+  async getZipCodeInput(): Promise<Textbox> {\n+    return Textbox.findByName(this.page, {dataTestId: DataTestIdAlias.Zip});\n+  }\n+\n+  async getCountryInput(): Promise<Textbox> {\n+    return Textbox.findByName(this.page, {dataTestId: DataTestIdAlias.Country});\n+  }\n+\n+  async getSaveProfileButton(): Promise<Button> {\n+    return Button.findByName(this.page, {name: LabelAlias.SaveProfile});\n+  }\n+\n+  // TODO generalize - promote to a Div Element?\n+  async getDivWithText(text: string, options?: WaitForSelectorOptions): Promise<BaseElement> {\n+    const selector = `//div[normalize-space(text())=\"${text}\"]`;\n+    const handle = await this.page.waitForXPath(selector, options);\n+    return BaseElement.asBaseElement(this.page, handle);\n+  }\n+\n+  async expectResearchPurposeErrorMissing(): Promise<void> {\n+    const text = 'Current Research can\\'t be blank';\n+    await this.getDivWithText(text, {hidden: true});\n+  }\n+\n+  async expectResearchPurposeErrorPresent(): Promise<void> {", "originalCommit": "e42755050e7d5ec3c4ada17d94693a0ef6a2fddc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTM4NjQ5OQ==", "url": "https://github.com/all-of-us/workbench/pull/3948#discussion_r481386499", "bodyText": "I want to have a generic check that works whether or not something is present - so I have changed this to something different", "author": "jmthibault79", "createdAt": "2020-09-01T19:39:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTMxNzgwOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTMxOTc3Nw==", "url": "https://github.com/all-of-us/workbench/pull/3948#discussion_r481319777", "bodyText": "I believe refinding is not necessary.", "author": "aweng98", "createdAt": "2020-09-01T17:40:33Z", "path": "e2e/tests/profile/profile-page.spec.ts", "diffHunk": "@@ -1,26 +1,123 @@\n-import HomePage from 'app/page/home-page';\n import ProfilePage from 'app/page/profile-page';\n import {signIn} from 'utils/test-utils';\n import navigation, {NavLink} from 'app/component/navigation';\n+import {makeString, makeUrl} from 'utils/str-utils';\n+import Button from '../../app/element/button';\n \n describe('Profile', () => {\n+  // initialized in beforeEach()\n+  let profilePage: ProfilePage;\n+\n+  async function waitForSaveButton(isActive: boolean): Promise<Button> {\n+    const button = await profilePage.getSaveProfileButton();\n+    const isCursorEnabled = ! (await button.isCursorNotAllowed());\n+    expect(isCursorEnabled).toBe(isActive);\n+    return button;\n+  }\n \n   beforeEach(async () => {\n     await signIn(page);\n+    await navigation.navMenu(page, NavLink.PROFILE);\n+    profilePage = new ProfilePage(page);\n+    await profilePage.waitForLoad();\n+\n+    // Verify \"Save Profile\" button is disabled first time page is opened.\n+    await waitForSaveButton(false);\n   });\n \n+  test('Edit single field of existing user profile', async () => {\n+    const testText = makeString(50);\n \n-  test('Check First and Last name fields on Profile page', async () => {\n-    const homePage = new HomePage(page);\n-    await homePage.waitForLoad();\n-    await navigation.navMenu(page, NavLink.PROFILE);\n-    const profilePage = new ProfilePage(page);\n-    const fname = await (await profilePage.getFirstName()).getValue();\n-    const lname = await (await profilePage.getLastName()).getValue();\n-    // check last and first name textbox is not empty\n-    expect(fname).toMatch(new RegExp(/^[a-zA-Z]+/));\n-    expect(lname).toMatch(new RegExp(/^[a-zA-Z]+/));\n-    expect(lname).not.toEqual(fname);\n+    // Type in Research Background textarea\n+    let researchBackground = await profilePage.getResearchBackgroundTextarea();\n+    await researchBackground.paste(testText);\n+\n+    // profile update should enable Save button\n+    const saveButton = await waitForSaveButton(true);\n+    await saveButton.click();\n+    await profilePage.waitForLoad();\n+\n+    researchBackground = await profilePage.getResearchBackgroundTextarea();", "originalCommit": "e42755050e7d5ec3c4ada17d94693a0ef6a2fddc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "95367d665206c54421254164e1b7fa150b6826be", "url": "https://github.com/all-of-us/workbench/commit/95367d665206c54421254164e1b7fa150b6826be", "message": "test refactor / wpi", "committedDate": "2020-09-01T18:00:10Z", "type": "commit"}, {"oid": "fbf8925c027410ab3118a32fdb06805f1df38185", "url": "https://github.com/all-of-us/workbench/commit/fbf8925c027410ab3118a32fdb06805f1df38185", "message": "fixes", "committedDate": "2020-09-01T18:02:51Z", "type": "commit"}, {"oid": "5880b9d7ccbaa9d420fc6ab83bf6455ee10f62e6", "url": "https://github.com/all-of-us/workbench/commit/5880b9d7ccbaa9d420fc6ab83bf6455ee10f62e6", "message": "Don't need to re-find these elements", "committedDate": "2020-09-01T19:11:00Z", "type": "commit"}, {"oid": "244f1409075ce2a4075f57b9bb4fb525501b9f55", "url": "https://github.com/all-of-us/workbench/commit/244f1409075ce2a4075f57b9bb4fb525501b9f55", "message": "fix imports", "committedDate": "2020-09-01T19:12:39Z", "type": "commit"}, {"oid": "3c0c3da58efa8a770003b0b8680e179e5d629c9f", "url": "https://github.com/all-of-us/workbench/commit/3c0c3da58efa8a770003b0b8680e179e5d629c9f", "message": "these consts don't need to be exported", "committedDate": "2020-09-01T19:16:08Z", "type": "commit"}, {"oid": "e4e823b8271ccf78c0a9f11a690538b8809fbc3a", "url": "https://github.com/all-of-us/workbench/commit/e4e823b8271ccf78c0a9f11a690538b8809fbc3a", "message": "this can be const", "committedDate": "2020-09-01T19:36:22Z", "type": "commit"}, {"oid": "965186b9e7a2356e64ff5f41b87a24fd79f97cf4", "url": "https://github.com/all-of-us/workbench/commit/965186b9e7a2356e64ff5f41b87a24fd79f97cf4", "message": "tmp rm incomplete test", "committedDate": "2020-09-01T19:37:48Z", "type": "commit"}, {"oid": "c49390b7afb1b90b3e3a458f9a36ec75ad7b2cd1", "url": "https://github.com/all-of-us/workbench/commit/c49390b7afb1b90b3e3a458f9a36ec75ad7b2cd1", "message": "trim names in sidenav.spec", "committedDate": "2020-09-01T21:22:01Z", "type": "commit"}]}