{"pr_number": 3598, "pr_title": "[RW-4976][risk=no] Running Puppeteer tests on local UI in CircleCI", "pr_createdAt": "2020-05-19T17:28:10Z", "pr_url": "https://github.com/all-of-us/workbench/pull/3598", "timeline": [{"oid": "8e2dd348e04f241527da54a0fc8bc867cf2d6108", "url": "https://github.com/all-of-us/workbench/commit/8e2dd348e04f241527da54a0fc8bc867cf2d6108", "message": "run puppeteer tests on local ui server", "committedDate": "2020-05-19T17:08:14Z", "type": "commit"}, {"oid": "8fc54652be3b1b322f0ea3e316b8d4455dd9de1b", "url": "https://github.com/all-of-us/workbench/commit/8fc54652be3b1b322f0ea3e316b8d4455dd9de1b", "message": "run puppeteer tests on local ui server", "committedDate": "2020-05-19T17:17:47Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzQ5NjU0Mg==", "url": "https://github.com/all-of-us/workbench/pull/3598#discussion_r427496542", "bodyText": "Better to just skip on master. This logic is not consistent with the other tests, and causes problems because it won't run again when a PR is opened.\nSpecifically consider the following PR flow:\n\ngit push # this logic runs, skips since there's no PR yet\ncreate PR # nothing happens, Circle continues running the other steps as normal, puppeteer will show green since it skipped\n(may or may not happen, depending on PR) git push # follow-up commit, now it will run properly", "author": "calbach", "createdAt": "2020-05-19T18:01:52Z", "path": ".circleci/config.yml", "diffHunk": "@@ -488,6 +533,71 @@ jobs:\n       - manage_api_cache:\n           save: true\n \n+  # Run Puppeteer e2e UI tests on deployed \"test\" environment.\n+  puppeteer-e2e-test:\n+    <<: *defaults\n+    environment:\n+      <<: *e2e_env\n+      WORKBENCH_ENV: dev\n+    working_directory: ~/workbench\n+    parallelism: 3\n+    steps:\n+      - browser-tools/install-browser-tools\n+      - checkout_init_git\n+      - halt_job_noncode_changes\n+      - run_e2e_test\n+\n+  # Deploy UI local server then run Puppeteer e2e tests on deployed \"local\" environment.\n+  puppeteer-e2e-local-ui:\n+    <<: *defaults\n+    environment:\n+      <<: *e2e_env\n+      WORKBENCH_ENV: local\n+    resource_class: medium+\n+    working_directory: ~/workbench\n+    parallelism: 1\n+    steps:\n+      - run:\n+          name: Check if it is a pull request", "originalCommit": "8fc54652be3b1b322f0ea3e316b8d4455dd9de1b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzUzMzMxMw==", "url": "https://github.com/all-of-us/workbench/pull/3598#discussion_r427533313", "bodyText": "FWIW there's an option we can turn on in Circle to only kick off workflows for changes on branches that are in pull requests if that's desirable.", "author": "jaycarlton", "createdAt": "2020-05-19T19:03:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzQ5NjU0Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzU0MDY4MA==", "url": "https://github.com/all-of-us/workbench/pull/3598#discussion_r427540680", "bodyText": "any objection to turn on this flag?\n\nhttps://app.circleci.com/settings/project/github/all-of-us/workbench/advanced?return-to=https%3A%2F%2Fapp.circleci.com%2Fpipelines%2Fgithub%2Fall-of-us%2Fworkbench", "author": "aweng98", "createdAt": "2020-05-19T19:16:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzQ5NjU0Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzYxNDIzMQ==", "url": "https://github.com/all-of-us/workbench/pull/3598#discussion_r427614231", "bodyText": "Interestingly, appears to already be on. I don't know who turned that on and when. So sounds like it should work as you expect.\nStill, we're doing the same semantic check on this line, so it's good to just check master branch here for consistency as you've done: \n  \n    \n      workbench/.circleci/config.yml\n    \n    \n         Line 109\n      in\n      8fc5465\n    \n    \n    \n    \n\n        \n          \n                         [ ${CIRCLE_BRANCH} != \"master\" ] &&", "author": "calbach", "createdAt": "2020-05-19T21:35:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzQ5NjU0Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzY1ODk0OQ==", "url": "https://github.com/all-of-us/workbench/pull/3598#discussion_r427658949", "bodyText": "oh, I turned it on after seeing Jay's comment. Honestly, I always thought it was on before.\nFor job puppeteer-e2e-local-ui, the command to skip job if it is on master branch is:\n- run:\n          name: Skip job if this is not a pull request\n          command: |\n            echo \"PR: $CI_PULL_REQUEST\"\n            if [ ${CIRCLE_BRANCH} != \"\" ] && [ ${CIRCLE_BRANCH} == \"master\" ] ; then\n              echo \"Not a PR, skipping Puppeteer tests\"\n              circleci-agent step halt\n            fi\n\nIs that correct?\nAnother question:  How can ${CIRCLE_BRANCH} == \"\"? I haven't seen that property with a empty string before.", "author": "aweng98", "createdAt": "2020-05-19T23:35:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzQ5NjU0Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzY2OTAxMg==", "url": "https://github.com/all-of-us/workbench/pull/3598#discussion_r427669012", "bodyText": "It can be empty when a tag is pushed, which happens during deploys.", "author": "calbach", "createdAt": "2020-05-20T00:07:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzQ5NjU0Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzQ5NzI1MA==", "url": "https://github.com/all-of-us/workbench/pull/3598#discussion_r427497250", "bodyText": "Note: one optimization you could make, if these things take a while, is to start the servers early, then put the dockerize wait as late as possible. i.e.\n- start_api\n- start_ui\n- setup_for_puppeteer\n- wait_api\n- wait_ui\n- puppeteer\n\nThere's no real need to block immediately", "author": "calbach", "createdAt": "2020-05-19T18:02:54Z", "path": ".circleci/config.yml", "diffHunk": "@@ -196,13 +214,72 @@ commands:\n           name: Run puppeteer e2e tests\n           working_directory: ~/workbench/e2e\n           # parallelism used to run e2e tests\n-          command: yarn test:ci $(circleci tests glob \"tests/**/*.spec.ts\" | circleci tests split --split-by=timings --timings-type=classname --show-counts)\n+          command: |\n+            circleci tests glob \"tests/**/*.spec.ts\" | circleci tests split --split-by=timings > /tmp/tests-to-run\n+            yarn test:ci $(cat /tmp/tests-to-run)\n+          no_output_timeout: 15m\n       - store_artifacts:\n           path: e2e/logs\n           destination: logs\n       - store_test_results:\n           path: ~/workbench/e2e/logs\n \n+\n+  start_local_api:\n+    description: \"Start local API server\"\n+    steps:\n+      - manage_api_cache:\n+          restore: true\n+      - run:\n+          # MySQL sometimes refuses connections by the time we attempt to apply\n+          # data migrations. Watch the port for 2m for startup.\n+          name: Await MySQL startup\n+          command: dockerize -wait tcp://127.0.0.1:3306 -timeout 2m\n+      - run:\n+          name: Run Local Migrations\n+          working_directory: ~/workbench/api\n+          command: ./project.rb run-local-migrations\n+      - run:\n+          name: Launch local API server\n+          working_directory: ~/workbench/api\n+          # tail -f is important here, it keeps this process running indefinitely\n+          command: ./project.rb start-local-api && tail -f build/dev-appserver-out/dev_appserver.out\n+          background: true\n+      - run:\n+          name: Wait for local API server to start", "originalCommit": "8fc54652be3b1b322f0ea3e316b8d4455dd9de1b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzUzNjIzOQ==", "url": "https://github.com/all-of-us/workbench/pull/3598#discussion_r427536239", "bodyText": "That's good strategy. But I think it's best for me that I don't make this change to keep focus only getting local ui + \"test\" api servers to work.\nI will incorporate that in future PR.", "author": "aweng98", "createdAt": "2020-05-19T19:08:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzQ5NzI1MA=="}], "type": "inlineReview"}, {"oid": "636738d90b68fbac0fa70be99fca04e0828c578d", "url": "https://github.com/all-of-us/workbench/commit/636738d90b68fbac0fa70be99fca04e0828c578d", "message": "skip local ui tests on master branch", "committedDate": "2020-05-19T18:24:45Z", "type": "commit"}, {"oid": "9db34d2937cb61abaa572679a265d7ec95033bcb", "url": "https://github.com/all-of-us/workbench/commit/9db34d2937cb61abaa572679a265d7ec95033bcb", "message": "revert page changes", "committedDate": "2020-05-19T19:04:06Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzUzNzM1MA==", "url": "https://github.com/all-of-us/workbench/pull/3598#discussion_r427537350", "bodyText": "Good thinking on using master branch for skip filtering. Updated command accordingly.", "author": "aweng98", "createdAt": "2020-05-19T19:10:33Z", "path": ".circleci/config.yml", "diffHunk": "@@ -488,6 +533,70 @@ jobs:\n       - manage_api_cache:\n           save: true\n \n+  # Run Puppeteer e2e UI tests on deployed \"test\" environment.\n+  puppeteer-e2e-test:\n+    <<: *defaults\n+    environment:\n+      <<: *e2e_env\n+      WORKBENCH_ENV: dev\n+    working_directory: ~/workbench\n+    parallelism: 3\n+    steps:\n+      - browser-tools/install-browser-tools\n+      - checkout_init_git\n+      - halt_job_noncode_changes\n+      - run_e2e_test\n+\n+  # Deploy UI local server then run Puppeteer e2e tests on deployed \"local\" environment.\n+  puppeteer-e2e-local-ui:\n+    <<: *defaults\n+    environment:\n+      <<: *e2e_env\n+      WORKBENCH_ENV: local\n+    resource_class: medium+\n+    working_directory: ~/workbench\n+    parallelism: 1\n+    steps:\n+      - run:\n+          name: Skip job if this is not a pull request\n+          command: |\n+            echo \"PR: $CI_PULL_REQUEST\"\n+            if [ ${CIRCLE_BRANCH} != \"\" ] && [ ${CIRCLE_BRANCH} == \"master\" ] ; then\n+              echo \"Not a PR, skipping Puppeteer tests\"\n+              circleci-agent step halt\n+            fi", "originalCommit": "9db34d2937cb61abaa572679a265d7ec95033bcb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "ef141ab4dcdc4896dc700b15f525267dbadd80a9", "url": "https://github.com/all-of-us/workbench/commit/ef141ab4dcdc4896dc700b15f525267dbadd80a9", "message": "move install-browser after skip job", "committedDate": "2020-05-19T19:36:14Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzY2MDczMw==", "url": "https://github.com/all-of-us/workbench/pull/3598#discussion_r427660733", "bodyText": "nit: I prefer the previous description", "author": "calbach", "createdAt": "2020-05-19T23:41:38Z", "path": ".circleci/config.yml", "diffHunk": "@@ -84,7 +101,7 @@ commands:\n           command: git submodule update --init --recursive\n \n   halt_job_noncode_changes:\n-    description: \"Halt job and succeed early if no code changes on master branch\"\n+    description: \"Skip job if no code changes on master branch\"", "originalCommit": "9db34d2937cb61abaa572679a265d7ec95033bcb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzY3NTk3NA==", "url": "https://github.com/all-of-us/workbench/pull/3598#discussion_r427675974", "bodyText": "reverted.", "author": "aweng98", "createdAt": "2020-05-20T00:31:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzY2MDczMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzY2MTA0MQ==", "url": "https://github.com/all-of-us/workbench/pull/3598#discussion_r427661041", "bodyText": "nit: this feels implicit to me - what else would we be caching? I don't think the change is needed", "author": "calbach", "createdAt": "2020-05-19T23:42:37Z", "path": ".circleci/config.yml", "diffHunk": "@@ -140,9 +157,9 @@ commands:\n       - restore_cache:\n           name: \"restore e2e cache\"\n           keys:\n-            - v1-e2e-cache-{{ .Branch }}-{{ checksum \"~/workbench/e2e/yarn.lock\" }}\n-            - v1-e2e-cache-master\n-            - v1-e2e-cache-\n+            - v1-e2e-dependency-cache-{{ .Branch }}-{{ checksum \"~/workbench/e2e/yarn.lock\" }}", "originalCommit": "9db34d2937cb61abaa572679a265d7ec95033bcb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzY3NjMyMg==", "url": "https://github.com/all-of-us/workbench/pull/3598#discussion_r427676322", "bodyText": "reverted. thought it would be good to match command name install_e2e_dependencies.", "author": "aweng98", "createdAt": "2020-05-20T00:33:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzY2MTA0MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzY2Mjc2NA==", "url": "https://github.com/all-of-us/workbench/pull/3598#discussion_r427662764", "bodyText": "this checks the api directory by default. That doesn't seem desirable here", "author": "calbach", "createdAt": "2020-05-19T23:47:28Z", "path": ".circleci/config.yml", "diffHunk": "@@ -488,6 +533,70 @@ jobs:\n       - manage_api_cache:\n           save: true\n \n+  # Run Puppeteer e2e UI tests on deployed \"test\" environment.\n+  puppeteer-e2e-test:\n+    <<: *defaults\n+    environment:\n+      <<: *e2e_env\n+      WORKBENCH_ENV: dev\n+    working_directory: ~/workbench\n+    parallelism: 3\n+    steps:\n+      - browser-tools/install-browser-tools\n+      - checkout_init_git\n+      - halt_job_noncode_changes\n+      - run_e2e_test\n+\n+  # Deploy UI local server then run Puppeteer e2e tests on deployed \"local\" environment.\n+  puppeteer-e2e-local-ui:\n+    <<: *defaults\n+    environment:\n+      <<: *e2e_env\n+      WORKBENCH_ENV: local\n+    resource_class: medium+\n+    working_directory: ~/workbench\n+    parallelism: 1\n+    steps:\n+      - run:\n+          name: Skip job if this is not a pull request\n+          command: |\n+            echo \"PR: $CI_PULL_REQUEST\"\n+            if [ ${CIRCLE_BRANCH} != \"\" ] && [ ${CIRCLE_BRANCH} == \"master\" ] ; then\n+              echo \"Not a PR, skipping Puppeteer tests\"\n+              circleci-agent step halt\n+            fi\n+      - checkout_init_git\n+      - halt_job_noncode_changes", "originalCommit": "9db34d2937cb61abaa572679a265d7ec95033bcb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzY3ODg2OQ==", "url": "https://github.com/all-of-us/workbench/pull/3598#discussion_r427678869", "bodyText": "halt_job_noncode_changes has no parameter. It skips job if only *.md or *.pdf files changed. I think you mean ensure_branch_has_changes command. But it has no default value for dir parameter. This was the change requested from you in last PR.", "author": "aweng98", "createdAt": "2020-05-20T00:42:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzY2Mjc2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzY4ODEwMA==", "url": "https://github.com/all-of-us/workbench/pull/3598#discussion_r427688100", "bodyText": "Oops, yep - way off. Thanks.", "author": "calbach", "createdAt": "2020-05-20T01:18:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzY2Mjc2NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzY2MzAxMA==", "url": "https://github.com/all-of-us/workbench/pull/3598#discussion_r427663010", "bodyText": "Did you mean to leave this in? Or are you actively debugging this and hoping to merge it with this PR? I dislike dead code so I would probably just leave this in a branch for now if it's not connected to anything.", "author": "calbach", "createdAt": "2020-05-19T23:48:05Z", "path": ".circleci/config.yml", "diffHunk": "@@ -488,6 +533,70 @@ jobs:\n       - manage_api_cache:\n           save: true\n \n+  # Run Puppeteer e2e UI tests on deployed \"test\" environment.\n+  puppeteer-e2e-test:\n+    <<: *defaults\n+    environment:\n+      <<: *e2e_env\n+      WORKBENCH_ENV: dev\n+    working_directory: ~/workbench\n+    parallelism: 3\n+    steps:\n+      - browser-tools/install-browser-tools\n+      - checkout_init_git\n+      - halt_job_noncode_changes\n+      - run_e2e_test\n+\n+  # Deploy UI local server then run Puppeteer e2e tests on deployed \"local\" environment.\n+  puppeteer-e2e-local-ui:\n+    <<: *defaults\n+    environment:\n+      <<: *e2e_env\n+      WORKBENCH_ENV: local\n+    resource_class: medium+\n+    working_directory: ~/workbench\n+    parallelism: 1\n+    steps:\n+      - run:\n+          name: Skip job if this is not a pull request\n+          command: |\n+            echo \"PR: $CI_PULL_REQUEST\"\n+            if [ ${CIRCLE_BRANCH} != \"\" ] && [ ${CIRCLE_BRANCH} == \"master\" ] ; then\n+              echo \"Not a PR, skipping Puppeteer tests\"\n+              circleci-agent step halt\n+            fi\n+      - checkout_init_git\n+      - halt_job_noncode_changes\n+      - browser-tools/install-browser-tools\n+      - start_local_ui\n+      - run_e2e_test\n+\n+  # NOT READY!!", "originalCommit": "9db34d2937cb61abaa572679a265d7ec95033bcb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzY3NzIxOA==", "url": "https://github.com/all-of-us/workbench/pull/3598#discussion_r427677218", "bodyText": "It is removed now. So close to have it working. I am saving it in a local file.", "author": "aweng98", "createdAt": "2020-05-20T00:36:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzY2MzAxMA=="}], "type": "inlineReview"}, {"oid": "71a83703f8b0000f4b34ad8cbad6dfca59571eca", "url": "https://github.com/all-of-us/workbench/commit/71a83703f8b0000f4b34ad8cbad6dfca59571eca", "message": "PR feedback", "committedDate": "2020-05-20T00:49:50Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzY4MTEyMQ==", "url": "https://github.com/all-of-us/workbench/pull/3598#discussion_r427681121", "bodyText": "to match halt_job_noncode_changes description.", "author": "aweng98", "createdAt": "2020-05-20T00:50:49Z", "path": ".circleci/config.yml", "diffHunk": "@@ -84,20 +101,20 @@ commands:\n           command: git submodule update --init --recursive\n \n   halt_job_noncode_changes:\n-    description: \"Halt job and succeed early if no code changes on master branch\"\n+    description: \"Halt job and succeed early if no code changes on non-master branch\"\n     steps:\n       - run:\n           command: |\n             if [ ${CIRCLE_BRANCH} != \"\" ] &&\n               [ ${CIRCLE_BRANCH} != \"master\" ] &&\n               ! git diff --name-only $(git merge-base origin/master ${CIRCLE_BRANCH}) | grep -qvE '(.md$)|(.pdf$)'; then\n-                echo \"No code changes in non-master branch. halting job.\"\n+                echo \"No code changes on non-master branch. halting job.\"\n                 circleci step halt\n             fi\n-          name: Halt job and succeed early if no code changes on master branch\n+          name: Halt job and succeed early if no code changes on non-master branch\n \n   ensure_branch_has_changes:\n-    description: \"Ensure branch has changes to code in specified directory\"\n+    description: Halt job and succeed early if no code changes in << parameters.dir_name >> directory on non-master branch", "originalCommit": "71a83703f8b0000f4b34ad8cbad6dfca59571eca", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzY4MTQ5Mg==", "url": "https://github.com/all-of-us/workbench/pull/3598#discussion_r427681492", "bodyText": "I believe it should be worded as non-master.", "author": "aweng98", "createdAt": "2020-05-20T00:52:25Z", "path": ".circleci/config.yml", "diffHunk": "@@ -84,20 +101,20 @@ commands:\n           command: git submodule update --init --recursive\n \n   halt_job_noncode_changes:\n-    description: \"Halt job and succeed early if no code changes on master branch\"\n+    description: \"Halt job and succeed early if no code changes on non-master branch\"", "originalCommit": "71a83703f8b0000f4b34ad8cbad6dfca59571eca", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}