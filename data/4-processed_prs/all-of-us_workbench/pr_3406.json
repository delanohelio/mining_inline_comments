{"pr_number": 3406, "pr_title": "[RW-4764][risk=no] Puppeteer new workspace tests", "pr_createdAt": "2020-04-15T02:33:15Z", "pr_url": "https://github.com/all-of-us/workbench/pull/3406", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTY4MzgyNQ==", "url": "https://github.com/all-of-us/workbench/pull/3406#discussion_r409683825", "bodyText": "Is this to avoid timeout errors?", "author": "NehaBroad", "createdAt": "2020-04-16T16:19:09Z", "path": "e2e/app/base-page.ts", "diffHunk": "@@ -52,7 +52,7 @@ export default abstract class BasePage {\n    */\n   async clickAndWait(clickElement: ElementHandle | BaseElement) {\n     return Promise.all([\n-      this.page.waitForNavigation({waitUntil: ['domcontentloaded', 'networkidle0'], timeout: 90000}),\n+      this.page.waitForNavigation({waitUntil: ['domcontentloaded', 'networkidle0'], timeout: 0}),", "originalCommit": "4f3dd96ca55f1ba8a6087fb335f0bf270ab3f091", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTY4NzgzOA==", "url": "https://github.com/all-of-us/workbench/pull/3406#discussion_r409687838", "bodyText": "yes. disabled timeout for this call. test timeout is capped at 4 min \"testTimeout\": 240000,. so that the waiting is not forever.", "author": "aweng98", "createdAt": "2020-04-16T16:25:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTY4MzgyNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTY4NjQxNg==", "url": "https://github.com/all-of-us/workbench/pull/3406#discussion_r409686416", "bodyText": "Another way to do this to avoid redundant code would be just to pass the action to ellipsisMenu this.selectAction, that way for any new action you do not have to add a new switch case and a method entry in ellipsisMenu", "author": "NehaBroad", "createdAt": "2020-04-16T16:23:01Z", "path": "e2e/app/data-page.ts", "diffHunk": "@@ -29,4 +37,40 @@ export default class DataPage extends AuthenticatedPage {\n     }\n   }\n \n+  async selectWorkspaceAction(action: WorkspaceAction) {\n+    const ellipsisMenu = new EllipsisMenu(this.page, './/*[@data-test-id=\"workspace-menu-button\"]');\n+    switch (action) {\n+    case WorkspaceAction.DELETE:\n+      await ellipsisMenu.delete();", "originalCommit": "4f3dd96ca55f1ba8a6087fb335f0bf270ab3f091", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTcxMzc5Mg==", "url": "https://github.com/all-of-us/workbench/pull/3406#discussion_r409713792", "bodyText": "\ud83d\udc4d\ud83d\udc4d", "author": "aweng98", "createdAt": "2020-04-16T17:05:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTY4NjQxNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTY4ODI0MQ==", "url": "https://github.com/all-of-us/workbench/pull/3406#discussion_r409688241", "bodyText": "whats is?", "author": "NehaBroad", "createdAt": "2020-04-16T16:25:43Z", "path": "e2e/app/navigation.ts", "diffHunk": "@@ -0,0 +1,102 @@\n+import {ElementHandle, Page} from 'puppeteer';\n+import {clrIconXpath} from './aou-elements/xpath-defaults';\n+import {findIcon} from './aou-elements/xpath-finder';\n+\n+export enum NavLink {\n+  HOME = 'Home',\n+  ADMIN = 'Admin',\n+  USER_ADMIN = 'User Admin',\n+  PROFILE = 'Profile',\n+  SIGN_OUT = 'Sign Out',\n+  CONTACT_US = 'Contact Us',\n+  USER_SUPPORT = 'User Support',\n+  YOUR_WORKSPACES = 'Your Workspaces',\n+  FEATURED_WORKSPACES = 'Featured Workspaces',\n+}\n+\n+export enum NavLinkIcon {\n+  HOME = 'home',\n+  ADMIN = 'user',\n+  CONTACT_US = 'envelope',\n+  USER_SUPPORT = 'help',\n+  YOUR_WORKSPACES = 'applications',\n+  FEATURED_WORKSPACES = 'star',\n+}\n+\n+export default class Navigation {\n+\n+  /**\n+   * Using SideNav menu, open another application page.\n+   * @param {Page} page\n+   * @param {NavLink} destinationApp\n+   */\n+  static async navMenu(page: Page, destinationApp: NavLink) {\n+\n+    const findMenuItem = async (): Promise<ElementHandle | null> => {\n+      await Navigation.openNavMenu(page);\n+      const angleIconXpath = clrIconXpath({}, 'angle');\n+      await page.waitForXPath(angleIconXpath, {timeout: 2000});\n+      const appLinkXpath = `//*[@role=\"button\" and @tabindex=\"0\"]//span[contains(., \"${destinationApp}\")]`;\n+         // Find link. If not found, determine if link should be found in a submenu: User or Admin\n+      const [applink] = await page.$x(appLinkXpath);\n+      if (!applink) {\n+            // If it's a link under User submenu.\n+        const [username, admin] = await page.$x(angleIconXpath);\n+        if (destinationApp === NavLink.PROFILE || destinationApp === NavLink.SIGN_OUT) {\n+               // Open User submenu if needed\n+          if (!applink) {\n+            await username.click();\n+            return page.waitForXPath(appLinkXpath, {timeout: 2000});\n+          }\n+        } else if (destinationApp === NavLink.USER_ADMIN) {\n+               // If it's a link under Admin submenu, open Admin submenu if needed\n+          if (!applink) {\n+            await admin.click();\n+            return page.waitForXPath(appLinkXpath, {timeout: 2000});\n+          }\n+        }\n+      } else {\n+        return applink;\n+      }\n+    }\n+\n+    // find target sidenav link. If not found, return null.\n+    const link = await findMenuItem();\n+    if (!link) {\n+      return null;\n+    }\n+    if (destinationApp === NavLink.CONTACT_US) {\n+      await link.click();\n+    } else {\n+         // click and wait for page navigation\n+      return Promise.all([\n+        page.waitForNavigation({waitUntil: ['domcontentloaded', 'networkidle0'], timeout: 90000}),\n+        link.click(),\n+      ]);\n+    }\n+  }\n+\n+  /**\n+   * Open SideNav menu.\n+   * @param page\n+   */\n+  static async openNavMenu(page: Page): Promise<void> {\n+    const is = await Navigation.sideNavIsOpen(page);", "originalCommit": "4f3dd96ca55f1ba8a6087fb335f0bf270ab3f091", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTcxNDEzOQ==", "url": "https://github.com/all-of-us/workbench/pull/3406#discussion_r409714139", "bodyText": "renamed to isOpen.", "author": "aweng98", "createdAt": "2020-04-16T17:06:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTY4ODI0MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTY4OTkwNA==", "url": "https://github.com/all-of-us/workbench/pull/3406#discussion_r409689904", "bodyText": "same here we can just pass the action and call this.selectAction", "author": "NehaBroad", "createdAt": "2020-04-16T16:28:13Z", "path": "e2e/app/workspace-card.ts", "diffHunk": "@@ -66,76 +67,30 @@ export default class WorkspaceCard extends BaseElement {\n     return name;\n   }\n \n-  /**\n-   * Returns an array of link texts in ellipsis popup. Used for UI verification tests\n-   */\n-  async getPopupLinkTextsArray(): Promise<unknown> {\n-    await this.clickEllipsis();\n-    const selector = `${WorkspaceCard.popupRootXpath}//*[@role=\"button\"]/text()`;\n-    await this.page.waitForXPath(selector, {visible: true});\n-    const elems = await this.page.$x(selector);\n-    const textsArray = [];\n-    for (const elem of elems) {\n-      textsArray.push(await (await elem.getProperty('textContent')).jsonValue());\n-      await elem.dispose();\n-    }\n-    return textsArray;\n-  }\n-\n-  /*\n-  * Click 'Duplicate' link in ellipsis popup.\n-   */\n-  async duplicate() {\n-    await this.clickEllipsis();\n-    const selector = this.linkSelector(WorkspaceAction.DUPLICATE);\n-    const link = await this.page.waitForXPath(selector, {visible: true});\n-    await link.click();\n-    await link.dispose();\n-  }\n-\n-  /*\n-  * Click 'Edit' link in ellipsis popup.\n-   */\n-  async edit() {\n-    await this.clickEllipsis();\n-    const selector = this.linkSelector(WorkspaceAction.EDIT);\n-    const link = await this.page.waitForXPath(selector, {visible: true});\n-    await link.click();\n-    await link.dispose();\n-  }\n-\n-  /*\n-  * Click 'Share' link in ellipsis popup.\n-   */\n-  async share() {\n-    await this.clickEllipsis();\n-    const selector = this.linkSelector(WorkspaceAction.SHARE);\n-    const link = await this.page.waitForXPath(selector, {visible: true});\n-    await link.click();\n-    await link.dispose();\n-  }\n-\n-  /*\n-  * Click 'Delete' link in ellipsis popup.\n-   */\n-  async delete() {\n-    await this.clickEllipsis();\n-    const selector = this.linkSelector(WorkspaceAction.DELETE);\n-    const link = await this.page.waitForXPath(selector, {visible: true});\n-    await link.click();\n-    await link.dispose();\n-  }\n-\n   asElementHandle(): ElementHandle {\n     return this.element.asElement();\n   }\n \n-  async getEllipsisIcon(): Promise<ElementHandle | null> {\n-    const ellipsis = await this.element.$x('.//clr-icon[@shape=\"ellipsis-vertical\"]');\n-    if (ellipsis.length === 0) {\n-      return null;\n+  async getEllipsis(): Promise<EllipsisMenu> {\n+    return new EllipsisMenu(this.page, './/clr-icon[@shape=\"ellipsis-vertical\"]', this.asElementHandle());\n+  }\n+\n+  async selectWorkspaceAction(action: WorkspaceAction): Promise<void> {\n+    const ellipsisMenu = await this.getEllipsis();\n+    switch (action) {\n+    case WorkspaceAction.DELETE:", "originalCommit": "4f3dd96ca55f1ba8a6087fb335f0bf270ab3f091", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTY5MDY1Mw==", "url": "https://github.com/all-of-us/workbench/pull/3406#discussion_r409690653", "bodyText": "Can you change it to LABLE_ALIAS?", "author": "NehaBroad", "createdAt": "2020-04-16T16:29:19Z", "path": "e2e/app/workspace-edit-page.ts", "diffHunk": "@@ -1,22 +1,25 @@\n-import {ElementHandle, Page} from 'puppeteer';\n-import Select from './aou-elements/select';\n-import SelectComponent from './aou-elements/select-component';\n-import Textbox from './aou-elements/textbox';\n-import WebComponent from './aou-elements/web-component';\n-import {findButton} from './aou-elements/xpath-finder';\n-import AuthenticatedPage from './authenticated-page';\n+import {Page} from 'puppeteer';\n+import Button from 'app/aou-elements/button';\n+import Checkbox from 'app/aou-elements/checkbox';\n+import Select from 'app/aou-elements/select';\n+import SelectComponent from 'app/aou-elements/select-component';\n+import Textbox from 'app/aou-elements/textbox';\n+import WebComponent from 'app/aou-elements/web-component';\n+import AuthenticatedPage from 'app/authenticated-page';\n+\n const faker = require('faker/locale/en_US');\n \n export const PAGE = {\n   TITLE: 'Create Workspace',\n };\n \n-export const FIELD_LABEL = {\n+export const labelAlias = {", "originalCommit": "4f3dd96ca55f1ba8a6087fb335f0bf270ab3f091", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTY5MTAwMg==", "url": "https://github.com/all-of-us/workbench/pull/3406#discussion_r409691002", "bodyText": "Field or FIELD", "author": "NehaBroad", "createdAt": "2020-04-16T16:29:51Z", "path": "e2e/app/workspace-edit-page.ts", "diffHunk": "@@ -33,11 +36,240 @@ export const FIELD_LABEL = {\n   SCIENTIFIC_APPROACHES: 'What are the scientific approaches you plan to use for your study',\n   ANTICIPATED_FINDINGS: 'What are the anticipated findings from the study',\n   PUBLICATION_IN_JOURNALS: 'Publication in peer-reviewed scientific journals',\n+  SOCIAL_MEDIA: 'Social media (Facebook, Instagram, Twitter)',\n+  PRESENTATION_AT_CONFERENCES: 'Presentation at national or international scientific conferences',\n+  PRESENTATION_AT_COMMUNITY_FORUMS: 'Presentation at community forums or advisory groups',\n+  PRESS_RELEASE: 'Press release or media article covering scientific publication',\n+  PUBLICATION_IN_COMMUNITY_JOURNALS: 'Publication in community-based journals or blog',\n+  PUBLICATION_IN_PERSONAL_BLOG: 'Publication of article in a personal blog',\n+  OTHER: 'Other',\n   INCREASE_WELLNESS: 'This research project seeks to increase wellness and resilience',\n-  NO_CONCERNS_ABOUT_STIGMATIZATION: 'No, I have no concerns at this time about potential stigmatization',\n+  SEEKS_TO_REDUCE_HEALTH_DISPARITIES: 'This research project seeks to reduce health disparities and improve health equity ',\n+  SEEKS_TO_DEVELOP_RISK_ASSESSMENT: 'This research project seeks to develop improved risk assessment and prevention strategies to preempt disease',\n+  SEEKS_TO_PROVIDE_EARLIER_ACCURATE_DIAGNOSIS: 'This research project seeks to provide earlier and more accurate diagnosis to decrease illness burden',\n+  SEEKS_TO_REDUCE_BURDEN: 'This research project seeks to improve health outcomes and reduce disease/illness burden',\n+  YES_FOCUS_ON_UNDERREPRESENTED_POPULATION: 'Yes, my study will focus on one or more specific underrepresented populations',\n+  NO_FOCUS_ON_UNDERREPRESENTED_POPULATION: 'No, my study will not center on underrepresented populations',\n+  RACE_MULTI_ANCESTRY: 'Multi-Ancestry or more than one race',\n+  AGE_GROUPS_ADOLESCENTS: 'Adolescents',\n+  SEX_AT_BIRTH: 'Participants who report something other than female or male as their sex at birth',\n+  GENDER_IDENTITY: 'Participants who identify as gender variant',\n+  GEOGRAPHY_RURAL: 'Participants who live in a rural or non-metropolitan setting',\n+  EDUCATION_LEVEL_HIGHSCHOOL: 'Participants with less than a high school degree or equivalent',\n+  DISABILITY_STATUS_WITH_DISABILITY: 'Participants with a physical and/or cognitive disability',\n+  NO_REQUEST_REVIEW: 'No, I have no concerns at this time about potential stigmatization',\n   YES_REQUEST_REVIEW: 'Yes, I would like to request a review of my research purpose',\n+  SHARE_WITH_COLLABORATORS: 'Share workspace with the same set of collaborators', // visible when clone workspace\n };\n \n+\n+export const field = {", "originalCommit": "4f3dd96ca55f1ba8a6087fb335f0bf270ab3f091", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTY5Mjk0NQ==", "url": "https://github.com/all-of-us/workbench/pull/3406#discussion_r409692945", "bodyText": "nit: can the path be updated to 'app/aou-elements/button'", "author": "NehaBroad", "createdAt": "2020-04-16T16:32:58Z", "path": "e2e/tests/workspace/workspace-create.spec.ts", "diffHunk": "@@ -1,26 +1,91 @@\n import Link from 'app/aou-elements/link';\n import DataPage from 'app/data-page';\n-import WorkspacesPage from 'app/workspaces-page';\n+import WorkspacesPage, {field} from 'app/workspaces-page';\n import {signIn} from 'tests/app';\n+import Button from '../../app/aou-elements/button';", "originalCommit": "4f3dd96ca55f1ba8a6087fb335f0bf270ab3f091", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTcwNzQzMg==", "url": "https://github.com/all-of-us/workbench/pull/3406#discussion_r409707432", "bodyText": "\ud83d\ude14\ud83d\udc4d forgot to check after Intellij auto imports.", "author": "aweng98", "createdAt": "2020-04-16T16:55:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTY5Mjk0NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTY5MzgxNw==", "url": "https://github.com/all-of-us/workbench/pull/3406#discussion_r409693817", "bodyText": "nit: can we use it like import * as fp from 'lodash/fp' to be consistent with ui code", "author": "NehaBroad", "createdAt": "2020-04-16T16:34:18Z", "path": "e2e/tests/workspace/workspace-clone.spec.ts", "diffHunk": "@@ -0,0 +1,104 @@\n+import WorkspacesPage from 'app/workspaces-page';\n+import {signIn} from 'tests/app';\n+import {WorkspaceAccessLevel, WorkspaceAction} from 'app/page-identifiers';\n+import DataPage from 'app/data-page';\n+import WorkspaceCard from 'app/workspace-card';\n+\n+const fp = require('lodash/fp');", "originalCommit": "4f3dd96ca55f1ba8a6087fb335f0bf270ab3f091", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTcwNTgwMQ==", "url": "https://github.com/all-of-us/workbench/pull/3406#discussion_r409705801", "bodyText": "\ud83d\udc4d Changed to import * as fp from 'lodash/fp';.", "author": "aweng98", "createdAt": "2020-04-16T16:52:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTY5MzgxNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTY5NTI3MQ==", "url": "https://github.com/all-of-us/workbench/pull/3406#discussion_r409695271", "bodyText": "can we use this as 'app/workspace-edit-page'?", "author": "NehaBroad", "createdAt": "2020-04-16T16:36:37Z", "path": "e2e/resources/workspace-data.ts", "diffHunk": "@@ -0,0 +1,171 @@\n+import {makeString} from 'resources/fake-user';\n+import {field} from '../app/workspace-edit-page';", "originalCommit": "4f3dd96ca55f1ba8a6087fb335f0bf270ab3f091", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTcxNTA3MA==", "url": "https://github.com/all-of-us/workbench/pull/3406#discussion_r409715070", "bodyText": "Done.", "author": "aweng98", "createdAt": "2020-04-16T17:07:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTY5NTI3MQ=="}], "type": "inlineReview"}, {"oid": "3ce877bc97bb064e7f55ec1176e8e070a4ff1ccd", "url": "https://github.com/all-of-us/workbench/commit/3ce877bc97bb064e7f55ec1176e8e070a4ff1ccd", "message": "new workspace tests\n\nrename takeAction() to performAction()\n\nrenamed ellipsis-dropdown.ts\n\nPR feedback\n\nPR feedback", "committedDate": "2020-04-16T18:56:20Z", "type": "commit"}, {"oid": "d09b3930346d66d120367a565aab87e7f6cf109a", "url": "https://github.com/all-of-us/workbench/commit/d09b3930346d66d120367a565aab87e7f6cf109a", "message": "institution email validation", "committedDate": "2020-04-16T19:07:09Z", "type": "commit"}, {"oid": "d09b3930346d66d120367a565aab87e7f6cf109a", "url": "https://github.com/all-of-us/workbench/commit/d09b3930346d66d120367a565aab87e7f6cf109a", "message": "institution email validation", "committedDate": "2020-04-16T19:07:09Z", "type": "forcePushed"}, {"oid": "2b8ce45f2a2a082bcf5d6a87b2ff6b48ef132f46", "url": "https://github.com/all-of-us/workbench/commit/2b8ce45f2a2a082bcf5d6a87b2ff6b48ef132f46", "message": "feedback", "committedDate": "2020-04-16T19:34:34Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDI3MzU3NQ==", "url": "https://github.com/all-of-us/workbench/pull/3406#discussion_r410273575", "bodyText": "from 'app", "author": "NehaBroad", "createdAt": "2020-04-17T14:48:40Z", "path": "e2e/utils/test-utils.ts", "diffHunk": "@@ -0,0 +1,60 @@\n+/**\n+ * @param fields Array\n+ */\n+import {Page} from 'puppeteer';\n+import Checkbox from '../app/aou-elements/checkbox';\n+import RadioButton from '../app/aou-elements/radiobutton';", "originalCommit": "2b8ce45f2a2a082bcf5d6a87b2ff6b48ef132f46", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "9466d306aa4c9e6aff757d7add9e91c2aeff1727", "url": "https://github.com/all-of-us/workbench/commit/9466d306aa4c9e6aff757d7add9e91c2aeff1727", "message": "pr feedback", "committedDate": "2020-04-17T17:00:06Z", "type": "commit"}]}