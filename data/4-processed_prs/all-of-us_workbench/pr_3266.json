{"pr_number": 3266, "pr_title": "[RW-4524][risk=no] Add in-form institution check to user creation page.", "pr_createdAt": "2020-03-18T12:49:13Z", "pr_url": "https://github.com/all-of-us/workbench/pull/3266", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDMyMjAxMQ==", "url": "https://github.com/all-of-us/workbench/pull/3266#discussion_r394322011", "bodyText": "There's a bit of \"clean up the awkward single-quote whitespace\" here. We should probably do this for the whole file at some point, but I couldn't help myself from fixing it for institution APIs while I was here.", "author": "gjuggler", "createdAt": "2020-03-18T12:51:47Z", "path": "api/src/main/resources/workbench-api.yaml", "diffHunk": "@@ -2320,23 +2320,17 @@ paths:\n       tags:\n       - institution\n       description: 'Gets the list of all Institutions. Requires INSTITUTION_ADMIN\n-        authority.", "originalCommit": "0a567f713962c2831e5c02dae97425fc7347accf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDM1NzcwNw==", "url": "https://github.com/all-of-us/workbench/pull/3266#discussion_r394357707", "bodyText": "Weird!  Was this a side-effect of the merge?  Thanks for cleanup.", "author": "jmthibault79", "createdAt": "2020-03-18T13:47:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDMyMjAxMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDMyNDI4OA==", "url": "https://github.com/all-of-us/workbench/pull/3266#discussion_r394324288", "bodyText": "Today I learned: the trailing slash here is important. I'd initially left it out, and what happened was that an API call such as:\n/v1/institutions/VUMC/checkEmail/gjuggler%40gmail.com\nwould land in our controller with parameters like:\nshortName: VUMC\nemail: gjuggler@gmail\nwithout the trailing \".com\".\nAdding the trailing slash to the Swagger helped fix this \u2013\u00a0the client now sends requests with the trailing slash, and the controller parses them correctly.\n(Note to self: if we were truly paranoid here, we'd add some more extensive controller-level tests to exercise the full request parsing flow. I didn't think it was worth it in this case, but I'm happy to hear disagreement.)", "author": "gjuggler", "createdAt": "2020-03-18T12:55:42Z", "path": "api/src/main/resources/workbench-api.yaml", "diffHunk": "@@ -2423,11 +2401,33 @@ paths:\n           \"$ref\": \"#/definitions/Institution\"\n       responses:\n         200:\n-          description: 'The updated Institution.\n-\n-'\n+          description: The updated Institution.\n           schema:\n             \"$ref\": \"#/definitions/Institution\"\n+  \"/v1/institutions/{shortName}/checkEmail/{email}/\":", "originalCommit": "0a567f713962c2831e5c02dae97425fc7347accf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDM2NDg3OA==", "url": "https://github.com/all-of-us/workbench/pull/3266#discussion_r394364878", "bodyText": "yikes, good catch", "author": "jmthibault79", "createdAt": "2020-03-18T13:57:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDMyNDI4OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDMyNDYyMA==", "url": "https://github.com/all-of-us/workbench/pull/3266#discussion_r394324620", "bodyText": "I didn't make any change here, but I think IntelliJ just removed the trailing whitespace automatically (here and below). I'm not sure how to go about removing these changes if I'm using IJ for editing...", "author": "gjuggler", "createdAt": "2020-03-18T12:56:16Z", "path": "api/src/main/resources/workbench-api.yaml", "diffHunk": "@@ -3884,7 +3884,7 @@ definitions:\n         type: string\n       approved:\n         type: boolean\n-        default: \n+        default:", "originalCommit": "0a567f713962c2831e5c02dae97425fc7347accf", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDM0NzgwOA==", "url": "https://github.com/all-of-us/workbench/pull/3266#discussion_r394347808", "bodyText": "Javadoc-ifying is good.  Let's fill in the return description too.", "author": "jmthibault79", "createdAt": "2020-03-18T13:32:54Z", "path": "api/src/main/java/org/pmiops/workbench/api/InstitutionController.java", "diffHunk": "@@ -56,8 +57,11 @@\n     return ResponseEntity.ok(response);\n   }\n \n-  // note: this endpoint is publicly accessible because it is needed for account creation\n-\n+  /**\n+   * This API is publicly-accessible since it is called during account creation.\n+   *\n+   * @return", "originalCommit": "0a567f713962c2831e5c02dae97425fc7347accf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTk5NTQwNA==", "url": "https://github.com/all-of-us/workbench/pull/3266#discussion_r395995404", "bodyText": "Done", "author": "gjuggler", "createdAt": "2020-03-21T14:05:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDM0NzgwOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDM0OTQ0Nw==", "url": "https://github.com/all-of-us/workbench/pull/3266#discussion_r394349447", "bodyText": "@Override", "author": "jmthibault79", "createdAt": "2020-03-18T13:35:19Z", "path": "api/src/main/java/org/pmiops/workbench/api/InstitutionController.java", "diffHunk": "@@ -66,6 +70,24 @@\n     return ResponseEntity.ok(response);\n   }\n \n+  /**\n+   * This API is publicly-accessible since it is called during account creation.\n+   *\n+   * @return\n+   */\n+  public ResponseEntity<CheckEmailResponse> checkEmail(final String shortName, final String email) {", "originalCommit": "0a567f713962c2831e5c02dae97425fc7347accf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTk5NTQzNw==", "url": "https://github.com/all-of-us/workbench/pull/3266#discussion_r395995437", "bodyText": "Done", "author": "gjuggler", "createdAt": "2020-03-21T14:05:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDM0OTQ0Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDM1MDA0MQ==", "url": "https://github.com/all-of-us/workbench/pull/3266#discussion_r394350041", "bodyText": "We repeat this block in a few places now so let's make it a private method", "author": "jmthibault79", "createdAt": "2020-03-18T13:36:13Z", "path": "api/src/main/java/org/pmiops/workbench/api/InstitutionController.java", "diffHunk": "@@ -66,6 +70,24 @@\n     return ResponseEntity.ok(response);\n   }\n \n+  /**\n+   * This API is publicly-accessible since it is called during account creation.\n+   *\n+   * @return\n+   */\n+  public ResponseEntity<CheckEmailResponse> checkEmail(final String shortName, final String email) {\n+    final Institution institution =", "originalCommit": "0a567f713962c2831e5c02dae97425fc7347accf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTk5NTY4Mw==", "url": "https://github.com/all-of-us/workbench/pull/3266#discussion_r395995683", "bodyText": "Done", "author": "gjuggler", "createdAt": "2020-03-21T14:09:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDM1MDA0MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDM1NTM1MQ==", "url": "https://github.com/all-of-us/workbench/pull/3266#discussion_r394355351", "bodyText": "might as well fill in these as well", "author": "jmthibault79", "createdAt": "2020-03-18T13:44:03Z", "path": "api/src/main/java/org/pmiops/workbench/institution/InstitutionService.java", "diffHunk": "@@ -35,4 +35,13 @@\n    */\n   boolean validateAffiliation(\n       @Nullable DbVerifiedInstitutionalAffiliation dbAffiliation, String contactEmail);\n+\n+  /**\n+   * Checks whether a given email address is a valid member of an Institution.\n+   *\n+   * @param institution", "originalCommit": "0a567f713962c2831e5c02dae97425fc7347accf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTk5NTk1Mw==", "url": "https://github.com/all-of-us/workbench/pull/3266#discussion_r395995953", "bodyText": "Done", "author": "gjuggler", "createdAt": "2020-03-21T14:13:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDM1NTM1MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDM1NTgwMg==", "url": "https://github.com/all-of-us/workbench/pull/3266#discussion_r394355802", "bodyText": "maybe: copy the pattern matching comment from the previous method", "author": "jmthibault79", "createdAt": "2020-03-18T13:44:46Z", "path": "api/src/main/java/org/pmiops/workbench/institution/InstitutionService.java", "diffHunk": "@@ -35,4 +35,13 @@\n    */\n   boolean validateAffiliation(\n       @Nullable DbVerifiedInstitutionalAffiliation dbAffiliation, String contactEmail);\n+\n+  /**\n+   * Checks whether a given email address is a valid member of an Institution.", "originalCommit": "0a567f713962c2831e5c02dae97425fc7347accf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTk5NTg1MQ==", "url": "https://github.com/all-of-us/workbench/pull/3266#discussion_r395995851", "bodyText": "Done, did some comment cleanup here.", "author": "gjuggler", "createdAt": "2020-03-21T14:12:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDM1NTgwMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDM2Nzk3Mw==", "url": "https://github.com/all-of-us/workbench/pull/3266#discussion_r394367973", "bodyText": "TOL with paranoia hat on: an attacker could spam this endpoint with emails, hunting for one that works.\nBut what would they do with that information?  They would still need to control that email address which the Inst is explicitly approving.\nMaybe not a real concern then.\nDOS is a real concern but that's true generally and should be mitigated in a general way, not here.", "author": "jmthibault79", "createdAt": "2020-03-18T14:01:41Z", "path": "api/src/main/resources/workbench-api.yaml", "diffHunk": "@@ -2423,11 +2401,33 @@ paths:\n           \"$ref\": \"#/definitions/Institution\"\n       responses:\n         200:\n-          description: 'The updated Institution.\n-\n-'\n+          description: The updated Institution.\n           schema:\n             \"$ref\": \"#/definitions/Institution\"\n+  \"/v1/institutions/{shortName}/checkEmail/{email}/\":\n+    parameters:\n+    - in: path\n+      name: shortName\n+      type: string\n+      description: 'The short name / key of the institution to check, e.g. \"VUMC\"'\n+      required: true\n+    - in: path\n+      name: email\n+      type: string\n+      description: Institutional contact email address to check.\n+      required: true\n+    get:\n+      tags:\n+        - institution\n+      operationId: checkEmail\n+      description: Checks whether the given email address is a verified member of an institution.\n+      x-aou-note: This endpoint is publicly-accessible and called by clients during user registration.", "originalCommit": "0a567f713962c2831e5c02dae97425fc7347accf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTk5NjQwNg==", "url": "https://github.com/all-of-us/workbench/pull/3266#discussion_r395996406", "bodyText": "Agreed \u2013\u00a0the DOS risk is nonzero, but we have other non-auth endpoints that access the DB as well. We should probably take some time to better document our ddos-protection story: what protections are afforded at the WAF, App Engine, Google Cloud, and application levels. Filed RW-4630 to track.", "author": "gjuggler", "createdAt": "2020-03-21T14:18:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDM2Nzk3Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDM3NzcwMA==", "url": "https://github.com/all-of-us/workbench/pull/3266#discussion_r394377700", "bodyText": "Could this return a ResponseEntity<Boolean> instead?", "author": "jmthibault79", "createdAt": "2020-03-18T14:15:03Z", "path": "api/src/main/java/org/pmiops/workbench/api/InstitutionController.java", "diffHunk": "@@ -66,6 +70,24 @@\n     return ResponseEntity.ok(response);\n   }\n \n+  /**\n+   * This API is publicly-accessible since it is called during account creation.\n+   *\n+   * @return\n+   */\n+  public ResponseEntity<CheckEmailResponse> checkEmail(final String shortName, final String email) {", "originalCommit": "0a567f713962c2831e5c02dae97425fc7347accf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTk5NTU0Nw==", "url": "https://github.com/all-of-us/workbench/pull/3266#discussion_r395995547", "bodyText": "I generally tend to avoid primitive return types for API responses where possible. It dramatically reduces the additional effort for someone to add another response field in the future, which I've found to be a maintenance win.", "author": "gjuggler", "createdAt": "2020-03-21T14:07:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDM3NzcwMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDU2NTQ0NA==", "url": "https://github.com/all-of-us/workbench/pull/3266#discussion_r394565444", "bodyText": "Is this event guaranteed to happen before the submit button is clicked?  Consider whether a user might choose to enter their Role before their Email", "author": "jmthibault79", "createdAt": "2020-03-18T18:44:47Z", "path": "ui/src/app/pages/login/account-creation/account-creation-institution.tsx", "diffHunk": "@@ -235,12 +314,21 @@ export class AccountCreationInstitution extends React.Component<Props, State> {\n                                     This will be the primary email contact for your new account.\n                                   </div>\n                                 </div>}\n-                                invalid={this.state.emailFailedValidation}\n-                                onBlur={() => this.validateContactEmailInline()}\n-                                onChange={email => this.updateContactEmail(email)}/>\n-            {this.state.emailFailedValidation &&\n-              <ErrorDiv data-test-id='invalid-email-error'>\n-                Error: email address is invalid\n+                                invalid={!this.isEmailValid()}\n+                                onBlur={() => this.onEmailBlur()}", "originalCommit": "0a567f713962c2831e5c02dae97425fc7347accf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTk5NzA0Nw==", "url": "https://github.com/all-of-us/workbench/pull/3266#discussion_r395997047", "bodyText": "That situation is caught correctly by the form-level validation: if an institution is selected, the form won't allow progress unless there is a non-null checkEmailResponse object in the component state.", "author": "gjuggler", "createdAt": "2020-03-21T14:26:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDU2NTQ0NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDU2Njc0MA==", "url": "https://github.com/all-of-us/workbench/pull/3266#discussion_r394566740", "bodyText": "why change this?", "author": "jmthibault79", "createdAt": "2020-03-18T18:47:00Z", "path": "ui/src/app/pages/login/account-creation/account-creation-institution.tsx", "diffHunk": "@@ -118,23 +190,30 @@ export class AccountCreationInstitution extends React.Component<Props, State> {\n           message: '^Email address is invalid'\n         }\n       },\n-      'verifiedInstitutionalAffiliation.institutionalRoleEnum': {\n+      'profile.verifiedInstitutionalAffiliation.institutionalRoleEnum': {\n         presence: {\n           allowEmpty: false,\n           message: '^Institutional role cannot be blank',\n         }\n       },\n     };\n+    if (!isBlank(this.state.profile.verifiedInstitutionalAffiliation.institutionShortName) &&\n+        !isBlank(this.state.profile.contactEmail)) {\n+      validationCheck['checkEmailResponse'] = {\n+        checkEmailResponse: {}\n+      };\n+    }\n+\n     if (this.state.profile.verifiedInstitutionalAffiliation.institutionalRoleEnum === InstitutionalRole.OTHER) {\n-      validationCheck['verifiedInstitutionalAffiliation.institutionalRoleOtherText'] = {\n+      validationCheck['profile.verifiedInstitutionalAffiliation.institutionalRoleOtherText'] = {\n         presence: {\n           allowEmpty: false,\n           message: '^Institutional role text cannot be blank',\n         }\n       };\n     }\n \n-    return validate(this.state.profile, validationCheck);\n+    return validate(this.state, validationCheck);", "originalCommit": "0a567f713962c2831e5c02dae97425fc7347accf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTk5NjkyNA==", "url": "https://github.com/all-of-us/workbench/pull/3266#discussion_r395996924", "bodyText": "This was a kind of subtle but interesting change \u2013 by providing the entire state object to validate.js, it allows us to run checks against any property of the component's state (which is the most flexible for future additions). In this case, I wanted to add some validation on the checkEmailResponse property, to ensure our form submission is appropriately blocked if the email-validation check hasn't completed.", "author": "gjuggler", "createdAt": "2020-03-21T14:25:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDU2Njc0MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjQzODIwNg==", "url": "https://github.com/all-of-us/workbench/pull/3266#discussion_r396438206", "bodyText": "nice, thanks", "author": "jmthibault79", "createdAt": "2020-03-23T13:11:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDU2Njc0MA=="}], "type": "inlineReview"}, {"oid": "f60f804a3cd152fef081e59d8b0cc3c165eec645", "url": "https://github.com/all-of-us/workbench/commit/f60f804a3cd152fef081e59d8b0cc3c165eec645", "message": "WIP checkEmail API and UI.", "committedDate": "2020-03-23T15:55:39Z", "type": "commit"}, {"oid": "50e111d099e7a491a7eda62004a8a93351e591cb", "url": "https://github.com/all-of-us/workbench/commit/50e111d099e7a491a7eda62004a8a93351e591cb", "message": "Move API to better location, add UI and unit tests.", "committedDate": "2020-03-23T15:55:39Z", "type": "commit"}, {"oid": "f2a28c962640424da5fa59eb613a8396ee372d2f", "url": "https://github.com/all-of-us/workbench/commit/f2a28c962640424da5fa59eb613a8396ee372d2f", "message": "Revert temp change to starting sign-in step.", "committedDate": "2020-03-23T15:55:39Z", "type": "commit"}, {"oid": "3d96d1d06b4ef68d962bdef9c293aec32908ef1b", "url": "https://github.com/all-of-us/workbench/commit/3d96d1d06b4ef68d962bdef9c293aec32908ef1b", "message": "PR feedback and added test case.", "committedDate": "2020-03-23T15:55:40Z", "type": "commit"}, {"oid": "bafe6f251da61243d23b5182c452ccacabca193c", "url": "https://github.com/all-of-us/workbench/commit/bafe6f251da61243d23b5182c452ccacabca193c", "message": "Add fix & test case for email-before-institution scenario", "committedDate": "2020-03-23T15:55:40Z", "type": "commit"}, {"oid": "ea5639e67abae3862a3ca321307d879157558ece", "url": "https://github.com/all-of-us/workbench/commit/ea5639e67abae3862a3ca321307d879157558ece", "message": "Fix bug in dropdown change handler.", "committedDate": "2020-03-23T15:55:40Z", "type": "commit"}, {"oid": "ea5639e67abae3862a3ca321307d879157558ece", "url": "https://github.com/all-of-us/workbench/commit/ea5639e67abae3862a3ca321307d879157558ece", "message": "Fix bug in dropdown change handler.", "committedDate": "2020-03-23T15:55:40Z", "type": "forcePushed"}]}