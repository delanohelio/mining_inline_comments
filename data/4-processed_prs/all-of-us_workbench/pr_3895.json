{"pr_number": 3895, "pr_title": "[no ticket][risk=no] Run puppeteer tests in staging", "pr_createdAt": "2020-08-18T21:43:53Z", "pr_url": "https://github.com/all-of-us/workbench/pull/3895", "timeline": [{"oid": "e7263d1d7ad67f62251e028bcf22deff2b9dc87e", "url": "https://github.com/all-of-us/workbench/commit/e7263d1d7ad67f62251e028bcf22deff2b9dc87e", "message": "enable tests in staging", "committedDate": "2020-08-19T21:16:21Z", "type": "forcePushed"}, {"oid": "bb6cd670e47830912face667bf3e7adf4d613977", "url": "https://github.com/all-of-us/workbench/commit/bb6cd670e47830912face667bf3e7adf4d613977", "message": "rebase master branch", "committedDate": "2020-08-19T22:16:22Z", "type": "forcePushed"}, {"oid": "b50b1fd97b35c5dda6e71056a046c8402c8776fb", "url": "https://github.com/all-of-us/workbench/commit/b50b1fd97b35c5dda6e71056a046c8402c8776fb", "message": "run tests in staging", "committedDate": "2020-08-20T03:15:58Z", "type": "commit"}, {"oid": "b50b1fd97b35c5dda6e71056a046c8402c8776fb", "url": "https://github.com/all-of-us/workbench/commit/b50b1fd97b35c5dda6e71056a046c8402c8776fb", "message": "run tests in staging", "committedDate": "2020-08-20T03:15:58Z", "type": "forcePushed"}, {"oid": "13e2ef3d5653b06e5f6fbb427db755674c6724ea", "url": "https://github.com/all-of-us/workbench/commit/13e2ef3d5653b06e5f6fbb427db755674c6724ea", "message": "rever pickWorkspace", "committedDate": "2020-08-20T03:49:05Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzU1NDMwOQ==", "url": "https://github.com/all-of-us/workbench/pull/3895#discussion_r473554309", "bodyText": "Homepage isn't always the landing page after login. For example, a user could have entered workspace url directly.", "author": "aweng98", "createdAt": "2020-08-20T02:42:02Z", "path": "e2e/app/page/google-login.ts", "diffHunk": "@@ -132,17 +131,17 @@ export default class GoogleLoginPage {\n     // Sometimes, user is prompted with \"Enter Recovery Email\" page. Handle the page if found.\n     const recoverEmailXpath = '//input[@type=\"email\" and @aria-label=\"Enter recovery email address\"]';\n     await Promise.race([\n-      waitForDocumentTitle(this.page, 'Homepage'),", "originalCommit": "d4ae2e44b29a13e3733fd6f762af10b49e4eb45f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzU2MzM1NA==", "url": "https://github.com/all-of-us/workbench/pull/3895#discussion_r473563354", "bodyText": "It is not enabled in staging workflow because the automation script that delete workspaces and billing projects are not working in staging.", "author": "aweng98", "createdAt": "2020-08-20T03:18:02Z", "path": ".circleci/config.yml", "diffHunk": "@@ -659,6 +691,11 @@ workflows:\n             - api-deps-check\n             - api-integration-test\n             - ui-unit-test\n+      # Not ready\n+      # - puppeteer-e2e-test-staging:\n+          # filters: *filter_only_release_tags\n+          # requires:\n+            # - deploy-staging", "originalCommit": "b50b1fd97b35c5dda6e71056a046c8402c8776fb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzU3MjIxNQ==", "url": "https://github.com/all-of-us/workbench/pull/3895#discussion_r473572215", "bodyText": "Reminder to myself: Remove this call in workflow before merge to master branch.", "author": "aweng98", "createdAt": "2020-08-20T03:54:23Z", "path": ".circleci/config.yml", "diffHunk": "@@ -625,6 +654,9 @@ workflows:\n           requires:\n             - api-deploy-to-test\n             - ui-deploy-to-test\n+      - puppeteer-e2e-test-staging", "originalCommit": "13e2ef3d5653b06e5f6fbb427db755674c6724ea", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "c68ed5badd8cd4e5867e4a5ec8085ff0dc71be42", "url": "https://github.com/all-of-us/workbench/commit/c68ed5badd8cd4e5867e4a5ec8085ff0dc71be42", "message": "circleci config", "committedDate": "2020-08-20T15:16:48Z", "type": "commit"}, {"oid": "52d70262fcd8e1eba3f0a22c1374c0dcd22cca68", "url": "https://github.com/all-of-us/workbench/commit/52d70262fcd8e1eba3f0a22c1374c0dcd22cca68", "message": "circleci config change", "committedDate": "2020-08-20T15:50:05Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDE1NTY2OA==", "url": "https://github.com/all-of-us/workbench/pull/3895#discussion_r474155668", "bodyText": "what do these changes have to do with running the tests in staging?", "author": "als364", "createdAt": "2020-08-20T17:29:48Z", "path": "e2e/app/element/select.ts", "diffHunk": "@@ -23,18 +23,26 @@ export default class Select extends BaseElement {\n     super(page, xpath);\n   }\n \n-  async selectOption(optionValue: string): Promise<string> {\n+  async selectOption(value: string): Promise<string> {", "originalCommit": "52d70262fcd8e1eba3f0a22c1374c0dcd22cca68", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDE4MjExMw==", "url": "https://github.com/all-of-us/workbench/pull/3895#discussion_r474182113", "bodyText": "The original way of finding select option is relying on the value. however, values are different for the Dataset on test and staging. see screenshots below. I had to change it to use displayed texts instead of value.\ntest env.\n\nstaging env.", "author": "aweng98", "createdAt": "2020-08-20T18:18:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDE1NTY2OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDE3NzM3Mg==", "url": "https://github.com/all-of-us/workbench/pull/3895#discussion_r474177372", "bodyText": "What do these changes have to do with running tests in staging?", "author": "als364", "createdAt": "2020-08-20T18:09:36Z", "path": "e2e/app/page/workspace-edit-page.ts", "diffHunk": "@@ -245,6 +245,13 @@ export default class WorkspaceEditPage extends AuthenticatedPage {\n     }\n   }\n \n+  /**", "originalCommit": "52d70262fcd8e1eba3f0a22c1374c0dcd22cca68", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDE4MzU4OA==", "url": "https://github.com/all-of-us/workbench/pull/3895#discussion_r474183588", "bodyText": "result of changes in Select class.", "author": "aweng98", "createdAt": "2020-08-20T18:21:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDE3NzM3Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDE4NDU2Ng==", "url": "https://github.com/all-of-us/workbench/pull/3895#discussion_r474184566", "bodyText": "In staging, there is a enabled UI feature flag which is disabled in test.\nUI behaviors are different as result. I had to modify this test so it works in both env.", "author": "aweng98", "createdAt": "2020-08-20T18:22:52Z", "path": "e2e/tests/cohorts/cohorts-rename.spec.ts", "diffHunk": "@@ -43,24 +43,27 @@ describe('User can create, modify, rename and delete Cohort', () => {\n     const minAge = 21;\n     const maxAge = 95;\n     const group1 = cohortBuildPage.findIncludeParticipantsGroup('Group 1');\n-    const group1Count = await group1.includeAge(minAge, maxAge);", "originalCommit": "52d70262fcd8e1eba3f0a22c1374c0dcd22cca68", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDIzNjg4NQ==", "url": "https://github.com/all-of-us/workbench/pull/3895#discussion_r474236885", "bodyText": "what flag is it? is it possible to condition the behavior of this test on the feature flag? how come these changes work on both staging and test?", "author": "als364", "createdAt": "2020-08-20T19:54:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDE4NDU2Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDI0NTkyNw==", "url": "https://github.com/all-of-us/workbench/pull/3895#discussion_r474245927", "bodyText": "I believe it was enableCBAgeTypeOptions. But I did a quick search now, flag was removed 3 days ago for all env. So I don't know what happens next.\nWhat the feature flag did wass: the count on the age slider is pre-calculated and then the real count is calculated in bigquery when Finish button in Modal is clicked. Pre-calcuated count is different from calculated count.", "author": "aweng98", "createdAt": "2020-08-20T20:12:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDE4NDU2Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDI0NzU5Mg==", "url": "https://github.com/all-of-us/workbench/pull/3895#discussion_r474247592", "bodyText": "would expect(totalCount).toEqual(group1Count) not then fail with the feature flag enabled?", "author": "als364", "createdAt": "2020-08-20T20:16:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDE4NDU2Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDI1ODAwNw==", "url": "https://github.com/all-of-us/workbench/pull/3895#discussion_r474258007", "bodyText": "No, test shouldn't fail with or without flag.\nOld way was to get the count within Age modal then verify count after close Age modal. New way is get the calculated Group Count after close Age modal, and then compare it with the Total Count. Because only one group, Group Count and Total Count should match.", "author": "aweng98", "createdAt": "2020-08-20T20:36:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDE4NDU2Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDI2MjQzMg==", "url": "https://github.com/all-of-us/workbench/pull/3895#discussion_r474262432", "bodyText": "Gotcha, thanks.", "author": "als364", "createdAt": "2020-08-20T20:45:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDE4NDU2Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDE4NjkwNA==", "url": "https://github.com/all-of-us/workbench/pull/3895#discussion_r474186904", "bodyText": "Changes here also for running test consistently in both env. In test env, all existing workspaces were created using Synthetic Dataset 3. In staging env, most of existing workspaces were created on Synthetic Dataset 1. Reusing Synthetic Dataset 1 workspaces are causing problems. So the solution is modify the test code - create new workspaces.", "author": "aweng98", "createdAt": "2020-08-20T18:27:03Z", "path": "e2e/tests/conceptsets/conceptset-edit.spec.ts", "diffHunk": "@@ -98,28 +95,14 @@ describe('Editing and Copying Concept Sets', () => {\n   /**\n    * Test:\n    * - Copy Concept Set from one workspace to another workspace.\n-   * Note: Use existing workspaces and Concept Set when possible. Otherwise create new workspaces and Concept Sets.\n    */\n   test('Copy Concept Set to another workspace', async () => {\n-    // Find all workspaces.\n-    const workspaceCard = new WorkspaceCard(page);\n-    const allWorkspaces = await workspaceCard.getWorkspaceMatchAccessLevel(WorkspaceAccessLevel.Owner);\n-\n-    // Need two workspaces.\n-    let workspace1: WorkspaceCard;\n-    let workspace2: WorkspaceCard;\n-\n-    if (allWorkspaces.length > 1) {\n-      workspace1 = allWorkspaces[0];\n-      workspace2 = allWorkspaces[1];\n-    } else {\n-      // Don't have two. Create two new workspaces.\n-      workspace1 = await findWorkspace(page, true);\n-      workspace2 = await findWorkspace(page, true);\n-    }\n-\n-    // Note: workspace1 is the Copy to workspace. workspace2 is the Copy from workspace.\n+", "originalCommit": "52d70262fcd8e1eba3f0a22c1374c0dcd22cca68", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDE4OTAyMQ==", "url": "https://github.com/all-of-us/workbench/pull/3895#discussion_r474189021", "bodyText": "unrelated change. while running and inspecting test code, I realized 3 lines of code can be rewritten in one line.", "author": "aweng98", "createdAt": "2020-08-20T18:30:47Z", "path": "e2e/tests/conceptsets/conceptset-edit.spec.ts", "diffHunk": "@@ -26,9 +25,7 @@ describe('Editing and Copying Concept Sets', () => {\n    */\n   test('Add to existing Concept Set in same workspace', async () => {\n     // Create a workspace\n-    const workspaceCard = await findWorkspace(page, true);\n-    const workspaceName = await workspaceCard.getWorkspaceName();\n-    await workspaceCard.clickWorkspaceName();\n+    const workspaceName = await findWorkspace(page, true).then(card => card.clickWorkspaceName());", "originalCommit": "52d70262fcd8e1eba3f0a22c1374c0dcd22cca68", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDE4OTYwMA==", "url": "https://github.com/all-of-us/workbench/pull/3895#discussion_r474189600", "bodyText": "Avoid finding and using Synthetic Dataset 1 workspaces.", "author": "aweng98", "createdAt": "2020-08-20T18:31:51Z", "path": "e2e/tests/workspace/workspace-edit.spec.ts", "diffHunk": "@@ -20,10 +20,17 @@ describe('Editing workspace thru workspace card ellipsis menu', () => {\n    * - Verify Workspace Information in ABOUT tab.\n    */\n   test('User as OWNER can edit workspace', async () => {\n-    const workspaceCard = await findWorkspace(page);\n+    const workspaceCard = await findWorkspace(page, true);", "originalCommit": "52d70262fcd8e1eba3f0a22c1374c0dcd22cca68", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDI4NDE4OA==", "url": "https://github.com/all-of-us/workbench/pull/3895#discussion_r474284188", "bodyText": "Our test environment is called \"test\"", "author": "calbach", "createdAt": "2020-08-20T21:31:34Z", "path": ".circleci/config.yml", "diffHunk": "@@ -205,12 +205,25 @@ commands:\n \n   run_e2e_test:\n     description: \"Run puppeteer e2e integration tests\"\n+    parameters:\n+      env_name:\n+        description: The target environment for run Puppeteer tests. Must be one of \"dev\", \"staging\".\n+        default: \"dev\"", "originalCommit": "52d70262fcd8e1eba3f0a22c1374c0dcd22cca68", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDI4NTA1NA==", "url": "https://github.com/all-of-us/workbench/pull/3895#discussion_r474285054", "bodyText": "Would prefer a consistent naming convention for these, e.g.\nPUPPETEER_USER_STAGING\nPUPPETEER_USER_TEST", "author": "calbach", "createdAt": "2020-08-20T21:33:29Z", "path": ".circleci/config.yml", "diffHunk": "@@ -205,12 +205,25 @@ commands:\n \n   run_e2e_test:\n     description: \"Run puppeteer e2e integration tests\"\n+    parameters:\n+      env_name:\n+        description: The target environment for run Puppeteer tests. Must be one of \"dev\", \"staging\".\n+        default: \"dev\"\n+        type: enum\n+        enum: [\"dev\", \"staging\"]\n     steps:\n       - install_e2e_dependencies\n       - run:\n-          name: Update Puppeteer test environment variables\n+          name: Update test user email env variable\n+          command: |\n+            case << parameters.env_name >> in\n+              staging) echo 'export USER_NAME=$PUPPETEER_TEST_USER_STAGING' >> $BASH_ENV ;;\n+              dev) echo 'export USER_NAME=$PUPPETEER_TEST_USER' >> $BASH_ENV ;;", "originalCommit": "52d70262fcd8e1eba3f0a22c1374c0dcd22cca68", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDI4NTIwNQ==", "url": "https://github.com/all-of-us/workbench/pull/3895#discussion_r474285205", "bodyText": "dev -> test", "author": "calbach", "createdAt": "2020-08-20T21:33:48Z", "path": ".circleci/config.yml", "diffHunk": "@@ -565,21 +579,29 @@ jobs:\n       - manage_api_cache:\n           save: true\n \n-  # Run Puppeteer e2e UI tests on deployed \"test\" environment.\n+  # Run Puppeteer e2e UI tests on deployed \"test\" or \"staging\" environment.\n   puppeteer-e2e-test:\n+    parameters:\n+      env_name:\n+        description: The target environment for run Puppeteer tests. Must be one of \"dev\", \"staging\".\n+        default: \"dev\"\n+        type: enum\n+        enum: [\"dev\", \"staging\"]", "originalCommit": "52d70262fcd8e1eba3f0a22c1374c0dcd22cca68", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "fb9679a90bca08786c88a4186cff3711e2c21e74", "url": "https://github.com/all-of-us/workbench/commit/fb9679a90bca08786c88a4186cff3711e2c21e74", "message": "PR feedback", "committedDate": "2020-08-20T23:39:11Z", "type": "commit"}, {"oid": "e494ddb2e774f8e0db40f04f7c390857fe95e529", "url": "https://github.com/all-of-us/workbench/commit/e494ddb2e774f8e0db40f04f7c390857fe95e529", "message": "minor", "committedDate": "2020-08-21T00:14:54Z", "type": "commit"}, {"oid": "3bfaf8ac597dfd63a7330615d7ed88a114735418", "url": "https://github.com/all-of-us/workbench/commit/3bfaf8ac597dfd63a7330615d7ed88a114735418", "message": "enum value: local", "committedDate": "2020-08-21T01:10:54Z", "type": "commit"}, {"oid": "fdcb08334274e20ac03002156a058599dad94563", "url": "https://github.com/all-of-us/workbench/commit/fdcb08334274e20ac03002156a058599dad94563", "message": "test env", "committedDate": "2020-08-21T02:04:19Z", "type": "commit"}, {"oid": "2ebe39fd1bd17c87ad5bf45be28c3ad3baa39910", "url": "https://github.com/all-of-us/workbench/commit/2ebe39fd1bd17c87ad5bf45be28c3ad3baa39910", "message": "test env", "committedDate": "2020-08-21T02:05:47Z", "type": "commit"}, {"oid": "114358b84b9360aa9f16b85f7dd49a23d2aaab27", "url": "https://github.com/all-of-us/workbench/commit/114358b84b9360aa9f16b85f7dd49a23d2aaab27", "message": "revert test change", "committedDate": "2020-08-21T02:27:16Z", "type": "commit"}, {"oid": "6ec51d73f1c1f7acdd7e70154704f8a7b823be9f", "url": "https://github.com/all-of-us/workbench/commit/6ec51d73f1c1f7acdd7e70154704f8a7b823be9f", "message": "ci testing", "committedDate": "2020-08-21T02:54:58Z", "type": "commit"}, {"oid": "98bae7c827cead9472f74d27a37883fecae6836e", "url": "https://github.com/all-of-us/workbench/commit/98bae7c827cead9472f74d27a37883fecae6836e", "message": "ci testing", "committedDate": "2020-08-21T03:22:31Z", "type": "commit"}, {"oid": "ae5bdcc8e244d5e8e7052242c36c59a35a753474", "url": "https://github.com/all-of-us/workbench/commit/ae5bdcc8e244d5e8e7052242c36c59a35a753474", "message": "ci testing", "committedDate": "2020-08-21T03:23:16Z", "type": "commit"}, {"oid": "376ae18cca4c8793507701666da76a67e97aff20", "url": "https://github.com/all-of-us/workbench/commit/376ae18cca4c8793507701666da76a67e97aff20", "message": "revert", "committedDate": "2020-08-21T03:28:55Z", "type": "commit"}]}