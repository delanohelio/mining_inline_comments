{"pr_number": 4266, "pr_title": "[RW-5591][risk=no] Create runtime panel", "pr_createdAt": "2020-11-09T20:41:17Z", "pr_url": "https://github.com/all-of-us/workbench/pull/4266", "timeline": [{"oid": "ca011bc39063fa43f0a42b9004c947d153df8c9c", "url": "https://github.com/all-of-us/workbench/commit/ca011bc39063fa43f0a42b9004c947d153df8c9c", "message": "create panel", "committedDate": "2020-11-09T20:44:07Z", "type": "commit"}, {"oid": "e91619b4c3459f084559be183cdd6ce25c856568", "url": "https://github.com/all-of-us/workbench/commit/e91619b4c3459f084559be183cdd6ce25c856568", "message": "lint", "committedDate": "2020-11-09T20:44:07Z", "type": "commit"}, {"oid": "cbc2407181bd264343a52b4664281a108f0b5c88", "url": "https://github.com/all-of-us/workbench/commit/cbc2407181bd264343a52b4664281a108f0b5c88", "message": "pretty", "committedDate": "2020-11-09T20:44:07Z", "type": "commit"}, {"oid": "cbc2407181bd264343a52b4664281a108f0b5c88", "url": "https://github.com/all-of-us/workbench/commit/cbc2407181bd264343a52b4664281a108f0b5c88", "message": "pretty", "committedDate": "2020-11-09T20:44:07Z", "type": "forcePushed"}, {"oid": "36bbd16bfeb661f5cdf3dde8ac025022fc546888", "url": "https://github.com/all-of-us/workbench/commit/36bbd16bfeb661f5cdf3dde8ac025022fc546888", "message": "secondarySmall button style", "committedDate": "2020-11-10T14:59:25Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDc4NTU5NA==", "url": "https://github.com/all-of-us/workbench/pull/4266#discussion_r520785594", "bodyText": "nit: && here and below?", "author": "calbach", "createdAt": "2020-11-10T18:41:20Z", "path": "ui/src/app/pages/analysis/runtime-panel.tsx", "diffHunk": "@@ -480,6 +483,113 @@ const CostEstimator = ({\n   </FlexRow>;\n };\n \n+const CreatePanel = ({creatorFreeCreditsRemaining, preset, profile, setPanelContent, workspace}) => {\n+  const {\n+    displayName,\n+    runtimeTemplate: {gceConfig = null, dataprocConfig = null}\n+  } = preset;\n+  const computeType = dataprocConfig ? ComputeType.Dataproc : ComputeType.Standard;\n+  const masterMachineType = computeType === ComputeType.Dataproc ? dataprocConfig.masterMachineType : gceConfig.machineType;\n+  const masterMachine = findMachineByName(masterMachineType);\n+  const masterDiskSize = computeType === ComputeType.Dataproc ? dataprocConfig.masterDiskSize : gceConfig.diskSize;\n+  const workerMachineType = computeType === ComputeType.Dataproc ? dataprocConfig.workerMachineType : null;\n+  const workerMachine = workerMachineType ? findMachineByName(workerMachineType) : null;\n+  const workerDiskSize = computeType === ComputeType.Dataproc ? dataprocConfig.workerDiskSize : null;\n+\n+  return <div style={styles.controlSection}>\n+    <CostEstimator\n+        freeCreditsRemaining={creatorFreeCreditsRemaining}\n+        profile={profile}\n+        runtimeParameters={{\n+          computeType: computeType,\n+          diskSize: gceConfig ? gceConfig.diskSize : null,", "originalCommit": "36bbd16bfeb661f5cdf3dde8ac025022fc546888", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDc4ODYwNQ==", "url": "https://github.com/all-of-us/workbench/pull/4266#discussion_r520788605", "bodyText": "nit: this line should be equivalent to just dataprocConfig", "author": "calbach", "createdAt": "2020-11-10T18:44:57Z", "path": "ui/src/app/pages/analysis/runtime-panel.tsx", "diffHunk": "@@ -480,6 +483,113 @@ const CostEstimator = ({\n   </FlexRow>;\n };\n \n+const CreatePanel = ({creatorFreeCreditsRemaining, preset, profile, setPanelContent, workspace}) => {\n+  const {\n+    displayName,\n+    runtimeTemplate: {gceConfig = null, dataprocConfig = null}\n+  } = preset;\n+  const computeType = dataprocConfig ? ComputeType.Dataproc : ComputeType.Standard;\n+  const masterMachineType = computeType === ComputeType.Dataproc ? dataprocConfig.masterMachineType : gceConfig.machineType;\n+  const masterMachine = findMachineByName(masterMachineType);\n+  const masterDiskSize = computeType === ComputeType.Dataproc ? dataprocConfig.masterDiskSize : gceConfig.diskSize;\n+  const workerMachineType = computeType === ComputeType.Dataproc ? dataprocConfig.workerMachineType : null;\n+  const workerMachine = workerMachineType ? findMachineByName(workerMachineType) : null;\n+  const workerDiskSize = computeType === ComputeType.Dataproc ? dataprocConfig.workerDiskSize : null;\n+\n+  return <div style={styles.controlSection}>\n+    <CostEstimator\n+        freeCreditsRemaining={creatorFreeCreditsRemaining}\n+        profile={profile}\n+        runtimeParameters={{\n+          computeType: computeType,\n+          diskSize: gceConfig ? gceConfig.diskSize : null,\n+          machineType: gceConfig ? gceConfig.machineType : null,\n+          dataprocConfig: dataprocConfig ? dataprocConfig : null", "originalCommit": "36bbd16bfeb661f5cdf3dde8ac025022fc546888", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDc4ODk0Nw==", "url": "https://github.com/all-of-us/workbench/pull/4266#discussion_r520788947", "bodyText": "nit: computeType: computeType, --> computeType,", "author": "calbach", "createdAt": "2020-11-10T18:45:19Z", "path": "ui/src/app/pages/analysis/runtime-panel.tsx", "diffHunk": "@@ -480,6 +483,113 @@ const CostEstimator = ({\n   </FlexRow>;\n };\n \n+const CreatePanel = ({creatorFreeCreditsRemaining, preset, profile, setPanelContent, workspace}) => {\n+  const {\n+    displayName,\n+    runtimeTemplate: {gceConfig = null, dataprocConfig = null}\n+  } = preset;\n+  const computeType = dataprocConfig ? ComputeType.Dataproc : ComputeType.Standard;\n+  const masterMachineType = computeType === ComputeType.Dataproc ? dataprocConfig.masterMachineType : gceConfig.machineType;\n+  const masterMachine = findMachineByName(masterMachineType);\n+  const masterDiskSize = computeType === ComputeType.Dataproc ? dataprocConfig.masterDiskSize : gceConfig.diskSize;\n+  const workerMachineType = computeType === ComputeType.Dataproc ? dataprocConfig.workerMachineType : null;\n+  const workerMachine = workerMachineType ? findMachineByName(workerMachineType) : null;\n+  const workerDiskSize = computeType === ComputeType.Dataproc ? dataprocConfig.workerDiskSize : null;\n+\n+  return <div style={styles.controlSection}>\n+    <CostEstimator\n+        freeCreditsRemaining={creatorFreeCreditsRemaining}\n+        profile={profile}\n+        runtimeParameters={{\n+          computeType: computeType,", "originalCommit": "36bbd16bfeb661f5cdf3dde8ac025022fc546888", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDc5MzE0Mw==", "url": "https://github.com/all-of-us/workbench/pull/4266#discussion_r520793143", "bodyText": "This whole section is bolded?", "author": "calbach", "createdAt": "2020-11-10T18:49:38Z", "path": "ui/src/app/pages/analysis/runtime-panel.tsx", "diffHunk": "@@ -480,6 +483,113 @@ const CostEstimator = ({\n   </FlexRow>;\n };\n \n+const CreatePanel = ({creatorFreeCreditsRemaining, preset, profile, setPanelContent, workspace}) => {\n+  const {\n+    displayName,\n+    runtimeTemplate: {gceConfig = null, dataprocConfig = null}\n+  } = preset;\n+  const computeType = dataprocConfig ? ComputeType.Dataproc : ComputeType.Standard;\n+  const masterMachineType = computeType === ComputeType.Dataproc ? dataprocConfig.masterMachineType : gceConfig.machineType;\n+  const masterMachine = findMachineByName(masterMachineType);\n+  const masterDiskSize = computeType === ComputeType.Dataproc ? dataprocConfig.masterDiskSize : gceConfig.diskSize;\n+  const workerMachineType = computeType === ComputeType.Dataproc ? dataprocConfig.workerMachineType : null;\n+  const workerMachine = workerMachineType ? findMachineByName(workerMachineType) : null;\n+  const workerDiskSize = computeType === ComputeType.Dataproc ? dataprocConfig.workerDiskSize : null;\n+\n+  return <div style={styles.controlSection}>\n+    <CostEstimator\n+        freeCreditsRemaining={creatorFreeCreditsRemaining}\n+        profile={profile}\n+        runtimeParameters={{\n+          computeType: computeType,\n+          diskSize: gceConfig ? gceConfig.diskSize : null,\n+          machineType: gceConfig ? gceConfig.machineType : null,\n+          dataprocConfig: dataprocConfig ? dataprocConfig : null\n+        }}\n+        runtimeChanged={false}\n+        workspace={workspace}\n+    />\n+    <FlexRow style={{justifyContent: 'space-between', alignItems: 'center'}}>\n+      <h3 style={{...styles.sectionHeader, ...styles.bold}}>Recommended Environment for {displayName}</h3>\n+      <Button\n+          type='secondarySmall'\n+          onClick={() => setPanelContent(PanelContent.Customize)}\n+      >\n+        Customize\n+      </Button>\n+    </FlexRow>\n+    <label htmlFor='compute-resources' style={{...styles.bold, marginTop: '1rem'}}>Compute Resources</label>\n+    <div id='compute-resources'>- Default: compute size of\n+      <b> {masterMachine.cpu} CPUs</b>,\n+      <b> {masterMachine.memory} GB memory</b>, and a\n+      <b> {masterDiskSize} GB disk</b>\n+    </div>\n+    {computeType === ComputeType.Dataproc && <Fragment>\n+      <label htmlFor='worker-configuration' style={{...styles.bold, marginTop: '1rem'}}>Worker Configuration</label>\n+      <div id='worker-configuration'>- Default:\n+        <b> {dataprocConfig.numberOfWorkers} worker(s)</b>\n+        {!dataprocConfig.numberOfPreemptibleWorkers && <Fragment>, </Fragment>}\n+        <b>", "originalCommit": "36bbd16bfeb661f5cdf3dde8ac025022fc546888", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjM3NzI5NQ==", "url": "https://github.com/all-of-us/workbench/pull/4266#discussion_r522377295", "bodyText": "The comma actually shouldn't be, but the rest should", "author": "als364", "createdAt": "2020-11-12T19:46:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDc5MzE0Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjM4MTYyMg==", "url": "https://github.com/all-of-us/workbench/pull/4266#discussion_r522381622", "bodyText": "I really don't think \"each with compute size of\" should be bolded, it's not dynamic content. If you prefer a consistency argument instead, you can also just look at the treatment of General Analysis, where \"compute size of\" is unbolded.", "author": "calbach", "createdAt": "2020-11-12T19:53:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDc5MzE0Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjM4NDE4Ng==", "url": "https://github.com/all-of-us/workbench/pull/4266#discussion_r522384186", "bodyText": "Oh, good point!", "author": "als364", "createdAt": "2020-11-12T19:58:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDc5MzE0Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDc5NDQ4MA==", "url": "https://github.com/all-of-us/workbench/pull/4266#discussion_r520794480", "bodyText": "I don't think we should need a comma before \"each with a compute size\" - would drop this", "author": "calbach", "createdAt": "2020-11-10T18:51:07Z", "path": "ui/src/app/pages/analysis/runtime-panel.tsx", "diffHunk": "@@ -480,6 +483,113 @@ const CostEstimator = ({\n   </FlexRow>;\n };\n \n+const CreatePanel = ({creatorFreeCreditsRemaining, preset, profile, setPanelContent, workspace}) => {\n+  const {\n+    displayName,\n+    runtimeTemplate: {gceConfig = null, dataprocConfig = null}\n+  } = preset;\n+  const computeType = dataprocConfig ? ComputeType.Dataproc : ComputeType.Standard;\n+  const masterMachineType = computeType === ComputeType.Dataproc ? dataprocConfig.masterMachineType : gceConfig.machineType;\n+  const masterMachine = findMachineByName(masterMachineType);\n+  const masterDiskSize = computeType === ComputeType.Dataproc ? dataprocConfig.masterDiskSize : gceConfig.diskSize;\n+  const workerMachineType = computeType === ComputeType.Dataproc ? dataprocConfig.workerMachineType : null;\n+  const workerMachine = workerMachineType ? findMachineByName(workerMachineType) : null;\n+  const workerDiskSize = computeType === ComputeType.Dataproc ? dataprocConfig.workerDiskSize : null;\n+\n+  return <div style={styles.controlSection}>\n+    <CostEstimator\n+        freeCreditsRemaining={creatorFreeCreditsRemaining}\n+        profile={profile}\n+        runtimeParameters={{\n+          computeType: computeType,\n+          diskSize: gceConfig ? gceConfig.diskSize : null,\n+          machineType: gceConfig ? gceConfig.machineType : null,\n+          dataprocConfig: dataprocConfig ? dataprocConfig : null\n+        }}\n+        runtimeChanged={false}\n+        workspace={workspace}\n+    />\n+    <FlexRow style={{justifyContent: 'space-between', alignItems: 'center'}}>\n+      <h3 style={{...styles.sectionHeader, ...styles.bold}}>Recommended Environment for {displayName}</h3>\n+      <Button\n+          type='secondarySmall'\n+          onClick={() => setPanelContent(PanelContent.Customize)}\n+      >\n+        Customize\n+      </Button>\n+    </FlexRow>\n+    <label htmlFor='compute-resources' style={{...styles.bold, marginTop: '1rem'}}>Compute Resources</label>\n+    <div id='compute-resources'>- Default: compute size of\n+      <b> {masterMachine.cpu} CPUs</b>,\n+      <b> {masterMachine.memory} GB memory</b>, and a\n+      <b> {masterDiskSize} GB disk</b>\n+    </div>\n+    {computeType === ComputeType.Dataproc && <Fragment>\n+      <label htmlFor='worker-configuration' style={{...styles.bold, marginTop: '1rem'}}>Worker Configuration</label>\n+      <div id='worker-configuration'>- Default:\n+        <b> {dataprocConfig.numberOfWorkers} worker(s)</b>\n+        {!dataprocConfig.numberOfPreemptibleWorkers && <Fragment>, </Fragment>}", "originalCommit": "36bbd16bfeb661f5cdf3dde8ac025022fc546888", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDc5OTQwNA==", "url": "https://github.com/all-of-us/workbench/pull/4266#discussion_r520799404", "bodyText": "I don't think this is ever the correct thing to show initially, would just remove this from the switch. If you need a default, Customize is probably most appropriate", "author": "calbach", "createdAt": "2020-11-10T18:56:21Z", "path": "ui/src/app/pages/analysis/runtime-panel.tsx", "diffHunk": "@@ -499,7 +609,12 @@ export const RuntimePanel = fp.flow(\n   const initialMasterMachine = findMachineByName(machineName) || defaultMachineType;\n   const initialCompute = dataprocConfig ? ComputeType.Dataproc : ComputeType.Standard;\n   // TODO(RW-5591): Initialize PanelContent according to the runtime status.\n-  const [panelContent, setPanelContent] = useState<PanelContent>(PanelContent.Customize);\n+  const initialPanelContent = fp.cond([\n+    [(s) => s === RuntimeStatus.Running || s === RuntimeStatus.Stopped, () => PanelContent.Customize],\n+    [(s) => s === null || s === RuntimeStatus.Unknown, () => PanelContent.Create],\n+    [() => true, () => PanelContent.Delete]", "originalCommit": "36bbd16bfeb661f5cdf3dde8ac025022fc546888", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDgxMDIwOA==", "url": "https://github.com/all-of-us/workbench/pull/4266#discussion_r520810208", "bodyText": "So initially I thought this might work, but I'm less sure as I understand more about hooks. My updated understanding is that this only works if the runtime store has already been populated by the time the user renders the panel contents. In most cases, this will be true, but I don't think it's guaranteed.", "author": "calbach", "createdAt": "2020-11-10T19:10:57Z", "path": "ui/src/app/pages/analysis/runtime-panel.tsx", "diffHunk": "@@ -499,7 +609,12 @@ export const RuntimePanel = fp.flow(\n   const initialMasterMachine = findMachineByName(machineName) || defaultMachineType;\n   const initialCompute = dataprocConfig ? ComputeType.Dataproc : ComputeType.Standard;\n   // TODO(RW-5591): Initialize PanelContent according to the runtime status.", "originalCommit": "36bbd16bfeb661f5cdf3dde8ac025022fc546888", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjQyNDE5MQ==", "url": "https://github.com/all-of-us/workbench/pull/4266#discussion_r522424191", "bodyText": "Sorry, what do you mean by 'this'? Inspecting the runtime status?", "author": "als364", "createdAt": "2020-11-12T21:02:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDgxMDIwOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjQyOTYzNw==", "url": "https://github.com/all-of-us/workbench/pull/4266#discussion_r522429637", "bodyText": "The thing you did here and which is outlined in this TODO, which is to pick initialPanelContent based on the incoming runtime. The initial value of a hook is only relevant to the first time this component gets rendered - if the runtime is undefined at that point (still loading), that dictates the initial value.", "author": "calbach", "createdAt": "2020-11-12T21:13:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDgxMDIwOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjQ0MDcwOQ==", "url": "https://github.com/all-of-us/workbench/pull/4266#discussion_r522440709", "bodyText": "Given the inability to rely on currentRuntime, do you think it's worth trying to do another useEffect that updates the panel content when the runtime status is updated, or should I just set reasonable defaults based on the initial state of currentRuntime and let the user click through to the customize page if they need to?", "author": "als364", "createdAt": "2020-11-12T21:35:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDgxMDIwOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjQ3NjAyMg==", "url": "https://github.com/all-of-us/workbench/pull/4266#discussion_r522476022", "bodyText": "It's probably easiest to just show the Customize page in this case as the initial page, if it's still loading. Showing the create page will be confusing if you already have an active runtime.\nThe useEffect approach I think is also possible, but would be complicated since you'll have to make sure it would run only once. Probably you'd need to introduce some loading state or PanelContent.Loading type, then useEffect transition based on runtime becoming !== undefined.\nI would just go with the simple approach of defaulting to Customize for now and leave a comment explaining the current state of things (please also remove this TODO line). We can revisit if this race condition winds up being more common than I'm expecting it to be.", "author": "calbach", "createdAt": "2020-11-12T22:36:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDgxMDIwOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzA2Mzk3Mw==", "url": "https://github.com/all-of-us/workbench/pull/4266#discussion_r523063973", "bodyText": "I think that would result in this Create page never being shown - we can't currently differentiate between getRuntime having not yet returned and getRuntime having returned nothing.", "author": "als364", "createdAt": "2020-11-13T16:32:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDgxMDIwOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzE3NDIxOA==", "url": "https://github.com/all-of-us/workbench/pull/4266#discussion_r523174218", "bodyText": "Ok, I think I am slightly wrong, and that currentRuntime will be undefined when getRuntime has not returned for the first time and it will be null if getRuntime 404s.", "author": "als364", "createdAt": "2020-11-13T19:22:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDgxMDIwOA=="}], "type": "inlineReview"}, {"oid": "e313ade69906e49e75cb5159562b0323441cb010", "url": "https://github.com/all-of-us/workbench/commit/e313ade69906e49e75cb5159562b0323441cb010", "message": "most review comments", "committedDate": "2020-11-12T21:43:31Z", "type": "commit"}, {"oid": "13e733c87341f154ff1d4efc35b761039cd0fb89", "url": "https://github.com/all-of-us/workbench/commit/13e733c87341f154ff1d4efc35b761039cd0fb89", "message": "close after create", "committedDate": "2020-11-13T18:29:31Z", "type": "commit"}, {"oid": "727ad0e2d484d77a8cdcb74c03ac1eaf933cb14a", "url": "https://github.com/all-of-us/workbench/commit/727ad0e2d484d77a8cdcb74c03ac1eaf933cb14a", "message": "unbreak tests", "committedDate": "2020-11-13T18:41:49Z", "type": "commit"}, {"oid": "c7005893b50a800b18aad74df81e0738b6673abf", "url": "https://github.com/all-of-us/workbench/commit/c7005893b50a800b18aad74df81e0738b6673abf", "message": "handle undefined", "committedDate": "2020-11-13T19:23:39Z", "type": "commit"}, {"oid": "18153ee73a0812082c4429f86ae49508c84998e1", "url": "https://github.com/all-of-us/workbench/commit/18153ee73a0812082c4429f86ae49508c84998e1", "message": "oy gevalt", "committedDate": "2020-11-13T19:54:15Z", "type": "commit"}, {"oid": "33798997b68c76d4cbae0754cfaa72e658bd9548", "url": "https://github.com/all-of-us/workbench/commit/33798997b68c76d4cbae0754cfaa72e658bd9548", "message": "and a test", "committedDate": "2020-11-13T20:14:50Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDQ1ODU3Ng==", "url": "https://github.com/all-of-us/workbench/pull/4266#discussion_r524458576", "bodyText": "Is there a test that actually clicks the create button on the create panel? This would be good to have", "author": "calbach", "createdAt": "2020-11-16T17:48:01Z", "path": "ui/src/app/pages/analysis/runtime-panel.spec.tsx", "diffHunk": "@@ -115,6 +124,19 @@ describe('RuntimePanel', () => {\n     expect(!wrapper.exists(Spinner));\n   });\n \n+  it('should show Create panel when no runtime', async() => {", "originalCommit": "33798997b68c76d4cbae0754cfaa72e658bd9548", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDQ3MDA4Mw==", "url": "https://github.com/all-of-us/workbench/pull/4266#discussion_r524470083", "bodyText": "The should allow creation when no runtime exists with defaults test does this.", "author": "als364", "createdAt": "2020-11-16T18:06:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDQ1ODU3Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDQ3MTcyMg==", "url": "https://github.com/all-of-us/workbench/pull/4266#discussion_r524471722", "bodyText": "Ah, nice - I see it now. Thanks.", "author": "calbach", "createdAt": "2020-11-16T18:08:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDQ1ODU3Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDQ2NzI4NQ==", "url": "https://github.com/all-of-us/workbench/pull/4266#discussion_r524467285", "bodyText": "nit: I feel it might be a cleaner separation to replace these constituent properties with disabled and label (disabled could default to false). This way you don't leave any opportunity for bugs where the button is potentially grayed out on the creation panel (create panel would just be a simple hardcoded 'Create'), and it pushed most of the hairy business logic into the customize panel where it belongs.", "author": "calbach", "createdAt": "2020-11-16T18:01:38Z", "path": "ui/src/app/pages/analysis/runtime-panel.tsx", "diffHunk": "@@ -480,11 +484,116 @@ const CostEstimator = ({\n   </FlexRow>;\n };\n \n+const CreatePanel = ({creatorFreeCreditsRemaining, preset, profile, setPanelContent, workspace}) => {\n+  const {\n+    displayName,\n+    runtimeTemplate: {gceConfig = null, dataprocConfig = null}\n+  } = preset;\n+  const computeType = dataprocConfig ? ComputeType.Dataproc : ComputeType.Standard;\n+  const masterMachineType = computeType === ComputeType.Dataproc ? dataprocConfig.masterMachineType : gceConfig.machineType;\n+  const masterMachine = findMachineByName(masterMachineType);\n+  const masterDiskSize = computeType === ComputeType.Dataproc ? dataprocConfig.masterDiskSize : gceConfig.diskSize;\n+  const workerMachineType = computeType === ComputeType.Dataproc ? dataprocConfig.workerMachineType : null;\n+  const workerMachine = workerMachineType ? findMachineByName(workerMachineType) : null;\n+  const workerDiskSize = computeType === ComputeType.Dataproc ? dataprocConfig.workerDiskSize : null;\n+\n+  return <div style={styles.controlSection}>\n+    <CostEstimator\n+        freeCreditsRemaining={creatorFreeCreditsRemaining}\n+        profile={profile}\n+        runtimeParameters={{\n+          computeType,\n+          diskSize: gceConfig && gceConfig.diskSize,\n+          machineType: gceConfig && gceConfig.machineType,\n+          dataprocConfig: dataprocConfig\n+        }}\n+        runtimeChanged={false}\n+        workspace={workspace}\n+    />\n+    <FlexRow style={{justifyContent: 'space-between', alignItems: 'center'}}>\n+      <h3 style={{...styles.sectionHeader, ...styles.bold}}>Recommended Environment for {displayName}</h3>\n+      <Button\n+          type='secondarySmall'\n+          onClick={() => setPanelContent(PanelContent.Customize)}\n+          aria-label='Customize'\n+      >\n+        Customize\n+      </Button>\n+    </FlexRow>\n+    <label htmlFor='compute-resources' style={{...styles.bold, marginTop: '1rem'}}>Compute Resources</label>\n+    <div id='compute-resources'>- Default: compute size of\n+      <b> {masterMachine.cpu} CPUs</b>,\n+      <b> {masterMachine.memory} GB memory</b>, and a\n+      <b> {masterDiskSize} GB disk</b>\n+    </div>\n+    {computeType === ComputeType.Dataproc && <Fragment>\n+      <label htmlFor='worker-configuration' style={{...styles.bold, marginTop: '1rem'}}>Worker Configuration</label>\n+      <div id='worker-configuration'>- Default:\n+        <b> {dataprocConfig.numberOfWorkers} worker(s) </b>\n+        {\n+          dataprocConfig.numberOfPreemptibleWorkers > 0 &&\n+          <b>and {dataprocConfig.numberOfPreemptibleWorkers}  preemptible worker(s) </b>\n+        }\n+        each with compute size of <b>{workerMachine.cpu} CPUs</b>,\n+        <b> {workerMachine.memory} GB memory</b>, and a\n+        <b> {workerDiskSize} GB disk</b>\n+      </div>\n+    </Fragment>}\n+  </div>;\n+};\n+\n+const UpdateRuntimeButton = ({\n+   closePanel,\n+   runtimeExists,", "originalCommit": "33798997b68c76d4cbae0754cfaa72e658bd9548", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDQ3MDM3MA==", "url": "https://github.com/all-of-us/workbench/pull/4266#discussion_r524470370", "bodyText": "Good call, will do.", "author": "als364", "createdAt": "2020-11-16T18:06:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDQ2NzI4NQ=="}], "type": "inlineReview"}, {"oid": "ae5fd2233bad254b851bc80a80b1170b26e8dab4", "url": "https://github.com/all-of-us/workbench/commit/ae5fd2233bad254b851bc80a80b1170b26e8dab4", "message": "last comments", "committedDate": "2020-11-16T18:21:29Z", "type": "commit"}, {"oid": "4ea3d7c117ab0430cfc673dc6c422677310bea45", "url": "https://github.com/all-of-us/workbench/commit/4ea3d7c117ab0430cfc673dc6c422677310bea45", "message": "gevalt", "committedDate": "2020-11-16T18:36:18Z", "type": "commit"}]}