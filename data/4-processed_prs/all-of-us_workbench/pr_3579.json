{"pr_number": 3579, "pr_title": "[risk=moderate][RW-4972] Change checkEmail endpoint from GET to POST with email body", "pr_createdAt": "2020-05-12T23:29:42Z", "pr_url": "https://github.com/all-of-us/workbench/pull/3579", "timeline": [{"oid": "3627f7ef0aa1ea5719a4e2d14b755f373a119207", "url": "https://github.com/all-of-us/workbench/commit/3627f7ef0aa1ea5719a4e2d14b755f373a119207", "message": "new POST endpoint for checkEmail", "committedDate": "2020-05-12T23:29:02Z", "type": "commit"}, {"oid": "6974c23f8a37ee8c2707f6c3defd6e06404adcff", "url": "https://github.com/all-of-us/workbench/commit/6974c23f8a37ee8c2707f6c3defd6e06404adcff", "message": "use an object to avoid JSON/Swagger string problems", "committedDate": "2020-05-12T23:29:02Z", "type": "commit"}, {"oid": "426ea9fd11556d9948779a981c24e0cb24a9b4ee", "url": "https://github.com/all-of-us/workbench/commit/426ea9fd11556d9948779a981c24e0cb24a9b4ee", "message": "lint", "committedDate": "2020-05-12T23:29:03Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDQ4MTEwOQ==", "url": "https://github.com/all-of-us/workbench/pull/3579#discussion_r424481109", "bodyText": "I would prefer to use type: string here but something gets lost in translation.  The Typescript wrapper adds double quotes to the string it passes to the endpoint (so, a valid JSON String) but the Java endpoint here treats the JSON String as a Java String without parsing the quotes away.\nAn alternative solution would be to manually strip the quotes.  But that feels too reliant on Swagger implementation so I'd be concerned that this might change with an upgrade.", "author": "jmthibault79", "createdAt": "2020-05-13T14:26:50Z", "path": "api/src/main/resources/workbench-api.yaml", "diffHunk": "@@ -2341,25 +2341,58 @@ paths:\n           description: The updated Institution.\n           schema:\n             \"$ref\": \"#/definitions/Institution\"\n-  \"/v1/institutions/{shortName}/checkEmail/{email}/\":\n+  \"/v1/institutions/{shortName}/checkEmail\":\n     parameters:\n     - in: path\n       name: shortName\n       type: string\n       description: 'The short name / key of the institution to check, e.g. \"VUMC\"'\n       required: true\n-    - in: path\n-      name: email\n-      type: string\n-      description: Institutional contact email address to check.\n-      required: true\n-    get:\n+    post:\n       tags:\n         - institution\n       operationId: checkEmail\n       description: Checks whether the given email address is a verified member of an institution.\n       x-aou-note: This endpoint is publicly-accessible and called by clients during user registration.\n       security: []\n+      parameters:\n+      - in: body\n+        name: contactEmail\n+        description: Institutional contact email address to check.\n+        required: true\n+        schema:\n+          type: object", "originalCommit": "426ea9fd11556d9948779a981c24e0cb24a9b4ee", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDQ5MDEwNA==", "url": "https://github.com/all-of-us/workbench/pull/3579#discussion_r424490104", "bodyText": "Yeah, I'm not too surprised there's weirdness in trying to have a bare string for a POST body. I think what you've done is the best approach, just go with the flow and make it a simple JSON object.\n[opt] The vast majority of our in: body definitions have a named schema: $ref. For consistency & explicitness, I'd recommend creating a CheckEmailRequest object here rather than inlining the schema.", "author": "gjuggler", "createdAt": "2020-05-13T14:38:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDQ4MTEwOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDUxNTU1MQ==", "url": "https://github.com/all-of-us/workbench/pull/3579#discussion_r424515551", "bodyText": "ok", "author": "jmthibault79", "createdAt": "2020-05-13T15:10:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDQ4MTEwOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDQ4NDgyOA==", "url": "https://github.com/all-of-us/workbench/pull/3579#discussion_r424484828", "bodyText": "keeping the old endpoint so as not to immediately break anything reliant on it.  https://precisionmedicineinitiative.atlassian.net/browse/RW-4948 removes it.", "author": "jmthibault79", "createdAt": "2020-05-13T14:31:38Z", "path": "api/src/main/resources/workbench-api.yaml", "diffHunk": "@@ -2341,25 +2341,58 @@ paths:\n           description: The updated Institution.\n           schema:\n             \"$ref\": \"#/definitions/Institution\"\n-  \"/v1/institutions/{shortName}/checkEmail/{email}/\":\n+  \"/v1/institutions/{shortName}/checkEmail\":\n     parameters:\n     - in: path\n       name: shortName\n       type: string\n       description: 'The short name / key of the institution to check, e.g. \"VUMC\"'\n       required: true\n-    - in: path\n-      name: email\n-      type: string\n-      description: Institutional contact email address to check.\n-      required: true\n-    get:\n+    post:\n       tags:\n         - institution\n       operationId: checkEmail\n       description: Checks whether the given email address is a verified member of an institution.\n       x-aou-note: This endpoint is publicly-accessible and called by clients during user registration.\n       security: []\n+      parameters:\n+      - in: body\n+        name: contactEmail\n+        description: Institutional contact email address to check.\n+        required: true\n+        schema:\n+          type: object\n+          required:\n+            - value\n+          properties:\n+            value:\n+              type: string\n+              description: Institutional contact email address to check.\n+\n+      responses:\n+        200:\n+          description: Whether the email is a valid member of the institution.\n+          schema:\n+            \"$ref\": \"#/definitions/CheckEmailResponse\"\n+  \"/v1/institutions/{shortName}/checkEmail/{email}/\":", "originalCommit": "426ea9fd11556d9948779a981c24e0cb24a9b4ee", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDQ5NTIyMA==", "url": "https://github.com/all-of-us/workbench/pull/3579#discussion_r424495220", "bodyText": "Nice approach! I appreciate the attention to detail (and I'm sure Alex does too).", "author": "gjuggler", "createdAt": "2020-05-13T14:44:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDQ4NDgyOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDQ4NTQ0NA==", "url": "https://github.com/all-of-us/workbench/pull/3579#discussion_r424485444", "bodyText": "Swagger generated this class for us without asking.  neat!", "author": "jmthibault79", "createdAt": "2020-05-13T14:32:27Z", "path": "ui/src/testing/stubs/institution-api-stub.ts", "diffHunk": "@@ -1,5 +1,6 @@\n import {\n   CheckEmailResponse,\n+  ContactEmail,", "originalCommit": "426ea9fd11556d9948779a981c24e0cb24a9b4ee", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDQ4Njc1NQ==", "url": "https://github.com/all-of-us/workbench/pull/3579#discussion_r424486755", "bodyText": "If we find a way to make type: string work in Swagger, we wouldn't need to change UI code at all.", "author": "jmthibault79", "createdAt": "2020-05-13T14:34:04Z", "path": "ui/src/app/pages/login/account-creation/account-creation-institution.tsx", "diffHunk": "@@ -170,8 +170,7 @@ export class AccountCreationInstitution extends React.Component<Props, State> {\n     }\n \n     try {\n-      const result = await institutionApi().checkEmail(institutionShortName, contactEmail,\n-        {signal: this.aborter.signal});\n+      const result = await institutionApi().checkEmail(institutionShortName, {value: contactEmail}, {signal: this.aborter.signal});", "originalCommit": "426ea9fd11556d9948779a981c24e0cb24a9b4ee", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "0866c23ca7a94e3a7634d7b1e46b22b32233ae36", "url": "https://github.com/all-of-us/workbench/commit/0866c23ca7a94e3a7634d7b1e46b22b32233ae36", "message": "Add email validation logging", "committedDate": "2020-05-13T15:09:23Z", "type": "commit"}, {"oid": "83bfb3949e127760c84c73c445996218716a2972", "url": "https://github.com/all-of-us/workbench/commit/83bfb3949e127760c84c73c445996218716a2972", "message": "CheckEmailRequest", "committedDate": "2020-05-13T15:25:16Z", "type": "commit"}]}