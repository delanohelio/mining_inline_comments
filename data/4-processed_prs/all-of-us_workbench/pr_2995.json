{"pr_number": 2995, "pr_title": "[risk=low][RW-4178] Prevent compute cost increasing API calls on billing inactive workspaces", "pr_createdAt": "2020-01-10T21:15:23Z", "pr_url": "https://github.com/all-of-us/workbench/pull/2995", "timeline": [{"oid": "e807b3eeb48ebe5d1082b0518ba99a12c19a5636", "url": "https://github.com/all-of-us/workbench/commit/e807b3eeb48ebe5d1082b0518ba99a12c19a5636", "message": "add compute tags", "committedDate": "2020-01-03T22:24:10Z", "type": "commit"}, {"oid": "bfaa40003e92913f3cd82178247749a5bf97a08e", "url": "https://github.com/all-of-us/workbench/commit/bfaa40003e92913f3cd82178247749a5bf97a08e", "message": "allow some more actions", "committedDate": "2020-01-03T22:33:15Z", "type": "commit"}, {"oid": "00cb819eb2bd4fef66175763b5c46a1d04e7a3c9", "url": "https://github.com/all-of-us/workbench/commit/00cb819eb2bd4fef66175763b5c46a1d04e7a3c9", "message": "add invalid billing checks", "committedDate": "2020-01-06T22:59:27Z", "type": "commit"}, {"oid": "8a5e071ab277000db7f608598360a7a62f434b25", "url": "https://github.com/all-of-us/workbench/commit/8a5e071ab277000db7f608598360a7a62f434b25", "message": "spotless", "committedDate": "2020-01-06T23:01:09Z", "type": "commit"}, {"oid": "c02fe25be66fa3dd6734b552cc76bd36b3164c56", "url": "https://github.com/all-of-us/workbench/commit/c02fe25be66fa3dd6734b552cc76bd36b3164c56", "message": "better error msg", "committedDate": "2020-01-08T21:47:04Z", "type": "commit"}, {"oid": "9d2c60e889c1ab4b9bbca50d8e1334f708442871", "url": "https://github.com/all-of-us/workbench/commit/9d2c60e889c1ab4b9bbca50d8e1334f708442871", "message": "WIP: checkpoint", "committedDate": "2020-01-09T22:45:21Z", "type": "commit"}, {"oid": "2d8e90e5f5713849f0943bc76e5a8d6b5de985ce", "url": "https://github.com/all-of-us/workbench/commit/2d8e90e5f5713849f0943bc76e5a8d6b5de985ce", "message": "add tests and refactor into common function", "committedDate": "2020-01-10T18:40:29Z", "type": "commit"}, {"oid": "b1e0d6da6f34c84c2e8a2431f8f3c97da7396823", "url": "https://github.com/all-of-us/workbench/commit/b1e0d6da6f34c84c2e8a2431f8f3c97da7396823", "message": "spotless", "committedDate": "2020-01-10T19:16:14Z", "type": "commit"}, {"oid": "3de2b82e0cb06f8a4d94d16e5b1e1640a2946e86", "url": "https://github.com/all-of-us/workbench/commit/3de2b82e0cb06f8a4d94d16e5b1e1640a2946e86", "message": "revert * imports", "committedDate": "2020-01-10T19:25:35Z", "type": "commit"}, {"oid": "102da6593cc3147c22d59420f286f67607651f03", "url": "https://github.com/all-of-us/workbench/commit/102da6593cc3147c22d59420f286f67607651f03", "message": "spotless", "committedDate": "2020-01-10T19:25:49Z", "type": "commit"}, {"oid": "21caeeabd5852011e69a9978dc7026fb96964bd2", "url": "https://github.com/all-of-us/workbench/commit/21caeeabd5852011e69a9978dc7026fb96964bd2", "message": "throw NotFoundException on invalid parameters", "committedDate": "2020-01-10T21:02:43Z", "type": "commit"}, {"oid": "82e90d14adda3ac45e0a2073119167b0c7feebcb", "url": "https://github.com/all-of-us/workbench/commit/82e90d14adda3ac45e0a2073119167b0c7feebcb", "message": "change exception message", "committedDate": "2020-01-10T21:16:51Z", "type": "commit"}, {"oid": "e67431fd19335ee3aa05d229b60190bd8cfc36e2", "url": "https://github.com/all-of-us/workbench/commit/e67431fd19335ee3aa05d229b60190bd8cfc36e2", "message": "Merge branch 'master' of github.com:all-of-us/workbench into songe/RW-4178", "committedDate": "2020-01-10T21:32:35Z", "type": "commit"}, {"oid": "f8a42f024b7079f7ec2e9bfa7ec46b98c69173d9", "url": "https://github.com/all-of-us/workbench/commit/f8a42f024b7079f7ec2e9bfa7ec46b98c69173d9", "message": "add feature flag", "committedDate": "2020-01-10T22:06:14Z", "type": "commit"}, {"oid": "4a48daf446c87cc83a0706756b7198df09dacdad", "url": "https://github.com/all-of-us/workbench/commit/4a48daf446c87cc83a0706756b7198df09dacdad", "message": "ws", "committedDate": "2020-01-10T22:07:49Z", "type": "commit"}, {"oid": "845c53d2390923439d181294d4d6d06830bf25f2", "url": "https://github.com/all-of-us/workbench/commit/845c53d2390923439d181294d4d6d06830bf25f2", "message": "ws", "committedDate": "2020-01-10T22:09:07Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTQ3MzQ4MA==", "url": "https://github.com/all-of-us/workbench/pull/2995#discussion_r365473480", "bodyText": "These checks should follow the access check, else this reveals some amount of information about existence of the workspace and its billing status, to any caller. In the cases where there is no explicit access check happening in the controller method, it would be probably be correct to add one - or else push this logic down into the service which is probably making that check. If this gets too hairy, I could probably be convinced it's not worth the effort for some of these without heavier refactoring.", "author": "calbach", "createdAt": "2020-01-10T23:46:52Z", "path": "api/src/main/java/org/pmiops/workbench/api/DataSetController.java", "diffHunk": "@@ -438,6 +438,8 @@ private void formatTimestampValues(List<DataSetPreviewValueList> valuePreviewLis\n   @Override\n   public ResponseEntity<EmptyResponse> exportToNotebook(\n       String workspaceNamespace, String workspaceId, DataSetExportRequest dataSetExportRequest) {\n+    workspaceService.requireActiveBilling(workspaceNamespace, workspaceId);", "originalCommit": "845c53d2390923439d181294d4d6d06830bf25f2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTUzMjc2Mw==", "url": "https://github.com/all-of-us/workbench/pull/2995#discussion_r365532763", "bodyText": "The need to add code to a number methods in just the right place makes me think we've missed an abstraction/opportunity to have something more systematic in place. Maybe a shim in between the ApiDelegate class and the Controller would be a good place to stick these validation methods generically.\nWhat's here is probably enough/appropriate for now to avoid scope creep, but if we need multiple overlapping kinds of checks soon, it could get unwieldy.", "author": "jaycarlton", "createdAt": "2020-01-11T17:30:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTQ3MzQ4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTYwODg3NA==", "url": "https://github.com/all-of-us/workbench/pull/2995#discussion_r365608874", "bodyText": "I was able to correctly order the access checks by pushing down the validate call to the underlying copy notebook function which performs the workspace access check. One side effect of this change, is that Rename Notebook will no longer be allowed since rename works by copying the original and then deleting it.\nGiven that we were unsure if Rename should be allowed or not, I thought it would be OK to not allow it if it makes the implementation easier.\nAnother note to Jay's point, this refactoring went in a direction of checking access at the point where we perform the relevant action instead of checking it at the top of the controller methods. It's a design that he brought up a while ago and I think that may be the way to go if we need to add more access control. It is going to be difficult to have to fully understand what an API call is going to do and declare the necessary permissions.\nOne downside to that approach though, is that our access control checks can be expensive (if we ask Firecloud) so we do not want to be calling it multiple times in a single client serving API call. One solution to this may be to add some caching mechanism that exists for the duration of a client serving API call so that we can add access control checks at various points without worrying about performance.", "author": "ericsong", "createdAt": "2020-01-12T20:36:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTQ3MzQ4MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTQ3NDgwMw==", "url": "https://github.com/all-of-us/workbench/pull/2995#discussion_r365474803", "bodyText": "this is potentially ambiguous, should this include the workspace ID in the message? Alternatively this method could return bool and the controller could throw a contextually relevant message.", "author": "calbach", "createdAt": "2020-01-10T23:55:04Z", "path": "api/src/main/java/org/pmiops/workbench/workspaces/WorkspaceServiceImpl.java", "diffHunk": "@@ -243,6 +248,19 @@ public DbWorkspace getRequiredWithCohorts(String ns, String firecloudName) {\n     return workspace;\n   }\n \n+  @Override\n+  public void requireActiveBilling(String workspaceNamespace, String workspaceId)\n+      throws ForbiddenException {\n+    if (!workbenchConfigProvider.get().featureFlags.enableBillingLockout) {\n+      return;\n+    }\n+\n+    if (BillingStatus.INACTIVE.equals(\n+        getRequired(workspaceNamespace, workspaceId).getBillingStatus())) {\n+      throw new ForbiddenException(\"Workspace is in an inactive billing state\");", "originalCommit": "845c53d2390923439d181294d4d6d06830bf25f2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTQ3NTEwMg==", "url": "https://github.com/all-of-us/workbench/pull/2995#discussion_r365475102", "bodyText": "nit: I think we should keep local and test in sync typically. I don't feel strongly about both true or both false", "author": "calbach", "createdAt": "2020-01-10T23:56:45Z", "path": "api/config/config_local.json", "diffHunk": "@@ -85,7 +85,8 @@\n     \"unsafeAllowDeleteUser\": true,\n     \"enableVpcFlowLogs\": true,\n     \"enableVpcServicePerimeter\": true,\n-    \"enableNewAccountCreation\": true\n+    \"enableNewAccountCreation\": true,\n+    \"enableBillingLockout\": true", "originalCommit": "845c53d2390923439d181294d4d6d06830bf25f2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTUzMjU0Mw==", "url": "https://github.com/all-of-us/workbench/pull/2995#discussion_r365532543", "bodyText": "aside: is it too late to rename enableNewAccountCreation? It's really talking about a revised flow, not enabling people to create new accounts altogether?", "author": "jaycarlton", "createdAt": "2020-01-11T17:26:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTQ3NTEwMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTU2MDQ1OQ==", "url": "https://github.com/all-of-us/workbench/pull/2995#discussion_r365560459", "bodyText": "I think the word New always referred to a \"new\" version of account creation. I do agree the name isn't the best but I don't think its something worth the hassle of changing, at least in an unrelated PR.", "author": "ericsong", "createdAt": "2020-01-12T06:19:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTQ3NTEwMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTYwNzc4NA==", "url": "https://github.com/all-of-us/workbench/pull/2995#discussion_r365607784", "bodyText": "sounds good.", "author": "jaycarlton", "createdAt": "2020-01-12T20:17:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTQ3NTEwMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTQ1NTQwMg==", "url": "https://github.com/all-of-us/workbench/pull/2995#discussion_r365455402", "bodyText": "nit: why is the new one not the final one? I wonder if we should alphabetize them.", "author": "jaycarlton", "createdAt": "2020-01-10T22:27:34Z", "path": "api/src/main/java/org/pmiops/workbench/workspaces/WorkspaceServiceImpl.java", "diffHunk": "@@ -95,6 +98,7 @@ public WorkspaceServiceImpl(\n       UserDao userDao,\n       Provider<DbUser> userProvider,\n       UserRecentWorkspaceDao userRecentWorkspaceDao,\n+      Provider<WorkbenchConfig> workbenchConfigProvider,", "originalCommit": "845c53d2390923439d181294d4d6d06830bf25f2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTU2MDY3OA==", "url": "https://github.com/all-of-us/workbench/pull/2995#discussion_r365560678", "bodyText": "sorry, not following. what is new and should be final?", "author": "ericsong", "createdAt": "2020-01-12T06:25:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTQ1NTQwMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTYwNzgxNw==", "url": "https://github.com/all-of-us/workbench/pull/2995#discussion_r365607817", "bodyText": "I meant the config provider looks like it was added but isn't the last parameter in the list. It's not worth worrying about.", "author": "jaycarlton", "createdAt": "2020-01-12T20:18:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTQ1NTQwMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTQ1NTkxMg==", "url": "https://github.com/all-of-us/workbench/pull/2995#discussion_r365455912", "bodyText": "nit: maybe say something about the workspace's project? Or is billingInactive a workspace concept?", "author": "jaycarlton", "createdAt": "2020-01-10T22:29:33Z", "path": "api/src/main/java/org/pmiops/workbench/workspaces/WorkspaceServiceImpl.java", "diffHunk": "@@ -243,6 +248,19 @@ public DbWorkspace getRequiredWithCohorts(String ns, String firecloudName) {\n     return workspace;\n   }\n \n+  @Override\n+  public void requireActiveBilling(String workspaceNamespace, String workspaceId)\n+      throws ForbiddenException {\n+    if (!workbenchConfigProvider.get().featureFlags.enableBillingLockout) {\n+      return;\n+    }\n+\n+    if (BillingStatus.INACTIVE.equals(\n+        getRequired(workspaceNamespace, workspaceId).getBillingStatus())) {\n+      throw new ForbiddenException(\"Workspace is in an inactive billing state\");", "originalCommit": "845c53d2390923439d181294d4d6d06830bf25f2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTQ1NjU2Mg==", "url": "https://github.com/all-of-us/workbench/pull/2995#discussion_r365456562", "bodyText": "There may be a way to generically have a shim abstract class that does this before validation, but no need to go there yet.\nIn terms of the name, do we need to call out billing here, or can we have a global workspace activation for these?", "author": "jaycarlton", "createdAt": "2020-01-10T22:31:32Z", "path": "api/src/main/java/org/pmiops/workbench/workspaces/WorkspacesController.java", "diffHunk": "@@ -605,6 +605,9 @@ private Boolean copyBlob(String bucketName, Blob b) {\n       String fromWorkspaceId,\n       String fromNotebookName,\n       CopyRequest copyRequest) {\n+    workspaceService.requireActiveBilling(", "originalCommit": "845c53d2390923439d181294d4d6d06830bf25f2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTQ1NzM0OA==", "url": "https://github.com/all-of-us/workbench/pull/2995#discussion_r365457348", "bodyText": "It would be nice to define a custom annotation for the checked controller methods, even if it's just a glorified comment. That way you can grab all occurrences of it at once if you like.", "author": "jaycarlton", "createdAt": "2020-01-10T22:34:13Z", "path": "api/src/main/java/org/pmiops/workbench/workspaces/WorkspacesController.java", "diffHunk": "@@ -605,6 +605,9 @@ private Boolean copyBlob(String bucketName, Blob b) {\n       String fromWorkspaceId,", "originalCommit": "845c53d2390923439d181294d4d6d06830bf25f2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTUzMjgyMg==", "url": "https://github.com/all-of-us/workbench/pull/2995#discussion_r365532822", "bodyText": "nit: I've been naming these kind of functions starting with validate, which I associate with a check that throws. As written, it's active voice, as if we're telling the class to require active billing on these arguments.", "author": "jaycarlton", "createdAt": "2020-01-11T17:31:38Z", "path": "api/src/main/java/org/pmiops/workbench/workspaces/WorkspaceService.java", "diffHunk": "@@ -40,6 +41,9 @@\n \n   DbWorkspace saveWithLastModified(DbWorkspace workspace);\n \n+  void requireActiveBilling(String workspaceNamespace, String workspaceId)", "originalCommit": "845c53d2390923439d181294d4d6d06830bf25f2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTU2MDQ5Mw==", "url": "https://github.com/all-of-us/workbench/pull/2995#discussion_r365560493", "bodyText": "sure, I like validate", "author": "ericsong", "createdAt": "2020-01-12T06:20:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTUzMjgyMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTUzMjg4NA==", "url": "https://github.com/all-of-us/workbench/pull/2995#discussion_r365532884", "bodyText": "I'm confused why this test case needs you to both set inactive here and then stub the call below.", "author": "jaycarlton", "createdAt": "2020-01-11T17:33:18Z", "path": "api/src/test/java/org/pmiops/workbench/api/ClusterControllerTest.java", "diffHunk": "@@ -418,6 +424,31 @@ public void testLocalize_noNotebooks() throws Exception {\n     assertThat(resp.getClusterLocalDirectory()).isEqualTo(\"workspaces/wsid\");\n   }\n \n+  @Test(expected = ForbiddenException.class)\n+  public void listCluster_requireActiveBilling() {\n+    testWorkspace.setBillingStatus(BillingStatus.INACTIVE);", "originalCommit": "845c53d2390923439d181294d4d6d06830bf25f2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTU2MDkyMw==", "url": "https://github.com/all-of-us/workbench/pull/2995#discussion_r365560923", "bodyText": "I was on the fence about adding it. The reason I did was because I felt like it explained the condition in which the exception is thrown but I can go either way so I'll remove it.", "author": "ericsong", "createdAt": "2020-01-12T06:32:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTUzMjg4NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTUzMjk1MQ==", "url": "https://github.com/all-of-us/workbench/pull/2995#discussion_r365532951", "bodyText": "Also, I'd probably just make two test workspaces, one active and one not, to cut down on the per-testcase setup.", "author": "jaycarlton", "createdAt": "2020-01-11T17:34:42Z", "path": "api/src/test/java/org/pmiops/workbench/api/ClusterControllerTest.java", "diffHunk": "@@ -418,6 +424,31 @@ public void testLocalize_noNotebooks() throws Exception {\n     assertThat(resp.getClusterLocalDirectory()).isEqualTo(\"workspaces/wsid\");\n   }\n \n+  @Test(expected = ForbiddenException.class)\n+  public void listCluster_requireActiveBilling() {\n+    testWorkspace.setBillingStatus(BillingStatus.INACTIVE);\n+\n+    doThrow(ForbiddenException.class)\n+        .when(workspaceService)\n+        .requireActiveBilling(WORKSPACE_NS, WORKSPACE_ID);\n+\n+    clusterController.listClusters(WORKSPACE_NS, WORKSPACE_ID);\n+  }\n+\n+  @Test(expected = ForbiddenException.class)\n+  public void localize_requireActiveBilling() {\n+    testWorkspace.setBillingStatus(BillingStatus.INACTIVE);", "originalCommit": "845c53d2390923439d181294d4d6d06830bf25f2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTUzMzAxOA==", "url": "https://github.com/all-of-us/workbench/pull/2995#discussion_r365533018", "bodyText": "So the only assertion is that the test throws this exception, and you're only throwing the exception because of Mockito. This feels like you're possibly testing this behavior at the wrong level, or in the wrong class.", "author": "jaycarlton", "createdAt": "2020-01-11T17:36:08Z", "path": "api/src/test/java/org/pmiops/workbench/api/ClusterControllerTest.java", "diffHunk": "@@ -418,6 +424,31 @@ public void testLocalize_noNotebooks() throws Exception {\n     assertThat(resp.getClusterLocalDirectory()).isEqualTo(\"workspaces/wsid\");\n   }\n \n+  @Test(expected = ForbiddenException.class)\n+  public void listCluster_requireActiveBilling() {\n+    testWorkspace.setBillingStatus(BillingStatus.INACTIVE);\n+\n+    doThrow(ForbiddenException.class)\n+        .when(workspaceService)\n+        .requireActiveBilling(WORKSPACE_NS, WORKSPACE_ID);\n+\n+    clusterController.listClusters(WORKSPACE_NS, WORKSPACE_ID);\n+  }\n+\n+  @Test(expected = ForbiddenException.class)\n+  public void localize_requireActiveBilling() {\n+    testWorkspace.setBillingStatus(BillingStatus.INACTIVE);\n+\n+    doThrow(ForbiddenException.class)\n+        .when(workspaceService)\n+        .requireActiveBilling(WORKSPACE_NS, WORKSPACE_ID);", "originalCommit": "845c53d2390923439d181294d4d6d06830bf25f2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTU2MTA5MA==", "url": "https://github.com/all-of-us/workbench/pull/2995#discussion_r365561090", "bodyText": "Yeah, this was the more tricky class to test because its the only one that actually mocks out workspaceService instead of relying on a real implementation.\nThat said, I think the level of testing here is valid if you view the subject under test as just the ClusterController. The test verifies that the requireActiveBilling() method is called, not if its implementation is correct.", "author": "ericsong", "createdAt": "2020-01-12T06:37:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTUzMzAxOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTYwNzkyMA==", "url": "https://github.com/all-of-us/workbench/pull/2995#discussion_r365607920", "bodyText": "I was thinking about this a bit. I think just verifying that requireActiveBilling() is called is enough here, since we test that it throws or not correctly elsewhere. That way you could drop the expected and the doThrow in favor of one statement that's a bit clearer I think.", "author": "jaycarlton", "createdAt": "2020-01-12T20:20:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTUzMzAxOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTUzMzExNQ==", "url": "https://github.com/all-of-us/workbench/pull/2995#discussion_r365533115", "bodyText": "I just learned that there's an error code 402 Payment Required, but it's nonstandard. Would've fit like a glove here though. https://developer.mozilla.org/en-US/docs/Web/HTTP/Status/402", "author": "jaycarlton", "createdAt": "2020-01-11T17:38:06Z", "path": "api/src/test/java/org/pmiops/workbench/api/DataSetControllerTest.java", "diffHunk": "@@ -960,6 +968,20 @@ public void exportToNewNotebook() {\n         .saveNotebook(eq(WORKSPACE_BUCKET_NAME), eq(notebookName), any(JSONObject.class));\n   }\n \n+  @Test(expected = ForbiddenException.class)", "originalCommit": "845c53d2390923439d181294d4d6d06830bf25f2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTU2MTE1MQ==", "url": "https://github.com/all-of-us/workbench/pull/2995#discussion_r365561151", "bodyText": "I found that too but I believe its not fully supported, just reserved for future use.", "author": "ericsong", "createdAt": "2020-01-12T06:38:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTUzMzExNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTUzMzE1Mw==", "url": "https://github.com/all-of-us/workbench/pull/2995#discussion_r365533153", "bodyText": "If you're looking for a rabbit hole, these should all be MockBeans", "author": "jaycarlton", "createdAt": "2020-01-11T17:38:55Z", "path": "api/src/test/java/org/pmiops/workbench/workspaces/WorkspaceServiceTest.java", "diffHunk": "@@ -55,6 +56,7 @@\n   @Mock private DataSetService mockDataSetService;", "originalCommit": "845c53d2390923439d181294d4d6d06830bf25f2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTUzMzg4NA==", "url": "https://github.com/all-of-us/workbench/pull/2995#discussion_r365533884", "bodyText": "I was going to post some reaction gifs to this constructor invocation, but I think there's an easier way to solve this issue.\nI'd go ahead and make a FakeWorkspaceServiceImpl class, use IntelliJ's default overload implementations that just return null, give it a zero-arg constructor, and tag it with @Service and give it a bean name. Then just inject it like a real service.\nYou'll likely need to mark the real one as primary so that the fake doesn't get pulled into real code.\nEven simpler would be to mock it with Mockito, but I think using it in production code is controversial if not frowned upon.\nIt's still a smell to me that you need to pull in this bean but don't need a working version, but I haven't looked around very much to understand the main issue you're working around.", "author": "jaycarlton", "createdAt": "2020-01-11T17:55:25Z", "path": "api/tools/src/main/java/org/pmiops/workbench/tools/ExportWorkspaceData.java", "diffHunk": "@@ -84,7 +84,7 @@\n   // Importing the real one requires importing a large subtree of dependencies\n   @Bean\n   public WorkspaceService workspaceService() {\n-    return new WorkspaceServiceImpl(null, null, null, null, null, null, null, null, null);\n+    return new WorkspaceServiceImpl(null, null, null, null, null, null, null, null, null, null);", "originalCommit": "845c53d2390923439d181294d4d6d06830bf25f2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTU2MTY2Mw==", "url": "https://github.com/all-of-us/workbench/pull/2995#discussion_r365561663", "bodyText": "I think I actually did try Mockito when I first implemented this but it didn't work for some reason. That said, this isn't exactly production code (it's one of our cmd line tools) and I don't think further refactoring in this specific case will save us time down the road.\nThe goal here was to just stop the DI wiring here so the tool wouldn't have to import a large number of dependencies.", "author": "ericsong", "createdAt": "2020-01-12T06:52:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTUzMzg4NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTYwODA0NA==", "url": "https://github.com/all-of-us/workbench/pull/2995#discussion_r365608044", "bodyText": "Right, so you need something depends on WorkspaceService, but aren't actually calling any method on it that needs WorkspaceService. That's a symptom of the services getting too large most likely. Not something to chase here if you're trying to keep this small though.", "author": "jaycarlton", "createdAt": "2020-01-12T20:22:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTUzMzg4NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTUzMzk2OQ==", "url": "https://github.com/all-of-us/workbench/pull/2995#discussion_r365533969", "bodyText": "If you have a few minutes to write a small markdown file about this mechanism and how it works and when you should make your APIs require billing, you could simply put the URL to that here. I don't think there's enough context here to help folks who come later really understand it.", "author": "jaycarlton", "createdAt": "2020-01-11T17:57:16Z", "path": "common-api/src/main/java/org/pmiops/workbench/config/WorkbenchConfig.java", "diffHunk": "@@ -196,6 +196,9 @@ public static WorkbenchConfig createEmptyConfig() {\n     // Flag to indicate whether to enable the new Create Account flow\n     // https://precisionmedicineinitiative.atlassian.net/browse/RW-3284\n     public boolean enableNewAccountCreation;\n+    // Setting this to true will prevent users from making compute increasing operations on", "originalCommit": "845c53d2390923439d181294d4d6d06830bf25f2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "f3e99c52b45c695b491c732bd43fc8a2426890c9", "url": "https://github.com/all-of-us/workbench/commit/f3e99c52b45c695b491c732bd43fc8a2426890c9", "message": "enforce ws access before billing check", "committedDate": "2020-01-12T06:10:36Z", "type": "commit"}, {"oid": "8f3207e19853d2c5f2d80bfd0f4a07d0226cd44b", "url": "https://github.com/all-of-us/workbench/commit/8f3207e19853d2c5f2d80bfd0f4a07d0226cd44b", "message": "revert build.gradle", "committedDate": "2020-01-12T06:16:19Z", "type": "commit"}, {"oid": "f143376b475c9d587d5a4b2b58ec61a4f32ee1cb", "url": "https://github.com/all-of-us/workbench/commit/f143376b475c9d587d5a4b2b58ec61a4f32ee1cb", "message": "bump junit", "committedDate": "2020-01-12T06:17:15Z", "type": "commit"}, {"oid": "8eee88f25a31d485cf0e8260eb00fd4903661330", "url": "https://github.com/all-of-us/workbench/commit/8eee88f25a31d485cf0e8260eb00fd4903661330", "message": "code review", "committedDate": "2020-01-12T06:55:01Z", "type": "commit"}, {"oid": "9a3e60d69af8c67316ff966e4215870a2103d5e9", "url": "https://github.com/all-of-us/workbench/commit/9a3e60d69af8c67316ff966e4215870a2103d5e9", "message": "remove unneeded test setup", "committedDate": "2020-01-12T07:08:36Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTU2MTc1Nw==", "url": "https://github.com/all-of-us/workbench/pull/2995#discussion_r365561757", "bodyText": "This was necessary to bring in assertThrows", "author": "ericsong", "createdAt": "2020-01-12T06:55:23Z", "path": "api/build.gradle", "diffHunk": "@@ -428,7 +428,7 @@ dependencies {\n   toolsCompile 'commons-cli:commons-cli:1.4'\n   toolsCompile 'com.opencsv:opencsv:4.6'\n \n-  testCompile 'junit:junit:4.12'\n+  testCompile 'junit:junit:4.13'", "originalCommit": "f143376b475c9d587d5a4b2b58ec61a4f32ee1cb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTYwODEwOA==", "url": "https://github.com/all-of-us/workbench/pull/2995#discussion_r365608108", "bodyText": "Oh nice. I wanted to use that somewhere not long ago.", "author": "jaycarlton", "createdAt": "2020-01-12T20:23:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTU2MTc1Nw=="}], "type": "inlineReview"}, {"oid": "ea434a02c5daa163722fe9a0ab5ba74abdd4f3e5", "url": "https://github.com/all-of-us/workbench/commit/ea434a02c5daa163722fe9a0ab5ba74abdd4f3e5", "message": "spotless", "committedDate": "2020-01-12T07:53:01Z", "type": "commit"}, {"oid": "749d22eed80c6f24cdfa8b485bede7eebee3add5", "url": "https://github.com/all-of-us/workbench/commit/749d22eed80c6f24cdfa8b485bede7eebee3add5", "message": "turn on test", "committedDate": "2020-01-12T20:08:02Z", "type": "commit"}, {"oid": "a05c81eebd8e25dbe7e41a579720d14c3a93fe82", "url": "https://github.com/all-of-us/workbench/commit/a05c81eebd8e25dbe7e41a579720d14c3a93fe82", "message": "add comment explaining when to add validat billing", "committedDate": "2020-01-13T18:17:35Z", "type": "commit"}]}