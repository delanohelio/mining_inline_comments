{"pr_number": 4108, "pr_title": "[RW-5494][risk=no] Reporting SQL queries for  ad hoc analysis in  BigQuery", "pr_createdAt": "2020-10-02T15:48:27Z", "pr_url": "https://github.com/all-of-us/workbench/pull/4108", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODkxNDM2MQ==", "url": "https://github.com/all-of-us/workbench/pull/4108#discussion_r498914361", "bodyText": "Is there a reason to refer to the user table here instead of the cohort table for pulling the latest snapshot timestamp? It might be clearer to keep the subquery within the same table.", "author": "gjuggler", "createdAt": "2020-10-02T16:07:15Z", "path": "api/reporting/queries/live/latest_table_views/latest_cohorts.sql", "diffHunk": "@@ -0,0 +1,13 @@\n+-- All cohorts from the most recent snapshot\n+SELECT\n+    c.*\n+FROM\n+    reporting_test.cohort c\n+WHERE\n+        c.snapshot_timestamp = (\n+        SELECT\n+            MAX(u2.snapshot_timestamp)\n+        FROM\n+            reporting_test.user u2)", "originalCommit": "d9911d49b97bc8d4d6fbac421941094951122c29", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTAwMjk3Mw==", "url": "https://github.com/all-of-us/workbench/pull/4108#discussion_r499002973", "bodyText": "Good point. I was going to make a view for just the latest timestamp or another one for all the unique timestamps values. I think I have that in another environment.\nIn the extreme case, everyone could delete all their cohorts today, and on Monday there should be zero cohorts at the latest timestamp, so we need a global notion of what that is.", "author": "jaycarlton", "createdAt": "2020-10-02T19:09:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODkxNDM2MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODkxNTAxMA==", "url": "https://github.com/all-of-us/workbench/pull/4108#discussion_r498915010", "bodyText": "nit: remove extra 'i'", "author": "gjuggler", "createdAt": "2020-10-02T16:08:29Z", "path": "api/reporting/queries/live/restructured_results/latest_users_structured.sql", "diffHunk": "@@ -0,0 +1,40 @@\n+SELECT\n+    TIMESTAMP_MILLIS(u.snapshot_timestamp) AS snapshot,\n+    STRUCT( u.user_id,\n+            u.username,\n+            u.disabled,\n+            u.creation_time,\n+            u.first_sign_in_time,\n+            u.first_registration_completion_time,\n+            u.last_modified_time) AS account,\n+    STRUCT( u.given_name,\n+            u.family_name,\n+            u.about_you,\n+            u.area_of_research,\n+            u.current_position,\n+            u.demographic_survey_completion_time) AS profile,\n+    STRUCT(u.contact_email,\n+           u.street_address_1,\n+           u.street_address_2,\n+           u.city,\n+           u.state,\n+           u.zip_code,\n+           u.country,\n+           u.professional_url) AS contact_info,\n+    STRUCT( STRUCT(u.compliance_training_completion_time AS completion_time,\n+                   u.compliance_training_bypass_time AS bypass_time,\n+                   u.compliance_training_expiration_time AS expiration_time) AS compliance_training,\n+            STRUCT(data_use_agreement_signed_version AS signed_version,\n+                   data_use_agreement_completion_time AS completion_timei,", "originalCommit": "d9911d49b97bc8d4d6fbac421941094951122c29", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODkxNTI3MA==", "url": "https://github.com/all-of-us/workbench/pull/4108#discussion_r498915270", "bodyText": "nit: not sure how free tier credits fits under the \"compliance\" banner", "author": "gjuggler", "createdAt": "2020-10-02T16:08:57Z", "path": "api/reporting/queries/live/restructured_results/latest_users_structured.sql", "diffHunk": "@@ -0,0 +1,40 @@\n+SELECT\n+    TIMESTAMP_MILLIS(u.snapshot_timestamp) AS snapshot,\n+    STRUCT( u.user_id,\n+            u.username,\n+            u.disabled,\n+            u.creation_time,\n+            u.first_sign_in_time,\n+            u.first_registration_completion_time,\n+            u.last_modified_time) AS account,\n+    STRUCT( u.given_name,\n+            u.family_name,\n+            u.about_you,\n+            u.area_of_research,\n+            u.current_position,\n+            u.demographic_survey_completion_time) AS profile,\n+    STRUCT(u.contact_email,\n+           u.street_address_1,\n+           u.street_address_2,\n+           u.city,\n+           u.state,\n+           u.zip_code,\n+           u.country,\n+           u.professional_url) AS contact_info,\n+    STRUCT( STRUCT(u.compliance_training_completion_time AS completion_time,\n+                   u.compliance_training_bypass_time AS bypass_time,\n+                   u.compliance_training_expiration_time AS expiration_time) AS compliance_training,\n+            STRUCT(data_use_agreement_signed_version AS signed_version,\n+                   data_use_agreement_completion_time AS completion_timei,\n+                   data_use_agreement_bypass_time AS bypass_time) AS data_use_agreement,\n+            STRUCT(u.era_commons_completion_time AS completion_time,\n+                   u.era_commons_bypass_time AS bypass_time) AS era_commons,\n+            STRUCT(u.two_factor_auth_completion_time AS completion_time,\n+                   u.two_factor_auth_bypass_time AS bypass_time) AS two_factor_auth,\n+            u.data_access_level,\n+            STRUCT(u.free_tier_credits_limit_days_override AS days,", "originalCommit": "d9911d49b97bc8d4d6fbac421941094951122c29", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTAyNjg1MQ==", "url": "https://github.com/all-of-us/workbench/pull/4108#discussion_r499026851", "bodyText": "We set  a limit and they comply with it? I'll break it out.", "author": "jaycarlton", "createdAt": "2020-10-02T20:06:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODkxNTI3MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODkxNzAwNA==", "url": "https://github.com/all-of-us/workbench/pull/4108#discussion_r498917004", "bodyText": "Nifty!\nI worry a small bit about \"give a mouse a cookie\" here, where there may become an expectation that all of our underlying data is structured this way, when it's really a manually crafted facade. Not necessarily a bad thing \u2013\u00a0it's just worth being clear about what this is and isn't.\nWe also got a pretty signal early on (from the PDR folks I believe) that their Tableau connector wouldn't be able to make use of BigQuery's nested / struct rows. Not sure whether that's still the case.\nAnyhow, those are just points to keep in mind. Seems useful and worth keeping around, at least as a POC of how one might add some structure to the BQ version of this reporting data.", "author": "gjuggler", "createdAt": "2020-10-02T16:12:27Z", "path": "api/reporting/queries/live/restructured_results/latest_users_structured.sql", "diffHunk": "@@ -0,0 +1,40 @@\n+SELECT\n+    TIMESTAMP_MILLIS(u.snapshot_timestamp) AS snapshot,", "originalCommit": "d9911d49b97bc8d4d6fbac421941094951122c29", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTAyNzQ1Mg==", "url": "https://github.com/all-of-us/workbench/pull/4108#discussion_r499027452", "bodyText": "Yeah, this is  more for Shimon and other internal customers. It sounds like the current plan is not to  connect Tableau to BigQUery directly at all  but to wait  for a NiFi pipeline  to  the PDR.\nLook at  it like UI; we have a workspaces page, but people don't expect to be able  to view all of our objects in that format.", "author": "jaycarlton", "createdAt": "2020-10-02T20:08:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODkxNzAwNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODkxNzU1Ng==", "url": "https://github.com/all-of-us/workbench/pull/4108#discussion_r498917556", "bodyText": "This one feels like a bit too much of a straight rename \u2013 which IIRC you'd tried to avoid doing, to reduce schema drift / random name-mapping challenges.", "author": "gjuggler", "createdAt": "2020-10-02T16:13:30Z", "path": "api/reporting/queries/live/restructured_results/latest_workspaces_structured.sql", "diffHunk": "@@ -0,0 +1,38 @@\n+-- latest workspaces, broken into logical structs for easier comprehension.\n+SELECT\n+    STRUCT(w.workspace_id,\n+           w.name,\n+           w.creator_id,\n+           w.cdr_version_id,\n+           w.creation_time) AS metadata,\n+    STRUCT(w.creation_time,\n+           w.last_accessed_time,\n+           w.last_modified_time) AS history,\n+    STRUCT( w.rp_additional_notes AS additional_notes,\n+            w.rp_ancestry AS ancestry,\n+            w.rp_anticipated_findings AS anticipated_findings,\n+            w.rp_approved AS approved,\n+            w.rp_commercial_purpose AS commercial_purpose,\n+            w.rp_control_set AS control_set,\n+            w.rp_disease_focused_research AS disease_focused_research,\n+            w.rp_disease_of_focus AS disease_of_focus,\n+            w.disseminate_research_other,\n+            w.rp_drug_development AS drug_development,\n+            w.rp_educational AS educational,\n+            w.rp_ethics AS ethics,\n+            w.rp_intended_study AS intended_study,\n+            w.rp_methods_development AS methods_development,\n+            w.rp_other_population_details AS other_population_details,\n+            w.rp_other_purpose AS other_purpose,\n+            w.rp_other_purpose_details AS other_purpose_details,\n+            w.rp_population_health AS population_health,\n+            w.rp_reason_for_all_of_us AS reason_for_all_of_us,\n+            w.rp_review_requested AS review_requested,\n+            w.rp_scientific_approach AS scientific_approach,\n+            w.rp_social_behavioral AS social_behavioral,\n+            w.rp_time_requested AS time_requested ) AS research_purpose,\n+    STRUCT(w.billing_status AS status,\n+           w.billing_account_type AS account_type ) AS billing,\n+    STRUCT(w.needs_rp_review_prompt) AS process_status", "originalCommit": "d9911d49b97bc8d4d6fbac421941094951122c29", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTAyODQyMw==", "url": "https://github.com/all-of-us/workbench/pull/4108#discussion_r499028423", "bodyText": "For those columns that come from our MySQL App DB (currently all of them), the schema-defined column names in this dataset are exactly the  same. This isn't a schema  contract but a pretty/convenient/useful  presentation.\nAlso, it's  not  renaming the var but exposing it as process_status.needs_rp_rreview_prompt.", "author": "jaycarlton", "createdAt": "2020-10-02T20:10:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODkxNzU1Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTAzMzY1MA==", "url": "https://github.com/all-of-us/workbench/pull/4108#discussion_r499033650", "bodyText": "I refactored all the rp review columns (I think) into one struct under research_purpose:\n\"research_purpose\": {\n      \"additional_notes\": null,\n      \"ancestry\": false,\n      \"anticipated_findings\": null,\n      \"commercial_purpose\": false,\n      \"control_set\": true,\n      \"disease_focused_research\": false,\n      \"disease_of_focus\": null,\n      \"disseminate_research_other\": null,\n      \"drug_development\": false,\n      \"educational\": false,\n      \"ethics\": false,\n      \"intended_study\": \"\",\n      \"methods_development\": false,\n      \"other_population_details\": null,\n      \"other_purpose\": false,\n      \"other_purpose_details\": null,\n      \"population_health\": false,\n      \"reason_for_all_of_us\": null,\n      \"scientific_approach\": null,\n      \"social_behavioral\": false,\n      \"review_rerquest\": {\n        \"rerquested\": false,\n        \"time_requested\": null,\n        \"approved\": null,\n        \"needs_user_prompt\": \"0\"\n      }\n    }", "author": "jaycarlton", "createdAt": "2020-10-02T20:23:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODkxNzU1Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTA0MDc4OQ==", "url": "https://github.com/all-of-us/workbench/pull/4108#discussion_r499040789", "bodyText": "Ah, I misunderstood the syntax at first glance. I thought 'needs_rp_review_prompt' was being renamed to 'process_status'.", "author": "gjuggler", "createdAt": "2020-10-02T20:41:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODkxNzU1Ng=="}], "type": "inlineReview"}, {"oid": "1d4c0f354ac12f6ad41bfbe4a15e99ae0785f964", "url": "https://github.com/all-of-us/workbench/commit/1d4c0f354ac12f6ad41bfbe4a15e99ae0785f964", "message": "first batch of queries", "committedDate": "2020-10-02T20:05:42Z", "type": "commit"}, {"oid": "900f42acdd63fb0b62790db4d627b07cd5420ff7", "url": "https://github.com/all-of-us/workbench/commit/900f42acdd63fb0b62790db4d627b07cd5420ff7", "message": "reorganize and   add a  doc", "committedDate": "2020-10-02T20:05:42Z", "type": "commit"}, {"oid": "a5bc8e44e97b4b9be917ec0f3747fa75feb4d86a", "url": "https://github.com/all-of-us/workbench/commit/a5bc8e44e97b4b9be917ec0f3747fa75feb4d86a", "message": "more  docs", "committedDate": "2020-10-02T20:05:43Z", "type": "commit"}, {"oid": "08141fb8d0e171dcb32f0531a263fdd37a7e231e", "url": "https://github.com/all-of-us/workbench/commit/08141fb8d0e171dcb32f0531a263fdd37a7e231e", "message": "link  from  top-level README", "committedDate": "2020-10-02T20:05:43Z", "type": "commit"}, {"oid": "04be070fa2590e141a203e55f2087d2984dfa1cf", "url": "https://github.com/all-of-us/workbench/commit/04be070fa2590e141a203e55f2087d2984dfa1cf", "message": "updated with PR notes", "committedDate": "2020-10-02T20:29:48Z", "type": "commit"}, {"oid": "299d66d46e966c7942b8c300ca380e146e2a17b0", "url": "https://github.com/all-of-us/workbench/commit/299d66d46e966c7942b8c300ca380e146e2a17b0", "message": "update README", "committedDate": "2020-10-02T20:40:36Z", "type": "commit"}, {"oid": "299d66d46e966c7942b8c300ca380e146e2a17b0", "url": "https://github.com/all-of-us/workbench/commit/299d66d46e966c7942b8c300ca380e146e2a17b0", "message": "update README", "committedDate": "2020-10-02T20:40:36Z", "type": "forcePushed"}]}