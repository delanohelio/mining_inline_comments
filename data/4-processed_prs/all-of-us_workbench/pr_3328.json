{"pr_number": 3328, "pr_title": "[RW-4614][risk=no]integrate jest-puppeteer in Puppeteer e2e test framework", "pr_createdAt": "2020-04-01T14:50:54Z", "pr_url": "https://github.com/all-of-us/workbench/pull/3328", "timeline": [{"oid": "552b260508cc209030a04b288702dff72fc9f3fc", "url": "https://github.com/all-of-us/workbench/commit/552b260508cc209030a04b288702dff72fc9f3fc", "message": "add jest-puppeteer preset", "committedDate": "2020-03-31T20:38:06Z", "type": "commit"}, {"oid": "53b3bf86020f2a89c202390d95b32af3a2fbe0d8", "url": "https://github.com/all-of-us/workbench/commit/53b3bf86020f2a89c202390d95b32af3a2fbe0d8", "message": "saving work", "committedDate": "2020-04-01T14:11:57Z", "type": "commit"}, {"oid": "ae7a956375ceca488f4687065d6a99bcaeb837f6", "url": "https://github.com/all-of-us/workbench/commit/ae7a956375ceca488f4687065d6a99bcaeb837f6", "message": "remove console log", "committedDate": "2020-04-01T17:48:47Z", "type": "commit"}, {"oid": "7b55c5836a008d96c466284734000a510b3716a0", "url": "https://github.com/all-of-us/workbench/commit/7b55c5836a008d96c466284734000a510b3716a0", "message": "test on circle", "committedDate": "2020-04-01T18:05:49Z", "type": "commit"}, {"oid": "e1f8695d106b94a997b4c73a389a308f14d6b68e", "url": "https://github.com/all-of-us/workbench/commit/e1f8695d106b94a997b4c73a389a308f14d6b68e", "message": "undo change circle config", "committedDate": "2020-04-01T18:51:56Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTgzODExOA==", "url": "https://github.com/all-of-us/workbench/pull/3328#discussion_r401838118", "bodyText": "tsc compile told me to remove redundant await when return is used. :)", "author": "aweng98", "createdAt": "2020-04-01T18:55:15Z", "path": "e2e/app/google-login.ts", "diffHunk": "@@ -23,41 +23,51 @@ export default class GoogleLoginPage extends BasePage {\n    * Login email input field.\n    */\n   async email(): Promise<ElementHandle> {\n-    return await this.page.waitForXPath(selectors.emailInput, {visible: true});", "originalCommit": "e1f8695d106b94a997b4c73a389a308f14d6b68e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTg0NzcxMA==", "url": "https://github.com/all-of-us/workbench/pull/3328#discussion_r401847710", "bodyText": "Unrelated to jest-puppeteer. This change owns thanks to the unpredictable Google authentication. Test won't fail on Google login page.", "author": "aweng98", "createdAt": "2020-04-01T19:12:06Z", "path": "e2e/app/google-login.ts", "diffHunk": "@@ -23,41 +23,51 @@ export default class GoogleLoginPage extends BasePage {\n    * Login email input field.\n    */\n   async email(): Promise<ElementHandle> {\n-    return await this.page.waitForXPath(selectors.emailInput, {visible: true});\n+    return this.page.waitForXPath(selectors.emailInput, {visible: true});\n   }\n \n   /**\n    * Login password input field.\n    */\n   async password(): Promise<ElementHandle> {\n-    return await this.page.waitForXPath(selectors.passwordInput, {visible: true});\n+    return this.page.waitForXPath(selectors.passwordInput, {visible: true});\n   }\n \n   /**\n    * Google login button.\n    */\n   async loginButton(): Promise<ElementHandle> {\n-    return await this.page.waitForXPath(selectors.loginButton, {visible: true});\n+    return this.page.waitForXPath(selectors.loginButton, {visible: true});\n   }\n \n   /**\n    * Enter login email and click Next button.\n    * @param email\n    */\n   async enterEmail(userEmail: string) : Promise<void> {\n-    let emailInput: ElementHandle;\n-    try {\n-      emailInput = await this.email()\n-    } catch(e) {\n-      const randomLink = await this.page.$x('//*[@role=\"link\"]//*[text()=\"Use another account\"]');\n-      if (randomLink.length > 0) {\n-        await randomLink[0].click();\n-      }\n-      emailInput = await this.email()\n+    // Handle Google \"Use another account\" dialog if it exists\n+    const useAnotherAccountXpath = '//*[@role=\"link\"]//*[text()=\"Use another account\"]';\n+    const elemt1 = await Promise.race([\n+      this.page.waitForXPath(selectors.emailInput, {visible: true, timeout: 60000}),\n+      this.page.waitForXPath(useAnotherAccountXpath, {visible: true, timeout: 60000}),\n+    ]);\n+\n+    // compare to the Use another account link\n+    const [link] = await this.page.$x(useAnotherAccountXpath);\n+    const isLink = await page.evaluate((e1, e2) => e1 === e2, elemt1, link);\n+    if (isLink) {\n+      // click \" Use another Account \" link\n+      await Promise.all([\n+        this.page.waitForNavigation(),\n+        link.click(),\n+      ]);\n     }", "originalCommit": "e1f8695d106b94a997b4c73a389a308f14d6b68e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTg0OTcwNg==", "url": "https://github.com/all-of-us/workbench/pull/3328#discussion_r401849706", "bodyText": "For now, in some tests, setUserAgent and setDefaultNavigationTimeout are still required in beforeEach. boilerplate code, not good. I have a PR in work that will remove them from tests for good. I don't want to pack more new changes in this PR.", "author": "aweng98", "createdAt": "2020-04-01T19:15:36Z", "path": "e2e/tests/user/login.spec.ts", "diffHunk": "@@ -1,40 +1,25 @@\n import GoogleLoginPage, {selectors} from '../../app/google-login';\n-import PuppeteerLaunch from '../../driver/puppeteer-launch';\n \n const configs = require('../../resources/workbench-config');\n \n-// set timeout globally per suite, not per test.\n-jest.setTimeout(2 * 60 * 1000);\n \n describe('Login tests:', () => {\n-  let browser;\n-  let incognitoContext;\n-  let page;\n-\n-  beforeAll(async () =>  {\n-    browser = await PuppeteerLaunch();\n-  });\n \n   beforeEach(async () => {\n-    incognitoContext = await browser.createIncognitoBrowserContext();\n-    page = await incognitoContext.newPage();\n     await page.setUserAgent(configs.puppeteerUserAgent);\n-    await page.setDefaultNavigationTimeout(60000);\n+    await page.setDefaultNavigationTimeout(120000);", "originalCommit": "e1f8695d106b94a997b4c73a389a308f14d6b68e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTg1MDEzMg==", "url": "https://github.com/all-of-us/workbench/pull/3328#discussion_r401850132", "bodyText": "test is no longer valid due to removal of invitation key during Create Account workflow.", "author": "aweng98", "createdAt": "2020-04-01T19:16:23Z", "path": "e2e/tests/user/registration-ui.spec.ts", "diffHunk": "@@ -3,56 +3,19 @@ import SelectComponent from '../../app/aou-elements/select-component';\n import Textbox from '../../app/aou-elements/textbox';\n import CreateAccountPage, {FIELD_LABEL, INSTITUTION_ROLE_VALUE, INSTITUTION_VALUE} from '../../app/create-account-page';\n import GoogleLoginPage from '../../app/google-login';\n-import PuppeteerLaunch from '../../driver/puppeteer-launch';\n \n const configs = require('../../resources/workbench-config');\n \n-// set timeout globally per suite, not per test.\n-jest.setTimeout(2 * 60 * 1000);\n \n-describe.skip('User registration tests:', () => {\n-\n-  let browser;\n-  let page;\n-\n-  beforeAll(async () => {\n-    browser = await PuppeteerLaunch();\n-  });\n+describe('User registration tests:', () => {\n \n   beforeEach(async () => {\n-    page = await browser.newPage();\n-    await page.setDefaultNavigationTimeout(60000);\n+    await page.setUserAgent(configs.puppeteerUserAgent);\n+    await page.setDefaultNavigationTimeout(120000);\n   });\n \n   afterEach(async () => {\n-    await page.close();\n-  });\n-\n-  afterAll(async () => {\n-    await browser.close();\n-  });\n-\n-\n-  test('Entered invalid invitation key', async () => {", "originalCommit": "e1f8695d106b94a997b4c73a389a308f14d6b68e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTg1MTA5Nw==", "url": "https://github.com/all-of-us/workbench/pull/3328#discussion_r401851097", "bodyText": "changes in tslint are mostly changed by linting. real change are lines #50 - #52.", "author": "aweng98", "createdAt": "2020-04-01T19:18:15Z", "path": "e2e/tslint.json", "diffHunk": "@@ -1,44 +1,55 @@\n {\n-    \"defaultSeverity\": \"error\",\n-    \"extends\": [\n-        \"tslint:recommended\",\n-        \"tslint-eslint-rules\",\n-        \"tslint-config-prettier\"\n+  \"defaultSeverity\": \"error\",", "originalCommit": "e1f8695d106b94a997b4c73a389a308f14d6b68e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk0MTQ5NA==", "url": "https://github.com/all-of-us/workbench/pull/3328#discussion_r401941494", "bodyText": "Is this the same as our other tslint file? We should probably just have one.", "author": "calbach", "createdAt": "2020-04-01T22:14:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTg1MTA5Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjY0MzkxMQ==", "url": "https://github.com/all-of-us/workbench/pull/3328#discussion_r402643911", "bodyText": "I did a quick comparison. Some tslint options are different. I created a ticket RW-4700 to perform this task. If I do it now in this PR, it's going to change all files' formatting.\nI recall vaguely I did this before but made it a separate file because I don't load ui project in IDE, somehow I thought \"extend\": \"../ui/tslint.json\" didn't work. I don't remember why.", "author": "aweng98", "createdAt": "2020-04-02T22:59:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTg1MTA5Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTkzNzA1NQ==", "url": "https://github.com/all-of-us/workbench/pull/3328#discussion_r401937055", "bodyText": "unused?", "author": "calbach", "createdAt": "2020-04-01T22:03:56Z", "path": "e2e/app/authenticated-page.ts", "diffHunk": "@@ -2,6 +2,7 @@ import {Page} from 'puppeteer';\n import {clrIconXpath} from './aou-elements/xpath-defaults';\n import {findIcon} from './aou-elements/xpath-finder';\n import BasePage from './base-page';\n+import {performance} from 'perf_hooks';", "originalCommit": "e1f8695d106b94a997b4c73a389a308f14d6b68e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk4ODcyOA==", "url": "https://github.com/all-of-us/workbench/pull/3328#discussion_r401988728", "bodyText": "I am not sure what changes (maybe its' the jest-puppeteer preset) is responsible for causing the error ReferenceError: performance is not defined if import is not specified. Code used to work without import it explicitly.", "author": "aweng98", "createdAt": "2020-04-02T00:36:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTkzNzA1NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTkzNzcwMg==", "url": "https://github.com/all-of-us/workbench/pull/3328#discussion_r401937702", "bodyText": "In the codebase we typically don't capitalize local variables, even if they are constants.", "author": "calbach", "createdAt": "2020-04-01T22:05:28Z", "path": "e2e/app/base-page.ts", "diffHunk": "@@ -232,7 +232,34 @@ export default abstract class BasePage {\n     const timestamp = new Date().getTime();\n     const screenshotFile = `${SCREENSHOT_DIR}/${fileName}_${timestamp}.png`;\n     await this.page.screenshot({path: screenshotFile, fullPage: true});\n-    console.log('screenshot taken: ' + screenshotFile);\n+    console.log('Saved screenshot ' + screenshotFile);\n+  }\n+\n+  async saveToFile(fileName, data, suffix: string = 'html') {\n+    const LOG_DIR = 'logs/html';", "originalCommit": "e1f8695d106b94a997b4c73a389a308f14d6b68e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk4OTE5MQ==", "url": "https://github.com/all-of-us/workbench/pull/3328#discussion_r401989191", "bodyText": "renamed them to screenshotDir and logDir.", "author": "aweng98", "createdAt": "2020-04-02T00:38:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTkzNzcwMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTkzOTg0OQ==", "url": "https://github.com/all-of-us/workbench/pull/3328#discussion_r401939849", "bodyText": "How did you decide on these flags - were these copied from elsewhere? Please add a comment.", "author": "calbach", "createdAt": "2020-04-01T22:10:45Z", "path": "e2e/jest-puppeteer.config.js", "diffHunk": "@@ -0,0 +1,44 @@\n+const lodash = require('lodash');\n+const puppeteer = require('puppeteer');\n+const isHeadless = process.env.HEADLESS !== 'false';\n+\n+const NEW_CHROME_SWITCHES = [", "originalCommit": "e1f8695d106b94a997b4c73a389a308f14d6b68e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjU0MzUxNg==", "url": "https://github.com/all-of-us/workbench/pull/3328#discussion_r402543516", "bodyText": "good question. I had them for a while but I can't remember whys. Thinking back, most flags are for running tests in headless mode on CircleCI docker container.\nI added some comments. Hope it helps. I need more time to dig deeper if need more info.", "author": "aweng98", "createdAt": "2020-04-02T19:00:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTkzOTg0OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk0MDUwMg==", "url": "https://github.com/all-of-us/workbench/pull/3328#discussion_r401940502", "bodyText": "Existing issue: the rest of the codebase uses lodash/fp, our convention is to alias this as \"fp\". May want to reconcile this later", "author": "calbach", "createdAt": "2020-04-01T22:12:17Z", "path": "e2e/resources/workbench-config.ts", "diffHunk": "@@ -1,5 +1,5 @@\n require('dotenv').config();\n-const _ = require('lodash');\n+const lodash = require('lodash');", "originalCommit": "e1f8695d106b94a997b4c73a389a308f14d6b68e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjU4OTMyNQ==", "url": "https://github.com/all-of-us/workbench/pull/3328#discussion_r402589325", "bodyText": "cool. I updated lodash to lodash/fp here and in jest-puppeteer.config.js.", "author": "aweng98", "createdAt": "2020-04-02T20:27:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk0MDUwMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk0MDk3Ng==", "url": "https://github.com/all-of-us/workbench/pull/3328#discussion_r401940976", "bodyText": "do we need to depend on clr-icon? This seems maybe overly specific. Can we just wait for app-signed-in, for example?", "author": "calbach", "createdAt": "2020-04-01T22:13:30Z", "path": "e2e/tests/app.ts", "diffHunk": "@@ -0,0 +1,9 @@\n+import {Page} from 'puppeteer';\n+import GoogleLoginPage from '../app/google-login';\n+\n+\n+export const signIn = async (page: Page) => {\n+  await GoogleLoginPage.logIn(page);\n+   // this element exists in DOM after user has logged in\n+  await page.waitFor(() => document.querySelector('app-signed-in app-nav-bar clr-icon') !== null);", "originalCommit": "e1f8695d106b94a997b4c73a389a308f14d6b68e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjU4OTY2Mg==", "url": "https://github.com/all-of-us/workbench/pull/3328#discussion_r402589662", "bodyText": "I wanted to look for the navbar icon specifically. but I think just app-signed-in element is sufficient.", "author": "aweng98", "createdAt": "2020-04-02T20:28:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk0MDk3Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk0MTEzOQ==", "url": "https://github.com/all-of-us/workbench/pull/3328#discussion_r401941139", "bodyText": "Fix steps", "author": "calbach", "createdAt": "2020-04-01T22:13:57Z", "path": "e2e/tests/user/registration.spec.ts", "diffHunk": "@@ -44,10 +25,6 @@ describe.skip('User registration tests:', () => {\n \n     const createAccountPage = new CreateAccountPage(page);\n \n-    // Step 1: Enter invitation key.\n-    await createAccountPage.waitForTextExists('Enter your Invitation Key:');\n-    await createAccountPage.fillOutInvitationKey(process.env.INVITATION_KEY);\n-\n     // Step 2: Terms of Service.", "originalCommit": "e1f8695d106b94a997b4c73a389a308f14d6b68e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjYzODkwNA==", "url": "https://github.com/all-of-us/workbench/pull/3328#discussion_r402638904", "bodyText": "Done", "author": "aweng98", "createdAt": "2020-04-02T22:45:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk0MTEzOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk0MTIyMw==", "url": "https://github.com/all-of-us/workbench/pull/3328#discussion_r401941223", "bodyText": "Did you mean to leave this in?", "author": "calbach", "createdAt": "2020-04-01T22:14:05Z", "path": "e2e/tests/user/registration.spec.ts", "diffHunk": "@@ -1,39 +1,20 @@\n import CreateAccountPage from '../../app/create-account-page';\n import GoogleLoginPage from '../../app/google-login';\n-import PuppeteerLaunch from '../../driver/puppeteer-launch';\n-const configs = require('../../resources/workbench-config');\n \n-// set timeout globally per suite, not per test.\n-jest.setTimeout(2 * 60 * 1000);\n \n-describe.skip('User registration tests:', () => {\n-\n-  let browser;\n-  let incognitoContext;\n-  let page;\n-\n-\n-  beforeAll(async () => {\n-    browser = await PuppeteerLaunch();\n-  });\n+describe('User registration tests:', () => {\n \n   beforeEach(async () => {\n-    incognitoContext = await browser.createIncognitoBrowserContext();\n-    page = await incognitoContext.newPage();\n     await page.setUserAgent(configs.puppeteerUserAgent);\n-    await page.setDefaultNavigationTimeout(60000);\n+    await page.setDefaultNavigationTimeout(120000);\n   });\n \n   afterEach(async () => {\n-    await incognitoContext.close();\n-  });\n-\n-  afterAll(async () => {\n-    await browser.close();\n+    await jestPuppeteer.resetBrowser();\n   });\n \n \n-  test('Can register new user', async () => {\n+  test.skip('Can register new user', async () => {", "originalCommit": "e1f8695d106b94a997b4c73a389a308f14d6b68e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjY0NjIzMA==", "url": "https://github.com/all-of-us/workbench/pull/3328#discussion_r402646230", "bodyText": "yes. test is still not working. I need to change ClrIconLink class for finding email validated success icon. I'm only able to fix this test partially in this PR.  ticket RW-4648", "author": "aweng98", "createdAt": "2020-04-02T23:05:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk0MTIyMw=="}], "type": "inlineReview"}, {"oid": "91db88325546bb14a809a8e4113432576c256ae8", "url": "https://github.com/all-of-us/workbench/commit/91db88325546bb14a809a8e4113432576c256ae8", "message": "PR feedback", "committedDate": "2020-04-03T01:42:22Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzE0MTUxNA==", "url": "https://github.com/all-of-us/workbench/pull/3328#discussion_r403141514", "bodyText": "remove?", "author": "calbach", "createdAt": "2020-04-03T16:51:11Z", "path": "e2e/jest-puppeteer.config.js", "diffHunk": "@@ -1,41 +1,45 @@\n-const lodash = require('lodash');\n+const fp = require('lodash/fp');\n const puppeteer = require('puppeteer');\n const isHeadless = process.env.HEADLESS !== 'false';\n \n+\n const NEW_CHROME_SWITCHES = [\n-  '--disable-web-security',\n-  '--disable-features=TranslateUI,BlinkGenPropertyTrees,IsolateOrigins,site-per-process',\n-  '--disable-gpu',\n-  '--disable-accelerated-2d-canvas', // disable gpu-accelerated 2d canvas\n-  '--no-zygote', // https://codereview.chromium.org/2384163002\n+  // Reduce cpu and memory usage. Disables one-site-per-process security policy, dedicated processes for site origins.\n+  '--disable-features=BlinkGenPropertyTrees,IsolateOrigins,site-per-process',\n+  // Page not loading Login URL when launched Chromium without this flag. It disables use of zygote process for forking child processes.\n+  // https://codereview.chromium.org/2384163002\n+  '--no-zygote',\n+  '--no-sandbox', // required for --no-zygote flag\n+  '--safebrowsing-disable-auto-update',\n   '--window-size=1920,1080',\n ];\n \n-// append to Puppeteer default chrome flags.\n+// Append to Puppeteer default chrome flags.\n // https://github.com/puppeteer/puppeteer/blob/33f1967072e07824c5bf6a8c1336f844d9efaabf/lib/Launcher.js#L261\n-const DEFAULT_SWITCHES = puppeteer.defaultArgs({devtools: false, headless: isHeadless, userDataDir: null})\n-  .concat(...NEW_CHROME_SWITCHES)\n-  .filter(flag => flag !== '--disable-background-networking'); // filter out from default arguments\n+const DEFAULT_SWITCHES = fp.concat(\n+  puppeteer.defaultArgs({devtools: false, headless: isHeadless, userDataDir: null}),\n+  NEW_CHROME_SWITCHES\n+);\n \n-// merge without changing DEFAULT_SWITCHES\n-const CI_SWITCHES = lodash.assign([], DEFAULT_SWITCHES,\n-    [\n-      '--disable-dev-shm-usage',\n-      '--no-sandbox',\n-      '--disable-setuid-sandbox',\n-    ]\n+// Need for running Puppeteer headless Chromium in docker container.\n+const CI_SWITCHES = fp.concat(\n+  DEFAULT_SWITCHES,\n+  [\n+    '--disable-gpu', // https://bugs.chromium.org/p/chromium/issues/detail?id=737678#c10\n+    '--disable-setuid-sandbox',\n+  ]\n );\n \n-// switches for Chrome launch\n const SWITCHES = (process.env.CI === 'true') ? CI_SWITCHES : DEFAULT_SWITCHES;\n \n+console.log(SWITCHES);", "originalCommit": "91db88325546bb14a809a8e4113432576c256ae8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzE0NTUzNg==", "url": "https://github.com/all-of-us/workbench/pull/3328#discussion_r403145536", "bodyText": "Done", "author": "aweng98", "createdAt": "2020-04-03T16:57:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzE0MTUxNA=="}], "type": "inlineReview"}, {"oid": "5faa2cc2572bfb4e1da0cfc6ac7f54d3b0a6d23b", "url": "https://github.com/all-of-us/workbench/commit/5faa2cc2572bfb4e1da0cfc6ac7f54d3b0a6d23b", "message": "PR feedback", "committedDate": "2020-04-03T19:35:13Z", "type": "commit"}]}