{"pr_number": 3021, "pr_title": "[risk=low][RW-3661]Send Free Tier alert emails (behind feature flag)", "pr_createdAt": "2020-01-21T23:18:12Z", "pr_url": "https://github.com/all-of-us/workbench/pull/3021", "timeline": [{"oid": "449e8b2b586d204c990c4529ff4a418f96c055c1", "url": "https://github.com/all-of-us/workbench/commit/449e8b2b586d204c990c4529ff4a418f96c055c1", "message": "RW-3661 send alert emails", "committedDate": "2020-01-21T23:16:48Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTY3MjI3NQ==", "url": "https://github.com/all-of-us/workbench/pull/3021#discussion_r369672275", "bodyText": "This was only used for free tier alert logging, and email alerting supersedes this.", "author": "jmthibault79", "createdAt": "2020-01-22T16:40:08Z", "path": "api/src/main/java/org/pmiops/workbench/billing/FreeTierBillingService.java", "diffHunk": "@@ -34,7 +35,7 @@\n public class FreeTierBillingService {\n \n   private final BigQueryService bigQueryService;\n-  private final NotificationService notificationService;", "originalCommit": "449e8b2b586d204c990c4529ff4a418f96c055c1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTY3NTI1Nw==", "url": "https://github.com/all-of-us/workbench/pull/3021#discussion_r369675257", "bodyText": "Sending email alerts is best-effort by design: no retries.\nI could report this in a louder or better way if you prefer.", "author": "jmthibault79", "createdAt": "2020-01-22T16:45:05Z", "path": "api/src/main/java/org/pmiops/workbench/billing/FreeTierBillingService.java", "diffHunk": "@@ -106,7 +109,11 @@ public void checkFreeTierBillingUsage() {\n     final Set<DbUser> newlyExpiredUsers =\n         Sets.difference(currentExpiredUsers, previouslyExpiredUsers);\n     for (final DbUser user : newlyExpiredUsers) {\n-      notificationService.alertUserFreeTierExpiration(user);\n+      try {\n+        mailService.alertUserFreeTierExpiration(user);\n+      } catch (final MessagingException e) {\n+        logger.log(Level.WARNING, e.getMessage());", "originalCommit": "449e8b2b586d204c990c4529ff4a418f96c055c1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "d6f5c520422744aac8e988fa634cab0ae56ed0b6", "url": "https://github.com/all-of-us/workbench/commit/d6f5c520422744aac8e988fa634cab0ae56ed0b6", "message": "RW-3661 send alert emails", "committedDate": "2020-01-22T18:03:27Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTc0ODYwNQ==", "url": "https://github.com/all-of-us/workbench/pull/3021#discussion_r369748605", "bodyText": "We shouldn't be calling this if the registration time is null, but I wanted to make the nullability contract explicit", "author": "jmthibault79", "createdAt": "2020-01-22T19:09:05Z", "path": "api/src/main/java/org/pmiops/workbench/billing/FreeTierBillingService.java", "diffHunk": "@@ -123,11 +130,17 @@ private boolean expiredByCost(final DbUser user, final double currentCost) {\n     return currentCost > getUserFreeTierDollarLimit(user);\n   }\n \n+  private Optional<Instant> getUserFreeCreditExpirationTime(final DbUser user) {", "originalCommit": "8b81f09414ac4ef1a8dda51a19e08322de76a612", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTc0OTE1Mg==", "url": "https://github.com/all-of-us/workbench/pull/3021#discussion_r369749152", "bodyText": "I missed that we needed expiration date for this alert when I was doing the logic story", "author": "jmthibault79", "createdAt": "2020-01-22T19:10:09Z", "path": "api/src/main/java/org/pmiops/workbench/billing/FreeTierBillingService.java", "diffHunk": "@@ -195,8 +208,16 @@ private void maybeAlertOnCostThresholds(\n       if (currentFraction > threshold) {\n         // only alert if we have not done so previously\n         if (previousFraction <= threshold) {\n-          notificationService.alertUserFreeTierDollarThreshold(\n-              user, threshold, currentCost, remainingBalance);", "originalCommit": "8b81f09414ac4ef1a8dda51a19e08322de76a612", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDY5NDQyOA==", "url": "https://github.com/all-of-us/workbench/pull/3021#discussion_r370694428", "bodyText": "should this be info or a warning message", "author": "NehaBroad", "createdAt": "2020-01-24T15:32:02Z", "path": "api/src/main/java/org/pmiops/workbench/mail/MailServiceImpl.java", "diffHunk": "@@ -84,6 +98,110 @@ public void sendWelcomeEmail(final String contactEmail, final String password, f\n     sendWithRetries(msg, String.format(\"Welcome for %s\", user.getName()));\n   }\n \n+  @Override\n+  public void alertUserFreeTierDollarThreshold(\n+      final DbUser user,\n+      double threshold,\n+      double currentUsage,\n+      double remainingBalance,\n+      final Optional<Instant> expirationTimeIfKnown)\n+      throws MessagingException {\n+    final WorkbenchConfig workbenchConfig = workbenchConfigProvider.get();\n+\n+    final String logMsg =\n+        String.format(\n+            \"User %s has passed the %.2f free tier dollar threshold.  Current total usage is $%.2f with remaining balance $%.2f\",\n+            user.getUsername(), threshold, currentUsage, remainingBalance);\n+    log.info(logMsg);\n+\n+    if (workbenchConfig.featureFlags.sendFreeTierAlertEmails) {\n+      final String msgHtml =\n+          buildHtml(\n+              FREE_TIER_DOLLAR_THRESHOLD_RESOURCE,\n+              freeTierDollarThresholdSubstitutionMap(\n+                  user, currentUsage, remainingBalance, expirationTimeIfKnown));\n+      final String subject =\n+          String.format(\n+              \"Reminder - %s Free credit usage in All of Us Researcher Workbench\",\n+              formatPercentage(threshold));\n+\n+      final MandrillMessage msg =\n+          new MandrillMessage()\n+              .to(Collections.singletonList(validatedRecipient(user.getContactEmail())))\n+              .html(msgHtml)\n+              .subject(subject)\n+              .fromEmail(workbenchConfig.mandrill.fromEmail);\n+\n+      sendWithRetries(\n+          msg, String.format(\"User %s passed a free tier dollar threshold\", user.getUsername()));\n+    }\n+  }\n+\n+  @Override\n+  public void alertUserFreeTierTimeThreshold(\n+      final DbUser user,\n+      long daysRemaining,\n+      final LocalDate expirationDate,\n+      double remainingDollarBalance)\n+      throws MessagingException {\n+    final WorkbenchConfig workbenchConfig = workbenchConfigProvider.get();\n+\n+    final String logMsg =\n+        String.format(\n+            \"User %s has %d days remaining until their expiration date of %s.  Current total usage is $%.2f\",\n+            user.getUsername(), daysRemaining, formatDate(expirationDate), remainingDollarBalance);\n+    log.info(logMsg);\n+\n+    if (workbenchConfig.featureFlags.sendFreeTierAlertEmails) {\n+      final String msgHtml =\n+          buildHtml(\n+              FREE_TIER_TIME_THRESHOLD_RESOURCE,\n+              freeTierTimeThresholdSubstitutionMap(\n+                  user, daysRemaining, remainingDollarBalance, expirationDate));\n+\n+      final String subject =\n+          String.format(\n+              \"Reminder - %d days remaining in Free credits in All of Us Researcher Workbench\",\n+              daysRemaining);\n+\n+      final MandrillMessage msg =\n+          new MandrillMessage()\n+              .to(Collections.singletonList(validatedRecipient(user.getContactEmail())))\n+              .html(msgHtml)\n+              .subject(subject)\n+              .fromEmail(workbenchConfig.mandrill.fromEmail);\n+\n+      sendWithRetries(\n+          msg, String.format(\"User %s passed a free tier time threshold\", user.getUsername()));\n+    }\n+  }\n+\n+  @Override\n+  public void alertUserFreeTierExpiration(final DbUser user) throws MessagingException {\n+    final WorkbenchConfig workbenchConfig = workbenchConfigProvider.get();\n+\n+    final String logMsg =\n+        String.format(\"Free credits have expired for User %s\", user.getUsername());\n+    log.info(logMsg);", "originalCommit": "8b81f09414ac4ef1a8dda51a19e08322de76a612", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDg1NTY1NQ==", "url": "https://github.com/all-of-us/workbench/pull/3021#discussion_r370855655", "bodyText": "I don't think this should be a warning because this is an expected situation, from our system's perspective.", "author": "jmthibault79", "createdAt": "2020-01-24T21:43:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDY5NDQyOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDY5NTQ5Mw==", "url": "https://github.com/all-of-us/workbench/pull/3021#discussion_r370695493", "bodyText": "nit: cloudStorageServiceProvider.get().getImageUrl(\"all_of_us_logo.png\")) this is being repeated a lot of times, if its going to be the same i am wondering if it can be taken out, just so if we will ever change the image source we can do it at one place", "author": "NehaBroad", "createdAt": "2020-01-24T15:34:08Z", "path": "api/src/main/java/org/pmiops/workbench/mail/MailServiceImpl.java", "diffHunk": "@@ -114,25 +232,72 @@ public void sendBetaAccessCompleteEmail(final String contactEmail, final String\n   }\n \n   private Map<EmailSubstitutionField, String> betaAccessSubstitutionMap(final String username) {\n-    final CloudStorageService cloudStorageService = cloudStorageServiceProvider.get();\n-\n+    final WorkbenchConfig workbenchConfig = workbenchConfigProvider.get();\n     final String action =\n         \"login to the workbench via <a class=\\\"link\\\" href=\\\"\"\n-            + workbenchConfigProvider.get().admin.loginUrl\n+            + workbenchConfig.admin.loginUrl\n             + \"\\\">\"\n-            + workbenchConfigProvider.get().admin.loginUrl\n+            + workbenchConfig.admin.loginUrl\n             + \"</a>\";\n \n     return new ImmutableMap.Builder<EmailSubstitutionField, String>()\n         .put(EmailSubstitutionField.ACTION, action)\n         .put(EmailSubstitutionField.BETA_ACCESS_REPORT, \"approved for use\")\n         .put(\n             EmailSubstitutionField.HEADER_IMG,\n-            cloudStorageService.getImageUrl(\"all_of_us_logo.png\"))\n+            cloudStorageServiceProvider.get().getImageUrl(\"all_of_us_logo.png\"))\n         .put(EmailSubstitutionField.USERNAME, username)\n         .build();\n   }\n \n+  private ImmutableMap<EmailSubstitutionField, String> freeTierDollarThresholdSubstitutionMap(\n+      final DbUser user,\n+      double currentUsage,\n+      double remainingBalance,\n+      final Optional<Instant> expirationTimeIfKnown) {\n+\n+    final String expirationDate =\n+        expirationTimeIfKnown\n+            .map(time -> formatDate(time.atZone(ZoneId.systemDefault()).toLocalDate()))\n+            .orElse(\"[unknown]\");\n+\n+    return new ImmutableMap.Builder<EmailSubstitutionField, String>()\n+        .put(\n+            EmailSubstitutionField.HEADER_IMG,\n+            cloudStorageServiceProvider.get().getImageUrl(\"all_of_us_logo.png\"))\n+        .put(EmailSubstitutionField.FIRST_NAME, user.getGivenName())\n+        .put(EmailSubstitutionField.LAST_NAME, user.getFamilyName())\n+        .put(EmailSubstitutionField.USED_CREDITS, formatCurrency(currentUsage))\n+        .put(EmailSubstitutionField.CREDIT_BALANCE, formatCurrency(remainingBalance))\n+        .put(EmailSubstitutionField.EXPIRATION_DATE, expirationDate)\n+        .build();\n+  }\n+\n+  private ImmutableMap<EmailSubstitutionField, String> freeTierTimeThresholdSubstitutionMap(\n+      DbUser user, long daysRemaining, double remainingDollarBalance, LocalDate expirationDate) {\n+    return new ImmutableMap.Builder<EmailSubstitutionField, String>()\n+        .put(\n+            EmailSubstitutionField.HEADER_IMG,\n+            cloudStorageServiceProvider.get().getImageUrl(\"all_of_us_logo.png\"))", "originalCommit": "8b81f09414ac4ef1a8dda51a19e08322de76a612", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDg1MDU3Mw==", "url": "https://github.com/all-of-us/workbench/pull/3021#discussion_r370850573", "bodyText": "good idea, thanks", "author": "jmthibault79", "createdAt": "2020-01-24T21:29:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDY5NTQ5Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDcwNjEwNg==", "url": "https://github.com/all-of-us/workbench/pull/3021#discussion_r370706106", "bodyText": "Can we add documentation for this class", "author": "NehaBroad", "createdAt": "2020-01-24T15:53:57Z", "path": "api/src/main/java/org/pmiops/workbench/billing/FreeTierBillingService.java", "diffHunk": "@@ -34,7 +35,7 @@\n public class FreeTierBillingService {", "originalCommit": "8b81f09414ac4ef1a8dda51a19e08322de76a612", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDg1NDI4MQ==", "url": "https://github.com/all-of-us/workbench/pull/3021#discussion_r370854281", "bodyText": "what documentation would you find useful here?", "author": "jmthibault79", "createdAt": "2020-01-24T21:39:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDcwNjEwNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTU2NjE4Mg==", "url": "https://github.com/all-of-us/workbench/pull/3021#discussion_r371566182", "bodyText": "just basic javacdoc comments describing the purpose of the class", "author": "NehaBroad", "createdAt": "2020-01-28T01:05:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDcwNjEwNg=="}], "type": "inlineReview"}, {"oid": "eaa9ada72b8764a0b5e1fe8ec5c4f8d6cdadde8b", "url": "https://github.com/all-of-us/workbench/commit/eaa9ada72b8764a0b5e1fe8ec5c4f8d6cdadde8b", "message": "RW-3661 send alert emails", "committedDate": "2020-01-28T15:39:35Z", "type": "commit"}, {"oid": "eaa9ada72b8764a0b5e1fe8ec5c4f8d6cdadde8b", "url": "https://github.com/all-of-us/workbench/commit/eaa9ada72b8764a0b5e1fe8ec5c4f8d6cdadde8b", "message": "RW-3661 send alert emails", "committedDate": "2020-01-28T15:39:35Z", "type": "forcePushed"}]}