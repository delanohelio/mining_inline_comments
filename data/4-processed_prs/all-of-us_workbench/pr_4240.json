{"pr_number": 4240, "pr_title": "[RW-5419][risk=no] Runtime cost estimator widget", "pr_createdAt": "2020-11-02T18:29:40Z", "pr_url": "https://github.com/all-of-us/workbench/pull/4240", "timeline": [{"oid": "8a73b4effabcfbf7a27f396b48e9caa9313c5668", "url": "https://github.com/all-of-us/workbench/commit/8a73b4effabcfbf7a27f396b48e9caa9313c5668", "message": "dryerful of lint", "committedDate": "2020-11-02T21:27:33Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjg4MzYwNg==", "url": "https://github.com/all-of-us/workbench/pull/4240#discussion_r516883606", "bodyText": "opt nit: I would probably just inline this below, but personal preference", "author": "calbach", "createdAt": "2020-11-03T18:48:35Z", "path": "api/src/main/java/org/pmiops/workbench/api/WorkspacesController.java", "diffHunk": "@@ -963,4 +964,17 @@ private void recordOperationTime(Runnable operation, String operationName) {\n         DistributionMetric.WORKSPACE_OPERATION_TIME,\n         operation);\n   }\n+\n+  public ResponseEntity<WorkspaceCreatorFreeCreditsRemainingResponse>\n+      getWorkspaceCreatorFreeCreditsRemaining(String workspaceNamespace, String workspaceId) {\n+    workspaceService.enforceWorkspaceAccessLevelAndRegisteredAuthDomain(\n+        workspaceNamespace, workspaceId, WorkspaceAccessLevel.WRITER);\n+    DbWorkspace dbWorkspace = workspaceService.getRequired(workspaceNamespace, workspaceId);\n+    double freeCreditsRemaining =\n+        freeTierBillingService.getWorkspaceCreatorFreeCreditsRemaining(dbWorkspace);\n+    WorkspaceCreatorFreeCreditsRemainingResponse response =\n+        new WorkspaceCreatorFreeCreditsRemainingResponse()", "originalCommit": "088c63f7e172c2fb53f3ec227ccfc689f1070f30", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjg4NDc4Mg==", "url": "https://github.com/all-of-us/workbench/pull/4240#discussion_r516884782", "bodyText": "opt: Math.max(creatorFreeCreditsRemaining, 0); probably more readable than the ternary", "author": "calbach", "createdAt": "2020-11-03T18:50:40Z", "path": "api/src/main/java/org/pmiops/workbench/billing/FreeTierBillingService.java", "diffHunk": "@@ -348,4 +348,21 @@ public boolean maybeSetDollarLimitOverride(DbUser user, double newDollarLimit) {\n   public Map<Long, Double> getUserIdToTotalCost() {\n     return workspaceFreeTierUsageDao.getUserIdToTotalCost();\n   }\n+\n+  /**\n+   * Given a workspace, find the amount of free credits that the workspace creator has left.\n+   *\n+   * @param dbWorkspace The workspace for which to find its creator's free credits remaining\n+   * @return The amount of free credits in USD the workspace creator has left, represented as a\n+   *     double\n+   */\n+  public double getWorkspaceCreatorFreeCreditsRemaining(DbWorkspace dbWorkspace) {\n+    Double creatorCachedFreeTierUsage = this.getCachedFreeTierUsage(dbWorkspace.getCreator());\n+    Double creatorFreeTierDollarLimit = this.getUserFreeTierDollarLimit(dbWorkspace.getCreator());\n+    double creatorFreeCreditsRemaining =\n+        creatorCachedFreeTierUsage == null\n+            ? creatorFreeTierDollarLimit\n+            : creatorFreeTierDollarLimit - creatorCachedFreeTierUsage;\n+    return creatorFreeCreditsRemaining > 0 ? creatorFreeCreditsRemaining : 0.0;", "originalCommit": "088c63f7e172c2fb53f3ec227ccfc689f1070f30", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjg4NzMwNg==", "url": "https://github.com/all-of-us/workbench/pull/4240#discussion_r516887306", "bodyText": "nit: destructuring would make these two lines a bit shorter", "author": "calbach", "createdAt": "2020-11-03T18:55:17Z", "path": "ui/src/app/components/help-sidebar.tsx", "diffHunk": "@@ -382,14 +385,17 @@ export const HelpSidebar = fp.flow(\n       }\n     });\n \n-    componentDidMount(): void {\n+    async componentDidMount() {\n+      const {namespace, id} = this.props.workspace;\n       this.subscription = participantStore.subscribe(participant => this.setState({participant}));\n       this.subscription.add(setSidebarActiveIconStore.subscribe(activeIcon => {\n         if (activeIcon !== null) {\n           this.setState({activeIcon});\n           this.props.setSidebarState(!!activeIcon);\n         }\n       }));\n+      const workspaceCreatorFreeCreditsRemainingResponse = await workspacesApi().getWorkspaceCreatorFreeCreditsRemaining(namespace, id);", "originalCommit": "088c63f7e172c2fb53f3ec227ccfc689f1070f30", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjg4ODExNA==", "url": "https://github.com/all-of-us/workbench/pull/4240#discussion_r516888114", "bodyText": "I'm worried this may be a bit chatty - can you try watching the network tab while navigating around a bit locally? If this only gets triggered across workspace changes, that's probably fine. If it's more frequently than that we may want to move this", "author": "calbach", "createdAt": "2020-11-03T18:56:51Z", "path": "ui/src/app/components/help-sidebar.tsx", "diffHunk": "@@ -382,14 +385,17 @@ export const HelpSidebar = fp.flow(\n       }\n     });\n \n-    componentDidMount(): void {\n+    async componentDidMount() {\n+      const {namespace, id} = this.props.workspace;\n       this.subscription = participantStore.subscribe(participant => this.setState({participant}));\n       this.subscription.add(setSidebarActiveIconStore.subscribe(activeIcon => {\n         if (activeIcon !== null) {\n           this.setState({activeIcon});\n           this.props.setSidebarState(!!activeIcon);\n         }\n       }));\n+      const workspaceCreatorFreeCreditsRemainingResponse = await workspacesApi().getWorkspaceCreatorFreeCreditsRemaining(namespace, id);", "originalCommit": "088c63f7e172c2fb53f3ec227ccfc689f1070f30", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzQ4MDUyNA==", "url": "https://github.com/all-of-us/workbench/pull/4240#discussion_r517480524", "bodyText": "this gets triggered on workspace changes and on moving from the data panel to the analysis panel for the first time, because the help sidebar has different content for that. I will give making this call in the runtime panel another go.", "author": "als364", "createdAt": "2020-11-04T16:41:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjg4ODExNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjg4ODU1MQ==", "url": "https://github.com/all-of-us/workbench/pull/4240#discussion_r516888551", "bodyText": "Why put the state here rather than just in the runtime panel?", "author": "calbach", "createdAt": "2020-11-03T18:57:38Z", "path": "ui/src/app/components/help-sidebar.tsx", "diffHunk": "@@ -382,14 +385,17 @@ export const HelpSidebar = fp.flow(\n       }\n     });\n \n-    componentDidMount(): void {\n+    async componentDidMount() {\n+      const {namespace, id} = this.props.workspace;\n       this.subscription = participantStore.subscribe(participant => this.setState({participant}));\n       this.subscription.add(setSidebarActiveIconStore.subscribe(activeIcon => {\n         if (activeIcon !== null) {\n           this.setState({activeIcon});\n           this.props.setSidebarState(!!activeIcon);\n         }\n       }));\n+      const workspaceCreatorFreeCreditsRemainingResponse = await workspacesApi().getWorkspaceCreatorFreeCreditsRemaining(namespace, id);\n+      this.setState({workspaceCreatorFreeCreditsRemaining: workspaceCreatorFreeCreditsRemainingResponse.freeCreditsRemaining});", "originalCommit": "088c63f7e172c2fb53f3ec227ccfc689f1070f30", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzQzMzMxMA==", "url": "https://github.com/all-of-us/workbench/pull/4240#discussion_r517433310", "bodyText": "argh, my comment on this earlier didn't post: I was struggling to make async calls compile inside the RuntimePanel. I can have another crack at it though.", "author": "als364", "createdAt": "2020-11-04T15:36:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjg4ODU1MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzU2Mjg5NQ==", "url": "https://github.com/all-of-us/workbench/pull/4240#discussion_r517562895", "bodyText": "Probably you'll need useEffect. The current way is not terrible, so I don't feel too strongly on this point if you can't get this working or it's messy.", "author": "calbach", "createdAt": "2020-11-04T18:55:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjg4ODU1MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjg5MDAxMg==", "url": "https://github.com/all-of-us/workbench/pull/4240#discussion_r516890012", "bodyText": "opt: I like the word Estimator from your PR description slightly better than Predictor.", "author": "calbach", "createdAt": "2020-11-03T19:00:16Z", "path": "ui/src/app/pages/analysis/runtime-panel.tsx", "diffHunk": "@@ -211,24 +226,149 @@ const DataProcConfigSelector = ({onChange, dataprocConfig})  => {\n   </fieldset>;\n };\n \n-export const RuntimePanel = fp.flow(withCurrentWorkspace(), withCdrVersions())(({workspace, cdrVersionListResponse}) => {\n+const PresetSelector = ({hasMicroarrayData, setSelectedDiskSize, setSelectedMachine, setSelectedCompute, setSelectedDataprocConfig}) => {\n+  {/* Recommended runtime: pick from default templates or change the image. */}\n+  return <PopupTrigger side='bottom'\n+                closeOnClick\n+                content={\n+                  <React.Fragment>\n+                    {\n+                      fp.flow(\n+                        fp.filter(({runtimeTemplate}) => hasMicroarrayData || !runtimeTemplate.dataprocConfig),\n+                        fp.toPairs,\n+                        fp.map(([i, preset]) => {\n+                          return <MenuItem\n+                                style={styles.presetMenuItem}\n+                                key={i}\n+                                aria-label={preset.displayName}\n+                                onClick={() => {\n+                                  // renaming to avoid shadowing\n+                                  const {runtimeTemplate} = preset;\n+                                  const {presetDiskSize, presetMachineName, presetCompute} = fp.cond([\n+                                    // Can't destructure due to shadowing.\n+                                    [() => !!runtimeTemplate.gceConfig, (tmpl: Runtime) => ({\n+                                      presetDiskSize: tmpl.gceConfig.diskSize,\n+                                      presetMachineName: tmpl.gceConfig.machineType,\n+                                      presetCompute: ComputeType.Standard\n+                                    })],\n+                                    [() => !!runtimeTemplate.dataprocConfig, ({dataprocConfig: {masterDiskSize, masterMachineType}}) => ({\n+                                      presetDiskSize: masterDiskSize,\n+                                      presetMachineName: masterMachineType,\n+                                      presetCompute: ComputeType.Dataproc\n+                                    })]\n+                                  ])(runtimeTemplate);\n+                                  const presetMachineType = fp.find(({name}) => name === presetMachineName, validLeonardoMachineTypes);\n+\n+                                  setSelectedDiskSize(presetDiskSize);\n+                                  setSelectedMachine(presetMachineType);\n+                                  setSelectedCompute(presetCompute);\n+                                  setSelectedDataprocConfig(runtimeTemplate.dataprocConfig);\n+                                }}>\n+                              {preset.displayName}\n+                            </MenuItem>;\n+                        })\n+                      )(runtimePresets)\n+                    }\n+                  </React.Fragment>\n+                }>\n+    <Clickable data-test-id='runtime-presets-menu'>\n+      Recommended environments <ClrIcon shape='caret down'/>\n+    </Clickable>\n+  </PopupTrigger>;\n+};\n+\n+const CostPredictor = ({", "originalCommit": "088c63f7e172c2fb53f3ec227ccfc689f1070f30", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjg5MDgyMQ==", "url": "https://github.com/all-of-us/workbench/pull/4240#discussion_r516890821", "bodyText": "s/owner/creator/", "author": "calbach", "createdAt": "2020-11-03T19:01:44Z", "path": "ui/src/app/pages/analysis/runtime-panel.tsx", "diffHunk": "@@ -211,24 +226,149 @@ const DataProcConfigSelector = ({onChange, dataprocConfig})  => {\n   </fieldset>;\n };\n \n-export const RuntimePanel = fp.flow(withCurrentWorkspace(), withCdrVersions())(({workspace, cdrVersionListResponse}) => {\n+const PresetSelector = ({hasMicroarrayData, setSelectedDiskSize, setSelectedMachine, setSelectedCompute, setSelectedDataprocConfig}) => {\n+  {/* Recommended runtime: pick from default templates or change the image. */}\n+  return <PopupTrigger side='bottom'\n+                closeOnClick\n+                content={\n+                  <React.Fragment>\n+                    {\n+                      fp.flow(\n+                        fp.filter(({runtimeTemplate}) => hasMicroarrayData || !runtimeTemplate.dataprocConfig),\n+                        fp.toPairs,\n+                        fp.map(([i, preset]) => {\n+                          return <MenuItem\n+                                style={styles.presetMenuItem}\n+                                key={i}\n+                                aria-label={preset.displayName}\n+                                onClick={() => {\n+                                  // renaming to avoid shadowing\n+                                  const {runtimeTemplate} = preset;\n+                                  const {presetDiskSize, presetMachineName, presetCompute} = fp.cond([\n+                                    // Can't destructure due to shadowing.\n+                                    [() => !!runtimeTemplate.gceConfig, (tmpl: Runtime) => ({\n+                                      presetDiskSize: tmpl.gceConfig.diskSize,\n+                                      presetMachineName: tmpl.gceConfig.machineType,\n+                                      presetCompute: ComputeType.Standard\n+                                    })],\n+                                    [() => !!runtimeTemplate.dataprocConfig, ({dataprocConfig: {masterDiskSize, masterMachineType}}) => ({\n+                                      presetDiskSize: masterDiskSize,\n+                                      presetMachineName: masterMachineType,\n+                                      presetCompute: ComputeType.Dataproc\n+                                    })]\n+                                  ])(runtimeTemplate);\n+                                  const presetMachineType = fp.find(({name}) => name === presetMachineName, validLeonardoMachineTypes);\n+\n+                                  setSelectedDiskSize(presetDiskSize);\n+                                  setSelectedMachine(presetMachineType);\n+                                  setSelectedCompute(presetCompute);\n+                                  setSelectedDataprocConfig(runtimeTemplate.dataprocConfig);\n+                                }}>\n+                              {preset.displayName}\n+                            </MenuItem>;\n+                        })\n+                      )(runtimePresets)\n+                    }\n+                  </React.Fragment>\n+                }>\n+    <Clickable data-test-id='runtime-presets-menu'>\n+      Recommended environments <ClrIcon shape='caret down'/>\n+    </Clickable>\n+  </PopupTrigger>;\n+};\n+\n+const CostPredictor = ({\n+  freeCreditsRemaining,\n+  profile,\n+  runningCost,\n+  runningCostBreakdown,\n+  runtimeChanged,\n+  storageCost,\n+  storageCostBreakdown,\n+  workspace\n+}) => {\n+  const wrapperStyle = runtimeChanged\n+    ? {...styles.costPredictorWrapper, backgroundColor: colorWithWhiteness(colors.warning, .9), borderColor: colors.warning}\n+    : styles.costPredictorWrapper;\n+  return <FlexRow\n+    style={wrapperStyle}\n+  >\n+    <FlexRow style={{minWidth: '250px', margin: '.33rem .5rem'}}>\n+      <FlexColumn style={{marginRight: '1rem'}}>\n+        <div style={{fontSize: '10px', fontWeight: 600}}>Cost when running</div>\n+        <TooltipTrigger content={\n+          <div>\n+            <div>Cost Breakdown</div>\n+            {runningCostBreakdown.map((lineItem, i) => <div key={i}>{lineItem}</div>)}\n+          </div>\n+        }>\n+          <div style={{fontSize: '20px', color: colors.accent}}>{formatUsd(runningCost)}/hr</div>\n+        </TooltipTrigger>\n+      </FlexColumn>\n+      <FlexColumn>\n+        <div style={{fontSize: '10px', fontWeight: 600}}>Cost when paused</div>\n+        <TooltipTrigger content={\n+          <div>\n+            <div>Cost Breakdown</div>\n+            {storageCostBreakdown.map((lineItem, i) => <div key={i}>{lineItem}</div>)}\n+          </div>\n+        }>\n+          <div style={{fontSize: '20px', color: colors.accent}}>{formatUsd(storageCost)}/hr</div>\n+        </TooltipTrigger>\n+      </FlexColumn>\n+    </FlexRow>\n+    {\n+      workspace.billingAccountType === BillingAccountType.FREETIER\n+      && profile.username === workspace.creator\n+      && <div style={{borderLeft: `1px solid ${colorWithWhiteness(colors.dark, .5)}`, padding: '.33rem .5rem'}}>\n+        Costs will draw from your remaining {formatUsd(freeCreditsRemaining)} of free credits.\n+      </div>\n+    }\n+    {\n+      workspace.billingAccountType === BillingAccountType.FREETIER\n+      && profile.username !== workspace.creator\n+      && <div style={{borderLeft: `1px solid ${colorWithWhiteness(colors.dark, .5)}`, padding: '.33rem .5rem'}}>\n+        Costs will draw from workspace owner's remaining {formatUsd(freeCreditsRemaining)} of free credits.", "originalCommit": "088c63f7e172c2fb53f3ec227ccfc689f1070f30", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjg5MTI4OA==", "url": "https://github.com/all-of-us/workbench/pull/4240#discussion_r516891288", "bodyText": "nit: wrap div?", "author": "calbach", "createdAt": "2020-11-03T19:02:36Z", "path": "ui/src/app/pages/analysis/runtime-panel.tsx", "diffHunk": "@@ -211,24 +226,149 @@ const DataProcConfigSelector = ({onChange, dataprocConfig})  => {\n   </fieldset>;\n };\n \n-export const RuntimePanel = fp.flow(withCurrentWorkspace(), withCdrVersions())(({workspace, cdrVersionListResponse}) => {\n+const PresetSelector = ({hasMicroarrayData, setSelectedDiskSize, setSelectedMachine, setSelectedCompute, setSelectedDataprocConfig}) => {\n+  {/* Recommended runtime: pick from default templates or change the image. */}\n+  return <PopupTrigger side='bottom'\n+                closeOnClick\n+                content={\n+                  <React.Fragment>\n+                    {\n+                      fp.flow(\n+                        fp.filter(({runtimeTemplate}) => hasMicroarrayData || !runtimeTemplate.dataprocConfig),\n+                        fp.toPairs,\n+                        fp.map(([i, preset]) => {\n+                          return <MenuItem\n+                                style={styles.presetMenuItem}\n+                                key={i}\n+                                aria-label={preset.displayName}\n+                                onClick={() => {\n+                                  // renaming to avoid shadowing\n+                                  const {runtimeTemplate} = preset;\n+                                  const {presetDiskSize, presetMachineName, presetCompute} = fp.cond([\n+                                    // Can't destructure due to shadowing.\n+                                    [() => !!runtimeTemplate.gceConfig, (tmpl: Runtime) => ({\n+                                      presetDiskSize: tmpl.gceConfig.diskSize,\n+                                      presetMachineName: tmpl.gceConfig.machineType,\n+                                      presetCompute: ComputeType.Standard\n+                                    })],\n+                                    [() => !!runtimeTemplate.dataprocConfig, ({dataprocConfig: {masterDiskSize, masterMachineType}}) => ({\n+                                      presetDiskSize: masterDiskSize,\n+                                      presetMachineName: masterMachineType,\n+                                      presetCompute: ComputeType.Dataproc\n+                                    })]\n+                                  ])(runtimeTemplate);\n+                                  const presetMachineType = fp.find(({name}) => name === presetMachineName, validLeonardoMachineTypes);\n+\n+                                  setSelectedDiskSize(presetDiskSize);\n+                                  setSelectedMachine(presetMachineType);\n+                                  setSelectedCompute(presetCompute);\n+                                  setSelectedDataprocConfig(runtimeTemplate.dataprocConfig);\n+                                }}>\n+                              {preset.displayName}\n+                            </MenuItem>;\n+                        })\n+                      )(runtimePresets)\n+                    }\n+                  </React.Fragment>\n+                }>\n+    <Clickable data-test-id='runtime-presets-menu'>\n+      Recommended environments <ClrIcon shape='caret down'/>\n+    </Clickable>\n+  </PopupTrigger>;\n+};\n+\n+const CostPredictor = ({\n+  freeCreditsRemaining,\n+  profile,\n+  runningCost,\n+  runningCostBreakdown,\n+  runtimeChanged,\n+  storageCost,\n+  storageCostBreakdown,\n+  workspace\n+}) => {\n+  const wrapperStyle = runtimeChanged\n+    ? {...styles.costPredictorWrapper, backgroundColor: colorWithWhiteness(colors.warning, .9), borderColor: colors.warning}\n+    : styles.costPredictorWrapper;\n+  return <FlexRow\n+    style={wrapperStyle}\n+  >\n+    <FlexRow style={{minWidth: '250px', margin: '.33rem .5rem'}}>\n+      <FlexColumn style={{marginRight: '1rem'}}>\n+        <div style={{fontSize: '10px', fontWeight: 600}}>Cost when running</div>\n+        <TooltipTrigger content={\n+          <div>\n+            <div>Cost Breakdown</div>\n+            {runningCostBreakdown.map((lineItem, i) => <div key={i}>{lineItem}</div>)}\n+          </div>\n+        }>\n+          <div style={{fontSize: '20px', color: colors.accent}}>{formatUsd(runningCost)}/hr</div>\n+        </TooltipTrigger>\n+      </FlexColumn>\n+      <FlexColumn>\n+        <div style={{fontSize: '10px', fontWeight: 600}}>Cost when paused</div>\n+        <TooltipTrigger content={\n+          <div>\n+            <div>Cost Breakdown</div>\n+            {storageCostBreakdown.map((lineItem, i) => <div key={i}>{lineItem}</div>)}\n+          </div>\n+        }>\n+          <div style={{fontSize: '20px', color: colors.accent}}>{formatUsd(storageCost)}/hr</div>\n+        </TooltipTrigger>\n+      </FlexColumn>\n+    </FlexRow>\n+    {\n+      workspace.billingAccountType === BillingAccountType.FREETIER\n+      && profile.username === workspace.creator\n+      && <div style={{borderLeft: `1px solid ${colorWithWhiteness(colors.dark, .5)}`, padding: '.33rem .5rem'}}>\n+        Costs will draw from your remaining {formatUsd(freeCreditsRemaining)} of free credits.\n+      </div>\n+    }\n+    {\n+      workspace.billingAccountType === BillingAccountType.FREETIER\n+      && profile.username !== workspace.creator\n+      && <div style={{borderLeft: `1px solid ${colorWithWhiteness(colors.dark, .5)}`, padding: '.33rem .5rem'}}>\n+        Costs will draw from workspace owner's remaining {formatUsd(freeCreditsRemaining)} of free credits.\n+      </div>\n+    }\n+    {workspace.billingAccountType === BillingAccountType.USERPROVIDED && <div style={{borderLeft: `1px solid ${colorWithWhiteness(colors.dark, .5)}`, padding: '.33rem .5rem'}}>", "originalCommit": "088c63f7e172c2fb53f3ec227ccfc689f1070f30", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjg5NDQ0MQ==", "url": "https://github.com/all-of-us/workbench/pull/4240#discussion_r516894441", "bodyText": "Thanks for adding this. Technically this should probably be in @ericsong 's UI PR, since currently all changes induce restarts until we have Update integration - but I'm fine adding it here since you already did the styling.\nThe logic for runtimeNeedsRestart is also not quite correct, e.g. shrinking the disk size is illegal via Update, and will require a restart. I don't know if that's the only issue, part of the update ticket was to identify exactly which config changes are supported.\nAlternatively, just drop runtimeNeedsRestart and only show this dialog with runtimeChanged - which would currently be accurate.", "author": "calbach", "createdAt": "2020-11-03T19:08:04Z", "path": "ui/src/app/pages/analysis/runtime-panel.tsx", "diffHunk": "@@ -323,6 +458,25 @@ export const RuntimePanel = fp.flow(withCurrentWorkspace(), withCdrVersions())((\n         }\n       </FlexColumn>\n     </div>\n+    {runtimeNeedsRestart && <FlexRow\n+        style={{\n+          alignItems: 'center',\n+          backgroundColor: colorWithWhiteness(colors.warning, .9),\n+          border: `1px solid ${colors.warning}`,\n+          borderRadius: '5px',\n+          color: colors.dark,\n+          marginTop: '.5rem',\n+          padding: '.5rem 0px'\n+        }}\n+    >\n+      <ClrIcon\n+          style={{color: colors.warning, marginLeft: '.5rem'}}\n+          shape={'warning-standard'}\n+          size={16}\n+          class={'is-solid'}\n+      />\n+      <div style={{marginLeft: '.5rem'}}>You've made changes that require recreating your environment to take effect.</div>", "originalCommit": "088c63f7e172c2fb53f3ec227ccfc689f1070f30", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzQ4MjQ4OQ==", "url": "https://github.com/all-of-us/workbench/pull/4240#discussion_r517482489", "bodyText": "will do the latter", "author": "als364", "createdAt": "2020-11-04T16:44:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjg5NDQ0MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjg5NjIxMQ==", "url": "https://github.com/all-of-us/workbench/pull/4240#discussion_r516896211", "bodyText": "While our UI doesn't currently support 0 node Dataproc clusters, they are legal, so I would probably handle this case", "author": "calbach", "createdAt": "2020-11-03T19:10:59Z", "path": "ui/src/app/utils/machines.ts", "diffHunk": "@@ -45,5 +51,92 @@ export const allMachineTypes = fp.map(({ price, preemptiblePrice, ...details })\n // See https://broadworkbench.atlassian.net/browse/SATURN-1337\n export const validLeonardoMachineTypes = allMachineTypes.filter(({memory}) => memory >= 4);\n \n+export const findMachineByName = (machineToFind: string) => fp.find(({name}) => name === machineToFind, allMachineTypes);\n+\n export const diskPrice = 0.04 / 730; // per GB hour, from https://cloud.google.com/compute/pricing\n export const dataprocCpuPrice = 0.01; // dataproc costs $0.01 per cpu per hour\n+\n+export const machineStoragePrice = ({masterDiskSize, numberOfWorkers, workerDiskSize }) => {\n+  if (numberOfWorkers && workerDiskSize) {\n+    return (masterDiskSize + numberOfWorkers * workerDiskSize) * diskPrice;\n+  } else {\n+    return masterDiskSize * diskPrice;\n+  }\n+};\n+\n+export const machineStorageCostBreakdown = ({masterDiskSize, numberOfWorkers, workerDiskSize}) => {\n+  const costs = [];\n+  if (numberOfWorkers && workerDiskSize) {\n+    costs.push(`${formatUsd(masterDiskSize * diskPrice)}/hr Master Disk`);\n+    costs.push(`${formatUsd((numberOfWorkers * workerDiskSize) * diskPrice)}/hr Worker Disks`);\n+  } else {\n+    costs.push(`${formatUsd(masterDiskSize * diskPrice)}/hr Disk`);\n+  }\n+  return costs;\n+};\n+\n+export const machineRunningPrice = ({\n+  computeType,\n+  masterDiskSize,\n+  masterMachineName,\n+  numberOfWorkers = 0,\n+  numberOfPreemptibleWorkers = 0,\n+  workerDiskSize,\n+  workerMachineName\n+}) => {\n+  const masterMachine = findMachineByName(masterMachineName);\n+  const workerMachine = workerMachineName && findMachineByName(workerMachineName);\n+\n+  if (computeType === ComputeType.Dataproc && !workerMachine) {", "originalCommit": "088c63f7e172c2fb53f3ec227ccfc689f1070f30", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjg5ODA2MA==", "url": "https://github.com/all-of-us/workbench/pull/4240#discussion_r516898060", "bodyText": "See above comment, returning [] here implies 0 cost for a 0 node cluster, which is not correct (though it can also never happen in the current UI)", "author": "calbach", "createdAt": "2020-11-03T19:14:29Z", "path": "ui/src/app/utils/machines.ts", "diffHunk": "@@ -45,5 +51,92 @@ export const allMachineTypes = fp.map(({ price, preemptiblePrice, ...details })\n // See https://broadworkbench.atlassian.net/browse/SATURN-1337\n export const validLeonardoMachineTypes = allMachineTypes.filter(({memory}) => memory >= 4);\n \n+export const findMachineByName = (machineToFind: string) => fp.find(({name}) => name === machineToFind, allMachineTypes);\n+\n export const diskPrice = 0.04 / 730; // per GB hour, from https://cloud.google.com/compute/pricing\n export const dataprocCpuPrice = 0.01; // dataproc costs $0.01 per cpu per hour\n+\n+export const machineStoragePrice = ({masterDiskSize, numberOfWorkers, workerDiskSize }) => {\n+  if (numberOfWorkers && workerDiskSize) {\n+    return (masterDiskSize + numberOfWorkers * workerDiskSize) * diskPrice;\n+  } else {\n+    return masterDiskSize * diskPrice;\n+  }\n+};\n+\n+export const machineStorageCostBreakdown = ({masterDiskSize, numberOfWorkers, workerDiskSize}) => {\n+  const costs = [];\n+  if (numberOfWorkers && workerDiskSize) {\n+    costs.push(`${formatUsd(masterDiskSize * diskPrice)}/hr Master Disk`);\n+    costs.push(`${formatUsd((numberOfWorkers * workerDiskSize) * diskPrice)}/hr Worker Disks`);\n+  } else {\n+    costs.push(`${formatUsd(masterDiskSize * diskPrice)}/hr Disk`);\n+  }\n+  return costs;\n+};\n+\n+export const machineRunningPrice = ({\n+  computeType,\n+  masterDiskSize,\n+  masterMachineName,\n+  numberOfWorkers = 0,\n+  numberOfPreemptibleWorkers = 0,\n+  workerDiskSize,\n+  workerMachineName\n+}) => {\n+  const masterMachine = findMachineByName(masterMachineName);\n+  const workerMachine = workerMachineName && findMachineByName(workerMachineName);\n+\n+  if (computeType === ComputeType.Dataproc && !workerMachine) {\n+    return NaN;\n+  }\n+\n+  const dataprocPrice = computeType === ComputeType.Dataproc\n+    ? fp.sum([\n+      (masterMachine.cpu + ((numberOfWorkers + numberOfPreemptibleWorkers) * workerMachine.cpu)) * dataprocCpuPrice,\n+      numberOfWorkers * workerMachine.price,\n+      numberOfPreemptibleWorkers * workerMachine.preemptiblePrice,\n+    ])\n+    : 0;\n+  return fp.sum([\n+    dataprocPrice,\n+    masterMachine.price,\n+    machineStoragePrice({masterDiskSize: masterDiskSize, numberOfWorkers: numberOfWorkers, workerDiskSize: workerDiskSize})\n+  ]);\n+};\n+\n+export const machineRunningCostBreakdown = ({\n+  computeType,\n+  masterDiskSize,\n+  masterMachineName,\n+  numberOfWorkers = 0,\n+  numberOfPreemptibleWorkers = 0,\n+  workerDiskSize,\n+  workerMachineName\n+}) => {\n+  const masterMachine = findMachineByName(masterMachineName);\n+  const costs = [];\n+  if (computeType === ComputeType.Dataproc) {\n+    const workerMachine = workerMachineName && findMachineByName(workerMachineName);\n+    if (!workerMachine) {\n+      return costs;", "originalCommit": "088c63f7e172c2fb53f3ec227ccfc689f1070f30", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjg5ODYxMQ==", "url": "https://github.com/all-of-us/workbench/pull/4240#discussion_r516898611", "bodyText": "nit: pull this out into a helper? This computation is duplicated here and above", "author": "calbach", "createdAt": "2020-11-03T19:15:25Z", "path": "ui/src/app/utils/machines.ts", "diffHunk": "@@ -45,5 +51,92 @@ export const allMachineTypes = fp.map(({ price, preemptiblePrice, ...details })\n // See https://broadworkbench.atlassian.net/browse/SATURN-1337\n export const validLeonardoMachineTypes = allMachineTypes.filter(({memory}) => memory >= 4);\n \n+export const findMachineByName = (machineToFind: string) => fp.find(({name}) => name === machineToFind, allMachineTypes);\n+\n export const diskPrice = 0.04 / 730; // per GB hour, from https://cloud.google.com/compute/pricing\n export const dataprocCpuPrice = 0.01; // dataproc costs $0.01 per cpu per hour\n+\n+export const machineStoragePrice = ({masterDiskSize, numberOfWorkers, workerDiskSize }) => {\n+  if (numberOfWorkers && workerDiskSize) {\n+    return (masterDiskSize + numberOfWorkers * workerDiskSize) * diskPrice;\n+  } else {\n+    return masterDiskSize * diskPrice;\n+  }\n+};\n+\n+export const machineStorageCostBreakdown = ({masterDiskSize, numberOfWorkers, workerDiskSize}) => {\n+  const costs = [];\n+  if (numberOfWorkers && workerDiskSize) {\n+    costs.push(`${formatUsd(masterDiskSize * diskPrice)}/hr Master Disk`);\n+    costs.push(`${formatUsd((numberOfWorkers * workerDiskSize) * diskPrice)}/hr Worker Disks`);\n+  } else {\n+    costs.push(`${formatUsd(masterDiskSize * diskPrice)}/hr Disk`);\n+  }\n+  return costs;\n+};\n+\n+export const machineRunningPrice = ({\n+  computeType,\n+  masterDiskSize,\n+  masterMachineName,\n+  numberOfWorkers = 0,\n+  numberOfPreemptibleWorkers = 0,\n+  workerDiskSize,\n+  workerMachineName\n+}) => {\n+  const masterMachine = findMachineByName(masterMachineName);\n+  const workerMachine = workerMachineName && findMachineByName(workerMachineName);\n+\n+  if (computeType === ComputeType.Dataproc && !workerMachine) {\n+    return NaN;\n+  }\n+\n+  const dataprocPrice = computeType === ComputeType.Dataproc\n+    ? fp.sum([\n+      (masterMachine.cpu + ((numberOfWorkers + numberOfPreemptibleWorkers) * workerMachine.cpu)) * dataprocCpuPrice,\n+      numberOfWorkers * workerMachine.price,\n+      numberOfPreemptibleWorkers * workerMachine.preemptiblePrice,\n+    ])\n+    : 0;\n+  return fp.sum([\n+    dataprocPrice,\n+    masterMachine.price,\n+    machineStoragePrice({masterDiskSize: masterDiskSize, numberOfWorkers: numberOfWorkers, workerDiskSize: workerDiskSize})\n+  ]);\n+};\n+\n+export const machineRunningCostBreakdown = ({\n+  computeType,\n+  masterDiskSize,\n+  masterMachineName,\n+  numberOfWorkers = 0,\n+  numberOfPreemptibleWorkers = 0,\n+  workerDiskSize,\n+  workerMachineName\n+}) => {\n+  const masterMachine = findMachineByName(masterMachineName);\n+  const costs = [];\n+  if (computeType === ComputeType.Dataproc) {\n+    const workerMachine = workerMachineName && findMachineByName(workerMachineName);\n+    if (!workerMachine) {\n+      return costs;\n+    }\n+    costs.push(`${formatUsd(masterMachine.price)}/hr Master VM`);\n+    if (numberOfWorkers > 0) {\n+      costs.push(`${formatUsd(workerMachine.price  * numberOfWorkers)}/hr Worker VM(s) (${numberOfWorkers})`);\n+    }\n+    if (numberOfPreemptibleWorkers > 0) {\n+      costs.push(\n+        `${formatUsd(workerMachine.preemptiblePrice * numberOfPreemptibleWorkers)}/hr Preemptible Worker VM(s) (${numberOfPreemptibleWorkers})`\n+      );\n+    }\n+    const dataprocPrice = (masterMachine.cpu + ((numberOfWorkers + numberOfPreemptibleWorkers) * workerMachine.cpu)) * dataprocCpuPrice;", "originalCommit": "088c63f7e172c2fb53f3ec227ccfc689f1070f30", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjkwMDA5Nw==", "url": "https://github.com/all-of-us/workbench/pull/4240#discussion_r516900097", "bodyText": "number of preemptible workers is not considered in this calculation - is that intentional?", "author": "calbach", "createdAt": "2020-11-03T19:18:22Z", "path": "ui/src/app/utils/machines.ts", "diffHunk": "@@ -45,5 +51,92 @@ export const allMachineTypes = fp.map(({ price, preemptiblePrice, ...details })\n // See https://broadworkbench.atlassian.net/browse/SATURN-1337\n export const validLeonardoMachineTypes = allMachineTypes.filter(({memory}) => memory >= 4);\n \n+export const findMachineByName = (machineToFind: string) => fp.find(({name}) => name === machineToFind, allMachineTypes);\n+\n export const diskPrice = 0.04 / 730; // per GB hour, from https://cloud.google.com/compute/pricing\n export const dataprocCpuPrice = 0.01; // dataproc costs $0.01 per cpu per hour\n+\n+export const machineStoragePrice = ({masterDiskSize, numberOfWorkers, workerDiskSize }) => {\n+  if (numberOfWorkers && workerDiskSize) {\n+    return (masterDiskSize + numberOfWorkers * workerDiskSize) * diskPrice;\n+  } else {\n+    return masterDiskSize * diskPrice;\n+  }\n+};\n+\n+export const machineStorageCostBreakdown = ({masterDiskSize, numberOfWorkers, workerDiskSize}) => {\n+  const costs = [];\n+  if (numberOfWorkers && workerDiskSize) {\n+    costs.push(`${formatUsd(masterDiskSize * diskPrice)}/hr Master Disk`);\n+    costs.push(`${formatUsd((numberOfWorkers * workerDiskSize) * diskPrice)}/hr Worker Disks`);\n+  } else {\n+    costs.push(`${formatUsd(masterDiskSize * diskPrice)}/hr Disk`);\n+  }\n+  return costs;\n+};\n+\n+export const machineRunningPrice = ({\n+  computeType,\n+  masterDiskSize,\n+  masterMachineName,\n+  numberOfWorkers = 0,\n+  numberOfPreemptibleWorkers = 0,\n+  workerDiskSize,\n+  workerMachineName\n+}) => {\n+  const masterMachine = findMachineByName(masterMachineName);\n+  const workerMachine = workerMachineName && findMachineByName(workerMachineName);\n+\n+  if (computeType === ComputeType.Dataproc && !workerMachine) {\n+    return NaN;\n+  }\n+\n+  const dataprocPrice = computeType === ComputeType.Dataproc\n+    ? fp.sum([\n+      (masterMachine.cpu + ((numberOfWorkers + numberOfPreemptibleWorkers) * workerMachine.cpu)) * dataprocCpuPrice,\n+      numberOfWorkers * workerMachine.price,\n+      numberOfPreemptibleWorkers * workerMachine.preemptiblePrice,\n+    ])\n+    : 0;\n+  return fp.sum([\n+    dataprocPrice,\n+    masterMachine.price,\n+    machineStoragePrice({masterDiskSize: masterDiskSize, numberOfWorkers: numberOfWorkers, workerDiskSize: workerDiskSize})", "originalCommit": "088c63f7e172c2fb53f3ec227ccfc689f1070f30", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzU1ODMyNw==", "url": "https://github.com/all-of-us/workbench/pull/4240#discussion_r517558327", "bodyText": "It is included in the dataproc price. This could be named clearer.", "author": "als364", "createdAt": "2020-11-04T18:48:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjkwMDA5Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzU2NDAzNA==", "url": "https://github.com/all-of-us/workbench/pull/4240#discussion_r517564034", "bodyText": "The dataproc price just includes machine prices. I'm asking why preemptible workers are not considered on this specific line for the storage price computation.", "author": "calbach", "createdAt": "2020-11-04T18:57:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjkwMDA5Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzU2NjM3NQ==", "url": "https://github.com/all-of-us/workbench/pull/4240#discussion_r517566375", "bodyText": "because Terra doesn't consider them: https://github.com/DataBiosphere/terra-ui/blob/cf5ec4408db3bd1fcdbcc5302da62d42e4d03ca3/src/components/ClusterManager.js#L85", "author": "als364", "createdAt": "2020-11-04T19:02:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjkwMDA5Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzU3MTIzNA==", "url": "https://github.com/all-of-us/workbench/pull/4240#discussion_r517571234", "bodyText": "although, looking at GCE docs, I think it should.", "author": "als364", "createdAt": "2020-11-04T19:10:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjkwMDA5Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjkwMDQyOQ==", "url": "https://github.com/all-of-us/workbench/pull/4240#discussion_r516900429", "bodyText": "nit: rm trailing param space", "author": "calbach", "createdAt": "2020-11-03T19:19:03Z", "path": "ui/src/app/utils/machines.ts", "diffHunk": "@@ -45,5 +51,92 @@ export const allMachineTypes = fp.map(({ price, preemptiblePrice, ...details })\n // See https://broadworkbench.atlassian.net/browse/SATURN-1337\n export const validLeonardoMachineTypes = allMachineTypes.filter(({memory}) => memory >= 4);\n \n+export const findMachineByName = (machineToFind: string) => fp.find(({name}) => name === machineToFind, allMachineTypes);\n+\n export const diskPrice = 0.04 / 730; // per GB hour, from https://cloud.google.com/compute/pricing\n export const dataprocCpuPrice = 0.01; // dataproc costs $0.01 per cpu per hour\n+\n+export const machineStoragePrice = ({masterDiskSize, numberOfWorkers, workerDiskSize }) => {", "originalCommit": "088c63f7e172c2fb53f3ec227ccfc689f1070f30", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjkwMzkxNQ==", "url": "https://github.com/all-of-us/workbench/pull/4240#discussion_r516903915", "bodyText": "Nice work on these utilities. Did you reference the Terra UI's implementation at all? If not - it would be good to do so now so we're aware of any discrepancies.", "author": "calbach", "createdAt": "2020-11-03T19:25:41Z", "path": "ui/src/app/utils/machines.ts", "diffHunk": "@@ -45,5 +51,92 @@ export const allMachineTypes = fp.map(({ price, preemptiblePrice, ...details })\n // See https://broadworkbench.atlassian.net/browse/SATURN-1337\n export const validLeonardoMachineTypes = allMachineTypes.filter(({memory}) => memory >= 4);\n \n+export const findMachineByName = (machineToFind: string) => fp.find(({name}) => name === machineToFind, allMachineTypes);\n+\n export const diskPrice = 0.04 / 730; // per GB hour, from https://cloud.google.com/compute/pricing\n export const dataprocCpuPrice = 0.01; // dataproc costs $0.01 per cpu per hour\n+\n+export const machineStoragePrice = ({masterDiskSize, numberOfWorkers, workerDiskSize }) => {\n+  if (numberOfWorkers && workerDiskSize) {\n+    return (masterDiskSize + numberOfWorkers * workerDiskSize) * diskPrice;\n+  } else {\n+    return masterDiskSize * diskPrice;\n+  }\n+};\n+\n+export const machineStorageCostBreakdown = ({masterDiskSize, numberOfWorkers, workerDiskSize}) => {\n+  const costs = [];\n+  if (numberOfWorkers && workerDiskSize) {\n+    costs.push(`${formatUsd(masterDiskSize * diskPrice)}/hr Master Disk`);\n+    costs.push(`${formatUsd((numberOfWorkers * workerDiskSize) * diskPrice)}/hr Worker Disks`);\n+  } else {\n+    costs.push(`${formatUsd(masterDiskSize * diskPrice)}/hr Disk`);\n+  }\n+  return costs;\n+};\n+\n+export const machineRunningPrice = ({\n+  computeType,\n+  masterDiskSize,\n+  masterMachineName,\n+  numberOfWorkers = 0,\n+  numberOfPreemptibleWorkers = 0,\n+  workerDiskSize,\n+  workerMachineName\n+}) => {\n+  const masterMachine = findMachineByName(masterMachineName);\n+  const workerMachine = workerMachineName && findMachineByName(workerMachineName);\n+\n+  if (computeType === ComputeType.Dataproc && !workerMachine) {\n+    return NaN;\n+  }\n+\n+  const dataprocPrice = computeType === ComputeType.Dataproc\n+    ? fp.sum([\n+      (masterMachine.cpu + ((numberOfWorkers + numberOfPreemptibleWorkers) * workerMachine.cpu)) * dataprocCpuPrice,\n+      numberOfWorkers * workerMachine.price,\n+      numberOfPreemptibleWorkers * workerMachine.preemptiblePrice,\n+    ])\n+    : 0;\n+  return fp.sum([\n+    dataprocPrice,\n+    masterMachine.price,\n+    machineStoragePrice({masterDiskSize: masterDiskSize, numberOfWorkers: numberOfWorkers, workerDiskSize: workerDiskSize})\n+  ]);\n+};\n+\n+export const machineRunningCostBreakdown = ({", "originalCommit": "088c63f7e172c2fb53f3ec227ccfc689f1070f30", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzU1ODYzMA==", "url": "https://github.com/all-of-us/workbench/pull/4240#discussion_r517558630", "bodyText": "Terra actually doesn't have this tooltip feature as far as I can tell.", "author": "als364", "createdAt": "2020-11-04T18:48:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjkwMzkxNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzU2MzQxMQ==", "url": "https://github.com/all-of-us/workbench/pull/4240#discussion_r517563411", "bodyText": "SOrry, I commented on the wrong line - I meant this comment generally about the overall price computation.", "author": "calbach", "createdAt": "2020-11-04T18:56:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjkwMzkxNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzU2NzAwMw==", "url": "https://github.com/all-of-us/workbench/pull/4240#discussion_r517567003", "bodyText": "Oh! Yes, I referenced Terra's implementation. I can link to the file from this file for future reference.", "author": "als364", "createdAt": "2020-11-04T19:03:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjkwMzkxNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzcxMzg3OA==", "url": "https://github.com/all-of-us/workbench/pull/4240#discussion_r517713878", "bodyText": "nit: single quotes", "author": "calbach", "createdAt": "2020-11-05T00:38:59Z", "path": "ui/src/app/pages/analysis/runtime-panel.spec.tsx", "diffHunk": "@@ -17,6 +17,7 @@ import {runtimeStore} from 'app/utils/stores';\n import {cdrVersionListResponse, CdrVersionsStubVariables} from 'testing/stubs/cdr-versions-api-stub';\n import {cdrVersionStore, serverConfigStore} from 'app/utils/navigation';\n import { RuntimeConfigurationType } from 'generated/fetch';\n+import {ComputeType} from \"app/utils/machines\";", "originalCommit": "06a131a31895b23659e9628b311dfee2849ba047", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzcxNTkwMA==", "url": "https://github.com/all-of-us/workbench/pull/4240#discussion_r517715900", "bodyText": "nit: correct pattern here is probably to create a new AbortController(), pass {signal: aborter.signal} on the API fetch, then return () => aborter.abort() from this useEffect callback as a cleanup.\nThis way, if the component gets dismounted, we cancel the fetch.", "author": "calbach", "createdAt": "2020-11-05T00:45:52Z", "path": "ui/src/app/pages/analysis/runtime-panel.tsx", "diffHunk": "@@ -211,24 +227,159 @@ const DataProcConfigSelector = ({onChange, dataprocConfig})  => {\n   </fieldset>;\n };\n \n-export const RuntimePanel = fp.flow(withCurrentWorkspace(), withCdrVersions())(({workspace, cdrVersionListResponse}) => {\n-  const {namespace, cdrVersionId} = workspace;\n+const PresetSelector = ({hasMicroarrayData, setSelectedDiskSize, setSelectedMachine, setSelectedCompute, setSelectedDataprocConfig}) => {\n+  {/* Recommended runtime: pick from default templates or change the image. */}\n+  return <PopupTrigger side='bottom'\n+                closeOnClick\n+                content={\n+                  <React.Fragment>\n+                    {\n+                      fp.flow(\n+                        fp.filter(({runtimeTemplate}) => hasMicroarrayData || !runtimeTemplate.dataprocConfig),\n+                        fp.toPairs,\n+                        fp.map(([i, preset]) => {\n+                          return <MenuItem\n+                                style={styles.presetMenuItem}\n+                                key={i}\n+                                aria-label={preset.displayName}\n+                                onClick={() => {\n+                                  // renaming to avoid shadowing\n+                                  const {runtimeTemplate} = preset;\n+                                  const {presetDiskSize, presetMachineName, presetCompute} = fp.cond([\n+                                    // Can't destructure due to shadowing.\n+                                    [() => !!runtimeTemplate.gceConfig, (tmpl: Runtime) => ({\n+                                      presetDiskSize: tmpl.gceConfig.diskSize,\n+                                      presetMachineName: tmpl.gceConfig.machineType,\n+                                      presetCompute: ComputeType.Standard\n+                                    })],\n+                                    [() => !!runtimeTemplate.dataprocConfig, ({dataprocConfig: {masterDiskSize, masterMachineType}}) => ({\n+                                      presetDiskSize: masterDiskSize,\n+                                      presetMachineName: masterMachineType,\n+                                      presetCompute: ComputeType.Dataproc\n+                                    })]\n+                                  ])(runtimeTemplate);\n+                                  const presetMachineType = fp.find(({name}) => name === presetMachineName, validLeonardoMachineTypes);\n+\n+                                  setSelectedDiskSize(presetDiskSize);\n+                                  setSelectedMachine(presetMachineType);\n+                                  setSelectedCompute(presetCompute);\n+                                  setSelectedDataprocConfig(runtimeTemplate.dataprocConfig);\n+                                }}>\n+                              {preset.displayName}\n+                            </MenuItem>;\n+                        })\n+                      )(runtimePresets)\n+                    }\n+                  </React.Fragment>\n+                }>\n+    <Clickable data-test-id='runtime-presets-menu'>\n+      Recommended environments <ClrIcon shape='caret down'/>\n+    </Clickable>\n+  </PopupTrigger>;\n+};\n+\n+const CostEstimator = ({\n+  freeCreditsRemaining,\n+  profile,\n+  runningCost,\n+  runningCostBreakdown,\n+  runtimeChanged,\n+  storageCost,\n+  storageCostBreakdown,\n+  workspace\n+}) => {\n+  const wrapperStyle = runtimeChanged\n+    ? {...styles.costPredictorWrapper, backgroundColor: colorWithWhiteness(colors.warning, .9), borderColor: colors.warning}\n+    : styles.costPredictorWrapper;\n+  return <FlexRow\n+    style={wrapperStyle}\n+  >\n+    <FlexRow style={{minWidth: '250px', margin: '.33rem .5rem'}}>\n+      <FlexColumn style={{marginRight: '1rem'}}>\n+        <div style={{fontSize: '10px', fontWeight: 600}}>Cost when running</div>\n+        <TooltipTrigger content={\n+          <div>\n+            <div>Cost Breakdown</div>\n+            {runningCostBreakdown.map((lineItem, i) => <div key={i}>{lineItem}</div>)}\n+          </div>\n+        }>\n+          <div style={{fontSize: '20px', color: colors.accent}}>{formatUsd(runningCost)}/hr</div>\n+        </TooltipTrigger>\n+      </FlexColumn>\n+      <FlexColumn>\n+        <div style={{fontSize: '10px', fontWeight: 600}}>Cost when paused</div>\n+        <TooltipTrigger content={\n+          <div>\n+            <div>Cost Breakdown</div>\n+            {storageCostBreakdown.map((lineItem, i) => <div key={i}>{lineItem}</div>)}\n+          </div>\n+        }>\n+          <div style={{fontSize: '20px', color: colors.accent}}>{formatUsd(storageCost)}/hr</div>\n+        </TooltipTrigger>\n+      </FlexColumn>\n+    </FlexRow>\n+    {\n+      workspace.billingAccountType === BillingAccountType.FREETIER\n+      && profile.username === workspace.creator\n+      && <div style={{borderLeft: `1px solid ${colorWithWhiteness(colors.dark, .5)}`, padding: '.33rem .5rem'}}>\n+        Costs will draw from your remaining {formatUsd(freeCreditsRemaining)} of free credits.\n+      </div>\n+    }\n+    {\n+      workspace.billingAccountType === BillingAccountType.FREETIER\n+      && profile.username !== workspace.creator\n+      && <div style={{borderLeft: `1px solid ${colorWithWhiteness(colors.dark, .5)}`, padding: '.33rem .5rem'}}>\n+        Costs will draw from workspace creator's remaining {formatUsd(freeCreditsRemaining)} of free credits.\n+      </div>\n+    }\n+    {\n+      workspace.billingAccountType === BillingAccountType.USERPROVIDED\n+      && <div style={{borderLeft: `1px solid ${colorWithWhiteness(colors.dark, .5)}`, padding: '.33rem .5rem'}}>\n+        Costs will be charged to billing account {workspace.billingAccountName}.\n+      </div>\n+    }\n+  </FlexRow>;\n+};\n+\n+export const RuntimePanel = fp.flow(\n+  withCdrVersions(),\n+  withCurrentWorkspace(),\n+  withUserProfile()\n+)(({cdrVersionListResponse, workspace, profileState}) => {\n+  const {namespace, id, cdrVersionId} = workspace;\n+\n+  const {profile} = profileState;\n+\n   const {hasMicroarrayData} = fp.find({cdrVersionId}, cdrVersionListResponse.items) || {hasMicroarrayData: false};\n   const [currentRuntime, setRequestedRuntime] = useCustomRuntime(namespace);\n+\n   const {status = null, dataprocConfig = null, gceConfig = {diskSize: defaultDiskSize}} = currentRuntime || {} as Partial<Runtime>;\n-  const machineName = !!dataprocConfig ? dataprocConfig.masterMachineType : gceConfig.machineType;\n-  const diskSize = !!dataprocConfig ? dataprocConfig.masterDiskSize : gceConfig.diskSize;\n-  const initialMasterMachine = findMachineByName(machineName);\n+  const diskSize = dataprocConfig ? dataprocConfig.masterDiskSize : gceConfig.diskSize;\n+  const machineName = dataprocConfig ? dataprocConfig.masterMachineType : gceConfig.machineType;\n+  const initialMasterMachine = findMachineByName(machineName) || defaultMachineType;\n+  const initialCompute = dataprocConfig ? ComputeType.Dataproc : ComputeType.Standard;\n+\n   const [selectedDiskSize, setSelectedDiskSize] = useState(diskSize);\n   const [selectedMachine, setSelectedMachine] = useState(initialMasterMachine);\n-  const [selectedCompute, setSelectedCompute] = useState<ComputeType>(dataprocConfig ? ComputeType.Dataproc : ComputeType.Standard);\n+  const [selectedCompute, setSelectedCompute] = useState<ComputeType>(initialCompute);\n   const [selectedDataprocConfig, setSelectedDataprocConfig] = useState<DataprocConfig | null>(dataprocConfig);\n \n   const selectedMachineType = selectedMachine && selectedMachine.name;\n   const runtimeExists = status && status !== RuntimeStatus.Deleted;\n   const runtimeChanged = !fp.equals(selectedMachine, initialMasterMachine) ||\n     selectedDiskSize !== diskSize ||\n-    !fp.equals(selectedDataprocConfig, dataprocConfig);\n+    !fp.equals(selectedDataprocConfig, dataprocConfig) ||\n+    !fp.equals(selectedCompute, initialCompute);\n+\n+  const [creatorFreeCreditsRemaining, setCreatorFreeCreditsRemaining] = useState(0);\n+  useEffect(() => {\n+    const fetchFreeCredits = async() => {", "originalCommit": "06a131a31895b23659e9628b311dfee2849ba047", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzcxNzI2OA==", "url": "https://github.com/all-of-us/workbench/pull/4240#discussion_r517717268", "bodyText": "Lots of repeated code here with these 4 parameters, perhaps this should just be a single object payload, then let the CostEstimator pass these through to the utilities?", "author": "calbach", "createdAt": "2020-11-05T00:50:30Z", "path": "ui/src/app/pages/analysis/runtime-panel.tsx", "diffHunk": "@@ -243,55 +394,52 @@ export const RuntimePanel = fp.flow(withCurrentWorkspace(), withCdrVersions())((\n     </div>\n     {/* TODO(RW-5419): Cost estimates go here. */}\n     <div style={styles.controlSection}>\n-      {/* Recommended runtime: pick from default templates or change the image. */}\n-      <PopupTrigger side='bottom'\n-                    closeOnClick\n-                    content={\n-                      <React.Fragment>\n-                        {\n-                          fp.flow(\n-                            fp.filter(({runtimeTemplate}) => hasMicroarrayData || !runtimeTemplate.dataprocConfig),\n-                            fp.toPairs,\n-                            fp.map(([i, preset]) => {\n-                              return <MenuItem\n-                              style={styles.presetMenuItem}\n-                              key={i}\n-                              aria-label={preset.displayName}\n-                              onClick={() => {\n-                                // renaming to avoid shadowing\n-                                const {runtimeTemplate} = preset;\n-                                const {presetDiskSize, presetMachineName, presetCompute} = fp.cond([\n-                                  // Can't destructure due to shadowing.\n-                                  [() => !!runtimeTemplate.gceConfig, (tmpl: Runtime) => ({\n-                                    presetDiskSize: tmpl.gceConfig.diskSize,\n-                                    presetMachineName: tmpl.gceConfig.machineType,\n-                                    presetCompute: ComputeType.Standard\n-                                  })],\n-                                  [() => !!runtimeTemplate.dataprocConfig, ({dataprocConfig: {masterDiskSize, masterMachineType}}) => ({\n-                                    presetDiskSize: masterDiskSize,\n-                                    presetMachineName: masterMachineType,\n-                                    presetCompute: ComputeType.Dataproc\n-                                  })]\n-                                ])(runtimeTemplate);\n-                                const presetMachineType = fp.find(({name}) => name === presetMachineName, validLeonardoMachineTypes);\n+      <CostEstimator\n+          freeCreditsRemaining={creatorFreeCreditsRemaining}\n+          profile={profile}\n+          runningCost={machineRunningPrice({\n+            computeType: selectedCompute,", "originalCommit": "06a131a31895b23659e9628b311dfee2849ba047", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzcxNzc0OA==", "url": "https://github.com/all-of-us/workbench/pull/4240#discussion_r517717748", "bodyText": "note: reminder to rebase this, since I changed this a bit in my PR", "author": "calbach", "createdAt": "2020-11-05T00:52:01Z", "path": "ui/src/app/utils/leo-runtime-initializer.tsx", "diffHunk": "@@ -13,8 +13,11 @@ import {serverConfigStore} from './navigation';\n // We're only willing to wait 20 minutes total for a runtime to initialize. After that we return\n // a rejected promise no matter what.\n const DEFAULT_OVERALL_TIMEOUT = 1000 * 60 * 20;\n-const DEFAULT_INITIAL_POLLING_DELAY = 2000;\n+// XXX: Hack for unit testing.\n+let DEFAULT_INITIAL_POLLING_DELAY = 2000;", "originalCommit": "06a131a31895b23659e9628b311dfee2849ba047", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "cdb049eb02b945a5883aba1a769b6d76bdfc6d2f", "url": "https://github.com/all-of-us/workbench/commit/cdb049eb02b945a5883aba1a769b6d76bdfc6d2f", "message": "Initial preset and dataproc fixes", "committedDate": "2020-11-05T16:49:41Z", "type": "commit"}, {"oid": "d4c04094e835a62d1a5cc7014d1e0965c832c14b", "url": "https://github.com/all-of-us/workbench/commit/d4c04094e835a62d1a5cc7014d1e0965c832c14b", "message": "first pass", "committedDate": "2020-11-05T16:49:42Z", "type": "commit"}, {"oid": "ff12bc635157fc5702c7db32cdabaf733458952d", "url": "https://github.com/all-of-us/workbench/commit/ff12bc635157fc5702c7db32cdabaf733458952d", "message": "dynamic update styling", "committedDate": "2020-11-05T16:49:42Z", "type": "commit"}, {"oid": "0b68da8d3131377ae92ea6ba8e7ccc1bbea53b3d", "url": "https://github.com/all-of-us/workbench/commit/0b68da8d3131377ae92ea6ba8e7ccc1bbea53b3d", "message": "shelving", "committedDate": "2020-11-05T16:49:42Z", "type": "commit"}, {"oid": "0aba36ed19766561b60690d57e5cc70152cb849e", "url": "https://github.com/all-of-us/workbench/commit/0aba36ed19766561b60690d57e5cc70152cb849e", "message": "free credits", "committedDate": "2020-11-05T16:49:42Z", "type": "commit"}, {"oid": "ba08455e2e3261471d03f5b48c2a87df3e5f3ef4", "url": "https://github.com/all-of-us/workbench/commit/ba08455e2e3261471d03f5b48c2a87df3e5f3ef4", "message": "billing account name", "committedDate": "2020-11-05T16:49:42Z", "type": "commit"}, {"oid": "880d4ac8258b32a50230b2306dbf55ae70fb62ec", "url": "https://github.com/all-of-us/workbench/commit/880d4ac8258b32a50230b2306dbf55ae70fb62ec", "message": "shelving - tooltips", "committedDate": "2020-11-05T16:49:42Z", "type": "commit"}, {"oid": "87cc2f834fe372a95bac7525bfd1bbe1595e8c51", "url": "https://github.com/all-of-us/workbench/commit/87cc2f834fe372a95bac7525bfd1bbe1595e8c51", "message": "shelving for debugging", "committedDate": "2020-11-05T16:49:42Z", "type": "commit"}, {"oid": "0432560500777424eb0c78e72c6a01b99b7392bc", "url": "https://github.com/all-of-us/workbench/commit/0432560500777424eb0c78e72c6a01b99b7392bc", "message": "per hour", "committedDate": "2020-11-05T16:49:42Z", "type": "commit"}, {"oid": "77e1ed5811e856338cb57573859d1b058f86fadb", "url": "https://github.com/all-of-us/workbench/commit/77e1ed5811e856338cb57573859d1b058f86fadb", "message": "dryerful of lint", "committedDate": "2020-11-05T16:49:42Z", "type": "commit"}, {"oid": "19efeba7e7dca2b4cd5913e5c6793856750b4b4e", "url": "https://github.com/all-of-us/workbench/commit/19efeba7e7dca2b4cd5913e5c6793856750b4b4e", "message": "implement api stub", "committedDate": "2020-11-05T16:49:42Z", "type": "commit"}, {"oid": "6da5617e3d4383f1a2bd1a9bec44e8c239dfa700", "url": "https://github.com/all-of-us/workbench/commit/6da5617e3d4383f1a2bd1a9bec44e8c239dfa700", "message": "spotless.........", "committedDate": "2020-11-05T16:49:42Z", "type": "commit"}, {"oid": "349724cb90889fd5936b9ef90f6615cc862d0d05", "url": "https://github.com/all-of-us/workbench/commit/349724cb90889fd5936b9ef90f6615cc862d0d05", "message": "use api stub", "committedDate": "2020-11-05T16:49:42Z", "type": "commit"}, {"oid": "0c64603f6cb782c8463879d3af0a404e2e467c9c", "url": "https://github.com/all-of-us/workbench/commit/0c64603f6cb782c8463879d3af0a404e2e467c9c", "message": "lint & lint & lint", "committedDate": "2020-11-05T16:49:42Z", "type": "commit"}, {"oid": "3fcc33fbc39c7118ddf3d3a18cbb80815ca2b81d", "url": "https://github.com/all-of-us/workbench/commit/3fcc33fbc39c7118ddf3d3a18cbb80815ca2b81d", "message": "fix ui tests", "committedDate": "2020-11-05T16:49:42Z", "type": "commit"}, {"oid": "954226363296c8b4f21055102a6c71e5ea48852f", "url": "https://github.com/all-of-us/workbench/commit/954226363296c8b4f21055102a6c71e5ea48852f", "message": "unfuck tests for real this time", "committedDate": "2020-11-05T16:49:42Z", "type": "commit"}, {"oid": "2f64bd1df82fef0db712efb126e69398d6ca8574", "url": "https://github.com/all-of-us/workbench/commit/2f64bd1df82fef0db712efb126e69398d6ca8574", "message": "review feedback", "committedDate": "2020-11-05T16:53:18Z", "type": "commit"}, {"oid": "38a38218e51df86f1fa9d3f3f8e70b69c626c7a0", "url": "https://github.com/all-of-us/workbench/commit/38a38218e51df86f1fa9d3f3f8e70b69c626c7a0", "message": "oy geVALT", "committedDate": "2020-11-05T16:53:18Z", "type": "commit"}, {"oid": "3f888badf753cbb3d48404f3eae3d92149798b16", "url": "https://github.com/all-of-us/workbench/commit/3f888badf753cbb3d48404f3eae3d92149798b16", "message": "further revisions", "committedDate": "2020-11-05T16:53:18Z", "type": "commit"}, {"oid": "ef6efd2c37bdb7d495ff079a3f04953b214ce1ef", "url": "https://github.com/all-of-us/workbench/commit/ef6efd2c37bdb7d495ff079a3f04953b214ce1ef", "message": "unit tests", "committedDate": "2020-11-05T20:18:12Z", "type": "commit"}, {"oid": "ef6efd2c37bdb7d495ff079a3f04953b214ce1ef", "url": "https://github.com/all-of-us/workbench/commit/ef6efd2c37bdb7d495ff079a3f04953b214ce1ef", "message": "unit tests", "committedDate": "2020-11-05T20:18:12Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODM1ODU4OQ==", "url": "https://github.com/all-of-us/workbench/pull/4240#discussion_r518358589", "bodyText": "Just noticed this diff..", "author": "calbach", "createdAt": "2020-11-05T20:54:53Z", "path": "ui/src/app/pages/analysis/runtime-panel.tsx", "diffHunk": "@@ -311,7 +499,7 @@ export const RuntimePanel = fp.flow(withCurrentWorkspace(), withCdrVersions())((\n       <FlexColumn style={{marginTop: '1rem'}}>\n         <label htmlFor='runtime-compute'>Compute type</label>\n         <Dropdown id='runtime-compute'\n-                  disabled={!hasMicroarrayData}\n+                  // disabled={!hasMicroarrayData}", "originalCommit": "ef6efd2c37bdb7d495ff079a3f04953b214ce1ef", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODM1OTcyNw==", "url": "https://github.com/all-of-us/workbench/pull/4240#discussion_r518359727", "bodyText": "fml i keep forgetting to revert this. will open new PR off master", "author": "als364", "createdAt": "2020-11-05T20:57:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODM1ODU4OQ=="}], "type": "inlineReview"}]}