{"pr_number": 3676, "pr_title": "[RW-4257][risk=moderate] Add support for the new Shibboleth service", "pr_createdAt": "2020-06-16T14:34:35Z", "pr_url": "https://github.com/all-of-us/workbench/pull/3676", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDkwMDY2MQ==", "url": "https://github.com/all-of-us/workbench/pull/3676#discussion_r440900661", "bodyText": "This is a somewhat opportunistic change / cleanup: the return value from postNihCallback was never used.", "author": "gjuggler", "createdAt": "2020-06-16T14:35:49Z", "path": "api/src/main/java/org/pmiops/workbench/firecloud/FireCloudService.java", "diffHunk": "@@ -111,7 +111,9 @@ FirecloudWorkspaceACLUpdateResponseList updateWorkspaceACL(\n    */\n   FirecloudNihStatus getNihStatus();\n \n-  FirecloudNihStatus postNihCallback(FirecloudJWTWrapper wrapper);\n+  // Submits a Shibboleth JWT for verification and update using the old-style Shibboleth service\n+  // (via Firecloud Orchestration API).\n+  void postNihCallback(FirecloudJWTWrapper wrapper);", "originalCommit": "875dc72a107cd8a4e9541e62187285079eb8353e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDkwMjI4MA==", "url": "https://github.com/all-of-us/workbench/pull/3676#discussion_r440902280", "bodyText": "I opted to use the standard \"firecloud\" API client config variables here. Even though Shibboleth is a distinct service, I felt it was simpler to use this standard set of API client variables rather than either (1) proliferate with add'l Shibboleth-specific configs or (2) use the ApiClient defaults. I'm open to objections here.", "author": "gjuggler", "createdAt": "2020-06-16T14:37:55Z", "path": "api/src/main/java/org/pmiops/workbench/shibboleth/ShibbolethConfig.java", "diffHunk": "@@ -0,0 +1,29 @@\n+package org.pmiops.workbench.shibboleth;\n+\n+import java.util.concurrent.TimeUnit;\n+import org.pmiops.workbench.auth.UserAuthentication;\n+import org.pmiops.workbench.config.WorkbenchConfig;\n+import org.pmiops.workbench.shibboleth.api.ShibbolethApi;\n+import org.springframework.context.annotation.Bean;\n+import org.springframework.context.annotation.ScopedProxyMode;\n+import org.springframework.web.context.annotation.RequestScope;\n+\n+@org.springframework.context.annotation.Configuration\n+public class ShibbolethConfig {\n+  public static final String X_APP_ID_HEADER = \"X-App-ID\";\n+\n+  @Bean\n+  @RequestScope(proxyMode = ScopedProxyMode.DEFAULT)\n+  public ShibbolethApi shibbolethApi(\n+      UserAuthentication userAuthentication, WorkbenchConfig workbenchConfig) {\n+    ApiClient apiClient = new ApiClient();\n+    apiClient.setBasePath(workbenchConfig.firecloud.shibbolethApiBaseUrl);\n+    apiClient.addDefaultHeader(X_APP_ID_HEADER, workbenchConfig.firecloud.xAppIdValue);\n+    apiClient.setDebugging(workbenchConfig.firecloud.debugEndpoints);", "originalCommit": "875dc72a107cd8a4e9541e62187285079eb8353e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTA0MDI1Ng==", "url": "https://github.com/all-of-us/workbench/pull/3676#discussion_r441040256", "bodyText": "This is probably fine", "author": "jmthibault79", "createdAt": "2020-06-16T18:00:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDkwMjI4MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDkwMzAxNA==", "url": "https://github.com/all-of-us/workbench/pull/3676#discussion_r440903014", "bodyText": "I basically copied this from FirecloudRetryHandler. It felt like an awful lot of boilerplate for a single new API call, but I didn't see an obvious alternative.", "author": "gjuggler", "createdAt": "2020-06-16T14:38:53Z", "path": "api/src/main/java/org/pmiops/workbench/shibboleth/ShibbolethRetryHandler.java", "diffHunk": "@@ -0,0 +1,60 @@\n+package org.pmiops.workbench.shibboleth;", "originalCommit": "875dc72a107cd8a4e9541e62187285079eb8353e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "57e34c6da3cd22fc9c66f47f57cb3ae46d87da2a", "url": "https://github.com/all-of-us/workbench/commit/57e34c6da3cd22fc9c66f47f57cb3ae46d87da2a", "message": "Create a new Shibboleth service YAML and package.", "committedDate": "2020-06-16T16:19:16Z", "type": "commit"}, {"oid": "868b2c3d4dc8ef87f571107c08c9c67ac9362f36", "url": "https://github.com/all-of-us/workbench/commit/868b2c3d4dc8ef87f571107c08c9c67ac9362f36", "message": "Self-review fixes.", "committedDate": "2020-06-16T16:19:17Z", "type": "commit"}, {"oid": "cf3c670d176268d8df2861f452663b0de6889561", "url": "https://github.com/all-of-us/workbench/commit/cf3c670d176268d8df2861f452663b0de6889561", "message": "Small fix to deafult server config.", "committedDate": "2020-06-16T16:19:17Z", "type": "commit"}, {"oid": "40161e0dd345d15d7e5ef7e7702d6d858c2fc596", "url": "https://github.com/all-of-us/workbench/commit/40161e0dd345d15d7e5ef7e7702d6d858c2fc596", "message": "Revert capitalization change (changed my mind).", "committedDate": "2020-06-16T16:19:17Z", "type": "commit"}, {"oid": "c59f712c3d8880c200dde12ebd49377788b31a86", "url": "https://github.com/all-of-us/workbench/commit/c59f712c3d8880c200dde12ebd49377788b31a86", "message": "Add missing @Service annotation", "committedDate": "2020-06-16T16:19:17Z", "type": "commit"}, {"oid": "2cbf6ea3d8aa2e164bf045855a347bb44e2a36c1", "url": "https://github.com/all-of-us/workbench/commit/2cbf6ea3d8aa2e164bf045855a347bb44e2a36c1", "message": "Flip feature on in test / perf / staging.", "committedDate": "2020-06-16T16:40:38Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTAzMzU1NQ==", "url": "https://github.com/all-of-us/workbench/pull/3676#discussion_r441033555", "bodyText": "Should this go inside the try?  Alternately, should we remove the try/catch since all it does is rethrow?", "author": "jmthibault79", "createdAt": "2020-06-16T17:49:15Z", "path": "api/src/main/java/org/pmiops/workbench/api/ProfileController.java", "diffHunk": "@@ -833,9 +837,14 @@ private void updateInstitutionalAffiliations(Profile updatedProfile, DbUser user\n     if (token == null || token.getJwt() == null) {\n       throw new BadRequestException(\"Token is required.\");\n     }\n-    FirecloudJWTWrapper wrapper = new FirecloudJWTWrapper().jwt(token.getJwt());\n+\n+    if (workbenchConfigProvider.get().featureFlags.useNewShibbolethService) {", "originalCommit": "f85483987a94aa5851ba63591dd80342894ea6f4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTA2NjgwMQ==", "url": "https://github.com/all-of-us/workbench/pull/3676#discussion_r441066801", "bodyText": "Removing try/catch sgtm. Done.", "author": "gjuggler", "createdAt": "2020-06-16T18:43:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTAzMzU1NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTAzNTUzMA==", "url": "https://github.com/all-of-us/workbench/pull/3676#discussion_r441035530", "bodyText": "interesting path here.  Just want to confirm: \"prod/dev\" is right?", "author": "jmthibault79", "createdAt": "2020-06-16T17:52:32Z", "path": "api/config/config_local.json", "diffHunk": "@@ -13,7 +13,9 @@\n     \"vpcServicePerimeterName\": \"accessPolicies/228353087260/servicePerimeters/terra_dev_aou_test\",\n     \"timeoutInSeconds\": 60,\n     \"jupyterDockerImage\": \"broadinstitute/terra-jupyter-aou:0.0.1\",\n-    \"welderDockerImage\": \"broadinstitute/welder-server:7ae1a62\"\n+    \"welderDockerImage\": \"broadinstitute/welder-server:7ae1a62\",\n+    \"shibbolethApiBaseUrl\": \"https:\\/\\/profile-dot-broad-shibboleth-prod.appspot.com/dev\",", "originalCommit": "f85483987a94aa5851ba63591dd80342894ea6f4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTA2NjM5Ng==", "url": "https://github.com/all-of-us/workbench/pull/3676#discussion_r441066396", "bodyText": "Yes \u2013\u00a0this is how the new Shibboleth service was designed. We noted this some time ago, and no changes were made.\nThis design also impacts our (in)ability to test against perf. AFAICT, there is no connection possible to the perf environment. So I just pushed a change which configures these params to empty strings in perf (which IMO is probably best, so any attempt fails hard rather than appears to work but acts on the wrong environment).\nThere's probably some architectural discussions worth having with the Terra UI team once they fully take on ownership of this service.", "author": "gjuggler", "createdAt": "2020-06-16T18:42:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTAzNTUzMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTAzNTc1Nw==", "url": "https://github.com/all-of-us/workbench/pull/3676#discussion_r441035757", "bodyText": "add /dev here?", "author": "jmthibault79", "createdAt": "2020-06-16T17:52:55Z", "path": "api/config/config_perf.json", "diffHunk": "@@ -13,7 +13,9 @@\n     \"vpcServicePerimeterName\": \"accessPolicies/228353087260/servicePerimeters/terra_perf_aou_perf\",\n     \"timeoutInSeconds\": 60,\n     \"jupyterDockerImage\": \"broadinstitute/terra-jupyter-aou:0.0.1\",\n-    \"welderDockerImage\": \"broadinstitute/welder-server:7ae1a62\"\n+    \"welderDockerImage\": \"broadinstitute/welder-server:7ae1a62\",\n+    \"shibbolethApiBaseUrl\": \"https:\\/\\/profile-dot-broad-shibboleth-prod.appspot.com/dev\",\n+    \"shibbolethUiBaseUrl\": \"https:\\/\\/broad-shibboleth-prod.appspot.com\"", "originalCommit": "f85483987a94aa5851ba63591dd80342894ea6f4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTA2NjY3Ng==", "url": "https://github.com/all-of-us/workbench/pull/3676#discussion_r441066676", "bodyText": "Thanks \u2013\u00a0done here and elsewhere. This also prompted me to think about the perf environment (which hits a distinct Terra env), where I decided to blank out the config values.", "author": "gjuggler", "createdAt": "2020-06-16T18:42:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTAzNTc1Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTAzNjEwOA==", "url": "https://github.com/all-of-us/workbench/pull/3676#discussion_r441036108", "bodyText": "/dev here?", "author": "jmthibault79", "createdAt": "2020-06-16T17:53:33Z", "path": "api/config/config_test.json", "diffHunk": "@@ -13,7 +13,9 @@\n     \"vpcServicePerimeterName\": \"accessPolicies/228353087260/servicePerimeters/terra_dev_aou_test\",\n     \"timeoutInSeconds\": 60,\n     \"jupyterDockerImage\": \"broadinstitute/terra-jupyter-aou:0.0.1\",\n-    \"welderDockerImage\": \"broadinstitute/welder-server:7ae1a62\"\n+    \"welderDockerImage\": \"broadinstitute/welder-server:7ae1a62\",\n+    \"shibbolethApiBaseUrl\": \"https:\\/\\/profile-dot-broad-shibboleth-prod.appspot.com/dev\",\n+    \"shibbolethUiBaseUrl\": \"https:\\/\\/broad-shibboleth-prod.appspot.com\"", "originalCommit": "f85483987a94aa5851ba63591dd80342894ea6f4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTA2NjczOA==", "url": "https://github.com/all-of-us/workbench/pull/3676#discussion_r441066738", "bodyText": "Done", "author": "gjuggler", "createdAt": "2020-06-16T18:42:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTAzNjEwOA=="}], "type": "inlineReview"}, {"oid": "1ac0ce660ed0a23cbdc192e057947dcb1e5d2c63", "url": "https://github.com/all-of-us/workbench/commit/1ac0ce660ed0a23cbdc192e057947dcb1e5d2c63", "message": "PR feedback.", "committedDate": "2020-06-16T18:44:05Z", "type": "commit"}, {"oid": "1ac0ce660ed0a23cbdc192e057947dcb1e5d2c63", "url": "https://github.com/all-of-us/workbench/commit/1ac0ce660ed0a23cbdc192e057947dcb1e5d2c63", "message": "PR feedback.", "committedDate": "2020-06-16T18:44:05Z", "type": "forcePushed"}, {"oid": "dc17527542a86a9fdde1a87168f7e87b2273a18b", "url": "https://github.com/all-of-us/workbench/commit/dc17527542a86a9fdde1a87168f7e87b2273a18b", "message": "Token template char is angle bracket, not curly brace.", "committedDate": "2020-06-16T19:21:07Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTYwNTg4Mw==", "url": "https://github.com/all-of-us/workbench/pull/3676#discussion_r441605883", "bodyText": "Something I learned recently for you to consider: The \"X-\" prefix is no longer recommended [1].\n[1] https://tools.ietf.org/html/rfc6648", "author": "dmohs", "createdAt": "2020-06-17T14:50:38Z", "path": "api/src/main/java/org/pmiops/workbench/shibboleth/ShibbolethConfig.java", "diffHunk": "@@ -0,0 +1,30 @@\n+package org.pmiops.workbench.shibboleth;\n+\n+import java.util.concurrent.TimeUnit;\n+import org.pmiops.workbench.auth.UserAuthentication;\n+import org.pmiops.workbench.config.WorkbenchConfig;\n+import org.pmiops.workbench.shibboleth.api.ShibbolethApi;\n+import org.springframework.context.annotation.Bean;\n+import org.springframework.context.annotation.Configuration;\n+import org.springframework.context.annotation.ScopedProxyMode;\n+import org.springframework.web.context.annotation.RequestScope;\n+\n+@Configuration\n+public class ShibbolethConfig {\n+  public static final String X_APP_ID_HEADER = \"X-App-ID\";", "originalCommit": "dc17527542a86a9fdde1a87168f7e87b2273a18b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}