{"pr_number": 3167, "pr_title": "[RW-3918][RISK=NO] DevOps & Monitoring framework", "pr_createdAt": "2020-02-20T20:34:59Z", "pr_url": "https://github.com/all-of-us/workbench/pull/3167", "timeline": [{"oid": "da8a725f0599777018ad4bf8ef14bcb74f380262", "url": "https://github.com/all-of-us/workbench/commit/da8a725f0599777018ad4bf8ef14bcb74f380262", "message": "cleaning some things up", "committedDate": "2020-01-14T18:07:52Z", "type": "commit"}, {"oid": "c2607b3d80c59dbaa905ce7da8cb015b4ac4e135", "url": "https://github.com/all-of-us/workbench/commit/c2607b3d80c59dbaa905ce7da8cb015b4ac4e135", "message": "more fixes", "committedDate": "2020-01-14T20:17:44Z", "type": "commit"}, {"oid": "6f35c8f5ee2594fda1f1752ac591ff2f11d38595", "url": "https://github.com/all-of-us/workbench/commit/6f35c8f5ee2594fda1f1752ac591ff2f11d38595", "message": "spotless", "committedDate": "2020-01-14T21:47:44Z", "type": "commit"}, {"oid": "9805b747141f43e7ec5be4b8e06c6c4eec7e99d5", "url": "https://github.com/all-of-us/workbench/commit/9805b747141f43e7ec5be4b8e06c6c4eec7e99d5", "message": "make string format thinner", "committedDate": "2020-01-14T22:26:06Z", "type": "commit"}, {"oid": "7dd1a1ad35ab1c54753ad36947f640dea9432dbf", "url": "https://github.com/all-of-us/workbench/commit/7dd1a1ad35ab1c54753ad36947f640dea9432dbf", "message": "restore logging level", "committedDate": "2020-01-14T22:26:33Z", "type": "commit"}, {"oid": "414905cd08fe8154f83451638aef23032c63f55e", "url": "https://github.com/all-of-us/workbench/commit/414905cd08fe8154f83451638aef23032c63f55e", "message": "Fox in mocks our game is done sir", "committedDate": "2020-01-14T23:18:44Z", "type": "commit"}, {"oid": "9020032cc65f7e0fed788de49c36e3b80a015d5b", "url": "https://github.com/all-of-us/workbench/commit/9020032cc65f7e0fed788de49c36e3b80a015d5b", "message": "spotless", "committedDate": "2020-01-15T02:30:34Z", "type": "commit"}, {"oid": "be70469b636474e31867c108b5c8cd7b86d103eb", "url": "https://github.com/all-of-us/workbench/commit/be70469b636474e31867c108b5c8cd7b86d103eb", "message": "merge master && switch set to list to match view.create signature", "committedDate": "2020-01-15T17:05:46Z", "type": "commit"}, {"oid": "8a8c6c85d4ba54a996f29e462bdcc0c866c4acd4", "url": "https://github.com/all-of-us/workbench/commit/8a8c6c85d4ba54a996f29e462bdcc0c866c4acd4", "message": "test tweak", "committedDate": "2020-01-15T17:47:17Z", "type": "commit"}, {"oid": "dfab77676c8621f7efa687f8cd53afd5d77861a9", "url": "https://github.com/all-of-us/workbench/commit/dfab77676c8621f7efa687f8cd53afd5d77861a9", "message": "initial stab at ruby script", "committedDate": "2020-01-16T17:54:31Z", "type": "commit"}, {"oid": "3c7fd01b59d929d7ea7e9c3e463dc339eb361b85", "url": "https://github.com/all-of-us/workbench/commit/3c7fd01b59d929d7ea7e9c3e463dc339eb361b85", "message": "Merge branch 'master' into jaycarlton/RW-3918", "committedDate": "2020-01-16T20:15:18Z", "type": "commit"}, {"oid": "462a8e9707fc9141f714b34fe676b2a0a22ecc66", "url": "https://github.com/all-of-us/workbench/commit/462a8e9707fc9141f714b34fe676b2a0a22ecc66", "message": "merge", "committedDate": "2020-02-20T18:58:57Z", "type": "commit"}, {"oid": "12b278eef8be7555e829f636ab2246e4a7fd4800", "url": "https://github.com/all-of-us/workbench/commit/12b278eef8be7555e829f636ab2246e4a7fd4800", "message": "move", "committedDate": "2020-02-20T19:03:55Z", "type": "commit"}, {"oid": "fab456c2b640ea1f4c29a7fda6e201e8205535ee", "url": "https://github.com/all-of-us/workbench/commit/fab456c2b640ea1f4c29a7fda6e201e8205535ee", "message": "moved from other repo", "committedDate": "2020-02-20T20:33:52Z", "type": "commit"}, {"oid": "55c35fa8f7808db436afa9680e7bf71c145fb8a2", "url": "https://github.com/all-of-us/workbench/commit/55c35fa8f7808db436afa9680e7bf71c145fb8a2", "message": "add .gitignore", "committedDate": "2020-02-20T20:50:46Z", "type": "commit"}, {"oid": "7791bc21a73a43d4cfdd018020b52283ec91c718", "url": "https://github.com/all-of-us/workbench/commit/7791bc21a73a43d4cfdd018020b52283ec91c718", "message": "progress...not quite right I don't think", "committedDate": "2020-02-20T23:04:11Z", "type": "commit"}, {"oid": "54be97b7698762dd9f595b2c3074e6b05555e9bc", "url": "https://github.com/all-of-us/workbench/commit/54be97b7698762dd9f595b2c3074e6b05555e9bc", "message": "cleanup", "committedDate": "2020-02-23T16:21:56Z", "type": "commit"}, {"oid": "a1da257512bc0ff75926ff893e1ef0f9b42b1d61", "url": "https://github.com/all-of-us/workbench/commit/a1da257512bc0ff75926ff893e1ef0f9b42b1d61", "message": "merge", "committedDate": "2020-02-23T16:22:15Z", "type": "commit"}, {"oid": "25c165657a3c93cb8082d5fe2ce5b76825521ae0", "url": "https://github.com/all-of-us/workbench/commit/25c165657a3c93cb8082d5fe2ce5b76825521ae0", "message": "credentials path", "committedDate": "2020-02-23T16:22:30Z", "type": "commit"}, {"oid": "72364a5d9a15aa4b647084de7ab04509d7335279", "url": "https://github.com/all-of-us/workbench/commit/72364a5d9a15aa4b647084de7ab04509d7335279", "message": "removing common", "committedDate": "2020-02-23T16:33:59Z", "type": "commit"}, {"oid": "6a5220146e0c95e3fdd239d9b1dd101fd2e880df", "url": "https://github.com/all-of-us/workbench/commit/6a5220146e0c95e3fdd239d9b1dd101fd2e880df", "message": "first mostly working version, setting all the SA's and not depending on any utils or project.rb code", "committedDate": "2020-02-24T01:45:13Z", "type": "commit"}, {"oid": "17af8716fa0aef07d6a2689afdd22bce3a638338", "url": "https://github.com/all-of-us/workbench/commit/17af8716fa0aef07d6a2689afdd22bce3a638338", "message": "fixes & updates", "committedDate": "2020-02-24T01:50:30Z", "type": "commit"}, {"oid": "aa61a0defade2f4053ed1e263a20936c345fadd5", "url": "https://github.com/all-of-us/workbench/commit/aa61a0defade2f4053ed1e263a20936c345fadd5", "message": "more counting", "committedDate": "2020-02-24T02:24:24Z", "type": "commit"}, {"oid": "ef4bf5d87f4edcf9c3f2079ae991a3935fa94004", "url": "https://github.com/all-of-us/workbench/commit/ef4bf5d87f4edcf9c3f2079ae991a3935fa94004", "message": "remove stuff for later and organize a bit", "committedDate": "2020-02-24T14:08:43Z", "type": "commit"}, {"oid": "0d4393d093b4653b0a7eccebade7544e17248682", "url": "https://github.com/all-of-us/workbench/commit/0d4393d093b4653b0a7eccebade7544e17248682", "message": "only one script in whole framework", "committedDate": "2020-02-24T14:26:55Z", "type": "commit"}, {"oid": "044747dc026e5f2a1bebc92560f086a8de219469", "url": "https://github.com/all-of-us/workbench/commit/044747dc026e5f2a1bebc92560f086a8de219469", "message": "docs", "committedDate": "2020-02-24T15:35:42Z", "type": "commit"}, {"oid": "2b9ace2651ce543e2f2c6f1336de1ca46ad9cbfb", "url": "https://github.com/all-of-us/workbench/commit/2b9ace2651ce543e2f2c6f1336de1ca46ad9cbfb", "message": "link to devops docs", "committedDate": "2020-02-24T15:39:39Z", "type": "commit"}, {"oid": "7931e1620905967ddcd3d3d55a9c4cf05a61d4ce", "url": "https://github.com/all-of-us/workbench/commit/7931e1620905967ddcd3d3d55a9c4cf05a61d4ce", "message": "gem reqs", "committedDate": "2020-02-24T15:48:31Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzM1MzI2OA==", "url": "https://github.com/all-of-us/workbench/pull/3167#discussion_r383353268", "bodyText": "Options parsing is coming in the next PR.", "author": "jaycarlton", "createdAt": "2020-02-24T16:00:00Z", "path": "ops/ruby/devops-framework/devops.rb", "diffHunk": "@@ -0,0 +1,13 @@\n+require 'logger'\n+require_relative 'tasks/count_monitoring_assets.rb'\n+\n+# Single entry point for the devops framework. This is the only true Ruby Script file. The\n+# rest are classes.\n+#\n+# Based on input commands, this script delegates the work to  a task class, which should not need to\n+# know anything about environment variables such as ARGV, the run directory,  etc. Tasks should also avoid\n+# global variables like `logger`, so that we can control logging preferences from the top level.\n+\n+logger = Logger.new(STDOUT)", "originalCommit": "7931e1620905967ddcd3d3d55a9c4cf05a61d4ce", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "2ab076f6089b515d3a5f916eb3959393409dc3b2", "url": "https://github.com/all-of-us/workbench/commit/2ab076f6089b515d3a5f916eb3959393409dc3b2", "message": "add options parser", "committedDate": "2020-02-24T20:20:48Z", "type": "commit"}, {"oid": "91172c58e451a63ba540de6ee1fd23aa73198e84", "url": "https://github.com/all-of-us/workbench/commit/91172c58e451a63ba540de6ee1fd23aa73198e84", "message": "handle missing  parameters", "committedDate": "2020-02-24T20:31:27Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzUxNzgyMQ==", "url": "https://github.com/all-of-us/workbench/pull/3167#discussion_r383517821", "bodyText": "typos\n(how soon until the keyboard is fixed?)", "author": "jmthibault79", "createdAt": "2020-02-24T21:14:14Z", "path": "README.md", "diffHunk": "@@ -585,6 +585,9 @@ To run tests in IntelliJ, go to your preferences, click plugins, and make sure y\n \n Once you have JUnit installed, go to the test file you want to run, right click on the test file, and select `Run` or `Debug` to run or debug the tests. To run or debug on a specific test class or method, open the file, and test running options should appear as green triangles pointing right on the side bar. Clicking that will open a dialog allowing you to run that specific class or method.\n \n+## DevOps\n+The `devops` frramework is describe [here](ops/ruby/devops-framework/DEVOPS_FRAMEWORK.md). Other", "originalCommit": "91172c58e451a63ba540de6ee1fd23aa73198e84", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzU2NTcwNw==", "url": "https://github.com/all-of-us/workbench/pull/3167#discussion_r383565707", "bodyText": "As soon as the new MacBook drops. If I tried to break my replacement before then, it would look suspicious.", "author": "jaycarlton", "createdAt": "2020-02-24T23:00:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzUxNzgyMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzUxODg1MA==", "url": "https://github.com/all-of-us/workbench/pull/3167#discussion_r383518850", "bodyText": "?", "author": "jmthibault79", "createdAt": "2020-02-24T21:16:21Z", "path": "ops/ruby/devops-framework/DEVOPS_FRAMEWORK.md", "diffHunk": "@@ -0,0 +1,78 @@\n+# DevOps Framework\n+\n+## Purpose\n+This is a small but flexible framework for automating DevOps actions and ensuring they are\n+taken in a traceable, repeatable, and consistent way. It operates by  communicating to Google Cloud Platform\n+directly, independently of the existing build, operations, and deployment pipeline(s).\n+\n+## Usage\n+The entry point to all functionality is `devops.rb`, which provides command line and environment\n+loading and dispatches to Task classes (not scripts) that do the real work.\n+`./devops.rb  -t <task_name> -e <env_file> --task-option-1 value1`\n+\n+There is also a dynamically-generated help file from the descriptions given in the options.\n+```\n+$ ruby ./devops.rb  --help\n+Usage: devops [options]\n+    -t, --task [TASK]                Task to be in in each environment", "originalCommit": "91172c58e451a63ba540de6ee1fd23aa73198e84", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzUxOTA1NQ==", "url": "https://github.com/all-of-us/workbench/pull/3167#discussion_r383519055", "bodyText": "Where is the format of this file specified?", "author": "jmthibault79", "createdAt": "2020-02-24T21:16:43Z", "path": "ops/ruby/devops-framework/DEVOPS_FRAMEWORK.md", "diffHunk": "@@ -0,0 +1,78 @@\n+# DevOps Framework\n+\n+## Purpose\n+This is a small but flexible framework for automating DevOps actions and ensuring they are\n+taken in a traceable, repeatable, and consistent way. It operates by  communicating to Google Cloud Platform\n+directly, independently of the existing build, operations, and deployment pipeline(s).\n+\n+## Usage\n+The entry point to all functionality is `devops.rb`, which provides command line and environment\n+loading and dispatches to Task classes (not scripts) that do the real work.\n+`./devops.rb  -t <task_name> -e <env_file> --task-option-1 value1`\n+\n+There is also a dynamically-generated help file from the descriptions given in the options.\n+```\n+$ ruby ./devops.rb  --help\n+Usage: devops [options]\n+    -t, --task [TASK]                Task to be in in each environment\n+    -e, --envs-file [ENVS_FILE]      Path to environments JSON file.", "originalCommit": "91172c58e451a63ba540de6ee1fd23aa73198e84", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDQ3NDU5MQ==", "url": "https://github.com/all-of-us/workbench/pull/3167#discussion_r384474591", "bodyText": "added, thanks", "author": "jaycarlton", "createdAt": "2020-02-26T12:57:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzUxOTA1NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzUyMDE5OQ==", "url": "https://github.com/all-of-us/workbench/pull/3167#discussion_r383520199", "bodyText": "sp: standard", "author": "jmthibault79", "createdAt": "2020-02-24T21:18:58Z", "path": "ops/ruby/devops-framework/DEVOPS_FRAMEWORK.md", "diffHunk": "@@ -0,0 +1,78 @@\n+# DevOps Framework\n+\n+## Purpose\n+This is a small but flexible framework for automating DevOps actions and ensuring they are\n+taken in a traceable, repeatable, and consistent way. It operates by  communicating to Google Cloud Platform\n+directly, independently of the existing build, operations, and deployment pipeline(s).\n+\n+## Usage\n+The entry point to all functionality is `devops.rb`, which provides command line and environment\n+loading and dispatches to Task classes (not scripts) that do the real work.\n+`./devops.rb  -t <task_name> -e <env_file> --task-option-1 value1`\n+\n+There is also a dynamically-generated help file from the descriptions given in the options.\n+```\n+$ ruby ./devops.rb  --help\n+Usage: devops [options]\n+    -t, --task [TASK]                Task to be in in each environment\n+    -e, --envs-file [ENVS_FILE]      Path to environments JSON file.\n+```\n+\n+##  Installation\n+We need a newish version of Ruby. I'm running 2.6.5 as of this writing, but haven't gone\n+back and tested with older versions. We also currently need the `gcloud` tools and an account with\n+sufficient privilege account to create service account tokens.\n+\n+Additionally, you'll need to install a gem or two. Right now, it's\n+\n+`gem install google-cloud-monitoring` for the monitoring library\n+\n+## Design Decisions\n+I should justify some of the  directions I've taken here, since they're departures to varying\n+degrees from how we've traditionally done things.\n+\n+### A New Ruby Application\n+I wrestled a bit with this actually. I haven't seen anything that Ruby can do that Python can't,\n+for example, and in general the latter language has much more documentation, a more active\n+community, and many more programmers. Ultimately, it would've  been a big reset to change\n+code bases and languages all at once, so I'll continue to write the first  version in Ruby until\n+I get ~~an excuse~~ a requirement to port to Python. One such requirement could come in the form\n+of other teams we depend  on and wish to integrate tightly with using some other language.\n+\n+### Task Classes Instead of Scripts\n+I  decided to make the tasks full  Ruby classes instead of stand-alone scripts for a couple  of reasons.\n+First, it ensures that we can minimize usage of global state (which can get away from you easily\n+in Ruby). Second, we can now configure things  like log levels in one place.\n+\n+### Independence of All Things All of Us\n+There are no dependencies on any AoU application or build/release code, or anything in\n+the utils repository. This allows us to avoid refactoring the legacy Ruby stack, and ensures\n+that this framework can be reused externally. Some notably absent things:\n+* `project.rb` System: This system depends on and is depended on by our  build & release framework, \n+which means we would be in danger of holding up a release if we needed to make a quick change.\n+* `ServiceAccountContext`: This system was a  major source of inspiration  for the new\n+ `ServiceAccountManager`, but had some customizations and legacy assumptions that were not compatible with the goals\n+ of this project.\n+* `Common.rb`: There are a number of useful snippets and  functions in this class, and I decided to steal\n+selectively and adapt rather than try to reuse it. It isn't a standard package, isn't actively maintained,\n+and it's not laid out in such a way that I can only bring in the  pieces I want. Logging  uses the\n+standnard Ruby logger, and I'm re-evaluating how we do subprocesses.", "originalCommit": "91172c58e451a63ba540de6ee1fd23aa73198e84", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzUyMDUyNQ==", "url": "https://github.com/all-of-us/workbench/pull/3167#discussion_r383520525", "bodyText": "sp: specific", "author": "jmthibault79", "createdAt": "2020-02-24T21:19:37Z", "path": "ops/ruby/devops-framework/DEVOPS_FRAMEWORK.md", "diffHunk": "@@ -0,0 +1,78 @@\n+# DevOps Framework\n+\n+## Purpose\n+This is a small but flexible framework for automating DevOps actions and ensuring they are\n+taken in a traceable, repeatable, and consistent way. It operates by  communicating to Google Cloud Platform\n+directly, independently of the existing build, operations, and deployment pipeline(s).\n+\n+## Usage\n+The entry point to all functionality is `devops.rb`, which provides command line and environment\n+loading and dispatches to Task classes (not scripts) that do the real work.\n+`./devops.rb  -t <task_name> -e <env_file> --task-option-1 value1`\n+\n+There is also a dynamically-generated help file from the descriptions given in the options.\n+```\n+$ ruby ./devops.rb  --help\n+Usage: devops [options]\n+    -t, --task [TASK]                Task to be in in each environment\n+    -e, --envs-file [ENVS_FILE]      Path to environments JSON file.\n+```\n+\n+##  Installation\n+We need a newish version of Ruby. I'm running 2.6.5 as of this writing, but haven't gone\n+back and tested with older versions. We also currently need the `gcloud` tools and an account with\n+sufficient privilege account to create service account tokens.\n+\n+Additionally, you'll need to install a gem or two. Right now, it's\n+\n+`gem install google-cloud-monitoring` for the monitoring library\n+\n+## Design Decisions\n+I should justify some of the  directions I've taken here, since they're departures to varying\n+degrees from how we've traditionally done things.\n+\n+### A New Ruby Application\n+I wrestled a bit with this actually. I haven't seen anything that Ruby can do that Python can't,\n+for example, and in general the latter language has much more documentation, a more active\n+community, and many more programmers. Ultimately, it would've  been a big reset to change\n+code bases and languages all at once, so I'll continue to write the first  version in Ruby until\n+I get ~~an excuse~~ a requirement to port to Python. One such requirement could come in the form\n+of other teams we depend  on and wish to integrate tightly with using some other language.\n+\n+### Task Classes Instead of Scripts\n+I  decided to make the tasks full  Ruby classes instead of stand-alone scripts for a couple  of reasons.\n+First, it ensures that we can minimize usage of global state (which can get away from you easily\n+in Ruby). Second, we can now configure things  like log levels in one place.\n+\n+### Independence of All Things All of Us\n+There are no dependencies on any AoU application or build/release code, or anything in\n+the utils repository. This allows us to avoid refactoring the legacy Ruby stack, and ensures\n+that this framework can be reused externally. Some notably absent things:\n+* `project.rb` System: This system depends on and is depended on by our  build & release framework, \n+which means we would be in danger of holding up a release if we needed to make a quick change.\n+* `ServiceAccountContext`: This system was a  major source of inspiration  for the new\n+ `ServiceAccountManager`, but had some customizations and legacy assumptions that were not compatible with the goals\n+ of this project.\n+* `Common.rb`: There are a number of useful snippets and  functions in this class, and I decided to steal\n+selectively and adapt rather than try to reuse it. It isn't a standard package, isn't actively maintained,\n+and it's not laid out in such a way that I can only bring in the  pieces I want. Logging  uses the\n+standnard Ruby logger, and I'm re-evaluating how we do subprocesses.\n+\n+### Use of Google Client Libraries Instead of `gcloud` Tool\n+`gcloud` is certainly a handy and indespensible tool for daily use for one-off tasks,\n+and has the advantage of working in the Cloud Shell. I don't propose to replace it for the\n+semi-manual tasks to which it is well suited.\n+\n+However, I do want to avoid making  system calls just to use `gcloud` when there is an equivalent\n+library method already provided. This will make the framework feel more like an application\n+(which most experienced programmers have an idea how to scale) than a collection of scripts.\n+\n+Ideally, we would not depend on `gcloud` being installed locally at all for someone to use\n+these tools.\n+\n+### Use of a Limited Service Account\n+The framework supports a bring-you-own-service-account model. I.e. any evaluation of permissions\n+is left up to GCP. I requested new  monitoring-speicic service accounts for this framework so", "originalCommit": "91172c58e451a63ba540de6ee1fd23aa73198e84", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDQ3NzAyMg==", "url": "https://github.com/all-of-us/workbench/pull/3167#discussion_r384477022", "bodyText": "\ud83d\udc4d", "author": "jaycarlton", "createdAt": "2020-02-26T13:02:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzUyMDUyNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzUyNTEzMw==", "url": "https://github.com/all-of-us/workbench/pull/3167#discussion_r383525133", "bodyText": "is there a way to do this generically, or error on any missing?", "author": "jmthibault79", "createdAt": "2020-02-24T21:28:46Z", "path": "ops/ruby/devops-framework/devops.rb", "diffHunk": "@@ -0,0 +1,43 @@\n+require 'logger'\n+require 'optparse'\n+require_relative 'tasks/count_monitoring_assets.rb'\n+\n+# Single entry point for the devops framework. This is the only true Ruby Script file. The\n+# rest are classes.\n+#\n+# Based on input commands, this script delegates the work to  a task class, which should not need to\n+# know anything about environment variables such as ARGV, the run directory,  etc. Tasks should also avoid\n+# global variables like `logger`, so that we can control logging preferences from the top level.\n+\n+# TODO(jaycarlton): work out a scheme for task-specific options (i.e. subcommands)\n+def parse_options\n+  options = {}\n+  OptionParser.new do |parser|\n+    parser.on('-t', '--task [TASK]', String, 'Task to be in in each environment')\n+    parser.on('-e', '--envs-file [ENVS]', String, 'Path to environments JSON file.')\n+  end.parse!({into: options})\n+\n+  #Now raise an exception if we have not found a required arg\n+  raise OptionParser::MissingArgument.new('task') if options[:task].nil?", "originalCommit": "91172c58e451a63ba540de6ee1fd23aa73198e84", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDQ3NzcxMA==", "url": "https://github.com/all-of-us/workbench/pull/3167#discussion_r384477710", "bodyText": "You would think. There's supposed to be a way to specify required args. This is reworked a good bit in the follow-on PR, and I'll see if I can make it simpler there.", "author": "jaycarlton", "createdAt": "2020-02-26T13:03:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzUyNTEzMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDY3MzY3Nw==", "url": "https://github.com/all-of-us/workbench/pull/3167#discussion_r384673677", "bodyText": "There are a ton of ways to do it, but this looks like the least bad. I don't know why nobody has added that in 10+ years.", "author": "jaycarlton", "createdAt": "2020-02-26T18:15:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzUyNTEzMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzUyNjc1Nw==", "url": "https://github.com/all-of-us/workbench/pull/3167#discussion_r383526757", "bodyText": "rm", "author": "jmthibault79", "createdAt": "2020-02-24T21:32:06Z", "path": "ops/ruby/devops-framework/tasks/lib/gcp_environment_info.rb", "diffHunk": "@@ -0,0 +1,32 @@\n+class GcpEnvironmentInfo\n+  # def initialize(short_name, project_id, project_number, service_account)", "originalCommit": "91172c58e451a63ba540de6ee1fd23aa73198e84", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzUzMDYwNQ==", "url": "https://github.com/all-of-us/workbench/pull/3167#discussion_r383530605", "bodyText": "sp: environments", "author": "jmthibault79", "createdAt": "2020-02-24T21:40:15Z", "path": "ops/ruby/devops-framework/tasks/count_monitoring_assets.rb", "diffHunk": "@@ -0,0 +1,66 @@\n+require \"google/cloud/monitoring\"\n+require 'logger'\n+\n+require_relative \"./lib/service_account_manager\"\n+require_relative './lib/gcp_environment_visitor'\n+\n+CUSTOM_METRIC_FILTER = \"metric.type = starts_with(\\\"custom.googleapis.com/\\\")\"\n+LOGS_BASED_METRIC_FILTER = \"metric.type = starts_with(\\\"logging.googleapis.com/\\\")\"\n+USER_LOGS_BASED_METRIC_FILTER = \"metric.type = starts_with(\\\"logging.googleapis.com/user/\\\")\"\n+\n+logger = Logger.new(STDOUT)\n+class MonitoringAssets\n+  def initialize(envrionments_path_json, logger = Logger.new(STDOUT))", "originalCommit": "91172c58e451a63ba540de6ee1fd23aa73198e84", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDQ3ODM1Nw==", "url": "https://github.com/all-of-us/workbench/pull/3167#discussion_r384478357", "bodyText": "Thanks. The spelling should get better if I can keep for IJ from marking everything as suspicious.", "author": "jaycarlton", "createdAt": "2020-02-26T13:04:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzUzMDYwNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzUzMTUzMQ==", "url": "https://github.com/all-of-us/workbench/pull/3167#discussion_r383531531", "bodyText": "sp: \"baed\" a few times in this file", "author": "jmthibault79", "createdAt": "2020-02-24T21:42:06Z", "path": "ops/ruby/devops-framework/tasks/count_monitoring_assets.rb", "diffHunk": "@@ -0,0 +1,66 @@\n+require \"google/cloud/monitoring\"\n+require 'logger'\n+\n+require_relative \"./lib/service_account_manager\"\n+require_relative './lib/gcp_environment_visitor'\n+\n+CUSTOM_METRIC_FILTER = \"metric.type = starts_with(\\\"custom.googleapis.com/\\\")\"\n+LOGS_BASED_METRIC_FILTER = \"metric.type = starts_with(\\\"logging.googleapis.com/\\\")\"\n+USER_LOGS_BASED_METRIC_FILTER = \"metric.type = starts_with(\\\"logging.googleapis.com/user/\\\")\"\n+\n+logger = Logger.new(STDOUT)\n+class MonitoringAssets\n+  def initialize(envrionments_path_json, logger = Logger.new(STDOUT))\n+    @visitor = GcpEnvironmentVisitor.new(envrionments_path_json, logger)\n+    @logger = logger\n+  end\n+\n+  # Demonstrate a simple usage of the AouEnvironmentVisitor with a few read-only operations\n+  # on monitoring things in all the environments.\n+  def inventory\n+    @visitor.visit do |env|\n+      counts  = {}\n+      metric_client = Google::Cloud::Monitoring::Metric.new\n+      metric_project_path = Google::Cloud::Monitoring::V3::MetricServiceClient.project_path(env.project_id)\n+\n+      resources = metric_client.list_monitored_resource_descriptors(metric_project_path)\n+      @logger.info(\"found #{resources.count} monitored resources\")\n+      counts['monitored_resources'] = resources.count\n+\n+      all_metrics = metric_client.list_metric_descriptors(metric_project_path)\n+      counts['metric_descriptors'] =  all_metrics.count\n+      @logger.info(\"found #{all_metrics.count} metric descriptors\")\n+\n+      custom_metrics = metric_client.list_metric_descriptors(metric_project_path, {filter: CUSTOM_METRIC_FILTER})\n+      @logger.info(\"found  #{custom_metrics.count} custom metrics\")\n+      counts['custom_metrics'] = custom_metrics.count\n+      custom_metrics.each do |metric|\n+        @logger.info(\"\\t#{metric.name}: #{metric.description}\")\n+      end\n+\n+      user_logs_based_metrics = metric_client.list_metric_descriptors(metric_project_path, {filter: USER_LOGS_BASED_METRIC_FILTER})\n+      counts['user_logs_based_metrics'] = user_logs_based_metrics.count\n+      @logger.info(\"found  #{user_logs_based_metrics.count} user-defined  logs-baed metrics\")", "originalCommit": "91172c58e451a63ba540de6ee1fd23aa73198e84", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzUzMzMzNQ==", "url": "https://github.com/all-of-us/workbench/pull/3167#discussion_r383533335", "bodyText": "what an interesting pattern", "author": "jmthibault79", "createdAt": "2020-02-24T21:45:43Z", "path": "ops/ruby/devops-framework/tasks/lib/service_account_manager.rb", "diffHunk": "@@ -0,0 +1,81 @@\n+require \"json\"\n+require 'tmpdir'\n+require 'fileutils'\n+require 'logger'\n+\n+# Entering a service account context ensures that a keyfile exists at the given\n+# path for the given service account, and that GOOGLE_APPLICATION_CREDENTIALS is\n+# pointing to it (for application default credentials). Creates this SA key and\n+# file if necessary, and destroys it when leaving the context.\n+#\n+# Nested service account contexts are not supported.\n+class ServiceAccountManager\n+\n+  SERVICE_ACCOUNT_KEY_FILE_NAME = \"sa-key.json\"\n+\n+  def initialize(project, service_account, logger = Logger.new(STDOUT))\n+    @logger = logger\n+    @project = project\n+    @service_account = service_account\n+  end\n+\n+  attr_reader :project\n+  attr_reader :service_account\n+  attr_reader :credentials_path\n+\n+  def run()\n+    @logger.info(\"service_account = #{@service_account}\")\n+    credentials_path = create_credentials_file\n+\n+    @logger.info(\"Setting environment variable GOOGLE_APPLICATION_CREDENTIALS to #{credentials_path}\")\n+    ENV[\"GOOGLE_APPLICATION_CREDENTIALS\"] = credentials_path\n+\n+    begin\n+      yield self", "originalCommit": "91172c58e451a63ba540de6ee1fd23aa73198e84", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzU2NTQyMA==", "url": "https://github.com/all-of-us/workbench/pull/3167#discussion_r383565420", "bodyText": "Yeah, this was the first language I tried to use professionally in like 2007, and it was the wrong choice for me at the time. I couldn't wrap my head around lambdas until years later, and Ruby has half a dozen ways of doing things like this.", "author": "jaycarlton", "createdAt": "2020-02-24T22:59:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzUzMzMzNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzYxODg3MA==", "url": "https://github.com/all-of-us/workbench/pull/3167#discussion_r383618870", "bodyText": "First attempt: you don't have permission to write to your gems folder\nSecond attempt: install ruby via Homebrew and update paths\nERROR:  Error installing google-cloud-monitoring:\n        The last version of grpc (~> 1.24) to support your Ruby & RubyGems was 1.27.0. Try installing it with `gem install grpc -v 1.27.0` and then running the current command again\n        grpc requires Ruby version >= 2.3, < 2.7.dev. The current ruby version is 2.7.0.0.\n\n$ ruby --version\nruby 2.7.0p0 (2019-12-25 revision 647ee6f091) [x86_64-darwin18]\n\n$ gem install grpc -v 1.27.0\nERROR:  Error installing grpc:\n        The last version of grpc (= 1.27.0) to support your Ruby & RubyGems was 1.27.0. Try installing it with `gem install grpc -v 1.27.0`\n        grpc requires Ruby version >= 2.3, < 2.7.dev. The current ruby version is 2.7.0.0.\n\nThird attempt: downgrade Homebrew ruby to 2.6 ... nope.  not available!  2.5 then.\n$ brew install ruby@2.5\n\nupdate my PATH again\n$ ruby --version\nruby 2.5.5p157 (2019-03-15 revision 67260) [x86_64-darwin18]\n$ gem install google-cloud-monitoring\n\nSuccess, finally.", "author": "jmthibault79", "createdAt": "2020-02-25T01:58:11Z", "path": "ops/ruby/devops-framework/DEVOPS_FRAMEWORK.md", "diffHunk": "@@ -0,0 +1,78 @@\n+# DevOps Framework\n+\n+## Purpose\n+This is a small but flexible framework for automating DevOps actions and ensuring they are\n+taken in a traceable, repeatable, and consistent way. It operates by  communicating to Google Cloud Platform\n+directly, independently of the existing build, operations, and deployment pipeline(s).\n+\n+## Usage\n+The entry point to all functionality is `devops.rb`, which provides command line and environment\n+loading and dispatches to Task classes (not scripts) that do the real work.\n+`./devops.rb  -t <task_name> -e <env_file> --task-option-1 value1`\n+\n+There is also a dynamically-generated help file from the descriptions given in the options.\n+```\n+$ ruby ./devops.rb  --help\n+Usage: devops [options]\n+    -t, --task [TASK]                Task to be in in each environment\n+    -e, --envs-file [ENVS_FILE]      Path to environments JSON file.\n+```\n+\n+##  Installation\n+We need a newish version of Ruby. I'm running 2.6.5 as of this writing, but haven't gone\n+back and tested with older versions. We also currently need the `gcloud` tools and an account with\n+sufficient privilege account to create service account tokens.\n+\n+Additionally, you'll need to install a gem or two. Right now, it's\n+\n+`gem install google-cloud-monitoring` for the monitoring library", "originalCommit": "91172c58e451a63ba540de6ee1fd23aa73198e84", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDA2NDkyOQ==", "url": "https://github.com/all-of-us/workbench/pull/3167#discussion_r384064929", "bodyText": "The command given here also failed. This worked for me:\ngem install --user google-cloud-monitoring\n\nWe should probably use a Gemfile if we're going to start requiring gem installation, rather than trying to keep this README up to date.", "author": "calbach", "createdAt": "2020-02-25T19:05:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzYxODg3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDQ3NjMyNQ==", "url": "https://github.com/all-of-us/workbench/pull/3167#discussion_r384476325", "bodyText": "Sorry about that. We still don't have official instructions for installing and configuring Ruby. Filed. https://precisionmedicineinitiative.atlassian.net/browse/RW-4511 to make this better.", "author": "jaycarlton", "createdAt": "2020-02-26T13:00:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzYxODg3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDQ4ODM1Nw==", "url": "https://github.com/all-of-us/workbench/pull/3167#discussion_r384488357", "bodyText": "Filed https://precisionmedicineinitiative.atlassian.net/browse/RW-4512 for gemfile. Hopefully it goes quickly, but I don't want to add scope to this PR as there's another one branched off it that's almost ready to go.", "author": "jaycarlton", "createdAt": "2020-02-26T13:24:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzYxODg3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDU4MjMzMQ==", "url": "https://github.com/all-of-us/workbench/pull/3167#discussion_r384582331", "bodyText": "Rather than these approaches, my strong preference would be to dockerize this so modifying your local Ruby install is not necessary.", "author": "jmthibault79", "createdAt": "2020-02-26T15:49:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzYxODg3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDYwNTU1Mw==", "url": "https://github.com/all-of-us/workbench/pull/3167#discussion_r384605553", "bodyText": "That's interesting. we can do a gemfile first I think. I don't know if I have a dockerization budget; I'm barely going to get away with doing this much.\nWe probably need to document local ruby anyway for build stuff.", "author": "jaycarlton", "createdAt": "2020-02-26T16:21:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzYxODg3MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDA2MzExNg==", "url": "https://github.com/all-of-us/workbench/pull/3167#discussion_r384063116", "bodyText": "nit: Should this file just be called README.md? the file path looks a bit redundant", "author": "calbach", "createdAt": "2020-02-25T19:01:51Z", "path": "ops/ruby/devops-framework/DEVOPS_FRAMEWORK.md", "diffHunk": "@@ -0,0 +1,78 @@\n+# DevOps Framework", "originalCommit": "91172c58e451a63ba540de6ee1fd23aa73198e84", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDQ3OTcyNA==", "url": "https://github.com/all-of-us/workbench/pull/3167#discussion_r384479724", "bodyText": "That sounds good for docs that are aimed at an obvious thing in the path. We have (and will have more) cross-cutting topics that don't fit that pattern, such as stuff split off the top README.md.", "author": "jaycarlton", "createdAt": "2020-02-26T13:07:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDA2MzExNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDA2NTM2Mg==", "url": "https://github.com/all-of-us/workbench/pull/3167#discussion_r384065362", "bodyText": "What does \"externally\" mean? I'm not sure I understand what you're intending to use this for which you couldn't use the existing framework for.", "author": "calbach", "createdAt": "2020-02-25T19:06:11Z", "path": "ops/ruby/devops-framework/DEVOPS_FRAMEWORK.md", "diffHunk": "@@ -0,0 +1,78 @@\n+# DevOps Framework\n+\n+## Purpose\n+This is a small but flexible framework for automating DevOps actions and ensuring they are\n+taken in a traceable, repeatable, and consistent way. It operates by  communicating to Google Cloud Platform\n+directly, independently of the existing build, operations, and deployment pipeline(s).\n+\n+## Usage\n+The entry point to all functionality is `devops.rb`, which provides command line and environment\n+loading and dispatches to Task classes (not scripts) that do the real work.\n+`./devops.rb  -t <task_name> -e <env_file> --task-option-1 value1`\n+\n+There is also a dynamically-generated help file from the descriptions given in the options.\n+```\n+$ ruby ./devops.rb  --help\n+Usage: devops [options]\n+    -t, --task [TASK]                Task to be in in each environment\n+    -e, --envs-file [ENVS_FILE]      Path to environments JSON file.\n+```\n+\n+##  Installation\n+We need a newish version of Ruby. I'm running 2.6.5 as of this writing, but haven't gone\n+back and tested with older versions. We also currently need the `gcloud` tools and an account with\n+sufficient privilege account to create service account tokens.\n+\n+Additionally, you'll need to install a gem or two. Right now, it's\n+\n+`gem install google-cloud-monitoring` for the monitoring library\n+\n+## Design Decisions\n+I should justify some of the  directions I've taken here, since they're departures to varying\n+degrees from how we've traditionally done things.\n+\n+### A New Ruby Application\n+I wrestled a bit with this actually. I haven't seen anything that Ruby can do that Python can't,\n+for example, and in general the latter language has much more documentation, a more active\n+community, and many more programmers. Ultimately, it would've  been a big reset to change\n+code bases and languages all at once, so I'll continue to write the first  version in Ruby until\n+I get ~~an excuse~~ a requirement to port to Python. One such requirement could come in the form\n+of other teams we depend  on and wish to integrate tightly with using some other language.\n+\n+### Task Classes Instead of Scripts\n+I  decided to make the tasks full  Ruby classes instead of stand-alone scripts for a couple  of reasons.\n+First, it ensures that we can minimize usage of global state (which can get away from you easily\n+in Ruby). Second, we can now configure things  like log levels in one place.\n+\n+### Independence of All Things All of Us\n+There are no dependencies on any AoU application or build/release code, or anything in\n+the utils repository. This allows us to avoid refactoring the legacy Ruby stack, and ensures\n+that this framework can be reused externally. Some notably absent things:", "originalCommit": "91172c58e451a63ba540de6ee1fd23aa73198e84", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDQ5MTQ3Mw==", "url": "https://github.com/all-of-us/workbench/pull/3167#discussion_r384491473", "bodyText": "External means anyone who isn't the AoU Workbench team. I intend for this to work in any GCP environment that has similar needs to what we need. Keeping that separation also means we'll never have to wait on a workbench release in order to make improvements to our devops tools. (We may adopt some other form of versioning discipline, especially for tasks that make changes to the system config).", "author": "jaycarlton", "createdAt": "2020-02-26T13:30:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDA2NTM2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDgwOTc5Ng==", "url": "https://github.com/all-of-us/workbench/pull/3167#discussion_r384809796", "bodyText": "I think there may be some conflating of different things here. The idea that we would need to \"wait on a workbench release in order to make improvements to our devops tools\" doesn't make sense. Presumably this idea originates from how the deploy tooling works; this has no bearing on oneoff devops tool executions via project.rb today.\nLets discuss tomorrow", "author": "calbach", "createdAt": "2020-02-26T22:36:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDA2NTM2Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDA2NjQ2OQ==", "url": "https://github.com/all-of-us/workbench/pull/3167#discussion_r384066469", "bodyText": "How does this relate to the workbench-devops repo?", "author": "calbach", "createdAt": "2020-02-25T19:08:19Z", "path": "ops/ruby/devops-framework/DEVOPS_FRAMEWORK.md", "diffHunk": "@@ -0,0 +1,78 @@\n+# DevOps Framework\n+\n+## Purpose\n+This is a small but flexible framework for automating DevOps actions and ensuring they are", "originalCommit": "91172c58e451a63ba540de6ee1fd23aa73198e84", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDQ4MTAyOQ==", "url": "https://github.com/all-of-us/workbench/pull/3167#discussion_r384481029", "bodyText": "workbench-devops ideally contains config information, tool inputs, and possibly docs that don't belong in a reusable, open source application. I'm hoping we can make these new tools available to either Terra or other DRC teams, as well as anyone using GCP, and even if our own project details aren't strictly private, including them here would clutter things.", "author": "jaycarlton", "createdAt": "2020-02-26T13:10:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDA2NjQ2OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDA2NjYxNw==", "url": "https://github.com/all-of-us/workbench/pull/3167#discussion_r384066617", "bodyText": "Is the proposal to move entirely to this new framework, including for our development scripts?", "author": "calbach", "createdAt": "2020-02-25T19:08:34Z", "path": "ops/ruby/devops-framework/DEVOPS_FRAMEWORK.md", "diffHunk": "@@ -0,0 +1,78 @@\n+# DevOps Framework\n+\n+## Purpose\n+This is a small but flexible framework for automating DevOps actions and ensuring they are", "originalCommit": "91172c58e451a63ba540de6ee1fd23aa73198e84", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDQ4MjM1MA==", "url": "https://github.com/all-of-us/workbench/pull/3167#discussion_r384482350", "bodyText": "I have not made such a proposal, for a couple of reasons. The first is something @gjuggler brought up, which is a general principle to keep build and ops tooling separated. This way the devops stuff can move faster. The second reason is that it's really late in the game to start straightening out some of the build tooling to make it more generic, independent and flexible.\nIf we find we have a clean set of things we want to share (such as a common command/sub-command CLI), then that's another conversation. One thing to look into there is Python CLI.", "author": "jaycarlton", "createdAt": "2020-02-26T13:12:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDA2NjYxNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDA2NzM2OQ==", "url": "https://github.com/all-of-us/workbench/pull/3167#discussion_r384067369", "bodyText": "Repeatability and consistency are mentioned here, yet a large divergence between this and the previous system is the lack of docker usage. Was docker considered?", "author": "calbach", "createdAt": "2020-02-25T19:10:02Z", "path": "ops/ruby/devops-framework/DEVOPS_FRAMEWORK.md", "diffHunk": "@@ -0,0 +1,78 @@\n+# DevOps Framework\n+\n+## Purpose\n+This is a small but flexible framework for automating DevOps actions and ensuring they are\n+taken in a traceable, repeatable, and consistent way. It operates by  communicating to Google Cloud Platform", "originalCommit": "91172c58e451a63ba540de6ee1fd23aa73198e84", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDQ4MzYyNA==", "url": "https://github.com/all-of-us/workbench/pull/3167#discussion_r384483624", "bodyText": "Do you mean, should I install all of this into a container and drive that? I hadn't considered that, but off the top of my head it seems like overkill. It was strongly hinted that I should write the first cut in Ruby.\nIf you mean, should I be running things inside containers, I'll cross that bridge when I come to it. Right now all my use cases are for configuring and exploring things in GCP across several projects, and keeping official operational configuration as consistent as possible across all of them.", "author": "jaycarlton", "createdAt": "2020-02-26T13:15:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDA2NzM2OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDA3MDM2Nw==", "url": "https://github.com/all-of-us/workbench/pull/3167#discussion_r384070367", "bodyText": "Was there some kind of consensus that the existing utils stuff is now legacy? Or is this PR the proposal to make this canon?", "author": "calbach", "createdAt": "2020-02-25T19:15:53Z", "path": "ops/ruby/devops-framework/DEVOPS_FRAMEWORK.md", "diffHunk": "@@ -0,0 +1,78 @@\n+# DevOps Framework\n+\n+## Purpose\n+This is a small but flexible framework for automating DevOps actions and ensuring they are\n+taken in a traceable, repeatable, and consistent way. It operates by  communicating to Google Cloud Platform\n+directly, independently of the existing build, operations, and deployment pipeline(s).\n+\n+## Usage\n+The entry point to all functionality is `devops.rb`, which provides command line and environment\n+loading and dispatches to Task classes (not scripts) that do the real work.\n+`./devops.rb  -t <task_name> -e <env_file> --task-option-1 value1`\n+\n+There is also a dynamically-generated help file from the descriptions given in the options.\n+```\n+$ ruby ./devops.rb  --help\n+Usage: devops [options]\n+    -t, --task [TASK]                Task to be in in each environment\n+    -e, --envs-file [ENVS_FILE]      Path to environments JSON file.\n+```\n+\n+##  Installation\n+We need a newish version of Ruby. I'm running 2.6.5 as of this writing, but haven't gone\n+back and tested with older versions. We also currently need the `gcloud` tools and an account with\n+sufficient privilege account to create service account tokens.\n+\n+Additionally, you'll need to install a gem or two. Right now, it's\n+\n+`gem install google-cloud-monitoring` for the monitoring library\n+\n+## Design Decisions\n+I should justify some of the  directions I've taken here, since they're departures to varying\n+degrees from how we've traditionally done things.\n+\n+### A New Ruby Application\n+I wrestled a bit with this actually. I haven't seen anything that Ruby can do that Python can't,\n+for example, and in general the latter language has much more documentation, a more active\n+community, and many more programmers. Ultimately, it would've  been a big reset to change\n+code bases and languages all at once, so I'll continue to write the first  version in Ruby until\n+I get ~~an excuse~~ a requirement to port to Python. One such requirement could come in the form\n+of other teams we depend  on and wish to integrate tightly with using some other language.\n+\n+### Task Classes Instead of Scripts\n+I  decided to make the tasks full  Ruby classes instead of stand-alone scripts for a couple  of reasons.\n+First, it ensures that we can minimize usage of global state (which can get away from you easily\n+in Ruby). Second, we can now configure things  like log levels in one place.\n+\n+### Independence of All Things All of Us\n+There are no dependencies on any AoU application or build/release code, or anything in\n+the utils repository. This allows us to avoid refactoring the legacy Ruby stack, and ensures", "originalCommit": "91172c58e451a63ba540de6ee1fd23aa73198e84", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDQ5MDM3MA==", "url": "https://github.com/all-of-us/workbench/pull/3167#discussion_r384490370", "bodyText": "I got the general sense that extending the existing ruby/gradle codebase needs more work than I have the charter to do right now, regardless of my feelings on what I might do differently.\nAs for the utils dir, I started from it, but realized it was pulling in lots of things I didn't need or understand, mostly ~3 years old and largely untouched since then. There may be a case for repackaging some of it in more granular ways. I also didn't want to fiddle with a git submodule, and as I've said, I wan this. whole project to be as standard and reusable as possible.", "author": "jaycarlton", "createdAt": "2020-02-26T13:28:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDA3MDM2Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDA3MzMwNw==", "url": "https://github.com/all-of-us/workbench/pull/3167#discussion_r384073307", "bodyText": "I'd have a slight preference for a positional arg rather than a flag for a task/command name, especially if there will be alternate flags for subcommands. This is pretty typical for CLIs with subcommands.", "author": "calbach", "createdAt": "2020-02-25T19:21:20Z", "path": "ops/ruby/devops-framework/DEVOPS_FRAMEWORK.md", "diffHunk": "@@ -0,0 +1,78 @@\n+# DevOps Framework\n+\n+## Purpose\n+This is a small but flexible framework for automating DevOps actions and ensuring they are\n+taken in a traceable, repeatable, and consistent way. It operates by  communicating to Google Cloud Platform\n+directly, independently of the existing build, operations, and deployment pipeline(s).\n+\n+## Usage\n+The entry point to all functionality is `devops.rb`, which provides command line and environment\n+loading and dispatches to Task classes (not scripts) that do the real work.\n+`./devops.rb  -t <task_name> -e <env_file> --task-option-1 value1`\n+\n+There is also a dynamically-generated help file from the descriptions given in the options.\n+```\n+$ ruby ./devops.rb  --help\n+Usage: devops [options]\n+    -t, --task [TASK]                Task to be in in each environment", "originalCommit": "91172c58e451a63ba540de6ee1fd23aa73198e84", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDQ4NjEzOA==", "url": "https://github.com/all-of-us/workbench/pull/3167#discussion_r384486138", "bodyText": "Let me see if there's a way to do that with this system. At the moment, I don't have true subcommands, and in the next PR it's just a shared options hash that individual tasks can choose from. I don't want to over-think this piece just yet though.\nI'm trying to find the Python package we saw in that one meeting.", "author": "jaycarlton", "createdAt": "2020-02-26T13:20:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDA3MzMwNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDA3NjYyMA==", "url": "https://github.com/all-of-us/workbench/pull/3167#discussion_r384076620", "bodyText": "Not to throw a wrench into things, but did you look at whether Terraform could work for applying these? https://www.terraform.io/docs/providers/google/r/monitoring_group.html\n(surface-level assessment as fine, there would be a lot of questions to answer here such as how we could run it and  how we'd do state tracking)", "author": "calbach", "createdAt": "2020-02-25T19:27:30Z", "path": "ops/ruby/devops-framework/tasks/count_monitoring_assets.rb", "diffHunk": "@@ -0,0 +1,66 @@\n+require \"google/cloud/monitoring\"\n+require 'logger'\n+\n+require_relative \"./lib/service_account_manager\"\n+require_relative './lib/gcp_environment_visitor'\n+\n+CUSTOM_METRIC_FILTER = \"metric.type = starts_with(\\\"custom.googleapis.com/\\\")\"\n+LOGS_BASED_METRIC_FILTER = \"metric.type = starts_with(\\\"logging.googleapis.com/\\\")\"\n+USER_LOGS_BASED_METRIC_FILTER = \"metric.type = starts_with(\\\"logging.googleapis.com/user/\\\")\"\n+\n+logger = Logger.new(STDOUT)\n+class MonitoringAssets\n+  def initialize(envrionments_path_json, logger = Logger.new(STDOUT))\n+    @visitor = GcpEnvironmentVisitor.new(envrionments_path_json, logger)\n+    @logger = logger\n+  end\n+\n+  # Demonstrate a simple usage of the AouEnvironmentVisitor with a few read-only operations\n+  # on monitoring things in all the environments.\n+  def inventory\n+    @visitor.visit do |env|\n+      counts  = {}\n+      metric_client = Google::Cloud::Monitoring::Metric.new\n+      metric_project_path = Google::Cloud::Monitoring::V3::MetricServiceClient.project_path(env.project_id)", "originalCommit": "91172c58e451a63ba540de6ee1fd23aa73198e84", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDQ5NjE1NQ==", "url": "https://github.com/all-of-us/workbench/pull/3167#discussion_r384496155", "bodyText": "This inventory task is just listing stuff, so no writes should be happening.\nThat sounds like almost, but not quite, what a stackdriver MonitoredResource is. At the moment, OpenCensus stands up the custom metrics itself (for gauges), and we're faking the rest with logs-based metrics, which I don't see support for. If it has a rich template system, that would be worth looking at, but I'm wondering how much we can pick and choose things here.\nResource groups look nice, but we don't have a use for them yet from what I've seen.\nIf I add a dependency on terraform, am I restricting this toolkit to just Terra apps?\nOne ulterior motive. with starting. from the vanilla Stackdriver client is to continue to provide them more useful feedback.", "author": "jaycarlton", "createdAt": "2020-02-26T13:38:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDA3NjYyMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTM4MDMwNg==", "url": "https://github.com/all-of-us/workbench/pull/3167#discussion_r385380306", "bodyText": "RE log-based metrics:\nThis? https://www.terraform.io/docs/providers/google/r/logging_metric.html\nRE Terraform:\nWhile Terra is technically a prefix of Terraform, and there are usages of Terraform by Terra, it is an entirely independent and unrelated tool: https://www.terraform.io .\nRE Feedback:\nI'm sure the Stackdriver team also has an interest in receiving feedback/usage on their Terraform provider.", "author": "calbach", "createdAt": "2020-02-27T21:25:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDA3NjYyMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDA3Nzc0MA==", "url": "https://github.com/all-of-us/workbench/pull/3167#discussion_r384077740", "bodyText": "Is this effectively a per-environment config JSON file which is tracked in source?", "author": "calbach", "createdAt": "2020-02-25T19:29:32Z", "path": "ops/ruby/devops-framework/DEVOPS_FRAMEWORK.md", "diffHunk": "@@ -0,0 +1,78 @@\n+# DevOps Framework\n+\n+## Purpose\n+This is a small but flexible framework for automating DevOps actions and ensuring they are\n+taken in a traceable, repeatable, and consistent way. It operates by  communicating to Google Cloud Platform\n+directly, independently of the existing build, operations, and deployment pipeline(s).\n+\n+## Usage\n+The entry point to all functionality is `devops.rb`, which provides command line and environment\n+loading and dispatches to Task classes (not scripts) that do the real work.\n+`./devops.rb  -t <task_name> -e <env_file> --task-option-1 value1`\n+\n+There is also a dynamically-generated help file from the descriptions given in the options.\n+```\n+$ ruby ./devops.rb  --help\n+Usage: devops [options]\n+    -t, --task [TASK]                Task to be in in each environment\n+    -e, --envs-file [ENVS_FILE]      Path to environments JSON file.", "originalCommit": "91172c58e451a63ba540de6ee1fd23aa73198e84", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDQ4Njc4OQ==", "url": "https://github.com/all-of-us/workbench/pull/3167#discussion_r384486789", "bodyText": "This project doesn't know or depend on anything in our source tree. The input file can live anywhere, but I don't think it should go in this public repo.", "author": "jaycarlton", "createdAt": "2020-02-26T13:21:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDA3Nzc0MA=="}], "type": "inlineReview"}, {"oid": "891e9a6e60b61d5d8324745026e1c393ec2680a4", "url": "https://github.com/all-of-us/workbench/commit/891e9a6e60b61d5d8324745026e1c393ec2680a4", "message": "help stuff", "committedDate": "2020-02-25T23:44:24Z", "type": "commit"}, {"oid": "538dcfb8e73530e132cd73d34592363de6ea5294", "url": "https://github.com/all-of-us/workbench/commit/538dcfb8e73530e132cd73d34592363de6ea5294", "message": "PR comments", "committedDate": "2020-02-26T13:40:01Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTM4Mzc4Mg==", "url": "https://github.com/all-of-us/workbench/pull/3167#discussion_r385383782", "bodyText": "Please update this to reflect what we discussed today. My takeaway understanding was:\nThis is an experiment in an approach to a devops framework. The rationale for it coexisting with the other devops tooling is that the current framework has many issues, and it would be a large undertaking to refactor the entirety of the existing system in one go. At a later point we will evaluate whether we want to switch our existing devops tooling to follow this model, or merge these models, or move to a separate third (e.g. non-Ruby) model.", "author": "calbach", "createdAt": "2020-02-27T21:32:59Z", "path": "ops/ruby/devops-framework/README.md", "diffHunk": "@@ -0,0 +1,108 @@\n+# DevOps Framework\n+\n+## Purpose", "originalCommit": "538dcfb8e73530e132cd73d34592363de6ea5294", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "8eed990cac0e38e773dd5508ce9ff75b2718c5b1", "url": "https://github.com/all-of-us/workbench/commit/8eed990cac0e38e773dd5508ce9ff75b2718c5b1", "message": "codacy fixes", "committedDate": "2020-02-27T21:40:44Z", "type": "commit"}, {"oid": "c20ec0e384e257d2cff6b55d7b8767887816732a", "url": "https://github.com/all-of-us/workbench/commit/c20ec0e384e257d2cff6b55d7b8767887816732a", "message": "update readme", "committedDate": "2020-02-27T21:53:21Z", "type": "commit"}]}