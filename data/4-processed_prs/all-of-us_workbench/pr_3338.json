{"pr_number": 3338, "pr_title": "[RW-3128][RISK=NO] local rollback command(s)", "pr_createdAt": "2020-04-03T00:15:08Z", "pr_url": "https://github.com/all-of-us/workbench/pull/3338", "timeline": [{"oid": "f0afad5d6bd621e0a212874e01258953cb28d117", "url": "https://github.com/all-of-us/workbench/commit/f0afad5d6bd621e0a212874e01258953cb28d117", "message": "hack migrations script for rollback", "committedDate": "2020-03-31T16:52:30Z", "type": "commit"}, {"oid": "2ed5d6e8db083502290f68734f8fe51783a22326", "url": "https://github.com/all-of-us/workbench/commit/2ed5d6e8db083502290f68734f8fe51783a22326", "message": "progress", "committedDate": "2020-04-02T16:23:57Z", "type": "commit"}, {"oid": "7a2215ddb4db40664e2e11accc722759b2dcb8d6", "url": "https://github.com/all-of-us/workbench/commit/7a2215ddb4db40664e2e11accc722759b2dcb8d6", "message": "remove comment", "committedDate": "2020-04-03T00:11:32Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjY2NzY2OQ==", "url": "https://github.com/all-of-us/workbench/pull/3338#discussion_r402667669", "bodyText": "There's still an issue with this block, at least accorrding to IntelliJ's gradle plugin", "author": "jaycarlton", "createdAt": "2020-04-03T00:16:23Z", "path": "api/db/build.gradle", "diffHunk": "@@ -11,16 +11,16 @@ apply plugin: 'org.liquibase.gradle'\n \n def db_host = System.getenv(\"DB_HOST\") ?: \"db\"\n def db_port = System.getenv(\"DB_PORT\") ?: \"3306\"\n+def liquibase_username = \"liquibase\"\n def liquibase_password = System.getenv(\"LIQUIBASE_DB_PASSWORD\") ?: \"lb-notasecret\"\n \n liquibase {\n     activities {\n         main {", "originalCommit": "7a2215ddb4db40664e2e11accc722759b2dcb8d6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjY2ODE3NA==", "url": "https://github.com/all-of-us/workbench/pull/3338#discussion_r402668174", "bodyText": "I did this to make the db/build.gradle project importable in IntelliJ. I'm not sure this is the right way to do it or if I still need it. #dev-productivity thread.", "author": "jaycarlton", "createdAt": "2020-04-03T00:18:06Z", "path": "api/db/gradle-wrapper.properties", "diffHunk": "@@ -0,0 +1,6 @@\n+#Wed Apr 01 12:34:20 EDT 2020\n+distributionUrl=https\\://services.gradle.org/distributions/gradle-4.6-all.zip", "originalCommit": "7a2215ddb4db40664e2e11accc722759b2dcb8d6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjY2ODQ3NA==", "url": "https://github.com/all-of-us/workbench/pull/3338#discussion_r402668474", "bodyText": "I want to break this script up into one that builds the database and one that runs a liquibase command. Even better if we can drive liquibase without Bash or Ruby.", "author": "jaycarlton", "createdAt": "2020-04-03T00:19:03Z", "path": "api/db/run-migrations.sh", "diffHunk": "@@ -22,7 +16,9 @@ trap finish EXIT\n envsubst < \"$(dirname \"${BASH_SOURCE}\")/create_db.sql\" > $CREATE_DB_FILE\n \n echo \"Creating database if it does not exist...\"\n+# This command is run regardless, and we rely on the commands in CREATE_DB_FILE being idempotent.\n mysql -h ${DB_HOST} --port ${DB_PORT} -u root -p${MYSQL_ROOT_PASSWORD} < ${CREATE_DB_FILE}", "originalCommit": "7a2215ddb4db40664e2e11accc722759b2dcb8d6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDIxMjc5OA==", "url": "https://github.com/all-of-us/workbench/pull/3338#discussion_r404212798", "bodyText": "Pushed to a later task.", "author": "jaycarlton", "createdAt": "2020-04-06T16:09:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjY2ODQ3NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjY2ODY1Mg==", "url": "https://github.com/all-of-us/workbench/pull/3338#discussion_r402668652", "bodyText": "I don't actually know how this file works, but I don't remember making this change...", "author": "jaycarlton", "createdAt": "2020-04-03T00:19:42Z", "path": "api/gradle/wrapper/gradle-wrapper.properties", "diffHunk": "@@ -1,6 +1,6 @@\n-#Thu May 10 14:42:28 CDT 2018\n+#Wed Apr 01 12:34:20 EDT 2020", "originalCommit": "7a2215ddb4db40664e2e11accc722759b2dcb8d6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjY2ODk3MQ==", "url": "https://github.com/all-of-us/workbench/pull/3338#discussion_r402668971", "bodyText": "This was a pain to write, and Zeus help me if I want another option. The idea is that exactly one is provided.\nAlso, I want a general liquibase command. I'll do that tomorrow just for fun.", "author": "jaycarlton", "createdAt": "2020-04-03T00:21:02Z", "path": "api/libproject/devstart.rb", "diffHunk": "@@ -634,6 +634,50 @@ def run_local_all_migrations()\n   :fn => ->() { run_local_all_migrations() }\n })\n \n+def rollback_db(cmd_name, *args)\n+  puts \"in rollback_db. cmd_name: #{cmd_name} args: #{args}\"\n+  ensure_docker_sync\n+  op = WbOptionsParser.new(cmd_name, args)\n+  op.add_typed_option(\n+      \"--count=[count]\",\n+      Integer,\n+      ->(opts, c) { opts.count = c},\n+      \"Count of changesets to roll back from end.\")\n+\n+  op.add_typed_option(\n+      \"--tag [tag]\",\n+      String,\n+      ->(opts, t) { opts.tag = t},\n+      \"Liquibase changeset tag to roll back to.\")\n+  op.add_validator ->(opts) {", "originalCommit": "7a2215ddb4db40664e2e11accc722759b2dcb8d6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjY2OTUzMw==", "url": "https://github.com/all-of-us/workbench/pull/3338#discussion_r402669533", "bodyText": "We actually don't need to provide this explicitly (yet), since the only activity we have is main. That would simplify things considerably, though I don't want to sacrifice generality. If other activities are added later, the default is to run all of them, so semantics will change if we leave this out.\nIt would be more robust to set main as the default as well, if that's supported.", "author": "jaycarlton", "createdAt": "2020-04-03T00:23:03Z", "path": "api/db/run-migrations.sh", "diffHunk": "@@ -2,15 +2,9 @@\n set -xeuo pipefail\n IFS=$'\\n\\t'\n \n-activity=\"-PrunList=$1\"\n-if [ -z ${2+x} ]\n-then\n-    context=\"\"\n-else\n-    context=\"-Pcontexts=$2\"\n-fi\n-\n-# Ruby is not installed in our dev container and this script is short, so bash is fine.\n+liquibaseCommand=\"${1-update}\"\n+runList=\"-PrunList=${2-main}\"", "originalCommit": "7a2215ddb4db40664e2e11accc722759b2dcb8d6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjY2OTkzMA==", "url": "https://github.com/all-of-us/workbench/pull/3338#discussion_r402669930", "bodyText": "This is really gross, but it works. I.e. we are handing the liquibase plugin an empty command value, and it doesn't break anything.\nThis script is way past my Bash expertise/tolerance. If I need to keep it, I want to port to Ruby or Python, or even pure Gradle.", "author": "jaycarlton", "createdAt": "2020-04-03T00:24:28Z", "path": "api/db/run-migrations.sh", "diffHunk": "@@ -2,15 +2,9 @@\n set -xeuo pipefail\n IFS=$'\\n\\t'\n \n-activity=\"-PrunList=$1\"\n-if [ -z ${2+x} ]\n-then\n-    context=\"\"\n-else\n-    context=\"-Pcontexts=$2\"\n-fi\n-\n-# Ruby is not installed in our dev container and this script is short, so bash is fine.\n+liquibaseCommand=\"${1-update}\"\n+runList=\"-PrunList=${2-main}\"\n+liquibaseArgs=\"${3--PliquibaseCommandValue=}\"", "originalCommit": "7a2215ddb4db40664e2e11accc722759b2dcb8d6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjY4MTY4MQ==", "url": "https://github.com/all-of-us/workbench/pull/3338#discussion_r402681681", "bodyText": "Perhaps a more specific flag name, e.g. --to-tag ; currently it's slightly ambiguous as to whether it's rolling back TO this tag, or rolling back JUST this tag.", "author": "calbach", "createdAt": "2020-04-03T01:07:48Z", "path": "api/libproject/devstart.rb", "diffHunk": "@@ -634,6 +634,50 @@ def run_local_all_migrations()\n   :fn => ->() { run_local_all_migrations() }\n })\n \n+def rollback_db(cmd_name, *args)\n+  puts \"in rollback_db. cmd_name: #{cmd_name} args: #{args}\"\n+  ensure_docker_sync\n+  op = WbOptionsParser.new(cmd_name, args)\n+  op.add_typed_option(\n+      \"--count=[count]\",\n+      Integer,\n+      ->(opts, c) { opts.count = c},\n+      \"Count of changesets to roll back from end.\")\n+\n+  op.add_typed_option(\n+      \"--tag [tag]\",", "originalCommit": "7a2215ddb4db40664e2e11accc722759b2dcb8d6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "713446bcfee69b33b2f284bd7ae7e0c9c1004d6c", "url": "https://github.com/all-of-us/workbench/commit/713446bcfee69b33b2f284bd7ae7e0c9c1004d6c", "message": "expose liquibase directly", "committedDate": "2020-04-03T17:37:05Z", "type": "commit"}, {"oid": "20d78e4a5da20d1e43ade5a5f7b1a67cfafe3476", "url": "https://github.com/all-of-us/workbench/commit/20d78e4a5da20d1e43ade5a5f7b1a67cfafe3476", "message": "don't use external runList anymore. it's not there", "committedDate": "2020-04-06T15:49:25Z", "type": "commit"}, {"oid": "5e254c4c736555e4fff4582bad60ed7850111697", "url": "https://github.com/all-of-us/workbench/commit/5e254c4c736555e4fff4582bad60ed7850111697", "message": "use a wrapper task called liquibase and confirm with user before continuing.", "committedDate": "2020-04-06T16:04:58Z", "type": "commit"}, {"oid": "3501c3b240281ac3419a7c25b95948c0f50020a0", "url": "https://github.com/all-of-us/workbench/commit/3501c3b240281ac3419a7c25b95948c0f50020a0", "message": "restore changelog", "committedDate": "2020-04-06T16:09:04Z", "type": "commit"}, {"oid": "c17cd82f68d389b231fadcce5947d7586d4078cf", "url": "https://github.com/all-of-us/workbench/commit/c17cd82f68d389b231fadcce5947d7586d4078cf", "message": "trying to use db context", "committedDate": "2020-04-08T13:16:30Z", "type": "commit"}, {"oid": "bdefe71ae8a7c9ad703c2b3ed086d60be075c1be", "url": "https://github.com/all-of-us/workbench/commit/bdefe71ae8a7c9ad703c2b3ed086d60be075c1be", "message": "fixes", "committedDate": "2020-04-08T21:34:48Z", "type": "commit"}, {"oid": "dffaf532319060911251d202600263d859c90bf5", "url": "https://github.com/all-of-us/workbench/commit/dffaf532319060911251d202600263d859c90bf5", "message": "cleanup slightly", "committedDate": "2020-04-09T13:05:53Z", "type": "commit"}, {"oid": "e317c18d91aaf63cb3b350d3e61185358ecaa861", "url": "https://github.com/all-of-us/workbench/commit/e317c18d91aaf63cb3b350d3e61185358ecaa861", "message": "merge", "committedDate": "2020-04-09T13:14:43Z", "type": "commit"}, {"oid": "9c2a3159963a5b6552b9b019e0924b73ab011c38", "url": "https://github.com/all-of-us/workbench/commit/9c2a3159963a5b6552b9b019e0924b73ab011c38", "message": "tidy up repeated code and add a couple trace logs", "committedDate": "2020-04-09T13:34:29Z", "type": "commit"}, {"oid": "74626f87c6d0872bff2784f9aaa50e5a801bc71d", "url": "https://github.com/all-of-us/workbench/commit/74626f87c6d0872bff2784f9aaa50e5a801bc71d", "message": "kill rollback-db command; it was just a different way to invoke run-liquibase in the end", "committedDate": "2020-04-09T13:36:37Z", "type": "commit"}, {"oid": "7b45b4771fd0c6b9040f9401d7e8492bd827707c", "url": "https://github.com/all-of-us/workbench/commit/7b45b4771fd0c6b9040f9401d7e8492bd827707c", "message": "restore properties file and add status line to sql proxy stuff", "committedDate": "2020-04-09T15:21:46Z", "type": "commit"}, {"oid": "fc9956be93a34d5ae4ba267e73e445783b0776e2", "url": "https://github.com/all-of-us/workbench/commit/fc9956be93a34d5ae4ba267e73e445783b0776e2", "message": "make proxy optional", "committedDate": "2020-04-09T17:19:47Z", "type": "commit"}, {"oid": "a53522d8ad82e313ea9e0b029c79651fcb46a129", "url": "https://github.com/all-of-us/workbench/commit/a53522d8ad82e313ea9e0b029c79651fcb46a129", "message": "remove old task name", "committedDate": "2020-04-09T17:28:16Z", "type": "commit"}, {"oid": "73a9d457aa1b9aa9708723c1d31195b3b5b63b2e", "url": "https://github.com/all-of-us/workbench/commit/73a9d457aa1b9aa9708723c1d31195b3b5b63b2e", "message": "rmeove unneeded changes", "committedDate": "2020-04-09T21:06:43Z", "type": "commit"}, {"oid": "f6cb24a0d4b6093b3ee925b53bfe4c402647a623", "url": "https://github.com/all-of-us/workbench/commit/f6cb24a0d4b6093b3ee925b53bfe4c402647a623", "message": "remove log line", "committedDate": "2020-04-09T21:07:17Z", "type": "commit"}, {"oid": "74e7fd57e96f4acb8b3b16b6cf2cff593bd69f12", "url": "https://github.com/all-of-us/workbench/commit/74e7fd57e96f4acb8b3b16b6cf2cff593bd69f12", "message": "restore script", "committedDate": "2020-04-09T21:09:21Z", "type": "commit"}, {"oid": "a26555029c4f0d19932d8c07189661fda8bbd464", "url": "https://github.com/all-of-us/workbench/commit/a26555029c4f0d19932d8c07189661fda8bbd464", "message": "cleanup & vars", "committedDate": "2020-04-09T21:58:38Z", "type": "commit"}, {"oid": "9945de0922ad14220f06a33c928f00e628efa4ae", "url": "https://github.com/all-of-us/workbench/commit/9945de0922ad14220f06a33c928f00e628efa4ae", "message": "unneeded stuff", "committedDate": "2020-04-09T22:24:53Z", "type": "commit"}, {"oid": "e95e115ed36ffe583c08d98cb874a7e36ab103fc", "url": "https://github.com/all-of-us/workbench/commit/e95e115ed36ffe583c08d98cb874a7e36ab103fc", "message": "cleanup", "committedDate": "2020-04-09T22:28:15Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjI0MTQxMA==", "url": "https://github.com/all-of-us/workbench/pull/3338#discussion_r406241410", "bodyText": "Arguably, I don't strictly need to make changes here anymore now that I'm calling the gradle task directly in run_liquibase. However, this does give us some flexibility later on to run arbitrary tasks without doing the user confirmation.", "author": "jaycarlton", "createdAt": "2020-04-09T14:22:56Z", "path": "api/db/run-migrations.sh", "diffHunk": "@@ -2,15 +2,9 @@\n set -xeuo pipefail\n IFS=$'\\n\\t'\n \n-activity=\"-PrunList=$1\"\n-if [ -z ${2+x} ]\n-then\n-    context=\"\"\n-else\n-    context=\"-Pcontexts=$2\"\n-fi\n-\n-# Ruby is not installed in our dev container and this script is short, so bash is fine.\n+liquibaseCommand=\"${1-update}\"", "originalCommit": "9c2a3159963a5b6552b9b019e0924b73ab011c38", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjI3OTY5MA==", "url": "https://github.com/all-of-us/workbench/pull/3338#discussion_r406279690", "bodyText": "Keeping this line in place breaks IntelliJ's gradle plugin. specifically, it can't be added to the Gradle pane as a project.", "author": "jaycarlton", "createdAt": "2020-04-09T15:15:59Z", "path": "api/db-cdr/build.gradle", "diffHunk": "@@ -51,6 +51,5 @@ liquibase {\n             username \"liquibase\"\n             password \"${liquibase_password}\"\n         }\n-        runList = project.ext.runList", "originalCommit": "9c2a3159963a5b6552b9b019e0924b73ab011c38", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjUzNzc5Nw==", "url": "https://github.com/all-of-us/workbench/pull/3338#discussion_r406537797", "bodyText": "spelling", "author": "calbach", "createdAt": "2020-04-09T23:56:19Z", "path": "api/libproject/devstart.rb", "diffHunk": "@@ -634,6 +634,116 @@ def run_local_all_migrations()\n   :fn => ->() { run_local_all_migrations() }\n })\n \n+def liquibase_gradlew_command(verification_command, argument, run_list)\n+  verificion_full_cmd = %W{../gradlew #{verification_command} -PrunList=#{run_list}}", "originalCommit": "e95e115ed36ffe583c08d98cb874a7e36ab103fc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjUzODU5MQ==", "url": "https://github.com/all-of-us/workbench/pull/3338#discussion_r406538591", "bodyText": "\ud83d\ude21", "author": "calbach", "createdAt": "2020-04-09T23:59:10Z", "path": "api/libproject/devstart.rb", "diffHunk": "@@ -634,6 +634,116 @@ def run_local_all_migrations()\n   :fn => ->() { run_local_all_migrations() }\n })\n \n+def liquibase_gradlew_command(verification_command, argument, run_list)\n+  verificion_full_cmd = %W{../gradlew #{verification_command} -PrunList=#{run_list}}\n+  unless argument.nil? || argument.empty?\n+    verificion_full_cmd << argument\n+  end\n+  verificion_full_cmd\n+end\n+\n+# Run a liqibase command against the specified project. Where possible, show SQL\n+# statements and ask user for verification.\n+def run_liquibase(cmd_name, *args)\n+  command_to_sql = {\n+      'changelogSync' => 'changelogSyncSQL',\n+      'markNextChangesetRan' => 'markNextChangesetRanSQL',\n+      'rollback' => 'rollbackSQL',\n+      'rollbackCount' => 'rollbackCountSQL',\n+      'rollbackToDate' => 'rollbackToDateSQL',\n+      'update' => 'updateSQL',\n+      'updateCount' => 'updateCountSql',", "originalCommit": "e95e115ed36ffe583c08d98cb874a7e36ab103fc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjc0MjM0NA==", "url": "https://github.com/all-of-us/workbench/pull/3338#discussion_r406742344", "bodyText": "So it's documented as updateCountSql officially, but the task in the plugin is updateCountSql.\nupdateCountSql - Writes SQL to apply the next <liquibaseCommandValue> change sets to STDOUT.\n\nI'll add a comment bemoaning this situation.", "author": "jaycarlton", "createdAt": "2020-04-10T12:48:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjUzODU5MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjUzODc1NQ==", "url": "https://github.com/all-of-us/workbench/pull/3338#discussion_r406538755", "bodyText": "argument", "author": "calbach", "createdAt": "2020-04-09T23:59:49Z", "path": "api/libproject/devstart.rb", "diffHunk": "@@ -634,6 +634,116 @@ def run_local_all_migrations()\n   :fn => ->() { run_local_all_migrations() }\n })\n \n+def liquibase_gradlew_command(verification_command, argument, run_list)\n+  verificion_full_cmd = %W{../gradlew #{verification_command} -PrunList=#{run_list}}\n+  unless argument.nil? || argument.empty?\n+    verificion_full_cmd << argument\n+  end\n+  verificion_full_cmd\n+end\n+\n+# Run a liqibase command against the specified project. Where possible, show SQL\n+# statements and ask user for verification.\n+def run_liquibase(cmd_name, *args)\n+  command_to_sql = {\n+      'changelogSync' => 'changelogSyncSQL',\n+      'markNextChangesetRan' => 'markNextChangesetRanSQL',\n+      'rollback' => 'rollbackSQL',\n+      'rollbackCount' => 'rollbackCountSQL',\n+      'rollbackToDate' => 'rollbackToDateSQL',\n+      'update' => 'updateSQL',\n+      'updateCount' => 'updateCountSql',\n+      'updateToTag' => 'updateToTagSQL'\n+  }\n+\n+  common = Common.new\n+  ensure_docker(cmd_name, args)\n+\n+  op = WbOptionsParser.new(cmd_name, args)\n+  op.add_typed_option(\n+      \"--command [command]\",\n+      String,\n+      ->(opts, c) { opts.command = c},\n+      \"Liquibase command, e.g. update, rollback, tag, validate. See \"+\n+          \"https://www.liquibase.org/documentation/command_line.html\")\n+  op.add_typed_option(\n+      \"--argument [argument]\",\n+      String,\n+      ->(opts, a) { opts.argument = a},\n+      \"Liquibase command argument, e.g. count or tag value\")\n+  op.add_typed_option(\n+        \"--run-list [run_list]\",\n+        String,\n+        ->(opts, rl) { opts.run_list = rl },\n+        \"Liquibase runList, a comma-separated list of activities in the liquibase task\")\n+  op.add_typed_option(\n+        '--project [project]',\n+        String,\n+        ->(opts, p) { opts.project = p },\n+        'AoU environment GCP project full name. Used to pick MySQL instance & creadentials.'\n+  )\n+  op.add_validator ->(opts) {\n+    if opts.command.nil? || opts.command.empty?\n+      raise ArgumentError.new(\"command is required\")\n+    end\n+  }\n+  op.parse.validate\n+\n+  # Currently there's only one activity (main), and leaving out the runList arugment causes", "originalCommit": "e95e115ed36ffe583c08d98cb874a7e36ab103fc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjUzOTM2OA==", "url": "https://github.com/all-of-us/workbench/pull/3338#discussion_r406539368", "bodyText": "I believe it executes a subprocess, presumably it didn't say cd not found, rather it didn't have any effect?", "author": "calbach", "createdAt": "2020-04-10T00:02:11Z", "path": "api/libproject/devstart.rb", "diffHunk": "@@ -634,6 +634,116 @@ def run_local_all_migrations()\n   :fn => ->() { run_local_all_migrations() }\n })\n \n+def liquibase_gradlew_command(verification_command, argument, run_list)\n+  verificion_full_cmd = %W{../gradlew #{verification_command} -PrunList=#{run_list}}\n+  unless argument.nil? || argument.empty?\n+    verificion_full_cmd << argument\n+  end\n+  verificion_full_cmd\n+end\n+\n+# Run a liqibase command against the specified project. Where possible, show SQL\n+# statements and ask user for verification.\n+def run_liquibase(cmd_name, *args)\n+  command_to_sql = {\n+      'changelogSync' => 'changelogSyncSQL',\n+      'markNextChangesetRan' => 'markNextChangesetRanSQL',\n+      'rollback' => 'rollbackSQL',\n+      'rollbackCount' => 'rollbackCountSQL',\n+      'rollbackToDate' => 'rollbackToDateSQL',\n+      'update' => 'updateSQL',\n+      'updateCount' => 'updateCountSql',\n+      'updateToTag' => 'updateToTagSQL'\n+  }\n+\n+  common = Common.new\n+  ensure_docker(cmd_name, args)\n+\n+  op = WbOptionsParser.new(cmd_name, args)\n+  op.add_typed_option(\n+      \"--command [command]\",\n+      String,\n+      ->(opts, c) { opts.command = c},\n+      \"Liquibase command, e.g. update, rollback, tag, validate. See \"+\n+          \"https://www.liquibase.org/documentation/command_line.html\")\n+  op.add_typed_option(\n+      \"--argument [argument]\",\n+      String,\n+      ->(opts, a) { opts.argument = a},\n+      \"Liquibase command argument, e.g. count or tag value\")\n+  op.add_typed_option(\n+        \"--run-list [run_list]\",\n+        String,\n+        ->(opts, rl) { opts.run_list = rl },\n+        \"Liquibase runList, a comma-separated list of activities in the liquibase task\")\n+  op.add_typed_option(\n+        '--project [project]',\n+        String,\n+        ->(opts, p) { opts.project = p },\n+        'AoU environment GCP project full name. Used to pick MySQL instance & creadentials.'\n+  )\n+  op.add_validator ->(opts) {\n+    if opts.command.nil? || opts.command.empty?\n+      raise ArgumentError.new(\"command is required\")\n+    end\n+  }\n+  op.parse.validate\n+\n+  # Currently there's only one activity (main), and leaving out the runList arugment causes\n+  # it to run that activity. However, that's not because it's detected as default or primary, but\n+  # leaving out the runList is equivalent to specifying all of the activities to run in unspecified\n+  # order.\n+  # https://github.com/liquibase/liquibase-gradle-plugin#3-configuring-the-plugin\n+  if op.opts.run_list.nil? || op.opts.run_list.empty?\n+    run_list = \"main\"\n+  else\n+    run_list = op.opts.run_list\n+  end\n+\n+  if op.opts.argument.nil? || op.opts.argument.empty?\n+    # It's safe to pass the '-PliquibaseCommand=' by itself, but it's not very clean\n+    argument = ''\n+  else\n+    argument = \"-PliquibaseCommandValue=#{op.opts.argument}\"\n+  end\n+\n+  if op.opts.project.nil? || op.opts.project.empty?\n+    op.opts.project = 'local'\n+  end\n+\n+  context = GcloudContextV2.new(op)\n+  context.validate\n+\n+  with_optional_cloud_proxy_and_db(context, nil, 'sa-key.json') do |gcc|\n+    common.status('inside with_optional_cloud_proxy_and_db')\n+    common.status(\"project: #{gcc.project}, account: #{gcc.account}, creds_file: #{gcc.creds_file}, dir: #{Dir.pwd}\")\n+    command = op.opts.command\n+\n+    Dir.chdir('db') # 'cd' isn't available to run inline apparently", "originalCommit": "e95e115ed36ffe583c08d98cb874a7e36ab103fc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjc3MDU3OA==", "url": "https://github.com/all-of-us/workbench/pull/3338#discussion_r406770578", "bodyText": "If I change that line to common.run_inline(%W{cd db}), I get\nproject: local, account: jay.carlton@pmi-ops.org, creds_file: , dir: /w/api\n+ cd db\nTraceback (most recent call last):\n\t8: from /w/api/project.rb:6:in `<main>'\n\t7: from /w/aou-utils/workbench.rb:61:in `handle_argv_or_die'\n\t6: from /w/aou-utils/utils/common.rb:86:in `handle_or_die'\n\t5: from /w/api/libproject/devstart.rb:745:in `block in <top (required)>'\n\t4: from /w/api/libproject/devstart.rb:717:in `run_liquibase'\n\t3: from /w/api/libproject/devstart.rb:2117:in `with_optional_cloud_proxy_and_db'\n\t2: from /w/api/libproject/devstart.rb:723:in `block in run_liquibase'\n\t1: from /w/aou-utils/utils/common.rb:157:in `run_inline'\n/w/aou-utils/utils/common.rb:157:in `spawn': No such file or directory - cd (Errno::ENOENT)", "author": "jaycarlton", "createdAt": "2020-04-10T14:00:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjUzOTM2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjg4NDU1MA==", "url": "https://github.com/all-of-us/workbench/pull/3338#discussion_r406884550", "bodyText": "Well.. consider me confused as well", "author": "calbach", "createdAt": "2020-04-10T18:28:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjUzOTM2OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjUzOTcxNg==", "url": "https://github.com/all-of-us/workbench/pull/3338#discussion_r406539716", "bodyText": "thanks, not a bad solution", "author": "calbach", "createdAt": "2020-04-10T00:03:36Z", "path": "api/libproject/devstart.rb", "diffHunk": "@@ -1999,6 +2109,19 @@ def with_cloud_proxy_and_db(gcc, service_account = nil, key_file = nil)\n   end\n end\n \n+def with_optional_cloud_proxy_and_db(gcc, service_account = nil, key_file = nil)", "originalCommit": "e95e115ed36ffe583c08d98cb874a7e36ab103fc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjU0MDI0OQ==", "url": "https://github.com/all-of-us/workbench/pull/3338#discussion_r406540249", "bodyText": "Does this duplicate the effect that gradle.properties is having? I assume that's just setting a default", "author": "calbach", "createdAt": "2020-04-10T00:05:49Z", "path": "api/libproject/devstart.rb", "diffHunk": "@@ -634,6 +634,116 @@ def run_local_all_migrations()\n   :fn => ->() { run_local_all_migrations() }\n })\n \n+def liquibase_gradlew_command(verification_command, argument, run_list)\n+  verificion_full_cmd = %W{../gradlew #{verification_command} -PrunList=#{run_list}}\n+  unless argument.nil? || argument.empty?\n+    verificion_full_cmd << argument\n+  end\n+  verificion_full_cmd\n+end\n+\n+# Run a liqibase command against the specified project. Where possible, show SQL\n+# statements and ask user for verification.\n+def run_liquibase(cmd_name, *args)\n+  command_to_sql = {\n+      'changelogSync' => 'changelogSyncSQL',\n+      'markNextChangesetRan' => 'markNextChangesetRanSQL',\n+      'rollback' => 'rollbackSQL',\n+      'rollbackCount' => 'rollbackCountSQL',\n+      'rollbackToDate' => 'rollbackToDateSQL',\n+      'update' => 'updateSQL',\n+      'updateCount' => 'updateCountSql',\n+      'updateToTag' => 'updateToTagSQL'\n+  }\n+\n+  common = Common.new\n+  ensure_docker(cmd_name, args)\n+\n+  op = WbOptionsParser.new(cmd_name, args)\n+  op.add_typed_option(\n+      \"--command [command]\",\n+      String,\n+      ->(opts, c) { opts.command = c},\n+      \"Liquibase command, e.g. update, rollback, tag, validate. See \"+\n+          \"https://www.liquibase.org/documentation/command_line.html\")\n+  op.add_typed_option(\n+      \"--argument [argument]\",\n+      String,\n+      ->(opts, a) { opts.argument = a},\n+      \"Liquibase command argument, e.g. count or tag value\")\n+  op.add_typed_option(\n+        \"--run-list [run_list]\",\n+        String,\n+        ->(opts, rl) { opts.run_list = rl },\n+        \"Liquibase runList, a comma-separated list of activities in the liquibase task\")\n+  op.add_typed_option(\n+        '--project [project]',\n+        String,\n+        ->(opts, p) { opts.project = p },\n+        'AoU environment GCP project full name. Used to pick MySQL instance & creadentials.'\n+  )\n+  op.add_validator ->(opts) {\n+    if opts.command.nil? || opts.command.empty?\n+      raise ArgumentError.new(\"command is required\")\n+    end\n+  }\n+  op.parse.validate\n+\n+  # Currently there's only one activity (main), and leaving out the runList arugment causes\n+  # it to run that activity. However, that's not because it's detected as default or primary, but\n+  # leaving out the runList is equivalent to specifying all of the activities to run in unspecified\n+  # order.\n+  # https://github.com/liquibase/liquibase-gradle-plugin#3-configuring-the-plugin\n+  if op.opts.run_list.nil? || op.opts.run_list.empty?\n+    run_list = \"main\"", "originalCommit": "e95e115ed36ffe583c08d98cb874a7e36ab103fc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjc0MjgzMA==", "url": "https://github.com/all-of-us/workbench/pull/3338#discussion_r406742830", "bodyText": "Oh good point. I just added the gradle.properties to shut up the IJ plugin so it would let me add db as a gradle project. Let me play with this.", "author": "jaycarlton", "createdAt": "2020-04-10T12:49:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjU0MDI0OQ=="}], "type": "inlineReview"}, {"oid": "7f474227dfe948890144bb90d80ea1c605ea9d60", "url": "https://github.com/all-of-us/workbench/commit/7f474227dfe948890144bb90d80ea1c605ea9d60", "message": "use longer verification string", "committedDate": "2020-04-10T16:27:54Z", "type": "commit"}]}