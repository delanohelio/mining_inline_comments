{"pr_number": 3197, "pr_title": "[RW-4246][RISK=LOW] Captcha requirement at the time of Registration", "pr_createdAt": "2020-02-27T19:23:46Z", "pr_url": "https://github.com/all-of-us/workbench/pull/3197", "timeline": [{"oid": "2f6df28a3e729d87c0b5aa492238303e18c31f58", "url": "https://github.com/all-of-us/workbench/commit/2f6df28a3e729d87c0b5aa492238303e18c31f58", "message": "Add captcha Demographic Survey page", "committedDate": "2020-02-27T19:20:39Z", "type": "commit"}, {"oid": "347617fba4ce0949e6e6d070884eed057c457027", "url": "https://github.com/all-of-us/workbench/commit/347617fba4ce0949e6e6d070884eed057c457027", "message": "Captcha conflict", "committedDate": "2020-02-27T19:55:52Z", "type": "commit"}, {"oid": "3030c8215c3834fc9de9cdf933471c27c654134c", "url": "https://github.com/all-of-us/workbench/commit/3030c8215c3834fc9de9cdf933471c27c654134c", "message": "Set captcha only if its enabled", "committedDate": "2020-02-27T19:59:59Z", "type": "commit"}, {"oid": "c146418e197a36ad7c0af67606fa3a2baae66581", "url": "https://github.com/all-of-us/workbench/commit/c146418e197a36ad7c0af67606fa3a2baae66581", "message": "fix test add comments", "committedDate": "2020-02-27T20:15:26Z", "type": "commit"}, {"oid": "d666ff5e16c7def1755501edaf2a3d4aa477a205", "url": "https://github.com/all-of-us/workbench/commit/d666ff5e16c7def1755501edaf2a3d4aa477a205", "message": "yarn lock", "committedDate": "2020-02-27T20:18:59Z", "type": "commit"}, {"oid": "e6913393a8ccb8b3f115f6ef62a9d43faa21cc22", "url": "https://github.com/all-of-us/workbench/commit/e6913393a8ccb8b3f115f6ef62a9d43faa21cc22", "message": "blank captcha key if captcha is not enabled", "committedDate": "2020-02-27T20:20:45Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTM0NzIyMg==", "url": "https://github.com/all-of-us/workbench/pull/3197#discussion_r385347222", "bodyText": "Nit: Please use specific imports as opposed to * imports.", "author": "s-rubenstein", "createdAt": "2020-02-27T20:14:07Z", "path": "api/src/main/java/org/pmiops/workbench/captcha/CaptchaServerVerificationResponse.java", "diffHunk": "@@ -0,0 +1,93 @@\n+package org.pmiops.workbench.captcha;\n+\n+import com.fasterxml.jackson.annotation.*;", "originalCommit": "3030c8215c3834fc9de9cdf933471c27c654134c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTM1MDYzMg==", "url": "https://github.com/all-of-us/workbench/pull/3197#discussion_r385350632", "bodyText": "Opt: Could either of these files be generated with Swagger? Assuming I understand and this is an api response object and a caller to the captcha API?\nThis is opt because this is a small number of methods and is unlikely to change, but may be worth considering.", "author": "s-rubenstein", "createdAt": "2020-02-27T20:21:36Z", "path": "api/src/main/java/org/pmiops/workbench/captcha/CaptchaServerVerificationResponse.java", "diffHunk": "@@ -0,0 +1,93 @@\n+package org.pmiops.workbench.captcha;", "originalCommit": "c146418e197a36ad7c0af67606fa3a2baae66581", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTM5NDgxOQ==", "url": "https://github.com/all-of-us/workbench/pull/3197#discussion_r385394819", "bodyText": "I started with the swagger approach that did not work for me hence i used this.", "author": "NehaBroad", "createdAt": "2020-02-27T21:56:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTM1MDYzMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTUwNjAwMw==", "url": "https://github.com/all-of-us/workbench/pull/3197#discussion_r385506003", "bodyText": "Apparently i need to borrow Greg's shame cube, the reason why this was not working in swagger was spelling mistake and security Definitions (we do not need it here)", "author": "NehaBroad", "createdAt": "2020-02-28T04:47:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTM1MDYzMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTM5OTgyNQ==", "url": "https://github.com/all-of-us/workbench/pull/3197#discussion_r385399825", "bodyText": "Drive-by comment: I think I lost the last round of \"battle\" over this topic in a PR from a couple months back (@als364 and @jaycarlton were on that one), but I still don't believe that filenames like this really belong in our per-environment config. Our convention has always been to have consistent filenames across environments, with just the bucket name changing (see credentialsBucketName). Most of our key / credential filenames are code-constants in CloudStorageServiceImpl\nI'm more than happy to be overruled if folks strongly disagree with that pattern. But it's important to note that we're actively introducing inconsistency in our system by storing key filenames in our config: some filenames will be stored in WorkbenchConfig, while most others continue to be code constants.\nIf we think there's benefit to migrating to the other approach, we should track a tech debt ticket & acknowledge the cost of migrating everything to the config pattern.", "author": "gjuggler", "createdAt": "2020-02-27T22:08:00Z", "path": "api/config/config_local.json", "diffHunk": "@@ -105,5 +105,9 @@\n     \"host\": \"pmi-drc-api-test.appspot.com\",\n     \"queueName\": \"rdrQueueTest\",\n     \"exportObjectsPerTask\" : 10\n+  },\n+  \"captcha\": {\n+    \"enableCaptcha\": true,\n+    \"serverKeyFileName\": \"captcha-server-key.txt\"", "originalCommit": "e6913393a8ccb8b3f115f6ef62a9d43faa21cc22", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTkwNzEzMg==", "url": "https://github.com/all-of-us/workbench/pull/3197#discussion_r385907132", "bodyText": "I agree we should migrate to the other approach, I don't think creating this new pattern should block this ticket, I do think creating said tech debt ticket should block this ticket.", "author": "als364", "createdAt": "2020-02-28T20:27:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTM5OTgyNQ=="}], "type": "inlineReview"}, {"oid": "6d482772b69b8c70bfef72d50ca975f3a3d2752f", "url": "https://github.com/all-of-us/workbench/commit/6d482772b69b8c70bfef72d50ca975f3a3d2752f", "message": "swagger for captcha", "committedDate": "2020-02-28T04:46:02Z", "type": "commit"}, {"oid": "56cc939d7f4215804b5f50e2d677eaaa82245146", "url": "https://github.com/all-of-us/workbench/commit/56cc939d7f4215804b5f50e2d677eaaa82245146", "message": "fix test", "committedDate": "2020-02-28T05:09:08Z", "type": "commit"}, {"oid": "703045182875144b04cac17b485b5a37bf547ab1", "url": "https://github.com/all-of-us/workbench/commit/703045182875144b04cac17b485b5a37bf547ab1", "message": "remove CaptchaServerVerificationResponse", "committedDate": "2020-02-28T05:11:31Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTkwOTYyMg==", "url": "https://github.com/all-of-us/workbench/pull/3197#discussion_r385909622", "bodyText": "This looks more like a ServiceImpl than a service - please pull out the Service interface.", "author": "als364", "createdAt": "2020-02-28T20:34:16Z", "path": "api/src/main/java/org/pmiops/workbench/captcha/CaptchaVerificationService.java", "diffHunk": "@@ -0,0 +1,72 @@\n+package org.pmiops.workbench.captcha;\n+\n+import java.util.logging.Level;\n+import java.util.logging.Logger;\n+import java.util.stream.Collectors;\n+import javax.inject.Provider;\n+import org.pmiops.workbench.captcha.api.CaptchaApi;\n+import org.pmiops.workbench.captcha.model.CaptchaVerificationResponse;\n+import org.pmiops.workbench.config.WorkbenchConfig;\n+import org.pmiops.workbench.google.CloudStorageService;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.stereotype.Service;\n+\n+/** Service to verify Captcha */\n+@Service\n+public class CaptchaVerificationService {", "originalCommit": "703045182875144b04cac17b485b5a37bf547ab1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTkxMDAwMA==", "url": "https://github.com/all-of-us/workbench/pull/3197#discussion_r385910000", "bodyText": "nit: either camelcase this or make it all lowercase", "author": "als364", "createdAt": "2020-02-28T20:35:17Z", "path": "api/src/test/java/org/pmiops/workbench/api/ProfileControllerTest.java", "diffHunk": "@@ -94,6 +96,8 @@\n   private static final String FAMILY_NAME = \"Bobberson\";\n   private static final String CONTACT_EMAIL = \"bob@example.com\";\n   private static final String INVITATION_KEY = \"secretpassword\";\n+  private static final String CAPTCHA_TOKEN = \"captchaToken\";\n+  private static final String WRONG_CAPTCHA_TOKEN = \"WrongcaptchaToken\";", "originalCommit": "703045182875144b04cac17b485b5a37bf547ab1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTkxMTYzMg==", "url": "https://github.com/all-of-us/workbench/pull/3197#discussion_r385911632", "bodyText": "jeez is this really how they cased it", "author": "als364", "createdAt": "2020-02-28T20:39:21Z", "path": "ui/src/app/pages/login/account-creation/account-creation-survey.tsx", "diffHunk": "@@ -13,7 +13,9 @@ import {SpinnerOverlay} from 'app/components/spinners';\n import {profileApi} from 'app/services/swagger-fetch-clients';\n import colors from 'app/styles/colors';\n import {toggleIncludes} from 'app/utils';\n+import {environment} from 'environments/environment';\n import {Profile} from 'generated/fetch';\n+import ReCAPTCHA from 'react-google-recaptcha';", "originalCommit": "703045182875144b04cac17b485b5a37bf547ab1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTkxMTgyMw==", "url": "https://github.com/all-of-us/workbench/pull/3197#discussion_r385911823", "bodyText": "nit: can you move this TODO up to line 93?", "author": "als364", "createdAt": "2020-02-28T20:39:50Z", "path": "ui/src/app/pages/login/account-creation/account-creation-survey.tsx", "diffHunk": "@@ -83,11 +91,21 @@ export class AccountCreationSurvey extends React.Component<AccountCreationSurvey\n         onComplete(savedProfile);\n       }).catch(error => {\n         console.log(error);\n-        this.setState({creatingAccount: false});\n+        if (environment.enableCaptcha) {\n+          // Reset captcha\n+          this.captchaRef.current.reset();\n+          this.setState({captcha: false});\n+        }\n         // TODO: we need to show some user-facing error message when this fails.", "originalCommit": "703045182875144b04cac17b485b5a37bf547ab1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTkxMjEzMw==", "url": "https://github.com/all-of-us/workbench/pull/3197#discussion_r385912133", "bodyText": "If you're not going to enable this straight away, please file a ticket to enable captcha in prod.", "author": "als364", "createdAt": "2020-02-28T20:40:42Z", "path": "ui/src/environments/environment.prod.ts", "diffHunk": "@@ -4,6 +4,7 @@ export const environment: Environment = {\n   displayTag: '',\n   shouldShowDisplayTag: false,\n   allOfUsApiUrl: 'https://api.workbench.researchallofus.org',\n+  captchaSiteKey: '',", "originalCommit": "703045182875144b04cac17b485b5a37bf547ab1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "a2943ca86b9d7e4834d7b2c055ef130cdbbb6362", "url": "https://github.com/all-of-us/workbench/commit/a2943ca86b9d7e4834d7b2c055ef130cdbbb6362", "message": "PR Comments Add serviceImpl remove filename from config", "committedDate": "2020-03-05T16:28:30Z", "type": "commit"}, {"oid": "d06f6d5b84f1a8aac3f11f668fc4292098cc8edc", "url": "https://github.com/all-of-us/workbench/commit/d06f6d5b84f1a8aac3f11f668fc4292098cc8edc", "message": "resolve file conflicts", "committedDate": "2020-03-05T16:35:26Z", "type": "commit"}, {"oid": "ddf9cf60a94aa9c136a1a88f3f74f3b5656d42e4", "url": "https://github.com/all-of-us/workbench/commit/ddf9cf60a94aa9c136a1a88f3f74f3b5656d42e4", "message": "spotless", "committedDate": "2020-03-05T16:58:29Z", "type": "commit"}]}