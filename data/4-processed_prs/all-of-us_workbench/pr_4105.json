{"pr_number": 4105, "pr_title": "[no ticket][risk=no] Puppeteer test suite wait timeout reduction", "pr_createdAt": "2020-10-02T00:33:24Z", "pr_url": "https://github.com/all-of-us/workbench/pull/4105", "timeline": [{"oid": "eab73593fcc02116abf29fe95cd4d168a529ab39", "url": "https://github.com/all-of-us/workbench/commit/eab73593fcc02116abf29fe95cd4d168a529ab39", "message": "wip", "committedDate": "2020-10-01T22:21:54Z", "type": "commit"}, {"oid": "11316bdf9fbc63bcb6b96db6b56b15d86c14481e", "url": "https://github.com/all-of-us/workbench/commit/11316bdf9fbc63bcb6b96db6b56b15d86c14481e", "message": "wip", "committedDate": "2020-10-01T22:42:15Z", "type": "commit"}, {"oid": "cebdd9a7285672ca1eefbc99d3f85adde62f34e2", "url": "https://github.com/all-of-us/workbench/commit/cebdd9a7285672ca1eefbc99d3f85adde62f34e2", "message": "fix broken tests", "committedDate": "2020-10-02T00:32:15Z", "type": "commit"}, {"oid": "18606d53a5c49a1e33e38a7a226eaa4b95b959ff", "url": "https://github.com/all-of-us/workbench/commit/18606d53a5c49a1e33e38a7a226eaa4b95b959ff", "message": "revert waits-utils", "committedDate": "2020-10-02T00:38:07Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODU3NDA0NA==", "url": "https://github.com/all-of-us/workbench/pull/4105#discussion_r498574044", "bodyText": "not used so I'm removing them.", "author": "aweng98", "createdAt": "2020-10-02T00:33:51Z", "path": "e2e/.env.sample", "diffHunk": "@@ -2,11 +2,3 @@\n USER_NAME=??\n # Workbench login password. Alternatively, set \"PASSWORD\" environment variable in the yarn command.\n PASSWORD=??\n-\n-# Puppeteer env\n-PUPPETEER_HEADLESS=true\n-# Slows down test playback speed in milliseconds\n-PUPPETEER_SLOWMO=10\n-# Time out in milliseconds\n-PUPPETEER_NAVIGATION_TIMEOUT=90000\n-PUPPETEER_TIMEOUT=90000", "originalCommit": "cebdd9a7285672ca1eefbc99d3f85adde62f34e2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODU3NDI4NA==", "url": "https://github.com/all-of-us/workbench/pull/4105#discussion_r498574284", "bodyText": "notebook Kernel to become ready could take a long time. So setting the timeout to 2 minutes.", "author": "aweng98", "createdAt": "2020-10-02T00:35:06Z", "path": "e2e/app/page/notebook-page.ts", "diffHunk": "@@ -190,10 +190,11 @@ export default class NotebookPage extends AuthenticatedPage {\n     }\n     await cellInput.dispose();\n     await this.run();\n-    await this.waitForKernelIdle(opts.timeOut);\n+    const {timeOut = 120000} = opts;", "originalCommit": "cebdd9a7285672ca1eefbc99d3f85adde62f34e2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODU3NDQzNA==", "url": "https://github.com/all-of-us/workbench/pull/4105#discussion_r498574434", "bodyText": "To fail CI e2e job little quicker.", "author": "aweng98", "createdAt": "2020-10-02T00:35:46Z", "path": "e2e/jest.config.js", "diffHunk": "@@ -3,7 +3,7 @@ const { TEST_MODE } = process.env;\n \n module.exports = {\n   \"verbose\": true,\n-  \"bail\": 3,  // Stop running tests after `n` failures\n+  \"bail\": 2,  // Stop running tests after `n` failures", "originalCommit": "cebdd9a7285672ca1eefbc99d3f85adde62f34e2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODU3NDY0Mw==", "url": "https://github.com/all-of-us/workbench/pull/4105#discussion_r498574643", "bodyText": "width:1280, height:680 is based on 15\" mac pro screen size.", "author": "aweng98", "createdAt": "2020-10-02T00:36:43Z", "path": "e2e/jest.test-setup.ts", "diffHunk": "@@ -14,9 +12,9 @@ const isDebugMode = process.argv.includes('--debug');\n  */\n beforeEach(async () => {\n   await page.setUserAgent(userAgent);\n-  // See https://github.com/puppeteer/puppeteer/blob/master/docs/api.md#pagesetdefaultnavigationtimeouttimeout\n-  page.setDefaultNavigationTimeout(navTimeOut);\n-  page.setDefaultTimeout(timeOut);\n+  await page.setViewport({width: 1280, height: 680});", "originalCommit": "cebdd9a7285672ca1eefbc99d3f85adde62f34e2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTA1MTAyMQ==", "url": "https://github.com/all-of-us/workbench/pull/4105#discussion_r499051021", "bodyText": "My first computer only had 512x342. \ud83d\udc74 Native res on a Mac Pro 15\" is 2880 x 1800.", "author": "jaycarlton", "createdAt": "2020-10-02T21:07:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODU3NDY0Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTA1NzM0NA==", "url": "https://github.com/all-of-us/workbench/pull/4105#discussion_r499057344", "bodyText": "right. 1280 x 680 actually is the minimum size where workbench UI does not have a horizontal scrollbar.", "author": "aweng98", "createdAt": "2020-10-02T21:26:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODU3NDY0Mw=="}], "type": "inlineReview"}, {"oid": "c118fc69b5ec853252af4326f9efd7064105bd92", "url": "https://github.com/all-of-us/workbench/commit/c118fc69b5ec853252af4326f9efd7064105bd92", "message": "login fix", "committedDate": "2020-10-02T14:32:13Z", "type": "commit"}, {"oid": "3a8d6819d9e04d3cdc34d8815bf274889d906b0b", "url": "https://github.com/all-of-us/workbench/commit/3a8d6819d9e04d3cdc34d8815bf274889d906b0b", "message": "wip", "committedDate": "2020-10-02T14:58:48Z", "type": "commit"}, {"oid": "80de2a7ce7f41f1e4bd35dbdab63a7e69f220d93", "url": "https://github.com/all-of-us/workbench/commit/80de2a7ce7f41f1e4bd35dbdab63a7e69f220d93", "message": "revert non-related changes", "committedDate": "2020-10-02T20:55:42Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTA0ODc0Mw==", "url": "https://github.com/all-of-us/workbench/pull/4105#discussion_r499048743", "bodyText": "setViewport might prevents bad click in Chrome headless mode.", "author": "aweng98", "createdAt": "2020-10-02T21:01:59Z", "path": "e2e/jest.test-setup.ts", "diffHunk": "@@ -14,9 +12,9 @@ const isDebugMode = process.argv.includes('--debug');\n  */\n beforeEach(async () => {\n   await page.setUserAgent(userAgent);\n-  // See https://github.com/puppeteer/puppeteer/blob/master/docs/api.md#pagesetdefaultnavigationtimeouttimeout\n-  page.setDefaultNavigationTimeout(navTimeOut);\n-  page.setDefaultTimeout(timeOut);\n+  await page.setViewport({width: 1280, height: 680});", "originalCommit": "80de2a7ce7f41f1e4bd35dbdab63a7e69f220d93", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTA1MTQ2Nw==", "url": "https://github.com/all-of-us/workbench/pull/4105#discussion_r499051467", "bodyText": "Is there a way to collect data on how long some of these actions take? Like record them to a spreadsheet or something? It would be interesting to see if 80% were under 2 seconds or something.", "author": "jaycarlton", "createdAt": "2020-10-02T21:09:07Z", "path": "e2e/jest.test-setup.ts", "diffHunk": "@@ -14,9 +12,9 @@ const isDebugMode = process.argv.includes('--debug');\n  */\n beforeEach(async () => {\n   await page.setUserAgent(userAgent);\n-  // See https://github.com/puppeteer/puppeteer/blob/master/docs/api.md#pagesetdefaultnavigationtimeouttimeout\n-  page.setDefaultNavigationTimeout(navTimeOut);\n-  page.setDefaultTimeout(timeOut);\n+  await page.setViewport({width: 1280, height: 680});\n+  page.setDefaultNavigationTimeout(60000); // Puppeteer default timeout is 30 seconds.", "originalCommit": "80de2a7ce7f41f1e4bd35dbdab63a7e69f220d93", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTA1NzY1MA==", "url": "https://github.com/all-of-us/workbench/pull/4105#discussion_r499057650", "bodyText": "there is a way by Puppeteer. I am taking note on this and a future PR is brewing.", "author": "aweng98", "createdAt": "2020-10-02T21:27:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTA1MTQ2Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTA1MTg1Mw==", "url": "https://github.com/all-of-us/workbench/pull/4105#discussion_r499051853", "bodyText": "this still seems high for signin. I feel like if it's  going to succeed, it'll do so in 10 seconds.", "author": "jaycarlton", "createdAt": "2020-10-02T21:10:16Z", "path": "e2e/utils/test-utils.ts", "diffHunk": "@@ -14,11 +14,12 @@ import {WorkspaceAccessLevel} from 'app/text-labels';\n import WorkspacesPage from 'app/page/workspaces-page';\n import {makeWorkspaceName} from './str-utils';\n \n+\n export async function signIn(page: Page, userId?: string, passwd?: string): Promise<void> {\n   const loginPage = new GoogleLoginPage(page);\n   await loginPage.login(userId, passwd);\n   // this element exists in DOM after user has logged in\n-  await page.waitForFunction(() => !!document.querySelector('app-signed-in'));\n+  await page.waitForFunction(() => !!document.querySelector('app-signed-in'), {timeout: 60000});", "originalCommit": "80de2a7ce7f41f1e4bd35dbdab63a7e69f220d93", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTA1ODQ1Nw==", "url": "https://github.com/all-of-us/workbench/pull/4105#discussion_r499058457", "bodyText": "Yes for single login session. But when Puppeteer tests are running in CI, up to 12 browsers hitting server simultaneously. In reality, unfortunately, speed isn't great.", "author": "aweng98", "createdAt": "2020-10-02T21:29:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTA1MTg1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTA2MDk4Mw==", "url": "https://github.com/all-of-us/workbench/pull/4105#discussion_r499060983", "bodyText": "The legitimate issue that's being mitigated here is that our servers are very slow on initial start up, and we're constantly pushing new versions to test. Without building some leniency into the test process, we're likely to see frequent failures from that. Reducing the server startup time or smoothing out the traffic shift on deployment are all reasonable mitigations to this that may be worth pursuing.", "author": "calbach", "createdAt": "2020-10-02T21:37:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTA1MTg1Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTA1MjA4Nw==", "url": "https://github.com/all-of-us/workbench/pull/4105#discussion_r499052087", "bodyText": "maybe default to 20 seconds and only go higher when timeOut is provided.", "author": "jaycarlton", "createdAt": "2020-10-02T21:10:57Z", "path": "e2e/utils/test-utils.ts", "diffHunk": "@@ -44,7 +45,7 @@ export async function signInAs(userId: string, passwd: string): Promise<Page> {\n  * It usually indicates the page is ready for user interaction.\n  * </pre>\n  */\n-export async function waitWhileLoading(page: Page, timeOut?: number): Promise<void> {\n+export async function waitWhileLoading(page: Page, timeOut: number = 90000): Promise<void> {", "originalCommit": "80de2a7ce7f41f1e4bd35dbdab63a7e69f220d93", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTA2MTU0Nw==", "url": "https://github.com/all-of-us/workbench/pull/4105#discussion_r499061547", "bodyText": "Thanks for adding this  - it's probably worth removing from the handful of tests where I've explicitly called it as well.", "author": "calbach", "createdAt": "2020-10-02T21:38:42Z", "path": "e2e/jest.test-setup.ts", "diffHunk": "@@ -14,9 +12,9 @@ const isDebugMode = process.argv.includes('--debug');\n  */\n beforeEach(async () => {\n   await page.setUserAgent(userAgent);\n-  // See https://github.com/puppeteer/puppeteer/blob/master/docs/api.md#pagesetdefaultnavigationtimeouttimeout\n-  page.setDefaultNavigationTimeout(navTimeOut);\n-  page.setDefaultTimeout(timeOut);\n+  await page.setViewport({width: 1280, height: 680});", "originalCommit": "80de2a7ce7f41f1e4bd35dbdab63a7e69f220d93", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}