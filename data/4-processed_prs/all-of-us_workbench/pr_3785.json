{"pr_number": 3785, "pr_title": "[risk=medium][RW-4980] Add an Admin updateAccount endpoint to power new Admin UI", "pr_createdAt": "2020-07-14T23:33:56Z", "pr_url": "https://github.com/all-of-us/workbench/pull/3785", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTE0MjMyNQ==", "url": "https://github.com/all-of-us/workbench/pull/3785#discussion_r455142325", "bodyText": "This seems clearer", "author": "jmthibault79", "createdAt": "2020-07-15T15:30:05Z", "path": "api/src/main/java/org/pmiops/workbench/billing/FreeTierBillingService.java", "diffHunk": "@@ -279,9 +279,8 @@ public Double getCachedFreeTierUsage(DbUser user) {\n    * @return whether the user has remaining credits\n    */\n   public boolean userHasRemainingFreeTierCredits(DbUser user) {\n-    return Optional.ofNullable(getCachedFreeTierUsage(user))\n-        .map(usage -> compareCosts(getUserFreeTierDollarLimit(user), usage) > 0)\n-        .orElse(true);\n+    final double usage = Optional.ofNullable(getCachedFreeTierUsage(user)).orElse(0.0);", "originalCommit": "eea22af4c4a0bcc72896ff41b6e095803eff57ad", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODE3NTMzOQ==", "url": "https://github.com/all-of-us/workbench/pull/3785#discussion_r458175339", "bodyText": "Yes. I'd also wrap compareCosts in something like isBelowCeiling(double usage, double ceiling) so we don't need the > 0 in this high-level function. In other words, all userHasRemainingFreeTierCredits knows how to do is get the limit and call the limit checker; no math happens here.", "author": "jaycarlton", "createdAt": "2020-07-21T15:13:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTE0MjMyNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTE2NjQ3Ng==", "url": "https://github.com/all-of-us/workbench/pull/3785#discussion_r455166476", "bodyText": "admins can change this, but users cannot.  See the validateProfile() methods family.", "author": "jmthibault79", "createdAt": "2020-07-15T16:09:42Z", "path": "api/src/main/java/org/pmiops/workbench/profile/ProfileService.java", "diffHunk": "@@ -201,6 +223,7 @@ public void updateProfileForUser(DbUser user, Profile updatedProfile, Profile pr\n \n     Timestamp now = new Timestamp(clock.instant().toEpochMilli());\n \n+    user.setContactEmail(updatedProfile.getContactEmail());", "originalCommit": "eea22af4c4a0bcc72896ff41b6e095803eff57ad", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODE4NzUyNw==", "url": "https://github.com/all-of-us/workbench/pull/3785#discussion_r458187527", "bodyText": "I don't like how we're mixing admin-only settings into the user-changeable stuff. We need to put authority guards around the set of properties only administrators can change.\nIf order is independent, it would be nice to bundle the admin properties into a setAdminProperties method or some such, guarded by an internal Authority check. I  think the @authority annotation only works at the controller level, but I'm not actually sure.", "author": "jaycarlton", "createdAt": "2020-07-21T15:29:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTE2NjQ3Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTk3NzYzNw==", "url": "https://github.com/all-of-us/workbench/pull/3785#discussion_r461977637", "bodyText": "The annotation is Controller-only, but I added a UserService.hasAuthority() here which does the job", "author": "jmthibault79", "createdAt": "2020-07-29T01:01:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTE2NjQ3Ng=="}], "type": "inlineReview"}, {"oid": "1b11969bf902709c072548e6ac0bfa5d957d468c", "url": "https://github.com/all-of-us/workbench/commit/1b11969bf902709c072548e6ac0bfa5d957d468c", "message": "fix 1 test", "committedDate": "2020-07-15T23:53:29Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjA2OTg1Ng==", "url": "https://github.com/all-of-us/workbench/pull/3785#discussion_r456069856", "bodyText": "not a change, just an observation of the current state", "author": "jmthibault79", "createdAt": "2020-07-16T20:50:27Z", "path": "api/src/test/java/org/pmiops/workbench/api/ProfileControllerTest.java", "diffHunk": "@@ -231,6 +235,9 @@ public void setUp() throws IOException {\n             .country(COUNTRY)\n             .zipCode(ZIP_CODE));\n \n+    // TODO: this needs to be set in createAccountAndDbUserWithAffiliation() instead of here.  Why?", "originalCommit": "81d8c72b51e0f705f8e87229fadfcd8f6645046e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODI4NDM5MA==", "url": "https://github.com/all-of-us/workbench/pull/3785#discussion_r458284390", "bodyText": "do you have a ticket  tracking these issues?", "author": "jaycarlton", "createdAt": "2020-07-21T17:55:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjA2OTg1Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODk1NjQ0Nw==", "url": "https://github.com/all-of-us/workbench/pull/3785#discussion_r458956447", "bodyText": "not currently.  My assumption is that these test classes will change quite a lot, so I plan to revisit then or soon after", "author": "jmthibault79", "createdAt": "2020-07-22T17:20:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjA2OTg1Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjA3MDkxMA==", "url": "https://github.com/all-of-us/workbench/pull/3785#discussion_r456070910", "bodyText": "these two lines help with round-tripping consistency", "author": "jmthibault79", "createdAt": "2020-07-16T20:52:22Z", "path": "api/src/test/java/org/pmiops/workbench/api/ProfileControllerTest.java", "diffHunk": "@@ -1147,14 +1155,333 @@ public void testUpdateProfile_updateDemographicSurvey() {\n         false);\n   }\n \n+  @Test(expected = NotFoundException.class)\n+  public void test_editUserInformation_null_user() {\n+    profileService.editUserInformation(new EditUserInformationRequest());\n+  }\n+\n+  @Test(expected = NotFoundException.class)\n+  public void test_editUserInformation_user_not_found() {\n+    final EditUserInformationRequest request =\n+        new EditUserInformationRequest().username(\"not found\");\n+    profileService.editUserInformation(request);\n+  }\n+\n+  @Test\n+  public void test_editUserInformation_no_change() {\n+    final Profile original = createAccountAndDbUserWithAffiliation();\n+\n+    // valid user but no fields updated\n+    final EditUserInformationRequest request =\n+        new EditUserInformationRequest().username(PRIMARY_EMAIL);\n+    final Profile retrieved = profileService.editUserInformation(request);\n+\n+    // RW-5257 Demo Survey completion time is incorrectly updated\n+    retrieved.setDemographicSurveyCompletionTime(null);\n+    assertThat(retrieved).isEqualTo(original);\n+  }\n+\n+  @Test\n+  public void test_editUserInformation_contactEmail() {\n+    // pre-affiliate with an Institution which will validate the user's existing\n+    // CONTACT_EMAIL and also a new one\n+    final String newContactEmail = \"eric.lander@broadinstitute.org\";\n+\n+    final Institution broadPlus =\n+        new Institution()\n+            .shortName(\"Broad\")\n+            .displayName(\"The Broad Institute\")\n+            .emailAddresses(ImmutableList.of(CONTACT_EMAIL, newContactEmail))\n+            .duaTypeEnum(DuaType.RESTRICTED)\n+            .organizationTypeEnum(OrganizationType.ACADEMIC_RESEARCH_INSTITUTION);\n+    institutionService.createInstitution(broadPlus);\n+\n+    final VerifiedInstitutionalAffiliation affiliation =\n+        new VerifiedInstitutionalAffiliation()\n+            .institutionShortName(broadPlus.getShortName())\n+            .institutionDisplayName(broadPlus.getDisplayName())\n+            .institutionalRoleEnum(InstitutionalRole.PROJECT_PERSONNEL);\n+\n+    final Profile original = createAccountAndDbUserWithAffiliation(affiliation);\n+    assertThat(original.getContactEmail()).isEqualTo(CONTACT_EMAIL);\n+\n+    final EditUserInformationRequest request =\n+        new EditUserInformationRequest().username(PRIMARY_EMAIL).contactEmail(newContactEmail);\n+    final Profile retrieved = profileService.editUserInformation(request);\n+    assertThat(retrieved.getContactEmail()).isEqualTo(newContactEmail);\n+  }\n+\n+  @Test(expected = BadRequestException.class)\n+  public void test_editUserInformation_contactEmail_no_match() {\n+    // the existing Institution for this user only matches the single CONTACT_EMAIL\n+    createAccountAndDbUserWithAffiliation();\n+\n+    final String newContactEmail = \"eric.lander@broadinstitute.org\";\n+    final EditUserInformationRequest request =\n+        new EditUserInformationRequest().username(PRIMARY_EMAIL).contactEmail(newContactEmail);\n+    profileService.editUserInformation(request);\n+  }\n+\n+  @Test\n+  public void test_editUserInformation_newAffiliation() {\n+    final VerifiedInstitutionalAffiliation expectedOriginalAffiliation =\n+        new VerifiedInstitutionalAffiliation()\n+            .institutionShortName(\"Broad\")\n+            .institutionDisplayName(\"The Broad Institute\")\n+            .institutionalRoleEnum(InstitutionalRole.PROJECT_PERSONNEL);\n+    final Profile original = createAccountAndDbUserWithAffiliation();\n+\n+    assertThat(original.getVerifiedInstitutionalAffiliation())\n+        .isEqualTo(expectedOriginalAffiliation);\n+\n+    // define a new affiliation which will match the user's existing CONTACT_EMAIL\n+\n+    final Institution massGeneral =\n+        new Institution()\n+            .shortName(\"MGH123\")\n+            .displayName(\"Massachusetts General Hospital\")\n+            .emailAddresses(ImmutableList.of(CONTACT_EMAIL))\n+            .duaTypeEnum(DuaType.RESTRICTED)\n+            .organizationTypeEnum(OrganizationType.HEALTH_CENTER_NON_PROFIT);\n+    institutionService.createInstitution(massGeneral);\n+\n+    final VerifiedInstitutionalAffiliation newAffiliation =\n+        new VerifiedInstitutionalAffiliation()\n+            .institutionShortName(massGeneral.getShortName())\n+            .institutionDisplayName(massGeneral.getDisplayName())\n+            .institutionalRoleEnum(InstitutionalRole.POST_DOCTORAL);\n+\n+    final EditUserInformationRequest request =\n+        new EditUserInformationRequest()\n+            .username(PRIMARY_EMAIL)\n+            .verifiedInstitutionalAffiliation(newAffiliation);\n+    final Profile retrieved = profileService.editUserInformation(request);\n+    assertThat(retrieved.getVerifiedInstitutionalAffiliation()).isEqualTo(newAffiliation);\n+  }\n+\n+  @Test(expected = BadRequestException.class)\n+  public void test_editUserInformation_newAffiliation_no_match() {\n+    createAccountAndDbUserWithAffiliation();\n+\n+    // define a new affiliation which will not match the user's CONTACT_EMAIL\n+\n+    final Institution massGeneral =\n+        new Institution()\n+            .shortName(\"MGH123\")\n+            .displayName(\"Massachusetts General Hospital\")\n+            .duaTypeEnum(DuaType.MASTER)\n+            .emailDomains(ImmutableList.of(\"mgh.org\", \"massgeneral.hospital\"))\n+            .organizationTypeEnum(OrganizationType.HEALTH_CENTER_NON_PROFIT);\n+    institutionService.createInstitution(massGeneral);\n+\n+    final VerifiedInstitutionalAffiliation newAffiliation =\n+        new VerifiedInstitutionalAffiliation()\n+            .institutionShortName(massGeneral.getShortName())\n+            .institutionDisplayName(massGeneral.getDisplayName())\n+            .institutionalRoleEnum(InstitutionalRole.POST_DOCTORAL);\n+\n+    final EditUserInformationRequest request =\n+        new EditUserInformationRequest()\n+            .username(PRIMARY_EMAIL)\n+            .verifiedInstitutionalAffiliation(newAffiliation);\n+    profileService.editUserInformation(request);\n+  }\n+\n+  @Test\n+  public void test_editUserInformation_contactEmail_newAffiliation_self_match() {\n+    final VerifiedInstitutionalAffiliation expectedOriginalAffiliation =\n+        new VerifiedInstitutionalAffiliation()\n+            .institutionShortName(\"Broad\")\n+            .institutionDisplayName(\"The Broad Institute\")\n+            .institutionalRoleEnum(InstitutionalRole.PROJECT_PERSONNEL);\n+\n+    final Profile original = createAccountAndDbUserWithAffiliation();\n+    assertThat(original.getContactEmail()).isEqualTo(CONTACT_EMAIL);\n+    assertThat(original.getVerifiedInstitutionalAffiliation())\n+        .isEqualTo(expectedOriginalAffiliation);\n+\n+    // update both the contact email and the affiliation, and validate against each other\n+\n+    final String newContactEmail = \"doctor@mgh.org\";\n+\n+    final Institution massGeneral =\n+        new Institution()\n+            .shortName(\"MGH123\")\n+            .displayName(\"Massachusetts General Hospital\")\n+            .duaTypeEnum(DuaType.MASTER)\n+            .emailDomains(ImmutableList.of(\"mgh.org\", \"massgeneral.hospital\"))\n+            .organizationTypeEnum(OrganizationType.HEALTH_CENTER_NON_PROFIT);\n+    institutionService.createInstitution(massGeneral);\n+\n+    final VerifiedInstitutionalAffiliation newAffiliation =\n+        new VerifiedInstitutionalAffiliation()\n+            .institutionShortName(massGeneral.getShortName())\n+            .institutionDisplayName(massGeneral.getDisplayName())\n+            .institutionalRoleEnum(InstitutionalRole.POST_DOCTORAL);\n+\n+    final EditUserInformationRequest request =\n+        new EditUserInformationRequest()\n+            .username(PRIMARY_EMAIL)\n+            .contactEmail(newContactEmail)\n+            .verifiedInstitutionalAffiliation(newAffiliation);\n+    final Profile retrieved = profileService.editUserInformation(request);\n+    assertThat(retrieved.getContactEmail()).isEqualTo(newContactEmail);\n+    assertThat(retrieved.getVerifiedInstitutionalAffiliation()).isEqualTo(newAffiliation);\n+  }\n+\n+  @Test(expected = BadRequestException.class)\n+  public void test_editUserInformation_contactEmail_newAffiliation_no_match() {\n+    final VerifiedInstitutionalAffiliation expectedOriginalAffiliation =\n+        new VerifiedInstitutionalAffiliation()\n+            .institutionShortName(\"Broad\")\n+            .institutionDisplayName(\"The Broad Institute\")\n+            .institutionalRoleEnum(InstitutionalRole.PROJECT_PERSONNEL);\n+\n+    final Profile original = createAccountAndDbUserWithAffiliation();\n+    assertThat(original.getContactEmail()).isEqualTo(CONTACT_EMAIL);\n+    assertThat(original.getVerifiedInstitutionalAffiliation())\n+        .isEqualTo(expectedOriginalAffiliation);\n+\n+    // update both the contact email and the affiliation, and fail to validate against each other\n+\n+    final String newContactEmail = \"notadoctor@hotmail.com\";\n+\n+    final Institution massGeneral =\n+        new Institution()\n+            .shortName(\"MGH123\")\n+            .displayName(\"Massachusetts General Hospital\")\n+            .duaTypeEnum(DuaType.MASTER)\n+            .emailDomains(ImmutableList.of(\"mgh.org\", \"massgeneral.hospital\"))\n+            .organizationTypeEnum(OrganizationType.HEALTH_CENTER_NON_PROFIT);\n+    institutionService.createInstitution(massGeneral);\n+\n+    final VerifiedInstitutionalAffiliation newAffiliation =\n+        new VerifiedInstitutionalAffiliation()\n+            .institutionShortName(massGeneral.getShortName())\n+            .institutionDisplayName(massGeneral.getDisplayName())\n+            .institutionalRoleEnum(InstitutionalRole.POST_DOCTORAL);\n+\n+    final EditUserInformationRequest request =\n+        new EditUserInformationRequest()\n+            .username(PRIMARY_EMAIL)\n+            .contactEmail(newContactEmail)\n+            .verifiedInstitutionalAffiliation(newAffiliation);\n+    profileService.editUserInformation(request);\n+  }\n+\n+  @Test\n+  public void test_editUserInformation_no_bypass_requests() {\n+    final Profile original = createAccountAndDbUserWithAffiliation();\n+\n+    final EditUserInformationRequest request =\n+        new EditUserInformationRequest()\n+            .username(PRIMARY_EMAIL)\n+            .accessBypassRequests(Collections.emptyList());\n+    final Profile retrieved = profileService.editUserInformation(request);\n+\n+    // RW-5257 Demo Survey completion time is incorrectly updated\n+    retrieved.setDemographicSurveyCompletionTime(null);\n+    assertThat(retrieved).isEqualTo(original);\n+  }\n+\n+  @Test\n+  public void test_editUserInformation_bypass_requests() {\n+    final Profile original = createAccountAndDbUserWithAffiliation();\n+\n+    // user has no bypasses at test start\n+    assertThat(original.getDataUseAgreementBypassTime()).isNull();\n+    assertThat(original.getComplianceTrainingBypassTime()).isNull();\n+    assertThat(original.getBetaAccessBypassTime()).isNull();\n+    assertThat(original.getEraCommonsBypassTime()).isNull();\n+    assertThat(original.getTwoFactorAuthBypassTime()).isNull();\n+\n+    final List<AccessBypassRequest> bypasses1 =\n+        ImmutableList.of(\n+            new AccessBypassRequest().moduleName(AccessModule.DATA_USE_AGREEMENT).isBypassed(true),\n+            new AccessBypassRequest().moduleName(AccessModule.COMPLIANCE_TRAINING).isBypassed(true),\n+            // would un-bypass if a bypass had existed\n+            new AccessBypassRequest().moduleName(AccessModule.BETA_ACCESS).isBypassed(false));\n+\n+    final EditUserInformationRequest request1 =\n+        new EditUserInformationRequest().username(PRIMARY_EMAIL).accessBypassRequests(bypasses1);\n+    final Profile retrieved1 = profileService.editUserInformation(request1);\n+\n+    // these two are now bypassed\n+    assertThat(retrieved1.getDataUseAgreementBypassTime()).isNotNull();\n+    assertThat(retrieved1.getComplianceTrainingBypassTime()).isNotNull();\n+    // remains unbypassed because the flag was set to false\n+    assertThat(retrieved1.getBetaAccessBypassTime()).isNull();\n+    // unchanged: unbypassed\n+    assertThat(retrieved1.getEraCommonsBypassTime()).isNull();\n+    assertThat(retrieved1.getTwoFactorAuthBypassTime()).isNull();\n+\n+    final List<AccessBypassRequest> bypasses2 =\n+        ImmutableList.of(\n+            // un-bypass the previously bypassed\n+            new AccessBypassRequest().moduleName(AccessModule.DATA_USE_AGREEMENT).isBypassed(false),\n+            new AccessBypassRequest()\n+                .moduleName(AccessModule.COMPLIANCE_TRAINING)\n+                .isBypassed(false),\n+            // bypass\n+            new AccessBypassRequest().moduleName(AccessModule.ERA_COMMONS).isBypassed(true),\n+            new AccessBypassRequest().moduleName(AccessModule.TWO_FACTOR_AUTH).isBypassed(true));\n+\n+    final EditUserInformationRequest request2 = request1.accessBypassRequests(bypasses2);\n+    final Profile retrieved2 = profileService.editUserInformation(request2);\n+\n+    // these two are now unbypassed\n+    assertThat(retrieved2.getDataUseAgreementBypassTime()).isNull();\n+    assertThat(retrieved2.getComplianceTrainingBypassTime()).isNull();\n+    // remains unbypassed\n+    assertThat(retrieved2.getBetaAccessBypassTime()).isNull();\n+    // the two are now bypassed\n+    assertThat(retrieved2.getEraCommonsBypassTime()).isNotNull();\n+    assertThat(retrieved2.getTwoFactorAuthBypassTime()).isNotNull();\n+  }\n+\n+  // verify that setFreeTierDollarOverride() is called when the quota changes\n+\n+  @Test\n+  public void test_editUserInformation_free_tier_quota() {\n+    createAccountAndDbUserWithAffiliation();\n+\n+    final Double newQuota = 123.4;\n+\n+    final EditUserInformationRequest request =\n+        new EditUserInformationRequest().username(PRIMARY_EMAIL).freeCreditsLimit(newQuota);\n+    profileService.editUserInformation(request);\n+    verify(mockFreeTierBillingService).setFreeTierDollarOverride(dbUser, newQuota);\n+  }\n+\n+  // verify that setFreeTierDollarOverride() is not called when the quota does not change\n+\n+  @Test\n+  public void test_editUserInformation_free_tier_quota_no_change() {\n+    final Profile original = createAccountAndDbUserWithAffiliation();\n+\n+    final EditUserInformationRequest request =\n+        new EditUserInformationRequest()\n+            .username(PRIMARY_EMAIL)\n+            .freeCreditsLimit(original.getFreeTierDollarQuota());\n+    profileService.editUserInformation(request);\n+\n+    verify(mockFreeTierBillingService, never()).setFreeTierDollarOverride(any(), anyDouble());\n+  }\n+\n   private Profile createAccountAndDbUserWithAffiliation(\n       VerifiedInstitutionalAffiliation verifiedAffiliation) {\n     createAccountRequest.getProfile().setVerifiedInstitutionalAffiliation(verifiedAffiliation);\n \n     Profile result = profileController.createAccount(createAccountRequest).getBody();\n+\n+    // initialize the global test dbUser\n     dbUser = userDao.findUserByUsername(PRIMARY_EMAIL);\n+\n+    // TODO: why is this necessary instead of initializing in setUp() ?\n     dbUser.setEmailVerificationStatusEnum(EmailVerificationStatus.SUBSCRIBED);\n-    userDao.save(dbUser);\n+    dbUser = userDao.save(dbUser);", "originalCommit": "81d8c72b51e0f705f8e87229fadfcd8f6645046e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjQ5NDY5Nw==", "url": "https://github.com/all-of-us/workbench/pull/3785#discussion_r456494697", "bodyText": "This was a fun exercise for Baby's First Kotlin, but it might be more appropriately part of User or Profile Auditor", "author": "jmthibault79", "createdAt": "2020-07-17T14:55:08Z", "path": "api/src/main/java/org/pmiops/workbench/actionaudit/auditors/FreeTierAuditor.kt", "diffHunk": "@@ -0,0 +1,5 @@\n+package org.pmiops.workbench.actionaudit.auditors\n+\n+interface FreeTierAuditor {", "originalCommit": "de57249e6b1c350d9fd94e21b2558e04ebe28f8c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODE1OTIxNA==", "url": "https://github.com/all-of-us/workbench/pull/3785#discussion_r458159214", "bodyText": "Nice. Note that it's not necessary to write auditors in Kotlin.\nThe UserServiceAuditor could work well here, since it has the administrator injected already.", "author": "jaycarlton", "createdAt": "2020-07-21T14:51:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjQ5NDY5Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODk1Njc4NQ==", "url": "https://github.com/all-of-us/workbench/pull/3785#discussion_r458956785", "bodyText": "sounds good", "author": "jmthibault79", "createdAt": "2020-07-22T17:20:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjQ5NDY5Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjQ5NTczNQ==", "url": "https://github.com/all-of-us/workbench/pull/3785#discussion_r456495735", "bodyText": "not sure whether this makes sense as a ProfileTargetProperty or elsewhere", "author": "jmthibault79", "createdAt": "2020-07-17T14:56:45Z", "path": "api/src/main/java/org/pmiops/workbench/actionaudit/targetproperties/ProfileTargetProperty.kt", "diffHunk": "@@ -20,5 +20,6 @@ constructor(override val propertyName: String, override val extractor: (Profile)\n     INSTITUTIONAL_AFFILIATIONS(\"institutional_affiliations\",\n             { it.institutionalAffiliations?.joinToString(\", \") }),\n     DEMOGRAPHIC_SURVEY(\"demographic_survey\", { it.demographicSurvey?.toString() }),\n-    ADDRESS(\"address\", { it.address?.toString() });\n+    ADDRESS(\"address\", { it.address?.toString() }),\n+    FREE_TIER_DOLLAR_QUOTA(\"free_tier_dollar_quota\", { it.freeTierDollarQuota?.toString() });", "originalCommit": "de57249e6b1c350d9fd94e21b2558e04ebe28f8c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODE2NTgzNA==", "url": "https://github.com/all-of-us/workbench/pull/3785#discussion_r458165834", "bodyText": "There's also an ACCOUNT target type which could make sense. the important thing is to capture the user ID, administrator ID, etc.", "author": "jaycarlton", "createdAt": "2020-07-21T15:00:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjQ5NTczNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODk1NzYyNA==", "url": "https://github.com/all-of-us/workbench/pull/3785#discussion_r458957624", "bodyText": "ok", "author": "jmthibault79", "createdAt": "2020-07-22T17:21:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjQ5NTczNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjQ5NzE5MQ==", "url": "https://github.com/all-of-us/workbench/pull/3785#discussion_r456497191", "bodyText": "broken out here so it can be called when either the VIA or the email change", "author": "jmthibault79", "createdAt": "2020-07-17T14:59:08Z", "path": "api/src/main/java/org/pmiops/workbench/profile/ProfileService.java", "diffHunk": "@@ -159,6 +160,10 @@ public void validateInstitutionalAffiliation(Profile profile) {\n           \"Institutional role description cannot be empty when institutional role is set to Other\");\n     }\n \n+    validateInstitutionalAffiliationAgainstEmail(profile);\n+  }\n+\n+  private void validateInstitutionalAffiliationAgainstEmail(Profile profile) {", "originalCommit": "de57249e6b1c350d9fd94e21b2558e04ebe28f8c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTA2NjkwNw==", "url": "https://github.com/all-of-us/workbench/pull/3785#discussion_r459066907", "bodyText": "Can we just start calling it Affiliation? I.e. validateEmailInAffiliatedDomain()?", "author": "jaycarlton", "createdAt": "2020-07-22T20:35:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjQ5NzE5MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTA2NzM0NQ==", "url": "https://github.com/all-of-us/workbench/pull/3785#discussion_r459067345", "bodyText": "Also, I try not to throw exceptions in services (especially exceptions intended for clients). Also, below, there's a 'validate' method that returns a boolean and doesn't throw:\n!institutionService.validateAffiliation(dbVerifiedAffiliation, contactEmail)", "author": "jaycarlton", "createdAt": "2020-07-22T20:36:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjQ5NzE5MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTY4NzY2Ng==", "url": "https://github.com/all-of-us/workbench/pull/3785#discussion_r459687666", "bodyText": "We throw all over this Service.  It's useful for me to do so here as well.\nvalidateAffiliation() works for me", "author": "jmthibault79", "createdAt": "2020-07-23T19:46:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjQ5NzE5MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjQ5NzQ0OQ==", "url": "https://github.com/all-of-us/workbench/pull/3785#discussion_r456497449", "bodyText": "I'm not super happy about the boolean flag here - open to ideas", "author": "jmthibault79", "createdAt": "2020-07-17T14:59:36Z", "path": "api/src/main/java/org/pmiops/workbench/profile/ProfileService.java", "diffHunk": "@@ -187,11 +192,28 @@ public void validateInstitutionalAffiliation(Profile profile) {\n    * @param previousProfile\n    */\n   public void updateProfileForUser(DbUser user, Profile updatedProfile, Profile previousProfile) {\n+    updateProfileForUser(user, updatedProfile, previousProfile, false);\n+  }\n+\n+  /**\n+   * Updates a profile for a given user as Admin and persists all information to the database.\n+   *\n+   * @param user\n+   * @param updatedProfile\n+   * @param previousProfile\n+   */\n+  public void adminUpdateProfileForUser(\n+      DbUser user, Profile updatedProfile, Profile previousProfile) {\n+    updateProfileForUser(user, updatedProfile, previousProfile, true);\n+  }\n+\n+  private void updateProfileForUser(\n+      DbUser user, Profile updatedProfile, Profile previousProfile, boolean userIsAdmin) {", "originalCommit": "de57249e6b1c350d9fd94e21b2558e04ebe28f8c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODE3NzQzMQ==", "url": "https://github.com/all-of-us/workbench/pull/3785#discussion_r458177431", "bodyText": "We can put a transient method on DbUser to return isAdministrrator or whatever based on the Authorities enum.", "author": "jaycarlton", "createdAt": "2020-07-21T15:15:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjQ5NzQ0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODk1ODU3MA==", "url": "https://github.com/all-of-us/workbench/pull/3785#discussion_r458958570", "bodyText": "That seems reasonable.  One snag here is that sometimes the user object is \"without authorities\" and I don't understand the implications of that well enough", "author": "jmthibault79", "createdAt": "2020-07-22T17:23:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjQ5NzQ0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTA2ODUwMQ==", "url": "https://github.com/all-of-us/workbench/pull/3785#discussion_r459068501", "bodyText": "Aren't they just lazily fetched the first time you try to grab them?\n  // Authorities (special permissions) are granted using api/project.rb set-authority.\n  @ElementCollection(fetch = FetchType.LAZY)\n  @CollectionTable(name = \"authority\", joinColumns = @JoinColumn(name = \"user_id\"))\n  @Column(name = \"authority\")\n  public Set<Short> getAuthorities() {\n    return authorities;\n  }\n\nThis is getting at my main source of confusion: does the DAO or the Entity drive the train here?", "author": "jaycarlton", "createdAt": "2020-07-22T20:38:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjQ5NzQ0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTY4ODk4MA==", "url": "https://github.com/all-of-us/workbench/pull/3785#discussion_r459688980", "bodyText": "Oh I see, thanks.  This seems much more tractable, then.", "author": "jmthibault79", "createdAt": "2020-07-23T19:49:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjQ5NzQ0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTgwMzYwNw==", "url": "https://github.com/all-of-us/workbench/pull/3785#discussion_r459803607", "bodyText": "This logic is now gated on the new DbUser.hasAuthority()", "author": "jmthibault79", "createdAt": "2020-07-24T00:48:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjQ5NzQ0OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjQ5OTYyMQ==", "url": "https://github.com/all-of-us/workbench/pull/3785#discussion_r456499621", "bodyText": "Split into \"this is a correct Profile\" vs \"user or admin can change this\" for clarity", "author": "jmthibault79", "createdAt": "2020-07-17T15:03:13Z", "path": "api/src/main/java/org/pmiops/workbench/profile/ProfileService.java", "diffHunk": "@@ -381,47 +415,73 @@ private void validateAreaOfResearch(Profile profile) throws BadRequestException\n    * object.\n    *\n    * @param updatedProfile\n-   * @param prevProfile\n+   * @param previousProfile\n    * @throws BadRequestException\n    */\n   @VisibleForTesting\n-  public void validateProfile(@Nonnull Profile updatedProfile, @Nullable Profile prevProfile)\n+  public void validateProfile(\n+      @Nonnull Profile updatedProfile, @Nullable Profile previousProfile, boolean userIsAdmin) {\n+\n+    final boolean isNewProfile = previousProfile == null;\n+    final Diff diff = javers.compare(previousProfile, updatedProfile);\n+\n+    validateProfileForCorrectness(updatedProfile, isNewProfile, diff);", "originalCommit": "de57249e6b1c350d9fd94e21b2558e04ebe28f8c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjUwMTQ4Mw==", "url": "https://github.com/all-of-us/workbench/pull/3785#discussion_r456501483", "bodyText": "using ProfileAuditorTest as a model", "author": "jmthibault79", "createdAt": "2020-07-17T15:06:14Z", "path": "api/src/test/java/org/pmiops/workbench/actionaudit/auditors/FreeTierAuditorTest.kt", "diffHunk": "@@ -0,0 +1,100 @@\n+package org.pmiops.workbench.actionaudit.auditors\n+\n+import com.google.common.truth.Truth.assertThat\n+import com.nhaarman.mockitokotlin2.argumentCaptor\n+import com.nhaarman.mockitokotlin2.mock\n+import com.nhaarman.mockitokotlin2.verify\n+import com.nhaarman.mockitokotlin2.whenever\n+import org.junit.Before\n+import org.junit.Test\n+import org.junit.runner.RunWith\n+import org.pmiops.workbench.actionaudit.ActionAuditEvent\n+import org.pmiops.workbench.actionaudit.ActionAuditService\n+import org.pmiops.workbench.actionaudit.ActionType\n+import org.pmiops.workbench.actionaudit.AgentType\n+import org.pmiops.workbench.actionaudit.TargetType\n+import org.pmiops.workbench.actionaudit.targetproperties.ProfileTargetProperty\n+import org.pmiops.workbench.db.model.DbUser\n+import org.springframework.test.context.junit4.SpringRunner\n+import java.time.Clock\n+import java.time.Instant\n+import javax.inject.Provider\n+\n+@RunWith(SpringRunner::class)\n+class FreeTierAuditorTest {", "originalCommit": "de57249e6b1c350d9fd94e21b2558e04ebe28f8c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODIzODMwNw==", "url": "https://github.com/all-of-us/workbench/pull/3785#discussion_r458238307", "bodyText": "OK. You don't need to use Kotlin unless you want to for these as well, unless you're getting really fancy with generics.", "author": "jaycarlton", "createdAt": "2020-07-21T16:41:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjUwMTQ4Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjUwMjU3MQ==", "url": "https://github.com/all-of-us/workbench/pull/3785#discussion_r456502571", "bodyText": "Because FreeTierBillingService now has a FreeTierAuditor dependency, this class needs to @Import it to run.  Instead, I took the opportunity to change this from a sorta-mock to a proper mock.", "author": "jmthibault79", "createdAt": "2020-07-17T15:08:00Z", "path": "api/src/test/java/org/pmiops/workbench/api/WorkspacesControllerTest.java", "diffHunk": "@@ -260,6 +260,8 @@\n   @Autowired private CohortAnnotationDefinitionController cohortAnnotationDefinitionController;\n   @Autowired private WorkspacesController workspacesController;\n \n+  @MockBean FreeTierBillingService mockFreeTierBillingService;", "originalCommit": "de57249e6b1c350d9fd94e21b2558e04ebe28f8c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "f23262a824b266cf9d3ae5771a3e63bb61d2cbe7", "url": "https://github.com/all-of-us/workbench/commit/f23262a824b266cf9d3ae5771a3e63bb61d2cbe7", "message": "rename", "committedDate": "2020-07-17T15:16:49Z", "type": "forcePushed"}, {"oid": "37fa695763dc81a2e344a73a477fd047b8ca0952", "url": "https://github.com/all-of-us/workbench/commit/37fa695763dc81a2e344a73a477fd047b8ca0952", "message": "lint", "committedDate": "2020-07-21T14:29:18Z", "type": "forcePushed"}, {"oid": "ff3b03c67c15c4d98328542add0bdf8b5e22a6aa", "url": "https://github.com/all-of-us/workbench/commit/ff3b03c67c15c4d98328542add0bdf8b5e22a6aa", "message": "FreeTierAuditor and test fixes\n\nadd auditor checks to FreeTierBillingServiceTest\n\nUse a @MockBean for FreeTierBillingService in WorkspacesControllerTest\n\nFreeTierAuditorTest", "committedDate": "2020-07-21T14:32:52Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODE2MzQ2Nw==", "url": "https://github.com/all-of-us/workbench/pull/3785#discussion_r458163467", "bodyText": "With this new one, BYPASS might be appropriate for the action type, and the target would be ACCOUNT, with a property type like FREE_TIER_SPEND_LIMIT. That way you can query for everything anyone has bypassed for a particular user (or any actions on the free tier limit).\nDETECT_HIGH_EGRESS_EVENT is the red-headed stepchild here, because it merges an action (detection) with a target (egress threshold). But it didn't have a clear enough mapping to a target at the time, or a generic notion of EGRESS_SYSTEM - DETECT - EVENT. Might be a good thing to change if we get around to consolidating those events somehow (as they currently fire once per minute).", "author": "jaycarlton", "createdAt": "2020-07-21T14:57:17Z", "path": "api/src/main/java/org/pmiops/workbench/actionaudit/ActionType.kt", "diffHunk": "@@ -11,5 +11,6 @@ enum class ActionType {\n     DUPLICATE_TO,\n     COLLABORATE,\n     DELETE,\n-    DETECT_HIGH_EGRESS_EVENT\n+    DETECT_HIGH_EGRESS_EVENT,\n+    FREE_TIER_DOLLAR_OVERRIDE", "originalCommit": "ff3b03c67c15c4d98328542add0bdf8b5e22a6aa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODk2MjYyMA==", "url": "https://github.com/all-of-us/workbench/pull/3785#discussion_r458962620", "bodyText": "I don't like \"bypass\" here because we use that term exclusively to refer to Access Modules.  OVERRIDE_DEFAULT of the FREE_TIER_SPEND_LIMIT, maybe.  Account fits too.  I'll try something along those lines.", "author": "jmthibault79", "createdAt": "2020-07-22T17:30:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODE2MzQ2Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTA2NTEzNQ==", "url": "https://github.com/all-of-us/workbench/pull/3785#discussion_r459065135", "bodyText": "Action type names should not have targets in them. You could just reuse EDIT. BYPASS to me works for any kind of limit or other blocker that the administrator is removing, and I could see it being helpful to query all such changes together.", "author": "jaycarlton", "createdAt": "2020-07-22T20:31:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODE2MzQ2Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTY3MTAwOQ==", "url": "https://github.com/all-of-us/workbench/pull/3785#discussion_r459671009", "bodyText": "edit works for me", "author": "jmthibault79", "createdAt": "2020-07-23T19:14:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODE2MzQ2Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODE2NDM4Mg==", "url": "https://github.com/all-of-us/workbench/pull/3785#discussion_r458164382", "bodyText": "please name the first argument targetUserId, as the provided user is the administrator.", "author": "jaycarlton", "createdAt": "2020-07-21T14:58:30Z", "path": "api/src/main/java/org/pmiops/workbench/actionaudit/auditors/FreeTierAuditorImpl.kt", "diffHunk": "@@ -0,0 +1,38 @@\n+package org.pmiops.workbench.actionaudit.auditors\n+\n+import org.pmiops.workbench.actionaudit.ActionAuditEvent\n+import org.pmiops.workbench.actionaudit.ActionAuditService\n+import org.pmiops.workbench.actionaudit.ActionType\n+import org.pmiops.workbench.actionaudit.AgentType\n+import org.pmiops.workbench.actionaudit.TargetType\n+import org.pmiops.workbench.actionaudit.targetproperties.ProfileTargetProperty\n+import org.pmiops.workbench.db.model.DbUser\n+import org.springframework.beans.factory.annotation.Autowired\n+import org.springframework.beans.factory.annotation.Qualifier\n+import org.springframework.stereotype.Service\n+import java.time.Clock\n+import javax.inject.Provider\n+\n+@Service\n+class FreeTierAuditorImpl @Autowired\n+constructor(\n+    private val userProvider: Provider<DbUser>,\n+    private val actionAuditService: ActionAuditService,\n+    private val clock: Clock,\n+    @Qualifier(\"ACTION_ID\") private val actionIdProvider: Provider<String>\n+) : FreeTierAuditor {\n+    override fun fireFreeTierDollarQuotaAction(userId: Long, previousDollarQuota: Double?, newDollarQuota: Double?) {", "originalCommit": "ff3b03c67c15c4d98328542add0bdf8b5e22a6aa", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODE3MjQyNg==", "url": "https://github.com/all-of-us/workbench/pull/3785#discussion_r458172426", "bodyText": "Aside: Is this slated to move to UserAdminService or similar?", "author": "jaycarlton", "createdAt": "2020-07-21T15:09:08Z", "path": "api/src/main/java/org/pmiops/workbench/api/ProfileController.java", "diffHunk": "@@ -579,6 +580,12 @@ private boolean userHasEverLoggedIn(\n     return ResponseEntity.ok(new EmptyResponse());\n   }\n \n+  @Override\n+  @AuthorityRequired({Authority.ACCESS_CONTROL_ADMIN})\n+  public ResponseEntity<Profile> editUserInformation(EditUserInformationRequest request) {\n+    return ResponseEntity.ok(profileService.editUserInformation(request));", "originalCommit": "ff3b03c67c15c4d98328542add0bdf8b5e22a6aa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODk2NjA4NA==", "url": "https://github.com/all-of-us/workbench/pull/3785#discussion_r458966084", "bodyText": "I'm undecided on whether to move ACCESS_CONTROL_ADMIN endpoints like these to a new FooAdminController/Service.  Certainly this will share the fate of others like it, whatever we decide on.  Before then, these will get pushed down to ProfileService/Impl like the others.", "author": "jmthibault79", "createdAt": "2020-07-22T17:35:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODE3MjQyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTA2MjQ2MQ==", "url": "https://github.com/all-of-us/workbench/pull/3785#discussion_r459062461", "bodyText": "I prefer a separate UserAdminController, leaving the profile stuff to just user-editable fields. Otherwise it's going to be too easy to accidentally give non-administrators access via some random codepath. I've already got changes to do that on one of my branches.", "author": "jaycarlton", "createdAt": "2020-07-22T20:26:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODE3MjQyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTA2NTY0MQ==", "url": "https://github.com/all-of-us/workbench/pull/3785#discussion_r459065641", "bodyText": "I'm a bit concerned that \"user information\" is not a well-scoped abstraction. What isn't user information? How about updateAccountAdminProperties() or something?", "author": "jaycarlton", "createdAt": "2020-07-22T20:32:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODE3MjQyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDEyODc4Nw==", "url": "https://github.com/all-of-us/workbench/pull/3785#discussion_r460128787", "bodyText": "\"User Information\" comes from the UI control.  I agree that it's vague and should be changed.  Something like AdminAccountProperties, yeah.  Let's see how that looks.", "author": "jmthibault79", "createdAt": "2020-07-24T15:33:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODE3MjQyNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODE4ODgzMw==", "url": "https://github.com/all-of-us/workbench/pull/3785#discussion_r458188833", "bodyText": "nit: check .size() > 0 so you don't have to use ! on the left and isEmpty() on the right.\nNot sure why we'd want to return a boolean and throw away the diffs though.", "author": "jaycarlton", "createdAt": "2020-07-21T15:30:49Z", "path": "api/src/main/java/org/pmiops/workbench/profile/ProfileService.java", "diffHunk": "@@ -370,6 +393,17 @@ private void validateAreaOfResearch(Profile profile) throws BadRequestException\n                 && ((PropertyChange) change).getPropertyNameWithPath().startsWith(pathPrefix));\n   }\n \n+  /**\n+   * Has this field changed?\n+   *\n+   * @param diff a Diff between two profiles\n+   * @param field which field to check\n+   * @return true if there are difference between the Profiles\n+   */\n+  private boolean fieldChanged(Diff diff, String field) {\n+    return !getChangesWithPrefix(diff, field).isEmpty();", "originalCommit": "ff3b03c67c15c4d98328542add0bdf8b5e22a6aa", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODE5MDMxNA==", "url": "https://github.com/all-of-us/workbench/pull/3785#discussion_r458190314", "bodyText": "Yeah, the validate method should not assume the user is an admin just based on some other function's opinion. We can use the user provider-provided user's authorities to check the required ones. (Note that \"admin\" isn't a single concept in the backend today as I understand it. It's just whoever has the authorities.)", "author": "jaycarlton", "createdAt": "2020-07-21T15:32:43Z", "path": "api/src/main/java/org/pmiops/workbench/profile/ProfileService.java", "diffHunk": "@@ -381,47 +415,73 @@ private void validateAreaOfResearch(Profile profile) throws BadRequestException\n    * object.\n    *\n    * @param updatedProfile\n-   * @param prevProfile\n+   * @param previousProfile\n    * @throws BadRequestException\n    */\n   @VisibleForTesting\n-  public void validateProfile(@Nonnull Profile updatedProfile, @Nullable Profile prevProfile)\n+  public void validateProfile(\n+      @Nonnull Profile updatedProfile, @Nullable Profile previousProfile, boolean userIsAdmin) {", "originalCommit": "ff3b03c67c15c4d98328542add0bdf8b5e22a6aa", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODE5Mjc2Mg==", "url": "https://github.com/all-of-us/workbench/pull/3785#discussion_r458192762", "bodyText": "Have you checked the API spec to make sure this is marked read-only? Might not hurt to verify the others as well.", "author": "jaycarlton", "createdAt": "2020-07-21T15:35:50Z", "path": "api/src/main/java/org/pmiops/workbench/profile/ProfileService.java", "diffHunk": "@@ -381,47 +415,73 @@ private void validateAreaOfResearch(Profile profile) throws BadRequestException\n    * object.\n    *\n    * @param updatedProfile\n-   * @param prevProfile\n+   * @param previousProfile\n    * @throws BadRequestException\n    */\n   @VisibleForTesting\n-  public void validateProfile(@Nonnull Profile updatedProfile, @Nullable Profile prevProfile)\n+  public void validateProfile(\n+      @Nonnull Profile updatedProfile, @Nullable Profile previousProfile, boolean userIsAdmin) {\n+\n+    final boolean isNewProfile = previousProfile == null;\n+    final Diff diff = javers.compare(previousProfile, updatedProfile);\n+\n+    validateProfileForCorrectness(updatedProfile, isNewProfile, diff);\n+\n+    if (userIsAdmin) {\n+      validateChangesAllowedByAdmin(diff);\n+    } else {\n+      validateChangesAllowedByUser(diff);\n+    }\n+  }\n+\n+  private void validateProfileForCorrectness(Profile profile, boolean isNewProfile, Diff diff)\n       throws BadRequestException {\n-    boolean isNewObject = prevProfile == null;\n-    Diff diff = javers.compare(prevProfile, updatedProfile);\n+    if (isNewProfile || fieldChanged(diff, \"username\")) {\n+      validateUsername(profile);\n+    }\n+    if (isNewProfile || fieldChanged(diff, \"contactEmail\")) {\n+      validateContactEmail(profile);\n \n-    if (!getChangesWithPrefix(diff, \"username\").isEmpty() || isNewObject) {\n-      validateUsername(updatedProfile);\n+      // only validate if the new profile has an affiliation - some older users do not\n+      if (profile.getVerifiedInstitutionalAffiliation() != null) {\n+        validateInstitutionalAffiliationAgainstEmail(profile);\n+      }\n     }\n-    if (!getChangesWithPrefix(diff, \"contactEmail\").isEmpty() || isNewObject) {\n-      validateContactEmail(updatedProfile);\n+    if (isNewProfile || fieldChanged(diff, \"givenName\")) {\n+      validateGivenName(profile);\n     }\n-    if (!getChangesWithPrefix(diff, \"givenName\").isEmpty() || isNewObject) {\n-      validateGivenName(updatedProfile);\n+    if (isNewProfile || fieldChanged(diff, \"familyName\")) {\n+      validateFamilyName(profile);\n     }\n-    if (!getChangesWithPrefix(diff, \"familyName\").isEmpty() || isNewObject) {\n-      validateFamilyName(updatedProfile);\n+    if (isNewProfile || fieldChanged(diff, \"address\")) {\n+      validateAddress(profile);\n     }\n-    if (!getChangesWithPrefix(diff, \"address\").isEmpty() || isNewObject) {\n-      validateAddress(updatedProfile);\n+    if (isNewProfile || fieldChanged(diff, \"areaOfResearch\")) {\n+      validateAreaOfResearch(profile);\n     }\n-    if (!getChangesWithPrefix(diff, \"areaOfResearch\").isEmpty() || isNewObject) {\n-      validateAreaOfResearch(updatedProfile);\n+    if (isNewProfile || fieldChanged(diff, \"verifiedInstitutionalAffiliation\")) {\n+      validateInstitutionalAffiliation(profile);\n+    }\n+  }\n+\n+  private void validateChangesAllowedByUser(Diff diff) {\n+    if (fieldChanged(diff, \"username\")) {\n+      // See RW-1488.\n+      throw new BadRequestException(\"Changing username is not supported\");\n     }\n-    if (!getChangesWithPrefix(diff, \"verifiedInstitutionalAffiliation\").isEmpty() || isNewObject) {\n-      validateInstitutionalAffiliation(updatedProfile);\n+    if (fieldChanged(diff, \"contactEmail\")) {\n+      // See RW-1488.\n+      throw new BadRequestException(\"Changing contact email is not currently supported\");\n     }\n+    if (fieldChanged(diff, \"verifiedInstitutionalAffiliation\")) {\n+      throw new BadRequestException(\"Changing Verified Institutional Affiliation is not supported\");\n+    }\n+  }\n \n-    if (!isNewObject) {\n-      // We disallow changes in certain fields.\n-      if (!getChangesWithPrefix(diff, \"username\").isEmpty()) {\n-        // See RW-1488.\n-        throw new BadRequestException(\"Changing username is not supported\");\n-      }\n-      if (!getChangesWithPrefix(diff, \"contactEmail\").isEmpty()) {\n-        // See RW-1488.\n-        throw new BadRequestException(\"Changing contact email is not currently supported\");\n-      }\n+  private void validateChangesAllowedByAdmin(Diff diff) {\n+    if (fieldChanged(diff, \"username\")) {", "originalCommit": "ff3b03c67c15c4d98328542add0bdf8b5e22a6aa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODk3NDUzMA==", "url": "https://github.com/all-of-us/workbench/pull/3785#discussion_r458974530", "bodyText": "could you clarify?", "author": "jmthibault79", "createdAt": "2020-07-22T17:49:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODE5Mjc2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTA3NDI2MA==", "url": "https://github.com/all-of-us/workbench/pull/3785#discussion_r459074260", "bodyText": "In the Swagger I mean. It's actually marked required even though we can't change it  \ud83d\ude22 .\n  Profile:\n    type: object\n    required:\n    - username\n    - dataAccessLevel", "author": "jaycarlton", "createdAt": "2020-07-22T20:48:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODE5Mjc2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDE0NTA0OA==", "url": "https://github.com/all-of-us/workbench/pull/3785#discussion_r460145048", "bodyText": "Looks like we don't use readOnly properties at all.", "author": "jmthibault79", "createdAt": "2020-07-24T16:01:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODE5Mjc2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDg5NTQ1NA==", "url": "https://github.com/all-of-us/workbench/pull/3785#discussion_r460895454", "bodyText": "I don't believe that's by policy, it's just that we haven't yet. I have it on a branch someplace, but that didn't go in for other reasons.", "author": "jaycarlton", "createdAt": "2020-07-27T13:38:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODE5Mjc2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTk3NjYzMg==", "url": "https://github.com/all-of-us/workbench/pull/3785#discussion_r461976632", "bodyText": "I tried this out and it didn't seem do anything.  It didn't remove the generated Profile.setUsername() or even prevent us from calling it - which we do, by the way: ProfileService.java:261\nIt also doesn't seem to hurt anything, so we could add it to mark our intention.", "author": "jmthibault79", "createdAt": "2020-07-29T00:57:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODE5Mjc2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjM1OTU4OQ==", "url": "https://github.com/all-of-us/workbench/pull/3785#discussion_r462359589", "bodyText": "I want to say something gets checked in the generated controller code. You'd have to try to set it to see what happens.  I dont' recall if it sets the readonly attribute in the client class or not.", "author": "jaycarlton", "createdAt": "2020-07-29T14:49:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODE5Mjc2Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODE5NTk1OQ==", "url": "https://github.com/all-of-us/workbench/pull/3785#discussion_r458195959", "bodyText": "I'd make a Diffs utility class and add this as a public static <T> Diff fromNewObject(T object).", "author": "jaycarlton", "createdAt": "2020-07-21T15:39:57Z", "path": "api/src/main/java/org/pmiops/workbench/profile/ProfileService.java", "diffHunk": "@@ -432,10 +492,48 @@ public void validateProfile(@Nonnull Profile updatedProfile, @Nullable Profile p\n    * @throws BadRequestException\n    */\n   public void validateNewProfile(Profile profile) throws BadRequestException {\n-    validateProfile(profile, null);\n+    // unused, but this is the correct syntax for a \"Diff\" of a new object\n+    final Diff dummyDiff = javers.compare(null, profile);", "originalCommit": "ff3b03c67c15c4d98328542add0bdf8b5e22a6aa", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODIyNTMwNg==", "url": "https://github.com/all-of-us/workbench/pull/3785#discussion_r458225306", "bodyText": "I thought the Diff object would have already done this comparison.", "author": "jaycarlton", "createdAt": "2020-07-21T16:21:26Z", "path": "api/src/main/java/org/pmiops/workbench/profile/ProfileService.java", "diffHunk": "@@ -432,10 +492,48 @@ public void validateProfile(@Nonnull Profile updatedProfile, @Nullable Profile p\n    * @throws BadRequestException\n    */\n   public void validateNewProfile(Profile profile) throws BadRequestException {\n-    validateProfile(profile, null);\n+    // unused, but this is the correct syntax for a \"Diff\" of a new object\n+    final Diff dummyDiff = javers.compare(null, profile);\n+    validateProfileForCorrectness(profile, true, dummyDiff);\n   }\n \n   public List<Profile> listAllProfiles() {\n     return userService.getAllUsers().stream().map(this::getProfile).collect(Collectors.toList());\n   }\n+\n+  /**\n+   * Updates the user metadata referenced by the fields of EditUserInformationRequest.\n+   *\n+   * @param request the fields to update. Fields left null here will not be updated. Contact Email\n+   *     and Verified Institutional Affiliation updates will trigger a check for affiliation\n+   *     validation.\n+   * @return the Profile of the user, after updates\n+   */\n+  public Profile editUserInformation(EditUserInformationRequest request) {\n+    final DbUser dbUser = userService.getByUsernameOrThrow(request.getUsername());\n+    final Profile originalProfile = getProfile(dbUser);\n+\n+    Optional.ofNullable(request.getFreeCreditsLimit())\n+        // only set override if it's different\n+        .filter(newLimit -> !newLimit.equals(originalProfile.getFreeTierDollarQuota()))", "originalCommit": "ff3b03c67c15c4d98328542add0bdf8b5e22a6aa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODk3NzE2MA==", "url": "https://github.com/all-of-us/workbench/pull/3785#discussion_r458977160", "bodyText": "this is a different code path than the diffs", "author": "jmthibault79", "createdAt": "2020-07-22T17:53:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODIyNTMwNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODk4MDUwMQ==", "url": "https://github.com/all-of-us/workbench/pull/3785#discussion_r458980501", "bodyText": "There is also a subtlety here which is a bit complicated and would probably benefit from a longer comment.  I'll work on that.", "author": "jmthibault79", "createdAt": "2020-07-22T17:59:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODIyNTMwNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTA3NTQ5OQ==", "url": "https://github.com/all-of-us/workbench/pull/3785#discussion_r459075499", "bodyText": "Can you compare with a tolerance (like $0.01) so that we're not affected by roundoff problems?", "author": "jaycarlton", "createdAt": "2020-07-22T20:51:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODIyNTMwNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDMwNTcyMg==", "url": "https://github.com/all-of-us/workbench/pull/3785#discussion_r460305722", "bodyText": "OK.  The comment I am referring to is now the Javadoc for the method FreeTierBillingService.maybeSetDollarLimitOverride()\nand it does now check vs a tolerance", "author": "jmthibault79", "createdAt": "2020-07-24T21:58:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODIyNTMwNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODIyODc2Mw==", "url": "https://github.com/all-of-us/workbench/pull/3785#discussion_r458228763", "bodyText": "If codegen is initializing your list variables to null, that's a bummer. It looks like it's inconsistent somehow on that.", "author": "jaycarlton", "createdAt": "2020-07-21T16:26:39Z", "path": "api/src/main/java/org/pmiops/workbench/profile/ProfileService.java", "diffHunk": "@@ -432,10 +492,48 @@ public void validateProfile(@Nonnull Profile updatedProfile, @Nullable Profile p\n    * @throws BadRequestException\n    */\n   public void validateNewProfile(Profile profile) throws BadRequestException {\n-    validateProfile(profile, null);\n+    // unused, but this is the correct syntax for a \"Diff\" of a new object\n+    final Diff dummyDiff = javers.compare(null, profile);\n+    validateProfileForCorrectness(profile, true, dummyDiff);\n   }\n \n   public List<Profile> listAllProfiles() {\n     return userService.getAllUsers().stream().map(this::getProfile).collect(Collectors.toList());\n   }\n+\n+  /**\n+   * Updates the user metadata referenced by the fields of EditUserInformationRequest.\n+   *\n+   * @param request the fields to update. Fields left null here will not be updated. Contact Email\n+   *     and Verified Institutional Affiliation updates will trigger a check for affiliation\n+   *     validation.\n+   * @return the Profile of the user, after updates\n+   */\n+  public Profile editUserInformation(EditUserInformationRequest request) {\n+    final DbUser dbUser = userService.getByUsernameOrThrow(request.getUsername());\n+    final Profile originalProfile = getProfile(dbUser);\n+\n+    Optional.ofNullable(request.getFreeCreditsLimit())\n+        // only set override if it's different\n+        .filter(newLimit -> !newLimit.equals(originalProfile.getFreeTierDollarQuota()))\n+        .ifPresent(\n+            freeCreditsLimit ->\n+                freeTierBillingService.setFreeTierDollarOverride(dbUser, freeCreditsLimit));\n+\n+    Optional.ofNullable(request.getAccessBypassRequests())", "originalCommit": "ff3b03c67c15c4d98328542add0bdf8b5e22a6aa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTA1NjQ5Ng==", "url": "https://github.com/all-of-us/workbench/pull/3785#discussion_r459056496", "bodyText": "it's not a required field in the JSON.  I can make it one, since an empty list has the same semantics as no list here.", "author": "jmthibault79", "createdAt": "2020-07-22T20:15:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODIyODc2Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTA3NjE3Ng==", "url": "https://github.com/all-of-us/workbench/pull/3785#discussion_r459076176", "bodyText": "\ud83d\udca5  null should be deprecated along with if.", "author": "jaycarlton", "createdAt": "2020-07-22T20:52:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODIyODc2Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODIyOTQ0NA==", "url": "https://github.com/all-of-us/workbench/pull/3785#discussion_r458229444", "bodyText": "[aside] In Java 9 this gets prettier with Optional.stream(). https://www.geeksforgeeks.org/optional-stream-method-in-java-with-examples/", "author": "jaycarlton", "createdAt": "2020-07-21T16:27:44Z", "path": "api/src/main/java/org/pmiops/workbench/profile/ProfileService.java", "diffHunk": "@@ -432,10 +492,48 @@ public void validateProfile(@Nonnull Profile updatedProfile, @Nullable Profile p\n    * @throws BadRequestException\n    */\n   public void validateNewProfile(Profile profile) throws BadRequestException {\n-    validateProfile(profile, null);\n+    // unused, but this is the correct syntax for a \"Diff\" of a new object\n+    final Diff dummyDiff = javers.compare(null, profile);\n+    validateProfileForCorrectness(profile, true, dummyDiff);\n   }\n \n   public List<Profile> listAllProfiles() {\n     return userService.getAllUsers().stream().map(this::getProfile).collect(Collectors.toList());\n   }\n+\n+  /**\n+   * Updates the user metadata referenced by the fields of EditUserInformationRequest.\n+   *\n+   * @param request the fields to update. Fields left null here will not be updated. Contact Email\n+   *     and Verified Institutional Affiliation updates will trigger a check for affiliation\n+   *     validation.\n+   * @return the Profile of the user, after updates\n+   */\n+  public Profile editUserInformation(EditUserInformationRequest request) {\n+    final DbUser dbUser = userService.getByUsernameOrThrow(request.getUsername());\n+    final Profile originalProfile = getProfile(dbUser);\n+\n+    Optional.ofNullable(request.getFreeCreditsLimit())\n+        // only set override if it's different\n+        .filter(newLimit -> !newLimit.equals(originalProfile.getFreeTierDollarQuota()))\n+        .ifPresent(\n+            freeCreditsLimit ->\n+                freeTierBillingService.setFreeTierDollarOverride(dbUser, freeCreditsLimit));\n+\n+    Optional.ofNullable(request.getAccessBypassRequests())\n+        .ifPresent(", "originalCommit": "ff3b03c67c15c4d98328542add0bdf8b5e22a6aa", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODIzMDYyNQ==", "url": "https://github.com/all-of-us/workbench/pull/3785#discussion_r458230625", "bodyText": "Consider guarding against empty strings as well, e.g. with Strings.isNullOrEmpty().", "author": "jaycarlton", "createdAt": "2020-07-21T16:29:37Z", "path": "api/src/main/java/org/pmiops/workbench/profile/ProfileService.java", "diffHunk": "@@ -432,10 +492,48 @@ public void validateProfile(@Nonnull Profile updatedProfile, @Nullable Profile p\n    * @throws BadRequestException\n    */\n   public void validateNewProfile(Profile profile) throws BadRequestException {\n-    validateProfile(profile, null);\n+    // unused, but this is the correct syntax for a \"Diff\" of a new object\n+    final Diff dummyDiff = javers.compare(null, profile);\n+    validateProfileForCorrectness(profile, true, dummyDiff);\n   }\n \n   public List<Profile> listAllProfiles() {\n     return userService.getAllUsers().stream().map(this::getProfile).collect(Collectors.toList());\n   }\n+\n+  /**\n+   * Updates the user metadata referenced by the fields of EditUserInformationRequest.\n+   *\n+   * @param request the fields to update. Fields left null here will not be updated. Contact Email\n+   *     and Verified Institutional Affiliation updates will trigger a check for affiliation\n+   *     validation.\n+   * @return the Profile of the user, after updates\n+   */\n+  public Profile editUserInformation(EditUserInformationRequest request) {\n+    final DbUser dbUser = userService.getByUsernameOrThrow(request.getUsername());\n+    final Profile originalProfile = getProfile(dbUser);\n+\n+    Optional.ofNullable(request.getFreeCreditsLimit())\n+        // only set override if it's different\n+        .filter(newLimit -> !newLimit.equals(originalProfile.getFreeTierDollarQuota()))\n+        .ifPresent(\n+            freeCreditsLimit ->\n+                freeTierBillingService.setFreeTierDollarOverride(dbUser, freeCreditsLimit));\n+\n+    Optional.ofNullable(request.getAccessBypassRequests())\n+        .ifPresent(\n+            requests ->\n+                requests.forEach(\n+                    bypass -> userService.updateBypassTime(dbUser.getUserId(), bypass)));\n+\n+    // refetch from the DB\n+    Profile updatedProfile = getProfile(userService.getByUsernameOrThrow(request.getUsername()));\n+    Optional.ofNullable(request.getContactEmail()).ifPresent(updatedProfile::setContactEmail);", "originalCommit": "ff3b03c67c15c4d98328542add0bdf8b5e22a6aa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTA1OTY4NQ==", "url": "https://github.com/all-of-us/workbench/pull/3785#discussion_r459059685", "bodyText": "this will get caught by validateContactEmail()", "author": "jmthibault79", "createdAt": "2020-07-22T20:21:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODIzMDYyNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODIzMTcwMA==", "url": "https://github.com/all-of-us/workbench/pull/3785#discussion_r458231700", "bodyText": "[aside] Would it be clearer to call this UpdateAccount? In other words, move slowly toward a model an account is the admin-owned thing, and a profile is the user-owned portion (at least in the api).", "author": "jaycarlton", "createdAt": "2020-07-21T16:31:15Z", "path": "api/src/main/resources/workbench-api.yaml", "diffHunk": "@@ -7787,3 +7814,29 @@ definitions:\n           timestamp (epoch millis) at workspace creation\n         type: integer\n         format: int64\n+  EditUserInformationRequest:", "originalCommit": "ff3b03c67c15c4d98328542add0bdf8b5e22a6aa", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODIzMzA1Nw==", "url": "https://github.com/all-of-us/workbench/pull/3785#discussion_r458233057", "bodyText": "I suspect there could be pushback to using a different request type here. I've gotten feedback before that we prefer to use the same payload object for create and update, though I understand the rationale. I believe @calbach had an opinion here, at least in the case of workspaces.\nBut if we have different logical resources for account and profile (for example), then there's more granularity.", "author": "jaycarlton", "createdAt": "2020-07-21T16:33:24Z", "path": "api/src/main/resources/workbench-api.yaml", "diffHunk": "@@ -7787,3 +7814,29 @@ definitions:\n           timestamp (epoch millis) at workspace creation\n         type: integer\n         format: int64\n+  EditUserInformationRequest:", "originalCommit": "ff3b03c67c15c4d98328542add0bdf8b5e22a6aa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDE0OTY1OA==", "url": "https://github.com/all-of-us/workbench/pull/3785#discussion_r460149658", "bodyText": "Profile would be overkill here, and much more difficult to get right.  (That was the main difficulty of a previous iteration of this work.)  This fits the semantics of what we're trying to do here.  I have updated the name to reference the Account concept, per other comments.", "author": "jmthibault79", "createdAt": "2020-07-24T16:09:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODIzMzA1Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODIzNDY0MA==", "url": "https://github.com/all-of-us/workbench/pull/3785#discussion_r458234640", "bodyText": "If these two fields need to be set together, I'd define a little object with just these two fields that gets updated atomically. Call it UserDomainInfo or something. That way the error handling is more transactional, in that you fail to apply either unless both agree.\nYou could get fancier by having flags to indicate no change vs delete or just require  both to  match exactly.", "author": "jaycarlton", "createdAt": "2020-07-21T16:35:52Z", "path": "api/src/main/resources/workbench-api.yaml", "diffHunk": "@@ -7787,3 +7814,29 @@ definitions:\n           timestamp (epoch millis) at workspace creation\n         type: integer\n         format: int64\n+  EditUserInformationRequest:\n+    description: >\n+      A group of changes an admin can make to a user in the Edit Information card of the individual-user admin page.\n+      Updates to the contact email or the institutional affiliation will be rejected if they do not validate.\n+    type: object\n+    required:\n+      - username\n+    properties:\n+      username:\n+        description: The full system-assigned ID of a user, including email domain\n+        type: string\n+      freeCreditsLimit:\n+        description: When set, overrides the default free credits dollar limit for this user.\n+        type: number\n+        format: double\n+      contactEmail:\n+        description: When set, replaces the user's contact email.  Must validate against the user's Institutional Affiliation, if one exists.", "originalCommit": "ff3b03c67c15c4d98328542add0bdf8b5e22a6aa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTA2NDYxMg==", "url": "https://github.com/all-of-us/workbench/pull/3785#discussion_r459064612", "bodyText": "They don't need to be set together - either can validate against the previous-profile value if the other is unset here", "author": "jmthibault79", "createdAt": "2020-07-22T20:30:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODIzNDY0MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDg5NjMzNQ==", "url": "https://github.com/all-of-us/workbench/pull/3785#discussion_r460896335", "bodyText": "But now there's an order dependence: you can't change one without changing the other if there's a new domain and a new institution, right?\nAlso, I'm really surprised no one has asked for separate contact emails and institutional emails yet.", "author": "jaycarlton", "createdAt": "2020-07-27T13:39:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODIzNDY0MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTE5OTg2Nw==", "url": "https://github.com/all-of-us/workbench/pull/3785#discussion_r461199867", "bodyText": "Not necessarily - a contact email could potentially be valid for more than one institution.", "author": "jmthibault79", "createdAt": "2020-07-27T22:11:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODIzNDY0MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjM5MDA2Mg==", "url": "https://github.com/all-of-us/workbench/pull/3785#discussion_r462390062", "bodyText": "No I mean my verified institutional email is brassrat@mit.edu but I want transactional email to go to prince.adam@gmail.com. As in I only use the institutional email for official purposes (kind of like how I have a broadinstitute email that I never check).", "author": "jaycarlton", "createdAt": "2020-07-29T15:30:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODIzNDY0MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODIzNzc2MQ==", "url": "https://github.com/all-of-us/workbench/pull/3785#discussion_r458237761", "bodyText": "I looked at AccessBypassRequest, and one thing to verify is that it handles the null case correctly. I.e. we start out with null bypass times in the current model, and we can update it here to true or false, but we can never remove any trace of it ever having been set. I guess that's fine if those are the intended rules. In particular, the isBypassed property is required, which I believes means you can't set it to null in Typescript.\nIf it's not too late, can we avoid nullable booleans altogether in favor of an enum BYPASS_STATUS like {NEVER_BYPASSED, BYPASSED, REVOKED}?", "author": "jaycarlton", "createdAt": "2020-07-21T16:40:39Z", "path": "api/src/main/resources/workbench-api.yaml", "diffHunk": "@@ -7787,3 +7814,29 @@ definitions:\n           timestamp (epoch millis) at workspace creation\n         type: integer\n         format: int64\n+  EditUserInformationRequest:\n+    description: >\n+      A group of changes an admin can make to a user in the Edit Information card of the individual-user admin page.\n+      Updates to the contact email or the institutional affiliation will be rejected if they do not validate.\n+    type: object\n+    required:\n+      - username\n+    properties:\n+      username:\n+        description: The full system-assigned ID of a user, including email domain\n+        type: string\n+      freeCreditsLimit:\n+        description: When set, overrides the default free credits dollar limit for this user.\n+        type: number\n+        format: double\n+      contactEmail:\n+        description: When set, replaces the user's contact email.  Must validate against the user's Institutional Affiliation, if one exists.\n+        type: string\n+      verifiedInstitutionalAffiliation:\n+        description: When set, replaces the user's verified institutional email.  Must validate against the user's contact email.\n+        \"$ref\": '#/definitions/VerifiedInstitutionalAffiliation'\n+      accessBypassRequests:\n+        description: When set, updates the user's bypass status for one or more access modules.\n+        type: array\n+        items:\n+          \"$ref\": '#/definitions/AccessBypassRequest'", "originalCommit": "ff3b03c67c15c4d98328542add0bdf8b5e22a6aa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTA2OTYwOA==", "url": "https://github.com/all-of-us/workbench/pull/3785#discussion_r459069608", "bodyText": "There's no nullable boolean here - this is a confusion between data at rest and the action to change the data.\nAccessBypassRequest holds the intent to make a change: turn a bypass on or off (possibly redundantly).  The bypass state itself is a nullable timestamp on DbUser, with the semantics of isBypassed = (timestamp != null).\nSo the default of \"never set\" is equivalent to false.", "author": "jmthibault79", "createdAt": "2020-07-22T20:40:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODIzNzc2MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDg5NzA5OQ==", "url": "https://github.com/all-of-us/workbench/pull/3785#discussion_r460897099", "bodyText": "Right. We can't distinguish a state with no history from a state where it was bypassed and removed by looking at the database. If history matters, then a boolean isn't really enough.\nIt's in the audit trail, though, and not something that should really be tackled on this PR.", "author": "jaycarlton", "createdAt": "2020-07-27T13:40:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODIzNzc2MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODI0MzY2Mg==", "url": "https://github.com/all-of-us/workbench/pull/3785#discussion_r458243662", "bodyText": "nit: alphabetize these, please. there are a couple of IJ plugins that can do that.", "author": "jaycarlton", "createdAt": "2020-07-21T16:49:42Z", "path": "api/src/test/java/org/pmiops/workbench/api/ProfileControllerTest.java", "diffHunk": "@@ -180,8 +188,9 @@\n     CaptchaVerificationService.class,\n     UserServiceImpl.class,\n     UserServiceTestConfiguration.class,\n+    FreeTierBillingService.class,", "originalCommit": "ff3b03c67c15c4d98328542add0bdf8b5e22a6aa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTA3MDU5OQ==", "url": "https://github.com/all-of-us/workbench/pull/3785#discussion_r459070599", "bodyText": "Will do.  I typically use Edit -> Sort Lines", "author": "jmthibault79", "createdAt": "2020-07-22T20:42:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODI0MzY2Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODI0NDA2NQ==", "url": "https://github.com/all-of-us/workbench/pull/3785#discussion_r458244065", "bodyText": "why is this commented out?", "author": "jaycarlton", "createdAt": "2020-07-21T16:50:19Z", "path": "api/src/test/java/org/pmiops/workbench/api/ProfileControllerTest.java", "diffHunk": "@@ -231,6 +240,9 @@ public void setUp() throws IOException {\n             .country(COUNTRY)\n             .zipCode(ZIP_CODE));\n \n+    // TODO: this needs to be set in createAccountAndDbUserWithAffiliation() instead of here.  Why?\n+    // profile.setEmailVerificationStatus(EmailVerificationStatus.SUBSCRIBED);", "originalCommit": "ff3b03c67c15c4d98328542add0bdf8b5e22a6aa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTA3MTQyOQ==", "url": "https://github.com/all-of-us/workbench/pull/3785#discussion_r459071429", "bodyText": "This is the command which logically fits here but does not work properly.  Is there a better way to make that clear?\nI could also just remove it.", "author": "jmthibault79", "createdAt": "2020-07-22T20:43:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODI0NDA2NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODI4NTA2OA==", "url": "https://github.com/all-of-us/workbench/pull/3785#discussion_r458285068", "bodyText": "are you verifying the wrong behavior here?", "author": "jaycarlton", "createdAt": "2020-07-21T17:56:55Z", "path": "api/src/test/java/org/pmiops/workbench/api/ProfileControllerTest.java", "diffHunk": "@@ -1147,14 +1138,382 @@ public void testUpdateProfile_updateDemographicSurvey() {\n         false);\n   }\n \n+  @Test(expected = NotFoundException.class)\n+  public void test_editUserInformation_null_user() {\n+    profileService.editUserInformation(new EditUserInformationRequest());\n+  }\n+\n+  @Test(expected = NotFoundException.class)\n+  public void test_editUserInformation_user_not_found() {\n+    final EditUserInformationRequest request =\n+        new EditUserInformationRequest().username(\"not found\");\n+    profileService.editUserInformation(request);\n+  }\n+\n+  @Test\n+  public void test_editUserInformation_no_change() {\n+    final Profile original = createAccountAndDbUserWithAffiliation();\n+\n+    // valid user but no fields updated\n+    final EditUserInformationRequest request =\n+        new EditUserInformationRequest().username(PRIMARY_EMAIL);\n+    final Profile retrieved = profileService.editUserInformation(request);\n+\n+    // RW-5257 Demo Survey completion time is incorrectly updated\n+    retrieved.setDemographicSurveyCompletionTime(null);", "originalCommit": "ff3b03c67c15c4d98328542add0bdf8b5e22a6aa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTA3MjQ5NA==", "url": "https://github.com/all-of-us/workbench/pull/3785#discussion_r459072494", "bodyText": "I want to assert a round trip but I can't because of RW-5257: this line is necessary to correct that.  Is there a better way to show this?", "author": "jmthibault79", "createdAt": "2020-07-22T20:45:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODI4NTA2OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTA3Mjk2NQ==", "url": "https://github.com/all-of-us/workbench/pull/3785#discussion_r459072965", "bodyText": "This would be cleaner if you passed in isNewProfile to fieldChanged(). Actually I'd probably have a method that absorbed all the ifs as well so there's not so much branching. Like\nboolean validateIfChanged(Diff diff, String fieldName, Consumer<Profile> validateFunction);\nBonus points for putting all that into an enum, or using a map from field names to validators.", "author": "jaycarlton", "createdAt": "2020-07-22T20:46:33Z", "path": "api/src/main/java/org/pmiops/workbench/profile/ProfileService.java", "diffHunk": "@@ -381,47 +415,73 @@ private void validateAreaOfResearch(Profile profile) throws BadRequestException\n    * object.\n    *\n    * @param updatedProfile\n-   * @param prevProfile\n+   * @param previousProfile\n    * @throws BadRequestException\n    */\n   @VisibleForTesting\n-  public void validateProfile(@Nonnull Profile updatedProfile, @Nullable Profile prevProfile)\n+  public void validateProfile(\n+      @Nonnull Profile updatedProfile, @Nullable Profile previousProfile, boolean userIsAdmin) {\n+\n+    final boolean isNewProfile = previousProfile == null;\n+    final Diff diff = javers.compare(previousProfile, updatedProfile);\n+\n+    validateProfileForCorrectness(updatedProfile, isNewProfile, diff);\n+\n+    if (userIsAdmin) {\n+      validateChangesAllowedByAdmin(diff);\n+    } else {\n+      validateChangesAllowedByUser(diff);\n+    }\n+  }\n+\n+  private void validateProfileForCorrectness(Profile profile, boolean isNewProfile, Diff diff)\n       throws BadRequestException {\n-    boolean isNewObject = prevProfile == null;\n-    Diff diff = javers.compare(prevProfile, updatedProfile);\n+    if (isNewProfile || fieldChanged(diff, \"username\")) {\n+      validateUsername(profile);\n+    }\n+    if (isNewProfile || fieldChanged(diff, \"contactEmail\")) {\n+      validateContactEmail(profile);\n \n-    if (!getChangesWithPrefix(diff, \"username\").isEmpty() || isNewObject) {\n-      validateUsername(updatedProfile);\n+      // only validate if the new profile has an affiliation - some older users do not\n+      if (profile.getVerifiedInstitutionalAffiliation() != null) {\n+        validateInstitutionalAffiliationAgainstEmail(profile);\n+      }\n     }\n-    if (!getChangesWithPrefix(diff, \"contactEmail\").isEmpty() || isNewObject) {\n-      validateContactEmail(updatedProfile);\n+    if (isNewProfile || fieldChanged(diff, \"givenName\")) {", "originalCommit": "ff3b03c67c15c4d98328542add0bdf8b5e22a6aa", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTA3NTA2NA==", "url": "https://github.com/all-of-us/workbench/pull/3785#discussion_r459075064", "bodyText": "I'd bundle these two calls into a ProfileService#getByUsername(String username) if you don't need the DbUser.", "author": "jaycarlton", "createdAt": "2020-07-22T20:50:31Z", "path": "api/src/main/java/org/pmiops/workbench/profile/ProfileService.java", "diffHunk": "@@ -432,10 +492,48 @@ public void validateProfile(@Nonnull Profile updatedProfile, @Nullable Profile p\n    * @throws BadRequestException\n    */\n   public void validateNewProfile(Profile profile) throws BadRequestException {\n-    validateProfile(profile, null);\n+    // unused, but this is the correct syntax for a \"Diff\" of a new object\n+    final Diff dummyDiff = javers.compare(null, profile);\n+    validateProfileForCorrectness(profile, true, dummyDiff);\n   }\n \n   public List<Profile> listAllProfiles() {\n     return userService.getAllUsers().stream().map(this::getProfile).collect(Collectors.toList());\n   }\n+\n+  /**\n+   * Updates the user metadata referenced by the fields of EditUserInformationRequest.\n+   *\n+   * @param request the fields to update. Fields left null here will not be updated. Contact Email\n+   *     and Verified Institutional Affiliation updates will trigger a check for affiliation\n+   *     validation.\n+   * @return the Profile of the user, after updates\n+   */\n+  public Profile editUserInformation(EditUserInformationRequest request) {\n+    final DbUser dbUser = userService.getByUsernameOrThrow(request.getUsername());\n+    final Profile originalProfile = getProfile(dbUser);", "originalCommit": "ff3b03c67c15c4d98328542add0bdf8b5e22a6aa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDE1MTE0Mg==", "url": "https://github.com/all-of-us/workbench/pull/3785#discussion_r460151142", "bodyText": "I do need the DbUser", "author": "jmthibault79", "createdAt": "2020-07-24T16:12:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTA3NTA2NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTA3NjU5Ng==", "url": "https://github.com/all-of-us/workbench/pull/3785#discussion_r459076596", "bodyText": "Can we just name this property affiliation with the intention to rename VerifiedInstitutionalAffiliation soon?", "author": "jaycarlton", "createdAt": "2020-07-22T20:53:40Z", "path": "api/src/main/resources/workbench-api.yaml", "diffHunk": "@@ -7787,3 +7814,29 @@ definitions:\n           timestamp (epoch millis) at workspace creation\n         type: integer\n         format: int64\n+  EditUserInformationRequest:\n+    description: >\n+      A group of changes an admin can make to a user in the Edit Information card of the individual-user admin page.\n+      Updates to the contact email or the institutional affiliation will be rejected if they do not validate.\n+    type: object\n+    required:\n+      - username\n+    properties:\n+      username:\n+        description: The full system-assigned ID of a user, including email domain\n+        type: string\n+      freeCreditsLimit:\n+        description: When set, overrides the default free credits dollar limit for this user.\n+        type: number\n+        format: double\n+      contactEmail:\n+        description: When set, replaces the user's contact email.  Must validate against the user's Institutional Affiliation, if one exists.\n+        type: string\n+      verifiedInstitutionalAffiliation:", "originalCommit": "ff3b03c67c15c4d98328542add0bdf8b5e22a6aa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDIxNzA3OA==", "url": "https://github.com/all-of-us/workbench/pull/3785#discussion_r460217078", "bodyText": "I like that.\nWe should remove all of the old-style affiliations before doing so, but I think we can get to this soon.  New ticket: https://precisionmedicineinitiative.atlassian.net/browse/RW-5326", "author": "jmthibault79", "createdAt": "2020-07-24T18:22:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTA3NjU5Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTA3Njk1Ng==", "url": "https://github.com/all-of-us/workbench/pull/3785#discussion_r459076956", "bodyText": "I'm confused: does the affiliation own the contact email or is it independent?", "author": "jaycarlton", "createdAt": "2020-07-22T20:54:25Z", "path": "api/src/main/resources/workbench-api.yaml", "diffHunk": "@@ -7787,3 +7814,29 @@ definitions:\n           timestamp (epoch millis) at workspace creation\n         type: integer\n         format: int64\n+  EditUserInformationRequest:\n+    description: >\n+      A group of changes an admin can make to a user in the Edit Information card of the individual-user admin page.\n+      Updates to the contact email or the institutional affiliation will be rejected if they do not validate.\n+    type: object\n+    required:\n+      - username\n+    properties:\n+      username:\n+        description: The full system-assigned ID of a user, including email domain\n+        type: string\n+      freeCreditsLimit:\n+        description: When set, overrides the default free credits dollar limit for this user.\n+        type: number\n+        format: double\n+      contactEmail:\n+        description: When set, replaces the user's contact email.  Must validate against the user's Institutional Affiliation, if one exists.\n+        type: string\n+      verifiedInstitutionalAffiliation:\n+        description: When set, replaces the user's verified institutional email.  Must validate against the user's contact email.", "originalCommit": "ff3b03c67c15c4d98328542add0bdf8b5e22a6aa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDE1MTU5NA==", "url": "https://github.com/all-of-us/workbench/pull/3785#discussion_r460151594", "bodyText": "copypaste error.  fixed.", "author": "jmthibault79", "createdAt": "2020-07-24T16:13:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTA3Njk1Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTA4NDc3NA==", "url": "https://github.com/all-of-us/workbench/pull/3785#discussion_r459084774", "bodyText": "If I see a method starting with set that returns a boolean, I generally assume it returns true if the value was successfully set. This contract is confusing to me.", "author": "jaycarlton", "createdAt": "2020-07-22T21:09:21Z", "path": "api/src/main/java/org/pmiops/workbench/billing/FreeTierBillingService.java", "diffHunk": "@@ -295,4 +296,34 @@ public double getUserFreeTierDollarLimit(DbUser user) {\n     return Optional.ofNullable(user.getFreeTierCreditsLimitDollarsOverride())\n         .orElse(workbenchConfigProvider.get().billing.defaultFreeCreditsDollarLimit);\n   }\n+\n+  /**\n+   * Set a custom Free Tier dollar limit override for this user. If this is greater than the user's\n+   * total cost, set their workspaces to active. Note: lowering the limit below total cost will not\n+   * set the workspaces to inactive. checkFreeTierBillingUsage() will do this as part of the next\n+   * cron run.\n+   *\n+   * @param user the user as represented in our database\n+   * @param dollarLimit the US dollar amount, represented as a double\n+   * @return whether the user's total cost is now below their limit", "originalCommit": "16a9825a21a642b4ce0b41f32d9a213778cb61ff", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDIzNDQ4OQ==", "url": "https://github.com/all-of-us/workbench/pull/3785#discussion_r460234489", "bodyText": "good point.  We don't need this return value.  It's a void now.", "author": "jmthibault79", "createdAt": "2020-07-24T19:00:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTA4NDc3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDMwNjE2Mw==", "url": "https://github.com/all-of-us/workbench/pull/3785#discussion_r460306163", "bodyText": "Update: it returns a boolean again, and works in the way you describe.  Method is now called maybeSetDollarLimitOverride() and has more internal logic", "author": "jmthibault79", "createdAt": "2020-07-24T21:59:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTA4NDc3NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTA4NTM5Nw==", "url": "https://github.com/all-of-us/workbench/pull/3785#discussion_r459085397", "bodyText": "I am surprised to see this being set in this service as opposed to the UserAdminService or ProfileService or someplace. I guess you'd have to invert the dependency for that to happen though.", "author": "jaycarlton", "createdAt": "2020-07-22T21:10:38Z", "path": "api/src/main/java/org/pmiops/workbench/billing/FreeTierBillingService.java", "diffHunk": "@@ -295,4 +296,34 @@ public double getUserFreeTierDollarLimit(DbUser user) {\n     return Optional.ofNullable(user.getFreeTierCreditsLimitDollarsOverride())\n         .orElse(workbenchConfigProvider.get().billing.defaultFreeCreditsDollarLimit);\n   }\n+\n+  /**\n+   * Set a custom Free Tier dollar limit override for this user. If this is greater than the user's\n+   * total cost, set their workspaces to active. Note: lowering the limit below total cost will not\n+   * set the workspaces to inactive. checkFreeTierBillingUsage() will do this as part of the next\n+   * cron run.\n+   *\n+   * @param user the user as represented in our database\n+   * @param dollarLimit the US dollar amount, represented as a double\n+   * @return whether the user's total cost is now below their limit\n+   */\n+  public boolean setFreeTierDollarOverride(DbUser user, double dollarLimit) {\n+    final Double previousLimitMaybe = user.getFreeTierCreditsLimitDollarsOverride();\n+\n+    // TODO: prevent setting this limit directly except in this method?\n+    user.setFreeTierCreditsLimitDollarsOverride(dollarLimit);\n+    user = userDao.save(user);", "originalCommit": "16a9825a21a642b4ce0b41f32d9a213778cb61ff", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTA4NjY3MA==", "url": "https://github.com/all-of-us/workbench/pull/3785#discussion_r459086670", "bodyText": "Why do we need the \"forUser\" suffix? I think that was there previously but I never got what it meant.\nSo Admins can't create profiles, right? At least not in their capacity as admins.", "author": "jaycarlton", "createdAt": "2020-07-22T21:13:10Z", "path": "api/src/main/java/org/pmiops/workbench/profile/ProfileService.java", "diffHunk": "@@ -187,11 +192,28 @@ public void validateInstitutionalAffiliation(Profile profile) {\n    * @param previousProfile\n    */\n   public void updateProfileForUser(DbUser user, Profile updatedProfile, Profile previousProfile) {\n+    updateProfileForUser(user, updatedProfile, previousProfile, false);\n+  }\n+\n+  /**\n+   * Updates a profile for a given user as Admin and persists all information to the database.\n+   *\n+   * @param user\n+   * @param updatedProfile\n+   * @param previousProfile\n+   */\n+  public void adminUpdateProfileForUser(", "originalCommit": "16a9825a21a642b4ce0b41f32d9a213778cb61ff", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDI1Mzg4MA==", "url": "https://github.com/all-of-us/workbench/pull/3785#discussion_r460253880", "bodyText": "(NOTE: I have removed the admin version of this method in favor of checking authorities)\nI'm not sure.  @gjuggler this was your originally, right?  Any concern with renaming updateProfileForUser() to \"updateProfile\" ?", "author": "jmthibault79", "createdAt": "2020-07-24T19:43:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTA4NjY3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDI2NjQ4NA==", "url": "https://github.com/all-of-us/workbench/pull/3785#discussion_r460266484", "bodyText": "IIRC this method originally lived at the controller level, where there is also an updateProfile() method (which handles the case when \"my current user\" is the target user being updated). Now that it's in the service it makes sense to remove the suffix for consistency with other methods in that file.", "author": "gjuggler", "createdAt": "2020-07-24T20:13:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTA4NjY3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDYxODQwNA==", "url": "https://github.com/all-of-us/workbench/pull/3785#discussion_r460618404", "bodyText": "Thanks.  Updated.", "author": "jmthibault79", "createdAt": "2020-07-27T02:41:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTA4NjY3MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTA4NzIwNQ==", "url": "https://github.com/all-of-us/workbench/pull/3785#discussion_r459087205", "bodyText": "By exiting early, we can't validate multiple fields and give the client a single exception with a list of issues with the profile. Granted no one has asked for that yet.", "author": "jaycarlton", "createdAt": "2020-07-22T21:14:19Z", "path": "api/src/main/java/org/pmiops/workbench/profile/ProfileService.java", "diffHunk": "@@ -381,47 +415,73 @@ private void validateAreaOfResearch(Profile profile) throws BadRequestException\n    * object.\n    *\n    * @param updatedProfile\n-   * @param prevProfile\n+   * @param previousProfile\n    * @throws BadRequestException\n    */\n   @VisibleForTesting\n-  public void validateProfile(@Nonnull Profile updatedProfile, @Nullable Profile prevProfile)\n+  public void validateProfile(\n+      @Nonnull Profile updatedProfile, @Nullable Profile previousProfile, boolean userIsAdmin) {\n+\n+    final boolean isNewProfile = previousProfile == null;\n+    final Diff diff = javers.compare(previousProfile, updatedProfile);\n+\n+    validateProfileForCorrectness(updatedProfile, isNewProfile, diff);\n+\n+    if (userIsAdmin) {\n+      validateChangesAllowedByAdmin(diff);\n+    } else {\n+      validateChangesAllowedByUser(diff);\n+    }\n+  }\n+\n+  private void validateProfileForCorrectness(Profile profile, boolean isNewProfile, Diff diff)\n       throws BadRequestException {\n-    boolean isNewObject = prevProfile == null;\n-    Diff diff = javers.compare(prevProfile, updatedProfile);\n+    if (isNewProfile || fieldChanged(diff, \"username\")) {\n+      validateUsername(profile);\n+    }\n+    if (isNewProfile || fieldChanged(diff, \"contactEmail\")) {\n+      validateContactEmail(profile);\n \n-    if (!getChangesWithPrefix(diff, \"username\").isEmpty() || isNewObject) {\n-      validateUsername(updatedProfile);\n+      // only validate if the new profile has an affiliation - some older users do not\n+      if (profile.getVerifiedInstitutionalAffiliation() != null) {\n+        validateInstitutionalAffiliationAgainstEmail(profile);\n+      }\n     }\n-    if (!getChangesWithPrefix(diff, \"contactEmail\").isEmpty() || isNewObject) {\n-      validateContactEmail(updatedProfile);\n+    if (isNewProfile || fieldChanged(diff, \"givenName\")) {\n+      validateGivenName(profile);\n     }\n-    if (!getChangesWithPrefix(diff, \"givenName\").isEmpty() || isNewObject) {\n-      validateGivenName(updatedProfile);\n+    if (isNewProfile || fieldChanged(diff, \"familyName\")) {\n+      validateFamilyName(profile);\n     }\n-    if (!getChangesWithPrefix(diff, \"familyName\").isEmpty() || isNewObject) {\n-      validateFamilyName(updatedProfile);\n+    if (isNewProfile || fieldChanged(diff, \"address\")) {\n+      validateAddress(profile);\n     }\n-    if (!getChangesWithPrefix(diff, \"address\").isEmpty() || isNewObject) {\n-      validateAddress(updatedProfile);\n+    if (isNewProfile || fieldChanged(diff, \"areaOfResearch\")) {\n+      validateAreaOfResearch(profile);\n     }\n-    if (!getChangesWithPrefix(diff, \"areaOfResearch\").isEmpty() || isNewObject) {\n-      validateAreaOfResearch(updatedProfile);\n+    if (isNewProfile || fieldChanged(diff, \"verifiedInstitutionalAffiliation\")) {\n+      validateInstitutionalAffiliation(profile);\n     }\n-    if (!getChangesWithPrefix(diff, \"verifiedInstitutionalAffiliation\").isEmpty() || isNewObject) {\n-      validateInstitutionalAffiliation(updatedProfile);\n+  }\n+\n+  private void validateChangesAllowedByUser(Diff diff) {\n+    if (fieldChanged(diff, \"username\")) {\n+      // See RW-1488.\n+      throw new BadRequestException(\"Changing username is not supported\");", "originalCommit": "16a9825a21a642b4ce0b41f32d9a213778cb61ff", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTk3ODkyMw==", "url": "https://github.com/all-of-us/workbench/pull/3785#discussion_r461978923", "bodyText": "Good point!  I filed this: https://precisionmedicineinitiative.atlassian.net/browse/RW-5334", "author": "jmthibault79", "createdAt": "2020-07-29T01:06:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTA4NzIwNQ=="}], "type": "inlineReview"}, {"oid": "591208a60052ab0030ed4cb1fe62afcebabe1241", "url": "https://github.com/all-of-us/workbench/commit/591208a60052ab0030ed4cb1fe62afcebabe1241", "message": "editUserInformation endpoint and tests", "committedDate": "2020-07-24T00:42:30Z", "type": "commit"}, {"oid": "e10015a6d80b551c58f5f8484d4ba834337c6e75", "url": "https://github.com/all-of-us/workbench/commit/e10015a6d80b551c58f5f8484d4ba834337c6e75", "message": "FreeTierAuditor and test fixes\n\nadd auditor checks to FreeTierBillingServiceTest\n\nUse a @MockBean for FreeTierBillingService in WorkspacesControllerTest\n\nFreeTierAuditorTest", "committedDate": "2020-07-24T00:42:30Z", "type": "commit"}, {"oid": "a9796d76d35500d4b011e92f8fddcfc781b0dec3", "url": "https://github.com/all-of-us/workbench/commit/a9796d76d35500d4b011e92f8fddcfc781b0dec3", "message": "costAboveLimit", "committedDate": "2020-07-24T00:42:31Z", "type": "commit"}, {"oid": "f1695a8f2d1ed91dc1976f052247e0c1210346dd", "url": "https://github.com/all-of-us/workbench/commit/f1695a8f2d1ed91dc1976f052247e0c1210346dd", "message": "targetUserId", "committedDate": "2020-07-24T00:42:31Z", "type": "commit"}, {"oid": "1a1aa5d0c1ca387b3c639d588ec581edc5e89bc2", "url": "https://github.com/all-of-us/workbench/commit/1a1aa5d0c1ca387b3c639d588ec581edc5e89bc2", "message": "isEmpty nit", "committedDate": "2020-07-24T00:42:32Z", "type": "commit"}, {"oid": "e742144296e499b2ff5b145e8dc460b3ebd8c31b", "url": "https://github.com/all-of-us/workbench/commit/e742144296e499b2ff5b145e8dc460b3ebd8c31b", "message": "accessBypassRequests is now required", "committedDate": "2020-07-24T00:42:32Z", "type": "commit"}, {"oid": "2f9e5e5a03d5c7765eebcc26dca87b8315afb008", "url": "https://github.com/all-of-us/workbench/commit/2f9e5e5a03d5c7765eebcc26dca87b8315afb008", "message": "alpha imports", "committedDate": "2020-07-24T00:42:32Z", "type": "commit"}, {"oid": "7069816e8fbcec09eff5c890458c78be09854100", "url": "https://github.com/all-of-us/workbench/commit/7069816e8fbcec09eff5c890458c78be09854100", "message": "merge FreeTierAuditor into UserServiceAuditor", "committedDate": "2020-07-24T00:42:33Z", "type": "commit"}, {"oid": "d634af34f647e9a4abaf726ed1bd5d8b9651d114", "url": "https://github.com/all-of-us/workbench/commit/d634af34f647e9a4abaf726ed1bd5d8b9651d114", "message": "Move ProfileTargetType.FREE_TIER_DOLLAR_QUOTA to AccountTargetType\nRemove ActionType.FREE_TIER_DOLLAR_OVERRIDE", "committedDate": "2020-07-24T00:42:33Z", "type": "commit"}, {"oid": "d85452fb151e3a098cc2a59558dee7f92485bf1e", "url": "https://github.com/all-of-us/workbench/commit/d85452fb151e3a098cc2a59558dee7f92485bf1e", "message": "validateInstitutionalAffiliationAgainstEmail -> validateAffiliation", "committedDate": "2020-07-24T00:42:34Z", "type": "commit"}, {"oid": "86bf9878ace072b74c5026f0c2794f87fac28e1a", "url": "https://github.com/all-of-us/workbench/commit/86bf9878ace072b74c5026f0c2794f87fac28e1a", "message": "DbUser.hasAuthority()", "committedDate": "2020-07-24T00:42:37Z", "type": "commit"}, {"oid": "86bf9878ace072b74c5026f0c2794f87fac28e1a", "url": "https://github.com/all-of-us/workbench/commit/86bf9878ace072b74c5026f0c2794f87fac28e1a", "message": "DbUser.hasAuthority()", "committedDate": "2020-07-24T00:42:37Z", "type": "forcePushed"}, {"oid": "ebd5574df283eb0df309e236e870f42771ffaf91", "url": "https://github.com/all-of-us/workbench/commit/ebd5574df283eb0df309e236e870f42771ffaf91", "message": "fixed a test", "committedDate": "2020-07-24T02:04:52Z", "type": "commit"}, {"oid": "4111c4a6f89efe55bd9255bb3b0aed5621763187", "url": "https://github.com/all-of-us/workbench/commit/4111c4a6f89efe55bd9255bb3b0aed5621763187", "message": "ProfileControllerTest test fixes", "committedDate": "2020-07-24T02:39:07Z", "type": "commit"}, {"oid": "f8178e0bba04f615168a738659c0e3ab5fd9cbff", "url": "https://github.com/all-of-us/workbench/commit/f8178e0bba04f615168a738659c0e3ab5fd9cbff", "message": "mini clean", "committedDate": "2020-07-24T02:42:23Z", "type": "commit"}, {"oid": "7a1b04e40dda8202098d476e3ead0144ce5433d8", "url": "https://github.com/all-of-us/workbench/commit/7a1b04e40dda8202098d476e3ead0144ce5433d8", "message": "rename editUserInformation to updateAccountProperties, etc", "committedDate": "2020-07-24T15:46:07Z", "type": "commit"}, {"oid": "6e4997effa437ab15f1aef5d3d095ff84a756f9a", "url": "https://github.com/all-of-us/workbench/commit/6e4997effa437ab15f1aef5d3d095ff84a756f9a", "message": "rename a few things after PR comments", "committedDate": "2020-07-24T18:39:23Z", "type": "commit"}, {"oid": "80edd8c22bbc206009a25483bb4e486af6deaad3", "url": "https://github.com/all-of-us/workbench/commit/80edd8c22bbc206009a25483bb4e486af6deaad3", "message": "lint", "committedDate": "2020-07-24T18:48:08Z", "type": "commit"}, {"oid": "06b835219ac479f52c2b147cbc5dd78e747fa40c", "url": "https://github.com/all-of-us/workbench/commit/06b835219ac479f52c2b147cbc5dd78e747fa40c", "message": "renames", "committedDate": "2020-07-24T18:51:39Z", "type": "commit"}, {"oid": "6246277c2e7e2f5e946a3b74f58a371a89b33002", "url": "https://github.com/all-of-us/workbench/commit/6246277c2e7e2f5e946a3b74f58a371a89b33002", "message": "push down the no-override logic", "committedDate": "2020-07-24T21:27:30Z", "type": "commit"}, {"oid": "23273d009cc8ddd643f74247857d9d4591c0b9dd", "url": "https://github.com/all-of-us/workbench/commit/23273d009cc8ddd643f74247857d9d4591c0b9dd", "message": "better tests", "committedDate": "2020-07-24T21:43:11Z", "type": "commit"}, {"oid": "87ab893c65de603cf4bec15d49083cb081a5f2c2", "url": "https://github.com/all-of-us/workbench/commit/87ab893c65de603cf4bec15d49083cb081a5f2c2", "message": "rename updateProfileForUser to updateProfile", "committedDate": "2020-07-27T02:40:54Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDg4MzE4OA==", "url": "https://github.com/all-of-us/workbench/pull/3785#discussion_r460883188", "bodyText": "nit: I don't know if we have a decision on trailing commas in these kinds of lists. Seems like it might not work everywhere in Java.", "author": "jaycarlton", "createdAt": "2020-07-27T13:19:17Z", "path": "api/src/main/java/org/pmiops/workbench/actionaudit/ActionType.kt", "diffHunk": "@@ -11,5 +11,5 @@ enum class ActionType {\n     DUPLICATE_TO,\n     COLLABORATE,\n     DELETE,\n-    DETECT_HIGH_EGRESS_EVENT\n+    DETECT_HIGH_EGRESS_EVENT,", "originalCommit": "87ab893c65de603cf4bec15d49083cb081a5f2c2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTk3Njg4MA==", "url": "https://github.com/all-of-us/workbench/pull/3785#discussion_r461976880", "bodyText": "I've been adding these various places - especially @Import({...}) lists in tests", "author": "jmthibault79", "createdAt": "2020-07-29T00:58:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDg4MzE4OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDg4NDg4MA==", "url": "https://github.com/all-of-us/workbench/pull/3785#discussion_r460884880", "bodyText": "nit: general convention would be something like fireEditFreeTierQuota(). Auditors always fire actions, so that part of the name doesn't narrow it down much.", "author": "jaycarlton", "createdAt": "2020-07-27T13:21:58Z", "path": "api/src/main/java/org/pmiops/workbench/actionaudit/auditors/UserServiceAuditor.java", "diffHunk": "@@ -21,4 +22,7 @@ void fireAdministrativeBypassTime(\n       Optional<Instant> newBypassTime);\n \n   void fireAcknowledgeTermsOfService(DbUser targetUser, Integer termsOfServiceVersion);\n+\n+  void fireFreeTierDollarQuotaAction(", "originalCommit": "87ab893c65de603cf4bec15d49083cb081a5f2c2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDg4NzQwOQ==", "url": "https://github.com/all-of-us/workbench/pull/3785#discussion_r460887409", "bodyText": "It might help to have a small MyCurrency class to wrap the double, from which you could move to a standard representation using integral cents. Just to keep money from getting subtracted from weights or something.", "author": "jaycarlton", "createdAt": "2020-07-27T13:25:43Z", "path": "api/src/main/java/org/pmiops/workbench/billing/FreeTierBillingService.java", "diffHunk": "@@ -136,10 +138,14 @@ private int compareCostFractions(final double a, final double b) {\n     return DoubleMath.fuzzyCompare(a, b, COST_FRACTION_TOLERANCE);\n   }\n \n-  private boolean expiredByCost(final DbUser user, final double currentCost) {\n+  private boolean costAboveLimit(final DbUser user, final double currentCost) {\n     return compareCosts(currentCost, getUserFreeTierDollarLimit(user)) > 0;\n   }\n \n+  private boolean costsDiffer(final double a, final double b) {", "originalCommit": "87ab893c65de603cf4bec15d49083cb081a5f2c2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDg4OTc1Ng==", "url": "https://github.com/all-of-us/workbench/pull/3785#discussion_r460889756", "bodyText": "Best way to do that is with a separate little service that only exposes one entry point.", "author": "jaycarlton", "createdAt": "2020-07-27T13:29:25Z", "path": "api/src/main/java/org/pmiops/workbench/billing/FreeTierBillingService.java", "diffHunk": "@@ -295,4 +300,42 @@ public double getUserFreeTierDollarLimit(DbUser user) {\n     return Optional.ofNullable(user.getFreeTierCreditsLimitDollarsOverride())\n         .orElse(workbenchConfigProvider.get().billing.defaultFreeCreditsDollarLimit);\n   }\n+\n+  /**\n+   * Set a Free Tier dollar limit override value for this user, but only if the value to set differs\n+   * from the system default or the user has an existing override. If the user has no override and\n+   * the value to set it equal to the system default, retain the system default so this user's quota\n+   * continues to track it.\n+   *\n+   * <p>If this is greater than the user's total cost, set their workspaces to active. Note:\n+   * lowering the limit below total cost will NOT set the workspaces to inactive.\n+   * checkFreeTierBillingUsage() will do this as part of the next cron run.\n+   *\n+   * @param user the user as represented in our database\n+   * @param newDollarLimit the US dollar amount, represented as a double\n+   * @return whether an override was set\n+   */\n+  public boolean maybeSetDollarLimitOverride(DbUser user, double newDollarLimit) {\n+    final Double previousLimitMaybe = user.getFreeTierCreditsLimitDollarsOverride();\n+\n+    if (previousLimitMaybe != null\n+        || costsDiffer(\n+            newDollarLimit, workbenchConfigProvider.get().billing.defaultFreeCreditsDollarLimit)) {\n+\n+      // TODO: prevent setting this limit directly except in this method?", "originalCommit": "87ab893c65de603cf4bec15d49083cb081a5f2c2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTIwNDYwNg==", "url": "https://github.com/all-of-us/workbench/pull/3785#discussion_r461204606", "bodyText": "That's effectively what we're doing already, at the Service or Controller level.  I'm imagining something stricter which we probably can't do, like \"only FreeTierBillingService can call this DbUser accessor\"", "author": "jmthibault79", "createdAt": "2020-07-27T22:23:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDg4OTc1Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDg5MDcyMg==", "url": "https://github.com/all-of-us/workbench/pull/3785#discussion_r460890722", "bodyText": "Looks like we're not setting the modified time on the user row? Please confirm that's what's wanted.", "author": "jaycarlton", "createdAt": "2020-07-27T13:30:53Z", "path": "api/src/main/java/org/pmiops/workbench/billing/FreeTierBillingService.java", "diffHunk": "@@ -295,4 +300,42 @@ public double getUserFreeTierDollarLimit(DbUser user) {\n     return Optional.ofNullable(user.getFreeTierCreditsLimitDollarsOverride())\n         .orElse(workbenchConfigProvider.get().billing.defaultFreeCreditsDollarLimit);\n   }\n+\n+  /**\n+   * Set a Free Tier dollar limit override value for this user, but only if the value to set differs\n+   * from the system default or the user has an existing override. If the user has no override and\n+   * the value to set it equal to the system default, retain the system default so this user's quota\n+   * continues to track it.\n+   *\n+   * <p>If this is greater than the user's total cost, set their workspaces to active. Note:\n+   * lowering the limit below total cost will NOT set the workspaces to inactive.\n+   * checkFreeTierBillingUsage() will do this as part of the next cron run.\n+   *\n+   * @param user the user as represented in our database\n+   * @param newDollarLimit the US dollar amount, represented as a double\n+   * @return whether an override was set\n+   */\n+  public boolean maybeSetDollarLimitOverride(DbUser user, double newDollarLimit) {\n+    final Double previousLimitMaybe = user.getFreeTierCreditsLimitDollarsOverride();\n+\n+    if (previousLimitMaybe != null\n+        || costsDiffer(\n+            newDollarLimit, workbenchConfigProvider.get().billing.defaultFreeCreditsDollarLimit)) {\n+\n+      // TODO: prevent setting this limit directly except in this method?\n+      user.setFreeTierCreditsLimitDollarsOverride(newDollarLimit);", "originalCommit": "87ab893c65de603cf4bec15d49083cb081a5f2c2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTI3NjA5NA==", "url": "https://github.com/all-of-us/workbench/pull/3785#discussion_r461276094", "bodyText": "good catch.  fixed.", "author": "jmthibault79", "createdAt": "2020-07-28T02:14:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDg5MDcyMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDg5MzA4MQ==", "url": "https://github.com/all-of-us/workbench/pull/3785#discussion_r460893081", "bodyText": "We should never have an enumeration where some states include others. This is icky. DEVELOPER should be its own, separate concept then.\nAdditionally, DEVELOPER is a bad name for this. I don't have or want authorities on PROD to do things like this.", "author": "jaycarlton", "createdAt": "2020-07-27T13:34:33Z", "path": "api/src/main/java/org/pmiops/workbench/db/model/DbUser.java", "diffHunk": "@@ -301,6 +301,13 @@ public void setAuthorities(Set<Short> newAuthorities) {\n     this.authorities = newAuthorities;\n   }\n \n+  @Transient\n+  public boolean hasAuthority(Authority required) {\n+    // DEVELOPER is the super-authority which subsumes all others", "originalCommit": "87ab893c65de603cf4bec15d49083cb081a5f2c2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTI3NjczNQ==", "url": "https://github.com/all-of-us/workbench/pull/3785#discussion_r461276735", "bodyText": "This replicates the existing Controller auth behavior.\nI would support removing it, but that's going to require a separate ticket and a larger conversation at a minimum.", "author": "jmthibault79", "createdAt": "2020-07-28T02:17:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDg5MzA4MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDg5NDk2OQ==", "url": "https://github.com/all-of-us/workbench/pull/3785#discussion_r460894969", "bodyText": "I don't like the isNewProfile flag here, because the Diff should already be able to tell us that. E.g. something like boolean isNewObject(Diff diff). Then each validate method could just take in a Diff and a string for the field name, or we could have a validateFields(Diff diff, Set<String> fieldNames). there are lots of if statements here currently, which are easily breakable by maintainers.", "author": "jaycarlton", "createdAt": "2020-07-27T13:37:26Z", "path": "api/src/main/java/org/pmiops/workbench/profile/ProfileService.java", "diffHunk": "@@ -381,47 +395,72 @@ private void validateAreaOfResearch(Profile profile) throws BadRequestException\n    * object.\n    *\n    * @param updatedProfile\n-   * @param prevProfile\n+   * @param previousProfile\n    * @throws BadRequestException\n    */\n   @VisibleForTesting\n-  public void validateProfile(@Nonnull Profile updatedProfile, @Nullable Profile prevProfile)\n+  public void validateProfile(@Nonnull Profile updatedProfile, @Nullable Profile previousProfile) {\n+\n+    final boolean isNewProfile = previousProfile == null;\n+    final Diff diff = javers.compare(previousProfile, updatedProfile);\n+\n+    validateProfileForCorrectness(updatedProfile, isNewProfile, diff);\n+\n+    if (userProvider.get().hasAuthority(Authority.ACCESS_CONTROL_ADMIN)) {\n+      validateChangesAllowedByAdmin(diff);\n+    } else {\n+      validateChangesAllowedByUser(diff);\n+    }\n+  }\n+\n+  private void validateProfileForCorrectness(Profile profile, boolean isNewProfile, Diff diff)", "originalCommit": "87ab893c65de603cf4bec15d49083cb081a5f2c2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTI4ODAyOA==", "url": "https://github.com/all-of-us/workbench/pull/3785#discussion_r461288028", "bodyText": "ok fine: isNewProfile is now a function of the Diff.\nI'm keeping the ifs because I like how they make the intent explicit.", "author": "jmthibault79", "createdAt": "2020-07-28T02:58:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDg5NDk2OQ=="}], "type": "inlineReview"}, {"oid": "8e52eb806ba3eb666d134ae136f63bdb9f25c3ea", "url": "https://github.com/all-of-us/workbench/commit/8e52eb806ba3eb666d134ae136f63bdb9f25c3ea", "message": "rename fireFreeTierDollarQuotaAction to fireSetFreeTierDollarLimitOverride", "committedDate": "2020-07-28T02:14:00Z", "type": "commit"}, {"oid": "7b6e5f428f8ae91edff9d95e753caab665bbb288", "url": "https://github.com/all-of-us/workbench/commit/7b6e5f428f8ae91edff9d95e753caab665bbb288", "message": "set user last modified when updating free tier dollar override", "committedDate": "2020-07-28T02:14:04Z", "type": "commit"}, {"oid": "89de47229166e930145ac6afe439f52e97f7b945", "url": "https://github.com/all-of-us/workbench/commit/89de47229166e930145ac6afe439f52e97f7b945", "message": "isNewProfile is now a function of a diff", "committedDate": "2020-07-28T02:54:43Z", "type": "commit"}, {"oid": "561eca062537f072cb9a00d883fdee041e292afe", "url": "https://github.com/all-of-us/workbench/commit/561eca062537f072cb9a00d883fdee041e292afe", "message": "move hasAuthority() to UserService to enable DB refetch", "committedDate": "2020-07-29T00:39:14Z", "type": "commit"}, {"oid": "3b02b2e13d64bc0321ff14d12a5f3b1414950340", "url": "https://github.com/all-of-us/workbench/commit/3b02b2e13d64bc0321ff14d12a5f3b1414950340", "message": "Make Profile.username readOnly in Swagger", "committedDate": "2020-07-29T00:42:11Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTk3NzQ0NQ==", "url": "https://github.com/all-of-us/workbench/pull/3785#discussion_r461977445", "bodyText": "This is new, and it works because it calls the query with JOIN FETCH", "author": "jmthibault79", "createdAt": "2020-07-29T01:00:30Z", "path": "api/src/main/java/org/pmiops/workbench/db/dao/UserServiceImpl.java", "diffHunk": "@@ -1022,4 +1024,13 @@ public void updateBypassTime(long userDatabaseId, AccessBypassRequest accessBypa\n             \"There is no access module named: \" + accessBypassRequest.getModuleName().toString());\n     }\n   }\n+\n+  @Override\n+  public boolean hasAuthority(long userId, Authority required) {", "originalCommit": "561eca062537f072cb9a00d883fdee041e292afe", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "ac91daa055cb6470a36df01e8db2407078a58ee7", "url": "https://github.com/all-of-us/workbench/commit/ac91daa055cb6470a36df01e8db2407078a58ee7", "message": "fix test to match new behavior", "committedDate": "2020-07-29T03:24:25Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjM4ODkxOQ==", "url": "https://github.com/all-of-us/workbench/pull/3785#discussion_r462388919", "bodyText": "aside: we should start using a yaml partial to bring these common codes in if we want to declare them everywhere. I'm not sure there's much percentage in doing it for all the endpoints.", "author": "jaycarlton", "createdAt": "2020-07-29T15:29:04Z", "path": "api/src/main/resources/workbench-api.yaml", "diffHunk": "@@ -1128,6 +1128,33 @@ paths:\n           description: No module exists with name submitted\n           schema:\n             \"$ref\": \"#/definitions/ErrorResponse\"\n+  \"/v1/admin/users/updateAccount\":\n+    post:\n+      tags:\n+        - profile\n+      consumes:\n+        - application/json\n+      description: 'Updates a subset of a user''s account metadata, as defined by the AccountPropertyUpdate object.  Requires ACCESS_CONTROL_ADMIN authority.'\n+      parameters:\n+        - in: body\n+          name: request\n+          description: The admin edit request to perform on a user\n+          schema:\n+            \"$ref\": \"#/definitions/AccountPropertyUpdate\"\n+      operationId: updateAccountProperties\n+      responses:\n+        200:", "originalCommit": "ac91daa055cb6470a36df01e8db2407078a58ee7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjM5MTI5Nw==", "url": "https://github.com/all-of-us/workbench/pull/3785#discussion_r462391297", "bodyText": "I've been using .isWithin(100.0).of(time_millis) for millisecond comparisons. Have to cast the arg to assertThat() to double to make that work. I guess we could make an instant-valued version...", "author": "jaycarlton", "createdAt": "2020-07-29T15:32:18Z", "path": "api/src/test/java/org/pmiops/workbench/billing/FreeTierBillingServiceTest.java", "diffHunk": "@@ -329,27 +335,112 @@ public void checkFreeTierBillingUsage_workspaceMissingCreatorNoNPE() {\n   }\n \n   @Test\n-  public void checkFreeTierBillingUsage_override() throws MessagingException {\n+  public void maybeSetDollarLimitOverride_true() {\n     workbenchConfig.billing.defaultFreeCreditsDollarLimit = 100.0;\n-    doReturn(mockBQTableSingleResult(100.01)).when(bigQueryService).executeQuery(any());\n+    final DbUser user = createUser(SINGLE_WORKSPACE_TEST_USER);\n+    assertThat(user.getLastModifiedTime()).isNull();\n+\n+    // we update the user and should see this last modified time\n+    final Instant time2 = START_INSTANT.plusSeconds(1000);\n+    CLOCK.setInstant(time2);\n+\n+    assertThat(freeTierBillingService.maybeSetDollarLimitOverride(user, 200.0)).isTrue();\n+    verify(mockUserServiceAuditor)\n+        .fireSetFreeTierDollarLimitOverride(user.getUserId(), null, 200.0);\n+    assertWithinBillingTolerance(freeTierBillingService.getUserFreeTierDollarLimit(user), 200.0);\n+    assertThat(userDao.findUserByUserId(user.getUserId()).getLastModifiedTime())\n+        .isEqualTo(new Timestamp(time2.toEpochMilli()));\n+\n+    // we update the user again and should see this new last modified time\n+    final Instant time3 = START_INSTANT.plusSeconds(2000);\n+    CLOCK.setInstant(time3);\n+\n+    assertThat(freeTierBillingService.maybeSetDollarLimitOverride(user, 100.0)).isTrue();\n+    verify(mockUserServiceAuditor)\n+        .fireSetFreeTierDollarLimitOverride(user.getUserId(), 200.0, 100.0);\n+    assertWithinBillingTolerance(freeTierBillingService.getUserFreeTierDollarLimit(user), 100.0);\n+    assertThat(userDao.findUserByUserId(user.getUserId()).getLastModifiedTime())\n+        .isEqualTo(new Timestamp(time3.toEpochMilli()));", "originalCommit": "ac91daa055cb6470a36df01e8db2407078a58ee7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}