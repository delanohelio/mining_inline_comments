{"pr_number": 4214, "pr_title": "[no ticket][risk=no] Puppeteer e2e test timeout fix", "pr_createdAt": "2020-10-27T14:40:07Z", "pr_url": "https://github.com/all-of-us/workbench/pull/4214", "timeline": [{"oid": "d8f19dd2a03c3a6e6d039062dee6f6609c9c1733", "url": "https://github.com/all-of-us/workbench/commit/d8f19dd2a03c3a6e6d039062dee6f6609c9c1733", "message": "wait timeout 30 sec", "committedDate": "2020-10-27T14:00:37Z", "type": "commit"}, {"oid": "e5aabb84dcc470a858e0a8c8d0daa3c52cc29f12", "url": "https://github.com/all-of-us/workbench/commit/e5aabb84dcc470a858e0a8c8d0daa3c52cc29f12", "message": "update spinner css", "committedDate": "2020-10-27T14:35:50Z", "type": "commit"}, {"oid": "745eec730ea377b7083766372a21f0e5fee751a6", "url": "https://github.com/all-of-us/workbench/commit/745eec730ea377b7083766372a21f0e5fee751a6", "message": "set defaultTimeout 15 seconds", "committedDate": "2020-10-27T14:37:30Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjc1MjA2OA==", "url": "https://github.com/all-of-us/workbench/pull/4214#discussion_r512752068", "bodyText": "wait longer for kernel status becomes ready. Notebook test failed in https://app.circleci.com/pipelines/github/all-of-us/workbench/5309/workflows/6ffd0b63-da62-477c-b54f-448bb6491880/jobs/106914/tests\nstacktrace:\nFailed test:  \"Workspace-owner-Jupyter-notebook-action-tests/Copy-notebook-to-another-Workspace-when-CDR-versions-match\"\nError: waitForKernelIdle encountered TimeoutError: waiting for selector \"#kernel_indicator_icon.kernel_idle_icon\" failed: timeout 10000ms exceeded\n  console.error\n    Notebook kernel is: Kernel Busy\n\n      119 |       ]);\n      120 |     } catch (e) {\n    > 121 |       console.error(`Notebook kernel is: ${await this.kernelStatus()}`);\n          |               ^\n      122 |       throw new Error(`waitForKernelIdle encountered ${e}`);\n      123 |     }\n      124 |   }\n\n      at NotebookPage.waitForKernelIdle (app/page/notebook-page.ts:121:15)\n      at NotebookPage.isLoaded (app/page/notebook-page.ts:48:5)\n      at NotebookPage.waitForLoad (app/page/authenticated-page.ts:35:5)\n      at WorkspaceAnalysisPage.createNotebook (app/page/workspace-analysis-page.ts:77:5)\n      at copyNotebookTest (tests/notebook/owner-copy-to-workspace.spec.ts:31:31)\n      at Object.<anonymous> (tests/notebook/owner-copy-to-workspace.spec.ts:75:5)", "author": "aweng98", "createdAt": "2020-10-27T14:42:41Z", "path": "e2e/app/page/notebook-page.ts", "diffHunk": "@@ -45,7 +45,7 @@ export default class NotebookPage extends AuthenticatedPage {\n \n   async isLoaded(): Promise<boolean> {\n     await waitForDocumentTitle(this.page, this.documentTitle);\n-    await this.waitForKernelIdle();\n+    await this.waitForKernelIdle(30000);", "originalCommit": "745eec730ea377b7083766372a21f0e5fee751a6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjk5NDYzOA==", "url": "https://github.com/all-of-us/workbench/pull/4214#discussion_r512994638", "bodyText": "I am ok with this fix in this PR - do we know the upper limit where we want to fail here? Is it at 30s? Or would waiting for the browser default timeout be ok?", "author": "petesantos", "createdAt": "2020-10-27T20:02:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjc1MjA2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzAwMzUwMQ==", "url": "https://github.com/all-of-us/workbench/pull/4214#discussion_r513003501", "bodyText": "30 seconds is a tryout. hopefully good enough. I don't want to start with a bigger timeout unless it's absolutely necessary. I would think 60 seconds is the upper limit.", "author": "aweng98", "createdAt": "2020-10-27T20:18:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjc1MjA2OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjc1MzUyMw==", "url": "https://github.com/all-of-us/workbench/pull/4214#discussion_r512753523", "bodyText": "reduces concurrent threads to 2 to deal with flaky tests.", "author": "aweng98", "createdAt": "2020-10-27T14:44:20Z", "path": "e2e/package.json", "diffHunk": "@@ -13,7 +13,7 @@\n     \"test-local:debug\": \"cross-env WORKBENCH_ENV=local PUPPETEER_HEADLESS=false DEBUG=true jest --maxWorkers=3\",\n     \"test-staging\": \"cross-env WORKBENCH_ENV=staging jest --maxWorkers=3\",\n     \"test-staging:debug\": \"cross-env WORKBENCH_ENV=staging PUPPETEER_HEADLESS=false DEBUG=true jest --maxWorkers=1\",\n-    \"test:ci\": \"jest --ci --maxWorkers=3\",\n+    \"test:ci\": \"jest --ci --maxWorkers=2\",", "originalCommit": "745eec730ea377b7083766372a21f0e5fee751a6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjk5NDY5NA==", "url": "https://github.com/all-of-us/workbench/pull/4214#discussion_r512994694", "bodyText": "I am ok with the change - is it well understood why more max workers causes an issue?", "author": "petesantos", "createdAt": "2020-10-27T20:02:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjc1MzUyMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzAwNzIxNw==", "url": "https://github.com/all-of-us/workbench/pull/4214#discussion_r513007217", "bodyText": "Puppeteer troubleshooting tip: https://developers.google.com/web/tools/puppeteer/troubleshooting?hl=ja#running_puppeteer_on_circleci", "author": "aweng98", "createdAt": "2020-10-27T20:25:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjc1MzUyMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjc1NzkxNw==", "url": "https://github.com/all-of-us/workbench/pull/4214#discussion_r512757917", "bodyText": "exclude a recently (don't know when) added spinner.\n\nTest failed in https://app.circleci.com/pipelines/github/all-of-us/workbench/5308/workflows/0b6cbff1-128e-49da-a3d4-d53c4786f7f1/jobs/106906/tests\nstacktrace:\nFAIL  tests/cohorts/cohorts-create.spec.ts (152.837 s)\n  User can create new Cohorts\n    \u2715 Add Cohort of Physical Measurements BMI (107149 ms)\n    \u25cb skipped Add Cohort of EKG condition with modifiers\n\n  \u25cf User can create new Cohorts \u203a Add Cohort of Physical Measurements BMI\n\n    TimeoutError: waiting for function failed: timeout 90000ms exceeded\n\n      273 | \n      274 |   // Wait for spinners stop and gone.\n    > 275 |   await page.waitForFunction((css) => {\n          |              ^\n      276 |     const elements = document.querySelectorAll(css);\n      277 |     return elements && elements.length === 0;\n      278 |   }, {polling: 'mutation', timeout: timeOut}, spinElementsSelector);\n\n      at new WaitTask (node_modules/puppeteer/lib/cjs/puppeteer/common/DOMWorld.js:394:34)\n      at DOMWorld.waitForFunction (node_modules/puppeteer/lib/cjs/puppeteer/common/DOMWorld.js:316:16)\n      at Frame.waitForFunction (node_modules/puppeteer/lib/cjs/puppeteer/common/FrameManager.js:869:32)\n      at Page.waitForFunction (node_modules/puppeteer/lib/cjs/puppeteer/common/Page.js:1221:33)\n      at Object.waitWhileLoading (utils/waits-utils.ts:275:14)", "author": "aweng98", "createdAt": "2020-10-27T14:49:30Z", "path": "e2e/utils/waits-utils.ts", "diffHunk": "@@ -263,7 +263,7 @@ export async function waitForText(page: Page,\n  */\n export async function waitWhileLoading(page: Page, timeOut: number = 90000): Promise<void> {\n   const notBlankPageSelector = '[data-test-id=\"sign-in-container\"], title:not(empty), div.spinner, svg[viewBox]';\n-  const spinElementsSelector = '[style*=\"running spin\"], .spinner:empty, [style*=\"running rotation\"]';\n+  const spinElementsSelector = '[style*=\"running spin\"], .spinner:empty, svg[style*=\"running rotation\"]:not([aria-hidden=\"true\"])';", "originalCommit": "745eec730ea377b7083766372a21f0e5fee751a6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}