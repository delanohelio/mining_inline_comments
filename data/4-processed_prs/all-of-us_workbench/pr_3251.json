{"pr_number": 3251, "pr_title": "[RW-4524][RW-4525][RW-4523][risk=low] Account creation UI for institutional affiliation", "pr_createdAt": "2020-03-13T02:35:33Z", "pr_url": "https://github.com/all-of-us/workbench/pull/3251", "timeline": [{"oid": "967b3bf1d4f280d926ece19029b66402d5945505", "url": "https://github.com/all-of-us/workbench/commit/967b3bf1d4f280d926ece19029b66402d5945505", "message": "WIP new form for institution & contact email.", "committedDate": "2020-03-12T13:25:18Z", "type": "commit"}, {"oid": "ebbed3a3206a1fad0387de3af3612fb9dcc5d60f", "url": "https://github.com/all-of-us/workbench/commit/ebbed3a3206a1fad0387de3af3612fb9dcc5d60f", "message": "Checkpoint, testing still WIP", "committedDate": "2020-03-12T13:25:18Z", "type": "commit"}, {"oid": "d35c637427f9524a466c36497c7fc77fbdd75894", "url": "https://github.com/all-of-us/workbench/commit/d35c637427f9524a466c36497c7fc77fbdd75894", "message": "Wrap up institution form tests.", "committedDate": "2020-03-12T18:56:30Z", "type": "commit"}, {"oid": "0f45eb4b759efab906761da0fa2d9e570a5cd4fc", "url": "https://github.com/all-of-us/workbench/commit/0f45eb4b759efab906761da0fa2d9e570a5cd4fc", "message": "Finish unit tests.", "committedDate": "2020-03-13T02:23:22Z", "type": "commit"}, {"oid": "8973b350ee3c15a92a39d062f13f38a85fc8be47", "url": "https://github.com/all-of-us/workbench/commit/8973b350ee3c15a92a39d062f13f38a85fc8be47", "message": "Unit test fixes.", "committedDate": "2020-03-13T02:43:49Z", "type": "commit"}, {"oid": "3af0cca693be3693422f0ff71e3246c38b5d34a6", "url": "https://github.com/all-of-us/workbench/commit/3af0cca693be3693422f0ff71e3246c38b5d34a6", "message": "Lint fixes", "committedDate": "2020-03-13T10:37:58Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjI0NzI0OQ==", "url": "https://github.com/all-of-us/workbench/pull/3251#discussion_r392247249", "bodyText": "If we are going to set this to true on local, we should probably do it on test too, just to match.", "author": "s-rubenstein", "createdAt": "2020-03-13T14:04:06Z", "path": "api/config/config_local.json", "diffHunk": "@@ -94,7 +94,7 @@\n     \"useKeylessDelegatedCredentials\": true,\n     \"sendFreeTierAlertEmails\": false,\n     \"enableMoodleV2Api\": true,\n-    \"requireInstitutionalVerification\": false,\n+    \"requireInstitutionalVerification\": true,", "originalCommit": "3af0cca693be3693422f0ff71e3246c38b5d34a6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjI3NzIxMw==", "url": "https://github.com/all-of-us/workbench/pull/3251#discussion_r392277213", "bodyText": "Good catch \u2013 I'd meant to do that but forgot. Done.", "author": "gjuggler", "createdAt": "2020-03-13T14:53:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjI0NzI0OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjI1NTkwNA==", "url": "https://github.com/all-of-us/workbench/pull/3251#discussion_r392255904", "bodyText": "Nit: I might move these up to be with the other helper functions, because they kinda shook me being in the middle of the test cases.", "author": "s-rubenstein", "createdAt": "2020-03-13T14:19:01Z", "path": "ui/src/app/pages/login/account-creation/account-creation-institution.spec.tsx", "diffHunk": "@@ -0,0 +1,151 @@\n+import {mount, ReactWrapper, ShallowWrapper} from 'enzyme';\n+import * as React from 'react';\n+\n+import {serverConfigStore} from 'app/utils/navigation';\n+import {ConfigApi, InstitutionApi, Profile} from 'generated/fetch';\n+import {createEmptyProfile} from 'app/pages/login/sign-in';\n+import {AccountCreationInstitution, Props} from './account-creation-institution';\n+import {ConfigApiStub} from 'testing/stubs/config-api-stub';\n+import {InstitutionApiStub} from 'testing/stubs/institution-api-stub';\n+import {registerApiClient} from 'app/services/swagger-fetch-clients';\n+import defaultServerConfig from 'testing/default-server-config';\n+import {institutionApi} from 'app/services/swagger-fetch-clients';\n+import SpyInstance = jest.SpyInstance;\n+import {Dropdown} from 'primereact/dropdown';\n+import {waitOneTickAndUpdate} from 'testing/react-test-helpers';\n+import {defaultInstitutions} from 'testing/stubs/institution-api-stub';\n+import {InstitutionalRole} from 'generated/fetch';\n+import {AccountCreationOptions} from 'app/pages/login/account-creation/account-creation-options';\n+\n+let mockGetPublicInstitutionDetails: SpyInstance;\n+\n+type AnyWrapper = (ShallowWrapper|ReactWrapper);\n+\n+let props: Props;\n+function component(): ReactWrapper {\n+  return mount(<AccountCreationInstitution {...props}/>);\n+}\n+\n+function getInstitutionDropdown(wrapper: AnyWrapper): Dropdown {\n+  return wrapper.find('Dropdown[data-test-id=\"institution-dropdown\"]').instance() as Dropdown;\n+}\n+\n+function getEmailInput(wrapper: AnyWrapper): AnyWrapper {\n+  return wrapper.find('[data-test-id=\"contact-email\"]').hostNodes();\n+}\n+\n+function getRoleDropdown(wrapper: AnyWrapper): Dropdown {\n+  return wrapper.find('Dropdown[data-test-id=\"role-dropdown\"]').instance() as Dropdown;\n+}\n+\n+function getSubmitButton(wrapper: AnyWrapper): AnyWrapper {\n+  return wrapper.find('[data-test-id=\"submit-button\"]');\n+}\n+\n+\n+beforeEach(() => {\n+  serverConfigStore.next(defaultServerConfig);\n+  registerApiClient(ConfigApi, new ConfigApiStub());\n+  registerApiClient(InstitutionApi, new InstitutionApiStub());\n+\n+  props = {\n+    profile: createEmptyProfile(true),\n+    onComplete: (profile: Profile) => {},\n+    onPreviousClick: (profile: Profile) => {}\n+  };\n+\n+  mockGetPublicInstitutionDetails = jest.spyOn(institutionApi(), 'getPublicInstitutionDetails');\n+});\n+\n+it('should render', async() => {\n+  const wrapper = component();\n+  expect(wrapper.exists()).toBeTruthy();\n+});\n+\n+it('should load institutions list', async() => {\n+  const wrapper = component();\n+  await waitOneTickAndUpdate(wrapper);\n+\n+  expect(mockGetPublicInstitutionDetails).toHaveBeenCalled();\n+\n+  const options = getInstitutionDropdown(wrapper).props.options as Array<Object>;\n+  expect(options.length).toEqual(defaultInstitutions.length);\n+});\n+\n+it('should show user-facing error message on data load error', async() => {\n+  mockGetPublicInstitutionDetails.mockRejectedValueOnce(new Response(null, {status: 500}));\n+  const wrapper = component();\n+  await waitOneTickAndUpdate(wrapper);\n+\n+  expect(wrapper.find('[data-test-id=\"data-load-error\"]').exists).toBeTruthy();\n+});\n+\n+const academicSpecificOption = AccountCreationOptions.institutionalRoleOptions.find(", "originalCommit": "3af0cca693be3693422f0ff71e3246c38b5d34a6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjI3NzMxMQ==", "url": "https://github.com/all-of-us/workbench/pull/3251#discussion_r392277311", "bodyText": "Done!", "author": "gjuggler", "createdAt": "2020-03-13T14:53:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjI1NTkwNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjI1OTgxOQ==", "url": "https://github.com/all-of-us/workbench/pull/3251#discussion_r392259819", "bodyText": "I would very strongly push for putting this into a true component, and I think it would be relatively low effort, considering it seems to already be pretty factored out. Would it be possible to do that within this PR?", "author": "s-rubenstein", "createdAt": "2020-03-13T14:25:12Z", "path": "ui/src/app/pages/login/account-creation/account-creation-institution.tsx", "diffHunk": "@@ -0,0 +1,330 @@\n+import * as fp from 'lodash/fp';\n+import * as React from 'react';\n+import * as validate from 'validate.js';\n+\n+import {Button} from 'app/components/buttons';\n+import {FlexColumn, FlexRow} from 'app/components/flex';\n+import {FormSection} from 'app/components/forms';\n+import {Error as ErrorDiv, TextInput} from 'app/components/inputs';\n+import {TooltipTrigger} from 'app/components/popups';\n+import {SpinnerOverlay} from 'app/components/spinners';\n+import {AccountCreationOptions} from 'app/pages/login/account-creation/account-creation-options';\n+import {WhyWillSomeInformationBePublic} from 'app/pages/login/account-creation/common-content';\n+import {commonStyles} from 'app/pages/login/account-creation/common-styles';\n+import {institutionApi} from 'app/services/swagger-fetch-clients';\n+import colors from 'app/styles/colors';\n+import {isBlank, reactStyles} from 'app/utils';\n+import {reportError} from 'app/utils/errors';\n+import {\n+  InstitutionalRole,\n+  Profile,\n+  PublicInstitutionDetails,\n+} from 'generated/fetch';\n+import {Dropdown} from 'primereact/dropdown';\n+\n+const styles = reactStyles({\n+  ...commonStyles,\n+  publiclyDisplayedText: {\n+    fontSize: 12,\n+    fontWeight: 400\n+  },\n+  sectionInput: {\n+    width: '14rem',\n+    height: '1.5rem'\n+  },\n+  text: {\n+    fontSize: 14,\n+    color: colors.primary,\n+    lineHeight: '22px',\n+  }\n+});\n+\n+// TODO: this is copy-pasted from account-creation.tsx. Consider factoring this into a true component.\n+function TextInputWithLabel(props) {", "originalCommit": "3af0cca693be3693422f0ff71e3246c38b5d34a6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjMzMzU1MQ==", "url": "https://github.com/all-of-us/workbench/pull/3251#discussion_r392333551", "bodyText": "Thanks for the prod \u2013 I merged this and the other common files into a single common.tsx, which feels right.", "author": "gjuggler", "createdAt": "2020-03-13T16:23:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjI1OTgxOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjI2MjYwMA==", "url": "https://github.com/all-of-us/workbench/pull/3251#discussion_r392262600", "bodyText": "Would it be possible to fold the marginLeft: '0.2rem' into a style object? This is the second place it is used.", "author": "s-rubenstein", "createdAt": "2020-03-13T14:29:33Z", "path": "ui/src/app/pages/login/account-creation/account-creation-institution.tsx", "diffHunk": "@@ -0,0 +1,330 @@\n+import * as fp from 'lodash/fp';\n+import * as React from 'react';\n+import * as validate from 'validate.js';\n+\n+import {Button} from 'app/components/buttons';\n+import {FlexColumn, FlexRow} from 'app/components/flex';\n+import {FormSection} from 'app/components/forms';\n+import {Error as ErrorDiv, TextInput} from 'app/components/inputs';\n+import {TooltipTrigger} from 'app/components/popups';\n+import {SpinnerOverlay} from 'app/components/spinners';\n+import {AccountCreationOptions} from 'app/pages/login/account-creation/account-creation-options';\n+import {WhyWillSomeInformationBePublic} from 'app/pages/login/account-creation/common-content';\n+import {commonStyles} from 'app/pages/login/account-creation/common-styles';\n+import {institutionApi} from 'app/services/swagger-fetch-clients';\n+import colors from 'app/styles/colors';\n+import {isBlank, reactStyles} from 'app/utils';\n+import {reportError} from 'app/utils/errors';\n+import {\n+  InstitutionalRole,\n+  Profile,\n+  PublicInstitutionDetails,\n+} from 'generated/fetch';\n+import {Dropdown} from 'primereact/dropdown';\n+\n+const styles = reactStyles({\n+  ...commonStyles,\n+  publiclyDisplayedText: {\n+    fontSize: 12,\n+    fontWeight: 400\n+  },\n+  sectionInput: {\n+    width: '14rem',\n+    height: '1.5rem'\n+  },\n+  text: {\n+    fontSize: 14,\n+    color: colors.primary,\n+    lineHeight: '22px',\n+  }\n+});\n+\n+// TODO: this is copy-pasted from account-creation.tsx. Consider factoring this into a true component.\n+function TextInputWithLabel(props) {\n+  return <div style={{width: '12rem', ...props.containerStyle}}>\n+    {props.labelContent}\n+    {props.labelText && <label style={{...styles.text, fontWeight: 600}}>{props.labelText}</label>}\n+    <div style={{marginTop: '0.1rem'}}>\n+      <TextInput data-test-id={props.inputId}\n+                 id={props.inputId}\n+                 name={props.inputName}\n+                 placeholder={props.placeholder}\n+                 value={props.value}\n+                 disabled={props.disabled}\n+                 onChange={props.onChange}\n+                 onBlur={props.onBlur}\n+                 invalid={props.invalid ? props.invalid.toString() : undefined}\n+                 style={{...styles.sectionInput, ...props.inputStyle}}/>\n+      {props.children}\n+    </div>\n+  </div>;\n+}\n+\n+export interface Props {\n+  profile: Profile;\n+  onComplete: (profile: Profile) => void;\n+  onPreviousClick: (profile: Profile) => void;\n+}\n+\n+\n+interface State {\n+  profile: Profile;\n+  emailFailedValidation: boolean;\n+  loadingInstitutions: boolean;\n+  institutions: Array<PublicInstitutionDetails>;\n+  dataLoadError: boolean;\n+}\n+\n+export class AccountCreationInstitution extends React.Component<Props, State> {\n+  constructor(props: Props) {\n+    super(props);\n+    this.state = {\n+      profile: props.profile,\n+      emailFailedValidation: false,\n+      institutions: [],\n+      loadingInstitutions: true,\n+      dataLoadError: false,\n+    };\n+  }\n+\n+  async componentDidMount() {\n+    try {\n+      const details = await institutionApi().getPublicInstitutionDetails();\n+      this.setState({\n+        loadingInstitutions: false,\n+        institutions: details.institutions\n+      });\n+    } catch (e) {\n+      this.setState({\n+        loadingInstitutions: false,\n+        dataLoadError: true\n+      });\n+      reportError(e);\n+    }\n+  }\n+\n+  validateContactEmailInline() {\n+    const {profile: { contactEmail } } = this.state;\n+\n+    if (isBlank(contactEmail)) {\n+      // Allow a blank email to pass inline validation: it will still block overall form\n+      // submission via the validate() config below.\n+      this.setState({emailFailedValidation: false});\n+      return;\n+    }\n+\n+    const result = validate.single(contactEmail, { email: true } );\n+    if (result === undefined) {\n+      this.setState({emailFailedValidation: false});\n+    } else {\n+      this.setState({emailFailedValidation: true});\n+    }\n+  }\n+\n+  updateContactEmail(contactEmail: string) {\n+    this.setState({emailFailedValidation: false});\n+    this.setState(fp.set(['profile', 'contactEmail'], contactEmail));\n+  }\n+\n+  // Visible for testing.\n+  public validate(): {[key: string]: Array<string>} {\n+    const validationCheck = {\n+      'verifiedInstitutionalAffiliation.institutionShortName': {\n+        presence: {\n+          allowEmpty: false,\n+          message: '^You must select an institution to continue',\n+        }\n+      },\n+      contactEmail: {\n+        presence: {\n+          allowEmpty: false,\n+          message: '^Email address cannot be blank',\n+        },\n+        email: {\n+          message: '^Email address is invalid'\n+        }\n+      },\n+      'verifiedInstitutionalAffiliation.institutionalRoleEnum': {\n+        presence: {\n+          allowEmpty: false,\n+          message: '^Institutional role cannot be blank',\n+        }\n+      },\n+    };\n+    if (this.state.profile.verifiedInstitutionalAffiliation.institutionalRoleEnum === InstitutionalRole.OTHER) {\n+      validationCheck['verifiedInstitutionalAffiliation.institutionalRoleOtherText'] = {\n+        presence: {\n+          allowEmpty: false,\n+          message: '^Institutional role text cannot be blank',\n+        }\n+      };\n+    }\n+\n+    return validate(this.state.profile, validationCheck);\n+  }\n+\n+  getRoleOptions(): Array<{label: string, value: InstitutionalRole}> {\n+    const {institutions, profile: {verifiedInstitutionalAffiliation: {institutionShortName}}} = this.state;\n+    if (isBlank(institutionShortName)) {\n+      return [];\n+    }\n+\n+    const selectedOrgType = institutions.find(\n+      inst => inst.shortName === institutionShortName).organizationTypeEnum;\n+    const availableRoles: Array<InstitutionalRole> =\n+      AccountCreationOptions.institutionalRolesByOrganizationType\n+      .find(obj => obj.type === selectedOrgType)\n+        .roles;\n+\n+    return AccountCreationOptions.institutionalRoleOptions.filter(option =>\n+      availableRoles.includes(option.value)\n+    );\n+  }\n+\n+  updateAffiliationValue(attribute: string, value) {\n+    this.setState(fp.set(['profile', 'verifiedInstitutionalAffiliation', attribute], value));\n+  }\n+\n+  render() {\n+    const {\n+      loadingInstitutions,\n+      institutions,\n+      profile: {\n+        contactEmail,\n+        verifiedInstitutionalAffiliation: {\n+          institutionShortName, institutionalRoleEnum, institutionalRoleOtherText,\n+        }\n+      }\n+    } = this.state;\n+\n+    const errors = this.validate();\n+\n+    return <div id='account-creation-institution'\n+                style={{paddingTop: '1.5rem', paddingRight: '3rem', paddingLeft: '3rem'}}>\n+      <div style={{fontSize: 28, fontWeight: 400, color: colors.primary}}>Create your account</div>\n+      <FlexRow>\n+        <FlexColumn style={{marginTop: '0.5rem', marginRight: '2rem'}}>\n+          <div style={{...styles.text, fontSize: 16, marginTop: '1rem'}}>\n+            Please complete Step 1 of 3\n+          </div>\n+          <div style={{...styles.text, fontSize: 14, marginTop: '0.7rem'}}>\n+            For access to the <i>All of Us</i> Research Program data, your institution needs to have signed a Data Use Agreement\n+            with the program. The institutions listed below have an Institutional Data Use Agreement with the program that\n+            enables us to provide their researchers with access to the Workbench.\n+          </div>\n+          <div style={{...styles.text, fontSize: 12, marginTop: '0.5rem'}}>\n+            All fields are required.\n+          </div>\n+          {loadingInstitutions && <SpinnerOverlay />}\n+          {!loadingInstitutions && <div style={{marginTop: '.5rem'}}>\n+            <label style={{...styles.text, fontWeight: 600}}>\n+              Select your institution\n+              <i style={{...styles.publiclyDisplayedText, marginLeft: '0.2rem'}}>\n+                Publicly displayed\n+              </i>\n+            </label>\n+            <div style={{...styles.text, fontSize: 14}}>\n+              Your institution will be notified that you have registered using your institutional credentials.\n+            </div>\n+            <Dropdown\n+                data-test-id='institution-dropdown'\n+                style={{width: '50%', minWidth: '600px'}}\n+                options={institutions.map(inst => ({'value': inst.shortName, 'label': inst.displayName}))}\n+                value={institutionShortName}\n+                onChange={(e) => {\n+                  this.updateAffiliationValue('institutionShortName', e.value);\n+                  // Clear out any existing values for role when the institution changes.\n+                  this.updateAffiliationValue('institutionalRoleEnum', undefined);\n+                  this.updateAffiliationValue('institutionalRoleOtherText', undefined);\n+                }}/>\n+            {this.state.dataLoadError &&\n+            <ErrorDiv data-test-id='data-load-error'>\n+              An error occurred loading the institution list. Please try again or contact\n+              <a href='mailto:support@researchallofus.org'>support@researchallofus.org</a>.\n+            </ErrorDiv>\n+            }\n+            <div style={{marginTop: '.5rem'}}>\n+              <a href={'https://www.researchallofus.org/apply/'} target='_blank' style={{color: colors.accent}}>\n+              Don't see your institution listed?\n+              </a>\n+            </div>\n+            <TextInputWithLabel containerStyle={{marginTop: '1rem', width: null}}\n+                                value={contactEmail}\n+                                inputId='contact-email'\n+                                inputName='contactEmail'\n+                                labelContent={<div>\n+                                  <label style={{...styles.text, fontWeight: 600}}>\n+                                    Your institutional email address\n+                                  </label>\n+                                  <div style={{...styles.text, fontSize: 14}}>\n+                                    This will be the primary email contact for your new account.\n+                                  </div>\n+                                </div>}\n+                                invalid={this.state.emailFailedValidation}\n+                                onBlur={() => this.validateContactEmailInline()}\n+                                onChange={email => this.updateContactEmail(email)}/>\n+            {this.state.emailFailedValidation &&\n+              <ErrorDiv data-test-id='invalid-email-error'>\n+                Error: email address is invalid\n+              </ErrorDiv>\n+            }\n+            <div style={{marginTop: '.5rem'}}>\n+              <label style={{...styles.text, fontWeight: 600, marginTop: '1rem'}}>\n+                Which of the following best describes your role?\n+                <i style={{...styles.publiclyDisplayedText, marginLeft: '0.2rem'}}>", "originalCommit": "3af0cca693be3693422f0ff71e3246c38b5d34a6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjM2MjMxOQ==", "url": "https://github.com/all-of-us/workbench/pull/3251#discussion_r392362319", "bodyText": "I'll punt on this one \u2013\u00a0the margins in this form are pretty haphazard, I wouldn't really know how to name such a style object.", "author": "gjuggler", "createdAt": "2020-03-13T17:13:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjI2MjYwMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjM3MjgyNA==", "url": "https://github.com/all-of-us/workbench/pull/3251#discussion_r392372824", "bodyText": "Sounds reasonable. TOL, since we have this a couple places in the account creation area, we could make a sub component for this, but I am okay punting on that.", "author": "s-rubenstein", "createdAt": "2020-03-13T17:32:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjI2MjYwMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjI2Mjc4Mg==", "url": "https://github.com/all-of-us/workbench/pull/3251#discussion_r392262782", "bodyText": "Can this be a style object? It is used multiple times", "author": "s-rubenstein", "createdAt": "2020-03-13T14:29:50Z", "path": "ui/src/app/pages/login/account-creation/account-creation-institution.tsx", "diffHunk": "@@ -0,0 +1,330 @@\n+import * as fp from 'lodash/fp';\n+import * as React from 'react';\n+import * as validate from 'validate.js';\n+\n+import {Button} from 'app/components/buttons';\n+import {FlexColumn, FlexRow} from 'app/components/flex';\n+import {FormSection} from 'app/components/forms';\n+import {Error as ErrorDiv, TextInput} from 'app/components/inputs';\n+import {TooltipTrigger} from 'app/components/popups';\n+import {SpinnerOverlay} from 'app/components/spinners';\n+import {AccountCreationOptions} from 'app/pages/login/account-creation/account-creation-options';\n+import {WhyWillSomeInformationBePublic} from 'app/pages/login/account-creation/common-content';\n+import {commonStyles} from 'app/pages/login/account-creation/common-styles';\n+import {institutionApi} from 'app/services/swagger-fetch-clients';\n+import colors from 'app/styles/colors';\n+import {isBlank, reactStyles} from 'app/utils';\n+import {reportError} from 'app/utils/errors';\n+import {\n+  InstitutionalRole,\n+  Profile,\n+  PublicInstitutionDetails,\n+} from 'generated/fetch';\n+import {Dropdown} from 'primereact/dropdown';\n+\n+const styles = reactStyles({\n+  ...commonStyles,\n+  publiclyDisplayedText: {\n+    fontSize: 12,\n+    fontWeight: 400\n+  },\n+  sectionInput: {\n+    width: '14rem',\n+    height: '1.5rem'\n+  },\n+  text: {\n+    fontSize: 14,\n+    color: colors.primary,\n+    lineHeight: '22px',\n+  }\n+});\n+\n+// TODO: this is copy-pasted from account-creation.tsx. Consider factoring this into a true component.\n+function TextInputWithLabel(props) {\n+  return <div style={{width: '12rem', ...props.containerStyle}}>\n+    {props.labelContent}\n+    {props.labelText && <label style={{...styles.text, fontWeight: 600}}>{props.labelText}</label>}\n+    <div style={{marginTop: '0.1rem'}}>\n+      <TextInput data-test-id={props.inputId}\n+                 id={props.inputId}\n+                 name={props.inputName}\n+                 placeholder={props.placeholder}\n+                 value={props.value}\n+                 disabled={props.disabled}\n+                 onChange={props.onChange}\n+                 onBlur={props.onBlur}\n+                 invalid={props.invalid ? props.invalid.toString() : undefined}\n+                 style={{...styles.sectionInput, ...props.inputStyle}}/>\n+      {props.children}\n+    </div>\n+  </div>;\n+}\n+\n+export interface Props {\n+  profile: Profile;\n+  onComplete: (profile: Profile) => void;\n+  onPreviousClick: (profile: Profile) => void;\n+}\n+\n+\n+interface State {\n+  profile: Profile;\n+  emailFailedValidation: boolean;\n+  loadingInstitutions: boolean;\n+  institutions: Array<PublicInstitutionDetails>;\n+  dataLoadError: boolean;\n+}\n+\n+export class AccountCreationInstitution extends React.Component<Props, State> {\n+  constructor(props: Props) {\n+    super(props);\n+    this.state = {\n+      profile: props.profile,\n+      emailFailedValidation: false,\n+      institutions: [],\n+      loadingInstitutions: true,\n+      dataLoadError: false,\n+    };\n+  }\n+\n+  async componentDidMount() {\n+    try {\n+      const details = await institutionApi().getPublicInstitutionDetails();\n+      this.setState({\n+        loadingInstitutions: false,\n+        institutions: details.institutions\n+      });\n+    } catch (e) {\n+      this.setState({\n+        loadingInstitutions: false,\n+        dataLoadError: true\n+      });\n+      reportError(e);\n+    }\n+  }\n+\n+  validateContactEmailInline() {\n+    const {profile: { contactEmail } } = this.state;\n+\n+    if (isBlank(contactEmail)) {\n+      // Allow a blank email to pass inline validation: it will still block overall form\n+      // submission via the validate() config below.\n+      this.setState({emailFailedValidation: false});\n+      return;\n+    }\n+\n+    const result = validate.single(contactEmail, { email: true } );\n+    if (result === undefined) {\n+      this.setState({emailFailedValidation: false});\n+    } else {\n+      this.setState({emailFailedValidation: true});\n+    }\n+  }\n+\n+  updateContactEmail(contactEmail: string) {\n+    this.setState({emailFailedValidation: false});\n+    this.setState(fp.set(['profile', 'contactEmail'], contactEmail));\n+  }\n+\n+  // Visible for testing.\n+  public validate(): {[key: string]: Array<string>} {\n+    const validationCheck = {\n+      'verifiedInstitutionalAffiliation.institutionShortName': {\n+        presence: {\n+          allowEmpty: false,\n+          message: '^You must select an institution to continue',\n+        }\n+      },\n+      contactEmail: {\n+        presence: {\n+          allowEmpty: false,\n+          message: '^Email address cannot be blank',\n+        },\n+        email: {\n+          message: '^Email address is invalid'\n+        }\n+      },\n+      'verifiedInstitutionalAffiliation.institutionalRoleEnum': {\n+        presence: {\n+          allowEmpty: false,\n+          message: '^Institutional role cannot be blank',\n+        }\n+      },\n+    };\n+    if (this.state.profile.verifiedInstitutionalAffiliation.institutionalRoleEnum === InstitutionalRole.OTHER) {\n+      validationCheck['verifiedInstitutionalAffiliation.institutionalRoleOtherText'] = {\n+        presence: {\n+          allowEmpty: false,\n+          message: '^Institutional role text cannot be blank',\n+        }\n+      };\n+    }\n+\n+    return validate(this.state.profile, validationCheck);\n+  }\n+\n+  getRoleOptions(): Array<{label: string, value: InstitutionalRole}> {\n+    const {institutions, profile: {verifiedInstitutionalAffiliation: {institutionShortName}}} = this.state;\n+    if (isBlank(institutionShortName)) {\n+      return [];\n+    }\n+\n+    const selectedOrgType = institutions.find(\n+      inst => inst.shortName === institutionShortName).organizationTypeEnum;\n+    const availableRoles: Array<InstitutionalRole> =\n+      AccountCreationOptions.institutionalRolesByOrganizationType\n+      .find(obj => obj.type === selectedOrgType)\n+        .roles;\n+\n+    return AccountCreationOptions.institutionalRoleOptions.filter(option =>\n+      availableRoles.includes(option.value)\n+    );\n+  }\n+\n+  updateAffiliationValue(attribute: string, value) {\n+    this.setState(fp.set(['profile', 'verifiedInstitutionalAffiliation', attribute], value));\n+  }\n+\n+  render() {\n+    const {\n+      loadingInstitutions,\n+      institutions,\n+      profile: {\n+        contactEmail,\n+        verifiedInstitutionalAffiliation: {\n+          institutionShortName, institutionalRoleEnum, institutionalRoleOtherText,\n+        }\n+      }\n+    } = this.state;\n+\n+    const errors = this.validate();\n+\n+    return <div id='account-creation-institution'\n+                style={{paddingTop: '1.5rem', paddingRight: '3rem', paddingLeft: '3rem'}}>\n+      <div style={{fontSize: 28, fontWeight: 400, color: colors.primary}}>Create your account</div>\n+      <FlexRow>\n+        <FlexColumn style={{marginTop: '0.5rem', marginRight: '2rem'}}>\n+          <div style={{...styles.text, fontSize: 16, marginTop: '1rem'}}>\n+            Please complete Step 1 of 3\n+          </div>\n+          <div style={{...styles.text, fontSize: 14, marginTop: '0.7rem'}}>\n+            For access to the <i>All of Us</i> Research Program data, your institution needs to have signed a Data Use Agreement\n+            with the program. The institutions listed below have an Institutional Data Use Agreement with the program that\n+            enables us to provide their researchers with access to the Workbench.\n+          </div>\n+          <div style={{...styles.text, fontSize: 12, marginTop: '0.5rem'}}>\n+            All fields are required.\n+          </div>\n+          {loadingInstitutions && <SpinnerOverlay />}\n+          {!loadingInstitutions && <div style={{marginTop: '.5rem'}}>\n+            <label style={{...styles.text, fontWeight: 600}}>\n+              Select your institution\n+              <i style={{...styles.publiclyDisplayedText, marginLeft: '0.2rem'}}>\n+                Publicly displayed\n+              </i>\n+            </label>\n+            <div style={{...styles.text, fontSize: 14}}>\n+              Your institution will be notified that you have registered using your institutional credentials.\n+            </div>\n+            <Dropdown\n+                data-test-id='institution-dropdown'\n+                style={{width: '50%', minWidth: '600px'}}", "originalCommit": "3af0cca693be3693422f0ff71e3246c38b5d34a6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjM1Nzc5Nw==", "url": "https://github.com/all-of-us/workbench/pull/3251#discussion_r392357797", "bodyText": "Done", "author": "gjuggler", "createdAt": "2020-03-13T17:04:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjI2Mjc4Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjI2MzUyMQ==", "url": "https://github.com/all-of-us/workbench/pull/3251#discussion_r392263521", "bodyText": "TOL: I wonder if we should consider making this a helper function, since we use this pattern a decent amount.", "author": "s-rubenstein", "createdAt": "2020-03-13T14:30:59Z", "path": "ui/src/app/pages/login/account-creation/account-creation-institution.tsx", "diffHunk": "@@ -0,0 +1,330 @@\n+import * as fp from 'lodash/fp';\n+import * as React from 'react';\n+import * as validate from 'validate.js';\n+\n+import {Button} from 'app/components/buttons';\n+import {FlexColumn, FlexRow} from 'app/components/flex';\n+import {FormSection} from 'app/components/forms';\n+import {Error as ErrorDiv, TextInput} from 'app/components/inputs';\n+import {TooltipTrigger} from 'app/components/popups';\n+import {SpinnerOverlay} from 'app/components/spinners';\n+import {AccountCreationOptions} from 'app/pages/login/account-creation/account-creation-options';\n+import {WhyWillSomeInformationBePublic} from 'app/pages/login/account-creation/common-content';\n+import {commonStyles} from 'app/pages/login/account-creation/common-styles';\n+import {institutionApi} from 'app/services/swagger-fetch-clients';\n+import colors from 'app/styles/colors';\n+import {isBlank, reactStyles} from 'app/utils';\n+import {reportError} from 'app/utils/errors';\n+import {\n+  InstitutionalRole,\n+  Profile,\n+  PublicInstitutionDetails,\n+} from 'generated/fetch';\n+import {Dropdown} from 'primereact/dropdown';\n+\n+const styles = reactStyles({\n+  ...commonStyles,\n+  publiclyDisplayedText: {\n+    fontSize: 12,\n+    fontWeight: 400\n+  },\n+  sectionInput: {\n+    width: '14rem',\n+    height: '1.5rem'\n+  },\n+  text: {\n+    fontSize: 14,\n+    color: colors.primary,\n+    lineHeight: '22px',\n+  }\n+});\n+\n+// TODO: this is copy-pasted from account-creation.tsx. Consider factoring this into a true component.\n+function TextInputWithLabel(props) {\n+  return <div style={{width: '12rem', ...props.containerStyle}}>\n+    {props.labelContent}\n+    {props.labelText && <label style={{...styles.text, fontWeight: 600}}>{props.labelText}</label>}\n+    <div style={{marginTop: '0.1rem'}}>\n+      <TextInput data-test-id={props.inputId}\n+                 id={props.inputId}\n+                 name={props.inputName}\n+                 placeholder={props.placeholder}\n+                 value={props.value}\n+                 disabled={props.disabled}\n+                 onChange={props.onChange}\n+                 onBlur={props.onBlur}\n+                 invalid={props.invalid ? props.invalid.toString() : undefined}\n+                 style={{...styles.sectionInput, ...props.inputStyle}}/>\n+      {props.children}\n+    </div>\n+  </div>;\n+}\n+\n+export interface Props {\n+  profile: Profile;\n+  onComplete: (profile: Profile) => void;\n+  onPreviousClick: (profile: Profile) => void;\n+}\n+\n+\n+interface State {\n+  profile: Profile;\n+  emailFailedValidation: boolean;\n+  loadingInstitutions: boolean;\n+  institutions: Array<PublicInstitutionDetails>;\n+  dataLoadError: boolean;\n+}\n+\n+export class AccountCreationInstitution extends React.Component<Props, State> {\n+  constructor(props: Props) {\n+    super(props);\n+    this.state = {\n+      profile: props.profile,\n+      emailFailedValidation: false,\n+      institutions: [],\n+      loadingInstitutions: true,\n+      dataLoadError: false,\n+    };\n+  }\n+\n+  async componentDidMount() {\n+    try {\n+      const details = await institutionApi().getPublicInstitutionDetails();\n+      this.setState({\n+        loadingInstitutions: false,\n+        institutions: details.institutions\n+      });\n+    } catch (e) {\n+      this.setState({\n+        loadingInstitutions: false,\n+        dataLoadError: true\n+      });\n+      reportError(e);\n+    }\n+  }\n+\n+  validateContactEmailInline() {\n+    const {profile: { contactEmail } } = this.state;\n+\n+    if (isBlank(contactEmail)) {\n+      // Allow a blank email to pass inline validation: it will still block overall form\n+      // submission via the validate() config below.\n+      this.setState({emailFailedValidation: false});\n+      return;\n+    }\n+\n+    const result = validate.single(contactEmail, { email: true } );\n+    if (result === undefined) {\n+      this.setState({emailFailedValidation: false});\n+    } else {\n+      this.setState({emailFailedValidation: true});\n+    }\n+  }\n+\n+  updateContactEmail(contactEmail: string) {\n+    this.setState({emailFailedValidation: false});\n+    this.setState(fp.set(['profile', 'contactEmail'], contactEmail));\n+  }\n+\n+  // Visible for testing.\n+  public validate(): {[key: string]: Array<string>} {\n+    const validationCheck = {\n+      'verifiedInstitutionalAffiliation.institutionShortName': {\n+        presence: {\n+          allowEmpty: false,\n+          message: '^You must select an institution to continue',\n+        }\n+      },\n+      contactEmail: {\n+        presence: {\n+          allowEmpty: false,\n+          message: '^Email address cannot be blank',\n+        },\n+        email: {\n+          message: '^Email address is invalid'\n+        }\n+      },\n+      'verifiedInstitutionalAffiliation.institutionalRoleEnum': {\n+        presence: {\n+          allowEmpty: false,\n+          message: '^Institutional role cannot be blank',\n+        }\n+      },\n+    };\n+    if (this.state.profile.verifiedInstitutionalAffiliation.institutionalRoleEnum === InstitutionalRole.OTHER) {\n+      validationCheck['verifiedInstitutionalAffiliation.institutionalRoleOtherText'] = {\n+        presence: {\n+          allowEmpty: false,\n+          message: '^Institutional role text cannot be blank',\n+        }\n+      };\n+    }\n+\n+    return validate(this.state.profile, validationCheck);\n+  }\n+\n+  getRoleOptions(): Array<{label: string, value: InstitutionalRole}> {\n+    const {institutions, profile: {verifiedInstitutionalAffiliation: {institutionShortName}}} = this.state;\n+    if (isBlank(institutionShortName)) {\n+      return [];\n+    }\n+\n+    const selectedOrgType = institutions.find(\n+      inst => inst.shortName === institutionShortName).organizationTypeEnum;\n+    const availableRoles: Array<InstitutionalRole> =\n+      AccountCreationOptions.institutionalRolesByOrganizationType\n+      .find(obj => obj.type === selectedOrgType)\n+        .roles;\n+\n+    return AccountCreationOptions.institutionalRoleOptions.filter(option =>\n+      availableRoles.includes(option.value)\n+    );\n+  }\n+\n+  updateAffiliationValue(attribute: string, value) {\n+    this.setState(fp.set(['profile', 'verifiedInstitutionalAffiliation', attribute], value));\n+  }\n+\n+  render() {\n+    const {\n+      loadingInstitutions,\n+      institutions,\n+      profile: {\n+        contactEmail,\n+        verifiedInstitutionalAffiliation: {\n+          institutionShortName, institutionalRoleEnum, institutionalRoleOtherText,\n+        }\n+      }\n+    } = this.state;\n+\n+    const errors = this.validate();\n+\n+    return <div id='account-creation-institution'\n+                style={{paddingTop: '1.5rem', paddingRight: '3rem', paddingLeft: '3rem'}}>\n+      <div style={{fontSize: 28, fontWeight: 400, color: colors.primary}}>Create your account</div>\n+      <FlexRow>\n+        <FlexColumn style={{marginTop: '0.5rem', marginRight: '2rem'}}>\n+          <div style={{...styles.text, fontSize: 16, marginTop: '1rem'}}>\n+            Please complete Step 1 of 3\n+          </div>\n+          <div style={{...styles.text, fontSize: 14, marginTop: '0.7rem'}}>\n+            For access to the <i>All of Us</i> Research Program data, your institution needs to have signed a Data Use Agreement\n+            with the program. The institutions listed below have an Institutional Data Use Agreement with the program that\n+            enables us to provide their researchers with access to the Workbench.\n+          </div>\n+          <div style={{...styles.text, fontSize: 12, marginTop: '0.5rem'}}>\n+            All fields are required.\n+          </div>\n+          {loadingInstitutions && <SpinnerOverlay />}\n+          {!loadingInstitutions && <div style={{marginTop: '.5rem'}}>\n+            <label style={{...styles.text, fontWeight: 600}}>\n+              Select your institution\n+              <i style={{...styles.publiclyDisplayedText, marginLeft: '0.2rem'}}>\n+                Publicly displayed\n+              </i>\n+            </label>\n+            <div style={{...styles.text, fontSize: 14}}>\n+              Your institution will be notified that you have registered using your institutional credentials.\n+            </div>\n+            <Dropdown\n+                data-test-id='institution-dropdown'\n+                style={{width: '50%', minWidth: '600px'}}\n+                options={institutions.map(inst => ({'value': inst.shortName, 'label': inst.displayName}))}\n+                value={institutionShortName}\n+                onChange={(e) => {\n+                  this.updateAffiliationValue('institutionShortName', e.value);\n+                  // Clear out any existing values for role when the institution changes.\n+                  this.updateAffiliationValue('institutionalRoleEnum', undefined);\n+                  this.updateAffiliationValue('institutionalRoleOtherText', undefined);\n+                }}/>\n+            {this.state.dataLoadError &&\n+            <ErrorDiv data-test-id='data-load-error'>\n+              An error occurred loading the institution list. Please try again or contact\n+              <a href='mailto:support@researchallofus.org'>support@researchallofus.org</a>.\n+            </ErrorDiv>\n+            }\n+            <div style={{marginTop: '.5rem'}}>\n+              <a href={'https://www.researchallofus.org/apply/'} target='_blank' style={{color: colors.accent}}>\n+              Don't see your institution listed?\n+              </a>\n+            </div>\n+            <TextInputWithLabel containerStyle={{marginTop: '1rem', width: null}}\n+                                value={contactEmail}\n+                                inputId='contact-email'\n+                                inputName='contactEmail'\n+                                labelContent={<div>\n+                                  <label style={{...styles.text, fontWeight: 600}}>\n+                                    Your institutional email address\n+                                  </label>\n+                                  <div style={{...styles.text, fontSize: 14}}>\n+                                    This will be the primary email contact for your new account.\n+                                  </div>\n+                                </div>}\n+                                invalid={this.state.emailFailedValidation}\n+                                onBlur={() => this.validateContactEmailInline()}\n+                                onChange={email => this.updateContactEmail(email)}/>\n+            {this.state.emailFailedValidation &&\n+              <ErrorDiv data-test-id='invalid-email-error'>\n+                Error: email address is invalid\n+              </ErrorDiv>\n+            }\n+            <div style={{marginTop: '.5rem'}}>\n+              <label style={{...styles.text, fontWeight: 600, marginTop: '1rem'}}>\n+                Which of the following best describes your role?\n+                <i style={{...styles.publiclyDisplayedText, marginLeft: '0.2rem'}}>\n+                  Publicly displayed\n+                </i>\n+              </label>\n+              <div>\n+                <Dropdown data-test-id='role-dropdown'\n+                          style={{width: '50%', 'minWidth': '600px'}}\n+                          placeholder={this.getRoleOptions() ?\n+                            '' : 'First select an institution above'}\n+                          options={this.getRoleOptions()}\n+                          value={institutionalRoleEnum}\n+                          onChange={(e) => this.updateAffiliationValue('institutionalRoleEnum', e.value)}/>\n+              </div>\n+            </div>\n+            {institutionalRoleEnum === InstitutionalRole.OTHER && <div style={{marginTop: '.5rem'}}>\n+              <label style={{...styles.text, fontWeight: 600, marginTop: '1rem'}}>\n+                Please describe your role\n+                <i style={{...styles.publiclyDisplayedText, marginLeft: '0.2rem'}}>\n+                  Publicly displayed\n+                </i>\n+              </label>\n+              <TextInputWithLabel value={institutionalRoleOtherText}\n+                                  inputId='institutionalRoleOtherText'\n+                                  inputName='institutionalRoleOtherText'\n+                                  onChange={v => this.updateAffiliationValue('institutionalRoleOtherText', v)}/>\n+            </div>\n+            }\n+          </div>\n+          }\n+          <FormSection style={{paddingBottom: '1rem'}}>\n+            <Button type='secondary' style={{marginRight: '1rem'}}\n+                    onClick={() => this.props.onPreviousClick(this.state.profile)}>\n+              Previous\n+            </Button>\n+            <TooltipTrigger content={errors && <div data-test-id='validation-errors'>\n+              <div>Please review the following: </div>\n+              <ul>\n+                {Object.keys(errors).map((key) => <li key={errors[key][0]}>{errors[key][0]}</li>)}", "originalCommit": "3af0cca693be3693422f0ff71e3246c38b5d34a6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjMzNTc4Mw==", "url": "https://github.com/all-of-us/workbench/pull/3251#discussion_r392335783", "bodyText": "Yeah, we're approaching 2 or 3 examples of this pattern now, so it may be helpful to invest in slightly more infrastructure surrounding it.", "author": "gjuggler", "createdAt": "2020-03-13T16:27:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjI2MzUyMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjM3MzA2Ng==", "url": "https://github.com/all-of-us/workbench/pull/3251#discussion_r392373066", "bodyText": "I think I'm happy not doing that in this PR, but would you add a ticket to follow up on that? (Maybe a tech debt ticket?)", "author": "s-rubenstein", "createdAt": "2020-03-13T17:33:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjI2MzUyMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjM3ODEyNA==", "url": "https://github.com/all-of-us/workbench/pull/3251#discussion_r392378124", "bodyText": "Sure, filed RW-4611", "author": "gjuggler", "createdAt": "2020-03-13T17:42:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjI2MzUyMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjI2NDcxNg==", "url": "https://github.com/all-of-us/workbench/pull/3251#discussion_r392264716", "bodyText": "Nit: There's a number of 'text but with fontWeight 600'. Would it make sense to create a boldText style, and use it everywhere that happens?", "author": "s-rubenstein", "createdAt": "2020-03-13T14:33:00Z", "path": "ui/src/app/pages/login/account-creation/account-creation-institution.tsx", "diffHunk": "@@ -0,0 +1,330 @@\n+import * as fp from 'lodash/fp';\n+import * as React from 'react';\n+import * as validate from 'validate.js';\n+\n+import {Button} from 'app/components/buttons';\n+import {FlexColumn, FlexRow} from 'app/components/flex';\n+import {FormSection} from 'app/components/forms';\n+import {Error as ErrorDiv, TextInput} from 'app/components/inputs';\n+import {TooltipTrigger} from 'app/components/popups';\n+import {SpinnerOverlay} from 'app/components/spinners';\n+import {AccountCreationOptions} from 'app/pages/login/account-creation/account-creation-options';\n+import {WhyWillSomeInformationBePublic} from 'app/pages/login/account-creation/common-content';\n+import {commonStyles} from 'app/pages/login/account-creation/common-styles';\n+import {institutionApi} from 'app/services/swagger-fetch-clients';\n+import colors from 'app/styles/colors';\n+import {isBlank, reactStyles} from 'app/utils';\n+import {reportError} from 'app/utils/errors';\n+import {\n+  InstitutionalRole,\n+  Profile,\n+  PublicInstitutionDetails,\n+} from 'generated/fetch';\n+import {Dropdown} from 'primereact/dropdown';\n+\n+const styles = reactStyles({\n+  ...commonStyles,\n+  publiclyDisplayedText: {\n+    fontSize: 12,\n+    fontWeight: 400\n+  },\n+  sectionInput: {\n+    width: '14rem',\n+    height: '1.5rem'\n+  },\n+  text: {\n+    fontSize: 14,\n+    color: colors.primary,\n+    lineHeight: '22px',\n+  }\n+});\n+\n+// TODO: this is copy-pasted from account-creation.tsx. Consider factoring this into a true component.\n+function TextInputWithLabel(props) {\n+  return <div style={{width: '12rem', ...props.containerStyle}}>\n+    {props.labelContent}\n+    {props.labelText && <label style={{...styles.text, fontWeight: 600}}>{props.labelText}</label>}\n+    <div style={{marginTop: '0.1rem'}}>\n+      <TextInput data-test-id={props.inputId}\n+                 id={props.inputId}\n+                 name={props.inputName}\n+                 placeholder={props.placeholder}\n+                 value={props.value}\n+                 disabled={props.disabled}\n+                 onChange={props.onChange}\n+                 onBlur={props.onBlur}\n+                 invalid={props.invalid ? props.invalid.toString() : undefined}\n+                 style={{...styles.sectionInput, ...props.inputStyle}}/>\n+      {props.children}\n+    </div>\n+  </div>;\n+}\n+\n+export interface Props {\n+  profile: Profile;\n+  onComplete: (profile: Profile) => void;\n+  onPreviousClick: (profile: Profile) => void;\n+}\n+\n+\n+interface State {\n+  profile: Profile;\n+  emailFailedValidation: boolean;\n+  loadingInstitutions: boolean;\n+  institutions: Array<PublicInstitutionDetails>;\n+  dataLoadError: boolean;\n+}\n+\n+export class AccountCreationInstitution extends React.Component<Props, State> {\n+  constructor(props: Props) {\n+    super(props);\n+    this.state = {\n+      profile: props.profile,\n+      emailFailedValidation: false,\n+      institutions: [],\n+      loadingInstitutions: true,\n+      dataLoadError: false,\n+    };\n+  }\n+\n+  async componentDidMount() {\n+    try {\n+      const details = await institutionApi().getPublicInstitutionDetails();\n+      this.setState({\n+        loadingInstitutions: false,\n+        institutions: details.institutions\n+      });\n+    } catch (e) {\n+      this.setState({\n+        loadingInstitutions: false,\n+        dataLoadError: true\n+      });\n+      reportError(e);\n+    }\n+  }\n+\n+  validateContactEmailInline() {\n+    const {profile: { contactEmail } } = this.state;\n+\n+    if (isBlank(contactEmail)) {\n+      // Allow a blank email to pass inline validation: it will still block overall form\n+      // submission via the validate() config below.\n+      this.setState({emailFailedValidation: false});\n+      return;\n+    }\n+\n+    const result = validate.single(contactEmail, { email: true } );\n+    if (result === undefined) {\n+      this.setState({emailFailedValidation: false});\n+    } else {\n+      this.setState({emailFailedValidation: true});\n+    }\n+  }\n+\n+  updateContactEmail(contactEmail: string) {\n+    this.setState({emailFailedValidation: false});\n+    this.setState(fp.set(['profile', 'contactEmail'], contactEmail));\n+  }\n+\n+  // Visible for testing.\n+  public validate(): {[key: string]: Array<string>} {\n+    const validationCheck = {\n+      'verifiedInstitutionalAffiliation.institutionShortName': {\n+        presence: {\n+          allowEmpty: false,\n+          message: '^You must select an institution to continue',\n+        }\n+      },\n+      contactEmail: {\n+        presence: {\n+          allowEmpty: false,\n+          message: '^Email address cannot be blank',\n+        },\n+        email: {\n+          message: '^Email address is invalid'\n+        }\n+      },\n+      'verifiedInstitutionalAffiliation.institutionalRoleEnum': {\n+        presence: {\n+          allowEmpty: false,\n+          message: '^Institutional role cannot be blank',\n+        }\n+      },\n+    };\n+    if (this.state.profile.verifiedInstitutionalAffiliation.institutionalRoleEnum === InstitutionalRole.OTHER) {\n+      validationCheck['verifiedInstitutionalAffiliation.institutionalRoleOtherText'] = {\n+        presence: {\n+          allowEmpty: false,\n+          message: '^Institutional role text cannot be blank',\n+        }\n+      };\n+    }\n+\n+    return validate(this.state.profile, validationCheck);\n+  }\n+\n+  getRoleOptions(): Array<{label: string, value: InstitutionalRole}> {\n+    const {institutions, profile: {verifiedInstitutionalAffiliation: {institutionShortName}}} = this.state;\n+    if (isBlank(institutionShortName)) {\n+      return [];\n+    }\n+\n+    const selectedOrgType = institutions.find(\n+      inst => inst.shortName === institutionShortName).organizationTypeEnum;\n+    const availableRoles: Array<InstitutionalRole> =\n+      AccountCreationOptions.institutionalRolesByOrganizationType\n+      .find(obj => obj.type === selectedOrgType)\n+        .roles;\n+\n+    return AccountCreationOptions.institutionalRoleOptions.filter(option =>\n+      availableRoles.includes(option.value)\n+    );\n+  }\n+\n+  updateAffiliationValue(attribute: string, value) {\n+    this.setState(fp.set(['profile', 'verifiedInstitutionalAffiliation', attribute], value));\n+  }\n+\n+  render() {\n+    const {\n+      loadingInstitutions,\n+      institutions,\n+      profile: {\n+        contactEmail,\n+        verifiedInstitutionalAffiliation: {\n+          institutionShortName, institutionalRoleEnum, institutionalRoleOtherText,\n+        }\n+      }\n+    } = this.state;\n+\n+    const errors = this.validate();\n+\n+    return <div id='account-creation-institution'\n+                style={{paddingTop: '1.5rem', paddingRight: '3rem', paddingLeft: '3rem'}}>\n+      <div style={{fontSize: 28, fontWeight: 400, color: colors.primary}}>Create your account</div>\n+      <FlexRow>\n+        <FlexColumn style={{marginTop: '0.5rem', marginRight: '2rem'}}>\n+          <div style={{...styles.text, fontSize: 16, marginTop: '1rem'}}>\n+            Please complete Step 1 of 3\n+          </div>\n+          <div style={{...styles.text, fontSize: 14, marginTop: '0.7rem'}}>\n+            For access to the <i>All of Us</i> Research Program data, your institution needs to have signed a Data Use Agreement\n+            with the program. The institutions listed below have an Institutional Data Use Agreement with the program that\n+            enables us to provide their researchers with access to the Workbench.\n+          </div>\n+          <div style={{...styles.text, fontSize: 12, marginTop: '0.5rem'}}>\n+            All fields are required.\n+          </div>\n+          {loadingInstitutions && <SpinnerOverlay />}\n+          {!loadingInstitutions && <div style={{marginTop: '.5rem'}}>\n+            <label style={{...styles.text, fontWeight: 600}}>\n+              Select your institution\n+              <i style={{...styles.publiclyDisplayedText, marginLeft: '0.2rem'}}>\n+                Publicly displayed\n+              </i>\n+            </label>\n+            <div style={{...styles.text, fontSize: 14}}>\n+              Your institution will be notified that you have registered using your institutional credentials.\n+            </div>\n+            <Dropdown\n+                data-test-id='institution-dropdown'\n+                style={{width: '50%', minWidth: '600px'}}\n+                options={institutions.map(inst => ({'value': inst.shortName, 'label': inst.displayName}))}\n+                value={institutionShortName}\n+                onChange={(e) => {\n+                  this.updateAffiliationValue('institutionShortName', e.value);\n+                  // Clear out any existing values for role when the institution changes.\n+                  this.updateAffiliationValue('institutionalRoleEnum', undefined);\n+                  this.updateAffiliationValue('institutionalRoleOtherText', undefined);\n+                }}/>\n+            {this.state.dataLoadError &&\n+            <ErrorDiv data-test-id='data-load-error'>\n+              An error occurred loading the institution list. Please try again or contact\n+              <a href='mailto:support@researchallofus.org'>support@researchallofus.org</a>.\n+            </ErrorDiv>\n+            }\n+            <div style={{marginTop: '.5rem'}}>\n+              <a href={'https://www.researchallofus.org/apply/'} target='_blank' style={{color: colors.accent}}>\n+              Don't see your institution listed?\n+              </a>\n+            </div>\n+            <TextInputWithLabel containerStyle={{marginTop: '1rem', width: null}}\n+                                value={contactEmail}\n+                                inputId='contact-email'\n+                                inputName='contactEmail'\n+                                labelContent={<div>\n+                                  <label style={{...styles.text, fontWeight: 600}}>", "originalCommit": "3af0cca693be3693422f0ff71e3246c38b5d34a6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjM2MjA4Ng==", "url": "https://github.com/all-of-us/workbench/pull/3251#discussion_r392362086", "bodyText": "done", "author": "gjuggler", "createdAt": "2020-03-13T17:13:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjI2NDcxNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjI2NTg0Nw==", "url": "https://github.com/all-of-us/workbench/pull/3251#discussion_r392265847", "bodyText": "Why remove the get on this? It doesn't have any side effects.", "author": "s-rubenstein", "createdAt": "2020-03-13T14:34:52Z", "path": "ui/src/app/pages/login/account-creation/account-creation.tsx", "diffHunk": "@@ -253,37 +220,19 @@ export class AccountCreation extends React.Component<AccountCreationProps, Accou\n     return state;\n   }\n \n-  get usernameValid(): boolean {\n+  // Returns whether the current username is considered valid. Undefined is returned when the\n+  // username is empty, or if a username check is in progress.\n+  isUsernameValid(): (boolean|undefined) {\n     if (isBlank(this.state.profile.username) || this.state.usernameCheckInProgress) {\n       return undefined;\n     }\n-    return !this.isUsernameValidationError;\n+    return !this.isUsernameValidationError();\n   }\n \n-  get isUsernameValidationError(): boolean {\n+  isUsernameValidationError(): boolean {", "originalCommit": "3af0cca693be3693422f0ff71e3246c38b5d34a6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjMzNzczMQ==", "url": "https://github.com/all-of-us/workbench/pull/3251#discussion_r392337731", "bodyText": "The main reason to remove it is that it forces callers to use parentheses when calling the method. I preferred removing this to make it clear that this is a method, with underlying logic and potentially downstream methods being called, rather than a simple property.", "author": "gjuggler", "createdAt": "2020-03-13T16:31:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjI2NTg0Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjI2NzkxMw==", "url": "https://github.com/all-of-us/workbench/pull/3251#discussion_r392267913", "bodyText": "Why does it need to be typed as any? Could it be typed as a Profile object?", "author": "s-rubenstein", "createdAt": "2020-03-13T14:38:23Z", "path": "ui/src/app/pages/login/account-creation/account-creation.tsx", "diffHunk": "@@ -394,88 +327,123 @@ export class AccountCreation extends React.Component<AccountCreationProps, Accou\n     this.updateInstitutionAffiliation('role', role);\n   }\n \n-  validateAccountCreation() {\n-    const {\n-      showInstitution,\n-      profile: {\n-        givenName, familyName, contactEmail, areaOfResearch, degrees, username,\n-        address: { streetAddress1, city, country, state, zipCode },\n-        // TODO remove after we switch to verified institutional affiliation\n-        institutionalAffiliations,\n-      }\n-    } = this.state;\n+  validate(): {[key: string]: string} {\n+    const {showInstitution} = this.state;\n     const {gsuiteDomain, requireInstitutionalVerification} = serverConfigStore.getValue();\n \n-    const presenceCheck = {\n-      presence: {\n-        allowEmpty: false\n-      }\n-    };\n-\n     const validationCheck = {\n-      username: {\n-        presence: presenceCheck,\n+      'username': {\n+        presence: {\n+          allowEmpty: false,\n+          message: '^Username cannot be blank'\n+        },\n         length: {\n-          minimum: 4 + gsuiteDomain.length,\n-          maximum: 64 + gsuiteDomain.length,\n-          tooShort: 'not valid',\n-          tooLong: 'not valid'\n+          minimum: 4,\n+          maximum: 64,\n         },\n-        email: {\n-          message: ' not valid'\n+      },\n+      'givenName': {\n+        presence: {\n+          allowEmpty: false,\n+          message: '^First name cannot be blank'\n         }\n       },\n-      givenName: presenceCheck,\n-      familyName: presenceCheck,\n-      contactEmail: {\n-        presence: presenceCheck,\n-        email: {\n-          message: 'invalid'\n+      'familyName': {\n+        presence: {\n+          allowEmpty: false,\n+          message: '^Last name cannot be blank'\n+        }\n+      },\n+      'areaOfResearch': {\n+        presence: {\n+          allowEmpty: false,\n+          message: '^Research description cannot be blank'\n+        }\n+      },\n+      'address.streetAddress1': {\n+        presence: {\n+          allowEmpty: false,\n+          message: '^Street address cannot be blank'\n+        }\n+      },\n+      'address.city': {\n+        presence: {\n+          allowEmpty: false,\n+          message: '^City cannot be blank'\n+        }\n+      },\n+      'address.state': {\n+        presence: {\n+          allowEmpty: false,\n+          message: '^State cannot be blank'\n+        }\n+      },\n+      'address.zipCode': {\n+        presence: {\n+          allowEmpty: false,\n+          message: '^Zip code cannot be blank'\n+        }\n+      },\n+      'address.country': {\n+        presence: {\n+          allowEmpty: false,\n+          message: '^Country cannot be blank'\n         }\n       },\n-      streetAddress1: presenceCheck,\n-      city: presenceCheck,\n-      state: presenceCheck,\n-      zipCode: presenceCheck,\n-      country: presenceCheck,\n-      areaOfResearch: presenceCheck\n     };\n \n-    if (requireInstitutionalVerification) {\n-      const institutionShortName = this.getVerifiedInstitutionalAffiliationAttribute('institutionShortName');\n-      const institutionalRoleEnum = this.getVerifiedInstitutionalAffiliationAttribute('institutionalRoleEnum');\n-      const institutionalRoleOtherText = this.getVerifiedInstitutionalAffiliationAttribute('institutionalRoleOtherText');\n-\n-      validationCheck['institutionShortName'] = presenceCheck;\n-      validationCheck['institutionalRoleEnum'] = presenceCheck;\n-      if (institutionalRoleEnum === InstitutionalRole.OTHER) {\n-        validationCheck['institutionalRoleOtherText'] = presenceCheck;\n-      }\n+    let validationData = {...this.state.profile} as any;", "originalCommit": "3af0cca693be3693422f0ff71e3246c38b5d34a6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjMzODA2MQ==", "url": "https://github.com/all-of-us/workbench/pull/3251#discussion_r392338061", "bodyText": "Ah, I ended up doing something fancy here and adding a custom 'usernameWithEmail' field to the validation data check. I added a comment to make clear what's going on here.", "author": "gjuggler", "createdAt": "2020-03-13T16:31:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjI2NzkxMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjI2OTA3MA==", "url": "https://github.com/all-of-us/workbench/pull/3251#discussion_r392269070", "bodyText": "Why remove the get on this as well? Once again, shouldn't have any side effects?", "author": "s-rubenstein", "createdAt": "2020-03-13T14:40:16Z", "path": "ui/src/app/pages/login/account-creation/account-creation.tsx", "diffHunk": "@@ -253,37 +220,19 @@ export class AccountCreation extends React.Component<AccountCreationProps, Accou\n     return state;\n   }\n \n-  get usernameValid(): boolean {\n+  // Returns whether the current username is considered valid. Undefined is returned when the\n+  // username is empty, or if a username check is in progress.\n+  isUsernameValid(): (boolean|undefined) {", "originalCommit": "3af0cca693be3693422f0ff71e3246c38b5d34a6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjMzNjkwNQ==", "url": "https://github.com/all-of-us/workbench/pull/3251#discussion_r392336905", "bodyText": "I found myself getting confused trying to decide which of these was a method and which was a getter. Personally, I'm coming to a conclusion that getters don't add enough value in Typescript to be worth the add'l mental burden on the reader. I'll bring this to eng sync and draft a PR with a style guide addition.", "author": "gjuggler", "createdAt": "2020-03-13T16:29:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjI2OTA3MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjI3MDQ3NQ==", "url": "https://github.com/all-of-us/workbench/pull/3251#discussion_r392270475", "bodyText": "Why not put this in common content as well, and just have one common file.", "author": "s-rubenstein", "createdAt": "2020-03-13T14:42:26Z", "path": "ui/src/app/pages/login/account-creation/common-styles.tsx", "diffHunk": "@@ -0,0 +1,28 @@\n+import colors, {colorWithWhiteness} from 'app/styles/colors';\n+import {reactStyles} from 'app/utils';\n+\n+// Contains style definitions shared across multiple account-creation form steps.\n+export const commonStyles = reactStyles({", "originalCommit": "3af0cca693be3693422f0ff71e3246c38b5d34a6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjMzODcxNg==", "url": "https://github.com/all-of-us/workbench/pull/3251#discussion_r392338716", "bodyText": "Good call \u2013\u00a0done.", "author": "gjuggler", "createdAt": "2020-03-13T16:32:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjI3MDQ3NQ=="}], "type": "inlineReview"}, {"oid": "a290aaba2bb8ae4c95568d3f172442a596372284", "url": "https://github.com/all-of-us/workbench/commit/a290aaba2bb8ae4c95568d3f172442a596372284", "message": "PR feedback.", "committedDate": "2020-03-13T17:12:35Z", "type": "commit"}, {"oid": "a04c7396a0fcc2bc2779394714471c004a1cb9e8", "url": "https://github.com/all-of-us/workbench/commit/a04c7396a0fcc2bc2779394714471c004a1cb9e8", "message": "Test fixes.", "committedDate": "2020-03-13T17:38:30Z", "type": "commit"}, {"oid": "cf97470b96dab002288257d55dd4cbe1b4a5a7cb", "url": "https://github.com/all-of-us/workbench/commit/cf97470b96dab002288257d55dd4cbe1b4a5a7cb", "message": "Profile controller test fix.", "committedDate": "2020-03-13T20:54:32Z", "type": "commit"}]}