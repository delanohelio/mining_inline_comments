{"pr_number": 4348, "pr_title": "Puppeteer: minor test code refactor", "pr_createdAt": "2020-12-03T16:38:26Z", "pr_url": "https://github.com/all-of-us/workbench/pull/4348", "timeline": [{"oid": "73e0a6adca30d140bcbc8ba1040f621d7603eb52", "url": "https://github.com/all-of-us/workbench/commit/73e0a6adca30d140bcbc8ba1040f621d7603eb52", "message": "fixes", "committedDate": "2020-12-03T16:35:46Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTM5NDU5NQ==", "url": "https://github.com/all-of-us/workbench/pull/4348#discussion_r535394595", "bodyText": "checking cdr version on Data page is moved to workspace-create.spec test (one less new workspace).", "author": "aweng98", "createdAt": "2020-12-03T16:39:57Z", "path": "e2e/tests/workspace/cdr-version-display.spec.ts", "diffHunk": "@@ -10,17 +10,6 @@ describe('Workspace CDR Version display', () => {\n         await signIn(page);\n     });\n \n-    test('The CDR version displays in the workspace navigation bar', async () => {", "originalCommit": "73e0a6adca30d140bcbc8ba1040f621d7603eb52", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTM5NjA5OQ==", "url": "https://github.com/all-of-us/workbench/pull/4348#discussion_r535396099", "bodyText": "not useful, cluttering code.", "author": "aweng98", "createdAt": "2020-12-03T16:41:32Z", "path": "e2e/tests/workspace/workspace-edit.spec.ts", "diffHunk": "@@ -85,8 +85,7 @@ describe('Editing workspace via workspace card snowman menu', () => {\n \n   test('User as OWNER can edit workspace via workspace action menu', async () => {\n     const workspaceCard = await findOrCreateWorkspace(page);\n-    const workspaceName = await workspaceCard.getWorkspaceName();\n-    console.log(workspaceName);", "originalCommit": "73e0a6adca30d140bcbc8ba1040f621d7603eb52", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTM5ODcwMw==", "url": "https://github.com/all-of-us/workbench/pull/4348#discussion_r535398703", "bodyText": "disable global retry failed tests in an indiscriminate fashion. Retry uses up billing projects and may hides application issues.", "author": "aweng98", "createdAt": "2020-12-03T16:44:33Z", "path": "e2e/jest-circus.setup.ts", "diffHunk": "@@ -2,4 +2,4 @@ require('expect-puppeteer');\n \n // Runs failed tests n-times until they pass or until the max number of retries is exhausted. This only works with jest-circus.\n // This file loaded in jest.config.js ==> setupFilesAfterEnv\n-jest.retryTimes(process.env.DEBUG === 'true' ? 0 : 1);\n+// jest.retryTimes(process.env.DEBUG === 'true' ? 0 : 1);", "originalCommit": "73e0a6adca30d140bcbc8ba1040f621d7603eb52", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTM5OTQ3NQ==", "url": "https://github.com/all-of-us/workbench/pull/4348#discussion_r535399475", "bodyText": "--maxWorkers=3 will cause test to fail when only one test is selected to run.", "author": "aweng98", "createdAt": "2020-12-03T16:45:23Z", "path": "e2e/package.json", "diffHunk": "@@ -9,10 +9,10 @@\n     \"test\": \"cross-env jest --maxWorkers=5\",\n     \"test:debugTest\": \"cross-env PUPPETEER_HEADLESS=false DEBUG=true node --inspect-brk node_modules/.bin/jest\",\n     \"test:debug\": \"cross-env PUPPETEER_HEADLESS=false DEBUG=true jest --detectOpenHandles\",\n-    \"test-local\": \"cross-env WORKBENCH_ENV=local DEBUG=true jest --maxWorkers=3\",\n-    \"test-local:debug\": \"cross-env WORKBENCH_ENV=local PUPPETEER_HEADLESS=false DEBUG=true jest --maxWorkers=3\",\n+    \"test-local\": \"cross-env WORKBENCH_ENV=local DEBUG=true jest --detectOpenHandles\",", "originalCommit": "73e0a6adca30d140bcbc8ba1040f621d7603eb52", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTQ0NjY4Mg==", "url": "https://github.com/all-of-us/workbench/pull/4348#discussion_r535446682", "bodyText": "This is surprising.  Where have you seen this?\nAlso: why change some of these but not others, and what does adding detectOpenHandles do?", "author": "jmthibault79", "createdAt": "2020-12-03T17:42:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTM5OTQ3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTQ2ODgzNw==", "url": "https://github.com/all-of-us/workbench/pull/4348#discussion_r535468837", "bodyText": "The error is Protocol error (DOM.describeNode): Target closed. when running only one test on localhost like yarn test-local tests/home/home-page.spec.ts.\n--detectOpenHandles detects one code issue: when asyn/promise code didn't use await.", "author": "aweng98", "createdAt": "2020-12-03T18:14:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTM5OTQ3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTYxMjM2OA==", "url": "https://github.com/all-of-us/workbench/pull/4348#discussion_r535612368", "bodyText": "I tried this out, and I was able to run a single test with maxWorkers=3.  Let's keep that flag.\nthibault@wm98d-e39 ~/src/aou/e2e (joel/create-auth-domain) $ yarn test-local tests/home/home-page.spec.ts                                                                                                                                           yarn run v1.21.1                                                                                                                                                                                                                                    $ cross-env WORKBENCH_ENV=local DEBUG=true jest --maxWorkers=3 tests/home/home-page.spec.ts                                                                                                                                                          PASS  tests/home/home-page.spec.ts (35.393 s)                                                                                                                                                                                                        Home page ui tests                                                                                                                                                                                                                                    \u2713 Check visibility of Workspace cards (16831 ms)                                                                                                                                                                                                    \u2713 Check Create New Workspace link on Home page (15654 ms)                                                                                                                                                                                                                                                                                                                                                                                                                                           Test Suites: 1 passed, 1 total                                                                                                                                                                                                                      Tests:       2 passed, 2 total                                                                                                                                                                                                                      Snapshots:   0 total                                                                                                                                                                                                                                Time:        36.542 s                                                                                                                                                                                                                               Ran all test suites matching /tests\\/home\\/home-page.spec.ts/i.                                                                                                                                                                                     \u2728  Done in 39.23s.", "author": "jmthibault79", "createdAt": "2020-12-03T21:02:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTM5OTQ3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTYxMjk5Mw==", "url": "https://github.com/all-of-us/workbench/pull/4348#discussion_r535612993", "bodyText": "detectOpenHandles looks useful.  Thanks \ud83d\udc4d", "author": "jmthibault79", "createdAt": "2020-12-03T21:02:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTM5OTQ3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTYyMTMwMg==", "url": "https://github.com/all-of-us/workbench/pull/4348#discussion_r535621302", "bodyText": "Reverted package.json back to original, saving detectOpenHandles change for another day.", "author": "aweng98", "createdAt": "2020-12-03T21:08:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTM5OTQ3NQ=="}], "type": "inlineReview"}, {"oid": "a9bc8f6c0a475e09f7a74ea02a25381386c71bfe", "url": "https://github.com/all-of-us/workbench/commit/a9bc8f6c0a475e09f7a74ea02a25381386c71bfe", "message": "enable dataset-create.spec", "committedDate": "2020-12-03T18:18:34Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTQ3NDUwOQ==", "url": "https://github.com/all-of-us/workbench/pull/4348#discussion_r535474509", "bodyText": "RW-5751 is done but no one re-enabled test.", "author": "aweng98", "createdAt": "2020-12-03T18:20:55Z", "path": "e2e/tests/datasets/dataset-create.spec.ts", "diffHunk": "@@ -21,8 +21,7 @@ describe('Dataset test', () => {\n    * - Edit dataset. Save dataset without Export to Notebook.\n    * - Delete Dataset.\n    */\n-  // RW-5751 Search for condition is failing in CI.\n-  xtest('Can create Dataset with user-defined Cohorts', async () => {\n+  test('Can create Dataset with user-defined Cohorts', async () => {", "originalCommit": "a9bc8f6c0a475e09f7a74ea02a25381386c71bfe", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "0c01a114320107436321f495d05da0bf31ec875c", "url": "https://github.com/all-of-us/workbench/commit/0c01a114320107436321f495d05da0bf31ec875c", "message": "revert changes in package.json", "committedDate": "2020-12-03T21:05:49Z", "type": "commit"}]}