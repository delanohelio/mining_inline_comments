{"pr_number": 3303, "pr_title": "[no ticket][risk=no]Find out why waitUntilNoSpinner fails in CircleCI jobs", "pr_createdAt": "2020-03-26T17:56:24Z", "pr_url": "https://github.com/all-of-us/workbench/pull/3303", "timeline": [{"oid": "717e7e1774fcf7bfc24ef17e0b3703fa9ea77d97", "url": "https://github.com/all-of-us/workbench/commit/717e7e1774fcf7bfc24ef17e0b3703fa9ea77d97", "message": "debug logging", "committedDate": "2020-03-26T16:32:46Z", "type": "commit"}, {"oid": "021eadfa7e49fd0f27b89d8e7fa7516d6894afb4", "url": "https://github.com/all-of-us/workbench/commit/021eadfa7e49fd0f27b89d8e7fa7516d6894afb4", "message": "debug logging", "committedDate": "2020-03-26T16:33:33Z", "type": "commit"}, {"oid": "902535d2e998485a1282dfd47a8b9686659d6825", "url": "https://github.com/all-of-us/workbench/commit/902535d2e998485a1282dfd47a8b9686659d6825", "message": "spinner timeout 90 seconds", "committedDate": "2020-03-26T17:45:33Z", "type": "commit"}, {"oid": "7753eac0b6bae03e1d50d03ce6cfee2003bf168b", "url": "https://github.com/all-of-us/workbench/commit/7753eac0b6bae03e1d50d03ce6cfee2003bf168b", "message": "log time in seconds", "committedDate": "2020-03-26T18:23:14Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODgzOTMwNg==", "url": "https://github.com/all-of-us/workbench/pull/3303#discussion_r398839306", "bodyText": "nit: change len to selectorLength", "author": "NehaBroad", "createdAt": "2020-03-26T19:32:58Z", "path": "e2e/app/authenticated-page.ts", "diffHunk": "@@ -161,12 +161,28 @@ export default abstract class AuthenticatedPage extends BasePage {\n     }, {timeout: 1000}, selectr1);\n     const jValue = await spinner.jsonValue();\n \n-    // wait maximum 60 seconds for spinner disappear if spinner existed\n+    // wait maximum 90 seconds for spinner disappear if spinner existed\n     const selectr2 = 'svg[style*=\"spin\"], .spinner:empty';\n-    if (jValue) {\n-      await this.page.waitFor((selector) => {\n-        return document.querySelectorAll(selector).length === 0\n-      }, {timeout: 60000}, selectr2);\n+    const startTime = performance.now();\n+    try {\n+      if (jValue) {\n+        await this.page.waitFor((selector) => {\n+          const len = document.querySelectorAll(selector).length;", "originalCommit": "7753eac0b6bae03e1d50d03ce6cfee2003bf168b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODg0MDcxOA==", "url": "https://github.com/all-of-us/workbench/pull/3303#discussion_r398840718", "bodyText": "\ud83d\udc4d", "author": "aweng98", "createdAt": "2020-03-26T19:35:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODgzOTMwNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODgzOTc2NA==", "url": "https://github.com/all-of-us/workbench/pull/3303#discussion_r398839764", "bodyText": "should this be 60 or 90?", "author": "NehaBroad", "createdAt": "2020-03-26T19:33:49Z", "path": "e2e/app/authenticated-page.ts", "diffHunk": "@@ -161,12 +161,28 @@ export default abstract class AuthenticatedPage extends BasePage {\n     }, {timeout: 1000}, selectr1);\n     const jValue = await spinner.jsonValue();\n \n-    // wait maximum 60 seconds for spinner disappear if spinner existed\n+    // wait maximum 90 seconds for spinner disappear if spinner existed\n     const selectr2 = 'svg[style*=\"spin\"], .spinner:empty';\n-    if (jValue) {\n-      await this.page.waitFor((selector) => {\n-        return document.querySelectorAll(selector).length === 0\n-      }, {timeout: 60000}, selectr2);\n+    const startTime = performance.now();\n+    try {\n+      if (jValue) {\n+        await this.page.waitFor((selector) => {\n+          const len = document.querySelectorAll(selector).length;\n+          return len === 0\n+        }, {timeout: 90000}, selectr2);\n+      }\n+    } catch (err) {\n+      await this.takeScreenshot('TimedOutWaitForSpinnerStop');\n+      throw err;\n+    } finally {\n+      const finishTime = performance.now();\n+      const diff = Math.floor(((finishTime - startTime) / 1000) % 60);\n+      if (diff > 60) {\n+        // if timeout exceeds 60 seconds without error thrown, it shows page loading is slow", "originalCommit": "7753eac0b6bae03e1d50d03ce6cfee2003bf168b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODg0MDQyMw==", "url": "https://github.com/all-of-us/workbench/pull/3303#discussion_r398840423", "bodyText": "it's correct.", "author": "aweng98", "createdAt": "2020-03-26T19:35:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODgzOTc2NA=="}], "type": "inlineReview"}, {"oid": "a5de0ea76ce1a8f9244dfd5f409ef60f3b0314e2", "url": "https://github.com/all-of-us/workbench/commit/a5de0ea76ce1a8f9244dfd5f409ef60f3b0314e2", "message": "PR feedback", "committedDate": "2020-03-26T19:40:59Z", "type": "commit"}]}