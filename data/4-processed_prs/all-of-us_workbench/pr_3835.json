{"pr_number": 3835, "pr_title": "[RW-5343][risk=no] filter on action types", "pr_createdAt": "2020-07-28T13:52:55Z", "pr_url": "https://github.com/all-of-us/workbench/pull/3835", "timeline": [{"oid": "c6b751afefde54cc34f0bed38f4694b361dc5167", "url": "https://github.com/all-of-us/workbench/commit/c6b751afefde54cc34f0bed38f4694b361dc5167", "message": "action type filter", "committedDate": "2020-08-06T18:06:09Z", "type": "commit"}, {"oid": "c6b751afefde54cc34f0bed38f4694b361dc5167", "url": "https://github.com/all-of-us/workbench/commit/c6b751afefde54cc34f0bed38f4694b361dc5167", "message": "action type filter", "committedDate": "2020-08-06T18:06:09Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjY5Mjc4Nw==", "url": "https://github.com/all-of-us/workbench/pull/3835#discussion_r466692787", "bodyText": "For better styling a 1rem marginLeft may be better.\nTOL - as this page is evolving it may make sense to take a step back and look at the markup and styling. We may be able to make some improvements in that area.", "author": "petesantos", "createdAt": "2020-08-06T21:20:48Z", "path": "ui/src/app/components/admin/audit-card-list-view.tsx", "diffHunk": "@@ -193,17 +210,115 @@ const AuditActionCard = (props: { action: AuditAction }) => {\n   );\n };\n \n-export const AuditActionCardListView = (props: { actions: AuditAction[]}) => {\n+interface FilterEntry {\n+  displayName?: string;\n+  isActive: boolean;\n+}\n+\n+const ActionTypeFilter = (props: {\n+  activeActionTypes: { [key: string]: FilterEntry },\n+  updateFilter: (actionType: string, isActive: boolean) => void }) => {\n+\n+  const {activeActionTypes, updateFilter} = props;\n+\n+  const toggleSelectedAction = (actionType) => {\n+    updateFilter(actionType, !fp.get(`${actionType}.isActive`)(activeActionTypes));\n+  };\n+\n+  return (\n+      <React.Fragment>\n+        <div style={{\n+          margin: '0',", "originalCommit": "c6b751afefde54cc34f0bed38f4694b361dc5167", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzEwMDMzMw==", "url": "https://github.com/all-of-us/workbench/pull/3835#discussion_r467100333", "bodyText": "Yes. I don't know if Lou has looked at it or not, but Shimon mentioned he was looking at the admin pages. As a casual UI developer, I'd really like a library of widgets that already have the right styling that I can just compose with.", "author": "jaycarlton", "createdAt": "2020-08-07T15:08:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjY5Mjc4Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjY5MzYwMQ==", "url": "https://github.com/all-of-us/workbench/pull/3835#discussion_r466693601", "bodyText": "nit / personal preference - remove the border. If you do want to keep the border some padding may help.\nalso consider 1px solid ${colors.secondary} to combine the style onto one line (using backtics the formatting won't let me show the backtics)", "author": "petesantos", "createdAt": "2020-08-06T21:22:34Z", "path": "ui/src/app/components/admin/audit-card-list-view.tsx", "diffHunk": "@@ -193,17 +210,115 @@ const AuditActionCard = (props: { action: AuditAction }) => {\n   );\n };\n \n-export const AuditActionCardListView = (props: { actions: AuditAction[]}) => {\n+interface FilterEntry {\n+  displayName?: string;\n+  isActive: boolean;\n+}\n+\n+const ActionTypeFilter = (props: {\n+  activeActionTypes: { [key: string]: FilterEntry },\n+  updateFilter: (actionType: string, isActive: boolean) => void }) => {\n+\n+  const {activeActionTypes, updateFilter} = props;\n+\n+  const toggleSelectedAction = (actionType) => {\n+    updateFilter(actionType, !fp.get(`${actionType}.isActive`)(activeActionTypes));\n+  };\n+\n+  return (\n+      <React.Fragment>\n+        <div style={{\n+          margin: '0',\n+          display: 'flex',\n+          flexDirection: 'column',\n+          textAlign: 'left',\n+          border: '1px solid',\n+          borderColor: colors.secondary,", "originalCommit": "c6b751afefde54cc34f0bed38f4694b361dc5167", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzEwMTQzNg==", "url": "https://github.com/all-of-us/workbench/pull/3835#discussion_r467101436", "bodyText": "It's intended to be temporary, but yeah. Especially if there are several filter lists, I need to think about that. I just wanted a good way to make it clear this was all one widget (especially as it changes sizes).\nThere was at one point a desire to collapse and expand cards  instead of or in addition to filtering as well.", "author": "jaycarlton", "createdAt": "2020-08-07T15:10:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjY5MzYwMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzAyNDQ2Nw==", "url": "https://github.com/all-of-us/workbench/pull/3835#discussion_r467024467", "bodyText": "This might be a bit cleaner / flatter than the nested flows\nfp.flow(\n    fp.map(fp.get('header.actionType')),\n    fp.join(' & '),\n    toTitleCase,\n    s => s || 'n/a')\n  (action.eventBundles);```", "author": "petesantos", "createdAt": "2020-08-07T12:59:45Z", "path": "ui/src/app/components/admin/audit-card-list-view.tsx", "diffHunk": "@@ -164,24 +177,28 @@ const EventBundleView = (props: {eventBundle: AuditEventBundle}) => {\n   </div>;\n };\n \n-const AuditActionCard = (props: { action: AuditAction }) => {\n-  const {action} = props;\n+const AuditActionCard = (props: { action: AuditAction, show: (AuditAction) => boolean }) => {\n+  const {action, show} = props;\n   // Something in the codegen is wonky here. the actionTime field is typed as a Date,\n   // but turns out to be a number for some reason here. In other contexts it appears\n   // to format itself happily though.\n   const timeString = moment(new Date(action.actionTime)).format('YYYY-MM-DD h:mm:ss');\n   const actionTypes = fp.flow(\n-    fp.map(fp.get('header.actionType')),\n-    s => s.join(' & '))\n+    fp.map(\n+      fp.flow(\n+        fp.get('header.actionType'),\n+        toTitleCase)),\n+    s => s ? s.join(' & ') : 'n/a')", "originalCommit": "c6b751afefde54cc34f0bed38f4694b361dc5167", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzEwMDAzMw==", "url": "https://github.com/all-of-us/workbench/pull/3835#discussion_r467100033", "bodyText": "definitely.", "author": "jaycarlton", "createdAt": "2020-08-07T15:08:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzAyNDQ2Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzA2NDgxMw==", "url": "https://github.com/all-of-us/workbench/pull/3835#discussion_r467064813", "bodyText": "This might be a bit cleaner with some additional desctructuring.\nAlso, keeping the code consistent with lodash may help future development and prevent confusion when reading through the code.\nI am not a fan of the double toPairs in my solution, but it does keep it in lodash/fp... I will think through it a bit more to see if there is a better solution.\nIf you don't want to do that - do take a look at the destructuring bit. It may be a bit cleaner than the array index references. The destructure should work with the native map code as well.\nfp.flow(\n          fp.toPairs,\n          fp.toPairs,\n          fp.map(([index, [id, entry]]: [number, [string, FilterEntry]]) =>\n            <CheckBox\n              key={index}\n              id={`${id}_active`}\n              onChange={() => toggleSelectedAction(id)}\n              label={entry.displayName}\n              checked={entry.isActive}\n              style={{margin: '0.25rem'}}/>)\n        )(activeActionTypes)}", "author": "petesantos", "createdAt": "2020-08-07T14:10:02Z", "path": "ui/src/app/components/admin/audit-card-list-view.tsx", "diffHunk": "@@ -193,17 +210,115 @@ const AuditActionCard = (props: { action: AuditAction }) => {\n   );\n };\n \n-export const AuditActionCardListView = (props: { actions: AuditAction[]}) => {\n+interface FilterEntry {\n+  displayName?: string;\n+  isActive: boolean;\n+}\n+\n+const ActionTypeFilter = (props: {\n+  activeActionTypes: { [key: string]: FilterEntry },\n+  updateFilter: (actionType: string, isActive: boolean) => void }) => {\n+\n+  const {activeActionTypes, updateFilter} = props;\n+\n+  const toggleSelectedAction = (actionType) => {\n+    updateFilter(actionType, !fp.get(`${actionType}.isActive`)(activeActionTypes));\n+  };\n+\n+  return (\n+      <React.Fragment>\n+        <div style={{\n+          margin: '0',\n+          display: 'flex',\n+          flexDirection: 'column',\n+          textAlign: 'left',\n+          border: '1px solid',\n+          borderColor: colors.secondary,\n+          width: 'fit-content'\n+        }}>\n+        <div style={{fontWeight: 600, color: colors.accent}}>Action Types</div>\n+        {fp.entries(activeActionTypes).map((actionTypeValuePair: [string, FilterEntry], index) =>\n+          <CheckBox\n+            key={index}\n+            id={`${actionTypeValuePair[0]}_active`}\n+            onChange={() => toggleSelectedAction(actionTypeValuePair[0])}\n+            label={actionTypeValuePair[1].displayName}\n+            checked={actionTypeValuePair[1].isActive}\n+            style={{margin: '0.25rem'}}/>)}\n+        </div>", "originalCommit": "c6b751afefde54cc34f0bed38f4694b361dc5167", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzEwNTM1MA==", "url": "https://github.com/all-of-us/workbench/pull/3835#discussion_r467105350", "bodyText": "This is definitely cleaner once I  wrapped my head around it. The double-pairing is awkward though. Is there a way to flatten the object into a list of (index, id, FilterEntry) first?", "author": "jaycarlton", "createdAt": "2020-08-07T15:17:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzA2NDgxMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODU3NjA2OQ==", "url": "https://github.com/all-of-us/workbench/pull/3835#discussion_r468576069", "bodyText": "It may be better to change what the structure of activeActionTypes looks like in AuditActionCardListView to make it easier to consume. That may be better for a future PR", "author": "petesantos", "createdAt": "2020-08-11T13:24:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzA2NDgxMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzA4Mzg2Mg==", "url": "https://github.com/all-of-us/workbench/pull/3835#discussion_r467083862", "bodyText": "I know we differ in opinion on who should be responsible for conditional renders (parent or component).\nAfter searching the code base I only saw 2-3 instances of the show property, but many of the && < string (I believe that accurately indicates a conditional render)\nHere is a suggestion that may simplify things a bit / improve readability:\n  const filteredActions = fp.flow(\n    fp.toPairs,\n    fp.map(([index, action]) => shouldShowAction(action) && <AuditActionCard key={index} action={action}/>),\n    fp.without([false])\n  )(actions);\n\n  return (\n      <React.Fragment>\n        <ActionTypeFilter activeActionTypes={activeActionTypes}\n                          updateFilter={updateFilterCallback}\n        />\n        <div style={{margin: '1rem', width: '30rem'}}>\n          {filteredActions.length ? filteredActions : <div  style={infoMessageStyle}>All cards filtered out.</div>}\n        </div>\n      </React.Fragment>\n  );\nFollowed by a removal of the show prop in the AuditActionCard component", "author": "petesantos", "createdAt": "2020-08-07T14:40:48Z", "path": "ui/src/app/components/admin/audit-card-list-view.tsx", "diffHunk": "@@ -193,17 +210,115 @@ const AuditActionCard = (props: { action: AuditAction }) => {\n   );\n };\n \n-export const AuditActionCardListView = (props: { actions: AuditAction[]}) => {\n+interface FilterEntry {\n+  displayName?: string;\n+  isActive: boolean;\n+}\n+\n+const ActionTypeFilter = (props: {\n+  activeActionTypes: { [key: string]: FilterEntry },\n+  updateFilter: (actionType: string, isActive: boolean) => void }) => {\n+\n+  const {activeActionTypes, updateFilter} = props;\n+\n+  const toggleSelectedAction = (actionType) => {\n+    updateFilter(actionType, !fp.get(`${actionType}.isActive`)(activeActionTypes));\n+  };\n+\n+  return (\n+      <React.Fragment>\n+        <div style={{\n+          margin: '0',\n+          display: 'flex',\n+          flexDirection: 'column',\n+          textAlign: 'left',\n+          border: '1px solid',\n+          borderColor: colors.secondary,\n+          width: 'fit-content'\n+        }}>\n+        <div style={{fontWeight: 600, color: colors.accent}}>Action Types</div>\n+        {fp.entries(activeActionTypes).map((actionTypeValuePair: [string, FilterEntry], index) =>\n+          <CheckBox\n+            key={index}\n+            id={`${actionTypeValuePair[0]}_active`}\n+            onChange={() => toggleSelectedAction(actionTypeValuePair[0])}\n+            label={actionTypeValuePair[1].displayName}\n+            checked={actionTypeValuePair[1].isActive}\n+            style={{margin: '0.25rem'}}/>)}\n+        </div>\n+    </React.Fragment>);\n+};\n+\n+export const AuditActionCardListView = (props: { actions:  AuditAction[]}) => {\n   const {actions} = props;\n+  const [actionTypes, setActionTypes] = useState([]);\n+  const [activeActionTypes, setActiveActionTypes] = useState({});\n+  const [actionTypeToCardCount, setActionTypeToCardCount] = useState({});\n+\n+  useEffect(() => {\n+    const result = (fp.flow(\n+      fp.flatMap((action: AuditAction) => action.eventBundles),\n+      fp.map((eventBundle) => eventBundle.header.actionType),\n+      fp.sortBy(a => a),\n+      fp.sortedUniq)(actions));\n+    setActionTypes(result);\n+  }, [actions]);\n+\n+  useEffect(() => {\n+    const actionTypeToShow: Object = {};\n+    fp.forEach((propertyPath: string) => {\n+      // TODO: figure out why I can't make this work using fp.set()\n+      actionTypeToShow[propertyPath] = {\n+        isActive: true,\n+        displayName: `${toTitleCase(propertyPath)} (${actionTypeToCardCount[propertyPath] || 0})`\n+      };\n+    })(actionTypes);\n+    setActiveActionTypes(actionTypeToShow);\n+  }, [actionTypes]);\n+\n+  useEffect(() => {\n+    const result: { [key: string]: number } = {};\n+    fp.forEach(action => {\n+      fp.forEach((actionType: string) => {\n+        result[actionType] = (result[actionType] || 0) + 1;\n+      })(getActionTypes(action));\n+      setActionTypeToCardCount(result);\n+    })(actions);\n+  }, [actions]);\n+\n+  const updateFilterCallback = (actionType: string, isActive: boolean) => {\n+    const newActiveActionTypes = fp.clone(activeActionTypes);\n+    newActiveActionTypes[actionType].isActive = isActive;\n+    setActiveActionTypes(newActiveActionTypes);\n+  };\n+\n+  function getActionTypes(action: AuditAction) {\n+    return fp.map((e: AuditEventBundle) => e.header.actionType)(action.eventBundles);\n+  }\n \n-  // Temporary workaround for sort order in the APIs, fixed in RW-4999.\n-  const actionsSorted = actions.sort((a, b) => {\n-    return new Date(b.actionTime).getTime() - new Date(a.actionTime).getTime();\n-  });\n+  // An action card should be shown only iff all action types\n+  // in its bundles are active (checked). Arguably this could be a simple boolean\n+  // property on the card, but then we'd have to manage that from a parent component\n+  // and use a callback, so it's not a big win.\n+  const shouldShowAction = (action: AuditAction) => {\n+    const cardActionTypes = getActionTypes(action);\n+    return fp.all((actionType: string) =>\n+        fp.get(`${actionType}.isActive`)(activeActionTypes))(cardActionTypes);\n+  };\n \n   return (\n-      <div style={{margin: '1rem', width: '30rem'}}>\n-        {actionsSorted.map((action, index) => (<AuditActionCard key={index} action={action}/>))}\n-      </div>\n+      <React.Fragment>\n+        <ActionTypeFilter activeActionTypes={activeActionTypes}\n+                          updateFilter={updateFilterCallback}\n+        />\n+        <div style={{margin: '1rem', width: '30rem'}}>\n+          {fp.any(shouldShowAction)(actions)", "originalCommit": "c6b751afefde54cc34f0bed38f4694b361dc5167", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzI1Mjk1Ng==", "url": "https://github.com/all-of-us/workbench/pull/3835#discussion_r467252956", "bodyText": "I agree that's cleaner here. I could rename show to dontBeNull and get the same idea across.", "author": "jaycarlton", "createdAt": "2020-08-07T20:25:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzA4Mzg2Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzA4NjEzMA==", "url": "https://github.com/all-of-us/workbench/pull/3835#discussion_r467086130", "bodyText": "Could this be done with a map - preventing the need to mutate the object?", "author": "petesantos", "createdAt": "2020-08-07T14:44:27Z", "path": "ui/src/app/components/admin/audit-card-list-view.tsx", "diffHunk": "@@ -193,17 +210,115 @@ const AuditActionCard = (props: { action: AuditAction }) => {\n   );\n };\n \n-export const AuditActionCardListView = (props: { actions: AuditAction[]}) => {\n+interface FilterEntry {\n+  displayName?: string;\n+  isActive: boolean;\n+}\n+\n+const ActionTypeFilter = (props: {\n+  activeActionTypes: { [key: string]: FilterEntry },\n+  updateFilter: (actionType: string, isActive: boolean) => void }) => {\n+\n+  const {activeActionTypes, updateFilter} = props;\n+\n+  const toggleSelectedAction = (actionType) => {\n+    updateFilter(actionType, !fp.get(`${actionType}.isActive`)(activeActionTypes));\n+  };\n+\n+  return (\n+      <React.Fragment>\n+        <div style={{\n+          margin: '0',\n+          display: 'flex',\n+          flexDirection: 'column',\n+          textAlign: 'left',\n+          border: '1px solid',\n+          borderColor: colors.secondary,\n+          width: 'fit-content'\n+        }}>\n+        <div style={{fontWeight: 600, color: colors.accent}}>Action Types</div>\n+        {fp.entries(activeActionTypes).map((actionTypeValuePair: [string, FilterEntry], index) =>\n+          <CheckBox\n+            key={index}\n+            id={`${actionTypeValuePair[0]}_active`}\n+            onChange={() => toggleSelectedAction(actionTypeValuePair[0])}\n+            label={actionTypeValuePair[1].displayName}\n+            checked={actionTypeValuePair[1].isActive}\n+            style={{margin: '0.25rem'}}/>)}\n+        </div>\n+    </React.Fragment>);\n+};\n+\n+export const AuditActionCardListView = (props: { actions:  AuditAction[]}) => {\n   const {actions} = props;\n+  const [actionTypes, setActionTypes] = useState([]);\n+  const [activeActionTypes, setActiveActionTypes] = useState({});\n+  const [actionTypeToCardCount, setActionTypeToCardCount] = useState({});\n+\n+  useEffect(() => {\n+    const result = (fp.flow(\n+      fp.flatMap((action: AuditAction) => action.eventBundles),\n+      fp.map((eventBundle) => eventBundle.header.actionType),\n+      fp.sortBy(a => a),\n+      fp.sortedUniq)(actions));\n+    setActionTypes(result);\n+  }, [actions]);\n+\n+  useEffect(() => {\n+    const actionTypeToShow: Object = {};\n+    fp.forEach((propertyPath: string) => {\n+      // TODO: figure out why I can't make this work using fp.set()\n+      actionTypeToShow[propertyPath] = {\n+        isActive: true,\n+        displayName: `${toTitleCase(propertyPath)} (${actionTypeToCardCount[propertyPath] || 0})`\n+      };\n+    })(actionTypes);\n+    setActiveActionTypes(actionTypeToShow);\n+  }, [actionTypes]);\n+\n+  useEffect(() => {\n+    const result: { [key: string]: number } = {};\n+    fp.forEach(action => {", "originalCommit": "c6b751afefde54cc34f0bed38f4694b361dc5167", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzA4NzA1OA==", "url": "https://github.com/all-of-us/workbench/pull/3835#discussion_r467087058", "bodyText": "Could this be a map rather than a forEach with object mutation?", "author": "petesantos", "createdAt": "2020-08-07T14:46:07Z", "path": "ui/src/app/components/admin/audit-card-list-view.tsx", "diffHunk": "@@ -193,17 +210,115 @@ const AuditActionCard = (props: { action: AuditAction }) => {\n   );\n };\n \n-export const AuditActionCardListView = (props: { actions: AuditAction[]}) => {\n+interface FilterEntry {\n+  displayName?: string;\n+  isActive: boolean;\n+}\n+\n+const ActionTypeFilter = (props: {\n+  activeActionTypes: { [key: string]: FilterEntry },\n+  updateFilter: (actionType: string, isActive: boolean) => void }) => {\n+\n+  const {activeActionTypes, updateFilter} = props;\n+\n+  const toggleSelectedAction = (actionType) => {\n+    updateFilter(actionType, !fp.get(`${actionType}.isActive`)(activeActionTypes));\n+  };\n+\n+  return (\n+      <React.Fragment>\n+        <div style={{\n+          margin: '0',\n+          display: 'flex',\n+          flexDirection: 'column',\n+          textAlign: 'left',\n+          border: '1px solid',\n+          borderColor: colors.secondary,\n+          width: 'fit-content'\n+        }}>\n+        <div style={{fontWeight: 600, color: colors.accent}}>Action Types</div>\n+        {fp.entries(activeActionTypes).map((actionTypeValuePair: [string, FilterEntry], index) =>\n+          <CheckBox\n+            key={index}\n+            id={`${actionTypeValuePair[0]}_active`}\n+            onChange={() => toggleSelectedAction(actionTypeValuePair[0])}\n+            label={actionTypeValuePair[1].displayName}\n+            checked={actionTypeValuePair[1].isActive}\n+            style={{margin: '0.25rem'}}/>)}\n+        </div>\n+    </React.Fragment>);\n+};\n+\n+export const AuditActionCardListView = (props: { actions:  AuditAction[]}) => {\n   const {actions} = props;\n+  const [actionTypes, setActionTypes] = useState([]);\n+  const [activeActionTypes, setActiveActionTypes] = useState({});\n+  const [actionTypeToCardCount, setActionTypeToCardCount] = useState({});\n+\n+  useEffect(() => {\n+    const result = (fp.flow(\n+      fp.flatMap((action: AuditAction) => action.eventBundles),\n+      fp.map((eventBundle) => eventBundle.header.actionType),\n+      fp.sortBy(a => a),\n+      fp.sortedUniq)(actions));\n+    setActionTypes(result);\n+  }, [actions]);\n+\n+  useEffect(() => {\n+    const actionTypeToShow: Object = {};\n+    fp.forEach((propertyPath: string) => {", "originalCommit": "c6b751afefde54cc34f0bed38f4694b361dc5167", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzA4OTUwMw==", "url": "https://github.com/all-of-us/workbench/pull/3835#discussion_r467089503", "bodyText": "Given that this effect runs on the prop change, and there is only one prop, it may be possible to eliminate all of the useEffect code and just compute all of the needed values. This would eliminate all 'state' in the react sense.", "author": "petesantos", "createdAt": "2020-08-07T14:50:03Z", "path": "ui/src/app/components/admin/audit-card-list-view.tsx", "diffHunk": "@@ -193,17 +210,115 @@ const AuditActionCard = (props: { action: AuditAction }) => {\n   );\n };\n \n-export const AuditActionCardListView = (props: { actions: AuditAction[]}) => {\n+interface FilterEntry {\n+  displayName?: string;\n+  isActive: boolean;\n+}\n+\n+const ActionTypeFilter = (props: {\n+  activeActionTypes: { [key: string]: FilterEntry },\n+  updateFilter: (actionType: string, isActive: boolean) => void }) => {\n+\n+  const {activeActionTypes, updateFilter} = props;\n+\n+  const toggleSelectedAction = (actionType) => {\n+    updateFilter(actionType, !fp.get(`${actionType}.isActive`)(activeActionTypes));\n+  };\n+\n+  return (\n+      <React.Fragment>\n+        <div style={{\n+          margin: '0',\n+          display: 'flex',\n+          flexDirection: 'column',\n+          textAlign: 'left',\n+          border: '1px solid',\n+          borderColor: colors.secondary,\n+          width: 'fit-content'\n+        }}>\n+        <div style={{fontWeight: 600, color: colors.accent}}>Action Types</div>\n+        {fp.entries(activeActionTypes).map((actionTypeValuePair: [string, FilterEntry], index) =>\n+          <CheckBox\n+            key={index}\n+            id={`${actionTypeValuePair[0]}_active`}\n+            onChange={() => toggleSelectedAction(actionTypeValuePair[0])}\n+            label={actionTypeValuePair[1].displayName}\n+            checked={actionTypeValuePair[1].isActive}\n+            style={{margin: '0.25rem'}}/>)}\n+        </div>\n+    </React.Fragment>);\n+};\n+\n+export const AuditActionCardListView = (props: { actions:  AuditAction[]}) => {\n   const {actions} = props;\n+  const [actionTypes, setActionTypes] = useState([]);\n+  const [activeActionTypes, setActiveActionTypes] = useState({});\n+  const [actionTypeToCardCount, setActionTypeToCardCount] = useState({});\n+\n+  useEffect(() => {", "originalCommit": "c6b751afefde54cc34f0bed38f4694b361dc5167", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzEwNjYyOA==", "url": "https://github.com/all-of-us/workbench/pull/3835#discussion_r467106628", "bodyText": "Oh, right. I don't a \"prop change handler\" because that's just render(), aka the body of my function element.", "author": "jaycarlton", "createdAt": "2020-08-07T15:19:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzA4OTUwMw=="}], "type": "inlineReview"}, {"oid": "bfeaeafe04e3e357bdbc3b3493270123f99be641", "url": "https://github.com/all-of-us/workbench/commit/bfeaeafe04e3e357bdbc3b3493270123f99be641", "message": "Merge branch 'master' into jaycarlton/filterAudit", "committedDate": "2020-08-07T15:03:05Z", "type": "commit"}, {"oid": "1db335f19e89d3d471df6ce066d30c81323edbf8", "url": "https://github.com/all-of-us/workbench/commit/1db335f19e89d3d471df6ce066d30c81323edbf8", "message": "some fixes, but broken - DO NOT MERGEE [skip ci]", "committedDate": "2020-08-07T20:15:11Z", "type": "commit"}, {"oid": "92d090d6b2c6bafd72994f4171ebd4e81ca95fe6", "url": "https://github.com/all-of-us/workbench/commit/92d090d6b2c6bafd72994f4171ebd4e81ca95fe6", "message": "fixup:", "committedDate": "2020-08-10T14:17:26Z", "type": "commit"}, {"oid": "112f2029823c4df56f0a6b18014af297418053ab", "url": "https://github.com/all-of-us/workbench/commit/112f2029823c4df56f0a6b18014af297418053ab", "message": "Merge branch 'master' into jaycarlton/filterAudit", "committedDate": "2020-08-10T14:17:42Z", "type": "commit"}, {"oid": "2e62869698d61d0b36c022648f6a0d4549c863fb", "url": "https://github.com/all-of-us/workbench/commit/2e62869698d61d0b36c022648f6a0d4549c863fb", "message": "Remove some state from AuditActionCardListView", "committedDate": "2020-08-10T15:37:51Z", "type": "commit"}, {"oid": "5025f3a138fb46b31144bb61772693267efbf395", "url": "https://github.com/all-of-us/workbench/commit/5025f3a138fb46b31144bb61772693267efbf395", "message": "name tweak", "committedDate": "2020-08-10T15:43:51Z", "type": "commit"}, {"oid": "68a8582936176e0a09506b8776bcbf9044908f4a", "url": "https://github.com/all-of-us/workbench/commit/68a8582936176e0a09506b8776bcbf9044908f4a", "message": "tweaks", "committedDate": "2020-08-10T18:17:26Z", "type": "commit"}, {"oid": "51fa79a0263160da76771d5c73f56f5d39768928", "url": "https://github.com/all-of-us/workbench/commit/51fa79a0263160da76771d5c73f56f5d39768928", "message": "merge Pete's changes", "committedDate": "2020-08-10T18:21:51Z", "type": "commit"}, {"oid": "fb30b676278b7cdeeb6171c8d6c32d8f15626899", "url": "https://github.com/all-of-us/workbench/commit/fb30b676278b7cdeeb6171c8d6c32d8f15626899", "message": "fix merge errors", "committedDate": "2020-08-10T19:09:08Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzI1NDEyNQ==", "url": "https://github.com/all-of-us/workbench/pull/3835#discussion_r467254125", "bodyText": "This is giving me all zero values somehow.", "author": "jaycarlton", "createdAt": "2020-08-07T20:28:39Z", "path": "ui/src/app/components/admin/audit-card-list-view.tsx", "diffHunk": "@@ -193,17 +210,127 @@ const AuditActionCard = (props: { action: AuditAction }) => {\n   );\n };\n \n-export const AuditActionCardListView = (props: { actions: AuditAction[]}) => {\n+interface FilterEntry {\n+  displayName?: string;\n+  isActive: boolean;\n+}\n+\n+interface FilterState {\n+  [key: string]: FilterEntry;\n+}\n+\n+const ActionTypeFilter = (props: {\n+  activeActionTypes: FilterState,\n+  updateFilter: (actionType: string, isActive: boolean) => void }) => {\n+\n+  const {activeActionTypes, updateFilter} = props;\n+\n+  const toggleSelectedAction = (actionType) => {\n+    updateFilter(actionType, !fp.get(`${actionType}.isActive`)(activeActionTypes));\n+  };\n+\n+  return (\n+      <React.Fragment>\n+        <div style={{\n+          marginLeft: '0',\n+          padding: '2px',\n+          display: 'flex',\n+          flexDirection: 'column',\n+          textAlign: 'left',\n+          border: `1px solid ${colors.secondary}`,\n+          width: 'fit-content'\n+        }}>\n+        <div style={{fontWeight: 600, color: colors.accent}}>Action Types</div>\n+          {\n+            fp.flow(\n+              fp.toPairs,\n+              fp.toPairs,\n+              fp.map(([index, [id, entry]]: [number, [string, FilterEntry]]) =>\n+                    <CheckBox\n+                        key={index}\n+                        id={`${id}_active`}\n+                        onChange={() => toggleSelectedAction(id)}\n+                        label={entry.displayName}\n+                        checked={entry.isActive}\n+                        style={{margin: '0.25rem'}}/>)\n+            )(activeActionTypes)\n+          }\n+        </div>\n+    </React.Fragment>);\n+};\n+\n+export const AuditActionCardListView = (props: { actions:  AuditAction[]}) => {\n+  console.log('render AuditActionCardListView');\n   const {actions} = props;\n+  const initialFilterState: FilterState = {};\n+  const [activeActionTypes, setActiveActionTypes] = useState(initialFilterState);\n+\n+  // FIXME: handle situation when one card has the same action multiple times\n+  const actionTypeToCardCount: {[key: string]: number} = fp.flow(", "originalCommit": "1db335f19e89d3d471df6ce066d30c81323edbf8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODEzNTgyMw==", "url": "https://github.com/all-of-us/workbench/pull/3835#discussion_r468135823", "bodyText": "I am not seeing this issue - I am seeing results.  Is this happening on all queries?", "author": "petesantos", "createdAt": "2020-08-10T19:35:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzI1NDEyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODU1MTY0Mg==", "url": "https://github.com/all-of-us/workbench/pull/3835#discussion_r468551642", "bodyText": "No, the issue is when a card has multiple eventBundles with the same action type. Frequently happens with Collaborate when you share a workspace with multiple people. We end up counting that card several times for the repeated action type.\nI think we just need to map the cards to tuples of unique action types, and then use that to build the map. I know how to do that part, but I'm not sure how to transform [[A, B, C], [A, A, A], [D]] into {A: 2, B: 1, C: 1, D: 1}.", "author": "jaycarlton", "createdAt": "2020-08-11T12:46:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzI1NDEyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODU3NjU3Nw==", "url": "https://github.com/all-of-us/workbench/pull/3835#discussion_r468576577", "bodyText": "I think I resolved this with:\n  const getActionTypes = (action: AuditAction) => fp.flow(\n    fp.map((e: AuditEventBundle) => e.header.actionType),\n    fp.uniq\n  )(action.eventBundles);\nI pushed the change.", "author": "petesantos", "createdAt": "2020-08-11T13:25:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzI1NDEyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODYxMDc5MA==", "url": "https://github.com/all-of-us/workbench/pull/3835#discussion_r468610790", "bodyText": "Oh I see. Once we have the unique count per card, we can just flatten that and count each one. I was thinking we had to   keep track of the original tuples somehow. Thanks.", "author": "jaycarlton", "createdAt": "2020-08-11T14:12:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzI1NDEyNQ=="}], "type": "inlineReview"}, {"oid": "30d4a5af0a0449d862538910a719ac2e5877c8df", "url": "https://github.com/all-of-us/workbench/commit/30d4a5af0a0449d862538910a719ac2e5877c8df", "message": "Correct for multi action event bundles", "committedDate": "2020-08-11T13:11:57Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODYxNzAxOQ==", "url": "https://github.com/all-of-us/workbench/pull/3835#discussion_r468617019", "bodyText": "Is there a slicker way to do this? In Java, there's a builder pattern that will let you do Builder.from(originalObj).withId(2).build with no  mutations.", "author": "jaycarlton", "createdAt": "2020-08-11T14:17:34Z", "path": "ui/src/app/components/admin/audit-card-list-view.tsx", "diffHunk": "@@ -193,17 +210,109 @@ const AuditActionCard = (props: { action: AuditAction }) => {\n   );\n };\n \n-export const AuditActionCardListView = (props: { actions: AuditAction[]}) => {\n+interface FilterEntry {\n+  displayName?: string;\n+  isActive: boolean;\n+}\n+\n+interface FilterState {\n+  [key: string]: FilterEntry;\n+}\n+\n+const ActionTypeFilter = (props: {\n+  activeActionTypes: FilterState,\n+  updateFilter: (actionType: string, isActive: boolean) => void }) => {\n+\n+  const {activeActionTypes, updateFilter} = props;\n+\n+  const toggleSelectedAction = (actionType) => {\n+    updateFilter(actionType, !fp.get(`${actionType}.isActive`)(activeActionTypes));\n+  };\n+\n+  return (\n+      <React.Fragment>\n+        <div style={{\n+          marginLeft: '0',\n+          padding: '2px',\n+          display: 'flex',\n+          flexDirection: 'column',\n+          textAlign: 'left',\n+          border: `1px solid ${colors.secondary}`,\n+          width: 'fit-content'\n+        }}>\n+        <div style={{fontWeight: 600, color: colors.accent}}>Action Types</div>\n+          {\n+            fp.flow(\n+              fp.toPairs,\n+              fp.toPairs,\n+              fp.map(([index, [id, entry]]: [number, [string, FilterEntry]]) =>\n+                    <CheckBox\n+                        key={index}\n+                        id={`${id}_active`}\n+                        onChange={() => toggleSelectedAction(id)}\n+                        label={entry.displayName}\n+                        checked={entry.isActive}\n+                        style={{margin: '0.25rem'}}/>)\n+            )(activeActionTypes)\n+          }\n+        </div>\n+    </React.Fragment>);\n+};\n+\n+export const AuditActionCardListView = (props: { actions:  AuditAction[]}) => {\n   const {actions} = props;\n+  const [activeActionTypes, setActiveActionTypes] = useState({});\n+\n+  const getActionTypes = (action: AuditAction) => fp.flow(\n+    fp.map((e: AuditEventBundle) => e.header.actionType),\n+    fp.uniq\n+  )(action.eventBundles);\n+\n+  useEffect(() => {\n+    const actionTypeToShow = fp.flow(\n+      fp.flatMap(getActionTypes),\n+      fp.countBy(fp.identity),\n+      fp.toPairs,\n+      fp.map(([actionName, count]: [string, number]) => [actionName, {\n+        isActive: true,\n+        displayName: `${toTitleCase(actionName)} (${count || 0})`\n+      }]),\n+      fp.fromPairs\n+    )(actions);\n+\n+    setActiveActionTypes(actionTypeToShow);\n+  }, [actions]);\n+\n+  const updateFilterCallback = (actionType: string, isActive: boolean) => {\n+    const newActiveActionTypes = fp.clone(activeActionTypes);", "originalCommit": "30d4a5af0a0449d862538910a719ac2e5877c8df", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODYyMDA3NA==", "url": "https://github.com/all-of-us/workbench/pull/3835#discussion_r468620074", "bodyText": "Missed this comment when I approved - let me take a look", "author": "petesantos", "createdAt": "2020-08-11T14:21:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODYxNzAxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODYyNDQ0NA==", "url": "https://github.com/all-of-us/workbench/pull/3835#discussion_r468624444", "bodyText": "It's just a curiosity, so no worries.", "author": "jaycarlton", "createdAt": "2020-08-11T14:27:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODYxNzAxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODYyNjIzNA==", "url": "https://github.com/all-of-us/workbench/pull/3835#discussion_r468626234", "bodyText": "I saw you merged, but if you are looking for an alternative this should work:\n const updateFilterCallback = (actionType: string, isActive: boolean) => {\n    setActiveActionTypes(fp.set([actionType, 'isActive'], isActive, activeActionTypes));\n  };", "author": "petesantos", "createdAt": "2020-08-11T14:29:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODYxNzAxOQ=="}], "type": "inlineReview"}]}