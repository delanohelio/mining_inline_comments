{"pr_number": 3112, "pr_title": "[RW-4303][risk=no] Refactor datasets page and fix race conditions", "pr_createdAt": "2020-02-11T07:19:47Z", "pr_url": "https://github.com/all-of-us/workbench/pull/3112", "timeline": [{"oid": "e52ea60e4acdd11fb53c7e5dce10ed568cfeb6af", "url": "https://github.com/all-of-us/workbench/commit/e52ea60e4acdd11fb53c7e5dce10ed568cfeb6af", "message": "Fix datasets freeze", "committedDate": "2020-02-11T07:20:19Z", "type": "commit"}, {"oid": "e52ea60e4acdd11fb53c7e5dce10ed568cfeb6af", "url": "https://github.com/all-of-us/workbench/commit/e52ea60e4acdd11fb53c7e5dce10ed568cfeb6af", "message": "Fix datasets freeze", "committedDate": "2020-02-11T07:20:19Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzY4MTk3MQ==", "url": "https://github.com/all-of-us/workbench/pull/3112#discussion_r377681971", "bodyText": "Is there a ticket for the refactor here? If not, we probably should file one.", "author": "s-rubenstein", "createdAt": "2020-02-11T14:50:45Z", "path": "ui/src/app/pages/data/data-set/dataset-page.tsx", "diffHunk": "@@ -426,47 +444,100 @@ const DataSetPage = fp.flow(withUserProfile(), withCurrentWorkspace(), withUrlPa\n \n     async componentDidMount() {\n       const {namespace, id} = this.props.workspace;\n-      const allPromises = [];\n-      allPromises.push(this.loadResources());\n-      if (this.editing) {\n-        allPromises.push(dataSetApi().getDataSet(\n-          namespace, id, this.props.urlParams.dataSetId).then((response) => {\n-            this.setState({\n-              dataSet: response,\n-              includesAllParticipants: response.includesAllParticipants,\n-              selectedConceptSetIds: response.conceptSets.map(cs => cs.id),\n-              selectedCohortIds: response.cohorts.map(c => c.id),\n-              selectedDomainValuePairs: response.domainValuePairs,\n-              valuesLoading: true,\n-            });\n-            if (response.prePackagedConceptSet === PrePackagedConceptSetEnum.BOTH) {\n-              this.setState({prePackagedSurvey: true, prePackagedDemographics: true});\n-            } else if (response.prePackagedConceptSet === PrePackagedConceptSetEnum.DEMOGRAPHICS) {\n-              this.setState({prePackagedDemographics: true});\n-            } else if (response.prePackagedConceptSet === PrePackagedConceptSetEnum.SURVEY) {\n-              this.setState({prePackagedSurvey: true});\n+      const resourcesPromise = this.loadResources();\n+      if (!this.editing) {\n+        return;\n+      }\n+\n+      const [, dataSet] = await Promise.all([\n+        resourcesPromise,\n+        dataSetApi().getDataSet(namespace, id, this.props.urlParams.dataSetId)\n+      ]);\n+\n+      const selectedPrepackagedConceptSets = this.apiEnumToPrePackageConceptSets(dataSet.prePackagedConceptSet);\n+      this.setState({\n+        dataSet,\n+        includesAllParticipants: dataSet.includesAllParticipants,\n+        selectedConceptSetIds: dataSet.conceptSets.map(cs => cs.id),\n+        selectedCohortIds: dataSet.cohorts.map(c => c.id),\n+        selectedDomainValuePairs: dataSet.domainValuePairs,\n+        selectedDomains: this.getDomainsFromConceptSets(dataSet.conceptSets, selectedPrepackagedConceptSets),\n+        selectedPrepackagedConceptSets,\n+      });\n+    }\n+\n+    async componentDidUpdate({}, prevState: State) {\n+      // After a state update, first check whether any new domains have been added.\n+      const newDomains = Array.from(this.state.selectedDomains)\n+          .filter(d => !prevState.selectedDomains.has(d));\n+      if (!newDomains.length) {\n+        return;\n+      }\n+\n+      // TODO: There is a lot of complexity here around loading domain values\n+      // which is static data for a given CDR version. Consider refactoring this", "originalCommit": "e52ea60e4acdd11fb53c7e5dce10ed568cfeb6af", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzgxNDI1Mg==", "url": "https://github.com/all-of-us/workbench/pull/3112#discussion_r377814252", "bodyText": "Filed https://precisionmedicineinitiative.atlassian.net/browse/RW-4426", "author": "calbach", "createdAt": "2020-02-11T18:23:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzY4MTk3MQ=="}], "type": "inlineReview"}, {"oid": "d1da0e34a91b146aef4bfac947b801b37feca16c", "url": "https://github.com/all-of-us/workbench/commit/d1da0e34a91b146aef4bfac947b801b37feca16c", "message": "link ticket", "committedDate": "2020-02-11T18:22:10Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzgwODQ0Ng==", "url": "https://github.com/all-of-us/workbench/pull/3112#discussion_r377808446", "bodyText": "@NehaBroad @blrubenstein  I could not understand what was going on here with this .survey value. I didn't find any comments hinting at the rationale for this. I removed it in my PR because it was a potential source of bugs/inconsistency. If this is tracking a real requirement, let me know.\nRelatedly, I'm confused by this line: https://github.com/all-of-us/workbench/blob/master/ui/src/app/pages/data/data-set/dataset-page.tsx#L1010", "author": "calbach", "createdAt": "2020-02-11T18:11:49Z", "path": "ui/src/app/pages/data/data-set/dataset-page.tsx", "diffHunk": "@@ -919,25 +934,27 @@ const DataSetPage = fp.flow(withUserProfile(), withCurrentWorkspace(), withUrlPa\n                       </div>\n                     </div>\n                   </BoxHeader>\n-                  <div style={{height: valueSets.length > 0 ? '7.625rem' : '9rem', overflowY: 'auto'}}>\n-                    {valuesLoading && <Spinner style={{position: 'relative',\n+                  <div style={{height: selectedDomains.size > 0 ? '7.625rem' : '9rem', overflowY: 'auto'}}>\n+                    {domainValueSetIsLoading.size > 0 && <Spinner style={{position: 'relative',\n                       top: '2rem', left: 'calc(50% - 36px)'}}/>}\n-                    {valueSets.map(valueSet =>\n-                      <div key={valueSet.domain}>\n+                    {Array.from(selectedDomains).map(domain =>\n+                      domainValueSetLookup.has(domain) &&\n+                      <div key={domain}>\n                         <Subheader style={{fontWeight: 'bold'}}>\n-                          {valueSet.survey ? 'Survey' : formatDomain(valueSet.domain)}", "originalCommit": "e52ea60e4acdd11fb53c7e5dce10ed568cfeb6af", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk5MDA4Nw==", "url": "https://github.com/all-of-us/workbench/pull/3112#discussion_r377990087", "bodyText": "It might be because Survey was not initially not a DOMAIN hence we were checking if survey object is populated treat it as SURVEY", "author": "NehaBroad", "createdAt": "2020-02-12T01:06:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzgwODQ0Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk5MzE1MQ==", "url": "https://github.com/all-of-us/workbench/pull/3112#discussion_r377993151", "bodyText": "Could the OBSERVATION thing be because of api/src/main/java/org/pmiops/workbench/db/dao/ConceptSetDao.java L26?\n.put(Domain.SURVEY, \"observation\")", "author": "NehaBroad", "createdAt": "2020-02-12T01:18:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzgwODQ0Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODU1OTQxMQ==", "url": "https://github.com/all-of-us/workbench/pull/3112#discussion_r378559411", "bodyText": "Surveys used to be in the Observation domain, I've removed the special handling of this for now, since presumably we could have a concept set in the observation domain as well, and we'd want it to be labeled accordingly.", "author": "calbach", "createdAt": "2020-02-12T22:51:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzgwODQ0Ng=="}], "type": "inlineReview"}, {"oid": "9dea23c531b4d68a822864df4815214cad0dea8e", "url": "https://github.com/all-of-us/workbench/commit/9dea23c531b4d68a822864df4815214cad0dea8e", "message": "Add test case", "committedDate": "2020-02-12T01:30:35Z", "type": "commit"}, {"oid": "e0280b6aceb4290241f4228b6a910131d4ce38c1", "url": "https://github.com/all-of-us/workbench/commit/e0280b6aceb4290241f4228b6a910131d4ce38c1", "message": "another reg test", "committedDate": "2020-02-12T02:00:03Z", "type": "commit"}, {"oid": "56c0a00d09272e5c5cb15f83401cb0edef9e5c54", "url": "https://github.com/all-of-us/workbench/commit/56c0a00d09272e5c5cb15f83401cb0edef9e5c54", "message": "Drop pairs on deselection", "committedDate": "2020-02-12T02:00:32Z", "type": "commit"}, {"oid": "d5bbe25e03fb0c5803fa35a88f1bd597ae26d0da", "url": "https://github.com/all-of-us/workbench/commit/d5bbe25e03fb0c5803fa35a88f1bd597ae26d0da", "message": "sort and survey domain cleanup", "committedDate": "2020-02-12T02:26:17Z", "type": "commit"}, {"oid": "a726dddeae17115d54f186bf345edfd34a88f142", "url": "https://github.com/all-of-us/workbench/commit/a726dddeae17115d54f186bf345edfd34a88f142", "message": "fix and test", "committedDate": "2020-02-12T02:36:41Z", "type": "commit"}, {"oid": "56c4d488ab536d40c9c819a4e7ebd8a4578aa1d0", "url": "https://github.com/all-of-us/workbench/commit/56c4d488ab536d40c9c819a4e7ebd8a4578aa1d0", "message": ";", "committedDate": "2020-02-12T17:22:31Z", "type": "commit"}, {"oid": "0488b3f1d06eb309d605ac5d0207ed4192f7e3ff", "url": "https://github.com/all-of-us/workbench/commit/0488b3f1d06eb309d605ac5d0207ed4192f7e3ff", "message": "PERSON first, the rest alpha", "committedDate": "2020-02-12T18:30:04Z", "type": "commit"}, {"oid": "71dfcf94886d69d0ed6ff07a96c3440e6c4cf91d", "url": "https://github.com/all-of-us/workbench/commit/71dfcf94886d69d0ed6ff07a96c3440e6c4cf91d", "message": "fix value counting", "committedDate": "2020-02-12T18:48:02Z", "type": "commit"}, {"oid": "0a59d2ff04f84ed841ee40e8ba773049ac1b7dd3", "url": "https://github.com/all-of-us/workbench/commit/0a59d2ff04f84ed841ee40e8ba773049ac1b7dd3", "message": "Handle select all logic, and initial dataset load", "committedDate": "2020-02-12T19:24:08Z", "type": "commit"}, {"oid": "9de82260ef941d42504b2f3db4421cfb343d20ed", "url": "https://github.com/all-of-us/workbench/commit/9de82260ef941d42504b2f3db4421cfb343d20ed", "message": "fix ds", "committedDate": "2020-02-12T19:39:40Z", "type": "commit"}, {"oid": "8b442840a233c6b351a1e60ed0aef3ad2352c985", "url": "https://github.com/all-of-us/workbench/commit/8b442840a233c6b351a1e60ed0aef3ad2352c985", "message": "lint", "committedDate": "2020-02-12T22:44:35Z", "type": "commit"}]}