{"pr_number": 4267, "pr_title": "[risk=low][RW-5564][RW-5721] Workspace Creation/Duplication updates for CDR Versions ", "pr_createdAt": "2020-11-10T00:09:26Z", "pr_url": "https://github.com/all-of-us/workbench/pull/4267", "timeline": [{"oid": "19e9180a377872e5ad5d38a156201db44c0cb5e8", "url": "https://github.com/all-of-us/workbench/commit/19e9180a377872e5ad5d38a156201db44c0cb5e8", "message": "tests", "committedDate": "2020-11-10T19:08:44Z", "type": "forcePushed"}, {"oid": "f32afcd5086a8d31d5015f8103e7ee509fda2107", "url": "https://github.com/all-of-us/workbench/commit/f32afcd5086a8d31d5015f8103e7ee509fda2107", "message": "New CDR Version Upgrade Flag and Modal", "committedDate": "2020-11-15T20:49:38Z", "type": "forcePushed"}, {"oid": "832598b5e3e080e2d032afb3755239561ddcd6d6", "url": "https://github.com/all-of-us/workbench/commit/832598b5e3e080e2d032afb3755239561ddcd6d6", "message": "e2e test for old cdr version modal", "committedDate": "2020-11-16T20:10:05Z", "type": "forcePushed"}, {"oid": "2a436bd9c672936f2b10c6a15fd33db5e11879f8", "url": "https://github.com/all-of-us/workbench/commit/2a436bd9c672936f2b10c6a15fd33db5e11879f8", "message": "RW-5721 New CDR Version Upgrade Flag and Modal", "committedDate": "2020-11-17T00:21:07Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTIwMzAwMQ==", "url": "https://github.com/all-of-us/workbench/pull/4267#discussion_r525203001", "bodyText": "New method below: minimal work required to create a new workspace", "author": "jmthibault79", "createdAt": "2020-11-17T14:37:17Z", "path": "e2e/app/page/workspaces-page.ts", "diffHunk": "@@ -78,16 +78,33 @@ export default class WorkspacesPage extends WorkspaceEditPage {\n      billingAccount: string = UseFreeCredits,\n      reviewRequest: boolean = false): Promise<string[]> {\n \n+    const editPage = await this.fillOutRequiredCreationFields(workspaceName, billingAccount, reviewRequest);", "originalCommit": "576ffc31a61081251ec3180f99e547bba525e1ae", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTIwNTkyOQ==", "url": "https://github.com/all-of-us/workbench/pull/4267#discussion_r525205929", "bodyText": "or onClose?", "author": "jmthibault79", "createdAt": "2020-11-17T14:41:09Z", "path": "ui/src/app/pages/workspace/cdr-version-upgrade-modal.tsx", "diffHunk": "@@ -0,0 +1,38 @@\n+import * as React from 'react';\n+\n+import {Button, Clickable} from 'app/components/buttons';\n+import {FlexRow} from 'app/components/flex';\n+import {ClrIcon} from 'app/components/icons';\n+import {Modal, ModalBody, ModalFooter, ModalTitle} from 'app/components/modals';\n+import colors from 'app/styles/colors';\n+import {AnalyticsTracker} from 'app/utils/analytics';\n+\n+interface Props {\n+  defaultCdrVersionName: string;\n+  onDismiss: () => void;", "originalCommit": "576ffc31a61081251ec3180f99e547bba525e1ae", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjk5ODk1NA==", "url": "https://github.com/all-of-us/workbench/pull/4267#discussion_r526998954", "bodyText": "Searching the code I am not seeing any instances of onDismiss, but lots of onClose. Perhaps in this case we should go with the de-facto standard onClose", "author": "petesantos", "createdAt": "2020-11-19T15:56:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTIwNTkyOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTIwNzUxOA==", "url": "https://github.com/all-of-us/workbench/pull/4267#discussion_r525207518", "bodyText": "This is the only new field - the rest is just alphabetized", "author": "jmthibault79", "createdAt": "2020-11-17T14:43:14Z", "path": "ui/src/app/pages/workspace/workspace-edit.tsx", "diffHunk": "@@ -236,47 +237,49 @@ export interface WorkspaceEditProps {\n }\n \n export interface WorkspaceEditState {\n+  billingAccounts: Array<BillingAccount>;\n   cdrVersionItems: Array<CdrVersion>;\n+  cloneUserRole: boolean;\n+  loading: boolean;\n+  populationChecked: boolean;\n   selectResearchPurpose: boolean;\n+  showCdrVersionModal: boolean;", "originalCommit": "576ffc31a61081251ec3180f99e547bba525e1ae", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTIwODI0Mw==", "url": "https://github.com/all-of-us/workbench/pull/4267#discussion_r525208243", "bodyText": "the only new line; the rest is just alphabetized", "author": "jmthibault79", "createdAt": "2020-11-17T14:44:10Z", "path": "ui/src/app/pages/workspace/workspace-edit.tsx", "diffHunk": "@@ -236,47 +237,49 @@ export interface WorkspaceEditProps {\n }\n \n export interface WorkspaceEditState {\n+  billingAccounts: Array<BillingAccount>;\n   cdrVersionItems: Array<CdrVersion>;\n+  cloneUserRole: boolean;\n+  loading: boolean;\n+  populationChecked: boolean;\n   selectResearchPurpose: boolean;\n+  showCdrVersionModal: boolean;\n+  showConfirmationModal: boolean;\n+  showCreateBillingAccountModal: boolean;\n+  showResearchPurpose: boolean;\n+  showStigmatizationDetails: boolean;\n+  showUnderservedPopulationDetails: boolean;\n   workspace: Workspace;\n   workspaceCreationConflictError: boolean;\n   workspaceCreationError: boolean;\n   workspaceCreationErrorMessage: string;\n   workspaceNewAclDelayed: boolean;\n   workspaceNewAclDelayedContinueFn: Function;\n-  cloneUserRole: boolean;\n-  loading: boolean;\n-  showUnderservedPopulationDetails: boolean;\n-  showStigmatizationDetails: boolean;\n-  showResearchPurpose: boolean;\n-  billingAccounts: Array<BillingAccount>;\n-  showCreateBillingAccountModal: boolean;\n-  showConfirmationModal: boolean;\n-  populationChecked: boolean;\n }\n \n export const WorkspaceEdit = fp.flow(withRouteConfigData(), withCurrentWorkspace(), withCdrVersions(), withUserProfile())(\n   class WorkspaceEditCmp extends React.Component<WorkspaceEditProps, WorkspaceEditState> {\n     constructor(props: WorkspaceEditProps) {\n       super(props);\n       this.state = {\n+        billingAccounts: [],\n         cdrVersionItems: this.createInitialCdrVersionsList(),\n-        workspace: this.createInitialWorkspaceState(),\n+        cloneUserRole: false,\n+        loading: false,\n+        populationChecked: props.workspace ? props.workspace.researchPurpose.populationDetails.length > 0 : undefined,\n         selectResearchPurpose: this.updateSelectedResearch(),\n+        showCdrVersionModal: false,", "originalCommit": "576ffc31a61081251ec3180f99e547bba525e1ae", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTIwOTQ1MA==", "url": "https://github.com/all-of-us/workbench/pull/4267#discussion_r525209450", "bodyText": "Modal cancel: force the use of the default CDR\nModal continue (requires checkboxes): allows use of chosen older CDR", "author": "jmthibault79", "createdAt": "2020-11-17T14:45:34Z", "path": "ui/src/app/pages/workspace/workspace-edit.tsx", "diffHunk": "@@ -1004,10 +1008,18 @@ export const WorkspaceEdit = fp.flow(withRouteConfigData(), withCurrentWorkspace\n       return <FadeBox  style={{margin: 'auto', marginTop: '1rem', width: '95.7%'}}>\n         <div style={{width: '1120px'}}>\n           {loading && <SpinnerOverlay overrideStylesOverlay={styles.spinner}/>}\n+          {!hasDefaultCdrVersion(this.state.workspace, cdrVersionListResponse) && showCdrVersionModal &&\n+            <OldCdrVersionModal\n+                onCancel={() => {\n+                  this.setState(fp.set(['workspace', 'cdrVersionId'], cdrVersionListResponse.defaultCdrVersionId));", "originalCommit": "576ffc31a61081251ec3180f99e547bba525e1ae", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTIxMjEwNA==", "url": "https://github.com/all-of-us/workbench/pull/4267#discussion_r525212104", "bodyText": "For the circle around the flag.  The flag is a ClrIcon.", "author": "jmthibault79", "createdAt": "2020-11-17T14:48:47Z", "path": "ui/src/app/pages/workspace/workspace-nav-bar.tsx", "diffHunk": "@@ -56,9 +61,65 @@ const styles = reactStyles({\n   },\n   disabled: {\n     color: colors.disabled\n-  }\n+  },\n });\n \n+const stylesFunction = {\n+  cdrVersionFlagCircle: (alert: boolean): React.CSSProperties => {", "originalCommit": "576ffc31a61081251ec3180f99e547bba525e1ae", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTIxMjg0Nw==", "url": "https://github.com/all-of-us/workbench/pull/4267#discussion_r525212847", "bodyText": "Better location for this const?", "author": "jmthibault79", "createdAt": "2020-11-17T14:49:38Z", "path": "ui/src/app/pages/workspace/workspace-nav-bar.tsx", "diffHunk": "@@ -56,9 +61,65 @@ const styles = reactStyles({\n   },\n   disabled: {\n     color: colors.disabled\n-  }\n+  },\n });\n \n+const stylesFunction = {\n+  cdrVersionFlagCircle: (alert: boolean): React.CSSProperties => {\n+    return {\n+      border: 'solid 1px',\n+      borderRadius: '50%',\n+      height: '50px',\n+      width: '50px',\n+      marginLeft: '12px',\n+      padding: '4px',\n+      backgroundColor: alert ? colors.danger : colors.secondary,\n+    };\n+  }\n+};\n+\n+const USER_DISMISSED_ALERT_VALUE = 'DISMISSED';", "originalCommit": "576ffc31a61081251ec3180f99e547bba525e1ae", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTI5NTk3NQ==", "url": "https://github.com/all-of-us/workbench/pull/4267#discussion_r525295975", "bodyText": "I'd create a new file for cdr tests like workspace-cdr.spec.ts to include this new test and the test below to take advantage of running tests in parallel threads.", "author": "aweng98", "createdAt": "2020-11-17T16:23:01Z", "path": "e2e/tests/workspace/workspace-create.spec.ts", "diffHunk": "@@ -72,6 +73,26 @@ describe('Creating new workspaces', () => {\n     await verifyWorkspaceLinkOnDataPage(newWorkspaceName);\n   });\n \n+  test('User cannot create a workspace with an old CDR Version without consenting to the restrictions', async () => {", "originalCommit": "1f3fee0a93aab8b096304cf74a7abf95bc063423", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTQxNjUzMQ==", "url": "https://github.com/all-of-us/workbench/pull/4267#discussion_r525416531", "bodyText": "nit: finding any object in a modal should use the modal parent: Checkbox.findByName(this.page, FIELD.willUseCheckbox.textOption, this);", "author": "aweng98", "createdAt": "2020-11-17T19:09:33Z", "path": "e2e/app/page/old-cdr-version-modal.ts", "diffHunk": "@@ -0,0 +1,76 @@\n+import {Page} from 'puppeteer';\n+\n+import Button from 'app/element/button';\n+import Modal from 'app/component/modal';\n+import {waitWhileLoading} from 'utils/waits-utils';\n+import {ElementType} from '../xpath-options';\n+import {LinkText} from '../text-labels';\n+import Checkbox from '../element/checkbox';\n+\n+const LabelAlias = {\n+    WILL_USE_OLD_CDR_VERSION: 'I will use this workspace to complete an existing study or replicate a previous study.',\n+    WILL_IDENTIFY_OLD_CDR_VERSION: 'In the workspace description below, I will identify which study I am continuing or replicating.',\n+}\n+\n+const FIELD = {\n+    willUseCheckbox: {\n+        textOption: {name: LabelAlias.WILL_USE_OLD_CDR_VERSION, type: ElementType.Checkbox}\n+    },\n+    willIdentifyCheckbox: {\n+        textOption: {name: LabelAlias.WILL_IDENTIFY_OLD_CDR_VERSION, type: ElementType.Checkbox}\n+    },\n+    continueButton: {\n+        textOption: {name: LinkText.Continue}\n+    },\n+}\n+\n+export default class OldCdrVersionModal extends Modal {\n+\n+    constructor(page: Page, xpath?: string) {\n+        super(page, xpath);\n+    }\n+\n+    async isLoaded(): Promise<boolean> {\n+        const xpath = '//*[@data-test-id=\"old-cdr-version-modal\"]';\n+        await Promise.all([\n+            this.page.waitForXPath(xpath),\n+            waitWhileLoading(this.page),\n+        ]);\n+        return true;\n+    }\n+\n+    async getWillUseCheckbox(): Promise<Checkbox> {\n+        return Checkbox.findByName(this.page, FIELD.willUseCheckbox.textOption);", "originalCommit": "8f582caaf4613dc48cfe5512b989abf49be98689", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjk5NTUyNw==", "url": "https://github.com/all-of-us/workbench/pull/4267#discussion_r526995527", "bodyText": "Does this need to be a string, could it be a boolean in localStorage?", "author": "petesantos", "createdAt": "2020-11-19T15:51:57Z", "path": "ui/src/app/pages/workspace/workspace-nav-bar.tsx", "diffHunk": "@@ -56,9 +61,63 @@ const styles = reactStyles({\n   },\n   disabled: {\n     color: colors.disabled\n-  }\n+  },\n });\n \n+const stylesFunction = {\n+  cdrVersionFlagCircle: (alert: boolean): React.CSSProperties => {\n+    return {\n+      border: 'solid 1px',\n+      borderRadius: '50%',\n+      height: '50px',\n+      width: '50px',\n+      marginLeft: '12px',\n+      padding: '4px',\n+      backgroundColor: alert ? colors.danger : colors.secondary,\n+    };\n+  }\n+};\n+\n+const USER_DISMISSED_ALERT_VALUE = 'DISMISSED';", "originalCommit": "92a4cb217d56271a6d64f58639d9fd80485b4aed", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzAzMDAzNQ==", "url": "https://github.com/all-of-us/workbench/pull/4267#discussion_r527030035", "bodyText": "Yes, the spec is strings-only.  https://www.w3.org/Bugs/Public/show_bug.cgi?id=12111", "author": "jmthibault79", "createdAt": "2020-11-19T16:37:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjk5NTUyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzA3MjU5NQ==", "url": "https://github.com/all-of-us/workbench/pull/4267#discussion_r527072595", "bodyText": "Ah - I did not know that - thanks!", "author": "petesantos", "createdAt": "2020-11-19T17:34:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjk5NTUyNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjk5NjI5Ng==", "url": "https://github.com/all-of-us/workbench/pull/4267#discussion_r526996296", "bodyText": "Could we initialize the state with:\nlocalStorage.getItem(localStorageKey) === USER_DISMISSED_ALERT_VALUE\nor just the value if the localStorage value is a boolean?", "author": "petesantos", "createdAt": "2020-11-19T15:52:55Z", "path": "ui/src/app/pages/workspace/workspace-nav-bar.tsx", "diffHunk": "@@ -56,9 +61,63 @@ const styles = reactStyles({\n   },\n   disabled: {\n     color: colors.disabled\n-  }\n+  },\n });\n \n+const stylesFunction = {\n+  cdrVersionFlagCircle: (alert: boolean): React.CSSProperties => {\n+    return {\n+      border: 'solid 1px',\n+      borderRadius: '50%',\n+      height: '50px',\n+      width: '50px',\n+      marginLeft: '12px',\n+      padding: '4px',\n+      backgroundColor: alert ? colors.danger : colors.secondary,\n+    };\n+  }\n+};\n+\n+const USER_DISMISSED_ALERT_VALUE = 'DISMISSED';\n+\n+const CdrVersion = (props: {workspace: Workspace, cdrVersionListResponse: CdrVersionListResponse}) => {\n+  const [showModal, setShowModal] = useState(false);\n+  const [userHasDismissedAlert, setUserHasDismissedAlert] = useState(false);\n+\n+  const {workspace, cdrVersionListResponse} = props;\n+  const {namespace, id} = workspace;\n+\n+  const localStorageKey = `${namespace}-${id}-user-dismissed-cdr-version-update-alert`;\n+\n+  // check whether the user has previously dismissed the alert in localStorage, to determine icon color\n+  useEffect(() =>\n+      setUserHasDismissedAlert(localStorage.getItem(localStorageKey) === USER_DISMISSED_ALERT_VALUE)", "originalCommit": "92a4cb217d56271a6d64f58639d9fd80485b4aed", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzA4MzMzNg==", "url": "https://github.com/all-of-us/workbench/pull/4267#discussion_r527083336", "bodyText": "looks like yes", "author": "jmthibault79", "createdAt": "2020-11-19T17:51:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjk5NjI5Ng=="}], "type": "inlineReview"}, {"oid": "8b2a7164cce9b3f362d18eb341698b5933a476fc", "url": "https://github.com/all-of-us/workbench/commit/8b2a7164cce9b3f362d18eb341698b5933a476fc", "message": "onDismiss -> onClose", "committedDate": "2020-11-19T16:52:47Z", "type": "forcePushed"}, {"oid": "687ce92b5ff6d03055b5145204cf0fd5605ced52", "url": "https://github.com/all-of-us/workbench/commit/687ce92b5ff6d03055b5145204cf0fd5605ced52", "message": "RW-5564 checkbox requirements for choosing an old CDR Version\n- OldCdrVersionModal", "committedDate": "2020-11-19T17:51:45Z", "type": "commit"}, {"oid": "8336d0063619ba64815e69f1f794d51f77aeda9c", "url": "https://github.com/all-of-us/workbench/commit/8336d0063619ba64815e69f1f794d51f77aeda9c", "message": "RW-5721 New CDR Version Upgrade Flag and Modal", "committedDate": "2020-11-19T17:53:00Z", "type": "commit"}, {"oid": "acd7f0b18f9f63cdc465c36c9fd04d4081cb6e83", "url": "https://github.com/all-of-us/workbench/commit/acd7f0b18f9f63cdc465c36c9fd04d4081cb6e83", "message": "This is disgusting but it works", "committedDate": "2020-11-19T17:53:08Z", "type": "commit"}, {"oid": "de59a67168fbaad3c2fbee8da7926a300d332495", "url": "https://github.com/all-of-us/workbench/commit/de59a67168fbaad3c2fbee8da7926a300d332495", "message": "make data-test-id propagation optional for Clickable", "committedDate": "2020-11-19T17:53:08Z", "type": "commit"}, {"oid": "fd6ac22ebe30332e30068d86029bd88beadbfabc", "url": "https://github.com/all-of-us/workbench/commit/fd6ac22ebe30332e30068d86029bd88beadbfabc", "message": "lint", "committedDate": "2020-11-19T17:53:09Z", "type": "commit"}, {"oid": "1e4b811d6eeac1663d48024530cd7bbd6bac6f72", "url": "https://github.com/all-of-us/workbench/commit/1e4b811d6eeac1663d48024530cd7bbd6bac6f72", "message": "e2e cdr-version-upgrade-modal.ts", "committedDate": "2020-11-19T17:53:10Z", "type": "commit"}, {"oid": "dacfc803fb708ceced264f68ef5adf37575f9693", "url": "https://github.com/all-of-us/workbench/commit/dacfc803fb708ceced264f68ef5adf37575f9693", "message": "e2e old-cdr-version-modal.ts", "committedDate": "2020-11-19T17:53:10Z", "type": "commit"}, {"oid": "594ea1598975e692657eb33712ee180f0d38e8c1", "url": "https://github.com/all-of-us/workbench/commit/594ea1598975e692657eb33712ee180f0d38e8c1", "message": "split up workspace e2e tests for parallelization", "committedDate": "2020-11-19T17:53:11Z", "type": "commit"}, {"oid": "d626f6cd31db2798f0d94a2bbb9e5b92589c21ec", "url": "https://github.com/all-of-us/workbench/commit/d626f6cd31db2798f0d94a2bbb9e5b92589c21ec", "message": "split up cdr0versions e2e tests", "committedDate": "2020-11-19T17:53:11Z", "type": "commit"}, {"oid": "d817da22b05eb70485cbb10be9926cea88a8080b", "url": "https://github.com/all-of-us/workbench/commit/d817da22b05eb70485cbb10be9926cea88a8080b", "message": "add this-container to modal methods", "committedDate": "2020-11-19T17:53:12Z", "type": "commit"}, {"oid": "2831db91b58aac169d5007cc21bfe0203d254916", "url": "https://github.com/all-of-us/workbench/commit/2831db91b58aac169d5007cc21bfe0203d254916", "message": "onDismiss -> onClose", "committedDate": "2020-11-19T17:53:13Z", "type": "commit"}, {"oid": "508ea7fea609626ab6580f7002908d4cdd2371d7", "url": "https://github.com/all-of-us/workbench/commit/508ea7fea609626ab6580f7002908d4cdd2371d7", "message": "init state from localStorage", "committedDate": "2020-11-19T17:53:13Z", "type": "commit"}, {"oid": "508ea7fea609626ab6580f7002908d4cdd2371d7", "url": "https://github.com/all-of-us/workbench/commit/508ea7fea609626ab6580f7002908d4cdd2371d7", "message": "init state from localStorage", "committedDate": "2020-11-19T17:53:13Z", "type": "forcePushed"}]}