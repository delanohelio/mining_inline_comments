{"pr_number": 3602, "pr_title": "Infer length properties from Array.getLength() method", "pr_createdAt": "2020-08-19T03:07:14Z", "pr_url": "https://github.com/typetools/checker-framework/pull/3602", "timeline": [{"oid": "5624d27a78b4f001b1e3c221bef373f66cb22a7d", "url": "https://github.com/typetools/checker-framework/commit/5624d27a78b4f001b1e3c221bef373f66cb22a7d", "message": "Merge pull request #1 from typetools/master\n\nUpdate fork", "committedDate": "2020-07-10T12:48:35Z", "type": "commit"}, {"oid": "3723b511d80ffc2424695f00d5765514782a92e4", "url": "https://github.com/typetools/checker-framework/commit/3723b511d80ffc2424695f00d5765514782a92e4", "message": "Merge pull request #4 from typetools/master\n\nUpdating fork", "committedDate": "2020-07-21T02:21:51Z", "type": "commit"}, {"oid": "29bd19b4fa3bb917bd3ed8d432d8d88273463379", "url": "https://github.com/typetools/checker-framework/commit/29bd19b4fa3bb917bd3ed8d432d8d88273463379", "message": "Merge pull request #6 from typetools/master\n\nUpdating fork", "committedDate": "2020-07-26T03:57:56Z", "type": "commit"}, {"oid": "39ac44ab6a7d63c166c8f67f2a86a16fd68b2566", "url": "https://github.com/typetools/checker-framework/commit/39ac44ab6a7d63c166c8f67f2a86a16fd68b2566", "message": "Merge pull request #7 from typetools/master\n\nMerge master", "committedDate": "2020-07-29T02:03:14Z", "type": "commit"}, {"oid": "ba9549a409311d26653050df1554c8022cdddaa4", "url": "https://github.com/typetools/checker-framework/commit/ba9549a409311d26653050df1554c8022cdddaa4", "message": "Check for Array.getLength() call and annotate the return value", "committedDate": "2020-07-30T13:58:15Z", "type": "commit"}, {"oid": "d7c7d0c66ff1ce110b42120715810dd44f2b1409", "url": "https://github.com/typetools/checker-framework/commit/d7c7d0c66ff1ce110b42120715810dd44f2b1409", "message": "Remove println", "committedDate": "2020-07-30T15:30:29Z", "type": "commit"}, {"oid": "8bf17fb6ca9a8a9e4c7b6777837c65455a4a7ff4", "url": "https://github.com/typetools/checker-framework/commit/8bf17fb6ca9a8a9e4c7b6777837c65455a4a7ff4", "message": "Merge pull request #10 from typetools/master\n\nUpdate fork", "committedDate": "2020-07-31T01:36:59Z", "type": "commit"}, {"oid": "5d79f0e0136e547af62829b2bb2629c5c738f393", "url": "https://github.com/typetools/checker-framework/commit/5d79f0e0136e547af62829b2bb2629c5c738f393", "message": "Some changes to add support for Array.getLength", "committedDate": "2020-08-04T03:46:55Z", "type": "commit"}, {"oid": "3c8d26485523b4f59815e493f585d835cc9b6aa8", "url": "https://github.com/typetools/checker-framework/commit/3c8d26485523b4f59815e493f585d835cc9b6aa8", "message": "Merge pull request #12 from typetools/master\n\nUpdate fork", "committedDate": "2020-08-05T02:02:36Z", "type": "commit"}, {"oid": "a125ea2a25dfb01037c7e71bd206cb1a2c74fbc7", "url": "https://github.com/typetools/checker-framework/commit/a125ea2a25dfb01037c7e71bd206cb1a2c74fbc7", "message": "Merge pull request #13 from typetools/master\n\nUpdate fork", "committedDate": "2020-08-11T02:04:03Z", "type": "commit"}, {"oid": "ad78d7fbde29b8d5d5f67759dc7cb4bf762eddd1", "url": "https://github.com/typetools/checker-framework/commit/ad78d7fbde29b8d5d5f67759dc7cb4bf762eddd1", "message": "retrieve array node", "committedDate": "2020-08-12T02:19:27Z", "type": "commit"}, {"oid": "1284e979c490485cd77f3595a04989aedb39526e", "url": "https://github.com/typetools/checker-framework/commit/1284e979c490485cd77f3595a04989aedb39526e", "message": "Merge pull request #15 from typetools/master\n\nUpdate fork", "committedDate": "2020-08-14T02:50:11Z", "type": "commit"}, {"oid": "0183886a717e98e20116f5216914590e3deda8e5", "url": "https://github.com/typetools/checker-framework/commit/0183886a717e98e20116f5216914590e3deda8e5", "message": "Merge branch 'master' of https://github.com/priti1999/checker-framework into fix-issue-2452", "committedDate": "2020-08-14T02:50:48Z", "type": "commit"}, {"oid": "4d4484fe9983111da1162057668a1e6922f0d5e2", "url": "https://github.com/typetools/checker-framework/commit/4d4484fe9983111da1162057668a1e6922f0d5e2", "message": "fix and testcase for Issue #2452", "committedDate": "2020-08-17T02:44:14Z", "type": "commit"}, {"oid": "b0fd341fba9ac02557042b422e28e770d250efef", "url": "https://github.com/typetools/checker-framework/commit/b0fd341fba9ac02557042b422e28e770d250efef", "message": "Add doc", "committedDate": "2020-08-18T01:57:13Z", "type": "commit"}, {"oid": "2cb10a4396c1411d23f8d3973aaeb5b3cff60962", "url": "https://github.com/typetools/checker-framework/commit/2cb10a4396c1411d23f8d3973aaeb5b3cff60962", "message": "add more doc", "committedDate": "2020-08-18T02:34:15Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDk3MjE2NQ==", "url": "https://github.com/typetools/checker-framework/pull/3602#discussion_r474972165", "bodyText": "I suggest moving this block of code down so that it appears immediately after String.length() is handled.", "author": "kelloggm", "createdAt": "2020-08-21T21:11:52Z", "path": "framework/src/main/java/org/checkerframework/common/value/ValueTreeAnnotator.java", "diffHunk": "@@ -399,6 +399,18 @@ public Void visitMethodInvocation(MethodInvocationTree tree, AnnotatedTypeMirror\n             }\n         }\n \n+        if (atypeFactory\n+                .getMethodIdentifier()\n+                .isArrayGetLengthInvocation(tree, atypeFactory.getProcessingEnv())) {\n+            List<? extends ExpressionTree> args = tree.getArguments();\n+            AnnotatedTypeMirror argType = atypeFactory.getAnnotatedType(args.get(0));\n+            AnnotationMirror resultAnno = atypeFactory.createArrayLengthResultAnnotation(argType);\n+            if (resultAnno != null) {\n+                type.replaceAnnotation(resultAnno);\n+            }\n+            return null;\n+        }\n+", "originalCommit": "2cb10a4396c1411d23f8d3973aaeb5b3cff60962", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDk3MjI0Ng==", "url": "https://github.com/typetools/checker-framework/pull/3602#discussion_r474972246", "bodyText": "That will make the flow of this method more clear.", "author": "kelloggm", "createdAt": "2020-08-21T21:12:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDk3MjE2NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTcxNDYwNA==", "url": "https://github.com/typetools/checker-framework/pull/3602#discussion_r479714604", "bodyText": "I agree and I tried moving it down but the tests fail. This happens because methodIsStaticallyExecutable() return false at line 430 for Array.getLength() method. Do you think this is another issue? If so I'll try fixing it as a part of another PR.", "author": "PRITI1999", "createdAt": "2020-08-30T03:06:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDk3MjE2NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTcyMTQwNA==", "url": "https://github.com/typetools/checker-framework/pull/3602#discussion_r479721404", "bodyText": "I agree that methodIsStaticallyExecutable() should return true for Array.getLength().  Thank you for reporting the problem.\nI believe I have fixed it for you so that you are not blocked.", "author": "mernst", "createdAt": "2020-08-30T04:48:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDk3MjE2NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDk3Mjc5OA==", "url": "https://github.com/typetools/checker-framework/pull/3602#discussion_r474972798", "bodyText": "Rather than checking for these in every place that refineStringAtLengthInvocation or refineArrayAtGetLengthInvocation might be called, I suggest creating one refineAtLengthInvocation method that then dispatches to those two methods (or just inlines their logic).", "author": "kelloggm", "createdAt": "2020-08-21T21:13:46Z", "path": "framework/src/main/java/org/checkerframework/common/value/ValueTransfer.java", "diffHunk": "@@ -1340,7 +1357,16 @@ private void addAnnotationToStore(CFStore store, AnnotationMirror anno, Node nod\n             if (node instanceof FieldAccessNode) {\n                 refineArrayAtLengthAccess((FieldAccessNode) internal, store);\n             } else if (node instanceof MethodInvocationNode) {\n-                refineStringAtLengthInvocation((MethodInvocationNode) internal, store);\n+                MethodInvocationNode miNode = (MethodInvocationNode) node;\n+                if (atypefactory\n+                        .getMethodIdentifier()\n+                        .isStringLengthMethod(miNode.getTarget().getMethod())) {\n+                    refineStringAtLengthInvocation(miNode, store);\n+                } else if (atypefactory\n+                        .getMethodIdentifier()\n+                        .isArrayGetLengthMethod(miNode.getTarget().getMethod())) {\n+                    refineArrayAtGetLengthInvocation(miNode, store);\n+                }", "originalCommit": "2cb10a4396c1411d23f8d3973aaeb5b3cff60962", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDk3MzQzMw==", "url": "https://github.com/typetools/checker-framework/pull/3602#discussion_r474973433", "bodyText": "Since there is also a refineAtLengthAccess method that implements the logic for both, I suggest renaming that method to refineAtLengthAccessImpl and making the wrapper method called refineAtLengthAccess. That wrapper method should take a MethodInvocationTree and check what method is actually being invoked, and then call refineAtLengthAccessImpl with the appropriate arguments.", "author": "kelloggm", "createdAt": "2020-08-21T21:15:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDk3Mjc5OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDk3Mzg0Nw==", "url": "https://github.com/typetools/checker-framework/pull/3602#discussion_r474973847", "bodyText": "Rather than adding these to the end of the file, please put them with the corresponding methods for String#length.", "author": "kelloggm", "createdAt": "2020-08-21T21:16:49Z", "path": "framework/src/main/java/org/checkerframework/common/value/ValueMethodIdentifier.java", "diffHunk": "@@ -78,4 +82,26 @@ public boolean isEndsWithMethod(ExecutableElement method) {\n     public boolean isArraysCopyOfInvocation(Tree tree, ProcessingEnvironment processingEnv) {\n         return TreeUtils.isMethodInvocation(tree, copyOfMethod, processingEnv);\n     }\n+\n+    /**\n+     * Determines whether a tree is an invocation of the {@code Array.getLength()} method.\n+     *\n+     * @param tree tree to check\n+     * @param processingEnv the processing environment\n+     * @return true iff the argument is an invocation of {@code Array.getLength()} method\n+     */\n+    public boolean isArrayGetLengthInvocation(Tree tree, ProcessingEnvironment processingEnv) {\n+        return TreeUtils.isMethodInvocation(tree, getLengthMethod, processingEnv);\n+    }\n+\n+    /**\n+     * Determines whether a method is the {@code Array.getLength()} method.\n+     *\n+     * @param method the element to check\n+     * @return true iff the argument method is {@code Array.getLength()} method\n+     */\n+    public boolean isArrayGetLengthMethod(ExecutableElement method) {\n+        // equals (rather than ElementUtils.ismethod) because String.length cannot be overridden\n+        return method.equals(getLengthMethod);\n+    }", "originalCommit": "2cb10a4396c1411d23f8d3973aaeb5b3cff60962", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "cf448ed71c898c5d76a2ec9f3903331a83111356", "url": "https://github.com/typetools/checker-framework/commit/cf448ed71c898c5d76a2ec9f3903331a83111356", "message": "Remove redundant code", "committedDate": "2020-08-30T03:00:03Z", "type": "commit"}, {"oid": "3ccf44e71a5d0520bdac5230ef9cc911bf49506d", "url": "https://github.com/typetools/checker-framework/commit/3ccf44e71a5d0520bdac5230ef9cc911bf49506d", "message": "Improve flow", "committedDate": "2020-08-30T03:08:31Z", "type": "commit"}, {"oid": "cf05a1a610c7933a5bed6570109e0507ee73c445", "url": "https://github.com/typetools/checker-framework/commit/cf05a1a610c7933a5bed6570109e0507ee73c445", "message": "Improve flow", "committedDate": "2020-08-30T03:09:52Z", "type": "commit"}, {"oid": "9ec1086090acf855ef3575ab77a1ad6a7aa3343c", "url": "https://github.com/typetools/checker-framework/commit/9ec1086090acf855ef3575ab77a1ad6a7aa3343c", "message": "Improve flow add doc", "committedDate": "2020-09-01T02:36:29Z", "type": "commit"}, {"oid": "228bf74d656a001645940fd5c97c33dba8400c6d", "url": "https://github.com/typetools/checker-framework/commit/228bf74d656a001645940fd5c97c33dba8400c6d", "message": "Build fix", "committedDate": "2020-09-02T10:46:37Z", "type": "commit"}, {"oid": "e5f951d3b4e07eb323158940ca8b6b29ca86b8b0", "url": "https://github.com/typetools/checker-framework/commit/e5f951d3b4e07eb323158940ca8b6b29ca86b8b0", "message": "Merge branch 'master' into fix-issue-2452", "committedDate": "2020-12-16T18:27:20Z", "type": "commit"}, {"oid": "456d318b6d8cd1ab71ce42d036383d121edccc1d", "url": "https://github.com/typetools/checker-framework/commit/456d318b6d8cd1ab71ce42d036383d121edccc1d", "message": "fix errors intro'd by mergE", "committedDate": "2020-12-16T20:50:55Z", "type": "commit"}]}