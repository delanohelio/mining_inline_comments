{"pr_number": 3196, "pr_title": "Add Gradle tasks to deploy Maven artifacts (both locally and to Maven central)", "pr_createdAt": "2020-03-25T20:02:15Z", "pr_url": "https://github.com/typetools/checker-framework/pull/3196", "timeline": [{"oid": "12f2525a5225d3235ce419e3065771ce6c59138c", "url": "https://github.com/typetools/checker-framework/commit/12f2525a5225d3235ce419e3065771ce6c59138c", "message": "Add tasks.", "committedDate": "2020-03-22T16:01:13Z", "type": "commit"}, {"oid": "6a4d96dac8f247db650038de319e6a72a7d7e179", "url": "https://github.com/typetools/checker-framework/commit/6a4d96dac8f247db650038de319e6a72a7d7e179", "message": "Add commands to deploy to Sonatypes.", "committedDate": "2020-03-22T20:23:05Z", "type": "commit"}, {"oid": "9d016ba97929ab4711ded413b338e84819100199", "url": "https://github.com/typetools/checker-framework/commit/9d016ba97929ab4711ded413b338e84819100199", "message": "More maven stuff.", "committedDate": "2020-03-22T22:35:07Z", "type": "commit"}, {"oid": "75fee2496a57683ec86415ddaeab08d0e9b3f8fa", "url": "https://github.com/typetools/checker-framework/commit/75fee2496a57683ec86415ddaeab08d0e9b3f8fa", "message": "Add more.", "committedDate": "2020-03-22T22:55:52Z", "type": "commit"}, {"oid": "d7e67d626ce3889575bf3997e170416c284cf0d0", "url": "https://github.com/typetools/checker-framework/commit/d7e67d626ce3889575bf3997e170416c284cf0d0", "message": "More.", "committedDate": "2020-03-22T23:14:34Z", "type": "commit"}, {"oid": "49d3828fd544e26083dcd699bef9437756401cfa", "url": "https://github.com/typetools/checker-framework/commit/49d3828fd544e26083dcd699bef9437756401cfa", "message": "Fix.", "committedDate": "2020-03-22T23:23:16Z", "type": "commit"}, {"oid": "5ba7f1700750f26a31ffeda109c7cf3c696c6e82", "url": "https://github.com/typetools/checker-framework/commit/5ba7f1700750f26a31ffeda109c7cf3c696c6e82", "message": "Fix.", "committedDate": "2020-03-22T23:27:17Z", "type": "commit"}, {"oid": "750a59e66a56348e7b3500c8065f4210305b404a", "url": "https://github.com/typetools/checker-framework/commit/750a59e66a56348e7b3500c8065f4210305b404a", "message": "Fix.", "committedDate": "2020-03-22T23:32:42Z", "type": "commit"}, {"oid": "f06fe5f3fd4015f45054d8b48509e069a786b218", "url": "https://github.com/typetools/checker-framework/commit/f06fe5f3fd4015f45054d8b48509e069a786b218", "message": "Fix.", "committedDate": "2020-03-22T23:39:05Z", "type": "commit"}, {"oid": "3bb7b8271dac2c58e7a67a93cf636642cd0f9df8", "url": "https://github.com/typetools/checker-framework/commit/3bb7b8271dac2c58e7a67a93cf636642cd0f9df8", "message": "Start changing release scripts.", "committedDate": "2020-03-23T20:39:05Z", "type": "commit"}, {"oid": "2917ec4b6497424027dc81db00354488c58c5999", "url": "https://github.com/typetools/checker-framework/commit/2917ec4b6497424027dc81db00354488c58c5999", "message": "Move poms.", "committedDate": "2020-03-23T22:19:07Z", "type": "commit"}, {"oid": "42b6aff9708b0ae707ea452f632c484066be6c8b", "url": "https://github.com/typetools/checker-framework/commit/42b6aff9708b0ae707ea452f632c484066be6c8b", "message": "Deletions.", "committedDate": "2020-03-23T22:19:51Z", "type": "commit"}, {"oid": "a1b64ca4ddcbe214c47eedb154c2ffdd969a1dce", "url": "https://github.com/typetools/checker-framework/commit/a1b64ca4ddcbe214c47eedb154c2ffdd969a1dce", "message": "Finish pom rename.", "committedDate": "2020-03-24T03:11:45Z", "type": "commit"}, {"oid": "9ef409ce7342f80c8473911b23eff7f4ee8c4d01", "url": "https://github.com/typetools/checker-framework/commit/9ef409ce7342f80c8473911b23eff7f4ee8c4d01", "message": "Add comments.", "committedDate": "2020-03-25T19:48:54Z", "type": "commit"}, {"oid": "53d09bd7fe70056c00e028ad3478857e8dc6c6f2", "url": "https://github.com/typetools/checker-framework/commit/53d09bd7fe70056c00e028ad3478857e8dc6c6f2", "message": "Add comment.", "committedDate": "2020-03-25T19:50:35Z", "type": "commit"}, {"oid": "7cef9b71bcbc18d486936e174569cd41bb65854c", "url": "https://github.com/typetools/checker-framework/commit/7cef9b71bcbc18d486936e174569cd41bb65854c", "message": "Fix.", "committedDate": "2020-03-25T19:51:21Z", "type": "commit"}, {"oid": "de0e55bc33761001e0a85ca856af8bf0b750815c", "url": "https://github.com/typetools/checker-framework/commit/de0e55bc33761001e0a85ca856af8bf0b750815c", "message": "Revert.", "committedDate": "2020-03-25T19:52:31Z", "type": "commit"}, {"oid": "80771e0ff3248a677023b37579558ea86a7373b8", "url": "https://github.com/typetools/checker-framework/commit/80771e0ff3248a677023b37579558ea86a7373b8", "message": "Fix.", "committedDate": "2020-03-25T19:53:45Z", "type": "commit"}, {"oid": "1c814a3fec036d8cfe62906c056e6ea02d357321", "url": "https://github.com/typetools/checker-framework/commit/1c814a3fec036d8cfe62906c056e6ea02d357321", "message": "Add newline.", "committedDate": "2020-03-25T20:08:20Z", "type": "commit"}, {"oid": "3e26e6fd35afc12a12dcb84c3e6b7a6b4e47102c", "url": "https://github.com/typetools/checker-framework/commit/3e26e6fd35afc12a12dcb84c3e6b7a6b4e47102c", "message": "Make POM files more consistent with one another", "committedDate": "2020-03-25T21:41:56Z", "type": "commit"}, {"oid": "17dc800c712b36d2d31c31733d43bdb34fbdb5e7", "url": "https://github.com/typetools/checker-framework/commit/17dc800c712b36d2d31c31733d43bdb34fbdb5e7", "message": "Make descriptions more uniform", "committedDate": "2020-03-25T21:47:00Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODE3MDMzMA==", "url": "https://github.com/typetools/checker-framework/pull/3196#discussion_r398170330", "bodyText": "Is the location used only for that purpose, or are the pom files used only for that purpose?\n(Using a complete sentence could have prevented my question.)", "author": "mernst", "createdAt": "2020-03-25T21:08:21Z", "path": "build.gradle", "diffHunk": "@@ -54,6 +54,9 @@ ext {\n     // The local git repository, typically in the .git directory, but not for worktrees.\n     // This value is always overwritten, but Gradle needs the variable to be initialized.\n     localRepo = \".git\"\n+\n+    // Location of pom files used only to add meta-data to the artifacts published to Maven.", "originalCommit": "1c814a3fec036d8cfe62906c056e6ea02d357321", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODE3MDY3Mg==", "url": "https://github.com/typetools/checker-framework/pull/3196#discussion_r398170672", "bodyText": "Why is the release number already incremented?  Maybe it's a temporary artifact of the lack of SNAPSHOT version numbers.", "author": "mernst", "createdAt": "2020-03-25T21:08:54Z", "path": "build.gradle", "diffHunk": "@@ -99,7 +102,7 @@ allprojects {\n     //   * any new checkers have been added,\n     //   * the patch level is 9 (keep the patch level as a single digit), or\n     //   * backward-incompatible changes have been made to APIs or elsewhere.\n-    version '3.2.0'\n+    version '3.2.1'", "originalCommit": "1c814a3fec036d8cfe62906c056e6ea02d357321", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODE3MDk1MA==", "url": "https://github.com/typetools/checker-framework/pull/3196#discussion_r398170950", "bodyText": "Is pom a filename, as opposed to the file contents?\n(Reading on, I see that it is.)\nSame comment a few other places.", "author": "mernst", "createdAt": "2020-03-25T21:09:24Z", "path": "build.gradle", "diffHunk": "@@ -969,3 +972,84 @@ task releaseAndTest {\n \n // Don't create an empty checker-framework-VERSION.jar\n jar.onlyIf {false}\n+\n+/**\n+ * Deploys the given jar file to the local Maven repository.\n+ * @param jar fully qualified file name of a jar file\n+ * @param pom pom file describing the artifact", "originalCommit": "1c814a3fec036d8cfe62906c056e6ea02d357321", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODE3MTUzMQ==", "url": "https://github.com/typetools/checker-framework/pull/3196#discussion_r398171531", "bodyText": "This isn't in the TODO list in the pull request.", "author": "mernst", "createdAt": "2020-03-25T21:10:31Z", "path": "build.gradle", "diffHunk": "@@ -969,3 +972,84 @@ task releaseAndTest {\n \n // Don't create an empty checker-framework-VERSION.jar\n jar.onlyIf {false}\n+\n+/**\n+ * Deploys the given jar file to the local Maven repository.\n+ * @param jar fully qualified file name of a jar file\n+ * @param pom pom file describing the artifact\n+ */\n+void mvnDeployToLocalRepo(String jar, String pom) {\n+    exec {\n+        executable 'mvn'\n+        args += [\n+                'install:install-file',\n+                \"-Dfile=${jar}\",\n+                \"-DpomFile=${pom}\",\n+                // TODO: This changes the version number of the artifact, but not the version number in the pom file.", "originalCommit": "1c814a3fec036d8cfe62906c056e6ea02d357321", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODE3NTIwNQ==", "url": "https://github.com/typetools/checker-framework/pull/3196#discussion_r398175205", "bodyText": "This could call the method that is defined on line 1040.  That wouldn't make the code much shorter, but it would clarify the relationship between the two methods, which would helped me to understand them.  The documentation could also be made more similar -- the difference in the Javadoc first sentence also made me think the methods were more different than they are.", "author": "mernst", "createdAt": "2020-03-25T21:17:13Z", "path": "build.gradle", "diffHunk": "@@ -969,3 +972,84 @@ task releaseAndTest {\n \n // Don't create an empty checker-framework-VERSION.jar\n jar.onlyIf {false}\n+\n+/**\n+ * Deploys the given jar file to the local Maven repository.\n+ * @param jar fully qualified file name of a jar file\n+ * @param pom pom file describing the artifact\n+ */\n+void mvnDeployToLocalRepo(String jar, String pom) {\n+    exec {\n+        executable 'mvn'\n+        args += [\n+                'install:install-file',\n+                \"-Dfile=${jar}\",\n+                \"-DpomFile=${pom}\",\n+                // TODO: This changes the version number of the artifact, but not the version number in the pom file.\n+//                \"-Dversion=${version}\",\n+                '-DgeneratePom=true'\n+\n+        ]\n+    }\n+}\n+\n+/**\n+ * Deploys the jar file produced by the \"jar\" task of the given project to the local Maven repository.\n+ * @param project project whose jar file is deployed\n+ * @param pom pom file describing the artifact\n+ */\n+void mvnDeployToLocalRepo(Project project, String pomFile) {\n+    String jarFile = project.tasks.getByName('jar').archiveFile.get().toString();\n+    mvnDeployToLocalRepo(jarFile, pomFile)\n+}\n+\n+/**\n+ * Signs and deploys the given jar file to the Sonatypes Maven repository.\n+ * @param jar fully qualified file name of a jar file\n+ * @param pom pom file describing the artifact\n+ * @param classifier the kind of artifact; sources or javadoc; defaults to the empty string\n+ */\n+void mvnSignAndDeployToSonatype(String jar, String pom, String classifier=\"\") {\n+    String passwordFile = \"/projects/swlab1/checker-framework/hosting-info/release-private.password\"\n+    String passphrase = new File(passwordFile).readLines().get(0);\n+\n+    exec {\n+        executable 'mvn'\n+        args += [\n+                'gpg:sign-and-deploy-file',\n+                '-Durl=https://oss.sonatype.org/service/local/staging/deploy/maven2/',\n+                '-DrepositoryId=sonatype-nexus-staging',\n+                \"-DpomFile=${pom}\",\n+                \"-Dfile=${jar}\",\n+                '-Dgpg.keyname=checker-framework-dev@googlegroups.com',\n+                \"-Dgpg.passphrase=${passphrase}\"\n+        ]\n+        if (!classifier.isEmpty()) {\n+            args += [\"-Dclassifier=${classifier}\"]\n+        }\n+    }\n+}\n+\n+/**\n+ * Signs and deploys multiple jar files for a single artifact.\n+ * @param classesJar class jar file\n+ * @param sourceJar source jar file corresponding to the classesJar\n+ * @param javadocJar javadoc jar file corresponding to the classesJar\n+ * @param pom pom file describing the artifact\n+ */\n+void mvnSignAndDeployMultipleToSonatype(String classesJar, String sourceJar, String javadocJar, String pom) {\n+    mvnSignAndDeployToSonatype(classesJar, pom)\n+    mvnSignAndDeployToSonatype(sourceJar, pom, \"sources\")\n+    mvnSignAndDeployToSonatype(javadocJar, pom,\"javadoc\")\n+}\n+\n+/**\n+ * Signs and deploys the classes jar, sources jar, and javadoc jar files for a single artifact.\n+ * @param project with a jar, sourcesJar, and javadocJar tasks defined\n+ * @param pom pom file describing the artifact\n+ */\n+void mvnSignAndDeployMultipleToSonatype(Project project, String pom) {", "originalCommit": "1c814a3fec036d8cfe62906c056e6ea02d357321", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODYyNzA0MA==", "url": "https://github.com/typetools/checker-framework/pull/3196#discussion_r398627040", "bodyText": "The qualifiers in this package are under MIT license, aren't they?", "author": "wmdietl", "createdAt": "2020-03-26T14:42:25Z", "path": "docs/developer/release/maven-artifacts/dataflow-pom.xml", "diffHunk": "@@ -37,12 +37,6 @@\n             <url>http://www.gnu.org/software/classpath/license.html</url>\n             <distribution>repo</distribution>\n         </license>\n-\n-        <license>", "originalCommit": "17dc800c712b36d2d31c31733d43bdb34fbdb5e7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODY0NTE4NA==", "url": "https://github.com/typetools/checker-framework/pull/3196#discussion_r398645184", "bodyText": "Yes, but the given license is the most restrictive one, and therefore the most useful one to state.\nWhen a POM file contains two licenses, that generally means that the user is permitted to use either of the given licenses, at the user's option.  That is not the case for this project, and therefore giving two licenses was misleading.", "author": "mernst", "createdAt": "2020-03-26T15:05:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODYyNzA0MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODY0ODE2OA==", "url": "https://github.com/typetools/checker-framework/pull/3196#discussion_r398648168", "bodyText": "Ah, yes, that makes sense. Thanks for clarifying. Maybe a comment here would prevent confusion.", "author": "wmdietl", "createdAt": "2020-03-26T15:08:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODYyNzA0MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODYyNzQ0Mw==", "url": "https://github.com/typetools/checker-framework/pull/3196#discussion_r398627443", "bodyText": "Same comment about qualifiers having MIT license.", "author": "wmdietl", "createdAt": "2020-03-26T14:42:58Z", "path": "docs/developer/release/maven-artifacts/dataflow-shaded-pom.xml", "diffHunk": "@@ -23,12 +23,6 @@\n             <url>http://www.gnu.org/software/classpath/license.html</url>\n             <distribution>repo</distribution>\n         </license>\n-\n-        <license>", "originalCommit": "17dc800c712b36d2d31c31733d43bdb34fbdb5e7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODY0NTM4MA==", "url": "https://github.com/typetools/checker-framework/pull/3196#discussion_r398645380", "bodyText": "Same response. :-)", "author": "mernst", "createdAt": "2020-03-26T15:05:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODYyNzQ0Mw=="}], "type": "inlineReview"}, {"oid": "883a67a367709d98a12442b0235fda0d5b349afa", "url": "https://github.com/typetools/checker-framework/commit/883a67a367709d98a12442b0235fda0d5b349afa", "message": "Add comment.", "committedDate": "2020-03-26T16:23:44Z", "type": "commit"}, {"oid": "61b1c88a8d8248aeff03c15325e7f15580474b62", "url": "https://github.com/typetools/checker-framework/commit/61b1c88a8d8248aeff03c15325e7f15580474b62", "message": "Code review.", "committedDate": "2020-03-26T16:28:38Z", "type": "commit"}, {"oid": "3d6001de5ee198e8a7dea306a51af875c696db76", "url": "https://github.com/typetools/checker-framework/commit/3d6001de5ee198e8a7dea306a51af875c696db76", "message": "Fix pom.", "committedDate": "2020-03-26T16:30:58Z", "type": "commit"}, {"oid": "6d0c02273dd09a040168378e751f085d7452de30", "url": "https://github.com/typetools/checker-framework/commit/6d0c02273dd09a040168378e751f085d7452de30", "message": "Fix comment.", "committedDate": "2020-03-26T16:33:04Z", "type": "commit"}, {"oid": "be31b29481092ebc638b9c62614efe8381b3e99e", "url": "https://github.com/typetools/checker-framework/commit/be31b29481092ebc638b9c62614efe8381b3e99e", "message": "Correct comments.", "committedDate": "2020-03-26T16:45:01Z", "type": "commit"}, {"oid": "d5ad1b62bb57560d64615b37a8c36707fb2e1b23", "url": "https://github.com/typetools/checker-framework/commit/d5ad1b62bb57560d64615b37a8c36707fb2e1b23", "message": "Tweaks.", "committedDate": "2020-03-26T16:47:41Z", "type": "commit"}, {"oid": "d48f4b970bc912756ce40a7e02e6f90a9dc86f1b", "url": "https://github.com/typetools/checker-framework/commit/d48f4b970bc912756ce40a7e02e6f90a9dc86f1b", "message": "Fix link.", "committedDate": "2020-03-27T20:18:55Z", "type": "commit"}, {"oid": "70890f40d61d90218359f100ca99bd2f858ac8c9", "url": "https://github.com/typetools/checker-framework/commit/70890f40d61d90218359f100ca99bd2f858ac8c9", "message": "Merge remote-tracking branch 'origin/master' into maven", "committedDate": "2020-03-27T20:19:03Z", "type": "commit"}, {"oid": "a98a72dafb6080d44a01d1c3045d3f65c1ed8aae", "url": "https://github.com/typetools/checker-framework/commit/a98a72dafb6080d44a01d1c3045d3f65c1ed8aae", "message": "Add method to update version number in poms.", "committedDate": "2020-03-27T20:47:45Z", "type": "commit"}]}