{"pr_number": 4082, "pr_title": "IllegalArgumentException on incremental build in IntelliJ 2020.3; fixed #4068", "pr_createdAt": "2020-12-29T16:37:28Z", "pr_url": "https://github.com/typetools/checker-framework/pull/4082", "timeline": [{"oid": "85ed6277e405466d5b0bea07c709f98bc4e09dcc", "url": "https://github.com/typetools/checker-framework/commit/85ed6277e405466d5b0bea07c709f98bc4e09dcc", "message": "Unwrap ProcessingEnvironment if it is dynamic proxy created by IntellliJ", "committedDate": "2020-12-29T10:29:40Z", "type": "commit"}, {"oid": "980cb5c3d419c579af219c8c15fafb184c57e420", "url": "https://github.com/typetools/checker-framework/commit/980cb5c3d419c579af219c8c15fafb184c57e420", "message": "Unwrap processing environment for IntelliJ and gradle incremental build", "committedDate": "2020-12-29T16:26:59Z", "type": "commit"}, {"oid": "8ef247eaa29eaf8308a9d94d680f31e944d9837e", "url": "https://github.com/typetools/checker-framework/commit/8ef247eaa29eaf8308a9d94d680f31e944d9837e", "message": "Fix interned strings compared with equals warning from CI", "committedDate": "2020-12-29T17:13:31Z", "type": "commit"}, {"oid": "602ccd1af93ee38bd210fe605353d3ba2b4f41d6", "url": "https://github.com/typetools/checker-framework/commit/602ccd1af93ee38bd210fe605353d3ba2b4f41d6", "message": "Javadoc fixes: HTML use and tag style", "committedDate": "2020-12-30T01:41:58Z", "type": "commit"}, {"oid": "a3c2b8b49fcad11b6c0c66075b555c410d223ff2", "url": "https://github.com/typetools/checker-framework/commit/a3c2b8b49fcad11b6c0c66075b555c410d223ff2", "message": "Add contributor", "committedDate": "2020-12-30T01:43:50Z", "type": "commit"}, {"oid": "9f516eefe6e744916c1958d6e984c444fa2dac9a", "url": "https://github.com/typetools/checker-framework/commit/9f516eefe6e744916c1958d6e984c444fa2dac9a", "message": "Make error message more explicit", "committedDate": "2020-12-30T01:48:00Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTkwNTMwOQ==", "url": "https://github.com/typetools/checker-framework/pull/4082#discussion_r549905309", "bodyText": "The result of getName() is not guaranteed to be interned, so use .equals().", "author": "mernst", "createdAt": "2020-12-30T01:25:55Z", "path": "framework/src/main/java/org/checkerframework/framework/source/SourceChecker.java", "diffHunk": "@@ -516,12 +519,94 @@\n     /** List of upstream checker names. Includes the current checker. */\n     protected List<@FullyQualifiedName String> upstreamCheckerNames;\n \n+    /**\n+     * Tries to unwrap ProcessingEnvironment from proxy in IntelliJ >=2020.3.\n+     *\n+     * @param envProxy is dynamic proxy wrapping processing environment\n+     * @return unwrapped processing environment, null if not successful\n+     */\n+    private static @Nullable ProcessingEnvironment unwrapIntelliJ(Object envProxy) {\n+        InvocationHandler handler = Proxy.getInvocationHandler(envProxy);\n+        try {\n+            Field field = handler.getClass().getDeclaredField(\"val$delegateTo\");\n+            field.setAccessible(true);\n+            Object o = field.get(handler);\n+            if (o instanceof ProcessingEnvironment) {\n+                return (ProcessingEnvironment) o;\n+            }\n+            return null;\n+        } catch (NoSuchFieldException | IllegalAccessException e) {\n+            return null;\n+        }\n+    }\n+\n+    /**\n+     * Gradle incremental processing unwrapping inspired by project Lombok.\n+     *\n+     * @param delegateClass is class in which we try to find delegate field\n+     * @param env is processing environment wrapper\n+     * @return unwrapped processing environment, null if not successful\n+     */\n+    private static @Nullable ProcessingEnvironment unwrapGradle(\n+            Class<?> delegateClass, Object env) {\n+        try {\n+            Field field = delegateClass.getDeclaredField(\"delegate\");\n+            field.setAccessible(true);\n+            Object o = field.get(env);\n+            if (o instanceof ProcessingEnvironment) {\n+                return (ProcessingEnvironment) o;\n+            }\n+            return null;\n+        } catch (NoSuchFieldException | IllegalAccessException e) {\n+            return null;\n+        }\n+    }\n+\n+    /**\n+     * IntelliJ wraps processing environment in dynamic proxy to check for modifications done by\n+     * annotation processors. But lots of functionality both here and in AbstractTypeProcessor call\n+     * methods from javac that require processing environment to be\n+     * com.sun.tools.javac.processing.JavacProcessingEnvironment and fail on proxy - thus in case\n+     * proxy is used, we have to unwrap it.\n+     *\n+     * @param env is processing environment supplied to checker\n+     * @return unwrapped environment if it is dynamic proxy, created by IntelliJ; original value in\n+     *     all other cases\n+     */\n+    private static ProcessingEnvironment unwrapProcessingEnvironment(ProcessingEnvironment env) {\n+        // equality, not instanceof corresponds to test in Trees and JavacTask\n+        // comparison instead of equals is required by some tests in CheckerFramework CI\n+        if (env.getClass().getName()\n+                == \"com.sun.tools.javac.processing.JavacProcessingEnvironment\") {", "originalCommit": "8ef247eaa29eaf8308a9d94d680f31e944d9837e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDA0ODQwNA==", "url": "https://github.com/typetools/checker-framework/pull/4082#discussion_r550048404", "bodyText": "I used equals originally and I do prefer it. But it caused typecheck_jdk11 test to fail originally... I might need Your help working around that.\nAnyways I committed change to equals for now", "author": "MichalStehlikCz", "createdAt": "2020-12-30T08:52:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTkwNTMwOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDE3ODc3NQ==", "url": "https://github.com/typetools/checker-framework/pull/4082#discussion_r550178775", "bodyText": "See log from typecheck_jdk11.sh / test-typecheck.sh\n\nTask :framework:checkInterning\n/__w/1/s/framework/src/main/java/org/checkerframework/framework/source/SourceChecker.java:586: warning: [interning:unnecessary.equals] use of .equals can be safely replaced by ==/!=\n.equals(\"com.sun.tools.javac.processing.JavacProcessingEnvironment\")) {\n^\nerror: warnings found and -Werror specified\n1 error\n1 warning", "author": "MichalStehlikCz", "createdAt": "2020-12-30T12:30:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTkwNTMwOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDIzMTc0Mg==", "url": "https://github.com/typetools/checker-framework/pull/4082#discussion_r550231742", "bodyText": "Although there is no guarantee in general, when using Oracle's JDK the method's return value is interned, and we can make that assumption.  I put the == test back.", "author": "mernst", "createdAt": "2020-12-30T15:26:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTkwNTMwOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTkwNjQzNA==", "url": "https://github.com/typetools/checker-framework/pull/4082#discussion_r549906434", "bodyText": "envProxy has type ProcessingEnvironment.  Is there a reason you didn't declare it as such?\nI have the same question regarding unwrapGradle.  Also, for consistency I would give the formal parameters of the two methods the same name.", "author": "mernst", "createdAt": "2020-12-30T01:32:53Z", "path": "framework/src/main/java/org/checkerframework/framework/source/SourceChecker.java", "diffHunk": "@@ -516,12 +519,94 @@\n     /** List of upstream checker names. Includes the current checker. */\n     protected List<@FullyQualifiedName String> upstreamCheckerNames;\n \n+    /**\n+     * Tries to unwrap ProcessingEnvironment from proxy in IntelliJ >=2020.3.\n+     *\n+     * @param envProxy is dynamic proxy wrapping processing environment\n+     * @return unwrapped processing environment, null if not successful\n+     */\n+    private static @Nullable ProcessingEnvironment unwrapIntelliJ(Object envProxy) {", "originalCommit": "8ef247eaa29eaf8308a9d94d680f31e944d9837e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDA1MzEzMA==", "url": "https://github.com/typetools/checker-framework/pull/4082#discussion_r550053130", "bodyText": "It was just copy & paste error as in original code, all parameters were declared as Object - fixed", "author": "MichalStehlikCz", "createdAt": "2020-12-30T08:58:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTkwNjQzNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTkwNjkyMA==", "url": "https://github.com/typetools/checker-framework/pull/4082#discussion_r549906920", "bodyText": "I am having trouble understanding these two lines.  Could you please clarify?\n(I can't even tell whether this is two sentences or one; could you use capitalization and punctuation (a period at the end of the sentence) to help with that?)", "author": "mernst", "createdAt": "2020-12-30T01:36:26Z", "path": "framework/src/main/java/org/checkerframework/framework/source/SourceChecker.java", "diffHunk": "@@ -516,12 +519,94 @@\n     /** List of upstream checker names. Includes the current checker. */\n     protected List<@FullyQualifiedName String> upstreamCheckerNames;\n \n+    /**\n+     * Tries to unwrap ProcessingEnvironment from proxy in IntelliJ >=2020.3.\n+     *\n+     * @param envProxy is dynamic proxy wrapping processing environment\n+     * @return unwrapped processing environment, null if not successful\n+     */\n+    private static @Nullable ProcessingEnvironment unwrapIntelliJ(Object envProxy) {\n+        InvocationHandler handler = Proxy.getInvocationHandler(envProxy);\n+        try {\n+            Field field = handler.getClass().getDeclaredField(\"val$delegateTo\");\n+            field.setAccessible(true);\n+            Object o = field.get(handler);\n+            if (o instanceof ProcessingEnvironment) {\n+                return (ProcessingEnvironment) o;\n+            }\n+            return null;\n+        } catch (NoSuchFieldException | IllegalAccessException e) {\n+            return null;\n+        }\n+    }\n+\n+    /**\n+     * Gradle incremental processing unwrapping inspired by project Lombok.\n+     *\n+     * @param delegateClass is class in which we try to find delegate field\n+     * @param env is processing environment wrapper\n+     * @return unwrapped processing environment, null if not successful\n+     */\n+    private static @Nullable ProcessingEnvironment unwrapGradle(\n+            Class<?> delegateClass, Object env) {\n+        try {\n+            Field field = delegateClass.getDeclaredField(\"delegate\");\n+            field.setAccessible(true);\n+            Object o = field.get(env);\n+            if (o instanceof ProcessingEnvironment) {\n+                return (ProcessingEnvironment) o;\n+            }\n+            return null;\n+        } catch (NoSuchFieldException | IllegalAccessException e) {\n+            return null;\n+        }\n+    }\n+\n+    /**\n+     * IntelliJ wraps processing environment in dynamic proxy to check for modifications done by\n+     * annotation processors. But lots of functionality both here and in AbstractTypeProcessor call\n+     * methods from javac that require processing environment to be\n+     * com.sun.tools.javac.processing.JavacProcessingEnvironment and fail on proxy - thus in case\n+     * proxy is used, we have to unwrap it.\n+     *\n+     * @param env is processing environment supplied to checker\n+     * @return unwrapped environment if it is dynamic proxy, created by IntelliJ; original value in\n+     *     all other cases\n+     */\n+    private static ProcessingEnvironment unwrapProcessingEnvironment(ProcessingEnvironment env) {\n+        // equality, not instanceof corresponds to test in Trees and JavacTask", "originalCommit": "8ef247eaa29eaf8308a9d94d680f31e944d9837e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDA1ODI5NA==", "url": "https://github.com/typetools/checker-framework/pull/4082#discussion_r550058294", "bodyText": "I tried to reformat comments to make them clearer", "author": "MichalStehlikCz", "createdAt": "2020-12-30T09:05:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTkwNjkyMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTkwNzA4OA==", "url": "https://github.com/typetools/checker-framework/pull/4082#discussion_r549907088", "bodyText": "Could you clarify \"here\"?  I think it means in this class, but it might mean in this method or something else.", "author": "mernst", "createdAt": "2020-12-30T01:37:31Z", "path": "framework/src/main/java/org/checkerframework/framework/source/SourceChecker.java", "diffHunk": "@@ -516,12 +519,94 @@\n     /** List of upstream checker names. Includes the current checker. */\n     protected List<@FullyQualifiedName String> upstreamCheckerNames;\n \n+    /**\n+     * Tries to unwrap ProcessingEnvironment from proxy in IntelliJ >=2020.3.\n+     *\n+     * @param envProxy is dynamic proxy wrapping processing environment\n+     * @return unwrapped processing environment, null if not successful\n+     */\n+    private static @Nullable ProcessingEnvironment unwrapIntelliJ(Object envProxy) {\n+        InvocationHandler handler = Proxy.getInvocationHandler(envProxy);\n+        try {\n+            Field field = handler.getClass().getDeclaredField(\"val$delegateTo\");\n+            field.setAccessible(true);\n+            Object o = field.get(handler);\n+            if (o instanceof ProcessingEnvironment) {\n+                return (ProcessingEnvironment) o;\n+            }\n+            return null;\n+        } catch (NoSuchFieldException | IllegalAccessException e) {\n+            return null;\n+        }\n+    }\n+\n+    /**\n+     * Gradle incremental processing unwrapping inspired by project Lombok.\n+     *\n+     * @param delegateClass is class in which we try to find delegate field\n+     * @param env is processing environment wrapper\n+     * @return unwrapped processing environment, null if not successful\n+     */\n+    private static @Nullable ProcessingEnvironment unwrapGradle(\n+            Class<?> delegateClass, Object env) {\n+        try {\n+            Field field = delegateClass.getDeclaredField(\"delegate\");\n+            field.setAccessible(true);\n+            Object o = field.get(env);\n+            if (o instanceof ProcessingEnvironment) {\n+                return (ProcessingEnvironment) o;\n+            }\n+            return null;\n+        } catch (NoSuchFieldException | IllegalAccessException e) {\n+            return null;\n+        }\n+    }\n+\n+    /**\n+     * IntelliJ wraps processing environment in dynamic proxy to check for modifications done by\n+     * annotation processors. But lots of functionality both here and in AbstractTypeProcessor call", "originalCommit": "8ef247eaa29eaf8308a9d94d680f31e944d9837e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDA1ODk2Mg==", "url": "https://github.com/typetools/checker-framework/pull/4082#discussion_r550058962", "bodyText": "I believe you already addressed this problem in your commit, thanks", "author": "MichalStehlikCz", "createdAt": "2020-12-30T09:05:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTkwNzA4OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTkwNzMyMQ==", "url": "https://github.com/typetools/checker-framework/pull/4082#discussion_r549907321", "bodyText": "Which checker is this supplied to?  Or do you mean to the Checker Framework?\nAlso, please don't use passive voice.  Indicate the actor if it is important, or don't mention it if it is not.", "author": "mernst", "createdAt": "2020-12-30T01:38:54Z", "path": "framework/src/main/java/org/checkerframework/framework/source/SourceChecker.java", "diffHunk": "@@ -516,12 +519,94 @@\n     /** List of upstream checker names. Includes the current checker. */\n     protected List<@FullyQualifiedName String> upstreamCheckerNames;\n \n+    /**\n+     * Tries to unwrap ProcessingEnvironment from proxy in IntelliJ >=2020.3.\n+     *\n+     * @param envProxy is dynamic proxy wrapping processing environment\n+     * @return unwrapped processing environment, null if not successful\n+     */\n+    private static @Nullable ProcessingEnvironment unwrapIntelliJ(Object envProxy) {\n+        InvocationHandler handler = Proxy.getInvocationHandler(envProxy);\n+        try {\n+            Field field = handler.getClass().getDeclaredField(\"val$delegateTo\");\n+            field.setAccessible(true);\n+            Object o = field.get(handler);\n+            if (o instanceof ProcessingEnvironment) {\n+                return (ProcessingEnvironment) o;\n+            }\n+            return null;\n+        } catch (NoSuchFieldException | IllegalAccessException e) {\n+            return null;\n+        }\n+    }\n+\n+    /**\n+     * Gradle incremental processing unwrapping inspired by project Lombok.\n+     *\n+     * @param delegateClass is class in which we try to find delegate field\n+     * @param env is processing environment wrapper\n+     * @return unwrapped processing environment, null if not successful\n+     */\n+    private static @Nullable ProcessingEnvironment unwrapGradle(\n+            Class<?> delegateClass, Object env) {\n+        try {\n+            Field field = delegateClass.getDeclaredField(\"delegate\");\n+            field.setAccessible(true);\n+            Object o = field.get(env);\n+            if (o instanceof ProcessingEnvironment) {\n+                return (ProcessingEnvironment) o;\n+            }\n+            return null;\n+        } catch (NoSuchFieldException | IllegalAccessException e) {\n+            return null;\n+        }\n+    }\n+\n+    /**\n+     * IntelliJ wraps processing environment in dynamic proxy to check for modifications done by\n+     * annotation processors. But lots of functionality both here and in AbstractTypeProcessor call\n+     * methods from javac that require processing environment to be\n+     * com.sun.tools.javac.processing.JavacProcessingEnvironment and fail on proxy - thus in case\n+     * proxy is used, we have to unwrap it.\n+     *\n+     * @param env is processing environment supplied to checker", "originalCommit": "8ef247eaa29eaf8308a9d94d680f31e944d9837e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDA2ODg1MA==", "url": "https://github.com/typetools/checker-framework/pull/4082#discussion_r550068850", "bodyText": "I removed text; I believe it is explained by comment on return sufficiently. Yes, I meant supplied to CheckerFramework, but I am not sure who is actually actor - frankly speaking, I do not quite understand mechanism used by IntelliJ or Gradle to inject their proxy around processing environment to compilation process :(", "author": "MichalStehlikCz", "createdAt": "2020-12-30T09:18:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTkwNzMyMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTkwODY5OQ==", "url": "https://github.com/typetools/checker-framework/pull/4082#discussion_r549908699", "bodyText": "Annotations are not needed on local variables.  Could you remove this one and the next few to make the code less cluttered?", "author": "mernst", "createdAt": "2020-12-30T01:48:08Z", "path": "framework/src/main/java/org/checkerframework/framework/source/SourceChecker.java", "diffHunk": "@@ -516,12 +519,94 @@\n     /** List of upstream checker names. Includes the current checker. */\n     protected List<@FullyQualifiedName String> upstreamCheckerNames;\n \n+    /**\n+     * Tries to unwrap ProcessingEnvironment from proxy in IntelliJ >=2020.3.\n+     *\n+     * @param envProxy is dynamic proxy wrapping processing environment\n+     * @return unwrapped processing environment, null if not successful\n+     */\n+    private static @Nullable ProcessingEnvironment unwrapIntelliJ(Object envProxy) {\n+        InvocationHandler handler = Proxy.getInvocationHandler(envProxy);\n+        try {\n+            Field field = handler.getClass().getDeclaredField(\"val$delegateTo\");\n+            field.setAccessible(true);\n+            Object o = field.get(handler);\n+            if (o instanceof ProcessingEnvironment) {\n+                return (ProcessingEnvironment) o;\n+            }\n+            return null;\n+        } catch (NoSuchFieldException | IllegalAccessException e) {\n+            return null;\n+        }\n+    }\n+\n+    /**\n+     * Gradle incremental processing unwrapping inspired by project Lombok.\n+     *\n+     * @param delegateClass is class in which we try to find delegate field\n+     * @param env is processing environment wrapper\n+     * @return unwrapped processing environment, null if not successful\n+     */\n+    private static @Nullable ProcessingEnvironment unwrapGradle(\n+            Class<?> delegateClass, Object env) {\n+        try {\n+            Field field = delegateClass.getDeclaredField(\"delegate\");\n+            field.setAccessible(true);\n+            Object o = field.get(env);\n+            if (o instanceof ProcessingEnvironment) {\n+                return (ProcessingEnvironment) o;\n+            }\n+            return null;\n+        } catch (NoSuchFieldException | IllegalAccessException e) {\n+            return null;\n+        }\n+    }\n+\n+    /**\n+     * IntelliJ wraps processing environment in dynamic proxy to check for modifications done by\n+     * annotation processors. But lots of functionality both here and in AbstractTypeProcessor call\n+     * methods from javac that require processing environment to be\n+     * com.sun.tools.javac.processing.JavacProcessingEnvironment and fail on proxy - thus in case\n+     * proxy is used, we have to unwrap it.\n+     *\n+     * @param env is processing environment supplied to checker\n+     * @return unwrapped environment if it is dynamic proxy, created by IntelliJ; original value in\n+     *     all other cases\n+     */\n+    private static ProcessingEnvironment unwrapProcessingEnvironment(ProcessingEnvironment env) {\n+        // equality, not instanceof corresponds to test in Trees and JavacTask\n+        // comparison instead of equals is required by some tests in CheckerFramework CI\n+        if (env.getClass().getName()\n+                == \"com.sun.tools.javac.processing.JavacProcessingEnvironment\") {\n+            return env;\n+        }\n+        // IntelliJ >2020.3 wraps processing environment in dynamic proxy...\n+        if (Proxy.isProxyClass(env.getClass())) {\n+            @Nullable ProcessingEnvironment unwrapped = unwrapIntelliJ(env);", "originalCommit": "8ef247eaa29eaf8308a9d94d680f31e944d9837e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDA2OTk5Nw==", "url": "https://github.com/typetools/checker-framework/pull/4082#discussion_r550069997", "bodyText": "Ok, done", "author": "MichalStehlikCz", "createdAt": "2020-12-30T09:20:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTkwODY5OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTkxMTUwMA==", "url": "https://github.com/typetools/checker-framework/pull/4082#discussion_r549911500", "bodyText": "I suggest putting this test within unwrapIntelliJ, so that all logic related to IntelliJ proxies is together.", "author": "mernst", "createdAt": "2020-12-30T02:06:33Z", "path": "framework/src/main/java/org/checkerframework/framework/source/SourceChecker.java", "diffHunk": "@@ -516,12 +519,94 @@\n     /** List of upstream checker names. Includes the current checker. */\n     protected List<@FullyQualifiedName String> upstreamCheckerNames;\n \n+    /**\n+     * Tries to unwrap ProcessingEnvironment from proxy in IntelliJ >=2020.3.\n+     *\n+     * @param envProxy is dynamic proxy wrapping processing environment\n+     * @return unwrapped processing environment, null if not successful\n+     */\n+    private static @Nullable ProcessingEnvironment unwrapIntelliJ(Object envProxy) {\n+        InvocationHandler handler = Proxy.getInvocationHandler(envProxy);\n+        try {\n+            Field field = handler.getClass().getDeclaredField(\"val$delegateTo\");\n+            field.setAccessible(true);\n+            Object o = field.get(handler);\n+            if (o instanceof ProcessingEnvironment) {\n+                return (ProcessingEnvironment) o;\n+            }\n+            return null;\n+        } catch (NoSuchFieldException | IllegalAccessException e) {\n+            return null;\n+        }\n+    }\n+\n+    /**\n+     * Gradle incremental processing unwrapping inspired by project Lombok.\n+     *\n+     * @param delegateClass is class in which we try to find delegate field\n+     * @param env is processing environment wrapper\n+     * @return unwrapped processing environment, null if not successful\n+     */\n+    private static @Nullable ProcessingEnvironment unwrapGradle(\n+            Class<?> delegateClass, Object env) {\n+        try {\n+            Field field = delegateClass.getDeclaredField(\"delegate\");\n+            field.setAccessible(true);\n+            Object o = field.get(env);\n+            if (o instanceof ProcessingEnvironment) {\n+                return (ProcessingEnvironment) o;\n+            }\n+            return null;\n+        } catch (NoSuchFieldException | IllegalAccessException e) {\n+            return null;\n+        }\n+    }\n+\n+    /**\n+     * IntelliJ wraps processing environment in dynamic proxy to check for modifications done by\n+     * annotation processors. But lots of functionality both here and in AbstractTypeProcessor call\n+     * methods from javac that require processing environment to be\n+     * com.sun.tools.javac.processing.JavacProcessingEnvironment and fail on proxy - thus in case\n+     * proxy is used, we have to unwrap it.\n+     *\n+     * @param env is processing environment supplied to checker\n+     * @return unwrapped environment if it is dynamic proxy, created by IntelliJ; original value in\n+     *     all other cases\n+     */\n+    private static ProcessingEnvironment unwrapProcessingEnvironment(ProcessingEnvironment env) {\n+        // equality, not instanceof corresponds to test in Trees and JavacTask\n+        // comparison instead of equals is required by some tests in CheckerFramework CI\n+        if (env.getClass().getName()\n+                == \"com.sun.tools.javac.processing.JavacProcessingEnvironment\") {\n+            return env;\n+        }\n+        // IntelliJ >2020.3 wraps processing environment in dynamic proxy...\n+        if (Proxy.isProxyClass(env.getClass())) {", "originalCommit": "8ef247eaa29eaf8308a9d94d680f31e944d9837e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDA3NjEwMw==", "url": "https://github.com/typetools/checker-framework/pull/4082#discussion_r550076103", "bodyText": "Moved", "author": "MichalStehlikCz", "createdAt": "2020-12-30T09:28:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTkxMTUwMA=="}], "type": "inlineReview"}, {"oid": "b57202a02b9b9749c3d81cb7f1fd0fec30ea9269", "url": "https://github.com/typetools/checker-framework/commit/b57202a02b9b9749c3d81cb7f1fd0fec30ea9269", "message": "Tweak comment", "committedDate": "2020-12-30T02:08:48Z", "type": "commit"}, {"oid": "631b0fe40bde44b431b6836a3b627d7c9cc018a0", "url": "https://github.com/typetools/checker-framework/commit/631b0fe40bde44b431b6836a3b627d7c9cc018a0", "message": "Use equality for string comparison (rollback Fix interned strings compared with equals warning from CI)", "committedDate": "2020-12-30T08:49:44Z", "type": "commit"}, {"oid": "bbb7d9f3920ebd934d76b69158bf6497d1e64776", "url": "https://github.com/typetools/checker-framework/commit/bbb7d9f3920ebd934d76b69158bf6497d1e64776", "message": "Consistently use ProcessingEnvironment type and env parameter name", "committedDate": "2020-12-30T08:58:05Z", "type": "commit"}, {"oid": "59325103b84f2af1377729c7af276d9cccffb760", "url": "https://github.com/typetools/checker-framework/commit/59325103b84f2af1377729c7af276d9cccffb760", "message": "Adjusted comments to make it clearer what methods actually do", "committedDate": "2020-12-30T09:04:03Z", "type": "commit"}, {"oid": "e624d3dc63e2d603f9a8f50ca37aa30ae4d5e98a", "url": "https://github.com/typetools/checker-framework/commit/e624d3dc63e2d603f9a8f50ca37aa30ae4d5e98a", "message": "Remove annotations on local variables", "committedDate": "2020-12-30T09:10:09Z", "type": "commit"}, {"oid": "5f2a8cca497d92a1f2f7d61a9b2b81e528f79ba0", "url": "https://github.com/typetools/checker-framework/commit/5f2a8cca497d92a1f2f7d61a9b2b81e528f79ba0", "message": "Remove unclear comment about source of processing environment", "committedDate": "2020-12-30T09:20:11Z", "type": "commit"}, {"oid": "4ce724bff34d44656dc2757edbc01fa6d6e0089d", "url": "https://github.com/typetools/checker-framework/commit/4ce724bff34d44656dc2757edbc01fa6d6e0089d", "message": "Move dynamic proxy test to unwrapIntelliJ", "committedDate": "2020-12-30T09:27:25Z", "type": "commit"}, {"oid": "2ebc1e2b28dc8124be85c30b8baa81beeb0537b0", "url": "https://github.com/typetools/checker-framework/commit/2ebc1e2b28dc8124be85c30b8baa81beeb0537b0", "message": "Move code, plus tweaks", "committedDate": "2020-12-30T15:23:48Z", "type": "commit"}]}