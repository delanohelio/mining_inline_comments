{"pr_number": 448, "pr_title": "HDDS-2870. Handle replay of KeyCreate requests.", "pr_createdAt": "2020-01-16T00:05:35Z", "pr_url": "https://github.com/apache/ozone/pull/448", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Nzc2MDU3OQ==", "url": "https://github.com/apache/ozone/pull/448#discussion_r367760579", "bodyText": "We can pass the dbKeyInfo to prepareKeyInfo, as for override keys we read from DB. As anyway to check whether it is replay or not we read from DB above we can use that.", "author": "bharatviswa504", "createdAt": "2020-01-17T04:04:07Z", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/file/OMFileCreateRequest.java", "diffHunk": "@@ -254,29 +276,23 @@ public OMClientResponse validateAndUpdateCache(OzoneManager ozoneManager,\n       OmBucketInfo bucketInfo = omMetadataManager.getBucketTable().get(\n           omMetadataManager.getBucketKey(volumeName, bucketName));\n       encryptionInfo = getFileEncryptionInfo(ozoneManager, bucketInfo);\n-      omKeyInfo = prepareKeyInfo(omMetadataManager, keyArgs,\n-          omMetadataManager.getOzoneKey(volumeName, bucketName,\n-              keyName), keyArgs.getDataSize(), locations,\n-          encryptionInfo.orNull(), ozoneManager.getPrefixManager(),\n-          bucketInfo, transactionLogIndex);\n-\n-      omClientResponse =  prepareCreateKeyResponse(keyArgs, omKeyInfo,\n-          locations, encryptionInfo.orNull(), exception,\n-          createFileRequest.getClientID(), transactionLogIndex, volumeName,\n+      omKeyInfo = prepareKeyInfo(omMetadataManager, keyArgs, ozoneKey,", "originalCommit": "21a5e17655c5cd779609a02996edc48a003d6601", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDQwMDAwOA==", "url": "https://github.com/apache/ozone/pull/448#discussion_r370400008", "bodyText": "Done.", "author": "hanishakoneru", "createdAt": "2020-01-23T22:59:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Nzc2MDU3OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Nzc2MTYwNA==", "url": "https://github.com/apache/ozone/pull/448#discussion_r367761604", "bodyText": "We can pass the dbKeyInfo to prepareKeyInfo, as for override keys we read from DB. As anyway to check whether it is replay or not we read from DB above we can use that.", "author": "bharatviswa504", "createdAt": "2020-01-17T04:10:44Z", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/key/OMKeyCreateRequest.java", "diffHunk": "@@ -174,26 +182,40 @@ public OMClientResponse validateAndUpdateCache(OzoneManager ozoneManager,\n       // bucket encryptionInfo will be not set. If this assumption holds\n       // true, we can avoid get from bucket table.\n \n+      // Check if Key already exists\n+      String dbKeyName = omMetadataManager.getOzoneKey(volumeName, bucketName,\n+          keyName);\n+      OmKeyInfo dbKeyInfo = omMetadataManager.getKeyTable().get(dbKeyName);\n+      if (dbKeyInfo != null) {\n+        // Check if this transaction is a replay of ratis logs.\n+        if (isReplay(ozoneManager, dbKeyInfo.getUpdateID(),\n+            transactionLogIndex)) {\n+          // Replay implies the response has already been returned to\n+          // the client. So take no further action and return a dummy\n+          // OMClientResponse.\n+          LOG.debug(\"Replayed Transaction {} ignored. Request: {}\",\n+              transactionLogIndex, createKeyRequest);\n+          return new OMKeyCreateResponse(createReplayOMResponse(omResponse));\n+        }\n+      }\n+\n       OmBucketInfo bucketInfo = omMetadataManager.getBucketTable().get(\n               omMetadataManager.getBucketKey(volumeName, bucketName));\n \n       encryptionInfo = getFileEncryptionInfo(ozoneManager, bucketInfo);\n \n-      omKeyInfo = prepareKeyInfo(omMetadataManager, keyArgs,\n-          omMetadataManager.getOzoneKey(volumeName, bucketName, keyName),\n+      omKeyInfo = prepareKeyInfo(omMetadataManager, keyArgs, dbKeyName,\n           keyArgs.getDataSize(), locations, encryptionInfo.orNull(),\n           ozoneManager.getPrefixManager(), bucketInfo, transactionLogIndex);\n-      omClientResponse = prepareCreateKeyResponse(keyArgs, omKeyInfo,\n-          locations, encryptionInfo.orNull(), exception,\n+      omClientResponse = prepareCreateKeyResponse(omResponse, keyArgs,", "originalCommit": "21a5e17655c5cd779609a02996edc48a003d6601", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDM5OTk2Mw==", "url": "https://github.com/apache/ozone/pull/448#discussion_r370399963", "bodyText": "Done.", "author": "hanishakoneru", "createdAt": "2020-01-23T22:59:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Nzc2MTYwNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDgzMjkyNw==", "url": "https://github.com/apache/ozone/pull/448#discussion_r370832927", "bodyText": "We are adding blocks twice for the case when keyInfo != null, as once in prepareKeyInfo and here again.\nSo, can we move the creation of KeyInfo logic to prepareKeyInfo and use prepareCreateKeyResponse just to generate OmClientResponse.", "author": "bharatviswa504", "createdAt": "2020-01-24T20:41:27Z", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/key/OMKeyRequest.java", "diffHunk": "@@ -250,91 +249,113 @@ public EncryptedKeyVersion run() throws IOException {\n    * @return OMClientResponse\n    */\n   @SuppressWarnings(\"parameternumber\")\n-  protected OMClientResponse prepareCreateKeyResponse(@Nonnull KeyArgs keyArgs,\n+  protected OMClientResponse prepareCreateKeyResponse(\n+      @Nonnull OMResponse.Builder omResponse, @Nonnull KeyArgs keyArgs,\n       OmKeyInfo omKeyInfo, @Nonnull List<OmKeyLocationInfo> locations,\n-      FileEncryptionInfo encryptionInfo, @Nullable IOException exception,\n+      FileEncryptionInfo encryptionInfo,\n       long clientID, long transactionLogIndex, @Nonnull String volumeName,\n       @Nonnull String bucketName, @Nonnull String keyName,\n       @Nonnull OzoneManager ozoneManager, @Nonnull OMAction omAction,\n       @Nonnull PrefixManager prefixManager,\n       @Nullable OmBucketInfo omBucketInfo) {\n \n-    OMResponse.Builder omResponse = OMResponse.newBuilder()\n-        .setStatus(OzoneManagerProtocolProtos.Status.OK);\n     OMMetadataManager omMetadataManager = ozoneManager.getMetadataManager();\n-\n-    Map<String, String> auditMap = buildKeyArgsAuditMap(keyArgs);\n-\n     OMClientResponse omClientResponse = null;\n-    if (exception == null) {\n-      if (omKeyInfo == null) {\n-        // the key does not exist, create a new object, the new blocks are the\n-        // version 0\n-        omKeyInfo = createKeyInfo(keyArgs, locations, keyArgs.getFactor(),\n-            keyArgs.getType(), keyArgs.getDataSize(), encryptionInfo,\n-            prefixManager, omBucketInfo, transactionLogIndex);\n-      }\n+    IOException exception = null;\n \n-      long openVersion = omKeyInfo.getLatestVersionLocations().getVersion();\n+    Map<String, String> auditMap = buildKeyArgsAuditMap(keyArgs);\n \n-      // Append blocks\n-      try {\n-        omKeyInfo.appendNewBlocks(keyArgs.getKeyLocationsList().stream()\n-            .map(OmKeyLocationInfo::getFromProtobuf)\n-            .collect(Collectors.toList()), false);\n+    if (omKeyInfo == null) {\n+      // the key does not exist, create a new object, the new blocks are the\n+      // version 0\n+      omKeyInfo = createKeyInfo(keyArgs, locations, keyArgs.getFactor(),\n+          keyArgs.getType(), keyArgs.getDataSize(), encryptionInfo,\n+          prefixManager, omBucketInfo, transactionLogIndex);\n+    }\n \n-      } catch (IOException ex) {\n-        exception = ex;\n-      }\n+    long openVersion = omKeyInfo.getLatestVersionLocations().getVersion();\n \n-      if (exception != null) {\n-        LOG.error(\"{} failed for Key: {} in volume/bucket:{}/{}\",\n-            omAction.getAction(), keyName, bucketName, volumeName, exception);\n-        omClientResponse = createKeyErrorResponse(ozoneManager.getMetrics(),\n-            omAction, exception, omResponse);\n+    // Append blocks", "originalCommit": "9bf0ec6dd3795cd3a5ced9e9f6de1e9f387046bf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDgzNjc1NA==", "url": "https://github.com/apache/ozone/pull/448#discussion_r370836754", "bodyText": "I think we are adding blocks only once. But still, if we consolidate the logic it will be good. Okay with doing that in a new Jira also.", "author": "bharatviswa504", "createdAt": "2020-01-24T20:52:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDgzMjkyNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDgzMzgzOQ==", "url": "https://github.com/apache/ozone/pull/448#discussion_r370833839", "bodyText": "NIT: public -> protected. (In Base class addToBatch is protected)", "author": "bharatviswa504", "createdAt": "2020-01-24T20:43:59Z", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/response/key/OMKeyCreateResponse.java", "diffHunk": "@@ -38,26 +36,30 @@\n   private OmKeyInfo omKeyInfo;\n   private long openKeySessionID;\n \n-  public OMKeyCreateResponse(@Nullable OmKeyInfo omKeyInfo,\n-      long openKeySessionID, @Nonnull OMResponse omResponse) {\n+  public OMKeyCreateResponse(@Nonnull OMResponse omResponse,\n+      @Nonnull OmKeyInfo omKeyInfo, long openKeySessionID) {\n     super(omResponse);\n     this.omKeyInfo = omKeyInfo;\n     this.openKeySessionID = openKeySessionID;\n   }\n \n+  /**\n+   * For when the request is not successful or it is a replay transaction.\n+   * For a successful request, the other constructor should be used.\n+   */\n+  public OMKeyCreateResponse(@Nonnull OMResponse omResponse) {\n+    super(omResponse);\n+    checkStatusNotOK();\n+  }\n+\n   @Override\n   public void addToDBBatch(OMMetadataManager omMetadataManager,\n       BatchOperation batchOperation) throws IOException {\n \n-    // For OmResponse with failure, this should do nothing. This method is\n-    // not called in failure scenario in OM code.\n-    if (getOMResponse().getStatus() == OzoneManagerProtocolProtos.Status.OK) {\n-      String openKey = omMetadataManager.getOpenKey(omKeyInfo.getVolumeName(),\n-          omKeyInfo.getBucketName(), omKeyInfo.getKeyName(),\n-          openKeySessionID);\n-      omMetadataManager.getOpenKeyTable().putWithBatch(batchOperation,\n-          openKey, omKeyInfo);\n-    }\n+    String openKey = omMetadataManager.getOpenKey(omKeyInfo.getVolumeName(),", "originalCommit": "9bf0ec6dd3795cd3a5ced9e9f6de1e9f387046bf", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "f1a8ac0f671d11ea516717b93f6bebd7ad37b721", "url": "https://github.com/apache/ozone/commit/f1a8ac0f671d11ea516717b93f6bebd7ad37b721", "message": "HDDS-2870. Handle replay of KeyCreate requests.\n\nHDDS-2870. Unit tests\n\nHDDS-2870. checkstyle fixes\n\nHDDS-2870. Unit test for FileCreateRequest\n\nreview comments\n\nRefactored OMKeyRequest#prepareKeyInfo and OMKeyRequest#prepareCreateKeyResponse\n\ncheckstyle", "committedDate": "2020-01-27T23:22:06Z", "type": "commit"}, {"oid": "e573284e39e2bf24d8e021fdefb7b81bab1df7d0", "url": "https://github.com/apache/ozone/commit/e573284e39e2bf24d8e021fdefb7b81bab1df7d0", "message": "HDDS-2870. Adding OMReplayException to handle replay case", "committedDate": "2020-01-28T18:41:08Z", "type": "commit"}, {"oid": "e573284e39e2bf24d8e021fdefb7b81bab1df7d0", "url": "https://github.com/apache/ozone/commit/e573284e39e2bf24d8e021fdefb7b81bab1df7d0", "message": "HDDS-2870. Adding OMReplayException to handle replay case", "committedDate": "2020-01-28T18:41:08Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjAxOTEyMg==", "url": "https://github.com/apache/ozone/pull/448#discussion_r372019122", "bodyText": "Minor: Duplicate  // Check if this transaction is a replay of ratis logs.\nWe can remove one.", "author": "bharatviswa504", "createdAt": "2020-01-28T19:47:18Z", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/file/OMFileCreateRequest.java", "diffHunk": "@@ -194,6 +212,28 @@ public OMClientResponse validateAndUpdateCache(OzoneManager ozoneManager,\n             OMException.ResultCodes.NOT_A_FILE);\n       }\n \n+      // Check if Key already exists in KeyTable and this transaction is a\n+      // replay.\n+      String ozoneKey = omMetadataManager.getOzoneKey(volumeName, bucketName,\n+          keyName);\n+      OmKeyInfo dbKeyInfo = omMetadataManager.getKeyTable().get(ozoneKey);\n+      if (dbKeyInfo != null) {\n+        // Check if this transaction is a replay of ratis logs.\n+        // Check if this transaction is a replay of ratis logs.", "originalCommit": "e573284e39e2bf24d8e021fdefb7b81bab1df7d0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjAyNDQyNA==", "url": "https://github.com/apache/ozone/pull/448#discussion_r372024424", "bodyText": "L302-L318 is common for FileCreate and KeyCreate can we move into a method and use it.\nOr we can move these to prepareKeyInfo from 302-310 and add new method to add to cache and response. In this way OmKeyInfo will be generated by prepareKeyInfo and response and adding to cache will be in a new method.", "author": "bharatviswa504", "createdAt": "2020-01-28T19:57:51Z", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/file/OMFileCreateRequest.java", "diffHunk": "@@ -254,36 +294,88 @@ public OMClientResponse validateAndUpdateCache(OzoneManager ozoneManager,\n       OmBucketInfo bucketInfo = omMetadataManager.getBucketTable().get(\n           omMetadataManager.getBucketKey(volumeName, bucketName));\n       encryptionInfo = getFileEncryptionInfo(ozoneManager, bucketInfo);\n-      omKeyInfo = prepareKeyInfo(omMetadataManager, keyArgs,\n-          omMetadataManager.getOzoneKey(volumeName, bucketName,\n-              keyName), keyArgs.getDataSize(), locations,\n-          encryptionInfo.orNull(), ozoneManager.getPrefixManager(),\n-          bucketInfo, transactionLogIndex);\n-\n-      omClientResponse =  prepareCreateKeyResponse(keyArgs, omKeyInfo,\n-          locations, encryptionInfo.orNull(), exception,\n-          createFileRequest.getClientID(), transactionLogIndex, volumeName,\n-          bucketName, keyName, ozoneManager,\n-          OMAction.CREATE_FILE, ozoneManager.getPrefixManager(), bucketInfo);\n+\n+      omKeyInfo = prepareKeyInfo(omMetadataManager, keyArgs, dbKeyInfo,\n+          keyArgs.getDataSize(), locations, encryptionInfo.orNull(),\n+          ozoneManager.getPrefixManager(), bucketInfo, trxnLogIndex);\n+\n+      long openVersion = omKeyInfo.getLatestVersionLocations().getVersion();", "originalCommit": "e573284e39e2bf24d8e021fdefb7b81bab1df7d0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjA1MDg2NA==", "url": "https://github.com/apache/ozone/pull/448#discussion_r372050864", "bodyText": "The issue is we have to get the openVersion before appending new blocks. Hence, I kept these lines out of prepareKeyInfo.\nI can add the appendBlocks and updateCache calls to another method. But since it was just 2 calls, i though it could be outside.", "author": "hanishakoneru", "createdAt": "2020-01-28T20:56:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjAyNDQyNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjA2MzU4Mg==", "url": "https://github.com/apache/ozone/pull/448#discussion_r372063582", "bodyText": "@hanishakoneru We shall open a new Jira to address this.", "author": "bharatviswa504", "createdAt": "2020-01-28T21:19:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjAyNDQyNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzMwNDc0NQ==", "url": "https://github.com/apache/ozone/pull/448#discussion_r377304745", "bodyText": "When i move the append blocks code inside prepareKeyInfo, it breaks multiplartUpload. TestOzoneSecure#testMultipartUploadOverride() fails because of this. This was done as part of HDDS-2944.\nSo going to keep append blocks outside the prepareKeyInfo() function.", "author": "hanishakoneru", "createdAt": "2020-02-10T20:42:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjAyNDQyNA=="}], "type": "inlineReview"}, {"oid": "717b0ffab355f86f86c4aa800f1f1b586f418c97", "url": "https://github.com/apache/ozone/commit/717b0ffab355f86f86c4aa800f1f1b586f418c97", "message": "review and checkstyle fix", "committedDate": "2020-01-28T20:00:04Z", "type": "commit"}, {"oid": "717b0ffab355f86f86c4aa800f1f1b586f418c97", "url": "https://github.com/apache/ozone/commit/717b0ffab355f86f86c4aa800f1f1b586f418c97", "message": "review and checkstyle fix", "committedDate": "2020-01-28T20:00:04Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjAzMjA0Mw==", "url": "https://github.com/apache/ozone/pull/448#discussion_r372032043", "bodyText": "Minor: Missing checkStatusNotOK() and also can we add similar javadoc as OMKeyCreateResponse.", "author": "bharatviswa504", "createdAt": "2020-01-28T20:14:13Z", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/response/file/OMFileCreateResponse.java", "diffHunk": "@@ -18,24 +18,25 @@\n \n package org.apache.hadoop.ozone.om.response.file;\n \n-import javax.annotation.Nullable;\n import javax.annotation.Nonnull;\n \n import org.apache.hadoop.ozone.om.helpers.OmKeyInfo;\n import org.apache.hadoop.ozone.om.response.key.OMKeyCreateResponse;\n import org.apache.hadoop.ozone.protocol.proto.OzoneManagerProtocolProtos\n     .OMResponse;\n \n-\n-\n /**\n  * Response for crate file request.\n  */\n public class OMFileCreateResponse extends OMKeyCreateResponse {\n \n-  public OMFileCreateResponse(@Nullable OmKeyInfo omKeyInfo,\n-      long openKeySessionID, @Nonnull OMResponse omResponse) {\n-    super(omKeyInfo, openKeySessionID, omResponse);\n+  public OMFileCreateResponse(@Nonnull OMResponse omResponse,\n+      @Nonnull OmKeyInfo omKeyInfo, long openKeySessionID) {\n+    super(omResponse, omKeyInfo, openKeySessionID);\n+  }\n+\n+  public OMFileCreateResponse(@Nonnull OMResponse omResponse) {\n+    super(omResponse);", "originalCommit": "717b0ffab355f86f86c4aa800f1f1b586f418c97", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjA1MjI4Ng==", "url": "https://github.com/apache/ozone/pull/448#discussion_r372052286", "bodyText": "Thanks for catching this. If you are ok with rest of the patch, I add this check in the next Jira HDDS-2944.", "author": "hanishakoneru", "createdAt": "2020-01-28T20:59:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjAzMjA0Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjA2Mzc2OA==", "url": "https://github.com/apache/ozone/pull/448#discussion_r372063768", "bodyText": "Sure.", "author": "bharatviswa504", "createdAt": "2020-01-28T21:20:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjAzMjA0Mw=="}], "type": "inlineReview"}]}