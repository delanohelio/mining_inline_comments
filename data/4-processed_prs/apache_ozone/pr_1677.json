{"pr_number": 1677, "pr_title": "HDDS-4562. Old bucket needs to be accessible after the cluster was upgraded to the Quota version.", "pr_createdAt": "2020-12-09T02:38:03Z", "pr_url": "https://github.com/apache/ozone/pull/1677", "timeline": [{"oid": "2b61f809783986ba5ee4d140de95d457432af78c", "url": "https://github.com/apache/ozone/commit/2b61f809783986ba5ee4d140de95d457432af78c", "message": "fix review issues", "committedDate": "2020-12-14T07:03:45Z", "type": "forcePushed"}, {"oid": "265bf1db8f1ecdf2dedc932a95d0b10872555738", "url": "https://github.com/apache/ozone/commit/265bf1db8f1ecdf2dedc932a95d0b10872555738", "message": "fix namespace quota.", "committedDate": "2020-12-14T13:04:35Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjkxNzU2Mw==", "url": "https://github.com/apache/ozone/pull/1677#discussion_r542917563", "bodyText": "Why do we need to do this during set Operation?", "author": "bharatviswa504", "createdAt": "2020-12-14T23:19:33Z", "path": "hadoop-ozone/client/src/main/java/org/apache/hadoop/ozone/client/rpc/RpcClient.java", "diffHunk": "@@ -291,9 +291,10 @@ public boolean setVolumeOwner(String volumeName, String owner)\n   public void setVolumeQuota(String volumeName, long quotaInCounts,\n       long quotaInBytes) throws IOException {\n     HddsClientUtils.verifyResourceName(volumeName);\n-    verifyCountsQuota(quotaInCounts);\n-    verifySpaceQuota(quotaInBytes);\n-    ozoneManagerClient.setQuota(volumeName, quotaInCounts, quotaInBytes);\n+    verifyCountsQuota(getQuotaValue(quotaInCounts));", "originalCommit": "ed17532fb5702f9a3429d1909d9cb1a4dea94824", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzAxODUzNg==", "url": "https://github.com/apache/ozone/pull/1677#discussion_r543018536", "bodyText": "This check simply ensures that when we use RpcClient set Quota, the value of quota must be legal (not less than -1). But the getQuotaValue conversion step inside is redundant,  I\u2018ll  delete this conversion.", "author": "captainzmc", "createdAt": "2020-12-15T03:29:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjkxNzU2Mw=="}], "type": "inlineReview"}, {"oid": "58b555780f1835356d1415f73672b66db9a931dc", "url": "https://github.com/apache/ozone/commit/58b555780f1835356d1415f73672b66db9a931dc", "message": "fix bucket quotaInBytes.", "committedDate": "2020-12-15T07:00:07Z", "type": "forcePushed"}, {"oid": "5b88e5160e267400ef8f9298911a63a5bd600d44", "url": "https://github.com/apache/ozone/commit/5b88e5160e267400ef8f9298911a63a5bd600d44", "message": "fix bucket quotaInBytes.", "committedDate": "2020-12-15T07:11:49Z", "type": "forcePushed"}, {"oid": "a38bd49a7c928557ec5346047191bc699dbb3b27", "url": "https://github.com/apache/ozone/commit/a38bd49a7c928557ec5346047191bc699dbb3b27", "message": "fix bucket quotaInBytes.", "committedDate": "2020-12-15T07:16:56Z", "type": "forcePushed"}, {"oid": "576e3d399ab78663dd4398b9b255f4dbba2508de", "url": "https://github.com/apache/ozone/commit/576e3d399ab78663dd4398b9b255f4dbba2508de", "message": "fix bucket quotaInBytes.", "committedDate": "2020-12-15T07:18:26Z", "type": "forcePushed"}, {"oid": "bc0ec8be7e745e64dc8159df3a86ff8eb9e94e51", "url": "https://github.com/apache/ozone/commit/bc0ec8be7e745e64dc8159df3a86ff8eb9e94e51", "message": "fix bucket quotaInBytes.", "committedDate": "2020-12-15T08:07:54Z", "type": "commit"}, {"oid": "bc0ec8be7e745e64dc8159df3a86ff8eb9e94e51", "url": "https://github.com/apache/ozone/commit/bc0ec8be7e745e64dc8159df3a86ff8eb9e94e51", "message": "fix bucket quotaInBytes.", "committedDate": "2020-12-15T08:07:54Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzM5MzAwMg==", "url": "https://github.com/apache/ozone/pull/1677#discussion_r543393002", "bodyText": "We can make this check in OM side and throw exception once user try to set quota on older version volumes/buckets.", "author": "linyiqun", "createdAt": "2020-12-15T14:27:52Z", "path": "hadoop-hdds/docs/content/feature/Quota.md", "diffHunk": "@@ -32,11 +32,16 @@ So far, we know that Ozone allows users to create volumes, buckets, and keys. A\n 1. Storage Space level quota\n \n Administrators should be able to define how much storage space a Volume or Bucket can use. The following Settings for Storage space quota are currently supported\uff1a\n+\n a. By default, the quota for volume and bucket is not enabled.\n+\n b. When volume quota is enabled, the total size of bucket quota cannot exceed volume.\n+\n c. Bucket quota can be set separately without enabling Volume quota. The size of bucket quota is unrestricted at this point.\n+\n d. Volume quota is not currently supported separately, and volume quota takes effect only if bucket quota is set. Because ozone only check the usedBytes of the bucket when we write the key.\n \n+e. If the cluster is upgraded from old version less than 1.1.0, use of quota on older volumes and buckets is not recommended. Since the old key is not counted to the bucket's usedBytes, the quota setting is inaccurate at this point.", "originalCommit": "bc0ec8be7e745e64dc8159df3a86ff8eb9e94e51", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDIzMzM0NQ==", "url": "https://github.com/apache/ozone/pull/1677#discussion_r544233345", "bodyText": "Currently, we have not agreed on whether bucket can be enabled for the old quota. At present, we only put forward the suggestion in the document very briefly. If the requirement is clear, we can issue Jira and solve it.", "author": "captainzmc", "createdAt": "2020-12-16T11:46:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzM5MzAwMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTIwNjY0MQ==", "url": "https://github.com/apache/ozone/pull/1677#discussion_r545206641", "bodyText": "Make sense to me.", "author": "linyiqun", "createdAt": "2020-12-17T16:03:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzM5MzAwMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzM5NDM2Ng==", "url": "https://github.com/apache/ozone/pull/1677#discussion_r543394366", "bodyText": "The namespace quota introduction can also be added. We could file a new JIRA for tacking this.", "author": "linyiqun", "createdAt": "2020-12-15T14:29:36Z", "path": "hadoop-hdds/docs/content/feature/Quota.md", "diffHunk": "@@ -32,11 +32,16 @@ So far, we know that Ozone allows users to create volumes, buckets, and keys. A\n 1. Storage Space level quota", "originalCommit": "bc0ec8be7e745e64dc8159df3a86ff8eb9e94e51", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzYzMzE2MQ==", "url": "https://github.com/apache/ozone/pull/1677#discussion_r543633161", "bodyText": "I can add namespace quota to this documentation: https://issues.apache.org/jira/browse/HDDS-4594. Before adding to documentation, I will first finish namespace support on bucket: https://issues.apache.org/jira/browse/HDDS-4277", "author": "amaliujia", "createdAt": "2020-12-15T19:38:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzM5NDM2Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzU1NzY0NQ==", "url": "https://github.com/apache/ozone/pull/1677#discussion_r543557645", "bodyText": "Minor:\nWhen volume quota is enabled, the total quota of the buckets, cannot exceed the volume quota.", "author": "bharatviswa504", "createdAt": "2020-12-15T17:50:08Z", "path": "hadoop-hdds/docs/content/feature/Quota.md", "diffHunk": "@@ -32,11 +32,16 @@ So far, we know that Ozone allows users to create volumes, buckets, and keys. A\n 1. Storage Space level quota\n \n Administrators should be able to define how much storage space a Volume or Bucket can use. The following Settings for Storage space quota are currently supported\uff1a\n+\n a. By default, the quota for volume and bucket is not enabled.\n+\n b. When volume quota is enabled, the total size of bucket quota cannot exceed volume.", "originalCommit": "bc0ec8be7e745e64dc8159df3a86ff8eb9e94e51", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzU1ODU1NA==", "url": "https://github.com/apache/ozone/pull/1677#discussion_r543558554", "bodyText": "Can we also add documentation about the clear space quota and the behavior?", "author": "bharatviswa504", "createdAt": "2020-12-15T17:51:24Z", "path": "hadoop-hdds/docs/content/feature/Quota.md", "diffHunk": "@@ -32,11 +32,16 @@ So far, we know that Ozone allows users to create volumes, buckets, and keys. A\n 1. Storage Space level quota\n \n Administrators should be able to define how much storage space a Volume or Bucket can use. The following Settings for Storage space quota are currently supported\uff1a\n+\n a. By default, the quota for volume and bucket is not enabled.\n+\n b. When volume quota is enabled, the total size of bucket quota cannot exceed volume.\n+\n c. Bucket quota can be set separately without enabling Volume quota. The size of bucket quota is unrestricted at this point.\n+\n d. Volume quota is not currently supported separately, and volume quota takes effect only if bucket quota is set. Because ozone only check the usedBytes of the bucket when we write the key.\n \n+e. If the cluster is upgraded from old version less than 1.1.0, use of quota on older volumes and buckets is not recommended. Since the old key is not counted to the bucket's usedBytes, the quota setting is inaccurate at this point.", "originalCommit": "bc0ec8be7e745e64dc8159df3a86ff8eb9e94e51", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTU5MjQ4OA==", "url": "https://github.com/apache/ozone/pull/1677#discussion_r545592488", "bodyText": "Yes. To prevent conflicts, I have updated the usage and behavior of clear space quota in this PR.", "author": "captainzmc", "createdAt": "2020-12-18T06:07:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzU1ODU1NA=="}], "type": "inlineReview"}, {"oid": "7dce9f7a96c799d481f48316239a93865f1dac40", "url": "https://github.com/apache/ozone/commit/7dce9f7a96c799d481f48316239a93865f1dac40", "message": "fix review issues and change default to -2.", "committedDate": "2020-12-17T02:20:39Z", "type": "forcePushed"}, {"oid": "c2704f79b1e64a683eabe6031157f4dd4248c691", "url": "https://github.com/apache/ozone/commit/c2704f79b1e64a683eabe6031157f4dd4248c691", "message": "fix review issues and change default to -2.", "committedDate": "2020-12-17T11:19:19Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTE4MzM1Ng==", "url": "https://github.com/apache/ozone/pull/1677#discussion_r545183356", "bodyText": "Why we change above condition check? Above check is to confirmed that the quota is enabled, not a validation check. If we want to make sure quota value is a positive value, I prefer to additionally add omVolumeArgs.getQuotaInNamespace() > 0 check.\nif (omVolumeArgs.getQuotaInNamespace() != OzoneConsts.QUOTA_RESET && omVolumeArgs.getQuotaInNamespace() > 0) {\n}", "author": "linyiqun", "createdAt": "2020-12-17T15:34:46Z", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/bucket/OMBucketCreateRequest.java", "diffHunk": "@@ -314,7 +314,9 @@ private BucketEncryptionInfoProto getBeinfo(\n    */\n   private void checkQuotaInNamespace(OmVolumeArgs omVolumeArgs,\n       long allocatedNamespace) throws IOException {\n-    if (omVolumeArgs.getQuotaInNamespace() != OzoneConsts.QUOTA_RESET) {\n+    // Client has ensured that no negative values other than -1 (clear quota)\n+    // will occur when quota is set.\n+    if (omVolumeArgs.getQuotaInNamespace() > OzoneConsts.QUOTA_RESET) {", "originalCommit": "c2704f79b1e64a683eabe6031157f4dd4248c691", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTUyNjM5MQ==", "url": "https://github.com/apache/ozone/pull/1677#discussion_r545526391", "bodyText": "@linyiqun Here with omVolumeArgs.getQuotaInNamespace () > 0 is enough? Because when it > 0 is certainly is not equal to -1.", "author": "captainzmc", "createdAt": "2020-12-18T02:08:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTE4MzM1Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTUzMDc0OQ==", "url": "https://github.com/apache/ozone/pull/1677#discussion_r545530749", "bodyText": "@captainzmc , here my point is that we should firstly check if the quota was enabled by using one variable flag(here I understand is OzoneConsts.QUOTA_RESET). Then we check the quota value if it's valid. Is there a switch config for the quota now?  If the quota is not enabled, we don't need to do the quota check anymore.\nFor the current value OzoneConsts.QUOTA_RESET is -1, omVolumeArgs.getQuotaInNamespace () > 0 makes the sense. But once OzoneConsts.QUOTA_RESET  to a positive value, this check won't work. So omVolumeArgs.getQuotaInNamespace() != OzoneConsts.QUOTA_RESET would still be a better check.", "author": "linyiqun", "createdAt": "2020-12-18T02:23:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTE4MzM1Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTUzNjM1Mw==", "url": "https://github.com/apache/ozone/pull/1677#discussion_r545536353", "bodyText": "Thanks for @linyiqun's feedback.\nCurrent there are two case  -1 or -2 (old volume/bucket) not check quota, actually we have guarantee on the client, user cann\u2019t set negative quota, Therefore, except for clear quota and old quota, there is no negative case.\nIn addition to using omVolumeArgs.getQuotaInNamespace ()! = OzoneConsts.QUOTA_RESET also need add omvolumeargs.getQuotainNamespace ()! = 2. The judgment condition will increase too much and the code will not be clear enough, we can use omVolumeArgs. getQuotaInNamespace () > 0, this will make the code much cleaner.", "author": "captainzmc", "createdAt": "2020-12-18T02:40:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTE4MzM1Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTU0OTU2Ng==", "url": "https://github.com/apache/ozone/pull/1677#discussion_r545549566", "bodyText": "Okay, go ahead for this.", "author": "linyiqun", "createdAt": "2020-12-18T03:26:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTE4MzM1Ng=="}], "type": "inlineReview"}, {"oid": "828f2e370d3164f24bdb811f0c48508617336a66", "url": "https://github.com/apache/ozone/commit/828f2e370d3164f24bdb811f0c48508617336a66", "message": "fix review issues and change default to -2.", "committedDate": "2020-12-18T02:15:08Z", "type": "forcePushed"}, {"oid": "554c9a86c1ae468501141fcd62944a62b109926f", "url": "https://github.com/apache/ozone/commit/554c9a86c1ae468501141fcd62944a62b109926f", "message": "fix review issues and change default to -2.", "committedDate": "2020-12-18T06:02:55Z", "type": "commit"}, {"oid": "554c9a86c1ae468501141fcd62944a62b109926f", "url": "https://github.com/apache/ozone/commit/554c9a86c1ae468501141fcd62944a62b109926f", "message": "fix review issues and change default to -2.", "committedDate": "2020-12-18T06:02:55Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTYxMDI0OQ==", "url": "https://github.com/apache/ozone/pull/1677#discussion_r545610249", "bodyText": "#1677 (comment)\nAny reason for moving back to int64?", "author": "bharatviswa504", "createdAt": "2020-12-18T07:03:15Z", "path": "hadoop-ozone/interface-client/src/main/proto/OmClientProtocol.proto", "diffHunk": "@@ -503,8 +503,8 @@ message BucketInfo {\n     optional string sourceVolume = 12;\n     optional string sourceBucket = 13;\n     optional uint64 usedBytes = 14;\n-    optional uint64 quotaInBytes = 15;\n-    optional uint64 quotaInNamespace = 16;\n+    optional int64 quotaInBytes = 15 [default = -2];", "originalCommit": "554c9a86c1ae468501141fcd62944a62b109926f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTY1NzE1Mw==", "url": "https://github.com/apache/ozone/pull/1677#discussion_r545657153", "bodyText": "Using sint64, I found that the default value changed to -9223372036854775808. This could be a compatibility issue. So I switched to int64, this is correct.", "author": "captainzmc", "createdAt": "2020-12-18T08:37:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTYxMDI0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjMzMzg5NQ==", "url": "https://github.com/apache/ozone/pull/1677#discussion_r546333895", "bodyText": "Interesting, thanks for info.", "author": "bharatviswa504", "createdAt": "2020-12-20T07:16:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTYxMDI0OQ=="}], "type": "inlineReview"}]}