{"pr_number": 1533, "pr_title": "HDDS-4408: Datanode State Machine Thread should keep alive during the whole lifetime of Datanode", "pr_createdAt": "2020-10-29T09:49:49Z", "pr_url": "https://github.com/apache/ozone/pull/1533", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTk5MzQyMA==", "url": "https://github.com/apache/ozone/pull/1533#discussion_r519993420", "bodyText": "Would it be better for the DN to just self-terminate if there is an uncaught exception in the state machine thread? Do we know what was the exact uncaught exception?", "author": "arp7", "createdAt": "2020-11-09T17:33:39Z", "path": "hadoop-hdds/container-service/src/main/java/org/apache/hadoop/ozone/container/common/statemachine/DatanodeStateMachine.java", "diffHunk": "@@ -399,18 +390,27 @@ public boolean isTransitionAllowedTo(DatanodeStates newState) {\n    * Start datanode state machine as a single thread daemon.\n    */\n   public void startDaemon() {\n-    Runnable startStateMachineTask = () -> {\n-      try {\n-        start();\n-        LOG.info(\"Ozone container server started.\");\n-      } catch (Exception ex) {\n-        LOG.error(\"Unable to start the DatanodeState Machine\", ex);\n-      }\n-    };\n+    reportManager.init();\n+    initCommandHandlerThread(conf);\n+\n+    // Start jvm monitor\n+    jvmPauseMonitor = new JvmPauseMonitor();\n+    jvmPauseMonitor\n+        .init(LegacyHadoopConfigurationSource.asHadoopConfiguration(conf));\n+    jvmPauseMonitor.start();\n+\n     stateMachineThread =  new ThreadFactoryBuilder()\n         .setDaemon(true)\n         .setNameFormat(\"Datanode State Machine Thread - %d\")\n-        .build().newThread(startStateMachineTask);\n+        .setUncaughtExceptionHandler((Thread t, Throwable e) -> {", "originalCommit": "4e88b00b43f496d7daa237c1669b52ce704fb2c7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDI3NjE0Mg==", "url": "https://github.com/apache/ozone/pull/1533#discussion_r520276142", "bodyText": "Yes, we know the uncaught exception, it is the OOM due to queued reports for a dead Recon. You may find the detail from above conversations.\nEither a HA solution or a fast fail solution is fine to me.\nBTW, the restart thread solution is already used in cmdProcessThread and leaseMonitorThread.", "author": "GlenGeng", "createdAt": "2020-11-10T04:17:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTk5MzQyMA=="}], "type": "inlineReview"}, {"oid": "aeaa76a8f72e4ddbf584ae3bf1dac3d8932c5952", "url": "https://github.com/apache/ozone/commit/aeaa76a8f72e4ddbf584ae3bf1dac3d8932c5952", "message": "HDDS-4408: terminate Datanode when Datanode State Machine Thread got uncaught exception.", "committedDate": "2020-11-12T11:07:30Z", "type": "commit"}, {"oid": "aeaa76a8f72e4ddbf584ae3bf1dac3d8932c5952", "url": "https://github.com/apache/ozone/commit/aeaa76a8f72e4ddbf584ae3bf1dac3d8932c5952", "message": "HDDS-4408: terminate Datanode when Datanode State Machine Thread got uncaught exception.", "committedDate": "2020-11-12T11:07:30Z", "type": "forcePushed"}]}