{"pr_number": 1601, "pr_title": "HDDS-4404. Datanode can go OOM when a Recon or SCM Server is very slow in processing reports", "pr_createdAt": "2020-11-19T00:58:54Z", "pr_url": "https://github.com/apache/ozone/pull/1601", "timeline": [{"oid": "2cb1635bf632d5adfa0fef3f5425a161f1365507", "url": "https://github.com/apache/ozone/commit/2cb1635bf632d5adfa0fef3f5425a161f1365507", "message": "HDDS-4404. Datanode can go OOM when a Recon or SCM Server is very slow in processing reports.\n\nChange-Id: Idf6394d0bde2fb1c9fe99a96c49fa28677e0e527", "committedDate": "2020-11-19T00:50:50Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzA3NjY5OQ==", "url": "https://github.com/apache/ozone/pull/1601#discussion_r527076699", "bodyText": "I see that this is a new logical condition here. When a new report publisher is added, explicit changes are needed here. If not, we can keep Line 237 as a simple else.", "author": "avijayanhwx", "createdAt": "2020-11-19T17:41:09Z", "path": "hadoop-hdds/container-service/src/main/java/org/apache/hadoop/ozone/container/common/statemachine/StateContext.java", "diffHunk": "@@ -190,16 +217,32 @@ void setShutdownGracefully() {\n   public boolean getShutdownOnError() {\n     return shutdownOnError;\n   }\n+\n   /**\n    * Adds the report to report queue.\n    *\n    * @param report report to be added\n    */\n   public void addReport(GeneratedMessage report) {\n     if (report != null) {\n-      synchronized (reports) {\n-        for (InetSocketAddress endpoint : endpoints) {\n-          reports.get(endpoint).add(report);\n+      final String reportType = report.getDescriptorForType().getFullName();\n+      for (InetSocketAddress endpoint : endpoints) {\n+        // Check report type\n+        if (reportType.equals(containerReportsProtoName)) {\n+          containerReport = report;\n+        } else if (reportType.equals(nodeReportProtoName)) {\n+          nodeReport = report;\n+        } else if (reportType.equals(pipelineReportsProtoName)) {\n+          pipelineReport = report;\n+        } else if (reportType.equals(commandStatusReportsProtoName) ||\n+            reportType.equals(incrementalContainerReportProtoName)) {\n+          // report type is CommandStatusReports or IncrementalContainerReport\n+          synchronized (reports) {\n+            reports.get(endpoint).add(report);", "originalCommit": "2cb1635bf632d5adfa0fef3f5425a161f1365507", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzEzNzg1Mg==", "url": "https://github.com/apache/ozone/pull/1601#discussion_r527137852", "bodyText": "Yes else would work here. I was pushing this as an assertion check here just for now to see if I will get any UT failures. Will remove later.", "author": "smengcl", "createdAt": "2020-11-19T19:19:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzA3NjY5OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzA3Nzc2NQ==", "url": "https://github.com/apache/ozone/pull/1601#discussion_r527077765", "bodyText": "Yes, it looks like we can break out here.", "author": "avijayanhwx", "createdAt": "2020-11-19T17:42:52Z", "path": "hadoop-hdds/container-service/src/main/java/org/apache/hadoop/ozone/container/common/states/endpoint/HeartbeatEndpointTask.java", "diffHunk": "@@ -184,15 +181,30 @@ private void addReports(SCMHeartbeatRequestProto.Builder requestBuilder) {\n     for (GeneratedMessage report :\n         context.getAllAvailableReports(rpcEndpoint.getAddress())) {\n       String reportName = report.getDescriptorForType().getFullName();\n+      // Example reportName = hadoop.hdds.NodeReportProto\n+\n       for (Descriptors.FieldDescriptor descriptor :\n           SCMHeartbeatRequestProto.getDescriptor().getFields()) {\n+\n         String heartbeatFieldName = descriptor.getMessageType().getFullName();\n+        // Possible heartbeatFieldName =\n+        //  hadoop.hdds.DatanodeDetailsProto\n+        //  hadoop.hdds.NodeReportProto\n+        //  hadoop.hdds.ContainerReportsProto\n+        //  hadoop.hdds.IncrementalContainerReportProto\n+        //  hadoop.hdds.CommandStatusReportsProto\n+        //  hadoop.hdds.ContainerActionsProto\n+        //  hadoop.hdds.PipelineActionsProto\n+        //  hadoop.hdds.PipelineReportsProto\n         if (heartbeatFieldName.equals(reportName)) {\n           if (descriptor.isRepeated()) {\n             requestBuilder.addRepeatedField(descriptor, report);\n           } else {\n             requestBuilder.setField(descriptor, report);\n           }\n+          // TODO: We can exit loop early here since we have a match already,\n+          //  right? Double check.\n+          break;", "originalCommit": "2cb1635bf632d5adfa0fef3f5425a161f1365507", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "3e53bf89bda180bd3035351afcbe5a89f30e49b7", "url": "https://github.com/apache/ozone/commit/3e53bf89bda180bd3035351afcbe5a89f30e49b7", "message": "Checkstyle.\n\nChange-Id: I6c4729634905bf6bba5bb6483c393d3c7511a78e", "committedDate": "2020-11-19T19:11:21Z", "type": "commit"}, {"oid": "024a4f80680e1c0421431f35308e68ef251fcba4", "url": "https://github.com/apache/ozone/commit/024a4f80680e1c0421431f35308e68ef251fcba4", "message": "Add mock-maker-inline so UT can mock final classes.\n\nChange-Id: I63470510ed2089438f08f4d3cea321c1b5f01c3c", "committedDate": "2020-11-19T23:07:31Z", "type": "commit"}, {"oid": "22846f48ce34f3fcefa1de2d3bd97c4771c26742", "url": "https://github.com/apache/ozone/commit/22846f48ce34f3fcefa1de2d3bd97c4771c26742", "message": "Remove throw exception in addReport.\n\nChange-Id: Id3ff6222ed279568d32876afc0a6a5ee1316c926", "committedDate": "2020-11-19T23:11:05Z", "type": "commit"}, {"oid": "878d27147fe2fb9b139193461a4b42853f9bd6e8", "url": "https://github.com/apache/ozone/commit/878d27147fe2fb9b139193461a4b42853f9bd6e8", "message": "Fix existing UT TestStateContext#testReportAPIs.\n\nChange-Id: I25020b4411f4163a2ec134431793bfe663e5f6bf", "committedDate": "2020-11-19T23:14:56Z", "type": "commit"}, {"oid": "5b2bbd322405ece0a0b9f59cd9136ce9a61e71c8", "url": "https://github.com/apache/ozone/commit/5b2bbd322405ece0a0b9f59cd9136ce9a61e71c8", "message": "Remove unused imports.\n\nChange-Id: I2dc93c42fc7468b37d41a179ca047ee385fc8896", "committedDate": "2020-11-19T23:16:18Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzQ3MTc3Ng==", "url": "https://github.com/apache/ozone/pull/1601#discussion_r527471776", "bodyText": "Do we need to synchronize the get/set on these containerReport/nodeReport/pipelineReport ?", "author": "GlenGeng", "createdAt": "2020-11-20T06:42:36Z", "path": "hadoop-hdds/container-service/src/main/java/org/apache/hadoop/ozone/container/common/statemachine/StateContext.java", "diffHunk": "@@ -190,16 +211,29 @@ void setShutdownGracefully() {\n   public boolean getShutdownOnError() {\n     return shutdownOnError;\n   }\n+\n   /**\n    * Adds the report to report queue.\n    *\n    * @param report report to be added\n    */\n   public void addReport(GeneratedMessage report) {\n     if (report != null) {\n-      synchronized (reports) {\n-        for (InetSocketAddress endpoint : endpoints) {\n-          reports.get(endpoint).add(report);\n+      // TODO: Check report.getDescriptorForType() != null as well?\n+      final String reportType = report.getDescriptorForType().getFullName();\n+      for (InetSocketAddress endpoint : endpoints) {\n+        // We only keep the latest container, node and pipeline report\n+        if (reportType.equals(CONTAINER_REPORTS_PROTO_NAME)) {", "originalCommit": "5b2bbd322405ece0a0b9f59cd9136ce9a61e71c8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODAwMjk3NA==", "url": "https://github.com/apache/ozone/pull/1601#discussion_r528002974", "bodyText": "No, container/node/pipeline should be fine. We need synchroized on reports because we want Map get and add not to get messed in between.", "author": "smengcl", "createdAt": "2020-11-20T22:24:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzQ3MTc3Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODQ5MzQ2MA==", "url": "https://github.com/apache/ozone/pull/1601#discussion_r528493460", "bodyText": "one thread write containerReport and another thread read containerReport, it's not thread safe, we can use AtomicReference<GeneratedMessage> containerReports", "author": "runzhiwang", "createdAt": "2020-11-23T06:39:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzQ3MTc3Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjgzMjAwMA==", "url": "https://github.com/apache/ozone/pull/1601#discussion_r532832000", "bodyText": "done", "author": "smengcl", "createdAt": "2020-11-30T19:06:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzQ3MTc3Ng=="}], "type": "inlineReview"}, {"oid": "2fcb2b667feaacf13cfdb64784e24a23bee05272", "url": "https://github.com/apache/ozone/commit/2fcb2b667feaacf13cfdb64784e24a23bee05272", "message": "Work around mockito bug in UT TestCreatePipelineCommandHandler: caused by adding mock-maker-inline.\n\nChange-Id: I0f21c508af1f7b36d7632aaa3b9173a17056f211", "committedDate": "2020-11-20T10:48:57Z", "type": "commit"}, {"oid": "c403208e6f403592e5c4e1fb38fbd4054afaf0bb", "url": "https://github.com/apache/ozone/commit/c403208e6f403592e5c4e1fb38fbd4054afaf0bb", "message": "Add UT testContainerNodePipelineReportAPIs.\n\nChange-Id: I8d67a1b6e2d9043fb1479e2547d2e690932f7985", "committedDate": "2020-11-20T11:49:08Z", "type": "commit"}, {"oid": "23d25cb7ab47bef872c99af6e9c460e96ecbc74e", "url": "https://github.com/apache/ozone/commit/23d25cb7ab47bef872c99af6e9c460e96ecbc74e", "message": "Clean up.\n\nChange-Id: Iaec544ba6fb211d0d71fe03b26b0fc70199dc882", "committedDate": "2020-11-20T11:56:55Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODQzNzM1MQ==", "url": "https://github.com/apache/ozone/pull/1601#discussion_r528437351", "bodyText": "@VisiableForTesting ?", "author": "runzhiwang", "createdAt": "2020-11-23T01:28:52Z", "path": "hadoop-hdds/container-service/src/main/java/org/apache/hadoop/ozone/container/common/statemachine/StateContext.java", "diffHunk": "@@ -583,4 +631,16 @@ public void addEndpoint(InetSocketAddress endpoint) {\n       this.reports.put(endpoint, new LinkedList<>());\n     }\n   }\n+\n+  public GeneratedMessage getContainerReports() {", "originalCommit": "23d25cb7ab47bef872c99af6e9c460e96ecbc74e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODQ5MjM5MQ==", "url": "https://github.com/apache/ozone/pull/1601#discussion_r528492391", "bodyText": "done", "author": "smengcl", "createdAt": "2020-11-23T06:34:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODQzNzM1MQ=="}], "type": "inlineReview"}, {"oid": "50b9a5e2258daf3239436d2b84cb68b58fab40ed", "url": "https://github.com/apache/ozone/commit/50b9a5e2258daf3239436d2b84cb68b58fab40ed", "message": "@VisibleForTesting for get container/node/pipeline reports as they are only used in UT, at least at the moment.\n\nChange-Id: I72070fde8df220ecebf2fb6d1015d19f65cee11e", "committedDate": "2020-11-23T06:34:42Z", "type": "commit"}, {"oid": "6f3ea1869645796190c58e0e835878a3538d488f", "url": "https://github.com/apache/ozone/commit/6f3ea1869645796190c58e0e835878a3538d488f", "message": "- Renamed `reports` to `incrementalReportsQueue` to better reflect the functionality of the map.\n- Added `acceptedIncrementalReportTypeSet` for rigorous report type checking.\n- `StateContext#addReport` now explicitly throws, instead of hiding any possible NPEs. Rationale: As I think again, those reports are all internally generated rather than dependent on direct user input. It's better to catch any problem early (if any).\n- `StateContext#addReport` also strictly checks for report type now. This intends to force any future additions of report types to be explicitly allowed. Only 5 report types (names) are expected:\n```\nhadoop.hdds.NodeReportProto\nhadoop.hdds.ContainerReportsProto\nhadoop.hdds.IncrementalContainerReportProto\nhadoop.hdds.CommandStatusReportsProto\nhadoop.hdds.PipelineReportsProto\n```\n- `StateContext#putBackReports` now checks ALL reports in the list to be put back. I'd expect the list to be small. And since the logic is run on each DataNode, it shouldn't become a performance bottleneck. Also added debug logging just in case we need to diagnose it in the future.\n- Added new UT `testPutBackReports` and `testReportQueueWithAddReports` to check that `putBackReports` and `getReports` behaves.\n\nChange-Id: I48aca3d4a422d52532b39c9462a30519c9cbe0eb", "committedDate": "2020-11-24T07:00:04Z", "type": "commit"}, {"oid": "9718488f3d9844317668ece24776de3ba2ffe3d0", "url": "https://github.com/apache/ozone/commit/9718488f3d9844317668ece24776de3ba2ffe3d0", "message": "Make containerReports, nodeReport, pipelineReports atomic and final.\n\nChange-Id: I44aba0ff093fa0ff5f9a35a74ff4126d9c73dd7b", "committedDate": "2020-11-24T07:06:20Z", "type": "commit"}, {"oid": "79882035c581c3b463b9b634a6f82c096bd0901a", "url": "https://github.com/apache/ozone/commit/79882035c581c3b463b9b634a6f82c096bd0901a", "message": "Checkstyle.\n\nChange-Id: I545ca8c636b8bbd1239a936603b6efcbfbd10b88", "committedDate": "2020-11-24T07:09:10Z", "type": "commit"}, {"oid": "fdc582315c024e1cbbd1897b69858107df4fe20a", "url": "https://github.com/apache/ozone/commit/fdc582315c024e1cbbd1897b69858107df4fe20a", "message": "Clean up.\n\nChange-Id: I5cdc38a297cf3d91bad8335eb36f2ba6b2009c10", "committedDate": "2020-11-24T07:15:39Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTI1Njc4MA==", "url": "https://github.com/apache/ozone/pull/1601#discussion_r529256780", "bodyText": "You may make them to be volatile, which is simpler but thread safe as well,", "author": "GlenGeng", "createdAt": "2020-11-24T07:33:32Z", "path": "hadoop-hdds/container-service/src/main/java/org/apache/hadoop/ozone/container/common/statemachine/StateContext.java", "diffHunk": "@@ -72,7 +101,13 @@\n   private final AtomicLong stateExecutionCount;\n   private final ConfigurationSource conf;\n   private final Set<InetSocketAddress> endpoints;\n-  private final Map<InetSocketAddress, List<GeneratedMessage>> reports;\n+  // Only the latest full report of each type is kept\n+  private final AtomicReference<GeneratedMessage> containerReports;", "originalCommit": "fdc582315c024e1cbbd1897b69858107df4fe20a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDU5NjY5MA==", "url": "https://github.com/apache/ozone/pull/1601#discussion_r530596690", "bodyText": "Thanks for the tip. I will keep atomic for now as the report is not updated so frequently on DNs (low performance impact).", "author": "smengcl", "createdAt": "2020-11-25T19:22:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTI1Njc4MA=="}], "type": "inlineReview"}, {"oid": "3a32e8bb8f36ecfbec6d960434446f05f5c12dde", "url": "https://github.com/apache/ozone/commit/3a32e8bb8f36ecfbec6d960434446f05f5c12dde", "message": "Remove assertion in putBackReports as requestBuilder might include Container/Node/Pipeline reports.\n\nThanks Aravindan.\n\nChange-Id: Ic39f53de8bb91a179bd5dc3301aa89ffecf5c076", "committedDate": "2020-11-30T20:35:15Z", "type": "commit"}, {"oid": "84e8f74c3f313156f0c4b01234d3d11a8b7cdc35", "url": "https://github.com/apache/ozone/commit/84e8f74c3f313156f0c4b01234d3d11a8b7cdc35", "message": "Empty commit to retrigger CI.\n\nChange-Id: I46fb65ce2c81cb607dd10a9ee829d829ec7a8cfc", "committedDate": "2020-12-01T19:31:25Z", "type": "commit"}, {"oid": "02298d92cf50a002f518f6f6dc2a27869a2916de", "url": "https://github.com/apache/ozone/commit/02298d92cf50a002f518f6f6dc2a27869a2916de", "message": "Empty commit to retrigger CI.\n\nChange-Id: I9d3b5ce0b81d457344ecd6b4ad6e141169bd89d3", "committedDate": "2020-12-07T17:46:17Z", "type": "commit"}, {"oid": "63a89ab0567fcfb85294345d545287502d298f33", "url": "https://github.com/apache/ozone/commit/63a89ab0567fcfb85294345d545287502d298f33", "message": "Retrigger.\n\nChange-Id: I4e9dace08152e21c2bb5da564487d776a84c4ade", "committedDate": "2020-12-07T23:33:21Z", "type": "commit"}, {"oid": "c64f247c3f444075f8c102f26acc536454f9ab05", "url": "https://github.com/apache/ozone/commit/c64f247c3f444075f8c102f26acc536454f9ab05", "message": "Merge branch 'master' into HDDS-4404-v2\n\nChange-Id: Iea89129865df35ca54d85307bac49ede5da45ea7", "committedDate": "2020-12-08T04:24:43Z", "type": "commit"}, {"oid": "34283ca72b8f83c42caa5742dc6ec57b59f9ea30", "url": "https://github.com/apache/ozone/commit/34283ca72b8f83c42caa5742dc6ec57b59f9ea30", "message": "Allow null as input to StateContext#addReport() as this blocked UT TestStorageContainerManager#testBlockDeletionTransactions.\n\nChange-Id: I16c8bfcfbd619a23241ea6dda9b95265714984bb", "committedDate": "2020-12-09T17:47:49Z", "type": "commit"}, {"oid": "ab37c2257aa58e7512294f25ad1c26da45ff7c91", "url": "https://github.com/apache/ozone/commit/ab37c2257aa58e7512294f25ad1c26da45ff7c91", "message": "Retrigger CI\n\nChange-Id: I64203ebbaeebdb4c598bb8dad578579c82bf604b", "committedDate": "2020-12-10T19:24:36Z", "type": "commit"}, {"oid": "f0dca47620dd94cd96862462781749a35e7f2c18", "url": "https://github.com/apache/ozone/commit/f0dca47620dd94cd96862462781749a35e7f2c18", "message": "trigger new CI check", "committedDate": "2020-12-12T09:37:39Z", "type": "commit"}]}