{"pr_number": 654, "pr_title": "HDDS-3150. Implement getIfExist in Table and use it in CreateKey/File", "pr_createdAt": "2020-03-09T22:27:15Z", "pr_url": "https://github.com/apache/ozone/pull/654", "timeline": [{"oid": "aaf7488d0d456dac372701a31a91b18454d253c9", "url": "https://github.com/apache/ozone/commit/aaf7488d0d456dac372701a31a91b18454d253c9", "message": "getIfExist", "committedDate": "2020-03-09T22:34:57Z", "type": "commit"}, {"oid": "aaf7488d0d456dac372701a31a91b18454d253c9", "url": "https://github.com/apache/ozone/commit/aaf7488d0d456dac372701a31a91b18454d253c9", "message": "getIfExist", "committedDate": "2020-03-09T22:34:57Z", "type": "forcePushed"}, {"oid": "faa0c88371d544882ca7c23464fe8b18c4ac0020", "url": "https://github.com/apache/ozone/commit/faa0c88371d544882ca7c23464fe8b18c4ac0020", "message": "minor change", "committedDate": "2020-03-09T22:43:24Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDA2NjU3MQ==", "url": "https://github.com/apache/ozone/pull/654#discussion_r390066571", "bodyText": "whats the reason for the illegal arguement exception ? Do we have a stack trace?", "author": "mukul1987", "createdAt": "2020-03-10T02:46:31Z", "path": "hadoop-hdds/framework/src/main/java/org/apache/hadoop/hdds/utils/db/RDBTable.java", "diffHunk": "@@ -155,6 +155,32 @@ public boolean isExist(byte[] key) throws IOException {\n     }\n   }\n \n+  @Override\n+  public byte[] getIfExist(byte[] key) throws IOException {\n+    try {\n+      // RocksDB#keyMayExist\n+      // If the key definitely does not exist in the database, then this\n+      // method returns false, else true.\n+      rdbMetrics.incNumDBKeyGetIfExistChecks();\n+      StringBuilder outValue = new StringBuilder();\n+      boolean keyMayExist = db.keyMayExist(handle, key, outValue);\n+      if (keyMayExist) {\n+        // Not using out value from string builder, as that is causing\n+        // IllegalArgumentException during protobuf parsing.", "originalCommit": "faa0c88371d544882ca7c23464fe8b18c4ac0020", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDA4OTE1Mw==", "url": "https://github.com/apache/ozone/pull/654#discussion_r390089153", "bodyText": "Because value returned from StringBuilder then to a string, which is converted to bytes[] and then later if it is used in parseFrom byte[] data.\njava.lang.IllegalArgumentException: Can't encode the the raw data from the byte array\n\tat org.apache.hadoop.ozone.om.codec.OmKeyInfoCodec.fromPersistedFormat(OmKeyInfoCodec.java:48)\n\tat org.apache.hadoop.ozone.om.codec.OmKeyInfoCodec.fromPersistedFormat(OmKeyInfoCodec.java:31)\n\tat org.apache.hadoop.hdds.utils.db.CodecRegistry.asObject(CodecRegistry.java:55)\n\tat org.apache.hadoop.hdds.utils.db.TypedTable.getFromTableIfExist(TypedTable.java:207)\n\tat org.apache.hadoop.hdds.utils.db.TypedTable.getIfExist(TypedTable.java:194)\n\tat org.apache.hadoop.ozone.om.request.key.OMKeyCreateRequest.validateAndUpdateCache(OMKeyCreateRequest.java:196)\n\tat org.apache.hadoop.ozone.protocolPB.OzoneManagerRequestHandler.handleWriteRequest(OzoneManagerRequestHandler.java:230)\n\tat org.apache.hadoop.ozone.protocolPB.OzoneManagerProtocolServerSideTranslatorPB.submitRequestDirectlyToOM(OzoneManagerProtocolServerSideTranslatorPB.java:210)\n\tat org.apache.hadoop.ozone.protocolPB.OzoneManagerProtocolServerSideTranslatorPB.processRequest(OzoneManagerProtocolServerSideTranslatorPB.java:130)\n\tat org.apache.hadoop.hdds.server.OzoneProtocolMessageDispatcher.processRequest(OzoneProtocolMessageDispatcher.java:72)\n\tat org.apache.hadoop.ozone.protocolPB.OzoneManagerProtocolServerSideTranslatorPB.submitRequest(OzoneManagerProtocolServerSideTranslatorPB.java:98)\n\tat org.apache.hadoop.ozone.protocol.proto.OzoneManagerProtocolProtos$OzoneManagerService$2.callBlockingMethod(OzoneManagerProtocolProtos.java)\n\tat org.apache.hadoop.ipc.ProtobufRpcEngine$Server$ProtoBufRpcInvoker.call(ProtobufRpcEngine.java:524)\n\tat org.apache.hadoop.ipc.RPC$Server.call(RPC.java:1025)\n\tat org.apache.hadoop.ipc.Server$RpcCall.run(Server.java:876)\n\tat org.apache.hadoop.ipc.Server$RpcCall.run(Server.java:822)\n\tat java.security.AccessController.doPrivileged(Native Method)\n\tat javax.security.auth.Subject.doAs(Subject.java:422)", "author": "bharatviswa504", "createdAt": "2020-03-10T04:25:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDA2NjU3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDY2NDQ4Nw==", "url": "https://github.com/apache/ozone/pull/654#discussion_r390664487", "bodyText": "Does this mean we cannot use the outValue that we pass in? If 'keyMayExist' returns true, and the value is indeed present in the block cache, I believe the outValue will have the data.", "author": "avijayanhwx", "createdAt": "2020-03-10T23:15:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDA2NjU3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDY2OTg2MA==", "url": "https://github.com/apache/ozone/pull/654#discussion_r390669860", "bodyText": "Yes, using that is causing the issue.", "author": "bharatviswa504", "createdAt": "2020-03-10T23:31:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDA2NjU3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDY3MDY1MA==", "url": "https://github.com/apache/ozone/pull/654#discussion_r390670650", "bodyText": "@Override\npublic byte[] get(byte[] key) throws IOException {\n  try {\n    // RocksDB#keyMayExist\n    // If the key definitely does not exist in the database, then this\n    // method returns false, else true.\n    rdbMetrics.incNumDBKeyIfExistChecks();\n    StringBuilder outValue = new StringBuilder();\n    boolean keyMayExist = db.keyMayExist(handle, key, outValue);\n    if (keyMayExist) {\n      byte[] val;\n      if (outValue.length() > 0) {\n        val = outValue.toString().getBytes(UTF_8);\n      } else {\n        val = db.get(handle, key);\n      }\n      if (val != null) {\n        rdbMetrics.incNumDBKeyIfExistMisses();\n      }\n      return val;\n    }\n    return null;\n  } catch (RocksDBException e) {\n    throw toIOException(\n        \"Error in accessing DB. \", e);\n  }\n}\n\nI tried with the above code, getting IllegalException during parsing. So, for now, removed not to use outVal.", "author": "bharatviswa504", "createdAt": "2020-03-10T23:34:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDA2NjU3MQ=="}], "type": "inlineReview"}, {"oid": "1ca75ae770643d3b5a24b2c6e5dc6b6411f2fef1", "url": "https://github.com/apache/ozone/commit/1ca75ae770643d3b5a24b2c6e5dc6b6411f2fef1", "message": "make key commit also use getIfExist", "committedDate": "2020-03-10T04:40:22Z", "type": "commit"}]}