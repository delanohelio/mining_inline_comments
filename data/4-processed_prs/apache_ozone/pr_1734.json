{"pr_number": 1734, "pr_title": "HDDS-4621. Set, add and remove ACL have no audit logs", "pr_createdAt": "2020-12-24T09:19:17Z", "pr_url": "https://github.com/apache/ozone/pull/1734", "timeline": [{"oid": "0a6a984d5e92dad08993dcd1fd4a19ca498fd5d3", "url": "https://github.com/apache/ozone/commit/0a6a984d5e92dad08993dcd1fd4a19ca498fd5d3", "message": "HDDS-4621. Set, add and remove ACL have no audit logs", "committedDate": "2020-12-24T09:16:42Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTY0NzkyMg==", "url": "https://github.com/apache/ozone/pull/1734#discussion_r551647922", "bodyText": "NIT: this can be put into the constructor with a member variable so that the protobuf conversion is done only once and the getter() simply return the member variable. Same apply to other places.", "author": "xiaoyuyao", "createdAt": "2021-01-05T00:26:58Z", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/volume/acl/OMVolumeSetAclRequest.java", "diffHunk": "@@ -88,6 +92,12 @@ public String getVolumeName() {\n     return volumeName;\n   }\n \n+  @Override\n+  OzoneObjInfo getObjectInfo() {\n+    return OzoneObjInfo.fromProtobuf(\n+        getOmRequest().getSetAclRequest().getObj());", "originalCommit": "0a6a984d5e92dad08993dcd1fd4a19ca498fd5d3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzA5NTI2NA==", "url": "https://github.com/apache/ozone/pull/1734#discussion_r553095264", "bodyText": "fixed.", "author": "ChenSammi", "createdAt": "2021-01-07T03:55:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTY0NzkyMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTc4OTU1Nw==", "url": "https://github.com/apache/ozone/pull/1734#discussion_r551789557", "bodyText": "buildAuditMessage determines success/failure based on whether exception is null.  But here we can also have failure without exception, indicated by operationResult = false.  I think audit log should indicate failure in this case.\n\n  \n    \n      ozone/hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/bucket/acl/OMBucketAddAclRequest.java\n    \n    \n        Lines 124 to 126\n      in\n      c3f6b4b\n    \n    \n    \n    \n\n        \n          \n           if (exception == null) { \n        \n\n        \n          \n             LOG.error(\"Add acl {} to path {} failed, because acl already exist\", \n        \n\n        \n          \n                 getAcls(), getPath());", "author": "adoroszlai", "createdAt": "2021-01-05T08:43:41Z", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/bucket/acl/OMBucketAddAclRequest.java", "diffHunk": "@@ -116,7 +126,11 @@ OMClientResponse onFailure(OMResponse.Builder omResponse,\n \n   @Override\n   void onComplete(boolean operationResult, IOException exception,\n-      OMMetrics omMetrics) {\n+      OMMetrics omMetrics, AuditLogger auditLogger,\n+      Map<String, String> auditMap) {\n+    auditLog(auditLogger, buildAuditMessage(OMAction.ADD_ACL, auditMap,\n+        exception, getOmRequest().getUserInfo()));", "originalCommit": "0a6a984d5e92dad08993dcd1fd4a19ca498fd5d3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzEzMDY0OA==", "url": "https://github.com/apache/ozone/pull/1734#discussion_r553130648", "bodyText": "@adoroszlai , thanks for the review and feedback.  Basically, I think  ACL error handling with both Result and Exception is complex.  I fired HDDS-4650m,  ACL related error handling refactor, to cleanly resolve this issue.", "author": "ChenSammi", "createdAt": "2021-01-07T06:20:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTc4OTU1Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTEyNzkyMA==", "url": "https://github.com/apache/ozone/pull/1734#discussion_r555127920", "bodyText": "@ChenSammi Thank you for working on this. To address this situation, how about this idea:\n\nLet's not call the auditlog() in the first line of the current method.\nWe can do something like this:\n    if (operationResult) { LOG.debug(\"Add acl: {} to path: {} success!\", getAcls(), getPath()); } else { omMetrics.incNumBucketUpdateFails(); if (exception == null) { LOG.error(\"Add acl {} to path {} failed, because acl already exist\", getAcls(), getPath()); } else { LOG.error(\"Add acl {} to path {} failed!\", getAcls(), getPath(), exception); exception = null; // } } auditLog(auditLogger, buildAuditMessage(OMAction.ADD_ACL, auditMap, exception, getOmRequest().getUserInfo()));   }\n\nThis will ensure this covers the edge case mentioned by @adoroszlai and we won't have to modify the Audit Log base framework since this scenario is for a very limited number of occurrence in auditing ACL ops only.\nWhat do you think?", "author": "dineshchitlangia", "createdAt": "2021-01-11T15:30:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTc4OTU1Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTEyOTUxNw==", "url": "https://github.com/apache/ozone/pull/1734#discussion_r555129517", "bodyText": "Sorry for bad formatting, github on Phone is funny :)\nBasically, I am suggesting we update exception=null in the else block after you have logged log.error().\nThen call the auditlog() at the end of the method.", "author": "dineshchitlangia", "createdAt": "2021-01-11T15:32:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTc4OTU1Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTE3MzE4Nw==", "url": "https://github.com/apache/ozone/pull/1734#discussion_r555173187", "bodyText": "@dineshchitlangia wouldn't exception=null have the effect of always logging SUCCESS in audit?", "author": "adoroszlai", "createdAt": "2021-01-11T16:23:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTc4OTU1Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTE3ODUxMw==", "url": "https://github.com/apache/ozone/pull/1734#discussion_r555178513", "bodyText": "Yikes, I intended to say that we set a not null value to exception and accordingly achieve it. Once I get to my laptop I will update here with proper suggestion. Thanks for catching it.", "author": "dineshchitlangia", "createdAt": "2021-01-11T16:31:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTc4OTU1Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTIxMTc0NA==", "url": "https://github.com/apache/ozone/pull/1734#discussion_r555211744", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                auditLog(auditLogger, buildAuditMessage(OMAction.ADD_ACL, auditMap,\n          \n          \n            \n                    exception, getOmRequest().getUserInfo()));\n          \n          \n            \n                if (operationResult) {\n          \n          \n            \n                  LOG.debug(\"Add acl: {} to path: {} success!\", getAcls(), getPath());\n          \n          \n            \n                } else {\n          \n          \n            \n                  omMetrics.incNumBucketUpdateFails();\n          \n          \n            \n                  if (exception == null) {\n          \n          \n            \n                    LOG.error(\"Add acl {} to path {} failed, because acl already exist\",\n          \n          \n            \n                        getAcls(), getPath());\n          \n          \n            \n                    exception = new ACLAlreadyExistsException(); //we can create this new type of exception\n          \n          \n            \n                  } else {\n          \n          \n            \n                    LOG.error(\"Add acl {} to path {} failed!\", getAcls(), getPath(),\n          \n          \n            \n                        exception);\n          \n          \n            \n                  }\n          \n          \n            \n                }\n          \n          \n            \n                }\n          \n          \n            \n                auditLog(auditLogger, buildAuditMessage(OMAction.ADD_ACL, auditMap,\n          \n          \n            \n                    exception, getOmRequest().getUserInfo()));\n          \n          \n            \n              }", "author": "dineshchitlangia", "createdAt": "2021-01-11T17:19:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTc4OTU1Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTY2MjM5MQ==", "url": "https://github.com/apache/ozone/pull/1734#discussion_r555662391", "bodyText": "Hi @dineshchitlangia, I have the same idea to throw the ACLAlreadyExistsException exception when add an acl and ACL does not exist exception when remove an acl.   I plan to put the logic in ozoneAclUtil.java so that we don't need to do the exception == null check in every ACL related request.\nAnd currently,  there are OzoneAclUtils.java which used by bucket, key and prefix ACL operation,  and OmOzoneAclMap.java which used by volume. I'd like to unify them and do some refactor which will be quite a big patch.   So leave it in HDDS-4650.", "author": "ChenSammi", "createdAt": "2021-01-12T10:21:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTc4OTU1Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTc3Mzg2MQ==", "url": "https://github.com/apache/ozone/pull/1734#discussion_r555773861", "bodyText": "Sound good to me. +1", "author": "dineshchitlangia", "createdAt": "2021-01-12T13:36:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTc4OTU1Nw=="}], "type": "inlineReview"}, {"oid": "2312d0a0183ed381efc0a54c8a8385f69fbdf9ac", "url": "https://github.com/apache/ozone/commit/2312d0a0183ed381efc0a54c8a8385f69fbdf9ac", "message": "address comments", "committedDate": "2021-01-07T03:54:35Z", "type": "commit"}, {"oid": "b48c942e501a7576d19527ac011619d03078a326", "url": "https://github.com/apache/ozone/commit/b48c942e501a7576d19527ac011619d03078a326", "message": "remove unused imports", "committedDate": "2021-01-07T06:08:26Z", "type": "commit"}]}