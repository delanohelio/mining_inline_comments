{"pr_number": 1672, "pr_title": "HDDS-4558. Support Ozone block token with access mode check.", "pr_createdAt": "2020-12-07T21:00:08Z", "pr_url": "https://github.com/apache/ozone/pull/1672", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTMyMzE5MQ==", "url": "https://github.com/apache/ozone/pull/1672#discussion_r539323191", "bodyText": "NIT: may be safer to throw an exception from a third, generic  }else {. Today there is no other option but if somebody implements a new message type, it will be forced to add condition for the new message.", "author": "elek", "createdAt": "2020-12-09T13:52:54Z", "path": "hadoop-hdds/framework/src/main/java/org/apache/hadoop/hdds/security/token/BlockTokenVerifier.java", "diffHunk": "@@ -118,7 +125,19 @@ public void verify(String user, String tokenStr,\n           \" by user: \" + tokenUser);\n     }\n \n-    // TODO: check cmd type and the permissions(AccessMode) in the token\n+    if (cmd == ReadChunk || cmd == GetBlock || cmd == GetSmallFile) {\n+      if (!tokenId.getAccessModes().contains(\n+          HddsProtos.BlockTokenSecretProto.AccessModeProto.READ)) {\n+        throw new BlockTokenException(\"Block token with \" + id\n+            + \" doesn't have READ permission\");\n+      }\n+    } else if (cmd == WriteChunk || cmd == PutBlock || cmd == PutSmallFile) {\n+      if (!tokenId.getAccessModes().contains(\n+          HddsProtos.BlockTokenSecretProto.AccessModeProto.WRITE)) {\n+        throw new BlockTokenException(\"Block token with \" + id\n+            + \" doesn't have WRITE permission\");\n+      }\n+    }", "originalCommit": "13486412b1d032fffa11508acdb3a11da92ec252", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTU2NTI4Ng==", "url": "https://github.com/apache/ozone/pull/1672#discussion_r539565286", "bodyText": "good point. Even though the check block token was not currently done for other cmd, the third else will ensure proper handling is added if this is changed in future.", "author": "xiaoyuyao", "createdAt": "2020-12-09T18:57:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTMyMzE5MQ=="}], "type": "inlineReview"}, {"oid": "8f5282db662ffdd327a584fed1ce81e8724f7d96", "url": "https://github.com/apache/ozone/commit/8f5282db662ffdd327a584fed1ce81e8724f7d96", "message": "address code review feedback", "committedDate": "2020-12-14T23:13:38Z", "type": "forcePushed"}, {"oid": "c36e3e39bdab659f8f6df58fd1a8aefa136423c9", "url": "https://github.com/apache/ozone/commit/c36e3e39bdab659f8f6df58fd1a8aefa136423c9", "message": "HDDS-4558. Support Ozone block token with access mode check.", "committedDate": "2020-12-15T17:24:04Z", "type": "commit"}, {"oid": "570246ade7b4a260aa714444e0fa577927253446", "url": "https://github.com/apache/ozone/commit/570246ade7b4a260aa714444e0fa577927253446", "message": "add block token for file read via hcfs", "committedDate": "2020-12-15T17:24:04Z", "type": "commit"}, {"oid": "b8e0d223ef5a958f0acdb29c56b9d0e568f5e04b", "url": "https://github.com/apache/ozone/commit/b8e0d223ef5a958f0acdb29c56b9d0e568f5e04b", "message": "improve the debug log for block token", "committedDate": "2020-12-15T17:24:04Z", "type": "commit"}, {"oid": "b93b5cff64f0c0212ecc772275acd70351f6b113", "url": "https://github.com/apache/ozone/commit/b93b5cff64f0c0212ecc772275acd70351f6b113", "message": "address code review feedback", "committedDate": "2020-12-15T17:24:10Z", "type": "commit"}, {"oid": "b93b5cff64f0c0212ecc772275acd70351f6b113", "url": "https://github.com/apache/ozone/commit/b93b5cff64f0c0212ecc772275acd70351f6b113", "message": "address code review feedback", "committedDate": "2020-12-15T17:24:10Z", "type": "forcePushed"}]}