{"pr_number": 1338, "pr_title": "HDDS-4023. Delete closed container after all blocks have been deleted.", "pr_createdAt": "2020-08-19T11:11:04Z", "pr_url": "https://github.com/apache/ozone/pull/1338", "timeline": [{"oid": "266b92bfc45fe5900e418770f9f4209c7e0c7103", "url": "https://github.com/apache/ozone/commit/266b92bfc45fe5900e418770f9f4209c7e0c7103", "message": "HDDS-4023. Delete closed container after all blocks have been deleted.", "committedDate": "2020-09-03T06:59:09Z", "type": "forcePushed"}, {"oid": "1f165c2a9c50062443532da62ba5f5087fc5aa41", "url": "https://github.com/apache/ozone/commit/1f165c2a9c50062443532da62ba5f5087fc5aa41", "message": "HDDS-4023. Delete closed container after all blocks have been deleted.", "committedDate": "2020-09-04T03:05:45Z", "type": "commit"}, {"oid": "1f165c2a9c50062443532da62ba5f5087fc5aa41", "url": "https://github.com/apache/ozone/commit/1f165c2a9c50062443532da62ba5f5087fc5aa41", "message": "HDDS-4023. Delete closed container after all blocks have been deleted.", "committedDate": "2020-09-04T03:05:45Z", "type": "forcePushed"}, {"oid": "6d0a84ac99268da273aed3be6ded6c76bc84cdbc", "url": "https://github.com/apache/ozone/commit/6d0a84ac99268da273aed3be6ded6c76bc84cdbc", "message": "checkstyle", "committedDate": "2020-09-04T10:23:59Z", "type": "commit"}, {"oid": "897a4b96013d06778187731d0f320db0581d5598", "url": "https://github.com/apache/ozone/commit/897a4b96013d06778187731d0f320db0581d5598", "message": "fix UT", "committedDate": "2020-09-08T08:24:47Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDgwODcxNw==", "url": "https://github.com/apache/ozone/pull/1338#discussion_r484808717", "bodyText": "Should we add another check here:\nif (state == LifeCycleState.DELETED) {\n  return\n}\n\nThis will avoid doing any further processing on a container which is expected to have zero replicas?", "author": "sodonnel", "createdAt": "2020-09-08T10:16:46Z", "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/container/ReplicationManager.java", "diffHunk": "@@ -312,6 +313,16 @@ private void processContainer(ContainerID id) {\n           action -> replicas.stream()\n               .noneMatch(r -> r.getDatanodeDetails().equals(action.datanode)));\n \n+      /*\n+       * If container is under deleting and all it's replicas are deleted, then\n+       * make the container as CLEANED, or resend the delete replica command if\n+       * needed.\n+       */\n+      if (state == LifeCycleState.DELETING) {\n+        handleContainerUnderDelete(container, replicas);\n+        return;\n+      }\n+", "originalCommit": "897a4b96013d06778187731d0f320db0581d5598", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "9f4c6258e65c62f76b8075cc2272eb37d090abc8", "url": "https://github.com/apache/ozone/commit/9f4c6258e65c62f76b8075cc2272eb37d090abc8", "message": "address comments", "committedDate": "2020-09-17T09:56:52Z", "type": "commit"}, {"oid": "d434ed409edc48816d9a647ff6c7a8f8c06384fd", "url": "https://github.com/apache/ozone/commit/d434ed409edc48816d9a647ff6c7a8f8c06384fd", "message": "fix UT", "committedDate": "2020-09-18T08:48:52Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDE4MDc3Mg==", "url": "https://github.com/apache/ozone/pull/1338#discussion_r494180772", "bodyText": "It doesn't seem correct to put the logic to delete the replica for the DELETED container inside updateContainerStats.\nIn ContainerReportHandler#processContainerReplicas(..) there is logic to delete an unknown container in the exception handler.\nCould we extract this into a new method, which is called from the exception handler. Then in AbstractContainerReportHandler#updateContainerState(...) handle the containers which should be deleted in the \"case DELETED\" branch of the swith statement. It could call that same extracted method - that way the logic to form the DeleteContainer command will be the same for both? It also seems more logical to put the delete inside UpdateContainerState rather than UpdateContainerStats.", "author": "sodonnel", "createdAt": "2020-09-24T09:44:21Z", "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/container/AbstractContainerReportHandler.java", "diffHunk": "@@ -96,13 +101,24 @@ protected void processContainerReplica(final DatanodeDetails datanodeDetails,\n    */\n   private void updateContainerStats(final DatanodeDetails datanodeDetails,\n                                     final ContainerID containerId,\n-                                    final ContainerReplicaProto replicaProto)\n+                                    final ContainerReplicaProto replicaProto,\n+                                    final EventPublisher publisher)\n       throws ContainerNotFoundException {\n+    final ContainerInfo containerInfo = containerManager\n+        .getContainer(containerId);\n \n-    if (isHealthy(replicaProto::getState)) {\n-      final ContainerInfo containerInfo = containerManager\n-          .getContainer(containerId);\n+    if (containerInfo.getState() == HddsProtos.LifeCycleState.DELETED) {", "originalCommit": "d434ed409edc48816d9a647ff6c7a8f8c06384fd", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "fb9afc94a6f4957fef83ce9abb9c5e3aa6180e53", "url": "https://github.com/apache/ozone/commit/fb9afc94a6f4957fef83ce9abb9c5e3aa6180e53", "message": "address review comments", "committedDate": "2020-09-25T12:26:28Z", "type": "commit"}, {"oid": "cd93423b03095ae95e8fa2b9f5410adb93b310e1", "url": "https://github.com/apache/ozone/commit/cd93423b03095ae95e8fa2b9f5410adb93b310e1", "message": "fix checkstyle", "committedDate": "2020-09-27T02:27:26Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjU0NDY5Ng==", "url": "https://github.com/apache/ozone/pull/1338#discussion_r496544696", "bodyText": "@ChenSammi , Is there any specific reason that we let ReplicationManager to help clean empty containers?  After this, ReplicaManager will do additionally container empty check for all healthy containers. Not sure if this is an efficiency way to put logic here.\n\nI wonder if it would be simpler to remove empty containers as part of Container Report processing? In AbstractContainerReportHandler#updateContainerState, we could check the size and number of keys of the reported containers in the CLOSED branch of the switch statement, and then take action to delete an empty container there? I have a feeling it might be simpler, but I am not sure. The disadvantage of doing it in the Container Report Processing, is that we are dealing with only a single replica at that stage. However if the container is CLOSED in SCM, and a report says it is empty then we should be good to simply remove the container from SCM and issue the delete container command when processing the container report.\n\nActually I prefer this way as @sodonnel mentioned.\n\nbut I am not sure. The disadvantage of doing it in the Container Report Processing, is that we are dealing with only a single replica at that stage\n\nWe could also get all replica info and check state in ContainerReportHandler, then send delete container command\nI'm okay for current way but just share my thought for this.", "author": "linyiqun", "createdAt": "2020-09-29T08:45:15Z", "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/container/ReplicationManager.java", "diffHunk": "@@ -320,6 +331,12 @@ private void processContainer(ContainerID id) {\n        * exact number of replicas in the same state.\n        */\n       if (isContainerHealthy(container, replicas)) {\n+        /*\n+         *  If container is empty, schedule task to delete the container.\n+         */\n+        if (isContainerEmpty(container, replicas)) {\n+          deleteContainerReplicas(container, replicas);\n+        }", "originalCommit": "cd93423b03095ae95e8fa2b9f5410adb93b310e1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}