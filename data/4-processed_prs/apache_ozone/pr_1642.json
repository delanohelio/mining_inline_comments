{"pr_number": 1642, "pr_title": "HDDS-4519. Return forbidden instead of interval server error from s3g\u2026", "pr_createdAt": "2020-12-01T08:52:27Z", "pr_url": "https://github.com/apache/ozone/pull/1642", "timeline": [{"oid": "bba1a8479323982829e101828430d968316d5801", "url": "https://github.com/apache/ozone/commit/bba1a8479323982829e101828430d968316d5801", "message": "HDDS-4519. Return forbidden instead of interval server error from s3g when user doesn't have the resouce permission.", "committedDate": "2020-12-01T08:46:31Z", "type": "commit"}, {"oid": "748aab07b64d917237ebec8c912df054508d34db", "url": "https://github.com/apache/ozone/commit/748aab07b64d917237ebec8c912df054508d34db", "message": "Fix checkstyle; Add more test cases", "committedDate": "2020-12-03T12:28:19Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTg0MzA2OA==", "url": "https://github.com/apache/ozone/pull/1642#discussion_r535843068", "bodyText": "Any specific reason for throwing RuntimeException here?", "author": "bharatviswa504", "createdAt": "2020-12-04T05:19:27Z", "path": "hadoop-ozone/client/src/main/java/org/apache/hadoop/ozone/client/OzoneBucket.java", "diffHunk": "@@ -780,7 +780,12 @@ public OzoneMultipartUploadList listMultipartUploads(String prefix)\n     @Override\n     public boolean hasNext() {\n       if(!currentIterator.hasNext() && currentValue != null) {\n-        currentIterator = getNextListOfKeys(currentValue.getName()).iterator();\n+        try {\n+          currentIterator =\n+              getNextListOfKeys(currentValue.getName()).iterator();\n+        } catch (IOException e) {\n+          throw new RuntimeException(e);", "originalCommit": "748aab07b64d917237ebec8c912df054508d34db", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTg0NDQ2MA==", "url": "https://github.com/apache/ozone/pull/1642#discussion_r535844460", "bodyText": "I see the current code is doing the same. Do you think we need to change here to handle error? (Not related to this PR BTW). I see the reason as hasNext() does not throw any exception.", "author": "bharatviswa504", "createdAt": "2020-12-04T05:23:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTg0MzA2OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTg1NDY2Nw==", "url": "https://github.com/apache/ozone/pull/1642#discussion_r535854667", "bodyText": "Do we think, we want to change it to AccessDenied, to be closer to S3\nhttps://docs.aws.amazon.com/AmazonS3/latest/API/ErrorResponses.html#RESTErrorResponses\nAccessDenied 403\nhttps://aws.amazon.com/premiumsupport/knowledge-center/s3-troubleshoot-403/ Even though we don't have S3 Acls, Ozone Acls causing this, but to be close to S3 I think error code having same might be better here IMHO.", "author": "bharatviswa504", "createdAt": "2020-12-04T05:55:30Z", "path": "hadoop-ozone/s3gateway/src/main/java/org/apache/hadoop/ozone/s3/exception/S3ErrorTable.java", "diffHunk": "@@ -105,6 +106,9 @@ private S3ErrorTable() {\n       \"InternalError\", \"We encountered an internal error. Please try again.\",\n       HTTP_SERVER_ERROR);\n \n+  public static final OS3Exception PERMISSION_DENIED = new OS3Exception(", "originalCommit": "748aab07b64d917237ebec8c912df054508d34db", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjgwNDcyMg==", "url": "https://github.com/apache/ozone/pull/1642#discussion_r536804722", "bodyText": "+1 for return 403", "author": "xiaoyuyao", "createdAt": "2020-12-05T15:02:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTg1NDY2Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTgwMTAyNA==", "url": "https://github.com/apache/ozone/pull/1642#discussion_r539801024", "bodyText": "Good catch, I will change the description to \"AccessDenied\".\nAlthough where are multiple Error Codes map to  \"HTTP 403 Forbidden\" ,  \"AccessDenied\" is the most appropriate description for this ACL case.\nhttps://docs.aws.amazon.com/AmazonS3/latest/API/ErrorResponses.html#RESTErrorResponses", "author": "ChenSammi", "createdAt": "2020-12-10T02:40:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTg1NDY2Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjgwNDg3Mw==", "url": "https://github.com/apache/ozone/pull/1642#discussion_r536804873", "bodyText": "Is it possible to have a common helper that does the OM result code => s3 error translation?", "author": "xiaoyuyao", "createdAt": "2020-12-05T15:02:50Z", "path": "hadoop-ozone/s3gateway/src/main/java/org/apache/hadoop/ozone/s3/endpoint/ObjectEndpoint.java", "diffHunk": "@@ -619,6 +631,9 @@ private Response createMultipartKey(String bucket, String key, long length,\n       if (ex.getResult() == ResultCodes.NO_SUCH_MULTIPART_UPLOAD_ERROR) {\n         throw S3ErrorTable.newError(NO_SUCH_UPLOAD,\n             uploadID);\n+      } else if (ex.getResult() == ResultCodes.PERMISSION_DENIED) {", "originalCommit": "748aab07b64d917237ebec8c912df054508d34db", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTgwODczNQ==", "url": "https://github.com/apache/ozone/pull/1642#discussion_r539808735", "bodyText": "In long term\uff0cit's good to have such a mapping table.\nBut there are many details need further discussion, for example, a error response has HTTP error code and s3 error code.  Multiple s3 error codse will map to the same HTTP error code.\nSome OM result codes, like QUOTA_EXCEEDED, I quickly go through all HTTP codes, didn't find a perfect match code.\nOther OM result codes, such as NOT_SUPPORTED_OPERATION, is just translated to \"interval error\" in s3g.", "author": "ChenSammi", "createdAt": "2020-12-10T03:02:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjgwNDg3Mw=="}], "type": "inlineReview"}, {"oid": "d4cd1f88a245a25643827628dd23f70298280fb5", "url": "https://github.com/apache/ozone/commit/d4cd1f88a245a25643827628dd23f70298280fb5", "message": "address comments", "committedDate": "2020-12-10T03:48:50Z", "type": "commit"}]}