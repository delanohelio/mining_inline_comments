{"pr_number": 1494, "pr_title": "HDDS-4330. Bootstrap new OM node", "pr_createdAt": "2020-10-13T19:21:29Z", "pr_url": "https://github.com/apache/ozone/pull/1494", "timeline": [{"oid": "c44fba2cf4b6287dff743268335ac17c38db5d45", "url": "https://github.com/apache/ozone/commit/c44fba2cf4b6287dff743268335ac17c38db5d45", "message": "unit tests", "committedDate": "2020-11-20T22:52:25Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTQ2OTk0Ng==", "url": "https://github.com/apache/ozone/pull/1494#discussion_r541469946", "bodyText": "General question why are specializing IllegalArgumentException if no other state/behavior added to it :)", "author": "swagle", "createdAt": "2020-12-12T01:36:18Z", "path": "hadoop-ozone/common/src/main/java/org/apache/hadoop/ozone/OzoneIllegalArgumentException.java", "diffHunk": "@@ -37,4 +37,8 @@\n   public OzoneIllegalArgumentException(final String message) {", "originalCommit": "c44fba2cf4b6287dff743268335ac17c38db5d45", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDc0MjY3Nw==", "url": "https://github.com/apache/ozone/pull/1494#discussion_r544742677", "bodyText": "Good point. Removed this from current patch.", "author": "hanishakoneru", "createdAt": "2020-12-17T01:26:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTQ2OTk0Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTQ3MjU2OA==", "url": "https://github.com/apache/ozone/pull/1494#discussion_r541472568", "bodyText": "Why is the number of newOMs an argument? I was expecting this to read based on the new HA configuration", "author": "swagle", "createdAt": "2020-12-12T01:49:14Z", "path": "hadoop-ozone/integration-test/src/test/java/org/apache/hadoop/ozone/MiniOzoneHAClusterImpl.java", "diffHunk": "@@ -442,7 +457,169 @@ private void initHAConfig(int basePort) throws IOException {\n         conf.setInt(omRatisPortKey, port + 4);\n       }\n \n-      conf.set(omNodesKey, omNodesKeyValue.substring(1));\n+      conf.set(omNodesKey, String.join(\",\", omNodeIds));\n+    }\n+  }\n+\n+  /**\n+   * Bootstrap new OMs and add them to existing OM ring.\n+   * @param numNewOMs number of new OMs to bootstrap\n+   * @return list of new OMs nodeIds\n+   */\n+  public List<String> bootstrapOzoneManagers(int numNewOMs) throws IOException,", "originalCommit": "c44fba2cf4b6287dff743268335ac17c38db5d45", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDQ5NTYwMA==", "url": "https://github.com/apache/ozone/pull/1494#discussion_r544495600", "bodyText": "Giving numNewOMs as parameter to test different scenarios - adding OMs one by one and adding two OMs together. This is the function which generates the new HA configuration for the new nodes.", "author": "hanishakoneru", "createdAt": "2020-12-16T17:42:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTQ3MjU2OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzA1MDIzNw==", "url": "https://github.com/apache/ozone/pull/1494#discussion_r543050237", "bodyText": "nit: old log4j habit, we should not need this check as parameters are evaluated only if debug is enabled with this format. same is true for line 384", "author": "fapifta", "createdAt": "2020-12-15T05:07:49Z", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/ratis/OzoneManagerRatisServer.java", "diffHunk": "@@ -137,6 +141,59 @@ public OMResponse submitRequest(OMRequest omRequest) throws ServiceException {\n     return processReply(omRequest, raftClientReply);\n   }\n \n+  /**\n+   * Add a new OM to the Ratis ring.\n+   * @return true if the new OM is successfully added to the ratis ring,\n+   * false otherwise.\n+   */\n+  public boolean bootstrapNewOMs(List<OMNodeDetails> newOMNodes) {\n+    StringBuilder newOMNodeIdsBuilder = new StringBuilder();\n+    newOMNodes.stream().forEach(newOMNode ->\n+        newOMNodeIdsBuilder.append(\", \").append(newOMNode.getOMNodeId()));\n+    String newOMNodeIds = newOMNodeIdsBuilder.toString().substring(2);\n+    LOG.info(\"Bootstrapping new OM(s): {}\", newOMNodeIds);\n+\n+    List<RaftPeer> newRaftPeerList = new ArrayList<>();\n+    newRaftPeerList.addAll(raftPeers);\n+\n+    for (OMNodeDetails newOMNode : newOMNodes) {\n+      String newOMNodeId = newOMNode.getOMNodeId();\n+      RaftPeerId newOMRaftPeerId = RaftPeerId.valueOf(newOMNodeId);\n+      InetSocketAddress newOMRatisAddr = new InetSocketAddress(\n+          newOMNode.getHostName(), newOMNode.getRatisPort());\n+\n+      newRaftPeerList.add(RaftPeer.newBuilder()\n+          .setId(newOMRaftPeerId)\n+          .setAddress(newOMRatisAddr)\n+          .build());\n+    }\n+\n+    if (LOG.isDebugEnabled()) {", "originalCommit": "c44fba2cf4b6287dff743268335ac17c38db5d45", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDc0MjcyNg==", "url": "https://github.com/apache/ozone/pull/1494#discussion_r544742726", "bodyText": "Done", "author": "hanishakoneru", "createdAt": "2020-12-17T01:26:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzA1MDIzNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzA1MDI5Ng==", "url": "https://github.com/apache/ozone/pull/1494#discussion_r543050296", "bodyText": "nit: again old log4j habit", "author": "fapifta", "createdAt": "2020-12-15T05:08:03Z", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/ratis/OzoneManagerStateMachine.java", "diffHunk": "@@ -164,6 +167,27 @@ public void notifyTermIndexUpdated(long currentTerm, long index) {\n     computeAndUpdateLastAppliedIndex(index, currentTerm, null, false);\n   }\n \n+  /**\n+   * Called from Ratis to notify state machine about configuration changes.\n+   */\n+  @Override\n+  public void notifyConfigurationChanged(long term, long index,\n+      RaftConfigurationProto newRaftConfiguration) {\n+    List<RaftPeerProto> newPeers = newRaftConfiguration.getPeersList();\n+    LOG.info(\"Received Configuration change notification from Ratis. New Peer\" +\n+        \" list:\\n{}\", newPeers);\n+    for (RaftProtos.RaftPeerProto raftPeerProto : newPeers) {\n+      String omNodeId = RaftPeerId.valueOf(raftPeerProto.getId()).toString();\n+      if (!ozoneManager.doesPeerExist(omNodeId)) {\n+        LOG.info(\"Adding new OM {} to the cluster.\", omNodeId);\n+        ozoneManager.addNewOMNode(omNodeId);\n+      } else if(LOG.isDebugEnabled()) {", "originalCommit": "c44fba2cf4b6287dff743268335ac17c38db5d45", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDc0Mjc4Mw==", "url": "https://github.com/apache/ozone/pull/1494#discussion_r544742783", "bodyText": "Done", "author": "hanishakoneru", "createdAt": "2020-12-17T01:27:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzA1MDI5Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzYwMjY1MA==", "url": "https://github.com/apache/ozone/pull/1494#discussion_r543602650", "bodyText": "Minor: Add javadoc", "author": "bharatviswa504", "createdAt": "2020-12-15T18:55:16Z", "path": "hadoop-ozone/common/src/main/java/org/apache/hadoop/ozone/om/protocolPB/OmTransport.java", "diffHunk": "@@ -33,6 +35,9 @@\n    */\n   OMResponse submitRequest(OMRequest payload) throws IOException;\n \n+  BootstrapResponse bootstrapRequest(BootstrapRequest bootstrapRequest)", "originalCommit": "c44fba2cf4b6287dff743268335ac17c38db5d45", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDc0MjgzOA==", "url": "https://github.com/apache/ozone/pull/1494#discussion_r544742838", "bodyText": "Done", "author": "hanishakoneru", "createdAt": "2020-12-17T01:27:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzYwMjY1MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzYwNTI0OA==", "url": "https://github.com/apache/ozone/pull/1494#discussion_r543605248", "bodyText": "In Hadoop3OMTransport, we have done some additional steps which are missing here.\n(And also right now Hadoop27OMTransport does not support OM HA, not related to this, is that is the reason for not adding here, as failOverproxy is not configured in Hadoop2 module?)", "author": "bharatviswa504", "createdAt": "2020-12-15T18:59:07Z", "path": "hadoop-ozone/ozonefs-hadoop2/src/main/java/org/apache/hadoop/fs/ozone/Hadoop27RpcTransport.java", "diffHunk": "@@ -71,6 +73,16 @@ public OMResponse submitRequest(OMRequest payload) throws IOException {\n     }\n   }\n \n+  @Override\n+  public BootstrapResponse bootstrapRequest(BootstrapRequest bootstrapRequest)\n+      throws IOException {\n+    try {\n+      return proxy.bootstrap(NULL_RPC_CONTROLLER, bootstrapRequest);\n+    } catch (ServiceException e) {\n+      throw new IOException(\"Service exception during the bootstrap\", e);", "originalCommit": "c44fba2cf4b6287dff743268335ac17c38db5d45", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDc0MzE1Ng==", "url": "https://github.com/apache/ozone/pull/1494#discussion_r544743156", "bodyText": "Yes, Hadoop27OMTransport does not support it. Replicated the behavior as is in submitRequest.", "author": "hanishakoneru", "createdAt": "2020-12-17T01:28:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzYwNTI0OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzYxMTM0MQ==", "url": "https://github.com/apache/ozone/pull/1494#discussion_r543611341", "bodyText": "We are directly using proto classes, can we have helper classes like how we have done for all other requests.", "author": "bharatviswa504", "createdAt": "2020-12-15T19:05:58Z", "path": "hadoop-ozone/common/src/main/java/org/apache/hadoop/ozone/om/protocolPB/OzoneManagerProtocolClientSideTranslatorPB.java", "diffHunk": "@@ -192,6 +195,51 @@ public void close() throws IOException {\n     transport.close();\n   }\n \n+\n+  public List<ServiceInfo> getServiceList() throws IOException {\n+    ServiceListRequest req = ServiceListRequest.newBuilder().build();\n+\n+    OMRequest omRequest = createOMRequest(Type.ServiceList)\n+        .setServiceListRequest(req)\n+        .build();\n+\n+    final ServiceListResponse resp = handleError(submitRequest(omRequest))\n+        .getServiceListResponse();\n+\n+    return resp.getServiceInfoList().stream()\n+        .map(ServiceInfo::getFromProtobuf)\n+        .collect(Collectors.toList());\n+\n+  }\n+\n+  @Override\n+  public ServiceInfoEx getServiceInfo() throws IOException {\n+    ServiceListRequest req = ServiceListRequest.newBuilder().build();\n+\n+    OMRequest omRequest = createOMRequest(Type.ServiceList)\n+        .setServiceListRequest(req)\n+        .build();\n+\n+    final ServiceListResponse resp = handleError(submitRequest(omRequest))\n+        .getServiceListResponse();\n+\n+    return new ServiceInfoEx(\n+        resp.getServiceInfoList().stream()\n+            .map(ServiceInfo::getFromProtobuf)\n+            .collect(Collectors.toList()),\n+        resp.getCaCertificate());\n+  }\n+\n+  @Override\n+  public boolean bootstrap(List<OMNodeInfo> omNodeInfos) throws IOException {", "originalCommit": "c44fba2cf4b6287dff743268335ac17c38db5d45", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDc0MzI2OA==", "url": "https://github.com/apache/ozone/pull/1494#discussion_r544743268", "bodyText": "Done. Using OMNodeDetails instead.", "author": "hanishakoneru", "createdAt": "2020-12-17T01:28:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzYxMTM0MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzYzODA5NQ==", "url": "https://github.com/apache/ozone/pull/1494#discussion_r543638095", "bodyText": "This is newly bootstrapped OM, so when it starts it has loaded new config, why do we need to do this?", "author": "bharatviswa504", "createdAt": "2020-12-15T19:46:28Z", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/OzoneManager.java", "diffHunk": "@@ -2707,6 +2728,57 @@ public ServiceInfoEx getServiceInfo() throws IOException {\n     return new ServiceInfoEx(getServiceList(), caCertPem);\n   }\n \n+  @Override\n+  public boolean bootstrap(List<OMNodeInfo> omNodeInfos) throws IOException {\n+    LOG.error(\"OM bootstrap command should be received via the RPC server\");\n+    throw new UnsupportedOperationException(\"OM bootstrap command should be \" +\n+        \"received via the RPC server\");\n+  }\n+\n+  /**\n+   * Add a new OM Node to the HA cluster.\n+   */\n+  public void addNewOMNode(String newOMNodeId) {\n+    OMNodeDetails newOMNodeDetails = OMNodeDetails.getOMNodeDetailsFromConf(\n+        getConfiguration(), getOMServiceId(), newOMNodeId);\n+    if (newOMNodeDetails == null) {\n+      // Load new configuration object to read in new peer information\n+      setConfiguration(new OzoneConfiguration());", "originalCommit": "c44fba2cf4b6287dff743268335ac17c38db5d45", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDY5NTI1MA==", "url": "https://github.com/apache/ozone/pull/1494#discussion_r544695250", "bodyText": "This is run on all OMs (old OMs also). OzoneManager#addNewOMNode() is called when Ratis sends notifyConfigurationChanged(). And since the old OMs are not necessarily restarted, we need to reload the configuration.", "author": "hanishakoneru", "createdAt": "2020-12-16T23:22:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzYzODA5NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzY0Njk5NA==", "url": "https://github.com/apache/ozone/pull/1494#discussion_r543646994", "bodyText": "We are not using httpAddrress, httpsAddress, rpcPort, serviceID which are sent thru bootStraprequest\nAnd in notifyConfigurationChanged finally reading from the current OM config. So, I see there is no real use in sending these information only required thing need looks like nodeID. Not sure If I am missing something here.", "author": "bharatviswa504", "createdAt": "2020-12-15T19:59:59Z", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/ratis/OzoneManagerRatisServer.java", "diffHunk": "@@ -137,6 +141,59 @@ public OMResponse submitRequest(OMRequest omRequest) throws ServiceException {\n     return processReply(omRequest, raftClientReply);\n   }\n \n+  /**\n+   * Add a new OM to the Ratis ring.\n+   * @return true if the new OM is successfully added to the ratis ring,\n+   * false otherwise.\n+   */\n+  public boolean bootstrapNewOMs(List<OMNodeDetails> newOMNodes) {\n+    StringBuilder newOMNodeIdsBuilder = new StringBuilder();\n+    newOMNodes.stream().forEach(newOMNode ->\n+        newOMNodeIdsBuilder.append(\", \").append(newOMNode.getOMNodeId()));\n+    String newOMNodeIds = newOMNodeIdsBuilder.toString().substring(2);\n+    LOG.info(\"Bootstrapping new OM(s): {}\", newOMNodeIds);", "originalCommit": "c44fba2cf4b6287dff743268335ac17c38db5d45", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDc0MzQ3MA==", "url": "https://github.com/apache/ozone/pull/1494#discussion_r544743470", "bodyText": "Done. Not propagating the unused data anymore.", "author": "hanishakoneru", "createdAt": "2020-12-17T01:28:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzY0Njk5NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzY0NzU3NA==", "url": "https://github.com/apache/ozone/pull/1494#discussion_r543647574", "bodyText": "Just a question:\nIf OM is started normally, and prepareBootStrapRequest is performed will it cause any issues?", "author": "bharatviswa504", "createdAt": "2020-12-15T20:00:58Z", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/ratis/OzoneManagerRatisServer.java", "diffHunk": "@@ -317,8 +377,18 @@ public static OzoneManagerRatisServer newOMRatisServer(\n         .build();\n \n     List<RaftPeer> raftPeers = new ArrayList<>();\n-    // Add this Ratis server to the Ratis ring\n-    raftPeers.add(localRaftPeer);\n+\n+    // If the OM is started in bootstrap mode, do not add it to the ratis ring.\n+    // It will be added later using SetConfiguration from the leader OM.\n+    if (isBootstrapping) {", "originalCommit": "c44fba2cf4b6287dff743268335ac17c38db5d45", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDc0MzY2NQ==", "url": "https://github.com/apache/ozone/pull/1494#discussion_r544743665", "bodyText": "It could possibly cause a different ring to form with the new OMs.\nThe most likely scenario is that the new OMs would shutdown. But we need to find a mechanism to find this erroneous scenario and address it.\nI think it should be done in a different Jira though.", "author": "hanishakoneru", "createdAt": "2020-12-17T01:29:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzY0NzU3NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mzc1NTQwNA==", "url": "https://github.com/apache/ozone/pull/1494#discussion_r543755404", "bodyText": "Here first we need to check for not null, as in few code paths getNewNodeInfos returns null.", "author": "bharatviswa504", "createdAt": "2020-12-15T23:12:56Z", "path": "hadoop-ozone/tools/src/main/java/org/apache/hadoop/ozone/admin/om/AddOMSubcommand.java", "diffHunk": "@@ -0,0 +1,174 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ *  with the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  Unless required by applicable law or agreed to in writing, software\n+ *  distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *  See the License for the specific language governing permissions and\n+ *  limitations under the License.\n+ */\n+\n+package org.apache.hadoop.ozone.admin.om;\n+\n+import java.io.IOException;\n+import java.net.InetSocketAddress;\n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.List;\n+import org.apache.hadoop.hdds.cli.HddsVersionProvider;\n+import org.apache.hadoop.hdds.conf.OzoneConfiguration;\n+import org.apache.hadoop.hdds.protocol.proto.HddsProtos;\n+import org.apache.hadoop.net.NetUtils;\n+import org.apache.hadoop.ozone.OmUtils;\n+import org.apache.hadoop.ozone.client.OzoneClientException;\n+import org.apache.hadoop.ozone.om.helpers.ServiceInfo;\n+import org.apache.hadoop.ozone.om.protocol.OzoneManagerProtocol;\n+import org.apache.hadoop.ozone.protocol.proto.OzoneManagerProtocolProtos.OMNodeInfo;\n+import org.apache.hadoop.ozone.protocol.proto.OzoneManagerProtocolProtos.OMRoleInfo;\n+import org.apache.hadoop.util.StringUtils;\n+import picocli.CommandLine;\n+\n+import java.util.concurrent.Callable;\n+\n+import static org.apache.hadoop.ozone.om.OMConfigKeys.OZONE_OM_ADDRESS_KEY;\n+import static org.apache.hadoop.ozone.om.OMConfigKeys.OZONE_OM_HTTPS_ADDRESS_KEY;\n+import static org.apache.hadoop.ozone.om.OMConfigKeys.OZONE_OM_HTTP_ADDRESS_KEY;\n+import static org.apache.hadoop.ozone.om.OMConfigKeys.OZONE_OM_NODES_KEY;\n+import static org.apache.hadoop.ozone.om.OMConfigKeys.OZONE_OM_RATIS_PORT_DEFAULT;\n+import static org.apache.hadoop.ozone.om.OMConfigKeys.OZONE_OM_RATIS_PORT_KEY;\n+\n+/**\n+ * Handler of om roles command.\n+ */\n+@CommandLine.Command(\n+    name = \"addom\", aliases = \"addoms, addnewom, addnewoms\",\n+    description = \"Adds newly Bootstrapped OM(s) to the cluster. \" +\n+        \"\\nNote - New OM(s) should be started in bootstrap mode before \" +\n+        \"running this command.\" +\n+        \"\\nNote - Configuration files of all existing \" +\n+        \"OM(s) MUST be updated with information about the new OM(s) (\" +\n+        OZONE_OM_NODES_KEY + \", \" + OZONE_OM_ADDRESS_KEY + \", \" +\n+        OZONE_OM_HTTP_ADDRESS_KEY + \", \" + OZONE_OM_HTTPS_ADDRESS_KEY + \", \" +\n+        OZONE_OM_RATIS_PORT_KEY + \").\",\n+    mixinStandardHelpOptions = true,\n+    versionProvider = HddsVersionProvider.class)\n+public class AddOMSubcommand implements Callable<Void> {\n+\n+  @CommandLine.ParentCommand\n+  private OMAdmin parent;\n+\n+  @CommandLine.Option(names = {\"-id\", \"--service-id\"},\n+      description = \"OM Service ID\",\n+      required = true)\n+  private String omServiceId;\n+\n+  @CommandLine.Option(names = {\"-nodeid\", \"-nodeids\", \"--new-node-ids\"},\n+      description = \"A comma separated list of node IDs of the new OM(s). \",\n+      required = true)\n+  private String newNodeIds;\n+\n+  private OzoneManagerProtocol ozoneManagerClient;\n+\n+  @Override\n+  public Void call() throws Exception {\n+    boolean success = false;\n+    try {\n+      ozoneManagerClient =  parent.createOmClient(omServiceId);\n+\n+      List<OMNodeInfo> newOMNodeInfos = getNewNodeInfos();\n+\n+      if (!newOMNodeInfos.isEmpty()) {", "originalCommit": "c44fba2cf4b6287dff743268335ac17c38db5d45", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDc0NDE0NQ==", "url": "https://github.com/apache/ozone/pull/1494#discussion_r544744145", "bodyText": "Done.", "author": "hanishakoneru", "createdAt": "2020-12-17T01:30:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mzc1NTQwNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mzc1NjM0Ng==", "url": "https://github.com/apache/ozone/pull/1494#discussion_r543756346", "bodyText": "Can we call this AddOMRequest, as this is an admin command submitted to add new OM's to the cluster.", "author": "bharatviswa504", "createdAt": "2020-12-15T23:14:56Z", "path": "hadoop-ozone/interface-client/src/main/proto/OmClientProtocol.proto", "diffHunk": "@@ -1203,11 +1203,41 @@ message UpdateGetS3SecretRequest {\n     required string awsSecret = 2;\n }\n \n+message OMNodeInfo {\n+    required string nodeId = 1;\n+    required string hostAddress = 2;\n+    required uint32 rpcPort = 3;\n+    required uint32 ratisPort = 4;\n+    required string httpAddr = 5;\n+    required string httpsAddr = 6;\n+    optional string serviceId = 7;\n+}\n+\n+enum BootstrapErrorCode {\n+    RATIS_NOT_ENABLED = 1;\n+    LEADER_UNDETERMINED = 2;\n+    RATIS_BOOTSTRAP_ERROR = 3;\n+}\n+\n+message BootstrapRequest {", "originalCommit": "c44fba2cf4b6287dff743268335ac17c38db5d45", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDc0NDE4OQ==", "url": "https://github.com/apache/ozone/pull/1494#discussion_r544744189", "bodyText": "Done.", "author": "hanishakoneru", "createdAt": "2020-12-17T01:30:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mzc1NjM0Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mzc1NjY2Mw==", "url": "https://github.com/apache/ozone/pull/1494#discussion_r543756663", "bodyText": "We are not using rpcPort, httpAddr, httpsAddr, serviceId these can be removed from this.", "author": "bharatviswa504", "createdAt": "2020-12-15T23:15:44Z", "path": "hadoop-ozone/interface-client/src/main/proto/OmClientProtocol.proto", "diffHunk": "@@ -1203,11 +1203,41 @@ message UpdateGetS3SecretRequest {\n     required string awsSecret = 2;\n }\n \n+message OMNodeInfo {\n+    required string nodeId = 1;\n+    required string hostAddress = 2;\n+    required uint32 rpcPort = 3;", "originalCommit": "c44fba2cf4b6287dff743268335ac17c38db5d45", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDc0NDIzMg==", "url": "https://github.com/apache/ozone/pull/1494#discussion_r544744232", "bodyText": "Done.", "author": "hanishakoneru", "createdAt": "2020-12-17T01:31:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mzc1NjY2Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mzc2MDkwMA==", "url": "https://github.com/apache/ozone/pull/1494#discussion_r543760900", "bodyText": "Question:\nI see this is called from Ratis, when any StateMachine has hit exception.\nIn this case, do we want to terminate OM, is this handled to handle any failure of notifyConfigurationChanged where we are throwing OzoneIllegalArgumentException?", "author": "bharatviswa504", "createdAt": "2020-12-15T23:25:07Z", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/ratis/OzoneManagerStateMachine.java", "diffHunk": "@@ -388,6 +412,15 @@ public String toStateMachineLogEntryString(StateMachineLogEntryProto proto) {\n     return OMRatisHelper.smProtoToString(proto);\n   }\n \n+  @Override\n+  public void close() throws IOException {\n+    // OM should be shutdown as the StateMachine has shutdown.", "originalCommit": "c44fba2cf4b6287dff743268335ac17c38db5d45", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDY5OTI1Ng==", "url": "https://github.com/apache/ozone/pull/1494#discussion_r544699256", "bodyText": "If the StateMachine has terminated for any reason, then the OM should also be terminated.\nThis is not just for notifyConfigurationChanged exception. If the RaftServer shutsdown for reason, we want the OM also to shutdown. Though the OM would not service write requests any more, the shutdown would not be visible to user as OM is still running.", "author": "hanishakoneru", "createdAt": "2020-12-16T23:32:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mzc2MDkwMA=="}], "type": "inlineReview"}, {"oid": "881cb6e77e22ff5c12aac652d3e73659bf0e7ab8", "url": "https://github.com/apache/ozone/commit/881cb6e77e22ff5c12aac652d3e73659bf0e7ab8", "message": "review comments", "committedDate": "2020-12-17T01:25:33Z", "type": "forcePushed"}, {"oid": "4e9e1e8498dd9d1418f321a9e3b60cdcffd9fbb1", "url": "https://github.com/apache/ozone/commit/4e9e1e8498dd9d1418f321a9e3b60cdcffd9fbb1", "message": "review comments", "committedDate": "2020-12-17T01:26:07Z", "type": "forcePushed"}, {"oid": "f9244cb9b389ee2befa0745ec6bc2c8b0ae74909", "url": "https://github.com/apache/ozone/commit/f9244cb9b389ee2befa0745ec6bc2c8b0ae74909", "message": "rebase and CI fixes", "committedDate": "2021-01-06T23:07:00Z", "type": "forcePushed"}, {"oid": "38978377d0ba2bc1cd223d7fd95c1b90de4a5821", "url": "https://github.com/apache/ozone/commit/38978377d0ba2bc1cd223d7fd95c1b90de4a5821", "message": "HDDS-4330. Bootstrap new OM node", "committedDate": "2021-04-20T22:31:29Z", "type": "forcePushed"}, {"oid": "c1b64ed0f78b3cabba65260aa53c2ae117ce0df4", "url": "https://github.com/apache/ozone/commit/c1b64ed0f78b3cabba65260aa53c2ae117ce0df4", "message": "CI fixes 1", "committedDate": "2021-04-23T17:55:34Z", "type": "forcePushed"}, {"oid": "f39d8d2daed922fa508eb577985795d63ad5ad60", "url": "https://github.com/apache/ozone/commit/f39d8d2daed922fa508eb577985795d63ad5ad60", "message": "CI fixes 2", "committedDate": "2021-04-23T22:35:20Z", "type": "forcePushed"}, {"oid": "b97fe2d44632d3c575bff16b2a8394c75802a04a", "url": "https://github.com/apache/ozone/commit/b97fe2d44632d3c575bff16b2a8394c75802a04a", "message": "CI fixes 2", "committedDate": "2021-05-25T16:41:56Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY0MDM2OTMyMQ==", "url": "https://github.com/apache/ozone/pull/1494#discussion_r640369321", "bodyText": "Looks like we need to add this new service to OMPolicyProvider and add the ACL property to ozone-default.xml\nTo allow service-level authorization for this rpc service.", "author": "bharatviswa504", "createdAt": "2021-05-27T07:45:00Z", "path": "hadoop-ozone/common/src/main/java/org/apache/hadoop/ozone/om/protocolPB/OMInterServiceProtocolPB.java", "diffHunk": "@@ -0,0 +1,41 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.hadoop.ozone.om.protocolPB;\n+\n+import org.apache.hadoop.hdds.annotation.InterfaceAudience;\n+import org.apache.hadoop.ozone.om.OMConfigKeys;\n+import org.apache.hadoop.ipc.ProtocolInfo;\n+import org.apache.hadoop.ozone.protocol.proto\n+    .OzoneManagerInterServiceProtocolProtos.OzoneManagerInterService;\n+import org.apache.hadoop.security.KerberosInfo;\n+import org.apache.hadoop.security.token.TokenInfo;\n+import org.apache.hadoop.ozone.security.OzoneDelegationTokenSelector;\n+\n+/**\n+ * Protocol used for communication between OMs.\n+ */\n+@ProtocolInfo(protocolName =\n+    \"org.apache.hadoop.ozone.om.protocol.OMInterServiceProtocol\",\n+    protocolVersion = 1)\n+@KerberosInfo(\n+    serverPrincipal = OMConfigKeys.OZONE_OM_KERBEROS_PRINCIPAL_KEY)\n+@TokenInfo(OzoneDelegationTokenSelector.class)\n+@InterfaceAudience.Private", "originalCommit": "9b804603308088b06211f384aee4c4e376dd791e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY0MDM3Mjc1OQ==", "url": "https://github.com/apache/ozone/pull/1494#discussion_r640372759", "bodyText": "Question: Do we need to add TokenInfo for this Protocol?\nAs for this, the user should come with a Kerberos credential only for bootstrap right? Or in general when do we add TokenInfo only when we allow that service with token auth?\ncc @xiaoyuyao", "author": "bharatviswa504", "createdAt": "2021-05-27T07:49:51Z", "path": "hadoop-ozone/common/src/main/java/org/apache/hadoop/ozone/om/protocolPB/OMInterServiceProtocolPB.java", "diffHunk": "@@ -0,0 +1,41 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.hadoop.ozone.om.protocolPB;\n+\n+import org.apache.hadoop.hdds.annotation.InterfaceAudience;\n+import org.apache.hadoop.ozone.om.OMConfigKeys;\n+import org.apache.hadoop.ipc.ProtocolInfo;\n+import org.apache.hadoop.ozone.protocol.proto\n+    .OzoneManagerInterServiceProtocolProtos.OzoneManagerInterService;\n+import org.apache.hadoop.security.KerberosInfo;\n+import org.apache.hadoop.security.token.TokenInfo;\n+import org.apache.hadoop.ozone.security.OzoneDelegationTokenSelector;\n+\n+/**\n+ * Protocol used for communication between OMs.\n+ */\n+@ProtocolInfo(protocolName =\n+    \"org.apache.hadoop.ozone.om.protocol.OMInterServiceProtocol\",\n+    protocolVersion = 1)\n+@KerberosInfo(\n+    serverPrincipal = OMConfigKeys.OZONE_OM_KERBEROS_PRINCIPAL_KEY)\n+@TokenInfo(OzoneDelegationTokenSelector.class)", "originalCommit": "9b804603308088b06211f384aee4c4e376dd791e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY0ODUzMDg2Ng==", "url": "https://github.com/apache/ozone/pull/1494#discussion_r648530866", "bodyText": "I am not sure.\n@xiaoyuyao can you please help with this?", "author": "hanishakoneru", "createdAt": "2021-06-09T17:40:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY0MDM3Mjc1OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY0OTY4MzEyMQ==", "url": "https://github.com/apache/ozone/pull/1494#discussion_r649683121", "bodyText": "Thank you @xiaoyuyao for the offline discussion.\n@bharatviswa504, you are right. We do not need to add TokenInfo for this protocol. Since this is inter OM service, OMs can use their Kerberos principal to authenticate. We do not need to provide Token authorization also.", "author": "hanishakoneru", "createdAt": "2021-06-11T04:33:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY0MDM3Mjc1OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY0MDM3NjU3NA==", "url": "https://github.com/apache/ozone/pull/1494#discussion_r640376574", "bodyText": "Do we need to add here also KerberosInfo.\nFrom other Protocol classes which are there in ozone, we have the info here also. Not sure mandatory or not here.", "author": "bharatviswa504", "createdAt": "2021-05-27T07:55:15Z", "path": "hadoop-ozone/common/src/main/java/org/apache/hadoop/ozone/om/protocol/OMInterServiceProtocol.java", "diffHunk": "@@ -0,0 +1,33 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ * <p>\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ * <p>\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.hadoop.ozone.om.protocol;\n+\n+import java.io.Closeable;\n+import java.io.IOException;\n+import org.apache.hadoop.ozone.om.helpers.OMNodeDetails;\n+\n+/**\n+ * Protocol for inter OM communication.\n+ */\n+public interface OMInterServiceProtocol extends Closeable {", "originalCommit": "9b804603308088b06211f384aee4c4e376dd791e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY0ODUzMDA0NQ==", "url": "https://github.com/apache/ozone/pull/1494#discussion_r648530045", "bodyText": "Done.", "author": "hanishakoneru", "createdAt": "2021-06-09T17:39:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY0MDM3NjU3NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY0MDM4NzU1Nw==", "url": "https://github.com/apache/ozone/pull/1494#discussion_r640387557", "bodyText": "Minor:\nActiveOMs -> ActiiiveSCMs\nOMs -> SCMs", "author": "bharatviswa504", "createdAt": "2021-05-27T08:10:16Z", "path": "hadoop-ozone/integration-test/src/test/java/org/apache/hadoop/ozone/MiniOzoneHAClusterImpl.java", "diffHunk": "@@ -352,7 +361,12 @@ public MiniOzoneCluster build() throws IOException {\n         numOfActiveOMs = numOfOMs;\n       }\n \n-      // If num of ActiveOMs is not set, set it to numOfOMs.\n+      // If num of OMs it not set, set it to 1.", "originalCommit": "9b804603308088b06211f384aee4c4e376dd791e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY0MDQ3MTYxMQ==", "url": "https://github.com/apache/ozone/pull/1494#discussion_r640471611", "bodyText": "This is reading the values from config, I think if all required information is passed like httpAddress, httpsAddress and any other required info, we can bootstrap OM's with out restart.  (As now if we read from config, we except the new OM details should be in config before)", "author": "bharatviswa504", "createdAt": "2021-05-27T09:51:25Z", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/ratis/OzoneManagerStateMachine.java", "diffHunk": "@@ -166,6 +167,29 @@ public void notifyTermIndexUpdated(long currentTerm, long index) {\n     computeAndUpdateLastAppliedIndex(index, currentTerm, null, false);\n   }\n \n+  /**\n+   * Called to notify state machine about configuration changes.\n+   * Configurations changes include addition of newly bootstrapped OM.\n+   */\n+  @Override\n+  public void notifyConfigurationChanged(long term, long index,\n+      RaftProtos.RaftConfigurationProto newRaftConfiguration) {\n+    List<RaftProtos.RaftPeerProto> newPeers =\n+        newRaftConfiguration.getPeersList();\n+    LOG.info(\"Received Configuration change notification from Ratis. New Peer\" +\n+        \" list:\\n{}\", newPeers);\n+    for (RaftProtos.RaftPeerProto raftPeerProto : newPeers) {\n+      String omNodeId = RaftPeerId.valueOf(raftPeerProto.getId()).toString();\n+      if (!ozoneManager.doesPeerExist(omNodeId)) {\n+        LOG.info(\"Adding new OM {} to the Peer list.\", omNodeId);\n+        ozoneManager.addOMNodeToPeers(omNodeId);", "originalCommit": "9b804603308088b06211f384aee4c4e376dd791e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY0MDUwNzYxOA==", "url": "https://github.com/apache/ozone/pull/1494#discussion_r640507618", "bodyText": "Looks like this is taken care of. With this       // Load new configuration object to read in new peer information\nsetConfiguration(new OzoneConfiguration());\nSo, here it reloads config from disk again? Have you tried on a docker/cluster to verify this. (From reading code looks like config load has taken care) Just curious.\nThe only thing is when they add a new node, the users should change the config on all nodes.", "author": "bharatviswa504", "createdAt": "2021-05-27T10:44:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY0MDQ3MTYxMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY0MDkwOTYxMA==", "url": "https://github.com/apache/ozone/pull/1494#discussion_r640909610", "bodyText": "Yes, tried it out on a docker cluster and the config is reloaded from disk.\n\nThe only thing is when they add a new node, the users should change the config on all nodes.\nYes that is a requirement to ensure that if the cluster is restarted, the old nodes have information about the new node.", "author": "hanishakoneru", "createdAt": "2021-05-27T19:31:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY0MDQ3MTYxMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY0MjE5OTM0OQ==", "url": "https://github.com/apache/ozone/pull/1494#discussion_r642199349", "bodyText": "We can revisit this if we want to support with out change in config.", "author": "bharatviswa504", "createdAt": "2021-05-31T04:15:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY0MDQ3MTYxMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY0MDQ3OTY5Mg==", "url": "https://github.com/apache/ozone/pull/1494#discussion_r640479692", "bodyText": "We commit to DB once double buffer flushes. Do you think we need some wait or read from StateMachine and getLastAppliedIndex?", "author": "bharatviswa504", "createdAt": "2021-05-27T10:02:11Z", "path": "hadoop-ozone/integration-test/src/test/java/org/apache/hadoop/ozone/om/TestOzoneManagerBootstrap.java", "diffHunk": "@@ -0,0 +1,212 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hadoop.ozone.om;\n+\n+import com.google.common.base.Supplier;\n+import java.io.File;\n+import java.io.FileFilter;\n+import java.io.IOException;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.UUID;\n+import java.util.concurrent.TimeUnit;\n+import org.apache.commons.lang3.RandomStringUtils;\n+import org.apache.hadoop.hdds.conf.OzoneConfiguration;\n+import org.apache.hadoop.hdfs.server.common.Storage;\n+import org.apache.hadoop.ozone.MiniOzoneCluster;\n+import org.apache.hadoop.ozone.MiniOzoneHAClusterImpl;\n+import org.apache.hadoop.ozone.client.ObjectStore;\n+import org.apache.hadoop.ozone.client.OzoneBucket;\n+import org.apache.hadoop.ozone.client.OzoneClientFactory;\n+import org.apache.hadoop.ozone.client.OzoneVolume;\n+import org.apache.hadoop.ozone.om.ratis.OzoneManagerRatisServer;\n+import org.apache.hadoop.test.GenericTestUtils;\n+import org.junit.After;\n+import org.junit.Assert;\n+import org.junit.Rule;\n+import org.junit.Test;\n+import org.junit.rules.ExpectedException;\n+import org.junit.rules.Timeout;\n+\n+import static org.apache.hadoop.ozone.OzoneConsts.SCM_DUMMY_SERVICE_ID;\n+import static org.apache.hadoop.ozone.om.OMConfigKeys.OZONE_OM_RATIS_SERVER_REQUEST_TIMEOUT_DEFAULT;\n+import static org.apache.hadoop.ozone.om.TestOzoneManagerHA.createKey;\n+\n+public class TestOzoneManagerBootstrap {\n+\n+  @Rule\n+  public ExpectedException exception = ExpectedException.none();\n+\n+  @Rule\n+  public Timeout timeout = new Timeout(500_000);\n+\n+  private MiniOzoneHAClusterImpl cluster = null;\n+  private ObjectStore objectStore;\n+  private OzoneConfiguration conf;\n+  private final String clusterId = UUID.randomUUID().toString();\n+  private final String scmId = UUID.randomUUID().toString();\n+\n+  private static final int NUM_INITIAL_OMS = 3;\n+\n+  private static final String OM_SERVICE_ID = \"om-bootstrap\";\n+  private static final String VOLUME_NAME;\n+  private static final String BUCKET_NAME;\n+\n+  private long lastTransactionIndex;\n+\n+  static {\n+    VOLUME_NAME = \"volume\" + RandomStringUtils.randomNumeric(5);\n+    BUCKET_NAME = \"bucket\" + RandomStringUtils.randomNumeric(5);\n+  }\n+\n+  private void setupCluster() throws Exception {\n+    setupCluster(NUM_INITIAL_OMS);\n+  }\n+\n+  private void setupCluster(int numInitialOMs) throws Exception {\n+    conf = new OzoneConfiguration();\n+    cluster = (MiniOzoneHAClusterImpl) MiniOzoneCluster.newHABuilder(conf)\n+        .setClusterId(clusterId)\n+        .setScmId(scmId)\n+        .setSCMServiceId(SCM_DUMMY_SERVICE_ID)\n+        .setOMServiceId(OM_SERVICE_ID)\n+        .setNumOfOzoneManagers(numInitialOMs)\n+        .build();\n+    cluster.waitForClusterToBeReady();\n+    objectStore = OzoneClientFactory.getRpcClient(OM_SERVICE_ID, conf)\n+        .getObjectStore();\n+\n+    // Perform some transactions\n+    objectStore.createVolume(VOLUME_NAME);\n+    OzoneVolume volume = objectStore.getVolume(VOLUME_NAME);\n+    volume.createBucket(BUCKET_NAME);\n+    OzoneBucket bucket = volume.getBucket(BUCKET_NAME);\n+    createKey(bucket);\n+\n+    lastTransactionIndex = cluster.getOMLeader().getRatisSnapshotIndex();", "originalCommit": "9b804603308088b06211f384aee4c4e376dd791e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY0MDk3MzI5MQ==", "url": "https://github.com/apache/ozone/pull/1494#discussion_r640973291", "bodyText": "Done. Getting SM's last applied index.", "author": "hanishakoneru", "createdAt": "2021-05-27T21:17:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY0MDQ3OTY5Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY0MDQ4MjA4OA==", "url": "https://github.com/apache/ozone/pull/1494#discussion_r640482088", "bodyText": "Question:\nNot understood the reason to do this.\nAs our MiniOzoneHACluster is only used in non-secure, why certClient is being set here?", "author": "bharatviswa504", "createdAt": "2021-05-27T10:05:34Z", "path": "hadoop-ozone/integration-test/src/test/java/org/apache/hadoop/ozone/MiniOzoneHAClusterImpl.java", "diffHunk": "@@ -652,10 +667,158 @@ private void initOMHAConfig(int basePort) throws IOException {\n         conf.setInt(omRatisPortKey, port + 4);\n       }\n \n-      conf.set(omNodesKey, omNodesKeyValue.substring(1));\n+      conf.set(omNodesKey, String.join(\",\", omNodeIds));\n+    }\n+  }\n+\n+  /**\n+   * Bootstrap new OM and add to existing OM HA service ring.\n+   * @return new OM nodeId\n+   */\n+  public void bootstrapOzoneManager(String omNodeId) throws Exception {\n+\n+    int basePort;\n+    int retryCount = 0;\n+\n+    OzoneManager om = null;\n+\n+    long leaderSnapshotIndex = getOMLeader().getRatisSnapshotIndex();\n+\n+    while (true) {\n+      try {\n+        basePort = 10000 + RANDOM.nextInt(1000) * 4;\n+        OzoneConfiguration newConf = addNewOMToConfig(getOMServiceId(),\n+            omNodeId, basePort);\n+\n+        om = bootstrapNewOM(omNodeId);\n+\n+        // Get the CertClient from an existing OM and set for new OM\n+        if (omhaService.getServiceByIndex(0).getCertificateClient() != null) {\n+          om.setCertClient(", "originalCommit": "9b804603308088b06211f384aee4c4e376dd791e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY0MDkyNzgxMw==", "url": "https://github.com/apache/ozone/pull/1494#discussion_r640927813", "bodyText": "You are right. I replicated this from MiniOzoneCluster. Will remove it.", "author": "hanishakoneru", "createdAt": "2021-05-27T20:00:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY0MDQ4MjA4OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY0MDQ4NDcyNA==", "url": "https://github.com/apache/ozone/pull/1494#discussion_r640484724", "bodyText": "Increase time duration here to avoid flakiness in CI runs.\nAnd also as method name says check OM Exists in peerList, can we check from ratis server peer info also?", "author": "bharatviswa504", "createdAt": "2021-05-27T10:09:11Z", "path": "hadoop-ozone/integration-test/src/test/java/org/apache/hadoop/ozone/om/TestOzoneManagerBootstrap.java", "diffHunk": "@@ -0,0 +1,212 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hadoop.ozone.om;\n+\n+import com.google.common.base.Supplier;\n+import java.io.File;\n+import java.io.FileFilter;\n+import java.io.IOException;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.UUID;\n+import java.util.concurrent.TimeUnit;\n+import org.apache.commons.lang3.RandomStringUtils;\n+import org.apache.hadoop.hdds.conf.OzoneConfiguration;\n+import org.apache.hadoop.hdfs.server.common.Storage;\n+import org.apache.hadoop.ozone.MiniOzoneCluster;\n+import org.apache.hadoop.ozone.MiniOzoneHAClusterImpl;\n+import org.apache.hadoop.ozone.client.ObjectStore;\n+import org.apache.hadoop.ozone.client.OzoneBucket;\n+import org.apache.hadoop.ozone.client.OzoneClientFactory;\n+import org.apache.hadoop.ozone.client.OzoneVolume;\n+import org.apache.hadoop.ozone.om.ratis.OzoneManagerRatisServer;\n+import org.apache.hadoop.test.GenericTestUtils;\n+import org.junit.After;\n+import org.junit.Assert;\n+import org.junit.Rule;\n+import org.junit.Test;\n+import org.junit.rules.ExpectedException;\n+import org.junit.rules.Timeout;\n+\n+import static org.apache.hadoop.ozone.OzoneConsts.SCM_DUMMY_SERVICE_ID;\n+import static org.apache.hadoop.ozone.om.OMConfigKeys.OZONE_OM_RATIS_SERVER_REQUEST_TIMEOUT_DEFAULT;\n+import static org.apache.hadoop.ozone.om.TestOzoneManagerHA.createKey;\n+\n+public class TestOzoneManagerBootstrap {\n+\n+  @Rule\n+  public ExpectedException exception = ExpectedException.none();\n+\n+  @Rule\n+  public Timeout timeout = new Timeout(500_000);\n+\n+  private MiniOzoneHAClusterImpl cluster = null;\n+  private ObjectStore objectStore;\n+  private OzoneConfiguration conf;\n+  private final String clusterId = UUID.randomUUID().toString();\n+  private final String scmId = UUID.randomUUID().toString();\n+\n+  private static final int NUM_INITIAL_OMS = 3;\n+\n+  private static final String OM_SERVICE_ID = \"om-bootstrap\";\n+  private static final String VOLUME_NAME;\n+  private static final String BUCKET_NAME;\n+\n+  private long lastTransactionIndex;\n+\n+  static {\n+    VOLUME_NAME = \"volume\" + RandomStringUtils.randomNumeric(5);\n+    BUCKET_NAME = \"bucket\" + RandomStringUtils.randomNumeric(5);\n+  }\n+\n+  private void setupCluster() throws Exception {\n+    setupCluster(NUM_INITIAL_OMS);\n+  }\n+\n+  private void setupCluster(int numInitialOMs) throws Exception {\n+    conf = new OzoneConfiguration();\n+    cluster = (MiniOzoneHAClusterImpl) MiniOzoneCluster.newHABuilder(conf)\n+        .setClusterId(clusterId)\n+        .setScmId(scmId)\n+        .setSCMServiceId(SCM_DUMMY_SERVICE_ID)\n+        .setOMServiceId(OM_SERVICE_ID)\n+        .setNumOfOzoneManagers(numInitialOMs)\n+        .build();\n+    cluster.waitForClusterToBeReady();\n+    objectStore = OzoneClientFactory.getRpcClient(OM_SERVICE_ID, conf)\n+        .getObjectStore();\n+\n+    // Perform some transactions\n+    objectStore.createVolume(VOLUME_NAME);\n+    OzoneVolume volume = objectStore.getVolume(VOLUME_NAME);\n+    volume.createBucket(BUCKET_NAME);\n+    OzoneBucket bucket = volume.getBucket(BUCKET_NAME);\n+    createKey(bucket);\n+\n+    lastTransactionIndex = cluster.getOMLeader().getRatisSnapshotIndex();\n+  }\n+\n+  @After\n+  public void shutdown() throws Exception {\n+    if (cluster != null) {\n+      cluster.shutdown();\n+    }\n+  }\n+\n+  private void assertNewOMExistsInPeerList(String nodeId) throws Exception {\n+    for (OzoneManager om : cluster.getOzoneManagersList()) {\n+      Assert.assertTrue(\"New OM node \" + nodeId + \" not present in Peer list \" +\n+              \"of OM \" + om.getOMNodeId(), om.doesPeerExist(nodeId));\n+    }\n+    OzoneManager newOM = cluster.getOzoneManager(nodeId);\n+    GenericTestUtils.waitFor(new Supplier<Boolean>() {\n+      @Override\n+      public Boolean get() {\n+        try {\n+          return newOM.getRatisSnapshotIndex() >= lastTransactionIndex;\n+        } catch (IOException e) {\n+          return false;\n+        }\n+      }\n+    }, 100, 10000);", "originalCommit": "9b804603308088b06211f384aee4c4e376dd791e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY0MDk3MzAzMQ==", "url": "https://github.com/apache/ozone/pull/1494#discussion_r640973031", "bodyText": "Done", "author": "hanishakoneru", "createdAt": "2021-05-27T21:17:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY0MDQ4NDcyNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY0MDQ5MzU1Ng==", "url": "https://github.com/apache/ozone/pull/1494#discussion_r640493556", "bodyText": "Question: Here comments changed, but actual values not changed.", "author": "bharatviswa504", "createdAt": "2021-05-27T10:22:26Z", "path": "hadoop-ozone/integration-test/src/test/java/org/apache/hadoop/ozone/MiniOzoneHAClusterImpl.java", "diffHunk": "@@ -65,11 +65,13 @@\n   private final OMHAService omhaService;\n   private final SCMHAService scmhaService;\n \n+  private final String clusterMetaPath;\n+\n   private int waitForClusterToBeReadyTimeout = 120000; // 2 min\n \n   private static final Random RANDOM = new Random();\n-  private static final int RATIS_RPC_TIMEOUT = 1000; // 1 second\n-  public static final int NODE_FAILURE_TIMEOUT = 2000; // 2 seconds\n+  private static final int RATIS_RPC_TIMEOUT = 1000; // 10 second", "originalCommit": "9b804603308088b06211f384aee4c4e376dd791e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY0MjE5ODY3Mw==", "url": "https://github.com/apache/ozone/pull/1494#discussion_r642198673", "bodyText": "Question: Why in exception case logging and return null, can't we throw an exception?\nAnd also can we add JavaDoc for this?", "author": "bharatviswa504", "createdAt": "2021-05-31T04:13:09Z", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/ratis/OzoneManagerRatisServer.java", "diffHunk": "@@ -671,6 +672,21 @@ public RaftServerStatus checkLeaderStatus() {\n     return RaftServerStatus.NOT_LEADER;\n   }\n \n+  @VisibleForTesting\n+  public List<String> getCurrentPeersFromRaftConf() {\n+    try {\n+      Collection<RaftPeer> currentPeers =\n+          server.getDivision(raftGroupId).getRaftConf().getCurrentPeers();\n+      List<String> currentPeerList = new ArrayList<>();\n+      currentPeers.forEach(e -> currentPeerList.add(e.getId().toString()));\n+      return currentPeerList;\n+    } catch (IOException e) {\n+      // In this case we return not a leader.\n+      LOG.error(\"Failed to get RaftServer information. \", e);", "originalCommit": "70676be28b5751b82837377224ad6aaa0b3169ff", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY0ODUyODYwNw==", "url": "https://github.com/apache/ozone/pull/1494#discussion_r648528607", "bodyText": "Done.", "author": "hanishakoneru", "createdAt": "2021-06-09T17:37:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY0MjE5ODY3Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY0MjIyNTU3MQ==", "url": "https://github.com/apache/ozone/pull/1494#discussion_r642225571", "bodyText": "Looks like we need to call computeAndUpdateLastAppliedIndex. As applyLogToStateMachine in StateMachineUpdater when configEntry, we call\nstateMachine.event().notifyConfigurationChanged(next.getTerm(), next.getIndex(), next.getConfigurationEntry());\nAs in OM StateMachine, we update lastAppliedIndex using computeAndUpdateLastAppliedIndex.", "author": "bharatviswa504", "createdAt": "2021-05-31T05:49:54Z", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/ratis/OzoneManagerStateMachine.java", "diffHunk": "@@ -166,6 +167,29 @@ public void notifyTermIndexUpdated(long currentTerm, long index) {\n     computeAndUpdateLastAppliedIndex(index, currentTerm, null, false);\n   }\n \n+  /**\n+   * Called to notify state machine about configuration changes.\n+   * Configurations changes include addition of newly bootstrapped OM.\n+   */\n+  @Override\n+  public void notifyConfigurationChanged(long term, long index,\n+      RaftProtos.RaftConfigurationProto newRaftConfiguration) {\n+    List<RaftProtos.RaftPeerProto> newPeers =\n+        newRaftConfiguration.getPeersList();", "originalCommit": "70676be28b5751b82837377224ad6aaa0b3169ff", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY0MjIyODkxMw==", "url": "https://github.com/apache/ozone/pull/1494#discussion_r642228913", "bodyText": "Sorry reading more looks we should be fine, as for any no state machine log entry we call notifyTermIndexUpdated.\nif (!next.hasStateMachineLogEntry()) {\n  stateMachine.event().notifyTermIndexUpdated(next.getTerm(), next.getIndex());\n}\n\nCan you also confirm once?", "author": "bharatviswa504", "createdAt": "2021-05-31T05:59:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY0MjIyNTU3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY0ODUyODUyNw==", "url": "https://github.com/apache/ozone/pull/1494#discussion_r648528527", "bodyText": "Correct. If the log entry is a configurationEntry or a metadataEntry, then RaftServerImpl calls notifyTermIndexUpdated on StateMachine.", "author": "hanishakoneru", "createdAt": "2021-06-09T17:37:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY0MjIyNTU3MQ=="}], "type": "inlineReview"}, {"oid": "3e1e5cf683a3ceff28d6b7856336bb3c6119c2a9", "url": "https://github.com/apache/ozone/commit/3e1e5cf683a3ceff28d6b7856336bb3c6119c2a9", "message": "Review comment fix", "committedDate": "2021-06-09T17:37:33Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1NTA5MzE0Mg==", "url": "https://github.com/apache/ozone/pull/1494#discussion_r655093142", "bodyText": "Just got a question:\nWhy only new node being added is not added here, but other nodes in-ring are added here? (Is it okay to add other nodes here it self, or they also can be discovered during setConf?)\nI remember there was a reason behind this, can you provide info or if you are having another update to PR add some comments it will be easy to understand the reason behind it?", "author": "bharatviswa504", "createdAt": "2021-06-21T05:56:15Z", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/ratis/OzoneManagerRatisServer.java", "diffHunk": "@@ -104,9 +104,127 @@\n   private final RaftGroupId raftGroupId;\n   private final RaftGroup raftGroup;\n   private final RaftPeerId raftPeerId;\n+  private final List<RaftPeer> raftPeers;\n \n   private final OzoneManager ozoneManager;\n   private final OzoneManagerStateMachine omStateMachine;\n+  private final String ratisStorageDir;\n+\n+  private final ClientId clientId = ClientId.randomId();\n+  private static final AtomicLong CALL_ID_COUNTER = new AtomicLong();\n+\n+  private static long nextCallId() {\n+    return CALL_ID_COUNTER.getAndIncrement() & Long.MAX_VALUE;\n+  }\n+\n+  /**\n+   * Returns an OM Ratis server.\n+   * @param conf configuration\n+   * @param om the OM instance starting the ratis server\n+   * @param raftGroupIdStr raft group id string\n+   * @param localRaftPeerId raft peer id of this Ratis server\n+   * @param addr address of the ratis server\n+   * @param peers peer nodes in the raft ring\n+   * @throws IOException\n+   */\n+  @SuppressWarnings({\"parameternumber\", \"java:S107\"})\n+  private OzoneManagerRatisServer(ConfigurationSource conf, OzoneManager om,\n+      String raftGroupIdStr, RaftPeerId localRaftPeerId,\n+      InetSocketAddress addr, List<RaftPeer> peers,\n+      SecurityConfig secConfig, CertificateClient certClient)\n+      throws IOException {\n+    this.ozoneManager = om;\n+    this.omRatisAddress = addr;\n+    this.port = addr.getPort();\n+    this.ratisStorageDir = OzoneManagerRatisUtils.getOMRatisDirectory(conf);\n+    RaftProperties serverProperties = newRaftProperties(conf);\n+\n+    this.raftPeerId = localRaftPeerId;\n+    this.raftGroupId = RaftGroupId.valueOf(\n+        getRaftGroupIdFromOmServiceId(raftGroupIdStr));\n+    this.raftPeers = Lists.newArrayList();\n+    this.raftPeers.addAll(peers);\n+    this.raftGroup = RaftGroup.valueOf(raftGroupId, peers);\n+\n+    StringBuilder raftPeersStr = new StringBuilder();\n+    for (RaftPeer peer : peers) {\n+      raftPeersStr.append(\", \").append(peer.getAddress());\n+    }\n+    LOG.info(\"Instantiating OM Ratis server with groupID: {} and \" +\n+        \"peers: {}\", raftGroupIdStr, raftPeersStr.toString().substring(2));\n+\n+    this.omStateMachine = getStateMachine(conf);\n+\n+    Parameters parameters = createServerTlsParameters(secConfig, certClient);\n+    this.server = RaftServer.newBuilder()\n+        .setServerId(this.raftPeerId)\n+        .setGroup(this.raftGroup)\n+        .setProperties(serverProperties)\n+        .setParameters(parameters)\n+        .setStateMachine(omStateMachine)\n+        .build();\n+  }\n+\n+  /**\n+   * Creates an instance of OzoneManagerRatisServer.\n+   */\n+  public static OzoneManagerRatisServer newOMRatisServer(\n+      ConfigurationSource ozoneConf, OzoneManager omProtocol,\n+      OMNodeDetails omNodeDetails, List<OMNodeDetails> peerNodes,\n+      SecurityConfig secConfig, CertificateClient certClient,\n+      boolean isBootstrapping) throws IOException {\n+\n+    // RaftGroupId is the omServiceId\n+    String omServiceId = omNodeDetails.getServiceId();\n+\n+    String omNodeId = omNodeDetails.getNodeId();\n+    RaftPeerId localRaftPeerId = RaftPeerId.getRaftPeerId(omNodeId);\n+\n+    InetSocketAddress ratisAddr = new InetSocketAddress(\n+        omNodeDetails.getInetAddress(), omNodeDetails.getRatisPort());\n+\n+    RaftPeer localRaftPeer = RaftPeer.newBuilder()\n+        .setId(localRaftPeerId)\n+        .setAddress(ratisAddr)\n+        .build();\n+\n+    List<RaftPeer> raftPeers = new ArrayList<>();\n+\n+    // If the OM is started in bootstrap mode, do not add it to the ratis ring.\n+    // It will be added later using SetConfiguration from the leader OM.\n+    if (isBootstrapping) {\n+      LOG.debug(\"OM started in Bootstrap mode and hence will not be added \" +\n+          \"to Ratis group during startup.\");\n+    } else {\n+      // On regular startup, add current OM to Ratis ring\n+      raftPeers.add(localRaftPeer);\n+    }\n+\n+    for (OMNodeDetails peerInfo : peerNodes) {\n+      String peerNodeId = peerInfo.getNodeId();\n+      RaftPeerId raftPeerId = RaftPeerId.valueOf(peerNodeId);", "originalCommit": "7c89974b47d1654ab7cdc36a504689bc41907218", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1NTY5ODc5Nw==", "url": "https://github.com/apache/ozone/pull/1494#discussion_r655698797", "bodyText": "The existing peers can either be added to the RaftServer (of Bootstrapping node) during initialization or they can be added later when the bootstrapping node gets the setConf log entry from leader. AFAIK, either way should work the same.\nNow that you mention it, if we do not add the peers during initialization, then we can update the config once for with all new OM nodes. This would be useful when we want to bootstrap multiple OMs.\nWill update the PR to use the 2nd approach. Thanks.", "author": "hanishakoneru", "createdAt": "2021-06-21T20:56:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1NTA5MzE0Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1NzE5OTM0Ng==", "url": "https://github.com/apache/ozone/pull/1494#discussion_r657199346", "bodyText": "Updated the patch. Please take a look. Thanks.", "author": "hanishakoneru", "createdAt": "2021-06-23T15:08:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1NTA5MzE0Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1NTA5ODc1Ng==", "url": "https://github.com/apache/ozone/pull/1494#discussion_r655098756", "bodyText": "Add javadocs to public methods", "author": "bharatviswa504", "createdAt": "2021-06-21T06:10:46Z", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/ratis/utils/OzoneManagerRatisUtils.java", "diffHunk": "@@ -340,4 +359,70 @@ public static boolean isBucketFSOptimized() {\n     return isBucketFSOptimized;\n   }\n \n+  /**\n+   * Get the local directory where ratis logs will be stored.\n+   */\n+  public static String getOMRatisDirectory(ConfigurationSource conf) {\n+    String storageDir = conf.get(OMConfigKeys.OZONE_OM_RATIS_STORAGE_DIR);\n+\n+    if (Strings.isNullOrEmpty(storageDir)) {\n+      storageDir = ServerUtils.getDefaultRatisDirectory(conf);\n+    }\n+    return storageDir;\n+  }\n+\n+  public static String getOMRatisSnapshotDirectory(ConfigurationSource conf) {", "originalCommit": "7c89974b47d1654ab7cdc36a504689bc41907218", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1NzE5ODkxNw==", "url": "https://github.com/apache/ozone/pull/1494#discussion_r657198917", "bodyText": "Done.", "author": "hanishakoneru", "createdAt": "2021-06-23T15:08:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1NTA5ODc1Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2NzY4Mjg4Mg==", "url": "https://github.com/apache/ozone/pull/1494#discussion_r667682882", "bodyText": "In normal OM start node, ratisServer peer list has local + peer.\n if (!isBootstrapping) {\n      // On regular startup, add all OMs to Ratis ring\n      raftPeers.add(localRaftPeer);\n\nIn bootstrap case, local node is not added to ratis server peer list.", "author": "bharatviswa504", "createdAt": "2021-07-12T07:17:56Z", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/OzoneManager.java", "diffHunk": "@@ -1339,7 +1339,38 @@ public void bootstrap(OMNodeDetails newOMNode) throws IOException {\n   }\n \n   /**\n-   * Add a new OM Node to the HA cluster. This call comes from OMRatisServer\n+   * When OMStateMachine receives a configuration change update, it calls\n+   * this function to update the peers list, if required.\n+   */\n+  public void updatePeerList(List<String> omNodeIds) {\n+    List<String> ratisServerPeerIdsList = omRatisServer.getPeerIds();\n+    for (String omNodeId : omNodeIds) {\n+      if (getOMNodeId().equals(omNodeId)) {", "originalCommit": "cdb9dfd27201844e01f71150dafb6f7a5208bdfe", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2NzY4Njk5Mg==", "url": "https://github.com/apache/ozone/pull/1494#discussion_r667686992", "bodyText": "While reading more, I have observed that before this change, we have not added local OM node to peer node  list before(raftPeers). Should we have the same behavior?. So, should we remove adding local node to peer list?\n      // On regular startup, add all OMs to Ratis ring\n      raftPeers.add(localRaftPeer);", "author": "bharatviswa504", "createdAt": "2021-07-12T07:24:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2NzY4Mjg4Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2OTkxNTc4NA==", "url": "https://github.com/apache/ozone/pull/1494#discussion_r669915784", "bodyText": "In bootstrap case, local node is not added to ratis server peer list.\n\nYes. This is because the local node is not part of the ratis ring yet. When the SetConfiguration is executed, this node would be added to the peer list.\n\nWhile reading more, I have observed that before this change, we have not added local OM node to peer node list before(raftPeers). Should we have the same behavior?. So, should we remove adding local node to peer list?\n\nBefore this change also the local OM node was added to the peer list in OMRatisServer. Are you referring to any other class?", "author": "hanishakoneru", "createdAt": "2021-07-14T20:04:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2NzY4Mjg4Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY3MDE0NjM4NA==", "url": "https://github.com/apache/ozone/pull/1494#discussion_r670146384", "bodyText": "newOMRatisServer\n    for (OMNodeDetails peerInfo : peerNodes) {\n      String peerNodeId = peerInfo.getNodeId();\n      RaftPeerId raftPeerId = RaftPeerId.valueOf(peerNodeId);\n      RaftPeer raftPeer;\n      if (peerInfo.isHostUnresolved()) {\n        raftPeer = RaftPeer.newBuilder()\n            .setId(raftPeerId)\n            .setAddress(peerInfo.getRatisHostPortStr())\n            .build();\n      } else {\n        InetSocketAddress peerRatisAddr = new InetSocketAddress(\n            peerInfo.getInetAddress(), peerInfo.getRatisPort());\n        raftPeer = RaftPeer.newBuilder()\n            .setId(raftPeerId)\n            .setAddress(peerRatisAddr)\n            .build();\n      }\n\n      // Add other OM nodes belonging to the same OM service to the Ratis ring\n      raftPeers.add(raftPeer);\n    }\n\n    return new OzoneManagerRatisServer(ozoneConf, omProtocol, omServiceId,\n        localRaftPeerId, ratisAddr, raftPeers, secConfig, certClient);\n\nLooks like previously we don't save raftPeers in OzoneManagerRatisServer.\nBut now with this PR, on old node all nodes peer+local will be in peer list.\n\nif (!isBootstrapping) { \n// On regular startup, add all OMs to Ratis ring \nraftPeers.add(localRaftPeer);\n\nWhere as for bootstrap due to this skip, we don't add\nif (getOMNodeId().equals(omNodeId)) {\ncontinue;\n}\n\nDue to this on bootstrap node peerlist does not include local node\nThere is a difference in raftPeers list in bootstrap and old node.", "author": "bharatviswa504", "createdAt": "2021-07-15T05:34:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2NzY4Mjg4Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY3MDc0NjgyNg==", "url": "https://github.com/apache/ozone/pull/1494#discussion_r670746826", "bodyText": "There is a difference in raftPeers list in bootstrap and old node.\n\nCorrect. On a bootstrapping node, we do not add the local node to raftPeer list. This is done later when a setConfiguration request is executed and it calls OMRatisServer#addRaftPeer().\n  /**\n   * Add given node to list of RaftPeers.\n   */\n  public void addRaftPeer(OMNodeDetails omNodeDetails) {\n    InetSocketAddress newOMRatisAddr = new InetSocketAddress(\n        omNodeDetails.getHostAddress(), omNodeDetails.getRatisPort());\n\n    raftPeers.add(RaftPeer.newBuilder()\n        .setId(RaftPeerId.valueOf(omNodeDetails.getNodeId()))\n        .setAddress(newOMRatisAddr)\n        .build());\n\n    LOG.info(\"Added OM {} to Ratis Peers list.\", omNodeDetails.getNodeId());\n  }\n\nAs for the old code, the local node was added to raftPeers there too (OzoneManagerRatisServer Line#348 in old code).", "author": "hanishakoneru", "createdAt": "2021-07-15T19:25:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2NzY4Mjg4Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY3MDk1Nzg2MQ==", "url": "https://github.com/apache/ozone/pull/1494#discussion_r670957861", "bodyText": "This is done later when a setConfiguration request is executed and it calls\n\n\nOMRatisServer#addRaftPeer().\n\nYes, but notifyConfigurationChanged calls updatePeerList\n@Override\n  public void notifyConfigurationChanged(long term, long index,\n      RaftProtos.RaftConfigurationProto newRaftConfiguration) {\n    List<RaftProtos.RaftPeerProto> newPeers =\n        newRaftConfiguration.getPeersList();\n    LOG.info(\"Received Configuration change notification from Ratis. New Peer\" +\n        \" list:\\n{}\", newPeers);\n\n    List<String> newPeerIds = new ArrayList<>();\n    for (RaftProtos.RaftPeerProto raftPeerProto : newPeers) {\n      newPeerIds.add(RaftPeerId.valueOf(raftPeerProto.getId()).toString());\n    }\n    // Check and update the peer list in OzoneManager\n    ozoneManager.updatePeerList(newPeerIds);\n  }\n\nAnd in updatePeerList we have\n public void updatePeerList(List<String> omNodeIds) {\n    List<String> ratisServerPeerIdsList = omRatisServer.getPeerIds();\n    for (String omNodeId : omNodeIds) {\n      if (getOMNodeId().equals(omNodeId)) {\n        continue;\n      }\n\nWhich skips calling addRaftPeer, when it is matching with localNode ID. Let me know if I am missing something here.", "author": "bharatviswa504", "createdAt": "2021-07-16T04:32:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2NzY4Mjg4Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY3MTU2MzI3Mg==", "url": "https://github.com/apache/ozone/pull/1494#discussion_r671563272", "bodyText": "Thanks Bharat. I get it now. Should not skip the checks for local node. I have updated the patch. Thanks for catching this.", "author": "hanishakoneru", "createdAt": "2021-07-16T23:03:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2NzY4Mjg4Mg=="}], "type": "inlineReview"}, {"oid": "368f5ce9a971cb25698693acad3a7850cc766d98", "url": "https://github.com/apache/ozone/commit/368f5ce9a971cb25698693acad3a7850cc766d98", "message": "Rebase changes", "committedDate": "2021-07-14T20:05:20Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY3MDc0NDQwNQ==", "url": "https://github.com/apache/ozone/pull/1494#discussion_r670744405", "bodyText": "@bharatviswa504, in old code too, local OM node is added to raftPeers list.", "author": "hanishakoneru", "createdAt": "2021-07-15T19:21:31Z", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/ratis/OzoneManagerRatisServer.java", "diffHunk": "@@ -273,106 +483,6 @@ private OMResponse processReply(OMRequest omRequest, RaftClientReply reply)\n     }\n   }\n \n-\n-  /**\n-   * Returns an OM Ratis server.\n-   * @param conf configuration\n-   * @param om the OM instance starting the ratis server\n-   * @param raftGroupIdStr raft group id string\n-   * @param localRaftPeerId raft peer id of this Ratis server\n-   * @param addr address of the ratis server\n-   * @param raftPeers peer nodes in the raft ring\n-   * @throws IOException\n-   */\n-  @SuppressWarnings({\"parameternumber\", \"java:S107\"})\n-  private OzoneManagerRatisServer(ConfigurationSource conf,\n-      OzoneManager om,\n-      String raftGroupIdStr, RaftPeerId localRaftPeerId,\n-      InetSocketAddress addr, List<RaftPeer> raftPeers,\n-      SecurityConfig secConfig, CertificateClient certClient)\n-      throws IOException {\n-    this.ozoneManager = om;\n-    this.omRatisAddress = addr;\n-    this.port = addr.getPort();\n-    RaftProperties serverProperties = newRaftProperties(conf);\n-\n-    this.raftPeerId = localRaftPeerId;\n-    this.raftGroupId = RaftGroupId.valueOf(\n-        getRaftGroupIdFromOmServiceId(raftGroupIdStr));\n-    this.raftGroup = RaftGroup.valueOf(raftGroupId, raftPeers);\n-\n-    StringBuilder raftPeersStr = new StringBuilder();\n-    for (RaftPeer peer : raftPeers) {\n-      raftPeersStr.append(\", \").append(peer.getAddress());\n-    }\n-    LOG.info(\"Instantiating OM Ratis server with GroupID: {} and \" +\n-        \"Raft Peers: {}\", raftGroupIdStr, raftPeersStr.toString().substring(2));\n-\n-    this.omStateMachine = getStateMachine(conf);\n-\n-    Parameters parameters = createServerTlsParameters(secConfig, certClient);\n-    this.server = RaftServer.newBuilder()\n-        .setServerId(this.raftPeerId)\n-        .setGroup(this.raftGroup)\n-        .setProperties(serverProperties)\n-        .setParameters(parameters)\n-        .setStateMachine(omStateMachine)\n-        .build();\n-  }\n-\n-  /**\n-   * Creates an instance of OzoneManagerRatisServer.\n-   */\n-  public static OzoneManagerRatisServer newOMRatisServer(\n-      ConfigurationSource ozoneConf, OzoneManager omProtocol,\n-      OMNodeDetails omNodeDetails, List<OMNodeDetails> peerNodes,\n-      SecurityConfig secConfig, CertificateClient certClient)\n-      throws IOException {\n-\n-    // RaftGroupId is the omServiceId\n-    String omServiceId = omNodeDetails.getServiceId();\n-\n-    String omNodeId = omNodeDetails.getNodeId();\n-    RaftPeerId localRaftPeerId = RaftPeerId.getRaftPeerId(omNodeId);\n-\n-    InetSocketAddress ratisAddr = new InetSocketAddress(\n-        omNodeDetails.getInetAddress(), omNodeDetails.getRatisPort());\n-\n-    RaftPeer localRaftPeer = RaftPeer.newBuilder()\n-        .setId(localRaftPeerId)\n-        .setAddress(ratisAddr)\n-        .build();\n-\n-    List<RaftPeer> raftPeers = new ArrayList<>();\n-    // Add this Ratis server to the Ratis ring\n-    raftPeers.add(localRaftPeer);", "originalCommit": "84e45b7ddc04fe002a0b7a9a528e1a8d3f3951fb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY3MDk1ODIzNw==", "url": "https://github.com/apache/ozone/pull/1494#discussion_r670958237", "bodyText": "Yes, ur correct. Thanks some how i missed this part.", "author": "bharatviswa504", "createdAt": "2021-07-16T04:33:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY3MDc0NDQwNQ=="}], "type": "inlineReview"}, {"oid": "4e9068e5a3c83731aeb1d7d2e9ebc607261fd8e3", "url": "https://github.com/apache/ozone/commit/4e9068e5a3c83731aeb1d7d2e9ebc607261fd8e3", "message": "HDDS-4330. Bootstrap new OM node", "committedDate": "2021-07-20T22:32:51Z", "type": "commit"}, {"oid": "369b5ccb9b288a7b7578d5f8341e4099b0754448", "url": "https://github.com/apache/ozone/commit/369b5ccb9b288a7b7578d5f8341e4099b0754448", "message": "CI fixes 1", "committedDate": "2021-07-20T22:32:51Z", "type": "commit"}, {"oid": "f4c147b2ff799a3715944e00216530fdcd062cdc", "url": "https://github.com/apache/ozone/commit/f4c147b2ff799a3715944e00216530fdcd062cdc", "message": "CI fixes 2", "committedDate": "2021-07-20T22:32:51Z", "type": "commit"}, {"oid": "6532008e1aa14b40d4997d45bf9b42c77602f0a0", "url": "https://github.com/apache/ozone/commit/6532008e1aa14b40d4997d45bf9b42c77602f0a0", "message": "Generalize Bootstrap error code", "committedDate": "2021-07-20T22:32:51Z", "type": "commit"}, {"oid": "64974a84c4cfe11e347b7a3b1074c25d468fc3eb", "url": "https://github.com/apache/ozone/commit/64974a84c4cfe11e347b7a3b1074c25d468fc3eb", "message": "Review comments fixes", "committedDate": "2021-07-20T22:32:51Z", "type": "commit"}, {"oid": "aada9bbc654419173ec9ddd8eba073d207b6cc2d", "url": "https://github.com/apache/ozone/commit/aada9bbc654419173ec9ddd8eba073d207b6cc2d", "message": "Review comment fix", "committedDate": "2021-07-20T22:32:51Z", "type": "commit"}, {"oid": "e8bd425d9f09e73bc5ee00f676bf7de692e70edf", "url": "https://github.com/apache/ozone/commit/e8bd425d9f09e73bc5ee00f676bf7de692e70edf", "message": "CI fixes + Remove Token authorization for the new protocol", "committedDate": "2021-07-20T22:32:51Z", "type": "commit"}, {"oid": "522023112e681a00bb95bfb4e73c8acef71e88ba", "url": "https://github.com/apache/ozone/commit/522023112e681a00bb95bfb4e73c8acef71e88ba", "message": "checkstyle fix", "committedDate": "2021-07-20T22:32:51Z", "type": "commit"}, {"oid": "fbcba69d07be24819758ecbd960bddfa2303f221", "url": "https://github.com/apache/ozone/commit/fbcba69d07be24819758ecbd960bddfa2303f221", "message": "Do not add peers to bootstrapping OM ratis server during initialization", "committedDate": "2021-07-20T22:32:51Z", "type": "commit"}, {"oid": "cdb5ac7e2bc8f65c011bc4aa630698cb33125024", "url": "https://github.com/apache/ozone/commit/cdb5ac7e2bc8f65c011bc4aa630698cb33125024", "message": "checkstyle fix", "committedDate": "2021-07-20T22:32:51Z", "type": "commit"}, {"oid": "c6f0011e4a97e918da367c9fa9747c4c0c2f369c", "url": "https://github.com/apache/ozone/commit/c6f0011e4a97e918da367c9fa9747c4c0c2f369c", "message": "Rebase changes", "committedDate": "2021-07-20T22:32:51Z", "type": "commit"}, {"oid": "c8b89425e7b7e7a2222215c94970d4427556b6d0", "url": "https://github.com/apache/ozone/commit/c8b89425e7b7e7a2222215c94970d4427556b6d0", "message": "CI fixes", "committedDate": "2021-07-20T22:32:51Z", "type": "commit"}, {"oid": "fdfe7a0291c188e7a89d479c5250fd0cd8a8a68c", "url": "https://github.com/apache/ozone/commit/fdfe7a0291c188e7a89d479c5250fd0cd8a8a68c", "message": "Add bootstrapping node to peer list on receiving notifyConfigurationChange", "committedDate": "2021-07-20T22:32:51Z", "type": "commit"}, {"oid": "4c8f4ce00f8d34264d25b5324f7f1979cd10d55a", "url": "https://github.com/apache/ozone/commit/4c8f4ce00f8d34264d25b5324f7f1979cd10d55a", "message": "Checkstyle fix", "committedDate": "2021-07-20T22:32:51Z", "type": "commit"}, {"oid": "ca81e1f9e92ac8e0c3e90f64f3657d579942f0e8", "url": "https://github.com/apache/ozone/commit/ca81e1f9e92ac8e0c3e90f64f3657d579942f0e8", "message": "Fixed TestOMBootstrap", "committedDate": "2021-07-20T22:32:51Z", "type": "commit"}, {"oid": "ca81e1f9e92ac8e0c3e90f64f3657d579942f0e8", "url": "https://github.com/apache/ozone/commit/ca81e1f9e92ac8e0c3e90f64f3657d579942f0e8", "message": "Fixed TestOMBootstrap", "committedDate": "2021-07-20T22:32:51Z", "type": "forcePushed"}]}