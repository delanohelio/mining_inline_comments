{"pr_number": 1214, "pr_title": "HDDS-3981. Add more debug level log to XceiverClientGrpc for debug purpose", "pr_createdAt": "2020-07-17T16:56:03Z", "pr_url": "https://github.com/apache/ozone/pull/1214", "timeline": [{"oid": "072963126ebb6527750d0b96d973cd89e48d849b", "url": "https://github.com/apache/ozone/commit/072963126ebb6527750d0b96d973cd89e48d849b", "message": "HDDS-3981. Add more debug level log to XceiverClientGrpc for debug purpose", "committedDate": "2020-07-17T16:48:02Z", "type": "commit"}, {"oid": "39a4825267a7618b956e349c93baf2a6e5e94a4a", "url": "https://github.com/apache/ozone/commit/39a4825267a7618b956e349c93baf2a6e5e94a4a", "message": "trigger new ci check", "committedDate": "2020-07-18T01:26:12Z", "type": "commit"}, {"oid": "a49773e38c8a02d8dd59e90c54b41f307160887a", "url": "https://github.com/apache/ozone/commit/a49773e38c8a02d8dd59e90c54b41f307160887a", "message": "trigger new ci check", "committedDate": "2020-07-18T07:53:28Z", "type": "commit"}, {"oid": "e1d7e9a9b6d078007495797ba01eb7d853c1fc84", "url": "https://github.com/apache/ozone/commit/e1d7e9a9b6d078007495797ba01eb7d853c1fc84", "message": "trigger new ci check", "committedDate": "2020-07-18T11:46:35Z", "type": "commit"}, {"oid": "9e1317686b3eebcdb5eb48b0af5f4b9140be8761", "url": "https://github.com/apache/ozone/commit/9e1317686b3eebcdb5eb48b0af5f4b9140be8761", "message": "trigger new ci check", "committedDate": "2020-07-22T07:18:47Z", "type": "commit"}, {"oid": "6a3d7b3fb72011bb512eccfb4f216f239f3f6001", "url": "https://github.com/apache/ozone/commit/6a3d7b3fb72011bb512eccfb4f216f239f3f6001", "message": "trigger new ci check", "committedDate": "2020-07-22T13:50:40Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTc5MzAwNw==", "url": "https://github.com/apache/ozone/pull/1214#discussion_r461793007", "bodyText": "Full DatanodeDetails.toString() include a lot of information and can hurt the perf on critical path. Consider using either ip or uuid instead.", "author": "xiaoyuyao", "createdAt": "2020-07-28T18:40:22Z", "path": "hadoop-hdds/client/src/main/java/org/apache/hadoop/hdds/scm/XceiverClientGrpc.java", "diffHunk": "@@ -354,7 +363,7 @@ private XceiverClientReply sendCommandWithRetry(\n         responseProto = null;\n       } catch (ExecutionException e) {\n         LOG.debug(\"Failed to execute command {} on datanode {}\",\n-            request, dn.getUuid(), e);", "originalCommit": "6a3d7b3fb72011bb512eccfb4f216f239f3f6001", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjcwNDMxOQ==", "url": "https://github.com/apache/ozone/pull/1214#discussion_r462704319", "bodyText": "I hope to using ip and uuid like ip/uuid, do you think it is ok for you?\nBecause, i want to get the ip so that i can clearly know the exception related to which datanode, but in local mode, all of ips of datanode are the same, for this situation, an addition uuid can help me to distinguish.", "author": "maobaolong", "createdAt": "2020-07-30T02:55:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTc5MzAwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjY1MDEzNA==", "url": "https://github.com/apache/ozone/pull/1214#discussion_r486650134", "bodyText": "I think ip address should be sufficient for production environment. The local mode is for mini clsuter test only.", "author": "xiaoyuyao", "createdAt": "2020-09-10T21:42:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTc5MzAwNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTc5MzIyMw==", "url": "https://github.com/apache/ozone/pull/1214#discussion_r461793223", "bodyText": "This needs to be guarded by if (LOG.isDebugEnabled())", "author": "xiaoyuyao", "createdAt": "2020-07-28T18:40:48Z", "path": "hadoop-hdds/client/src/main/java/org/apache/hadoop/hdds/scm/XceiverClientGrpc.java", "diffHunk": "@@ -354,7 +363,7 @@ private XceiverClientReply sendCommandWithRetry(\n         responseProto = null;\n       } catch (ExecutionException e) {\n         LOG.debug(\"Failed to execute command {} on datanode {}\",", "originalCommit": "6a3d7b3fb72011bb512eccfb4f216f239f3f6001", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjcwNTc2MQ==", "url": "https://github.com/apache/ozone/pull/1214#discussion_r462705761", "bodyText": "I think for this case, the if (LOG.isDebugEnabled()) guard is redundancy, because, the L365 have no any need compute parameter, all arguments are reference, for the LOG.debug, lets go into the implementation of Log4jLoggerAdapter, the if (LOG.isDebugEnabled()) is there\n  public void debug(String format, Object... arguments) {\n    if (this.logger.isDebugEnabled()) {\n      FormattingTuple ft = MessageFormatter.arrayFormat(format, arguments);\n      this.logger.log(FQCN, Level.DEBUG, ft.getMessage(), ft.getThrowable());\n    }\n  }", "author": "maobaolong", "createdAt": "2020-07-30T03:00:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTc5MzIyMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjY0OTQ3OQ==", "url": "https://github.com/apache/ozone/pull/1214#discussion_r486649479", "bodyText": "Good point, you are right on this.", "author": "xiaoyuyao", "createdAt": "2020-09-10T21:41:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTc5MzIyMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTc5NDIxMQ==", "url": "https://github.com/apache/ozone/pull/1214#discussion_r461794211", "bodyText": "In sendCommandAsync() below we already have a LOG.debug(cmdType, Dn). Can you move this there to avoid duplicate debug log?", "author": "xiaoyuyao", "createdAt": "2020-07-28T18:42:42Z", "path": "hadoop-hdds/client/src/main/java/org/apache/hadoop/hdds/scm/XceiverClientGrpc.java", "diffHunk": "@@ -339,6 +343,11 @@ private XceiverClientReply sendCommandWithRetry(\n         // in case these don't exist for the specific datanode.\n         reply.addDatanode(dn);\n         responseProto = sendCommandAsync(request, dn).getResponse().get();\n+        if (LOG.isDebugEnabled()) {", "originalCommit": "6a3d7b3fb72011bb512eccfb4f216f239f3f6001", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjcwNTY2Mg==", "url": "https://github.com/apache/ozone/pull/1214#discussion_r462705662", "bodyText": "@xiaoyuyao I hope so, but I think it would be difficult, because, i want to log the retry index and cost time.\nwhen the sendCommandAsync  return back, the client still doesn't get the result from datanode. the result return until the get return.\nIf i have something wrong, please correct me.", "author": "maobaolong", "createdAt": "2020-07-30T03:00:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTc5NDIxMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjY1MjU3Mw==", "url": "https://github.com/apache/ozone/pull/1214#discussion_r486652573", "bodyText": "I mean if we could move the LOG for latency around Line 464 where the container op latency metrics are updated. This way, we can piggyback LOG with the existing metrics update.\nmetrics.addContainerOpsLatency(request.getCmdType(),\nSystem.nanoTime() - requestTime);", "author": "xiaoyuyao", "createdAt": "2020-09-10T21:48:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTc5NDIxMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODMyODEwMw==", "url": "https://github.com/apache/ozone/pull/1214#discussion_r488328103", "bodyText": "@xiaoyuyao Thanks you for your reply and suggestion. I tried to add the LOG into the L464, like following\n              public void onNext(ContainerCommandResponseProto value) {\n                replyFuture.complete(value);\n                metrics.decrPendingContainerOpsMetrics(request.getCmdType());\n                long cost = System.nanoTime() - requestTime;\n                metrics.addContainerOpsLatency(request.getCmdType(),\n                    cost);\n                if (LOG.isDebugEnabled()) {\n                  LOG.debug(\"Executed command {} on datanode {}, cost = {}, \"\n                          + \"retryCount = {}\" + \", cmdType = {}\", request, dn,\n                      cost, index, request.getCmdType());\n                }\n                semaphore.release();\n              }\nBut, there are some question\n\nIt cannot print the Index which stand for the retried datanode index of the datanodeList.\nI should add the same log logic to the onError also? Otherwise, when we met error, the onNext won't be executed.\n\nAs index can be calculate from the log context, I drop it.", "author": "maobaolong", "createdAt": "2020-09-15T01:29:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTc5NDIxMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDc0OTc0Nw==", "url": "https://github.com/apache/ozone/pull/1214#discussion_r464749747", "bodyText": "Correct me if I'm wrong, I think we have already print the same debug message on Line 338-340 from the caller. Print just the IP address should be sufficient.", "author": "xiaoyuyao", "createdAt": "2020-08-04T01:41:12Z", "path": "hadoop-hdds/client/src/main/java/org/apache/hadoop/hdds/scm/XceiverClientGrpc.java", "diffHunk": "@@ -433,7 +442,7 @@ public XceiverClientReply sendCommandAsync(\n     UUID dnId = dn.getUuid();\n     if (LOG.isDebugEnabled()) {\n       LOG.debug(\"Send command {} to datanode {}\",\n-          request.getCmdType(), dn.getNetworkFullPath());\n+          request.getCmdType(), dn);", "originalCommit": "6a3d7b3fb72011bb512eccfb4f216f239f3f6001", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzY2MjM5NQ==", "url": "https://github.com/apache/ozone/pull/1214#discussion_r467662395", "bodyText": "OK, you are right, the redundancy log content is useless, I've change it to dn.getIpAddress().", "author": "maobaolong", "createdAt": "2020-08-10T02:20:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDc0OTc0Nw=="}], "type": "inlineReview"}, {"oid": "6a7a413f2d42e7ddda9e3695175c76145ed9d211", "url": "https://github.com/apache/ozone/commit/6a7a413f2d42e7ddda9e3695175c76145ed9d211", "message": "Address comments, log the ip address o dn only.", "committedDate": "2020-08-10T02:14:39Z", "type": "commit"}, {"oid": "0f027d854c2d94f14de8b4504c68fa21a6937240", "url": "https://github.com/apache/ozone/commit/0f027d854c2d94f14de8b4504c68fa21a6937240", "message": "Address comment, move the debug log into sendCommandAsync", "committedDate": "2020-09-15T01:29:22Z", "type": "commit"}]}