{"pr_number": 1164, "pr_title": "HDDS-3824: OM read requests should make SCM#refreshPipeline outside BUCKET_LOCK", "pr_createdAt": "2020-07-06T06:11:08Z", "pr_url": "https://github.com/apache/ozone/pull/1164", "timeline": [{"oid": "2511f13871a1f3869f5375639d4fcd81a303af1f", "url": "https://github.com/apache/ozone/commit/2511f13871a1f3869f5375639d4fcd81a303af1f", "message": "HDDS-3824: OM read requests should make SCM#refreshPipeline outside the BUCKET_LOCK", "committedDate": "2020-07-06T06:07:42Z", "type": "commit"}, {"oid": "ea1206929d39031343fc19969f5a475c65f46f75", "url": "https://github.com/apache/ozone/commit/ea1206929d39031343fc19969f5a475c65f46f75", "message": "HDDS-3824: Fixed checkstyle warnings", "committedDate": "2020-07-07T05:30:11Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTEyMjIwNA==", "url": "https://github.com/apache/ozone/pull/1164#discussion_r451122204", "bodyText": "should we order datanodes when the key is a file for caller like getFileStatus?", "author": "xiaoyuyao", "createdAt": "2020-07-07T20:24:50Z", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/KeyManagerImpl.java", "diffHunk": "@@ -1706,36 +1718,41 @@ public OzoneFileStatus getFileStatus(OmKeyArgs args) throws IOException {\n \n       // Check if the key is a file.\n       String fileKeyBytes = metadataManager.getOzoneKey(\n-          volumeName, bucketName, keyName);\n-      OmKeyInfo fileKeyInfo = metadataManager.getKeyTable().get(fileKeyBytes);\n+              volumeName, bucketName, keyName);\n+      fileKeyInfo = metadataManager.getKeyTable().get(fileKeyBytes);\n+\n+      // Check if the key is a directory.\n+      if (fileKeyInfo == null) {\n+        String dirKey = OzoneFSUtils.addTrailingSlashIfNeeded(keyName);\n+        String dirKeyBytes = metadataManager.getOzoneKey(\n+                volumeName, bucketName, dirKey);\n+        OmKeyInfo dirKeyInfo = metadataManager.getKeyTable().get(dirKeyBytes);\n+        if (dirKeyInfo != null) {\n+          return new OzoneFileStatus(dirKeyInfo, scmBlockSize, true);\n+        }\n+      }\n+    } finally {\n+      metadataManager.getLock().releaseReadLock(BUCKET_LOCK, volumeName,\n+              bucketName);\n+\n+      // if the key is a file then do refresh pipeline info in OM by asking SCM\n       if (fileKeyInfo != null) {\n-        if (args.getRefreshPipeline()) {\n+        if (refreshPipeline) {\n           refreshPipeline(fileKeyInfo);\n         }", "originalCommit": "ea1206929d39031343fc19969f5a475c65f46f75", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTMyNzY4Mw==", "url": "https://github.com/apache/ozone/pull/1164#discussion_r451327683", "bodyText": "Thanks for the review. Good point. For sorting dns, we need to introduce a new arg clientAddress to APIs listStatus, getFileStatus interfaces.\nNeed to pass a new argument clientAddress like lookupFile API. Can we do interface changes in a separate jira task ?", "author": "rakeshadr", "createdAt": "2020-07-08T07:08:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTEyMjIwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjE5NjQ3MQ==", "url": "https://github.com/apache/ozone/pull/1164#discussion_r452196471", "bodyText": "@xiaoyuyao, IMHO, your proposal is unrelated to this perf changes and for focussed reviews/commits I have created HDDS-3947 jira to handle your comment. Hope this is fine with you. Thanks!", "author": "rakeshadr", "createdAt": "2020-07-09T12:56:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTEyMjIwNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTIwOTEyMQ==", "url": "https://github.com/apache/ozone/pull/1164#discussion_r451209121", "bodyText": "Can we also move the generation of the secret token also outside of the lock?", "author": "bharatviswa504", "createdAt": "2020-07-08T00:02:16Z", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/KeyManagerImpl.java", "diffHunk": "@@ -659,15 +660,6 @@ public OmKeyInfo lookupKey(OmKeyArgs args, String clientAddress)\n           });\n         }\n       }\n-      // Refresh container pipeline info from SCM", "originalCommit": "ea1206929d39031343fc19969f5a475c65f46f75", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTMzNTY4OA==", "url": "https://github.com/apache/ozone/pull/1164#discussion_r451335688", "bodyText": "Thanks for the review. Sure, will do it.", "author": "rakeshadr", "createdAt": "2020-07-08T07:24:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTIwOTEyMQ=="}], "type": "inlineReview"}, {"oid": "35471063461c8978378b19ac7123e9f9b848aa59", "url": "https://github.com/apache/ozone/commit/35471063461c8978378b19ac7123e9f9b848aa59", "message": "HDDS-3824: Fixed review comment - generating of the secret token can also be moved outside lock", "committedDate": "2020-07-08T07:26:55Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzkxNzc3OA==", "url": "https://github.com/apache/ozone/pull/1164#discussion_r453917778", "bodyText": "The last parameter of getOzoneFileStatus() should have refreshPipeline handled already. Can we pass args.getRefreshPipeline() on line 1901?", "author": "xiaoyuyao", "createdAt": "2020-07-13T20:37:58Z", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/KeyManagerImpl.java", "diffHunk": "@@ -1877,26 +1897,18 @@ public OmKeyInfo lookupFile(OmKeyArgs args, String clientAddress)\n     String volumeName = args.getVolumeName();\n     String bucketName = args.getBucketName();\n     String keyName = args.getKeyName();\n-\n-    metadataManager.getLock().acquireReadLock(BUCKET_LOCK, volumeName,\n-        bucketName);\n-    try {\n-      OzoneFileStatus fileStatus = getFileStatus(args);\n-      if (fileStatus.isFile()) {\n-        if (args.getRefreshPipeline()) {\n-          refreshPipeline(fileStatus.getKeyInfo());\n-        }\n-        if (args.getSortDatanodes()) {\n-          sortDatanodeInPipeline(fileStatus.getKeyInfo(), clientAddress);\n-        }\n-        return fileStatus.getKeyInfo();\n-      }\n+    OzoneFileStatus fileStatus = getOzoneFileStatus(volumeName, bucketName,\n+            keyName, false);\n       //if key is not of type file or if key is not found we throw an exception\n-    } finally {\n-      metadataManager.getLock().releaseReadLock(BUCKET_LOCK, volumeName,\n-          bucketName);\n+    if (fileStatus != null && fileStatus.isFile()) {\n+      if (args.getRefreshPipeline()) {\n+        refreshPipeline(fileStatus.getKeyInfo());", "originalCommit": "35471063461c8978378b19ac7123e9f9b848aa59", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDEwNDA0MQ==", "url": "https://github.com/apache/ozone/pull/1164#discussion_r454104041", "bodyText": "Done", "author": "rakeshadr", "createdAt": "2020-07-14T05:08:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzkxNzc3OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzkxODA4OQ==", "url": "https://github.com/apache/ozone/pull/1164#discussion_r453918089", "bodyText": "NIT: sortDatanodes can be handled similarly in getOzoneFileStatus?", "author": "xiaoyuyao", "createdAt": "2020-07-13T20:38:31Z", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/KeyManagerImpl.java", "diffHunk": "@@ -1877,26 +1897,18 @@ public OmKeyInfo lookupFile(OmKeyArgs args, String clientAddress)\n     String volumeName = args.getVolumeName();\n     String bucketName = args.getBucketName();\n     String keyName = args.getKeyName();\n-\n-    metadataManager.getLock().acquireReadLock(BUCKET_LOCK, volumeName,\n-        bucketName);\n-    try {\n-      OzoneFileStatus fileStatus = getFileStatus(args);\n-      if (fileStatus.isFile()) {\n-        if (args.getRefreshPipeline()) {\n-          refreshPipeline(fileStatus.getKeyInfo());\n-        }\n-        if (args.getSortDatanodes()) {\n-          sortDatanodeInPipeline(fileStatus.getKeyInfo(), clientAddress);\n-        }\n-        return fileStatus.getKeyInfo();\n-      }\n+    OzoneFileStatus fileStatus = getOzoneFileStatus(volumeName, bucketName,\n+            keyName, false);\n       //if key is not of type file or if key is not found we throw an exception\n-    } finally {\n-      metadataManager.getLock().releaseReadLock(BUCKET_LOCK, volumeName,\n-          bucketName);\n+    if (fileStatus != null && fileStatus.isFile()) {\n+      if (args.getRefreshPipeline()) {\n+        refreshPipeline(fileStatus.getKeyInfo());\n+      }\n+      if (args.getSortDatanodes()) {", "originalCommit": "35471063461c8978378b19ac7123e9f9b848aa59", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDEwNDExMw==", "url": "https://github.com/apache/ozone/pull/1164#discussion_r454104113", "bodyText": "Done", "author": "rakeshadr", "createdAt": "2020-07-14T05:08:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzkxODA4OQ=="}], "type": "inlineReview"}, {"oid": "c500b2a829b73dc85c6c867f0e56902606e0a352", "url": "https://github.com/apache/ozone/commit/c500b2a829b73dc85c6c867f0e56902606e0a352", "message": "HDDS-3824: Review comments", "committedDate": "2020-07-14T05:03:34Z", "type": "commit"}, {"oid": "fc330f26f0e43e97c9ea7a1a20c0e2e655787e6c", "url": "https://github.com/apache/ozone/commit/fc330f26f0e43e97c9ea7a1a20c0e2e655787e6c", "message": "trigger new CI check", "committedDate": "2020-07-14T06:47:15Z", "type": "commit"}, {"oid": "69a210011a6a62f856e1b81b5a8848685536fd7a", "url": "https://github.com/apache/ozone/commit/69a210011a6a62f856e1b81b5a8848685536fd7a", "message": "trigger new CI check", "committedDate": "2020-07-14T09:17:43Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDU0NzI1NA==", "url": "https://github.com/apache/ozone/pull/1164#discussion_r454547254", "bodyText": "I'm +1 on this JIRA.\nCan we file a follow up JIRA to allow batching refreshPipeline call instead of individual calls to save RPC traffic.", "author": "xiaoyuyao", "createdAt": "2020-07-14T18:08:56Z", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/KeyManagerImpl.java", "diffHunk": "@@ -2083,6 +2092,11 @@ private void listStatusFindKeyInTableCache(\n       metadataManager.getLock().releaseReadLock(BUCKET_LOCK, volumeName,\n           bucketName);\n     }\n+    if (args.getRefreshPipeline()) {\n+      for(OzoneFileStatus fileStatus : fileStatusList){\n+        refreshPipeline(fileStatus.getKeyInfo());", "originalCommit": "69a210011a6a62f856e1b81b5a8848685536fd7a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDc4OTgxMw==", "url": "https://github.com/apache/ozone/pull/1164#discussion_r454789813", "bodyText": "Thanks @xiaoyuyao , I have raised HDDS-3961 to handle this case.", "author": "rakeshadr", "createdAt": "2020-07-15T04:50:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDU0NzI1NA=="}], "type": "inlineReview"}]}