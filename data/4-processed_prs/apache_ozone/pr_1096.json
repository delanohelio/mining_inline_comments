{"pr_number": 1096, "pr_title": "HDDS-3833. Use Pipeline choose policy to choose pipeline from exist pipeline list", "pr_createdAt": "2020-06-19T02:15:56Z", "pr_url": "https://github.com/apache/ozone/pull/1096", "timeline": [{"oid": "968748986a9b22f80167dfeab2789444283c1216", "url": "https://github.com/apache/ozone/commit/968748986a9b22f80167dfeab2789444283c1216", "message": "HDDS-3833. Use Pipeline choose policy to choose pipeline from exist pipeline list", "committedDate": "2020-06-19T02:34:25Z", "type": "forcePushed"}, {"oid": "087cefaa812fa84c2044bc1fd73d48be3b63e375", "url": "https://github.com/apache/ozone/commit/087cefaa812fa84c2044bc1fd73d48be3b63e375", "message": "HDDS-3833. Use Pipeline choose policy to choose pipeline from exist pipeline list", "committedDate": "2020-06-19T02:59:21Z", "type": "forcePushed"}, {"oid": "370cbb0f53dcc8410ae21a49dc5f5e65a3e7d312", "url": "https://github.com/apache/ozone/commit/370cbb0f53dcc8410ae21a49dc5f5e65a3e7d312", "message": "HDDS-3833. Use Pipeline choose policy to choose pipeline from exist pipeline list", "committedDate": "2020-06-19T14:00:27Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTU3NTM3Mw==", "url": "https://github.com/apache/ozone/pull/1096#discussion_r459575373", "bodyText": "nit. Suggest rename ozone.scm.pipeline.choose.impl --> ozone.scm.pipeline.choose.policy.impl", "author": "avijayanhwx", "createdAt": "2020-07-23T16:26:50Z", "path": "hadoop-hdds/common/src/main/java/org/apache/hadoop/hdds/scm/ScmConfigKeys.java", "diffHunk": "@@ -287,6 +287,9 @@\n   public static final String OZONE_SCM_PIPELINE_OWNER_CONTAINER_COUNT =\n       \"ozone.scm.pipeline.owner.container.count\";\n   public static final int OZONE_SCM_PIPELINE_OWNER_CONTAINER_COUNT_DEFAULT = 3;\n+  // Pipeline choose policy:\n+  public static final String OZONE_SCM_PIPELINE_CHOOSE_IMPL_KEY =\n+      \"ozone.scm.pipeline.choose.impl\";", "originalCommit": "8dfadd99d7b8320bb454d74863cadb5146345b0e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTg1NTY4NQ==", "url": "https://github.com/apache/ozone/pull/1096#discussion_r459855685", "bodyText": "Done.", "author": "maobaolong", "createdAt": "2020-07-24T05:16:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTU3NTM3Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTU3Nzk5OA==", "url": "https://github.com/apache/ozone/pull/1096#discussion_r459577998", "bodyText": "@maobaolong For my knowledge, can you list a few pipeline selection policies that you envision? I am wondering if we are OK with just a List<Pipeline> as an argument.", "author": "avijayanhwx", "createdAt": "2020-07-23T16:31:03Z", "path": "hadoop-hdds/common/src/main/java/org/apache/hadoop/hdds/scm/PipelineChoosePolicy.java", "diffHunk": "@@ -0,0 +1,36 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with this\n+ * work for additional information regarding copyright ownership.  The ASF\n+ * licenses this file to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ * <p>\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ * <p>\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package org.apache.hadoop.hdds.scm;\n+\n+import org.apache.hadoop.hdds.scm.pipeline.Pipeline;\n+\n+import java.util.List;\n+\n+/**\n+ * A {@link PipelineChoosePolicy} support choosing pipeline from exist list.\n+ */\n+public interface PipelineChoosePolicy {\n+\n+  /**\n+   * Given an initial list of pipelines, return one of the pipelines.\n+   *\n+   * @param pipelineList list of pipelines.\n+   * @return one of the pipelines.\n+   */\n+  Pipeline choosePipeline(List<Pipeline> pipelineList);", "originalCommit": "8dfadd99d7b8320bb454d74863cadb5146345b0e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDA2Mzc0Mg==", "url": "https://github.com/apache/ozone/pull/1096#discussion_r460063742", "bodyText": "@avijayanhwx Thank you for your suggestion, I add a arguments map, for extension purpose, i use Object type as value type.", "author": "maobaolong", "createdAt": "2020-07-24T13:49:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTU3Nzk5OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTU3ODU4Ng==", "url": "https://github.com/apache/ozone/pull/1096#discussion_r459578586", "bodyText": "We could get a runtime exception from a plugged in policy. Can we have to fallback to default (Random) on error after logging?", "author": "avijayanhwx", "createdAt": "2020-07-23T16:32:05Z", "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/block/BlockManagerImpl.java", "diffHunk": "@@ -222,9 +224,7 @@ public AllocatedBlock allocateBlock(final long size, ReplicationType type,\n       }\n \n       if (null == pipeline) {\n-        // TODO: #CLUTIL Make the selection policy driven.\n-        pipeline = availablePipelines\n-            .get((int) (Math.random() * availablePipelines.size()));\n+        pipeline = pipelineChoosePolicy.choosePipeline(availablePipelines);", "originalCommit": "8dfadd99d7b8320bb454d74863cadb5146345b0e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTg1ODA2NA==", "url": "https://github.com/apache/ozone/pull/1096#discussion_r459858064", "bodyText": "Done.", "author": "maobaolong", "createdAt": "2020-07-24T05:28:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTU3ODU4Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTU4NzM5NA==", "url": "https://github.com/apache/ozone/pull/1096#discussion_r459587394", "bodyText": "We are relying on default constructor here. And we pass in only List<Pipeline> through the API. We may have policies that need more information like the topology, client address etc as well. Can we make sure we support them without change of interface later?", "author": "avijayanhwx", "createdAt": "2020-07-23T16:46:57Z", "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/pipeline/choose/algorithms/PipelineChoosePolicyFactory.java", "diffHunk": "@@ -0,0 +1,71 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hadoop.hdds.scm.pipeline.choose.algorithms;\n+\n+import org.apache.hadoop.hdds.conf.ConfigurationSource;\n+import org.apache.hadoop.hdds.scm.PipelineChoosePolicy;\n+import org.apache.hadoop.hdds.scm.ScmConfigKeys;\n+import org.apache.hadoop.hdds.scm.exceptions.SCMException;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.lang.reflect.Constructor;\n+\n+/**\n+ * A factory to create pipeline choose policy instance based on configuration\n+ * property {@link ScmConfigKeys#OZONE_SCM_PIPELINE_CHOOSE_IMPL_KEY}.\n+ */\n+public final class PipelineChoosePolicyFactory {\n+  private static final Logger LOG =\n+      LoggerFactory.getLogger(PipelineChoosePolicyFactory.class);\n+\n+  private static final Class<? extends PipelineChoosePolicy>\n+      OZONE_SCM_PIPELINE_CHOOSE_IMPL_DEFAULT =\n+      RandomPipelineChoosePolicy.class;\n+\n+  private PipelineChoosePolicyFactory() {\n+  }\n+\n+  public static PipelineChoosePolicy getPolicy(\n+      ConfigurationSource conf) throws SCMException {\n+    final Class<? extends PipelineChoosePolicy> policyClass = conf\n+        .getClass(ScmConfigKeys.OZONE_SCM_PIPELINE_CHOOSE_IMPL_KEY,\n+            OZONE_SCM_PIPELINE_CHOOSE_IMPL_DEFAULT,\n+            PipelineChoosePolicy.class);\n+    Constructor<? extends PipelineChoosePolicy> constructor;\n+    try {\n+      constructor = policyClass.getDeclaredConstructor();", "originalCommit": "8dfadd99d7b8320bb454d74863cadb5146345b0e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDA2NzIyMQ==", "url": "https://github.com/apache/ozone/pull/1096#discussion_r460067221", "bodyText": "Now it cannot get the client address while allocate block. After this PR, we can create a new ticket to add client parameter to the allocateblock method, then, I can write a localFirstPolicy. Also, I plan to let datanode report its utilized to scm, so i can implement a LowLoadFirstPolicy, we can also collect the pipeline vote count, batch size, use these information, we can get write many kind of choose pipeline policy.", "author": "maobaolong", "createdAt": "2020-07-24T13:55:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTU4NzM5NA=="}], "type": "inlineReview"}, {"oid": "3596e41a01913227197620c318f32a892076d848", "url": "https://github.com/apache/ozone/commit/3596e41a01913227197620c318f32a892076d848", "message": "HDDS-3833. Use Pipeline choose policy to choose pipeline from exist pipeline list", "committedDate": "2020-07-24T04:51:31Z", "type": "commit"}, {"oid": "3596e41a01913227197620c318f32a892076d848", "url": "https://github.com/apache/ozone/commit/3596e41a01913227197620c318f32a892076d848", "message": "HDDS-3833. Use Pipeline choose policy to choose pipeline from exist pipeline list", "committedDate": "2020-07-24T04:51:31Z", "type": "forcePushed"}, {"oid": "54bc1eaab1d4be8e3320061b1b1357915e4ff641", "url": "https://github.com/apache/ozone/commit/54bc1eaab1d4be8e3320061b1b1357915e4ff641", "message": "HDDS-3833. Address comments, rename the key, add fallback code.", "committedDate": "2020-07-24T05:27:01Z", "type": "commit"}, {"oid": "1d48df448f73400bf52e672c8844932de2700aea", "url": "https://github.com/apache/ozone/commit/1d48df448f73400bf52e672c8844932de2700aea", "message": "HDDS-3833. Address comments. Add a new policy.", "committedDate": "2020-07-24T13:44:54Z", "type": "commit"}, {"oid": "85f829231161c35c80014b27d3da94b7ee6841c7", "url": "https://github.com/apache/ozone/commit/85f829231161c35c80014b27d3da94b7ee6841c7", "message": "fix style.", "committedDate": "2020-07-24T13:53:29Z", "type": "commit"}, {"oid": "7bdcbb95a31a18382e2b6b9c14f8722916e5525c", "url": "https://github.com/apache/ozone/commit/7bdcbb95a31a18382e2b6b9c14f8722916e5525c", "message": "Correct the ozone-default.xml", "committedDate": "2020-07-25T00:07:16Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDc1OTY2OA==", "url": "https://github.com/apache/ozone/pull/1096#discussion_r460759668", "bodyText": "I would prefer to use the new, Java based configuration API:\nhttps://cwiki.apache.org/confluence/display/HADOOP/Java-based+configuration+API", "author": "elek", "createdAt": "2020-07-27T09:22:19Z", "path": "hadoop-hdds/common/src/main/resources/ozone-default.xml", "diffHunk": "@@ -814,6 +814,20 @@\n       value.\n     </description>\n   </property>\n+  <property>", "originalCommit": "7bdcbb95a31a18382e2b6b9c14f8722916e5525c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDc1OTcwNA==", "url": "https://github.com/apache/ozone/pull/1096#discussion_r460759704", "bodyText": "Proto.lock file change should be excluded. the proto.lock should represent and old state: the last released state to use it as a base for comparison.\nRebase to the latest master and you won't see the changed proto lock files (which makes it easy to add lock files accidentally)", "author": "elek", "createdAt": "2020-07-27T09:22:22Z", "path": "hadoop-hdds/interface-server/src/main/resources/proto.lock", "diffHunk": "@@ -1209,6 +1209,10 @@\n               {\n                 \"name\": \"INTERNAL_ERROR\",\n                 \"integer\": 29\n+              },", "originalCommit": "7bdcbb95a31a18382e2b6b9c14f8722916e5525c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDc2MjQ3Ng==", "url": "https://github.com/apache/ozone/pull/1096#discussion_r460762476", "bodyText": "It seems to be a standard parameter which is added to all the implementation. Wouldn't be better to add it as a type-safe field? Or we can use a PipelineRequestInformation class instead of the Map<String,Object> if you would like to make it easier to add more information latest.", "author": "elek", "createdAt": "2020-07-27T09:27:05Z", "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/block/BlockManagerImpl.java", "diffHunk": "@@ -222,9 +224,11 @@ public AllocatedBlock allocateBlock(final long size, ReplicationType type,\n       }\n \n       if (null == pipeline) {\n-        // TODO: #CLUTIL Make the selection policy driven.\n-        pipeline = availablePipelines\n-            .get((int) (Math.random() * availablePipelines.size()));\n+        Map<String, Object> params = new HashMap<>();\n+        params.put(\n+            PipelineChoosePolicy.PIPELINE_CHOOSE_POLICY_PARAM_SIZE, size);\n+        pipeline = pipelineChoosePolicy.choosePipeline(", "originalCommit": "7bdcbb95a31a18382e2b6b9c14f8722916e5525c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "c7b62a3c5072a07fa473e944df3c615c95167d7b", "url": "https://github.com/apache/ozone/commit/c7b62a3c5072a07fa473e944df3c615c95167d7b", "message": "Address comments, create PipelineRequestInformation as the general parameter entity.", "committedDate": "2020-07-30T16:43:47Z", "type": "commit"}, {"oid": "b16249d1135ed68e8e86324e33f7f1a1f71791fd", "url": "https://github.com/apache/ozone/commit/b16249d1135ed68e8e86324e33f7f1a1f71791fd", "message": "Revert proto.lock", "committedDate": "2020-07-30T16:45:08Z", "type": "commit"}, {"oid": "d9381169bfec5a38d365d82a0ce5fb1a62658368", "url": "https://github.com/apache/ozone/commit/d9381169bfec5a38d365d82a0ce5fb1a62658368", "message": "Merge branch 'master' of https://github.com/apache/hadoop-ozone into choosePipelinePolicy", "committedDate": "2020-07-30T16:46:42Z", "type": "commit"}, {"oid": "5e9a2035cf7813087d87400cfea10d5a435af029", "url": "https://github.com/apache/ozone/commit/5e9a2035cf7813087d87400cfea10d5a435af029", "message": "Use Java based configuration API to write config.", "committedDate": "2020-07-30T17:23:14Z", "type": "commit"}, {"oid": "9b7cfc563d66a169093e5e09fbcd38f6d2afc9c2", "url": "https://github.com/apache/ozone/commit/9b7cfc563d66a169093e5e09fbcd38f6d2afc9c2", "message": "fix style.", "committedDate": "2020-07-30T17:26:00Z", "type": "commit"}, {"oid": "399d574b682fc4155def121630d812721b60847b", "url": "https://github.com/apache/ozone/commit/399d574b682fc4155def121630d812721b60847b", "message": "Add some tests.", "committedDate": "2020-07-30T23:36:39Z", "type": "commit"}, {"oid": "399d574b682fc4155def121630d812721b60847b", "url": "https://github.com/apache/ozone/commit/399d574b682fc4155def121630d812721b60847b", "message": "Add some tests.", "committedDate": "2020-07-30T23:36:39Z", "type": "forcePushed"}, {"oid": "8f3769db087d32785f3725a803ec2f298a69851a", "url": "https://github.com/apache/ozone/commit/8f3769db087d32785f3725a803ec2f298a69851a", "message": "fix test failed", "committedDate": "2020-07-31T00:56:51Z", "type": "commit"}]}