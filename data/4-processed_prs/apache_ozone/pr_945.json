{"pr_number": 945, "pr_title": "HDDS-3622. Implement rocksdb tool to parse scm db", "pr_createdAt": "2020-05-19T17:59:27Z", "pr_url": "https://github.com/apache/ozone/pull/945", "timeline": [{"oid": "1f13010ad4009f1099e025a2a6961e876a61c5aa", "url": "https://github.com/apache/ozone/commit/1f13010ad4009f1099e025a2a6961e876a61c5aa", "message": "HDDS-3622.Implement rocksdb tool to parse scm db", "committedDate": "2020-05-19T17:52:39Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzQ5NzM5MA==", "url": "https://github.com/apache/ozone/pull/945#discussion_r427497390", "bodyText": "Please expand wildcard imports.", "author": "mukul1987", "createdAt": "2020-05-19T18:03:09Z", "path": "hadoop-ozone/tools/src/main/java/org/apache/hadoop/ozone/debug/ListTables.java", "diffHunk": "@@ -0,0 +1,58 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ *  with the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  Unless required by applicable law or agreed to in writing, software\n+ *  distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *  See the License for the specific language governing permissions and\n+ *  limitations under the License.\n+ */\n+\n+package org.apache.hadoop.ozone.debug;\n+\n+import org.rocksdb.*;", "originalCommit": "1f13010ad4009f1099e025a2a6961e876a61c5aa", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzQ5ODUzNQ==", "url": "https://github.com/apache/ozone/pull/945#discussion_r427498535", "bodyText": "after extending GenericCli, we will not need this change.", "author": "mukul1987", "createdAt": "2020-05-19T18:05:09Z", "path": "hadoop-ozone/tools/src/main/java/org/apache/hadoop/ozone/debug/ListTables.java", "diffHunk": "@@ -0,0 +1,58 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ *  with the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  Unless required by applicable law or agreed to in writing, software\n+ *  distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *  See the License for the specific language governing permissions and\n+ *  limitations under the License.\n+ */\n+\n+package org.apache.hadoop.ozone.debug;\n+\n+import org.rocksdb.*;\n+import picocli.CommandLine;\n+\n+import java.nio.charset.StandardCharsets;\n+import java.util.List;\n+import java.util.concurrent.Callable;\n+\n+/**\n+ * List all column Families/Tables in db.\n+ */\n+@CommandLine.Command(\n+        name = \"list\",\n+        description = \"list all tables in db.\"\n+)\n+public class ListTables implements Callable<Void> {\n+\n+  @CommandLine.ParentCommand\n+  private RDBParser parent;\n+\n+  @Override\n+  public Void call() throws Exception {\n+    List<byte[]> cfList = getColumnFamilyList(parent.getDbPath());\n+    for (byte[] b : cfList) {\n+      System.out.println(new String(b, StandardCharsets.UTF_8));\n+    }\n+    return null;\n+  }\n+\n+  private static List<byte[]> getColumnFamilyList(String dbPath) {\n+    List<byte[]> cfList = null;\n+    try {\n+      cfList = RocksDB.listColumnFamilies(new Options(), dbPath);\n+    } catch (RocksDBException e) {\n+      e.printStackTrace();", "originalCommit": "1f13010ad4009f1099e025a2a6961e876a61c5aa", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzQ5OTYxNg==", "url": "https://github.com/apache/ozone/pull/945#discussion_r427499616", "bodyText": "lets check for null here as if the table name doesn't match, we can throw NPE.", "author": "mukul1987", "createdAt": "2020-05-19T18:06:55Z", "path": "hadoop-ozone/tools/src/main/java/org/apache/hadoop/ozone/debug/SCMDBParser.java", "diffHunk": "@@ -0,0 +1,120 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ *  with the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  Unless required by applicable law or agreed to in writing, software\n+ *  distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *  See the License for the specific language governing permissions and\n+ *  limitations under the License.\n+ */\n+\n+package org.apache.hadoop.ozone.debug;\n+\n+import org.apache.hadoop.hdds.utils.db.DBColumnFamilyDefinition;\n+import org.rocksdb.*;\n+import picocli.CommandLine;\n+\n+import java.io.IOException;\n+import java.nio.charset.StandardCharsets;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.List;\n+import java.util.concurrent.Callable;\n+\n+/**\n+ * Parser for scm.db file.\n+ */\n+@CommandLine.Command(\n+        name = \"scmdbparser\",\n+        description = \"Parse specified metadataTable\"\n+)\n+public class SCMDBParser implements Callable<Void> {\n+\n+  @CommandLine.Option(names = {\"-table\"},\n+            description = \"Table name\")\n+  private String tableName;\n+\n+  @CommandLine.ParentCommand\n+  private RDBParser parent;\n+\n+\n+  private static void displayTable(RocksDB rocksDB,\n+        DBColumnFamilyDefinition dbColumnFamilyDefinition,\n+        List<ColumnFamilyHandle> list) throws IOException {\n+    ColumnFamilyHandle columnFamilyHandle = getColumnFamilyHandle(\n+            dbColumnFamilyDefinition.getTableName()\n+                    .getBytes(StandardCharsets.UTF_8), list);\n+    RocksIterator iterator = rocksDB.newIterator(columnFamilyHandle);", "originalCommit": "1f13010ad4009f1099e025a2a6961e876a61c5aa", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzUwMDM0Nw==", "url": "https://github.com/apache/ozone/pull/945#discussion_r427500347", "bodyText": "This map should be constructed from SCM DB definition.", "author": "mukul1987", "createdAt": "2020-05-19T18:08:09Z", "path": "hadoop-ozone/tools/src/main/java/org/apache/hadoop/ozone/debug/RDBParser.java", "diffHunk": "@@ -0,0 +1,74 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ *  with the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  Unless required by applicable law or agreed to in writing, software\n+ *  distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *  See the License for the specific language governing permissions and\n+ *  limitations under the License.\n+ */\n+\n+package org.apache.hadoop.ozone.debug;\n+\n+import org.apache.hadoop.hdds.cli.GenericCli;\n+import org.apache.hadoop.hdds.scm.metadata.SCMDBDefinition;\n+import org.apache.hadoop.hdds.utils.db.DBColumnFamilyDefinition;\n+import picocli.CommandLine;\n+\n+import java.util.HashMap;\n+\n+/**\n+ * Tool that parses rocksdb file.\n+ */\n+@CommandLine.Command(\n+        name = \"rdbparser\",\n+        description = \"Parse rocksdb file content\",\n+        subcommands = {\n+                SCMDBParser.class,\n+                ListTables.class\n+        })\n+public class RDBParser extends GenericCli {\n+\n+  @CommandLine.Option(names = {\"-path\"},\n+            description = \"Database File Path\")\n+    private String dbPath;\n+\n+  public static HashMap<String, DBColumnFamilyDefinition>\n+      getColumnFamilyMap() {\n+    return columnFamilyMap;\n+  }\n+\n+  private static HashMap<String, DBColumnFamilyDefinition>  columnFamilyMap;\n+\n+  public String getDbPath() {\n+    return dbPath;\n+  }\n+\n+  static {\n+    columnFamilyMap = constructColumnFamilyMap();\n+  }\n+\n+  private static HashMap<String, DBColumnFamilyDefinition>\n+      constructColumnFamilyMap() {\n+    columnFamilyMap = new HashMap<String, DBColumnFamilyDefinition>();", "originalCommit": "1f13010ad4009f1099e025a2a6961e876a61c5aa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzUwMTA1OQ==", "url": "https://github.com/apache/ozone/pull/945#discussion_r427501059", "bodyText": "This can be replaced with getColumnFamilies, and then a table created out of that.", "author": "mukul1987", "createdAt": "2020-05-19T18:09:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzUwMDM0Nw=="}], "type": "inlineReview"}, {"oid": "0de770297d492206904ebb5547bd6c64fb0cc8ae", "url": "https://github.com/apache/ozone/commit/0de770297d492206904ebb5547bd6c64fb0cc8ae", "message": "addressed review comments", "committedDate": "2020-05-20T06:11:34Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODY1MzA3Nw==", "url": "https://github.com/apache/ozone/pull/945#discussion_r428653077", "bodyText": "Nit1: I am not sure if we need a separated method just to call this function.\nList<byte[]> columnFamilies = RocksDB.listColumnFamilies(new Options(), parent.getDbPath);\nNit2: I tend to agree with Uncle Bob, that we don't need to include the type of a variable in the name of the variable:\n\nHungarian Notation was considered to be pretty important back in the Windows C API, when everything was an integer handle or a long pointer or a void pointer, or one of several implementations of \u201cstring\u201d (with different uses and attributes). The compiler did not check types in those days, so the programmers needed a crutch to help them remember the types.\n\n\nIn modern languages we have much richer type systems, and the compilers remember and enforce the types. What\u2019s more, there is a trend toward smaller classes and shorter functions so that people can usually see the point of declaration of each variable they\u2019re using.\n\n\nJava programmers don\u2019t need type encoding. Objects are strongly typed, and editing environments have advanced such that they detect a type error long before you can run a compile! So nowadays HN and other forms of type encoding are simply impediments. They make it harder to change the name or type of a variable, function, or class. They make it harder to read the code. And they create the possibility that the encoding system will mislead the reader.\n\n(In: Clean Code / Chapter 2. Meaningful name)", "author": "elek", "createdAt": "2020-05-21T13:32:46Z", "path": "hadoop-ozone/tools/src/main/java/org/apache/hadoop/ozone/debug/ListTables.java", "diffHunk": "@@ -0,0 +1,57 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ *  with the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  Unless required by applicable law or agreed to in writing, software\n+ *  distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *  See the License for the specific language governing permissions and\n+ *  limitations under the License.\n+ */\n+\n+package org.apache.hadoop.ozone.debug;\n+\n+import org.rocksdb.Options;\n+import org.rocksdb.RocksDB;\n+import org.rocksdb.RocksDBException;\n+import picocli.CommandLine;\n+\n+import java.nio.charset.StandardCharsets;\n+import java.util.List;\n+import java.util.concurrent.Callable;\n+\n+/**\n+ * List all column Families/Tables in db.\n+ */\n+@CommandLine.Command(\n+        name = \"list\",\n+        description = \"list all tables in db.\"\n+)\n+public class ListTables implements Callable<Void> {\n+\n+  @CommandLine.ParentCommand\n+  private RDBParser parent;\n+\n+  @Override\n+  public Void call() throws Exception {\n+    List<byte[]> cfList = getColumnFamilyList(parent.getDbPath());\n+    for (byte[] b : cfList) {\n+      System.out.println(new String(b, StandardCharsets.UTF_8));\n+    }\n+    return null;\n+  }\n+\n+  private static List<byte[]> getColumnFamilyList(String dbPath)", "originalCommit": "0de770297d492206904ebb5547bd6c64fb0cc8ae", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODY1NTEwMg==", "url": "https://github.com/apache/ozone/pull/945#discussion_r428655102", "bodyText": "If there is an exception, we are in trouble anyway. I would throw the exception without printing out the problem and GenericCli will handle all the remaining parts.", "author": "elek", "createdAt": "2020-05-21T13:36:13Z", "path": "hadoop-ozone/tools/src/main/java/org/apache/hadoop/ozone/debug/SCMDBParser.java", "diffHunk": "@@ -0,0 +1,123 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ *  with the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  Unless required by applicable law or agreed to in writing, software\n+ *  distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *  See the License for the specific language governing permissions and\n+ *  limitations under the License.\n+ */\n+\n+package org.apache.hadoop.ozone.debug;\n+\n+import org.apache.hadoop.hdds.utils.db.DBColumnFamilyDefinition;\n+import org.rocksdb.*;\n+import picocli.CommandLine;\n+\n+import java.io.IOException;\n+import java.nio.charset.StandardCharsets;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.List;\n+import java.util.concurrent.Callable;\n+\n+/**\n+ * Parser for scm.db file.\n+ */\n+@CommandLine.Command(\n+        name = \"scmdbparser\",\n+        description = \"Parse specified metadataTable\"\n+)\n+public class SCMDBParser implements Callable<Void> {\n+\n+  @CommandLine.Option(names = {\"-table\"},\n+            description = \"Table name\")\n+  private String tableName;\n+\n+  @CommandLine.ParentCommand\n+  private RDBParser parent;\n+\n+\n+  private static void displayTable(RocksDB rocksDB,\n+        DBColumnFamilyDefinition dbColumnFamilyDefinition,\n+        List<ColumnFamilyHandle> list) throws IOException {\n+    ColumnFamilyHandle columnFamilyHandle = getColumnFamilyHandle(\n+            dbColumnFamilyDefinition.getTableName()\n+                    .getBytes(StandardCharsets.UTF_8), list);\n+    if (columnFamilyHandle==null){\n+      throw new IllegalArgumentException(\"columnFamilyHandle is null\");\n+    }\n+    RocksIterator iterator = rocksDB.newIterator(columnFamilyHandle);\n+    iterator.seekToFirst();\n+    while (iterator.isValid()){\n+      Object o = dbColumnFamilyDefinition.getValueCodec()\n+              .fromPersistedFormat(iterator.value());\n+      System.out.println(o);\n+      iterator.next();\n+    }\n+  }\n+\n+  private static ColumnFamilyHandle getColumnFamilyHandle(\n+            byte[] name, List<ColumnFamilyHandle> columnFamilyHandles) {\n+    return columnFamilyHandles\n+            .stream()\n+            .filter(\n+              handle -> {\n+                try {\n+                  return Arrays.equals(handle.getName(), name);\n+                    } catch (Exception ex) {\n+                  throw new RuntimeException(ex);\n+                    }\n+              })\n+            .findAny()\n+            .orElse(null);\n+  }\n+\n+  @Override\n+  public Void call() throws Exception {\n+    List<ColumnFamilyDescriptor> cfs = new ArrayList<>();\n+    final List<ColumnFamilyHandle> columnFamilyHandleList =\n+            new ArrayList<>();\n+    List<byte[]> cfList = null;\n+    try {\n+      cfList = RocksDB.listColumnFamilies(new Options(),\n+                    parent.getDbPath());\n+    } catch (Exception e) {\n+      e.printStackTrace();", "originalCommit": "0de770297d492206904ebb5547bd6c64fb0cc8ae", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODY1NTY4OA==", "url": "https://github.com/apache/ozone/pull/945#discussion_r428655688", "bodyText": "Nit: Can you please use --table. It's more standard (or use -t and --table as an alias)", "author": "elek", "createdAt": "2020-05-21T13:37:16Z", "path": "hadoop-ozone/tools/src/main/java/org/apache/hadoop/ozone/debug/SCMDBParser.java", "diffHunk": "@@ -0,0 +1,123 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ *  with the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  Unless required by applicable law or agreed to in writing, software\n+ *  distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *  See the License for the specific language governing permissions and\n+ *  limitations under the License.\n+ */\n+\n+package org.apache.hadoop.ozone.debug;\n+\n+import org.apache.hadoop.hdds.utils.db.DBColumnFamilyDefinition;\n+import org.rocksdb.*;\n+import picocli.CommandLine;\n+\n+import java.io.IOException;\n+import java.nio.charset.StandardCharsets;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.List;\n+import java.util.concurrent.Callable;\n+\n+/**\n+ * Parser for scm.db file.\n+ */\n+@CommandLine.Command(\n+        name = \"scmdbparser\",\n+        description = \"Parse specified metadataTable\"\n+)\n+public class SCMDBParser implements Callable<Void> {\n+\n+  @CommandLine.Option(names = {\"-table\"},", "originalCommit": "0de770297d492206904ebb5547bd6c64fb0cc8ae", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "41790d7e1e6bf56f4af4e7592783ba734e6673ae", "url": "https://github.com/apache/ozone/commit/41790d7e1e6bf56f4af4e7592783ba734e6673ae", "message": "Reading DBDefinition from db file name", "committedDate": "2020-05-29T14:59:12Z", "type": "commit"}]}