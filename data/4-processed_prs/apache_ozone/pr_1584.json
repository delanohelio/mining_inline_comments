{"pr_number": 1584, "pr_title": "HDDS-4441. Add metrics for ACL related operations.(Addendum for HA).", "pr_createdAt": "2020-11-12T18:10:35Z", "pr_url": "https://github.com/apache/ozone/pull/1584", "timeline": [{"oid": "be14c72599aa1e47777095c9e49ad6248aa8d217", "url": "https://github.com/apache/ozone/commit/be14c72599aa1e47777095c9e49ad6248aa8d217", "message": "HDDS-4441. Add metrics for ACL related operations.(Addendum for HA).", "committedDate": "2020-11-12T18:07:59Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzM4NDAxNw==", "url": "https://github.com/apache/ozone/pull/1584#discussion_r523384017", "bodyText": "How about moving this line after true operationResult branch of onComplete() at line-120 ?", "author": "cxorm", "createdAt": "2020-11-14T06:26:30Z", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/bucket/acl/OMBucketAddAclRequest.java", "diffHunk": "@@ -130,5 +131,12 @@ void onComplete(boolean operationResult, IOException exception,\n     }\n   }\n \n+  @Override\n+  public OMClientResponse validateAndUpdateCache(OzoneManager ozoneManager,\n+      long trxnLogIndex, OzoneManagerDoubleBufferHelper omDoubleBufferHelper) {\n+    ozoneManager.getMetrics().incNumAddAcl();", "originalCommit": "be14c72599aa1e47777095c9e49ad6248aa8d217", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzM5MDA4Mg==", "url": "https://github.com/apache/ozone/pull/1584#discussion_r523390082", "bodyText": "Thanx @cxorm for the review. In onComplete(), there doesn't seems to be any instance of ozoneManager available, and I quickly had a check over, couple of other files, they too were incrementing metrics in validateAndUpdateCache, I think we can be in sync with them.\nLet me know, if you are ok going ahead this way.", "author": "ayushtkn", "createdAt": "2020-11-14T07:42:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzM4NDAxNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzQyNDE5Nw==", "url": "https://github.com/apache/ozone/pull/1584#discussion_r523424197", "bodyText": "Thanx @cxorm for the review. In onComplete(), there doesn't seems to be any instance of ozoneManager available, and I quickly had a check over, couple of other files, they too were incrementing metrics in validateAndUpdateCache, I think we can be in sync with them.\n\nThanks @ayushtkn for the comment.\nIMHO the onComplete() is called by super class validateAndUpdateCache (for example, in this part its super class is OMBucketAclRequest), and it has instance of ozoneManager.\nAn operation scenario is that when we call ozoneManager.getMetrics().incNumAddAcl() before super.validateAndUpdateCache() and failure occurs in validateAndUpdateCache(), the incNumAddAcl() shouldn't take effect, but it did.", "author": "cxorm", "createdAt": "2020-11-14T14:16:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzM4NDAxNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzQyNjg4Mw==", "url": "https://github.com/apache/ozone/pull/1584#discussion_r523426883", "bodyText": "Thanx @cxorm\nAre you talking about this onComplete?\nhttps://github.com/apache/ozone/blob/master/hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/volume/acl/OMVolumeAddAclRequest.java#L114\nIf not can you point me to that. It doesn't have ozonemanager\n\nAn operation scenario is that when we call ozoneManager.getMetrics().incNumAddAcl() before super.validateAndUpdateCache() and failure occurs in validateAndUpdateCache(), the incNumAddAcl() shouldn't take effect, but it did.\n\nAren't these metrics suppose to track the number of calls? not just success?\nvalidateAndUpdateCache  too has a metrics getting incremented,     omMetrics.incNumVolumeUpdates();, if a failure occurs post that, it isn't bothered.", "author": "ayushtkn", "createdAt": "2020-11-14T14:46:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzM4NDAxNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzQyOTQ0Mw==", "url": "https://github.com/apache/ozone/pull/1584#discussion_r523429443", "bodyText": "A reference from HDFS namenode.\nhttps://github.com/apache/hadoop/blob/trunk/hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/namenode/NameNodeRpcServer.java#L1960\nHere too, the metrics is incremented before and the execution is done post that, even if the call fails , the metrics shall still track that call.", "author": "ayushtkn", "createdAt": "2020-11-14T15:13:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzM4NDAxNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzkwNDU5OA==", "url": "https://github.com/apache/ozone/pull/1584#discussion_r523904598", "bodyText": "In Ozone, we increment these metrics represents number of operations, (Not the number of successful operations)\nIMHO, this approach matches with all other requests, and LGTM.", "author": "bharatviswa504", "createdAt": "2020-11-16T05:19:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzM4NDAxNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzk3NzgwNw==", "url": "https://github.com/apache/ozone/pull/1584#discussion_r523977807", "bodyText": "Thank you @bharatviswa504 for the clarification (and sorry for my previous view.)\nI'm +1 for the patch.", "author": "cxorm", "createdAt": "2020-11-16T08:47:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzM4NDAxNw=="}], "type": "inlineReview"}]}