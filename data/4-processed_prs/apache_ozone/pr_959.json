{"pr_number": 959, "pr_title": "HDDS-3186. Introduce generic SCMRatisRequest and SCMRatisResponse.", "pr_createdAt": "2020-05-22T19:18:20Z", "pr_url": "https://github.com/apache/ozone/pull/959", "timeline": [{"oid": "bae48c22e88975ff07a1ab44088dc5d266a5695b", "url": "https://github.com/apache/ozone/commit/bae48c22e88975ff07a1ab44088dc5d266a5695b", "message": "HDDS-3186. Initial version.", "committedDate": "2020-05-22T19:15:44Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTgwOTY5OQ==", "url": "https://github.com/apache/ozone/pull/959#discussion_r429809699", "bodyText": "can we put this into SCMHAUtils?", "author": "timmylicheng", "createdAt": "2020-05-25T08:41:13Z", "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/ha/RatisUtil.java", "diffHunk": "@@ -0,0 +1,92 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with this\n+ * work for additional information regarding copyright ownership.  The ASF\n+ * licenses this file to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ * <p/>\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ * <p/>\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package org.apache.hadoop.hdds.scm.ha;\n+\n+import com.google.common.base.Strings;\n+import org.apache.hadoop.hdds.conf.ConfigurationSource;\n+import org.apache.hadoop.hdds.server.ServerUtils;\n+import org.apache.ratis.RaftConfigKeys;\n+import org.apache.ratis.conf.RaftProperties;\n+import org.apache.ratis.grpc.GrpcConfigKeys;\n+import org.apache.ratis.rpc.RpcType;\n+import org.apache.ratis.server.RaftServerConfigKeys;\n+import org.apache.ratis.util.SizeInBytes;\n+import org.apache.ratis.util.TimeDuration;\n+\n+import java.io.File;\n+import java.net.InetSocketAddress;\n+import java.util.Collections;\n+import java.util.concurrent.TimeUnit;\n+\n+public class RatisUtil {", "originalCommit": "bae48c22e88975ff07a1ab44088dc5d266a5695b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTg2MjgwMQ==", "url": "https://github.com/apache/ozone/pull/959#discussion_r429862801", "bodyText": "I have moved this to ReflectionUtil class which can be used for all the utility methods related to reflection. I will update the PR soon.\nI agree that we should use the existing SCMHAUtil instead of creating new RatisUtil", "author": "nandakumar131", "createdAt": "2020-05-25T10:32:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTgwOTY5OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDI1MDkzNA==", "url": "https://github.com/apache/ozone/pull/959#discussion_r430250934", "bodyText": "https://issues.apache.org/jira/browse/HDDS-3660 Track it here", "author": "timmylicheng", "createdAt": "2020-05-26T08:43:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTgwOTY5OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDI1OTk2Mw==", "url": "https://github.com/apache/ozone/pull/959#discussion_r430259963", "bodyText": "I feel it's ok to have ReflectionUtil, RatisUtil, and SCMHAUtil as they serve a different purpose.", "author": "nandakumar131", "createdAt": "2020-05-26T08:57:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTgwOTY5OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTgxMDg5MA==", "url": "https://github.com/apache/ozone/pull/959#discussion_r429810890", "bodyText": "I've merged SCMRatisServer and SCMStateMachine into one between /ha and /ratis in timmylicheng#1. We can use /ha as your did here, but we need to combine all methods into one.", "author": "timmylicheng", "createdAt": "2020-05-25T08:43:36Z", "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/ha/SCMRatisServer.java", "diffHunk": "@@ -0,0 +1,101 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with this\n+ * work for additional information regarding copyright ownership.  The ASF\n+ * licenses this file to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ * <p/>\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ * <p/>\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package org.apache.hadoop.hdds.scm.ha;\n+\n+import java.io.IOException;\n+import java.net.InetSocketAddress;\n+import java.nio.charset.StandardCharsets;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.UUID;\n+import java.util.concurrent.ExecutionException;\n+import java.util.concurrent.atomic.AtomicLong;\n+\n+import org.apache.hadoop.hdds.conf.ConfigurationSource;\n+import org.apache.hadoop.hdds.protocol.proto.SCMRatisProtocolProtos;\n+import org.apache.ratis.conf.RaftProperties;\n+import org.apache.ratis.protocol.ClientId;\n+import org.apache.ratis.protocol.RaftClientReply;\n+import org.apache.ratis.protocol.RaftClientRequest;\n+import org.apache.ratis.protocol.RaftGroup;\n+import org.apache.ratis.protocol.RaftGroupId;\n+import org.apache.ratis.protocol.RaftPeer;\n+import org.apache.ratis.protocol.RaftPeerId;\n+import org.apache.ratis.server.RaftServer;\n+\n+public class SCMRatisServer {", "originalCommit": "bae48c22e88975ff07a1ab44088dc5d266a5695b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTg2MzgxOQ==", "url": "https://github.com/apache/ozone/pull/959#discussion_r429863819", "bodyText": "I don't think we need to copy all the code/methods from OzoneManagerHA implementation. We can add things to SCMHA related classes whenever required.\nIt's better not to have code that is not used or needed.\nLet's add/update the SCMHA code when needed.", "author": "nandakumar131", "createdAt": "2020-05-25T10:34:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTgxMDg5MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDEyNjgxMA==", "url": "https://github.com/apache/ozone/pull/959#discussion_r430126810", "bodyText": "How about Snapshot in SCMStateMachine?", "author": "timmylicheng", "createdAt": "2020-05-26T02:31:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTgxMDg5MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDI1MjE0NA==", "url": "https://github.com/apache/ozone/pull/959#discussion_r430252144", "bodyText": "Track the issue in https://issues.apache.org/jira/browse/HDDS-3661.\nThis is to split the work.", "author": "timmylicheng", "createdAt": "2020-05-26T08:45:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTgxMDg5MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDI1ODkxOA==", "url": "https://github.com/apache/ozone/pull/959#discussion_r430258918", "bodyText": "Let's configure/enable Ratis snapshot after we have some design plan on how to implement the snapshot.", "author": "nandakumar131", "createdAt": "2020-05-26T08:56:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTgxMDg5MA=="}], "type": "inlineReview"}, {"oid": "ecdfa6d5a2dabe64f0d291273d8929221ff8fda3", "url": "https://github.com/apache/ozone/commit/ecdfa6d5a2dabe64f0d291273d8929221ff8fda3", "message": "HDDS-3186. Additional changes.", "committedDate": "2020-05-25T18:24:57Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDEyNjkzNw==", "url": "https://github.com/apache/ozone/pull/959#discussion_r430126937", "bodyText": "Do we need to addContainerToDB here?", "author": "timmylicheng", "createdAt": "2020-05-26T02:31:43Z", "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/container/ContainerManagerImpl.java", "diffHunk": "@@ -0,0 +1,282 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with this\n+ * work for additional information regarding copyright ownership.  The ASF\n+ * licenses this file to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ * <p/>\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ * <p/>\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package org.apache.hadoop.hdds.scm.container;\n+\n+import java.io.IOException;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+import java.util.Set;\n+import java.util.concurrent.locks.ReadWriteLock;\n+import java.util.concurrent.locks.ReentrantReadWriteLock;\n+import java.util.stream.Collectors;\n+\n+import org.apache.hadoop.conf.Configuration;\n+import org.apache.hadoop.hdds.protocol.proto.HddsProtos.ContainerInfoProto;\n+import org.apache.hadoop.hdds.protocol.proto.HddsProtos.LifeCycleState;\n+import org.apache.hadoop.hdds.protocol.proto.HddsProtos.LifeCycleEvent;\n+import org.apache.hadoop.hdds.protocol.proto.HddsProtos.ReplicationFactor;\n+import org.apache.hadoop.hdds.protocol.proto.HddsProtos.ReplicationType;\n+import org.apache.hadoop.hdds.scm.ha.SCMHAManager;\n+import org.apache.hadoop.hdds.scm.pipeline.Pipeline;\n+import org.apache.hadoop.hdds.scm.pipeline.PipelineManager;\n+import org.apache.hadoop.hdds.utils.db.Table;\n+import org.apache.hadoop.util.Time;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * TODO: Add javadoc.\n+ */\n+public class ContainerManagerImpl implements ContainerManagerV2 {\n+\n+  /**\n+   *\n+   */\n+  private static final Logger LOG = LoggerFactory.getLogger(\n+      ContainerManagerImpl.class);\n+\n+  /**\n+   *\n+   */\n+  private final ReadWriteLock lock;\n+\n+  /**\n+   *\n+   */\n+  private final PipelineManager pipelineManager;\n+\n+  /**\n+   *\n+   */\n+  private final ContainerStateManagerV2 containerStateManager;\n+\n+  /**\n+   *\n+   */\n+  public ContainerManagerImpl(\n+      // Introduce builder for this class?\n+      final Configuration conf, final PipelineManager pipelineManager,\n+      final SCMHAManager scmhaManager,\n+      final Table<ContainerID, ContainerInfo> containerStore)\n+      throws IOException {\n+    this.lock = new ReentrantReadWriteLock();\n+    this.pipelineManager = pipelineManager;\n+    this.containerStateManager =  ContainerStateManagerImpl.newBuilder()\n+        .setConfiguration(conf)\n+        .setPipelineManager(pipelineManager)\n+        .setRatisServer(scmhaManager.getRatisServer())\n+        .setContainerStore(containerStore)\n+        .build();\n+  }\n+\n+  @Override\n+  public Set<ContainerID> getContainerIDs() {\n+    lock.readLock().lock();\n+    try {\n+      return containerStateManager.getContainerIDs();\n+    } finally {\n+      lock.readLock().unlock();\n+    }\n+  }\n+\n+  @Override\n+  public Set<ContainerInfo> getContainers() {\n+    lock.readLock().lock();\n+    try {\n+      return containerStateManager.getContainerIDs().stream().map(id -> {\n+        try {\n+          return containerStateManager.getContainer(id);\n+        } catch (ContainerNotFoundException e) {\n+          // How can this happen? o_O\n+          return null;\n+        }\n+      }).filter(Objects::nonNull).collect(Collectors.toSet());\n+    } finally {\n+      lock.readLock().unlock();\n+    }\n+  }\n+\n+  @Override\n+  public ContainerInfo getContainer(final ContainerID containerID)\n+      throws ContainerNotFoundException {\n+    lock.readLock().lock();\n+    try {\n+      return containerStateManager.getContainer(containerID);\n+    } finally {\n+      lock.readLock().unlock();\n+    }\n+  }\n+\n+  @Override\n+  public Set<ContainerInfo> getContainers(final LifeCycleState state) {\n+    lock.readLock().lock();\n+    try {\n+      return containerStateManager.getContainerIDs(state).stream().map(id -> {\n+        try {\n+          return containerStateManager.getContainer(id);\n+        } catch (ContainerNotFoundException e) {\n+          // How can this happen? o_O\n+          return null;\n+        }\n+      }).filter(Objects::nonNull).collect(Collectors.toSet());\n+    } finally {\n+      lock.readLock().unlock();\n+    }\n+  }\n+\n+  @Override\n+  public boolean exists(final ContainerID containerID) {\n+    lock.readLock().lock();\n+    try {\n+      return (containerStateManager.getContainer(containerID) != null);\n+    } catch (ContainerNotFoundException ex) {\n+      return false;\n+    } finally {\n+      lock.readLock().unlock();\n+    }\n+  }\n+\n+  @Override\n+  public List<ContainerInfo> listContainers(final ContainerID startID,\n+                                            final int count) {\n+    lock.readLock().lock();\n+    try {\n+      final long startId = startID == null ? 0 : startID.getId();\n+      final List<ContainerID> containersIds =\n+          new ArrayList<>(containerStateManager.getContainerIDs());\n+      Collections.sort(containersIds);\n+      return containersIds.stream()\n+          .filter(id -> id.getId() > startId)\n+          .limit(count)\n+          .map(id -> {\n+            try {\n+              return containerStateManager.getContainer(id);\n+            } catch (ContainerNotFoundException ex) {\n+              // This can never happen, as we hold lock no one else can remove\n+              // the container after we got the container ids.\n+              LOG.warn(\"Container Missing.\", ex);\n+              return null;\n+            }\n+          }).collect(Collectors.toList());\n+    } finally {\n+      lock.readLock().unlock();\n+    }\n+  }\n+\n+  @Override\n+  public ContainerInfo allocateContainer(final ReplicationType type,\n+      final ReplicationFactor replicationFactor, final String owner)\n+      throws IOException {\n+    lock.writeLock().lock();\n+    try {\n+      final List<Pipeline> pipelines = pipelineManager\n+          .getPipelines(type, replicationFactor, Pipeline.PipelineState.OPEN);\n+\n+      if (pipelines.isEmpty()) {\n+        throw new IOException(\"Could not allocate container. Cannot get any\" +\n+            \" matching pipeline for Type:\" + type + \", Factor:\" +\n+            replicationFactor + \", State:PipelineState.OPEN\");\n+      }\n+\n+      final ContainerID containerID = containerStateManager\n+          .getNextContainerID();\n+      final Pipeline pipeline = pipelines.get(\n+          (int) containerID.getId() % pipelines.size());\n+\n+      final ContainerInfoProto containerInfo = ContainerInfoProto.newBuilder()\n+          .setState(LifeCycleState.OPEN)\n+          .setPipelineID(pipeline.getId().getProtobuf())\n+          .setUsedBytes(0)\n+          .setNumberOfKeys(0)\n+          .setStateEnterTime(Time.now())\n+          .setOwner(owner)\n+          .setContainerID(containerID.getId())\n+          .setDeleteTransactionId(0)\n+          .setReplicationFactor(pipeline.getFactor())\n+          .setReplicationType(pipeline.getType())\n+          .build();\n+      containerStateManager.addContainer(containerInfo);", "originalCommit": "ecdfa6d5a2dabe64f0d291273d8929221ff8fda3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDI2MDcxNg==", "url": "https://github.com/apache/ozone/pull/959#discussion_r430260716", "bodyText": "It is handled inside ContainerStateManager.", "author": "nandakumar131", "createdAt": "2020-05-26T08:59:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDEyNjkzNw=="}], "type": "inlineReview"}]}