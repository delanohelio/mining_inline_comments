{"pr_number": 1498, "pr_title": "HDDS-4339. Allow AWSSignatureProcessor init when aws signature is absent.", "pr_createdAt": "2020-10-14T12:11:55Z", "pr_url": "https://github.com/apache/ozone/pull/1498", "timeline": [{"oid": "d12bdf68fd5a86164f2b23ec47a6030d26b0ed67", "url": "https://github.com/apache/ozone/commit/d12bdf68fd5a86164f2b23ec47a6030d26b0ed67", "message": "HDDS-4339. Skip aws signature when it's absent in header.", "committedDate": "2020-10-15T09:22:22Z", "type": "forcePushed"}, {"oid": "07fd22f08007c0e4dd276e9b78b0f6be87a4a4cf", "url": "https://github.com/apache/ozone/commit/07fd22f08007c0e4dd276e9b78b0f6be87a4a4cf", "message": "HDDS-4339. Skip aws signature when it's absent in header.", "committedDate": "2020-10-15T09:59:08Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzI5MzM3Mg==", "url": "https://github.com/apache/ozone/pull/1498#discussion_r507293372", "bodyText": "#1110 (comment)\nWhen S3 misses the auth header error returned is AuthorizationHeaderMalformedHeader. Refer for more info the above comment link.\nQuestion: After this fix, will it show this error when the auth header is missing or it will be just logged in S3G logs?", "author": "bharatviswa504", "createdAt": "2020-10-19T00:45:56Z", "path": "hadoop-ozone/s3gateway/src/main/java/org/apache/hadoop/ozone/s3/OzoneClientProducer.java", "diffHunk": "@@ -116,6 +116,13 @@ private OzoneClient getClient(OzoneConfiguration config) throws IOException {\n     }\n   }\n \n+  // ONLY validate aws access id when needed.\n+  private void validateAccessId(String awsAccessId) throws Exception {\n+    if (awsAccessId == null || awsAccessId.equals(\"\")) {\n+      throw S3_AUTHINFO_CREATION_ERROR;", "originalCommit": "07fd22f08007c0e4dd276e9b78b0f6be87a4a4cf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODE4MjUwNg==", "url": "https://github.com/apache/ozone/pull/1498#discussion_r508182506", "bodyText": "@bharatviswa504 Right now, it catching all exceptions and just print out logs. Do we want to throw OS3Exception?", "author": "timmylicheng", "createdAt": "2020-10-20T03:11:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzI5MzM3Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODYyMzUzNg==", "url": "https://github.com/apache/ozone/pull/1498#discussion_r508623536", "bodyText": "Yes, When I tried AWS S3 end point it shows AuthorizationHeaderMalformed to user. Refer #1110 (comment)\nIMHO S3G needs to mimic AWS S3 behavior, so S3 tools can handle S3G.", "author": "bharatviswa504", "createdAt": "2020-10-20T15:39:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzI5MzM3Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODk1MzUwOA==", "url": "https://github.com/apache/ozone/pull/1498#discussion_r508953508", "bodyText": "@bharatviswa504 I agree. But it will involve discussion over our internal errors mapping to s3 error codes, which could be a larger discussion. This patch is to have a hot fix for AWSSignatureProcessor init process to avoid NPE. Shall I create a separate JIRA to track handling s3g errors?", "author": "timmylicheng", "createdAt": "2020-10-21T02:37:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzI5MzM3Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODk3MTg3OQ==", "url": "https://github.com/apache/ozone/pull/1498#discussion_r508971879", "bodyText": "fine with me if we want to fix the error in a new Jira.\nHere we need to map this missing auth header to AuthorizationHeaderMalformed. We should mimic AWS S3 behavior like any other error like BucketNotFound etc.,", "author": "bharatviswa504", "createdAt": "2020-10-21T03:45:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzI5MzM3Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODk3MjkyMQ==", "url": "https://github.com/apache/ozone/pull/1498#discussion_r508972921", "bodyText": "During initial S3G development, we have followed this error list, and also for API we have tried with S3 to see the behavior and also documentation for that API.\nhttps://docs.aws.amazon.com/AmazonS3/latest/API/ErrorResponses.html#ErrorCodeList\nSee if this helps here.", "author": "bharatviswa504", "createdAt": "2020-10-21T03:50:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzI5MzM3Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTA4OTgyMw==", "url": "https://github.com/apache/ozone/pull/1498#discussion_r509089823", "bodyText": "Open https://issues.apache.org/jira/browse/HDDS-4361 to track proper s3 errors back to bad requests.", "author": "timmylicheng", "createdAt": "2020-10-21T08:31:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzI5MzM3Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDEwNzU5Mg==", "url": "https://github.com/apache/ozone/pull/1498#discussion_r510107592", "bodyText": "@bharatviswa504 I think a correct handling for ozone internal errors and s3 native errors is very important and would involve more in-depth changes between Ozone client and s3g. HDDS-4361 will be an umbrella JIRA to track the corrections we wanna make.", "author": "timmylicheng", "createdAt": "2020-10-22T12:08:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzI5MzM3Mg=="}], "type": "inlineReview"}, {"oid": "e51118a199de5885d4494fc6a4098dce22c34cab", "url": "https://github.com/apache/ozone/commit/e51118a199de5885d4494fc6a4098dce22c34cab", "message": "Use MALFORMED_HEADER as exception.", "committedDate": "2020-10-20T06:14:52Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzE2NjMxMw==", "url": "https://github.com/apache/ozone/pull/1498#discussion_r513166313", "bodyText": "This will throw NPE when awsAccessId is null, do we need to move validateAccessId before remoteUser creation.", "author": "bharatviswa504", "createdAt": "2020-10-28T03:58:58Z", "path": "hadoop-ozone/s3gateway/src/main/java/org/apache/hadoop/ozone/s3/OzoneClientProducer.java", "diffHunk": "@@ -80,9 +81,15 @@ private OzoneClient getClient(OzoneConfiguration config) throws IOException {\n       UserGroupInformation remoteUser =", "originalCommit": "e51118a199de5885d4494fc6a4098dce22c34cab", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDAxMTMzMw==", "url": "https://github.com/apache/ozone/pull/1498#discussion_r514011333", "bodyText": "Sure. Updated.", "author": "timmylicheng", "createdAt": "2020-10-29T06:20:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzE2NjMxMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDgyMDExOQ==", "url": "https://github.com/apache/ozone/pull/1498#discussion_r514820119", "bodyText": "Minor NIT: do we still need this precondition check.\nSorry missed it earlier?", "author": "bharatviswa504", "createdAt": "2020-10-30T04:10:48Z", "path": "hadoop-ozone/s3gateway/src/main/java/org/apache/hadoop/ozone/s3/AWSSignatureProcessor.java", "diffHunk": "@@ -108,23 +109,29 @@ public void init()\n \n     this.method = context.getMethod();\n     String authHeader = headers.get(AUTHORIZATION_HEADER);\n-    String[] split = authHeader.split(\" \");\n-    if (split[0].equals(AuthorizationHeaderV2.IDENTIFIER)) {\n-      if (v2Header == null) {\n-        v2Header = new AuthorizationHeaderV2(authHeader);\n-      }\n-    } else {\n-      if (v4Header == null) {\n-        v4Header = new AuthorizationHeaderV4(authHeader);\n+    if (authHeader != null) {\n+      String[] split = authHeader.split(\" \");\n+      if (split[0].equals(AuthorizationHeaderV2.IDENTIFIER)) {\n+        if (v2Header == null) {\n+          v2Header = new AuthorizationHeaderV2(authHeader);\n+        }\n+      } else {\n+        if (v4Header == null) {\n+          v4Header = new AuthorizationHeaderV4(authHeader);\n+        }\n+        parse();\n       }\n-      parse();\n+    } else { // no auth header\n+      v4Header = null;\n+      v2Header = null;\n     }\n   }\n \n \n-  public void parse() throws Exception {\n-    StringBuilder strToSign = new StringBuilder();\n+  private void parse() throws Exception {\n+    Preconditions.checkNotNull(v4Header);", "originalCommit": "098cdef90e7e0dc6d2885048b52bf3a29ab5b1bf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjQwODg1Ng==", "url": "https://github.com/apache/ozone/pull/1498#discussion_r516408856", "bodyText": "I think so. Otherwise, v4header is still likely to throw NPE...", "author": "timmylicheng", "createdAt": "2020-11-03T03:21:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDgyMDExOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjQyNjg1Ng==", "url": "https://github.com/apache/ozone/pull/1498#discussion_r516426856", "bodyText": "sorry missed this, parse we called only when authHeader!=null.\nBut anyway, even without this it will fail with NPE, and now this code has moved to try catch and it is properly handled and this error is propagated to OzoneClientProducer. So, the pending part is propagating error from OzoneClientProducer to S3 clients.", "author": "bharatviswa504", "createdAt": "2020-11-03T04:50:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDgyMDExOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDgyMTA0MA==", "url": "https://github.com/apache/ozone/pull/1498#discussion_r514821040", "bodyText": "Minor NIT: do we still need this precondition check.\nSame here.", "author": "bharatviswa504", "createdAt": "2020-10-30T04:11:39Z", "path": "hadoop-ozone/s3gateway/src/main/java/org/apache/hadoop/ozone/s3/AWSSignatureProcessor.java", "diffHunk": "@@ -167,7 +174,9 @@ public void parse() throws Exception {\n   }\n \n   @VisibleForTesting\n-  public String buildCanonicalRequest() throws OS3Exception {\n+  protected String buildCanonicalRequest() throws OS3Exception {\n+    Preconditions.checkNotNull(v4Header);", "originalCommit": "098cdef90e7e0dc6d2885048b52bf3a29ab5b1bf", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "c8cc0aa52c12c30ed2369797a73e7fb36eb5bb29", "url": "https://github.com/apache/ozone/commit/c8cc0aa52c12c30ed2369797a73e7fb36eb5bb29", "message": "HDDS-4339. Skip aws signature when it's absent in header.", "committedDate": "2020-11-02T23:27:53Z", "type": "commit"}, {"oid": "644f9e7d50c3cb4b279e82fbbe588079dce84aab", "url": "https://github.com/apache/ozone/commit/644f9e7d50c3cb4b279e82fbbe588079dce84aab", "message": "Use MALFORMED_HEADER as exception.", "committedDate": "2020-11-02T23:27:53Z", "type": "commit"}, {"oid": "4f2562f77b0f3b8bc057cbbdc5c30f7aa11cb027", "url": "https://github.com/apache/ozone/commit/4f2562f77b0f3b8bc057cbbdc5c30f7aa11cb027", "message": "Validate accessID earlier.", "committedDate": "2020-11-02T23:27:54Z", "type": "commit"}, {"oid": "e8699d2fe1f5edd99c1ab90535933d550170015c", "url": "https://github.com/apache/ozone/commit/e8699d2fe1f5edd99c1ab90535933d550170015c", "message": "S3G unauthorized client able to access", "committedDate": "2020-11-02T23:27:54Z", "type": "commit"}, {"oid": "7b26fb85e042f85fd443c9cd450459c8364583ee", "url": "https://github.com/apache/ozone/commit/7b26fb85e042f85fd443c9cd450459c8364583ee", "message": "fix test and also handle error of creation of signature processor\"", "committedDate": "2020-11-03T00:39:19Z", "type": "forcePushed"}, {"oid": "46a74a6d1aad7abaacded68382ad7f7d4a4f8fda", "url": "https://github.com/apache/ozone/commit/46a74a6d1aad7abaacded68382ad7f7d4a4f8fda", "message": "fix test and also handle error of creation of signature processor\"", "committedDate": "2020-11-03T00:40:46Z", "type": "forcePushed"}, {"oid": "6f600ca6f5c69a8d0af12ff95fa28c65d347d659", "url": "https://github.com/apache/ozone/commit/6f600ca6f5c69a8d0af12ff95fa28c65d347d659", "message": "fix test and also handle error of creation of signature processor\"", "committedDate": "2020-11-03T00:52:15Z", "type": "forcePushed"}, {"oid": "b1693bad8c495048b3d24158266fbd138e66a31e", "url": "https://github.com/apache/ozone/commit/b1693bad8c495048b3d24158266fbd138e66a31e", "message": "fix test and also handle error of creation of signature processor\"", "committedDate": "2020-11-03T00:55:37Z", "type": "commit"}, {"oid": "b1693bad8c495048b3d24158266fbd138e66a31e", "url": "https://github.com/apache/ozone/commit/b1693bad8c495048b3d24158266fbd138e66a31e", "message": "fix test and also handle error of creation of signature processor\"", "committedDate": "2020-11-03T00:55:37Z", "type": "forcePushed"}]}