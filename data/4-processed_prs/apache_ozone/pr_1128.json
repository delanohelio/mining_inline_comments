{"pr_number": 1128, "pr_title": "HDDS-3862. Prepare checks for running some tests multiple times", "pr_createdAt": "2020-06-25T15:15:19Z", "pr_url": "https://github.com/apache/ozone/pull/1128", "timeline": [{"oid": "268e59e6d015a48b07b12b0dd3c2289f3b311dc2", "url": "https://github.com/apache/ozone/commit/268e59e6d015a48b07b12b0dd3c2289f3b311dc2", "message": "HDDS-3862. Prepare checks for running some tests multiple times", "committedDate": "2020-06-24T17:53:31Z", "type": "commit"}, {"oid": "3bb425194b1f0d00a935a937ae28336830964a9e", "url": "https://github.com/apache/ozone/commit/3bb425194b1f0d00a935a937ae28336830964a9e", "message": "trigger new CI check", "committedDate": "2020-06-25T06:35:23Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzU1ODQ2Mw==", "url": "https://github.com/apache/ozone/pull/1128#discussion_r447558463", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                echo \"Iteration ${i} exit code: ${irc}\" | tee -a \"${REPORT_DIR}/output.log\"\n          \n          \n            \n                echo \"Iteration ${i} exit code: ${irc}\" | tee -a \"${REPORT_DIR}/summary.txt\"\n          \n      \n    \n    \n  \n\nBased on the existing convention, output.log contains the full std output, summary.txt the information.", "author": "elek", "createdAt": "2020-06-30T09:50:46Z", "path": "hadoop-ozone/dev-support/checks/junit.sh", "diffHunk": "@@ -0,0 +1,63 @@\n+#!/usr/bin/env bash\n+# Licensed to the Apache Software Foundation (ASF) under one or more\n+# contributor license agreements.  See the NOTICE file distributed with\n+# this work for additional information regarding copyright ownership.\n+# The ASF licenses this file to You under the Apache License, Version 2.0\n+# (the \"License\"); you may not use this file except in compliance with\n+# the License.  You may obtain a copy of the License at\n+#\n+#     http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+\n+set -u -o pipefail\n+\n+DIR=\"$( cd \"$( dirname \"${BASH_SOURCE[0]}\" )\" >/dev/null 2>&1 && pwd )\"\n+cd \"$DIR/../../..\" || exit 1\n+\n+: ${CHECK:=\"unit\"}\n+: ${ITERATIONS:=\"1\"}\n+\n+export MAVEN_OPTS=\"-Xmx4096m\"\n+MAVEN_OPTIONS='-B -Dskip.npx -Dskip.installnpx'\n+mvn ${MAVEN_OPTIONS} -DskipTests clean install\n+\n+REPORT_DIR=${OUTPUT_DIR:-\"$DIR/../../../target/${CHECK}\"}\n+mkdir -p \"$REPORT_DIR\"\n+\n+rc=0\n+for i in $(seq 1 ${ITERATIONS}); do\n+  if [[ ${ITERATIONS} -gt 1 ]]; then\n+    original_report_dir=\"${REPORT_DIR}\"\n+    REPORT_DIR=\"${original_report_dir}/iteration${i}\"\n+    mkdir -p \"${REPORT_DIR}\"\n+  fi\n+\n+  mvn ${MAVEN_OPTIONS} -fae \"$@\" test \\\n+    | tee \"${REPORT_DIR}/output.log\"\n+  irc=$?\n+\n+  # shellcheck source=hadoop-ozone/dev-support/checks/_mvn_unit_report.sh\n+  source \"${DIR}/_mvn_unit_report.sh\"\n+\n+  if [[ ${ITERATIONS} -gt 1 ]]; then\n+    REPORT_DIR=\"${original_report_dir}\"\n+    echo \"Iteration ${i} exit code: ${irc}\" | tee -a \"${REPORT_DIR}/output.log\"", "originalCommit": "3bb425194b1f0d00a935a937ae28336830964a9e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzYxODkyMQ==", "url": "https://github.com/apache/ozone/pull/1128#discussion_r447618921", "bodyText": "@elek I've updated the patch based on this suggestion.  Now that I see the results of a repeated run, a question occurred to me: should we print only failed iterations (to match how we only list failed tests in summary) or all of them?", "author": "adoroszlai", "createdAt": "2020-06-30T11:44:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzU1ODQ2Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODQ4NzMzNg==", "url": "https://github.com/apache/ozone/pull/1128#discussion_r448487336", "bodyText": "When we had the Kubernetes based build / notification logic, it worked based on the number of lines in the summary.txt. Today we have no such dependencies. I am fine with keeping it simple in this form (include all lines).", "author": "elek", "createdAt": "2020-07-01T16:40:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzU1ODQ2Mw=="}], "type": "inlineReview"}, {"oid": "f9b0239711b811b8f1888c2d3e9b98c55928d1ce", "url": "https://github.com/apache/ozone/commit/f9b0239711b811b8f1888c2d3e9b98c55928d1ce", "message": "HDDS-3862. Output iteration result to summary", "committedDate": "2020-06-30T10:19:41Z", "type": "commit"}, {"oid": "e83b53233304d8ee68299de9864663854a5420e4", "url": "https://github.com/apache/ozone/commit/e83b53233304d8ee68299de9864663854a5420e4", "message": "trigger new CI check", "committedDate": "2020-07-01T17:23:48Z", "type": "commit"}, {"oid": "df8c3ea6795fb026d8c21cf98d10eeed1681f4ae", "url": "https://github.com/apache/ozone/commit/df8c3ea6795fb026d8c21cf98d10eeed1681f4ae", "message": "trigger new CI check", "committedDate": "2020-07-02T10:43:29Z", "type": "commit"}, {"oid": "416b9ad0a6de8c54468143c0e6e9fa5659a9dcf5", "url": "https://github.com/apache/ozone/commit/416b9ad0a6de8c54468143c0e6e9fa5659a9dcf5", "message": "trigger new CI check", "committedDate": "2020-07-02T13:07:49Z", "type": "commit"}, {"oid": "92c055d3e43620daaba9ca46cfe9b37845d113f1", "url": "https://github.com/apache/ozone/commit/92c055d3e43620daaba9ca46cfe9b37845d113f1", "message": "trigger new CI check", "committedDate": "2020-07-02T16:14:42Z", "type": "commit"}]}