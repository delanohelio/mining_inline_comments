{"pr_number": 1716, "pr_title": "HDDS-4606. Detect and handle duplicate ACLs when set default ACLs", "pr_createdAt": "2020-12-16T13:09:36Z", "pr_url": "https://github.com/apache/ozone/pull/1716", "timeline": [{"oid": "02866a22d9ae7cc6a82f0b982274dd15930ca164", "url": "https://github.com/apache/ozone/commit/02866a22d9ae7cc6a82f0b982274dd15930ca164", "message": "HDDS-4606. Got wrong acls when set default Acl(s) on volume for repeatedly", "committedDate": "2020-12-16T13:02:51Z", "type": "commit"}, {"oid": "e7cb5ebc25e50ed106cbacd17d03592d9f00bec7", "url": "https://github.com/apache/ozone/commit/e7cb5ebc25e50ed106cbacd17d03592d9f00bec7", "message": "HDDS-4606. Got wrong acls when set default Acl(s) on volume for repeatedly", "committedDate": "2020-12-17T01:08:52Z", "type": "commit"}, {"oid": "740a5f784f86a4037b208529f59ce76408421e79", "url": "https://github.com/apache/ozone/commit/740a5f784f86a4037b208529f59ce76408421e79", "message": "HDDS-4606. Got wrong acls when set default Acl(s) on volume for repeatedly, add handle adding different acl rights to existing acl entry", "committedDate": "2020-12-21T05:24:00Z", "type": "commit"}, {"oid": "610b540b9705e063973de044a2d84c946d5c75a2", "url": "https://github.com/apache/ozone/commit/610b540b9705e063973de044a2d84c946d5c75a2", "message": "HDDS-4606. Got wrong acls when set default Acl(s) on volume for repeatedly, add handle adding different acl rights to existing acl entry", "committedDate": "2020-12-21T05:31:58Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzcyNDgxNA==", "url": "https://github.com/apache/ozone/pull/1716#discussion_r547724814", "bodyText": "currBitSet  -> curBitSet", "author": "ChenSammi", "createdAt": "2020-12-23T06:53:45Z", "path": "hadoop-ozone/common/src/main/java/org/apache/hadoop/ozone/om/helpers/OmOzoneAclMap.java", "diffHunk": "@@ -100,28 +97,58 @@ private BitSet getAcl(OzoneAclType type, String user) {\n   // Add a new acl to the map\n   public void addAcl(OzoneAcl acl) throws OMException {\n     Objects.requireNonNull(acl, \"Acl should not be null.\");\n+    OzoneAclType aclType = OzoneAclType.valueOf(acl.getType().name());\n     if (acl.getAclScope().equals(OzoneAcl.AclScope.DEFAULT)) {\n-      defaultAclList.add(OzoneAcl.toProtobuf(acl));\n+      addDefaultAcl(acl);\n       return;\n     }\n \n-    OzoneAclType aclType = OzoneAclType.valueOf(acl.getType().name());\n     if (!getAccessAclMap(aclType).containsKey(acl.getName())) {\n       getAccessAclMap(aclType).put(acl.getName(), acl.getAclBitSet());\n     } else {\n-      // Check if we are adding new rights to existing acl.\n-      BitSet temp = (BitSet) acl.getAclBitSet().clone();\n-      BitSet curRights = (BitSet) getAccessAclMap(aclType).\n-          get(acl.getName()).clone();\n-      temp.or(curRights);\n-\n-      if (temp.equals(curRights)) {\n-        // throw exception if acl is already added.\n-        throw new OMException(\"Acl \" + acl + \" already exist.\",\n-            INVALID_REQUEST);\n+      BitSet currBitSet = getAccessAclMap(aclType).get(acl.getName());", "originalCommit": "d0f2cfdb21a54f3ecb5e97608457f010b53e0a40", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzcyNjI3NQ==", "url": "https://github.com/apache/ozone/pull/1716#discussion_r547726275", "bodyText": "New line indent is 2. Here second line of a long line is 4.", "author": "ChenSammi", "createdAt": "2020-12-23T06:55:24Z", "path": "hadoop-ozone/common/src/main/java/org/apache/hadoop/ozone/om/helpers/OmOzoneAclMap.java", "diffHunk": "@@ -100,28 +97,58 @@ private BitSet getAcl(OzoneAclType type, String user) {\n   // Add a new acl to the map\n   public void addAcl(OzoneAcl acl) throws OMException {\n     Objects.requireNonNull(acl, \"Acl should not be null.\");\n+    OzoneAclType aclType = OzoneAclType.valueOf(acl.getType().name());\n     if (acl.getAclScope().equals(OzoneAcl.AclScope.DEFAULT)) {\n-      defaultAclList.add(OzoneAcl.toProtobuf(acl));\n+      addDefaultAcl(acl);\n       return;\n     }\n \n-    OzoneAclType aclType = OzoneAclType.valueOf(acl.getType().name());\n     if (!getAccessAclMap(aclType).containsKey(acl.getName())) {\n       getAccessAclMap(aclType).put(acl.getName(), acl.getAclBitSet());\n     } else {\n-      // Check if we are adding new rights to existing acl.\n-      BitSet temp = (BitSet) acl.getAclBitSet().clone();\n-      BitSet curRights = (BitSet) getAccessAclMap(aclType).\n-          get(acl.getName()).clone();\n-      temp.or(curRights);\n-\n-      if (temp.equals(curRights)) {\n-        // throw exception if acl is already added.\n-        throw new OMException(\"Acl \" + acl + \" already exist.\",\n-            INVALID_REQUEST);\n+      BitSet currBitSet = getAccessAclMap(aclType).get(acl.getName());\n+      BitSet bitSet = checkAndGet(acl, currBitSet);\n+      getAccessAclMap(aclType).replace(acl.getName(), bitSet);\n+    }\n+  }\n+\n+  private void addDefaultAcl(OzoneAcl acl) throws OMException {\n+    OzoneAclInfo ozoneAclInfo = OzoneAcl.toProtobuf(acl);\n+    if (defaultAclList.contains(ozoneAclInfo)) {\n+      aclExistsError(acl);\n+    } else {\n+      for (int i = 0; i < defaultAclList.size(); i++) {\n+        OzoneAclInfo old = defaultAclList.get(i);\n+        if (old.getType() == ozoneAclInfo.getType() && old.getName().equals(\n+                ozoneAclInfo.getName())) {\n+          BitSet currBitSet = BitSet.valueOf(old.getRights().toByteArray());\n+          BitSet bitSet = checkAndGet(acl, currBitSet);\n+          ozoneAclInfo = OzoneAclInfo.newBuilder(ozoneAclInfo).setRights(\n+                  ByteString.copyFrom(bitSet.toByteArray())).build();\n+          defaultAclList.remove(i);\n+          defaultAclList.add(ozoneAclInfo);\n+          return;\n+        }\n       }\n-      getAccessAclMap(aclType).replace(acl.getName(), temp);\n     }\n+    defaultAclList.add(ozoneAclInfo);\n+  }\n+\n+  private void aclExistsError(OzoneAcl acl) throws OMException {\n+    // throw exception if acl is already added.\n+    throw new OMException(\"Acl \" + acl + \" already exist.\", INVALID_REQUEST);\n+  }\n+\n+  private BitSet checkAndGet(OzoneAcl acl, BitSet currBitSet)\n+          throws OMException {", "originalCommit": "d0f2cfdb21a54f3ecb5e97608457f010b53e0a40", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzcyNjQ2Nw==", "url": "https://github.com/apache/ozone/pull/1716#discussion_r547726467", "bodyText": "currBitSet -> curBitSet", "author": "ChenSammi", "createdAt": "2020-12-23T06:55:36Z", "path": "hadoop-ozone/common/src/main/java/org/apache/hadoop/ozone/om/helpers/OmOzoneAclMap.java", "diffHunk": "@@ -100,28 +97,58 @@ private BitSet getAcl(OzoneAclType type, String user) {\n   // Add a new acl to the map\n   public void addAcl(OzoneAcl acl) throws OMException {\n     Objects.requireNonNull(acl, \"Acl should not be null.\");\n+    OzoneAclType aclType = OzoneAclType.valueOf(acl.getType().name());\n     if (acl.getAclScope().equals(OzoneAcl.AclScope.DEFAULT)) {\n-      defaultAclList.add(OzoneAcl.toProtobuf(acl));\n+      addDefaultAcl(acl);\n       return;\n     }\n \n-    OzoneAclType aclType = OzoneAclType.valueOf(acl.getType().name());\n     if (!getAccessAclMap(aclType).containsKey(acl.getName())) {\n       getAccessAclMap(aclType).put(acl.getName(), acl.getAclBitSet());\n     } else {\n-      // Check if we are adding new rights to existing acl.\n-      BitSet temp = (BitSet) acl.getAclBitSet().clone();\n-      BitSet curRights = (BitSet) getAccessAclMap(aclType).\n-          get(acl.getName()).clone();\n-      temp.or(curRights);\n-\n-      if (temp.equals(curRights)) {\n-        // throw exception if acl is already added.\n-        throw new OMException(\"Acl \" + acl + \" already exist.\",\n-            INVALID_REQUEST);\n+      BitSet currBitSet = getAccessAclMap(aclType).get(acl.getName());\n+      BitSet bitSet = checkAndGet(acl, currBitSet);\n+      getAccessAclMap(aclType).replace(acl.getName(), bitSet);\n+    }\n+  }\n+\n+  private void addDefaultAcl(OzoneAcl acl) throws OMException {\n+    OzoneAclInfo ozoneAclInfo = OzoneAcl.toProtobuf(acl);\n+    if (defaultAclList.contains(ozoneAclInfo)) {\n+      aclExistsError(acl);\n+    } else {\n+      for (int i = 0; i < defaultAclList.size(); i++) {\n+        OzoneAclInfo old = defaultAclList.get(i);\n+        if (old.getType() == ozoneAclInfo.getType() && old.getName().equals(\n+                ozoneAclInfo.getName())) {\n+          BitSet currBitSet = BitSet.valueOf(old.getRights().toByteArray());\n+          BitSet bitSet = checkAndGet(acl, currBitSet);\n+          ozoneAclInfo = OzoneAclInfo.newBuilder(ozoneAclInfo).setRights(\n+                  ByteString.copyFrom(bitSet.toByteArray())).build();\n+          defaultAclList.remove(i);\n+          defaultAclList.add(ozoneAclInfo);\n+          return;\n+        }\n       }\n-      getAccessAclMap(aclType).replace(acl.getName(), temp);\n     }\n+    defaultAclList.add(ozoneAclInfo);\n+  }\n+\n+  private void aclExistsError(OzoneAcl acl) throws OMException {\n+    // throw exception if acl is already added.\n+    throw new OMException(\"Acl \" + acl + \" already exist.\", INVALID_REQUEST);\n+  }\n+\n+  private BitSet checkAndGet(OzoneAcl acl, BitSet currBitSet)", "originalCommit": "d0f2cfdb21a54f3ecb5e97608457f010b53e0a40", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzczMzM0Nw==", "url": "https://github.com/apache/ozone/pull/1716#discussion_r547733347", "bodyText": "Could you replace other same expection codes in this class using this aclExistsError function?", "author": "ChenSammi", "createdAt": "2020-12-23T07:04:09Z", "path": "hadoop-ozone/common/src/main/java/org/apache/hadoop/ozone/om/helpers/OmOzoneAclMap.java", "diffHunk": "@@ -100,28 +97,58 @@ private BitSet getAcl(OzoneAclType type, String user) {\n   // Add a new acl to the map\n   public void addAcl(OzoneAcl acl) throws OMException {\n     Objects.requireNonNull(acl, \"Acl should not be null.\");\n+    OzoneAclType aclType = OzoneAclType.valueOf(acl.getType().name());\n     if (acl.getAclScope().equals(OzoneAcl.AclScope.DEFAULT)) {\n-      defaultAclList.add(OzoneAcl.toProtobuf(acl));\n+      addDefaultAcl(acl);\n       return;\n     }\n \n-    OzoneAclType aclType = OzoneAclType.valueOf(acl.getType().name());\n     if (!getAccessAclMap(aclType).containsKey(acl.getName())) {\n       getAccessAclMap(aclType).put(acl.getName(), acl.getAclBitSet());\n     } else {\n-      // Check if we are adding new rights to existing acl.\n-      BitSet temp = (BitSet) acl.getAclBitSet().clone();\n-      BitSet curRights = (BitSet) getAccessAclMap(aclType).\n-          get(acl.getName()).clone();\n-      temp.or(curRights);\n-\n-      if (temp.equals(curRights)) {\n-        // throw exception if acl is already added.\n-        throw new OMException(\"Acl \" + acl + \" already exist.\",\n-            INVALID_REQUEST);\n+      BitSet currBitSet = getAccessAclMap(aclType).get(acl.getName());\n+      BitSet bitSet = checkAndGet(acl, currBitSet);\n+      getAccessAclMap(aclType).replace(acl.getName(), bitSet);\n+    }\n+  }\n+\n+  private void addDefaultAcl(OzoneAcl acl) throws OMException {\n+    OzoneAclInfo ozoneAclInfo = OzoneAcl.toProtobuf(acl);\n+    if (defaultAclList.contains(ozoneAclInfo)) {\n+      aclExistsError(acl);\n+    } else {\n+      for (int i = 0; i < defaultAclList.size(); i++) {\n+        OzoneAclInfo old = defaultAclList.get(i);\n+        if (old.getType() == ozoneAclInfo.getType() && old.getName().equals(\n+                ozoneAclInfo.getName())) {\n+          BitSet currBitSet = BitSet.valueOf(old.getRights().toByteArray());\n+          BitSet bitSet = checkAndGet(acl, currBitSet);\n+          ozoneAclInfo = OzoneAclInfo.newBuilder(ozoneAclInfo).setRights(\n+                  ByteString.copyFrom(bitSet.toByteArray())).build();\n+          defaultAclList.remove(i);\n+          defaultAclList.add(ozoneAclInfo);\n+          return;\n+        }\n       }\n-      getAccessAclMap(aclType).replace(acl.getName(), temp);\n     }\n+    defaultAclList.add(ozoneAclInfo);\n+  }\n+\n+  private void aclExistsError(OzoneAcl acl) throws OMException {", "originalCommit": "d0f2cfdb21a54f3ecb5e97608457f010b53e0a40", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "52a975bb90a6362dcb3e0da3248eddbe29d5973a", "url": "https://github.com/apache/ozone/commit/52a975bb90a6362dcb3e0da3248eddbe29d5973a", "message": "HDDS-4606. Detect and handle duplicate ACLs when set default ACLs", "committedDate": "2020-12-23T07:32:14Z", "type": "commit"}, {"oid": "5e37dd5e609bb513b969adbda62f564c1563a5c8", "url": "https://github.com/apache/ozone/commit/5e37dd5e609bb513b969adbda62f564c1563a5c8", "message": "Merge branch 'master' of https://github.com/apache/ozone into HDDS-4606", "committedDate": "2020-12-23T07:32:45Z", "type": "commit"}, {"oid": "5e37dd5e609bb513b969adbda62f564c1563a5c8", "url": "https://github.com/apache/ozone/commit/5e37dd5e609bb513b969adbda62f564c1563a5c8", "message": "Merge branch 'master' of https://github.com/apache/ozone into HDDS-4606", "committedDate": "2020-12-23T07:32:45Z", "type": "forcePushed"}]}