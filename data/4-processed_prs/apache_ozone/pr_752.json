{"pr_number": 752, "pr_title": "HDDS-3319. Handle HA for BasicOzoneClientAdapterImpl#renew/cancel().", "pr_createdAt": "2020-04-02T01:24:47Z", "pr_url": "https://github.com/apache/ozone/pull/752", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjA0OTgyMQ==", "url": "https://github.com/apache/ozone/pull/752#discussion_r402049821", "bodyText": "Now with this change, we have an assumption that client can never use OM_SERVICE_ID_DEFAULT value when configuring HA. As previously in single node OM with ratis enabled, we need raftGroupID to get that we have used this default serviceID.", "author": "bharatviswa504", "createdAt": "2020-04-02T04:50:07Z", "path": "hadoop-ozone/client/src/main/java/org/apache/hadoop/ozone/client/OzoneClientFactory.java", "diffHunk": "@@ -159,6 +163,47 @@ private static OzoneClient getRpcClient(ClientProtocol clientProtocol,\n     return new OzoneClient(config, proxy);\n   }\n \n+  /**\n+   * Create OzoneClient for token renew/cancel operations.\n+   * @param conf Configuration to be used for OzoneCient creation\n+   * @param token ozone token is involved\n+   * @return\n+   * @throws IOException\n+   */\n+  public static OzoneClient getOzoneClient(Configuration conf,\n+      Token<OzoneTokenIdentifier> token) throws IOException {\n+    Preconditions.checkNotNull(token, \"Null token is not allowed\");\n+    String omServiceId = token.decodeIdentifier().getOmServiceId();\n+    if (StringUtils.isNotEmpty(omServiceId)) {\n+      // new OM should always issue token with omServiceId\n+      if (omServiceId.equals(OzoneConsts.OM_SERVICE_ID_DEFAULT)) {", "originalCommit": "0e0b790dc923e7735fc6c039c60ea51e20f16fe4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjA1NzQwMQ==", "url": "https://github.com/apache/ozone/pull/752#discussion_r402057401", "bodyText": "Do we need to update it to something like this  if (omServiceId.equals(OzoneConsts.OM_SERVICE_ID_DEFAULT) && !OmUtils.isOmHAServiceId(conf, omServiceId))", "author": "bharatviswa504", "createdAt": "2020-04-02T05:20:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjA0OTgyMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjA5MDQyNw==", "url": "https://github.com/apache/ozone/pull/752#discussion_r402090427", "bodyText": "Do we use the OM_SERVICE_ID_DEFAULT for non-HA case? My first version does not have the following logic and I thought this is purely for non-HA where we don't need this serviceID to create RPC client.\nif (omServiceId.equals(OzoneConsts.OM_SERVICE_ID_DEFAULT)) {\n// Non-HA\nreturn OzoneClientFactory.getRpcClient(conf);\n}\nIf all the HA and HA are unified, we can skip those lines and only use the second if when the omServiceId match with the local configure. Still, the default om service id is risky in cross cluster operations like distcp as I mentioned below.", "author": "xiaoyuyao", "createdAt": "2020-04-02T06:57:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjA0OTgyMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjA1MDc1OQ==", "url": "https://github.com/apache/ozone/pull/752#discussion_r402050759", "bodyText": "This else, says when new client talking to old OM with HA, we are failing is my understanding correct here?", "author": "bharatviswa504", "createdAt": "2020-04-02T04:53:53Z", "path": "hadoop-ozone/client/src/main/java/org/apache/hadoop/ozone/client/OzoneClientFactory.java", "diffHunk": "@@ -159,6 +163,47 @@ private static OzoneClient getRpcClient(ClientProtocol clientProtocol,\n     return new OzoneClient(config, proxy);\n   }\n \n+  /**\n+   * Create OzoneClient for token renew/cancel operations.\n+   * @param conf Configuration to be used for OzoneCient creation\n+   * @param token ozone token is involved\n+   * @return\n+   * @throws IOException\n+   */\n+  public static OzoneClient getOzoneClient(Configuration conf,\n+      Token<OzoneTokenIdentifier> token) throws IOException {\n+    Preconditions.checkNotNull(token, \"Null token is not allowed\");\n+    String omServiceId = token.decodeIdentifier().getOmServiceId();\n+    if (StringUtils.isNotEmpty(omServiceId)) {\n+      // new OM should always issue token with omServiceId\n+      if (omServiceId.equals(OzoneConsts.OM_SERVICE_ID_DEFAULT)) {\n+        // Non-HA\n+        return OzoneClientFactory.getRpcClient(conf);\n+      } else if (OmUtils.isOmHAServiceId(conf, omServiceId)) {\n+        // HA with matching service id\n+        return OzoneClientFactory.getRpcClient(omServiceId, conf);\n+      } else {\n+        // HA with mismatched service id\n+        throw new IOException(\"Service ID specified does not match\" +\n+            \" with \" + OZONE_OM_SERVICE_IDS_KEY + \" defined in the \" +\n+            \"configuration. Configured \" + OZONE_OM_SERVICE_IDS_KEY +\n+            \" are\" + conf.getTrimmedStringCollection(\n+            OZONE_OM_SERVICE_IDS_KEY));\n+      }\n+    } else {\n+      // Old OM may issue token without omServiceId that should work\n+      // with non-HA case\n+      if (!OmUtils.isServiceIdsDefined(conf)) {\n+        return OzoneClientFactory.getRpcClient(conf);\n+      } else {", "originalCommit": "0e0b790dc923e7735fc6c039c60ea51e20f16fe4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjA4NzE2MQ==", "url": "https://github.com/apache/ozone/pull/752#discussion_r402087161", "bodyText": "The serviceID must be unique to support distcp cross clusters. In the case when token does not provide omServiceId or only the default serviceID is provided. Token renew/cancel may not be able to figure out the right OM clusters to talk to. That's the main reason that we fail here.", "author": "xiaoyuyao", "createdAt": "2020-04-02T06:49:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjA1MDc1OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjA1NjQ5OQ==", "url": "https://github.com/apache/ozone/pull/752#discussion_r402056499", "bodyText": "OZONE_BUCKET_URI_DESCRIPTION -> need to be updated as o3://om or o3://serviceid", "author": "bharatviswa504", "createdAt": "2020-04-02T05:17:09Z", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/web/ozShell/token/GetTokenHandler.java", "diffHunk": "@@ -39,7 +40,9 @@\n     description = \"get a delegation token.\")\n public class GetTokenHandler extends Handler {\n \n-\n+  @CommandLine.Parameters(arity = \"1..1\",\n+      description = Shell.OZONE_BUCKET_URI_DESCRIPTION)", "originalCommit": "0e0b790dc923e7735fc6c039c60ea51e20f16fe4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjA5NTMxNA==", "url": "https://github.com/apache/ozone/pull/752#discussion_r402095314", "bodyText": "Fixed.", "author": "xiaoyuyao", "createdAt": "2020-04-02T07:08:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjA1NjQ5OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjA1ODM2Ng==", "url": "https://github.com/apache/ozone/pull/752#discussion_r402058366", "bodyText": "Minor: Can we also found service ID which helps during debug", "author": "bharatviswa504", "createdAt": "2020-04-02T05:23:57Z", "path": "hadoop-ozone/client/src/main/java/org/apache/hadoop/ozone/client/OzoneClientFactory.java", "diffHunk": "@@ -159,6 +163,47 @@ private static OzoneClient getRpcClient(ClientProtocol clientProtocol,\n     return new OzoneClient(config, proxy);\n   }\n \n+  /**\n+   * Create OzoneClient for token renew/cancel operations.\n+   * @param conf Configuration to be used for OzoneCient creation\n+   * @param token ozone token is involved\n+   * @return\n+   * @throws IOException\n+   */\n+  public static OzoneClient getOzoneClient(Configuration conf,\n+      Token<OzoneTokenIdentifier> token) throws IOException {\n+    Preconditions.checkNotNull(token, \"Null token is not allowed\");\n+    String omServiceId = token.decodeIdentifier().getOmServiceId();\n+    if (StringUtils.isNotEmpty(omServiceId)) {\n+      // new OM should always issue token with omServiceId\n+      if (omServiceId.equals(OzoneConsts.OM_SERVICE_ID_DEFAULT)) {\n+        // Non-HA\n+        return OzoneClientFactory.getRpcClient(conf);\n+      } else if (OmUtils.isOmHAServiceId(conf, omServiceId)) {\n+        // HA with matching service id\n+        return OzoneClientFactory.getRpcClient(omServiceId, conf);\n+      } else {\n+        // HA with mismatched service id\n+        throw new IOException(\"Service ID specified does not match\" +", "originalCommit": "0e0b790dc923e7735fc6c039c60ea51e20f16fe4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjA4ODE2NQ==", "url": "https://github.com/apache/ozone/pull/752#discussion_r402088165", "bodyText": "good point, will fix in the next commit.", "author": "xiaoyuyao", "createdAt": "2020-04-02T06:52:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjA1ODM2Ng=="}], "type": "inlineReview"}, {"oid": "005318d6511cac2e3101c46807395f371b503bfe", "url": "https://github.com/apache/ozone/commit/005318d6511cac2e3101c46807395f371b503bfe", "message": "Fix some token CLI issue.", "committedDate": "2020-04-07T07:07:46Z", "type": "forcePushed"}, {"oid": "4574e1ff5e53f6ac51c8bd4926134ba940c00566", "url": "https://github.com/apache/ozone/commit/4574e1ff5e53f6ac51c8bd4926134ba940c00566", "message": "HDDS-3319. Handle HA for BasicOzoneClientAdapterImpl#renew/cancel().", "committedDate": "2020-04-07T14:22:15Z", "type": "commit"}, {"oid": "071f6832cca6614618032ac33c41d29e38d2a4d7", "url": "https://github.com/apache/ozone/commit/071f6832cca6614618032ac33c41d29e38d2a4d7", "message": "address code review feedbacks and fix unit test failures", "committedDate": "2020-04-07T14:22:15Z", "type": "commit"}, {"oid": "29e0dd074fb28a2ac3c81d725ed8a2ab001c6f98", "url": "https://github.com/apache/ozone/commit/29e0dd074fb28a2ac3c81d725ed8a2ab001c6f98", "message": "More specific on the case of non-HA and single-node Ratis HA", "committedDate": "2020-04-07T14:22:16Z", "type": "commit"}, {"oid": "ba8d595a3e2b9a2e1e39b232fabf14c9ab0fe8cf", "url": "https://github.com/apache/ozone/commit/ba8d595a3e2b9a2e1e39b232fabf14c9ab0fe8cf", "message": "Fix some token CLI issue.", "committedDate": "2020-04-07T14:22:16Z", "type": "commit"}, {"oid": "ba8d595a3e2b9a2e1e39b232fabf14c9ab0fe8cf", "url": "https://github.com/apache/ozone/commit/ba8d595a3e2b9a2e1e39b232fabf14c9ab0fe8cf", "message": "Fix some token CLI issue.", "committedDate": "2020-04-07T14:22:16Z", "type": "forcePushed"}]}