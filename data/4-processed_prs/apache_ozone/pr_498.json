{"pr_number": 498, "pr_title": "HDDS-2940. mkdir : create key table entries for intermediate directories in the path", "pr_createdAt": "2020-01-27T17:25:49Z", "pr_url": "https://github.com/apache/ozone/pull/498", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjIyODg5NA==", "url": "https://github.com/apache/ozone/pull/498#discussion_r372228894", "bodyText": "There seems to be no usage for this method.", "author": "avijayanhwx", "createdAt": "2020-01-29T07:42:46Z", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/file/OMFileRequest.java", "diffHunk": "@@ -84,6 +92,70 @@ public static OMDirectoryResult verifyFilesInPath(\n     return OMDirectoryResult.NONE;\n   }\n \n+  /**\n+   * generate the object id from the transaction id.\n+   * @param id\n+   * @return object id\n+   */\n+  public static long getObjIdFromTxId(long id) {\n+    return id << TRANSACTION_ID_SHIFT;\n+  }\n+\n+  /**\n+   * Return list of missing parent directories in the given path.\n+   * @param omMetadataManager\n+   * @param volumeName\n+   * @param bucketName\n+   * @param keyPath\n+   * @return List of keys representing non-existent parent dirs\n+   * @throws IOException\n+   */\n+  public static List<String> getMissingParents(\n+      @Nonnull OMMetadataManager omMetadataManager,\n+      @Nonnull String volumeName,\n+      @Nonnull String bucketName,\n+      @Nonnull Path keyPath) throws IOException {\n+\n+    List<String> missing = new ArrayList<>();\n+\n+    while (keyPath != null) {\n+      String pathName = keyPath.toString();\n+\n+      String dbKeyName = omMetadataManager.getOzoneKey(volumeName,\n+          bucketName, pathName);\n+      String dbDirKeyName = omMetadataManager.getOzoneDirKey(volumeName,\n+          bucketName, pathName);\n+\n+      if (omMetadataManager.getKeyTable().isExist(dbKeyName)) {\n+        // Found a file in the given path.\n+        String errorMsg = \"File \" + dbKeyName + \" exists with same name as \" +\n+            \" directory in path : \" + pathName;\n+        throw new IOException(errorMsg);\n+      } else if (omMetadataManager.getKeyTable().isExist(dbDirKeyName)) {\n+        // Found a directory in the given path. Higher parents must exist.\n+        break;\n+      } else {\n+        missing.add(pathName);\n+      }\n+      keyPath = keyPath.getParent();\n+    }\n+\n+    return missing;\n+  }\n+\n+  private static OmKeyInfo getKeyInfo(", "originalCommit": "f5866a0796bd2339f5dd95abf94e4976357d1760", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mjc4ODc1Ng==", "url": "https://github.com/apache/ozone/pull/498#discussion_r372788756", "bodyText": "thanks for pointing it out, will remove. a relic from an earlier version of my patch.", "author": "supratimdeka", "createdAt": "2020-01-30T07:14:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjIyODg5NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjIzMDcyNQ==", "url": "https://github.com/apache/ozone/pull/498#discussion_r372230725", "bodyText": "Do we need to worry about this assumption not being true in clusters already deployed?", "author": "avijayanhwx", "createdAt": "2020-01-29T07:48:18Z", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/file/OMFileRequest.java", "diffHunk": "@@ -84,6 +92,70 @@ public static OMDirectoryResult verifyFilesInPath(\n     return OMDirectoryResult.NONE;\n   }\n \n+  /**\n+   * generate the object id from the transaction id.\n+   * @param id\n+   * @return object id\n+   */\n+  public static long getObjIdFromTxId(long id) {\n+    return id << TRANSACTION_ID_SHIFT;\n+  }\n+\n+  /**\n+   * Return list of missing parent directories in the given path.\n+   * @param omMetadataManager\n+   * @param volumeName\n+   * @param bucketName\n+   * @param keyPath\n+   * @return List of keys representing non-existent parent dirs\n+   * @throws IOException\n+   */\n+  public static List<String> getMissingParents(\n+      @Nonnull OMMetadataManager omMetadataManager,\n+      @Nonnull String volumeName,\n+      @Nonnull String bucketName,\n+      @Nonnull Path keyPath) throws IOException {\n+\n+    List<String> missing = new ArrayList<>();\n+\n+    while (keyPath != null) {\n+      String pathName = keyPath.toString();\n+\n+      String dbKeyName = omMetadataManager.getOzoneKey(volumeName,\n+          bucketName, pathName);\n+      String dbDirKeyName = omMetadataManager.getOzoneDirKey(volumeName,\n+          bucketName, pathName);\n+\n+      if (omMetadataManager.getKeyTable().isExist(dbKeyName)) {\n+        // Found a file in the given path.\n+        String errorMsg = \"File \" + dbKeyName + \" exists with same name as \" +\n+            \" directory in path : \" + pathName;\n+        throw new IOException(errorMsg);\n+      } else if (omMetadataManager.getKeyTable().isExist(dbDirKeyName)) {\n+        // Found a directory in the given path. Higher parents must exist.", "originalCommit": "f5866a0796bd2339f5dd95abf94e4976357d1760", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mjc4ODE1Mg==", "url": "https://github.com/apache/ozone/pull/498#discussion_r372788152", "bodyText": "because clusters are not already deployed, if we introduce this change now, we do not have that problem. Of course we are referring to customer deployments here and not any internal test setups, right?", "author": "supratimdeka", "createdAt": "2020-01-30T07:12:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjIzMDcyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzEwNTk5Mg==", "url": "https://github.com/apache/ozone/pull/498#discussion_r373105992", "bodyText": "Yes, agreed.", "author": "avijayanhwx", "createdAt": "2020-01-30T18:04:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjIzMDcyNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjIzMjY3NQ==", "url": "https://github.com/apache/ozone/pull/498#discussion_r372232675", "bodyText": "I believe this can be moved up to after the \"verifyFilesInPath\" call. Also, should we repeat the check for presence of intermediate directory path in keyTable in getMissingParents() again?", "author": "avijayanhwx", "createdAt": "2020-01-29T07:54:06Z", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/file/OMDirectoryCreateRequest.java", "diffHunk": "@@ -126,31 +129,41 @@ public OMClientResponse validateAndUpdateCache(OzoneManager ozoneManager,\n     boolean acquiredLock = false;\n     IOException exception = null;\n     OMClientResponse omClientResponse = null;\n+    List<OmKeyInfo> missingParentInfos = new ArrayList<>();\n+\n     try {\n       // check Acl\n       checkKeyAcls(ozoneManager, volumeName, bucketName, keyName,\n           IAccessAuthorizer.ACLType.CREATE, OzoneObj.ResourceType.KEY);\n \n       // Check if this is the root of the filesystem.\n       if (keyName.length() == 0) {\n-        return new OMDirectoryCreateResponse(null,\n+        return new OMDirectoryCreateResponse(null, null,\n             omResponse.setCreateDirectoryResponse(\n-                CreateDirectoryResponse.newBuilder()).build());\n+                CreateDirectoryResponse.newBuilder()).build(), false);\n       }\n       // acquire lock\n       acquiredLock = omMetadataManager.getLock().acquireWriteLock(BUCKET_LOCK,\n           volumeName, bucketName);\n \n       validateBucketAndVolume(omMetadataManager, volumeName, bucketName);\n \n+      Path keyPath = Paths.get(keyName);\n+\n       // Need to check if any files exist in the given path, if they exist we\n       // cannot create a directory with the given key.\n       OMFileRequest.OMDirectoryResult omDirectoryResult =\n           OMFileRequest.verifyFilesInPath(omMetadataManager,\n-          volumeName, bucketName, keyName, Paths.get(keyName));\n+          volumeName, bucketName, keyName, keyPath);\n+\n+      List<String> missingParents = OMFileRequest.getMissingParents(\n+          omMetadataManager, volumeName, bucketName, keyPath.getParent());\n \n       OmBucketInfo omBucketInfo = omMetadataManager.getBucketTable().get(\n           omMetadataManager.getBucketKey(volumeName, bucketName));\n+      long baseObjId = OMFileRequest.getObjIdFromTxId(transactionLogIndex);\n+      long objectCount = 1;\n+\n       OmKeyInfo dirKeyInfo = null;\n       if (omDirectoryResult == FILE_EXISTS ||", "originalCommit": "f5866a0796bd2339f5dd95abf94e4976357d1760", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzA1MjIxNw==", "url": "https://github.com/apache/ozone/pull/498#discussion_r373052217", "bodyText": "will move the code snippet as suggested.\nwould there be any benefit checking for the presence of intermediate directory in keyTable again? the objective of the function, as the name suggests is focussed on getting parents in the path which are missing.", "author": "supratimdeka", "createdAt": "2020-01-30T16:24:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjIzMjY3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDg2NzA4MQ==", "url": "https://github.com/apache/ozone/pull/498#discussion_r374867081", "bodyText": "I think we can combine the two functions to avoid doing DB reads twice. We could probably change OMDirectoryResult structure to include the result + missing dirs.", "author": "hanishakoneru", "createdAt": "2020-02-04T19:10:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjIzMjY3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTA2MTYxMw==", "url": "https://github.com/apache/ozone/pull/498#discussion_r375061613", "bodyText": "Yes, @hanishakoneru's suggestion makes sense if we want to avoid doing the same reads twice.", "author": "avijayanhwx", "createdAt": "2020-02-05T05:09:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjIzMjY3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjcxMzI4NA==", "url": "https://github.com/apache/ozone/pull/498#discussion_r376713284", "bodyText": "Thanks, makes sense. Will make the suggested change.", "author": "supratimdeka", "createdAt": "2020-02-08T14:32:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjIzMjY3NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDg2OTk1Mg==", "url": "https://github.com/apache/ozone/pull/498#discussion_r374869952", "bodyText": "How are we calculating the objectID here? Is this to ensure that the objectIDs are unique?\nI am not sure what the effects would be as we set the transactionID as the objectID everywhere else.", "author": "hanishakoneru", "createdAt": "2020-02-04T19:16:22Z", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/file/OMDirectoryCreateRequest.java", "diffHunk": "@@ -159,8 +172,24 @@ public OMClientResponse validateAndUpdateCache(OzoneManager ozoneManager,\n             FILE_ALREADY_EXISTS);\n       } else if (omDirectoryResult == DIRECTORY_EXISTS_IN_GIVENPATH ||\n           omDirectoryResult == NONE) {\n-        dirKeyInfo = createDirectoryKeyInfo(ozoneManager, omBucketInfo,\n-            volumeName, bucketName, keyName, keyArgs, transactionLogIndex);\n+        dirKeyInfo = createDirectoryKeyInfo(ozoneManager, keyName, keyArgs,\n+            baseObjId, transactionLogIndex);\n+\n+        for (String missingKey : missingParents) {\n+          LOG.debug(\"missing parent {}\", missingKey);\n+          // what about keyArgs for parent directories? TODO\n+          OmKeyInfo parentKeyInfo = createDirectoryKeyInfoNoACL(ozoneManager,\n+              missingKey, keyArgs, baseObjId + objectCount,\n+              transactionLogIndex);", "originalCommit": "3bdd258e9214d96f249fadb27d41757fb18ccca4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjcxMzY4OA==", "url": "https://github.com/apache/ozone/pull/498#discussion_r376713688", "bodyText": "the base object ID for every create is the transaction log index left shifted by 8 bits (tx log index << 8). OMFileRequest.getObjIdFromTxId() implements this logic. I have replaced all 3 places in the code where a object id is generated, with this call. intermediate directories are created iteratively by doing a +1 starting from the base object ID. that will guarantee each object id is unique - given that the base object id starts with the unique transaction log index.\nI will put in asserts to ensure there is no overflow.", "author": "supratimdeka", "createdAt": "2020-02-08T14:40:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDg2OTk1Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzM1NzAzMw==", "url": "https://github.com/apache/ozone/pull/498#discussion_r377357033", "bodyText": "We could still end up with the same objectID for keys and buckets/ volumes.\nFor example, Lets say Trxn 1 creates dir1/dir2/dir3. So objectID for dir1 would be 1 << 8 + 1 i.e. 257.\nNow let's say Trxn 257 comes in and creates bucket1. Then, dir1 and bucket1 would have the same objectID.\nLet's change the objectID for volumes, buckets and prefixInfo's too.", "author": "hanishakoneru", "createdAt": "2020-02-10T22:32:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDg2OTk1Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzU2MTk2MQ==", "url": "https://github.com/apache/ozone/pull/498#discussion_r377561961", "bodyText": "sure, will use the same object id scheme for volume and bucket.", "author": "supratimdeka", "createdAt": "2020-02-11T10:52:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDg2OTk1Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDg3MTc2MA==", "url": "https://github.com/apache/ozone/pull/498#discussion_r374871760", "bodyText": "Let's not set the updateID here as it will be set later.", "author": "hanishakoneru", "createdAt": "2020-02-04T19:19:48Z", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/file/OMDirectoryCreateRequest.java", "diffHunk": "@@ -228,10 +289,8 @@ private OmKeyInfo createDirectoryKeyInfo(OzoneManager ozoneManager,\n         .setReplicationType(HddsProtos.ReplicationType.RATIS)\n         .setReplicationFactor(HddsProtos.ReplicationFactor.ONE)\n         .setFileEncryptionInfo(encryptionInfo.orNull())\n-        .setAcls(OzoneAclUtil.fromProtobuf(keyArgs.getAclsList()))\n-        .setObjectID(transactionLogIndex)\n-        .setUpdateID(transactionLogIndex)\n-        .build();\n+        .setObjectID(objectId)\n+        .setUpdateID(0);", "originalCommit": "3bdd258e9214d96f249fadb27d41757fb18ccca4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjcxMzc0Mw==", "url": "https://github.com/apache/ozone/pull/498#discussion_r376713743", "bodyText": "sure, will make the change. any specific reason why it might not be a good idea?", "author": "supratimdeka", "createdAt": "2020-02-08T14:41:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDg3MTc2MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzM1OTU5OA==", "url": "https://github.com/apache/ozone/pull/498#discussion_r377359598", "bodyText": "No strong reason. Just to avoid setting it twice.\nBut this leads me to another thought. Instead of having a separate setObjectID and setUpdateID methods, we could have 1 method which updates both. This would ensure that we never miss setting the updateID when setting objectID. Just a thought.. unrelated to this Jira.", "author": "hanishakoneru", "createdAt": "2020-02-10T22:38:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDg3MTc2MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDg3MzI3MQ==", "url": "https://github.com/apache/ozone/pull/498#discussion_r374873271", "bodyText": "We can avoid passing the createPrefix param and use parentKeyInfos != null check only instead.", "author": "hanishakoneru", "createdAt": "2020-02-04T19:22:43Z", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/response/file/OMDirectoryCreateResponse.java", "diffHunk": "@@ -39,11 +40,17 @@\n   public static final Logger LOG =\n       LoggerFactory.getLogger(OMDirectoryCreateResponse.class);\n   private OmKeyInfo dirKeyInfo;\n+  private List<OmKeyInfo> parentKeyInfos;\n+  private boolean createPrefix;\n \n   public OMDirectoryCreateResponse(@Nullable OmKeyInfo dirKeyInfo,\n-      @Nonnull OMResponse omResponse) {\n+      @Nullable List<OmKeyInfo> parentKeyInfos,\n+      @Nonnull OMResponse omResponse,\n+      boolean createPrefix) {", "originalCommit": "3bdd258e9214d96f249fadb27d41757fb18ccca4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjcxMzg4NQ==", "url": "https://github.com/apache/ozone/pull/498#discussion_r376713885", "bodyText": "the createPrefix represents a configuration parameter. whereas parentKeyInfos can actually be null.\nyes, things will work as you suggested. I can remove the createPrefix argument. But given that it represents a config control, I would wish to retain it.\nIf you insist, then I will go ahead and remove it.", "author": "supratimdeka", "createdAt": "2020-02-08T14:43:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDg3MzI3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzM1NzQwMA==", "url": "https://github.com/apache/ozone/pull/498#discussion_r377357400", "bodyText": "Sure. I am ok with keeping the createPrefix param.", "author": "hanishakoneru", "createdAt": "2020-02-10T22:33:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDg3MzI3MQ=="}], "type": "inlineReview"}, {"oid": "0bac317c67690bda80150c0e4973f1df0030f9dc", "url": "https://github.com/apache/ozone/commit/0bac317c67690bda80150c0e4973f1df0030f9dc", "message": "addressed review comments. fixed failure in acceptance test", "committedDate": "2020-02-11T13:35:36Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTU5Mjk3NQ==", "url": "https://github.com/apache/ozone/pull/498#discussion_r379592975", "bodyText": "We already computed getObjIdRangeFromTxId() in the calling function while computing baseObjId (line 180). Can we avoid calling it again here?", "author": "hanishakoneru", "createdAt": "2020-02-14T18:59:08Z", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/file/OMDirectoryCreateRequest.java", "diffHunk": "@@ -229,12 +243,69 @@ public OMClientResponse validateAndUpdateCache(OzoneManager ozoneManager,\n           auditMap, exception, userInfo));\n     }\n \n+    logResult(createDirectoryRequest, keyArgs, omMetrics, result, trxnLogIndex,\n+        exception);\n+\n+    return omClientResponse;\n+  }\n+\n+  private List<OmKeyInfo> getAllParentInfo(OzoneManager ozoneManager,\n+      KeyArgs keyArgs, List<String> missingParents, long trxnLogIndex)\n+      throws OMException, IOException {\n+    OMMetadataManager omMetadataManager = ozoneManager.getMetadataManager();\n+    List<OmKeyInfo> missingParentInfos = new ArrayList<>();\n+\n+    ImmutablePair<Long, Long> objIdRange = OMFileRequest\n+        .getObjIdRangeFromTxId(trxnLogIndex);", "originalCommit": "ea63c4254013dcfa00566d28dbf6ef9b8ed99201", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTc0ODk1Ng==", "url": "https://github.com/apache/ozone/pull/498#discussion_r379748956", "bodyText": "the code around the previous call doesn't need to bother about the object range, only the base id. the code here requires the object range.\nworry about an extra call during directory create might be premature in the overall cpu profile?", "author": "supratimdeka", "createdAt": "2020-02-15T05:46:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTU5Mjk3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDgxMjI5MA==", "url": "https://github.com/apache/ozone/pull/498#discussion_r380812290", "bodyText": "No I was just thinking from code cleaning perspective.", "author": "hanishakoneru", "createdAt": "2020-02-18T17:09:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTU5Mjk3NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTU5MzE2MQ==", "url": "https://github.com/apache/ozone/pull/498#discussion_r379593161", "bodyText": "We can move this inside the second if else condition.", "author": "hanishakoneru", "createdAt": "2020-02-14T18:59:35Z", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/file/OMDirectoryCreateRequest.java", "diffHunk": "@@ -161,14 +167,18 @@ public OMClientResponse validateAndUpdateCache(OzoneManager ozoneManager,\n \n       validateBucketAndVolume(omMetadataManager, volumeName, bucketName);\n \n+      Path keyPath = Paths.get(keyName);\n+\n       // Need to check if any files exist in the given path, if they exist we\n       // cannot create a directory with the given key.\n+      OMFileRequest.OMPathInfo omPathInfo =\n+          OMFileRequest.verifyFilesInPath(omMetadataManager, volumeName,\n+              bucketName, keyName, keyPath);\n       OMFileRequest.OMDirectoryResult omDirectoryResult =\n-          OMFileRequest.verifyFilesInPath(omMetadataManager,\n-          volumeName, bucketName, keyName, Paths.get(keyName));\n+          omPathInfo.getDirectoryResult();\n+      List<String> missingParents = omPathInfo.getMissingParents();\n+      long baseObjId = OMFileRequest.getObjIDFromTxId(trxnLogIndex);", "originalCommit": "ea63c4254013dcfa00566d28dbf6ef9b8ed99201", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTc0OTM1MA==", "url": "https://github.com/apache/ozone/pull/498#discussion_r379749350", "bodyText": "ok", "author": "supratimdeka", "createdAt": "2020-02-15T05:47:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTU5MzE2MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTU5NDM1Mg==", "url": "https://github.com/apache/ozone/pull/498#discussion_r379594352", "bodyText": "Can we update this debug log message to indicate that the missing parent directory is being created/ added to KeyTable?", "author": "hanishakoneru", "createdAt": "2020-02-14T19:02:25Z", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/file/OMDirectoryCreateRequest.java", "diffHunk": "@@ -229,12 +243,69 @@ public OMClientResponse validateAndUpdateCache(OzoneManager ozoneManager,\n           auditMap, exception, userInfo));\n     }\n \n+    logResult(createDirectoryRequest, keyArgs, omMetrics, result, trxnLogIndex,\n+        exception);\n+\n+    return omClientResponse;\n+  }\n+\n+  private List<OmKeyInfo> getAllParentInfo(OzoneManager ozoneManager,\n+      KeyArgs keyArgs, List<String> missingParents, long trxnLogIndex)\n+      throws OMException, IOException {\n+    OMMetadataManager omMetadataManager = ozoneManager.getMetadataManager();\n+    List<OmKeyInfo> missingParentInfos = new ArrayList<>();\n+\n+    ImmutablePair<Long, Long> objIdRange = OMFileRequest\n+        .getObjIdRangeFromTxId(trxnLogIndex);\n+    long baseObjId = objIdRange.getLeft();\n+    long maxObjId = objIdRange.getRight();\n+    long maxLevels = maxObjId - baseObjId;\n+    long objectCount = 1; // baseObjID is used by the leaf directory\n+\n+    String volumeName = keyArgs.getVolumeName();\n+    String bucketName = keyArgs.getBucketName();\n+    String keyName = keyArgs.getKeyName();\n+\n+    for (String missingKey : missingParents) {\n+      long nextObjId = baseObjId + objectCount;\n+      if (nextObjId > maxObjId) {\n+        throw new OMException(\"Too many directories in path. Exceeds limit of \"\n+            + maxLevels + \". Unable to create directory: \" + keyName\n+            + \" in volume/bucket: \" + volumeName + \"/\" + bucketName,\n+            INVALID_KEY_NAME);\n+      }\n+\n+      LOG.debug(\"missing parent {}\", missingKey);", "originalCommit": "ea63c4254013dcfa00566d28dbf6ef9b8ed99201", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTc0OTQ1MA==", "url": "https://github.com/apache/ozone/pull/498#discussion_r379749450", "bodyText": "ok", "author": "supratimdeka", "createdAt": "2020-02-15T05:47:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTU5NDM1Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTU5OTM5NA==", "url": "https://github.com/apache/ozone/pull/498#discussion_r379599394", "bodyText": "We use this function multiple times (more than getObjIdRangeFromTxId()). Wouldn't it be better to directly execute shift operation here instead of calling getObjIdRangeFromTxId()?", "author": "hanishakoneru", "createdAt": "2020-02-14T19:14:04Z", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/file/OMFileRequest.java", "diffHunk": "@@ -64,24 +72,79 @@ public static OMDirectoryResult verifyFilesInPath(\n         // Found a file in the given path.\n         // Check if this is actual file or a file in the given path\n         if (dbKeyName.equals(fileNameFromDetails)) {\n-          return OMDirectoryResult.FILE_EXISTS;\n+          result = OMDirectoryResult.FILE_EXISTS;\n         } else {\n-          return OMDirectoryResult.FILE_EXISTS_IN_GIVENPATH;\n+          result = OMDirectoryResult.FILE_EXISTS_IN_GIVENPATH;\n         }\n       } else if (omMetadataManager.getKeyTable().isExist(dbDirKeyName)) {\n         // Found a directory in the given path.\n         // Check if this is actual directory or a directory in the given path\n         if (dbDirKeyName.equals(dirNameFromDetails)) {\n-          return OMDirectoryResult.DIRECTORY_EXISTS;\n+          result = OMDirectoryResult.DIRECTORY_EXISTS;\n         } else {\n-          return OMDirectoryResult.DIRECTORY_EXISTS_IN_GIVENPATH;\n+          result = OMDirectoryResult.DIRECTORY_EXISTS_IN_GIVENPATH;\n+        }\n+      } else {\n+        if (!dbDirKeyName.equals(dirNameFromDetails)) {\n+          missing.add(keyPath.toString());\n         }\n       }\n+\n+      if (result != OMDirectoryResult.NONE) {\n+        return new OMPathInfo(missing, result);\n+      }\n       keyPath = keyPath.getParent();\n     }\n \n     // Found no files/ directories in the given path.\n-    return OMDirectoryResult.NONE;\n+    return new OMPathInfo(missing, OMDirectoryResult.NONE);\n+  }\n+\n+  /**\n+   * Get the valid base object id given the transaction id.\n+   * @param id of the transaction\n+   * @return base object id allocated against the transaction\n+   */\n+  public static long getObjIDFromTxId(long id) {\n+    return getObjIdRangeFromTxId(id).getLeft();\n+  }", "originalCommit": "ea63c4254013dcfa00566d28dbf6ef9b8ed99201", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTc1MDcxMA==", "url": "https://github.com/apache/ozone/pull/498#discussion_r379750710", "bodyText": "ok", "author": "supratimdeka", "createdAt": "2020-02-15T05:51:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTU5OTM5NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTYwMjQ4NQ==", "url": "https://github.com/apache/ozone/pull/498#discussion_r379602485", "bodyText": "Double check of status.isDirectory()", "author": "hanishakoneru", "createdAt": "2020-02-14T19:21:19Z", "path": "hadoop-ozone/integration-test/src/test/java/org/apache/hadoop/fs/ozone/TestOzoneFileInterfaces.java", "diffHunk": "@@ -340,4 +385,30 @@ private Path createPath(String relativePath) {\n       return new Path(relativePath);\n     }\n   }\n+\n+  /**\n+   * verify that a directory exists and is initialized correctly.\n+   * @param path of the directory\n+   * @return null indicates FILE_NOT_FOUND, else the FileStatus\n+   * @throws IOException\n+   */\n+  private FileStatus getDirectoryStat(Path path) throws IOException {\n+\n+    FileStatus status = null;\n+\n+    try {\n+      status = fs.getFileStatus(path);\n+    } catch (FileNotFoundException e) {\n+      return null;\n+    }\n+    assertTrue(\"The created path is not directory.\", status.isDirectory());\n+\n+    assertTrue(status.isDirectory());", "originalCommit": "ea63c4254013dcfa00566d28dbf6ef9b8ed99201", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTc1MDkwOQ==", "url": "https://github.com/apache/ozone/pull/498#discussion_r379750909", "bodyText": "will remove", "author": "supratimdeka", "createdAt": "2020-02-15T05:52:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTYwMjQ4NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTYwNTkxOQ==", "url": "https://github.com/apache/ozone/pull/498#discussion_r379605919", "bodyText": "This case would never be reached in this test suit as createPrefix config is true by default and we are not overriding it.", "author": "hanishakoneru", "createdAt": "2020-02-14T19:29:06Z", "path": "hadoop-ozone/integration-test/src/test/java/org/apache/hadoop/fs/ozone/TestOzoneFileInterfaces.java", "diffHunk": "@@ -217,27 +219,70 @@ private void verifyOwnerGroup(FileStatus fileStatus) {\n \n   @Test\n   public void testDirectory() throws IOException {\n-    String dirPath = RandomStringUtils.randomAlphanumeric(5);\n-    Path path = createPath(\"/\" + dirPath);\n-    assertTrue(\"Makedirs returned with false for the path \" + path,\n-        fs.mkdirs(path));\n-\n-    FileStatus status = fs.getFileStatus(path);\n-    assertTrue(\"The created path is not directory.\", status.isDirectory());\n-\n-    assertTrue(status.isDirectory());\n-    assertEquals(FsPermission.getDirDefault(), status.getPermission());\n-    verifyOwnerGroup(status);\n+    String leafName = RandomStringUtils.randomAlphanumeric(5);\n+    OMMetadataManager metadataManager = cluster.getOzoneManager()\n+        .getMetadataManager();\n+\n+    String lev1dir = \"abc\";\n+    Path lev1path = createPath(\"/\" + lev1dir);\n+    String lev1key = metadataManager.getOzoneDirKey(volumeName, bucketName,\n+        o3fs.pathToKey(lev1path));\n+    String lev2dir = \"def\";\n+    Path lev2path = createPath(\"/\" + lev1dir + \"/\" + lev2dir);\n+    String lev2key = metadataManager.getOzoneDirKey(volumeName, bucketName,\n+        o3fs.pathToKey(lev2path));\n+\n+    FileStatus rootChild;\n+    FileStatus rootstatus;\n+    FileStatus leafstatus;\n+\n+    Path leaf = createPath(\"/\" + lev1dir + \"/\" + lev2dir + \"/\" + leafName);\n+    String leafKey = metadataManager.getOzoneDirKey(volumeName, bucketName,\n+        o3fs.pathToKey(leaf));\n+\n+    // verify prefix directories and the leaf, do not already exist\n+    assertTrue(metadataManager.getKeyTable().get(lev1key) == null);\n+    assertTrue(metadataManager.getKeyTable().get(lev2key) == null);\n+    assertTrue(metadataManager.getKeyTable().get(leafKey) == null);\n+\n+    assertTrue(\"Makedirs returned with false for the path \" + leaf,\n+        fs.mkdirs(leaf));\n+\n+    // verify the leaf directory got created.\n+    leafstatus = getDirectoryStat(leaf);\n+    assertTrue(leafstatus != null);\n+\n+    if (cluster.getOzoneManager().createPrefixEntries()) {\n+      FileStatus lev1status;\n+      FileStatus lev2status;\n+\n+      // verify prefix directories got created when creating the leaf directory.\n+      String kn = metadataManager.getKeyTable().get(lev2key).getKeyName();\n+      assertTrue(kn.equals(\"abc/def/\"));\n+      assertTrue(metadataManager\n+          .getKeyTable()\n+          .get(lev1key)\n+          .getKeyName().equals(\"abc/\"));\n+      assertTrue(metadataManager\n+          .getKeyTable()\n+          .get(lev2key)\n+          .getKeyName().equals(\"abc/def/\"));\n+      lev1status = getDirectoryStat(lev1path);\n+      lev2status = getDirectoryStat(lev2path);\n+      assertTrue((lev1status != null) && (lev2status != null));\n+      rootChild = lev1status;\n+    } else {", "originalCommit": "ea63c4254013dcfa00566d28dbf6ef9b8ed99201", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTc1MTYxNQ==", "url": "https://github.com/apache/ozone/pull/498#discussion_r379751615", "bodyText": "I'll fix that in a subsequent patch. this is a comment from @mukul1987 as well. we will include both cases in the parametrised test.", "author": "supratimdeka", "createdAt": "2020-02-15T05:54:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTYwNTkxOQ=="}], "type": "inlineReview"}, {"oid": "27b89a56216ef493c9b4695474dd37c9864a301f", "url": "https://github.com/apache/ozone/commit/27b89a56216ef493c9b4695474dd37c9864a301f", "message": "review comments.", "committedDate": "2020-02-19T03:39:08Z", "type": "forcePushed"}, {"oid": "f81d929e8e9bbf133ffc7142abec092d63c98517", "url": "https://github.com/apache/ozone/commit/f81d929e8e9bbf133ffc7142abec092d63c98517", "message": "undo findbugs related code movement in OzoneManager to fix acceptance failure", "committedDate": "2020-02-20T16:02:39Z", "type": "forcePushed"}, {"oid": "18bf1e4429c9bca13861aeb6989ae8e5e37af967", "url": "https://github.com/apache/ozone/commit/18bf1e4429c9bca13861aeb6989ae8e5e37af967", "message": "HDDS-2940. mkdir : create key table entries for intermediate directories in the path.", "committedDate": "2020-02-26T16:47:16Z", "type": "commit"}, {"oid": "db16e8893920d709752512833d3b62c91d366a5e", "url": "https://github.com/apache/ozone/commit/db16e8893920d709752512833d3b62c91d366a5e", "message": "findbugs and checkstyle issues, review comments", "committedDate": "2020-02-26T16:47:16Z", "type": "commit"}, {"oid": "dc6954dbd4d01a922a5b7d60f17ea2e1b06e9d42", "url": "https://github.com/apache/ozone/commit/dc6954dbd4d01a922a5b7d60f17ea2e1b06e9d42", "message": "findbugs null ptr. object id during key create", "committedDate": "2020-02-26T16:47:16Z", "type": "commit"}, {"oid": "953122cc6e9b1a85f2149adae22fda1be4475945", "url": "https://github.com/apache/ozone/commit/953122cc6e9b1a85f2149adae22fda1be4475945", "message": "addressed review comments. fixed failure in acceptance test", "committedDate": "2020-02-26T16:47:16Z", "type": "commit"}, {"oid": "7c560f9c77d6958f3a8c9533d69e62077953b9f4", "url": "https://github.com/apache/ozone/commit/7c560f9c77d6958f3a8c9533d69e62077953b9f4", "message": "fixed checkstyle, findbugs and unit test fails", "committedDate": "2020-02-26T16:47:16Z", "type": "commit"}, {"oid": "62c0713d73f50ae9fa29416d2e244f2b40548754", "url": "https://github.com/apache/ozone/commit/62c0713d73f50ae9fa29416d2e244f2b40548754", "message": "fixed unit test failure for Volume create, excluded internal config param from ozone-default", "committedDate": "2020-02-26T16:47:16Z", "type": "commit"}, {"oid": "d61d7dbee348b8b1d2e18f8c3309c08b15d7403b", "url": "https://github.com/apache/ozone/commit/d61d7dbee348b8b1d2e18f8c3309c08b15d7403b", "message": "checkstyle", "committedDate": "2020-02-26T16:47:16Z", "type": "commit"}, {"oid": "aae01d8316584699fac0fc9ef8d8284ae5791d4e", "url": "https://github.com/apache/ozone/commit/aae01d8316584699fac0fc9ef8d8284ae5791d4e", "message": "addressed review comments. test checks key table directly.", "committedDate": "2020-02-26T16:47:16Z", "type": "commit"}, {"oid": "a82e703590d8e2a3df9c840ba389691450b67e3e", "url": "https://github.com/apache/ozone/commit/a82e703590d8e2a3df9c840ba389691450b67e3e", "message": "review comments.", "committedDate": "2020-02-26T16:47:16Z", "type": "commit"}, {"oid": "56200628a433ccd60d6e7d6dbb314b235a9219c6", "url": "https://github.com/apache/ozone/commit/56200628a433ccd60d6e7d6dbb314b235a9219c6", "message": "undo findbugs related code movement in OzoneManager to fix acceptance failure", "committedDate": "2020-02-26T16:47:16Z", "type": "commit"}, {"oid": "f2532570603dcf852e8ed20a3ac4a40d9ead13cb", "url": "https://github.com/apache/ozone/commit/f2532570603dcf852e8ed20a3ac4a40d9ead13cb", "message": "fixed acceptance failure, default ACL issue", "committedDate": "2020-02-26T16:47:16Z", "type": "commit"}, {"oid": "ec1ec28d7733f7cb76df8be8d37a11b74a630302", "url": "https://github.com/apache/ozone/commit/ec1ec28d7733f7cb76df8be8d37a11b74a630302", "message": "checkstyle and findbugs", "committedDate": "2020-02-26T17:04:53Z", "type": "commit"}, {"oid": "ec1ec28d7733f7cb76df8be8d37a11b74a630302", "url": "https://github.com/apache/ozone/commit/ec1ec28d7733f7cb76df8be8d37a11b74a630302", "message": "checkstyle and findbugs", "committedDate": "2020-02-26T17:04:53Z", "type": "forcePushed"}]}