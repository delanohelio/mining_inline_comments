{"pr_number": 1310, "pr_title": "HDDS-4094. Support byte-level write in Freon HadoopFsGenerator", "pr_createdAt": "2020-08-10T14:52:31Z", "pr_url": "https://github.com/apache/ozone/pull/1310", "timeline": [{"oid": "cc8939517096f264ce5f64b5e79a2659ff7339ff", "url": "https://github.com/apache/ozone/commit/cc8939517096f264ce5f64b5e79a2659ff7339ff", "message": "HDDS-4094. Support byte-leve write in Freon HadoopFsGenerator", "committedDate": "2020-08-10T13:06:51Z", "type": "commit"}, {"oid": "83d834563150f40cc50e266da063e371e27fa980", "url": "https://github.com/apache/ozone/commit/83d834563150f40cc50e266da063e371e27fa980", "message": "fix findbugs problem", "committedDate": "2020-08-11T13:52:41Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODU4NDg4OA==", "url": "https://github.com/apache/ozone/pull/1310#discussion_r468584888", "bodyText": "outputStream.write(buffer, i, results in IndexOutOfBoundsException if bufferSize < keySize.\nI think it should be:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    for (int i = 0; i < nrRemaining; i += copyBufferSize) {\n          \n          \n            \n                      outputStream.write(buffer, i,\n          \n          \n            \n                          Math.min(copyBufferSize, (int) (nrRemaining - i)));\n          \n          \n            \n                    for (int i = 0; i < curSize; i += copyBufferSize) {\n          \n          \n            \n                      outputStream.write(buffer, i,\n          \n          \n            \n                          Math.min(copyBufferSize, curSize - i));\n          \n      \n    \n    \n  \n\nCan you please add a test case in TestContentGenerator for this?", "author": "adoroszlai", "createdAt": "2020-08-11T13:37:30Z", "path": "hadoop-ozone/tools/src/main/java/org/apache/hadoop/ozone/freon/ContentGenerator.java", "diffHunk": "@@ -56,7 +64,20 @@ public void write(OutputStream outputStream) throws IOException {\n     for (long nrRemaining = keySize;\n          nrRemaining > 0; nrRemaining -= bufferSize) {\n       int curSize = (int) Math.min(bufferSize, nrRemaining);\n-      outputStream.write(buffer, 0, curSize);\n+      if (copyBufferSize == 1) {\n+        for (int i = 0; i < curSize; i++) {\n+          outputStream.write(buffer[i]);\n+        }\n+      } else {\n+        for (int i = 0; i < nrRemaining; i += copyBufferSize) {\n+          outputStream.write(buffer, i,\n+              Math.min(copyBufferSize, (int) (nrRemaining - i)));", "originalCommit": "cc8939517096f264ce5f64b5e79a2659ff7339ff", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDc3MTA1OQ==", "url": "https://github.com/apache/ozone/pull/1310#discussion_r470771059", "bodyText": "Thanks the suggestions. I also created a unit test when I saw that you already suggested one, slightly different so I kept both of them ;-)", "author": "elek", "createdAt": "2020-08-14T17:54:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODU4NDg4OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODYwOTI0Nw==", "url": "https://github.com/apache/ozone/pull/1310#discussion_r468609247", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            }\n          \n          \n            \n            \n          \n          \n            \n              @Test\n          \n          \n            \n              public void writeWithDistinctSizes() throws IOException {\n          \n          \n            \n                ContentGenerator generator = new ContentGenerator(20, 8, 3);\n          \n          \n            \n                ByteArrayOutputStream output = new ByteArrayOutputStream();\n          \n          \n            \n            \n          \n          \n            \n                generator.write(output);\n          \n          \n            \n            \n          \n          \n            \n                byte[] expected = new byte[20];\n          \n          \n            \n                byte[] buffer = generator.getBuffer();\n          \n          \n            \n                System.arraycopy(buffer, 0, expected, 0, buffer.length);\n          \n          \n            \n                System.arraycopy(buffer, 0, expected, 8, buffer.length);\n          \n          \n            \n                System.arraycopy(buffer, 0, expected, 16, 4);\n          \n          \n            \n                Assert.assertArrayEquals(expected, output.toByteArray());\n          \n          \n            \n              }\n          \n          \n            \n            }", "author": "adoroszlai", "createdAt": "2020-08-11T14:10:07Z", "path": "hadoop-ozone/tools/src/test/java/org/apache/hadoop/ozone/freon/TestContentGenerator.java", "diffHunk": "@@ -0,0 +1,56 @@\n+package org.apache.hadoop.ozone.freon;\n+\n+import java.io.ByteArrayOutputStream;\n+import java.io.IOException;\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with this\n+ * work for additional information regarding copyright ownership.  The ASF\n+ * licenses this file to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ * <p>\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ * <p>\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+import org.junit.Assert;\n+import org.junit.Test;\n+\n+/**\n+ * Tests for the ContentGenerator class of Freon.\n+ */\n+public class TestContentGenerator {\n+\n+  @Test\n+  public void writeWrite() throws IOException {\n+    ContentGenerator generator = new ContentGenerator(1024, 1024);\n+    ByteArrayOutputStream output = new ByteArrayOutputStream();\n+\n+    generator.write(output);\n+    Assert.assertArrayEquals(generator.getBuffer(), output.toByteArray());\n+  }\n+\n+  @Test\n+  public void writeWithByteLevelWrite() throws IOException {\n+    ContentGenerator generator = new ContentGenerator(1024, 1024, 1);\n+    ByteArrayOutputStream output = new ByteArrayOutputStream();\n+\n+    generator.write(output);\n+    Assert.assertArrayEquals(generator.getBuffer(), output.toByteArray());\n+  }\n+\n+  @Test\n+  public void writeWithSmallBuffer() throws IOException {\n+    ContentGenerator generator = new ContentGenerator(1024, 1024, 10);\n+    ByteArrayOutputStream output = new ByteArrayOutputStream();\n+\n+    generator.write(output);\n+    Assert.assertArrayEquals(generator.getBuffer(), output.toByteArray());\n+  }\n+}", "originalCommit": "cc8939517096f264ce5f64b5e79a2659ff7339ff", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODYxMTExOA==", "url": "https://github.com/apache/ozone/pull/1310#discussion_r468611118", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n               * Number of bytes to write in one call. Should be less than the bufferSize.\n          \n          \n            \n               * Number of bytes to write in one call. Should be no larger than the bufferSize.", "author": "adoroszlai", "createdAt": "2020-08-11T14:12:37Z", "path": "hadoop-ozone/tools/src/main/java/org/apache/hadoop/ozone/freon/ContentGenerator.java", "diffHunk": "@@ -38,15 +39,23 @@\n    */\n   private int bufferSize;\n \n+  /**\n+   * Number of bytes to write in one call. Should be less than the bufferSize.", "originalCommit": "83d834563150f40cc50e266da063e371e27fa980", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "2c6fe66ea2e680c6bd868ec0bcb9cfab686d7c43", "url": "https://github.com/apache/ozone/commit/2c6fe66ea2e680c6bd868ec0bcb9cfab686d7c43", "message": "Apply suggestions from code review\n\nCo-authored-by: Doroszlai, Attila <6454655+adoroszlai@users.noreply.github.com>", "committedDate": "2020-08-14T17:44:22Z", "type": "commit"}, {"oid": "19c5cf4e213bbe01040e6b667756437fd81a90b8", "url": "https://github.com/apache/ozone/commit/19c5cf4e213bbe01040e6b667756437fd81a90b8", "message": "add one more unit test", "committedDate": "2020-08-14T17:46:23Z", "type": "commit"}, {"oid": "190300951e66edb524b55cd7c667bd84fca08ce4", "url": "https://github.com/apache/ozone/commit/190300951e66edb524b55cd7c667bd84fca08ce4", "message": "fix checkstyle", "committedDate": "2020-08-14T17:47:03Z", "type": "commit"}]}