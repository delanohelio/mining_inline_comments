{"pr_number": 839, "pr_title": "HDDS-3411. Switch Recon SQL DB to Derby.", "pr_createdAt": "2020-04-17T03:18:52Z", "pr_url": "https://github.com/apache/ozone/pull/839", "timeline": [{"oid": "1d822d7218d2eadc04da0609874ea9ca17391a74", "url": "https://github.com/apache/ozone/commit/1d822d7218d2eadc04da0609874ea9ca17391a74", "message": "HDDS-3411. Switch Recon SQL DB to Derby.", "committedDate": "2020-04-17T03:10:35Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTk4MTQ0OQ==", "url": "https://github.com/apache/ozone/pull/839#discussion_r409981449", "bodyText": "Why does this class only provide 1 configuration item? The JooqPersistence module properties should not be moved here?", "author": "swagle", "createdAt": "2020-04-17T04:08:31Z", "path": "hadoop-ozone/recon-codegen/src/main/java/org/hadoop/ozone/recon/codegen/ReconSqlDbConfig.java", "diffHunk": "@@ -0,0 +1,50 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ * <p>\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ * <p>\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.hadoop.ozone.recon.codegen;\n+\n+import org.apache.hadoop.hdds.conf.Config;\n+import org.apache.hadoop.hdds.conf.ConfigGroup;\n+import org.apache.hadoop.hdds.conf.ConfigTag;\n+import org.apache.hadoop.hdds.conf.ConfigType;\n+\n+/**\n+ * The configuration class for the Recon SQL DB.\n+ */\n+@ConfigGroup(prefix = \"ozone.recon.sql.db\")\n+public class ReconSqlDbConfig {", "originalCommit": "1d822d7218d2eadc04da0609874ea9ca17391a74", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDM2NTIxOA==", "url": "https://github.com/apache/ozone/pull/839#discussion_r410365218", "bodyText": "Yes, but the Java configuration based API is for new config items generally. The code looks at ozone-default.xml and also Java based configuration classes and creates a master list for the default xml during assembly.", "author": "avijayanhwx", "createdAt": "2020-04-17T17:25:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTk4MTQ0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDM2NDg3Nw==", "url": "https://github.com/apache/ozone/pull/839#discussion_r414364877", "bodyText": "I am 100% happy with the answer...\n... but as @anuengineer is not here I feel the responsibility to decorate pull requests with random external literature. \ud83d\ude04\nSlow migration to Java based configuration API can happen at any time:\n\nTHE BOY SCOUTS HAVE A RULE: \u201cAlways leave the campground cleaner than you found it.\u201d If you find a mess on the ground, you clean it up regardless of who might have made it. You intentionally improve the environment for the next group of campers. (Actually, the original form of that rule, written by Robert Stephenson Smyth Baden-Powell, the father of scouting, was \u201cTry and leave this world a little better than you found it.\u201d)\n\n\nWhat if we followed a similar rule in our code: \u201cAlways check a module in cleaner than when you checked it out\u201d? Regardless of who the original author was, what if we always made some effort, no matter how small, to improve the module? What would be the result?\n\nhttps://www.oreilly.com/library/view/97-things-every/9780596809515/ch08.html\n(Again, It's fine with me as is, I do the same. I skip the migration when it makes the patch harder to understand. But I never skip to add funny comments... \ud83d\ude09 )", "author": "elek", "createdAt": "2020-04-24T07:42:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTk4MTQ0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDcwNDgzOQ==", "url": "https://github.com/apache/ozone/pull/839#discussion_r414704839", "bodyText": "@elek and here comes the random quote, You can always tag me and I will show up; even if it is only for a random quote \ud83e\udd26\n\u201cWithout change, something sleeps inside us, and seldom awakens. The sleeper must awaken -- Frank Herbert, Dune \"\nThank you for doing your part :), and wake up call.", "author": "anuengineer", "createdAt": "2020-04-24T16:27:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTk4MTQ0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDg2OTI3NQ==", "url": "https://github.com/apache/ozone/pull/839#discussion_r414869275", "bodyText": "Ok guys I am convinced :) I will move all the Recon SQL DB related configs to Java in this PR. These configs are very good candidates for hiding inside the code.  They are not expected to change often.", "author": "avijayanhwx", "createdAt": "2020-04-24T21:19:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTk4MTQ0OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTk4MjA2MQ==", "url": "https://github.com/apache/ozone/pull/839#discussion_r409982061", "bodyText": "Generally, schemas are lowercase.", "author": "swagle", "createdAt": "2020-04-17T04:11:21Z", "path": "hadoop-ozone/recon-codegen/src/main/java/org/hadoop/ozone/recon/codegen/JooqCodeGenerator.java", "diffHunk": "@@ -55,10 +60,11 @@\n   private static final Logger LOG =\n       LoggerFactory.getLogger(JooqCodeGenerator.class);\n \n-  private static final String SQLITE_DB =\n-      System.getProperty(\"java.io.tmpdir\") + \"/recon-generated-schema\";\n-  private static final String JDBC_URL = \"jdbc:sqlite:\" + SQLITE_DB;\n-\n+  private static final String DB = Paths.get(\n+      System.getProperty(\"java.io.tmpdir\"),\n+      \"recon-generated-schema-\" + Time.monotonicNow()).toString();\n+  public static final String RECON_SCHEMA_NAME = \"RECON\";", "originalCommit": "1d822d7218d2eadc04da0609874ea9ca17391a74", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDM2NDQyMA==", "url": "https://github.com/apache/ozone/pull/839#discussion_r410364420", "bodyText": "Yes, but internally, I found that it becomes uppercase in the DB metadata. Hence, if I keep it as \"recon\", I have to do .toUpperCase() in Jooq code gen setSchemaName for it to find our classes.", "author": "avijayanhwx", "createdAt": "2020-04-17T17:23:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTk4MjA2MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTk4MjIyNw==", "url": "https://github.com/apache/ozone/pull/839#discussion_r409982227", "bodyText": "Any reason to use a timestamp-based path?", "author": "swagle", "createdAt": "2020-04-17T04:12:08Z", "path": "hadoop-ozone/recon-codegen/src/main/java/org/hadoop/ozone/recon/codegen/JooqCodeGenerator.java", "diffHunk": "@@ -55,10 +60,11 @@\n   private static final Logger LOG =\n       LoggerFactory.getLogger(JooqCodeGenerator.class);\n \n-  private static final String SQLITE_DB =\n-      System.getProperty(\"java.io.tmpdir\") + \"/recon-generated-schema\";\n-  private static final String JDBC_URL = \"jdbc:sqlite:\" + SQLITE_DB;\n-\n+  private static final String DB = Paths.get(\n+      System.getProperty(\"java.io.tmpdir\"),\n+      \"recon-generated-schema-\" + Time.monotonicNow()).toString();", "originalCommit": "1d822d7218d2eadc04da0609874ea9ca17391a74", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDM2Mzg1OQ==", "url": "https://github.com/apache/ozone/pull/839#discussion_r410363859", "bodyText": "If we have a failed build on a host (which I experienced), re-building fails with database already found always.", "author": "avijayanhwx", "createdAt": "2020-04-17T17:22:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTk4MjIyNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTk4MzA5NA==", "url": "https://github.com/apache/ozone/pull/839#discussion_r409983094", "bodyText": "This is actually an antipattern :-) Although I am guilty of this as well. Instead of the if we should have a DerbyDataSourceProvider, SqliteDataSourceProvider and Default one. Can be left as a TODO for later as well, upto you.", "author": "swagle", "createdAt": "2020-04-17T04:15:40Z", "path": "hadoop-ozone/recon/src/main/java/org/apache/hadoop/ozone/recon/persistence/DefaultDataSourceProvider.java", "diffHunk": "@@ -43,14 +52,26 @@\n    */\n   @Override\n   public DataSource get() {", "originalCommit": "1d822d7218d2eadc04da0609874ea9ca17391a74", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDM2MzI0Nw==", "url": "https://github.com/apache/ozone/pull/839#discussion_r410363247", "bodyText": "Yeah, I agree. Will look into this change. Maybe I can create 2 different datasource providers and re-use in the test.", "author": "avijayanhwx", "createdAt": "2020-04-17T17:21:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTk4MzA5NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDAyMDk4OA==", "url": "https://github.com/apache/ozone/pull/839#discussion_r410020988", "bodyText": "License is missing.", "author": "vivekratnavel", "createdAt": "2020-04-17T06:40:57Z", "path": "hadoop-ozone/recon/src/test/java/org/apache/hadoop/ozone/recon/persistence/TestReconWithDifferentSqlDBs.java", "diffHunk": "@@ -0,0 +1,142 @@\n+package org.apache.hadoop.ozone.recon.persistence;", "originalCommit": "1d822d7218d2eadc04da0609874ea9ca17391a74", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDM2MTI5OQ==", "url": "https://github.com/apache/ozone/pull/839#discussion_r410361299", "bodyText": "Thanks, will fix it.", "author": "avijayanhwx", "createdAt": "2020-04-17T17:17:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDAyMDk4OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDAyMTQzMQ==", "url": "https://github.com/apache/ozone/pull/839#discussion_r410021431", "bodyText": "Why should we set schema name as user?", "author": "vivekratnavel", "createdAt": "2020-04-17T06:42:08Z", "path": "hadoop-ozone/recon-codegen/src/main/java/org/hadoop/ozone/recon/codegen/JooqCodeGenerator.java", "diffHunk": "@@ -109,20 +113,25 @@ private void generateSourceCode(String outputDir) throws Exception {\n    * Provider for embedded datasource.\n    */\n   static class LocalDataSourceProvider implements Provider<DataSource> {\n-    private static SQLiteDataSource db;\n-\n+    private static EmbeddedDataSource dataSource;\n     static {\n-      db = new SQLiteDataSource();\n-      db.setUrl(JDBC_URL);\n+      try {\n+        createNewDerbyDatabase(JDBC_URL, RECON_SCHEMA_NAME);\n+      } catch (Exception e) {\n+        LOG.error(\"Error creating Recon Derby DB.\", e);\n+      }\n+      dataSource = new EmbeddedDataSource();\n+      dataSource.setDatabaseName(DB);\n+      dataSource.setUser(RECON_SCHEMA_NAME);", "originalCommit": "1d822d7218d2eadc04da0609874ea9ca17391a74", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDM2MTIwOQ==", "url": "https://github.com/apache/ozone/pull/839#discussion_r410361209", "bodyText": "In derby (at least), user name becomes the schema.", "author": "avijayanhwx", "createdAt": "2020-04-17T17:17:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDAyMTQzMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDA0NDg3Ng==", "url": "https://github.com/apache/ozone/pull/839#discussion_r410044876", "bodyText": "Thanks the patch @avijayanhwx\nCan we remove old sqlite dependency from here and from hadoop-ozone/dist/src/main/license/LICENSE.txt?\nIs it still required?\nOne other question: do you have any performance numbers between sqlite vs derby? (I don't think it's a big problem, just interested if you know sg.)", "author": "elek", "createdAt": "2020-04-17T07:36:01Z", "path": "hadoop-ozone/recon/pom.xml", "diffHunk": "@@ -331,6 +331,11 @@\n       <artifactId>bonecp</artifactId>\n       <version>0.8.0.RELEASE</version>\n     </dependency>\n+    <dependency>\n+      <groupId>org.apache.derby</groupId>\n+      <artifactId>derby</artifactId>\n+      <version>10.14.2.0</version>\n+    </dependency>\n     <dependency>", "originalCommit": "1d822d7218d2eadc04da0609874ea9ca17391a74", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDM3ODA0Mw==", "url": "https://github.com/apache/ozone/pull/839#discussion_r410378043", "bodyText": "@elek Thanks for the review.  We have not done perf testing on our SQL DB yet since we don't have a scale issue there (hopefully :) ) We will take up a task to try perf analysis between the 2 DBs. Until then, we can assume the performance between Derby vs Sqlite is similar as seen in some online references.\nRegarding the sqlite dependency that has been left around, I wanted to retain the out of the box support for sqlite in Recon (without JAR being supplied by the user). Also, we have sqlite JAR dependency in the unit tests.", "author": "avijayanhwx", "createdAt": "2020-04-17T17:49:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDA0NDg3Ng=="}], "type": "inlineReview"}, {"oid": "17f56a7ec8a5dc68ac8e48ebaa0a016e7c8e6f6c", "url": "https://github.com/apache/ozone/commit/17f56a7ec8a5dc68ac8e48ebaa0a016e7c8e6f6c", "message": "Fix integration test failure.", "committedDate": "2020-04-23T00:53:59Z", "type": "commit"}, {"oid": "83a85a6c96160c56ef7b0962f9f4acf4fc131c74", "url": "https://github.com/apache/ozone/commit/83a85a6c96160c56ef7b0962f9f4acf4fc131c74", "message": "Rat check.", "committedDate": "2020-04-23T00:59:32Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDE5NzM2Mw==", "url": "https://github.com/apache/ozone/pull/839#discussion_r414197363", "bodyText": "Can we rename to createReconTaskStatusTable for consistency?", "author": "vivekratnavel", "createdAt": "2020-04-23T23:46:51Z", "path": "hadoop-ozone/recon-codegen/src/main/java/org/hadoop/ozone/recon/schema/ReconTaskSchemaDefinition.java", "diffHunk": "@@ -48,7 +50,9 @@\n   @Override\n   public void initializeSchema() throws SQLException {\n     Connection conn = dataSource.getConnection();\n-    createReconTaskStatus(conn);\n+    if (!TABLE_EXISTS_CHECK.test(conn, RECON_TASK_STATUS_TABLE_NAME)) {\n+      createReconTaskStatus(conn);", "originalCommit": "83a85a6c96160c56ef7b0962f9f4acf4fc131c74", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjA5MTY5Mw==", "url": "https://github.com/apache/ozone/pull/839#discussion_r416091693", "bodyText": "Done.", "author": "avijayanhwx", "createdAt": "2020-04-27T19:33:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDE5NzM2Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDE5ODMzOA==", "url": "https://github.com/apache/ozone/pull/839#discussion_r414198338", "bodyText": "Can we rename to createFileSizeCountTable for consistency?", "author": "vivekratnavel", "createdAt": "2020-04-23T23:49:24Z", "path": "hadoop-ozone/recon-codegen/src/main/java/org/hadoop/ozone/recon/schema/UtilizationSchemaDefinition.java", "diffHunk": "@@ -52,8 +59,12 @@\n   @Transactional\n   public void initializeSchema() throws SQLException {\n     Connection conn = dataSource.getConnection();\n-    createClusterGrowthTable(conn);\n-    createFileSizeCount(conn);\n+    if (!TABLE_EXISTS_CHECK.test(conn, FILE_COUNT_BY_SIZE_TABLE_NAME)) {\n+      createFileSizeCount(conn);", "originalCommit": "83a85a6c96160c56ef7b0962f9f4acf4fc131c74", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjA5MTYyMw==", "url": "https://github.com/apache/ozone/pull/839#discussion_r416091623", "bodyText": "Done.", "author": "avijayanhwx", "createdAt": "2020-04-27T19:32:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDE5ODMzOA=="}], "type": "inlineReview"}, {"oid": "fed115d473fc731e54094a921b94afde1fe24702", "url": "https://github.com/apache/ozone/commit/fed115d473fc731e54094a921b94afde1fe24702", "message": "Merge remote-tracking branch 'upstream/master' into HDDS-3411-master", "committedDate": "2020-04-24T21:21:08Z", "type": "commit"}, {"oid": "d61cbd88bd90948f83e907fa769333d87d4785b0", "url": "https://github.com/apache/ozone/commit/d61cbd88bd90948f83e907fa769333d87d4785b0", "message": "Merge remote-tracking branch 'upstream/master' into HDDS-3411-master", "committedDate": "2020-04-27T19:19:21Z", "type": "commit"}, {"oid": "e22f0905691b3b79d860ea8ae112a352372fd516", "url": "https://github.com/apache/ozone/commit/e22f0905691b3b79d860ea8ae112a352372fd516", "message": "Address review comments, move SQL DB configs to Java based.", "committedDate": "2020-04-27T19:32:20Z", "type": "commit"}, {"oid": "523f50b4dc19a8b0da5fd185004811e59f236dab", "url": "https://github.com/apache/ozone/commit/523f50b4dc19a8b0da5fd185004811e59f236dab", "message": "trigger new CI check", "committedDate": "2020-04-27T21:48:45Z", "type": "commit"}, {"oid": "fa85ecd7376a8ca34598a68a52f9c6fb2d3206ef", "url": "https://github.com/apache/ozone/commit/fa85ecd7376a8ca34598a68a52f9c6fb2d3206ef", "message": "Fix TestOzoneConfigurationFields integration test failure.", "committedDate": "2020-04-27T23:04:06Z", "type": "commit"}, {"oid": "98ebd2675be7660d7355aec5d3557bfcea8f8d03", "url": "https://github.com/apache/ozone/commit/98ebd2675be7660d7355aec5d3557bfcea8f8d03", "message": "Merge branch 'master' into HDDS-3411-master", "committedDate": "2020-04-30T18:25:59Z", "type": "commit"}]}