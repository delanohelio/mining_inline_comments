{"pr_number": 1737, "pr_title": "HDDS-4568. Add SCMContext to SCM HA", "pr_createdAt": "2020-12-25T03:08:22Z", "pr_url": "https://github.com/apache/ozone/pull/1737", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODkxODc2MA==", "url": "https://github.com/apache/ozone/pull/1737#discussion_r548918760", "bodyText": "This part of a change is contained in master (#1728)", "author": "amaliujia", "createdAt": "2020-12-25T22:45:39Z", "path": "hadoop-hdds/container-service/src/main/java/org/apache/hadoop/ozone/container/common/transport/server/ratis/XceiverServerRatis.java", "diffHunk": "@@ -516,6 +515,15 @@ public RaftServer getServer() {\n     return server;\n   }\n \n+  public RaftServer.Division getServerDivision() throws IOException {", "originalCommit": "ee5e166c956b9bf698102c6ae4ad5ec36ffe7cd6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTkzMzA1NA==", "url": "https://github.com/apache/ozone/pull/1737#discussion_r549933054", "bodyText": "I see. so this is from the cherry picked commit from master.", "author": "amaliujia", "createdAt": "2020-12-30T04:38:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODkxODc2MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODkxOTM1OQ==", "url": "https://github.com/apache/ozone/pull/1737#discussion_r548919359", "bodyText": "Will it make sense to use SCMContext to get current term?", "author": "amaliujia", "createdAt": "2020-12-25T22:53:41Z", "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/ha/SCMStateMachine.java", "diffHunk": "@@ -89,4 +103,27 @@ private Message process(final SCMRatisRequest request)\n     }\n   }\n \n+  @Override\n+  public void notifyNotLeader(Collection<TransactionContext> pendingEntries) {\n+    LOG.info(\"current leader SCM steps down.\");\n+    scm.getScmContext().updateIsLeaderAndTerm(false, 0);\n+  }\n+\n+  @Override\n+  public void notifyLeaderChanged(RaftGroupMemberId groupMemberId,\n+                                  RaftPeerId newLeaderId) {\n+    if (!groupMemberId.getPeerId().equals(newLeaderId)) {\n+      LOG.info(\"leader changed, yet current SCM is still follower.\");\n+      return;\n+    }\n+\n+    long term = scm.getScmHAManager()\n+        .getRatisServer()\n+        .getDivision()\n+        .getInfo()\n+        .getCurrentTerm();", "originalCommit": "ee5e166c956b9bf698102c6ae4ad5ec36ffe7cd6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTEwNzAxNA==", "url": "https://github.com/apache/ozone/pull/1737#discussion_r551107014", "bodyText": "We use SCMContext to encapsulate raft related info, so that components in SCM won't need to hold a reference of SCMHAManager or SCMRatisServer.\nFor non-HA mode or unit test, we just need an empty SCMContext, instead of a mocked SCMHAManager or a mocked SCMRatisServer.", "author": "GlenGeng", "createdAt": "2021-01-04T03:52:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODkxOTM1OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDgzNTUxNA==", "url": "https://github.com/apache/ozone/pull/1737#discussion_r550835514", "bodyText": "Could we also catch the NotLeaderException like other places does?  There are some other places we don't catch this exception that is swallowed by IOException.\n        } catch (NotLeaderException nle) {\n\n        }  catch (IOException e) {\n          // We may tolerate a number of failures for sometime\n          // but if it continues to fail, at some point we need to raise\n          // an exception and probably fail the SCM ? At present, it simply\n          // continues to retry the scanning.\n          LOG.error(\"Failed to get block deletion transactions from delTX log\",\n              e);\n          return EmptyTaskResult.newResult();\n        }", "author": "linyiqun", "createdAt": "2021-01-02T03:00:31Z", "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/block/SCMBlockDeletingService.java", "diffHunk": "@@ -146,9 +151,10 @@ public EmptyTaskResult call() throws Exception {\n               // We should stop caching new commands if num of un-processed\n               // command is bigger than a limit, e.g 50. In case datanode goes\n               // offline for sometime, the cached commands be flooded.\n+              SCMCommand<?> command = new DeleteBlocksCommand(dnTXs);\n+              command.setTerm(scmContext.getTerm());", "originalCommit": "ee5e166c956b9bf698102c6ae4ad5ec36ffe7cd6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTEwNzI0NA==", "url": "https://github.com/apache/ozone/pull/1737#discussion_r551107244", "bodyText": "Sure, I will fix them in the next patch.", "author": "GlenGeng", "createdAt": "2021-01-04T03:53:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDgzNTUxNA=="}], "type": "inlineReview"}, {"oid": "369efc5c662b6cd10313664fd711acf97f2d904a", "url": "https://github.com/apache/ozone/commit/369efc5c662b6cd10313664fd711acf97f2d904a", "message": "HDDS-4568: add UT", "committedDate": "2021-01-06T11:30:18Z", "type": "forcePushed"}, {"oid": "d57a79aeba0528951a8ae2a2c5a4b0ea424c19a7", "url": "https://github.com/apache/ozone/commit/d57a79aeba0528951a8ae2a2c5a4b0ea424c19a7", "message": "HDDS-4568: SCMContext Part 1: Raft Related Info", "committedDate": "2021-01-12T07:19:40Z", "type": "commit"}, {"oid": "b91c678f56ab2893bd0998039d5e155d432b2b44", "url": "https://github.com/apache/ozone/commit/b91c678f56ab2893bd0998039d5e155d432b2b44", "message": "HDDS-4568: SCMContext Part 2: SafeMode Related Info", "committedDate": "2021-01-12T07:19:43Z", "type": "commit"}, {"oid": "4ea79af1e0fac8c84cf4f3d24b3e6af14f18ab06", "url": "https://github.com/apache/ozone/commit/4ea79af1e0fac8c84cf4f3d24b3e6af14f18ab06", "message": "HDDS-4568: add UT", "committedDate": "2021-01-12T07:19:43Z", "type": "commit"}, {"oid": "4ea79af1e0fac8c84cf4f3d24b3e6af14f18ab06", "url": "https://github.com/apache/ozone/commit/4ea79af1e0fac8c84cf4f3d24b3e6af14f18ab06", "message": "HDDS-4568: add UT", "committedDate": "2021-01-12T07:19:43Z", "type": "forcePushed"}, {"oid": "b38236c86bcbd16cb41bdf35281c229542b2fc94", "url": "https://github.com/apache/ozone/commit/b38236c86bcbd16cb41bdf35281c229542b2fc94", "message": "HDDS-4568: Fix comments and failed tests.", "committedDate": "2021-01-12T10:40:25Z", "type": "commit"}, {"oid": "b38236c86bcbd16cb41bdf35281c229542b2fc94", "url": "https://github.com/apache/ozone/commit/b38236c86bcbd16cb41bdf35281c229542b2fc94", "message": "HDDS-4568: Fix comments and failed tests.", "committedDate": "2021-01-12T10:40:25Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NjI3MzcwMg==", "url": "https://github.com/apache/ozone/pull/1737#discussion_r556273702", "bodyText": "Nit: will it better to replace constructor by a builder for creating instances of SCMContext? It could improve readability when constructing a SCMContext. E.g. setting as a follower for SCMContext versus setting as a leader, a setLeader(true/false) is more understandable. Also using constructor with multiple parameters  in multiple places is a signal to use builder pattern.", "author": "amaliujia", "createdAt": "2021-01-13T05:38:05Z", "path": "hadoop-hdds/server-scm/src/test/java/org/apache/hadoop/hdds/scm/ha/TestSCMContext.java", "diffHunk": "@@ -0,0 +1,67 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ * <p>\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ * <p>\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hadoop.hdds.scm.ha;\n+\n+import org.apache.hadoop.hdds.scm.safemode.SCMSafeModeManager.SafeModeStatus;\n+import org.apache.ratis.protocol.exceptions.NotLeaderException;\n+import org.junit.Test;\n+\n+import static org.junit.Assert.assertTrue;\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertFalse;\n+import static org.junit.Assert.fail;\n+\n+/**\n+ * Test for SCMContext.\n+ */\n+public class TestSCMContext {\n+  @Test\n+  public void testRaftOperations() {\n+    // start as follower\n+    SCMContext scmContext = new SCMContext(false, 0, null, null);", "originalCommit": "b38236c86bcbd16cb41bdf35281c229542b2fc94", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzAxNTUyMQ==", "url": "https://github.com/apache/ozone/pull/1737#discussion_r557015521", "bodyText": "Agree. Will fix in #1784.", "author": "GlenGeng", "createdAt": "2021-01-14T03:08:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NjI3MzcwMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1ODA4MDI3MQ==", "url": "https://github.com/apache/ozone/pull/1737#discussion_r558080271", "bodyText": "i agree.", "author": "bshashikant", "createdAt": "2021-01-15T09:01:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NjI3MzcwMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1OTIwMjY1Nw==", "url": "https://github.com/apache/ozone/pull/1737#discussion_r559202657", "bodyText": "If you have reviewed HDDS-4295. Add SCMServiceManager to SCM HA, please ignore this PR, since the first 4 commits of SCMServiceManager are exactly from this PR.\nbtw, I have added a builder for SCMContext in the latest commit of SCMServiceManager.", "author": "GlenGeng", "createdAt": "2021-01-17T16:13:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NjI3MzcwMg=="}], "type": "inlineReview"}]}