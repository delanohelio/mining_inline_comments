{"pr_number": 1322, "pr_title": "HDDS-3829. Introduce Layout Feature interface in Ozone.", "pr_createdAt": "2020-08-12T14:56:27Z", "pr_url": "https://github.com/apache/ozone/pull/1322", "timeline": [{"oid": "3f8e7b2bf6770340eaa3c7c54a23ca2bf8e990e5", "url": "https://github.com/apache/ozone/commit/3f8e7b2bf6770340eaa3c7c54a23ca2bf8e990e5", "message": "HDDS-3829. Introduce Layout Feature interface in Ozone.", "committedDate": "2020-08-12T14:55:23Z", "type": "commit"}, {"oid": "5349fa8ed7027ace8d79225814ef1e13ce9856e3", "url": "https://github.com/apache/ozone/commit/5349fa8ed7027ace8d79225814ef1e13ce9856e3", "message": "Fix rat and checkstyle.", "committedDate": "2020-08-12T15:07:47Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTMxMzkyOA==", "url": "https://github.com/apache/ozone/pull/1322#discussion_r471313928", "bodyText": "This might go into a separate pull request and we may commit it way before the branch is commited.", "author": "fapifta", "createdAt": "2020-08-17T08:13:12Z", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/response/s3/security/package-info.java", "diffHunk": "@@ -19,4 +19,4 @@\n /**\n  * Package contains classes related to S3 security responses.\n  */\n-package org.apache.hadoop.ozone.om.request.s3.security;\n+package org.apache.hadoop.ozone.om.response.s3.security;", "originalCommit": "5349fa8ed7027ace8d79225814ef1e13ce9856e3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTc0MTc1NA==", "url": "https://github.com/apache/ozone/pull/1322#discussion_r475741754", "bodyText": "Agreed. I had to include this since the plugin that was added for scanning annotations fails the build due to this discrepancy. I will create a separate JIRA to fix this on master, but since it is a tiny change, I would like to leave it here until then to keep the build green.", "author": "avijayanhwx", "createdAt": "2020-08-24T16:32:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTMxMzkyOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTMzMjQ1MQ==", "url": "https://github.com/apache/ozone/pull/1322#discussion_r471332451", "bodyText": "Can you please elaborate what will this line do in the test, and why it has to be here? It is unclear whether it tests anything, or this is just a leftover from a thought.", "author": "fapifta", "createdAt": "2020-08-17T08:46:48Z", "path": "hadoop-ozone/ozone-manager/src/test/java/org/apache/hadoop/ozone/om/upgrade/TestOMVersionManager.java", "diffHunk": "@@ -0,0 +1,63 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hadoop.ozone.om.upgrade;\n+\n+import static org.apache.hadoop.ozone.om.upgrade.OMLayoutFeatureCatalog.OMLayoutFeature.CREATE_EC;\n+import static org.apache.hadoop.ozone.om.upgrade.OMLayoutFeatureCatalog.OMLayoutFeature.INITIAL_VERSION;\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertFalse;\n+import static org.junit.Assert.assertTrue;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.when;\n+\n+import java.io.IOException;\n+\n+import org.apache.hadoop.ozone.om.OMStorage;\n+import org.apache.hadoop.ozone.om.OzoneManager;\n+import org.apache.hadoop.ozone.om.upgrade.OMLayoutFeatureCatalog.OMLayoutFeature;\n+import org.apache.hadoop.ozone.upgrade.LayoutFeature;\n+import org.junit.Test;\n+\n+/**\n+ * Test OM layout version management.\n+ */\n+public class TestOMVersionManager {\n+\n+  @Test\n+  public void testOMLayoutVersionManager() throws IOException {\n+    OMStorage omStorage = mock(OMStorage.class);\n+    when(omStorage.getLayoutVersion()).thenReturn(0);\n+    OMVersionManager.init(omStorage);\n+    assertTrue(OMVersionManager.isAllowed(INITIAL_VERSION));\n+    assertFalse(OMVersionManager.isAllowed(CREATE_EC));\n+    assertEquals(0, OMVersionManager.getMetadataLayoutVersion());\n+    assertTrue(OMVersionManager.needsFinalization());\n+    OMVersionManager.doFinalize(mock(OzoneManager.class));", "originalCommit": "5349fa8ed7027ace8d79225814ef1e13ce9856e3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTc0MjQ3Mw==", "url": "https://github.com/apache/ozone/pull/1322#discussion_r475742473", "bodyText": "I am sure it is a leftover line ;) I will remove it.", "author": "avijayanhwx", "createdAt": "2020-08-24T16:33:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTMzMjQ1MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTM0NjE0OA==", "url": "https://github.com/apache/ozone/pull/1322#discussion_r471346148", "bodyText": "If we use an enum to store the list of features in a component, why do we need the enclosing class here? Is there a future intent hidden here, or it is just a leftover from an earlier implementation?", "author": "fapifta", "createdAt": "2020-08-17T09:11:46Z", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/upgrade/OMLayoutFeatureCatalog.java", "diffHunk": "@@ -0,0 +1,71 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hadoop.ozone.om.upgrade;\n+\n+import java.util.Optional;\n+\n+import org.apache.hadoop.ozone.upgrade.LayoutFeature;\n+\n+/**\n+ * Catalog of Ozone Manager features.\n+ */\n+public class OMLayoutFeatureCatalog {", "originalCommit": "5349fa8ed7027ace8d79225814ef1e13ce9856e3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTc0MDYzMQ==", "url": "https://github.com/apache/ozone/pull/1322#discussion_r475740631", "bodyText": "Good point. I wanted to have an enclosing class for \"ease\" of understanding. We have a 'catalog' of features in OM. In the future, we can expect some helper methods to be added at the catalog level which may not be needed at the Feature level.", "author": "avijayanhwx", "createdAt": "2020-08-24T16:30:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTM0NjE0OA=="}], "type": "inlineReview"}, {"oid": "68127fe034ef9dabab25e6b87c4fe383959e4cad", "url": "https://github.com/apache/ozone/commit/68127fe034ef9dabab25e6b87c4fe383959e4cad", "message": "Refactoring based on review comments.", "committedDate": "2020-08-24T22:21:18Z", "type": "commit"}, {"oid": "a41d917d326f7233f8e9a0b5701ee9e1dccd395d", "url": "https://github.com/apache/ozone/commit/a41d917d326f7233f8e9a0b5701ee9e1dccd395d", "message": "Fix CS and Rat issues.", "committedDate": "2020-08-24T23:32:43Z", "type": "commit"}, {"oid": "1f68135a48ee4d26b6884abd7adb8f94b4b95d3d", "url": "https://github.com/apache/ozone/commit/1f68135a48ee4d26b6884abd7adb8f94b4b95d3d", "message": "Fix unit test and findbug.", "committedDate": "2020-08-25T19:47:34Z", "type": "commit"}, {"oid": "27154adc9898b7c5debfcecc5f527fcb768fe38b", "url": "https://github.com/apache/ozone/commit/27154adc9898b7c5debfcecc5f527fcb768fe38b", "message": "trigger new CI check", "committedDate": "2020-08-25T22:16:58Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODUzMTM3Nw==", "url": "https://github.com/apache/ozone/pull/1322#discussion_r478531377", "bodyText": "Sometimes metadataLayoutVersion is not always updated during rolling, we should have one variable called lastSoftwareLayoutVersion to compare with softwareLayoutVersion. And then to decide if we need to finalized.", "author": "linyiqun", "createdAt": "2020-08-27T16:05:13Z", "path": "hadoop-hdds/common/src/main/java/org/apache/hadoop/ozone/upgrade/AbstractLayoutVersionManager.java", "diffHunk": "@@ -0,0 +1,110 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hadoop.ozone.upgrade;\n+\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.Iterator;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.TreeMap;\n+\n+import com.google.common.base.Preconditions;\n+\n+/**\n+ * Layout Version Manager containing generic method implementations.\n+ */\n+@SuppressWarnings(\"visibilitymodifier\")\n+public abstract class AbstractLayoutVersionManager implements\n+    LayoutVersionManager {\n+\n+  protected int metadataLayoutVersion; // MLV.\n+  protected int softwareLayoutVersion; // SLV.\n+  protected TreeMap<Integer, LayoutFeature> features = new TreeMap<>();\n+  protected Map<String, LayoutFeature> featureMap = new HashMap<>();\n+  protected volatile boolean isInitialized = false;\n+\n+  protected void init(int version, LayoutFeature[] lfs) {\n+    if (!isInitialized) {\n+      metadataLayoutVersion = version;\n+      initializeFeatures(lfs);\n+      softwareLayoutVersion = features.lastKey();\n+      isInitialized = true;\n+    }\n+  }\n+\n+  protected void initializeFeatures(LayoutFeature[] lfs) {\n+    Arrays.stream(lfs).forEach(f -> {\n+      Preconditions.checkArgument(!featureMap.containsKey(f.name()));\n+      Preconditions.checkArgument(!features.containsKey(f.layoutVersion()));\n+      features.put(f.layoutVersion(), f);\n+      featureMap.put(f.name(), f);\n+    });\n+  }\n+\n+  public int getMetadataLayoutVersion() {\n+    return metadataLayoutVersion;\n+  }\n+\n+  public int getSoftwareLayoutVersion() {\n+    return softwareLayoutVersion;\n+  }\n+\n+  public boolean needsFinalization() {\n+    return metadataLayoutVersion < softwareLayoutVersion;", "originalCommit": "27154adc9898b7c5debfcecc5f527fcb768fe38b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODU2MDgwMw==", "url": "https://github.com/apache/ozone/pull/1322#discussion_r478560803", "bodyText": "@linyiqun The lastSoftwareLayoutVersion is what we write into the OM Version file on finalize. This is what we read into the MLV during init. Hence, MLV is same as 'lastSoftwareLayoutVersion'.\nLet's say you finalized when you have features 1,2,3. So you write the value \"3\" into the Version file on finalize. The next software has layout features 1,2,3,4,5. When you \"upgrade\" the software bits and start OM, then it will see MLV = 3 and SLV = max(version(feature)). Since 3 < 5, it needs to be finalized again.", "author": "avijayanhwx", "createdAt": "2020-08-27T16:53:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODUzMTM3Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODU2MjY3OA==", "url": "https://github.com/apache/ozone/pull/1322#discussion_r478562678", "bodyText": "After finalize, the MLV becomes same as SLV (after writing to Version file), and then all feature APIs > 3 and <= 5 are now allowed.", "author": "avijayanhwx", "createdAt": "2020-08-27T16:56:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODUzMTM3Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODU3ODA0NQ==", "url": "https://github.com/apache/ozone/pull/1322#discussion_r478578045", "bodyText": "In the v2 Upgrade doc, we were talking about LFV (Last Finalized Version) in terms of handling the Ratis \"Apply Transaction\" changes. For the first version, since we are adding 'Apply Transaction' changes also as Layout Features, we do not need that.\nBased on how often apply transaction changes are needed, in the next version of implementation, we can maintain \"software version\" separately from metadata layout version. The only extra added benefit for that is that we can support downgrades with just apply transaction changes, and no layout version changes.", "author": "avijayanhwx", "createdAt": "2020-08-27T17:23:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODUzMTM3Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODUzMzMwMA==", "url": "https://github.com/apache/ozone/pull/1322#discussion_r478533300", "bodyText": "Here softwareLayoutVersion is extracted from LayoutFeature, this seems also like a metadataLayoutVersion. is this true? It looks a little confused here.", "author": "linyiqun", "createdAt": "2020-08-27T16:08:12Z", "path": "hadoop-hdds/common/src/main/java/org/apache/hadoop/ozone/upgrade/AbstractLayoutVersionManager.java", "diffHunk": "@@ -0,0 +1,110 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hadoop.ozone.upgrade;\n+\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.Iterator;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.TreeMap;\n+\n+import com.google.common.base.Preconditions;\n+\n+/**\n+ * Layout Version Manager containing generic method implementations.\n+ */\n+@SuppressWarnings(\"visibilitymodifier\")\n+public abstract class AbstractLayoutVersionManager implements\n+    LayoutVersionManager {\n+\n+  protected int metadataLayoutVersion; // MLV.\n+  protected int softwareLayoutVersion; // SLV.\n+  protected TreeMap<Integer, LayoutFeature> features = new TreeMap<>();\n+  protected Map<String, LayoutFeature> featureMap = new HashMap<>();\n+  protected volatile boolean isInitialized = false;\n+\n+  protected void init(int version, LayoutFeature[] lfs) {\n+    if (!isInitialized) {\n+      metadataLayoutVersion = version;\n+      initializeFeatures(lfs);\n+      softwareLayoutVersion = features.lastKey();", "originalCommit": "27154adc9898b7c5debfcecc5f527fcb768fe38b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODU2MTI4MQ==", "url": "https://github.com/apache/ozone/pull/1322#discussion_r478561281", "bodyText": "Same as I have explained in the last comment.", "author": "avijayanhwx", "createdAt": "2020-08-27T16:53:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODUzMzMwMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODgxMzA4Mw==", "url": "https://github.com/apache/ozone/pull/1322#discussion_r478813083", "bodyText": "I am looking into for this logic again. If new version is not finalized, metadataLayoutVersion will still older than new SLV = max(version(feature)), that means this new introduced features contained in new Ozone version cannot work until we do the finalize. But actually sometimes, some features can have a minimal compatible version, it can allow to run >=  minimal compatible MLV.\nFor the first step implementation, we could make each minimal compatible MLV as their current layout version, like\npublic enum OMLayoutFeature implements LayoutFeature {\nINITIAL_VERSION(0, 0, \"Initial Layout Version\"),\nCREATE_EC(1, 1, \"\"),\nNEW_FEATURE(2, 2, \"new feature\", new NewOmFeatureUpgradeAction());\nprivate int layoutVersion;\nprivate int minCompatLayoutVersion\n\nAnd then use minCompatLayoutVersion to do compatibility check. Not sure if this change is expected to do in next step.", "author": "linyiqun", "createdAt": "2020-08-28T03:39:52Z", "path": "hadoop-hdds/common/src/main/java/org/apache/hadoop/ozone/upgrade/AbstractLayoutVersionManager.java", "diffHunk": "@@ -0,0 +1,110 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hadoop.ozone.upgrade;\n+\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.Iterator;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.TreeMap;\n+\n+import com.google.common.base.Preconditions;\n+\n+/**\n+ * Layout Version Manager containing generic method implementations.\n+ */\n+@SuppressWarnings(\"visibilitymodifier\")\n+public abstract class AbstractLayoutVersionManager implements\n+    LayoutVersionManager {\n+\n+  protected int metadataLayoutVersion; // MLV.\n+  protected int softwareLayoutVersion; // SLV.\n+  protected TreeMap<Integer, LayoutFeature> features = new TreeMap<>();\n+  protected Map<String, LayoutFeature> featureMap = new HashMap<>();\n+  protected volatile boolean isInitialized = false;\n+\n+  protected void init(int version, LayoutFeature[] lfs) {\n+    if (!isInitialized) {\n+      metadataLayoutVersion = version;\n+      initializeFeatures(lfs);\n+      softwareLayoutVersion = features.lastKey();\n+      isInitialized = true;\n+    }\n+  }\n+\n+  protected void initializeFeatures(LayoutFeature[] lfs) {\n+    Arrays.stream(lfs).forEach(f -> {\n+      Preconditions.checkArgument(!featureMap.containsKey(f.name()));\n+      Preconditions.checkArgument(!features.containsKey(f.layoutVersion()));\n+      features.put(f.layoutVersion(), f);\n+      featureMap.put(f.name(), f);\n+    });\n+  }\n+\n+  public int getMetadataLayoutVersion() {\n+    return metadataLayoutVersion;\n+  }\n+\n+  public int getSoftwareLayoutVersion() {\n+    return softwareLayoutVersion;\n+  }\n+\n+  public boolean needsFinalization() {\n+    return metadataLayoutVersion < softwareLayoutVersion;\n+  }\n+\n+  public boolean isAllowed(LayoutFeature layoutFeature) {\n+    return layoutFeature.layoutVersion() <= metadataLayoutVersion;", "originalCommit": "27154adc9898b7c5debfcecc5f527fcb768fe38b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDQ4ODk2Ng==", "url": "https://github.com/apache/ozone/pull/1322#discussion_r480488966", "bodyText": "@linyiqun It is by design that newer \"layout\" features cannot work in Ozone until finalize. We will have a concept of Minimum Compatible layout version in the future, which is used to denote the minimum Layout version from which you can upgrade to the current layout version.", "author": "avijayanhwx", "createdAt": "2020-09-01T00:16:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODgxMzA4Mw=="}], "type": "inlineReview"}]}