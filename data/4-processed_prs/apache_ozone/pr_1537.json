{"pr_number": 1537, "pr_title": "HDDS-4413. Container replication should fail in case of import failure.", "pr_createdAt": "2020-10-31T10:26:03Z", "pr_url": "https://github.com/apache/ozone/pull/1537", "timeline": [{"oid": "f7f3481858502618711fc03701ac321e1f4e7bbd", "url": "https://github.com/apache/ozone/commit/f7f3481858502618711fc03701ac321e1f4e7bbd", "message": "HDDS-4413. Container replication logs success despite import failure.", "committedDate": "2020-10-31T10:21:43Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjgwMTE0MQ==", "url": "https://github.com/apache/ozone/pull/1537#discussion_r516801141", "bodyText": "I think we should remove this catch block completely.  Logging the same exception both here and in the caller (replicate()) is IMO unnecessary.", "author": "adoroszlai", "createdAt": "2020-11-03T16:34:18Z", "path": "hadoop-hdds/container-service/src/main/java/org/apache/hadoop/ozone/container/replication/DownloadAndImportReplicator.java", "diffHunk": "@@ -89,6 +91,7 @@ public void importContainer(long containerID, Path tarFilePath) {\n       LOG.error(\n           \"Can't import the downloaded container data id=\" + containerID,\n           e);\n+      throw e;", "originalCommit": "f7f3481858502618711fc03701ac321e1f4e7bbd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjg5MDMxOA==", "url": "https://github.com/apache/ozone/pull/1537#discussion_r516890318", "bodyText": "Yeps, Removed!!!", "author": "ayushtkn", "createdAt": "2020-11-03T19:00:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjgwMTE0MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjgwMTY1MQ==", "url": "https://github.com/apache/ozone/pull/1537#discussion_r516801651", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  LOG.error(\"Container replication was unsuccessful.\", e);\n          \n          \n            \n                  LOG.error(\"Container {} replication was unsuccessful.\", containerID, e);", "author": "adoroszlai", "createdAt": "2020-11-03T16:35:03Z", "path": "hadoop-hdds/container-service/src/main/java/org/apache/hadoop/ozone/container/replication/DownloadAndImportReplicator.java", "diffHunk": "@@ -122,7 +125,7 @@ public void replicate(ReplicationTask task) {\n       LOG.info(\"Container {} is replicated successfully\", containerID);\n       task.setStatus(Status.DONE);\n     } catch (Exception e) {\n-      LOG.error(\"Container replication was unsuccessful .\", e);\n+      LOG.error(\"Container replication was unsuccessful.\", e);", "originalCommit": "f7f3481858502618711fc03701ac321e1f4e7bbd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjg5MDQ1Nw==", "url": "https://github.com/apache/ozone/pull/1537#discussion_r516890457", "bodyText": "Done", "author": "ayushtkn", "createdAt": "2020-11-03T19:01:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjgwMTY1MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjgyNTM3Nw==", "url": "https://github.com/apache/ozone/pull/1537#discussion_r516825377", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                res.complete(Paths.get(\"file:/tmp/file\"));\n          \n          \n            \n                res.complete(Paths.get(\"file:/tmp/no-such-file\"));\n          \n      \n    \n    \n  \n\nThis would document that the expected failure is due to FileNotFoundException.", "author": "adoroszlai", "createdAt": "2020-11-03T17:09:07Z", "path": "hadoop-hdds/container-service/src/test/java/org/apache/hadoop/ozone/container/replication/TestReplicationSupervisor.java", "diffHunk": "@@ -173,6 +178,36 @@ public void stalledDownload() {\n     }\n   }\n \n+  @Test\n+  public void testDownloadAndImportReplicatorFailure() {\n+    ReplicationSupervisor supervisor =\n+        new ReplicationSupervisor(set, mutableReplicator,\n+            newDirectExecutorService());\n+\n+    // Mock to fetch an exception in the importContainer method.\n+    SimpleContainerDownloader moc =\n+        Mockito.mock(SimpleContainerDownloader.class);\n+    CompletableFuture<Path> res = new CompletableFuture<>();\n+    res.complete(Paths.get(\"file:/tmp/file\"));", "originalCommit": "f7f3481858502618711fc03701ac321e1f4e7bbd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjg5MDYyOA==", "url": "https://github.com/apache/ozone/pull/1537#discussion_r516890628", "bodyText": "Changed", "author": "ayushtkn", "createdAt": "2020-11-03T19:01:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjgyNTM3Nw=="}], "type": "inlineReview"}, {"oid": "9839940507602338e1ba98637f50461e19bf685e", "url": "https://github.com/apache/ozone/commit/9839940507602338e1ba98637f50461e19bf685e", "message": "Handle review comments.", "committedDate": "2020-11-03T18:55:16Z", "type": "commit"}]}