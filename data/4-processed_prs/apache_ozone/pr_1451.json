{"pr_number": 1451, "pr_title": "HDDS-4117. Normalize Keypath for listKeys.", "pr_createdAt": "2020-09-29T03:54:05Z", "pr_url": "https://github.com/apache/ozone/pull/1451", "timeline": [{"oid": "2be2252dc049911afdba0e8645579f03da7f1ffb", "url": "https://github.com/apache/ozone/commit/2be2252dc049911afdba0e8645579f03da7f1ffb", "message": "fix test", "committedDate": "2020-09-29T19:56:12Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTUyNTkyMg==", "url": "https://github.com/apache/ozone/pull/1451#discussion_r499525922", "bodyText": "NIT:\nI think it's easier to follow to move the condition to here:\n     if (enableFileSystemPaths) {\n       startKey = normalizeListKeyPath(startKey);\n       keyPrefix = normalizeListKeyPath(keyPrefix);\n    }\n\nDespite the name, the startKey and keyPrefix are not normalized if enableFileSystemPaths is false", "author": "elek", "createdAt": "2020-10-05T11:23:17Z", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/KeyManagerImpl.java", "diffHunk": "@@ -919,12 +920,32 @@ private boolean isKeyEmpty(OmKeyInfo keyInfo) {\n     // underlying table using an iterator. That automatically creates a\n     // snapshot of the data, so we don't need these locks at a higher level\n     // when we iterate.\n+\n+    startKey = normalizeListKeyPath(startKey);\n+    keyPrefix = normalizeListKeyPath(keyPrefix);", "originalCommit": "2be2252dc049911afdba0e8645579f03da7f1ffb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTgwNjE0OQ==", "url": "https://github.com/apache/ozone/pull/1451#discussion_r499806149", "bodyText": "As anyway this condition needs to be checked inside normalizeListKeyPath, so not performed check again here.", "author": "bharatviswa504", "createdAt": "2020-10-05T18:57:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTUyNTkyMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjM1MjM0OQ==", "url": "https://github.com/apache/ozone/pull/1451#discussion_r502352349", "bodyText": "Sorry, I don't get it. Why do we need to check it inside normalizeListKeyPath.\nAs I wrote it's a very minor thing, but it seems to be better to move out the check from the method because it improves the readability (IMHO!).\nWhen somebody read the listKeys method it suggest the the keys are normalized. but in fact it's normalized only if enableFileSystemPaths. This can be confusing as the method name is normalizeListKeyPath and not something like normalizeListKeyPathIfNormalizationIsEnabled.\nI suggested moving out this condition from this method to improve the readibility, but if you think it's a bad idea, it can be ignored.", "author": "elek", "createdAt": "2020-10-09T11:03:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTUyNTkyMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODg4ODYzOA==", "url": "https://github.com/apache/ozone/pull/1451#discussion_r508888638", "bodyText": "Thanks to explain it. I understood your point. Updated the code.", "author": "bharatviswa504", "createdAt": "2020-10-20T22:58:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTUyNTkyMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTUyNjMwNQ==", "url": "https://github.com/apache/ozone/pull/1451#discussion_r499526305", "bodyText": "Is there any reason to keep these two features (return empty string for empty string + keep closing /) in here intead of moving to  OmUtils.normalizeKey(keyPath)", "author": "elek", "createdAt": "2020-10-05T11:24:00Z", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/KeyManagerImpl.java", "diffHunk": "@@ -919,12 +920,32 @@ private boolean isKeyEmpty(OmKeyInfo keyInfo) {\n     // underlying table using an iterator. That automatically creates a\n     // snapshot of the data, so we don't need these locks at a higher level\n     // when we iterate.\n+\n+    startKey = normalizeListKeyPath(startKey);\n+    keyPrefix = normalizeListKeyPath(keyPrefix);\n+\n     List<OmKeyInfo> keyList = metadataManager.listKeys(volumeName, bucketName,\n         startKey, keyPrefix, maxKeys);\n     refreshPipeline(keyList);\n     return keyList;\n   }\n \n+  private String normalizeListKeyPath(String keyPath) {\n+\n+    String normalizeKeyPath = keyPath;\n+    if (enableFileSystemPaths) {\n+      // For empty strings do nothing.\n+      if (StringUtils.isBlank(keyPath)) {", "originalCommit": "2be2252dc049911afdba0e8645579f03da7f1ffb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTgwNTU1NA==", "url": "https://github.com/apache/ozone/pull/1451#discussion_r499805554", "bodyText": "For key ending with \"/\" after normalizing it will return the key without trailing \"/\". As here the key intended to be searched is, I have added it back here. In my view removing \"/\" at the end when the user explicitly asked to search for keys end with \"/\", it might return results differently, as I don't want to change current semantics.\nExample:\nthe prefix is \"/a/b/c/d/\" -> after Normalize \"/a/b/c/d\"\nSo if we don't add \"/\" back, it will return keys with prefix \"/a/b/c/d\", but user intention here is to get keys in \"/a/b/c/d/\" so not to change semantics for this case handled in this method instead of common method used by all classes.\nAnd also for null not calling OmUtils.normalizeKey(keyPath), the Paths method will fail with NPE, so this is also considered a special case and handled it in this method.", "author": "bharatviswa504", "createdAt": "2020-10-05T18:56:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTUyNjMwNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjM1Nzc3OA==", "url": "https://github.com/apache/ozone/pull/1451#discussion_r502357778", "bodyText": "Thanks to explain it.\n\nthe Paths method will fail with NPE, so this is also\n\nNot a big deal, but if we move the empty check, to normalizeKey, the method will be safe forever, and we don't need to do the empty check all the time when we need to call it.", "author": "elek", "createdAt": "2020-10-09T11:15:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTUyNjMwNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjM1ODg2Mw==", "url": "https://github.com/apache/ozone/pull/1451#discussion_r502358863", "bodyText": "BTW (just a discussion not a code review comment): it can be useful to differentiate between normalization (removing/resolving .., //) and handling closing /. My impression is that we need different rules for them.\nThis is a good example here: you need the first (\"normalization\") but not the second. (Maybe two different method?)", "author": "elek", "createdAt": "2020-10-09T11:17:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTUyNjMwNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODg5MTE3Nw==", "url": "https://github.com/apache/ozone/pull/1451#discussion_r508891177", "bodyText": "Thanks for clear explanation, I have updated to move null check to normalizeKey method.\n\nBTW (just a discussion not a code review comment): it can be useful to differentiate between normalization\n(removing/resolving .., //) and handling closing /. My impression is that we need different rules for them.\n\nUpdated OmUtils.normalizeKey to take the boolean flag to preseverTralingSlash if true will preserve it. In this way, this method can be used in listKey case with true, rest all code with false. Have a look in to it, and share ur suggestions on the approach.", "author": "bharatviswa504", "createdAt": "2020-10-20T23:05:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTUyNjMwNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTUyNzE4OA==", "url": "https://github.com/apache/ozone/pull/1451#discussion_r499527188", "bodyText": "Do we need this method at all? Is it possible to have invalid key path after OmUtils.normalizeKey? Seems to be an unnecessary additional step.", "author": "elek", "createdAt": "2020-10-05T11:25:41Z", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/OMClientRequest.java", "diffHunk": "@@ -298,21 +296,11 @@ public static String validateAndNormalizeKey(boolean enableFileSystemPaths,\n     }\n   }\n \n-  @SuppressFBWarnings(\"DMI_HARDCODED_ABSOLUTE_FILENAME\")\n+\n   public static String validateAndNormalizeKey(String keyName)\n       throws OMException {\n-    String normalizedKeyName;\n-    if (keyName.startsWith(OM_KEY_PREFIX)) {\n-      normalizedKeyName = Paths.get(keyName).toUri().normalize().getPath();\n-    } else {\n-      normalizedKeyName = Paths.get(OM_KEY_PREFIX, keyName).toUri()\n-          .normalize().getPath();\n-    }\n-    if (!keyName.equals(normalizedKeyName)) {\n-      LOG.debug(\"Normalized key {} to {} \", keyName,\n-          normalizedKeyName.substring(1));\n-    }\n-    return isValidKeyPath(normalizedKeyName.substring(1));\n+    String normalizedKeyName = OmUtils.normalizeKey(keyName);\n+    return isValidKeyPath(normalizedKeyName);", "originalCommit": "2be2252dc049911afdba0e8645579f03da7f1ffb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTgwMDkxNw==", "url": "https://github.com/apache/ozone/pull/1451#discussion_r499800917", "bodyText": "Yes, there are a few cases.\nFor examples refer testNormalizeKeyInvalidPaths test in TestNormalizePaths.java\nhttps://github.com/apache/hadoop-ozone/blob/master/hadoop-ozone/ozone-manager/src/test/java/org/apache/hadoop/ozone/om/request/TestNormalizePaths.java#L71", "author": "bharatviswa504", "createdAt": "2020-10-05T18:47:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTUyNzE4OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjM1Njk1Ng==", "url": "https://github.com/apache/ozone/pull/1451#discussion_r502356956", "bodyText": "Got it, thanks a lot. These are the cases where the normalization will result an invalid path due to the too many .. (for example)", "author": "elek", "createdAt": "2020-10-09T11:13:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTUyNzE4OA=="}], "type": "inlineReview"}, {"oid": "6f1bf22f707bac6c58fe894c8e95b41035f84176", "url": "https://github.com/apache/ozone/commit/6f1bf22f707bac6c58fe894c8e95b41035f84176", "message": "HDDS-4117. Normalize Keypath for listKeys.", "committedDate": "2020-10-20T22:45:11Z", "type": "commit"}, {"oid": "343a9bc3bc504f061877c0dfdadcc1f2b85ff44d", "url": "https://github.com/apache/ozone/commit/343a9bc3bc504f061877c0dfdadcc1f2b85ff44d", "message": "fix cs and pom update", "committedDate": "2020-10-20T22:45:11Z", "type": "commit"}, {"oid": "03d0de40e03692b85aa67908f550a195a2408639", "url": "https://github.com/apache/ozone/commit/03d0de40e03692b85aa67908f550a195a2408639", "message": "fix test", "committedDate": "2020-10-20T22:45:12Z", "type": "commit"}, {"oid": "d385e99c769280176a2652eaac9bf05f5a774ade", "url": "https://github.com/apache/ozone/commit/d385e99c769280176a2652eaac9bf05f5a774ade", "message": "fix review comments", "committedDate": "2020-10-20T23:13:20Z", "type": "commit"}, {"oid": "d385e99c769280176a2652eaac9bf05f5a774ade", "url": "https://github.com/apache/ozone/commit/d385e99c769280176a2652eaac9bf05f5a774ade", "message": "fix review comments", "committedDate": "2020-10-20T23:13:20Z", "type": "forcePushed"}, {"oid": "2b939afa1820c877ee581e9289dff9d66e271c95", "url": "https://github.com/apache/ozone/commit/2b939afa1820c877ee581e9289dff9d66e271c95", "message": "fix cs", "committedDate": "2020-10-20T23:53:54Z", "type": "commit"}]}