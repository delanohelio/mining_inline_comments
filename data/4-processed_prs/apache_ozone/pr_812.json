{"pr_number": 812, "pr_title": "HDDS-3161. Block illegal characters when creating keys.", "pr_createdAt": "2020-04-11T19:12:53Z", "pr_url": "https://github.com/apache/ozone/pull/812", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDA3MDczOQ==", "url": "https://github.com/apache/ozone/pull/812#discussion_r410070739", "bodyText": "Please move this regex to OzoneConsts and please add a simplified example on what characters are not allowed.", "author": "mukul1987", "createdAt": "2020-04-17T08:26:33Z", "path": "hadoop-hdds/client/src/main/java/org/apache/hadoop/hdds/scm/client/HddsClientUtils.java", "diffHunk": "@@ -196,6 +196,27 @@ public static void verifyResourceName(String... resourceNames) {\n     }\n   }\n \n+  /**\n+   * verifies that key name is a valid name.\n+   *\n+   * @param keyName key name to be validated\n+   *\n+   * @throws IllegalArgumentException\n+   */\n+  public static void verifyKeyName(String keyName) {\n+    if (keyName == null) {\n+      throw new IllegalArgumentException(\"Key name is null\");\n+    }\n+    String regex = \"^[^^{}<>^?%~#`\\\\[\\\\]\\\\|\\\\\\\\(\\\\x80-\\\\xff)]$\";", "originalCommit": "2149bc56e20ab04aab00b1539f0d9f057f693115", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTU2MjY4MQ==", "url": "https://github.com/apache/ozone/pull/812#discussion_r411562681", "bodyText": "Thanks, I've moved the regex to OzoneConsts and explained it.", "author": "cku328", "createdAt": "2020-04-20T17:33:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDA3MDczOQ=="}], "type": "inlineReview"}, {"oid": "a39cfcef4c0d680bdb61701d87153ba30da36b44", "url": "https://github.com/apache/ozone/commit/a39cfcef4c0d680bdb61701d87153ba30da36b44", "message": "HDDS-3161. Block illegal characters when creating keys.", "committedDate": "2020-04-19T13:12:43Z", "type": "forcePushed"}, {"oid": "6fba4369308a5f70c6b466b4bf3e9bd720f693a0", "url": "https://github.com/apache/ozone/commit/6fba4369308a5f70c6b466b4bf3e9bd720f693a0", "message": "Added key name check in some requests.\n\nSigned-off-by: Neo <cku328@gmail.com>", "committedDate": "2020-04-20T15:11:23Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzEwNjk4MQ==", "url": "https://github.com/apache/ozone/pull/812#discussion_r413106981", "bodyText": "Converting each character to string and checking separately with a regex seems more expensive than either individual character comparison or full-string regex check.", "author": "adoroszlai", "createdAt": "2020-04-22T15:57:08Z", "path": "hadoop-hdds/client/src/main/java/org/apache/hadoop/hdds/scm/client/HddsClientUtils.java", "diffHunk": "@@ -196,6 +196,27 @@ public static void verifyResourceName(String... resourceNames) {\n     }\n   }\n \n+  /**\n+   * verifies that key name is a valid name.\n+   *\n+   * @param keyName key name to be validated\n+   *\n+   * @throws IllegalArgumentException\n+   */\n+  public static void verifyKeyName(String keyName) {\n+    if (keyName == null) {\n+      throw new IllegalArgumentException(\"Key name is null\");\n+    }\n+    for (int index = 0; index < keyName.length(); index++) {\n+      char currChar = keyName.charAt(index);\n+      if (!(Character.toString(currChar)\n+              .matches(OzoneConsts.KEYNAME_AVOID_CHARACTERS_REGEX))){", "originalCommit": "6fba4369308a5f70c6b466b4bf3e9bd720f693a0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDg4NDM1OA==", "url": "https://github.com/apache/ozone/pull/812#discussion_r414884358", "bodyText": "Thanks @adoroszlai for the comment.\nChecking each character independently with regular expressions to know exactly which one is not allowed. But I feel the same way, independently check each character is expensive, so I modified it to use full-string to check.", "author": "cku328", "createdAt": "2020-04-24T21:52:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzEwNjk4MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzEwOTUzNQ==", "url": "https://github.com/apache/ozone/pull/812#discussion_r413109535", "bodyText": "Constants for regex patterns should be pre-compiled (Pattern.compile(...)).", "author": "adoroszlai", "createdAt": "2020-04-22T16:00:24Z", "path": "hadoop-hdds/common/src/main/java/org/apache/hadoop/ozone/OzoneConsts.java", "diffHunk": "@@ -328,5 +328,19 @@ private OzoneConsts() {\n   public static final String GDPR_SECRET = \"secret\";\n   public static final String GDPR_ALGORITHM = \"algorithm\";\n \n+  /**\n+   * Block key name as illegal characters\n+   *\n+   * This regular expression is used to check if key name\n+   * contains illegal characters when creating/renaming key.\n+   *\n+   * Avoid the following characters in a key name:\n+   * \"\\\", \"{\", \"}\", \"^\", \"<\", \">\", \"#\", \"|\", \"%\", \"`\", \"[\", \"]\", \"~\", \"?\"\n+   * and Non-printable ASCII characters (128\u2013255 decimal characters).\n+   * https://docs.aws.amazon.com/AmazonS3/latest/dev/UsingMetadata.html\n+   */\n+  public static final String KEYNAME_AVOID_CHARACTERS_REGEX =\n+          \"^[^^{}<>^?%~#`\\\\[\\\\]\\\\|\\\\\\\\(\\\\x80-\\\\xff)]$\";", "originalCommit": "6fba4369308a5f70c6b466b4bf3e9bd720f693a0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDg4NDQyOQ==", "url": "https://github.com/apache/ozone/pull/812#discussion_r414884429", "bodyText": "Thanks! I fixed it.", "author": "cku328", "createdAt": "2020-04-24T21:52:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzEwOTUzNQ=="}], "type": "inlineReview"}, {"oid": "fc8f2f99925d3e64443e776fd31bc6425b507c00", "url": "https://github.com/apache/ozone/commit/fc8f2f99925d3e64443e776fd31bc6425b507c00", "message": "HDDS-3161. Block illegal characters when creating keys.", "committedDate": "2020-04-24T19:46:00Z", "type": "commit"}, {"oid": "a91e7f8186e1d34804296a9a889f273672dca1ef", "url": "https://github.com/apache/ozone/commit/a91e7f8186e1d34804296a9a889f273672dca1ef", "message": "Moving regular expression to OzoneConsts file.\n\nSigned-off-by: Neo <cku328@gmail.com>", "committedDate": "2020-04-24T19:46:00Z", "type": "commit"}, {"oid": "78f9e99eace6affdd1bc4e6510c95902acef497d", "url": "https://github.com/apache/ozone/commit/78f9e99eace6affdd1bc4e6510c95902acef497d", "message": "Added key name check in some requests.\n\nSigned-off-by: Neo <cku328@gmail.com>", "committedDate": "2020-04-24T19:46:00Z", "type": "commit"}, {"oid": "ab75c37044d9f5a079731b144f875576f9fd2adb", "url": "https://github.com/apache/ozone/commit/ab75c37044d9f5a079731b144f875576f9fd2adb", "message": "pre-compiled regex patterns & check the entire string.", "committedDate": "2020-04-24T19:46:00Z", "type": "commit"}, {"oid": "320952174b22d57eb4e3fe6f8b682d6aa191680f", "url": "https://github.com/apache/ozone/commit/320952174b22d57eb4e3fe6f8b682d6aa191680f", "message": "change this check to optional", "committedDate": "2020-04-24T19:47:15Z", "type": "forcePushed"}, {"oid": "4e14e818441d3e0c075f573265d0a25d1e9e9518", "url": "https://github.com/apache/ozone/commit/4e14e818441d3e0c075f573265d0a25d1e9e9518", "message": "hange this check to optionl", "committedDate": "2020-04-24T20:08:36Z", "type": "commit"}, {"oid": "4e14e818441d3e0c075f573265d0a25d1e9e9518", "url": "https://github.com/apache/ozone/commit/4e14e818441d3e0c075f573265d0a25d1e9e9518", "message": "hange this check to optionl", "committedDate": "2020-04-24T20:08:36Z", "type": "forcePushed"}, {"oid": "8973cd7f1090acc1f27f93ab2fb116acd0c56cb1", "url": "https://github.com/apache/ozone/commit/8973cd7f1090acc1f27f93ab2fb116acd0c56cb1", "message": "fixed checkstyle", "committedDate": "2020-04-24T20:26:25Z", "type": "commit"}, {"oid": "9ffb4d6347836766dff6130e14043ca0de33db32", "url": "https://github.com/apache/ozone/commit/9ffb4d6347836766dff6130e14043ca0de33db32", "message": "fix bugs", "committedDate": "2020-04-24T21:45:53Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjU1NTU5MQ==", "url": "https://github.com/apache/ozone/pull/812#discussion_r416555591", "bodyText": "I would like to propose making this message consistent with the one in OmUtils, so that ozone fs -put and ozone sh key put both print the same error.  I think it can be most simply done by moving the message from OmUtils here and letting the OMException propagate the underlying exception's message.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  throw new IllegalArgumentException(\"key name contains \" +\n          \n          \n            \n                          \"illegal characters.\");\n          \n          \n            \n                  throw new IllegalArgumentException(\"Invalid key name: \" + keyName);\n          \n      \n    \n    \n  \n\nIf you agree, please feel free to wait for others' reviews before making this change, to reduce the number of rounds.", "author": "adoroszlai", "createdAt": "2020-04-28T12:00:53Z", "path": "hadoop-hdds/client/src/main/java/org/apache/hadoop/hdds/scm/client/HddsClientUtils.java", "diffHunk": "@@ -196,6 +196,24 @@ public static void verifyResourceName(String... resourceNames) {\n     }\n   }\n \n+  /**\n+   * verifies that key name is a valid name.\n+   *\n+   * @param keyName key name to be validated\n+   *\n+   * @throws IllegalArgumentException\n+   */\n+  public static void verifyKeyName(String keyName) {\n+    if (keyName == null) {\n+      throw new IllegalArgumentException(\"Key name is null\");\n+    }\n+    if(!OzoneConsts.KEYNAME_ILLEGAL_CHARACTER_CHECK_REGEX\n+            .matcher(keyName).matches()){\n+      throw new IllegalArgumentException(\"key name contains \" +\n+              \"illegal characters.\");", "originalCommit": "9ffb4d6347836766dff6130e14043ca0de33db32", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjY5NDQ5Mg==", "url": "https://github.com/apache/ozone/pull/812#discussion_r416694492", "bodyText": "Thanks for the suggestion, I agree with you.\nI'll wait for others' reviews and suggestions before I make this change.", "author": "cku328", "createdAt": "2020-04-28T15:11:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjU1NTU5MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjU1NTg2MQ==", "url": "https://github.com/apache/ozone/pull/812#discussion_r416555861", "bodyText": "Corresponding to the suggestion for HddsClientUtils:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  throw new OMException(\"Invalid key name: \" + keyName,\n          \n          \n            \n                  throw new OMException(e.getMessage(),", "author": "adoroszlai", "createdAt": "2020-04-28T12:01:20Z", "path": "hadoop-ozone/common/src/main/java/org/apache/hadoop/ozone/OmUtils.java", "diffHunk": "@@ -506,4 +506,17 @@ public static long getOMClientRpcTimeOut(Configuration configuration) {\n     return OzoneConfiguration.of(configuration)\n         .getObject(OMClientConfig.class).getRpcTimeOut();\n   }\n+\n+  /**\n+   * Verify key name is a valid name.\n+   */\n+  public static void validateKeyName(String keyName)\n+          throws OMException {\n+    try {\n+      HddsClientUtils.verifyKeyName(keyName);\n+    } catch (IllegalArgumentException e) {\n+      throw new OMException(\"Invalid key name: \" + keyName,", "originalCommit": "9ffb4d6347836766dff6130e14043ca0de33db32", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "17e40c23392df10bbfdf5e737b417ddda82f43c0", "url": "https://github.com/apache/ozone/commit/17e40c23392df10bbfdf5e737b417ddda82f43c0", "message": "update message of exception", "committedDate": "2020-05-05T16:18:16Z", "type": "commit"}, {"oid": "41f9045c5e997c51dcdbf083ddeeb41ab543fb4b", "url": "https://github.com/apache/ozone/commit/41f9045c5e997c51dcdbf083ddeeb41ab543fb4b", "message": "Merge remote-tracking branch 'remotes/upstream/master' into HDDS-3161\n\n# Conflicts:\n#\thadoop-ozone/client/src/main/java/org/apache/hadoop/ozone/client/rpc/RpcClient.java\n#\thadoop-ozone/common/src/main/java/org/apache/hadoop/ozone/OmUtils.java", "committedDate": "2020-05-05T16:56:13Z", "type": "commit"}, {"oid": "07a8386fe6e4155dbb140badbf01927d0e360796", "url": "https://github.com/apache/ozone/commit/07a8386fe6e4155dbb140badbf01927d0e360796", "message": "Merge remote-tracking branch 'origin/master' into HEAD", "committedDate": "2020-06-24T11:46:43Z", "type": "commit"}]}