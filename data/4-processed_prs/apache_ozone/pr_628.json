{"pr_number": 628, "pr_title": "HDDS-1008. Invalidate closed container replicas on a failed volume.", "pr_createdAt": "2020-03-03T17:09:13Z", "pr_url": "https://github.com/apache/ozone/pull/628", "timeline": [{"oid": "fa380c27023602ebfb7ac88fdaba962893a8251b", "url": "https://github.com/apache/ozone/commit/fa380c27023602ebfb7ac88fdaba962893a8251b", "message": "HDDS-1008. Invalidate container replicas on volume failure.", "committedDate": "2020-03-03T17:02:58Z", "type": "commit"}, {"oid": "754e62bd5fb810a287f2bf4d355076ec4f6cadba", "url": "https://github.com/apache/ozone/commit/754e62bd5fb810a287f2bf4d355076ec4f6cadba", "message": "Fixes checkstyle and findbugs.", "committedDate": "2020-03-03T18:45:44Z", "type": "commit"}, {"oid": "b77278eba3a878a3187bdefbb61d8d30b9bdf33d", "url": "https://github.com/apache/ozone/commit/b77278eba3a878a3187bdefbb61d8d30b9bdf33d", "message": "Addresses supratim's comments", "committedDate": "2020-03-04T10:34:04Z", "type": "commit"}, {"oid": "513ff182fae284020e9d7be386d87bc932ec1ee9", "url": "https://github.com/apache/ozone/commit/513ff182fae284020e9d7be386d87bc932ec1ee9", "message": "Fixes unit test", "committedDate": "2020-03-04T11:31:10Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzY1NzY1Ng==", "url": "https://github.com/apache/ozone/pull/628#discussion_r387657656", "bodyText": "This can probably be done outside the writeLock - should be safe.\nalso, we can invoke the listener outside the for loop - perhaps like:\nif (!failedVolumes.isEmpty()) {failedVolumeListener.run();}", "author": "supratimdeka", "createdAt": "2020-03-04T13:14:36Z", "path": "hadoop-hdds/container-service/src/main/java/org/apache/hadoop/ozone/container/common/volume/VolumeSet.java", "diffHunk": "@@ -239,23 +249,24 @@ private void checkAllVolumes() throws IOException {\n    * @param failedVolumes\n    */\n   private void handleVolumeFailures(Set<HddsVolume> failedVolumes) {\n-    for (HddsVolume v: failedVolumes) {\n-      this.writeLock();\n-      try {\n+    this.writeLock();\n+    try {\n+      for (HddsVolume v : failedVolumes) {\n         // Immediately mark the volume as failed so it is unavailable\n         // for new containers.\n-        volumeMap.remove(v.getHddsRootDir().getPath());\n-        failedVolumeMap.putIfAbsent(v.getHddsRootDir().getPath(), v);\n-      } finally {\n-        this.writeUnlock();\n+        failVolume(v.getHddsRootDir().getPath());\n       }\n-\n-      // TODO:\n-      // 1. Mark all closed containers on the volume as unhealthy.\n-      // 2. Consider stopping IO on open containers and tearing down\n-      //    active pipelines.\n-      // 3. Handle Ratis log disk failure.\n+      if (failedVolumeListener != null) {", "originalCommit": "513ff182fae284020e9d7be386d87bc932ec1ee9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODEyNTExMQ==", "url": "https://github.com/apache/ozone/pull/628#discussion_r388125111", "bodyText": "Yes we can move it outside. But I think there is a race condition in marking a volume as failed. A container in process of creation can still get created on the failed volume. We can handle it as part of separate jira though.", "author": "lokeshj1703", "createdAt": "2020-03-05T07:51:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzY1NzY1Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzY2MTcxOQ==", "url": "https://github.com/apache/ozone/pull/628#discussion_r387661719", "bodyText": "Good point. But, I think this is how it is already implemented. updateContainerData() on encountering an exception, does not reset the state if the state is UNHEALTHY. Or did I get that wrong?", "author": "supratimdeka", "createdAt": "2020-03-04T13:22:13Z", "path": "hadoop-hdds/container-service/src/main/java/org/apache/hadoop/ozone/container/keyvalue/KeyValueContainer.java", "diffHunk": "@@ -298,6 +298,8 @@ public void markContainerForClose() throws StorageContainerException {\n   public void markContainerUnhealthy() throws StorageContainerException {\n     writeLock();\n     try {\n+      // TODO: container should be marked UNHEALTHY in memory even if container", "originalCommit": "513ff182fae284020e9d7be386d87bc932ec1ee9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODExNTkxNQ==", "url": "https://github.com/apache/ozone/pull/628#discussion_r388115915", "bodyText": "You are right. I missed the state check.", "author": "lokeshj1703", "createdAt": "2020-03-05T07:23:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzY2MTcxOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzY2NDM5Mg==", "url": "https://github.com/apache/ozone/pull/628#discussion_r387664392", "bodyText": "any reason why we are migrating to this constructor with the additional argument?\nsame question applies to all the other places where this change has been made.", "author": "supratimdeka", "createdAt": "2020-03-04T13:26:56Z", "path": "hadoop-hdds/container-service/src/test/java/org/apache/hadoop/ozone/container/common/volume/TestVolumeSet.java", "diffHunk": "@@ -64,7 +64,7 @@\n   private static final String DUMMY_IP_ADDR = \"0.0.0.0\";\n \n   private void initializeVolumeSet() throws Exception {\n-    volumeSet = new VolumeSet(UUID.randomUUID().toString(), conf);\n+    volumeSet = new VolumeSet(UUID.randomUUID().toString(), null, conf);", "originalCommit": "513ff182fae284020e9d7be386d87bc932ec1ee9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODEyNTMxNw==", "url": "https://github.com/apache/ozone/pull/628#discussion_r388125317", "bodyText": "This is change related to old commit. Will fix it.", "author": "lokeshj1703", "createdAt": "2020-03-05T07:51:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzY2NDM5Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzY2NjEzMg==", "url": "https://github.com/apache/ozone/pull/628#discussion_r387666132", "bodyText": "might make sense to add the container id and the volume in this error log.", "author": "supratimdeka", "createdAt": "2020-03-04T13:30:12Z", "path": "hadoop-hdds/container-service/src/main/java/org/apache/hadoop/ozone/container/common/impl/ContainerSet.java", "diffHunk": "@@ -122,6 +122,18 @@ public int containerCount() {\n     return containerMap.size();\n   }\n \n+  public void handleVolumeFailures() {\n+    containerMap.values().forEach(c -> {\n+      if (c.getContainerData().getVolume().isFailed()) {\n+        try {\n+          c.markContainerUnhealthy();\n+        } catch (StorageContainerException e) {\n+          LOG.error(\"Failed to move container to UNHEALTHY state\", e);", "originalCommit": "513ff182fae284020e9d7be386d87bc932ec1ee9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "32251313bacafb0736cb1fac9d20f2889c7dd1bc", "url": "https://github.com/apache/ozone/commit/32251313bacafb0736cb1fac9d20f2889c7dd1bc", "message": "Address review comments", "committedDate": "2020-03-05T08:00:37Z", "type": "commit"}]}