{"pr_number": 1078, "pr_title": "HDDS-3794. Topology Aware read does not work correctly in XceiverClientGrpc", "pr_createdAt": "2020-06-15T20:36:05Z", "pr_url": "https://github.com/apache/ozone/pull/1078", "timeline": [{"oid": "d01a932f5f88c50f5e8d62b92691a9e9467d4674", "url": "https://github.com/apache/ozone/commit/d01a932f5f88c50f5e8d62b92691a9e9467d4674", "message": "Fixed issue and added tests", "committedDate": "2020-06-15T20:32:47Z", "type": "commit"}, {"oid": "99ef7a27975e0cc475c3b8caf7895054e0a60244", "url": "https://github.com/apache/ozone/commit/99ef7a27975e0cc475c3b8caf7895054e0a60244", "message": "Retest", "committedDate": "2020-06-15T22:14:54Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTE1NDUxMw==", "url": "https://github.com/apache/ozone/pull/1078#discussion_r441154513", "bodyText": "Good catch @sodonnel . The fix LGTM overall. I just have one question:\nHave you consider populating blockID properly for the first getBlock() call with additional else if on the top?\nelse if (request.getCmdType() == ContainerProtos.Type.GetBlock) {\nblockID = request.getGetBlock().getBlockID();\n}", "author": "xiaoyuyao", "createdAt": "2020-06-16T21:32:18Z", "path": "hadoop-hdds/client/src/main/java/org/apache/hadoop/hdds/scm/XceiverClientGrpc.java", "diffHunk": "@@ -314,15 +314,17 @@ private XceiverClientReply sendCommandWithRetry(\n           // Pull the Cached DN to the top of the DN list\n           Collections.swap(datanodeList, 0, getBlockDNCacheIndex);\n         }\n-      } else if (topologyAwareRead) {", "originalCommit": "99ef7a27975e0cc475c3b8caf7895054e0a60244", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTE2ODE2Nw==", "url": "https://github.com/apache/ozone/pull/1078#discussion_r441168167", "bodyText": "Yea, I did wonder why getBlock() is not part of that IF block. I guess it makes sense to add it in just in case, as it will do no harm.\nI am not really fully up-to-speed on the read path from the Ozone client - would it be normal for several getblock calls to be made against the same pipeline (XceiverClientGrpc instance)? Ie do we expect getBlock to benefit from the cached connection sometimes?", "author": "sodonnel", "createdAt": "2020-06-16T22:04:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTE1NDUxMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTMwMzE3Mg==", "url": "https://github.com/apache/ozone/pull/1078#discussion_r441303172", "bodyText": "Yea, I did wonder why getBlock() is not part of that IF block. I guess it makes sense to add it in just in case, as it will do no harm.\nI am not really fully up-to-speed on the read path from the Ozone client - would it be normal for several getblock calls to be made against the same pipeline (XceiverClientGrpc instance)? Ie do we expect getBlock to benefit from the cached connection sometimes?\n\nYes, it is quite possible to use the same XceiverClientGrpc instanvce to read for multiple blocks for multiple keys.", "author": "bshashikant", "createdAt": "2020-06-17T06:13:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTE1NDUxMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTQwOTcwNw==", "url": "https://github.com/apache/ozone/pull/1078#discussion_r441409707", "bodyText": "Thanks for the feedback. I have made this change, so pending a clean CI run please give it a check.", "author": "sodonnel", "createdAt": "2020-06-17T09:26:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTE1NDUxMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjIwOTk4Mw==", "url": "https://github.com/apache/ozone/pull/1078#discussion_r442209983", "bodyText": "@xiaoyuyao @bshashikant Are you happy with the revision and for me to commit this one? Thanks.", "author": "sodonnel", "createdAt": "2020-06-18T13:05:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTE1NDUxMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzAzNzMxMw==", "url": "https://github.com/apache/ozone/pull/1078#discussion_r443037313", "bodyText": "LGTM, +1.", "author": "xiaoyuyao", "createdAt": "2020-06-19T20:46:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTE1NDUxMw=="}], "type": "inlineReview"}, {"oid": "9bb9c927b3b5bece58041b972d5645c9cbd14627", "url": "https://github.com/apache/ozone/commit/9bb9c927b3b5bece58041b972d5645c9cbd14627", "message": "Check for cached connection on getBlock command too", "committedDate": "2020-06-17T09:23:36Z", "type": "commit"}, {"oid": "7fd71cfee55f6a9dd2d46fb0619eafe68e36a320", "url": "https://github.com/apache/ozone/commit/7fd71cfee55f6a9dd2d46fb0619eafe68e36a320", "message": "Trigger CI", "committedDate": "2020-06-17T11:45:23Z", "type": "commit"}]}