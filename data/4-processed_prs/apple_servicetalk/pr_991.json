{"pr_number": 991, "pr_title": "Do not wrap unreleasable ByteBuf(s) with `Unpooled.unreleasableBuffer`", "pr_createdAt": "2020-03-31T18:46:09Z", "pr_url": "https://github.com/apple/servicetalk/pull/991", "timeline": [{"oid": "5d11281b715ad01702cce05e993d98208a6fefec", "url": "https://github.com/apple/servicetalk/commit/5d11281b715ad01702cce05e993d98208a6fefec", "message": "Do not wrap unreleasable ByteBuf(s) with `Unpooled.unreleasableBuffer`\n\nMotivation:\n\nFor cases when `AbstractByteBuf` wraps `ByteBuf`(s) allocated by ST\nwith another interface (slice/duplicate/readOnly) we wrap them one\nmore time with `UnreleasableByteBuf`. However, this is not necessary\nas our `ByteBuf`(s) are always unreleasable and final. There is no\nway it can be unwrapped and released. Therefore, `UnreleasableByteBuf`\nis useless and just creates more garbage for GC.\n\nModifications:\n\n- Remove all methods that apply `Unpooled.unreleasableBuffer` for\nreturned results;\n- Enhance tests to cover all API that may return a new `ByteBuf`\nor a new wrapped `ByteBuf`;\n- Assert that all `Buffer`s allocated by ST have `refCnt() > 1`;\n\nResult:\n\nLess memory allocation for slice/duplicate/readOnly methods of\nalready unreleasable `ByteBuf`(s).", "committedDate": "2020-03-31T18:45:00Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTEzNzk4NQ==", "url": "https://github.com/apple/servicetalk/pull/991#discussion_r401137985", "bodyText": "Actually, we can also remove these methods that are here to avoid an additional call to retain(). As retain() it just noon for our implementations, it's ok to use readRetainedSlice from AbstractByteBuf. Tests are all green if I remove these methods. WDYT?", "author": "idelpivnitskiy", "createdAt": "2020-03-31T18:49:35Z", "path": "servicetalk-buffer-netty/src/main/java/io/servicetalk/buffer/netty/UnreleasableDirectByteBuf.java", "diffHunk": "@@ -44,31 +43,11 @@\n         super.retain();\n     }\n \n-    @Override\n-    public ByteBuf asReadOnly() {\n-        return Unpooled.unreleasableBuffer(super.asReadOnly());\n-    }\n-\n-    @Override\n-    public ByteBuf readSlice(int length) {\n-        return Unpooled.unreleasableBuffer(super.readSlice(length));\n-    }\n-\n     @Override\n     public ByteBuf readRetainedSlice(int length) {\n         return readSlice(length);", "originalCommit": "5d11281b715ad01702cce05e993d98208a6fefec", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTM2OTExMQ==", "url": "https://github.com/apple/servicetalk/pull/991#discussion_r401369111", "bodyText": "(I am not sure if you are saying the same thing)\nI guess it was here before since this was calling readSlice() which was wrapping into the unreleasableBuffer. Since readSlice() override is removed, this becomes redundant.", "author": "NiteshKant", "createdAt": "2020-04-01T05:47:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTEzNzk4NQ=="}], "type": "inlineReview"}, {"oid": "b28a5cd05aa19d45e7cd50064ee04dab3a19aced", "url": "https://github.com/apple/servicetalk/commit/b28a5cd05aa19d45e7cd50064ee04dab3a19aced", "message": "Remove overrides for retained slice/duplicate", "committedDate": "2020-04-01T16:55:44Z", "type": "commit"}]}