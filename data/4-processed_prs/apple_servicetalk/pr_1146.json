{"pr_number": 1146, "pr_title": "Support batched service discoverer updates", "pr_createdAt": "2020-09-09T19:36:46Z", "pr_url": "https://github.com/apple/servicetalk/pull/1146", "timeline": [{"oid": "9ff07a1d75a149035b039a3de13423e4d407c488", "url": "https://github.com/apple/servicetalk/commit/9ff07a1d75a149035b039a3de13423e4d407c488", "message": "Simplify ServiceDiscoverer generics in client builders\n\n__Motivation__\n\n`SingleAddressHttpClientBuilder` is used as a template for partitioned and multi-address builders for which SD event types is different. Although, users are not expected to use a ServiceDiscoverer with different event type, we accommodate this usage in our public APIs. Accomodating this usage further trickles down to builder implementation and the external facing `ServiceDiscoveryRetryStrategy`. It also complicates generic handling whenever we change `ServiceDiscoverer` APIs.\nFurther the partitioned builder uncheck casts the service discovery stream while using which hides type issues.\n\n__Modification__\n\n - Remove the `? extends` in the `ServiceDiscoverer` event type while accepting a `ServiceDiscoverer` in the builders. When a different event type is required (partitioned builder), store the `ServiceDiscoverer` locally.\n - Simplify `ServiceDiscoveryRetryStrategy` generics.\n\n __Result__\n\n Less generics clutter in public APIs.", "committedDate": "2020-09-04T23:59:36Z", "type": "commit"}, {"oid": "f37798bd3e914a990f7a283cbe395fe3960078df", "url": "https://github.com/apple/servicetalk/commit/f37798bd3e914a990f7a283cbe395fe3960078df", "message": "Support batched service discoverer updates\n\n__Motivation__\n\n`ServiceDiscoverer#discover()` returns a `Publisher<ServiceDiscovererEvent>` where each `ServiceDiscovererEvent` contains the state of a single address. Clients always retry service discovery failures assuming transient failures but try to hold on to the last known addresses till a subsequent successful `discover()` call.  Upon a subsequent successful call; the client then has to decide after how many addresses should the old cache be disposed to reduce churn associated by deactivating an address and then subsequently activating again. Today this is done with heuristics around percentage address received between failed and successful discover call.\n\nIf we implement batch service discoverer events where a ServiceDiscoverer implementation can send all known addresses in one batch then the above mentioned heuristics can be removed.\n\n__Modification__\n\n- Modify `ServiceDiscoverer#discover()` to return a `Publisher<List<ServiceDiscovererEvent<ResolvedAddress>>>`\n- Modify `DefaultServiceDiscoveryRetryStrategy` to enable/disable retention of addresses between retries as opposed to the percent based heuristics.\n\n__Result__\n\nDeterministic caching of addresses on service discoverer failures.", "committedDate": "2020-09-09T19:34:35Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjAwMjY2MA==", "url": "https://github.com/apple/servicetalk/pull/1146#discussion_r486002660", "bodyText": "Do we need a List? Will Collection be enough?", "author": "idelpivnitskiy", "createdAt": "2020-09-10T01:03:40Z", "path": "servicetalk-client-api/src/main/java/io/servicetalk/client/api/ServiceDiscoverer.java", "diffHunk": "@@ -47,5 +49,5 @@\n      * </ul>\n      * @return a {@link Publisher} that represents a stream of events from the service discovery system.\n      */\n-    Publisher<E> discover(UnresolvedAddress address);\n+    Publisher<List<E>> discover(UnresolvedAddress address);", "originalCommit": "f37798bd3e914a990f7a283cbe395fe3960078df", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjYwOTc5Nw==", "url": "https://github.com/apple/servicetalk/pull/1146#discussion_r486609797", "bodyText": "Good call, Collection is enough", "author": "NiteshKant", "createdAt": "2020-09-10T20:19:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjAwMjY2MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjAxMTk5OA==", "url": "https://github.com/apple/servicetalk/pull/1146#discussion_r486011998", "bodyText": "If we change public API of SD to emit List of addresses, should we also change LB factory API to use the same API for eventPublisher? Looks a bit weird do have these API different.", "author": "idelpivnitskiy", "createdAt": "2020-09-10T01:39:24Z", "path": "servicetalk-http-netty/src/main/java/io/servicetalk/http/netty/DefaultSingleAddressHttpClientBuilder.java", "diffHunk": "@@ -263,8 +255,9 @@ public StreamingHttpClient buildStreaming() {\n         // Track resources that potentially need to be closed when an exception is thrown during buildStreaming\n         final CompositeCloseable closeOnException = newCompositeCloseable();\n         try {\n-            final SdStatusCompletable sdStatus = new SdStatusCompletable();\n-            final Publisher<? extends ServiceDiscovererEvent<R>> sdEvents = ctx.discover(sdStatus);\n+\n+            final Publisher<ServiceDiscovererEvent<R>> sdEvents =\n+                    ctx.serviceDiscoverer.discover(ctx.address()).flatMapConcatIterable(identity());", "originalCommit": "f37798bd3e914a990f7a283cbe395fe3960078df", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjYxNTIxNg==", "url": "https://github.com/apple/servicetalk/pull/1146#discussion_r486615216", "bodyText": "I think sending the List to load balancer does not have any value as LBs are not expected to cache, batch SD updates. Passing the List makes the API more complex, so I decided not to propagate the changes to the LB layer. If we see a need in the future, it should be straight forward to change.", "author": "NiteshKant", "createdAt": "2020-09-10T20:30:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjAxMTk5OA=="}], "type": "inlineReview"}, {"oid": "93e9d4f7ea89a773c5adfec708c04bc398bba44d", "url": "https://github.com/apple/servicetalk/commit/93e9d4f7ea89a773c5adfec708c04bc398bba44d", "message": "Review comments", "committedDate": "2020-09-10T20:19:29Z", "type": "commit"}, {"oid": "bb2a165bb6e1a252937f0d9152e2cd9205a4f3c6", "url": "https://github.com/apple/servicetalk/commit/bb2a165bb6e1a252937f0d9152e2cd9205a4f3c6", "message": "Merge remote-tracking branch 'upstream/main' into sd-batch", "committedDate": "2020-09-10T20:41:57Z", "type": "commit"}, {"oid": "b025acbace78bd17b2ff04d37e81ce0387964552", "url": "https://github.com/apple/servicetalk/commit/b025acbace78bd17b2ff04d37e81ce0387964552", "message": "Review comments", "committedDate": "2020-09-10T20:52:14Z", "type": "commit"}, {"oid": "272968e72d8afdba76865daa82af92c23b4b8dc8", "url": "https://github.com/apple/servicetalk/commit/272968e72d8afdba76865daa82af92c23b4b8dc8", "message": "Merge remote-tracking branch 'upstream/main' into sd-batch", "committedDate": "2020-09-17T02:14:01Z", "type": "commit"}, {"oid": "787c512a3f39ec28607a1af19817b39633fd8930", "url": "https://github.com/apple/servicetalk/commit/787c512a3f39ec28607a1af19817b39633fd8930", "message": "Rebase to main", "committedDate": "2020-09-17T02:29:34Z", "type": "commit"}]}