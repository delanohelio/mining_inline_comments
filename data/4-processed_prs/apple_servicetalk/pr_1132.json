{"pr_number": 1132, "pr_title": "Provide informative exceptions upon gRPC calls when plain h2/h1 resp", "pr_createdAt": "2020-08-21T09:52:28Z", "pr_url": "https://github.com/apple/servicetalk/pull/1132", "timeline": [{"oid": "c70ef30c07d665f7283cf9d4b75b22777ae5d47b", "url": "https://github.com/apple/servicetalk/commit/c70ef30c07d665f7283cf9d4b75b22777ae5d47b", "message": "Provide informative exceptions upon gRPC calls when plain h2/h1 resp", "committedDate": "2020-08-21T09:22:01Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDU5Njk1Mw==", "url": "https://github.com/apple/servicetalk/pull/1132#discussion_r474596953", "bodyText": "nit: final", "author": "normanmaurer", "createdAt": "2020-08-21T09:53:58Z", "path": "servicetalk-grpc-api/src/main/java/io/servicetalk/grpc/api/GrpcUtils.java", "diffHunk": "@@ -347,4 +356,37 @@ protected HttpHeaders payloadComplete(final HttpHeaders trailers) {\n             return trailers;\n         }\n     }\n+\n+    static class EnsureValidGrpcResponseTransformer", "originalCommit": "c70ef30c07d665f7283cf9d4b75b22777ae5d47b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDU5ODAzOA==", "url": "https://github.com/apple/servicetalk/pull/1132#discussion_r474598038", "bodyText": "seems like this field is never used which means you could most likely just make this implementation a singleton and so reduce GC ?", "author": "normanmaurer", "createdAt": "2020-08-21T09:55:19Z", "path": "servicetalk-grpc-api/src/main/java/io/servicetalk/grpc/api/GrpcUtils.java", "diffHunk": "@@ -347,4 +356,37 @@ protected HttpHeaders payloadComplete(final HttpHeaders trailers) {\n             return trailers;\n         }\n     }\n+\n+    static class EnsureValidGrpcResponseTransformer\n+            implements TrailersTransformer<Object, Object> {\n+\n+        private final HttpResponseStatus status;", "originalCommit": "c70ef30c07d665f7283cf9d4b75b22777ae5d47b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDgyNzc1NQ==", "url": "https://github.com/apple/servicetalk/pull/1132#discussion_r474827755", "bodyText": "I think this change isn't needed anymore, the new transformer also does the same thing.", "author": "NiteshKant", "createdAt": "2020-08-21T17:20:36Z", "path": "servicetalk-grpc-api/src/main/java/io/servicetalk/grpc/api/GrpcUtils.java", "diffHunk": "@@ -63,14 +65,6 @@\n     private static final CharSequence IDENTITY = newAsciiString(None.encoding());\n     private static final CharSequence GRPC_MESSAGE_ENCODING_KEY = newAsciiString(\"grpc-encoding\");\n     private static final GrpcStatus STATUS_OK = GrpcStatus.fromCodeValue(GrpcStatusCode.OK.value());\n-    private static final TrailersTransformer<Object, Object> ENSURE_GRPC_STATUS_RECEIVED =\n-            new StatelessTrailersTransformer<Object>() {\n-        @Override\n-        protected HttpHeaders payloadComplete(final HttpHeaders trailers) {", "originalCommit": "c70ef30c07d665f7283cf9d4b75b22777ae5d47b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDgyODI1NQ==", "url": "https://github.com/apple/servicetalk/pull/1132#discussion_r474828255", "bodyText": "rename to ensureGrpcContentType?", "author": "NiteshKant", "createdAt": "2020-08-21T17:21:36Z", "path": "servicetalk-grpc-api/src/main/java/io/servicetalk/grpc/api/GrpcUtils.java", "diffHunk": "@@ -185,16 +183,27 @@ static void setStatus(final HttpHeaders trailers, final Throwable cause, final B\n         }\n \n         // There was no grpc-status in the trailers, so it must be in headers.\n-        ensureGrpcStatusReceived(response.headers());\n+        ensureGrpcStatusReceived(headers);\n         return response.payloadBody(deserializer);\n     }\n \n+    private static void ensureNotPlainHtmlResponse(final HttpResponseStatus status,", "originalCommit": "c70ef30c07d665f7283cf9d4b75b22777ae5d47b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDgyOTk0Mg==", "url": "https://github.com/apple/servicetalk/pull/1132#discussion_r474829942", "bodyText": "We should also add some positive tests when the content type is correct with and without the charset.", "author": "NiteshKant", "createdAt": "2020-08-21T17:24:57Z", "path": "servicetalk-grpc-netty/src/test/java/io/servicetalk/grpc/netty/HtmlResponseUponGrpcRequestTest.java", "diffHunk": "@@ -0,0 +1,123 @@\n+/*\n+ * Copyright \u00a9 2020 Apple Inc. and the ServiceTalk project authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.servicetalk.grpc.netty;\n+\n+import io.servicetalk.grpc.api.GrpcStatusCode;\n+import io.servicetalk.grpc.api.GrpcStatusException;\n+import io.servicetalk.grpc.netty.TesterProto.TestRequest;\n+import io.servicetalk.http.netty.HttpServers;\n+import io.servicetalk.transport.api.ServerContext;\n+\n+import org.junit.Test;\n+import org.junit.function.ThrowingRunnable;\n+\n+import java.util.concurrent.ExecutionException;\n+\n+import static io.servicetalk.concurrent.api.Publisher.from;\n+import static io.servicetalk.concurrent.api.Single.succeeded;\n+import static io.servicetalk.grpc.api.GrpcExecutionStrategies.noOffloadsStrategy;\n+import static io.servicetalk.http.api.HttpSerializationProviders.textSerializer;\n+import static io.servicetalk.http.netty.HttpProtocolConfigs.h2Default;\n+import static io.servicetalk.transport.netty.internal.AddressUtils.localAddress;\n+import static io.servicetalk.transport.netty.internal.AddressUtils.serverHostAndPort;\n+import static java.util.Collections.singletonList;\n+import static org.hamcrest.MatcherAssert.assertThat;\n+import static org.hamcrest.Matchers.instanceOf;\n+import static org.hamcrest.Matchers.is;\n+import static org.hamcrest.Matchers.notNullValue;\n+import static org.junit.Assert.assertThrows;\n+import static org.junit.Assert.assertTrue;\n+\n+public final class HtmlResponseUponGrpcRequestTest {", "originalCommit": "c70ef30c07d665f7283cf9d4b75b22777ae5d47b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTAxNTY1OA==", "url": "https://github.com/apple/servicetalk/pull/1132#discussion_r475015658", "bodyText": "nit: shifted indentation", "author": "idelpivnitskiy", "createdAt": "2020-08-22T00:00:43Z", "path": "servicetalk-http-api/src/main/java/io/servicetalk/http/api/HeaderUtils.java", "diffHunk": "@@ -647,7 +647,7 @@ private HttpCookiePair findNext(CharSequence cookieHeaderValue) {\n      * the provided charset has been found, {@code false} otherwise.\n      * @see <a href=\"https://tools.ietf.org/html/rfc2045#section-5.1\">Syntax of the Content-Type Header Field</a>\n      */\n-    static boolean hasContentType(final HttpHeaders headers,\n+    public static boolean hasContentType(final HttpHeaders headers,\n                                   final CharSequence expectedContentType,\n                                   @Nullable final Charset expectedCharset) {", "originalCommit": "c70ef30c07d665f7283cf9d4b75b22777ae5d47b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTAxNTk0OQ==", "url": "https://github.com/apple/servicetalk/pull/1132#discussion_r475015949", "bodyText": "If we don't have a need for noOffloadsStrategy() we should use the default strategy.", "author": "idelpivnitskiy", "createdAt": "2020-08-22T00:02:25Z", "path": "servicetalk-grpc-netty/src/test/java/io/servicetalk/grpc/netty/HtmlResponseUponGrpcRequestTest.java", "diffHunk": "@@ -0,0 +1,123 @@\n+/*\n+ * Copyright \u00a9 2020 Apple Inc. and the ServiceTalk project authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.servicetalk.grpc.netty;\n+\n+import io.servicetalk.grpc.api.GrpcStatusCode;\n+import io.servicetalk.grpc.api.GrpcStatusException;\n+import io.servicetalk.grpc.netty.TesterProto.TestRequest;\n+import io.servicetalk.http.netty.HttpServers;\n+import io.servicetalk.transport.api.ServerContext;\n+\n+import org.junit.Test;\n+import org.junit.function.ThrowingRunnable;\n+\n+import java.util.concurrent.ExecutionException;\n+\n+import static io.servicetalk.concurrent.api.Publisher.from;\n+import static io.servicetalk.concurrent.api.Single.succeeded;\n+import static io.servicetalk.grpc.api.GrpcExecutionStrategies.noOffloadsStrategy;\n+import static io.servicetalk.http.api.HttpSerializationProviders.textSerializer;\n+import static io.servicetalk.http.netty.HttpProtocolConfigs.h2Default;\n+import static io.servicetalk.transport.netty.internal.AddressUtils.localAddress;\n+import static io.servicetalk.transport.netty.internal.AddressUtils.serverHostAndPort;\n+import static java.util.Collections.singletonList;\n+import static org.hamcrest.MatcherAssert.assertThat;\n+import static org.hamcrest.Matchers.instanceOf;\n+import static org.hamcrest.Matchers.is;\n+import static org.hamcrest.Matchers.notNullValue;\n+import static org.junit.Assert.assertThrows;\n+import static org.junit.Assert.assertTrue;\n+\n+public final class HtmlResponseUponGrpcRequestTest {\n+\n+    private ServerContext serverContext;\n+    private TesterProto.Tester.BlockingTesterClient client;\n+\n+    public HtmlResponseUponGrpcRequestTest() throws Exception {\n+        final String responsePayload = \"non-grpc error!\";\n+        serverContext = HttpServers.forAddress(localAddress(0))\n+                .protocols(h2Default())\n+                .listenAndAwait((ctx, request, responseFactory) ->\n+                        succeeded(responseFactory.badRequest().payloadBody(responsePayload, textSerializer())));\n+\n+        client = GrpcClients.forAddress(serverHostAndPort(serverContext))\n+                .executionStrategy(noOffloadsStrategy())", "originalCommit": "c70ef30c07d665f7283cf9d4b75b22777ae5d47b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTAxODM5MQ==", "url": "https://github.com/apple/servicetalk/pull/1132#discussion_r475018391", "bodyText": "nit: extra space between \"HTTP\" and \"status\"", "author": "idelpivnitskiy", "createdAt": "2020-08-22T00:12:39Z", "path": "servicetalk-grpc-api/src/main/java/io/servicetalk/grpc/api/GrpcUtils.java", "diffHunk": "@@ -185,16 +183,27 @@ static void setStatus(final HttpHeaders trailers, final Throwable cause, final B\n         }\n \n         // There was no grpc-status in the trailers, so it must be in headers.\n-        ensureGrpcStatusReceived(response.headers());\n+        ensureGrpcStatusReceived(headers);\n         return response.payloadBody(deserializer);\n     }\n \n+    private static void ensureNotPlainHtmlResponse(final HttpResponseStatus status,\n+                                                      final HttpHeaders headers) {\n+        final CharSequence contentTypeHeader = headers.get(CONTENT_TYPE);\n+        if (!hasContentType(headers, GRPC_CONTENT_TYPE, null)) {\n+            throw new GrpcStatus(INTERNAL, null,\n+                    \"HTTP  status code: \" + status + \"\\n\" +", "originalCommit": "c70ef30c07d665f7283cf9d4b75b22777ae5d47b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "984bc448e856697a22b72e3b29f9b4bc7c5a772d", "url": "https://github.com/apple/servicetalk/commit/984bc448e856697a22b72e3b29f9b4bc7c5a772d", "message": "Address review comments", "committedDate": "2020-09-09T18:06:48Z", "type": "commit"}]}