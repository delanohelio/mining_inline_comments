{"pr_number": 1125, "pr_title": "Remove servicetalk-grpc-gradle-plugin", "pr_createdAt": "2020-08-13T22:39:42Z", "pr_url": "https://github.com/apple/servicetalk/pull/1125", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDI4NzYxMg==", "url": "https://github.com/apple/servicetalk/pull/1125#discussion_r470287612", "bodyText": "the build is expected to fail until google/protobuf-gradle-plugin#423 is released", "author": "Scottmitch", "createdAt": "2020-08-13T22:40:10Z", "path": "gradle.properties", "diffHunk": "@@ -52,7 +52,7 @@ apacheDirectoryServerVersion=1.5.7\n commonsLangVersion=2.6\n \n # gRPC\n-protobufGradlePluginVersion=0.8.12\n+protobufGradlePluginVersion=0.8.13", "originalCommit": "2f24aa2b1419851514d33ab2f8b5ab200e85c3f4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDI4NzgwOQ==", "url": "https://github.com/apple/servicetalk/pull/1125#discussion_r470287809", "bodyText": "using file() normalizes the paths for unix/windows (tested locally on macOS / windows)", "author": "Scottmitch", "createdAt": "2020-08-13T22:40:40Z", "path": "servicetalk-examples/grpc/helloworld/build.gradle", "diffHunk": "@@ -14,27 +14,51 @@\n  * limitations under the License.\n  */\n \n+buildscript {\n+  dependencies {\n+    classpath \"com.google.protobuf:protobuf-gradle-plugin:$protobufGradlePluginVersion\"\n+  }\n+}\n+\n apply plugin: \"java\"\n-apply plugin: \"io.servicetalk.servicetalk-grpc-gradle-plugin\"\n+apply plugin: \"com.google.protobuf\"\n apply from: \"../../gradle/idea.gradle\"\n \n dependencies {\n   implementation project(\":servicetalk-annotations\")\n   implementation project(\":servicetalk-grpc-netty\")\n+  implementation project(\":servicetalk-grpc-protoc\")\n   implementation project(\":servicetalk-grpc-protobuf\")\n \n   implementation \"org.slf4j:slf4j-api:$slf4jVersion\"\n   runtimeOnly \"org.apache.logging.log4j:log4j-slf4j-impl:$log4jVersion\"\n }\n \n-serviceTalkGrpc {\n-  protobufVersion = project.property(\"protobufVersion\")\n-\n-  // The following setting must be omitted in users projects and is necessary here\n-  // only because we want to use the locally built version of the plugin\n-  serviceTalkProtocPluginPath =\n-      \"${project.rootProject.rootDir}/servicetalk-grpc-protoc/build/buildExecutable/servicetalk-grpc-protoc-\" +\n-          project.version + \"-all.jar\"\n+protobuf {\n+  protoc {\n+    artifact = \"com.google.protobuf:protoc:$protobufVersion\"\n+  }\n+  plugins {\n+    servicetalk_grpc {\n+      //// Users are expected to use \"artifact\" instead of \"path\". we use \"path\"\n+      //// only because we want to use the gradle project local version of the plugin\n+      // artifact = \"io.servicetalk:servicetalk-grpc-proto\"$serviceTalkVersion\"\n+      path = file(\"${project.rootProject.rootDir}/servicetalk-grpc-protoc/build\" +", "originalCommit": "2f24aa2b1419851514d33ab2f8b5ab200e85c3f4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "5030570b6234a974de887d1cd7359286448e5f38", "url": "https://github.com/apple/servicetalk/commit/5030570b6234a974de887d1cd7359286448e5f38", "message": "Remove servicetalk-grpc-gradle-plugin\n\nMotivation:\nservicetalk-grpc-gradle-plugin currently depends upon\nprotobuf-gradle-plugin. However protobuf-gradle-plugin was not designed\nto be included in other plugins and may result in\nsequencing/initialization issues if it is manually included or included\nby other plugins. protobuf-gradle-plugin\n[recently added support for java protoc plugins](https://github.com/google/protobuf-gradle-plugin/pull/423)\nso we can remove servicetalk-grpc-gradle-plugin and have users directly\nconsume protobuf-gradle-plugin.\n\nModifications:\n- Remove servicetalk-grpc-gradle-plugin\n- Adjust all usages of servicetalk-grpc-gradle-plugin to directly\nleverage protobuf-gradle-plugin.\n\nResult:\nLess duplicate code, and users directly use\nprotobuf-gradle-plugin to configure all protobuf related items in a\nsingle gradle extension.", "committedDate": "2020-08-21T00:11:40Z", "type": "commit"}, {"oid": "5030570b6234a974de887d1cd7359286448e5f38", "url": "https://github.com/apple/servicetalk/commit/5030570b6234a974de887d1cd7359286448e5f38", "message": "Remove servicetalk-grpc-gradle-plugin\n\nMotivation:\nservicetalk-grpc-gradle-plugin currently depends upon\nprotobuf-gradle-plugin. However protobuf-gradle-plugin was not designed\nto be included in other plugins and may result in\nsequencing/initialization issues if it is manually included or included\nby other plugins. protobuf-gradle-plugin\n[recently added support for java protoc plugins](https://github.com/google/protobuf-gradle-plugin/pull/423)\nso we can remove servicetalk-grpc-gradle-plugin and have users directly\nconsume protobuf-gradle-plugin.\n\nModifications:\n- Remove servicetalk-grpc-gradle-plugin\n- Adjust all usages of servicetalk-grpc-gradle-plugin to directly\nleverage protobuf-gradle-plugin.\n\nResult:\nLess duplicate code, and users directly use\nprotobuf-gradle-plugin to configure all protobuf related items in a\nsingle gradle extension.", "committedDate": "2020-08-21T00:11:40Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTAyMDc5MQ==", "url": "https://github.com/apple/servicetalk/pull/1125#discussion_r475020791", "bodyText": "We currently generate into $buildDir/generated/source/proto, consider preserving the pre-existing path everywhere.", "author": "idelpivnitskiy", "createdAt": "2020-08-22T00:29:06Z", "path": "servicetalk-examples/grpc/helloworld/build.gradle", "diffHunk": "@@ -14,27 +14,51 @@\n  * limitations under the License.\n  */\n \n+buildscript {\n+  dependencies {\n+    classpath \"com.google.protobuf:protobuf-gradle-plugin:$protobufGradlePluginVersion\"\n+  }\n+}\n+\n apply plugin: \"java\"\n-apply plugin: \"io.servicetalk.servicetalk-grpc-gradle-plugin\"\n+apply plugin: \"com.google.protobuf\"\n apply from: \"../../gradle/idea.gradle\"\n \n dependencies {\n   implementation project(\":servicetalk-annotations\")\n   implementation project(\":servicetalk-grpc-netty\")\n+  implementation project(\":servicetalk-grpc-protoc\")\n   implementation project(\":servicetalk-grpc-protobuf\")\n \n   implementation \"org.slf4j:slf4j-api:$slf4jVersion\"\n   runtimeOnly \"org.apache.logging.log4j:log4j-slf4j-impl:$log4jVersion\"\n }\n \n-serviceTalkGrpc {\n-  protobufVersion = project.property(\"protobufVersion\")\n-\n-  // The following setting must be omitted in users projects and is necessary here\n-  // only because we want to use the locally built version of the plugin\n-  serviceTalkProtocPluginPath =\n-      \"${project.rootProject.rootDir}/servicetalk-grpc-protoc/build/buildExecutable/servicetalk-grpc-protoc-\" +\n-          project.version + \"-all.jar\"\n+protobuf {\n+  protoc {\n+    artifact = \"com.google.protobuf:protoc:$protobufVersion\"\n+  }\n+  plugins {\n+    servicetalk_grpc {\n+      //// Users are expected to use \"artifact\" instead of \"path\". we use \"path\"\n+      //// only because we want to use the gradle project local version of the plugin\n+      // artifact = \"io.servicetalk:servicetalk-grpc-proto\"$serviceTalkVersion\"\n+      path = file(\"${project.rootProject.rootDir}/servicetalk-grpc-protoc/build\" +\n+                  \"/buildExecutable/servicetalk-grpc-protoc-${project.version}-all.jar\").path\n+    }\n+  }\n+  generateProtoTasks {\n+    all().each { task ->\n+      task.plugins {\n+        servicetalk_grpc {\n+          // Need to tell protobuf-gradle-plugin to output in the correct directory if all generated\n+          // code for a single proto goes to a single file (e.g. \"java_multiple_files = false\" in the .proto).\n+          outputSubDir = \"java\"\n+        }\n+      }\n+    }\n+  }\n+  generatedFilesBaseDir = \"$buildDir/generated/sources\"", "originalCommit": "5030570b6234a974de887d1cd7359286448e5f38", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjY1MzQwNQ==", "url": "https://github.com/apple/servicetalk/pull/1125#discussion_r476653405", "bodyText": "I'll target sources (the plural form) as there is other tooling that also targets this directory, but adding proto to de-dup sounds good.", "author": "Scottmitch", "createdAt": "2020-08-25T18:28:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTAyMDc5MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTAyMTE4NQ==", "url": "https://github.com/apple/servicetalk/pull/1125#discussion_r475021185", "bodyText": "Shouldn't block this PR, but would be nice to provide documentation for the new approach in our docs website.", "author": "idelpivnitskiy", "createdAt": "2020-08-22T00:31:41Z", "path": "servicetalk-grpc-gradle-plugin/README.adoc", "diffHunk": "@@ -1,74 +0,0 @@\n-= ServiceTalk gRPC Gradle Plugin\n-\n-Gradle plugin for configuring gRPC client and server code generation.", "originalCommit": "5030570b6234a974de887d1cd7359286448e5f38", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTAyMjc0MQ==", "url": "https://github.com/apple/servicetalk/pull/1125#discussion_r475022741", "bodyText": "Why the path is not used for this module anymore?", "author": "idelpivnitskiy", "createdAt": "2020-08-22T00:43:29Z", "path": "servicetalk-grpc-protoc/build.gradle", "diffHunk": "@@ -73,14 +72,11 @@ publishing {\n   }\n }\n \n-serviceTalkGrpc {\n-  protobufVersion = project.property(\"protobufVersion\")\n-\n-  // The following setting must be omitted in users projects and is necessary here\n-  // only because we want to use the locally built version of the plugin\n-  serviceTalkProtocPluginPath =\n-      \"${project.rootProject.rootDir}/servicetalk-grpc-protoc/build/buildExecutable/servicetalk-grpc-protoc-\" +\n-          project.version + \"-all.jar\"", "originalCommit": "5030570b6234a974de887d1cd7359286448e5f38", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjYzNTc1Ng==", "url": "https://github.com/apple/servicetalk/pull/1125#discussion_r476635756", "bodyText": "good question. there were no tests to validate the results of the generated code so the build passes without this. I will add some tests.", "author": "Scottmitch", "createdAt": "2020-08-25T17:56:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTAyMjc0MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTAyMzMwMw==", "url": "https://github.com/apple/servicetalk/pull/1125#discussion_r475023303", "bodyText": "Looks like protobuf-gradle-plugin does this magic for us, we do not need it anymore. Tried to test ./gradlew idea and it worked fine without this section.", "author": "idelpivnitskiy", "createdAt": "2020-08-22T00:48:00Z", "path": "servicetalk-grpc-netty/build.gradle", "diffHunk": "@@ -49,44 +55,42 @@ dependencies {\n   testImplementation \"org.mockito:mockito-core:$mockitoCoreVersion\"\n }\n \n-serviceTalkGrpc {\n-  protobufVersion = project.property(\"protobufVersion\")\n-\n-  // The following setting must be omitted in users projects and is necessary here\n-  // only because we want to use the locally built version of the plugin\n-  serviceTalkProtocPluginPath =\n-      \"${project.rootProject.rootDir}/servicetalk-grpc-protoc/build/buildExecutable/servicetalk-grpc-protoc-\" +\n-          project.version + \"-all.jar\"\n-}\n-\n-// The following setting must be omitted in users projects and is necessary here\n-// only because we want to use the locally built version of the plugin\n-afterEvaluate {\n-  generateTestProto.dependsOn(\":servicetalk-grpc-protoc:buildExecutable\")\n-}\n-\n-// Configure grpc-java as required by ProtocolCompatibilityTest\n-def generatedBaseDir = \"$projectDir/generated\"\n-\n protobuf {\n+  protoc {\n+    artifact = \"com.google.protobuf:protoc:$protobufVersion\"\n+  }\n   plugins {\n     grpc {\n       artifact = \"io.grpc:protoc-gen-grpc-java:$grpcVersion\"\n     }\n+    servicetalk_grpc {\n+      //// Users are expected to use \"artifact\" instead of \"path\". we use \"path\"\n+      //// only because we want to use the gradle project local version of the plugin\n+      path = file(\"${project.rootProject.rootDir}/servicetalk-grpc-protoc/build\" +\n+                  \"/buildExecutable/servicetalk-grpc-protoc-${project.version}-all.jar\").path\n+    }\n   }\n   generateProtoTasks {\n-    configure(all()) {\n-      project.tasks.ideaModule.dependsOn(it)\n-      plugins {\n+    all().each { task ->\n+      task.plugins {\n         grpc {}\n+        servicetalk_grpc {\n+          outputSubDir = \"java\"\n+        }\n       }\n     }\n   }\n-  generatedFilesBaseDir = generatedBaseDir\n+  generatedFilesBaseDir = \"$buildDir/generated/sources\"\n+}\n+\n+//// The following setting must be omitted in users projects and is necessary here\n+//// only because we want to use the gradle project local version of the plugin\n+afterEvaluate {\n+  generateTestProto.dependsOn(\":servicetalk-grpc-protoc:buildExecutable\")\n }\n \n idea {\n   module {\n-    testSourceDirs += files(\"$generatedBaseDir/source/proto/test/grpc\")\n+    testSourceDirs += files(\"${protobuf.generatedFilesBaseDir}/source/proto/test/grpc\")", "originalCommit": "5030570b6234a974de887d1cd7359286448e5f38", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjY0MDkyNg==", "url": "https://github.com/apple/servicetalk/pull/1125#discussion_r476640926", "bodyText": "sounds good \u2702\ufe0f", "author": "Scottmitch", "createdAt": "2020-08-25T18:05:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTAyMzMwMw=="}], "type": "inlineReview"}, {"oid": "b6296f193ef1106f99732f4b90ed5cd110b922e5", "url": "https://github.com/apple/servicetalk/commit/b6296f193ef1106f99732f4b90ed5cd110b922e5", "message": "review comments and cleanup", "committedDate": "2020-08-25T18:28:57Z", "type": "commit"}]}