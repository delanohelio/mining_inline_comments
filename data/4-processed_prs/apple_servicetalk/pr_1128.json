{"pr_number": 1128, "pr_title": "Improve tests for ALPN", "pr_createdAt": "2020-08-18T23:06:16Z", "pr_url": "https://github.com/apple/servicetalk/pull/1128", "timeline": [{"oid": "d13e5d9857caeff032b48ec6a308c346ced34c5d", "url": "https://github.com/apple/servicetalk/commit/d13e5d9857caeff032b48ec6a308c346ced34c5d", "message": "Improve tests for ALPN\n\nMotivation:\n\nAssertions from non-main thread (e.g. inside the service handle method)\ndo not fail the test.\nAlso, existing tests do not verify that `SSLSession` is set on the client\nside.\n\nModifications:\n\n- Assert server-side state in the main thread;\n- Assert that `ConnectionContext` is set correctly on the client-side;\n- Avoid using deprecated jUnit API;\n\nResult:\n\nBetter test coverage for ALPN use cases.", "committedDate": "2020-08-18T23:04:36Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjU1NzgxNg==", "url": "https://github.com/apple/servicetalk/pull/1128#discussion_r472557816", "bodyText": "Overwrites like this causes debugging pain if inadvertently multiple requests are sent to the service.\nI find it useful to instead use a BlockingQueue to track requests which gives an additional benefit of being able to wait for a request to be received by the server. However, YMMV", "author": "NiteshKant", "createdAt": "2020-08-18T23:58:46Z", "path": "servicetalk-http-netty/src/test/java/io/servicetalk/http/netty/AlpnClientAndServerTest.java", "diffHunk": "@@ -110,19 +112,16 @@ public AlpnClientAndServerTest(List<String> serverSideProtocols,\n         });\n     }\n \n-    private static ServerContext startServer(List<String> supportedProtocols,\n-                                             @Nullable HttpProtocolVersion expectedProtocol) throws Exception {\n+    private ServerContext startServer(List<String> supportedProtocols,\n+                                      @Nullable HttpProtocolVersion expectedProtocol) throws Exception {\n         return HttpServers.forAddress(localAddress(0))\n                 .protocols(toProtocolConfigs(supportedProtocols))\n                 .secure()\n                 .provider(OPENSSL)\n                 .commit(DefaultTestCerts::loadServerPem, DefaultTestCerts::loadServerKey)\n                 .listenBlocking((ctx, request, responseFactory) -> {\n-                    if (\"PRI\".equals(request.method().name()) && expectedProtocol == null) {\n-                        return responseFactory.badRequest();\n-                    }\n-                    assertThat(request.version(), is(expectedProtocol));\n-                    assertThat(ctx.sslSession(), is(notNullValue()));\n+                    serviceContext.set(ctx);", "originalCommit": "d13e5d9857caeff032b48ec6a308c346ced34c5d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjU2MzY3NA==", "url": "https://github.com/apple/servicetalk/pull/1128#discussion_r472563674", "bodyText": "Thanks for reminder, BlockingQueue is better!", "author": "idelpivnitskiy", "createdAt": "2020-08-19T00:19:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjU1NzgxNg=="}], "type": "inlineReview"}, {"oid": "2bdef0d6a5eb9075213694fc1f40f2b1cc47a608", "url": "https://github.com/apple/servicetalk/commit/2bdef0d6a5eb9075213694fc1f40f2b1cc47a608", "message": "Use BlockingQueue instead of AtomicReference", "committedDate": "2020-08-19T00:18:20Z", "type": "commit"}]}