{"pr_number": 940, "pr_title": "H2 client should send `ENABLE_PUSH=false` setting for new connections", "pr_createdAt": "2020-02-17T16:59:39Z", "pr_url": "https://github.com/apple/servicetalk/pull/940", "timeline": [{"oid": "9e1423e87700be81976b84ab3c9113d57d1b4adc", "url": "https://github.com/apple/servicetalk/commit/9e1423e87700be81976b84ab3c9113d57d1b4adc", "message": "H2 client should send `ENABLE_PUSH=false` setting for new connections\n\nMotivation:\n\nTo notify server side that ST client currently does not support\nserver push, client should send `ENABLE_PUSH=false` setting when it\nconnects to the server.\nIf server sends a `PUSH_PROMISE` frame, client should send `GO_AWAY`\nbefore closing the connection.\n\nModifications:\n\n- Add `ENABLE_PUSH=false` to the set of initial h2 settings;\n- Send `GO_AWAY` frame with `PROTOCOL_ERROR` if server sends a push;\n\nResult:\n\nH2 client notifies server that it does not support server push and\nsends `GO_AWAY` frame before closing the connection, if server sends\na push.", "committedDate": "2020-02-15T02:27:30Z", "type": "commit"}, {"oid": "db34d8db357d4eb811326704d9a94992a123512e", "url": "https://github.com/apple/servicetalk/commit/db34d8db357d4eb811326704d9a94992a123512e", "message": "Close connection when GO_AWAY is flushed", "committedDate": "2020-02-17T16:56:16Z", "type": "commit"}, {"oid": "9ee4245ebdfc58b8aea5a5215b61f4e34a3821e7", "url": "https://github.com/apple/servicetalk/commit/9ee4245ebdfc58b8aea5a5215b61f4e34a3821e7", "message": "Update copyright year", "committedDate": "2020-02-17T16:58:57Z", "type": "commit"}, {"oid": "466f641f76c0f564ffe0d9e0535448e1a9a2b97d", "url": "https://github.com/apple/servicetalk/commit/466f641f76c0f564ffe0d9e0535448e1a9a2b97d", "message": "Move logger to H2PushStreamHandler", "committedDate": "2020-02-17T17:01:11Z", "type": "commit"}, {"oid": "a33754cdf0da622db476713c469bd1c6ac2e68f2", "url": "https://github.com/apple/servicetalk/commit/a33754cdf0da622db476713c469bd1c6ac2e68f2", "message": "Add maxConcurrentStreams(0)", "committedDate": "2020-02-18T18:33:05Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDg2NDczOQ==", "url": "https://github.com/apple/servicetalk/pull/940#discussion_r380864739", "bodyText": "Netty should be closing the channel and log appropriately:\nhttps://github.com/netty/netty/blob/4.1/codec-http2/src/main/java/io/netty/handler/codec/http2/Http2ConnectionHandler.java#L905-L929\nI do not think we need to add a listener here", "author": "NiteshKant", "createdAt": "2020-02-18T18:47:37Z", "path": "servicetalk-http-netty/src/main/java/io/servicetalk/http/netty/H2ClientParentChannelInitializer.java", "diffHunk": "@@ -72,7 +84,14 @@ private H2PushStreamHandler() {\n \n         @Override\n         public void channelRegistered(final ChannelHandlerContext ctx) {\n-            ctx.close(); // push streams are not supported\n+            // See SETTINGS_ENABLE_PUSH in https://tools.ietf.org/html/rfc7540#section-6.5.2\n+            ctx.writeAndFlush(new DefaultHttp2GoAwayFrame(PROTOCOL_ERROR))\n+                    .addListener((ChannelFutureListener) future -> {\n+                if (!future.isSuccess()) {\n+                    LOGGER.debug(\"Failed to send a GO_AWAY frame for received PUSH_PROMISE frame\", future.cause());\n+                }\n+                ctx.close(); // push streams are not supported", "originalCommit": "a33754cdf0da622db476713c469bd1c6ac2e68f2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "f7d473167681700a71dc9a2901bda8f2f47673b6", "url": "https://github.com/apple/servicetalk/commit/f7d473167681700a71dc9a2901bda8f2f47673b6", "message": "remove listener", "committedDate": "2020-02-18T19:50:42Z", "type": "commit"}, {"oid": "8dbc8bbbb3073979e26b63d42ff0e17442d844c7", "url": "https://github.com/apple/servicetalk/commit/8dbc8bbbb3073979e26b63d42ff0e17442d844c7", "message": "remove unused logger", "committedDate": "2020-02-18T21:08:07Z", "type": "commit"}, {"oid": "df3cf25ab6b1cbbe9d234216fd778ae4089b60e0", "url": "https://github.com/apple/servicetalk/commit/df3cf25ab6b1cbbe9d234216fd778ae4089b60e0", "message": "do not create a new settings storage object", "committedDate": "2020-02-18T21:32:13Z", "type": "commit"}]}