{"pr_number": 1074, "pr_title": "Avoid blocking JDK DNS resolutions", "pr_createdAt": "2020-05-29T23:15:44Z", "pr_url": "https://github.com/apple/servicetalk/pull/1074", "timeline": [{"oid": "fea4eab090c3edd285a4a62b34fbaff4ba54be31", "url": "https://github.com/apple/servicetalk/commit/fea4eab090c3edd285a4a62b34fbaff4ba54be31", "message": "Avoid blocking JDK DNS resolutions\n\nMotivation:\n\nUsers of `HttpClients.forResolvedAddress(HostAndPort)` API could end up\nusing blocking JDK DNS resolution if they pass unresolved hostname.\n\nModification:\n\n- Use `java.net.InetSocketAddress.createUnresolved` instead of\n`new java.net.InetSocketAddress`;\n\nResult:\n\nUsers who pass unresolved hostname will see `UnresolvedAddressException`\nand should use `HttpClients.forAddress` instead that performs async DNS\nresolutions using netty-dns-resolver.", "committedDate": "2020-05-29T23:15:13Z", "type": "commit"}, {"oid": "57d936ba0a640a246265531f6f741aae4115eb88", "url": "https://github.com/apple/servicetalk/commit/57d936ba0a640a246265531f6f741aae4115eb88", "message": "Add a utility toInetSocketAddress and tests", "committedDate": "2020-05-30T00:06:39Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjc4ODg3MQ==", "url": "https://github.com/apple/servicetalk/pull/1074#discussion_r432788871", "bodyText": "@Scottmitch createUnresolved doesn't work when you pass an IP-address. I had to create a utility for this conversion.", "author": "idelpivnitskiy", "createdAt": "2020-05-30T00:12:34Z", "path": "servicetalk-http-netty/src/main/java/io/servicetalk/http/netty/HttpClients.java", "diffHunk": "@@ -221,7 +221,7 @@ private HttpClients() {\n     public static SingleAddressHttpClientBuilder<HostAndPort, InetSocketAddress> forResolvedAddressViaProxy(\n             final HostAndPort address, final HostAndPort proxyAddress) {\n         return DefaultSingleAddressHttpClientBuilder.forResolvedAddressViaProxy(address,\n-                new InetSocketAddress(address.hostName(), address.port()), proxyAddress);\n+                toInetSocketAddress(address), proxyAddress);", "originalCommit": "57d936ba0a640a246265531f6f741aae4115eb88", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "09cddf5e6d8dee737efc1ad4ab483492322d2596", "url": "https://github.com/apple/servicetalk/commit/09cddf5e6d8dee737efc1ad4ab483492322d2596", "message": "Suppress PMD warnings", "committedDate": "2020-05-30T06:45:05Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzA1NTQzNQ==", "url": "https://github.com/apple/servicetalk/pull/1074#discussion_r433055435", "bodyText": "nit: Rename to toUnresolvedAddress() to indicate it is unresolved?", "author": "NiteshKant", "createdAt": "2020-06-01T06:01:33Z", "path": "servicetalk-transport-netty-internal/src/main/java/io/servicetalk/transport/netty/internal/BuilderUtils.java", "diffHunk": "@@ -158,12 +163,27 @@ public static SocketAddress toNettyAddress(Object address) {\n             return (SocketAddress) address;\n         }\n         if (address instanceof HostAndPort) {\n-            HostAndPort hostAndPort = (HostAndPort) address;\n-            return new InetSocketAddress(hostAndPort.hostName(), hostAndPort.port());\n+            return toInetSocketAddress((HostAndPort) address);\n         }\n         throw new IllegalArgumentException(\"Unsupported address: \" + address);\n     }\n \n+    /**\n+     * Converts {@link HostAndPort} that contains a resolved address into {@link InetSocketAddress}.\n+     *\n+     * @param resolvedAddress the resolved address to convert.\n+     * @return {@link InetSocketAddress} from the passed resolved {@link HostAndPort}.\n+     */\n+    public static InetSocketAddress toInetSocketAddress(final HostAndPort resolvedAddress) {", "originalCommit": "09cddf5e6d8dee737efc1ad4ab483492322d2596", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzM2MDY2OA==", "url": "https://github.com/apple/servicetalk/pull/1074#discussion_r433360668", "bodyText": "Actually, it's a resolved address, we expect an IP instead of the host. toUnresolvedAddress name is misleading in the same way as InetSocketAddress.createUnresolved that doesn't work in this case, because it initializes InetSocketAddress.getHostName() instead of InetSocketAddress.getAddress().", "author": "idelpivnitskiy", "createdAt": "2020-06-01T16:52:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzA1NTQzNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzQyMzkwNw==", "url": "https://github.com/apple/servicetalk/pull/1074#discussion_r433423907", "bodyText": "aah rite .. can we use a name which indicates that it is resolved then?", "author": "NiteshKant", "createdAt": "2020-06-01T18:51:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzA1NTQzNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzA1NTU2MQ==", "url": "https://github.com/apple/servicetalk/pull/1074#discussion_r433055561", "bodyText": "Use loopback IPs instead of some specific IPs here and below?", "author": "NiteshKant", "createdAt": "2020-06-01T06:02:06Z", "path": "servicetalk-transport-netty-internal/src/test/java/io/servicetalk/transport/netty/internal/BuilderUtilsTest.java", "diffHunk": "@@ -0,0 +1,54 @@\n+/*\n+ * Copyright \u00a9 2020 Apple Inc. and the ServiceTalk project authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.servicetalk.transport.netty.internal;\n+\n+import io.servicetalk.transport.api.HostAndPort;\n+\n+import org.junit.Test;\n+\n+import java.net.InetSocketAddress;\n+import java.net.UnknownHostException;\n+\n+import static io.servicetalk.transport.netty.internal.BuilderUtils.toInetSocketAddress;\n+import static org.hamcrest.MatcherAssert.assertThat;\n+import static org.hamcrest.Matchers.equalTo;\n+import static org.hamcrest.Matchers.is;\n+\n+public class BuilderUtilsTest {\n+\n+    @Test\n+    @SuppressWarnings(\"PMD.AvoidUsingHardCodedIP\")\n+    public void toInetSocketAddressFromIPv4() {\n+        InetSocketAddress address = toInetSocketAddress(HostAndPort.of(\"192.168.1.1\", 8080));", "originalCommit": "09cddf5e6d8dee737efc1ad4ab483492322d2596", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "67b63bdd0855fe8ed15d768c15b2d273e11b654b", "url": "https://github.com/apple/servicetalk/commit/67b63bdd0855fe8ed15d768c15b2d273e11b654b", "message": "Use local addresses", "committedDate": "2020-06-01T16:46:15Z", "type": "commit"}, {"oid": "c70a77bf8afc150aee42136be85ec259e5e9c67c", "url": "https://github.com/apple/servicetalk/commit/c70a77bf8afc150aee42136be85ec259e5e9c67c", "message": "toInetSocketAddress -> toResolvedInetSocketAddress", "committedDate": "2020-06-01T20:21:17Z", "type": "commit"}, {"oid": "2e69eb474ad5e52d1a749b0b3ca78cd6f65b6820", "url": "https://github.com/apple/servicetalk/commit/2e69eb474ad5e52d1a749b0b3ca78cd6f65b6820", "message": "Throw IllegalArgumentException", "committedDate": "2020-06-01T20:29:15Z", "type": "commit"}]}