{"pr_number": 486, "pr_title": "KOGITO-3602 - Add aggregate LIME global explainer", "pr_createdAt": "2020-10-15T12:26:59Z", "pr_url": "https://github.com/kiegroup/kogito-apps/pull/486", "timeline": [{"oid": "fab83a364f8450ecbc1c65e8dfb37b0c0973344f", "url": "https://github.com/kiegroup/kogito-apps/commit/fab83a364f8450ecbc1c65e8dfb37b0c0973344f", "message": "KOGITO-3602 - added aggregate lime local explainer, major improvements to data distribution APIs", "committedDate": "2020-10-15T12:24:21Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTEzMDE1NA==", "url": "https://github.com/kiegroup/kogito-apps/pull/486#discussion_r509130154", "bodyText": "Perhaps the sample size could be customisable (with a fallback default)?", "author": "ruivieira", "createdAt": "2020-10-21T09:29:25Z", "path": "explainability/explainability-core/src/main/java/org/kie/kogito/explainability/global/lime/AggregatedLimeExplainer.java", "diffHunk": "@@ -0,0 +1,61 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.kie.kogito.explainability.global.lime;\n+\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.concurrent.ExecutionException;\n+import java.util.stream.Collectors;\n+\n+import org.kie.kogito.explainability.global.GlobalExplainer;\n+import org.kie.kogito.explainability.local.lime.LimeExplainer;\n+import org.kie.kogito.explainability.model.Prediction;\n+import org.kie.kogito.explainability.model.PredictionInput;\n+import org.kie.kogito.explainability.model.PredictionProvider;\n+import org.kie.kogito.explainability.model.PredictionProviderMetadata;\n+import org.kie.kogito.explainability.model.Saliency;\n+\n+/**\n+ * Global explainer aggregating LIME explanations over a number of inputs by reporting the mean feature importance for\n+ * each feature.\n+ */\n+public class AggregatedLimeExplainer implements GlobalExplainer<Map<String, Saliency>> {\n+\n+    private final LimeExplainer limeExplainer;\n+\n+    public AggregatedLimeExplainer(LimeExplainer limeExplainer) {\n+        this.limeExplainer = limeExplainer;\n+    }\n+\n+    @Override\n+    public Map<String, Saliency> explain(PredictionProvider model, PredictionProviderMetadata metadata)\n+            throws InterruptedException, ExecutionException {\n+        List<PredictionInput> inputs = metadata.getDataDistribution().sample(100);", "originalCommit": "fab83a364f8450ecbc1c65e8dfb37b0c0973344f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTQwNDMyNQ==", "url": "https://github.com/kiegroup/kogito-apps/pull/486#discussion_r509404325", "bodyText": "yeah, definitely. Same as per LimeExplainer.", "author": "tteofili", "createdAt": "2020-10-21T15:52:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTEzMDE1NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTEzMTk0Mg==", "url": "https://github.com/kiegroup/kogito-apps/pull/486#discussion_r509131942", "bodyText": "PredictionInputsDataDistribution has a nice optimisation (returning all samples when sampleSize > inputs.size()) with the added benefit that it won't given an index error if we ask for more samples than inputs.\nCould it be added here too?", "author": "ruivieira", "createdAt": "2020-10-21T09:32:04Z", "path": "explainability/explainability-core/src/main/java/org/kie/kogito/explainability/model/NumericFeatureDistribution.java", "diffHunk": "@@ -0,0 +1,66 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.kie.kogito.explainability.model;\n+\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.stream.Collectors;\n+\n+/**\n+ * Numeric feature distribution based on {@code double[]}.\n+ */\n+public class NumericFeatureDistribution implements FeatureDistribution {\n+\n+    private final Feature feature;\n+    private final double[] doubles;\n+\n+    public NumericFeatureDistribution(Feature feature, double[] doubles) {\n+        this.feature = feature;\n+        this.doubles = doubles;\n+    }\n+\n+    @Override\n+    public Feature getFeature() {\n+        return feature;\n+    }\n+\n+    @Override\n+    public Value<?> sample() {\n+        return sample(1).get(0);\n+    }\n+\n+    @Override\n+    public List<Value<?>> sample(int sampleSize) {", "originalCommit": "fab83a364f8450ecbc1c65e8dfb37b0c0973344f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTIyNTY3MA==", "url": "https://github.com/kiegroup/kogito-apps/pull/486#discussion_r509225670", "bodyText": "Please add a log message in similar scenarios like \"required 100 samples but only 10 available\"", "author": "danielezonca", "createdAt": "2020-10-21T12:12:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTEzMTk0Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTQwNjA3Mw==", "url": "https://github.com/kiegroup/kogito-apps/pull/486#discussion_r509406073", "bodyText": "agree with both comments, thanks!", "author": "tteofili", "createdAt": "2020-10-21T15:54:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTEzMTk0Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTE0NzAyOQ==", "url": "https://github.com/kiegroup/kogito-apps/pull/486#discussion_r509147029", "bodyText": "Same comment as in NumericFeatureDistribution.sample()", "author": "ruivieira", "createdAt": "2020-10-21T09:55:15Z", "path": "explainability/explainability-core/src/main/java/org/kie/kogito/explainability/model/GenericFeatureDistribution.java", "diffHunk": "@@ -0,0 +1,63 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.kie.kogito.explainability.model;\n+\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Random;\n+\n+import org.kie.kogito.explainability.utils.DataUtils;\n+\n+/**\n+ * Feature distribution based on list of {@code Values}.\n+ */\n+public class GenericFeatureDistribution implements FeatureDistribution {\n+\n+    private final Feature feature;\n+    private final List<Value<?>> values;\n+\n+    public GenericFeatureDistribution(Feature feature, List<Value<?>> values) {\n+        this.feature = feature;\n+        this.values = Collections.unmodifiableList(values);\n+    }\n+\n+    @Override\n+    public Feature getFeature() {\n+        return feature;\n+    }\n+\n+    @Override\n+    public Value<?> sample() {\n+        return sample(1).get(0);\n+    }\n+\n+    @Override\n+    public List<Value<?>> sample(int sampleSize) {", "originalCommit": "fab83a364f8450ecbc1c65e8dfb37b0c0973344f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTQxNDY2Nw==", "url": "https://github.com/kiegroup/kogito-apps/pull/486#discussion_r509414667", "bodyText": "agreed", "author": "tteofili", "createdAt": "2020-10-21T16:06:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTE0NzAyOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTE3MDQ0OQ==", "url": "https://github.com/kiegroup/kogito-apps/pull/486#discussion_r509170449", "bodyText": "IIUC when considering a large list, perhaps get a random element directly by index could be better than shuffling the entire collection, since it's O(1) vs O(N)?", "author": "ruivieira", "createdAt": "2020-10-21T10:34:09Z", "path": "explainability/explainability-core/src/main/java/org/kie/kogito/explainability/model/PredictionInputsDataDistribution.java", "diffHunk": "@@ -0,0 +1,80 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.kie.kogito.explainability.model;\n+\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+\n+/**\n+ * Data distribution based on list of {@code PredictionInputs}.\n+ */\n+public class PredictionInputsDataDistribution implements DataDistribution {\n+\n+    private final List<PredictionInput> inputs;\n+\n+    public PredictionInputsDataDistribution(List<PredictionInput> inputs) {\n+        this.inputs = Collections.unmodifiableList(inputs);\n+    }\n+\n+    @Override\n+    public PredictionInput sample() {\n+        List<PredictionInput> copy = new java.util.ArrayList<>(inputs);\n+        Collections.shuffle(copy);", "originalCommit": "fab83a364f8450ecbc1c65e8dfb37b0c0973344f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTQzNTkxMQ==", "url": "https://github.com/kiegroup/kogito-apps/pull/486#discussion_r509435911", "bodyText": "the reason for not having done that already is that I'm starting to dislike having Random objects all over the API.\nBut I guess the performance difference is worth the annoyance :-)", "author": "tteofili", "createdAt": "2020-10-21T16:37:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTE3MDQ0OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTE4MDc5NQ==", "url": "https://github.com/kiegroup/kogito-apps/pull/486#discussion_r509180795", "bodyText": "I don't know if it's worth to test when multiple features have the same importance, perhaps not...", "author": "ruivieira", "createdAt": "2020-10-21T10:52:36Z", "path": "explainability/explainability-core/src/test/java/org/kie/kogito/explainability/model/SaliencyTest.java", "diffHunk": "@@ -0,0 +1,106 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.kie.kogito.explainability.model;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.stream.Collectors;\n+\n+import org.junit.jupiter.api.Test;\n+import org.kie.kogito.explainability.TestUtils;\n+\n+import static org.junit.jupiter.api.Assertions.*;\n+\n+class SaliencyTest {", "originalCommit": "fab83a364f8450ecbc1c65e8dfb37b0c0973344f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDY5ODIzMw==", "url": "https://github.com/kiegroup/kogito-apps/pull/486#discussion_r510698233", "bodyText": "good idea.", "author": "tteofili", "createdAt": "2020-10-23T07:48:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTE4MDc5NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTA3NDM5OA==", "url": "https://github.com/kiegroup/kogito-apps/pull/486#discussion_r509074398", "bodyText": "Some notes:\n\nYou can send to predictAsync the whole list of PredictionInput instead of one by one\nYou should remove all get() and use thenApply / thenCompose to combine all the async calls\nMake number of samples as constructor param\nMake this method returns CompletableFuture<Map<String, Saliency>>", "author": "danielezonca", "createdAt": "2020-10-21T08:09:14Z", "path": "explainability/explainability-core/src/main/java/org/kie/kogito/explainability/global/lime/AggregatedLimeExplainer.java", "diffHunk": "@@ -0,0 +1,61 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.kie.kogito.explainability.global.lime;\n+\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.concurrent.ExecutionException;\n+import java.util.stream.Collectors;\n+\n+import org.kie.kogito.explainability.global.GlobalExplainer;\n+import org.kie.kogito.explainability.local.lime.LimeExplainer;\n+import org.kie.kogito.explainability.model.Prediction;\n+import org.kie.kogito.explainability.model.PredictionInput;\n+import org.kie.kogito.explainability.model.PredictionProvider;\n+import org.kie.kogito.explainability.model.PredictionProviderMetadata;\n+import org.kie.kogito.explainability.model.Saliency;\n+\n+/**\n+ * Global explainer aggregating LIME explanations over a number of inputs by reporting the mean feature importance for\n+ * each feature.\n+ */\n+public class AggregatedLimeExplainer implements GlobalExplainer<Map<String, Saliency>> {\n+\n+    private final LimeExplainer limeExplainer;\n+\n+    public AggregatedLimeExplainer(LimeExplainer limeExplainer) {\n+        this.limeExplainer = limeExplainer;\n+    }\n+\n+    @Override\n+    public Map<String, Saliency> explain(PredictionProvider model, PredictionProviderMetadata metadata)\n+            throws InterruptedException, ExecutionException {\n+        List<PredictionInput> inputs = metadata.getDataDistribution().sample(100);\n+        List<Saliency> saliencies = new ArrayList<>();\n+        for (PredictionInput input : inputs) {\n+            Prediction prediction = new Prediction(input, model.predictAsync(List.of(input)).get().get(0));\n+            saliencies.addAll(limeExplainer.explainAsync(prediction, model).get().values());\n+        }\n+        List<Saliency> merged = Saliency.merge(saliencies.toArray(new Saliency[0]));\n+        Map<String, Saliency> meanSaliencyMap = new HashMap<>();\n+        for (Saliency saliency: merged) {\n+            meanSaliencyMap.put(saliency.getOutput().getName(), saliency);\n+        }\n+        return meanSaliencyMap;\n+    }", "originalCommit": "fab83a364f8450ecbc1c65e8dfb37b0c0973344f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTA4MTI3OA==", "url": "https://github.com/kiegroup/kogito-apps/pull/486#discussion_r509081278", "bodyText": "Don't abuse of stream :)\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            double[] featureXSvalues = featureDistribution.sample(seriesLength).stream().map(Value::asNumber).map(Number::doubleValue).mapToDouble(d -> d).sorted().toArray();\n          \n          \n            \n                            double[] featureXSvalues = featureDistribution.sample(seriesLength).stream().mapToDouble(v -> v.asNumber().doubleValue()).sorted().toArray();\n          \n      \n    \n    \n  \n\nWhy do you sort them? Is it needed?", "author": "danielezonca", "createdAt": "2020-10-21T08:19:33Z", "path": "explainability/explainability-core/src/main/java/org/kie/kogito/explainability/global/pdp/PartialDependencePlotExplainer.java", "diffHunk": "@@ -81,12 +82,12 @@ public PartialDependencePlotExplainer() {\n         DataDistribution dataDistribution = metadata.getDataDistribution();\n         int noOfFeatures = metadata.getInputShape().getFeatures().size();\n \n-        List<FeatureDistribution> featureDistributions = dataDistribution.getFeatureDistributions();\n+        List<FeatureDistribution> featureDistributions = dataDistribution.asFeatureDistributions();\n         for (int featureIndex = 0; featureIndex < noOfFeatures; featureIndex++) {\n             for (int outputIndex = 0; outputIndex < metadata.getOutputShape().getOutputs().size(); outputIndex++) {\n                 // generate samples for the feature under analysis\n-                double[] featureXSvalues = DataUtils.generateSamples(featureDistributions.get(featureIndex).getMin(),\n-                                                                     featureDistributions.get(featureIndex).getMax(), seriesLength);\n+                FeatureDistribution featureDistribution = featureDistributions.get(featureIndex);\n+                double[] featureXSvalues = featureDistribution.sample(seriesLength).stream().map(Value::asNumber).map(Number::doubleValue).mapToDouble(d -> d).sorted().toArray();", "originalCommit": "fab83a364f8450ecbc1c65e8dfb37b0c0973344f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTc2MjM5Mg==", "url": "https://github.com/kiegroup/kogito-apps/pull/486#discussion_r511762392", "bodyText": "yes, because the related \"plot\" will then show the output trend as feature value increases (where it makes sense, e.g. with numbers).", "author": "tteofili", "createdAt": "2020-10-26T07:35:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTA4MTI3OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTA4MTk3NQ==", "url": "https://github.com/kiegroup/kogito-apps/pull/486#discussion_r509081975", "bodyText": "Same as above\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        double[] featureData = featureDistributions.get(i).sample(seriesLength).stream()\n          \n          \n            \n                                .map(Value::asNumber).map(Number::doubleValue).mapToDouble(d -> d).sorted().toArray();\n          \n          \n            \n                        double[] featureData = featureDistributions.get(i).sample(seriesLength).stream()\n          \n          \n            \n                                .mapToDouble(v -> v.asNumber().doubleValue()).sorted().toArray();", "author": "danielezonca", "createdAt": "2020-10-21T08:20:32Z", "path": "explainability/explainability-core/src/main/java/org/kie/kogito/explainability/global/pdp/PartialDependencePlotExplainer.java", "diffHunk": "@@ -175,9 +176,8 @@ public PartialDependencePlotExplainer() {\n     private double[][] generateDistributions(int noOfFeatures, List<FeatureDistribution> featureDistributions) {\n         double[][] trainingData = new double[noOfFeatures][seriesLength];\n         for (int i = 0; i < noOfFeatures; i++) {\n-            double[] featureData = DataUtils.generateData(featureDistributions.get(i).getMean(),\n-                                                          featureDistributions.get(i).getStdDev(), seriesLength,\n-                                                          random);\n+            double[] featureData = featureDistributions.get(i).sample(seriesLength).stream()\n+                    .map(Value::asNumber).map(Number::doubleValue).mapToDouble(d -> d).sorted().toArray();", "originalCommit": "fab83a364f8450ecbc1c65e8dfb37b0c0973344f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTc2MjY4MA==", "url": "https://github.com/kiegroup/kogito-apps/pull/486#discussion_r511762680", "bodyText": "here we can avoid the sorting actually.", "author": "tteofili", "createdAt": "2020-10-26T07:36:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTA4MTk3NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTEzMTI0Mw==", "url": "https://github.com/kiegroup/kogito-apps/pull/486#discussion_r509131243", "bodyText": "General comments to this global explainer class:\nI think it should be useful to support a scenario where we already have Predictions (aka both input and output) and we just need to apply limeExplainer. For example this is true if we have training/historical data.\nWhat about extend PredictionProviderMetadata to support a similar scenario? It will probably require to change the explain method too (like create a method CompletableFuture<List<Prediction>> extractPrediction(model, metadata) that get prediction data if available or calculate them)", "author": "danielezonca", "createdAt": "2020-10-21T09:31:01Z", "path": "explainability/explainability-core/src/main/java/org/kie/kogito/explainability/global/lime/AggregatedLimeExplainer.java", "diffHunk": "@@ -0,0 +1,61 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.kie.kogito.explainability.global.lime;\n+\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.concurrent.ExecutionException;\n+import java.util.stream.Collectors;\n+\n+import org.kie.kogito.explainability.global.GlobalExplainer;\n+import org.kie.kogito.explainability.local.lime.LimeExplainer;\n+import org.kie.kogito.explainability.model.Prediction;\n+import org.kie.kogito.explainability.model.PredictionInput;\n+import org.kie.kogito.explainability.model.PredictionProvider;\n+import org.kie.kogito.explainability.model.PredictionProviderMetadata;\n+import org.kie.kogito.explainability.model.Saliency;\n+\n+/**\n+ * Global explainer aggregating LIME explanations over a number of inputs by reporting the mean feature importance for\n+ * each feature.\n+ */\n+public class AggregatedLimeExplainer implements GlobalExplainer<Map<String, Saliency>> {", "originalCommit": "fab83a364f8450ecbc1c65e8dfb37b0c0973344f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjk2ODc4Ng==", "url": "https://github.com/kiegroup/kogito-apps/pull/486#discussion_r526968786", "bodyText": "I think that's a good idea, generally speaking. I think it would be better to let the user decide whether using existing Predictions or generating new ones via model.predictAsync, so I would probably create a different interface for that purpose (and AggregatedLimeExplainer would implement that too).", "author": "tteofili", "createdAt": "2020-11-19T15:18:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTEzMTI0Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTE1NTQyNg==", "url": "https://github.com/kiegroup/kogito-apps/pull/486#discussion_r509155426", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    this.name = name;\n          \n          \n            \n                    this.type = type;\n          \n          \n            \n                    this.value = new Value<>(null);\n          \n          \n            \n                    this.score = 0d;\n          \n          \n            \n                    this(name, type, new Value<>(null), 0d);", "author": "danielezonca", "createdAt": "2020-10-21T10:08:48Z", "path": "explainability/explainability-core/src/main/java/org/kie/kogito/explainability/model/Output.java", "diffHunk": "@@ -25,6 +27,13 @@\n     private final double score;\n     private final String name;\n \n+    public Output(String name, Type type) {\n+        this.name = name;\n+        this.type = type;\n+        this.value = new Value<>(null);\n+        this.score = 0d;", "originalCommit": "fab83a364f8450ecbc1c65e8dfb37b0c0973344f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTE1NjY3MA==", "url": "https://github.com/kiegroup/kogito-apps/pull/486#discussion_r509156670", "bodyText": "What's the reason of this change?", "author": "danielezonca", "createdAt": "2020-10-21T10:10:49Z", "path": "explainability/explainability-core/src/main/java/org/kie/kogito/explainability/utils/DataUtils.java", "diffHunk": "@@ -165,7 +167,7 @@ else if (upperBound > lowerBound) {\n                 perturbationSize = perturbationContext.getRandom().ints(lowerBound, 1 + upperBound).findFirst().orElse(1);\n             }\n             if (perturbationSize > 0) {\n-                int[] indexesToBePerturbed = perturbationContext.getRandom().ints(1, newFeatures.size())\n+                int[] indexesToBePerturbed = perturbationContext.getRandom().ints(0, newFeatures.size())", "originalCommit": "fab83a364f8450ecbc1c65e8dfb37b0c0973344f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTc2MzE5Mw==", "url": "https://github.com/kiegroup/kogito-apps/pull/486#discussion_r511763193", "bodyText": "I didn't have the fix for KOGITO-3564.\nI can drop it now.", "author": "tteofili", "createdAt": "2020-10-26T07:37:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTE1NjY3MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTE1ODYyOA==", "url": "https://github.com/kiegroup/kogito-apps/pull/486#discussion_r509158628", "bodyText": "What's the reason of this change?", "author": "danielezonca", "createdAt": "2020-10-21T10:14:09Z", "path": "explainability/explainability-core/src/test/java/org/kie/kogito/explainability/global/pdp/PartialDependencePlotExplainerTest.java", "diffHunk": "@@ -98,7 +97,7 @@ private void assertGraph(PartialDependenceGraph pdp) {\n         for (int i = 0; i < pdp.getX().length; i++) {\n             assertNotEquals(Double.NaN, pdp.getY()[i]);\n             if (i > 0) {\n-                assertTrue(pdp.getX()[i] > pdp.getX()[i - 1]);\n+                assertTrue(pdp.getX()[i] >= pdp.getX()[i - 1]);", "originalCommit": "fab83a364f8450ecbc1c65e8dfb37b0c0973344f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjg5MDk5OA==", "url": "https://github.com/kiegroup/kogito-apps/pull/486#discussion_r526890998", "bodyText": "I have adjusted the test to better reflect the semantics of what one can expect from PDP graphs there.", "author": "tteofili", "createdAt": "2020-11-19T13:37:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTE1ODYyOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTE2MzE2Nw==", "url": "https://github.com/kiegroup/kogito-apps/pull/486#discussion_r509163167", "bodyText": "What about make merge accept a List<Saliency> so you can avoid to convert to array and then convert again to list?", "author": "danielezonca", "createdAt": "2020-10-21T10:21:42Z", "path": "explainability/explainability-core/src/main/java/org/kie/kogito/explainability/global/lime/AggregatedLimeExplainer.java", "diffHunk": "@@ -0,0 +1,61 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.kie.kogito.explainability.global.lime;\n+\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.concurrent.ExecutionException;\n+import java.util.stream.Collectors;\n+\n+import org.kie.kogito.explainability.global.GlobalExplainer;\n+import org.kie.kogito.explainability.local.lime.LimeExplainer;\n+import org.kie.kogito.explainability.model.Prediction;\n+import org.kie.kogito.explainability.model.PredictionInput;\n+import org.kie.kogito.explainability.model.PredictionProvider;\n+import org.kie.kogito.explainability.model.PredictionProviderMetadata;\n+import org.kie.kogito.explainability.model.Saliency;\n+\n+/**\n+ * Global explainer aggregating LIME explanations over a number of inputs by reporting the mean feature importance for\n+ * each feature.\n+ */\n+public class AggregatedLimeExplainer implements GlobalExplainer<Map<String, Saliency>> {\n+\n+    private final LimeExplainer limeExplainer;\n+\n+    public AggregatedLimeExplainer(LimeExplainer limeExplainer) {\n+        this.limeExplainer = limeExplainer;\n+    }\n+\n+    @Override\n+    public Map<String, Saliency> explain(PredictionProvider model, PredictionProviderMetadata metadata)\n+            throws InterruptedException, ExecutionException {\n+        List<PredictionInput> inputs = metadata.getDataDistribution().sample(100);\n+        List<Saliency> saliencies = new ArrayList<>();\n+        for (PredictionInput input : inputs) {\n+            Prediction prediction = new Prediction(input, model.predictAsync(List.of(input)).get().get(0));\n+            saliencies.addAll(limeExplainer.explainAsync(prediction, model).get().values());\n+        }\n+        List<Saliency> merged = Saliency.merge(saliencies.toArray(new Saliency[0]));", "originalCommit": "fab83a364f8450ecbc1c65e8dfb37b0c0973344f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "e3ffae0ef27932312da09b8a8a1876595feb1b8a", "url": "https://github.com/kiegroup/kogito-apps/commit/e3ffae0ef27932312da09b8a8a1876595feb1b8a", "message": "KOGITO-3602 - fixed failing test", "committedDate": "2020-10-21T15:48:28Z", "type": "commit"}, {"oid": "5d92b474ca9583608d1270867876a688948a842d", "url": "https://github.com/kiegroup/kogito-apps/commit/5d92b474ca9583608d1270867876a688948a842d", "message": "KOGITO-3602 - make sample size configurable", "committedDate": "2020-10-21T15:59:13Z", "type": "commit"}, {"oid": "70bd2b3838ffb34cfb16beea73bf6f00f6ce8e4f", "url": "https://github.com/kiegroup/kogito-apps/commit/70bd2b3838ffb34cfb16beea73bf6f00f6ce8e4f", "message": "KOGITO-3602 - return all samples when sampleSize is bigger than existing samples, also log a warning", "committedDate": "2020-10-21T16:04:00Z", "type": "commit"}, {"oid": "7b78cc9f617335b062690373e8e1a745e78281d5", "url": "https://github.com/kiegroup/kogito-apps/commit/7b78cc9f617335b062690373e8e1a745e78281d5", "message": "KOGITO-3602 - return all samples when sampleSize is bigger than existing samples, also log a warning", "committedDate": "2020-10-21T16:06:07Z", "type": "commit"}, {"oid": "fbe183a1c3c93a7feb7707853e766a746ee7647c", "url": "https://github.com/kiegroup/kogito-apps/commit/fbe183a1c3c93a7feb7707853e766a746ee7647c", "message": "Update explainability/explainability-core/src/main/java/org/kie/kogito/explainability/model/Output.java\n\nCo-authored-by: Daniele Zonca <dzonca@redhat.com>", "committedDate": "2020-10-21T16:07:17Z", "type": "commit"}, {"oid": "101c57308b9d6b16bc70ef300297e2b285a880a1", "url": "https://github.com/kiegroup/kogito-apps/commit/101c57308b9d6b16bc70ef300297e2b285a880a1", "message": "Merge branch 'KOGITO-3602' of github.com:tteofili/kogito-apps into KOGITO-3602", "committedDate": "2020-10-21T16:07:51Z", "type": "commit"}, {"oid": "fe5dd293129e833083d44d8c2f9b627b59a03bca", "url": "https://github.com/kiegroup/kogito-apps/commit/fe5dd293129e833083d44d8c2f9b627b59a03bca", "message": "Merge branch 'master' of github.com:kiegroup/kogito-apps into KOGITO-3602", "committedDate": "2020-10-22T14:52:35Z", "type": "commit"}, {"oid": "88275fbe8030386c759726e3da7b66fc0a7d39d7", "url": "https://github.com/kiegroup/kogito-apps/commit/88275fbe8030386c759726e3da7b66fc0a7d39d7", "message": "KOGITO-3602 - improved SaliencyTest", "committedDate": "2020-10-23T07:48:58Z", "type": "commit"}, {"oid": "171009e45aa9ddf9c5989f93a7ab8dba1a575073", "url": "https://github.com/kiegroup/kogito-apps/commit/171009e45aa9ddf9c5989f93a7ab8dba1a575073", "message": "KOGITO-3602 - dropped useless Random", "committedDate": "2020-10-26T07:33:37Z", "type": "commit"}, {"oid": "db1857d8c4e54805a748708464675ccb23b223ee", "url": "https://github.com/kiegroup/kogito-apps/commit/db1857d8c4e54805a748708464675ccb23b223ee", "message": "KOGITO-3602 - drop unneeded sorting", "committedDate": "2020-10-26T07:38:09Z", "type": "commit"}, {"oid": "a6f81ef5de21e1e7e191b55fa0662495c081db07", "url": "https://github.com/kiegroup/kogito-apps/commit/a6f81ef5de21e1e7e191b55fa0662495c081db07", "message": "Merge branch 'master' of github.com:kiegroup/kogito-apps into KOGITO-3602", "committedDate": "2020-10-26T07:38:25Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjY5ODU2NQ==", "url": "https://github.com/kiegroup/kogito-apps/pull/486#discussion_r512698565", "bodyText": "Shouldn't we rather throw an exception or something. User may not notice this in logs.", "author": "jiripetrlik", "createdAt": "2020-10-27T13:38:58Z", "path": "explainability/explainability-core/src/main/java/org/kie/kogito/explainability/model/NumericFeatureDistribution.java", "diffHunk": "@@ -0,0 +1,76 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.kie.kogito.explainability.model;\n+\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.stream.Collectors;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * Numeric feature distribution based on {@code double[]}.\n+ */\n+public class NumericFeatureDistribution implements FeatureDistribution {\n+\n+    private final Logger LOGGER = LoggerFactory.getLogger(NumericFeatureDistribution.class);\n+\n+    private final Feature feature;\n+    private final double[] doubles;\n+\n+    public NumericFeatureDistribution(Feature feature, double[] doubles) {\n+        this.feature = feature;\n+        this.doubles = doubles;\n+    }\n+\n+    @Override\n+    public Feature getFeature() {\n+        return feature;\n+    }\n+\n+    @Override\n+    public Value<?> sample() {\n+        return sample(1).get(0);\n+    }\n+\n+    @Override\n+    public List<Value<?>> sample(int sampleSize) {\n+        if (sampleSize >= doubles.length) {\n+            LOGGER.warn(\"required {} samples, but only {} are available\", sampleSize, doubles.length);", "originalCommit": "88275fbe8030386c759726e3da7b66fc0a7d39d7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjk0OTk5OQ==", "url": "https://github.com/kiegroup/kogito-apps/pull/486#discussion_r526949999", "bodyText": "I've made it possible to sample a no. of samples bigger than the sample size (so generated data will contain duplicates).", "author": "tteofili", "createdAt": "2020-11-19T14:55:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjY5ODU2NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjY5OTA0NQ==", "url": "https://github.com/kiegroup/kogito-apps/pull/486#discussion_r512699045", "bodyText": "Again shouldn't we throw exception here?", "author": "jiripetrlik", "createdAt": "2020-10-27T13:39:34Z", "path": "explainability/explainability-core/src/main/java/org/kie/kogito/explainability/model/PredictionInputsDataDistribution.java", "diffHunk": "@@ -0,0 +1,86 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.kie.kogito.explainability.model;\n+\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * Data distribution based on list of {@code PredictionInputs}.\n+ */\n+public class PredictionInputsDataDistribution implements DataDistribution {\n+\n+    private final Logger LOGGER = LoggerFactory.getLogger(PredictionInputsDataDistribution.class);\n+\n+    private final List<PredictionInput> inputs;\n+\n+    public PredictionInputsDataDistribution(List<PredictionInput> inputs) {\n+        this.inputs = Collections.unmodifiableList(inputs);\n+    }\n+\n+    @Override\n+    public PredictionInput sample() {\n+        List<PredictionInput> copy = new java.util.ArrayList<>(inputs);\n+        Collections.shuffle(copy);\n+        return copy.get(0);\n+    }\n+\n+    @Override\n+    public List<PredictionInput> sample(int sampleSize) {\n+        if (sampleSize >= inputs.size()) {\n+            LOGGER.warn(\"required {} samples, but only {} are available\", sampleSize, inputs.size());", "originalCommit": "88275fbe8030386c759726e3da7b66fc0a7d39d7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjk1MDA4MA==", "url": "https://github.com/kiegroup/kogito-apps/pull/486#discussion_r526950080", "bodyText": "I've made it possible to sample a no. of samples bigger than the sample size (so generated data will contain duplicates).", "author": "tteofili", "createdAt": "2020-11-19T14:55:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjY5OTA0NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjcwMTAwOA==", "url": "https://github.com/kiegroup/kogito-apps/pull/486#discussion_r512701008", "bodyText": "I think it would be better to use fixed seed here.", "author": "jiripetrlik", "createdAt": "2020-10-27T13:42:00Z", "path": "explainability/explainability-core/src/test/java/org/kie/kogito/explainability/global/lime/AggregatedLimeExplainerTest.java", "diffHunk": "@@ -0,0 +1,71 @@\n+package org.kie.kogito.explainability.global.lime;\n+\n+import java.util.LinkedList;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Random;\n+import java.util.concurrent.ExecutionException;\n+import java.util.stream.Collectors;\n+\n+import org.junit.jupiter.api.Test;\n+import org.kie.kogito.explainability.TestUtils;\n+import org.kie.kogito.explainability.local.lime.LimeExplainer;\n+import org.kie.kogito.explainability.model.DataDistribution;\n+import org.kie.kogito.explainability.model.Feature;\n+import org.kie.kogito.explainability.model.FeatureFactory;\n+import org.kie.kogito.explainability.model.FeatureImportance;\n+import org.kie.kogito.explainability.model.Output;\n+import org.kie.kogito.explainability.model.PredictionInput;\n+import org.kie.kogito.explainability.model.PredictionOutput;\n+import org.kie.kogito.explainability.model.PredictionProvider;\n+import org.kie.kogito.explainability.model.PredictionProviderMetadata;\n+import org.kie.kogito.explainability.model.Saliency;\n+import org.kie.kogito.explainability.model.Type;\n+import org.kie.kogito.explainability.model.Value;\n+import org.kie.kogito.explainability.utils.DataUtils;\n+\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+import static org.junit.jupiter.api.Assertions.assertFalse;\n+import static org.junit.jupiter.api.Assertions.assertNotNull;\n+import static org.junit.jupiter.api.Assertions.assertTrue;\n+\n+class AggregatedLimeExplainerTest {\n+\n+    @Test\n+    void testExplain() throws ExecutionException, InterruptedException {\n+        PredictionProvider evenFeatureModel = TestUtils.getSumSkipModel(1);\n+        PredictionProviderMetadata metadata = new PredictionProviderMetadata() {\n+            @Override\n+            public DataDistribution getDataDistribution() {\n+                return DataUtils.generateRandomDataDistribution(3, 100, new Random());", "originalCommit": "88275fbe8030386c759726e3da7b66fc0a7d39d7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "4fce2e61b5bb7f0d37fa58a7cc272bd0708029f3", "url": "https://github.com/kiegroup/kogito-apps/commit/4fce2e61b5bb7f0d37fa58a7cc272bd0708029f3", "message": "Merge branch 'master' of github.com:kiegroup/kogito-apps into KOGITO-3602", "committedDate": "2020-11-16T11:07:02Z", "type": "commit"}, {"oid": "3ba7c3973de25cf6e65e0478528fa634a11388ce", "url": "https://github.com/kiegroup/kogito-apps/commit/3ba7c3973de25cf6e65e0478528fa634a11388ce", "message": "KOGITO-3602 - faster sample generation in PIDD", "committedDate": "2020-11-16T11:11:45Z", "type": "commit"}, {"oid": "0902dc424c8c83d69b523831e448556a59c5ae10", "url": "https://github.com/kiegroup/kogito-apps/commit/0902dc424c8c83d69b523831e448556a59c5ae10", "message": "KOGITO-3602 - addressed AggregatingLimeExplainer impl concerns", "committedDate": "2020-11-18T17:43:48Z", "type": "commit"}, {"oid": "4b077d2a73d8e458699d6d03c9abd0e9b00f60d9", "url": "https://github.com/kiegroup/kogito-apps/commit/4b077d2a73d8e458699d6d03c9abd0e9b00f60d9", "message": "KOGITO-3602 - minor fixes", "committedDate": "2020-11-19T08:16:20Z", "type": "commit"}, {"oid": "571273eeefd23d1575067ad62271bce5154507e3", "url": "https://github.com/kiegroup/kogito-apps/commit/571273eeefd23d1575067ad62271bce5154507e3", "message": "KOGITO-3602 - minor fixes", "committedDate": "2020-11-19T08:17:56Z", "type": "commit"}, {"oid": "d6cf5088b404cca395633af2d4b3e6638e2f3a5d", "url": "https://github.com/kiegroup/kogito-apps/commit/d6cf5088b404cca395633af2d4b3e6638e2f3a5d", "message": "KOGITO-3602 - minor fixes", "committedDate": "2020-11-19T08:22:58Z", "type": "commit"}, {"oid": "3a11a4f56ac6f584833b71a4edabacccf6cbee37", "url": "https://github.com/kiegroup/kogito-apps/commit/3a11a4f56ac6f584833b71a4edabacccf6cbee37", "message": "Update explainability/explainability-core/src/main/java/org/kie/kogito/explainability/global/pdp/PartialDependencePlotExplainer.java\n\nCo-authored-by: Daniele Zonca <dzonca@redhat.com>", "committedDate": "2020-11-19T08:24:29Z", "type": "commit"}, {"oid": "7ab6408f423208b9a32b9136f985b788b4920db7", "url": "https://github.com/kiegroup/kogito-apps/commit/7ab6408f423208b9a32b9136f985b788b4920db7", "message": "KOGITO-3602 - minor fixes", "committedDate": "2020-11-19T08:29:14Z", "type": "commit"}, {"oid": "6ed06807098394e03b8e84e14e1aa3dd6abfe857", "url": "https://github.com/kiegroup/kogito-apps/commit/6ed06807098394e03b8e84e14e1aa3dd6abfe857", "message": "KOGITO-3602 - dropped duplidate Saliency#merge method", "committedDate": "2020-11-19T08:40:37Z", "type": "commit"}, {"oid": "8ddddd9de421a6ce2d50fef118c0b99af7ce34d4", "url": "https://github.com/kiegroup/kogito-apps/commit/8ddddd9de421a6ce2d50fef118c0b99af7ce34d4", "message": "KOGITO-3602 - fixed PDP test", "committedDate": "2020-11-19T13:36:02Z", "type": "commit"}, {"oid": "b4089392c0570c9d69095d68e2f7bcff52d126b4", "url": "https://github.com/kiegroup/kogito-apps/commit/b4089392c0570c9d69095d68e2f7bcff52d126b4", "message": "KOGITO-3602 - fixing seeds in AggregateLimeExplainerTest", "committedDate": "2020-11-19T14:16:18Z", "type": "commit"}, {"oid": "e8f8c61825d565b8c2abe377475fb40a3e6b825e", "url": "https://github.com/kiegroup/kogito-apps/commit/e8f8c61825d565b8c2abe377475fb40a3e6b825e", "message": "KOGITO-3602 - made it possible to generate more samples than sample size in DD impls", "committedDate": "2020-11-19T14:54:21Z", "type": "commit"}, {"oid": "869ba36659afda19e1a2c69bbb0801dd29127bae", "url": "https://github.com/kiegroup/kogito-apps/commit/869ba36659afda19e1a2c69bbb0801dd29127bae", "message": "KOGITO-3602 - made it possible to generate aggregate explanations from (historical) predictions, minor fixes", "committedDate": "2020-11-19T16:19:53Z", "type": "commit"}, {"oid": "c2af39d9536e62bd2b8a5b9f6b39ff3b290d175a", "url": "https://github.com/kiegroup/kogito-apps/commit/c2af39d9536e62bd2b8a5b9f6b39ff3b290d175a", "message": "KOGITO-3602 - removed unused imports and fields", "committedDate": "2020-11-19T17:41:08Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzUxMjk4OA==", "url": "https://github.com/kiegroup/kogito-apps/pull/486#discussion_r527512988", "bodyText": "private static final int DEFAULT_SAMPLE_SIZE = 100?", "author": "r00ta", "createdAt": "2020-11-20T08:13:46Z", "path": "explainability/explainability-core/src/main/java/org/kie/kogito/explainability/global/lime/AggregatedLimeExplainer.java", "diffHunk": "@@ -0,0 +1,69 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.kie.kogito.explainability.global.lime;\n+\n+import java.util.Collection;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.concurrent.CompletableFuture;\n+\n+import org.kie.kogito.explainability.global.ExistingPredictionsGlobalExplainer;\n+import org.kie.kogito.explainability.global.GlobalExplainer;\n+import org.kie.kogito.explainability.local.lime.LimeExplainer;\n+import org.kie.kogito.explainability.model.Prediction;\n+import org.kie.kogito.explainability.model.PredictionInput;\n+import org.kie.kogito.explainability.model.PredictionProvider;\n+import org.kie.kogito.explainability.model.PredictionProviderMetadata;\n+import org.kie.kogito.explainability.model.Saliency;\n+import org.kie.kogito.explainability.utils.DataUtils;\n+\n+/**\n+ * Global explainer aggregating LIME explanations over a number of inputs by reporting the mean feature importance for\n+ * each feature.\n+ */\n+public class AggregatedLimeExplainer implements GlobalExplainer<CompletableFuture<Map<String, Saliency>>>,\n+                                                ExistingPredictionsGlobalExplainer<CompletableFuture<Map<String, Saliency>>> {\n+\n+    private final LimeExplainer limeExplainer;\n+    private final int sampleSize;\n+\n+    public AggregatedLimeExplainer(LimeExplainer limeExplainer) {\n+        this(limeExplainer, 100);", "originalCommit": "c2af39d9536e62bd2b8a5b9f6b39ff3b290d175a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzU2MzY3OQ==", "url": "https://github.com/kiegroup/kogito-apps/pull/486#discussion_r527563679", "bodyText": "sure", "author": "tteofili", "createdAt": "2020-11-20T09:32:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzUxMjk4OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzUyNDc3Mg==", "url": "https://github.com/kiegroup/kogito-apps/pull/486#discussion_r527524772", "bodyText": "public static List<Value<?>> sample(int sampleSize) {\n        List<Value<?>> copy = new java.util.ArrayList<>(values);\n        Collections.shuffle(copy);\n        return copy.subList(0, sampleSize);\n    }\n\n?", "author": "r00ta", "createdAt": "2020-11-20T08:35:42Z", "path": "explainability/explainability-core/src/main/java/org/kie/kogito/explainability/model/GenericFeatureDistribution.java", "diffHunk": "@@ -0,0 +1,62 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.kie.kogito.explainability.model;\n+\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+\n+/**\n+ * Feature distribution based on list of {@code Values}.\n+ */\n+public class GenericFeatureDistribution implements FeatureDistribution {\n+\n+    private final Feature feature;\n+    private final List<Value<?>> values;\n+\n+    public GenericFeatureDistribution(Feature feature, List<Value<?>> values) {\n+        this.feature = feature;\n+        this.values = Collections.unmodifiableList(values);\n+    }\n+\n+    @Override\n+    public Feature getFeature() {\n+        return feature;\n+    }\n+\n+    @Override\n+    public Value<?> sample() {\n+        return sample(1).get(0);\n+    }\n+\n+    @Override\n+    public List<Value<?>> sample(int sampleSize) {\n+        List<Value<?>> copy = new java.util.ArrayList<>(values);\n+        List<Value<?>> samples = new ArrayList<>(sampleSize);\n+        for (int i = 0; i < sampleSize; i++) {\n+            if (i % values.size() == 0) {\n+                Collections.shuffle(copy);\n+            }\n+            samples.add(copy.get(i));\n+        }\n+        return samples;\n+    }", "originalCommit": "c2af39d9536e62bd2b8a5b9f6b39ff3b290d175a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzU2ODk4NA==", "url": "https://github.com/kiegroup/kogito-apps/pull/486#discussion_r527568984", "bodyText": "I like the suggested change, I need to also make it possible to return a List whose size is bigger than the original values List (hence a subList wouldn't always work here).", "author": "tteofili", "createdAt": "2020-11-20T09:41:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzUyNDc3Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzU4MDcxMg==", "url": "https://github.com/kiegroup/kogito-apps/pull/486#discussion_r527580712", "bodyText": "@tteofili I'm probably wrong here, but if it's sampling with replacement would something like\nList<Value<?>> samples = new Random()\n   .ints(sampleSize, 0, values.size()-1)\n   .mapToObj(i -> values.get(i))\n   .collect(Collectors.toList());\n\nwork?", "author": "ruivieira", "createdAt": "2020-11-20T10:00:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzUyNDc3Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzYxODYwMg==", "url": "https://github.com/kiegroup/kogito-apps/pull/486#discussion_r527618602", "bodyText": "agreed, I'll abstract inside an utility method in DataUtils, thanks!", "author": "tteofili", "createdAt": "2020-11-20T11:06:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzUyNDc3Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzUyOTc2MA==", "url": "https://github.com/kiegroup/kogito-apps/pull/486#discussion_r527529760", "bodyText": "Minor comment: getFeatureDistributions?", "author": "r00ta", "createdAt": "2020-11-20T08:45:07Z", "path": "explainability/explainability-core/src/main/java/org/kie/kogito/explainability/model/IndependentFeaturesDatatDistribution.java", "diffHunk": "@@ -0,0 +1,81 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.kie.kogito.explainability.model;\n+\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Set;\n+\n+import com.google.common.collect.Sets;\n+\n+/**\n+ * Data distribution based on list of {@code FeatureDistributions}.\n+ */\n+public class IndependentFeaturesDatatDistribution implements DataDistribution {\n+\n+    private final List<FeatureDistribution> featureDistributions;\n+\n+    public IndependentFeaturesDatatDistribution(List<FeatureDistribution> featureDistributions) {\n+        this.featureDistributions = Collections.unmodifiableList(featureDistributions);\n+    }\n+\n+    @Override\n+    public PredictionInput sample() {\n+        List<Feature> features = new ArrayList<>(featureDistributions.size());\n+        for (FeatureDistribution featureDistribution : featureDistributions) {\n+            Feature feature = featureDistribution.getFeature();\n+            features.add(FeatureFactory.copyOf(feature, featureDistribution.sample()));\n+        }\n+        return new PredictionInput(features);\n+    }\n+\n+    @Override\n+    public List<PredictionInput> sample(int sampleSize) {\n+        List<PredictionInput> inputs = new ArrayList<>(sampleSize);\n+        for (int i = 0; i < sampleSize; i++) {\n+            inputs.add(sample());\n+        }\n+        return inputs;\n+    }\n+\n+    @Override\n+    public List<PredictionInput> getAllSamples() {\n+        List<Set<Feature>> featureEnumerations = new ArrayList<>(featureDistributions.size());\n+        for (FeatureDistribution featureDistribution : featureDistributions) {\n+            List<Value<?>> allValues = featureDistribution.getAllSamples();\n+            Set<Feature> currentFeatures = new HashSet<>(allValues.size());\n+            Feature feature = featureDistribution.getFeature();\n+            for (Value<?> v : allValues) {\n+                Feature f = FeatureFactory.copyOf(feature, v);\n+                currentFeatures.add(f);\n+            }\n+            featureEnumerations.add(currentFeatures);\n+        }\n+        Set<List<Feature>> cartesianProduct = Sets.cartesianProduct(featureEnumerations);\n+        List<PredictionInput> inputs = new ArrayList<>(cartesianProduct.size());\n+        for (List<Feature> features : cartesianProduct) {\n+            inputs.add(new PredictionInput(features));\n+        }\n+        return inputs;\n+    }\n+\n+    @Override\n+    public List<FeatureDistribution> asFeatureDistributions() {", "originalCommit": "c2af39d9536e62bd2b8a5b9f6b39ff3b290d175a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzU2ODUzMw==", "url": "https://github.com/kiegroup/kogito-apps/pull/486#discussion_r527568533", "bodyText": "not a strong opinion, but I preferred as  because the DataDistribution interface might or might not be made up of independent feature distributions, so this method would actually transform the underlying data to such a List.", "author": "tteofili", "createdAt": "2020-11-20T09:41:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzUyOTc2MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzUzMDEyMw==", "url": "https://github.com/kiegroup/kogito-apps/pull/486#discussion_r527530123", "bodyText": "Same as before", "author": "r00ta", "createdAt": "2020-11-20T08:45:45Z", "path": "explainability/explainability-core/src/main/java/org/kie/kogito/explainability/model/NumericFeatureDistribution.java", "diffHunk": "@@ -0,0 +1,69 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.kie.kogito.explainability.model;\n+\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.stream.Collectors;\n+\n+/**\n+ * Numeric feature distribution based on {@code double[]}.\n+ */\n+public class NumericFeatureDistribution implements FeatureDistribution {\n+\n+    private final Feature feature;\n+    private final double[] doubles;\n+\n+    public NumericFeatureDistribution(Feature feature, double[] doubles) {\n+        this.feature = feature;\n+        this.doubles = doubles;\n+    }\n+\n+    @Override\n+    public Feature getFeature() {\n+        return feature;\n+    }\n+\n+    @Override\n+    public Value<?> sample() {\n+        return sample(1).get(0);\n+    }\n+\n+    @Override\n+    public List<Value<?>> sample(int sampleSize) {\n+        List<Double> copy = Arrays.stream(doubles).boxed().collect(Collectors.toList());\n+        List<Value<?>> samples = new ArrayList<>(sampleSize);\n+        for (int i = 0; i < sampleSize; i++) {\n+            if (i % doubles.length == 0) {\n+                Collections.shuffle(copy);\n+            }\n+            samples.add(new Value<>(copy.get(i % doubles.length)));\n+        }", "originalCommit": "c2af39d9536e62bd2b8a5b9f6b39ff3b290d175a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzYxODA3Mg==", "url": "https://github.com/kiegroup/kogito-apps/pull/486#discussion_r527618072", "bodyText": "will do sampling with replacament in a common matter as per @ruivieira's soggestion", "author": "tteofili", "createdAt": "2020-11-20T11:05:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzUzMDEyMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzUzMDY1MA==", "url": "https://github.com/kiegroup/kogito-apps/pull/486#discussion_r527530650", "bodyText": "I see that in other implementations getAllSample shuffles the collection before it is returned. Should we do the same here?", "author": "r00ta", "createdAt": "2020-11-20T08:46:44Z", "path": "explainability/explainability-core/src/main/java/org/kie/kogito/explainability/model/GenericFeatureDistribution.java", "diffHunk": "@@ -0,0 +1,62 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.kie.kogito.explainability.model;\n+\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+\n+/**\n+ * Feature distribution based on list of {@code Values}.\n+ */\n+public class GenericFeatureDistribution implements FeatureDistribution {\n+\n+    private final Feature feature;\n+    private final List<Value<?>> values;\n+\n+    public GenericFeatureDistribution(Feature feature, List<Value<?>> values) {\n+        this.feature = feature;\n+        this.values = Collections.unmodifiableList(values);\n+    }\n+\n+    @Override\n+    public Feature getFeature() {\n+        return feature;\n+    }\n+\n+    @Override\n+    public Value<?> sample() {\n+        return sample(1).get(0);\n+    }\n+\n+    @Override\n+    public List<Value<?>> sample(int sampleSize) {\n+        List<Value<?>> copy = new java.util.ArrayList<>(values);\n+        List<Value<?>> samples = new ArrayList<>(sampleSize);\n+        for (int i = 0; i < sampleSize; i++) {\n+            if (i % values.size() == 0) {\n+                Collections.shuffle(copy);\n+            }\n+            samples.add(copy.get(i));\n+        }\n+        return samples;\n+    }\n+\n+    @Override\n+    public List<Value<?>> getAllSamples() {\n+        return values;", "originalCommit": "c2af39d9536e62bd2b8a5b9f6b39ff3b290d175a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzYxNzY4Mg==", "url": "https://github.com/kiegroup/kogito-apps/pull/486#discussion_r527617682", "bodyText": "yes, the behavior (shuffling) should be consistent across the implementations.", "author": "tteofili", "createdAt": "2020-11-20T11:05:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzUzMDY1MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzUzMjk3Mw==", "url": "https://github.com/kiegroup/kogito-apps/pull/486#discussion_r527532973", "bodyText": "In the other implementations of DataDistribution the method sample is without resampling, the same element can't be picked more than one time (and sampleSize must be <= thelist.size()). Here the same method works with sampleSize > inputs.size() and is with resampling, is this intended?", "author": "r00ta", "createdAt": "2020-11-20T08:50:55Z", "path": "explainability/explainability-core/src/main/java/org/kie/kogito/explainability/model/PredictionInputsDataDistribution.java", "diffHunk": "@@ -0,0 +1,84 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.kie.kogito.explainability.model;\n+\n+import java.security.SecureRandom;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Random;\n+\n+/**\n+ * Data distribution based on list of {@code PredictionInputs}.\n+ */\n+public class PredictionInputsDataDistribution implements DataDistribution {\n+\n+    private final List<PredictionInput> inputs;\n+    private final Random random;\n+\n+    public PredictionInputsDataDistribution(List<PredictionInput> inputs) {\n+        this(inputs, new SecureRandom());\n+    }\n+\n+    public PredictionInputsDataDistribution(List<PredictionInput> inputs, Random random) {\n+        this.inputs = Collections.unmodifiableList(inputs);\n+        this.random = random;\n+    }\n+\n+    @Override\n+    public PredictionInput sample() {\n+        List<PredictionInput> copy = new java.util.ArrayList<>(inputs);\n+        Collections.shuffle(copy);\n+        return copy.get(0);\n+    }\n+\n+    @Override\n+    public List<PredictionInput> sample(int sampleSize) {\n+        List<PredictionInput> samples = new ArrayList<>(sampleSize);\n+        for (int i = 0; i < sampleSize; i++) {\n+            int index = random.nextInt(inputs.size() - 1);\n+            index = index % inputs.size();\n+            samples.add(inputs.get(index));\n+        }\n+        return samples;", "originalCommit": "c2af39d9536e62bd2b8a5b9f6b39ff3b290d175a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzU3OTc3NA==", "url": "https://github.com/kiegroup/kogito-apps/pull/486#discussion_r527579774", "bodyText": "in IndependentFeaturesDatatDistribution this is not explicitly done because there's no fixed list of PredictionInputs to sample from, in there sample() is called n times regardless of the dimensionality of the underlying FeatureDistributions therefore repetition might happen and there's no need to explicitly re-sample.\nI'll add a test in  IndependentFeaturesDatatDistributionTest to cover this scenario there as well.", "author": "tteofili", "createdAt": "2020-11-20T09:59:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzUzMjk3Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzU4MDQ4NQ==", "url": "https://github.com/kiegroup/kogito-apps/pull/486#discussion_r527580485", "bodyText": "anyway in general it should be possible to draw as many samples as one wish, without requiring knowledge about the underlying data / feature distribution size. I'll double check this can be done in all the affected classes.", "author": "tteofili", "createdAt": "2020-11-20T10:00:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzUzMjk3Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzU5MzI0MA==", "url": "https://github.com/kiegroup/kogito-apps/pull/486#discussion_r527593240", "bodyText": "all in all I think the best solution is to just call sample() n times avoiding any unnecessary guards on the sample size.", "author": "tteofili", "createdAt": "2020-11-20T10:21:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzUzMjk3Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzUzNDY1OQ==", "url": "https://github.com/kiegroup/kogito-apps/pull/486#discussion_r527534659", "bodyText": "remove newline :D", "author": "r00ta", "createdAt": "2020-11-20T08:54:00Z", "path": "explainability/explainability-core/src/main/java/org/kie/kogito/explainability/model/Saliency.java", "diffHunk": "@@ -58,8 +65,41 @@ public Output getOutput() {\n     @Override\n     public String toString() {\n         return \"Saliency{\" +\n-                \"perFeatureImportance=\" + perFeatureImportance +\n+                \"output=\" + output +\n+                \", perFeatureImportance=\" + perFeatureImportance +\n                 '}';\n     }\n-}\n \n+    /**\n+     * Merge saliencies so that they are aggregated by {@code Output} and the resulting list of associated\n+     * {@code FeatureImportance}s is derived by calculating the mean score for each feature across all such saliencies.\n+     *\n+     * @param saliencies a collection of saliency maps\n+     * @return a map of merged saliencies, one for each output appearing in the input saliencies\n+     */\n+    public static Map<String, Saliency> merge(Collection<Map<String, Saliency>> saliencies) {\n+        Map<String, Saliency> finalResult = new HashMap<>();\n+\n+        // group Saliencies by Output\n+        Map<Output, List<Saliency>> flatten = saliencies.stream()\n+                .map(Map::values)\n+                .flatMap(Collection::stream)\n+                .collect(Collectors.groupingBy(Saliency::getOutput));\n+\n+        // calculate mean feature importance\n+        for (Map.Entry<Output, List<Saliency>> saliencyEntry : flatten.entrySet()) {\n+            List<FeatureImportance> result = new ArrayList<>();\n+            List<FeatureImportance> fis = saliencyEntry.getValue().stream().map(s -> s.perFeatureImportance).flatMap(Collection::stream).collect(Collectors.toList());\n+            Map<Feature, List<FeatureImportance>> collect = fis.stream().collect(Collectors.groupingBy(fi -> FeatureFactory.copyOf(fi.getFeature(), new Value<>(null))));\n+            for (Map.Entry<Feature, List<FeatureImportance>> entry : collect.entrySet()) {\n+                double meanScore = entry.getValue().stream().map(FeatureImportance::getScore).flatMapToDouble(DoubleStream::of).average().orElse(0);\n+                result.add(new FeatureImportance(entry.getKey(), meanScore));\n+            }\n+            result.sort(Comparator.comparing(f -> f.getFeature().getName()));\n+            finalResult.put(saliencyEntry.getKey().getName(), new Saliency(saliencyEntry.getKey(), result));\n+        }\n+        return finalResult;\n+    }\n+", "originalCommit": "c2af39d9536e62bd2b8a5b9f6b39ff3b290d175a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzU4MDg5NA==", "url": "https://github.com/kiegroup/kogito-apps/pull/486#discussion_r527580894", "bodyText": "oki", "author": "tteofili", "createdAt": "2020-11-20T10:00:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzUzNDY1OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzUzNjM1OA==", "url": "https://github.com/kiegroup/kogito-apps/pull/486#discussion_r527536358", "bodyText": "Should we set the seed here as well?", "author": "r00ta", "createdAt": "2020-11-20T08:57:01Z", "path": "explainability/explainability-core/src/test/java/org/kie/kogito/explainability/global/pdp/PartialDependencePlotExplainerTest.java", "diffHunk": "@@ -54,7 +53,7 @@\n     PredictionProviderMetadata metadata = new PredictionProviderMetadata() {\n         @Override\n         public DataDistribution getDataDistribution() {\n-            return DataUtils.generateRandomDataDistribution(3, 100, new FakeRandom());\n+            return DataUtils.generateRandomDataDistribution(3, 100, new Random());", "originalCommit": "c2af39d9536e62bd2b8a5b9f6b39ff3b290d175a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzU4MTAzNA==", "url": "https://github.com/kiegroup/kogito-apps/pull/486#discussion_r527581034", "bodyText": "yes, good point.", "author": "tteofili", "createdAt": "2020-11-20T10:00:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzUzNjM1OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzU0ODkyOQ==", "url": "https://github.com/kiegroup/kogito-apps/pull/486#discussion_r527548929", "bodyText": "What do you think if we aggregate the three tests in one? At the end they are checking that sample(), sample(int) and getAllSamples returns something, we might do something like\n    @Test\n    void testNumericGetAllSamples() {\n        Feature feature = TestUtils.getMockedNumericFeature();\n        double[] doubles = DataUtils.generateSamples(0, 10, 10);\n        List<Value<?>> values = Arrays.stream(doubles).mapToObj(Value::new).collect(Collectors.toList());\n        GenericFeatureDistribution numericFeatureDistribution = new GenericFeatureDistribution(feature, values);\n        Assertions.assertEquals(10, numericFeatureDistribution.getAllSamples().size());\n        Assertions.assertEquals(3, numericFeatureDistribution.sample(3).size());\n        Assertions.assertTrue(numericFeatureDistribution.sample().asNumber()).isBetween(0d, 10d));\n    }\n\nAssuming that  DataUtils.generateSamples is already unit tested I don't think it's necessary to test that every element is between 0 and 10.\nI would put a unit test for the case numericFeatureDistribution.sample(11) instead", "author": "r00ta", "createdAt": "2020-11-20T09:08:53Z", "path": "explainability/explainability-core/src/test/java/org/kie/kogito/explainability/model/GenericFeatureDistributionTest.java", "diffHunk": "@@ -0,0 +1,118 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.kie.kogito.explainability.model;\n+\n+import java.util.Arrays;\n+import java.util.List;\n+import java.util.stream.Collectors;\n+\n+import org.junit.jupiter.api.Test;\n+import org.kie.kogito.explainability.TestUtils;\n+import org.kie.kogito.explainability.utils.DataUtils;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.junit.jupiter.api.Assertions.*;\n+\n+class GenericFeatureDistributionTest {\n+\n+    @Test\n+    void testNumericSample() {\n+        Feature feature = TestUtils.getMockedNumericFeature();\n+        double[] doubles = DataUtils.generateSamples(0, 10, 10);\n+        List<Value<?>> values = Arrays.stream(doubles).mapToObj(Value::new).collect(Collectors.toList());\n+        GenericFeatureDistribution numericFeatureDistribution = new GenericFeatureDistribution(feature, values);\n+        Value<?> sample = numericFeatureDistribution.sample();\n+        assertNotNull(sample);\n+        assertNotNull(sample.getUnderlyingObject());\n+        assertThat(sample.asNumber()).isBetween(0d, 10d);\n+    }\n+\n+    @Test\n+    void testNumericSamples() {\n+        Feature feature = TestUtils.getMockedNumericFeature();\n+        double[] doubles = DataUtils.generateSamples(0, 10, 10);\n+        List<Value<?>> values = Arrays.stream(doubles).mapToObj(Value::new).collect(Collectors.toList());\n+        GenericFeatureDistribution numericFeatureDistribution = new GenericFeatureDistribution(feature, values);\n+        List<Value<?>> samples = numericFeatureDistribution.sample(3);\n+        assertNotNull(samples);\n+        assertEquals(3, samples.size());\n+        for (Value<?> sample : samples) {\n+            assertNotNull(sample);\n+            assertNotNull(sample.getUnderlyingObject());\n+            assertThat(sample.asNumber()).isBetween(0d, 10d);\n+        }\n+    }\n+\n+    @Test\n+    void testNumericGetAllSamples() {\n+        Feature feature = TestUtils.getMockedNumericFeature();\n+        double[] doubles = DataUtils.generateSamples(0, 10, 10);\n+        List<Value<?>> values = Arrays.stream(doubles).mapToObj(Value::new).collect(Collectors.toList());\n+        GenericFeatureDistribution numericFeatureDistribution = new GenericFeatureDistribution(feature, values);\n+        List<Value<?>> samples = numericFeatureDistribution.getAllSamples();\n+        assertNotNull(samples);\n+        assertEquals(10, samples.size());\n+        for (Value<?> sample : samples) {\n+            assertNotNull(sample);\n+            assertNotNull(sample.getUnderlyingObject());\n+            assertThat(sample.asNumber()).isBetween(0d, 10d);\n+        }\n+    }", "originalCommit": "c2af39d9536e62bd2b8a5b9f6b39ff3b290d175a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzY4Njc0Ng==", "url": "https://github.com/kiegroup/kogito-apps/pull/486#discussion_r527686746", "bodyText": "ok, I will unify them as suggested and create a new one for the \"bigger than distribution size\" case.", "author": "tteofili", "createdAt": "2020-11-20T13:22:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzU0ODkyOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzU0OTMwNQ==", "url": "https://github.com/kiegroup/kogito-apps/pull/486#discussion_r527549305", "bodyText": "Same for this", "author": "r00ta", "createdAt": "2020-11-20T09:09:14Z", "path": "explainability/explainability-core/src/test/java/org/kie/kogito/explainability/model/GenericFeatureDistributionTest.java", "diffHunk": "@@ -0,0 +1,118 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.kie.kogito.explainability.model;\n+\n+import java.util.Arrays;\n+import java.util.List;\n+import java.util.stream.Collectors;\n+\n+import org.junit.jupiter.api.Test;\n+import org.kie.kogito.explainability.TestUtils;\n+import org.kie.kogito.explainability.utils.DataUtils;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.junit.jupiter.api.Assertions.*;\n+\n+class GenericFeatureDistributionTest {\n+\n+    @Test\n+    void testNumericSample() {\n+        Feature feature = TestUtils.getMockedNumericFeature();\n+        double[] doubles = DataUtils.generateSamples(0, 10, 10);\n+        List<Value<?>> values = Arrays.stream(doubles).mapToObj(Value::new).collect(Collectors.toList());\n+        GenericFeatureDistribution numericFeatureDistribution = new GenericFeatureDistribution(feature, values);\n+        Value<?> sample = numericFeatureDistribution.sample();\n+        assertNotNull(sample);\n+        assertNotNull(sample.getUnderlyingObject());\n+        assertThat(sample.asNumber()).isBetween(0d, 10d);\n+    }\n+\n+    @Test\n+    void testNumericSamples() {\n+        Feature feature = TestUtils.getMockedNumericFeature();\n+        double[] doubles = DataUtils.generateSamples(0, 10, 10);\n+        List<Value<?>> values = Arrays.stream(doubles).mapToObj(Value::new).collect(Collectors.toList());\n+        GenericFeatureDistribution numericFeatureDistribution = new GenericFeatureDistribution(feature, values);\n+        List<Value<?>> samples = numericFeatureDistribution.sample(3);\n+        assertNotNull(samples);\n+        assertEquals(3, samples.size());\n+        for (Value<?> sample : samples) {\n+            assertNotNull(sample);\n+            assertNotNull(sample.getUnderlyingObject());\n+            assertThat(sample.asNumber()).isBetween(0d, 10d);\n+        }\n+    }\n+\n+    @Test\n+    void testNumericGetAllSamples() {\n+        Feature feature = TestUtils.getMockedNumericFeature();\n+        double[] doubles = DataUtils.generateSamples(0, 10, 10);\n+        List<Value<?>> values = Arrays.stream(doubles).mapToObj(Value::new).collect(Collectors.toList());\n+        GenericFeatureDistribution numericFeatureDistribution = new GenericFeatureDistribution(feature, values);\n+        List<Value<?>> samples = numericFeatureDistribution.getAllSamples();\n+        assertNotNull(samples);\n+        assertEquals(10, samples.size());\n+        for (Value<?> sample : samples) {\n+            assertNotNull(sample);\n+            assertNotNull(sample.getUnderlyingObject());\n+            assertThat(sample.asNumber()).isBetween(0d, 10d);\n+        }\n+    }\n+\n+    @Test\n+    void testStringSample() {\n+        Feature feature = TestUtils.getMockedNumericFeature();\n+        String[] words = \"a b c d e f g h i j k l m n o p q r s u v w x y z\".split(\" \");\n+        List<Value<?>> values = Arrays.stream(words).map(Value::new).collect(Collectors.toList());\n+        GenericFeatureDistribution numericFeatureDistribution = new GenericFeatureDistribution(feature, values);\n+        Value<?> sample = numericFeatureDistribution.sample();\n+        assertNotNull(sample);\n+        assertNotNull(sample.getUnderlyingObject());\n+        assertThat(sample.asString()).isBetween(\"a\", \"z\");\n+    }\n+\n+    @Test\n+    void testStringSamples() {\n+        Feature feature = TestUtils.getMockedNumericFeature();\n+        String[] words = \"a b c d e f g h i j k l m n o p q r s u v w x y z\".split(\" \");\n+        List<Value<?>> values = Arrays.stream(words).map(Value::new).collect(Collectors.toList());\n+        GenericFeatureDistribution numericFeatureDistribution = new GenericFeatureDistribution(feature, values);\n+        List<Value<?>> samples = numericFeatureDistribution.sample(3);\n+        assertNotNull(samples);\n+        assertEquals(3, samples.size());\n+        for (Value<?> sample : samples) {\n+            assertNotNull(sample);\n+            assertNotNull(sample.getUnderlyingObject());\n+            assertThat(sample.asString()).isBetween(\"a\", \"z\");\n+        }\n+    }\n+\n+    @Test\n+    void testStringGetAllSamples() {\n+        Feature feature = TestUtils.getMockedNumericFeature();\n+        String[] words = \"a b c d e f g h i j k l m n o p q r s t u v w x y z\".split(\" \");\n+        List<Value<?>> values = Arrays.stream(words).map(Value::new).collect(Collectors.toList());\n+        GenericFeatureDistribution numericFeatureDistribution = new GenericFeatureDistribution(feature, values);\n+        List<Value<?>> samples = numericFeatureDistribution.getAllSamples();\n+        assertNotNull(samples);\n+        assertEquals(26, samples.size());\n+        for (Value<?> sample : samples) {\n+            assertNotNull(sample);\n+            assertNotNull(sample.getUnderlyingObject());\n+            assertThat(sample.asString()).isBetween(\"a\", \"z\");\n+        }\n+    }", "originalCommit": "c2af39d9536e62bd2b8a5b9f6b39ff3b290d175a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzU1MDE3MQ==", "url": "https://github.com/kiegroup/kogito-apps/pull/486#discussion_r527550171", "bodyText": "Same as before", "author": "r00ta", "createdAt": "2020-11-20T09:09:55Z", "path": "explainability/explainability-core/src/test/java/org/kie/kogito/explainability/model/IndependentFeaturesDatatDistributionTest.java", "diffHunk": "@@ -0,0 +1,102 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.kie.kogito.explainability.model;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+import org.junit.jupiter.api.Test;\n+import org.kie.kogito.explainability.TestUtils;\n+import org.kie.kogito.explainability.utils.DataUtils;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+import static org.junit.jupiter.api.Assertions.assertNotNull;\n+\n+class IndependentFeaturesDatatDistributionTest {\n+\n+    @Test\n+    void testSample() {", "originalCommit": "c2af39d9536e62bd2b8a5b9f6b39ff3b290d175a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzU1MDM4NQ==", "url": "https://github.com/kiegroup/kogito-apps/pull/486#discussion_r527550385", "bodyText": "same as before", "author": "r00ta", "createdAt": "2020-11-20T09:10:16Z", "path": "explainability/explainability-core/src/test/java/org/kie/kogito/explainability/model/NumericFeatureDistributionTest.java", "diffHunk": "@@ -0,0 +1,84 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.kie.kogito.explainability.model;\n+\n+import java.util.List;\n+\n+import org.junit.jupiter.api.Test;\n+import org.kie.kogito.explainability.TestUtils;\n+import org.kie.kogito.explainability.utils.DataUtils;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.junit.jupiter.api.Assertions.*;\n+\n+class NumericFeatureDistributionTest {\n+\n+    @Test", "originalCommit": "c2af39d9536e62bd2b8a5b9f6b39ff3b290d175a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzU1MDY1MA==", "url": "https://github.com/kiegroup/kogito-apps/pull/486#discussion_r527550650", "bodyText": "same as before", "author": "r00ta", "createdAt": "2020-11-20T09:10:40Z", "path": "explainability/explainability-core/src/test/java/org/kie/kogito/explainability/model/PredictionInputsDataDistributionTest.java", "diffHunk": "@@ -0,0 +1,104 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.kie.kogito.explainability.model;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+import org.junit.jupiter.api.Test;\n+import org.kie.kogito.explainability.TestUtils;\n+\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+import static org.junit.jupiter.api.Assertions.assertNotNull;\n+import static org.junit.jupiter.api.Assertions.assertTrue;\n+\n+class PredictionInputsDataDistributionTest {\n+\n+    @Test\n+    void testSample() {", "originalCommit": "c2af39d9536e62bd2b8a5b9f6b39ff3b290d175a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzU1MjQyOQ==", "url": "https://github.com/kiegroup/kogito-apps/pull/486#discussion_r527552429", "bodyText": "Is this unit tested?", "author": "r00ta", "createdAt": "2020-11-20T09:13:52Z", "path": "explainability/explainability-core/src/main/java/org/kie/kogito/explainability/model/Saliency.java", "diffHunk": "@@ -58,8 +65,41 @@ public Output getOutput() {\n     @Override\n     public String toString() {\n         return \"Saliency{\" +\n-                \"perFeatureImportance=\" + perFeatureImportance +\n+                \"output=\" + output +\n+                \", perFeatureImportance=\" + perFeatureImportance +\n                 '}';\n     }\n-}\n \n+    /**\n+     * Merge saliencies so that they are aggregated by {@code Output} and the resulting list of associated\n+     * {@code FeatureImportance}s is derived by calculating the mean score for each feature across all such saliencies.\n+     *\n+     * @param saliencies a collection of saliency maps\n+     * @return a map of merged saliencies, one for each output appearing in the input saliencies\n+     */\n+    public static Map<String, Saliency> merge(Collection<Map<String, Saliency>> saliencies) {", "originalCommit": "c2af39d9536e62bd2b8a5b9f6b39ff3b290d175a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzU5MzkxNw==", "url": "https://github.com/kiegroup/kogito-apps/pull/486#discussion_r527593917", "bodyText": "yes, in SaliencyTest", "author": "tteofili", "createdAt": "2020-11-20T10:23:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzU1MjQyOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzU1MjY0NA==", "url": "https://github.com/kiegroup/kogito-apps/pull/486#discussion_r527552644", "bodyText": "Maybe I missed them, but do we have tests for those?", "author": "r00ta", "createdAt": "2020-11-20T09:14:15Z", "path": "explainability/explainability-core/src/main/java/org/kie/kogito/explainability/global/lime/AggregatedLimeExplainer.java", "diffHunk": "@@ -0,0 +1,69 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.kie.kogito.explainability.global.lime;\n+\n+import java.util.Collection;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.concurrent.CompletableFuture;\n+\n+import org.kie.kogito.explainability.global.ExistingPredictionsGlobalExplainer;\n+import org.kie.kogito.explainability.global.GlobalExplainer;\n+import org.kie.kogito.explainability.local.lime.LimeExplainer;\n+import org.kie.kogito.explainability.model.Prediction;\n+import org.kie.kogito.explainability.model.PredictionInput;\n+import org.kie.kogito.explainability.model.PredictionProvider;\n+import org.kie.kogito.explainability.model.PredictionProviderMetadata;\n+import org.kie.kogito.explainability.model.Saliency;\n+import org.kie.kogito.explainability.utils.DataUtils;\n+\n+/**\n+ * Global explainer aggregating LIME explanations over a number of inputs by reporting the mean feature importance for\n+ * each feature.\n+ */\n+public class AggregatedLimeExplainer implements GlobalExplainer<CompletableFuture<Map<String, Saliency>>>,\n+                                                ExistingPredictionsGlobalExplainer<CompletableFuture<Map<String, Saliency>>> {\n+\n+    private final LimeExplainer limeExplainer;\n+    private final int sampleSize;\n+\n+    public AggregatedLimeExplainer(LimeExplainer limeExplainer) {\n+        this(limeExplainer, 100);\n+    }\n+\n+    public AggregatedLimeExplainer(LimeExplainer limeExplainer, int sampleSize) {\n+        this.limeExplainer = limeExplainer;\n+        this.sampleSize = sampleSize;\n+    }\n+\n+    @Override\n+    public CompletableFuture<Map<String, Saliency>> explain(PredictionProvider model, PredictionProviderMetadata metadata) {\n+        List<PredictionInput> inputs = metadata.getDataDistribution().sample(sampleSize); // sample inputs from the data distribution\n+\n+        return model.predictAsync(inputs) // execute the model on the inputs\n+                .thenApply(os -> DataUtils.getPredictions(inputs, os)) // generate predictions from inputs and outputs\n+                .thenCompose(ps -> explain(model, ps)); // explain predictions\n+    }\n+\n+    @Override\n+    public CompletableFuture<Map<String, Saliency>> explain(PredictionProvider model, Collection<Prediction> predictions) {\n+        return CompletableFuture.completedFuture(predictions)\n+                .thenApply(p -> p.stream().map(prediction -> limeExplainer.explainAsync(prediction, model)) // extract saliency for each input\n+                        .map(CompletableFuture::join) // aggregate all the saliencies\n+                        .reduce(Collections.emptyMap(), (m1, m2) -> Saliency.merge(List.of(m1, m2)))); // merge all the saliencies together\n+    }\n+}", "originalCommit": "c2af39d9536e62bd2b8a5b9f6b39ff3b290d175a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzU5NDI1OA==", "url": "https://github.com/kiegroup/kogito-apps/pull/486#discussion_r527594258", "bodyText": "yes, they are tested in AggregatedLimeExplainerTest.", "author": "tteofili", "createdAt": "2020-11-20T10:23:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzU1MjY0NA=="}], "type": "inlineReview"}, {"oid": "4db39d7e9a2b31966c816d22c46d086b9a3c0336", "url": "https://github.com/kiegroup/kogito-apps/commit/4db39d7e9a2b31966c816d22c46d086b9a3c0336", "message": "KOGITO-3602 - added test, minor reafactoring in ALE", "committedDate": "2020-11-20T10:02:28Z", "type": "commit"}, {"oid": "f446d2e2bd9f8b9dfce0b1eab9c3b1f07d6e1ce5", "url": "https://github.com/kiegroup/kogito-apps/commit/f446d2e2bd9f8b9dfce0b1eab9c3b1f07d6e1ce5", "message": "KOGITO-3602 - removed newline", "committedDate": "2020-11-20T10:03:24Z", "type": "commit"}, {"oid": "f31f52851d34117b3ad6de890d122c5ca0ce891d", "url": "https://github.com/kiegroup/kogito-apps/commit/f31f52851d34117b3ad6de890d122c5ca0ce891d", "message": "KOGITO-3602 - more consistent *Distribution behaviors across impls", "committedDate": "2020-11-20T11:07:47Z", "type": "commit"}, {"oid": "5b53c49e1e2a0ed04c5f32c4e8ebf741c61baf2d", "url": "https://github.com/kiegroup/kogito-apps/commit/5b53c49e1e2a0ed04c5f32c4e8ebf741c61baf2d", "message": "KOGITO-3602 - use an instance Random in *Distributions", "committedDate": "2020-11-20T11:11:24Z", "type": "commit"}, {"oid": "fc3b3292d610f365d6ed7fa09eff92be13d4651e", "url": "https://github.com/kiegroup/kogito-apps/commit/fc3b3292d610f365d6ed7fa09eff92be13d4651e", "message": "KOGITO-3602 - set random seed in PDPETest", "committedDate": "2020-11-20T11:26:15Z", "type": "commit"}, {"oid": "0f257c8fac32c2c1c3872b0d137186e99c226ec5", "url": "https://github.com/kiegroup/kogito-apps/commit/0f257c8fac32c2c1c3872b0d137186e99c226ec5", "message": "KOGITO-3602 - test refactoring", "committedDate": "2020-11-20T14:04:28Z", "type": "commit"}, {"oid": "cd2279c36f9b6c4c222ba432765bededfe976253", "url": "https://github.com/kiegroup/kogito-apps/commit/cd2279c36f9b6c4c222ba432765bededfe976253", "message": "KOGITO-3602 - test refactoring", "committedDate": "2020-11-20T14:04:51Z", "type": "commit"}, {"oid": "348fe89bdcc36909849605a510810aaf6f8da453", "url": "https://github.com/kiegroup/kogito-apps/commit/348fe89bdcc36909849605a510810aaf6f8da453", "message": "KOGITO-3602 - optimize imports", "committedDate": "2020-11-20T14:05:32Z", "type": "commit"}, {"oid": "453560cc4ef9351f143e723a3f7740a9d975668c", "url": "https://github.com/kiegroup/kogito-apps/commit/453560cc4ef9351f143e723a3f7740a9d975668c", "message": "KOGITO-3602 - removed unused imports", "committedDate": "2020-11-23T09:11:30Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODYwNTA2OQ==", "url": "https://github.com/kiegroup/kogito-apps/pull/486#discussion_r528605069", "bodyText": "If I'm not wrong, according to the doc if you do value.size() - 1 the last value is never picked\nhttps://docs.oracle.com/javase/8/docs/api/java/util/Random.html#ints-long-int-int-", "author": "r00ta", "createdAt": "2020-11-23T10:32:40Z", "path": "explainability/explainability-core/src/main/java/org/kie/kogito/explainability/utils/DataUtils.java", "diffHunk": "@@ -408,4 +400,32 @@ private static void linearizeFeature(List<Feature> flattenedFeatures, Feature f)\n             flattenedFeatures.add(f);\n         }\n     }\n+\n+    /**\n+     * Build Predictions from PredictionInputs and PredictionOutputs.\n+     *\n+     * @param inputs prediction inputs\n+     * @param os     prediction outputs\n+     * @return a list of predictions\n+     */\n+    public static List<Prediction> getPredictions(List<PredictionInput> inputs, List<PredictionOutput> os) {\n+        return IntStream.range(0, os.size())\n+                .mapToObj(i -> new Prediction(inputs.get(i), os.get(i))).collect(Collectors.toList());\n+    }\n+\n+    /**\n+     * Sample (with replacement) from a list of values.\n+     *\n+     * @param values     the list to sample from\n+     * @param sampleSize the no. of samples to draw\n+     * @param random     a random instance\n+     * @param <T>        the type of values to sample\n+     * @return a list of sampled values\n+     */\n+    public static <T> List<T> sampleWithReplacement(List<T> values, int sampleSize, Random random) {\n+        return random\n+                .ints(sampleSize, 0, values.size() - 1)", "originalCommit": "453560cc4ef9351f143e723a3f7740a9d975668c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODY5NDM4NA==", "url": "https://github.com/kiegroup/kogito-apps/pull/486#discussion_r528694384", "bodyText": "correct, thanks for spotting it out!", "author": "tteofili", "createdAt": "2020-11-23T13:15:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODYwNTA2OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODYwNjg1OA==", "url": "https://github.com/kiegroup/kogito-apps/pull/486#discussion_r528606858", "bodyText": "Arrays.asList(doubles) is enought isnt't?", "author": "r00ta", "createdAt": "2020-11-23T10:35:41Z", "path": "explainability/explainability-core/src/main/java/org/kie/kogito/explainability/model/NumericFeatureDistribution.java", "diffHunk": "@@ -0,0 +1,71 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.kie.kogito.explainability.model;\n+\n+import java.security.SecureRandom;\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Random;\n+import java.util.stream.Collectors;\n+\n+import org.kie.kogito.explainability.utils.DataUtils;\n+\n+/**\n+ * Numeric feature distribution based on {@code double[]}.\n+ */\n+public class NumericFeatureDistribution implements FeatureDistribution {\n+\n+    private final Feature feature;\n+    private final double[] doubles;\n+    private final Random random;\n+\n+    public NumericFeatureDistribution(Feature feature, double[] doubles) {\n+        this(feature, doubles, new SecureRandom());\n+    }\n+\n+    public NumericFeatureDistribution(Feature feature, double[] doubles, Random random) {\n+        this.feature = feature;\n+        this.doubles = doubles;\n+        this.random = random;\n+    }\n+\n+    @Override\n+    public Feature getFeature() {\n+        return feature;\n+    }\n+\n+    @Override\n+    public Value<?> sample() {\n+        return sample(1).get(0);\n+    }\n+\n+    @Override\n+    public List<Value<?>> sample(int sampleSize) {\n+        return DataUtils.sampleWithReplacement(toValuesList(), sampleSize, random);\n+    }\n+\n+    private List<Value<?>> toValuesList() {\n+        return Arrays.stream(doubles).boxed().map(Value::new).collect(Collectors.toList());", "originalCommit": "453560cc4ef9351f143e723a3f7740a9d975668c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODcwODMzMw==", "url": "https://github.com/kiegroup/kogito-apps/pull/486#discussion_r528708333", "bodyText": "this is used to map a double[] into a List<Value<Double>>, it seems to me it's needed.", "author": "tteofili", "createdAt": "2020-11-23T13:38:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODYwNjg1OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODc1MjgxNw==", "url": "https://github.com/kiegroup/kogito-apps/pull/486#discussion_r528752817", "bodyText": "my bad, your're right", "author": "r00ta", "createdAt": "2020-11-23T14:44:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODYwNjg1OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODYxMzIzOQ==", "url": "https://github.com/kiegroup/kogito-apps/pull/486#discussion_r528613239", "bodyText": "Are these two tests covering the same scenario?", "author": "r00ta", "createdAt": "2020-11-23T10:46:44Z", "path": "explainability/explainability-core/src/test/java/org/kie/kogito/explainability/model/PredictionInputsDataDistributionTest.java", "diffHunk": "@@ -0,0 +1,90 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.kie.kogito.explainability.model;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+import org.junit.jupiter.api.Test;\n+import org.kie.kogito.explainability.TestUtils;\n+\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+import static org.junit.jupiter.api.Assertions.assertNotNull;\n+import static org.junit.jupiter.api.Assertions.assertTrue;\n+\n+class PredictionInputsDataDistributionTest {\n+\n+    @Test\n+    void testSample() {\n+        List<PredictionInput> inputs = new ArrayList<>(3);\n+        inputs.add(new PredictionInput(List.of(TestUtils.getMockedTextFeature(\"foo\"))));\n+        inputs.add(new PredictionInput(List.of(TestUtils.getMockedTextFeature(\"bar\"))));\n+        inputs.add(new PredictionInput(List.of(TestUtils.getMockedTextFeature(\"asd\"))));\n+        PredictionInputsDataDistribution predictionInputsDataDistribution = new PredictionInputsDataDistribution(inputs);\n+        PredictionInput sample = predictionInputsDataDistribution.sample();\n+        assertNotNull(sample);\n+        assertTrue(inputs.contains(sample));\n+    }\n+\n+    @Test\n+    void testSamples() {\n+        List<PredictionInput> inputs = new ArrayList<>(3);\n+        inputs.add(new PredictionInput(List.of(TestUtils.getMockedTextFeature(\"foo\"))));\n+        inputs.add(new PredictionInput(List.of(TestUtils.getMockedTextFeature(\"bar\"))));\n+        inputs.add(new PredictionInput(List.of(TestUtils.getMockedTextFeature(\"asd\"))));\n+        PredictionInputsDataDistribution predictionInputsDataDistribution = new PredictionInputsDataDistribution(inputs);\n+        assertEquals(3, predictionInputsDataDistribution.getAllSamples().size());\n+        List<PredictionInput> samples = predictionInputsDataDistribution.sample(2);\n+        assertNotNull(samples);\n+        assertEquals(2, samples.size());\n+        for (PredictionInput sample : samples) {\n+            assertTrue(inputs.contains(sample));\n+        }\n+    }\n+\n+    @Test\n+    void testLargerSamples() {\n+        List<PredictionInput> inputs = new ArrayList<>(3);\n+        inputs.add(new PredictionInput(List.of(TestUtils.getMockedTextFeature(\"foo\"))));\n+        inputs.add(new PredictionInput(List.of(TestUtils.getMockedTextFeature(\"bar\"))));\n+        inputs.add(new PredictionInput(List.of(TestUtils.getMockedTextFeature(\"asd\"))));\n+        PredictionInputsDataDistribution predictionInputsDataDistribution = new PredictionInputsDataDistribution(inputs);\n+        List<PredictionInput> samples = predictionInputsDataDistribution.sample(12);\n+        assertNotNull(samples);\n+        assertEquals(12, samples.size());\n+        for (PredictionInput sample : samples) {\n+            assertTrue(inputs.contains(sample));\n+        }\n+    }", "originalCommit": "453560cc4ef9351f143e723a3f7740a9d975668c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODcwODkxNA==", "url": "https://github.com/kiegroup/kogito-apps/pull/486#discussion_r528708914", "bodyText": "the second one covers the case for the sampleSize being bigger than the actual underlying data distribution size.", "author": "tteofili", "createdAt": "2020-11-23T13:39:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODYxMzIzOQ=="}], "type": "inlineReview"}, {"oid": "a9c2e8c527e3db2e3335582d0bc44f9dfd30d198", "url": "https://github.com/kiegroup/kogito-apps/commit/a9c2e8c527e3db2e3335582d0bc44f9dfd30d198", "message": "KOGITO-3602 - fixed samplingWRepl, added unit test", "committedDate": "2020-11-23T13:34:55Z", "type": "commit"}, {"oid": "1fad96e9a7f629dde33cb4754b60572e35b3f97f", "url": "https://github.com/kiegroup/kogito-apps/commit/1fad96e9a7f629dde33cb4754b60572e35b3f97f", "message": "KOGITO-3602 - minor adjustments", "committedDate": "2020-11-23T13:50:09Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTI2ODE0MA==", "url": "https://github.com/kiegroup/kogito-apps/pull/486#discussion_r529268140", "bodyText": "It would be better to make this deterministic, wdyt?\nyou might want to test if sampleWithReplacement works when values.size() < sampleSize for example", "author": "r00ta", "createdAt": "2020-11-24T07:55:33Z", "path": "explainability/explainability-core/src/test/java/org/kie/kogito/explainability/utils/DataUtilsTest.java", "diffHunk": "@@ -400,4 +401,14 @@ void testDropLinearizedFeature() {\n             assertNotEquals(source, newFeature);\n         }\n     }\n+\n+    @Test\n+    void testSampleWithReplacement() {\n+        List<Double> values = Arrays.stream(DataUtils.generateData(0, 1, 100, random)).boxed().collect(Collectors.toList());\n+        int sampleSize = random.nextInt(100);\n+        List<Double> samples = DataUtils.sampleWithReplacement(values, sampleSize, random);\n+        assertNotNull(samples);\n+        assertEquals(sampleSize, samples.size());\n+        assertThat(values).contains(samples.get(random.nextInt(sampleSize - 1)));", "originalCommit": "a9c2e8c527e3db2e3335582d0bc44f9dfd30d198", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTI3MTY4MA==", "url": "https://github.com/kiegroup/kogito-apps/pull/486#discussion_r529271680", "bodyText": "sure, makes sense.", "author": "tteofili", "createdAt": "2020-11-24T08:01:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTI2ODE0MA=="}], "type": "inlineReview"}, {"oid": "fcd69cc92fe54f4fbba08bb93dfbcf6453fcbe41", "url": "https://github.com/kiegroup/kogito-apps/commit/fcd69cc92fe54f4fbba08bb93dfbcf6453fcbe41", "message": "KOGITO-3602 - enhanced test for sample with replacement", "committedDate": "2020-11-24T08:50:24Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDI0NjA1OA==", "url": "https://github.com/kiegroup/kogito-apps/pull/486#discussion_r530246058", "bodyText": "I was wondering: since the array doubles is private and when it is used it's always converted to a list, is it better to convert it to a List<Value<?>> in the constructor so that it's done only once and not repeated every time a method is called?", "author": "r00ta", "createdAt": "2020-11-25T09:58:55Z", "path": "explainability/explainability-core/src/main/java/org/kie/kogito/explainability/model/NumericFeatureDistribution.java", "diffHunk": "@@ -0,0 +1,71 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.kie.kogito.explainability.model;\n+\n+import java.security.SecureRandom;\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Random;\n+import java.util.stream.Collectors;\n+\n+import org.kie.kogito.explainability.utils.DataUtils;\n+\n+/**\n+ * Numeric feature distribution based on {@code double[]}.\n+ */\n+public class NumericFeatureDistribution implements FeatureDistribution {\n+\n+    private final Feature feature;\n+    private final double[] doubles;\n+    private final Random random;\n+\n+    public NumericFeatureDistribution(Feature feature, double[] doubles) {\n+        this(feature, doubles, new SecureRandom());\n+    }\n+\n+    public NumericFeatureDistribution(Feature feature, double[] doubles, Random random) {\n+        this.feature = feature;\n+        this.doubles = doubles;\n+        this.random = random;\n+    }\n+\n+    @Override\n+    public Feature getFeature() {\n+        return feature;\n+    }\n+\n+    @Override\n+    public Value<?> sample() {\n+        return sample(1).get(0);\n+    }\n+\n+    @Override\n+    public List<Value<?>> sample(int sampleSize) {\n+        return DataUtils.sampleWithReplacement(toValuesList(doubles), sampleSize, random);\n+    }\n+\n+    private List<Value<?>> toValuesList(double[] doubles) {", "originalCommit": "fcd69cc92fe54f4fbba08bb93dfbcf6453fcbe41", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDI1MzgxMQ==", "url": "https://github.com/kiegroup/kogito-apps/pull/486#discussion_r530253811", "bodyText": "+1", "author": "tteofili", "createdAt": "2020-11-25T10:10:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDI0NjA1OA=="}], "type": "inlineReview"}, {"oid": "6c45c4b2d0b9778c975f6e7793f19b67c62e27d3", "url": "https://github.com/kiegroup/kogito-apps/commit/6c45c4b2d0b9778c975f6e7793f19b67c62e27d3", "message": "KOGITO-3602 - converting double[] to values only once in NFD", "committedDate": "2020-11-25T10:17:46Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjk3MDE3Mg==", "url": "https://github.com/kiegroup/kogito-apps/pull/486#discussion_r526970172", "bodyText": "Where is it used? I cannot find any usage", "author": "danielezonca", "createdAt": "2020-11-19T15:20:18Z", "path": "explainability/explainability-core/pom.xml", "diffHunk": "@@ -19,6 +19,10 @@\n       <groupId>org.apache.commons</groupId>\n       <artifactId>commons-lang3</artifactId>\n     </dependency>\n+    <dependency>\n+      <groupId>com.google.guava</groupId>\n+      <artifactId>guava</artifactId>\n+    </dependency>", "originalCommit": "e8f8c61825d565b8c2abe377475fb40a3e6b825e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTY2OTM2MA==", "url": "https://github.com/kiegroup/kogito-apps/pull/486#discussion_r531669360", "bodyText": "leftover from the initial draft, will remove it, thanks for spotting it.", "author": "tteofili", "createdAt": "2020-11-27T15:43:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjk3MDE3Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTY3MTM3Mg==", "url": "https://github.com/kiegroup/kogito-apps/pull/486#discussion_r531671372", "bodyText": "ah no! it's actually used in IndependentFeatureDistribution to generate the cartesian product of the feature values.", "author": "tteofili", "createdAt": "2020-11-27T15:48:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjk3MDE3Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDAwODYxNQ==", "url": "https://github.com/kiegroup/kogito-apps/pull/486#discussion_r534008615", "bodyText": "I'm dropping guava as it's only used here, hence reimplementing cartesian product.", "author": "tteofili", "createdAt": "2020-12-02T09:16:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjk3MDE3Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjk3ODgwMA==", "url": "https://github.com/kiegroup/kogito-apps/pull/486#discussion_r526978800", "bodyText": "This could produce to index out of bound if values is an empty list", "author": "danielezonca", "createdAt": "2020-11-19T15:30:58Z", "path": "explainability/explainability-core/src/main/java/org/kie/kogito/explainability/model/GenericFeatureDistribution.java", "diffHunk": "@@ -0,0 +1,70 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.kie.kogito.explainability.model;\n+\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * Feature distribution based on list of {@code Values}.\n+ */\n+public class GenericFeatureDistribution implements FeatureDistribution {\n+\n+    private final Logger LOGGER = LoggerFactory.getLogger(GenericFeatureDistribution.class);\n+\n+    private final Feature feature;\n+    private final List<Value<?>> values;\n+\n+    public GenericFeatureDistribution(Feature feature, List<Value<?>> values) {\n+        this.feature = feature;\n+        this.values = Collections.unmodifiableList(values);\n+    }\n+\n+    @Override\n+    public Feature getFeature() {\n+        return feature;\n+    }\n+\n+    @Override\n+    public Value<?> sample() {\n+        return sample(1).get(0);", "originalCommit": "e8f8c61825d565b8c2abe377475fb40a3e6b825e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTY2OTQ4Mg==", "url": "https://github.com/kiegroup/kogito-apps/pull/486#discussion_r531669482", "bodyText": "correct, thanks, I'll fix it.", "author": "tteofili", "createdAt": "2020-11-27T15:44:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjk3ODgwMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjk3OTEzMQ==", "url": "https://github.com/kiegroup/kogito-apps/pull/486#discussion_r526979131", "bodyText": "Same as above", "author": "danielezonca", "createdAt": "2020-11-19T15:31:24Z", "path": "explainability/explainability-core/src/main/java/org/kie/kogito/explainability/model/NumericFeatureDistribution.java", "diffHunk": "@@ -0,0 +1,69 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.kie.kogito.explainability.model;\n+\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.stream.Collectors;\n+\n+/**\n+ * Numeric feature distribution based on {@code double[]}.\n+ */\n+public class NumericFeatureDistribution implements FeatureDistribution {\n+\n+    private final Feature feature;\n+    private final double[] doubles;\n+\n+    public NumericFeatureDistribution(Feature feature, double[] doubles) {\n+        this.feature = feature;\n+        this.doubles = doubles;\n+    }\n+\n+    @Override\n+    public Feature getFeature() {\n+        return feature;\n+    }\n+\n+    @Override\n+    public Value<?> sample() {\n+        return sample(1).get(0);", "originalCommit": "e8f8c61825d565b8c2abe377475fb40a3e6b825e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTY2OTU1NQ==", "url": "https://github.com/kiegroup/kogito-apps/pull/486#discussion_r531669555", "bodyText": "correct, thanks, I'll fix it.", "author": "tteofili", "createdAt": "2020-11-27T15:44:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjk3OTEzMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTY0NjYxNQ==", "url": "https://github.com/kiegroup/kogito-apps/pull/486#discussion_r531646615", "bodyText": "Please create a ticket to review this code, we should be able to compose requests without the CompletableFuture::join", "author": "danielezonca", "createdAt": "2020-11-27T14:56:18Z", "path": "explainability/explainability-core/src/main/java/org/kie/kogito/explainability/global/lime/AggregatedLimeExplainer.java", "diffHunk": "@@ -0,0 +1,71 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.kie.kogito.explainability.global.lime;\n+\n+import java.util.Collection;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.concurrent.CompletableFuture;\n+\n+import org.kie.kogito.explainability.global.ExistingPredictionsGlobalExplainer;\n+import org.kie.kogito.explainability.global.GlobalExplainer;\n+import org.kie.kogito.explainability.local.lime.LimeExplainer;\n+import org.kie.kogito.explainability.model.Prediction;\n+import org.kie.kogito.explainability.model.PredictionInput;\n+import org.kie.kogito.explainability.model.PredictionProvider;\n+import org.kie.kogito.explainability.model.PredictionProviderMetadata;\n+import org.kie.kogito.explainability.model.Saliency;\n+import org.kie.kogito.explainability.utils.DataUtils;\n+\n+/**\n+ * Global explainer aggregating LIME explanations over a number of inputs by reporting the mean feature importance for\n+ * each feature.\n+ */\n+public class AggregatedLimeExplainer implements GlobalExplainer<CompletableFuture<Map<String, Saliency>>>,\n+                                                ExistingPredictionsGlobalExplainer<CompletableFuture<Map<String, Saliency>>> {\n+\n+    private static final int DEFAULT_SAMPLE_SIZE = 100;\n+\n+    private final LimeExplainer limeExplainer;\n+    private final int sampleSize;\n+\n+    public AggregatedLimeExplainer(LimeExplainer limeExplainer) {\n+        this(limeExplainer, DEFAULT_SAMPLE_SIZE);\n+    }\n+\n+    public AggregatedLimeExplainer(LimeExplainer limeExplainer, int sampleSize) {\n+        this.limeExplainer = limeExplainer;\n+        this.sampleSize = sampleSize;\n+    }\n+\n+    @Override\n+    public CompletableFuture<Map<String, Saliency>> explain(PredictionProvider model, PredictionProviderMetadata metadata) {\n+        List<PredictionInput> inputs = metadata.getDataDistribution().sample(sampleSize); // sample inputs from the data distribution\n+\n+        return model.predictAsync(inputs) // execute the model on the inputs\n+                .thenApply(os -> DataUtils.getPredictions(inputs, os)) // generate predictions from inputs and outputs\n+                .thenCompose(ps -> explain(model, ps)); // explain predictions\n+    }\n+\n+    @Override\n+    public CompletableFuture<Map<String, Saliency>> explain(PredictionProvider model, Collection<Prediction> predictions) {\n+        return CompletableFuture.completedFuture(predictions)\n+                .thenApply(p -> p.stream().map(prediction -> limeExplainer.explainAsync(prediction, model)) // extract saliency for each input\n+                        .map(CompletableFuture::join) // aggregate all the saliencies\n+                        .reduce(Collections.emptyMap(), (m1, m2) -> Saliency.merge(List.of(m1, m2)))); // merge all the saliencies together", "originalCommit": "6c45c4b2d0b9778c975f6e7793f19b67c62e27d3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDA3MDYzMQ==", "url": "https://github.com/kiegroup/kogito-apps/pull/486#discussion_r534070631", "bodyText": "I've created https://issues.redhat.com/browse/FAI-334 to track this.", "author": "tteofili", "createdAt": "2020-12-02T10:47:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTY0NjYxNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTY0ODI0MQ==", "url": "https://github.com/kiegroup/kogito-apps/pull/486#discussion_r531648241", "bodyText": "What about review it to use LimeConfig?", "author": "danielezonca", "createdAt": "2020-11-27T14:59:23Z", "path": "explainability/explainability-core/src/main/java/org/kie/kogito/explainability/global/lime/AggregatedLimeExplainer.java", "diffHunk": "@@ -0,0 +1,71 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.kie.kogito.explainability.global.lime;\n+\n+import java.util.Collection;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.concurrent.CompletableFuture;\n+\n+import org.kie.kogito.explainability.global.ExistingPredictionsGlobalExplainer;\n+import org.kie.kogito.explainability.global.GlobalExplainer;\n+import org.kie.kogito.explainability.local.lime.LimeExplainer;\n+import org.kie.kogito.explainability.model.Prediction;\n+import org.kie.kogito.explainability.model.PredictionInput;\n+import org.kie.kogito.explainability.model.PredictionProvider;\n+import org.kie.kogito.explainability.model.PredictionProviderMetadata;\n+import org.kie.kogito.explainability.model.Saliency;\n+import org.kie.kogito.explainability.utils.DataUtils;\n+\n+/**\n+ * Global explainer aggregating LIME explanations over a number of inputs by reporting the mean feature importance for\n+ * each feature.\n+ */\n+public class AggregatedLimeExplainer implements GlobalExplainer<CompletableFuture<Map<String, Saliency>>>,\n+                                                ExistingPredictionsGlobalExplainer<CompletableFuture<Map<String, Saliency>>> {\n+\n+    private static final int DEFAULT_SAMPLE_SIZE = 100;", "originalCommit": "6c45c4b2d0b9778c975f6e7793f19b67c62e27d3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDAzMDI2MQ==", "url": "https://github.com/kiegroup/kogito-apps/pull/486#discussion_r534030261", "bodyText": "agreed, it'll rely on the underlying LimeExplainer#getLimeConfig() settings.", "author": "tteofili", "createdAt": "2020-12-02T09:47:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTY0ODI0MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTY2MDcxNQ==", "url": "https://github.com/kiegroup/kogito-apps/pull/486#discussion_r531660715", "bodyText": "What about merge this interface with GlobalExplainer and have two different methods explainFromPrediction and explainFromMetadata?\nYou can also default implement explainFromMetadata\n    default public T explainFromMetadata(PredictionProvider model, PredictionProviderMetadata metadata) {\n        List<PredictionInput> inputs = metadata.getDataDistribution().sample(sampleSize); // sample inputs from the data distribution\n\n        return model.predictAsync(inputs) // execute the model on the inputs\n                .thenApply(os -> DataUtils.getPredictions(inputs, os)) // generate predictions from inputs and outputs\n                .thenCompose(ps -> explain(model, ps)); // explain predictions\n    }", "author": "danielezonca", "createdAt": "2020-11-27T15:25:37Z", "path": "explainability/explainability-core/src/main/java/org/kie/kogito/explainability/global/ExistingPredictionsGlobalExplainer.java", "diffHunk": "@@ -0,0 +1,39 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.kie.kogito.explainability.global;\n+\n+import java.util.Collection;\n+\n+import org.kie.kogito.explainability.model.Prediction;\n+import org.kie.kogito.explainability.model.PredictionProvider;\n+\n+/**\n+ * A global explainability method that leverages existing predictions (e.g. from historical data) instead of generating\n+ * new ones for the purpose of explainability.\n+ *\n+ * @param <T> the type of global explanation generated\n+ */\n+public interface ExistingPredictionsGlobalExplainer<T> {", "originalCommit": "6c45c4b2d0b9778c975f6e7793f19b67c62e27d3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDA2ODA1MQ==", "url": "https://github.com/kiegroup/kogito-apps/pull/486#discussion_r534068051", "bodyText": "agree on unifying the two interfaces, for now I'd not add a default method since we only have two impls, also the PDPExplainer works explicitly with feature distributions independently and would rather not make use of the existing outputs (as the inputs need to be \"crafted\" specifically and outputs need to be recalculated).", "author": "tteofili", "createdAt": "2020-12-02T10:43:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTY2MDcxNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTY2MTU5Mg==", "url": "https://github.com/kiegroup/kogito-apps/pull/486#discussion_r531661592", "bodyText": "Please verify if this could throw an index out of bound", "author": "danielezonca", "createdAt": "2020-11-27T15:27:28Z", "path": "explainability/explainability-core/src/main/java/org/kie/kogito/explainability/model/PredictionInputsDataDistribution.java", "diffHunk": "@@ -0,0 +1,80 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.kie.kogito.explainability.model;\n+\n+import java.security.SecureRandom;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Random;\n+\n+import org.kie.kogito.explainability.utils.DataUtils;\n+\n+/**\n+ * Data distribution based on list of {@code PredictionInputs}.\n+ */\n+public class PredictionInputsDataDistribution implements DataDistribution {\n+\n+    private final List<PredictionInput> inputs;\n+    private final Random random;\n+\n+    public PredictionInputsDataDistribution(List<PredictionInput> inputs) {\n+        this(inputs, new SecureRandom());\n+    }\n+\n+    public PredictionInputsDataDistribution(List<PredictionInput> inputs, Random random) {\n+        this.inputs = Collections.unmodifiableList(inputs);\n+        this.random = random;\n+    }\n+\n+    @Override\n+    public PredictionInput sample() {\n+        return sample(1).get(0);", "originalCommit": "6c45c4b2d0b9778c975f6e7793f19b67c62e27d3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzM5MTY2OQ==", "url": "https://github.com/kiegroup/kogito-apps/pull/486#discussion_r533391669", "bodyText": "@tteofili sorry I've missed this in the first review, is IndependentFeaturesDatatDistribution a typo? (i.e. should be IndependentFeaturesDataDistribution).\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            public class IndependentFeaturesDatatDistribution implements DataDistribution {\n          \n          \n            \n            public class IndependentFeaturesDataDistribution implements DataDistribution {", "author": "ruivieira", "createdAt": "2020-12-01T13:04:42Z", "path": "explainability/explainability-core/src/main/java/org/kie/kogito/explainability/model/IndependentFeaturesDatatDistribution.java", "diffHunk": "@@ -0,0 +1,81 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.kie.kogito.explainability.model;\n+\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Set;\n+\n+import com.google.common.collect.Sets;\n+\n+/**\n+ * Data distribution based on list of {@code FeatureDistributions}.\n+ */\n+public class IndependentFeaturesDatatDistribution implements DataDistribution {", "originalCommit": "6c45c4b2d0b9778c975f6e7793f19b67c62e27d3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDAwODA5OQ==", "url": "https://github.com/kiegroup/kogito-apps/pull/486#discussion_r534008099", "bodyText": "thanks a lot Rui for having spotted this \ud83d\udc4d", "author": "tteofili", "createdAt": "2020-12-02T09:15:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzM5MTY2OQ=="}], "type": "inlineReview"}, {"oid": "37c381f32109c06c6dbd4afced9b0c98c7d62d7f", "url": "https://github.com/kiegroup/kogito-apps/commit/37c381f32109c06c6dbd4afced9b0c98c7d62d7f", "message": "KOGITO-3602 - incorporating review comments", "committedDate": "2020-12-02T09:41:48Z", "type": "commit"}, {"oid": "a71909d84bbcbac437ca6f443b07cab20f1fbec1", "url": "https://github.com/kiegroup/kogito-apps/commit/a71909d84bbcbac437ca6f443b07cab20f1fbec1", "message": "Merge branch 'master' of github.com:kiegroup/kogito-apps into KOGITO-3602", "committedDate": "2020-12-02T09:44:55Z", "type": "commit"}, {"oid": "b49e922053bf6c0a723d27fbbabd4a647cf3f411", "url": "https://github.com/kiegroup/kogito-apps/commit/b49e922053bf6c0a723d27fbbabd4a647cf3f411", "message": "KOGITO-3602 - incorporating review comments", "committedDate": "2020-12-02T09:54:23Z", "type": "commit"}, {"oid": "681866b78f4dc30cd95974309f6b1e6d7f4c247a", "url": "https://github.com/kiegroup/kogito-apps/commit/681866b78f4dc30cd95974309f6b1e6d7f4c247a", "message": "KOGITO-3602 - incorporating review comments", "committedDate": "2020-12-02T10:47:30Z", "type": "commit"}]}