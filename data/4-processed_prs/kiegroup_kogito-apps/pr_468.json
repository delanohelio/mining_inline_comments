{"pr_number": 468, "pr_title": "KOGITO-3291: Implement security at Quarkus level for Management Console", "pr_createdAt": "2020-09-25T05:45:37Z", "pr_url": "https://github.com/kiegroup/kogito-apps/pull/468", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTcwNDM4OA==", "url": "https://github.com/kiegroup/kogito-apps/pull/468#discussion_r495704388", "bodyText": "If these dependencies are not necessary, please remove them.", "author": "Sgitario", "createdAt": "2020-09-28T05:58:24Z", "path": "security-commons/pom.xml", "diffHunk": "@@ -0,0 +1,106 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n+<project xmlns=\"http://maven.apache.org/POM/4.0.0\"\n+         xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n+         xsi:schemaLocation=\"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd\">\n+  <parent>\n+    <artifactId>kogito-apps</artifactId>\n+    <groupId>org.kie.kogito</groupId>\n+    <version>1.0.0-SNAPSHOT</version>\n+  </parent>\n+  <modelVersion>4.0.0</modelVersion>\n+\n+  <name>Kogito :: Security Commons</name>\n+  <artifactId>security-commons</artifactId>\n+\n+  <dependencyManagement>\n+    <dependencies>\n+      <dependency>\n+        <groupId>org.kie.kogito</groupId>\n+        <artifactId>kogito-bom</artifactId>\n+        <version>${project.version}</version>\n+        <type>pom</type>\n+        <scope>import</scope>\n+      </dependency>\n+      <dependency>\n+        <groupId>io.quarkus</groupId>\n+        <artifactId>quarkus-bom</artifactId>\n+        <version>${version.io.quarkus}</version>\n+        <type>pom</type>\n+        <scope>import</scope>\n+      </dependency>\n+    </dependencies>\n+  </dependencyManagement>\n+  <dependencies>\n+\n+    <!--dependency>\n+      <groupId>io.quarkus</groupId>\n+      <artifactId>quarkus-vertx-web</artifactId>\n+    </dependency -->\n+    <!--dependency>\n+      <groupId>io.quarkus</groupId>\n+      <artifactId>quarkus-resteasy</artifactId>", "originalCommit": "cdbacf9515b77c021687910e741a66c1740937c9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTcwNTg4Mg==", "url": "https://github.com/kiegroup/kogito-apps/pull/468#discussion_r495705882", "bodyText": "The name \"isReactAuthEnabled\" is accurated? Now, the auth is implemented in quarkus, so maybe just \"isAuthEnabled\" would be more correct?", "author": "Sgitario", "createdAt": "2020-09-28T06:03:31Z", "path": "ui-packages/packages/common/src/utils/KeycloakClient.ts", "diffHunk": "@@ -31,74 +35,143 @@ const keycloakInstance = createKeycloakInstance();\n export const getKeycloakInstance = (): KeycloakInstance => {\n   return keycloakInstance;\n };\n-export const getUserName = (): string => {\n-  let username = 'Anonymous';\n+\n+let currentSecurityContext;\n+export const getLoadedSecurityContext = (): UserContext => {\n+  if (!currentSecurityContext) {\n+    return {\n+      userName: 'Anonymous',\n+      roles: [],\n+      token: ''\n+    };\n+  }\n+  return currentSecurityContext;\n+}\n+\n+export const loadSecurityContext = async (\n+  onloadSuccess: () => void\n+) => {\n   if (isAuthEnabled()) {\n-    // @ts-ignore\n-    username = getKeycloakInstance().tokenParsed.preferred_username;\n+    if (isReactAuthEnabled()) {\n+      currentSecurityContext = {\n+        // @ts-ignore\n+        userName: getKeycloakInstance().tokenParsed.preferred_username,\n+        roles: getKeycloakInstance().tokenParsed.realm_access.roles,\n+        token: getKeycloakInstance().token\n+      };\n+      onloadSuccess();\n+    } else {\n+      try {\n+        const response = await axios.get(`/api/user/me`, {\n+          headers: {'Access-Control-Allow-Origin': '*'}\n+        });\n+        currentSecurityContext = response.data;\n+        onloadSuccess();\n+      } catch (error) {\n+        currentSecurityContext = {\n+          userName: error.message,\n+          roles: [],\n+          token: ''\n+        };\n+      }\n+    }\n+  } else {\n+    currentSecurityContext = {\n+      userName: 'Anonymous',\n+      roles: [],\n+      token: ''\n+    };\n+    onloadSuccess();\n   }\n-  return username;\n+};\n+\n+export const getUserName = (): string => {\n+  return getLoadedSecurityContext().userName;\n };\n \n export const getToken = (): string => {\n-  // @ts-ignore\n-  return getKeycloakInstance().token;\n+  return getLoadedSecurityContext().token;\n+};\n+\n+export const getRoles = (): string[] => {\n+  return getLoadedSecurityContext().roles;\n+};\n+\n+export const addResponseInterceptor = (client: AxiosInstance, onError: (AxiosRequestConfig) => void) => {\n+  client.interceptors.response.use(response => response,\n+    (error) => {\n+      if (error.response.status === 401) {\n+        onError(error.config);\n+      }\n+      return Promise.reject(error);\n+    });\n };\n \n export const appRenderWithAxiosInterceptorConfig = (\n   appRender: () => void\n ): void => {\n   if (isAuthEnabled()) {\n-    getKeycloakInstance()\n-      .init({ onLoad: 'login-required' })\n-      .success(authenticated => {\n-        if (authenticated) {\n-          appRender();\n-        }\n-      });\n-\n+    if (isReactAuthEnabled()) {", "originalCommit": "cdbacf9515b77c021687910e741a66c1740937c9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTcwNjIyNg==", "url": "https://github.com/kiegroup/kogito-apps/pull/468#discussion_r495706226", "bodyText": "Why do we need this property \"KOGITO_REACT_AUTH_ENABLED\"? Should not we use the KOGITO_AUTH_ENABLED for both quarkus and react apps as they are tied with each other now?", "author": "Sgitario", "createdAt": "2020-09-28T06:04:37Z", "path": "ui-packages/packages/management-console/package.json", "diffHunk": "@@ -12,7 +12,7 @@\n     \"precommit\": \"lint-staged\",\n     \"build:prod\": \"yarn run lint && webpack --config webpack.prod.js\",\n     \"start\": \"webpack-dev-server --hot --color --progress --info=true --config webpack.dev.js\",\n-    \"start-auth\": \"webpack-dev-server --hot --color --progress --info=true --config webpack.dev.js --define process.env.KOGITO_AUTH_ENABLED=true\",\n+    \"start-auth\": \"webpack-dev-server --hot --color --progress --info=true --config webpack.dev.js --define process.env.KOGITO_AUTH_ENABLED=true --define process.env.KOGITO_REACT_AUTH_ENABLED=true\",", "originalCommit": "cdbacf9515b77c021687910e741a66c1740937c9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTcxNzMzNQ==", "url": "https://github.com/kiegroup/kogito-apps/pull/468#discussion_r495717335", "bodyText": "@Sgitario the idea is to maintain the two modes of security: with the quarkus application (oidc extension) and at the react side (keycloak.js). That reactAuth enabled (property \"KOGITO_REACT_AUTH_ENABLED) has the goal to differentiate them.\nThe common use would be the quarkus security, but I keep this thinking in future integrations of the MC(react side).", "author": "nmirasch", "createdAt": "2020-09-28T06:37:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTcwNjIyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTcyNDM0OA==", "url": "https://github.com/kiegroup/kogito-apps/pull/468#discussion_r495724348", "bodyText": "I was not aware of this functionality... Is this new property transparent of the overal usage of the KOGITO_AUTH_ENABLED? I mean if I enable the KOGITO_AUTH_ENABLED property, the security will be enabled without taking care of more properties?", "author": "Sgitario", "createdAt": "2020-09-28T06:55:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTcwNjIyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTgyMzU4MA==", "url": "https://github.com/kiegroup/kogito-apps/pull/468#discussion_r495823580", "bodyText": "yes,  when security is enabled.. the property KOGITO_AUTH_ENABLED have to be true in both cases, and if its false is disabled. the only thing is, if the console want to be ran outside the quarkus app with security enabled, an extra property have to be set then :  KOGITO_REACT_AUTH_ENABLED.", "author": "nmirasch", "createdAt": "2020-09-28T09:57:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTcwNjIyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTgzNDgyMg==", "url": "https://github.com/kiegroup/kogito-apps/pull/468#discussion_r495834822", "bodyText": "Ok, thanks for the explanation.", "author": "Sgitario", "createdAt": "2020-09-28T10:17:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTcwNjIyNg=="}], "type": "inlineReview"}, {"oid": "f0d78bca4b2b3c7e687091239efacf8275d006cf", "url": "https://github.com/kiegroup/kogito-apps/commit/f0d78bca4b2b3c7e687091239efacf8275d006cf", "message": "KOGITO-3291: updated kogito-realm.json to map the user groups and remove comments", "committedDate": "2020-09-28T09:49:17Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjMxNjUyMA==", "url": "https://github.com/kiegroup/kogito-apps/pull/468#discussion_r496316520", "bodyText": "this file can probably removed, there is one at the root level already", "author": "cristianonicolai", "createdAt": "2020-09-29T01:05:14Z", "path": "security-commons/.gitignore", "diffHunk": "@@ -0,0 +1,14 @@\n+/target", "originalCommit": "f0d78bca4b2b3c7e687091239efacf8275d006cf", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjMxNjY3NA==", "url": "https://github.com/kiegroup/kogito-apps/pull/468#discussion_r496316674", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    private Set<String> roles= Collections.emptySet();\n          \n          \n            \n                    private Set<String> roles = Collections.emptySet();", "author": "cristianonicolai", "createdAt": "2020-09-29T01:05:48Z", "path": "security-commons/src/main/java/org/kie/kogito/security/UserResource.java", "diffHunk": "@@ -0,0 +1,82 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.kie.kogito.security;\n+\n+import java.util.Collections;\n+import java.util.Set;\n+\n+import javax.inject.Inject;\n+import javax.ws.rs.GET;\n+import javax.ws.rs.Path;\n+import javax.ws.rs.Produces;\n+import javax.ws.rs.core.MediaType;\n+\n+import io.quarkus.security.Authenticated;\n+import io.quarkus.security.credential.TokenCredential;\n+import io.quarkus.security.identity.SecurityIdentity;\n+import org.jboss.resteasy.annotations.cache.NoCache;\n+\n+@Path(UserResource.USER_PATH)\n+@Authenticated\n+public class UserResource {\n+\n+    public static final String USER_PATH = \"/api/user\";\n+\n+    @Inject\n+    SecurityIdentity identity;\n+\n+    @GET\n+    @Path(\"/me\")\n+    @Produces(MediaType.APPLICATION_JSON)\n+    @NoCache\n+    public User me() {\n+        return new User(identity);\n+    }\n+\n+    protected void setSecurityIdentity(SecurityIdentity securityIdentity) {\n+        this.identity = securityIdentity;\n+    }\n+\n+    public static class User {\n+\n+        private String userName = \"Anonymous\";\n+        private Set<String> roles= Collections.emptySet();", "originalCommit": "f0d78bca4b2b3c7e687091239efacf8275d006cf", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjMxNjc0OA==", "url": "https://github.com/kiegroup/kogito-apps/pull/468#discussion_r496316748", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                identity.getPrincipal()!=null &&\n          \n          \n            \n                                identity.getPrincipal() != null &&", "author": "cristianonicolai", "createdAt": "2020-09-29T01:06:11Z", "path": "security-commons/src/main/java/org/kie/kogito/security/UserResource.java", "diffHunk": "@@ -0,0 +1,82 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.kie.kogito.security;\n+\n+import java.util.Collections;\n+import java.util.Set;\n+\n+import javax.inject.Inject;\n+import javax.ws.rs.GET;\n+import javax.ws.rs.Path;\n+import javax.ws.rs.Produces;\n+import javax.ws.rs.core.MediaType;\n+\n+import io.quarkus.security.Authenticated;\n+import io.quarkus.security.credential.TokenCredential;\n+import io.quarkus.security.identity.SecurityIdentity;\n+import org.jboss.resteasy.annotations.cache.NoCache;\n+\n+@Path(UserResource.USER_PATH)\n+@Authenticated\n+public class UserResource {\n+\n+    public static final String USER_PATH = \"/api/user\";\n+\n+    @Inject\n+    SecurityIdentity identity;\n+\n+    @GET\n+    @Path(\"/me\")\n+    @Produces(MediaType.APPLICATION_JSON)\n+    @NoCache\n+    public User me() {\n+        return new User(identity);\n+    }\n+\n+    protected void setSecurityIdentity(SecurityIdentity securityIdentity) {\n+        this.identity = securityIdentity;\n+    }\n+\n+    public static class User {\n+\n+        private String userName = \"Anonymous\";\n+        private Set<String> roles= Collections.emptySet();\n+        private String token = \"\";\n+\n+        User(SecurityIdentity identity) {\n+            if(identity != null &&\n+                    identity.getPrincipal()!=null &&", "originalCommit": "f0d78bca4b2b3c7e687091239efacf8275d006cf", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjMxNjgwMQ==", "url": "https://github.com/kiegroup/kogito-apps/pull/468#discussion_r496316801", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                identity.getCredential(TokenCredential.class)!=null) {\n          \n          \n            \n                                identity.getCredential(TokenCredential.class) != null) {", "author": "cristianonicolai", "createdAt": "2020-09-29T01:06:21Z", "path": "security-commons/src/main/java/org/kie/kogito/security/UserResource.java", "diffHunk": "@@ -0,0 +1,82 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.kie.kogito.security;\n+\n+import java.util.Collections;\n+import java.util.Set;\n+\n+import javax.inject.Inject;\n+import javax.ws.rs.GET;\n+import javax.ws.rs.Path;\n+import javax.ws.rs.Produces;\n+import javax.ws.rs.core.MediaType;\n+\n+import io.quarkus.security.Authenticated;\n+import io.quarkus.security.credential.TokenCredential;\n+import io.quarkus.security.identity.SecurityIdentity;\n+import org.jboss.resteasy.annotations.cache.NoCache;\n+\n+@Path(UserResource.USER_PATH)\n+@Authenticated\n+public class UserResource {\n+\n+    public static final String USER_PATH = \"/api/user\";\n+\n+    @Inject\n+    SecurityIdentity identity;\n+\n+    @GET\n+    @Path(\"/me\")\n+    @Produces(MediaType.APPLICATION_JSON)\n+    @NoCache\n+    public User me() {\n+        return new User(identity);\n+    }\n+\n+    protected void setSecurityIdentity(SecurityIdentity securityIdentity) {\n+        this.identity = securityIdentity;\n+    }\n+\n+    public static class User {\n+\n+        private String userName = \"Anonymous\";\n+        private Set<String> roles= Collections.emptySet();\n+        private String token = \"\";\n+\n+        User(SecurityIdentity identity) {\n+            if(identity != null &&\n+                    identity.getPrincipal()!=null &&\n+                    identity.getCredential(TokenCredential.class)!=null) {", "originalCommit": "f0d78bca4b2b3c7e687091239efacf8275d006cf", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "00316f59f063418efdb4c0658ff8e37105607013", "url": "https://github.com/kiegroup/kogito-apps/commit/00316f59f063418efdb4c0658ff8e37105607013", "message": "KOGITO-3291: Implement security at Quarkus level for Management Console", "committedDate": "2020-09-30T06:04:21Z", "type": "commit"}, {"oid": "826e26bebcefe7ae35bb7fc571414f372b8b15c3", "url": "https://github.com/kiegroup/kogito-apps/commit/826e26bebcefe7ae35bb7fc571414f372b8b15c3", "message": "KOGITO-3291: updated kogito-realm.json to map the user groups and remove comments", "committedDate": "2020-09-30T06:04:21Z", "type": "commit"}, {"oid": "5cae92b13a47296234501840d7257afc4304905d", "url": "https://github.com/kiegroup/kogito-apps/commit/5cae92b13a47296234501840d7257afc4304905d", "message": " KOGITO-3291: Removed keycloak integration from react", "committedDate": "2020-09-30T09:19:02Z", "type": "commit"}, {"oid": "5cae92b13a47296234501840d7257afc4304905d", "url": "https://github.com/kiegroup/kogito-apps/commit/5cae92b13a47296234501840d7257afc4304905d", "message": " KOGITO-3291: Removed keycloak integration from react", "committedDate": "2020-09-30T09:19:02Z", "type": "forcePushed"}, {"oid": "fb841f9b4573fe1a562f34194b98ffd379121bac", "url": "https://github.com/kiegroup/kogito-apps/commit/fb841f9b4573fe1a562f34194b98ffd379121bac", "message": "KOGITO-3291: updated security commons testing", "committedDate": "2020-09-30T11:37:29Z", "type": "commit"}]}