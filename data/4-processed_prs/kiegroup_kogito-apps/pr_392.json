{"pr_number": 392, "pr_title": "KOGITO-3090 - Fix pagination and add tests", "pr_createdAt": "2020-08-13T16:55:17Z", "pr_url": "https://github.com/kiegroup/kogito-apps/pull/392", "timeline": [{"oid": "e9095517905e6b899a771685dc07698206776556", "url": "https://github.com/kiegroup/kogito-apps/commit/e9095517905e6b899a771685dc07698206776556", "message": "fix pagination and add tests", "committedDate": "2020-08-13T16:53:55Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTI2NzEzOQ==", "url": "https://github.com/kiegroup/kogito-apps/pull/392#discussion_r471267139", "bodyText": "Can you please better explain the original problem?\nI don't like that now we are loading the entire storage in a list before applying the offset.", "author": "danielezonca", "createdAt": "2020-08-17T06:58:06Z", "path": "trusty/trusty-service/src/main/java/org/kie/kogito/trusty/service/TrustyServiceImpl.java", "diffHunk": "@@ -56,13 +61,23 @@ public TrustyServiceImpl(TrustyStorageService storageService) {\n     }\n \n     @Override\n-    public List<Execution> getExecutionHeaders(OffsetDateTime from, OffsetDateTime to, int limit, int offset, String prefix) {\n+    public MatchedExecutionHeaders getExecutionHeaders(OffsetDateTime from, OffsetDateTime to, int limit, int offset, String prefix) {\n         Storage<String, Decision> storage = storageService.getDecisionsStorage();\n         List<AttributeFilter<?>> filters = new ArrayList<>();\n         filters.add(QueryFilterFactory.like(Execution.EXECUTION_ID_FIELD, prefix + \"*\"));\n         filters.add(QueryFilterFactory.greaterThanEqual(Execution.EXECUTION_TIMESTAMP_FIELD, from.toInstant().toEpochMilli()));\n         filters.add(QueryFilterFactory.lessThanEqual(Execution.EXECUTION_TIMESTAMP_FIELD, to.toInstant().toEpochMilli()));\n-        return new ArrayList<>(storage.query().limit(limit).offset(offset).filter(filters).execute());\n+        ArrayList result = new ArrayList<>(storage.query()\n+                                                   .sort(asList(orderBy(Execution.EXECUTION_TIMESTAMP_FIELD, DESC)))\n+                                                   .filter(filters)\n+                                                   .execute()", "originalCommit": "e9095517905e6b899a771685dc07698206776556", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTQ2Mjk5NQ==", "url": "https://github.com/kiegroup/kogito-apps/pull/392#discussion_r471462995", "bodyText": "Ok I had a look to Query in persistence-commons and count is not supported so we should implement it to properly fix the bug", "author": "danielezonca", "createdAt": "2020-08-17T13:02:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTI2NzEzOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTU2MzQyMg==", "url": "https://github.com/kiegroup/kogito-apps/pull/392#discussion_r471563422", "bodyText": "Hi @danielezonca ,\nwe have two options:\n\nwe load all the executions from that timestamp and then apply the offset/return the count of the results\nwe run two queries: one to extract the number of matched executions and one to extract only the results from offset to offset+total.\n\nThis PR implements the first option and adds some tests to check that the contract with the UI is not broken in terms of pagination. We can move forward with this and then create another ticket to implement the second option, or directly implement that. let me know what you think", "author": "r00ta", "createdAt": "2020-08-17T15:36:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTI2NzEzOQ=="}], "type": "inlineReview"}, {"oid": "78bca7f2c5420d4661813aaf4726b92cdb4b175d", "url": "https://github.com/kiegroup/kogito-apps/commit/78bca7f2c5420d4661813aaf4726b92cdb4b175d", "message": "Merge branch 'master' into KOGITO-3090-fix-pagination", "committedDate": "2020-08-24T06:47:25Z", "type": "commit"}, {"oid": "8ff72ba4c78de30143d87a3b9c197721fd964e79", "url": "https://github.com/kiegroup/kogito-apps/commit/8ff72ba4c78de30143d87a3b9c197721fd964e79", "message": "Merge remote-tracking branch 'upstream/master' into KOGITO-3090-fix-pagination", "committedDate": "2020-08-25T09:03:22Z", "type": "commit"}, {"oid": "7f68b099ecc7307925376b77dc6180f80b2fcb2c", "url": "https://github.com/kiegroup/kogito-apps/commit/7f68b099ecc7307925376b77dc6180f80b2fcb2c", "message": "rebase", "committedDate": "2020-08-25T09:14:33Z", "type": "commit"}, {"oid": "73ed731ad130033cee3ac6fa41676fee3e388be7", "url": "https://github.com/kiegroup/kogito-apps/commit/73ed731ad130033cee3ac6fa41676fee3e388be7", "message": "rebase: remove v1 from endpoints", "committedDate": "2020-08-26T07:23:30Z", "type": "commit"}]}