{"pr_number": 647, "pr_title": "Track user assignments and update if they change, sync jurisdictions by Id", "pr_createdAt": "2020-09-21T08:58:20Z", "pr_url": "https://github.com/opensrp/opensrp-client-core/pull/647", "timeline": [{"oid": "63fa94041f2decab43402f78bb32cdec54059b27", "url": "https://github.com/opensrp/opensrp-client-core/commit/63fa94041f2decab43402f78bb32cdec54059b27", "message": "Remove parent  from hierarchy if only child is removed", "committedDate": "2020-09-23T13:28:42Z", "type": "forcePushed"}, {"oid": "f0615b57ba78c4ca90dbb3fd8710d4e73a86ca32", "url": "https://github.com/opensrp/opensrp-client-core/commit/f0615b57ba78c4ca90dbb3fd8710d4e73a86ca32", "message": "Save assigned jurisdiction Ids during login", "committedDate": "2020-09-24T06:41:14Z", "type": "commit"}, {"oid": "0a938a9f9599d873c3759b5e080b3eb158fa1d78", "url": "https://github.com/opensrp/opensrp-client-core/commit/0a938a9f9599d873c3759b5e080b3eb158fa1d78", "message": "Remove unsed code used when reveal was using OpenMRS team management", "committedDate": "2020-09-24T06:41:14Z", "type": "commit"}, {"oid": "7ff2774cadfd4f4375efcbb154d8f08c91ffd992", "url": "https://github.com/opensrp/opensrp-client-core/commit/7ff2774cadfd4f4375efcbb154d8f08c91ffd992", "message": "Send jurisdiction Ids when synching locations", "committedDate": "2020-09-24T06:41:14Z", "type": "commit"}, {"oid": "3cca0278806636eeb7653dda78a6ef20c90327ec", "url": "https://github.com/opensrp/opensrp-client-core/commit/3cca0278806636eeb7653dda78a6ef20c90327ec", "message": "Validate user assignments after sync", "committedDate": "2020-09-24T06:41:14Z", "type": "commit"}, {"oid": "7aa98aa11b0408063385e05dbe40e846cffbd9d6", "url": "https://github.com/opensrp/opensrp-client-core/commit/7aa98aa11b0408063385e05dbe40e846cffbd9d6", "message": "Validate user assignments only if keycloak is configured", "committedDate": "2020-09-24T06:41:14Z", "type": "commit"}, {"oid": "b801d297a337b986ef61425f64ead1f4730785cb", "url": "https://github.com/opensrp/opensrp-client-core/commit/b801d297a337b986ef61425f64ead1f4730785cb", "message": "Support retrieving boolean preferences", "committedDate": "2020-09-24T06:41:14Z", "type": "commit"}, {"oid": "fc2faf9c2f7ead5d9e4982552e7a32969c245c11", "url": "https://github.com/opensrp/opensrp-client-core/commit/fc2faf9c2f7ead5d9e4982552e7a32969c245c11", "message": "Set locationIds if they exist", "committedDate": "2020-09-24T06:41:14Z", "type": "commit"}, {"oid": "731f285637f81214d4bb5e1b5a90d6f96c5b1ed7", "url": "https://github.com/opensrp/opensrp-client-core/commit/731f285637f81214d4bb5e1b5a90d6f96c5b1ed7", "message": "delete locations and plans that a user no longer has access to", "committedDate": "2020-09-24T06:41:15Z", "type": "commit"}, {"oid": "b5a8f5cb68878cbeeccb2ba211c45bbc2315f7bd", "url": "https://github.com/opensrp/opensrp-client-core/commit/b5a8f5cb68878cbeeccb2ba211c45bbc2315f7bd", "message": "Remove locations from location tree", "committedDate": "2020-09-24T06:41:15Z", "type": "commit"}, {"oid": "0726380808c0521a4ceac354ca0cf45cdb407b75", "url": "https://github.com/opensrp/opensrp-client-core/commit/0726380808c0521a4ceac354ca0cf45cdb407b75", "message": "remove jurisdictions that use no longer has access on preferences", "committedDate": "2020-09-24T06:41:15Z", "type": "commit"}, {"oid": "3b5c7aa7103451f94476bef0e6e3fc0281510af5", "url": "https://github.com/opensrp/opensrp-client-core/commit/3b5c7aa7103451f94476bef0e6e3fc0281510af5", "message": "Unit test remove locations from hiearchy", "committedDate": "2020-09-24T06:41:15Z", "type": "commit"}, {"oid": "626281b57cbe113a4051502e1c6ffd2f9c3cd490", "url": "https://github.com/opensrp/opensrp-client-core/commit/626281b57cbe113a4051502e1c6ffd2f9c3cd490", "message": "Unit test removing locations are removed from the location hierachy", "committedDate": "2020-09-24T06:41:15Z", "type": "commit"}, {"oid": "750799aac50d8afc83664f9789408bcbaf5a2176", "url": "https://github.com/opensrp/opensrp-client-core/commit/750799aac50d8afc83664f9789408bcbaf5a2176", "message": "Correct logic of removing locations from lcation tree", "committedDate": "2020-09-24T06:41:15Z", "type": "commit"}, {"oid": "9c0b8bb172d877ebd473ceab1e6798401e58bb7f", "url": "https://github.com/opensrp/opensrp-client-core/commit/9c0b8bb172d877ebd473ceab1e6798401e58bb7f", "message": "broadcast removed assignments if new assignments have not been added", "committedDate": "2020-09-24T06:41:15Z", "type": "commit"}, {"oid": "4a988626e435c1c21d77e342c1d6b411ccb0f0a9", "url": "https://github.com/opensrp/opensrp-client-core/commit/4a988626e435c1c21d77e342c1d6b411ccb0f0a9", "message": "Evict location heirarchy cache", "committedDate": "2020-09-24T06:41:15Z", "type": "commit"}, {"oid": "a94f9e70faa88ee0f8a08ea75d5dc727756794d5", "url": "https://github.com/opensrp/opensrp-client-core/commit/a94f9e70faa88ee0f8a08ea75d5dc727756794d5", "message": "Logoff if user default location is revoked", "committedDate": "2020-09-24T06:41:15Z", "type": "commit"}, {"oid": "49a2fad11263769fb0e0844b56d21febf738d34d", "url": "https://github.com/opensrp/opensrp-client-core/commit/49a2fad11263769fb0e0844b56d21febf738d34d", "message": "reset sync when new assignments are assigned", "committedDate": "2020-09-24T06:41:16Z", "type": "commit"}, {"oid": "b096e71a388d5168b904c1b6a38d4ad756d09325", "url": "https://github.com/opensrp/opensrp-client-core/commit/b096e71a388d5168b904c1b6a38d4ad756d09325", "message": "bump up version as per semver", "committedDate": "2020-09-24T06:41:46Z", "type": "commit"}, {"oid": "0f1ca58f4ec5cb8e84cc68ae04d5e139e2e2fdac", "url": "https://github.com/opensrp/opensrp-client-core/commit/0f1ca58f4ec5cb8e84cc68ae04d5e139e2e2fdac", "message": "Add a receiver for removed assignments", "committedDate": "2020-09-24T06:41:46Z", "type": "commit"}, {"oid": "c3cb7d471f670c14302a6680a09eccc1d2dd2316", "url": "https://github.com/opensrp/opensrp-client-core/commit/c3cb7d471f670c14302a6680a09eccc1d2dd2316", "message": "Broadcast receiver allow registration of multiple listeners", "committedDate": "2020-09-24T06:41:46Z", "type": "commit"}, {"oid": "be619bbae79a11731e87acabeb1cfdfbdb880590", "url": "https://github.com/opensrp/opensrp-client-core/commit/be619bbae79a11731e87acabeb1cfdfbdb880590", "message": "Add a unit testing if location is removed and parent is without children then parent is also removed", "committedDate": "2020-09-24T06:41:46Z", "type": "commit"}, {"oid": "3e506fa328b677cacf0f7e19d0d593d49c0431e1", "url": "https://github.com/opensrp/opensrp-client-core/commit/3e506fa328b677cacf0f7e19d0d593d49c0431e1", "message": "Remove parent  from hierarchy if only child is removed", "committedDate": "2020-09-24T06:41:46Z", "type": "commit"}, {"oid": "3e506fa328b677cacf0f7e19d0d593d49c0431e1", "url": "https://github.com/opensrp/opensrp-client-core/commit/3e506fa328b677cacf0f7e19d0d593d49c0431e1", "message": "Remove parent  from hierarchy if only child is removed", "committedDate": "2020-09-24T06:41:46Z", "type": "forcePushed"}, {"oid": "6e509426bd9b709a981c1bd9561022082833971a", "url": "https://github.com/opensrp/opensrp-client-core/commit/6e509426bd9b709a981c1bd9561022082833971a", "message": "Remove unsed fields and optimize imports", "committedDate": "2020-09-24T06:48:36Z", "type": "commit"}, {"oid": "d2021623f992d6f2c0d83ad01c700377514d5a52", "url": "https://github.com/opensrp/opensrp-client-core/commit/d2021623f992d6f2c0d83ad01c700377514d5a52", "message": "Assert location cache is evicted", "committedDate": "2020-09-24T07:01:39Z", "type": "commit"}, {"oid": "cad29ed71cd7e0e9d8a06cedacd42866b180e0b9", "url": "https://github.com/opensrp/opensrp-client-core/commit/cad29ed71cd7e0e9d8a06cedacd42866b180e0b9", "message": "Add unit tests for new assignments and removed assignments", "committedDate": "2020-09-24T08:31:26Z", "type": "commit"}, {"oid": "4b4e0bb5026c8a1d3996712076625d915e9e8d9d", "url": "https://github.com/opensrp/opensrp-client-core/commit/4b4e0bb5026c8a1d3996712076625d915e9e8d9d", "message": "Remove internal try catch", "committedDate": "2020-09-24T10:43:00Z", "type": "commit"}, {"oid": "7e316c141806f635f3ff45397bd01a0edeb4ef79", "url": "https://github.com/opensrp/opensrp-client-core/commit/7e316c141806f635f3ff45397bd01a0edeb4ef79", "message": "unit test removing default location user is logged off", "committedDate": "2020-09-24T10:50:26Z", "type": "commit"}, {"oid": "3a991faec653530f1a7ac95afcd0d8fa8409e595", "url": "https://github.com/opensrp/opensrp-client-core/commit/3a991faec653530f1a7ac95afcd0d8fa8409e595", "message": "Add receiver Unit tests", "committedDate": "2020-09-24T13:34:29Z", "type": "commit"}, {"oid": "246538cf580ed6aead266b479d135f1b4c310789", "url": "https://github.com/opensrp/opensrp-client-core/commit/246538cf580ed6aead266b479d135f1b4c310789", "message": "Add unit tests", "committedDate": "2020-09-24T13:44:37Z", "type": "commit"}, {"oid": "246538cf580ed6aead266b479d135f1b4c310789", "url": "https://github.com/opensrp/opensrp-client-core/commit/246538cf580ed6aead266b479d135f1b4c310789", "message": "Add unit tests", "committedDate": "2020-09-24T13:44:37Z", "type": "forcePushed"}, {"oid": "3235f0fb0bf74af483411cd626c3352d5b1034c7", "url": "https://github.com/opensrp/opensrp-client-core/commit/3235f0fb0bf74af483411cd626c3352d5b1034c7", "message": "add teardown method and correct injecting mocks syntax", "committedDate": "2020-09-24T14:13:15Z", "type": "commit"}, {"oid": "c7e98bf511eb1038cf050a0fe9efd9a59984b60f", "url": "https://github.com/opensrp/opensrp-client-core/commit/c7e98bf511eb1038cf050a0fe9efd9a59984b60f", "message": "unit test get assignment throws error if null", "committedDate": "2020-09-24T14:44:57Z", "type": "commit"}, {"oid": "47439c3205640f7c136f7cd923a90a650148f1ea", "url": "https://github.com/opensrp/opensrp-client-core/commit/47439c3205640f7c136f7cd923a90a650148f1ea", "message": "Return boolean if validation succeeded", "committedDate": "2020-09-24T15:42:50Z", "type": "commit"}, {"oid": "47439c3205640f7c136f7cd923a90a650148f1ea", "url": "https://github.com/opensrp/opensrp-client-core/commit/47439c3205640f7c136f7cd923a90a650148f1ea", "message": "Return boolean if validation succeeded", "committedDate": "2020-09-24T15:42:50Z", "type": "forcePushed"}, {"oid": "b85c79371ac15f09654d533ad3ded702130662f7", "url": "https://github.com/opensrp/opensrp-client-core/commit/b85c79371ac15f09654d533ad3ded702130662f7", "message": "stub getFormattedBaseUrl", "committedDate": "2020-09-24T16:16:23Z", "type": "forcePushed"}, {"oid": "4b89e5a05d1c79e4cbf83ac61163bc9ece2469e6", "url": "https://github.com/opensrp/opensrp-client-core/commit/4b89e5a05d1c79e4cbf83ac61163bc9ece2469e6", "message": "stub getFormattedBaseUrl", "committedDate": "2020-09-24T16:30:20Z", "type": "commit"}, {"oid": "4b89e5a05d1c79e4cbf83ac61163bc9ece2469e6", "url": "https://github.com/opensrp/opensrp-client-core/commit/4b89e5a05d1c79e4cbf83ac61163bc9ece2469e6", "message": "stub getFormattedBaseUrl", "committedDate": "2020-09-24T16:30:20Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDgxOTI5Ng==", "url": "https://github.com/opensrp/opensrp-client-core/pull/647#discussion_r494819296", "bodyText": "Could we make this location_ids a constant", "author": "Rkareko", "createdAt": "2020-09-25T08:07:12Z", "path": "opensrp-app/src/main/java/org/smartregister/sync/helper/LocationServiceHelper.java", "diffHunk": "@@ -161,6 +162,11 @@ private String fetchLocationsOrStructures(boolean isJurisdiction, Long serverVer\n         if (isJurisdiction) {\n             String preferenceLocationNames = allSharedPreferences.getPreference(OPERATIONAL_AREAS);\n             request.put(\"location_names\", new JSONArray(Arrays.asList(preferenceLocationNames.split(\",\"))));\n+\n+            String preferenceLocationIds = allSharedPreferences.getPreference(JURISDICTION_IDS);\n+            if (StringUtils.isNotBlank(preferenceLocationIds)) {\n+                request.put(\"location_ids\", new JSONArray(Arrays.asList(preferenceLocationIds.split(\",\"))));", "originalCommit": "4b89e5a05d1c79e4cbf83ac61163bc9ece2469e6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDgwNTg3MQ==", "url": "https://github.com/opensrp/opensrp-client-core/pull/647#discussion_r494805871", "bodyText": "I think the parent might be null\nThis is a question. I see that we delete  the parent also if the node id was it's only child. I am not sure why that is?", "author": "ekigamba", "createdAt": "2020-09-25T07:41:35Z", "path": "opensrp-app/src/main/java/org/smartregister/domain/jsonmapping/util/Tree.java", "diffHunk": "@@ -112,6 +112,23 @@ public void addNode(K id, String label, T node, K parentId) {\n         return null;\n     }\n \n+    /**\n+     * Delete nodes from location hierarchy\n+     *\n+     * @param id the id of the node to remove\n+     */\n+    public void deleteNode(K id) {\n+        TreeNode<K, T> node = getNode(id);\n+        removeNode(id);\n+        parentChildren.remove(id);\n+        LinkedHashSet<K> parent = parentChildren.get(node.getParent());\n+        if (parent != null && parent.size() == 1) {\n+            deleteNode(node.getParent());\n+        } else {\n+            parent.remove(id);", "originalCommit": "4b89e5a05d1c79e4cbf83ac61163bc9ece2469e6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDgzNzQzMQ==", "url": "https://github.com/opensrp/opensrp-client-core/pull/647#discussion_r494837431", "bodyText": "This is so that we don't have orphaned nodes. In the location tree we usually get the assigned locations and build the higher nodes, so if a lower node is removed, then its logical the the parent should be removed", "author": "githengi", "createdAt": "2020-09-25T08:40:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDgwNTg3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDgzODQ5MA==", "url": "https://github.com/opensrp/opensrp-client-core/pull/647#discussion_r494838490", "bodyText": "Cool", "author": "ekigamba", "createdAt": "2020-09-25T08:42:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDgwNTg3MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDgxNjM5OA==", "url": "https://github.com/opensrp/opensrp-client-core/pull/647#discussion_r494816398", "bodyText": "Nice catch", "author": "ekigamba", "createdAt": "2020-09-25T08:01:35Z", "path": "opensrp-app/src/main/java/org/smartregister/receiver/ValidateAssignmentReceiver.java", "diffHunk": "@@ -0,0 +1,83 @@\n+package org.smartregister.receiver;\n+\n+import android.content.BroadcastReceiver;\n+import android.content.Context;\n+import android.content.Intent;\n+import android.content.IntentFilter;\n+import android.os.Bundle;\n+\n+import org.smartregister.dto.UserAssignmentDTO;\n+import org.smartregister.sync.helper.ValidateAssignmentHelper;\n+\n+import java.io.Serializable;\n+import java.util.LinkedHashSet;\n+import java.util.Set;\n+\n+import timber.log.Timber;\n+\n+/**\n+ * Created by samuelgithengi on 9/21/20.\n+ */\n+public class ValidateAssignmentReceiver extends BroadcastReceiver {\n+\n+    private static ValidateAssignmentReceiver instance;\n+\n+    private Set<UserAssignmentListener> userAssignmentListeners;\n+\n+    public static void init(Context context) {\n+        if (instance != null) {\n+            destroy(context);\n+        }\n+        instance = new ValidateAssignmentReceiver();\n+        context.registerReceiver(instance,\n+                new IntentFilter(ValidateAssignmentHelper.ACTION_ASSIGNMENT_REMOVED));\n+    }\n+\n+    public static void destroy(Context context) {\n+        try {\n+            if (instance != null) {\n+                context.unregisterReceiver(instance);\n+                instance = null;\n+            }\n+        } catch (IllegalArgumentException e) {", "originalCommit": "4b89e5a05d1c79e4cbf83ac61163bc9ece2469e6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "748791288fdccdf851a5cda51889bd7868c186ee", "url": "https://github.com/opensrp/opensrp-client-core/commit/748791288fdccdf851a5cda51889bd7868c186ee", "message": "PR requested changes", "committedDate": "2020-09-25T08:42:25Z", "type": "commit"}, {"oid": "a076c612f65100419e85fb6237efac2bd93e4ee7", "url": "https://github.com/opensrp/opensrp-client-core/commit/a076c612f65100419e85fb6237efac2bd93e4ee7", "message": "clean up", "committedDate": "2020-09-25T08:53:39Z", "type": "commit"}, {"oid": "a076c612f65100419e85fb6237efac2bd93e4ee7", "url": "https://github.com/opensrp/opensrp-client-core/commit/a076c612f65100419e85fb6237efac2bd93e4ee7", "message": "clean up", "committedDate": "2020-09-25T08:53:39Z", "type": "forcePushed"}]}