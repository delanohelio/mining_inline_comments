{"pr_number": 688, "pr_title": "Encrypt Shared Preferences", "pr_createdAt": "2020-11-12T09:57:48Z", "pr_url": "https://github.com/opensrp/opensrp-client-core/pull/688", "timeline": [{"oid": "8e16d11f84c4c51b7edcdf29a8cbdf90c5475cc6", "url": "https://github.com/opensrp/opensrp-client-core/commit/8e16d11f84c4c51b7edcdf29a8cbdf90c5475cc6", "message": "Remove unused import", "committedDate": "2020-11-17T06:30:51Z", "type": "forcePushed"}, {"oid": "25f561b74f80d61322c133f66fe5d691543da307", "url": "https://github.com/opensrp/opensrp-client-core/commit/25f561b74f80d61322c133f66fe5d691543da307", "message": "Fix unit tests", "committedDate": "2020-11-18T10:24:28Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjA0MTI1Ng==", "url": "https://github.com/opensrp/opensrp-client-core/pull/688#discussion_r526041256", "bodyText": "What is the difference in these?In case this fails what is the fall back, stop app or use normal preferences?", "author": "githengi", "createdAt": "2020-11-18T12:15:43Z", "path": "opensrp-app/src/main/java/org/smartregister/Context.java", "diffHunk": "@@ -580,12 +591,46 @@ public AllSettings allSettings() {\n \n     public AllSharedPreferences allSharedPreferences() {\n         if (allSharedPreferences == null) {\n-            allSharedPreferences = new AllSharedPreferences(\n-                    getDefaultSharedPreferences(this.applicationContext));\n+            allSharedPreferences = new AllSharedPreferences(createSharedPreferences(this.applicationContext));\n         }\n         return allSharedPreferences;\n     }\n \n+    private SharedPreferences createSharedPreferences(android.content.Context context) {\n+        SyncConfiguration syncConfiguration = CoreLibrary.getInstance().getSyncConfiguration();\n+        \n+        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.M\n+                && syncConfiguration != null\n+                && syncConfiguration.encryptSharedPreferences()) {\n+\n+            return createEncryptedSharedPreferences(context);\n+        } else {\n+            return getDefaultSharedPreferences(context);\n+        }\n+    }\n+\n+    private SharedPreferences createEncryptedSharedPreferences(android.content.Context context) {\n+        SharedPreferences sharedPreferences = null;\n+\n+        try {\n+            String masterKeyAlias = MasterKeys.getOrCreate(MasterKeys.AES256_GCM_SPEC);\n+\n+            sharedPreferences = EncryptedSharedPreferences.create(\n+                    SHARED_PREFERENCES_FILENAME,\n+                    masterKeyAlias,\n+                    context,\n+                    EncryptedSharedPreferences.PrefKeyEncryptionScheme.AES256_SIV,\n+                    EncryptedSharedPreferences.PrefValueEncryptionScheme.AES256_GCM\n+            );\n+        } catch (GeneralSecurityException e) {\n+            Timber.e(e);\n+        } catch (IOException e) {\n+            Timber.e(e);\n+        }", "originalCommit": "25f561b74f80d61322c133f66fe5d691543da307", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjA3MTQxOQ==", "url": "https://github.com/opensrp/opensrp-client-core/pull/688#discussion_r526071419", "bodyText": "Updated to fall back to unencrypted SharedPreferences on error", "author": "qiarie", "createdAt": "2020-11-18T13:07:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjA0MTI1Ng=="}], "type": "inlineReview"}, {"oid": "02d2375a07e8754f007888de2b2d4091c8fff93f", "url": "https://github.com/opensrp/opensrp-client-core/commit/02d2375a07e8754f007888de2b2d4091c8fff93f", "message": "Fallback to unencrypted SharedPreferences on exception", "committedDate": "2020-11-18T13:06:13Z", "type": "forcePushed"}, {"oid": "7852ba9c841a0f4ff1e39356ee080c0483ddc303", "url": "https://github.com/opensrp/opensrp-client-core/commit/7852ba9c841a0f4ff1e39356ee080c0483ddc303", "message": "Override encryptSharedPreferences sync configuration in sample", "committedDate": "2020-11-19T10:05:28Z", "type": "forcePushed"}, {"oid": "592601f26ae4782dfc5c84bb8e7209e23697993b", "url": "https://github.com/opensrp/opensrp-client-core/commit/592601f26ae4782dfc5c84bb8e7209e23697993b", "message": "Rebase off master", "committedDate": "2020-11-26T10:38:23Z", "type": "forcePushed"}, {"oid": "dddca6c7bcdec691771775bb57acb09896bf4e3e", "url": "https://github.com/opensrp/opensrp-client-core/commit/dddca6c7bcdec691771775bb57acb09896bf4e3e", "message": "Rebase off master", "committedDate": "2020-12-07T12:08:07Z", "type": "forcePushed"}, {"oid": "5a139307a4b46c5a35085f25938fa0f07a2e1ca0", "url": "https://github.com/opensrp/opensrp-client-core/commit/5a139307a4b46c5a35085f25938fa0f07a2e1ca0", "message": "Rebase off master", "committedDate": "2020-12-07T12:55:52Z", "type": "forcePushed"}, {"oid": "21582429222fbb003b91336c50d407f91cb72c6b", "url": "https://github.com/opensrp/opensrp-client-core/commit/21582429222fbb003b91336c50d407f91cb72c6b", "message": "x", "committedDate": "2020-12-14T09:12:41Z", "type": "forcePushed"}, {"oid": "f396f29524ffb7673b136bd4b51c23d795a7ba4a", "url": "https://github.com/opensrp/opensrp-client-core/commit/f396f29524ffb7673b136bd4b51c23d795a7ba4a", "message": "Rebase off master", "committedDate": "2020-12-14T09:13:25Z", "type": "forcePushed"}, {"oid": "d558cdf37cb4371d4b16b572a9f23b1dab34115f", "url": "https://github.com/opensrp/opensrp-client-core/commit/d558cdf37cb4371d4b16b572a9f23b1dab34115f", "message": "Allow for shared prefs upgrade", "committedDate": "2021-01-14T07:51:26Z", "type": "forcePushed"}, {"oid": "6ff900c6d084581e99bc599516d7140ae398b3c4", "url": "https://github.com/opensrp/opensrp-client-core/commit/6ff900c6d084581e99bc599516d7140ae398b3c4", "message": "Bug fix", "committedDate": "2021-01-15T14:04:21Z", "type": "forcePushed"}, {"oid": "79076f42d6881c058edd12043aaec01f0ecbcf50", "url": "https://github.com/opensrp/opensrp-client-core/commit/79076f42d6881c058edd12043aaec01f0ecbcf50", "message": "Add encrypted shared prefs config to properties\n\n- Remove encrypted shared prefs from SyncConfiguration", "committedDate": "2021-02-02T05:52:05Z", "type": "forcePushed"}, {"oid": "3f8a56f2b2bab93edc3781b0ad01a0c505057b45", "url": "https://github.com/opensrp/opensrp-client-core/commit/3f8a56f2b2bab93edc3781b0ad01a0c505057b45", "message": "Fix unit tests", "committedDate": "2021-02-02T11:34:00Z", "type": "forcePushed"}, {"oid": "5b32135c75b1658010bdc7e9de645930b4b8a290", "url": "https://github.com/opensrp/opensrp-client-core/commit/5b32135c75b1658010bdc7e9de645930b4b8a290", "message": "Add androidx.security dependency\n\n- Update minimum SDK to 23\n- Update SharedPrefences dependency to androidx.preferences", "committedDate": "2021-02-09T06:35:44Z", "type": "commit"}, {"oid": "17a8960969f71c81a7abcd6b7e9e33f6a60657e5", "url": "https://github.com/opensrp/opensrp-client-core/commit/17a8960969f71c81a7abcd6b7e9e33f6a60657e5", "message": "Add encrypted SharedPreferences option", "committedDate": "2021-02-09T06:35:44Z", "type": "commit"}, {"oid": "f83a8d9abbde74af8e8c54d86d2de49435fea962", "url": "https://github.com/opensrp/opensrp-client-core/commit/f83a8d9abbde74af8e8c54d86d2de49435fea962", "message": "Add encryptSharedPreferences flag to SyncConfiguration", "committedDate": "2021-02-09T07:04:50Z", "type": "commit"}, {"oid": "74a75f7804b3e8bd6f8c48d123cb9f1b18784739", "url": "https://github.com/opensrp/opensrp-client-core/commit/74a75f7804b3e8bd6f8c48d123cb9f1b18784739", "message": "Update CryptographicHelperTest build version to M", "committedDate": "2021-02-09T07:04:50Z", "type": "commit"}, {"oid": "3ddd933f32951c0649332a84a7836d1d290513f6", "url": "https://github.com/opensrp/opensrp-client-core/commit/3ddd933f32951c0649332a84a7836d1d290513f6", "message": "Update dependency to androidx.preferences", "committedDate": "2021-02-09T07:04:50Z", "type": "commit"}, {"oid": "ab006d61574cde43ee5a21287547b255825772ed", "url": "https://github.com/opensrp/opensrp-client-core/commit/ab006d61574cde43ee5a21287547b255825772ed", "message": "Remove unused import", "committedDate": "2021-02-09T07:04:50Z", "type": "commit"}, {"oid": "816a68fd3c5b79cb786f15280b4b258b822d5c93", "url": "https://github.com/opensrp/opensrp-client-core/commit/816a68fd3c5b79cb786f15280b4b258b822d5c93", "message": "Restore minimum SDK version to 18\n\n- Override minimum SDK requirement for androidx.security", "committedDate": "2021-02-09T07:04:50Z", "type": "commit"}, {"oid": "a82769228532f0367db2d138f152b96d711e7459", "url": "https://github.com/opensrp/opensrp-client-core/commit/a82769228532f0367db2d138f152b96d711e7459", "message": "Update security-crypto library to 1.0.0-rc03", "committedDate": "2021-02-09T07:04:50Z", "type": "commit"}, {"oid": "d817703fb0240cf399881807b7f8518205e3c596", "url": "https://github.com/opensrp/opensrp-client-core/commit/d817703fb0240cf399881807b7f8518205e3c596", "message": "Use EncryptedSharedPreferences for Android M+ only", "committedDate": "2021-02-09T07:04:50Z", "type": "commit"}, {"oid": "b1ac0230f84bd419ce3d03829aa514c07e2dc63e", "url": "https://github.com/opensrp/opensrp-client-core/commit/b1ac0230f84bd419ce3d03829aa514c07e2dc63e", "message": "Replace userService getAllSharedPreferences with context allSharedPreferences", "committedDate": "2021-02-09T07:04:50Z", "type": "commit"}, {"oid": "3b66c395a1e0a2a2c57fe17eeea50abba8c18e0a", "url": "https://github.com/opensrp/opensrp-client-core/commit/3b66c395a1e0a2a2c57fe17eeea50abba8c18e0a", "message": "Revert CryptographicHelperTest tests to run on LOLLIPOP_MR1", "committedDate": "2021-02-09T07:04:50Z", "type": "commit"}, {"oid": "f75727dfa83ddc65a1f18f572b2c4fcf5f631125", "url": "https://github.com/opensrp/opensrp-client-core/commit/f75727dfa83ddc65a1f18f572b2c4fcf5f631125", "message": "Fix unit tests", "committedDate": "2021-02-09T07:04:50Z", "type": "commit"}, {"oid": "e60e80293ddcfdba87dd62ebce0b247f6df26e0c", "url": "https://github.com/opensrp/opensrp-client-core/commit/e60e80293ddcfdba87dd62ebce0b247f6df26e0c", "message": "Fallback to unencrypted SharedPreferences on exception", "committedDate": "2021-02-09T07:04:50Z", "type": "commit"}, {"oid": "8d58178456253242c44835fbb9a5b51301ef45c5", "url": "https://github.com/opensrp/opensrp-client-core/commit/8d58178456253242c44835fbb9a5b51301ef45c5", "message": "Add unit tests", "committedDate": "2021-02-09T07:04:50Z", "type": "commit"}, {"oid": "93632091a046132833138379c09cfd2f6e3a0810", "url": "https://github.com/opensrp/opensrp-client-core/commit/93632091a046132833138379c09cfd2f6e3a0810", "message": "Update unit tests", "committedDate": "2021-02-09T07:04:50Z", "type": "commit"}, {"oid": "3d66837c28df63148d171f54588afd2bf36cefa7", "url": "https://github.com/opensrp/opensrp-client-core/commit/3d66837c28df63148d171f54588afd2bf36cefa7", "message": "Fix broken unit tests", "committedDate": "2021-02-09T07:04:50Z", "type": "commit"}, {"oid": "3e4e1488ed89f45912450fd3d2ea0b30487e1d75", "url": "https://github.com/opensrp/opensrp-client-core/commit/3e4e1488ed89f45912450fd3d2ea0b30487e1d75", "message": "Override encryptSharedPreferences sync configuration in sample", "committedDate": "2021-02-09T07:04:50Z", "type": "commit"}, {"oid": "df9adc5b716957b791f064e732b77df66488b07a", "url": "https://github.com/opensrp/opensrp-client-core/commit/df9adc5b716957b791f064e732b77df66488b07a", "message": "Fix broken test", "committedDate": "2021-02-09T07:04:50Z", "type": "commit"}, {"oid": "a0ff04315032f03845c828b6c9fdf99f526b0801", "url": "https://github.com/opensrp/opensrp-client-core/commit/a0ff04315032f03845c828b6c9fdf99f526b0801", "message": "Rebase off master", "committedDate": "2021-02-09T07:04:50Z", "type": "commit"}, {"oid": "86cd0689107531cc128f318bed073bbb34b00bdd", "url": "https://github.com/opensrp/opensrp-client-core/commit/86cd0689107531cc128f318bed073bbb34b00bdd", "message": "Allow for shared prefs upgrade", "committedDate": "2021-02-09T07:04:50Z", "type": "commit"}, {"oid": "5eb8b59aae4e3a1c823a0407bcaa90b19866d731", "url": "https://github.com/opensrp/opensrp-client-core/commit/5eb8b59aae4e3a1c823a0407bcaa90b19866d731", "message": "Bug fix", "committedDate": "2021-02-09T07:04:50Z", "type": "commit"}, {"oid": "efe597b13804e9d50c7f495a9c07995be92bf77e", "url": "https://github.com/opensrp/opensrp-client-core/commit/efe597b13804e9d50c7f495a9c07995be92bf77e", "message": "Add encrypted shared prefs config to properties\n\n- Remove encrypted shared prefs from SyncConfiguration", "committedDate": "2021-02-09T07:05:18Z", "type": "commit"}, {"oid": "b93a52fe3276de6812152976402007e4baf0ccfb", "url": "https://github.com/opensrp/opensrp-client-core/commit/b93a52fe3276de6812152976402007e4baf0ccfb", "message": "Fix unit tests", "committedDate": "2021-02-09T07:05:18Z", "type": "commit"}, {"oid": "b93a52fe3276de6812152976402007e4baf0ccfb", "url": "https://github.com/opensrp/opensrp-client-core/commit/b93a52fe3276de6812152976402007e4baf0ccfb", "message": "Fix unit tests", "committedDate": "2021-02-09T07:05:18Z", "type": "forcePushed"}, {"oid": "a1e7d1e3e5dff4d235c31b8f1597c84f4d9f37f9", "url": "https://github.com/opensrp/opensrp-client-core/commit/a1e7d1e3e5dff4d235c31b8f1597c84f4d9f37f9", "message": "Bump up version", "committedDate": "2021-02-09T14:40:08Z", "type": "commit"}]}