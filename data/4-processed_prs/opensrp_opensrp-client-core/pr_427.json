{"pr_number": 427, "pr_title": "Add tests to clientprocessorforjava", "pr_createdAt": "2020-02-18T08:51:28Z", "pr_url": "https://github.com/opensrp/opensrp-client-core/pull/427", "timeline": [{"oid": "18f634d438035392031436ae68d8a7315cb0a484", "url": "https://github.com/opensrp/opensrp-client-core/commit/18f634d438035392031436ae68d8a7315cb0a484", "message": "added tests to org.smartregister.sync#getClientAttributes,#", "committedDate": "2020-02-18T08:34:03Z", "type": "commit"}, {"oid": "7756528db2e2b73088c1fcb8f68dcad8505724c7", "url": "https://github.com/opensrp/opensrp-client-core/commit/7756528db2e2b73088c1fcb8f68dcad8505724c7", "message": "added close case test", "committedDate": "2020-02-18T08:50:07Z", "type": "commit"}, {"oid": "82950a9eb5ffc46e2a3166fea9756f3c112c4c4e", "url": "https://github.com/opensrp/opensrp-client-core/commit/82950a9eb5ffc46e2a3166fea9756f3c112c4c4e", "message": "set instance to null after test", "committedDate": "2020-02-18T09:14:46Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDY2ODMzOA==", "url": "https://github.com/opensrp/opensrp-client-core/pull/427#discussion_r380668338", "bodyText": "Is this the only the exception that can occur", "author": "githengi", "createdAt": "2020-02-18T13:24:37Z", "path": "opensrp-app/src/main/java/org/smartregister/sync/ClientProcessorForJava.java", "diffHunk": "@@ -663,7 +658,7 @@ public void updateClientDetailsTable(Event event, Client client) {\n             if (StringUtils.isNotBlank(gender)) {\n                 map.put(GENDER, gender);\n             }\n-        } catch (Exception e) {\n+        } catch (NullPointerException e) {", "originalCommit": "82950a9eb5ffc46e2a3166fea9756f3c112c4c4e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDY4NjQ2Ng==", "url": "https://github.com/opensrp/opensrp-client-core/pull/427#discussion_r380686466", "bodyText": "yeah i think so", "author": "bennsimon", "createdAt": "2020-02-18T13:57:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDY2ODMzOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDY2ODM3NA==", "url": "https://github.com/opensrp/opensrp-client-core/pull/427#discussion_r380668374", "bodyText": "Is this the only the exception that can occur", "author": "githengi", "createdAt": "2020-02-18T13:24:42Z", "path": "opensrp-app/src/main/java/org/smartregister/sync/ClientProcessorForJava.java", "diffHunk": "@@ -648,7 +643,7 @@ public void updateClientDetailsTable(Event event, Client client) {\n                     attributes.put(key, value.toString());\n                 }\n             }\n-        } catch (Exception e) {\n+        } catch (NullPointerException e) {", "originalCommit": "82950a9eb5ffc46e2a3166fea9756f3c112c4c4e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDY4NjQwNw==", "url": "https://github.com/opensrp/opensrp-client-core/pull/427#discussion_r380686407", "bodyText": "yeah i think so", "author": "bennsimon", "createdAt": "2020-02-18T13:57:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDY2ODM3NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDY3MjQ4MA==", "url": "https://github.com/opensrp/opensrp-client-core/pull/427#discussion_r380672480", "bodyText": "why is this required, unit tests should normally end with asserts or expected failures", "author": "githengi", "createdAt": "2020-02-18T13:32:35Z", "path": "opensrp-app/src/test/java/org/smartregister/sync/ClientProcessorForJavaTest.java", "diffHunk": "@@ -92,4 +114,57 @@ public void testGetValuesStrShouldGetCorrectlyFormattedString() throws Exception\n         valStr = Whitebox.invokeMethod(clientProcessor, \"getValuesStr\", obs, values, null);\n         assertEquals(\"val1\", valStr);\n     }\n+\n+    @Test\n+    public void testGetClientAttributesShouldReturnRequiredValues() throws Exception {\n+        ClientProcessorForJava clientProcessor = new ClientProcessorForJava(context);\n+        Map<String, Object> attributes = new HashMap<>();\n+        attributes.put(\"national_id\", \"3434-34\");\n+        attributes.put(\"drivers-license\", \"DL-324\");\n+        Client client = new Client(\"123-23\");\n+        client.setAttributes(attributes);\n+        Map<String, Object> result = Whitebox.invokeMethod(clientProcessor, \"getClientAttributes\", client);\n+        assertEquals(attributes, result);\n+    }\n+\n+    @Test\n+    public void testGetGenderShouldReturnCorrectValue() throws Exception {\n+        ClientProcessorForJava clientProcessor = new ClientProcessorForJava(context);\n+        Client client = new Client(\"123-23\");\n+        client.setGender(\"Female\");\n+        Map<String, String> resultMap = Whitebox.invokeMethod(clientProcessor, \"getGender\", client);\n+        Map<String, String> expectedMap = new HashMap<>();\n+        expectedMap.put(\"gender\", \"Female\");\n+        assertEquals(expectedMap, resultMap);\n+    }\n+\n+    @Test\n+    public void testUpdateIdenitifierShouldRemoveHyphenFromOpenmrsId() throws Exception {\n+        ClientProcessorForJava clientProcessor = new ClientProcessorForJava(context);\n+        ContentValues contentValues = new ContentValues();\n+        contentValues.put(\"zeir_id\", \"23-23\");\n+        Whitebox.setInternalState(clientProcessor, \"openmrsGenIds\", new String[]{\"zeir_id\"});\n+        Whitebox.invokeMethod(clientProcessor, \"updateIdenitifier\", contentValues);\n+        assertEquals(\"2323\", contentValues.get(\"zeir_id\"));\n+    }\n+\n+    @Test\n+    public void testCloseCaseShouldReturnFalseIfCloseCaseIsEmpty() {\n+        ClientProcessorForJava clientProcessor = new ClientProcessorForJava(context);\n+        assertFalse(clientProcessor.closeCase(new Client(\"1233-2\"), new ArrayList<>()));\n+    }\n+\n+    @Test\n+    public void testCloseCaseShouldPassCorrectValuesToCloseCase() {\n+        ClientProcessorForJava clientProcessor = new ClientProcessorForJava(context);\n+        CommonRepository commonRepository = Mockito.mock(CommonRepository.class);\n+        ReflectionHelpers.setStaticField(CoreLibrary.class, \"instance\", coreLibrary);\n+        PowerMockito.when(coreLibrary.context()).thenReturn(opensrpContext);\n+        PowerMockito.when(opensrpContext.commonrepository(\"child\")).thenReturn(commonRepository);\n+        assertTrue(clientProcessor.closeCase(new Client(\"1233-2\"), Arrays.asList(\"child\")));\n+        Mockito.verify(commonRepository).closeCase(closeCaseArgumentCaptor.capture(), closeCaseArgumentCaptor.capture());\n+        assertEquals(\"1233-2\", closeCaseArgumentCaptor.getAllValues().get(0));\n+        assertEquals(\"child\", closeCaseArgumentCaptor.getAllValues().get(1));\n+        ReflectionHelpers.setStaticField(CoreLibrary.class, \"instance\", null);", "originalCommit": "82950a9eb5ffc46e2a3166fea9756f3c112c4c4e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDY4NzE2NQ==", "url": "https://github.com/opensrp/opensrp-client-core/pull/427#discussion_r380687165", "bodyText": "I do that since leaving the instance of CoreLibrary might affect how other tests behave within the class .The other way i can do is to add a teardown for this.", "author": "bennsimon", "createdAt": "2020-02-18T13:58:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDY3MjQ4MA=="}], "type": "inlineReview"}, {"oid": "c940ee22349d6bcc4b5255b61bb4f2592bf81d71", "url": "https://github.com/opensrp/opensrp-client-core/commit/c940ee22349d6bcc4b5255b61bb4f2592bf81d71", "message": "Merge branch 'master' into add-tests-to-clientprocessorforjava", "committedDate": "2020-02-18T14:03:23Z", "type": "commit"}, {"oid": "ba4040fffdbc57deda57fc568092218c65ef1bd3", "url": "https://github.com/opensrp/opensrp-client-core/commit/ba4040fffdbc57deda57fc568092218c65ef1bd3", "message": "Merge branch 'master' of github.com:OpenSRP/opensrp-client-core into add-tests-to-clientprocessorforjava", "committedDate": "2020-02-19T07:04:28Z", "type": "commit"}, {"oid": "e2f06e4e62e5b486ae1b125a27f79e82475b7bd8", "url": "https://github.com/opensrp/opensrp-client-core/commit/e2f06e4e62e5b486ae1b125a27f79e82475b7bd8", "message": "Merge branch 'master' into add-tests-to-clientprocessorforjava", "committedDate": "2020-02-19T07:25:19Z", "type": "commit"}]}