{"pr_number": 603, "pr_title": "Add SyncIntentService tests", "pr_createdAt": "2020-07-21T08:39:13Z", "pr_url": "https://github.com/opensrp/opensrp-client-core/pull/603", "timeline": [{"oid": "940d5e96f832222a6ab6d25742d714a7a3349ca7", "url": "https://github.com/opensrp/opensrp-client-core/commit/940d5e96f832222a6ab6d25742d714a7a3349ca7", "message": "Add SyncIntentService test", "committedDate": "2020-07-21T08:38:01Z", "type": "commit"}, {"oid": "9611aa1ccb9308c3406b7fdaba8ab9bc9cc79cb9", "url": "https://github.com/opensrp/opensrp-client-core/commit/9611aa1ccb9308c3406b7fdaba8ab9bc9cc79cb9", "message": "Add unit test", "committedDate": "2020-07-21T09:01:58Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDY4MTgwMA==", "url": "https://github.com/opensrp/opensrp-client-core/pull/603#discussion_r460681800", "bodyText": "This is interesting, fetch really shouldn't happen if this is false.\nSo not sure why this test passes.", "author": "vincent-karuri", "createdAt": "2020-07-27T06:54:57Z", "path": "opensrp-app/src/test/java/org/smartregister/sync/intent/SyncIntentServiceTest.java", "diffHunk": "@@ -0,0 +1,86 @@\n+package org.smartregister.sync.intent;\n+\n+import android.content.Context;\n+import android.content.Intent;\n+import android.content.pm.PackageManager;\n+\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.mockito.ArgumentCaptor;\n+import org.mockito.Captor;\n+import org.mockito.Mock;\n+import org.mockito.MockitoAnnotations;\n+import org.powermock.reflect.Whitebox;\n+import org.robolectric.RuntimeEnvironment;\n+import org.smartregister.BaseRobolectricUnitTest;\n+import org.smartregister.CoreLibrary;\n+import org.smartregister.SyncConfiguration;\n+import org.smartregister.domain.FetchStatus;\n+import org.smartregister.receiver.SyncStatusBroadcastReceiver;\n+import org.smartregister.util.SyncUtils;\n+\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertNotNull;\n+import static org.mockito.Mockito.spy;\n+import static org.mockito.Mockito.verify;\n+import static org.mockito.Mockito.when;\n+\n+/**\n+ * Created by Richard Kareko on 7/21/20.\n+ */\n+\n+public class SyncIntentServiceTest extends BaseRobolectricUnitTest {\n+\n+    @Mock\n+    private SyncUtils syncUtils;\n+\n+    @Mock\n+    SyncConfiguration syncConfiguration;\n+\n+    @Captor\n+    private ArgumentCaptor<Intent>  intentArgumentCaptor;\n+\n+    private Context context = RuntimeEnvironment.application;\n+\n+    private SyncIntentService syncIntentService;\n+\n+    @Before\n+    public void setUp() {\n+        Whitebox.setInternalState(CoreLibrary.getInstance(), \"syncConfiguration\", syncConfiguration);\n+        MockitoAnnotations.initMocks(this);\n+        syncIntentService = new SyncIntentService();\n+        syncIntentService.init(context);\n+        Whitebox.setInternalState(syncIntentService, \"mBase\", RuntimeEnvironment.application);\n+    }\n+\n+    @Test\n+    public void testInit() {\n+        assertNotNull(Whitebox.getInternalState(syncIntentService, \"httpAgent\"));\n+        assertNotNull(Whitebox.getInternalState(syncIntentService, \"syncUtils\"));\n+        assertNotNull(Whitebox.getInternalState(syncIntentService, \"context\"));\n+    }\n+\n+    @Test\n+    public void testHandleSyncSendFetchStartedBroadCast() throws PackageManager.NameNotFoundException {\n+        syncIntentService = spy(syncIntentService);\n+        Whitebox.setInternalState(syncIntentService, \"syncUtils\", syncUtils);\n+        when(syncUtils.verifyAuthorization()).thenReturn(true);\n+        when(syncUtils.isAppVersionAllowed()).thenReturn(false);", "originalCommit": "9611aa1ccb9308c3406b7fdaba8ab9bc9cc79cb9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTM0Njk4Mw==", "url": "https://github.com/opensrp/opensrp-client-core/pull/603#discussion_r461346983", "bodyText": "The check for isAppVersionAllowed id done later in the code after the broadcast has been sent as seen here", "author": "Rkareko", "createdAt": "2020-07-28T06:27:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDY4MTgwMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTM4MDEyNQ==", "url": "https://github.com/opensrp/opensrp-client-core/pull/603#discussion_r461380125", "bodyText": "I guess the point was that the message should not be broadcast until we are sure fetch is actually happening.\nWhich atm only happens here.", "author": "vincent-karuri", "createdAt": "2020-07-28T07:39:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDY4MTgwMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTM4MDc5NA==", "url": "https://github.com/opensrp/opensrp-client-core/pull/603#discussion_r461380794", "bodyText": "Fetch does not happen for the other if branches.", "author": "vincent-karuri", "createdAt": "2020-07-28T07:40:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDY4MTgwMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTM4OTAwMw==", "url": "https://github.com/opensrp/opensrp-client-core/pull/603#discussion_r461389003", "bodyText": "@ndegwamartin @githengi Would like to hear your thoughts on this. Should the broadcast message be moved from here to here", "author": "Rkareko", "createdAt": "2020-07-28T07:54:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDY4MTgwMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTQwODkwMQ==", "url": "https://github.com/opensrp/opensrp-client-core/pull/603#discussion_r461408901", "bodyText": "Hmm, maybe not unless you do some more refactoring. The sync process is comprised of two items, pushToServer and pullECFromServer. Push does not fall under the minAppVersionAllowed condition since it is triggered before then", "author": "ndegwamartin", "createdAt": "2020-07-28T08:29:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDY4MTgwMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTQxMjk1Nw==", "url": "https://github.com/opensrp/opensrp-client-core/pull/603#discussion_r461412957", "bodyText": "I think we should keep minAppVersionAllowed separate from pushToServer as currently is. Data on device should still be allowed to be uploaded even if app is older and deprecated.", "author": "githengi", "createdAt": "2020-07-28T08:35:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDY4MTgwMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTQyODg3Nw==", "url": "https://github.com/opensrp/opensrp-client-core/pull/603#discussion_r461428877", "bodyText": "The FetchStatus.fetchStarted is a bit of a misnomer since it signals the beginning of sync (both push and pull) though it should ideally apply to just pull (it's synonymous with fetch)?\nSo the question is whether to broadcast that only when an actual pull is happening, which doesn't happen for the first two branches.", "author": "vincent-karuri", "createdAt": "2020-07-28T09:01:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDY4MTgwMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTQ1MjQ5MA==", "url": "https://github.com/opensrp/opensrp-client-core/pull/603#discussion_r461452490", "bodyText": "I agree that FetchStatus.fetchStarted is a bit of a misnomer but it is used to signal that the sync process has started as such moving the broadcast to when the pull is happening would in essence mean that we are not considering the push to server bit as part of sync.", "author": "Rkareko", "createdAt": "2020-07-28T09:38:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDY4MTgwMA=="}], "type": "inlineReview"}, {"oid": "de2219632a90897bcd78451e0784fd5ceb6b65d8", "url": "https://github.com/opensrp/opensrp-client-core/commit/de2219632a90897bcd78451e0784fd5ceb6b65d8", "message": "Merge branch 'master' into rkareko-tt-22", "committedDate": "2020-07-27T07:06:34Z", "type": "commit"}, {"oid": "ea4b0248c015c70a4a4801d983e29ab6aab2406b", "url": "https://github.com/opensrp/opensrp-client-core/commit/ea4b0248c015c70a4a4801d983e29ab6aab2406b", "message": "Merge branch 'master' into rkareko-tt-22", "committedDate": "2020-07-28T05:27:37Z", "type": "commit"}, {"oid": "38ac97dcb15a5a64808023e35f8c901c1454e4be", "url": "https://github.com/opensrp/opensrp-client-core/commit/38ac97dcb15a5a64808023e35f8c901c1454e4be", "message": "Use explicit scoping for variable", "committedDate": "2020-07-28T05:36:11Z", "type": "commit"}, {"oid": "68a28bbe3375fd74433b24e19d8cf62e05b3035e", "url": "https://github.com/opensrp/opensrp-client-core/commit/68a28bbe3375fd74433b24e19d8cf62e05b3035e", "message": "Update isAppVersionAllowed to true for testHandleSyncSendFetchStartedBroadCast test", "committedDate": "2020-07-28T08:54:51Z", "type": "commit"}]}