{"pr_number": 652, "pr_title": "Support P2P sync by locations", "pr_createdAt": "2020-09-22T16:07:44Z", "pr_url": "https://github.com/opensrp/opensrp-client-core/pull/652", "timeline": [{"oid": "9d85d060cb4dd5b15898fbc9e0974668ff826f11", "url": "https://github.com/opensrp/opensrp-client-core/commit/9d85d060cb4dd5b15898fbc9e0974668ff826f11", "message": "Allow sync by location Ids for clients", "committedDate": "2020-09-22T14:41:47Z", "type": "commit"}, {"oid": "b63d2c4da49d6a78c49f37043f37728a8bde65f7", "url": "https://github.com/opensrp/opensrp-client-core/commit/b63d2c4da49d6a78c49f37043f37728a8bde65f7", "message": "If location filters are provided sync data by locationIds", "committedDate": "2020-09-22T16:02:09Z", "type": "commit"}, {"oid": "80f73d0cbf2bf13404b18d00b5b58bc0ce731ce0", "url": "https://github.com/opensrp/opensrp-client-core/commit/80f73d0cbf2bf13404b18d00b5b58bc0ce731ce0", "message": "Support lookup by location Id for events and clients", "committedDate": "2020-09-22T16:22:23Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mjg3NzMyNA==", "url": "https://github.com/opensrp/opensrp-client-core/pull/652#discussion_r492877324", "bodyText": "We can also depend on the presence of the location filter here to decide if we should extract the locationId", "author": "ekigamba", "createdAt": "2020-09-22T16:33:42Z", "path": "opensrp-app/src/main/java/org/smartregister/repository/P2PSenderTransferDao.java", "diffHunk": "@@ -28,37 +30,51 @@\n     @Nullable\n     @Override\n     public TreeSet<DataType> getDataTypes() {\n-        return (TreeSet<DataType>) dataTypes.clone();\n+        TreeSet<DataType> dataTypeTreeSet = new TreeSet<>();\n+        int start = dataTypes.size() + 1;\n+        P2POptions p2POptions = CoreLibrary.getInstance().getP2POptions();\n+        if (p2POptions != null && !ArrayUtils.isEmpty(p2POptions.getLocationsFilter())) {\n+            for (String location : p2POptions.getLocationsFilter()) {\n+                for (DataType dataType : dataTypes) {\n+                    dataTypeTreeSet.add(new DataType(dataType.getName() + \":\" + location, dataType.getType(), start + dataTypeTreeSet.size()));\n+                }\n+            }\n+        }\n+        TreeSet<DataType> dataTypesClone = new TreeSet<>(dataTypes);\n+        dataTypesClone.addAll(dataTypeTreeSet);\n+        return dataTypesClone;\n     }\n \n     @Nullable\n     @Override\n     public JsonData getJsonData(@NonNull DataType dataType, long lastRecordId, int batchSize) {\n-        if (dataType.getName().equals(event.getName())) {\n+        String[] dataTypeParams = dataType.getName().split(\":\");", "originalCommit": "80f73d0cbf2bf13404b18d00b5b58bc0ce731ce0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "3d42027713c6fd901a07102bced57d2b908bd598", "url": "https://github.com/opensrp/opensrp-client-core/commit/3d42027713c6fd901a07102bced57d2b908bd598", "message": " build dynamic data types only when location filter is defined, otherwise use default data types", "committedDate": "2020-09-22T16:39:23Z", "type": "commit"}, {"oid": "cd923c8aaff47a4c71798078af13ca29c33144be", "url": "https://github.com/opensrp/opensrp-client-core/commit/cd923c8aaff47a4c71798078af13ca29c33144be", "message": "extract locationId only if location filter is enabled", "committedDate": "2020-09-22T16:47:24Z", "type": "commit"}, {"oid": "1eabe1ebed4bae54427d8ff6e480b7e978dc18a3", "url": "https://github.com/opensrp/opensrp-client-core/commit/1eabe1ebed4bae54427d8ff6e480b7e978dc18a3", "message": "Cleanup", "committedDate": "2020-09-22T16:59:01Z", "type": "commit"}, {"oid": "4a2a0f33334f81f5d43e655b39ff712c82ff96b2", "url": "https://github.com/opensrp/opensrp-client-core/commit/4a2a0f33334f81f5d43e655b39ff712c82ff96b2", "message": "Implement location filter for structure and task p2p sync", "committedDate": "2020-09-23T06:55:14Z", "type": "commit"}, {"oid": "1d8287ec7c962c4334e2d511088804c9884ff155", "url": "https://github.com/opensrp/opensrp-client-core/commit/1d8287ec7c962c4334e2d511088804c9884ff155", "message": "pass p2p options in core library", "committedDate": "2020-09-23T07:19:47Z", "type": "commit"}, {"oid": "2f9ae5e4ec9e8fc0a62dfef08491897d3a425438", "url": "https://github.com/opensrp/opensrp-client-core/commit/2f9ae5e4ec9e8fc0a62dfef08491897d3a425438", "message": "Code cleanup", "committedDate": "2020-09-23T07:21:15Z", "type": "commit"}, {"oid": "09f2352fb929a580d5eef914feb7f4c760302ce9", "url": "https://github.com/opensrp/opensrp-client-core/commit/09f2352fb929a580d5eef914feb7f4c760302ce9", "message": "location Id on event table", "committedDate": "2020-09-23T07:36:09Z", "type": "commit"}, {"oid": "4f12fdda2fa4761329ccba6540817676a9f7af0d", "url": "https://github.com/opensrp/opensrp-client-core/commit/4f12fdda2fa4761329ccba6540817676a9f7af0d", "message": "Populate locationId on event table", "committedDate": "2020-09-23T08:00:49Z", "type": "commit"}, {"oid": "6cb79df451237be78a7d278c8caaf7379a1c2a4a", "url": "https://github.com/opensrp/opensrp-client-core/commit/6cb79df451237be78a7d278c8caaf7379a1c2a4a", "message": "Bump up version", "committedDate": "2020-09-23T08:16:37Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzI4OTE1Ng==", "url": "https://github.com/opensrp/opensrp-client-core/pull/652#discussion_r493289156", "bodyText": "Let's disable this. I just looked at the workflow and we'll have to call\nCoreLibrary.getInstance().getP2POptions().setLocationsFilter(locationsFilter) everytime before starting the P2P activity. The instance of this class is created at the start of the application at which point we don't know the specific filters", "author": "ekigamba", "createdAt": "2020-09-23T08:09:49Z", "path": "opensrp-app/src/main/java/org/smartregister/repository/P2PSenderTransferDao.java", "diffHunk": "@@ -25,40 +27,73 @@\n \n public class P2PSenderTransferDao extends BaseP2PTransferDao implements SenderTransferDao {\n \n+    private static final String SEPARATOR = \"-\";\n+\n+    private P2POptions p2POptions;\n+\n+    public P2PSenderTransferDao() {\n+        this(null);\n+    }\n+\n+    public P2PSenderTransferDao(P2POptions p2POptions) {", "originalCommit": "09f2352fb929a580d5eef914feb7f4c760302ce9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzQ3OTUyMA==", "url": "https://github.com/opensrp/opensrp-client-core/pull/652#discussion_r493479520", "bodyText": "Removed", "author": "githengi", "createdAt": "2020-09-23T11:32:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzI4OTE1Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzI5NjY5Ng==", "url": "https://github.com/opensrp/opensrp-client-core/pull/652#discussion_r493296696", "bodyText": "Set the DataType#position in the third param as the loop position. This is used to order the datatypes so that the syncing is done in the correct order.\nI think you should also change the loops i.e the dataType loop should be the outer loop so that the order is\n\nclient-{locationId1}\nclient-{locationId2}\nclient-{locationId3}\nevent-{locationId1}\nevent-{locationId2} ...", "author": "ekigamba", "createdAt": "2020-09-23T08:17:22Z", "path": "opensrp-app/src/main/java/org/smartregister/repository/P2PSenderTransferDao.java", "diffHunk": "@@ -25,40 +27,73 @@\n \n public class P2PSenderTransferDao extends BaseP2PTransferDao implements SenderTransferDao {\n \n+    private static final String SEPARATOR = \"-\";\n+\n+    private P2POptions p2POptions;\n+\n+    public P2PSenderTransferDao() {\n+        this(null);\n+    }\n+\n+    public P2PSenderTransferDao(P2POptions p2POptions) {\n+        super();\n+        this.p2POptions = p2POptions;\n+    }\n+\n     @Nullable\n     @Override\n     public TreeSet<DataType> getDataTypes() {\n-        return (TreeSet<DataType>) dataTypes.clone();\n+        TreeSet<DataType> dataTypeTreeSet = new TreeSet<>();\n+\n+        if (locationFilterEnabled()) {\n+            for (String location : p2POptions.getLocationsFilter()) {\n+                for (DataType dataType : dataTypes) {\n+                    dataTypeTreeSet.add(new DataType(dataType.getName() + SEPARATOR + location, dataType.getType(), dataTypeTreeSet.size()));", "originalCommit": "09f2352fb929a580d5eef914feb7f4c760302ce9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzM3MjgwNQ==", "url": "https://github.com/opensrp/opensrp-client-core/pull/652#discussion_r493372805", "bodyText": "Not sure wanted for it order sync data per locations, so that if the user checks a particular location chances are that data is synced or its not. Ordering the data type maybe confusing when user opens an location with some data synced while others is not synched", "author": "githengi", "createdAt": "2020-09-23T09:34:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzI5NjY5Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzMxOTM0NQ==", "url": "https://github.com/opensrp/opensrp-client-core/pull/652#discussion_r493319345", "bodyText": "Use event_column.locationId on this line and next line", "author": "ekigamba", "createdAt": "2020-09-23T08:40:45Z", "path": "opensrp-app/src/main/java/org/smartregister/repository/EventClientRepository.java", "diffHunk": "@@ -146,6 +146,17 @@ public static void createAdditionalColumns(SQLiteDatabase db) {\n         createAdditionalColumns(db, Table.event.name(), Table.client.name());\n     }\n \n+    /**\n+     * add locationId  column on event table\n+     *\n+     * @param db the database being upgraded\n+     */\n+    public static void addEventLocationId(SQLiteDatabase db) {\n+        DatabaseMigrationUtils.addColumnIfNotExists(db, Table.event.name(), client_column.locationId.name(), VARCHAR);", "originalCommit": "09f2352fb929a580d5eef914feb7f4c760302ce9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzMyNTE0NQ==", "url": "https://github.com/opensrp/opensrp-client-core/pull/652#discussion_r493325145", "bodyText": "This works perfect except for situations where the event does not have a locationId. I don't know if that is possible on Reveal currently", "author": "ekigamba", "createdAt": "2020-09-23T08:46:37Z", "path": "opensrp-app/src/main/java/org/smartregister/repository/EventClientRepository.java", "diffHunk": "@@ -154,7 +154,7 @@ public static void createAdditionalColumns(SQLiteDatabase db) {\n     public static void addEventLocationId(SQLiteDatabase db) {\n         DatabaseMigrationUtils.addColumnIfNotExists(db, Table.event.name(), client_column.locationId.name(), VARCHAR);\n         DatabaseMigrationUtils.addIndexIfNotExists(db, Table.event.name(), client_column.locationId.name());\n-\n+        db.execSQL(String.format(\"UPDATE %s set %s = %s\", Table.event.name(), event_column.locationId.name(), \"substr(json,instr(json, '\\\"locationId\\\":')+14,36)\"));", "originalCommit": "4f12fdda2fa4761329ccba6540817676a9f7af0d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzQ3OTc4NQ==", "url": "https://github.com/opensrp/opensrp-client-core/pull/652#discussion_r493479785", "bodyText": "Added a filter for only events with locationId", "author": "githengi", "createdAt": "2020-09-23T11:32:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzMyNTE0NQ=="}], "type": "inlineReview"}, {"oid": "54896796dc388959f89b961b2afc97bed6b8010f", "url": "https://github.com/opensrp/opensrp-client-core/commit/54896796dc388959f89b961b2afc97bed6b8010f", "message": "only populate locationId if its found on event", "committedDate": "2020-09-23T09:30:44Z", "type": "commit"}, {"oid": "f0619b1fae5a6edb893cb6db34ec28e0ec04608b", "url": "https://github.com/opensrp/opensrp-client-core/commit/f0619b1fae5a6edb893cb6db34ec28e0ec04608b", "message": "PR review requested changes", "committedDate": "2020-09-23T10:36:32Z", "type": "commit"}, {"oid": "f0619b1fae5a6edb893cb6db34ec28e0ec04608b", "url": "https://github.com/opensrp/opensrp-client-core/commit/f0619b1fae5a6edb893cb6db34ec28e0ec04608b", "message": "PR review requested changes", "committedDate": "2020-09-23T10:36:32Z", "type": "forcePushed"}, {"oid": "3838bee7b5eadee288ae6ae8439e85825168f7d7", "url": "https://github.com/opensrp/opensrp-client-core/commit/3838bee7b5eadee288ae6ae8439e85825168f7d7", "message": "populate location id when saving events", "committedDate": "2020-09-23T12:01:36Z", "type": "commit"}, {"oid": "20b03361968280b83413b41c28cce19299c702a0", "url": "https://github.com/opensrp/opensrp-client-core/commit/20b03361968280b83413b41c28cce19299c702a0", "message": "Optimize imports", "committedDate": "2020-09-23T12:12:26Z", "type": "commit"}]}