{"pr_number": 447, "pr_title": "Support min allowed app version", "pr_createdAt": "2020-03-06T12:53:24Z", "pr_url": "https://github.com/opensrp/opensrp-client-core/pull/447", "timeline": [{"oid": "122980ac96126ffadb626d8fcee5f2b2e8fd229b", "url": "https://github.com/opensrp/opensrp-client-core/commit/122980ac96126ffadb626d8fcee5f2b2e8fd229b", "message": "Run ec-sync after syncing server settings", "committedDate": "2020-03-04T14:24:22Z", "type": "commit"}, {"oid": "76fc4e4824f5527a514a0b8f6e3946fb9f3d5b81", "url": "https://github.com/opensrp/opensrp-client-core/commit/76fc4e4824f5527a514a0b8f6e3946fb9f3d5b81", "message": "Extract min app version setting and logout user if using outdated app", "committedDate": "2020-03-04T15:05:03Z", "type": "commit"}, {"oid": "dd2f058bb43e05747e8879e9178b06e3d5b68263", "url": "https://github.com/opensrp/opensrp-client-core/commit/dd2f058bb43e05747e8879e9178b06e3d5b68263", "message": "Extract min allowed app version and perform minor refactor", "committedDate": "2020-03-05T14:47:38Z", "type": "commit"}, {"oid": "ecf6a6e94e1b21f7052ff8f53ee8fac9496c5c56", "url": "https://github.com/opensrp/opensrp-client-core/commit/ecf6a6e94e1b21f7052ff8f53ee8fac9496c5c56", "message": "Record that an app is outdated before logging out", "committedDate": "2020-03-05T15:03:16Z", "type": "commit"}, {"oid": "9c4efa35022c1c492f69dc1f432b7aa4eb681671", "url": "https://github.com/opensrp/opensrp-client-core/commit/9c4efa35022c1c492f69dc1f432b7aa4eb681671", "message": "Extract min allowed version value after determining key name matches", "committedDate": "2020-03-05T15:15:34Z", "type": "commit"}, {"oid": "7a95decaa369d423fe1f3dbcc3ee11049d1af7bc", "url": "https://github.com/opensrp/opensrp-client-core/commit/7a95decaa369d423fe1f3dbcc3ee11049d1af7bc", "message": "Prevent login if the app is outdated", "committedDate": "2020-03-06T09:13:08Z", "type": "commit"}, {"oid": "19808f76c1991977e602932251125ed7f7845cb2", "url": "https://github.com/opensrp/opensrp-client-core/commit/19808f76c1991977e602932251125ed7f7845cb2", "message": "Move app version validation to utils class and add appropriate method on forced logout", "committedDate": "2020-03-06T11:46:38Z", "type": "commit"}, {"oid": "85e24977db9998888d49e870f166a99f5cf229d7", "url": "https://github.com/opensrp/opensrp-client-core/commit/85e24977db9998888d49e870f166a99f5cf229d7", "message": "Minor code refactor and add error messages for forced logout", "committedDate": "2020-03-06T11:56:02Z", "type": "commit"}, {"oid": "e8330625a936c90f5d2c240907d1571b7f89a637", "url": "https://github.com/opensrp/opensrp-client-core/commit/e8330625a936c90f5d2c240907d1571b7f89a637", "message": "Fix boolean logic bug", "committedDate": "2020-03-06T12:18:40Z", "type": "commit"}, {"oid": "22547ee6a43adf8ce457e2cfadc16e512c6a26e4", "url": "https://github.com/opensrp/opensrp-client-core/commit/22547ee6a43adf8ce457e2cfadc16e512c6a26e4", "message": "Extract app version code instead of library version code", "committedDate": "2020-03-06T12:44:03Z", "type": "commit"}, {"oid": "c94ec1e1286e7861f1df8939b8d0b07473eb0c0c", "url": "https://github.com/opensrp/opensrp-client-core/commit/c94ec1e1286e7861f1df8939b8d0b07473eb0c0c", "message": "Allow all apps to sync by default and perform code clean-up", "committedDate": "2020-03-09T12:13:44Z", "type": "commit"}, {"oid": "d0753b7fe990742dced3dd59f1f85403f66ec261", "url": "https://github.com/opensrp/opensrp-client-core/commit/d0753b7fe990742dced3dd59f1f85403f66ec261", "message": "Add BaseLoginPresenter tests", "committedDate": "2020-03-10T08:17:11Z", "type": "commit"}, {"oid": "0ef30f3c99ce6d6d2e8ec2f38e433c14eeac974e", "url": "https://github.com/opensrp/opensrp-client-core/commit/0ef30f3c99ce6d6d2e8ec2f38e433c14eeac974e", "message": "Add AllSettings test", "committedDate": "2020-03-10T08:32:53Z", "type": "commit"}, {"oid": "b0743c1453573c5219e0453758a17ee949190ba0", "url": "https://github.com/opensrp/opensrp-client-core/commit/b0743c1453573c5219e0453758a17ee949190ba0", "message": "Perform minor refactor and add Utils tests", "committedDate": "2020-03-10T09:55:25Z", "type": "commit"}, {"oid": "f1ab629ef06ca88137eead14e154e405a3c47e1d", "url": "https://github.com/opensrp/opensrp-client-core/commit/f1ab629ef06ca88137eead14e154e405a3c47e1d", "message": "Add SyncUtils tests", "committedDate": "2020-03-10T13:27:08Z", "type": "commit"}, {"oid": "ab0267952e49b62f51a1463e87aea1c5a167a2f2", "url": "https://github.com/opensrp/opensrp-client-core/commit/ab0267952e49b62f51a1463e87aea1c5a167a2f2", "message": "Merge branch 'master' into 445-support-min-allowed-app-version", "committedDate": "2020-03-23T13:42:54Z", "type": "commit"}, {"oid": "7f903b2b17ee132e371ed6d7ec9a90f380c0b806", "url": "https://github.com/opensrp/opensrp-client-core/commit/7f903b2b17ee132e371ed6d7ec9a90f380c0b806", "message": "Merge branch 'master' into 445-support-min-allowed-app-version", "committedDate": "2020-03-24T11:31:29Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzA5MDAwNQ==", "url": "https://github.com/opensrp/opensrp-client-core/pull/447#discussion_r397090005", "bodyText": "This should be after if(!hasValidAuthorization) as its more efficient as hasValidAuthorization is already known.\nIS_APP_VERSION_ALLOWED will always be false even after an APK has been upgraded if it was false as it will not be set to true again why not save the minimum version itself and just check against that instead of boolean", "author": "githengi", "createdAt": "2020-03-24T11:43:42Z", "path": "opensrp-app/src/main/java/org/smartregister/sync/intent/SyncIntentService.java", "diffHunk": "@@ -79,12 +82,16 @@ private void doSync() {\n             if (hasValidAuthorization || !CoreLibrary.getInstance().getSyncConfiguration().disableSyncToServerIfUserIsDisabled()) {\n                 pushToServer();\n             }\n-            if (hasValidAuthorization) {\n-                pullECFromServer();\n-            } else {\n+\n+            if (!syncUtils.isAppVersionAllowed()) {\n+                AllSettings settingsRepository = org.smartregister.Context.getInstance().allSettings();\n+                settingsRepository.put(IS_APP_VERSION_ALLOWED, \"false\");", "originalCommit": "7f903b2b17ee132e371ed6d7ec9a90f380c0b806", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzgxOTc0Mw==", "url": "https://github.com/opensrp/opensrp-client-core/pull/447#discussion_r397819743", "bodyText": "Fixed the first concern.\nI'm not sure I understand the second concern. An upgrade can only be done by uninstalling the current app or by clearing data on the phone and upgrading with a new apk. So the IS_APP_VERSION_ALLOWED will definitely be recomputed.\nOnce a user is logged out, they cannot log back in until they upgrade the app by following one of the two options above.", "author": "vincent-karuri", "createdAt": "2020-03-25T12:36:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzA5MDAwNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Nzg0MzQyMA==", "url": "https://github.com/opensrp/opensrp-client-core/pull/447#discussion_r397843420", "bodyText": "Its possible to upgrade without uninstall of the current app and this is the upgrade recommended for the OpenSRP.\nThe concert is valid when the APK is upgraded", "author": "githengi", "createdAt": "2020-03-25T13:15:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzA5MDAwNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzkzOTcxMQ==", "url": "https://github.com/opensrp/opensrp-client-core/pull/447#discussion_r397939711", "bodyText": "Fixed.", "author": "vincent-karuri", "createdAt": "2020-03-25T15:20:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzA5MDAwNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzA5MTk0Mg==", "url": "https://github.com/opensrp/opensrp-client-core/pull/447#discussion_r397091942", "bodyText": "maybe break from loop here", "author": "githengi", "createdAt": "2020-03-24T11:47:28Z", "path": "opensrp-app/src/main/java/org/smartregister/util/SyncUtils.java", "diffHunk": "@@ -84,4 +96,39 @@ public void logoutUser() {\n         opensrpContent.userService().logoutSession();\n     }\n \n+    public boolean isAppVersionAllowed() throws PackageManager.NameNotFoundException {\n+        boolean isAppVersionAllowed = true;\n+\n+        AllSettings settingsRepository = opensrpContent.allSettings();\n+        Setting minAllowedAppVersionSetting = settingsRepository.getSetting(MIN_ALLOWED_APP_VERSION);\n+        if (minAllowedAppVersionSetting == null) {\n+            return isAppVersionAllowed;\n+        }\n+\n+        int minAllowedAppVersion = extractMinAllowedAppVersion(minAllowedAppVersionSetting.getValue());\n+        if (getVersionCode(context) < minAllowedAppVersion) {\n+            isAppVersionAllowed = false;\n+        }\n+\n+        return isAppVersionAllowed;\n+    }\n+\n+    private int extractMinAllowedAppVersion(String setting) {\n+        int minAllowedAppVersion = 0;\n+        try {\n+            JSONArray settings = new JSONObject(setting).optJSONArray(SETTINGS);\n+            for (int i = 0; i < settings.length(); i++) {\n+                JSONObject currSettingObj = settings.optJSONObject(i);\n+                String currKey = currSettingObj.optString(KEY);\n+                if (MIN_ALLOWED_APP_VERSION.equals(currKey)) {\n+                    minAllowedAppVersion = currSettingObj.optInt(VALUE, minAllowedAppVersion);", "originalCommit": "7f903b2b17ee132e371ed6d7ec9a90f380c0b806", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzgxMzYyOQ==", "url": "https://github.com/opensrp/opensrp-client-core/pull/447#discussion_r397813629", "bodyText": "Done.", "author": "vincent-karuri", "createdAt": "2020-03-25T12:24:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzA5MTk0Mg=="}], "type": "inlineReview"}, {"oid": "4196bf387244233e57bec98e72b07fb4b4f97e74", "url": "https://github.com/opensrp/opensrp-client-core/commit/4196bf387244233e57bec98e72b07fb4b4f97e74", "message": "Merge remote-tracking branch 'origin/master' into 445-support-min-allowed-app-version", "committedDate": "2020-03-25T12:24:04Z", "type": "commit"}, {"oid": "fb0075e33ab4f7c88b31cda22c3fa3d976f5bbc4", "url": "https://github.com/opensrp/opensrp-client-core/commit/fb0075e33ab4f7c88b31cda22c3fa3d976f5bbc4", "message": "Perform minor optimizations", "committedDate": "2020-03-25T12:39:05Z", "type": "commit"}, {"oid": "c186e83d116539a6a8af37fb3962880ccfc1017f", "url": "https://github.com/opensrp/opensrp-client-core/commit/c186e83d116539a6a8af37fb3962880ccfc1017f", "message": "Save min allowed app version instead of authorization status", "committedDate": "2020-03-25T14:00:37Z", "type": "commit"}, {"oid": "e30fdbf2cf1195f0ab5058180bceb688d94d8c7b", "url": "https://github.com/opensrp/opensrp-client-core/commit/e30fdbf2cf1195f0ab5058180bceb688d94d8c7b", "message": "Refactor all app version validation into sync utils and fix failing tests", "committedDate": "2020-03-25T15:19:38Z", "type": "commit"}, {"oid": "e30fdbf2cf1195f0ab5058180bceb688d94d8c7b", "url": "https://github.com/opensrp/opensrp-client-core/commit/e30fdbf2cf1195f0ab5058180bceb688d94d8c7b", "message": "Refactor all app version validation into sync utils and fix failing tests", "committedDate": "2020-03-25T15:19:38Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Nzk0NzAwMg==", "url": "https://github.com/opensrp/opensrp-client-core/pull/447#discussion_r397947002", "bodyText": "This is no longer used", "author": "githengi", "createdAt": "2020-03-25T15:29:47Z", "path": "opensrp-app/src/main/java/org/smartregister/AllConstants.java", "diffHunk": "@@ -450,4 +450,15 @@\n \n     }\n \n+    public interface FORCED_LOGOUT {\n+        String MIN_ALLOWED_APP_VERSION_SETTING = \"min_allowed_app_version_setting\";\n+        String MIN_ALLOWED_APP_VERSION = \"min_allowed_app_version\";\n+        String IS_APP_VERSION_ALLOWED = \"is_app_version_allowed\";", "originalCommit": "e30fdbf2cf1195f0ab5058180bceb688d94d8c7b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODQzODgzNg==", "url": "https://github.com/opensrp/opensrp-client-core/pull/447#discussion_r398438836", "bodyText": "Removed.", "author": "vincent-karuri", "createdAt": "2020-03-26T09:46:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Nzk0NzAwMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Nzk0NzkxNg==", "url": "https://github.com/opensrp/opensrp-client-core/pull/447#discussion_r397947916", "bodyText": "import not used", "author": "githengi", "createdAt": "2020-03-25T15:30:53Z", "path": "opensrp-app/src/main/java/org/smartregister/sync/intent/SyncIntentService.java", "diffHunk": "@@ -31,6 +32,8 @@\n \n import timber.log.Timber;\n \n+import static org.smartregister.AllConstants.FORCED_LOGOUT.IS_APP_VERSION_ALLOWED;", "originalCommit": "e30fdbf2cf1195f0ab5058180bceb688d94d8c7b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODQzODkwOA==", "url": "https://github.com/opensrp/opensrp-client-core/pull/447#discussion_r398438908", "bodyText": "Removed.", "author": "vincent-karuri", "createdAt": "2020-03-26T09:46:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Nzk0NzkxNg=="}], "type": "inlineReview"}, {"oid": "a3350d3af5451f94c3c25d6052d3e7110849e505", "url": "https://github.com/opensrp/opensrp-client-core/commit/a3350d3af5451f94c3c25d6052d3e7110849e505", "message": "Code clean-up", "committedDate": "2020-03-26T06:31:22Z", "type": "commit"}, {"oid": "cdc735f01d6ea929d2e8e31033cf475ea2f0ae76", "url": "https://github.com/opensrp/opensrp-client-core/commit/cdc735f01d6ea929d2e8e31033cf475ea2f0ae76", "message": "Merge remote-tracking branch 'origin/master' into 445-support-min-allowed-app-version", "committedDate": "2020-03-26T06:34:31Z", "type": "commit"}, {"oid": "70d5c860e0b6d525c0d1d69c31220cc601072cd2", "url": "https://github.com/opensrp/opensrp-client-core/commit/70d5c860e0b6d525c0d1d69c31220cc601072cd2", "message": "Bump lib version", "committedDate": "2020-03-26T06:35:06Z", "type": "commit"}, {"oid": "07a118d688ac6fd5f99d7750604358bf6d22e05d", "url": "https://github.com/opensrp/opensrp-client-core/commit/07a118d688ac6fd5f99d7750604358bf6d22e05d", "message": "Fix integer to long casting error", "committedDate": "2020-03-26T07:47:05Z", "type": "commit"}, {"oid": "4cf5e0f811f8de94ee0f2df05ff3d8727a7b671c", "url": "https://github.com/opensrp/opensrp-client-core/commit/4cf5e0f811f8de94ee0f2df05ff3d8727a7b671c", "message": "Re-process min allowed version setting if it was recently updated during sync", "committedDate": "2020-03-26T08:57:42Z", "type": "commit"}, {"oid": "21a395a1887f17cbc8b09d99815aff9ab5f1fa5b", "url": "https://github.com/opensrp/opensrp-client-core/commit/21a395a1887f17cbc8b09d99815aff9ab5f1fa5b", "message": "Derive server version from server setting", "committedDate": "2020-03-26T09:26:14Z", "type": "commit"}, {"oid": "ccc9629b47582a83f298ffaf6fba5bdf51b32490", "url": "https://github.com/opensrp/opensrp-client-core/commit/ccc9629b47582a83f298ffaf6fba5bdf51b32490", "message": "Run default sync only if settings were successfully synced", "committedDate": "2020-03-26T12:29:39Z", "type": "commit"}, {"oid": "625dcecc157a2335b7cd5feeb387fff34f811eb9", "url": "https://github.com/opensrp/opensrp-client-core/commit/625dcecc157a2335b7cd5feeb387fff34f811eb9", "message": "Only logout outdated app if it has successfully pushed its data to the server", "committedDate": "2020-03-26T12:49:28Z", "type": "commit"}, {"oid": "625dcecc157a2335b7cd5feeb387fff34f811eb9", "url": "https://github.com/opensrp/opensrp-client-core/commit/625dcecc157a2335b7cd5feeb387fff34f811eb9", "message": "Only logout outdated app if it has successfully pushed its data to the server", "committedDate": "2020-03-26T12:49:28Z", "type": "forcePushed"}, {"oid": "c869e87e7eef461b6ed1ba3a1ea317799cc5b7f4", "url": "https://github.com/opensrp/opensrp-client-core/commit/c869e87e7eef461b6ed1ba3a1ea317799cc5b7f4", "message": "Don't pull data from the server as long as the app is outdated", "committedDate": "2020-03-26T13:35:51Z", "type": "commit"}, {"oid": "c869e87e7eef461b6ed1ba3a1ea317799cc5b7f4", "url": "https://github.com/opensrp/opensrp-client-core/commit/c869e87e7eef461b6ed1ba3a1ea317799cc5b7f4", "message": "Don't pull data from the server as long as the app is outdated", "committedDate": "2020-03-26T13:35:51Z", "type": "forcePushed"}]}