{"pr_number": 548, "pr_title": "Retry sync for plans, locations and tasks", "pr_createdAt": "2020-06-04T09:49:11Z", "pr_url": "https://github.com/opensrp/opensrp-client-core/pull/548", "timeline": [{"oid": "d57726e734dff1a633c84f06ed9bc7831128eecf", "url": "https://github.com/opensrp/opensrp-client-core/commit/d57726e734dff1a633c84f06ed9bc7831128eecf", "message": "Retry sync for tasks if records are returned", "committedDate": "2020-06-04T06:41:55Z", "type": "commit"}, {"oid": "60f70e5e28e7c5749ecf2c99c69302d2549c57b6", "url": "https://github.com/opensrp/opensrp-client-core/commit/60f70e5e28e7c5749ecf2c99c69302d2549c57b6", "message": "Retry sync for plans if record are returned", "committedDate": "2020-06-04T06:53:35Z", "type": "commit"}, {"oid": "1b7eded0392444e39c52b64fe7cdf15a4a396ff5", "url": "https://github.com/opensrp/opensrp-client-core/commit/1b7eded0392444e39c52b64fe7cdf15a4a396ff5", "message": "Retry sync for locations and structures if more records are available", "committedDate": "2020-06-04T07:20:31Z", "type": "commit"}, {"oid": "079a396b53716730ddc73b2715689be0a48bcb74", "url": "https://github.com/opensrp/opensrp-client-core/commit/079a396b53716730ddc73b2715689be0a48bcb74", "message": "Rename variable", "committedDate": "2020-06-04T07:34:21Z", "type": "commit"}, {"oid": "ed8ae691781bcedd71129f98f98d6f4c8c105571", "url": "https://github.com/opensrp/opensrp-client-core/commit/ed8ae691781bcedd71129f98f98d6f4c8c105571", "message": "Merge branch 'master' into retry-sync-for-plans-locations-tasks", "committedDate": "2020-06-04T09:49:18Z", "type": "commit"}, {"oid": "09226f70c3d7eaf06bcd9d4e449735afb025c467", "url": "https://github.com/opensrp/opensrp-client-core/commit/09226f70c3d7eaf06bcd9d4e449735afb025c467", "message": "Merge branch 'master' into retry-sync-for-plans-locations-tasks", "committedDate": "2020-06-08T13:46:45Z", "type": "commit"}, {"oid": "fdeb7cd5aef2563ad225ea70ed31900ee412b467", "url": "https://github.com/opensrp/opensrp-client-core/commit/fdeb7cd5aef2563ad225ea70ed31900ee412b467", "message": "Merge branch 'master' into retry-sync-for-plans-locations-tasks", "committedDate": "2020-06-10T08:23:15Z", "type": "commit"}, {"oid": "997cf6f9fe7eb68dc2071ab7bc519406877f1b26", "url": "https://github.com/opensrp/opensrp-client-core/commit/997cf6f9fe7eb68dc2071ab7bc519406877f1b26", "message": "Merge branch 'master' into retry-sync-for-plans-locations-tasks", "committedDate": "2020-06-18T12:15:03Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjY4MzUyNQ==", "url": "https://github.com/opensrp/opensrp-client-core/pull/548#discussion_r442683525", "bodyText": "since the limit can always be changed from the server, retry sync if any record was synced", "author": "githengi", "createdAt": "2020-06-19T07:40:33Z", "path": "opensrp-app/src/main/java/org/smartregister/sync/helper/PlanIntentServiceHelper.java", "diffHunk": "@@ -59,6 +60,15 @@ private PlanIntentServiceHelper(PlanDefinitionRepository planRepository, Locatio\n     }\n \n     public void syncPlans() {\n+        int batchFetchCount = batchFetchPlansFromServer();\n+\n+        while(batchFetchCount >= PLAN_PULL_LIMIT) {", "originalCommit": "997cf6f9fe7eb68dc2071ab7bc519406877f1b26", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjY4MzU4OA==", "url": "https://github.com/opensrp/opensrp-client-core/pull/548#discussion_r442683588", "bodyText": "since the limit can always be changed from the server, retry sync if any record was synced", "author": "githengi", "createdAt": "2020-06-19T07:40:40Z", "path": "opensrp-app/src/main/java/org/smartregister/sync/helper/LocationServiceHelper.java", "diffHunk": "@@ -78,6 +79,19 @@ public static LocationServiceHelper getInstance() {\n     }\n \n     protected List<Location> syncLocationsStructures(boolean isJurisdiction) {\n+        List<Location> locationStructures = batchSyncLocationsStructures(isJurisdiction);\n+        int batchFetchCount = locationStructures.size();\n+\n+        while( locationStructures != null &&  batchFetchCount >= LOCATION_PULL_LIMIT) {", "originalCommit": "997cf6f9fe7eb68dc2071ab7bc519406877f1b26", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjY4Mzg3MQ==", "url": "https://github.com/opensrp/opensrp-client-core/pull/548#discussion_r442683871", "bodyText": "since the limit can always be changed from the server, retry sync if any record was synced", "author": "githengi", "createdAt": "2020-06-19T07:41:23Z", "path": "opensrp-app/src/main/java/org/smartregister/sync/helper/TaskServiceHelper.java", "diffHunk": "@@ -95,6 +96,20 @@ public TaskServiceHelper(TaskRepository taskRepository) {\n     public List<Task> fetchTasksFromServer() {\n         Set<String> planDefinitions = getPlanDefinitionIds();\n         List<String> groups = getLocationIds();\n+\n+        List<Task> tasks = batchFetchTasksFromServer(planDefinitions,groups);\n+        int batchFetchCount = tasks.size();\n+\n+        while( tasks != null &&  batchFetchCount >= TASK_PULL_LIMIT) {", "originalCommit": "997cf6f9fe7eb68dc2071ab7bc519406877f1b26", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "bf3cb14540d08ab561cf2911fbff7df4a31fbcad", "url": "https://github.com/opensrp/opensrp-client-core/commit/bf3cb14540d08ab561cf2911fbff7df4a31fbcad", "message": "Retry sync if any records are fetched from the server", "committedDate": "2020-06-19T08:35:44Z", "type": "commit"}, {"oid": "d8e8ca8c18dc8f24c15ce09a0d4b9e241324a6ef", "url": "https://github.com/opensrp/opensrp-client-core/commit/d8e8ca8c18dc8f24c15ce09a0d4b9e241324a6ef", "message": "Perform null checks", "committedDate": "2020-06-19T08:55:14Z", "type": "commit"}, {"oid": "bacd7a5bba946a08d1aea54176185458d7b8b1d8", "url": "https://github.com/opensrp/opensrp-client-core/commit/bacd7a5bba946a08d1aea54176185458d7b8b1d8", "message": "Merge branch 'retry-sync-for-plans-locations-tasks' of github.com:OpenSRP/opensrp-client-core into retry-sync-for-plans-locations-tasks", "committedDate": "2020-06-19T09:01:35Z", "type": "commit"}, {"oid": "67cc94109686f2773a128b85f6caa684181b15d4", "url": "https://github.com/opensrp/opensrp-client-core/commit/67cc94109686f2773a128b85f6caa684181b15d4", "message": "Use recursion for retrying sync", "committedDate": "2020-06-19T13:31:49Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjg0NDQ5MQ==", "url": "https://github.com/opensrp/opensrp-client-core/pull/548#discussion_r442844491", "bodyText": "No need for this", "author": "githengi", "createdAt": "2020-06-19T13:36:01Z", "path": "opensrp-app/src/main/java/org/smartregister/sync/helper/PlanIntentServiceHelper.java", "diffHunk": "@@ -86,10 +91,15 @@ public void syncPlans() {\n             // update most recent server version\n             if (!Utils.isEmptyCollection(plans)) {\n                 allSharedPreferences.savePreference(PLAN_LAST_SYNC_DATE, String.valueOf(getPlanDefinitionMaxServerVersion(plans, maxServerVersion)));\n+\n+                // retry fetch since there were items synced from the server\n+                batchFetchPlansFromServer();\n             }\n         } catch (Exception e) {\n             Timber.e(e, \"EXCEPTION %s\", e.toString());\n         }\n+\n+        return ;", "originalCommit": "67cc94109686f2773a128b85f6caa684181b15d4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjg0NjA2NA==", "url": "https://github.com/opensrp/opensrp-client-core/pull/548#discussion_r442846064", "bodyText": "for recursion add a param  List<Task to batchFetchTasksFromServer\nThen this is how you recall the method\ntasks.addAll(batchFetchTasks);\nreturn  batchFetchTasksFromServer(planDefinitions, groups,tasks);", "author": "githengi", "createdAt": "2020-06-19T13:38:53Z", "path": "opensrp-app/src/main/java/org/smartregister/sync/helper/TaskServiceHelper.java", "diffHunk": "@@ -120,6 +127,9 @@ public TaskServiceHelper(TaskRepository taskRepository) {\n             }\n             if (!Utils.isEmptyCollection(tasks)) {\n                 allSharedPreferences.savePreference(TASK_LAST_SYNC_DATE, String.valueOf(getTaskMaxServerVersion(tasks, maxServerVersion)));\n+                // retry fetch since there were items synced from the server\n+                List<Task> batchFetchTasks = batchFetchTasksFromServer(planDefinitions, groups);\n+                tasks.addAll(batchFetchTasks);", "originalCommit": "67cc94109686f2773a128b85f6caa684181b15d4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjg0NjM0Nw==", "url": "https://github.com/opensrp/opensrp-client-core/pull/548#discussion_r442846347", "bodyText": "check https://github.com/OpenSRP/opensrp-client-core/pull/548/files#r442846064", "author": "githengi", "createdAt": "2020-06-19T13:39:23Z", "path": "opensrp-app/src/main/java/org/smartregister/sync/helper/LocationServiceHelper.java", "diffHunk": "@@ -108,6 +113,10 @@ public static LocationServiceHelper getInstance() {\n                 String maxServerVersion = getMaxServerVersion(locations);\n                 String updateKey = isJurisdiction ? LOCATION_LAST_SYNC_DATE : STRUCTURES_LAST_SYNC_DATE;\n                 allSharedPreferences.savePreference(updateKey, maxServerVersion);\n+\n+                // retry fetch since there were items synced from the server\n+                List<Location> batchLocationStructures = batchSyncLocationsStructures(isJurisdiction);\n+                locations.addAll(batchLocationStructures);", "originalCommit": "67cc94109686f2773a128b85f6caa684181b15d4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "c256a3b2e80305c9921bc7f0d53ea2db749da0f4", "url": "https://github.com/opensrp/opensrp-client-core/commit/c256a3b2e80305c9921bc7f0d53ea2db749da0f4", "message": "Merge branch 'master' into retry-sync-for-plans-locations-tasks", "committedDate": "2020-06-19T13:53:19Z", "type": "commit"}, {"oid": "bb69c25ace2b1881eb67d264f8a01684e48182cd", "url": "https://github.com/opensrp/opensrp-client-core/commit/bb69c25ace2b1881eb67d264f8a01684e48182cd", "message": "Update recursive funtion", "committedDate": "2020-06-19T14:15:54Z", "type": "commit"}, {"oid": "fd9632315b4d267f446c245551b423dbc0f68079", "url": "https://github.com/opensrp/opensrp-client-core/commit/fd9632315b4d267f446c245551b423dbc0f68079", "message": "Fix termination conditional for recursive functional to return total entities", "committedDate": "2020-06-21T11:09:52Z", "type": "commit"}, {"oid": "ff92f0a497b72f976525560e5fc78ab3bbf82e43", "url": "https://github.com/opensrp/opensrp-client-core/commit/ff92f0a497b72f976525560e5fc78ab3bbf82e43", "message": "Merge branch 'master' into retry-sync-for-plans-locations-tasks", "committedDate": "2020-06-23T10:04:06Z", "type": "commit"}, {"oid": "458e7fc230f2f98bb459e5dfb1d82d4725e09f68", "url": "https://github.com/opensrp/opensrp-client-core/commit/458e7fc230f2f98bb459e5dfb1d82d4725e09f68", "message": "Update test to return empty list on second location sync call", "committedDate": "2020-06-23T10:58:55Z", "type": "commit"}, {"oid": "30a92ae688648644b95d6d4f25a76d7be53c829b", "url": "https://github.com/opensrp/opensrp-client-core/commit/30a92ae688648644b95d6d4f25a76d7be53c829b", "message": "Merge branch 'master' into retry-sync-for-plans-locations-tasks", "committedDate": "2020-06-23T11:52:46Z", "type": "commit"}, {"oid": "ecd1c238bffb4eaabfe339c6da9b538c6800d3bf", "url": "https://github.com/opensrp/opensrp-client-core/commit/ecd1c238bffb4eaabfe339c6da9b538c6800d3bf", "message": "Nullify geometry when returning synced locations/structures", "committedDate": "2020-06-24T08:55:47Z", "type": "commit"}, {"oid": "62215b511df719d5ee9d42f11f20ecbce9841a72", "url": "https://github.com/opensrp/opensrp-client-core/commit/62215b511df719d5ee9d42f11f20ecbce9841a72", "message": "Merge branch 'master' into retry-sync-for-plans-locations-tasks", "committedDate": "2020-06-24T08:56:19Z", "type": "commit"}, {"oid": "af4f74661c8964ec050ea43b61f9b22ea8f679aa", "url": "https://github.com/opensrp/opensrp-client-core/commit/af4f74661c8964ec050ea43b61f9b22ea8f679aa", "message": "Bump version", "committedDate": "2020-06-26T09:10:05Z", "type": "commit"}]}