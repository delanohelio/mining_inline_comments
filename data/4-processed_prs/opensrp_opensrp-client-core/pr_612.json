{"pr_number": 612, "pr_title": "Added sync intent service tests", "pr_createdAt": "2020-07-28T07:58:08Z", "pr_url": "https://github.com/opensrp/opensrp-client-core/pull/612", "timeline": [{"oid": "e57995c53f64113274c2a002b70c35e5268e5f01", "url": "https://github.com/opensrp/opensrp-client-core/commit/e57995c53f64113274c2a002b70c35e5268e5f01", "message": "Added sync intent service tests", "committedDate": "2020-07-28T07:49:33Z", "type": "commit"}, {"oid": "b5780b575f6d2435a1d148f1d273442ae6fdeef4", "url": "https://github.com/opensrp/opensrp-client-core/commit/b5780b575f6d2435a1d148f1d273442ae6fdeef4", "message": "Merge branch 'master' into rkareko-tt-23", "committedDate": "2020-07-28T16:24:45Z", "type": "commit"}, {"oid": "6c8e0feaf044e12f0e75b72048656c156f4a51b8", "url": "https://github.com/opensrp/opensrp-client-core/commit/6c8e0feaf044e12f0e75b72048656c156f4a51b8", "message": "Merge branch 'master' into rkareko-tt-23", "committedDate": "2020-08-04T08:16:39Z", "type": "commit"}, {"oid": "c749fbe905b5433c7e7e05eb18ac6990967d306f", "url": "https://github.com/opensrp/opensrp-client-core/commit/c749fbe905b5433c7e7e05eb18ac6990967d306f", "message": "Add pull ec from server when sync filter param is null test", "committedDate": "2020-08-04T08:48:36Z", "type": "commit"}, {"oid": "c23c46c5e5c2d9fed98c3964b01f2ec9cab4b14b", "url": "https://github.com/opensrp/opensrp-client-core/commit/c23c46c5e5c2d9fed98c3964b01f2ec9cab4b14b", "message": "Add pull ec from server when sync filter values is null test", "committedDate": "2020-08-04T09:54:25Z", "type": "commit"}, {"oid": "78ab3493af06b54ae8093a3d7247dc30c00bd027", "url": "https://github.com/opensrp/opensrp-client-core/commit/78ab3493af06b54ae8093a3d7247dc30c00bd027", "message": "Merge branch 'master' into rkareko-tt-23", "committedDate": "2020-08-13T07:53:14Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTg5NjE4Ng==", "url": "https://github.com/opensrp/opensrp-client-core/pull/612#discussion_r469896186", "bodyText": "call pullECFromServer() since it's protected. Otherwise the rest is OK", "author": "ekigamba", "createdAt": "2020-08-13T11:55:32Z", "path": "opensrp-app/src/test/java/org/smartregister/sync/intent/SyncIntentServiceTest.java", "diffHunk": "@@ -84,4 +85,64 @@ public void testHandleSyncCallsLogoutUserIfHasValidAuthorizationIsFalse() {\n         verify(syncUtils).logoutUser();\n     }\n \n+    @Test\n+    public void testHandleSyncCallsLogOutUserIfAppVersionIsNotAllowedAnd() {\n+        syncIntentService = spy(syncIntentService);\n+        Whitebox.setInternalState(syncIntentService, \"syncUtils\", syncUtils);\n+        when(syncUtils.verifyAuthorization()).thenReturn(true);\n+        when(syncConfiguration.disableSyncToServerIfUserIsDisabled()).thenReturn(true);\n+        syncIntentService.handleSync();\n+        verify(syncUtils).logoutUser();\n+    }\n+\n+    @Test\n+    public void testHandleSyncCallsPullECFromServerIfHasValidAuthorizationAndIsAppVersionAllowed() throws PackageManager.NameNotFoundException {\n+        syncIntentService = spy(syncIntentService);\n+        Whitebox.setInternalState(syncIntentService, \"syncUtils\", syncUtils);\n+        when(syncUtils.verifyAuthorization()).thenReturn(true);\n+        when(syncUtils.isAppVersionAllowed()).thenReturn(true);\n+        when(syncConfiguration.disableSyncToServerIfUserIsDisabled()).thenReturn(true);\n+        syncIntentService.handleSync();\n+        verify(syncIntentService).pullECFromServer();\n+    }\n+\n+    @Test\n+    public void testPullEcFromServerWhenSyncFilterParamIsNull() throws PackageManager.NameNotFoundException {\n+        initMocksForPullECFromServer();\n+        syncIntentService.handleSync();", "originalCommit": "78ab3493af06b54ae8093a3d7247dc30c00bd027", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTg5NjI0Mw==", "url": "https://github.com/opensrp/opensrp-client-core/pull/612#discussion_r469896243", "bodyText": "call pullECFromServer() since it's protected. Otherwise the rest is OK", "author": "ekigamba", "createdAt": "2020-08-13T11:55:40Z", "path": "opensrp-app/src/test/java/org/smartregister/sync/intent/SyncIntentServiceTest.java", "diffHunk": "@@ -84,4 +85,64 @@ public void testHandleSyncCallsLogoutUserIfHasValidAuthorizationIsFalse() {\n         verify(syncUtils).logoutUser();\n     }\n \n+    @Test\n+    public void testHandleSyncCallsLogOutUserIfAppVersionIsNotAllowedAnd() {\n+        syncIntentService = spy(syncIntentService);\n+        Whitebox.setInternalState(syncIntentService, \"syncUtils\", syncUtils);\n+        when(syncUtils.verifyAuthorization()).thenReturn(true);\n+        when(syncConfiguration.disableSyncToServerIfUserIsDisabled()).thenReturn(true);\n+        syncIntentService.handleSync();\n+        verify(syncUtils).logoutUser();\n+    }\n+\n+    @Test\n+    public void testHandleSyncCallsPullECFromServerIfHasValidAuthorizationAndIsAppVersionAllowed() throws PackageManager.NameNotFoundException {\n+        syncIntentService = spy(syncIntentService);\n+        Whitebox.setInternalState(syncIntentService, \"syncUtils\", syncUtils);\n+        when(syncUtils.verifyAuthorization()).thenReturn(true);\n+        when(syncUtils.isAppVersionAllowed()).thenReturn(true);\n+        when(syncConfiguration.disableSyncToServerIfUserIsDisabled()).thenReturn(true);\n+        syncIntentService.handleSync();\n+        verify(syncIntentService).pullECFromServer();\n+    }\n+\n+    @Test\n+    public void testPullEcFromServerWhenSyncFilterParamIsNull() throws PackageManager.NameNotFoundException {\n+        initMocksForPullECFromServer();\n+        syncIntentService.handleSync();\n+        verify(syncIntentService, times(2)).sendBroadcast(intentArgumentCaptor.capture());\n+        // sync fetch started broadcast sent\n+        assertEquals(SyncStatusBroadcastReceiver.ACTION_SYNC_STATUS, intentArgumentCaptor.getAllValues().get(0).getAction());\n+        assertEquals(FetchStatus.fetchStarted, intentArgumentCaptor.getAllValues().get(0).getSerializableExtra(SyncStatusBroadcastReceiver.EXTRA_FETCH_STATUS));\n+\n+        // sync fetch failed broadcast sent\n+        assertEquals(SyncStatusBroadcastReceiver.ACTION_SYNC_STATUS, intentArgumentCaptor.getAllValues().get(1).getAction());\n+        assertEquals(FetchStatus.fetchedFailed, intentArgumentCaptor.getAllValues().get(1).getSerializableExtra(SyncStatusBroadcastReceiver.EXTRA_FETCH_STATUS));\n+\n+    }\n+\n+    @Test\n+    public void testPullEcFromServerWhenSyncFilterValueIsNull() throws PackageManager.NameNotFoundException {\n+        initMocksForPullECFromServer();\n+        when(syncConfiguration.getSyncFilterParam()).thenReturn(SyncFilter.LOCATION);\n+        syncIntentService.handleSync();", "originalCommit": "78ab3493af06b54ae8093a3d7247dc30c00bd027", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "3f206318d2cd236d6a877b460579dfff6caef629", "url": "https://github.com/opensrp/opensrp-client-core/commit/3f206318d2cd236d6a877b460579dfff6caef629", "message": "Update unit tests", "committedDate": "2020-08-17T15:09:51Z", "type": "commit"}]}