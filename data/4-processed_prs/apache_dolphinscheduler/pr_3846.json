{"pr_number": 3846, "pr_title": "[FIX-Bug #3845][Ambari Plugin] Start Ambari report an error: Table 't_ds_process_definition_version' already exists", "pr_createdAt": "2020-09-28T08:41:21Z", "pr_url": "https://github.com/apache/dolphinscheduler/pull/3846", "timeline": [{"oid": "56e030e65974bb551d64a6dc9a1ff9a0cb8a629d", "url": "https://github.com/apache/dolphinscheduler/commit/56e030e65974bb551d64a6dc9a1ff9a0cb8a629d", "message": "[Bug][Ambari Plugin] Start Ambari report an error: Table 't_ds_process_definition_version' already exists #3845", "committedDate": "2020-09-28T08:34:19Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTgwMzc2Mg==", "url": "https://github.com/apache/dolphinscheduler/pull/3846#discussion_r495803762", "bodyText": "I think the problem is in the schema file. Not here.\nIn order to ensure that the table structure metadata is up to date, we need to execute the upgrade-dolphinscheduler.sh script at startup. This script will automatically check the current version number and execute the corresponding upgrade sql file.\nTherefore, we require that the sql file in the schema must meet the ability of repeatable execution.\nIn order to achieve this goal, if we need to create the table t_ds_process_definition_version, then we should use\ncreate table IF NOT EXISTS t_ds_process_definition_version;\n\n\nor\ndrop table if exists t_ds_process_definition_version;\ncreate table t_ds_process_definition_version;", "author": "gaojun2048", "createdAt": "2020-09-28T09:23:49Z", "path": "ambari_plugin/common-services/DOLPHIN/1.3.0/package/scripts/dolphin_api_service.py", "diffHunk": "@@ -45,10 +45,6 @@ def start(self, env):\n         init_cmd=format(\"sh \" + params.dolphin_home + \"/script/create-dolphinscheduler.sh\")\n         Execute(init_cmd, user=params.dolphin_user)\n \n-        #upgrade\n-        upgrade_cmd=format(\"sh \" + params.dolphin_home + \"/script/upgrade-dolphinscheduler.sh\")", "originalCommit": "56e030e65974bb551d64a6dc9a1ff9a0cb8a629d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTgxNjc1OA==", "url": "https://github.com/apache/dolphinscheduler/pull/3846#discussion_r495816758", "bodyText": "+1", "author": "felix-thinkingdata", "createdAt": "2020-09-28T09:45:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTgwMzc2Mg=="}], "type": "inlineReview"}, {"oid": "5f7d6ea46318bec9d03fc4eab05d7752a839029b", "url": "https://github.com/apache/dolphinscheduler/commit/5f7d6ea46318bec9d03fc4eab05d7752a839029b", "message": "Revert \"[Bug][Ambari Plugin] Start Ambari report an error: Table 't_ds_process_definition_version' already exists #3845\"\n\nThis reverts commit 56e030e6", "committedDate": "2020-09-28T09:52:18Z", "type": "commit"}, {"oid": "af4440d47b11ee6d707b4fa256a6fd65b6d05e12", "url": "https://github.com/apache/dolphinscheduler/commit/af4440d47b11ee6d707b4fa256a6fd65b6d05e12", "message": "[Bug][Ambari Plugin] Start Ambari report an error: Table 't_ds_process_definition_version' already exists #3845", "committedDate": "2020-09-28T09:52:18Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTgyNTEyNg==", "url": "https://github.com/apache/dolphinscheduler/pull/3846#discussion_r495825126", "bodyText": "I don\u2019t know why the author of this stored procedure wants to recreate t_ds_process_definition_version here. If this is necessary, I think it`s  better to modify it to\ndrop table if exists xxx;\ncreate table xxx;", "author": "gaojun2048", "createdAt": "2020-09-28T09:59:48Z", "path": "sql/upgrade/1.3.3_schema/mysql/dolphinscheduler_ddl.sql", "diffHunk": "@@ -101,7 +101,7 @@ drop PROCEDURE if EXISTS ct_dolphin_T_t_ds_process_definition_version;\n delimiter d//\n CREATE PROCEDURE ct_dolphin_T_t_ds_process_definition_version()\n BEGIN\n-    CREATE TABLE `t_ds_process_definition_version` (\n+    CREATE TABLE IF NOT EXISTS `t_ds_process_definition_version` (", "originalCommit": "af4440d47b11ee6d707b4fa256a6fd65b6d05e12", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTgyODQ4OA==", "url": "https://github.com/apache/dolphinscheduler/pull/3846#discussion_r495828488", "bodyText": "I don\u2019t know why the author of this stored procedure wants to recreate t_ds_process_definition_version here. If this is necessary, I think it`s better to modify it to\ndrop table if exists xxx;\ncreate table xxx;\n\n\nI am a newer for dolphinscheduler. I just worry about that there store some values in this table. So I add IF NOT EXISTS.", "author": "yangruochen", "createdAt": "2020-09-28T10:05:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTgyNTEyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTgyODY2Ng==", "url": "https://github.com/apache/dolphinscheduler/pull/3846#discussion_r495828666", "bodyText": "@yangyichao-mango", "author": "felix-thinkingdata", "createdAt": "2020-09-28T10:05:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTgyNTEyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTgzMjA5MQ==", "url": "https://github.com/apache/dolphinscheduler/pull/3846#discussion_r495832091", "bodyText": "That's fine ,Before version 1.3.3\uff0cThis table does not exist.\n\u8fd9\u6837\u662f\u53ef\u4ee5\u7684\uff0c\u8fd9\u4e2a\u8868\u57281.3.3\u4e4b\u524d\u662f\u4e0d\u5b58\u5728\u7684\u3002", "author": "felix-thinkingdata", "createdAt": "2020-09-28T10:12:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTgyNTEyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTgzNDkwNg==", "url": "https://github.com/apache/dolphinscheduler/pull/3846#discussion_r495834906", "bodyText": "That's fine ,Before version 1.3.3\uff0cThis table does not exist.\n\u8fd9\u6837\u662f\u53ef\u4ee5\u7684\uff0c\u8fd9\u4e2a\u8868\u57281.3.3\u4e4b\u524d\u662f\u4e0d\u5b58\u5728\u7684\u3002\n\nOk !", "author": "gaojun2048", "createdAt": "2020-09-28T10:18:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTgyNTEyNg=="}], "type": "inlineReview"}]}