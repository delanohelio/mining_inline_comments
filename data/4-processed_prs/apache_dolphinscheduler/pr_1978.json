{"pr_number": 1978, "pr_title": "Refactor dockerfile", "pr_createdAt": "2020-02-19T10:03:28Z", "pr_url": "https://github.com/apache/dolphinscheduler/pull/1978", "timeline": [{"oid": "86e607dc564e9a4819dfc469626f196127db8622", "url": "https://github.com/apache/dolphinscheduler/commit/86e607dc564e9a4819dfc469626f196127db8622", "message": "Merge pull request #1 from apache/dev\n\nmerge", "committedDate": "2020-01-08T02:11:45Z", "type": "commit"}, {"oid": "5dbee2ad21dcae034b9ba1514dae3f100baa6c6d", "url": "https://github.com/apache/dolphinscheduler/commit/5dbee2ad21dcae034b9ba1514dae3f100baa6c6d", "message": "Merge branch 'dev' of https://github.com/apache/incubator-dolphinscheduler into dev", "committedDate": "2020-02-13T11:25:36Z", "type": "commit"}, {"oid": "73094787f9e8a89104c3f1acbf512829c2d969c4", "url": "https://github.com/apache/dolphinscheduler/commit/73094787f9e8a89104c3f1acbf512829c2d969c4", "message": "Support DS to create user and group in windows environment", "committedDate": "2020-02-13T11:57:03Z", "type": "commit"}, {"oid": "5ccebbf5f8f17720d038a319d91a4bfda2825789", "url": "https://github.com/apache/dolphinscheduler/commit/5ccebbf5f8f17720d038a319d91a4bfda2825789", "message": "Add unit test", "committedDate": "2020-02-13T13:50:20Z", "type": "commit"}, {"oid": "1bb4c53d896cdbf673c9b1ae9401b287fea5c28c", "url": "https://github.com/apache/dolphinscheduler/commit/1bb4c53d896cdbf673c9b1ae9401b287fea5c28c", "message": "Merge branch 'dev' of https://github.com/apache/incubator-dolphinscheduler into dev", "committedDate": "2020-02-17T02:19:57Z", "type": "commit"}, {"oid": "f959c8e8573002205417b85cd0cf878f656923f7", "url": "https://github.com/apache/dolphinscheduler/commit/f959c8e8573002205417b85cd0cf878f656923f7", "message": "delete combined-server config in dolphinscheduler-daemon.sh file", "committedDate": "2020-02-17T02:33:27Z", "type": "commit"}, {"oid": "5cfc68d1e1bfa94a0c188898b233ad988125b027", "url": "https://github.com/apache/dolphinscheduler/commit/5cfc68d1e1bfa94a0c188898b233ad988125b027", "message": "Merge branch 'dev' of https://github.com/apache/incubator-dolphinscheduler into dev", "committedDate": "2020-02-19T09:45:28Z", "type": "commit"}, {"oid": "c6f9306260088bcc59250c3acb73526db29bdde8", "url": "https://github.com/apache/dolphinscheduler/commit/c6f9306260088bcc59250c3acb73526db29bdde8", "message": "refactor dockerfile", "committedDate": "2020-02-19T09:59:57Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTY2MTk3NQ==", "url": "https://github.com/apache/dolphinscheduler/pull/1978#discussion_r381661975", "bodyText": "Why delete license announcement?", "author": "khadgarmage", "createdAt": "2020-02-20T01:55:28Z", "path": "dockerfile/Dockerfile", "diffHunk": "@@ -1,136 +1,74 @@\n-#", "originalCommit": "c6f9306260088bcc59250c3acb73526db29bdde8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTcwMTMxNg==", "url": "https://github.com/apache/dolphinscheduler/pull/1978#discussion_r381701316", "bodyText": "I have forgot it, because this dockerfile is new.", "author": "liwenhe1993", "createdAt": "2020-02-20T03:08:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTY2MTk3NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTY2MzgyMg==", "url": "https://github.com/apache/dolphinscheduler/pull/1978#discussion_r381663822", "bodyText": "Can Alibaba Cloud Mirror make download quickly abroad?", "author": "khadgarmage", "createdAt": "2020-02-20T01:58:33Z", "path": "dockerfile/Dockerfile", "diffHunk": "@@ -1,136 +1,74 @@\n-#\n-# Licensed to the Apache Software Foundation (ASF) under one or more\n-# contributor license agreements.  See the NOTICE file distributed with\n-# this work for additional information regarding copyright ownership.\n-# The ASF licenses this file to You under the Apache License, Version 2.0\n-# (the \"License\"); you may not use this file except in compliance with\n-# the License.  You may obtain a copy of the License at\n-#\n-#     http://www.apache.org/licenses/LICENSE-2.0\n-#\n-# Unless required by applicable law or agreed to in writing, software\n-# distributed under the License is distributed on an \"AS IS\" BASIS,\n-# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n-# See the License for the specific language governing permissions and\n-# limitations under the License.\n-#\n+FROM nginx:alpine\n \n-FROM ubuntu:18.04\n+ARG VERSION\n \n-ENV LANG=C.UTF-8\n-ENV DEBIAN_FRONTEND=noninteractive\n+ENV TZ Asia/Shanghai\n+ENV LANG C.UTF-8\n+ENV DEBIAN_FRONTEND noninteractive\n \n-ARG version\n-ARG tar_version\n+#1. using aliyun mirror, and install dos2unix shadow bash openrc python sudo vim wget iputils net-tools ssh pip kazoo\n+RUN sed -i \"s/dl-cdn.alpinelinux.org/mirrors.aliyun.com/g\" /etc/apk/repositories && \\", "originalCommit": "c6f9306260088bcc59250c3acb73526db29bdde8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTY5OTI3NQ==", "url": "https://github.com/apache/dolphinscheduler/pull/1978#discussion_r381699275", "bodyText": "I will remove it", "author": "liwenhe1993", "createdAt": "2020-02-20T03:04:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTY2MzgyMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTY2ODY4MQ==", "url": "https://github.com/apache/dolphinscheduler/pull/1978#discussion_r381668681", "bodyText": "Why dos2unix, not sh?", "author": "khadgarmage", "createdAt": "2020-02-20T02:07:26Z", "path": "dockerfile/Dockerfile", "diffHunk": "@@ -1,136 +1,74 @@\n-#\n-# Licensed to the Apache Software Foundation (ASF) under one or more\n-# contributor license agreements.  See the NOTICE file distributed with\n-# this work for additional information regarding copyright ownership.\n-# The ASF licenses this file to You under the Apache License, Version 2.0\n-# (the \"License\"); you may not use this file except in compliance with\n-# the License.  You may obtain a copy of the License at\n-#\n-#     http://www.apache.org/licenses/LICENSE-2.0\n-#\n-# Unless required by applicable law or agreed to in writing, software\n-# distributed under the License is distributed on an \"AS IS\" BASIS,\n-# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n-# See the License for the specific language governing permissions and\n-# limitations under the License.\n-#\n+FROM nginx:alpine\n \n-FROM ubuntu:18.04\n+ARG VERSION\n \n-ENV LANG=C.UTF-8\n-ENV DEBIAN_FRONTEND=noninteractive\n+ENV TZ Asia/Shanghai\n+ENV LANG C.UTF-8\n+ENV DEBIAN_FRONTEND noninteractive\n \n-ARG version\n-ARG tar_version\n+#1. using aliyun mirror, and install dos2unix shadow bash openrc python sudo vim wget iputils net-tools ssh pip kazoo\n+RUN sed -i \"s/dl-cdn.alpinelinux.org/mirrors.aliyun.com/g\" /etc/apk/repositories && \\\n+    apk update && \\\n+    apk add dos2unix shadow bash openrc python sudo vim wget iputils net-tools openssh-server py2-pip && \\\n+    apk add --update procps && \\\n+    openrc boot && \\\n+    pip install kazoo\n \n-#1,install jdk\n-\n-RUN apt-get update \\\n-    && apt-get -y install openjdk-8-jdk \\\n-    && rm -rf /var/lib/apt/lists/*\n-\n-ENV JAVA_HOME /usr/lib/jvm/java-8-openjdk-amd64\n+#2. install jdk\n+RUN apk add openjdk8\n+ENV JAVA_HOME /usr/lib/jvm/java-1.8-openjdk\n ENV PATH $JAVA_HOME/bin:$PATH\n \n-\n-#install wget\n-RUN apt-get update && \\\n-        apt-get -y install wget\n-#2,install ZK\n-\n+#3. install zk\n RUN cd /opt && \\\n-    wget https://www-us.apache.org/dist/zookeeper/zookeeper-3.4.14/zookeeper-3.4.14.tar.gz  && \\\n-    tar -zxvf zookeeper-3.4.14.tar.gz  && \\\n-    mv zookeeper-3.4.14 zookeeper && \\\n-    rm -rf ./zookeeper-*tar.gz && \\\n+    wget https://downloads.apache.org/zookeeper/zookeeper-3.5.7/apache-zookeeper-3.5.7-bin.tar.gz && \\\n+    tar -zxvf apache-zookeeper-3.5.7-bin.tar.gz && \\\n+    mv apache-zookeeper-3.5.7-bin zookeeper && \\\n     mkdir -p /tmp/zookeeper && \\\n+    rm -rf ./zookeeper-*tar.gz && \\\n     rm -rf /opt/zookeeper/conf/zoo_sample.cfg\n-\n-ADD ./dockerfile/conf/zookeeper/zoo.cfg /opt/zookeeper/conf\n-ENV ZK_HOME=/opt/zookeeper\n-ENV PATH $PATH:$ZK_HOME/bin\n-\n-#3,install maven\n-RUN cd /opt && \\\n-    wget http://apache-mirror.rbc.ru/pub/apache/maven/maven-3/3.3.9/binaries/apache-maven-3.3.9-bin.tar.gz && \\\n-    tar -zxvf apache-maven-3.3.9-bin.tar.gz && \\\n-    mv apache-maven-3.3.9 maven && \\\n-    rm -rf ./apache-maven-*tar.gz && \\\n-    rm -rf /opt/maven/conf/settings.xml\n-ADD ./dockerfile/conf/maven/settings.xml /opt/maven/conf\n-ENV MAVEN_HOME=/opt/maven\n-ENV PATH $PATH:$MAVEN_HOME/bin\n-\n-#4,install node\n-RUN cd /opt && \\\n-    wget https://nodejs.org/download/release/v8.9.4/node-v8.9.4-linux-x64.tar.gz && \\\n-    tar -zxvf node-v8.9.4-linux-x64.tar.gz && \\\n-    mv node-v8.9.4-linux-x64 node && \\\n-    rm -rf ./node-v8.9.4-*tar.gz\n-ENV NODE_HOME=/opt/node\n-ENV PATH $PATH:$NODE_HOME/bin\n-\n-#5,install postgresql\n-RUN apt-get update && \\\n-    apt-get install -y postgresql postgresql-contrib sudo && \\\n-    sed -i 's/localhost/*/g' /etc/postgresql/10/main/postgresql.conf\n-\n-#6,install nginx\n-RUN apt-get update && \\\n-  apt-get install -y nginx && \\\n-  rm -rf /var/lib/apt/lists/* && \\\n-  echo \"\\ndaemon off;\" >> /etc/nginx/nginx.conf && \\\n-  chown -R www-data:www-data /var/lib/nginx\n-\n-#7,install sudo,python,vim,ping and ssh command\n-RUN apt-get update && \\\n-  apt-get -y install sudo && \\\n-  apt-get -y install python && \\\n-  apt-get -y install vim && \\\n-  apt-get -y install iputils-ping && \\\n-  apt-get -y install net-tools && \\\n-  apt-get -y install openssh-server && \\\n-  apt-get -y install python-pip && \\\n-  pip install kazoo\n-\n-#8,add dolphinscheduler source code to /opt/dolphinscheduler_source\n-ADD . /opt/dolphinscheduler_source\n-\n-\n-#9,backend compilation\n-RUN cd /opt/dolphinscheduler_source && \\\n-    mvn clean package -Prelease -Dmaven.test.skip=true\n-\n-#10,frontend compilation\n-RUN chmod -R 777 /opt/dolphinscheduler_source/dolphinscheduler-ui && \\\n-    cd /opt/dolphinscheduler_source/dolphinscheduler-ui && \\\n-    rm -rf /opt/dolphinscheduler_source/dolphinscheduler-ui/node_modules && \\\n-    npm install node-sass --unsafe-perm && \\\n-    npm install && \\\n-    npm run build\n-\n-#11,modify dolphinscheduler configuration file\n-#backend configuration\n-RUN tar -zxvf /opt/dolphinscheduler_source/dolphinscheduler-dist/dolphinscheduler-backend/target/apache-dolphinscheduler-incubating-${tar_version}-dolphinscheduler-backend-bin.tar.gz -C /opt && \\\n-    mv /opt/apache-dolphinscheduler-incubating-${tar_version}-dolphinscheduler-backend-bin /opt/dolphinscheduler && \\\n-    rm -rf /opt/dolphinscheduler/conf\n-\n-ADD ./dockerfile/conf/dolphinscheduler/conf /opt/dolphinscheduler/conf\n-#frontend nginx configuration\n-ADD ./dockerfile/conf/nginx/dolphinscheduler.conf /etc/nginx/conf.d\n-\n-#12,open port\n-EXPOSE 2181 2888 3888 3306 80 12345 8888\n-\n-COPY ./dockerfile/startup.sh /root/startup.sh\n-#13,modify permissions and set soft links\n-RUN chmod +x /root/startup.sh && \\\n-  chmod +x /opt/dolphinscheduler/script/create-dolphinscheduler.sh && \\\n-  chmod +x /opt/zookeeper/bin/zkServer.sh && \\\n-  chmod +x /opt/dolphinscheduler/bin/dolphinscheduler-daemon.sh && \\\n-  rm -rf /bin/sh && \\\n-  ln -s /bin/bash /bin/sh && \\\n-  mkdir -p /tmp/xls\n-\n+ADD ./conf/zookeeper/zoo.cfg /opt/zookeeper/conf\n+ENV ZK_HOME /opt/zookeeper\n+ENV PATH $ZK_HOME/bin:$PATH\n+\n+#4. install pg\n+RUN apk add postgresql postgresql-contrib\n+\n+#5. add dolphinscheduler\n+ADD ./apache-dolphinscheduler-incubating-${VERSION}-SNAPSHOT-dolphinscheduler-bin.tar.gz /opt/\n+RUN mv /opt/apache-dolphinscheduler-incubating-${VERSION}-SNAPSHOT-dolphinscheduler-bin/ /opt/dolphinscheduler/\n+ENV DOLPHINSCHEDULER_HOME /opt/dolphinscheduler\n+\n+#6. modify nginx\n+RUN echo \"daemon off;\" >> /etc/nginx/nginx.conf && \\\n+    rm -rf /etc/nginx/conf.d/*\n+ADD ./conf/nginx/dolphinscheduler.conf /etc/nginx/conf.d\n+\n+#7. add configuration and modify permissions and set soft links\n+ADD ./startup-init-conf.sh /root/startup-init-conf.sh\n+ADD ./startup.sh /root/startup.sh\n+ADD ./conf/dolphinscheduler/*.tpl /opt/dolphinscheduler/conf/\n+ADD ./conf/dolphinscheduler/env/dolphinscheduler_env /opt/dolphinscheduler/conf/env/\n+RUN chmod +x /root/startup-init-conf.sh && \\\n+    chmod +x /root/startup.sh && \\\n+    chmod +x /opt/dolphinscheduler/conf/env/dolphinscheduler_env && \\\n+    chmod +x /opt/dolphinscheduler/script/*.sh && \\\n+    chmod +x /opt/dolphinscheduler/bin/*.sh && \\\n+    chmod +x /opt/zookeeper/bin/*.sh && \\\n+    dos2unix /root/startup-init-conf.sh && \\", "originalCommit": "c6f9306260088bcc59250c3acb73526db29bdde8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTY5ODY0Mw==", "url": "https://github.com/apache/dolphinscheduler/pull/1978#discussion_r381698643", "bodyText": "Because bash script with Windows line-ending CRLF won't work on Linux.\nUNIX and UNIX-like operating systems (including Mac OS X) represent line endings as LF alone.\nConverting line-ending using dos2unix.", "author": "liwenhe1993", "createdAt": "2020-02-20T03:03:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTY2ODY4MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTY3MjQ3OA==", "url": "https://github.com/apache/dolphinscheduler/pull/1978#discussion_r381672478", "bodyText": "It is better to build image based on the current branch code, both CI and release can be used, rather than build based on the package", "author": "khadgarmage", "createdAt": "2020-02-20T02:14:17Z", "path": "dockerfile/hooks/build", "diffHunk": "@@ -15,10 +15,21 @@\n # See the License for the specific language governing permissions and\n # limitations under the License.\n #\n-\n echo \"------ dolphinscheduler start - build -------\"\n printenv\n \n-docker build --build-arg version=$version --build-arg tar_version=$tar_version  -t $DOCKER_REPO:$version .\n+echo -e \"Current Directory is $(pwd)\\n\"\n+\n+# maven package(Project Directory)\n+echo -e \"mvn clean compile package -Prelease\"\n+mvn clean compile package -Prelease\n+\n+# mv dolphinscheduler-bin.tar.gz file to dockerfile directory\n+echo -e \"mv $(pwd)/dolphinscheduler-dist/target/apache-dolphinscheduler-incubating-${VERSION}-SNAPSHOT-dolphinscheduler-bin.tar.gz $(pwd)/dockerfile/\\n\"", "originalCommit": "c6f9306260088bcc59250c3acb73526db29bdde8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTcwNzgxMw==", "url": "https://github.com/apache/dolphinscheduler/pull/1978#discussion_r381707813", "bodyText": "User can use it, and CI can also use it.", "author": "liwenhe1993", "createdAt": "2020-02-20T03:21:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTY3MjQ3OA=="}], "type": "inlineReview"}, {"oid": "2f0a6f6a46782693952ef8726a1290e5215ac54f", "url": "https://github.com/apache/dolphinscheduler/commit/2f0a6f6a46782693952ef8726a1290e5215ac54f", "message": "modify dockerfile", "committedDate": "2020-02-20T05:25:27Z", "type": "commit"}, {"oid": "fbe23acb1a64cc9320d0b2121208a386a5389e07", "url": "https://github.com/apache/dolphinscheduler/commit/fbe23acb1a64cc9320d0b2121208a386a5389e07", "message": "modify dockerfile", "committedDate": "2020-02-20T06:07:45Z", "type": "commit"}, {"oid": "3b62517f76669258e63ca0fd5fa89a311dbfbd5b", "url": "https://github.com/apache/dolphinscheduler/commit/3b62517f76669258e63ca0fd5fa89a311dbfbd5b", "message": "Merge branch 'dev' of https://github.com/apache/incubator-dolphinscheduler into dev\n\n# Conflicts:\n#\tdockerfile/conf/dolphinscheduler/conf/org/apache/dolphinscheduler/dao/mapper/ProcessInstanceMapper.xml\n#\tdockerfile/conf/dolphinscheduler/conf/org/apache/dolphinscheduler/dao/mapper/TaskInstanceMapper.xml", "committedDate": "2020-02-20T11:24:56Z", "type": "commit"}, {"oid": "a1357fb3d64eeb347866753fd52165a2570c6a0a", "url": "https://github.com/apache/dolphinscheduler/commit/a1357fb3d64eeb347866753fd52165a2570c6a0a", "message": "Merge remote-tracking branch 'origin/dev' into dev", "committedDate": "2020-02-20T11:25:29Z", "type": "commit"}]}