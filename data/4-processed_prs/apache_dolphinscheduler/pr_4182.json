{"pr_number": 4182, "pr_title": "[FIX-#4172][server-worker] kill task NPE", "pr_createdAt": "2020-12-08T15:54:21Z", "pr_url": "https://github.com/apache/dolphinscheduler/pull/4182", "timeline": [{"oid": "5309096c1088ec6ad24307d74ff3187a2b3ce185", "url": "https://github.com/apache/dolphinscheduler/commit/5309096c1088ec6ad24307d74ff3187a2b3ce185", "message": "[FIX-#4172][server-worker] kill task NPE\n\nThe cache task will be sent when the Process is generated. Before that, if a kill task appears, then NPE will appear\nModification method: write into the cache when the task is received, and mark it as preData\nIf the task is killed before the Process is generated, delete the cache directly at this time\nIt will be judged before the process is generated. If the task has been killed, it will not be executed.\nAfter the new process is created, write it into the cache, and judge again, if kill, then kill the process.\n\nthis closes #4172", "committedDate": "2020-12-08T15:52:48Z", "type": "commit"}, {"oid": "9b640acd126d262f5e74773d0e00eaa39dbfe0ef", "url": "https://github.com/apache/dolphinscheduler/commit/9b640acd126d262f5e74773d0e00eaa39dbfe0ef", "message": "Delete the commented out code\nAdd spring beans", "committedDate": "2020-12-08T16:13:33Z", "type": "commit"}, {"oid": "06690fed6507a7e0b7c7fe2a07ba7b23d2240cb4", "url": "https://github.com/apache/dolphinscheduler/commit/06690fed6507a7e0b7c7fe2a07ba7b23d2240cb4", "message": "code smell", "committedDate": "2020-12-09T04:06:09Z", "type": "commit"}, {"oid": "84b226525f74d5a6331068a7302c0aa36b6a564a", "url": "https://github.com/apache/dolphinscheduler/commit/84b226525f74d5a6331068a7302c0aa36b6a564a", "message": "add test", "committedDate": "2020-12-09T06:54:53Z", "type": "commit"}, {"oid": "77a6d909f848c0bd8bc12c78192efc8981d22d64", "url": "https://github.com/apache/dolphinscheduler/commit/77a6d909f848c0bd8bc12c78192efc8981d22d64", "message": "add test", "committedDate": "2020-12-09T08:39:32Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTEyMTM3Mg==", "url": "https://github.com/apache/dolphinscheduler/pull/4182#discussion_r539121372", "bodyText": "i think here you can return result and ignore the next process", "author": "lenboo", "createdAt": "2020-12-09T08:55:38Z", "path": "dolphinscheduler-server/src/main/java/org/apache/dolphinscheduler/server/worker/task/AbstractCommandExecutor.java", "diffHunk": "@@ -135,12 +143,17 @@ private void buildProcess(String commandFile) throws IOException {\n      * @return CommandExecuteResult\n      * @throws Exception if error throws Exception\n      */\n-    public CommandExecuteResult run(String execCommand) throws Exception{\n+    public CommandExecuteResult run(String execCommand) throws Exception {\n \n         CommandExecuteResult result = new CommandExecuteResult();\n \n-\n+        int taskInstanceId = taskExecutionContext.getTaskInstanceId();\n+        // If the task has been killed, then the task in the cache is null\n+        if (null == taskExecutionContextCacheManager.getByTaskInstanceId(taskInstanceId)) {\n+            result.setExitStatusCode(EXIT_CODE_KILL);", "originalCommit": "77a6d909f848c0bd8bc12c78192efc8981d22d64", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "161e2430ba19aec37575dadd88f7add0c4f93cf9", "url": "https://github.com/apache/dolphinscheduler/commit/161e2430ba19aec37575dadd88f7add0c4f93cf9", "message": "fix error", "committedDate": "2020-12-09T08:59:09Z", "type": "commit"}, {"oid": "5a8e8bfa44808cc8ccf89343043451b23a11bc2c", "url": "https://github.com/apache/dolphinscheduler/commit/5a8e8bfa44808cc8ccf89343043451b23a11bc2c", "message": "test", "committedDate": "2020-12-09T12:08:23Z", "type": "commit"}, {"oid": "49aafc3b6014f655bad2682a53f7a6c28abc1ea1", "url": "https://github.com/apache/dolphinscheduler/commit/49aafc3b6014f655bad2682a53f7a6c28abc1ea1", "message": "test", "committedDate": "2020-12-09T12:28:57Z", "type": "commit"}, {"oid": "c216e25703b38c7af43922ace0488e20186640cd", "url": "https://github.com/apache/dolphinscheduler/commit/c216e25703b38c7af43922ace0488e20186640cd", "message": "revert", "committedDate": "2020-12-09T12:43:16Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTM1NzE0NA==", "url": "https://github.com/apache/dolphinscheduler/pull/4182#discussion_r539357144", "bodyText": "whether here need return the result too?", "author": "lenboo", "createdAt": "2020-12-09T14:35:27Z", "path": "dolphinscheduler-server/src/main/java/org/apache/dolphinscheduler/server/worker/task/AbstractCommandExecutor.java", "diffHunk": "@@ -155,14 +169,17 @@ public CommandExecuteResult run(String execCommand) throws Exception{\n         // parse process output\n         parseProcessOutput(process);\n \n-\n         Integer processId = getProcessId(process);\n \n         result.setProcessId(processId);\n \n         // cache processId\n         taskExecutionContext.setProcessId(processId);\n-        taskExecutionContextCacheManager.cacheTaskExecutionContext(taskExecutionContext);\n+        boolean updateTaskExecutionContextStatus = taskExecutionContextCacheManager.updateTaskExecutionContext(taskExecutionContext);\n+        if (Boolean.FALSE.equals(updateTaskExecutionContextStatus)) {\n+            ProcessUtils.kill(taskExecutionContext);\n+            result.setExitStatusCode(EXIT_CODE_KILL);", "originalCommit": "c216e25703b38c7af43922ace0488e20186640cd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTc5NzIzNQ==", "url": "https://github.com/apache/dolphinscheduler/pull/4182#discussion_r539797235", "bodyText": "Thx.done", "author": "CalvinKirs", "createdAt": "2020-12-10T02:29:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTM1NzE0NA=="}], "type": "inlineReview"}, {"oid": "6d3c2194d59b863e42f0412b32bcdf7d70f8632b", "url": "https://github.com/apache/dolphinscheduler/commit/6d3c2194d59b863e42f0412b32bcdf7d70f8632b", "message": "fix error", "committedDate": "2020-12-10T02:21:34Z", "type": "commit"}]}