{"pr_number": 4006, "pr_title": "refactor(BlockItemFactory): remove code dupes; add doc; retain components", "pr_createdAt": "2020-05-30T12:38:55Z", "pr_url": "https://github.com/MovingBlocks/Terasology/pull/4006", "timeline": [{"oid": "fc52c9cbab9e0480d861d98999c0244d1c420e68", "url": "https://github.com/MovingBlocks/Terasology/commit/fc52c9cbab9e0480d861d98999c0244d1c420e68", "message": "refactor: BlockItemFactory to remove code duplication", "committedDate": "2020-05-29T20:02:46Z", "type": "commit"}, {"oid": "d35eac3e6083f28a377523e1344e0d86a812fde7", "url": "https://github.com/MovingBlocks/Terasology/commit/d35eac3e6083f28a377523e1344e0d86a812fde7", "message": "feat: Keep components listed as _retain components_ when creating a block item", "committedDate": "2020-05-29T20:04:27Z", "type": "commit"}, {"oid": "e96f45cceebab5bde9acdae210e2586f221ffae6", "url": "https://github.com/MovingBlocks/Terasology/commit/e96f45cceebab5bde9acdae210e2586f221ffae6", "message": "refactor(BlockItemFactory): better names; use RetainComponents", "committedDate": "2020-05-30T11:26:47Z", "type": "commit"}, {"oid": "667b37351e3ebd5169b91e50acce5120bd6f6560", "url": "https://github.com/MovingBlocks/Terasology/commit/667b37351e3ebd5169b91e50acce5120bd6f6560", "message": "doc: Update doc for RetainComponentsComponent", "committedDate": "2020-05-30T12:58:53Z", "type": "commit"}, {"oid": "729c1ac2821efdb8c44249cfdd9b7aa9f8540430", "url": "https://github.com/MovingBlocks/Terasology/commit/729c1ac2821efdb8c44249cfdd9b7aa9f8540430", "message": "refactor: use common super type ComponentContainer in BlockItemFactory", "committedDate": "2020-05-30T12:59:31Z", "type": "commit"}, {"oid": "7be96276f45cbc3bad06e1f753dfda39b80ec096", "url": "https://github.com/MovingBlocks/Terasology/commit/7be96276f45cbc3bad06e1f753dfda39b80ec096", "message": "refactor: make use of `::updateComponent` when adjusting block item components", "committedDate": "2020-05-30T13:13:26Z", "type": "commit"}, {"oid": "c60485959e2452125da833a4c6cdb36e9dd4e3ae", "url": "https://github.com/MovingBlocks/Terasology/commit/c60485959e2452125da833a4c6cdb36e9dd4e3ae", "message": "doc(BlockItemFactory): doc class and builder methods", "committedDate": "2020-05-30T14:17:51Z", "type": "commit"}, {"oid": "dda70171a421b58e71f4f766c7c727223234ef75", "url": "https://github.com/MovingBlocks/Terasology/commit/dda70171a421b58e71f4f766c7c727223234ef75", "message": "doc(BlockItemFactory): doc for `BlockItemFactory::newInstance` methods", "committedDate": "2020-05-30T14:22:21Z", "type": "commit"}, {"oid": "b24cdaf9a1a0a579b31e0623a187ab7a8e062b74", "url": "https://github.com/MovingBlocks/Terasology/commit/b24cdaf9a1a0a579b31e0623a187ab7a8e062b74", "message": "doc(BlockItemFactory): finalize documentation for class", "committedDate": "2020-05-30T14:25:05Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjg3NzMxOQ==", "url": "https://github.com/MovingBlocks/Terasology/pull/4006#discussion_r432877319", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n             * A factory to create new <emph>block items</emph> for a {@link BlockFamily}.\n          \n          \n            \n             * A factory to create new <em>block items</em> for a {@link BlockFamily}.", "author": "keturn", "createdAt": "2020-05-30T18:38:31Z", "path": "engine/src/main/java/org/terasology/world/block/items/BlockItemFactory.java", "diffHunk": "@@ -15,68 +15,81 @@\n  */\n package org.terasology.world.block.items;\n \n+import com.google.common.base.Preconditions;\n+import com.google.common.primitives.Ints;\n import org.terasology.entitySystem.Component;\n+import org.terasology.entitySystem.ComponentContainer;\n import org.terasology.entitySystem.entity.EntityBuilder;\n import org.terasology.entitySystem.entity.EntityManager;\n import org.terasology.entitySystem.entity.EntityRef;\n-import org.terasology.entitySystem.prefab.Prefab;\n import org.terasology.logic.common.DisplayNameComponent;\n+import org.terasology.logic.common.RetainComponentsComponent;\n import org.terasology.logic.inventory.ItemComponent;\n import org.terasology.rendering.logic.LightComponent;\n import org.terasology.world.block.family.BlockFamily;\n \n+import java.util.Collections;\n import java.util.Optional;\n+import java.util.Set;\n \n /**\n+ * A factory to create new <emph>block items</emph> for a {@link BlockFamily}.", "originalCommit": "b24cdaf9a1a0a579b31e0623a187ab7a8e062b74", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjg3OTY1NQ==", "url": "https://github.com/MovingBlocks/Terasology/pull/4006#discussion_r432879655", "bodyText": "I feel like there should be a shorter form of that conversion. Oh, here we go:\nhttps://guava.dev/releases/snapshot/api/docs/com/google/common/primitives/SignedBytes.html#saturatedCast-long-\nsignedBytes.saturatedCast(quantity)", "author": "keturn", "createdAt": "2020-05-30T19:11:28Z", "path": "engine/src/main/java/org/terasology/world/block/items/BlockItemFactory.java", "diffHunk": "@@ -85,37 +98,145 @@ public EntityRef newInstance(BlockFamily blockFamily, int quantity) {\n         return builder.build();\n     }\n \n+    /**\n+     * Create a new block item for the given {@link BlockFamily}, with {@code blockEntity} as reference entity to retain\n+     * components from.\n+     * <p>\n+     * The item quantity defaults to 1.\n+     * <p>\n+     * Use {@link #newBuilder(BlockFamily, EntityRef, int)} if you want to modify the block item entity's properties\n+     * before it gets created.\n+     *\n+     * @param blockFamily block family to create the block item builder for\n+     * @param blockEntity reference block entity to retain components from\n+     * @return the block item entity\n+     */\n     public EntityRef newInstance(BlockFamily blockFamily, EntityRef blockEntity) {\n         if (blockFamily == null) {\n             return EntityRef.NULL;\n         }\n \n+        return createBuilder(blockFamily, blockEntity, (byte) 1).build();\n+    }\n+\n+    /**\n+     * Create a new block item builder for the given {@link BlockFamily} and item quantity.\n+     * <p>\n+     * Attempts to resolve the corresponding block prefab to retrieve a list of potential components to add.\n+     * <p>\n+     * Use this method if you want to modify the block item entity's properties before it gets created.\n+     *\n+     * @param blockFamily block family to create the block item builder for\n+     * @param quantity item quantity (see {@link ItemComponent#stackCount}); constrained to [0...128)\n+     * @return a pre-populated entity builder for a block item entity\n+     */\n+    public EntityBuilder newBuilder(BlockFamily blockFamily, int quantity) {\n+        final ComponentContainer components =\n+                blockFamily.getArchetypeBlock().getPrefab()\n+                        .map(p -> ((ComponentContainer) p))\n+                        .orElse(EntityRef.NULL);\n+\n+        return createBuilder(blockFamily, components, (byte) Ints.constrainToRange(quantity, 0, Byte.MAX_VALUE));", "originalCommit": "b24cdaf9a1a0a579b31e0623a187ab7a8e062b74", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "a5bee8ee6990a3e5aa3a60febb1cb9f8cc02f7b5", "url": "https://github.com/MovingBlocks/Terasology/commit/a5bee8ee6990a3e5aa3a60febb1cb9f8cc02f7b5", "message": "Update engine/src/main/java/org/terasology/world/block/items/BlockItemFactory.java\n\nCo-authored-by: Kevin Turner <83819+keturn@users.noreply.github.com>", "committedDate": "2020-05-30T22:38:08Z", "type": "commit"}, {"oid": "9b47bc51432c2b548a45b1e99f05b83d9633e436", "url": "https://github.com/MovingBlocks/Terasology/commit/9b47bc51432c2b548a45b1e99f05b83d9633e436", "message": ". improve conversion to byte by using SignedBytes::saturatedCast", "committedDate": "2020-05-30T22:40:16Z", "type": "commit"}]}