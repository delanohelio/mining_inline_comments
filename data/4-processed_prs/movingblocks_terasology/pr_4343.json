{"pr_number": 4343, "pr_title": "Fix/transient deps", "pr_createdAt": "2020-12-28T06:24:22Z", "pr_url": "https://github.com/MovingBlocks/Terasology/pull/4343", "timeline": [{"oid": "b8d7f2aae816723c26c599e57eb4c20c45c44325", "url": "https://github.com/MovingBlocks/Terasology/commit/b8d7f2aae816723c26c599e57eb4c20c45c44325", "message": "chore: use short-form copyright", "committedDate": "2020-12-28T17:06:37Z", "type": "commit"}, {"oid": "5cfcf10928f3c0e79cb5c1e8fbc78cfe578b79ee", "url": "https://github.com/MovingBlocks/Terasology/commit/5cfcf10928f3c0e79cb5c1e8fbc78cfe578b79ee", "message": "chore (build): refactor lambda to named function", "committedDate": "2020-12-28T17:06:37Z", "type": "commit"}, {"oid": "ef739b4c18572fb61e61af6e605289d739f6654d", "url": "https://github.com/MovingBlocks/Terasology/commit/ef739b4c18572fb61e61af6e605289d739f6654d", "message": "fix (build): use gradle to resolve all runtime classpath for facades\n\nThe :moduleClasses task wasn't sufficient to get all the dependencies of those classes on the classpath.\n\nThis replaces it with a gradle Platform which depends on all those module subprojects.\n\nFixes #4014.", "committedDate": "2020-12-28T17:06:37Z", "type": "commit"}, {"oid": "ef739b4c18572fb61e61af6e605289d739f6654d", "url": "https://github.com/MovingBlocks/Terasology/commit/ef739b4c18572fb61e61af6e605289d739f6654d", "message": "fix (build): use gradle to resolve all runtime classpath for facades\n\nThe :moduleClasses task wasn't sufficient to get all the dependencies of those classes on the classpath.\n\nThis replaces it with a gradle Platform which depends on all those module subprojects.\n\nFixes #4014.", "committedDate": "2020-12-28T17:06:37Z", "type": "forcePushed"}, {"oid": "e8214339e905955cba910b1a60027abdd971e4bd", "url": "https://github.com/MovingBlocks/Terasology/commit/e8214339e905955cba910b1a60027abdd971e4bd", "message": "feat (build): make :modules:clean clean each module", "committedDate": "2020-12-28T17:41:25Z", "type": "commit"}, {"oid": "1f325e70ccde94689336768f683cc996fbe25bb2", "url": "https://github.com/MovingBlocks/Terasology/commit/1f325e70ccde94689336768f683cc996fbe25bb2", "message": "Merge remote-tracking branch 'origin/develop' into fix/transient-deps", "committedDate": "2020-12-28T19:07:52Z", "type": "commit"}, {"oid": "c15b05510567be0359349b730f2b1a3dd522c241", "url": "https://github.com/MovingBlocks/Terasology/commit/c15b05510567be0359349b730f2b1a3dd522c241", "message": "Merge remote-tracking branch 'origin/develop' into fix/transient-deps", "committedDate": "2020-12-29T20:32:18Z", "type": "commit"}, {"oid": "1f59aded808e4aedef56a5de5a04734936a771d2", "url": "https://github.com/MovingBlocks/Terasology/commit/1f59aded808e4aedef56a5de5a04734936a771d2", "message": "Merge remote-tracking branch 'origin/develop' into fix/transient-deps", "committedDate": "2021-01-02T20:43:06Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDkyMDQzNw==", "url": "https://github.com/MovingBlocks/Terasology/pull/4343#discussion_r550920437", "bodyText": "Would it be worth adding a quick comment here? I'm not even sure what \"platform\" even means here, although I can figure what the overall meaning is", "author": "Cervator", "createdAt": "2021-01-02T20:56:30Z", "path": "facades/PC/build.gradle.kts", "diffHunk": "@@ -92,6 +92,8 @@ dependencies {\n \n     // TODO: Consider whether we can move the CR dependency back here from the engine, where it is referenced from the main menu\n     implementation(group = \"org.terasology.crashreporter\", name = \"cr-terasology\", version = \"4.1.0\")\n+\n+    runtimeOnly(platform(project(\":modules\")))", "originalCommit": "1f59aded808e4aedef56a5de5a04734936a771d2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDkyMjU4OQ==", "url": "https://github.com/MovingBlocks/Terasology/pull/4343#discussion_r550922589", "bodyText": "can do", "author": "keturn", "createdAt": "2021-01-02T21:22:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDkyMDQzNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDkyMDY3NQ==", "url": "https://github.com/MovingBlocks/Terasology/pull/4343#discussion_r550920675", "bodyText": "Similarly here I fully expect that this works, but is allowing dependencies not a default state of some sort? That seems odd.", "author": "Cervator", "createdAt": "2021-01-02T20:59:01Z", "path": "modules/build.gradle.kts", "diffHunk": "@@ -0,0 +1,25 @@\n+// Copyright 2020 The Terasology Foundation\n+// SPDX-License-Identifier: Apache-2.0\n+\n+plugins {\n+    `java-platform`\n+}\n+\n+javaPlatform {\n+    allowDependencies()", "originalCommit": "1f59aded808e4aedef56a5de5a04734936a771d2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDkyMzkxMQ==", "url": "https://github.com/MovingBlocks/Terasology/pull/4343#discussion_r550923911", "bodyText": "That is the case! By default, gradle's java-platform is a thing that specifies version constraints, but consumers can depend on the platform without depending on everything in it.\nthat scenario probably looks more like:\ndependencies {\n    implementation(platform(\"com.example.foo:foo-framework:3\"))\n    implementation(\"com.example.foo:foo-core\")\n    implementation(\"com.example.foo:foo-http-server\")\n}\nto say \"I need these things from Foo Framework v3, make sure all versions are consistent with what they've published as v3 of that platform.\"\nIn order to say this platform depends on things we have to explicitly enable set this flag.", "author": "keturn", "createdAt": "2021-01-02T21:38:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDkyMDY3NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDkyMDc5Mw==", "url": "https://github.com/MovingBlocks/Terasology/pull/4343#discussion_r550920793", "bodyText": "I figure this builds the runtime classpath so all the module jars are available to the engine. this can be used to refer to a whole project level in Gradle, so to say?\nThis reminds me of that old idea to make the PC facade have a compile dependency on all the modules, to have them for sure get built when you run the game. Although at the cost of not being able to launch without every single module working, and maybe at a risk to get weird dependencies written into the binaries published to Artifactory.", "author": "Cervator", "createdAt": "2021-01-02T21:01:01Z", "path": "modules/build.gradle.kts", "diffHunk": "@@ -0,0 +1,25 @@\n+// Copyright 2020 The Terasology Foundation\n+// SPDX-License-Identifier: Apache-2.0\n+\n+plugins {\n+    `java-platform`\n+}\n+\n+javaPlatform {\n+    allowDependencies()\n+}\n+\n+dependencies {\n+    // This platform depends on each of its subprojects.\n+    subprojects {\n+        runtime(this)", "originalCommit": "1f59aded808e4aedef56a5de5a04734936a771d2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDkzMjA2OQ==", "url": "https://github.com/MovingBlocks/Terasology/pull/4343#discussion_r550932069", "bodyText": "this is given by the closest enclosing scope; it's the project that subprojects is iterating through. (the hints added by IntelliJ make this clearer when reading it in the IDE)\n\nmake the PC facade have a compile dependency on all the modules\n\nYes, that's exactly what is happening when the facade depends on the platform.\n\nat the cost of not being able to launch without every single module working\n\nI think we already sacrificed that ability a while ago?\nTest plan:\n\ngroovyw recurse JoshariasSurvival\nadd some compilation error to EdibileFlora's FillingModifierSystem\ngradlew game --continue\n\n:modules:EdibleFlora:compileJava fails\n\n\n\nI think because the game task depends on the moduleClasses task.\nI haven't yet come across a gradle way to always attempt to rebuild dependency subprojects if their sources changed but also soft-fail and try to run subsequent steps despite that. You can --continue, but I think that only makes it keep going on independent parts of the dependency tree, not excuse a missing dependency.", "author": "keturn", "createdAt": "2021-01-02T23:20:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDkyMDc5Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDkzMzk1OQ==", "url": "https://github.com/MovingBlocks/Terasology/pull/4343#discussion_r550933959", "bodyText": "get weird dependencies written into the binaries published to Artifactory.\n\nyes, if you publish a jar of the PC facade while you have subprojects present in /modules/, that would include things we probably don't want included.\nIs that a thing that happens? Does anything publish facade that's not in a clean workspace made explicitly for that purpose?\nIf so, then yeah, we'll have to add more separation so this local workspace state isn't confused with what we want to publish to the world. I hadn't imagined it was used that way.", "author": "keturn", "createdAt": "2021-01-02T23:46:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDkyMDc5Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDk0MDg3OQ==", "url": "https://github.com/MovingBlocks/Terasology/pull/4343#discussion_r550940879", "bodyText": "Gradle will always hit the issues, yep, IntelliJ has had a tendency in the past to skip errors if they're in something the run config doesn't care about. I'm not sure about that now since we're having some other weird issues there from time to time :-)", "author": "Cervator", "createdAt": "2021-01-03T01:18:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDkyMDc5Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDk0NzU3OQ==", "url": "https://github.com/MovingBlocks/Terasology/pull/4343#discussion_r550947579", "bodyText": "if you publish a jar of the PC facade ...\n\nI didn't see this comment earlier while posting my own for some reason. No, that isn't done anywhere at the moment. And any sort of test-publishing we might do locally surely should target something like the Nanoware test repos in Artifactory.\nIt is good to know though, in case we get creative and weird in the future. One idea that floated around was to build modules in an actual full engine workspace, rather than the minified single-module workspace we run in Jenkins right now. Even that in theory shouldn't hit it - since that should just publish the module, not the facade.\nSo - not worried about it. May be worth highlighting with a comment perhaps :-)", "author": "Cervator", "createdAt": "2021-01-03T02:50:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDkyMDc5Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDkyMTA4OA==", "url": "https://github.com/MovingBlocks/Terasology/pull/4343#discussion_r550921088", "bodyText": "Again understanding what this does, but cleanPlatform throws me off naming-wise. Is it almost like \"cleanPlatform\" would really be the task name? But since you want :modules:clean to work then the task name just remains \"clean\"\nWould something like cleanAllModules and cleanAllModules.dependsOn(... do the same thing but be clearer in naming?", "author": "Cervator", "createdAt": "2021-01-02T21:05:02Z", "path": "modules/build.gradle.kts", "diffHunk": "@@ -0,0 +1,25 @@\n+// Copyright 2020 The Terasology Foundation\n+// SPDX-License-Identifier: Apache-2.0\n+\n+plugins {\n+    `java-platform`\n+}\n+\n+javaPlatform {\n+    allowDependencies()\n+}\n+\n+dependencies {\n+    // This platform depends on each of its subprojects.\n+    subprojects {\n+        runtime(this)\n+    }\n+}\n+\n+// Allows using :modules:clean as a shortcut for running clean in each module.\n+tasks.named(\"clean\").configure {\n+    val cleanPlatform = this", "originalCommit": "1f59aded808e4aedef56a5de5a04734936a771d2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDkzMjIxNQ==", "url": "https://github.com/MovingBlocks/Terasology/pull/4343#discussion_r550932215", "bodyText": "cleanPlatform here is a local variable so I can use it below after this has been shadowed by the subproject. It's not renaming any tasks.", "author": "keturn", "createdAt": "2021-01-02T23:23:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDkyMTA4OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDkzMjUwOQ==", "url": "https://github.com/MovingBlocks/Terasology/pull/4343#discussion_r550932509", "bodyText": "Oh yes, I got that part. Thus the \"almost like\" \ud83d\ude01\nLike in the abstract this class could as well have been called \"cleanPlatform\" or \"cleanAllModules\" - plain \"cleanPlatform\" just throws me off as a variable name the way it gets used, but that's very minor and probably just me \ud83d\udc4d", "author": "Cervator", "createdAt": "2021-01-02T23:26:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDkyMTA4OA=="}], "type": "inlineReview"}, {"oid": "f383cb13f6c9ecf972c1e3532e24c1aadcb5b08c", "url": "https://github.com/MovingBlocks/Terasology/commit/f383cb13f6c9ecf972c1e3532e24c1aadcb5b08c", "message": "chore (build): the dependency on modules is for local dev builds", "committedDate": "2021-01-03T00:00:43Z", "type": "commit"}]}