{"pr_number": 3871, "pr_title": "More Gradle: now with makeshift release management! Ready for v3.0.0", "pr_createdAt": "2020-03-30T06:57:05Z", "pr_url": "https://github.com/MovingBlocks/Terasology/pull/3871", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTE3ODUzMQ==", "url": "https://github.com/MovingBlocks/Terasology/pull/3871#discussion_r401178531", "bodyText": "I'm wondering whether we should start to scope the properties in the gradle builds, similar to what most plugins to. This would become terasology.publishRepo then...", "author": "skaldarnar", "createdAt": "2020-03-31T20:00:39Z", "path": "config/gradle/publish.gradle", "diffHunk": "@@ -17,16 +17,45 @@ publishing {\n                 maven {\n                     name = 'TerasologyOrg'\n \n-                    def repoViaEnv = System.getenv()[\"PUBLISH_REPO\"]\n                     if (rootProject.hasProperty(\"publishRepo\")) {", "originalCommit": "ba1eb808bcf65ae03f59197310db1dc30350fd7c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTMyNzEzMQ==", "url": "https://github.com/MovingBlocks/Terasology/pull/3871#discussion_r401327131", "bodyText": "Had not thought about that before. Even in a plain build file, rather than a plugin? I've been curious if some of our logic might go better in a plugin, where it would make all kinds of sense, since then you'd probably use neato little blocks to configure it.", "author": "Cervator", "createdAt": "2020-04-01T02:53:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTE3ODUzMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTE4NTM2OQ==", "url": "https://github.com/MovingBlocks/Terasology/pull/3871#discussion_r401185369", "bodyText": "The whole logic in here boils down to just this, doesn't it?\nif (isMaster(maybeGitBranch) && !shouldBypassModuleRelease()) {\n\tdeducedPublishRepo += \"-release-local\"\n} else {\n\tdeducedPublishRepo += \"-snapshot-local\"\n}\nI think with the two additional functions this code is really readable, and the nesting is reduced.\ndef isMaster(gitBranch) {\n  return gitBranch != null && gitBranch != \"\" && gitBranch.equals(\"master\");\n}\n\ndef shouldBypassModuleRelease() {\n  return project.hasProperty(\"bypassModuleReleaseManagement\") && \n\tbypassModuleReleaseManagement == \"true\";\n}", "author": "skaldarnar", "createdAt": "2020-03-31T20:12:52Z", "path": "config/gradle/publish.gradle", "diffHunk": "@@ -17,16 +17,45 @@ publishing {\n                 maven {\n                     name = 'TerasologyOrg'\n \n-                    def repoViaEnv = System.getenv()[\"PUBLISH_REPO\"]\n                     if (rootProject.hasProperty(\"publishRepo\")) {\n+                        // This first option is good for local testing, you can set a full explicit target repo in gradle.properties\n                         url = \"http://artifactory.terasology.org/artifactory/$publishRepo\"\n-                        println \"Changing PUBLISH repoKey set via property to $publishRepo\"\n-                    } else if (repoViaEnv != null && repoViaEnv != \"\") {\n-                        url = \"http://artifactory.terasology.org/artifactory/$repoViaEnv\"\n-                        println \"Changing PUBLISH repoKey set via env var to $repoViaEnv\"\n+                        println \"Changing PUBLISH repoKey set via Gradle property to $publishRepo\"\n                     } else {\n-                        url = 'http://artifactory.terasology.org/artifactory/terasology-snapshot-local'\n-                        println \"PUBLISH repoKey is terasology-snapshot-local (default value)\"\n+                        // In this case we are going to fletch the publish repo together from a few things\n+                        // First if we have an override from the environment to use a different target publish org\n+                        String deducedPublishRepo = System.getenv()[\"PUBLISH_ORG\"]\n+                        if (deducedPublishRepo == null || deducedPublishRepo == \"\") {\n+                            // If not then default\n+                            deducedPublishRepo = \"terasology\"\n+                        }\n+                        String releaseRepoFragment = \"-release-local\"\n+                        String snapshotRepoFragment = \"-snapshot-local\"\n+\n+                        // Secondly we're going to find out if we're doing a release or a snapshot - this gets a little more complicated\n+                        String gitBranch = System.getenv()[\"BRANCH_NAME\"]\n+                        if (gitBranch != null && gitBranch != \"\" && gitBranch.equals(\"master\")) {\n+                            // Okay we're in an environment where a branch name is set to 'master' so we might be doing a release\n+                            // This is the funny part. Modules aren't ready globally to accept master branch == release, so check a prop that defaults to bypass\n+                            if (project.hasProperty(\"bypassModuleReleaseManagement\")) {\n+                                if (bypassModuleReleaseManagement == \"true\") {\n+                                    println \"Release management not enabled for \" + project.name + \", using snapshot repo despite building 'master' branch\"\n+                                    deducedPublishRepo += snapshotRepoFragment\n+                                } else {\n+                                    println \"Release management *is* enabled for \" + project.name + \", using release repo since building 'master' branch\"\n+                                    deducedPublishRepo += releaseRepoFragment\n+                                }\n+                            } else {\n+                                println \"We're working on a 'master' branch with defaults so using the release publish repo\"\n+                                deducedPublishRepo += releaseRepoFragment\n+                            }\n+                        } else {\n+                            // No master branch so we for sure are just doing snapshots\n+                            println \"We're not working with a branch name set that's 'master' so assuming we're publishing snapshots\"\n+                            deducedPublishRepo += \"-snapshot-local\"\n+                        }", "originalCommit": "ba1eb808bcf65ae03f59197310db1dc30350fd7c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTE4NjI4MQ==", "url": "https://github.com/MovingBlocks/Terasology/pull/3871#discussion_r401186281", "bodyText": "This would loose a couple of console lines, but overall the structure in the build file is more comprehensible imho.", "author": "skaldarnar", "createdAt": "2020-03-31T20:14:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTE4NTM2OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTMzNzA5MQ==", "url": "https://github.com/MovingBlocks/Terasology/pull/3871#discussion_r401337091", "bodyText": "Thank you! I had even more logic madness in there while trying to find a solution that would cover all the scenarios, this was actually an already boiled down version, but closing in on 2 am was not letting me see clearly in shrinking it further. This is way cleaner! Don't need the logging now that it tests out fine :-)", "author": "Cervator", "createdAt": "2020-04-01T03:34:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTE4NTM2OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTE4NTczNg==", "url": "https://github.com/MovingBlocks/Terasology/pull/3871#discussion_r401185736", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                        deducedPublishRepo += \"-snapshot-local\"\n          \n          \n            \n                                        deducedPublishRepo += snapshotRepoFragment", "author": "skaldarnar", "createdAt": "2020-03-31T20:13:32Z", "path": "config/gradle/publish.gradle", "diffHunk": "@@ -17,16 +17,45 @@ publishing {\n                 maven {\n                     name = 'TerasologyOrg'\n \n-                    def repoViaEnv = System.getenv()[\"PUBLISH_REPO\"]\n                     if (rootProject.hasProperty(\"publishRepo\")) {\n+                        // This first option is good for local testing, you can set a full explicit target repo in gradle.properties\n                         url = \"http://artifactory.terasology.org/artifactory/$publishRepo\"\n-                        println \"Changing PUBLISH repoKey set via property to $publishRepo\"\n-                    } else if (repoViaEnv != null && repoViaEnv != \"\") {\n-                        url = \"http://artifactory.terasology.org/artifactory/$repoViaEnv\"\n-                        println \"Changing PUBLISH repoKey set via env var to $repoViaEnv\"\n+                        println \"Changing PUBLISH repoKey set via Gradle property to $publishRepo\"\n                     } else {\n-                        url = 'http://artifactory.terasology.org/artifactory/terasology-snapshot-local'\n-                        println \"PUBLISH repoKey is terasology-snapshot-local (default value)\"\n+                        // In this case we are going to fletch the publish repo together from a few things\n+                        // First if we have an override from the environment to use a different target publish org\n+                        String deducedPublishRepo = System.getenv()[\"PUBLISH_ORG\"]\n+                        if (deducedPublishRepo == null || deducedPublishRepo == \"\") {\n+                            // If not then default\n+                            deducedPublishRepo = \"terasology\"\n+                        }\n+                        String releaseRepoFragment = \"-release-local\"\n+                        String snapshotRepoFragment = \"-snapshot-local\"\n+\n+                        // Secondly we're going to find out if we're doing a release or a snapshot - this gets a little more complicated\n+                        String gitBranch = System.getenv()[\"BRANCH_NAME\"]\n+                        if (gitBranch != null && gitBranch != \"\" && gitBranch.equals(\"master\")) {\n+                            // Okay we're in an environment where a branch name is set to 'master' so we might be doing a release\n+                            // This is the funny part. Modules aren't ready globally to accept master branch == release, so check a prop that defaults to bypass\n+                            if (project.hasProperty(\"bypassModuleReleaseManagement\")) {\n+                                if (bypassModuleReleaseManagement == \"true\") {\n+                                    println \"Release management not enabled for \" + project.name + \", using snapshot repo despite building 'master' branch\"\n+                                    deducedPublishRepo += snapshotRepoFragment\n+                                } else {\n+                                    println \"Release management *is* enabled for \" + project.name + \", using release repo since building 'master' branch\"\n+                                    deducedPublishRepo += releaseRepoFragment\n+                                }\n+                            } else {\n+                                println \"We're working on a 'master' branch with defaults so using the release publish repo\"\n+                                deducedPublishRepo += releaseRepoFragment\n+                            }\n+                        } else {\n+                            // No master branch so we for sure are just doing snapshots\n+                            println \"We're not working with a branch name set that's 'master' so assuming we're publishing snapshots\"\n+                            deducedPublishRepo += \"-snapshot-local\"", "originalCommit": "ba1eb808bcf65ae03f59197310db1dc30350fd7c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTE4ODYyOQ==", "url": "https://github.com/MovingBlocks/Terasology/pull/3871#discussion_r401188629", "bodyText": "Heavyly in favor of git tags, as most modules don't have complicated branching going on anyways. But you're right, should not be done in this PR, and needs some proper thoughtwork to figure out details and edge cases...", "author": "skaldarnar", "createdAt": "2020-03-31T20:18:28Z", "path": "modules/BiomesAPI/build.gradle", "diffHunk": "@@ -35,17 +25,25 @@ buildscript {\n     }\n }\n \n-// Handle some logic related to where what is\n-sourceSets {\n-    main.java.outputDir = new File(\"$buildDir/classes\")\n-    test.java.outputDir = new File(\"$buildDir/testClasses\")\n-}\n-JavaPluginConvention convention = project.getConvention().getPlugin(JavaPluginConvention.class);\n-SourceSet mainSourceSet = convention.getSourceSets().getByName(\"main\");\n+import groovy.json.JsonSlurper\n+import org.reflections.Reflections\n+import org.reflections.util.FilterBuilder\n+import org.reflections.scanners.SubTypesScanner\n+import org.reflections.scanners.TypeAnnotationsScanner\n+import org.reflections.util.ConfigurationBuilder\n \n ext {\n     // Read environment variables, including variables passed by jenkins continuous integration server\n     env = System.getenv()\n+\n+    // This is a fun one ... when versions switched to dynamic -SNAPSHOT or not based on branch existing modules using `master` would suddenly try publishing releases\n+    // This won't work without additionally doing constant version bumps (perhaps via Git tags) - but too much work to switch around all modules at once\n+    // Complicating things more the use of publish.gradle to centralize logic means modules and engine bits are treated the same, yet we need to vary modules\n+    // Temporary workaround: default modules to bypass release management: master branch builds will still make snapshot builds for the snapshot repo\n+    // If a module actually wants release management simply include `\"isReleaseManaged\" : true` in module.txt - this is needed for the engine repo embedded modules\n+    // One option would be to slowly convert modulespace to default to a `develop` + `master` setup living in harmony with associated automation/github tweaks\n+    // Alternatively one more round of refactoring could switch to Git tags, a single `master` branch, and possible other things to help match snaps/PR builds somehow?", "originalCommit": "ba1eb808bcf65ae03f59197310db1dc30350fd7c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTE4OTUxMw==", "url": "https://github.com/MovingBlocks/Terasology/pull/3871#discussion_r401189513", "bodyText": "I don't like the fact that the generic module.txt now holds information specific to our build system. As it is not officially documented anywhere, I guess its not much of a deal. Nevertheless, I would like to get rid of it asap.", "author": "skaldarnar", "createdAt": "2020-03-31T20:19:50Z", "path": "modules/BiomesAPI/build.gradle", "diffHunk": "@@ -35,17 +25,25 @@ buildscript {\n     }\n }\n \n-// Handle some logic related to where what is\n-sourceSets {\n-    main.java.outputDir = new File(\"$buildDir/classes\")\n-    test.java.outputDir = new File(\"$buildDir/testClasses\")\n-}\n-JavaPluginConvention convention = project.getConvention().getPlugin(JavaPluginConvention.class);\n-SourceSet mainSourceSet = convention.getSourceSets().getByName(\"main\");\n+import groovy.json.JsonSlurper\n+import org.reflections.Reflections\n+import org.reflections.util.FilterBuilder\n+import org.reflections.scanners.SubTypesScanner\n+import org.reflections.scanners.TypeAnnotationsScanner\n+import org.reflections.util.ConfigurationBuilder\n \n ext {\n     // Read environment variables, including variables passed by jenkins continuous integration server\n     env = System.getenv()\n+\n+    // This is a fun one ... when versions switched to dynamic -SNAPSHOT or not based on branch existing modules using `master` would suddenly try publishing releases\n+    // This won't work without additionally doing constant version bumps (perhaps via Git tags) - but too much work to switch around all modules at once\n+    // Complicating things more the use of publish.gradle to centralize logic means modules and engine bits are treated the same, yet we need to vary modules\n+    // Temporary workaround: default modules to bypass release management: master branch builds will still make snapshot builds for the snapshot repo\n+    // If a module actually wants release management simply include `\"isReleaseManaged\" : true` in module.txt - this is needed for the engine repo embedded modules", "originalCommit": "ba1eb808bcf65ae03f59197310db1dc30350fd7c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTMzMDQ0OA==", "url": "https://github.com/MovingBlocks/Terasology/pull/3871#discussion_r401330448", "bodyText": "Yep, it is a workaround for sure. Lets me get through this big release without an even bigger overhaul. It can be an undocced feature likely never to be used in module land as we can hopefully finish improving things soon.", "author": "Cervator", "createdAt": "2020-04-01T03:06:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTE4OTUxMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTE4OTk4Mw==", "url": "https://github.com/MovingBlocks/Terasology/pull/3871#discussion_r401189983", "bodyText": "Why no null check for the branch name here? Shouldn't this be a similar check to isMaster(...) as proposed above?", "author": "skaldarnar", "createdAt": "2020-03-31T20:20:40Z", "path": "modules/BiomesAPI/build.gradle", "diffHunk": "@@ -69,11 +67,44 @@ for (dependency in moduleConfig.dependencies) {\n // Gradle uses the magic version variable when creating the jar name (unless explicitly set somewhere else I guess)\n version = moduleConfig.version\n \n+import org.gradle.internal.logging.text.StyledTextOutputFactory\n+import static org.gradle.internal.logging.text.StyledTextOutput.Style\n+\n+// The only case in which we make module non-snapshots is if release management is enabled and BRANCH_NAME is \"master\"\n+if (moduleConfig.isReleaseManaged && env.BRANCH_NAME == \"master\") {", "originalCommit": "ba1eb808bcf65ae03f59197310db1dc30350fd7c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTMzMjM1OQ==", "url": "https://github.com/MovingBlocks/Terasology/pull/3871#discussion_r401332359", "bodyText": "Mixture of \"way too deep into the rabbit warren, just want to finish!\" and from this spot actually being null safe since == rather than equals :-)\nWhy is the other place null checking and using String.equals ? Rabbit holes and 2 am coding ;-)", "author": "Cervator", "createdAt": "2020-04-01T03:14:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTE4OTk4Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTE5MTAzNA==", "url": "https://github.com/MovingBlocks/Terasology/pull/3871#discussion_r401191034", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                if (version.contains(\"-SNAPSHOT\")) {\n          \n          \n            \n                if (version.endsWith(\"-SNAPSHOT\")) {", "author": "skaldarnar", "createdAt": "2020-03-31T20:22:23Z", "path": "modules/BiomesAPI/build.gradle", "diffHunk": "@@ -69,11 +67,44 @@ for (dependency in moduleConfig.dependencies) {\n // Gradle uses the magic version variable when creating the jar name (unless explicitly set somewhere else I guess)\n version = moduleConfig.version\n \n+import org.gradle.internal.logging.text.StyledTextOutputFactory\n+import static org.gradle.internal.logging.text.StyledTextOutput.Style\n+\n+// The only case in which we make module non-snapshots is if release management is enabled and BRANCH_NAME is \"master\"\n+if (moduleConfig.isReleaseManaged && env.BRANCH_NAME == \"master\") {\n+    // This is mildly awkward since we need to bypass by default, yet if release management is on (true) then we set the bypass to false ..\n+    ext.bypassModuleReleaseManagement = false\n+    if (version.contains(\"-SNAPSHOT\")) {", "originalCommit": "ba1eb808bcf65ae03f59197310db1dc30350fd7c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTMzNzMzNA==", "url": "https://github.com/MovingBlocks/Terasology/pull/3871#discussion_r401337334", "bodyText": "Applied this, thanks! Actually cleaned it up a bit more yet now that I can brain again.", "author": "Cervator", "createdAt": "2020-04-01T03:35:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTE5MTAzNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTE5MTM5Mw==", "url": "https://github.com/MovingBlocks/Terasology/pull/3871#discussion_r401191393", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                if (!version.contains(\"-SNAPSHOT\")) {\n          \n          \n            \n                if (!version.endsWith(\"-SNAPSHOT\")) {", "author": "skaldarnar", "createdAt": "2020-03-31T20:23:02Z", "path": "modules/BiomesAPI/build.gradle", "diffHunk": "@@ -69,11 +67,44 @@ for (dependency in moduleConfig.dependencies) {\n // Gradle uses the magic version variable when creating the jar name (unless explicitly set somewhere else I guess)\n version = moduleConfig.version\n \n+import org.gradle.internal.logging.text.StyledTextOutputFactory\n+import static org.gradle.internal.logging.text.StyledTextOutput.Style\n+\n+// The only case in which we make module non-snapshots is if release management is enabled and BRANCH_NAME is \"master\"\n+if (moduleConfig.isReleaseManaged && env.BRANCH_NAME == \"master\") {\n+    // This is mildly awkward since we need to bypass by default, yet if release management is on (true) then we set the bypass to false ..\n+    ext.bypassModuleReleaseManagement = false\n+    if (version.contains(\"-SNAPSHOT\")) {\n+        version -= \"-SNAPSHOT\"\n+        def out = services.get(StyledTextOutputFactory).create(\"an-ouput\")\n+        out.withStyle(Style.FailureHeader).println(\"WARNING: Module \" + project.name + \" is explicitly versioned as a snapshot in module.txt, please remove '-SNAPSHOT'\")\n+    }\n+} else {\n+    if (!version.contains(\"-SNAPSHOT\")) {", "originalCommit": "ba1eb808bcf65ae03f59197310db1dc30350fd7c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTE5MjM0Mw==", "url": "https://github.com/MovingBlocks/Terasology/pull/3871#discussion_r401192343", "bodyText": "see above (isMaster(...) check).", "author": "skaldarnar", "createdAt": "2020-03-31T20:24:36Z", "path": "modules/BuilderSampleGameplay/build.gradle", "diffHunk": "@@ -69,11 +67,44 @@ for (dependency in moduleConfig.dependencies) {\n // Gradle uses the magic version variable when creating the jar name (unless explicitly set somewhere else I guess)\n version = moduleConfig.version\n \n+import org.gradle.internal.logging.text.StyledTextOutputFactory\n+import static org.gradle.internal.logging.text.StyledTextOutput.Style\n+\n+// The only case in which we make module non-snapshots is if release management is enabled and BRANCH_NAME is \"master\"\n+if (moduleConfig.isReleaseManaged && env.BRANCH_NAME == \"master\") {", "originalCommit": "ba1eb808bcf65ae03f59197310db1dc30350fd7c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTE5MjQ1OA==", "url": "https://github.com/MovingBlocks/Terasology/pull/3871#discussion_r401192458", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                if (version.contains(\"-SNAPSHOT\")) {\n          \n          \n            \n                if (version.endsWith(\"-SNAPSHOT\")) {", "author": "skaldarnar", "createdAt": "2020-03-31T20:24:48Z", "path": "modules/BuilderSampleGameplay/build.gradle", "diffHunk": "@@ -69,11 +67,44 @@ for (dependency in moduleConfig.dependencies) {\n // Gradle uses the magic version variable when creating the jar name (unless explicitly set somewhere else I guess)\n version = moduleConfig.version\n \n+import org.gradle.internal.logging.text.StyledTextOutputFactory\n+import static org.gradle.internal.logging.text.StyledTextOutput.Style\n+\n+// The only case in which we make module non-snapshots is if release management is enabled and BRANCH_NAME is \"master\"\n+if (moduleConfig.isReleaseManaged && env.BRANCH_NAME == \"master\") {\n+    // This is mildly awkward since we need to bypass by default, yet if release management is on (true) then we set the bypass to false ..\n+    ext.bypassModuleReleaseManagement = false\n+    if (version.contains(\"-SNAPSHOT\")) {", "originalCommit": "ba1eb808bcf65ae03f59197310db1dc30350fd7c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTE5MjU3MQ==", "url": "https://github.com/MovingBlocks/Terasology/pull/3871#discussion_r401192571", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                if (!version.contains(\"-SNAPSHOT\")) {\n          \n          \n            \n                if (!version.endsWith(\"-SNAPSHOT\")) {", "author": "skaldarnar", "createdAt": "2020-03-31T20:25:00Z", "path": "modules/BuilderSampleGameplay/build.gradle", "diffHunk": "@@ -69,11 +67,44 @@ for (dependency in moduleConfig.dependencies) {\n // Gradle uses the magic version variable when creating the jar name (unless explicitly set somewhere else I guess)\n version = moduleConfig.version\n \n+import org.gradle.internal.logging.text.StyledTextOutputFactory\n+import static org.gradle.internal.logging.text.StyledTextOutput.Style\n+\n+// The only case in which we make module non-snapshots is if release management is enabled and BRANCH_NAME is \"master\"\n+if (moduleConfig.isReleaseManaged && env.BRANCH_NAME == \"master\") {\n+    // This is mildly awkward since we need to bypass by default, yet if release management is on (true) then we set the bypass to false ..\n+    ext.bypassModuleReleaseManagement = false\n+    if (version.contains(\"-SNAPSHOT\")) {\n+        version -= \"-SNAPSHOT\"\n+        def out = services.get(StyledTextOutputFactory).create(\"an-ouput\")\n+        out.withStyle(Style.FailureHeader).println(\"WARNING: Module \" + project.name + \" is explicitly versioned as a snapshot in module.txt, please remove '-SNAPSHOT'\")\n+    }\n+} else {\n+    if (!version.contains(\"-SNAPSHOT\")) {", "originalCommit": "ba1eb808bcf65ae03f59197310db1dc30350fd7c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTE5Mjc3MQ==", "url": "https://github.com/MovingBlocks/Terasology/pull/3871#discussion_r401192771", "bodyText": "see above", "author": "skaldarnar", "createdAt": "2020-03-31T20:25:24Z", "path": "modules/Core/build.gradle", "diffHunk": "@@ -69,11 +67,44 @@ for (dependency in moduleConfig.dependencies) {\n // Gradle uses the magic version variable when creating the jar name (unless explicitly set somewhere else I guess)\n version = moduleConfig.version\n \n+import org.gradle.internal.logging.text.StyledTextOutputFactory\n+import static org.gradle.internal.logging.text.StyledTextOutput.Style\n+\n+// The only case in which we make module non-snapshots is if release management is enabled and BRANCH_NAME is \"master\"\n+if (moduleConfig.isReleaseManaged && env.BRANCH_NAME == \"master\") {", "originalCommit": "ba1eb808bcf65ae03f59197310db1dc30350fd7c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTE5Mjg0OA==", "url": "https://github.com/MovingBlocks/Terasology/pull/3871#discussion_r401192848", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                if (version.contains(\"-SNAPSHOT\")) {\n          \n          \n            \n                if (version.endsWith(\"-SNAPSHOT\")) {", "author": "skaldarnar", "createdAt": "2020-03-31T20:25:33Z", "path": "modules/Core/build.gradle", "diffHunk": "@@ -69,11 +67,44 @@ for (dependency in moduleConfig.dependencies) {\n // Gradle uses the magic version variable when creating the jar name (unless explicitly set somewhere else I guess)\n version = moduleConfig.version\n \n+import org.gradle.internal.logging.text.StyledTextOutputFactory\n+import static org.gradle.internal.logging.text.StyledTextOutput.Style\n+\n+// The only case in which we make module non-snapshots is if release management is enabled and BRANCH_NAME is \"master\"\n+if (moduleConfig.isReleaseManaged && env.BRANCH_NAME == \"master\") {\n+    // This is mildly awkward since we need to bypass by default, yet if release management is on (true) then we set the bypass to false ..\n+    ext.bypassModuleReleaseManagement = false\n+    if (version.contains(\"-SNAPSHOT\")) {", "originalCommit": "ba1eb808bcf65ae03f59197310db1dc30350fd7c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTE5MjkzMg==", "url": "https://github.com/MovingBlocks/Terasology/pull/3871#discussion_r401192932", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                if (!version.contains(\"-SNAPSHOT\")) {\n          \n          \n            \n                if (!version.endsWith(\"-SNAPSHOT\")) {", "author": "skaldarnar", "createdAt": "2020-03-31T20:25:43Z", "path": "modules/Core/build.gradle", "diffHunk": "@@ -69,11 +67,44 @@ for (dependency in moduleConfig.dependencies) {\n // Gradle uses the magic version variable when creating the jar name (unless explicitly set somewhere else I guess)\n version = moduleConfig.version\n \n+import org.gradle.internal.logging.text.StyledTextOutputFactory\n+import static org.gradle.internal.logging.text.StyledTextOutput.Style\n+\n+// The only case in which we make module non-snapshots is if release management is enabled and BRANCH_NAME is \"master\"\n+if (moduleConfig.isReleaseManaged && env.BRANCH_NAME == \"master\") {\n+    // This is mildly awkward since we need to bypass by default, yet if release management is on (true) then we set the bypass to false ..\n+    ext.bypassModuleReleaseManagement = false\n+    if (version.contains(\"-SNAPSHOT\")) {\n+        version -= \"-SNAPSHOT\"\n+        def out = services.get(StyledTextOutputFactory).create(\"an-ouput\")\n+        out.withStyle(Style.FailureHeader).println(\"WARNING: Module \" + project.name + \" is explicitly versioned as a snapshot in module.txt, please remove '-SNAPSHOT'\")\n+    }\n+} else {\n+    if (!version.contains(\"-SNAPSHOT\")) {", "originalCommit": "ba1eb808bcf65ae03f59197310db1dc30350fd7c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTE5MzMwOQ==", "url": "https://github.com/MovingBlocks/Terasology/pull/3871#discussion_r401193309", "bodyText": "see above", "author": "skaldarnar", "createdAt": "2020-03-31T20:26:24Z", "path": "modules/CoreSampleGameplay/build.gradle", "diffHunk": "@@ -69,11 +67,44 @@ for (dependency in moduleConfig.dependencies) {\n // Gradle uses the magic version variable when creating the jar name (unless explicitly set somewhere else I guess)\n version = moduleConfig.version\n \n+import org.gradle.internal.logging.text.StyledTextOutputFactory\n+import static org.gradle.internal.logging.text.StyledTextOutput.Style\n+\n+// The only case in which we make module non-snapshots is if release management is enabled and BRANCH_NAME is \"master\"\n+if (moduleConfig.isReleaseManaged && env.BRANCH_NAME == \"master\") {", "originalCommit": "ba1eb808bcf65ae03f59197310db1dc30350fd7c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTE5MzQxNw==", "url": "https://github.com/MovingBlocks/Terasology/pull/3871#discussion_r401193417", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                if (version.contains(\"-SNAPSHOT\")) {\n          \n          \n            \n                if (version.endsWith(\"-SNAPSHOT\")) {", "author": "skaldarnar", "createdAt": "2020-03-31T20:26:37Z", "path": "modules/CoreSampleGameplay/build.gradle", "diffHunk": "@@ -69,11 +67,44 @@ for (dependency in moduleConfig.dependencies) {\n // Gradle uses the magic version variable when creating the jar name (unless explicitly set somewhere else I guess)\n version = moduleConfig.version\n \n+import org.gradle.internal.logging.text.StyledTextOutputFactory\n+import static org.gradle.internal.logging.text.StyledTextOutput.Style\n+\n+// The only case in which we make module non-snapshots is if release management is enabled and BRANCH_NAME is \"master\"\n+if (moduleConfig.isReleaseManaged && env.BRANCH_NAME == \"master\") {\n+    // This is mildly awkward since we need to bypass by default, yet if release management is on (true) then we set the bypass to false ..\n+    ext.bypassModuleReleaseManagement = false\n+    if (version.contains(\"-SNAPSHOT\")) {", "originalCommit": "ba1eb808bcf65ae03f59197310db1dc30350fd7c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTE5MzUxMQ==", "url": "https://github.com/MovingBlocks/Terasology/pull/3871#discussion_r401193511", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                if (!version.contains(\"-SNAPSHOT\")) {\n          \n          \n            \n                if (!version.endsWith(\"-SNAPSHOT\")) {", "author": "skaldarnar", "createdAt": "2020-03-31T20:26:46Z", "path": "modules/CoreSampleGameplay/build.gradle", "diffHunk": "@@ -69,11 +67,44 @@ for (dependency in moduleConfig.dependencies) {\n // Gradle uses the magic version variable when creating the jar name (unless explicitly set somewhere else I guess)\n version = moduleConfig.version\n \n+import org.gradle.internal.logging.text.StyledTextOutputFactory\n+import static org.gradle.internal.logging.text.StyledTextOutput.Style\n+\n+// The only case in which we make module non-snapshots is if release management is enabled and BRANCH_NAME is \"master\"\n+if (moduleConfig.isReleaseManaged && env.BRANCH_NAME == \"master\") {\n+    // This is mildly awkward since we need to bypass by default, yet if release management is on (true) then we set the bypass to false ..\n+    ext.bypassModuleReleaseManagement = false\n+    if (version.contains(\"-SNAPSHOT\")) {\n+        version -= \"-SNAPSHOT\"\n+        def out = services.get(StyledTextOutputFactory).create(\"an-ouput\")\n+        out.withStyle(Style.FailureHeader).println(\"WARNING: Module \" + project.name + \" is explicitly versioned as a snapshot in module.txt, please remove '-SNAPSHOT'\")\n+    }\n+} else {\n+    if (!version.contains(\"-SNAPSHOT\")) {", "originalCommit": "ba1eb808bcf65ae03f59197310db1dc30350fd7c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTE5MzY0OQ==", "url": "https://github.com/MovingBlocks/Terasology/pull/3871#discussion_r401193649", "bodyText": "see above", "author": "skaldarnar", "createdAt": "2020-03-31T20:26:56Z", "path": "templates/build.gradle", "diffHunk": "@@ -69,11 +67,44 @@ for (dependency in moduleConfig.dependencies) {\n // Gradle uses the magic version variable when creating the jar name (unless explicitly set somewhere else I guess)\n version = moduleConfig.version\n \n+import org.gradle.internal.logging.text.StyledTextOutputFactory\n+import static org.gradle.internal.logging.text.StyledTextOutput.Style\n+\n+// The only case in which we make module non-snapshots is if release management is enabled and BRANCH_NAME is \"master\"\n+if (moduleConfig.isReleaseManaged && env.BRANCH_NAME == \"master\") {", "originalCommit": "ba1eb808bcf65ae03f59197310db1dc30350fd7c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTE5MzcyNA==", "url": "https://github.com/MovingBlocks/Terasology/pull/3871#discussion_r401193724", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                if (version.contains(\"-SNAPSHOT\")) {\n          \n          \n            \n                if (version.endsWith(\"-SNAPSHOT\")) {", "author": "skaldarnar", "createdAt": "2020-03-31T20:27:05Z", "path": "templates/build.gradle", "diffHunk": "@@ -69,11 +67,44 @@ for (dependency in moduleConfig.dependencies) {\n // Gradle uses the magic version variable when creating the jar name (unless explicitly set somewhere else I guess)\n version = moduleConfig.version\n \n+import org.gradle.internal.logging.text.StyledTextOutputFactory\n+import static org.gradle.internal.logging.text.StyledTextOutput.Style\n+\n+// The only case in which we make module non-snapshots is if release management is enabled and BRANCH_NAME is \"master\"\n+if (moduleConfig.isReleaseManaged && env.BRANCH_NAME == \"master\") {\n+    // This is mildly awkward since we need to bypass by default, yet if release management is on (true) then we set the bypass to false ..\n+    ext.bypassModuleReleaseManagement = false\n+    if (version.contains(\"-SNAPSHOT\")) {", "originalCommit": "ba1eb808bcf65ae03f59197310db1dc30350fd7c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTE5Mzc5MQ==", "url": "https://github.com/MovingBlocks/Terasology/pull/3871#discussion_r401193791", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                if (!version.contains(\"-SNAPSHOT\")) {\n          \n          \n            \n                if (!version.endsWith(\"-SNAPSHOT\")) {", "author": "skaldarnar", "createdAt": "2020-03-31T20:27:14Z", "path": "templates/build.gradle", "diffHunk": "@@ -69,11 +67,44 @@ for (dependency in moduleConfig.dependencies) {\n // Gradle uses the magic version variable when creating the jar name (unless explicitly set somewhere else I guess)\n version = moduleConfig.version\n \n+import org.gradle.internal.logging.text.StyledTextOutputFactory\n+import static org.gradle.internal.logging.text.StyledTextOutput.Style\n+\n+// The only case in which we make module non-snapshots is if release management is enabled and BRANCH_NAME is \"master\"\n+if (moduleConfig.isReleaseManaged && env.BRANCH_NAME == \"master\") {\n+    // This is mildly awkward since we need to bypass by default, yet if release management is on (true) then we set the bypass to false ..\n+    ext.bypassModuleReleaseManagement = false\n+    if (version.contains(\"-SNAPSHOT\")) {\n+        version -= \"-SNAPSHOT\"\n+        def out = services.get(StyledTextOutputFactory).create(\"an-ouput\")\n+        out.withStyle(Style.FailureHeader).println(\"WARNING: Module \" + project.name + \" is explicitly versioned as a snapshot in module.txt, please remove '-SNAPSHOT'\")\n+    }\n+} else {\n+    if (!version.contains(\"-SNAPSHOT\")) {", "originalCommit": "ba1eb808bcf65ae03f59197310db1dc30350fd7c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTQyNjMzMw==", "url": "https://github.com/MovingBlocks/Terasology/pull/3871#discussion_r401426333", "bodyText": "What about a general approach like this (in the future): https://medium.com/@ungesehn/use-gitignore-for-gradle-task-excludes-e5d011e99f71\n.settings should be gitignores regardless of where in the file tree...", "author": "skaldarnar", "createdAt": "2020-04-01T08:02:03Z", "path": "facades/subprojects.gradle", "diffHunk": "@@ -1,9 +1,13 @@\n // This magically allows subdirs in this subproject to themselves become sub-subprojects in a proper tree structure\n new File(rootDir, 'facades').eachDir { possibleSubprojectDir ->\n-    def subprojectName = 'facades:' + possibleSubprojectDir.name\n-    println \"Processing facade $subprojectName, including it as a sub-project\"\n-    include subprojectName\n-    def subprojectPath = ':' + subprojectName\n-    def subproject = project(subprojectPath)\n-    subproject.projectDir = possibleSubprojectDir\n+    if (!possibleSubprojectDir.name.startsWith(\".\")) {", "originalCommit": "a5b1bf569c1c79f454a7cf07abf9f36f97d848e9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "18f895a719833f2c1e55b4ba60511deaec6baf3a", "url": "https://github.com/MovingBlocks/Terasology/commit/18f895a719833f2c1e55b4ba60511deaec6baf3a", "message": "Support bypassing artifact publishing and varying the target based on branch name\n\nChange env var\n\nConsole logging issue\n\nFixy", "committedDate": "2020-04-02T01:39:11Z", "type": "commit"}, {"oid": "e714a481d38996be80e9017ae8fae4775fbf1751", "url": "https://github.com/MovingBlocks/Terasology/commit/e714a481d38996be80e9017ae8fae4775fbf1751", "message": "Release v3.0.0", "committedDate": "2020-04-02T01:39:11Z", "type": "commit"}, {"oid": "39584a7c736ae48972e7351fc28840e865efef24", "url": "https://github.com/MovingBlocks/Terasology/commit/39584a7c736ae48972e7351fc28840e865efef24", "message": "Explicitly include javadoc (would otherwise not generate if not hitting publish)", "committedDate": "2020-04-02T01:39:11Z", "type": "commit"}, {"oid": "9e30d34e56a81e89e4e9339e2b68263f2769bdb6", "url": "https://github.com/MovingBlocks/Terasology/commit/9e30d34e56a81e89e4e9339e2b68263f2769bdb6", "message": "Makeshift release management for both engine components and modules\n\nAvoids having to manage -SNAPSHOT in code, instead it is deduced from the environment if a branch name is set (Jenkins)\n\nIf branch is master (and for modules if release management is opted into) then artifacts will be published to a release repo, otherwise to a snapshot repo\n\nRetains support for varying the target publish org in Artifactory so \"terasology\" vs \"nanoware\" for instance.", "committedDate": "2020-04-02T01:39:11Z", "type": "commit"}, {"oid": "d3e3cd03ce4178ed11cc2828ec4e5d29639bc429", "url": "https://github.com/MovingBlocks/Terasology/commit/d3e3cd03ce4178ed11cc2828ec4e5d29639bc429", "message": "Exclude any facade or meta module directories that start with . from detection (can happen in some IDEs)", "committedDate": "2020-04-02T01:39:11Z", "type": "commit"}, {"oid": "935895b9916afe4aaae7a81c903a2dfb990b1c0d", "url": "https://github.com/MovingBlocks/Terasology/commit/935895b9916afe4aaae7a81c903a2dfb990b1c0d", "message": "Cleanup from code review", "committedDate": "2020-04-02T01:39:11Z", "type": "commit"}, {"oid": "935895b9916afe4aaae7a81c903a2dfb990b1c0d", "url": "https://github.com/MovingBlocks/Terasology/commit/935895b9916afe4aaae7a81c903a2dfb990b1c0d", "message": "Cleanup from code review", "committedDate": "2020-04-02T01:39:11Z", "type": "forcePushed"}]}