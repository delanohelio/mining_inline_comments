{"pr_number": 4321, "pr_title": "fix!(BlockRegion): Rewrite of BlockRegion", "pr_createdAt": "2020-12-13T15:37:08Z", "pr_url": "https://github.com/MovingBlocks/Terasology/pull/4321", "timeline": [{"oid": "f4c91fb17ef764182b5bb43b8fd92b3f6d6d7219", "url": "https://github.com/MovingBlocks/Terasology/commit/f4c91fb17ef764182b5bb43b8fd92b3f6d6d7219", "message": "Config eclipse", "committedDate": "2020-12-13T14:54:27Z", "type": "commit"}, {"oid": "728e1a9fc001a77fed692d78716822cd92f57dda", "url": "https://github.com/MovingBlocks/Terasology/commit/728e1a9fc001a77fed692d78716822cd92f57dda", "message": "Modification BlockRegion intersection methods + tests", "committedDate": "2020-12-13T14:54:52Z", "type": "commit"}, {"oid": "d62a6e2ebe4050404433de5ad2fd82b054db60ea", "url": "https://github.com/MovingBlocks/Terasology/commit/d62a6e2ebe4050404433de5ad2fd82b054db60ea", "message": "Correct mistake in BlockRegion test", "committedDate": "2020-12-13T14:57:37Z", "type": "commit"}, {"oid": "ea81fe3dbd524e68e54342d7cbf4bfe08c5ad6f9", "url": "https://github.com/MovingBlocks/Terasology/commit/ea81fe3dbd524e68e54342d7cbf4bfe08c5ad6f9", "message": "Merge branch 'develop' of https://github.com/QuentinAndre11/Terasology into develop", "committedDate": "2020-12-13T16:21:52Z", "type": "commit"}, {"oid": "f490be68371e2bdc85d373880d00be177b51dccd", "url": "https://github.com/MovingBlocks/Terasology/commit/f490be68371e2bdc85d373880d00be177b51dccd", "message": "fixes PR", "committedDate": "2020-12-13T17:03:05Z", "type": "commit"}, {"oid": "eaaf9a92b4432e75959e5f9206a6d6ecf2d8b2ff", "url": "https://github.com/MovingBlocks/Terasology/commit/eaaf9a92b4432e75959e5f9206a6d6ecf2d8b2ff", "message": "fixes PR 2", "committedDate": "2020-12-13T17:21:54Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTk2ODY1NA==", "url": "https://github.com/MovingBlocks/Terasology/pull/4321#discussion_r541968654", "bodyText": "this isn't relevant to the PR", "author": "pollend", "createdAt": "2020-12-13T17:32:19Z", "path": "config/eclipse/Terasology.launch", "diffHunk": "@@ -1,17 +1,17 @@\n <?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"no\"?>\n <launchConfiguration type=\"org.eclipse.jdt.launching.localJavaApplication\">\n-<listAttribute key=\"org.eclipse.debug.core.MAPPED_RESOURCE_PATHS\">\n-<listEntry value=\"/PC/src/main/java/org/terasology/engine/Terasology.java\"/>\n-</listAttribute>\n-<listAttribute key=\"org.eclipse.debug.core.MAPPED_RESOURCE_TYPES\">\n-<listEntry value=\"1\"/>\n-</listAttribute>\n-<listAttribute key=\"org.eclipse.debug.ui.favoriteGroups\">\n-<listEntry value=\"org.eclipse.debug.ui.launchGroup.debug\"/>\n-<listEntry value=\"org.eclipse.debug.ui.launchGroup.run\"/>\n-</listAttribute>\n-<stringAttribute key=\"org.eclipse.jdt.launching.MAIN_TYPE\" value=\"org.terasology.engine.Terasology\"/>\n-<stringAttribute key=\"org.eclipse.jdt.launching.PROJECT_ATTR\" value=\"PC\"/>\n-<stringAttribute key=\"org.eclipse.jdt.launching.VM_ARGUMENTS\" value=\"-Xms256m -Xmx1024m\"/>\n-<stringAttribute key=\"org.eclipse.jdt.launching.WORKING_DIRECTORY\" value=\"${workspace_loc:PC}/../..\"/>\n+    <listAttribute key=\"org.eclipse.debug.core.MAPPED_RESOURCE_PATHS\">\n+        <listEntry value=\"/PC/src/main/java/org/terasology/engine/Terasology.java\"/>\n+    </listAttribute>\n+    <listAttribute key=\"org.eclipse.debug.core.MAPPED_RESOURCE_TYPES\">\n+        <listEntry value=\"1\"/>\n+    </listAttribute>\n+    <listAttribute key=\"org.eclipse.debug.ui.favoriteGroups\">\n+        <listEntry value=\"org.eclipse.debug.ui.launchGroup.debug\"/>\n+        <listEntry value=\"org.eclipse.debug.ui.launchGroup.run\"/>\n+    </listAttribute>\n+    <stringAttribute key=\"org.eclipse.jdt.launching.MAIN_TYPE\" value=\"org.terasology.engine.Terasology\"/>\n+    <stringAttribute key=\"org.eclipse.jdt.launching.PROJECT_ATTR\" value=\"PC\"/>\n+    <stringAttribute key=\"org.eclipse.jdt.launching.VM_ARGUMENTS\" value=\"-Xms256m -Xmx1024m\"/>\n+    <stringAttribute key=\"org.eclipse.jdt.launching.WORKING_DIRECTORY\" value=\"${workspace_loc:PC}/../..\"/>", "originalCommit": "eaaf9a92b4432e75959e5f9206a6d6ecf2d8b2ff", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "0f168f1699c4c72bbd0c71df5effd811c32d7208", "url": "https://github.com/MovingBlocks/Terasology/commit/0f168f1699c4c72bbd0c71df5effd811c32d7208", "message": "update block region bounds", "committedDate": "2020-12-13T21:34:59Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjAxMjY5MQ==", "url": "https://github.com/MovingBlocks/Terasology/pull/4321#discussion_r542012691", "bodyText": "@pollend Should those really be public? I'm a bit confused right now, as I thought we agreed on Slack with @4Denthusiast that we should ensure that invalid min/max combinations should throw exceptions. With these values publicly accessible we cannot guarantee that...", "author": "skaldarnar", "createdAt": "2020-12-13T21:47:10Z", "path": "engine/src/main/java/org/terasology/world/block/BlockRegion.java", "diffHunk": "@@ -25,20 +25,39 @@\n  */\n public class BlockRegion {\n \n+\n+    /**\n+     * The x coordinate of the minimum corner.\n+     */\n+    public int minX = Integer.MAX_VALUE;\n+    /**\n+     * The y coordinate of the minimum corner.\n+     */\n+    public int minY = Integer.MAX_VALUE;\n+    /**\n+     * The z coordinate of the minimum corner.\n+     */\n+    public int minZ = Integer.MAX_VALUE;\n+    /**\n+     * The x coordinate of the maximum corner.\n+     */\n+    public int maxX = Integer.MIN_VALUE;\n+    /**\n+     * The y coordinate of the maximum corner.\n+     */\n+    public int maxY = Integer.MIN_VALUE;\n     /**\n-     * AABB region that backs a BlockRegion\n+     * The z coordinate of the maximum corner.\n      */\n-    public final AABBi aabb = new AABBi();\n+    public int maxZ = Integer.MIN_VALUE;", "originalCommit": "0f168f1699c4c72bbd0c71df5effd811c32d7208", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "ab1406764946a6d703975287fa3deb0ce7444bad", "url": "https://github.com/MovingBlocks/Terasology/commit/ab1406764946a6d703975287fa3deb0ce7444bad", "message": "update test formatting and rework bounds", "committedDate": "2020-12-13T22:07:31Z", "type": "commit"}, {"oid": "682d69bb97adb3e2781c0c2bcf1b870d80da8aaa", "url": "https://github.com/MovingBlocks/Terasology/commit/682d69bb97adb3e2781c0c2bcf1b870d80da8aaa", "message": "update blockregion min and max", "committedDate": "2020-12-13T22:41:10Z", "type": "commit"}, {"oid": "37e6be4e0e9765e2024fe90e48e1ca0c75110db9", "url": "https://github.com/MovingBlocks/Terasology/commit/37e6be4e0e9765e2024fe90e48e1ca0c75110db9", "message": "remove use of aabbf cache instance", "committedDate": "2020-12-14T02:42:49Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjA3NDg1Nw==", "url": "https://github.com/MovingBlocks/Terasology/pull/4321#discussion_r542074857", "bodyText": "I'm pretty sure this logic is incorrect @4Denthusiast", "author": "pollend", "createdAt": "2020-12-14T02:44:41Z", "path": "engine/src/main/java/org/terasology/world/block/BlockRegion.java", "diffHunk": "@@ -792,36 +1026,50 @@ public BlockRegion addExtents(int extentX, int extentY, int extentZ, BlockRegion\n      * @return dest\n      */\n     public BlockRegion addExtents(float extentX, float extentY, float extentZ, BlockRegion dest) {\n-        dest.aabb.minX = Math.roundUsing(this.aabb.minX - extentX, RoundingMode.FLOOR);\n-        dest.aabb.minY = Math.roundUsing(this.aabb.minY - extentY, RoundingMode.FLOOR);\n-        dest.aabb.minZ = Math.roundUsing(this.aabb.minZ - extentZ, RoundingMode.FLOOR);\n+        dest.minX = Math.roundUsing(this.minX - extentX, RoundingMode.FLOOR);\n+        dest.minY = Math.roundUsing(this.minY - extentY, RoundingMode.FLOOR);\n+        dest.minZ = Math.roundUsing(this.minZ - extentZ, RoundingMode.FLOOR);\n+\n+        dest.maxX = Math.roundUsing(this.maxX + extentX, RoundingMode.CEILING);\n+        dest.maxY = Math.roundUsing(this.maxY + extentY, RoundingMode.CEILING);\n+        dest.maxZ = Math.roundUsing(this.maxZ + extentZ, RoundingMode.CEILING);\n \n-        dest.aabb.maxX = Math.roundUsing(this.aabb.maxX + extentX, RoundingMode.CEILING);\n-        dest.aabb.maxY = Math.roundUsing(this.aabb.maxY + extentY, RoundingMode.CEILING);\n-        dest.aabb.maxZ = Math.roundUsing(this.aabb.maxZ + extentZ, RoundingMode.CEILING);\n         return dest;\n     }\n ", "originalCommit": "37e6be4e0e9765e2024fe90e48e1ca0c75110db9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mjg4MjAzOA==", "url": "https://github.com/MovingBlocks/Terasology/pull/4321#discussion_r542882038", "bodyText": "Agreed (and I've added a test for that). But I'm also not sure whether there's a value in this method anymore, now that we treat integer coordinates as block centers. I think the following should hold (and could be the implementation):\npublic BlockRegion addExtents(float extentX, float extentY, float extentZ, BlockRegion dest) {\n\treturn addExtents(Math.roundUsing(extentX, RoundingMode.FLOOR), \n\t\tMath.roundUsing(extentY, RoundingMode.FLOOR), \n\t\tMath.roundUsing(extentZ, RoundingMode.FLOOR), dest);\n}", "author": "skaldarnar", "createdAt": "2020-12-14T22:36:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjA3NDg1Nw=="}], "type": "inlineReview"}, {"oid": "1fcf782143827772449dfaed8444749111117eb2", "url": "https://github.com/MovingBlocks/Terasology/commit/1fcf782143827772449dfaed8444749111117eb2", "message": "revert Terasology.launcher", "committedDate": "2020-12-14T02:53:25Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjM0ODc4NQ==", "url": "https://github.com/MovingBlocks/Terasology/pull/4321#discussion_r542348785", "bodyText": "maxZ, not minZ (and similarly for the other two).", "author": "4Denthusiast", "createdAt": "2020-12-14T12:34:12Z", "path": "engine/src/main/java/org/terasology/world/block/BlockRegion.java", "diffHunk": "@@ -297,24 +287,20 @@ public BlockRegion set(BlockRegion source) {\n         this.maxX = source.maxX;\n         this.maxY = source.maxY;\n         this.maxZ = source.maxZ;\n-        this.isDirt = true;\n         return this;\n     }\n \n     //TODO: 1.9.26 has a constant interface for aabbf\n-    public AABBf getBounds() {\n-        if(isDirt) {\n-            return bounds.setMin(\n-                this.minX - .5f,\n-                this.minY - .5f,\n-                this.minZ - .5f\n-            ).setMax(\n-                this.maxX + .5f,\n-                this.maxY + .5f,\n-                this.maxZ + .5f\n-            );\n-        }\n-        return bounds;\n+    public AABBf getBounds(AABBf dest) {\n+        dest.minX = minX - .5f;\n+        dest.minY = minY - .5f;\n+        dest.minZ = minZ - .5f;\n+\n+        dest.maxX = minX + .5f;\n+        dest.maxY = minY + .5f;\n+        dest.maxZ = minZ + .5f;", "originalCommit": "37e6be4e0e9765e2024fe90e48e1ca0c75110db9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "d8eb01860c773635c43d8fa433bd80bc95adef9f", "url": "https://github.com/MovingBlocks/Terasology/commit/d8eb01860c773635c43d8fa433bd80bc95adef9f", "message": "fix: correct addExtents(float...) and add test", "committedDate": "2020-12-14T22:41:41Z", "type": "commit"}, {"oid": "1bdb599c3157017cdd4d2604272680558a4546a8", "url": "https://github.com/MovingBlocks/Terasology/commit/1bdb599c3157017cdd4d2604272680558a4546a8", "message": "fix: correct getBounds(...) and add test", "committedDate": "2020-12-14T22:48:53Z", "type": "commit"}, {"oid": "acca3b4677e6b2b40d56edfe2d44e99a8e444ed1", "url": "https://github.com/MovingBlocks/Terasology/commit/acca3b4677e6b2b40d56edfe2d44e99a8e444ed1", "message": "test: adjust tests for center point of BlockRegion", "committedDate": "2020-12-14T22:53:08Z", "type": "commit"}, {"oid": "f992f2917b5ec9c9932a09f51d7a2f409ab68ac8", "url": "https://github.com/MovingBlocks/Terasology/commit/f992f2917b5ec9c9932a09f51d7a2f409ab68ac8", "message": "test: add test to check min/max are correct", "committedDate": "2020-12-14T23:02:03Z", "type": "commit"}, {"oid": "789c1775f22ad313ee80274c2cf0adcd93b2b0bd", "url": "https://github.com/MovingBlocks/Terasology/commit/789c1775f22ad313ee80274c2cf0adcd93b2b0bd", "message": "fix: correct intersectsAABB(other) and add more test cases", "committedDate": "2020-12-14T23:16:13Z", "type": "commit"}, {"oid": "54166bbaabb56ac3ab41015b6ab7d3296046460e", "url": "https://github.com/MovingBlocks/Terasology/commit/54166bbaabb56ac3ab41015b6ab7d3296046460e", "message": "Merge branch 'develop' into develop", "committedDate": "2020-12-19T13:57:04Z", "type": "commit"}, {"oid": "e09097432cdebaefbaa8f7c637616e433ac50c44", "url": "https://github.com/MovingBlocks/Terasology/commit/e09097432cdebaefbaa8f7c637616e433ac50c44", "message": "chore(BlockRegion): remove deprecated constructors", "committedDate": "2020-12-19T15:28:30Z", "type": "commit"}, {"oid": "a89854003dd48e3137419ea85049ea1f5f1e6f62", "url": "https://github.com/MovingBlocks/Terasology/commit/a89854003dd48e3137419ea85049ea1f5f1e6f62", "message": "test(BlockRegion): move test class to correct package; add (failing) tests for empty region", "committedDate": "2020-12-19T15:49:41Z", "type": "commit"}, {"oid": "f8b9b65e922dc6eade3d633c81fce519998b1512", "url": "https://github.com/MovingBlocks/Terasology/commit/f8b9b65e922dc6eade3d633c81fce519998b1512", "message": "test(BlockRegion): more tests, more fixes", "committedDate": "2020-12-19T23:04:16Z", "type": "commit"}, {"oid": "0b6740a2b68eeaa37bc64ec535f420ce4f49d446", "url": "https://github.com/MovingBlocks/Terasology/commit/0b6740a2b68eeaa37bc64ec535f420ce4f49d446", "message": "test(BlockRegion): ...", "committedDate": "2020-12-19T23:45:14Z", "type": "commit"}, {"oid": "da9063b1eac8d3b304b96921ced8b1a069cd420c", "url": "https://github.com/MovingBlocks/Terasology/commit/da9063b1eac8d3b304b96921ced8b1a069cd420c", "message": "test(BlockRegion): ...", "committedDate": "2020-12-20T16:32:13Z", "type": "commit"}, {"oid": "755cf56c2a5ec55865146fb9e89b3772cc223591", "url": "https://github.com/MovingBlocks/Terasology/commit/755cf56c2a5ec55865146fb9e89b3772cc223591", "message": "test(BlockRegion): ...", "committedDate": "2020-12-20T17:20:44Z", "type": "commit"}, {"oid": "637d9b12fe505fcbf81c9cad3d392141b737e1dc", "url": "https://github.com/MovingBlocks/Terasology/commit/637d9b12fe505fcbf81c9cad3d392141b737e1dc", "message": "Merge branch 'develop' into develop", "committedDate": "2020-12-20T17:48:26Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjQwOTUyMw==", "url": "https://github.com/MovingBlocks/Terasology/pull/4321#discussion_r546409523", "bodyText": "I think this will have some implications, as it could not be null before.\nI haven't double-checked where this component is used/accessed.", "author": "skaldarnar", "createdAt": "2020-12-20T18:03:21Z", "path": "engine/src/main/java/org/terasology/world/block/regions/BlockRegionComponent.java", "diffHunk": "@@ -8,15 +8,19 @@\n import org.terasology.world.block.BlockRegion;\n \n /**\n+ *\n  */\n public class BlockRegionComponent implements Component {\n+    /**\n+     * May be null.\n+     */\n     @Replicate\n-    public BlockRegion region = new BlockRegion();\n+    public BlockRegion region;", "originalCommit": "637d9b12fe505fcbf81c9cad3d392141b737e1dc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjQwOTc4NQ==", "url": "https://github.com/MovingBlocks/Terasology/pull/4321#discussion_r546409785", "bodyText": "hmm, so an empty blockmap is null.", "author": "pollend", "createdAt": "2020-12-20T18:05:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjQwOTUyMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjQwOTk4OA==", "url": "https://github.com/MovingBlocks/Terasology/pull/4321#discussion_r546409988", "bodyText": "I'm not sure this is intuitive - while writing tests for this, I was wondering whether\nBlockRegions.createFromCenterAndExtents(new Vector3i(), new Vector3i(0,0,0))\nis valid or not, and what it should return. In the given implementation it is valid, as the extents are added to the center block, while the utility method might be interpreted in a way that \"extents\" refers to the final extents...", "author": "skaldarnar", "createdAt": "2020-12-20T18:07:17Z", "path": "engine/src/main/java/org/terasology/world/block/BlockRegions.java", "diffHunk": "@@ -53,7 +56,7 @@ public static BlockRegion createFromMinAndMax(int minX, int minY, int minZ, int\n      * @return new block region\n      */\n     public static BlockRegion createFromCenterAndExtents(Vector3ic center, Vector3ic extents) {\n-        return new BlockRegion().union(center).addExtents(extents);\n+        return new BlockRegion(center).extend(extents);", "originalCommit": "637d9b12fe505fcbf81c9cad3d392141b737e1dc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjQxMDI0OQ==", "url": "https://github.com/MovingBlocks/Terasology/pull/4321#discussion_r546410249", "bodyText": "This is not public anymore, so there is hopefully no way to create invalid BlockRegions anymore. However, this comes in very handy when redcuing a list of positions in the encompassing helper methods, that's why I left it in...\nNot sure what to do with it...", "author": "skaldarnar", "createdAt": "2020-12-20T18:09:55Z", "path": "engine/src/main/java/org/terasology/world/block/BlockRegion.java", "diffHunk": "@@ -19,317 +19,384 @@\n import org.joml.Vector3ic;\n import org.terasology.entitySystem.entity.EntityRef;\n \n+import java.util.Optional;\n+\n /**\n- * is a bounded box describing blocks contained within. A {@link BlockRegion} is described and backed by an {@link\n- * AABBi}\n+ * A bounded, axis-aligned volume in space denoting a collection of blocks contained within.\n  */\n public class BlockRegion {\n \n     /**\n-     * AABB region that backs a BlockRegion\n+     * The x coordinate of the minimum corner.\n+     */\n+    private int minX = Integer.MAX_VALUE;\n+    /**\n+     * The y coordinate of the minimum corner.\n+     */\n+    private int minY = Integer.MAX_VALUE;\n+    /**\n+     * The z coordinate of the minimum corner.\n+     */\n+    private int minZ = Integer.MAX_VALUE;\n+    /**\n+     * The x coordinate of the maximum corner.\n      */\n-    public final AABBi aabb = new AABBi();\n+    private int maxX = Integer.MIN_VALUE;\n+    /**\n+     * The y coordinate of the maximum corner.\n+     */\n+    private int maxY = Integer.MIN_VALUE;\n+    /**\n+     * The z coordinate of the maximum corner.\n+     */\n+    private int maxZ = Integer.MIN_VALUE;\n \n-    public BlockRegion() {\n-    }\n+    // -- CONSTRUCTORS -----------------------------------------------------------------------------------------------//\n \n-    public BlockRegion(BlockRegion source) {\n-        aabb.set(source.aabb);\n+    /**\n+     * Creates an empty block region with invalid minimum/maximum corners.\n+     * <p>\n+     * {@link #isValid()} will return {@code false} for an empty block region created via this constructor.\n+     */\n+    @Deprecated\n+    BlockRegion() {", "originalCommit": "637d9b12fe505fcbf81c9cad3d392141b737e1dc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjQxMzMwOA==", "url": "https://github.com/MovingBlocks/Terasology/pull/4321#discussion_r546413308", "bodyText": "I wouldn't mark it as deprecated though.", "author": "pollend", "createdAt": "2020-12-20T18:39:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjQxMDI0OQ=="}], "type": "inlineReview"}]}