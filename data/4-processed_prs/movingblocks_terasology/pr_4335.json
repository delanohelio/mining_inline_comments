{"pr_number": 4335, "pr_title": "feat(JOML): migrate chunkview and tests cases", "pr_createdAt": "2020-12-27T02:30:21Z", "pr_url": "https://github.com/MovingBlocks/Terasology/pull/4335", "timeline": [{"oid": "dc403667fb44ccaf3fe963dbb428404999f0b51b", "url": "https://github.com/MovingBlocks/Terasology/commit/dc403667fb44ccaf3fe963dbb428404999f0b51b", "message": "feat(JOML): migrate chunkview and tests cases", "committedDate": "2020-12-27T02:28:48Z", "type": "commit"}, {"oid": "e530bd55679cc9eac0e3ea43ec797da8e08f3140", "url": "https://github.com/MovingBlocks/Terasology/commit/e530bd55679cc9eac0e3ea43ec797da8e08f3140", "message": "Merge branch 'develop' into feature/joml-migrate-chunkview", "committedDate": "2020-12-27T16:33:12Z", "type": "commit"}, {"oid": "19949a66f052514d1bbde2569edb0b212792db56", "url": "https://github.com/MovingBlocks/Terasology/commit/19949a66f052514d1bbde2569edb0b212792db56", "message": "Merge branch 'develop' into feature/joml-migrate-chunkview", "committedDate": "2020-12-30T19:46:25Z", "type": "commit"}, {"oid": "a8e0f2d2b370524e699ad6fe6afcbdea3f8af8e2", "url": "https://github.com/MovingBlocks/Terasology/commit/a8e0f2d2b370524e699ad6fe6afcbdea3f8af8e2", "message": "Merge branch 'develop' into feature/joml-migrate-chunkview", "committedDate": "2021-01-03T04:23:19Z", "type": "commit"}, {"oid": "345396311095b2840420771d1592a7fbee6b8038", "url": "https://github.com/MovingBlocks/Terasology/commit/345396311095b2840420771d1592a7fbee6b8038", "message": "Merge branch 'develop' into feature/joml-migrate-chunkview", "committedDate": "2021-01-05T04:06:25Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDM3Mzc1MA==", "url": "https://github.com/MovingBlocks/Terasology/pull/4335#discussion_r554373750", "bodyText": "Should this be Chunks.toRelative or something like that?", "author": "skaldarnar", "createdAt": "2021-01-09T10:58:41Z", "path": "engine/src/main/java/org/terasology/world/internal/ChunkViewCoreImpl.java", "diffHunk": "@@ -107,87 +109,77 @@ public byte getLight(Vector3i pos) {\n \n     @Override\n     public byte getSunlight(int blockX, int blockY, int blockZ) {\n-        if (!blockRegion.encompasses(blockX, blockY, blockZ)) {\n+        if (!blockRegion.contains(blockX, blockY, blockZ)) {\n             return 0;\n         }\n \n         int chunkIndex = relChunkIndex(blockX, blockY, blockZ);\n-        return chunks[chunkIndex].getSunlight(ChunkMath.calcRelativeBlockPos(blockX, blockY, blockZ, chunkFilterSize));\n+        return chunks[chunkIndex].getSunlight(JomlUtil.from(ChunkMath.calcRelativeBlockPos(blockX, blockY, blockZ, chunkFilterSize, new Vector3i())));", "originalCommit": "345396311095b2840420771d1592a7fbee6b8038", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDM3MzkxMw==", "url": "https://github.com/MovingBlocks/Terasology/pull/4335#discussion_r554373913", "bodyText": "same here?", "author": "skaldarnar", "createdAt": "2021-01-09T10:59:02Z", "path": "engine/src/main/java/org/terasology/world/internal/ChunkViewCoreImpl.java", "diffHunk": "@@ -107,87 +109,77 @@ public byte getLight(Vector3i pos) {\n \n     @Override\n     public byte getSunlight(int blockX, int blockY, int blockZ) {\n-        if (!blockRegion.encompasses(blockX, blockY, blockZ)) {\n+        if (!blockRegion.contains(blockX, blockY, blockZ)) {\n             return 0;\n         }\n \n         int chunkIndex = relChunkIndex(blockX, blockY, blockZ);\n-        return chunks[chunkIndex].getSunlight(ChunkMath.calcRelativeBlockPos(blockX, blockY, blockZ, chunkFilterSize));\n+        return chunks[chunkIndex].getSunlight(JomlUtil.from(ChunkMath.calcRelativeBlockPos(blockX, blockY, blockZ, chunkFilterSize, new Vector3i())));\n     }\n \n     @Override\n     public byte getLight(int blockX, int blockY, int blockZ) {\n-        if (!blockRegion.encompasses(blockX, blockY, blockZ)) {\n+        if (!blockRegion.contains(blockX, blockY, blockZ)) {\n             return 0;\n         }\n \n         int chunkIndex = relChunkIndex(blockX, blockY, blockZ);\n-        return chunks[chunkIndex].getLight(ChunkMath.calcRelativeBlockPos(blockX, blockY, blockZ, chunkFilterSize));\n+        return chunks[chunkIndex].getLight(JomlUtil.from(ChunkMath.calcRelativeBlockPos(blockX, blockY, blockZ, chunkFilterSize, new Vector3i())));", "originalCommit": "345396311095b2840420771d1592a7fbee6b8038", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDM3NzQzNA==", "url": "https://github.com/MovingBlocks/Terasology/pull/4335#discussion_r554377434", "bodyText": "Isn't this the same as:\nVector3i tmp = new Vector3i();\nBlockRegion expandedRegion = new BlockRegion(region).expand(1, 1, 1);\n\nVector3i minChunk = ChunkMath.calcChunkPos(expandedRegion.getMin(tmp), chunkPower);\nVector3i maxChunk = ChunkMath.calcChunkPos(expandedRegion.getMax(tmp), chunkPower);\nThis might get a bit esoteric here, but I'd love to write something like:\nBlockRegion chunkRegion = region.expand(1, 1, 1).map(corner -> ChunkMath.calcChunkPos(corner, chunkPower);\nAnd is there an alternative to ChunkMath.calcChunkPos(pos, power) in Chunks? I at least don't see one which takes vectors for both arguments when looking at Chunks.toChunkPos.", "author": "skaldarnar", "createdAt": "2021-01-09T11:07:50Z", "path": "engine/src/main/java/org/terasology/world/internal/ChunkViewCoreImpl.java", "diffHunk": "@@ -211,24 +203,24 @@ public void setExtraData(int index, int blockX, int blockY, int blockZ, int valu\n     }\n \n     @Override\n-    public void setDirtyAround(Vector3i blockPos) {\n-        for (Vector3i pos : ChunkMath.getChunkRegionAroundWorldPos(blockPos, 1)) {\n-            chunks[pos.x + offset.x + chunkRegion.size().x * (pos.z + offset.z)].setDirty(true);\n+    public void setDirtyAround(Vector3ic blockPos) {\n+        for (Vector3ic pos : ChunkMath.getChunkRegionAroundWorldPos(blockPos, 1)) {\n+            chunks[pos.x() + offset.x + chunkRegion.getSizeX() * (pos.z() + offset.z)].setDirty(true);\n         }\n     }\n \n     @Override\n-    public void setDirtyAround(Region3i region) {\n-        Vector3i minPos = new Vector3i(region.min());\n+    public void setDirtyAround(BlockRegionc region) {\n+        Vector3i minPos = region.getMin(new Vector3i());\n         minPos.sub(1, 1, 1);\n-        Vector3i maxPos = new Vector3i(region.max());\n+        Vector3i maxPos = region.getMax(new Vector3i());\n         maxPos.add(1, 1, 1);\n \n         Vector3i minChunk = ChunkMath.calcChunkPos(minPos, chunkPower);\n         Vector3i maxChunk = ChunkMath.calcChunkPos(maxPos, chunkPower);", "originalCommit": "345396311095b2840420771d1592a7fbee6b8038", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDM3OTAxMw==", "url": "https://github.com/MovingBlocks/Terasology/pull/4335#discussion_r554379013", "bodyText": "On a second look, we introduced toChunkRegion(BlockRegion region, Vector3ic chunkPower, BlockRegion dest), which I guess can (or even should) be used here:\n        BlockRegion expandedRegion = new BlockRegion(region).expand(1, 1, 1);\n        for (Vector3ic pos : Chunks.toChunkRegion(expandedRegion, chunkPower, expandedRegion) {\n            chunks[pos.x() + offset.x + chunkRegion.getSizeX() * (pos.z() + offset.z)].setDirty(true);\n        }", "author": "skaldarnar", "createdAt": "2021-01-09T11:11:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDM3NzQzNA=="}], "type": "inlineReview"}, {"oid": "c1f90d85d1ded69b89f9bd16ec9da8d8046fc1fc", "url": "https://github.com/MovingBlocks/Terasology/commit/c1f90d85d1ded69b89f9bd16ec9da8d8046fc1fc", "message": "Merge branch 'develop' into feature/joml-migrate-chunkview", "committedDate": "2021-01-09T11:14:02Z", "type": "commit"}, {"oid": "e0de8f386095cc9fd78a6c0831ba475eb33c9408", "url": "https://github.com/MovingBlocks/Terasology/commit/e0de8f386095cc9fd78a6c0831ba475eb33c9408", "message": "chore(joml): replace ChunkMath and ChunkConstants with `Chunks`", "committedDate": "2021-01-09T11:51:33Z", "type": "commit"}, {"oid": "3fb8cda6065224e6635e032a6190124c99908dd3", "url": "https://github.com/MovingBlocks/Terasology/commit/3fb8cda6065224e6635e032a6190124c99908dd3", "message": "Merge branch 'develop' into feature/joml-migrate-chunkview", "committedDate": "2021-01-09T17:02:26Z", "type": "commit"}]}