{"pr_number": 4147, "pr_title": "feat: set limits for maximum memory use.", "pr_createdAt": "2020-09-12T19:53:17Z", "pr_url": "https://github.com/MovingBlocks/Terasology/pull/4147", "timeline": [{"oid": "6d11ca362bb83d951d0bb10b533664497729c874", "url": "https://github.com/MovingBlocks/Terasology/commit/6d11ca362bb83d951d0bb10b533664497729c874", "message": "chore: upgrade JNA to 4.5.2\n\nThe latest in the 4.x series.", "committedDate": "2020-09-11T23:04:09Z", "type": "commit"}, {"oid": "d06441b40719af2aa1c369a9e30595d0efab670a", "url": "https://github.com/MovingBlocks/Terasology/commit/d06441b40719af2aa1c369a9e30595d0efab670a", "message": "feature: limit max data segment size with setrlimit\n\nWIP: Currently hardcoded to 8 GB.", "committedDate": "2020-09-12T19:21:49Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzQ0MzU1Nw==", "url": "https://github.com/MovingBlocks/Terasology/pull/4147#discussion_r487443557", "bodyText": "There's a new major version of JNA 5.x out since October 2018, but the 4.5 series is sufficient to provide the Resource API and I thought I could get away with doing less testing if I stuck to the same major version.\nManually keeping versions in sync between here and facade's build.gradle is a bother. Perhaps after clearing the jna-in-jopenvr obstacle we can revisit this and see if we can avoid that duplication.", "author": "keturn", "createdAt": "2020-09-12T20:03:00Z", "path": "engine/build.gradle", "diffHunk": "@@ -96,7 +96,7 @@ dependencies {\n     api group: 'org.codehaus.plexus', name: 'plexus-utils', version: '1.5.6'\n \n     // Java magic\n-    implementation group: 'net.java.dev.jna', name: 'jna-platform', version: '4.2.2'\n+    implementation group: 'net.java.dev.jna', name: 'jna-platform', version: '4.5.2'", "originalCommit": "d06441b40719af2aa1c369a9e30595d0efab670a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzQ0MzY0NA==", "url": "https://github.com/MovingBlocks/Terasology/pull/4147#discussion_r487443644", "bodyText": "Placeholder error handling, do something better here.", "author": "keturn", "createdAt": "2020-09-12T20:04:25Z", "path": "facades/PC/src/main/java/org/terasology/engine/Terasology.java", "diffHunk": "@@ -477,4 +470,26 @@ private static int getLastNumber(String str) {\n         return Integer.parseInt(str.substring(positionOfLastDigit));\n     }\n \n+    private static void setMemoryLimit(long maxMegabytes) {\n+        // Memory-limiting techniques are highly platform-specific.\n+        if (Platform.isLinux()) {\n+            final LibC.Rlimit dataLimit = new LibC.Rlimit();\n+            long maxBytes = maxMegabytes * 1024 * 1024;\n+            dataLimit.rlim_cur = maxBytes;\n+            dataLimit.rlim_max = maxBytes;\n+            // Under Linux \u2265 4.7, we can limit the maximum size of the process's data segment, which includes its\n+            // heap. Note we cannot directly limit its resident set size, see setrlimit(3).\n+            LibC.INSTANCE.setrlimit(LibC.RLIMIT_DATA, dataLimit);\n+        }\n+    }\n+\n+    private static void adjustOutOfMemoryScore(int adjustment) {\n+        Path procFile = Paths.get(\"/proc\", \"self\", \"oom_score_adj\");\n+        try {\n+            Files.write(procFile, String.valueOf(adjustment).getBytes(),\n+                    StandardOpenOption.WRITE, StandardOpenOption.TRUNCATE_EXISTING);\n+        } catch (IOException e) {\n+            e.printStackTrace();", "originalCommit": "d06441b40719af2aa1c369a9e30595d0efab670a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "4fcf34d82960467ffa71de5cc1504364bbfe7bfb", "url": "https://github.com/MovingBlocks/Terasology/commit/4fcf34d82960467ffa71de5cc1504364bbfe7bfb", "message": "Merge remote-tracking branch 'origin/develop' into feature/memory-limit-linux", "committedDate": "2021-08-15T23:12:27Z", "type": "commit"}, {"oid": "a113145981f3b3195fb32be8e8b35d885935674a", "url": "https://github.com/MovingBlocks/Terasology/commit/a113145981f3b3195fb32be8e8b35d885935674a", "message": "feat(facade): add `--max-data-size` command line option", "committedDate": "2021-08-16T03:36:20Z", "type": "commit"}, {"oid": "1a8089f2ac31aa95d1e8409d523560c63c57a808", "url": "https://github.com/MovingBlocks/Terasology/commit/1a8089f2ac31aa95d1e8409d523560c63c57a808", "message": "feat(facade): add `--oom-score` command line option", "committedDate": "2021-08-16T03:37:24Z", "type": "commit"}, {"oid": "185a64ea406ae7d5518f65576aa7db0d8ec8362b", "url": "https://github.com/MovingBlocks/Terasology/commit/185a64ea406ae7d5518f65576aa7db0d8ec8362b", "message": "chore(facade): capitalize for consistency", "committedDate": "2021-08-16T03:37:52Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4OTIyNzE3OA==", "url": "https://github.com/MovingBlocks/Terasology/pull/4147#discussion_r689227178", "bodyText": "FIXME: these are supposed to be test dependencies!", "author": "keturn", "createdAt": "2021-08-16T04:06:48Z", "path": "facades/PC/build.gradle.kts", "diffHunk": "@@ -68,6 +69,16 @@ dependencies {\n \n     // TODO: Consider whether we can move the CR dependency back here from the engine, where it is referenced from the main menu\n     implementation(group = \"org.terasology.crashreporter\", name = \"cr-terasology\", version = \"4.1.0\")\n+\n+    implementation(platform(\"org.junit:junit-bom:5.7.1\")) {\n+        // junit-bom will set version numbers for the other org.junit dependencies.\n+    }\n+    implementation(\"org.junit.jupiter:junit-jupiter-api\")\n+    implementation(\"org.junit.jupiter:junit-jupiter-params\")", "originalCommit": "185a64ea406ae7d5518f65576aa7db0d8ec8362b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4OTIyNzI2MA==", "url": "https://github.com/MovingBlocks/Terasology/pull/4147#discussion_r689227260", "bodyText": "FIXME: docstring", "author": "keturn", "createdAt": "2021-08-16T04:07:11Z", "path": "facades/PC/src/main/java/org/terasology/engine/DataSizeConverter.java", "diffHunk": "@@ -0,0 +1,56 @@\n+// Copyright 2021 The Terasology Foundation\n+// SPDX-License-Identifier: Apache-2.0\n+\n+package org.terasology.engine;\n+\n+import picocli.CommandLine;\n+\n+import java.math.BigDecimal;\n+import java.util.Locale;\n+import java.util.regex.Matcher;\n+import java.util.regex.Pattern;\n+\n+public class DataSizeConverter implements CommandLine.ITypeConverter<Long> {", "originalCommit": "185a64ea406ae7d5518f65576aa7db0d8ec8362b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "8d647f736f26f5150c085058a988c1b745e441aa", "url": "https://github.com/MovingBlocks/Terasology/commit/8d647f736f26f5150c085058a988c1b745e441aa", "message": "Merge branch 'develop' into feature/memory-limit-linux", "committedDate": "2021-08-18T13:51:29Z", "type": "commit"}, {"oid": "b9dbc2ed984f01913269621128412b345351422f", "url": "https://github.com/MovingBlocks/Terasology/commit/b9dbc2ed984f01913269621128412b345351422f", "message": "Merge branch 'develop' into feature/memory-limit-linux", "committedDate": "2021-08-19T20:40:22Z", "type": "commit"}]}