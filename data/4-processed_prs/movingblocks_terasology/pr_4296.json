{"pr_number": 4296, "pr_title": "feat(JOML): migrate BlockRegionComponent logic", "pr_createdAt": "2020-12-01T04:40:33Z", "pr_url": "https://github.com/MovingBlocks/Terasology/pull/4296", "timeline": [{"oid": "9a79fceec25db8ac0a92b98545916ad1ca6c021a", "url": "https://github.com/MovingBlocks/Terasology/commit/9a79fceec25db8ac0a92b98545916ad1ca6c021a", "message": "feat(JOML): migrate blockregion logic", "committedDate": "2020-12-01T04:37:19Z", "type": "commit"}, {"oid": "ef84ecc32892433c05e12733e73205e3e8b949d1", "url": "https://github.com/MovingBlocks/Terasology/commit/ef84ecc32892433c05e12733e73205e3e8b949d1", "message": "update getters", "committedDate": "2020-12-02T04:59:54Z", "type": "commit"}, {"oid": "e28328f1a53bccab66dae8b04085e772d247c23c", "url": "https://github.com/MovingBlocks/Terasology/commit/e28328f1a53bccab66dae8b04085e772d247c23c", "message": "remove unused field 'overrideBlockEntities' from BlockRegionComponent (not used in Omega)", "committedDate": "2020-12-05T22:07:03Z", "type": "commit"}, {"oid": "ab154a2881a13ca47d936ebce8e50db61cbef65b", "url": "https://github.com/MovingBlocks/Terasology/commit/ab154a2881a13ca47d936ebce8e50db61cbef65b", "message": "move JOML conversion outwards", "committedDate": "2020-12-05T22:08:02Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjg5NzYzMg==", "url": "https://github.com/MovingBlocks/Terasology/pull/4296#discussion_r536897632", "bodyText": "I'd try to push the use of JomlUtils as far outwards as possible and do the computation all in JOML already \ud83e\udd14\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                Vector3i location = new Vector3i(JomlUtil.from(blockRegion.region.center(new Vector3f())), RoundingMode.HALF_UP);\n          \n          \n            \n                                Vector3i location = JomlUtil.from(new org.joml.Vector3i(blockRegion.region.center(new Vector3f()), org.joml.RoundingMode.HALF_UP));", "author": "skaldarnar", "createdAt": "2020-12-05T21:40:25Z", "path": "engine/src/main/java/org/terasology/world/block/entity/BlockEntitySystem.java", "diffHunk": "@@ -102,13 +105,13 @@ public void defaultDropsHandling(CreateBlockDropsEvent event, EntityRef entity,\n                 BlockRegionComponent blockRegion = entity.getComponent(BlockRegionComponent.class);\n                 if (blockComponent.dropBlocksInRegion) {\n                     // loop through all the blocks in this region and drop them\n-                    for (Vector3i location : blockRegion.region) {\n+                    for (Vector3ic location : BlockRegions.iterableInPlace(blockRegion.region)) {\n                         Block blockInWorld = worldProvider.getBlock(location);\n-                        commonDefaultDropsHandling(event, entity, location, blockInWorld.getBlockFamily().getArchetypeBlock());\n+                        commonDefaultDropsHandling(event, entity, JomlUtil.from(location), blockInWorld.getBlockFamily().getArchetypeBlock());\n                     }\n                 } else {\n                     // just drop the ActAsBlock block\n-                    Vector3i location = new Vector3i(blockRegion.region.center(), RoundingMode.HALF_UP);\n+                    Vector3i location = new Vector3i(JomlUtil.from(blockRegion.region.center(new Vector3f())), RoundingMode.HALF_UP);", "originalCommit": "ef84ecc32892433c05e12733e73205e3e8b949d1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjg5OTkyNg==", "url": "https://github.com/MovingBlocks/Terasology/pull/4296#discussion_r536899926", "bodyText": "Does this make sure that the component holds it's own copy of the BlockRegion?", "author": "skaldarnar", "createdAt": "2020-12-05T21:55:54Z", "path": "engine/src/main/java/org/terasology/world/block/regions/BlockRegionComponent.java", "diffHunk": "@@ -4,20 +4,20 @@\n package org.terasology.world.block.regions;\n \n import org.terasology.entitySystem.Component;\n-import org.terasology.math.Region3i;\n import org.terasology.network.Replicate;\n+import org.terasology.world.block.BlockRegion;\n \n /**\n  */\n public class BlockRegionComponent implements Component {\n     @Replicate\n-    public Region3i region = Region3i.empty();\n+    public BlockRegion region = new BlockRegion();\n     public boolean overrideBlockEntities = true;\n \n     public BlockRegionComponent() {\n     }\n \n-    public BlockRegionComponent(Region3i region) {\n-        this.region = region;\n+    public BlockRegionComponent(BlockRegion region) {\n+        this.region.set(region);", "originalCommit": "ef84ecc32892433c05e12733e73205e3e8b949d1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjkwMDMxMw==", "url": "https://github.com/MovingBlocks/Terasology/pull/4296#discussion_r536900313", "bodyText": "This should also work with the in-place variant, shouldn't it? Removing from the map does not store it for later, I'd think ^^\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    for (org.joml.Vector3i pos : BlockRegions.iterable(oldRegion)) {\n          \n          \n            \n                    for (org.joml.Vector3i pos : BlockRegions.iterableInPlace(oldRegion)) {", "author": "skaldarnar", "createdAt": "2020-12-05T21:58:33Z", "path": "engine/src/main/java/org/terasology/world/internal/EntityAwareWorldProvider.java", "diffHunk": "@@ -474,28 +475,28 @@ public void onDeactivateBlock(BeforeDeactivateComponent event, EntityRef entity)\n     public void onBlockRegionActivated(OnActivatedComponent event, EntityRef entity) {\n         BlockRegionComponent regionComp = entity.getComponent(BlockRegionComponent.class);\n         blockRegions.put(entity, regionComp.region);\n-        for (Vector3i pos : regionComp.region) {\n+        for (org.joml.Vector3i pos : BlockRegions.iterable(regionComp.region)) {\n             blockRegionLookup.put(pos, entity);\n         }\n     }\n \n     @ReceiveEvent(components = {BlockRegionComponent.class})\n     public void onBlockRegionChanged(OnChangedComponent event, EntityRef entity) {\n-        Region3i oldRegion = blockRegions.get(entity);\n-        for (Vector3i pos : oldRegion) {\n+        BlockRegion oldRegion = blockRegions.get(entity);\n+        for (org.joml.Vector3i pos : BlockRegions.iterable(oldRegion)) {", "originalCommit": "ef84ecc32892433c05e12733e73205e3e8b949d1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjkwMDM3OA==", "url": "https://github.com/MovingBlocks/Terasology/pull/4296#discussion_r536900378", "bodyText": "Same there:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    for (org.joml.Vector3i pos : BlockRegions.iterable(oldRegion)) {\n          \n          \n            \n                    for (org.joml.Vector3i pos : BlockRegions.iterableInPlace(oldRegion)) {", "author": "skaldarnar", "createdAt": "2020-12-05T21:59:02Z", "path": "engine/src/main/java/org/terasology/world/internal/EntityAwareWorldProvider.java", "diffHunk": "@@ -474,28 +475,28 @@ public void onDeactivateBlock(BeforeDeactivateComponent event, EntityRef entity)\n     public void onBlockRegionActivated(OnActivatedComponent event, EntityRef entity) {\n         BlockRegionComponent regionComp = entity.getComponent(BlockRegionComponent.class);\n         blockRegions.put(entity, regionComp.region);\n-        for (Vector3i pos : regionComp.region) {\n+        for (org.joml.Vector3i pos : BlockRegions.iterable(regionComp.region)) {\n             blockRegionLookup.put(pos, entity);\n         }\n     }\n \n     @ReceiveEvent(components = {BlockRegionComponent.class})\n     public void onBlockRegionChanged(OnChangedComponent event, EntityRef entity) {\n-        Region3i oldRegion = blockRegions.get(entity);\n-        for (Vector3i pos : oldRegion) {\n+        BlockRegion oldRegion = blockRegions.get(entity);\n+        for (org.joml.Vector3i pos : BlockRegions.iterable(oldRegion)) {\n             blockRegionLookup.remove(pos);\n         }\n         BlockRegionComponent regionComp = entity.getComponent(BlockRegionComponent.class);\n         blockRegions.put(entity, regionComp.region);\n-        for (Vector3i pos : regionComp.region) {\n+        for (org.joml.Vector3i pos : BlockRegions.iterable(regionComp.region)) {\n             blockRegionLookup.put(pos, entity);\n         }\n     }\n \n     @ReceiveEvent(components = {BlockRegionComponent.class})\n     public void onBlockRegionDeactivated(BeforeDeactivateComponent event, EntityRef entity) {\n-        Region3i oldRegion = blockRegions.get(entity);\n-        for (Vector3i pos : oldRegion) {\n+        BlockRegion oldRegion = blockRegions.get(entity);\n+        for (org.joml.Vector3i pos : BlockRegions.iterable(oldRegion)) {", "originalCommit": "ef84ecc32892433c05e12733e73205e3e8b949d1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "2bcf534f08a80e03f2a9aa4bc84bdc6bc5befbda", "url": "https://github.com/MovingBlocks/Terasology/commit/2bcf534f08a80e03f2a9aa4bc84bdc6bc5befbda", "message": "add (unrelated) TODO in EntityAwareWorldProvider", "committedDate": "2020-12-05T22:18:49Z", "type": "commit"}, {"oid": "665880ae5035fadde23d722b78507eafd1325f38", "url": "https://github.com/MovingBlocks/Terasology/commit/665880ae5035fadde23d722b78507eafd1325f38", "message": "Merge branch 'develop' into feature/joml-migrate-BlockRegion", "committedDate": "2020-12-05T22:43:39Z", "type": "commit"}, {"oid": "f61dc14df12de2d6fd2b28d9e6fe933dce4e709a", "url": "https://github.com/MovingBlocks/Terasology/commit/f61dc14df12de2d6fd2b28d9e6fe933dce4e709a", "message": "feat: add BlockRegions.encompassing", "committedDate": "2020-12-05T23:40:55Z", "type": "commit"}, {"oid": "398a90e58fcc514c66b99d1e0928d6792f5ae76c", "url": "https://github.com/MovingBlocks/Terasology/commit/398a90e58fcc514c66b99d1e0928d6792f5ae76c", "message": "doc: improve docs on BlockRegions", "committedDate": "2020-12-05T23:41:10Z", "type": "commit"}, {"oid": "f4d2ba729bd0eb8554fdd7721c9a4d470548d3f2", "url": "https://github.com/MovingBlocks/Terasology/commit/f4d2ba729bd0eb8554fdd7721c9a4d470548d3f2", "message": "test: parameterize test for BlockRegions#createFromMinAndMax", "committedDate": "2020-12-05T23:42:07Z", "type": "commit"}, {"oid": "f424810eca8a84fbaa37661d00bb724460a0fe2e", "url": "https://github.com/MovingBlocks/Terasology/commit/f424810eca8a84fbaa37661d00bb724460a0fe2e", "message": "test: add parameterized tests for BlockRegions#encompassing", "committedDate": "2020-12-06T00:07:07Z", "type": "commit"}, {"oid": "2b7dfcf95e803d95b7ecda68ba621f3c67f8c810", "url": "https://github.com/MovingBlocks/Terasology/commit/2b7dfcf95e803d95b7ecda68ba621f3c67f8c810", "message": "test: add test for BlockRegion#center()", "committedDate": "2020-12-06T12:10:33Z", "type": "commit"}, {"oid": "9dc2de1f5c6d10cff9b0f47138e864ac3ccbaa7f", "url": "https://github.com/MovingBlocks/Terasology/commit/9dc2de1f5c6d10cff9b0f47138e864ac3ccbaa7f", "message": "Merge branch 'develop' into feature/joml-migrate-BlockRegion", "committedDate": "2020-12-06T12:37:00Z", "type": "commit"}, {"oid": "99c6b80c8f3fd7697cdf40c0eae5e6ed317ee461", "url": "https://github.com/MovingBlocks/Terasology/commit/99c6b80c8f3fd7697cdf40c0eae5e6ed317ee461", "message": "test: fix expected center point of empty `new BlockRegion()`", "committedDate": "2020-12-06T12:52:50Z", "type": "commit"}, {"oid": "cbae62ccb85fecffe21761d53d94486e8c0c398b", "url": "https://github.com/MovingBlocks/Terasology/commit/cbae62ccb85fecffe21761d53d94486e8c0c398b", "message": "fix: define center() for invalid BlockRegions", "committedDate": "2020-12-06T15:06:49Z", "type": "commit"}, {"oid": "9126f1f6a39c7f95a9cfba16d57b85dcb301d619", "url": "https://github.com/MovingBlocks/Terasology/commit/9126f1f6a39c7f95a9cfba16d57b85dcb301d619", "message": "return NaN instead of positive INF for center of invalid region", "committedDate": "2020-12-06T15:56:43Z", "type": "commit"}, {"oid": "8af0f5ed977038a7d8924402cd274bc0483fb83e", "url": "https://github.com/MovingBlocks/Terasology/commit/8af0f5ed977038a7d8924402cd274bc0483fb83e", "message": "Merge branch 'develop' into feature/joml-migrate-BlockRegion", "committedDate": "2020-12-08T21:27:57Z", "type": "commit"}, {"oid": "ccb0cdc78ca6ac639d334f5eae205eb0ed204378", "url": "https://github.com/MovingBlocks/Terasology/commit/ccb0cdc78ca6ac639d334f5eae205eb0ed204378", "message": "feat: use `iterableInPlace` for removing pos\n\nCo-authored-by: Tobias Nett <skaldarnar@googlemail.com>", "committedDate": "2020-12-08T22:06:43Z", "type": "commit"}, {"oid": "3dcc0b9638b966d9febc02c5e67bc9454d6a4573", "url": "https://github.com/MovingBlocks/Terasology/commit/3dcc0b9638b966d9febc02c5e67bc9454d6a4573", "message": "feat: use `iterableInPlace` for removing pos\n\nCo-authored-by: Tobias Nett <skaldarnar@googlemail.com>", "committedDate": "2020-12-08T22:07:00Z", "type": "commit"}, {"oid": "8ec5ab8e98db6388652d370a6de73170179cc64c", "url": "https://github.com/MovingBlocks/Terasology/commit/8ec5ab8e98db6388652d370a6de73170179cc64c", "message": "fix: use Vector3ic", "committedDate": "2020-12-08T22:18:27Z", "type": "commit"}]}