{"pr_number": 4606, "pr_title": "[GEOS-9834] GetLegendGraphic results in java.lang.NegativeArraySizeException or OutOfMemory", "pr_createdAt": "2020-12-21T08:36:10Z", "pr_url": "https://github.com/geoserver/geoserver/pull/4606", "timeline": [{"oid": "2e3edbb4b4d54feb28edb6abaee0a8ab75d1cded", "url": "https://github.com/geoserver/geoserver/commit/2e3edbb4b4d54feb28edb6abaee0a8ab75d1cded", "message": "fix: multiple rescaling applied to width and height", "committedDate": "2020-12-21T08:34:48Z", "type": "commit"}, {"oid": "e30e24416b2d80cfe32d237f990005cad36bba22", "url": "https://github.com/geoserver/geoserver/commit/e30e24416b2d80cfe32d237f990005cad36bba22", "message": "fix: code formatting", "committedDate": "2020-12-21T12:45:12Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzIxNDYyNA==", "url": "https://github.com/geoserver/geoserver/pull/4606#discussion_r547214624", "bodyText": "Empty line of code?", "author": "aaime", "createdAt": "2020-12-22T11:05:55Z", "path": "src/wms/src/test/java/org/geoserver/wms/legendgraphic/BufferedImageLegendGraphicOutputFormatTest.java", "diffHunk": "@@ -1330,6 +1333,46 @@ public void testSimpleLine() throws Exception {\n         assertColorSimilar(Color.WHITE, colorOutsideCenter, 20);\n     }\n \n+    /** Tests that rescale due to dpi is done correctly. */\n+    @org.junit.Test\n+    public void testScaleDPI() throws Exception {\n+        GetLegendGraphicRequest req = new GetLegendGraphicRequest(null);\n+        ;", "originalCommit": "e30e24416b2d80cfe32d237f990005cad36bba22", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTE5NTg2Mw==", "url": "https://github.com/geoserver/geoserver/pull/4606#discussion_r555195863", "bodyText": "Surprised no QA tool complained about the white space changes. Maybe it's a switch between linux and windows newlines?", "author": "aaime", "createdAt": "2021-01-11T16:56:18Z", "path": "src/wms/src/test/java/org/geoserver/wms/legendgraphic/BufferedImageLegendGraphicOutputFormatTest.java", "diffHunk": "@@ -70,12 +70,14 @@\n  */\n public class BufferedImageLegendGraphicOutputFormatTest\n         extends BaseLegendTest<BufferedImageLegendGraphicBuilder> {\n+", "originalCommit": "e30e24416b2d80cfe32d237f990005cad36bba22", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTIwMDUyNQ==", "url": "https://github.com/geoserver/geoserver/pull/4606#discussion_r555200525", "bodyText": "I am not familiar with this bit of code, but after review, the fix seems legit.\nHowever, I'm not convinced it's the best way to solve this. The method is called over and over, once for each layer, the reason why we're having this problem it's that the code does two separate things:\n\nResize the style based on the DPI, its intended purpose from the method name.\nAs a side effect, also change the w and h fields... and if done over and over, well, that can cause very bad results indeed.\n\nI would propose to move the side effect to another method that is called outside of the loop instead, e..g, resizeBoundsForDPI. The call would be before the \"for\" loops in BufferedImageLegendGraphicBuilder and JSONLegendGraphicBuilder. @ianturton you seem to be the original author of this method (as far as git goes at least), what do you think?", "author": "aaime", "createdAt": "2021-01-11T17:03:00Z", "path": "src/wms/src/main/java/org/geoserver/wms/legendgraphic/LegendGraphicBuilder.java", "diffHunk": "@@ -153,8 +153,8 @@ protected Style resizeForDPI(GetLegendGraphicRequest request, Style gt2Style) {\n         double standardDpi = RendererUtilities.getDpi(Collections.emptyMap());\n         if (dpi != standardDpi) {\n             double scaleFactor = dpi / standardDpi;\n-            w = ((int) Math.round(w * scaleFactor));\n-            h = ((int) Math.round(h * scaleFactor));\n+            w = ((int) Math.round(request.getWidth() * scaleFactor));\n+            h = ((int) Math.round(request.getHeight() * scaleFactor));", "originalCommit": "e30e24416b2d80cfe32d237f990005cad36bba22", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTIwNjAzOA==", "url": "https://github.com/geoserver/geoserver/pull/4606#discussion_r555206038", "bodyText": "I was just looking at that and thinking it looked familiar!\nLooks as if whatever I was working on only ever called that section of code once. So I would pull out the resize as @aaime suggests, possibly into the setup method.", "author": "ianturton", "createdAt": "2021-01-11T17:10:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTIwMDUyNQ=="}], "type": "inlineReview"}, {"oid": "58c656eccea2792650aaf88b7271870667d6344e", "url": "https://github.com/geoserver/geoserver/commit/58c656eccea2792650aaf88b7271870667d6344e", "message": "fix: whitespaces", "committedDate": "2021-01-15T05:52:33Z", "type": "commit"}, {"oid": "3868106fa2f3d90574e20ba7c28518a92c5614b9", "url": "https://github.com/geoserver/geoserver/commit/3868106fa2f3d90574e20ba7c28518a92c5614b9", "message": "fix: pull rescale to setup and expose dpi scale factor", "committedDate": "2021-01-15T06:12:15Z", "type": "commit"}]}