{"pr_number": 4156, "pr_title": "[GEOS-9561] Add rest parameter to update native bbox when harvesting \u2026", "pr_createdAt": "2020-04-02T15:59:24Z", "pr_url": "https://github.com/geoserver/geoserver/pull/4156", "timeline": [{"oid": "e94caea7135b46ba2cb1959e8daeaae296867177", "url": "https://github.com/geoserver/geoserver/commit/e94caea7135b46ba2cb1959e8daeaae296867177", "message": "[GEOS-9561] Add rest parameter to update native bbox when harvesting or deleting granules from image mosaic", "committedDate": "2020-04-03T06:33:31Z", "type": "forcePushed"}, {"oid": "2e373cf1b4205cb83f358ae48166dd49b0f1e8af", "url": "https://github.com/geoserver/geoserver/commit/2e373cf1b4205cb83f358ae48166dd49b0f1e8af", "message": "[GEOS-9561] Add rest parameter to update native bbox when harvesting or deleting granules from image mosaic", "committedDate": "2020-04-03T12:52:53Z", "type": "forcePushed"}, {"oid": "86b0f14d9ed4786fe3c6c6dd241e3c30f8c2ec37", "url": "https://github.com/geoserver/geoserver/commit/86b0f14d9ed4786fe3c6c6dd241e3c30f8c2ec37", "message": "[GEOS-9561] Add rest parameter to update native bbox when harvesting or deleting granules from image mosaic", "committedDate": "2020-04-03T13:01:27Z", "type": "forcePushed"}, {"oid": "fe42cf55abd8c5a5ccbd7b3aef5785e72f09c580", "url": "https://github.com/geoserver/geoserver/commit/fe42cf55abd8c5a5ccbd7b3aef5785e72f09c580", "message": "[GEOS-9561] Add rest parameter to update native bbox when harvesting or deleting granules from image mosaic", "committedDate": "2020-04-03T20:43:22Z", "type": "forcePushed"}, {"oid": "8f56c42a6acf2e9172b29ba262c0951f3bbfaa2c", "url": "https://github.com/geoserver/geoserver/commit/8f56c42a6acf2e9172b29ba262c0951f3bbfaa2c", "message": "[GEOS-9561] Add rest parameter to update native bbox when harvesting or deleting granules from image mosaic", "committedDate": "2020-04-06T08:23:45Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDEwMDA0NQ==", "url": "https://github.com/geoserver/geoserver/pull/4156#discussion_r404100045", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                      description: The parameter allows, when valorized as \"true\", to trigger the native bbox update of the layer configuration according \n          \n          \n            \n                      description: When set to \"true\", triggers re-calculation of the layer native bbox. Defaults to \"false\".", "author": "aaime", "createdAt": "2020-04-06T13:42:49Z", "path": "doc/en/api/1.0.0/coveragestores.yaml", "diffHunk": "@@ -286,6 +286,12 @@ paths:\n           required: false\n           description: The filename parameter specifies the target file name for a file that needs to harvested as part of a mosaic. This is important to avoid clashes and to make sure the right dimension values are available in the name for multidimensional mosaics to work. Only used if method=\"file\".\n           type: string\n+        - name: updateBBox\n+          in: query\n+          required: false\n+          description: The parameter allows, when valorized as \"true\", to trigger the native bbox update of the layer configuration according ", "originalCommit": "8f56c42a6acf2e9172b29ba262c0951f3bbfaa2c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTM1NTExNg==", "url": "https://github.com/geoserver/geoserver/pull/4156#discussion_r405355116", "bodyText": "fixed", "author": "taba90", "createdAt": "2020-04-08T08:40:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDEwMDA0NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDEwMDI1NA==", "url": "https://github.com/geoserver/geoserver/pull/4156#discussion_r404100254", "bodyText": "See comment above.", "author": "aaime", "createdAt": "2020-04-06T13:43:06Z", "path": "doc/en/api/1.0.0/structuredcoverages.yaml", "diffHunk": "@@ -402,6 +402,11 @@ paths:\n           required: false\n           type: string\n           minimum: 0\n+        - name: updateBBox\n+          in: query\n+          required: false\n+          description: The parameter allows, when valorized as \"true\", to trigger the native bbox update of the layer configuration according ", "originalCommit": "8f56c42a6acf2e9172b29ba262c0951f3bbfaa2c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTM1NTE5Nw==", "url": "https://github.com/geoserver/geoserver/pull/4156#discussion_r405355197", "bodyText": "fixed", "author": "taba90", "createdAt": "2020-04-08T08:40:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDEwMDI1NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDEwMDMyMw==", "url": "https://github.com/geoserver/geoserver/pull/4156#discussion_r404100323", "bodyText": "See comment above.", "author": "aaime", "createdAt": "2020-04-06T13:43:11Z", "path": "doc/en/api/1.0.0/structuredcoverages.yaml", "diffHunk": "@@ -589,7 +594,12 @@ paths:\n             Finally, when set to \"all\" both data and auxiliary files are removed.\n           required: false\n           type: string\n-          minimum: 0         \n+          minimum: 0  \n+        - name: updateBBox\n+          in: query\n+          required: false\n+          description: The parameter allows, when valorized as \"true\", to trigger the native bbox update of the layer configuration according ", "originalCommit": "8f56c42a6acf2e9172b29ba262c0951f3bbfaa2c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTM1NTMwMQ==", "url": "https://github.com/geoserver/geoserver/pull/4156#discussion_r405355301", "bodyText": "fixed", "author": "taba90", "createdAt": "2020-04-08T08:40:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDEwMDMyMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDEwMDkxNQ==", "url": "https://github.com/geoserver/geoserver/pull/4156#discussion_r404100915", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n             * This class aims to provide methods to update mosaic native bounding box at the coverage info\n          \n          \n            \n             * This class provides methods to update a mosaic native bounding box at the coverage info", "author": "aaime", "createdAt": "2020-04-06T13:43:56Z", "path": "src/restconfig/src/main/java/org/geoserver/rest/catalog/MosaicInfoBBoxHandler.java", "diffHunk": "@@ -0,0 +1,61 @@\n+/* (c) 2020 Open Source Geospatial Foundation - all rights reserved\n+ * This code is licensed under the GPL 2.0 license, available at the root\n+ * application directory.\n+ */\n+package org.geoserver.rest.catalog;\n+\n+import java.io.IOException;\n+import java.util.List;\n+import java.util.logging.Level;\n+import java.util.logging.Logger;\n+import org.geoserver.catalog.Catalog;\n+import org.geoserver.catalog.CoverageInfo;\n+import org.geoserver.catalog.CoverageStoreInfo;\n+import org.geotools.coverage.grid.io.StructuredGridCoverage2DReader;\n+import org.geotools.geometry.jts.ReferencedEnvelope;\n+import org.geotools.util.logging.Logging;\n+\n+/**\n+ * This class aims to provide methods to update mosaic native bounding box at the coverage info", "originalCommit": "8f56c42a6acf2e9172b29ba262c0951f3bbfaa2c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTM1NTM4Mg==", "url": "https://github.com/geoserver/geoserver/pull/4156#discussion_r405355382", "bodyText": "fixed", "author": "taba90", "createdAt": "2020-04-08T08:40:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDEwMDkxNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDExMTAyNQ==", "url": "https://github.com/geoserver/geoserver/pull/4156#discussion_r404111025", "bodyText": "Good to see tests for harvest and re-harvest. The delete path was modified too, is there a test for it?", "author": "aaime", "createdAt": "2020-04-06T13:57:06Z", "path": "src/restconfig/src/test/java/org/geoserver/rest/catalog/CoverageStoreFileUploadTest.java", "diffHunk": "@@ -576,4 +572,108 @@ private void configureCoverageInfo(\n         // add the store\n         getCatalog().add(cinfo);\n     }\n+\n+    @Test\n+    public void testDefaultBehaviourUpdateBBoxPOST() throws Exception {\n+        setUpBBoxTest(\"bboxtest\");\n+        byte[] bytes = null;\n+        CoverageStoreInfo storeInfo = getCatalog().getCoverageStoreByName(\"bboxtest\");\n+        assertNotNull(storeInfo);\n+        CoverageInfo ci = getCatalog().getCoverageByName(\"bboxtest\");\n+        assertNotNull(ci);\n+        assertEquals(storeInfo, ci.getStore());\n+        // Harvesting\n+        URL zipHarvest = getClass().getResource(\"test_bbox_granules.zip\");\n+        try (InputStream is = zipHarvest.openStream()) {\n+            bytes = IOUtils.toByteArray(is);\n+        }\n+        // Create the POST request\n+        MockHttpServletRequest request =\n+                createRequest(\n+                        RestBaseController.ROOT_PATH\n+                                + \"/workspaces/gs/coveragestores/bboxtest/file.imagemosaic\");\n+        request.setMethod(\"POST\");\n+        request.setContentType(\"application/zip\");\n+        request.setContent(bytes);\n+        request.addHeader(\"Content-type\", \"application/zip\");\n+        dispatch(request);\n+        testBBoxLayerConfiguration(\n+                storeInfo, (current, old) -> assertNotEquals(current, old), catalog);\n+        CoverageInfo coverage = getCatalog().getResourceByName(\"bboxtest\", CoverageInfo.class);\n+        if (coverage != null) {\n+            removeStore(\n+                    coverage.getStore().getWorkspace().getName(), coverage.getStore().getName());\n+        }\n+    }\n+\n+    @Test\n+    public void testUpdateBBoxTrueParameterPOST() throws Exception {", "originalCommit": "8f56c42a6acf2e9172b29ba262c0951f3bbfaa2c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTM1NjMzNw==", "url": "https://github.com/geoserver/geoserver/pull/4156#discussion_r405356337", "bodyText": "yes those are in the StructuredCoverageStoresTest class 9c3df0d#diff-12372cf7938b4aed6e65eba2d824237aR871", "author": "taba90", "createdAt": "2020-04-08T08:42:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDExMTAyNQ=="}], "type": "inlineReview"}, {"oid": "723bec48c1ec4e48ab8d0cab0648e5e6c6ae35db", "url": "https://github.com/geoserver/geoserver/commit/723bec48c1ec4e48ab8d0cab0648e5e6c6ae35db", "message": "[GEOS-9561] Add rest parameter to update native bbox when harvesting or deleting granules from image mosaic", "committedDate": "2020-04-07T08:21:16Z", "type": "forcePushed"}, {"oid": "b64e952dcfafeba954a7c90af4ec1f1502125a74", "url": "https://github.com/geoserver/geoserver/commit/b64e952dcfafeba954a7c90af4ec1f1502125a74", "message": "[GEOS-9561] Add rest parameter to update native bbox when harvesting or deleting granules from image mosaic", "committedDate": "2020-04-07T09:21:04Z", "type": "forcePushed"}, {"oid": "63e3f44036cfcd45b5804b7d5963a099bf5c38f3", "url": "https://github.com/geoserver/geoserver/commit/63e3f44036cfcd45b5804b7d5963a099bf5c38f3", "message": "fix MacOs build failing", "committedDate": "2020-04-07T15:12:58Z", "type": "forcePushed"}, {"oid": "9c3df0dec3079791dd5f99101180e5ffe5e92bb9", "url": "https://github.com/geoserver/geoserver/commit/9c3df0dec3079791dd5f99101180e5ffe5e92bb9", "message": "[GEOS-9561] Add rest parameter to update native bbox when harvesting or deleting granules from image mosaic", "committedDate": "2020-04-08T08:01:41Z", "type": "commit"}, {"oid": "c017f9ae876b4623f1566fd32ed0f152982cc563", "url": "https://github.com/geoserver/geoserver/commit/c017f9ae876b4623f1566fd32ed0f152982cc563", "message": "reviewer's feedback applied", "committedDate": "2020-04-08T08:01:41Z", "type": "commit"}, {"oid": "0be6a84a307b150153b3468d5ff9ae8b75650348", "url": "https://github.com/geoserver/geoserver/commit/0be6a84a307b150153b3468d5ff9ae8b75650348", "message": "fix MacOs build failing", "committedDate": "2020-04-08T08:01:41Z", "type": "commit"}, {"oid": "0be6a84a307b150153b3468d5ff9ae8b75650348", "url": "https://github.com/geoserver/geoserver/commit/0be6a84a307b150153b3468d5ff9ae8b75650348", "message": "fix MacOs build failing", "committedDate": "2020-04-08T08:01:41Z", "type": "forcePushed"}]}