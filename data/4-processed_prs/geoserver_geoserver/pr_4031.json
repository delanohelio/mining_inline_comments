{"pr_number": 4031, "pr_title": "[GEOS-9487] GSIP 187 - New extension point in ResourcePool for retyping feature types and features", "pr_createdAt": "2020-02-06T09:19:25Z", "pr_url": "https://github.com/geoserver/geoserver/pull/4031", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzA0MzgyMw==", "url": "https://github.com/geoserver/geoserver/pull/4031#discussion_r377043823", "bodyText": "This comment needs to be updated, a comments explaining a bit was going on would be welcome \ud83d\ude38.", "author": "nmco", "createdAt": "2020-02-10T12:52:33Z", "path": "src/main/src/main/java/org/geoserver/catalog/ResourcePool.java", "diffHunk": "@@ -1382,15 +1389,22 @@ else if (ppolicy == ProjectionPolicy.NONE && nativeCRS != null) {\n             }\n \n             // return a normal", "originalCommit": "21e4686cb42c1a67398fead3267e0542d00084ed", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzA3OTA5OA==", "url": "https://github.com/geoserver/geoserver/pull/4031#discussion_r377079098", "bodyText": "Agreed, and would add a note about the order of operations, why first create the geoserver feature source and then run the wrappers after it, instead of the opposite. I believe it has to be this way to match the feature type building process?\nHowever picture this case, a wrapper is building a geometry type that was not there. GeoServer feature source applies the projection handling, so doing it before, will make the code lose it. Maybe it's better to apply the callbacks before any sort of CRS handling is done, both here and computing the feature type, since the CRS handling is one of the user visible/user configurable things. Let's talk about it at least?", "author": "aaime", "createdAt": "2020-02-10T14:01:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzA0MzgyMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDI0NzY5MQ==", "url": "https://github.com/geoserver/geoserver/pull/4031#discussion_r380247691", "bodyText": "Good catch @aaime (and thank you for the offline explanation \ud83d\ude09). So @imranrajjad, like me you may have not noticed that this code:\n            // return a normal\n            return GeoServerFeatureLocking.create(\n                    fs,\n                    new GeoServerFeatureSource.Settings(\n                            schema,\n                            info.filter(),\n                            resultCRS,\n                            info.getProjectionPolicy().getCode(),\n                            getTolerance(info),\n                            info.getMetadata()));\nIs actually wrapping the original feature source fs with a wrapper that will provide extra GeoServer functionalities, for example, the ability to define a layer with a CQL filter or the ability of forcing a layer for publishing different from the native one.\nHence this extension wrapping  should happen before this is done, and we shoudl actually wrap the original feature source, the variable fs.\nThe integration tests should also be extended to tests this situations:\n\nA layer whit a CQL filter associated, querying the layer using WMS or WFs should filter out the features not matching the layer associated CQL\nA layer with the declared CRS different form the native one, querying the layer iwht either WFS or WMS should return featrues expressed in the declared SRS not in the native one.", "author": "nmco", "createdAt": "2020-02-17T15:33:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzA0MzgyMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzM0MzExMQ==", "url": "https://github.com/geoserver/geoserver/pull/4031#discussion_r383343111", "bodyText": "@nmco its done", "author": "imranrajjad", "createdAt": "2020-02-24T15:44:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzA0MzgyMw=="}], "type": "inlineReview"}, {"oid": "7a92ab148d11fd692088635a9ed35fd00ea8502c", "url": "https://github.com/geoserver/geoserver/commit/7a92ab148d11fd692088635a9ed35fd00ea8502c", "message": "[GEOS-9487] GSIP 187 - New extension point in ResourcePool for retyping\nfeature types and features\n\n- added interface and code pointers in gs-main\n- added unit tests\n\nGSIP : https://github.com/geoserver/geoserver/wiki/GSIP-187", "committedDate": "2020-02-24T10:29:08Z", "type": "commit"}, {"oid": "8b9ce7f4598d534cd8575d872f3e53986b116657", "url": "https://github.com/geoserver/geoserver/commit/8b9ce7f4598d534cd8575d872f3e53986b116657", "message": "[GEOS-9487] added unit tests for Geoserver wrapper\n\n-unit tests : CQL and Re-projection", "committedDate": "2020-02-24T15:43:26Z", "type": "commit"}, {"oid": "8b9ce7f4598d534cd8575d872f3e53986b116657", "url": "https://github.com/geoserver/geoserver/commit/8b9ce7f4598d534cd8575d872f3e53986b116657", "message": "[GEOS-9487] added unit tests for Geoserver wrapper\n\n-unit tests : CQL and Re-projection", "committedDate": "2020-02-24T15:43:26Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzM5NzA2Nw==", "url": "https://github.com/geoserver/geoserver/pull/4031#discussion_r383397067", "bodyText": "Please shorten this comment, if the class is moved or renamed this will be come just noise.", "author": "nmco", "createdAt": "2020-02-24T17:11:08Z", "path": "src/main/src/main/java/org/geoserver/catalog/ResourcePool.java", "diffHunk": "@@ -1381,6 +1388,13 @@ else if (ppolicy == ProjectionPolicy.NONE && nativeCRS != null) {\n                 schema = typeBuilder.buildFeatureType();\n             }\n \n+            // applying wrappers using\n+            // implementations of org.geoserver.catalog.RetypeFeatureTypeCallback", "originalCommit": "8b9ce7f4598d534cd8575d872f3e53986b116657", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzY2NjcyNQ==", "url": "https://github.com/geoserver/geoserver/pull/4031#discussion_r383666725", "bodyText": "will do", "author": "imranrajjad", "createdAt": "2020-02-25T05:33:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzM5NzA2Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzM5ODQyNg==", "url": "https://github.com/geoserver/geoserver/pull/4031#discussion_r383398426", "bodyText": "You should not assume this will always by a ``SimpleFeatureSource`, check this method returning type.", "author": "nmco", "createdAt": "2020-02-24T17:13:34Z", "path": "src/main/src/main/java/org/geoserver/catalog/ResourcePool.java", "diffHunk": "@@ -1381,6 +1388,13 @@ else if (ppolicy == ProjectionPolicy.NONE && nativeCRS != null) {\n                 schema = typeBuilder.buildFeatureType();\n             }\n \n+            // applying wrappers using\n+            // implementations of org.geoserver.catalog.RetypeFeatureTypeCallback\n+            for (RetypeFeatureTypeCallback callback :\n+                    GeoServerExtensions.extensions(RetypeFeatureTypeCallback.class)) {\n+                fs = (SimpleFeatureSource) callback.wrapFeatureSource(info, fs);", "originalCommit": "8b9ce7f4598d534cd8575d872f3e53986b116657", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzY4NTI2OA==", "url": "https://github.com/geoserver/geoserver/pull/4031#discussion_r383685268", "bodyText": "will add a check", "author": "imranrajjad", "createdAt": "2020-02-25T06:44:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzM5ODQyNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzM5OTc4Ng==", "url": "https://github.com/geoserver/geoserver/pull/4031#discussion_r383399786", "bodyText": "Noisy JavaDoc, better no doc that noise, you can configure your IDE to not create this templates. Since there is not final dot in your sentence I'm not even sure you finished it ...", "author": "nmco", "createdAt": "2020-02-24T17:16:11Z", "path": "src/main/src/test/java/org/geoserver/catalog/MockRetypeFeatureTypeCallback.java", "diffHunk": "@@ -0,0 +1,71 @@\n+/* (c) 2020 Open Source Geospatial Foundation - all rights reserved\r\n+ * This code is licensed under the GPL 2.0 license, available at the root\r\n+ * application directory.\r\n+ */\r\n+package org.geoserver.catalog;\r\n+\r\n+import org.geoserver.catalog.retype.MockRetypedSource;\r\n+import org.geotools.data.FeatureSource;\r\n+import org.geotools.data.simple.SimpleFeatureSource;\r\n+import org.geotools.feature.simple.SimpleFeatureTypeBuilder;\r\n+import org.geotools.referencing.CRS;\r\n+import org.locationtech.jts.geom.Point;\r\n+import org.opengis.feature.type.AttributeDescriptor;\r\n+import org.opengis.feature.type.FeatureType;\r\n+import org.opengis.feature.type.PropertyDescriptor;\r\n+import org.opengis.referencing.crs.CoordinateReferenceSystem;\r\n+\r\n+/**\r\n+ * This is a mock implementation\r\n+ *\r\n+ * @author ImranR\r\n+ */\r", "originalCommit": "8b9ce7f4598d534cd8575d872f3e53986b116657", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzY2NzI1MQ==", "url": "https://github.com/geoserver/geoserver/pull/4031#discussion_r383667251", "bodyText": "will change", "author": "imranrajjad", "createdAt": "2020-02-25T05:35:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzM5OTc4Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzM5OTkwNw==", "url": "https://github.com/geoserver/geoserver/pull/4031#discussion_r383399907", "bodyText": "?", "author": "nmco", "createdAt": "2020-02-24T17:16:25Z", "path": "src/main/src/test/java/org/geoserver/catalog/MockRetypeFeatureTypeCallback.java", "diffHunk": "@@ -0,0 +1,71 @@\n+/* (c) 2020 Open Source Geospatial Foundation - all rights reserved\r\n+ * This code is licensed under the GPL 2.0 license, available at the root\r\n+ * application directory.\r\n+ */\r\n+package org.geoserver.catalog;\r\n+\r\n+import org.geoserver.catalog.retype.MockRetypedSource;\r\n+import org.geotools.data.FeatureSource;\r\n+import org.geotools.data.simple.SimpleFeatureSource;\r\n+import org.geotools.feature.simple.SimpleFeatureTypeBuilder;\r\n+import org.geotools.referencing.CRS;\r\n+import org.locationtech.jts.geom.Point;\r\n+import org.opengis.feature.type.AttributeDescriptor;\r\n+import org.opengis.feature.type.FeatureType;\r\n+import org.opengis.feature.type.PropertyDescriptor;\r\n+import org.opengis.referencing.crs.CoordinateReferenceSystem;\r\n+\r\n+/**\r\n+ * This is a mock implementation\r\n+ *\r\n+ * @author ImranR\r\n+ */\r\n+public class MockRetypeFeatureTypeCallback implements RetypeFeatureTypeCallback {\r\n+\r\n+    public static final String RETYPED = \"RETYPED\";\r\n+    public static final String RETYPED_GEOM_COLUMN = \"GENERATED_POINT\";\r\n+\r\n+    public static final String LONG_FIELD = \"lon\";\r\n+    public static final String LAT_FIELD = \"lat\";\r\n+    public static final int EPSG_CODE = 4326;\r\n+\r\n+    @Override\r\n+    public FeatureType retypeFeatureType(FeatureTypeInfo featureTypeInfo, FeatureType src) {\r\n+        // only work for the test file : test/resources/org/geoserver/catalog/longlat.properties\r", "originalCommit": "8b9ce7f4598d534cd8575d872f3e53986b116657", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzY2NzY1MA==", "url": "https://github.com/geoserver/geoserver/pull/4031#discussion_r383667650", "bodyText": "this implementation will only work for vector layer using this property file as a data source. I will move Bean initiation inside the test", "author": "imranrajjad", "createdAt": "2020-02-25T05:37:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzM5OTkwNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzQwMDE5Ng==", "url": "https://github.com/geoserver/geoserver/pull/4031#discussion_r383400196", "bodyText": "I don't think you want to swallow this exception, if that's the case please log it.", "author": "nmco", "createdAt": "2020-02-24T17:16:56Z", "path": "src/main/src/test/java/org/geoserver/catalog/MockRetypeFeatureTypeCallback.java", "diffHunk": "@@ -0,0 +1,71 @@\n+/* (c) 2020 Open Source Geospatial Foundation - all rights reserved\r\n+ * This code is licensed under the GPL 2.0 license, available at the root\r\n+ * application directory.\r\n+ */\r\n+package org.geoserver.catalog;\r\n+\r\n+import org.geoserver.catalog.retype.MockRetypedSource;\r\n+import org.geotools.data.FeatureSource;\r\n+import org.geotools.data.simple.SimpleFeatureSource;\r\n+import org.geotools.feature.simple.SimpleFeatureTypeBuilder;\r\n+import org.geotools.referencing.CRS;\r\n+import org.locationtech.jts.geom.Point;\r\n+import org.opengis.feature.type.AttributeDescriptor;\r\n+import org.opengis.feature.type.FeatureType;\r\n+import org.opengis.feature.type.PropertyDescriptor;\r\n+import org.opengis.referencing.crs.CoordinateReferenceSystem;\r\n+\r\n+/**\r\n+ * This is a mock implementation\r\n+ *\r\n+ * @author ImranR\r\n+ */\r\n+public class MockRetypeFeatureTypeCallback implements RetypeFeatureTypeCallback {\r\n+\r\n+    public static final String RETYPED = \"RETYPED\";\r\n+    public static final String RETYPED_GEOM_COLUMN = \"GENERATED_POINT\";\r\n+\r\n+    public static final String LONG_FIELD = \"lon\";\r\n+    public static final String LAT_FIELD = \"lat\";\r\n+    public static final int EPSG_CODE = 4326;\r\n+\r\n+    @Override\r\n+    public FeatureType retypeFeatureType(FeatureTypeInfo featureTypeInfo, FeatureType src) {\r\n+        // only work for the test file : test/resources/org/geoserver/catalog/longlat.properties\r\n+        if (!RetypeFeatureTypeCallbackTest.LONG_LAT_NO_GEOM_ON_THE_FLY_LAYER.equalsIgnoreCase(\r\n+                featureTypeInfo.getName())) return src;\r\n+        try {\r\n+            CoordinateReferenceSystem crs = CRS.decode(\"EPSG:\" + EPSG_CODE);\r\n+            SimpleFeatureTypeBuilder builder = new SimpleFeatureTypeBuilder();\r\n+\r\n+            builder.setName(src.getName());\r\n+            builder.setCRS(crs);\r\n+\r\n+            builder.add(RETYPED_GEOM_COLUMN, Point.class);\r\n+            for (PropertyDescriptor ad : src.getDescriptors()) {\r\n+                builder.add((AttributeDescriptor) ad);\r\n+            }\r\n+            FeatureType newType = builder.buildFeatureType();\r\n+            newType.getUserData().put(RETYPED, true);\r\n+            return newType;\r\n+\r\n+        } catch (Exception e) {\r\n+            e.printStackTrace();\r", "originalCommit": "8b9ce7f4598d534cd8575d872f3e53986b116657", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzY3MDQ4NA==", "url": "https://github.com/geoserver/geoserver/pull/4031#discussion_r383670484", "bodyText": "will handle it", "author": "imranrajjad", "createdAt": "2020-02-25T05:49:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzQwMDE5Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzQwMDMwOQ==", "url": "https://github.com/geoserver/geoserver/pull/4031#discussion_r383400309", "bodyText": "?", "author": "nmco", "createdAt": "2020-02-24T17:17:09Z", "path": "src/main/src/test/java/org/geoserver/catalog/MockRetypeFeatureTypeCallback.java", "diffHunk": "@@ -0,0 +1,71 @@\n+/* (c) 2020 Open Source Geospatial Foundation - all rights reserved\r\n+ * This code is licensed under the GPL 2.0 license, available at the root\r\n+ * application directory.\r\n+ */\r\n+package org.geoserver.catalog;\r\n+\r\n+import org.geoserver.catalog.retype.MockRetypedSource;\r\n+import org.geotools.data.FeatureSource;\r\n+import org.geotools.data.simple.SimpleFeatureSource;\r\n+import org.geotools.feature.simple.SimpleFeatureTypeBuilder;\r\n+import org.geotools.referencing.CRS;\r\n+import org.locationtech.jts.geom.Point;\r\n+import org.opengis.feature.type.AttributeDescriptor;\r\n+import org.opengis.feature.type.FeatureType;\r\n+import org.opengis.feature.type.PropertyDescriptor;\r\n+import org.opengis.referencing.crs.CoordinateReferenceSystem;\r\n+\r\n+/**\r\n+ * This is a mock implementation\r\n+ *\r\n+ * @author ImranR\r\n+ */\r\n+public class MockRetypeFeatureTypeCallback implements RetypeFeatureTypeCallback {\r\n+\r\n+    public static final String RETYPED = \"RETYPED\";\r\n+    public static final String RETYPED_GEOM_COLUMN = \"GENERATED_POINT\";\r\n+\r\n+    public static final String LONG_FIELD = \"lon\";\r\n+    public static final String LAT_FIELD = \"lat\";\r\n+    public static final int EPSG_CODE = 4326;\r\n+\r\n+    @Override\r\n+    public FeatureType retypeFeatureType(FeatureTypeInfo featureTypeInfo, FeatureType src) {\r\n+        // only work for the test file : test/resources/org/geoserver/catalog/longlat.properties\r\n+        if (!RetypeFeatureTypeCallbackTest.LONG_LAT_NO_GEOM_ON_THE_FLY_LAYER.equalsIgnoreCase(\r\n+                featureTypeInfo.getName())) return src;\r\n+        try {\r\n+            CoordinateReferenceSystem crs = CRS.decode(\"EPSG:\" + EPSG_CODE);\r\n+            SimpleFeatureTypeBuilder builder = new SimpleFeatureTypeBuilder();\r\n+\r\n+            builder.setName(src.getName());\r\n+            builder.setCRS(crs);\r\n+\r\n+            builder.add(RETYPED_GEOM_COLUMN, Point.class);\r\n+            for (PropertyDescriptor ad : src.getDescriptors()) {\r\n+                builder.add((AttributeDescriptor) ad);\r\n+            }\r\n+            FeatureType newType = builder.buildFeatureType();\r\n+            newType.getUserData().put(RETYPED, true);\r\n+            return newType;\r\n+\r\n+        } catch (Exception e) {\r\n+            e.printStackTrace();\r\n+        }\r\n+        return src;\r\n+    }\r\n+\r\n+    @Override\r\n+    public FeatureSource wrapFeatureSource(\r\n+            FeatureTypeInfo featureTypeInfo, FeatureSource featureSource) {\r\n+        // only work for the test file : test/resources/org/geoserver/catalog/longlat.properties\r", "originalCommit": "8b9ce7f4598d534cd8575d872f3e53986b116657", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzY3MDUyMw==", "url": "https://github.com/geoserver/geoserver/pull/4031#discussion_r383670523", "bodyText": "this implementation will only work for vector layer using this property file as a data source. I will move Bean initiation inside the test", "author": "imranrajjad", "createdAt": "2020-02-25T05:49:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzQwMDMwOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzQwMTUyMg==", "url": "https://github.com/geoserver/geoserver/pull/4031#discussion_r383401522", "bodyText": "The JavaDoc of this class shoulder really explain what's going on: it will generate a geometry attribute on the fly? If that's the case it could also use a more focused named than MockRetypeFeatureTypeCallback.", "author": "nmco", "createdAt": "2020-02-24T17:19:18Z", "path": "src/main/src/test/java/org/geoserver/catalog/MockRetypeFeatureTypeCallback.java", "diffHunk": "@@ -0,0 +1,71 @@\n+/* (c) 2020 Open Source Geospatial Foundation - all rights reserved\r\n+ * This code is licensed under the GPL 2.0 license, available at the root\r\n+ * application directory.\r\n+ */\r\n+package org.geoserver.catalog;\r\n+\r\n+import org.geoserver.catalog.retype.MockRetypedSource;\r\n+import org.geotools.data.FeatureSource;\r\n+import org.geotools.data.simple.SimpleFeatureSource;\r\n+import org.geotools.feature.simple.SimpleFeatureTypeBuilder;\r\n+import org.geotools.referencing.CRS;\r\n+import org.locationtech.jts.geom.Point;\r\n+import org.opengis.feature.type.AttributeDescriptor;\r\n+import org.opengis.feature.type.FeatureType;\r\n+import org.opengis.feature.type.PropertyDescriptor;\r\n+import org.opengis.referencing.crs.CoordinateReferenceSystem;\r\n+\r\n+/**\r\n+ * This is a mock implementation\r\n+ *\r\n+ * @author ImranR\r\n+ */\r\n+public class MockRetypeFeatureTypeCallback implements RetypeFeatureTypeCallback {\r", "originalCommit": "8b9ce7f4598d534cd8575d872f3e53986b116657", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzQwMTgwOA==", "url": "https://github.com/geoserver/geoserver/pull/4031#discussion_r383401808", "bodyText": "?", "author": "nmco", "createdAt": "2020-02-24T17:19:48Z", "path": "src/main/src/test/java/org/geoserver/catalog/RetypeFeatureTypeCallbackTest.java", "diffHunk": "@@ -0,0 +1,98 @@\n+/* (c) 2020 Open Source Geospatial Foundation - all rights reserved\r\n+ * This code is licensed under the GPL 2.0 license, available at the root\r\n+ * application directory.\r\n+ */\r\n+package org.geoserver.catalog;\r\n+\r\n+import static org.junit.Assert.assertFalse;\r\n+import static org.junit.Assert.assertTrue;\r\n+\r\n+import java.io.IOException;\r\n+import java.util.HashMap;\r\n+import java.util.Map;\r\n+import javax.xml.namespace.QName;\r\n+import org.geoserver.data.test.MockData;\r\n+import org.geoserver.data.test.SystemTestData;\r\n+import org.geoserver.data.test.SystemTestData.LayerProperty;\r\n+import org.geoserver.test.GeoServerSystemTestSupport;\r\n+import org.geotools.data.FeatureSource;\r\n+import org.geotools.feature.FeatureIterator;\r\n+import org.geotools.referencing.CRS;\r\n+import org.junit.Test;\r\n+import org.locationtech.jts.geom.Point;\r\n+import org.opengis.feature.Feature;\r\n+import org.opengis.feature.type.FeatureType;\r\n+import org.opengis.referencing.crs.CoordinateReferenceSystem;\r\n+import org.vfny.geoserver.global.GeoServerFeatureSource;\r\n+\r\n+/**\r\n+ * This test makes use of mock RetypeFeatureTypeCallback implementation provided in\r", "originalCommit": "8b9ce7f4598d534cd8575d872f3e53986b116657", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzY3MTcwNQ==", "url": "https://github.com/geoserver/geoserver/pull/4031#discussion_r383671705", "bodyText": "will fix", "author": "imranrajjad", "createdAt": "2020-02-25T05:54:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzQwMTgwOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzQwMTg3NQ==", "url": "https://github.com/geoserver/geoserver/pull/4031#discussion_r383401875", "bodyText": "?", "author": "nmco", "createdAt": "2020-02-24T17:19:55Z", "path": "src/main/src/test/java/org/geoserver/catalog/RetypeFeatureTypeCallbackTest.java", "diffHunk": "@@ -0,0 +1,98 @@\n+/* (c) 2020 Open Source Geospatial Foundation - all rights reserved\r\n+ * This code is licensed under the GPL 2.0 license, available at the root\r\n+ * application directory.\r\n+ */\r\n+package org.geoserver.catalog;\r\n+\r\n+import static org.junit.Assert.assertFalse;\r\n+import static org.junit.Assert.assertTrue;\r\n+\r\n+import java.io.IOException;\r\n+import java.util.HashMap;\r\n+import java.util.Map;\r\n+import javax.xml.namespace.QName;\r\n+import org.geoserver.data.test.MockData;\r\n+import org.geoserver.data.test.SystemTestData;\r\n+import org.geoserver.data.test.SystemTestData.LayerProperty;\r\n+import org.geoserver.test.GeoServerSystemTestSupport;\r\n+import org.geotools.data.FeatureSource;\r\n+import org.geotools.feature.FeatureIterator;\r\n+import org.geotools.referencing.CRS;\r\n+import org.junit.Test;\r\n+import org.locationtech.jts.geom.Point;\r\n+import org.opengis.feature.Feature;\r\n+import org.opengis.feature.type.FeatureType;\r\n+import org.opengis.referencing.crs.CoordinateReferenceSystem;\r\n+import org.vfny.geoserver.global.GeoServerFeatureSource;\r\n+\r\n+/**\r\n+ * This test makes use of mock RetypeFeatureTypeCallback implementation provided in\r\n+ *\r\n+ * @author ImranR\r", "originalCommit": "8b9ce7f4598d534cd8575d872f3e53986b116657", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzY3MTcyNA==", "url": "https://github.com/geoserver/geoserver/pull/4031#discussion_r383671724", "bodyText": "will remove", "author": "imranrajjad", "createdAt": "2020-02-25T05:54:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzQwMTg3NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzQwMzI3OA==", "url": "https://github.com/geoserver/geoserver/pull/4031#discussion_r383403278", "bodyText": "This is the basic layer for a specific test, the method name is too generic.", "author": "nmco", "createdAt": "2020-02-24T17:22:19Z", "path": "src/main/src/test/java/org/geoserver/catalog/RetypeFeatureTypeCallbackTest.java", "diffHunk": "@@ -0,0 +1,98 @@\n+/* (c) 2020 Open Source Geospatial Foundation - all rights reserved\r\n+ * This code is licensed under the GPL 2.0 license, available at the root\r\n+ * application directory.\r\n+ */\r\n+package org.geoserver.catalog;\r\n+\r\n+import static org.junit.Assert.assertFalse;\r\n+import static org.junit.Assert.assertTrue;\r\n+\r\n+import java.io.IOException;\r\n+import java.util.HashMap;\r\n+import java.util.Map;\r\n+import javax.xml.namespace.QName;\r\n+import org.geoserver.data.test.MockData;\r\n+import org.geoserver.data.test.SystemTestData;\r\n+import org.geoserver.data.test.SystemTestData.LayerProperty;\r\n+import org.geoserver.test.GeoServerSystemTestSupport;\r\n+import org.geotools.data.FeatureSource;\r\n+import org.geotools.feature.FeatureIterator;\r\n+import org.geotools.referencing.CRS;\r\n+import org.junit.Test;\r\n+import org.locationtech.jts.geom.Point;\r\n+import org.opengis.feature.Feature;\r\n+import org.opengis.feature.type.FeatureType;\r\n+import org.opengis.referencing.crs.CoordinateReferenceSystem;\r\n+import org.vfny.geoserver.global.GeoServerFeatureSource;\r\n+\r\n+/**\r\n+ * This test makes use of mock RetypeFeatureTypeCallback implementation provided in\r\n+ *\r\n+ * @author ImranR\r\n+ */\r\n+public class RetypeFeatureTypeCallbackTest extends GeoServerSystemTestSupport {\r\n+\r\n+    public static final String LONG_LAT_NO_GEOM_ON_THE_FLY_LAYER = \"longlat\";\r\n+    public static final QName LONG_LAT_NO_GEOM_ON_THE_FLY_QNAME =\r\n+            new QName(\r\n+                    MockData.DEFAULT_PREFIX,\r\n+                    LONG_LAT_NO_GEOM_ON_THE_FLY_LAYER,\r\n+                    MockData.DEFAULT_PREFIX);\r\n+\r\n+    @Override\r\n+    protected void onSetUp(SystemTestData testData) throws Exception {\r\n+        super.onSetUp(testData);\r\n+        setupBasicLayer(testData);\r\n+    }\r\n+\r\n+    private void setupBasicLayer(SystemTestData testData) throws IOException {\r", "originalCommit": "8b9ce7f4598d534cd8575d872f3e53986b116657", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzY3MTc4Nw==", "url": "https://github.com/geoserver/geoserver/pull/4031#discussion_r383671787", "bodyText": "will change", "author": "imranrajjad", "createdAt": "2020-02-25T05:54:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzQwMzI3OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzQwNDgxNA==", "url": "https://github.com/geoserver/geoserver/pull/4031#discussion_r383404814", "bodyText": "This test performs at least three different tests:\n\nthat a geometry attribute will be generated on the fly, i.e. testing the extension points\nasserts that GeoServer re-projection still work, I would provide some context explained why we are explicitly tests this\nasserts that layer CQL filters are still working, same comment as for previous point\n\nPlease implemented different tests properly documented, this will make the tests easier to debug, understand and resilient.", "author": "nmco", "createdAt": "2020-02-24T17:25:01Z", "path": "src/main/src/test/java/org/geoserver/catalog/RetypeFeatureTypeCallbackTest.java", "diffHunk": "@@ -0,0 +1,98 @@\n+/* (c) 2020 Open Source Geospatial Foundation - all rights reserved\r\n+ * This code is licensed under the GPL 2.0 license, available at the root\r\n+ * application directory.\r\n+ */\r\n+package org.geoserver.catalog;\r\n+\r\n+import static org.junit.Assert.assertFalse;\r\n+import static org.junit.Assert.assertTrue;\r\n+\r\n+import java.io.IOException;\r\n+import java.util.HashMap;\r\n+import java.util.Map;\r\n+import javax.xml.namespace.QName;\r\n+import org.geoserver.data.test.MockData;\r\n+import org.geoserver.data.test.SystemTestData;\r\n+import org.geoserver.data.test.SystemTestData.LayerProperty;\r\n+import org.geoserver.test.GeoServerSystemTestSupport;\r\n+import org.geotools.data.FeatureSource;\r\n+import org.geotools.feature.FeatureIterator;\r\n+import org.geotools.referencing.CRS;\r\n+import org.junit.Test;\r\n+import org.locationtech.jts.geom.Point;\r\n+import org.opengis.feature.Feature;\r\n+import org.opengis.feature.type.FeatureType;\r\n+import org.opengis.referencing.crs.CoordinateReferenceSystem;\r\n+import org.vfny.geoserver.global.GeoServerFeatureSource;\r\n+\r\n+/**\r\n+ * This test makes use of mock RetypeFeatureTypeCallback implementation provided in\r\n+ *\r\n+ * @author ImranR\r\n+ */\r\n+public class RetypeFeatureTypeCallbackTest extends GeoServerSystemTestSupport {\r\n+\r\n+    public static final String LONG_LAT_NO_GEOM_ON_THE_FLY_LAYER = \"longlat\";\r\n+    public static final QName LONG_LAT_NO_GEOM_ON_THE_FLY_QNAME =\r\n+            new QName(\r\n+                    MockData.DEFAULT_PREFIX,\r\n+                    LONG_LAT_NO_GEOM_ON_THE_FLY_LAYER,\r\n+                    MockData.DEFAULT_PREFIX);\r\n+\r\n+    @Override\r\n+    protected void onSetUp(SystemTestData testData) throws Exception {\r\n+        super.onSetUp(testData);\r\n+        setupBasicLayer(testData);\r\n+    }\r\n+\r\n+    private void setupBasicLayer(SystemTestData testData) throws IOException {\r\n+        Map<LayerProperty, Object> props = new HashMap<LayerProperty, Object>();\r\n+        props.put(LayerProperty.PROJECTION_POLICY, ProjectionPolicy.REPROJECT_TO_DECLARED);\r\n+        props.put(LayerProperty.SRS, 3857);\r\n+        // Loading a layer with location given as latitude and longitude and no geometry\r\n+        testData.addVectorLayer(\r\n+                LONG_LAT_NO_GEOM_ON_THE_FLY_QNAME,\r\n+                props,\r\n+                LONG_LAT_NO_GEOM_ON_THE_FLY_LAYER + \".properties\",\r\n+                getClass(),\r\n+                getCatalog());\r\n+    }\r\n+\r\n+    @Test\r\n+    public void testResourcePoolOperations() throws Exception {\r\n+        ResourcePool pool = ResourcePool.create(getCatalog());\r", "originalCommit": "8b9ce7f4598d534cd8575d872f3e53986b116657", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzY3NzYwNw==", "url": "https://github.com/geoserver/geoserver/pull/4031#discussion_r383677607", "bodyText": "added", "author": "imranrajjad", "createdAt": "2020-02-25T06:17:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzQwNDgxNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzQwNDk3MQ==", "url": "https://github.com/geoserver/geoserver/pull/4031#discussion_r383404971", "bodyText": "?", "author": "nmco", "createdAt": "2020-02-24T17:25:16Z", "path": "src/main/src/test/java/org/geoserver/catalog/retype/MockRetypedFeatureCollection.java", "diffHunk": "@@ -0,0 +1,69 @@\n+/* (c) 2020 Open Source Geospatial Foundation - all rights reserved\r\n+ * This code is licensed under the GPL 2.0 license, available at the root\r\n+ * application directory.\r\n+ */\r\n+package org.geoserver.catalog.retype;\r\n+\r\n+import java.util.NoSuchElementException;\r\n+import org.geoserver.catalog.FeatureTypeInfo;\r\n+import org.geotools.data.simple.SimpleFeatureCollection;\r\n+import org.geotools.data.simple.SimpleFeatureIterator;\r\n+import org.geotools.feature.collection.DecoratingSimpleFeatureCollection;\r\n+import org.opengis.feature.simple.SimpleFeature;\r\n+import org.opengis.feature.simple.SimpleFeatureType;\r\n+\r\n+/*\r\n+ * A Mock implementation of DecoratingSimpleFeatureCollection to handle features with geometries generated on the fly\r", "originalCommit": "8b9ce7f4598d534cd8575d872f3e53986b116657", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzY3Nzc2MQ==", "url": "https://github.com/geoserver/geoserver/pull/4031#discussion_r383677761", "bodyText": "removed", "author": "imranrajjad", "createdAt": "2020-02-25T06:17:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzQwNDk3MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzQwNTY1NA==", "url": "https://github.com/geoserver/geoserver/pull/4031#discussion_r383405654", "bodyText": "Looks like this is formatted like a poem, not even sure how this passed the auto formatting validation.", "author": "nmco", "createdAt": "2020-02-24T17:26:30Z", "path": "src/main/src/test/java/org/geoserver/catalog/retype/MockRetypedFeatureConverter.java", "diffHunk": "@@ -0,0 +1,142 @@\n+/* (c) 2020 Open Source Geospatial Foundation - all rights reserved\r\n+ * This code is licensed under the GPL 2.0 license, available at the root\r\n+ * application directory.\r\n+ */\r\n+package org.geoserver.catalog.retype;\r\n+\r\n+import static java.util.Optional.ofNullable;\r\n+\r\n+import java.util.ArrayList;\r\n+import java.util.Arrays;\r\n+import java.util.LinkedList;\r\n+import java.util.List;\r\n+import java.util.stream.Collectors;\r\n+import org.geoserver.catalog.FeatureTypeInfo;\r\n+import org.geoserver.catalog.MockRetypeFeatureTypeCallback;\r\n+import org.geotools.data.Query;\r\n+import org.geotools.feature.simple.SimpleFeatureBuilder;\r\n+import org.geotools.feature.simple.SimpleFeatureTypeBuilder;\r\n+import org.geotools.geometry.jts.JTSFactoryFinder;\r\n+import org.geotools.referencing.CRS;\r\n+import org.locationtech.jts.geom.Coordinate;\r\n+import org.locationtech.jts.geom.GeometryFactory;\r\n+import org.locationtech.jts.geom.Point;\r\n+import org.opengis.feature.Property;\r\n+import org.opengis.feature.simple.SimpleFeature;\r\n+import org.opengis.feature.simple.SimpleFeatureType;\r\n+import org.opengis.feature.type.AttributeDescriptor;\r\n+\r\n+/*\r\n+ * A Mock Converter Helper class to demonstrate how to\r\n+ * Retype Feature by generating Geometries on the fly\r\n+ * Defining Geomtry attribute on the fly\r\n+ * Query handling which ensure that dynamic field is not delegated to Data Store\r\n+ *\r", "originalCommit": "8b9ce7f4598d534cd8575d872f3e53986b116657", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzY3NzgxNQ==", "url": "https://github.com/geoserver/geoserver/pull/4031#discussion_r383677815", "bodyText": "will remove", "author": "imranrajjad", "createdAt": "2020-02-25T06:17:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzQwNTY1NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzQwNjMyNQ==", "url": "https://github.com/geoserver/geoserver/pull/4031#discussion_r383406325", "bodyText": "Why this generic ``Mock```names? This doesn't mock anything and its not generic no? This implements a concrete behavior to validate an extension point no? Why not put this class inside the test a private static inner classes?", "author": "nmco", "createdAt": "2020-02-24T17:27:49Z", "path": "src/main/src/test/java/org/geoserver/catalog/retype/MockRetypedFeatureConverter.java", "diffHunk": "@@ -0,0 +1,142 @@\n+/* (c) 2020 Open Source Geospatial Foundation - all rights reserved\r\n+ * This code is licensed under the GPL 2.0 license, available at the root\r\n+ * application directory.\r\n+ */\r\n+package org.geoserver.catalog.retype;\r\n+\r\n+import static java.util.Optional.ofNullable;\r\n+\r\n+import java.util.ArrayList;\r\n+import java.util.Arrays;\r\n+import java.util.LinkedList;\r\n+import java.util.List;\r\n+import java.util.stream.Collectors;\r\n+import org.geoserver.catalog.FeatureTypeInfo;\r\n+import org.geoserver.catalog.MockRetypeFeatureTypeCallback;\r\n+import org.geotools.data.Query;\r\n+import org.geotools.feature.simple.SimpleFeatureBuilder;\r\n+import org.geotools.feature.simple.SimpleFeatureTypeBuilder;\r\n+import org.geotools.geometry.jts.JTSFactoryFinder;\r\n+import org.geotools.referencing.CRS;\r\n+import org.locationtech.jts.geom.Coordinate;\r\n+import org.locationtech.jts.geom.GeometryFactory;\r\n+import org.locationtech.jts.geom.Point;\r\n+import org.opengis.feature.Property;\r\n+import org.opengis.feature.simple.SimpleFeature;\r\n+import org.opengis.feature.simple.SimpleFeatureType;\r\n+import org.opengis.feature.type.AttributeDescriptor;\r\n+\r\n+/*\r\n+ * A Mock Converter Helper class to demonstrate how to\r\n+ * Retype Feature by generating Geometries on the fly\r\n+ * Defining Geomtry attribute on the fly\r\n+ * Query handling which ensure that dynamic field is not delegated to Data Store\r\n+ *\r\n+ * **/\r\n+public class MockRetypedFeatureConverter {\r", "originalCommit": "8b9ce7f4598d534cd8575d872f3e53986b116657", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzY3ODI0Mg==", "url": "https://github.com/geoserver/geoserver/pull/4031#discussion_r383678242", "bodyText": "will change the name, its being used in two classes as a helper class hence cannot be made private inner static", "author": "imranrajjad", "createdAt": "2020-02-25T06:19:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzQwNjMyNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzQwNjQxMQ==", "url": "https://github.com/geoserver/geoserver/pull/4031#discussion_r383406411", "bodyText": "?", "author": "nmco", "createdAt": "2020-02-24T17:27:57Z", "path": "src/main/src/test/java/org/geoserver/catalog/retype/MockRetypedFeatureConverter.java", "diffHunk": "@@ -0,0 +1,142 @@\n+/* (c) 2020 Open Source Geospatial Foundation - all rights reserved\r\n+ * This code is licensed under the GPL 2.0 license, available at the root\r\n+ * application directory.\r\n+ */\r\n+package org.geoserver.catalog.retype;\r\n+\r\n+import static java.util.Optional.ofNullable;\r\n+\r\n+import java.util.ArrayList;\r\n+import java.util.Arrays;\r\n+import java.util.LinkedList;\r\n+import java.util.List;\r\n+import java.util.stream.Collectors;\r\n+import org.geoserver.catalog.FeatureTypeInfo;\r\n+import org.geoserver.catalog.MockRetypeFeatureTypeCallback;\r\n+import org.geotools.data.Query;\r\n+import org.geotools.feature.simple.SimpleFeatureBuilder;\r\n+import org.geotools.feature.simple.SimpleFeatureTypeBuilder;\r\n+import org.geotools.geometry.jts.JTSFactoryFinder;\r\n+import org.geotools.referencing.CRS;\r\n+import org.locationtech.jts.geom.Coordinate;\r\n+import org.locationtech.jts.geom.GeometryFactory;\r\n+import org.locationtech.jts.geom.Point;\r\n+import org.opengis.feature.Property;\r\n+import org.opengis.feature.simple.SimpleFeature;\r\n+import org.opengis.feature.simple.SimpleFeatureType;\r\n+import org.opengis.feature.type.AttributeDescriptor;\r\n+\r\n+/*\r\n+ * A Mock Converter Helper class to demonstrate how to\r\n+ * Retype Feature by generating Geometries on the fly\r\n+ * Defining Geomtry attribute on the fly\r\n+ * Query handling which ensure that dynamic field is not delegated to Data Store\r\n+ *\r\n+ * **/\r\n+public class MockRetypedFeatureConverter {\r\n+    private final GeometryFactory geometryFactory = JTSFactoryFinder.getGeometryFactory();\r\n+\r\n+    public SimpleFeature generateGeometry(\r\n+            FeatureTypeInfo info, SimpleFeatureType schema, SimpleFeature simpleFeature) {\r\n+        if (simpleFeature != null) {\r\n+            try {\r\n+                SimpleFeatureBuilder featureBuilder = new SimpleFeatureBuilder(schema);\r\n+                Double x =\r\n+                        Double.valueOf(\r\n+                                getAsString(\r\n+                                        simpleFeature, MockRetypeFeatureTypeCallback.LONG_FIELD));\r\n+                Double y =\r\n+                        Double.valueOf(\r\n+                                getAsString(\r\n+                                        simpleFeature, MockRetypeFeatureTypeCallback.LAT_FIELD));\r\n+\r\n+                Point point = geometryFactory.createPoint(new Coordinate(x, y));\r\n+                point.setSRID(MockRetypeFeatureTypeCallback.EPSG_CODE);\r\n+\r\n+                featureBuilder.add(point);\r\n+                for (Property prop : simpleFeature.getProperties()) {\r\n+                    featureBuilder.set(prop.getName(), prop.getValue());\r\n+                }\r\n+                simpleFeature = featureBuilder.buildFeature(simpleFeature.getID());\r\n+            } catch (Exception e) {\r\n+\r", "originalCommit": "8b9ce7f4598d534cd8575d872f3e53986b116657", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzY4MDE0OQ==", "url": "https://github.com/geoserver/geoserver/pull/4031#discussion_r383680149", "bodyText": "will handle", "author": "imranrajjad", "createdAt": "2020-02-25T06:26:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzQwNjQxMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzQwNjUxMw==", "url": "https://github.com/geoserver/geoserver/pull/4031#discussion_r383406513", "bodyText": "?", "author": "nmco", "createdAt": "2020-02-24T17:28:07Z", "path": "src/main/src/test/java/org/geoserver/catalog/retype/MockRetypedFeatureConverter.java", "diffHunk": "@@ -0,0 +1,142 @@\n+/* (c) 2020 Open Source Geospatial Foundation - all rights reserved\r\n+ * This code is licensed under the GPL 2.0 license, available at the root\r\n+ * application directory.\r\n+ */\r\n+package org.geoserver.catalog.retype;\r\n+\r\n+import static java.util.Optional.ofNullable;\r\n+\r\n+import java.util.ArrayList;\r\n+import java.util.Arrays;\r\n+import java.util.LinkedList;\r\n+import java.util.List;\r\n+import java.util.stream.Collectors;\r\n+import org.geoserver.catalog.FeatureTypeInfo;\r\n+import org.geoserver.catalog.MockRetypeFeatureTypeCallback;\r\n+import org.geotools.data.Query;\r\n+import org.geotools.feature.simple.SimpleFeatureBuilder;\r\n+import org.geotools.feature.simple.SimpleFeatureTypeBuilder;\r\n+import org.geotools.geometry.jts.JTSFactoryFinder;\r\n+import org.geotools.referencing.CRS;\r\n+import org.locationtech.jts.geom.Coordinate;\r\n+import org.locationtech.jts.geom.GeometryFactory;\r\n+import org.locationtech.jts.geom.Point;\r\n+import org.opengis.feature.Property;\r\n+import org.opengis.feature.simple.SimpleFeature;\r\n+import org.opengis.feature.simple.SimpleFeatureType;\r\n+import org.opengis.feature.type.AttributeDescriptor;\r\n+\r\n+/*\r\n+ * A Mock Converter Helper class to demonstrate how to\r\n+ * Retype Feature by generating Geometries on the fly\r\n+ * Defining Geomtry attribute on the fly\r\n+ * Query handling which ensure that dynamic field is not delegated to Data Store\r\n+ *\r\n+ * **/\r\n+public class MockRetypedFeatureConverter {\r\n+    private final GeometryFactory geometryFactory = JTSFactoryFinder.getGeometryFactory();\r\n+\r\n+    public SimpleFeature generateGeometry(\r\n+            FeatureTypeInfo info, SimpleFeatureType schema, SimpleFeature simpleFeature) {\r\n+        if (simpleFeature != null) {\r\n+            try {\r\n+                SimpleFeatureBuilder featureBuilder = new SimpleFeatureBuilder(schema);\r\n+                Double x =\r\n+                        Double.valueOf(\r\n+                                getAsString(\r\n+                                        simpleFeature, MockRetypeFeatureTypeCallback.LONG_FIELD));\r\n+                Double y =\r\n+                        Double.valueOf(\r\n+                                getAsString(\r\n+                                        simpleFeature, MockRetypeFeatureTypeCallback.LAT_FIELD));\r\n+\r\n+                Point point = geometryFactory.createPoint(new Coordinate(x, y));\r\n+                point.setSRID(MockRetypeFeatureTypeCallback.EPSG_CODE);\r\n+\r\n+                featureBuilder.add(point);\r\n+                for (Property prop : simpleFeature.getProperties()) {\r\n+                    featureBuilder.set(prop.getName(), prop.getValue());\r\n+                }\r\n+                simpleFeature = featureBuilder.buildFeature(simpleFeature.getID());\r\n+            } catch (Exception e) {\r\n+\r\n+            }\r\n+        }\r\n+        return simpleFeature;\r\n+    }\r\n+\r\n+    private String getAsString(SimpleFeature simpleFeature, String name) {\r", "originalCommit": "8b9ce7f4598d534cd8575d872f3e53986b116657", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzQwNjY0Mg==", "url": "https://github.com/geoserver/geoserver/pull/4031#discussion_r383406642", "bodyText": "?", "author": "nmco", "createdAt": "2020-02-24T17:28:23Z", "path": "src/main/src/test/java/org/geoserver/catalog/retype/MockRetypedFeatureConverter.java", "diffHunk": "@@ -0,0 +1,142 @@\n+/* (c) 2020 Open Source Geospatial Foundation - all rights reserved\r\n+ * This code is licensed under the GPL 2.0 license, available at the root\r\n+ * application directory.\r\n+ */\r\n+package org.geoserver.catalog.retype;\r\n+\r\n+import static java.util.Optional.ofNullable;\r\n+\r\n+import java.util.ArrayList;\r\n+import java.util.Arrays;\r\n+import java.util.LinkedList;\r\n+import java.util.List;\r\n+import java.util.stream.Collectors;\r\n+import org.geoserver.catalog.FeatureTypeInfo;\r\n+import org.geoserver.catalog.MockRetypeFeatureTypeCallback;\r\n+import org.geotools.data.Query;\r\n+import org.geotools.feature.simple.SimpleFeatureBuilder;\r\n+import org.geotools.feature.simple.SimpleFeatureTypeBuilder;\r\n+import org.geotools.geometry.jts.JTSFactoryFinder;\r\n+import org.geotools.referencing.CRS;\r\n+import org.locationtech.jts.geom.Coordinate;\r\n+import org.locationtech.jts.geom.GeometryFactory;\r\n+import org.locationtech.jts.geom.Point;\r\n+import org.opengis.feature.Property;\r\n+import org.opengis.feature.simple.SimpleFeature;\r\n+import org.opengis.feature.simple.SimpleFeatureType;\r\n+import org.opengis.feature.type.AttributeDescriptor;\r\n+\r\n+/*\r\n+ * A Mock Converter Helper class to demonstrate how to\r\n+ * Retype Feature by generating Geometries on the fly\r\n+ * Defining Geomtry attribute on the fly\r\n+ * Query handling which ensure that dynamic field is not delegated to Data Store\r\n+ *\r\n+ * **/\r\n+public class MockRetypedFeatureConverter {\r\n+    private final GeometryFactory geometryFactory = JTSFactoryFinder.getGeometryFactory();\r\n+\r\n+    public SimpleFeature generateGeometry(\r\n+            FeatureTypeInfo info, SimpleFeatureType schema, SimpleFeature simpleFeature) {\r\n+        if (simpleFeature != null) {\r\n+            try {\r\n+                SimpleFeatureBuilder featureBuilder = new SimpleFeatureBuilder(schema);\r\n+                Double x =\r\n+                        Double.valueOf(\r\n+                                getAsString(\r\n+                                        simpleFeature, MockRetypeFeatureTypeCallback.LONG_FIELD));\r\n+                Double y =\r\n+                        Double.valueOf(\r\n+                                getAsString(\r\n+                                        simpleFeature, MockRetypeFeatureTypeCallback.LAT_FIELD));\r\n+\r\n+                Point point = geometryFactory.createPoint(new Coordinate(x, y));\r\n+                point.setSRID(MockRetypeFeatureTypeCallback.EPSG_CODE);\r\n+\r\n+                featureBuilder.add(point);\r\n+                for (Property prop : simpleFeature.getProperties()) {\r\n+                    featureBuilder.set(prop.getName(), prop.getValue());\r\n+                }\r\n+                simpleFeature = featureBuilder.buildFeature(simpleFeature.getID());\r\n+            } catch (Exception e) {\r\n+\r\n+            }\r\n+        }\r\n+        return simpleFeature;\r\n+    }\r\n+\r\n+    private String getAsString(SimpleFeature simpleFeature, String name) {\r\n+        return ofNullable(simpleFeature.getProperty(name))\r\n+                .flatMap(property -> ofNullable(property.getValue()))\r\n+                .map(Object::toString)\r\n+                .orElseThrow(\r\n+                        () ->\r\n+                                new IllegalArgumentException(\r\n+                                        String.format(\"cannot get value of property [%s]\", name)));\r\n+    }\r\n+\r\n+    public SimpleFeatureType defineGeometryAttributeFor(FeatureTypeInfo info, SimpleFeatureType src)\r\n+            throws Exception {\r\n+\r\n+        SimpleFeatureTypeBuilder builder = new SimpleFeatureTypeBuilder();\r\n+\r\n+        builder.setName(src.getName());\r\n+        builder.setCRS(CRS.decode(\"EPSG:\" + MockRetypeFeatureTypeCallback.EPSG_CODE));\r\n+\r\n+        builder.add(MockRetypeFeatureTypeCallback.RETYPED_GEOM_COLUMN, Point.class);\r\n+        for (AttributeDescriptor ad : src.getAttributeDescriptors()) {\r\n+            if (!ad.getLocalName()\r\n+                    .equalsIgnoreCase(MockRetypeFeatureTypeCallback.RETYPED_GEOM_COLUMN)) {\r\n+                builder.add(ad);\r\n+            }\r\n+        }\r\n+        SimpleFeatureType simpleFeatureType = builder.buildFeatureType();\r\n+\r\n+        return simpleFeatureType;\r\n+    }\r\n+\r\n+    public Query convertQuery(FeatureTypeInfo info, Query query) {\r\n+\r\n+        Query q = new Query(query);\r\n+        List<String> properties = new ArrayList<>();\r\n+        try {\r\n+            // no fields were sent, use all fields excluding geom field\r\n+            if (query.getPropertyNames() == null) {\r\n+                properties =\r\n+                        info.getFeatureType()\r\n+                                .getDescriptors()\r\n+                                .stream()\r\n+                                .filter(\r\n+                                        propertyDescriptor ->\r\n+                                                !propertyDescriptor\r\n+                                                        .getName()\r\n+                                                        .toString()\r\n+                                                        .equals(\r\n+                                                                MockRetypeFeatureTypeCallback\r\n+                                                                        .RETYPED_GEOM_COLUMN))\r\n+                                .map(propertyDescriptor -> propertyDescriptor.getName().toString())\r\n+                                .collect(Collectors.toList());\r\n+            } else {\r\n+                // else use the passed fields of this query\r\n+                // but make sure geom field is replaced with Long and Lat fields\r\n+                List<String> existingProperties =\r\n+                        new LinkedList<String>(Arrays.asList(query.getPropertyNames()));\r\n+                // remove geom column\r\n+                existingProperties.remove(MockRetypeFeatureTypeCallback.RETYPED_GEOM_COLUMN);\r\n+                // make sure longitude field is present\r\n+                if (!existingProperties.contains(MockRetypeFeatureTypeCallback.LONG_FIELD))\r\n+                    existingProperties.add(MockRetypeFeatureTypeCallback.LONG_FIELD);\r\n+                // make sure latitude field is present\r\n+                if (!existingProperties.contains(MockRetypeFeatureTypeCallback.LAT_FIELD))\r\n+                    existingProperties.add(MockRetypeFeatureTypeCallback.LAT_FIELD);\r\n+\r\n+                properties = new ArrayList<>(existingProperties);\r\n+            }\r\n+\r\n+        } catch (Exception e) {\r\n+            e.printStackTrace();\r", "originalCommit": "8b9ce7f4598d534cd8575d872f3e53986b116657", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzQwNjc4MQ==", "url": "https://github.com/geoserver/geoserver/pull/4031#discussion_r383406781", "bodyText": "Same comments above.", "author": "nmco", "createdAt": "2020-02-24T17:28:37Z", "path": "src/main/src/test/java/org/geoserver/catalog/retype/MockRetypedSource.java", "diffHunk": "@@ -0,0 +1,75 @@\n+/* (c) 2020 Open Source Geospatial Foundation - all rights reserved\r\n+ * This code is licensed under the GPL 2.0 license, available at the root\r\n+ * application directory.\r\n+ */\r\n+package org.geoserver.catalog.retype;\r\n+\r\n+import java.io.IOException;\r\n+import org.geoserver.catalog.FeatureTypeInfo;\r\n+import org.geoserver.security.decorators.DecoratingSimpleFeatureSource;\r\n+import org.geotools.data.Query;\r\n+import org.geotools.data.simple.SimpleFeatureCollection;\r\n+import org.geotools.data.simple.SimpleFeatureSource;\r\n+import org.opengis.feature.simple.SimpleFeatureType;\r\n+import org.opengis.filter.Filter;\r\n+\r\n+/*\r\n+ * A Mock Retyped Feature Source demonstrating how to handle dynamic dynamic Geometry generations\r\n+ * */\r\n+public class MockRetypedSource extends DecoratingSimpleFeatureSource {\r", "originalCommit": "8b9ce7f4598d534cd8575d872f3e53986b116657", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzY4MDIxNA==", "url": "https://github.com/geoserver/geoserver/pull/4031#discussion_r383680214", "bodyText": "will remove", "author": "imranrajjad", "createdAt": "2020-02-25T06:26:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzQwNjc4MQ=="}], "type": "inlineReview"}, {"oid": "6bf5b0e990fd0f3d0f07128da12cd8c58c7d2878", "url": "https://github.com/geoserver/geoserver/commit/6bf5b0e990fd0f3d0f07128da12cd8c58c7d2878", "message": "[GEOS-9487] rev 2\n\n-fixed java docs\n-requested refactors\n-moved bean init to unit test from applicationContext.xml", "committedDate": "2020-02-25T06:54:17Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjI4NzMzMA==", "url": "https://github.com/geoserver/geoserver/pull/4031#discussion_r386287330", "bodyText": "?", "author": "nmco", "createdAt": "2020-03-02T09:45:54Z", "path": "src/main/src/test/java/org/geoserver/catalog/RetypeFeatureTypeCallbackTest.java", "diffHunk": "@@ -0,0 +1,467 @@\n+/* (c) 2020 Open Source Geospatial Foundation - all rights reserved\r\n+ * This code is licensed under the GPL 2.0 license, available at the root\r\n+ * application directory.\r\n+ */\r\n+package org.geoserver.catalog;\r\n+\r\n+import static java.util.Optional.ofNullable;\r\n+import static org.junit.Assert.assertFalse;\r\n+import static org.junit.Assert.assertTrue;\r\n+\r\n+import java.io.IOException;\r\n+import java.util.ArrayList;\r\n+import java.util.Arrays;\r\n+import java.util.HashMap;\r\n+import java.util.LinkedList;\r\n+import java.util.List;\r\n+import java.util.Map;\r\n+import java.util.NoSuchElementException;\r\n+import java.util.logging.Level;\r\n+import java.util.logging.Logger;\r\n+import java.util.stream.Collectors;\r\n+import javax.xml.namespace.QName;\r\n+import org.geoserver.data.test.MockData;\r\n+import org.geoserver.data.test.SystemTestData;\r\n+import org.geoserver.data.test.SystemTestData.LayerProperty;\r\n+import org.geoserver.platform.GeoServerExtensionsHelper;\r\n+import org.geoserver.security.decorators.DecoratingSimpleFeatureSource;\r\n+import org.geoserver.test.GeoServerSystemTestSupport;\r\n+import org.geotools.data.FeatureSource;\r\n+import org.geotools.data.Query;\r\n+import org.geotools.data.simple.SimpleFeatureCollection;\r\n+import org.geotools.data.simple.SimpleFeatureIterator;\r\n+import org.geotools.data.simple.SimpleFeatureSource;\r\n+import org.geotools.feature.FeatureIterator;\r\n+import org.geotools.feature.collection.DecoratingSimpleFeatureCollection;\r\n+import org.geotools.feature.simple.SimpleFeatureBuilder;\r\n+import org.geotools.feature.simple.SimpleFeatureTypeBuilder;\r\n+import org.geotools.geometry.jts.JTSFactoryFinder;\r\n+import org.geotools.referencing.CRS;\r\n+import org.junit.Test;\r\n+import org.locationtech.jts.geom.Coordinate;\r\n+import org.locationtech.jts.geom.GeometryFactory;\r\n+import org.locationtech.jts.geom.Point;\r\n+import org.opengis.feature.Feature;\r\n+import org.opengis.feature.Property;\r\n+import org.opengis.feature.simple.SimpleFeature;\r\n+import org.opengis.feature.simple.SimpleFeatureType;\r\n+import org.opengis.feature.type.AttributeDescriptor;\r\n+import org.opengis.feature.type.FeatureType;\r\n+import org.opengis.feature.type.PropertyDescriptor;\r\n+import org.opengis.filter.Filter;\r\n+import org.opengis.referencing.crs.CoordinateReferenceSystem;\r\n+import org.vfny.geoserver.global.GeoServerFeatureSource;\r\n+\r\n+/**\r\n+ * This test asserts the an implementation of RetypeFeatureTypeCallback is integrated properly with\r\n+ * GeoServerFeatureSource wrapper. The test asserts that when a feature type is retyped through\r\n+ * RetypeFeatureTypeCallback implementation, it does not break or override the functionality\r\n+ * provided by GeoServerFeatureSource wrapper.\r\n+ */\r\n+public class RetypeFeatureTypeCallbackTest extends GeoServerSystemTestSupport {\r\n+\r\n+    public static final String LONG_LAT_NO_GEOM_ON_THE_FLY_LAYER_FILE = \"longlat.properties\";\r\n+    public static final QName LONG_LAT_NO_GEOM_ON_THE_FLY_QNAME =\r\n+            new QName(MockData.DEFAULT_PREFIX, \"longlat\", MockData.DEFAULT_PREFIX);\r\n+\r\n+    public static final QName LONG_LAT_NO_GEOM_ON_THE_FLY_QNAME_REPROJECTED =\r\n+            new QName(MockData.DEFAULT_PREFIX, \"longlat_reprojected\", MockData.DEFAULT_PREFIX);\r\n+\r\n+    @Override\r\n+    protected void onSetUp(SystemTestData testData) throws Exception {\r\n+        // registering singleton for this test only\r\n+        TestRetypeFeatureTypeCallback o2 = new TestRetypeFeatureTypeCallback();\r\n+        GeoServerExtensionsHelper.singleton(\r\n+                \"retypeFeatureTypeCallbackTest\", o2, RetypeFeatureTypeCallback.class);\r\n+\r\n+        super.onSetUp(testData);\r\n+        setUpNonGeometryLayer(testData);\r\n+        setReprojectedUpNonGeometryLayer(testData);\r\n+    }\r\n+\r\n+    private void setUpNonGeometryLayer(SystemTestData testData) throws IOException {\r\n+        // Loading a vector layer with location given as latitude and longitude and no geometry\r\n+        Map<LayerProperty, Object> props = new HashMap<LayerProperty, Object>();\r\n+        testData.addVectorLayer(\r\n+                LONG_LAT_NO_GEOM_ON_THE_FLY_QNAME,\r\n+                props,\r\n+                LONG_LAT_NO_GEOM_ON_THE_FLY_LAYER_FILE,\r\n+                getClass(),\r\n+                getCatalog());\r\n+    }\r\n+\r\n+    private void setReprojectedUpNonGeometryLayer(SystemTestData testData) throws IOException {\r\n+        // Loading a vector layer with location given as latitude and longitude and no geometry\r\n+        Map<LayerProperty, Object> props = new HashMap<LayerProperty, Object>();\r\n+        // declaring a different CRS to test re-projection\r\n+        props.put(LayerProperty.PROJECTION_POLICY, ProjectionPolicy.REPROJECT_TO_DECLARED);\r\n+        props.put(LayerProperty.SRS, 900913);\r\n+        testData.addVectorLayer(\r\n+                LONG_LAT_NO_GEOM_ON_THE_FLY_QNAME_REPROJECTED,\r\n+                props,\r\n+                LONG_LAT_NO_GEOM_ON_THE_FLY_LAYER_FILE,\r\n+                getClass(),\r\n+                getCatalog());\r\n+    }\r\n+\r\n+    @Test\r\n+    public void testGeometryCreation() throws Exception {\r\n+        ResourcePool pool = ResourcePool.create(getCatalog());\r\n+        FeatureTypeInfo info =\r\n+                getCatalog()\r\n+                        .getFeatureTypeByName(\r\n+                                LONG_LAT_NO_GEOM_ON_THE_FLY_QNAME.getNamespaceURI(),\r\n+                                LONG_LAT_NO_GEOM_ON_THE_FLY_QNAME.getLocalPart());\r\n+        FeatureType ft1 = pool.getFeatureType(info);\r\n+\r\n+        // assert that feature type is returned with a point geometry\r\n+        assertTrue(ft1.getUserData().containsKey(TestRetypeFeatureTypeCallback.RETYPED));\r\n+        assertTrue(ft1.getGeometryDescriptor().getType().getBinding().equals(Point.class));\r\n+\r\n+        FeatureSource retyped = pool.getFeatureSource(info, null);\r\n+        // assert FeatureSource is nicely wrapped inside Geoserver wrapper\r\n+        assertTrue(retyped instanceof GeoServerFeatureSource);\r\n+        // assert FeatureSource has Geometry type set to Point\r\n+        assertTrue(\r\n+                retyped.getSchema()\r\n+                        .getGeometryDescriptor()\r\n+                        .getType()\r\n+                        .getBinding()\r\n+                        .equals(Point.class));\r\n+        AttributeDescriptor geomAttibute =\r\n+                (AttributeDescriptor) retyped.getSchema().getGeometryDescriptor().getDefaultValue();\r\n+        // Finally assert that each features has a valid geometry\r\n+        try (FeatureIterator iterator = retyped.getFeatures().features()) {\r\n+            while (iterator.hasNext()) {\r\n+                Feature feature = iterator.next();\r\n+                assertTrue(feature.getDefaultGeometryProperty().getValue() instanceof Point);\r\n+            }\r\n+        }\r\n+    }\r\n+\r\n+    @Test\r\n+    public void testReProjection() throws Exception {\r\n+        ResourcePool pool = ResourcePool.create(getCatalog());\r\n+        FeatureTypeInfo info =\r\n+                getCatalog()\r\n+                        .getFeatureTypeByName(\r\n+                                LONG_LAT_NO_GEOM_ON_THE_FLY_QNAME_REPROJECTED.getNamespaceURI(),\r\n+                                LONG_LAT_NO_GEOM_ON_THE_FLY_QNAME_REPROJECTED.getLocalPart());\r\n+\r\n+        FeatureSource retyped = pool.getFeatureSource(info, null);\r\n+        CoordinateReferenceSystem reprojected = CRS.decode(\"EPSG:\" + 900913);\r\n+\r\n+        // asserting re-projection occurred to the declared CRS\r\n+        try (FeatureIterator iterator = retyped.getFeatures().features()) {\r\n+            while (iterator.hasNext()) {\r\n+                Feature feature = iterator.next();\r\n+                // check if resulting feature are in correct CRS\r\n+                assertFalse(\r\n+                        CRS.isTransformationRequired(\r\n+                                reprojected, feature.getType().getCoordinateReferenceSystem()));\r\n+            }\r\n+        }\r\n+    }\r\n+\r\n+    @Test\r\n+    public void testCQLFilter() throws Exception {\r\n+        ResourcePool pool = ResourcePool.create(getCatalog());\r\n+        FeatureTypeInfo info =\r\n+                getCatalog()\r\n+                        .getFeatureTypeByName(\r\n+                                LONG_LAT_NO_GEOM_ON_THE_FLY_QNAME.getNamespaceURI(),\r\n+                                LONG_LAT_NO_GEOM_ON_THE_FLY_QNAME.getLocalPart());\r\n+        FeatureType ft1 = pool.getFeatureType(info);\r\n+        // setting a feature type level CQL to allow only ONE feature\r\n+        info.setCqlFilter(\"data = 'd1'\");\r\n+        getCatalog().save(info);\r\n+\r\n+        FeatureSource retyped = pool.getFeatureSource(info, null);\r\n+\r\n+        try {\r\n+            int count = retyped.getFeatures().size();\r\n+            assertTrue(count == 1);\r\n+        } finally {\r\n+            // reset\r\n+            info.setCqlFilter(null);\r\n+            getCatalog().save(info);\r\n+        }\r\n+    }\r\n+\r\n+    // sample classes providing required implementations in context of the unit test\r\n+\r\n+    /* The main implementation for extension point  */\r\n+    public static class TestRetypeFeatureTypeCallback implements RetypeFeatureTypeCallback {\r\n+\r\n+        public static Logger LOGGER =\r\n+                Logger.getLogger(TestRetypeFeatureTypeCallback.class.getCanonicalName());\r\n+\r\n+        public static final String RETYPED = \"RETYPED\";\r\n+        public static final String RETYPED_GEOM_COLUMN = \"GENERATED_POINT\";\r\n+\r\n+        public static final String LONG_FIELD = \"lon\";\r\n+        public static final String LAT_FIELD = \"lat\";\r\n+        public static final int EPSG_CODE = 4326;\r\n+\r\n+        @Override\r\n+        public FeatureType retypeFeatureType(FeatureTypeInfo featureTypeInfo, FeatureType src) {\r\n+            try {\r\n+                CoordinateReferenceSystem crs = CRS.decode(\"EPSG:\" + EPSG_CODE);\r\n+                SimpleFeatureTypeBuilder builder = new SimpleFeatureTypeBuilder();\r\n+\r\n+                builder.setName(src.getName());\r\n+                builder.setCRS(crs);\r\n+\r\n+                builder.add(RETYPED_GEOM_COLUMN, Point.class);\r\n+                for (PropertyDescriptor ad : src.getDescriptors()) {\r\n+                    builder.add((AttributeDescriptor) ad);\r\n+                }\r\n+                FeatureType newType = builder.buildFeatureType();\r\n+                newType.getUserData().put(RETYPED, true);\r\n+                return newType;\r\n+\r\n+            } catch (Exception e) {\r\n+                LOGGER.log(\r\n+                        Level.SEVERE,\r\n+                        \"Error in TestRetypeFeatureTypeCallback:retypeFeatureType\",\r\n+                        e);\r\n+            }\r\n+            return src;\r\n+        }\r\n+\r\n+        @Override\r\n+        public FeatureSource wrapFeatureSource(\r\n+                FeatureTypeInfo featureTypeInfo, FeatureSource featureSource) {\r\n+            TestRetypedSource wrapped =\r\n+                    new TestRetypedSource(featureTypeInfo, (SimpleFeatureSource) featureSource);\r\n+\r\n+            return wrapped;\r\n+        }\r\n+    }\r\n+\r\n+    public static class TestRetypedSource extends DecoratingSimpleFeatureSource {\r\n+\r\n+        private final FeatureTypeInfo featureTypeInfo;\r\n+        private SimpleFeatureType cachedFeatureType;\r\n+        SimpleFeatureSource delegate;\r\n+\r\n+        RetypeHelper converter = new RetypeHelper();\r\n+\r\n+        public TestRetypedSource(FeatureTypeInfo featureTypeInfo, SimpleFeatureSource delegate) {\r\n+            super(delegate);\r\n+            this.featureTypeInfo = featureTypeInfo;\r\n+\r\n+            this.delegate = delegate;\r\n+        }\r\n+\r\n+        @Override\r\n+        public SimpleFeatureType getSchema() {\r\n+\r\n+            SimpleFeatureType src = super.getSchema();\r\n+            try {\r\n+                return converter.defineGeometryAttributeFor(featureTypeInfo, src);\r\n+            } catch (Exception e) {\r\n+                e.printStackTrace();\r\n+            }\r\n+\r\n+            return src;\r\n+        }\r\n+\r\n+        @Override\r\n+        public SimpleFeatureCollection getFeatures() throws IOException {\r\n+\r\n+            SimpleFeatureCollection features = getFeatures(Query.ALL);\r\n+            return new TestRetypedFeatureCollection(features, featureTypeInfo, getSchema());\r\n+        }\r\n+\r\n+        @Override\r\n+        public SimpleFeatureCollection getFeatures(Filter srcFilter) throws IOException {\r\n+            Query query = new Query(Query.ALL);\r\n+            query.setFilter(srcFilter);\r\n+            Query newQuery = converter.convertQuery(featureTypeInfo, query);\r\n+            SimpleFeatureCollection features = super.getFeatures(newQuery);\r\n+            return new TestRetypedFeatureCollection(features, featureTypeInfo, getSchema());\r\n+        }\r\n+\r\n+        @Override\r\n+        public SimpleFeatureCollection getFeatures(Query srcQuery) throws IOException {\r\n+            Query newQuery = converter.convertQuery(featureTypeInfo, srcQuery);\r\n+            SimpleFeatureCollection features = super.getFeatures(newQuery);\r\n+            return new TestRetypedFeatureCollection(features, featureTypeInfo, getSchema());\r\n+        }\r\n+\r\n+        @Override\r\n+        public int getCount(Query srcQuery) throws IOException {\r\n+            Query newQuery = converter.convertQuery(featureTypeInfo, srcQuery);\r\n+            return super.getCount(newQuery);\r\n+        }\r\n+    }\r\n+\r\n+    public static class TestRetypedFeatureCollection extends DecoratingSimpleFeatureCollection {\r\n+\r\n+        private final FeatureTypeInfo featureTypeInfo;\r\n+        private final SimpleFeatureType schema;\r\n+\r\n+        TestRetypedFeatureCollection(\r\n+                SimpleFeatureCollection delegate,\r\n+                FeatureTypeInfo featureTypeInfo,\r\n+                SimpleFeatureType schema) {\r\n+            super(delegate);\r\n+\r\n+            this.featureTypeInfo = featureTypeInfo;\r\n+            this.schema = schema;\r\n+        }\r\n+\r\n+        @Override\r\n+        public SimpleFeatureType getSchema() {\r\n+            return this.schema;\r\n+        }\r\n+\r\n+        @Override\r\n+        public SimpleFeatureIterator features() {\r\n+            return new GeometryGenerationCollectionIterator(super.features());\r\n+        }\r\n+\r\n+        private class GeometryGenerationCollectionIterator implements SimpleFeatureIterator {\r\n+\r\n+            private final SimpleFeatureIterator delegate;\r\n+\r\n+            RetypeHelper converter = new RetypeHelper();\r\n+\r\n+            private GeometryGenerationCollectionIterator(SimpleFeatureIterator delegate) {\r\n+                this.delegate = delegate;\r\n+            }\r\n+\r\n+            @Override\r\n+            public boolean hasNext() {\r\n+                return delegate.hasNext();\r\n+            }\r\n+\r\n+            @Override\r\n+            public SimpleFeature next() throws NoSuchElementException {\r\n+                SimpleFeature feature = delegate.next();\r\n+                return converter.generateGeometry(featureTypeInfo, schema, feature);\r\n+            }\r\n+\r\n+            @Override\r\n+            public void close() {\r\n+                delegate.close();\r\n+            }\r\n+        }\r\n+    }\r\n+\r\n+    public static class RetypeHelper {\r\n+        public static Logger LOGGER = Logger.getLogger(RetypeHelper.class.getCanonicalName());\r\n+\r\n+        private final GeometryFactory geometryFactory = JTSFactoryFinder.getGeometryFactory();\r\n+\r\n+        public SimpleFeature generateGeometry(\r\n+                FeatureTypeInfo info, SimpleFeatureType schema, SimpleFeature simpleFeature) {\r\n+            if (simpleFeature != null) {\r\n+                try {\r\n+                    SimpleFeatureBuilder featureBuilder = new SimpleFeatureBuilder(schema);\r\n+                    Double x =\r\n+                            Double.valueOf(\r\n+                                    getAsString(\r\n+                                            simpleFeature,\r\n+                                            TestRetypeFeatureTypeCallback.LONG_FIELD));\r\n+                    Double y =\r\n+                            Double.valueOf(\r\n+                                    getAsString(\r\n+                                            simpleFeature,\r\n+                                            TestRetypeFeatureTypeCallback.LAT_FIELD));\r\n+\r\n+                    Point point = geometryFactory.createPoint(new Coordinate(x, y));\r\n+                    point.setSRID(TestRetypeFeatureTypeCallback.EPSG_CODE);\r\n+\r\n+                    featureBuilder.add(point);\r\n+                    for (Property prop : simpleFeature.getProperties()) {\r\n+                        featureBuilder.set(prop.getName(), prop.getValue());\r\n+                    }\r\n+                    simpleFeature = featureBuilder.buildFeature(simpleFeature.getID());\r\n+                } catch (Exception e) {\r\n+                    LOGGER.log(Level.SEVERE, e.getMessage(), e);\r\n+                }\r\n+            }\r\n+            return simpleFeature;\r\n+        }\r\n+\r\n+        private String getAsString(SimpleFeature simpleFeature, String name) {\r\n+            return ofNullable(simpleFeature.getProperty(name))\r\n+                    .flatMap(property -> ofNullable(property.getValue()))\r\n+                    .map(Object::toString)\r\n+                    .orElseThrow(\r\n+                            () ->\r\n+                                    new IllegalArgumentException(\r\n+                                            String.format(\r\n+                                                    \"cannot get value of property [%s]\", name)));\r\n+        }\r\n+\r\n+        public SimpleFeatureType defineGeometryAttributeFor(\r\n+                FeatureTypeInfo info, SimpleFeatureType src) throws Exception {\r\n+\r\n+            SimpleFeatureTypeBuilder builder = new SimpleFeatureTypeBuilder();\r\n+\r\n+            builder.setName(src.getName());\r\n+            builder.setCRS(CRS.decode(\"EPSG:\" + TestRetypeFeatureTypeCallback.EPSG_CODE));\r\n+\r\n+            builder.add(TestRetypeFeatureTypeCallback.RETYPED_GEOM_COLUMN, Point.class);\r\n+            for (AttributeDescriptor ad : src.getAttributeDescriptors()) {\r\n+                if (!ad.getLocalName()\r\n+                        .equalsIgnoreCase(TestRetypeFeatureTypeCallback.RETYPED_GEOM_COLUMN)) {\r\n+                    builder.add(ad);\r\n+                }\r\n+            }\r\n+            SimpleFeatureType simpleFeatureType = builder.buildFeatureType();\r\n+\r\n+            return simpleFeatureType;\r\n+        }\r\n+\r\n+        public Query convertQuery(FeatureTypeInfo info, Query query) {\r\n+\r\n+            Query q = new Query(query);\r\n+            List<String> properties = new ArrayList<>();\r\n+            try {\r\n+                // no fields were sent, use all fields excluding geom field\r\n+                if (query.getPropertyNames() == null) {\r\n+                    properties =\r\n+                            info.getFeatureType()\r\n+                                    .getDescriptors()\r\n+                                    .stream()\r\n+                                    .filter(\r\n+                                            propertyDescriptor ->\r\n+                                                    !propertyDescriptor\r\n+                                                            .getName()\r\n+                                                            .toString()\r\n+                                                            .equals(\r\n+                                                                    TestRetypeFeatureTypeCallback\r\n+                                                                            .RETYPED_GEOM_COLUMN))\r\n+                                    .map(\r\n+                                            propertyDescriptor ->\r\n+                                                    propertyDescriptor.getName().toString())\r\n+                                    .collect(Collectors.toList());\r\n+                } else {\r\n+                    // else use the passed fields of this query\r\n+                    // but make sure geom field is replaced with Long and Lat fields\r\n+                    List<String> existingProperties =\r\n+                            new LinkedList<String>(Arrays.asList(query.getPropertyNames()));\r\n+                    // remove geom column\r\n+                    existingProperties.remove(TestRetypeFeatureTypeCallback.RETYPED_GEOM_COLUMN);\r\n+                    // make sure longitude field is present\r\n+                    if (!existingProperties.contains(TestRetypeFeatureTypeCallback.LONG_FIELD))\r\n+                        existingProperties.add(TestRetypeFeatureTypeCallback.LONG_FIELD);\r\n+                    // make sure latitude field is present\r\n+                    if (!existingProperties.contains(TestRetypeFeatureTypeCallback.LAT_FIELD))\r\n+                        existingProperties.add(TestRetypeFeatureTypeCallback.LAT_FIELD);\r\n+\r\n+                    properties = new ArrayList<>(existingProperties);\r\n+                }\r\n+\r\n+            } catch (Exception e) {\r\n+                e.printStackTrace();\r", "originalCommit": "6c80dab3840671f1103edeb718a2f4f6d94251b1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjI4NzQ0NA==", "url": "https://github.com/geoserver/geoserver/pull/4031#discussion_r386287444", "bodyText": "?", "author": "nmco", "createdAt": "2020-03-02T09:46:08Z", "path": "src/main/src/test/java/org/geoserver/catalog/RetypeFeatureTypeCallbackTest.java", "diffHunk": "@@ -0,0 +1,467 @@\n+/* (c) 2020 Open Source Geospatial Foundation - all rights reserved\r\n+ * This code is licensed under the GPL 2.0 license, available at the root\r\n+ * application directory.\r\n+ */\r\n+package org.geoserver.catalog;\r\n+\r\n+import static java.util.Optional.ofNullable;\r\n+import static org.junit.Assert.assertFalse;\r\n+import static org.junit.Assert.assertTrue;\r\n+\r\n+import java.io.IOException;\r\n+import java.util.ArrayList;\r\n+import java.util.Arrays;\r\n+import java.util.HashMap;\r\n+import java.util.LinkedList;\r\n+import java.util.List;\r\n+import java.util.Map;\r\n+import java.util.NoSuchElementException;\r\n+import java.util.logging.Level;\r\n+import java.util.logging.Logger;\r\n+import java.util.stream.Collectors;\r\n+import javax.xml.namespace.QName;\r\n+import org.geoserver.data.test.MockData;\r\n+import org.geoserver.data.test.SystemTestData;\r\n+import org.geoserver.data.test.SystemTestData.LayerProperty;\r\n+import org.geoserver.platform.GeoServerExtensionsHelper;\r\n+import org.geoserver.security.decorators.DecoratingSimpleFeatureSource;\r\n+import org.geoserver.test.GeoServerSystemTestSupport;\r\n+import org.geotools.data.FeatureSource;\r\n+import org.geotools.data.Query;\r\n+import org.geotools.data.simple.SimpleFeatureCollection;\r\n+import org.geotools.data.simple.SimpleFeatureIterator;\r\n+import org.geotools.data.simple.SimpleFeatureSource;\r\n+import org.geotools.feature.FeatureIterator;\r\n+import org.geotools.feature.collection.DecoratingSimpleFeatureCollection;\r\n+import org.geotools.feature.simple.SimpleFeatureBuilder;\r\n+import org.geotools.feature.simple.SimpleFeatureTypeBuilder;\r\n+import org.geotools.geometry.jts.JTSFactoryFinder;\r\n+import org.geotools.referencing.CRS;\r\n+import org.junit.Test;\r\n+import org.locationtech.jts.geom.Coordinate;\r\n+import org.locationtech.jts.geom.GeometryFactory;\r\n+import org.locationtech.jts.geom.Point;\r\n+import org.opengis.feature.Feature;\r\n+import org.opengis.feature.Property;\r\n+import org.opengis.feature.simple.SimpleFeature;\r\n+import org.opengis.feature.simple.SimpleFeatureType;\r\n+import org.opengis.feature.type.AttributeDescriptor;\r\n+import org.opengis.feature.type.FeatureType;\r\n+import org.opengis.feature.type.PropertyDescriptor;\r\n+import org.opengis.filter.Filter;\r\n+import org.opengis.referencing.crs.CoordinateReferenceSystem;\r\n+import org.vfny.geoserver.global.GeoServerFeatureSource;\r\n+\r\n+/**\r\n+ * This test asserts the an implementation of RetypeFeatureTypeCallback is integrated properly with\r\n+ * GeoServerFeatureSource wrapper. The test asserts that when a feature type is retyped through\r\n+ * RetypeFeatureTypeCallback implementation, it does not break or override the functionality\r\n+ * provided by GeoServerFeatureSource wrapper.\r\n+ */\r\n+public class RetypeFeatureTypeCallbackTest extends GeoServerSystemTestSupport {\r\n+\r\n+    public static final String LONG_LAT_NO_GEOM_ON_THE_FLY_LAYER_FILE = \"longlat.properties\";\r\n+    public static final QName LONG_LAT_NO_GEOM_ON_THE_FLY_QNAME =\r\n+            new QName(MockData.DEFAULT_PREFIX, \"longlat\", MockData.DEFAULT_PREFIX);\r\n+\r\n+    public static final QName LONG_LAT_NO_GEOM_ON_THE_FLY_QNAME_REPROJECTED =\r\n+            new QName(MockData.DEFAULT_PREFIX, \"longlat_reprojected\", MockData.DEFAULT_PREFIX);\r\n+\r\n+    @Override\r\n+    protected void onSetUp(SystemTestData testData) throws Exception {\r\n+        // registering singleton for this test only\r\n+        TestRetypeFeatureTypeCallback o2 = new TestRetypeFeatureTypeCallback();\r\n+        GeoServerExtensionsHelper.singleton(\r\n+                \"retypeFeatureTypeCallbackTest\", o2, RetypeFeatureTypeCallback.class);\r\n+\r\n+        super.onSetUp(testData);\r\n+        setUpNonGeometryLayer(testData);\r\n+        setReprojectedUpNonGeometryLayer(testData);\r\n+    }\r\n+\r\n+    private void setUpNonGeometryLayer(SystemTestData testData) throws IOException {\r\n+        // Loading a vector layer with location given as latitude and longitude and no geometry\r\n+        Map<LayerProperty, Object> props = new HashMap<LayerProperty, Object>();\r\n+        testData.addVectorLayer(\r\n+                LONG_LAT_NO_GEOM_ON_THE_FLY_QNAME,\r\n+                props,\r\n+                LONG_LAT_NO_GEOM_ON_THE_FLY_LAYER_FILE,\r\n+                getClass(),\r\n+                getCatalog());\r\n+    }\r\n+\r\n+    private void setReprojectedUpNonGeometryLayer(SystemTestData testData) throws IOException {\r\n+        // Loading a vector layer with location given as latitude and longitude and no geometry\r\n+        Map<LayerProperty, Object> props = new HashMap<LayerProperty, Object>();\r\n+        // declaring a different CRS to test re-projection\r\n+        props.put(LayerProperty.PROJECTION_POLICY, ProjectionPolicy.REPROJECT_TO_DECLARED);\r\n+        props.put(LayerProperty.SRS, 900913);\r\n+        testData.addVectorLayer(\r\n+                LONG_LAT_NO_GEOM_ON_THE_FLY_QNAME_REPROJECTED,\r\n+                props,\r\n+                LONG_LAT_NO_GEOM_ON_THE_FLY_LAYER_FILE,\r\n+                getClass(),\r\n+                getCatalog());\r\n+    }\r\n+\r\n+    @Test\r\n+    public void testGeometryCreation() throws Exception {\r\n+        ResourcePool pool = ResourcePool.create(getCatalog());\r\n+        FeatureTypeInfo info =\r\n+                getCatalog()\r\n+                        .getFeatureTypeByName(\r\n+                                LONG_LAT_NO_GEOM_ON_THE_FLY_QNAME.getNamespaceURI(),\r\n+                                LONG_LAT_NO_GEOM_ON_THE_FLY_QNAME.getLocalPart());\r\n+        FeatureType ft1 = pool.getFeatureType(info);\r\n+\r\n+        // assert that feature type is returned with a point geometry\r\n+        assertTrue(ft1.getUserData().containsKey(TestRetypeFeatureTypeCallback.RETYPED));\r\n+        assertTrue(ft1.getGeometryDescriptor().getType().getBinding().equals(Point.class));\r\n+\r\n+        FeatureSource retyped = pool.getFeatureSource(info, null);\r\n+        // assert FeatureSource is nicely wrapped inside Geoserver wrapper\r\n+        assertTrue(retyped instanceof GeoServerFeatureSource);\r\n+        // assert FeatureSource has Geometry type set to Point\r\n+        assertTrue(\r\n+                retyped.getSchema()\r\n+                        .getGeometryDescriptor()\r\n+                        .getType()\r\n+                        .getBinding()\r\n+                        .equals(Point.class));\r\n+        AttributeDescriptor geomAttibute =\r\n+                (AttributeDescriptor) retyped.getSchema().getGeometryDescriptor().getDefaultValue();\r\n+        // Finally assert that each features has a valid geometry\r\n+        try (FeatureIterator iterator = retyped.getFeatures().features()) {\r\n+            while (iterator.hasNext()) {\r\n+                Feature feature = iterator.next();\r\n+                assertTrue(feature.getDefaultGeometryProperty().getValue() instanceof Point);\r\n+            }\r\n+        }\r\n+    }\r\n+\r\n+    @Test\r\n+    public void testReProjection() throws Exception {\r\n+        ResourcePool pool = ResourcePool.create(getCatalog());\r\n+        FeatureTypeInfo info =\r\n+                getCatalog()\r\n+                        .getFeatureTypeByName(\r\n+                                LONG_LAT_NO_GEOM_ON_THE_FLY_QNAME_REPROJECTED.getNamespaceURI(),\r\n+                                LONG_LAT_NO_GEOM_ON_THE_FLY_QNAME_REPROJECTED.getLocalPart());\r\n+\r\n+        FeatureSource retyped = pool.getFeatureSource(info, null);\r\n+        CoordinateReferenceSystem reprojected = CRS.decode(\"EPSG:\" + 900913);\r\n+\r\n+        // asserting re-projection occurred to the declared CRS\r\n+        try (FeatureIterator iterator = retyped.getFeatures().features()) {\r\n+            while (iterator.hasNext()) {\r\n+                Feature feature = iterator.next();\r\n+                // check if resulting feature are in correct CRS\r\n+                assertFalse(\r\n+                        CRS.isTransformationRequired(\r\n+                                reprojected, feature.getType().getCoordinateReferenceSystem()));\r\n+            }\r\n+        }\r\n+    }\r\n+\r\n+    @Test\r\n+    public void testCQLFilter() throws Exception {\r\n+        ResourcePool pool = ResourcePool.create(getCatalog());\r\n+        FeatureTypeInfo info =\r\n+                getCatalog()\r\n+                        .getFeatureTypeByName(\r\n+                                LONG_LAT_NO_GEOM_ON_THE_FLY_QNAME.getNamespaceURI(),\r\n+                                LONG_LAT_NO_GEOM_ON_THE_FLY_QNAME.getLocalPart());\r\n+        FeatureType ft1 = pool.getFeatureType(info);\r\n+        // setting a feature type level CQL to allow only ONE feature\r\n+        info.setCqlFilter(\"data = 'd1'\");\r\n+        getCatalog().save(info);\r\n+\r\n+        FeatureSource retyped = pool.getFeatureSource(info, null);\r\n+\r\n+        try {\r\n+            int count = retyped.getFeatures().size();\r\n+            assertTrue(count == 1);\r\n+        } finally {\r\n+            // reset\r\n+            info.setCqlFilter(null);\r\n+            getCatalog().save(info);\r\n+        }\r\n+    }\r\n+\r\n+    // sample classes providing required implementations in context of the unit test\r\n+\r\n+    /* The main implementation for extension point  */\r\n+    public static class TestRetypeFeatureTypeCallback implements RetypeFeatureTypeCallback {\r\n+\r\n+        public static Logger LOGGER =\r\n+                Logger.getLogger(TestRetypeFeatureTypeCallback.class.getCanonicalName());\r\n+\r\n+        public static final String RETYPED = \"RETYPED\";\r\n+        public static final String RETYPED_GEOM_COLUMN = \"GENERATED_POINT\";\r\n+\r\n+        public static final String LONG_FIELD = \"lon\";\r\n+        public static final String LAT_FIELD = \"lat\";\r\n+        public static final int EPSG_CODE = 4326;\r\n+\r\n+        @Override\r\n+        public FeatureType retypeFeatureType(FeatureTypeInfo featureTypeInfo, FeatureType src) {\r\n+            try {\r\n+                CoordinateReferenceSystem crs = CRS.decode(\"EPSG:\" + EPSG_CODE);\r\n+                SimpleFeatureTypeBuilder builder = new SimpleFeatureTypeBuilder();\r\n+\r\n+                builder.setName(src.getName());\r\n+                builder.setCRS(crs);\r\n+\r\n+                builder.add(RETYPED_GEOM_COLUMN, Point.class);\r\n+                for (PropertyDescriptor ad : src.getDescriptors()) {\r\n+                    builder.add((AttributeDescriptor) ad);\r\n+                }\r\n+                FeatureType newType = builder.buildFeatureType();\r\n+                newType.getUserData().put(RETYPED, true);\r\n+                return newType;\r\n+\r\n+            } catch (Exception e) {\r\n+                LOGGER.log(\r\n+                        Level.SEVERE,\r\n+                        \"Error in TestRetypeFeatureTypeCallback:retypeFeatureType\",\r\n+                        e);\r\n+            }\r\n+            return src;\r\n+        }\r\n+\r\n+        @Override\r\n+        public FeatureSource wrapFeatureSource(\r\n+                FeatureTypeInfo featureTypeInfo, FeatureSource featureSource) {\r\n+            TestRetypedSource wrapped =\r\n+                    new TestRetypedSource(featureTypeInfo, (SimpleFeatureSource) featureSource);\r\n+\r\n+            return wrapped;\r\n+        }\r\n+    }\r\n+\r\n+    public static class TestRetypedSource extends DecoratingSimpleFeatureSource {\r\n+\r\n+        private final FeatureTypeInfo featureTypeInfo;\r\n+        private SimpleFeatureType cachedFeatureType;\r\n+        SimpleFeatureSource delegate;\r\n+\r\n+        RetypeHelper converter = new RetypeHelper();\r\n+\r\n+        public TestRetypedSource(FeatureTypeInfo featureTypeInfo, SimpleFeatureSource delegate) {\r\n+            super(delegate);\r\n+            this.featureTypeInfo = featureTypeInfo;\r\n+\r\n+            this.delegate = delegate;\r\n+        }\r\n+\r\n+        @Override\r\n+        public SimpleFeatureType getSchema() {\r\n+\r\n+            SimpleFeatureType src = super.getSchema();\r\n+            try {\r\n+                return converter.defineGeometryAttributeFor(featureTypeInfo, src);\r\n+            } catch (Exception e) {\r\n+                e.printStackTrace();\r", "originalCommit": "6c80dab3840671f1103edeb718a2f4f6d94251b1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "a81030b41c2558927ccb536f075aba018789ac13", "url": "https://github.com/geoserver/geoserver/commit/a81030b41c2558927ccb536f075aba018789ac13", "message": "[GEOS-9487] rev 3\n\n-moved test implemetnations inside unit test\n-broke unit tests into three unit test\n\t-test geom generation\n\t-test re-projection\n\t-test cql filter", "committedDate": "2020-03-02T10:25:26Z", "type": "commit"}, {"oid": "a81030b41c2558927ccb536f075aba018789ac13", "url": "https://github.com/geoserver/geoserver/commit/a81030b41c2558927ccb536f075aba018789ac13", "message": "[GEOS-9487] rev 3\n\n-moved test implemetnations inside unit test\n-broke unit tests into three unit test\n\t-test geom generation\n\t-test re-projection\n\t-test cql filter", "committedDate": "2020-03-02T10:25:26Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjgxOTQ2Nw==", "url": "https://github.com/geoserver/geoserver/pull/4031#discussion_r386819467", "bodyText": "protect yourself with a try catch here so you can clearly blame any implementation that causes problems", "author": "jodygarnett", "createdAt": "2020-03-03T06:23:20Z", "path": "src/main/src/main/java/org/geoserver/catalog/ResourcePool.java", "diffHunk": "@@ -1111,7 +1111,13 @@ private FeatureType buildFeatureType(\n                 }\n             }\n             ft = tb.buildFeatureType();\n+            // extension point for retyping the feature type\n+            for (RetypeFeatureTypeCallback callback :\n+                    GeoServerExtensions.extensions(RetypeFeatureTypeCallback.class)) {\n+                ft = callback.retypeFeatureType(info, ft);", "originalCommit": "a81030b41c2558927ccb536f075aba018789ac13", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjgxOTcwMA==", "url": "https://github.com/geoserver/geoserver/pull/4031#discussion_r386819700", "bodyText": "Same advise on try / catch around to catch and report errors when calling any extension", "author": "jodygarnett", "createdAt": "2020-03-03T06:24:14Z", "path": "src/main/src/main/java/org/geoserver/catalog/ResourcePool.java", "diffHunk": "@@ -1381,6 +1387,13 @@ else if (ppolicy == ProjectionPolicy.NONE && nativeCRS != null) {\n                 schema = typeBuilder.buildFeatureType();\n             }\n \n+            // applying wrappers using implementations of RetypeFeatureTypeCallback\n+            for (RetypeFeatureTypeCallback callback :\n+                    GeoServerExtensions.extensions(RetypeFeatureTypeCallback.class)) {\n+                if (SimpleFeatureSource.class.isAssignableFrom(fs.getClass()))", "originalCommit": "a81030b41c2558927ccb536f075aba018789ac13", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}