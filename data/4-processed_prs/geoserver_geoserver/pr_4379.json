{"pr_number": 4379, "pr_title": "[GEOS-9654] Layer preview layer count and paging off base when secured layers are not visible", "pr_createdAt": "2020-07-03T12:34:20Z", "pr_url": "https://github.com/geoserver/geoserver/pull/4379", "timeline": [{"oid": "83f975dc3084b256fcfcc635123c627996802740", "url": "https://github.com/geoserver/geoserver/commit/83f975dc3084b256fcfcc635123c627996802740", "message": "[GEOS-9654] Layer preview layer count and paging off base when secured layers are not visible", "committedDate": "2020-07-03T12:32:57Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTY2Njk1OA==", "url": "https://github.com/geoserver/geoserver/pull/4379#discussion_r449666958", "bodyText": "Why not \ud83e\udd23.", "author": "nmco", "createdAt": "2020-07-03T17:30:33Z", "path": "src/main/src/main/java/org/geoserver/catalog/Predicates.java", "diffHunk": "@@ -218,6 +219,17 @@ public static Filter and(Filter op1, Filter op2) {\n         return factory.and(children);\n     }\n \n+    /**\n+     * Returns a negated filter. If the filter was already a negation, its child fiter will be\n+     * returned instead (simplifying out the double negation)\n+     */\n+    public static Filter not(Filter filter) {\n+        if (filter instanceof Not) {\n+            return ((Not) filter).getFilter();", "originalCommit": "83f975dc3084b256fcfcc635123c627996802740", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTY2NzQ5Mg==", "url": "https://github.com/geoserver/geoserver/pull/4379#discussion_r449667492", "bodyText": "I see the filter was missing.", "author": "nmco", "createdAt": "2020-07-03T17:33:29Z", "path": "src/main/src/main/java/org/geoserver/security/impl/DefaultResourceAccessManager.java", "diffHunk": "@@ -562,14 +562,27 @@ public Filter getSecurityFilter(Authentication user, Class<? extends CatalogInfo\n                         wsNode.getChildren().entrySet()) {\n                     String layerName = layerEntry.getKey();\n                     SecureTreeNode layerNode = layerEntry.getValue();\n+                    String prefixedName = wsName + \":\" + layerName;\n+                    Filter typeFilter = getTypeFilter(prefixedName, clazz);\n+                    if (typeFilter == null) {\n+                        // dangling rule, referencing a non existing layer/group, continue\n+                        continue;\n+                    }\n+\n                     boolean layerAccess = canAccess(user, layerNode);\n                     if (layerAccess != wsAccess) {\n                         if (wsAccess) {\n                             layerExceptions.add(\n-                                    Predicates.notEqual(\"prefixedName\", wsName + \":\" + layerName));\n+                                    Predicates.not(\n+                                            Predicates.and(\n+                                                    typeFilter,", "originalCommit": "83f975dc3084b256fcfcc635123c627996802740", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTY2OTA2OA==", "url": "https://github.com/geoserver/geoserver/pull/4379#discussion_r449669068", "bodyText": "Basically we want o exclude layer groups right?", "author": "nmco", "createdAt": "2020-07-03T17:41:45Z", "path": "src/main/src/main/java/org/geoserver/security/impl/DefaultResourceAccessManager.java", "diffHunk": "@@ -641,6 +644,20 @@ public Filter getSecurityFilter(Authentication user, Class<? extends CatalogInfo\n         }\n     }\n \n+    private Filter getTypeFilter(String prefixedName, Class clazz) {\n+        if (rawCatalog.getLayerByName(prefixedName) != null)\n+            if (clazz.equals(PublishedInfo.class)) {\n+                // restrict to layers in this case\n+                return Predicates.isInstanceOf(LayerInfo.class);", "originalCommit": "83f975dc3084b256fcfcc635123c627996802740", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}