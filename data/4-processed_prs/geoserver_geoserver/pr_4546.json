{"pr_number": 4546, "pr_title": "[GEOS-9773] Allow internal GWC to tile WMS requests that don't contain TILED=TRUE in the request parameters", "pr_createdAt": "2020-10-23T09:29:28Z", "pr_url": "https://github.com/geoserver/geoserver/pull/4546", "timeline": [{"oid": "17c1edbb75807d1c15a0106a6043ded06d0400cb", "url": "https://github.com/geoserver/geoserver/commit/17c1edbb75807d1c15a0106a6043ded06d0400cb", "message": "fix merge", "committedDate": "2020-10-23T09:26:57Z", "type": "commit"}, {"oid": "2cd085f4b42c001b00c2ae0edee647052129bed2", "url": "https://github.com/geoserver/geoserver/commit/2cd085f4b42c001b00c2ae0edee647052129bed2", "message": "added integration test", "committedDate": "2020-10-23T09:27:15Z", "type": "commit"}, {"oid": "32df9ec65c18e165f0b7b0505a30340f8cc392fb", "url": "https://github.com/geoserver/geoserver/commit/32df9ec65c18e165f0b7b0505a30340f8cc392fb", "message": "add back in lost variable", "committedDate": "2020-10-23T10:30:28Z", "type": "commit"}, {"oid": "2cbcf13691d0b8e01108fef755cb1e7d3114e663", "url": "https://github.com/geoserver/geoserver/commit/2cbcf13691d0b8e01108fef755cb1e7d3114e663", "message": "add missing test", "committedDate": "2020-10-23T10:41:53Z", "type": "commit"}, {"oid": "c48f44171eb46312c3cee590e70cd258a4fda9aa", "url": "https://github.com/geoserver/geoserver/commit/c48f44171eb46312c3cee590e70cd258a4fda9aa", "message": "add the rest of the missing chery pick", "committedDate": "2020-10-23T13:26:46Z", "type": "commit"}, {"oid": "4c47803c0428bcfb9b9014e112e0a0823397515f", "url": "https://github.com/geoserver/geoserver/commit/4c47803c0428bcfb9b9014e112e0a0823397515f", "message": "fix typo in wicket config", "committedDate": "2020-10-23T17:06:47Z", "type": "commit"}, {"oid": "b48c800774b74b8d47060434d63a06b05212d29a", "url": "https://github.com/geoserver/geoserver/commit/b48c800774b74b8d47060434d63a06b05212d29a", "message": "handle capabilities and update docs", "committedDate": "2020-10-24T10:52:52Z", "type": "commit"}, {"oid": "8de109781b3b5e18455e07e0a6b4e5bff2802d04", "url": "https://github.com/geoserver/geoserver/commit/8de109781b3b5e18455e07e0a6b4e5bff2802d04", "message": "formatting", "committedDate": "2020-10-24T16:59:48Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjEyMzUyOQ==", "url": "https://github.com/geoserver/geoserver/pull/4546#discussion_r512123529", "bodyText": "Nice to see docs! Maybe an update to the screenshot above would help too.", "author": "aaime", "createdAt": "2020-10-26T17:01:58Z", "path": "doc/en/user/source/geowebcache/webadmin/defaults.rst", "diffHunk": "@@ -31,6 +31,11 @@ With direct integration, tile caching is enabled for all standard WMS requests t\n \r\n This setting is disabled by default. When enabling this option, it is a good idea to also turn on :ref:`gwc_webadmin_diskquotas` as well, to prevent unbounded growth of the stored tiles.\r\n \r\n+Explicitly require TILED Parameter\r", "originalCommit": "8de109781b3b5e18455e07e0a6b4e5bff2802d04", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjQ5ODEzNg==", "url": "https://github.com/geoserver/geoserver/pull/4546#discussion_r512498136", "bodyText": "I have updated that image", "author": "ianturton", "createdAt": "2020-10-27T08:31:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjEyMzUyOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjEyMzg2Mg==", "url": "https://github.com/geoserver/geoserver/pull/4546#discussion_r512123862", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            When this parameter is checked direct integration requires that the ``tiled=true`` parameter be set in all requests that will be cached. If this parameter is unchecked all incoming requests will be considered for caching, the request must still conform to all required parameters.\n          \n          \n            \n            When this parameter is checked direct WMS integration requires that the ``tiled=true`` parameter be set in all requests that will be cached. If this parameter is unchecked all incoming requests will be considered for caching, the request must still conform to all required parameters.", "author": "aaime", "createdAt": "2020-10-26T17:02:25Z", "path": "doc/en/user/source/geowebcache/webadmin/defaults.rst", "diffHunk": "@@ -31,6 +31,11 @@ With direct integration, tile caching is enabled for all standard WMS requests t\n \r\n This setting is disabled by default. When enabling this option, it is a good idea to also turn on :ref:`gwc_webadmin_diskquotas` as well, to prevent unbounded growth of the stored tiles.\r\n \r\n+Explicitly require TILED Parameter\r\n+``````````````````````````````````\r\n+When this parameter is checked direct integration requires that the ``tiled=true`` parameter be set in all requests that will be cached. If this parameter is unchecked all incoming requests will be considered for caching, the request must still conform to all required parameters.\r", "originalCommit": "8de109781b3b5e18455e07e0a6b4e5bff2802d04", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjEyNTA5Mw==", "url": "https://github.com/geoserver/geoserver/pull/4546#discussion_r512125093", "bodyText": "Wondering, is this object stored using XStream? I have vague memories that XStream dodges the normal construction mechanism and ends up ignoring field initializers too. I would give it a look.\nBelieve that normally we use Boolean object wrapper, and in the getter, if null, return the desired default value... at least, that's what we do for CatalogInfo objects :-D", "author": "aaime", "createdAt": "2020-10-26T17:04:13Z", "path": "src/gwc/src/main/java/org/geoserver/gwc/config/GWCConfig.java", "diffHunk": "@@ -28,6 +28,8 @@\n \n     private boolean directWMSIntegrationEnabled;\n \n+    private boolean requireTiledParameter = true;", "originalCommit": "8de109781b3b5e18455e07e0a6b4e5bff2802d04", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjEyNTg1Mg==", "url": "https://github.com/geoserver/geoserver/pull/4546#discussion_r512125852", "bodyText": "Leftover print?", "author": "aaime", "createdAt": "2020-10-26T17:05:20Z", "path": "src/gwc/src/test/java/org/geoserver/gwc/wms/CachingExtendedCapabilitiesProviderTest.java", "diffHunk": "@@ -122,6 +122,24 @@ public void testTileSets() throws Exception {\n         assertXpathExists(tileSetPath + \"[1]/Format\", dom);\n         assertXpathExists(tileSetPath + \"[1]/Layers\", dom);\n         assertXpathExists(tileSetPath + \"[1]/Styles\", dom);\n+\n+        // Test RequireTiledParameter==false\n+        GWC.get().getConfig().setDirectWMSIntegrationEnabled(true);\n+        GWC.get().getConfig().setRequireTiledParameter(false);\n+        dom = dom(get(\"wms?request=getCapabilities&version=1.1.1\"), false);\n+        print(dom);", "originalCommit": "8de109781b3b5e18455e07e0a6b4e5bff2802d04", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjEyNjUyNw==", "url": "https://github.com/geoserver/geoserver/pull/4546#discussion_r512126527", "bodyText": "Confused, if the new setting affecting capabilities results at all?", "author": "aaime", "createdAt": "2020-10-26T17:06:21Z", "path": "src/gwc/src/test/java/org/geoserver/gwc/wms/CachingExtendedCapabilitiesProviderTest.java", "diffHunk": "@@ -122,6 +122,24 @@ public void testTileSets() throws Exception {\n         assertXpathExists(tileSetPath + \"[1]/Format\", dom);\n         assertXpathExists(tileSetPath + \"[1]/Layers\", dom);\n         assertXpathExists(tileSetPath + \"[1]/Styles\", dom);\n+\n+        // Test RequireTiledParameter==false", "originalCommit": "8de109781b3b5e18455e07e0a6b4e5bff2802d04", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjUwMDI4NQ==", "url": "https://github.com/geoserver/geoserver/pull/4546#discussion_r512500285", "bodyText": "Direct Integration makes changes by adding in TileSets if tiled=true is sent, so I matched that. I suspect that no one actually uses that feature as it would need hand coding on the client side, but it seemed safest to match the existing behaviour", "author": "ianturton", "createdAt": "2020-10-27T08:34:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjEyNjUyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjUxNjQwMg==", "url": "https://github.com/geoserver/geoserver/pull/4546#discussion_r512516402", "bodyText": "Oh, I see... hum, that grows the capablities document quite a bit though. I also believe that nobody is really using that feature, the idea here is to use the cache just because clients happen to align to the grid. @simboss what do you think?", "author": "aaime", "createdAt": "2020-10-27T08:59:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjEyNjUyNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjEyNjg2MQ==", "url": "https://github.com/geoserver/geoserver/pull/4546#discussion_r512126861", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            GWCSettingsPage.requireTiledParameter.title= When set to true, explicitly require TILED Parameter, otherwise accept all requests for tiling\n          \n          \n            \n            GWCSettingsPage.requireTiledParameter.title= When set to true, explicitly require TILED Parameter, otherwise consider all requests for tile caching", "author": "aaime", "createdAt": "2020-10-26T17:06:52Z", "path": "src/web/gwc/src/main/resources/GeoServerApplication.properties", "diffHunk": "@@ -7,6 +7,8 @@ GWC.diskQuotaLoadFailed = Loading quota store failed, the disk quota subsystem i\n GWCSettingsPage.description                = Configure the global settings for the embedded GeoWebCache\n GWCSettingsPage.enableWMSIntegration       = Enable direct integration with GeoServer WMS\n GWCSettingsPage.enableWMSIntegration.title = Allows the regular WMS to serve cached content. When this option is enabled, use tiled=true for GetCapabilities in the GeoServer WMS to include the WMS-C VendorSpecificCapabilities\n+GWCSettingsPage.requireTiledParameter      = Explicitly require TILED Parameter\n+GWCSettingsPage.requireTiledParameter.title= When set to true, explicitly require TILED Parameter, otherwise accept all requests for tiling", "originalCommit": "8de109781b3b5e18455e07e0a6b4e5bff2802d04", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "c0303f41bd7bc3fed39560be38e5cf016137dbe8", "url": "https://github.com/geoserver/geoserver/commit/c0303f41bd7bc3fed39560be38e5cf016137dbe8", "message": "Update doc/en/user/source/geowebcache/webadmin/defaults.rst\n\nCo-authored-by: Andrea Aime <andrea.aime@gmail.com>", "committedDate": "2020-10-27T08:29:42Z", "type": "commit"}, {"oid": "b6e9f2238edf97e0cfecc5cce2f54c6a90097c90", "url": "https://github.com/geoserver/geoserver/commit/b6e9f2238edf97e0cfecc5cce2f54c6a90097c90", "message": "Update src/web/gwc/src/main/resources/GeoServerApplication.properties\n\nCo-authored-by: Andrea Aime <andrea.aime@gmail.com>", "committedDate": "2020-10-27T08:35:30Z", "type": "commit"}, {"oid": "404938c2d77ad190ed00255cd0fb26a69bb1ce0d", "url": "https://github.com/geoserver/geoserver/commit/404938c2d77ad190ed00255cd0fb26a69bb1ce0d", "message": "remove leftover print", "committedDate": "2020-10-27T08:36:07Z", "type": "commit"}, {"oid": "c498d0cabceda8b66fafb3d4d63891449efbab44", "url": "https://github.com/geoserver/geoserver/commit/c498d0cabceda8b66fafb3d4d63891449efbab44", "message": "Merge branch 'geos-9773' of github.com:ianturton/geoserver into geos-9773", "committedDate": "2020-10-27T08:36:30Z", "type": "commit"}, {"oid": "1faa30e5933a2a09e9b9bf5eea49e056398ea3b2", "url": "https://github.com/geoserver/geoserver/commit/1faa30e5933a2a09e9b9bf5eea49e056398ea3b2", "message": "force true on startup when not previously persisted", "committedDate": "2020-10-27T08:52:29Z", "type": "commit"}, {"oid": "d5bbb872c8fbeed28c8e97ec67c7f6e4cd5be9e6", "url": "https://github.com/geoserver/geoserver/commit/d5bbb872c8fbeed28c8e97ec67c7f6e4cd5be9e6", "message": "fix formatting", "committedDate": "2020-10-27T13:45:05Z", "type": "commit"}]}