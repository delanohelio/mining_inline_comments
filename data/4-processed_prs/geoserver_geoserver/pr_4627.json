{"pr_number": 4627, "pr_title": "[GEOS-9830] Allow the possibility to define allowedArea in a SRID different from 4326 in geofence [GEOS-9831] Possibility to use SpatialFilter in Geofence also to clip features", "pr_createdAt": "2020-12-23T17:36:49Z", "pr_url": "https://github.com/geoserver/geoserver/pull/4627", "timeline": [{"oid": "78cad59622ec265f824f9ba9cce40df195cfe757", "url": "https://github.com/geoserver/geoserver/commit/78cad59622ec265f824f9ba9cce40df195cfe757", "message": "[GEOS-9831] Possibility to use SpatialFilter in Geofence also to clip features", "committedDate": "2020-12-28T14:53:10Z", "type": "forcePushed"}, {"oid": "4c25e0340564f3c568f7c1896659e2adbd29eb39", "url": "https://github.com/geoserver/geoserver/commit/4c25e0340564f3c568f7c1896659e2adbd29eb39", "message": "[GEOS-9831] Possibility to use SpatialFilter in Geofence also to clip features", "committedDate": "2021-01-05T20:55:23Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDA4NTY1Nw==", "url": "https://github.com/geoserver/geoserver/pull/4627#discussion_r554085657", "bodyText": "As noted in the GeoTools PR, this approach is inefficient. Better to check if there is a intersectFilter while working in getReadQuery and \"and\" an intersection filter there, so that it send down to the data source for efficient processing.", "author": "aaime", "createdAt": "2021-01-08T17:25:07Z", "path": "src/main/src/main/java/org/geoserver/security/decorators/SecuredFeatureSource.java", "diffHunk": "@@ -104,12 +105,37 @@ protected SecuredFeatureSource(FeatureSource<T, F> delegate, WrapperPolicy polic\n                                         + \"by security (because they are required by the schema). \"\n                                         + \"Either the security setup is broken or you have a security breach\");\n                     }\n-                    return SecuredObjects.secure(fc, policy);\n+                    result = SecuredObjects.secure(fc, policy);\n                 }\n             } else {\n-                return SecuredObjects.secure(fc, policy);\n+                result = SecuredObjects.secure(fc, policy);\n             }\n         }\n+        AccessLimits limits = policy.getLimits();\n+        if (limits instanceof VectorAccessLimits) {\n+            VectorAccessLimits vectorLimits = (VectorAccessLimits) limits;\n+            result = decoratesForClipping(vectorLimits, result);\n+        }\n+        return result;\n+    }\n+\n+    private FeatureCollection decoratesForClipping(\n+            VectorAccessLimits limits, FeatureCollection collection) {\n+        if (!(collection instanceof SimpleFeatureCollection))\n+            throw new RuntimeException(\"Cannot clip on Complex Features\");\n+        Geometry clipFilter = limits.getClipVectorFilter();\n+        Geometry intersectFilter = limits.getIntersectVectorFilter();\n+        if (clipFilter != null) {\n+            if (intersectFilter != null)", "originalCommit": "4c25e0340564f3c568f7c1896659e2adbd29eb39", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDA4NjIzNw==", "url": "https://github.com/geoserver/geoserver/pull/4627#discussion_r554086237", "bodyText": "Actually, since there is read filter, wondering if GeoFence cannot just build the full read filter by itself, rather than adding this field. This would also simplify SecuredFeatureSource.", "author": "aaime", "createdAt": "2021-01-08T17:26:08Z", "path": "src/main/src/main/java/org/geoserver/security/VectorAccessLimits.java", "diffHunk": "@@ -166,6 +183,22 @@ private void writeProperties(List<PropertyName> attributes, ObjectOutputStream o\n         }\n     }\n \n+    public Geometry getClipVectorFilter() {\n+        return clipVectorFilter;\n+    }\n+\n+    public void setClipVectorFilter(Geometry clipVectorFilter) {\n+        this.clipVectorFilter = clipVectorFilter;\n+    }\n+\n+    public Geometry getIntersectVectorFilter() {", "originalCommit": "4c25e0340564f3c568f7c1896659e2adbd29eb39", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDA4NzA3Mw==", "url": "https://github.com/geoserver/geoserver/pull/4627#discussion_r554087073", "bodyText": "Ok so it seems to be already here. Why does it need to be added as a separate field too?", "author": "aaime", "createdAt": "2021-01-08T17:27:48Z", "path": "src/extension/geofence/src/main/java/org/geoserver/geofence/GeofenceAccessManager.java", "diffHunk": "@@ -580,8 +661,12 @@ AccessLimits buildResourceAccessLimits(\n         AccessLimits accessLimits = null;\n         if (info instanceof FeatureTypeInfo) {\n             // merge the area among the filters\n-            if (reprojArea != null) {\n-                Filter areaFilter = FF.intersects(FF.property(\"\"), FF.literal(reprojArea));\n+            if (intersectsArea != null) {\n+                Filter areaFilter = FF.intersects(FF.property(\"\"), FF.literal(intersectsArea));", "originalCommit": "4c25e0340564f3c568f7c1896659e2adbd29eb39", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDQ0NTc2OQ==", "url": "https://github.com/geoserver/geoserver/pull/4627#discussion_r554445769", "bodyText": "thanks for your point @aaime :\nthe scenario that the usage of ClipIntersectionFeatureCollection and the new field try to handle is one where we have two spatial filter one per type and is needed to put them in \"OR\".\nThis happens when a user is inside two groups one with an intersects filter and the other with the clip. Geofence will return an accessInfo with both filter types. Simply delegating to the database the intersection and the applying the clip with the ClipFeatureCollection would return only the clipped geometries.\nIn this case the intersects filter is still delegated to the database but the intersection is performed again to check wheter or not return feature according to the two spatial filters.", "author": "taba90", "createdAt": "2021-01-09T16:36:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDA4NzA3Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTE1Nzk3MQ==", "url": "https://github.com/geoserver/geoserver/pull/4627#discussion_r555157971", "bodyText": "So in case you have both, you need to clip the geometry, but only if it does not also overlap with the intersect filter, in which case you return it fully?\nThat's bizzarre, but even if we wanted to have this functionality, it should be buried inside the GeoFence module, something like this does not belong in GeoTools.", "author": "aaime", "createdAt": "2021-01-11T16:02:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDA4NzA3Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTE2OTM5MA==", "url": "https://github.com/geoserver/geoserver/pull/4627#discussion_r555169390", "bodyText": "Actually scratch that, it woudl have to be in gs-main... do we really need that behavior though?\nIf really needed, then the odd feature collection wrapper should be a package private class somewhere in gs-main. I mean, it's even hard to explain, we don't want to expose it.", "author": "aaime", "createdAt": "2021-01-11T16:18:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDA4NzA3Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MzUzMTkxMg==", "url": "https://github.com/geoserver/geoserver/pull/4627#discussion_r563531912", "bodyText": "Odd but... if a user belongs to two groups one with an intersects filter and the other with the clip filter and the two overlaps,  if the intersects doesn't win over the clip then we would have cases where the user is meant to have access to a geometry that he cannot actually sees.", "author": "taba90", "createdAt": "2021-01-25T08:20:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDA4NzA3Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MzYyMjU4Nw==", "url": "https://github.com/geoserver/geoserver/pull/4627#discussion_r563622587", "bodyText": "Verified with Emanuele, its indeed the intended behavior", "author": "aaime", "createdAt": "2021-01-25T10:40:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDA4NzA3Mw=="}], "type": "inlineReview"}, {"oid": "9e93439132ed4831c724e7de350459a35272eb93", "url": "https://github.com/geoserver/geoserver/commit/9e93439132ed4831c724e7de350459a35272eb93", "message": "update geofence version", "committedDate": "2021-01-24T12:05:33Z", "type": "forcePushed"}, {"oid": "e31d062cfeb6c4292969418177006b09c58170da", "url": "https://github.com/geoserver/geoserver/commit/e31d062cfeb6c4292969418177006b09c58170da", "message": "update geofence version", "committedDate": "2021-01-25T10:03:26Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MzYyNDY1NA==", "url": "https://github.com/geoserver/geoserver/pull/4627#discussion_r563624654", "bodyText": "This bit seems weird too. A multi-geometry is still cosidered \"one\", while here it's taken apart in smaller bits?\nSay the geometry is Italy and all its big and small islands, if I undrestand correctly, only the bits of that large multipolygon intersecting the geometry filter would be returned? That's now how spatial databases work, it's surprising behavior to me.", "author": "aaime", "createdAt": "2021-01-25T10:44:01Z", "path": "src/main/src/main/java/org/geoserver/security/decorators/ClipIntersectsFeatureIterator.java", "diffHunk": "@@ -0,0 +1,184 @@\n+/*\n+ *    GeoTools - The Open Source Java GIS Toolkit\n+ *    http://geotools.org\n+ *\n+ *    (C) 2020, Open Source Geospatial Foundation (OSGeo)\n+ *\n+ *    This library is free software; you can redistribute it and/or\n+ *    modify it under the terms of the GNU Lesser General Public\n+ *    License as published by the Free Software Foundation;\n+ *    version 2.1 of the License.\n+ *\n+ *    This library is distributed in the hope that it will be useful,\n+ *    but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ *    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU\n+ *    Lesser General Public License for more details.\n+ */\n+package org.geoserver.security.decorators;\n+\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import org.geotools.data.simple.SimpleFeatureIterator;\n+import org.geotools.feature.collection.ClippedFeatureIterator;\n+import org.locationtech.jts.geom.Geometry;\n+import org.locationtech.jts.geom.GeometryCollection;\n+import org.locationtech.jts.geom.GeometryFactory;\n+import org.locationtech.jts.geom.LineString;\n+import org.locationtech.jts.geom.MultiLineString;\n+import org.locationtech.jts.geom.MultiPoint;\n+import org.locationtech.jts.geom.MultiPolygon;\n+import org.locationtech.jts.geom.Point;\n+import org.locationtech.jts.geom.Polygon;\n+import org.opengis.feature.simple.SimpleFeature;\n+import org.opengis.feature.simple.SimpleFeatureType;\n+import org.opengis.feature.type.AttributeDescriptor;\n+import org.opengis.feature.type.GeometryDescriptor;\n+import org.opengis.feature.type.Name;\n+\n+/**\n+ * A SimpleFeatureCollection that can filter features' geometries by a clip (crop) spatialFilter and\n+ * by an intersects spatialFilter. If a geometry is hit by both the result of the two filters is\n+ * merged.\n+ */\n+class ClipIntersectsFeatureIterator extends ClippedFeatureIterator {\n+    private Geometry intersects;\n+\n+    /**\n+     * @param delegate delegate Iterator to be used as a delegate.\n+     * @param clip the geometry to be used to clip (crop features).\n+     * @param intersects the geometry to be used to intersects features.\n+     * @param schema the featureType\n+     * @param preserveZ flag to set to true if the clipping process should preserve the z dimension\n+     */\n+    ClipIntersectsFeatureIterator(\n+            SimpleFeatureIterator delegate,\n+            Geometry clip,\n+            Geometry intersects,\n+            SimpleFeatureType schema,\n+            boolean preserveZ) {\n+        super(delegate, clip, schema, preserveZ);\n+        this.intersects = intersects;\n+    }\n+\n+    @Override\n+    public boolean hasNext() {\n+\n+        while (next == null && delegate.hasNext()) {\n+            // try building the clipped feature out of the original feature, if the\n+            // default geometry is clipped out, skip it\n+            SimpleFeature f = delegate.next();\n+\n+            boolean doTheClip = intersects == null ? true : false;\n+\n+            Map<Name, Geometry> intersectedGeometries = null;\n+            if (intersects != null) {\n+                Map<Name, Geometry> geometryAttributes = extractGeometryAttributes(f);\n+                intersectedGeometries =\n+                        getIntersectingGeometries(geometryAttributes, f.getFeatureType());\n+                // if there is at least one geometryCollection or not all the geometry\n+                // attributes were intersected performs also the clip\n+                if (intersectedGeometries != null)\n+                    doTheClip =\n+                            intersectedGeometries\n+                                            .values()\n+                                            .stream()\n+                                            .anyMatch(g -> g instanceof GeometryCollection)\n+                                    || geometryAttributes.size() > intersectedGeometries.size();\n+            }\n+\n+            boolean clippedOut = false;\n+            if (doTheClip) clippedOut = prepareBuilderForNextFeature(f);\n+\n+            if (!clippedOut) {\n+                // build the next feature\n+                next = fb.buildFeature(f.getID());\n+                unionWithIntersected(intersectedGeometries);\n+\n+            } else if (intersectedGeometries != null && !intersectedGeometries.isEmpty()) {\n+                next = fb.buildFeature(f.getID());\n+                for (Name name : intersectedGeometries.keySet()) {\n+                    next.setAttribute(name, intersectedGeometries.get(name));\n+                }\n+            }\n+\n+            fb.reset();\n+        }\n+\n+        return next != null;\n+    }\n+\n+    // union the clipped geometries with the intersected one\n+    private void unionWithIntersected(Map<Name, Geometry> intersectedGeometries) {\n+        for (Name name : intersectedGeometries.keySet()) {\n+            Geometry intersected = intersectedGeometries.get(name);\n+            if (intersected != null && !intersected.isEmpty())\n+                next.setAttribute(name, ((Geometry) next.getAttribute(name)).union(intersected));\n+        }\n+    }\n+\n+    private Map<Name, Geometry> getIntersectingGeometries(\n+            Map<Name, Geometry> geometryAttributes, SimpleFeatureType type) {\n+        Map<Name, Geometry> intersectedGeometries = new HashMap<>();\n+        for (Name name : geometryAttributes.keySet()) {\n+            Geometry geom = geometryAttributes.get(name);\n+            if (geom instanceof GeometryCollection) {", "originalCommit": "e31d062cfeb6c4292969418177006b09c58170da", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MzgzMzg0OQ==", "url": "https://github.com/geoserver/geoserver/pull/4627#discussion_r563833849", "bodyText": "thanks for your point @aaime fixed", "author": "taba90", "createdAt": "2021-01-25T15:55:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MzYyNDY1NA=="}], "type": "inlineReview"}, {"oid": "d97a6388a65149c9d0fa7d4ed945f5ea1e997819", "url": "https://github.com/geoserver/geoserver/commit/d97a6388a65149c9d0fa7d4ed945f5ea1e997819", "message": "review feedback applied", "committedDate": "2021-01-25T15:54:49Z", "type": "forcePushed"}, {"oid": "85b45320ed8baa8e57316a5f6069c4482548af08", "url": "https://github.com/geoserver/geoserver/commit/85b45320ed8baa8e57316a5f6069c4482548af08", "message": "[GEOS-9830] Allow the possibility to define allowedArea in a SRID different from 4326 in geofence", "committedDate": "2021-01-26T09:20:22Z", "type": "commit"}, {"oid": "d2511ab0015c0d2f42261043b22cb49b91b29673", "url": "https://github.com/geoserver/geoserver/commit/d2511ab0015c0d2f42261043b22cb49b91b29673", "message": "review feedback applied", "committedDate": "2021-01-26T10:04:58Z", "type": "forcePushed"}, {"oid": "8b905c247b7382b32ceebe9fa8dafb80ac70ec6f", "url": "https://github.com/geoserver/geoserver/commit/8b905c247b7382b32ceebe9fa8dafb80ac70ec6f", "message": "[GEOS-9831] Possibility to use SpatialFilter in Geofence also to clip features", "committedDate": "2021-01-26T11:10:36Z", "type": "commit"}, {"oid": "ffb29deb2340aa13270eaef6e8ca631d6407008b", "url": "https://github.com/geoserver/geoserver/commit/ffb29deb2340aa13270eaef6e8ca631d6407008b", "message": "[GEOS-9875] Update geofence version to 3.4.7", "committedDate": "2021-01-26T11:12:55Z", "type": "commit"}, {"oid": "ffb29deb2340aa13270eaef6e8ca631d6407008b", "url": "https://github.com/geoserver/geoserver/commit/ffb29deb2340aa13270eaef6e8ca631d6407008b", "message": "[GEOS-9875] Update geofence version to 3.4.7", "committedDate": "2021-01-26T11:12:55Z", "type": "forcePushed"}]}