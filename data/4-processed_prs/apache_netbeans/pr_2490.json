{"pr_number": 2490, "pr_title": "[NETBEANS-3789] Fix missing artitact nodes in Gradle Project Configurations.", "pr_createdAt": "2020-10-25T20:35:22Z", "pr_url": "https://github.com/apache/netbeans/pull/2490", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTcwOTk4MA==", "url": "https://github.com/apache/netbeans/pull/2490#discussion_r511709980", "bodyText": "Isn't this an API? If so, I'd better be documented in arch.xml as <arch group=\"systemproperty\" stability=\"private\" .../>", "author": "JaroslavTulach", "createdAt": "2020-10-26T04:06:53Z", "path": "extide/gradle/src/org/netbeans/modules/gradle/GradleProjectCache.java", "diffHunk": "@@ -88,6 +88,8 @@\n     private static AtomicLong timeInLoad = new AtomicLong();\n     private static AtomicInteger loadedProjects = new AtomicInteger();\n \n+    private static final boolean DEBUG_GRADLE_INFO_ACTION = Boolean.getBoolean(\"netbeans.debug.gradle.info.action\"); //NOI18N", "originalCommit": "1a9644c40677934a0a99da60f0bff461e49118bc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTcxMDQ2Mg==", "url": "https://github.com/apache/netbeans/pull/2490#discussion_r511710462", "bodyText": "Is gradle_user_name also some kind of API as it is read elsewhere?", "author": "JaroslavTulach", "createdAt": "2020-10-26T04:09:35Z", "path": "extide/gradle/netbeans-gradle-tooling/src/main/groovy/org/netbeans/modules/gradle/tooling/NbProjectInfoBuilder.groovy", "diffHunk": "@@ -99,6 +99,7 @@ class NbProjectInfoBuilder {\n         model.info.project_buildDir = project.buildDir;\n         model.info.project_projectDir = project.projectDir;\n         model.info.project_rootDir = project.rootDir;\n+        model.info.gradle_user_home = project.gradle.gradleUserHomeDir;", "originalCommit": "1a9644c40677934a0a99da60f0bff461e49118bc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTcxMDY0MQ==", "url": "https://github.com/apache/netbeans/pull/2490#discussion_r511710641", "bodyText": "Here the gradle_user_home value is read...", "author": "JaroslavTulach", "createdAt": "2020-10-26T04:10:24Z", "path": "extide/gradle/src/org/netbeans/modules/gradle/api/GradleBaseProjectBuilder.java", "diffHunk": "@@ -125,6 +127,9 @@ void processTasks() {\n \n     void processDependencies() {\n \n+        File gradleUserHome = (File) info.get(\"gradle_user_home\");", "originalCommit": "1a9644c40677934a0a99da60f0bff461e49118bc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTc2OTYyMg==", "url": "https://github.com/apache/netbeans/pull/2490#discussion_r511769622", "bodyText": "Technically it is an API, a protocol behind a serialization between the netbeans-gradle-tooling which is actually a trojan horse that lets serialize the build information out of Gradle. On NetBeans side this data is de-serialized by the different GradleWhateverProjectBuilders. These builders then constructs public API objects from the de-serialized information.\nThis is one of the ugliest part of my Gradle integration. There are two reasons for implementing it this way. The ready to use Gradle Models were really not provided enough information in the days of Gradle 1.x, 2.x and 3.x series. The other one is that the remoting which would make these rich interfaces easily consumable were/are memory grubbing proxies. So I reduced the remoting to HashSet-s, HashMaps with Strings and Files.\nHaving that once NetBeans get the information proxies back, basically a few hashmaps, it rewrites the data into real JVM objects, so those can be serialized to disk for caching, and also can built API objects out of it. AFAIK, Attila had a nice abstraction between Gradle and NetBeans and the objects (proxies) returned by  Gradle were ready to use for NetBeans. Unfortunately they were seldom reclaimed by the GC. I guess Attila fixed that later, but I have not followed his plugin that closely.", "author": "lkishalmi", "createdAt": "2020-10-26T07:52:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTcxMDY0MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTc3MjQxNw==", "url": "https://github.com/apache/netbeans/pull/2490#discussion_r511772417", "bodyText": "Actually this is the primary fix. The transient data (I called that ext for whatever reason) shall be not cached to the disk, but when NetBeans process the project information it holds important data on binary, source and javadoc location which are stored in the GradleAtrifactStore. Returning an empty map when the project is not restored from serialization, made that these location data were never stored in the artifact store.", "author": "lkishalmi", "createdAt": "2020-10-26T07:59:02Z", "path": "extide/gradle/src/org/netbeans/modules/gradle/cache/ProjectInfoDiskCache.java", "diffHunk": "@@ -83,7 +86,7 @@ public QualifiedProjectInfo(Quality quality, NbProjectInfo pinfo) {\n \n         @Override\n         public Map<String, Object> getExt() {\n-            return Collections.emptyMap();\n+            return ext != null ? ext : Collections.emptyMap();", "originalCommit": "1a9644c40677934a0a99da60f0bff461e49118bc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTc3Mzg5Ng==", "url": "https://github.com/apache/netbeans/pull/2490#discussion_r511773896", "bodyText": "This makes the module dependency resolution more stable. If the ArtifactStore has no information on a module for whatever reason, NetBeans tries to resolve it using the Gradle Module Cache directory structure.", "author": "lkishalmi", "createdAt": "2020-10-26T08:02:14Z", "path": "extide/gradle/src/org/netbeans/modules/gradle/api/GradleBaseProjectBuilder.java", "diffHunk": "@@ -242,6 +244,23 @@ void processDependencies() {\n         problems.addAll(unresolvedProblems.values());\n     }\n \n+    private ModuleDependency resolveModuleDependency(File gradleUserHome, String c) {\n+        GradleModuleFileCache21 moduleCache = GradleModuleFileCache21.getGradleFileCache(gradleUserHome.toPath());\n+        GradleModuleFileCache21.CachedArtifactVersion artVersion = moduleCache.resolveModule(c);\n+        Set<File> binaries = artifactSore.getBinaries(c);", "originalCommit": "1a9644c40677934a0a99da60f0bff461e49118bc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "11165e5d43ce3f98e6c6c0eb3a57d43404b634bf", "url": "https://github.com/apache/netbeans/commit/11165e5d43ce3f98e6c6c0eb3a57d43404b634bf", "message": "[NETBEANS-3789] Fix missing configuration nodes.", "committedDate": "2020-10-26T16:02:46Z", "type": "forcePushed"}, {"oid": "d192365b9b6499ae82add6467cc025fd5b37cbbc", "url": "https://github.com/apache/netbeans/commit/d192365b9b6499ae82add6467cc025fd5b37cbbc", "message": "[NETBEANS-3789] Fix missing configuration nodes.", "committedDate": "2020-10-26T19:44:20Z", "type": "commit"}, {"oid": "d192365b9b6499ae82add6467cc025fd5b37cbbc", "url": "https://github.com/apache/netbeans/commit/d192365b9b6499ae82add6467cc025fd5b37cbbc", "message": "[NETBEANS-3789] Fix missing configuration nodes.", "committedDate": "2020-10-26T19:44:20Z", "type": "forcePushed"}]}