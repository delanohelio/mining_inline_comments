{"pr_number": 7631, "pr_title": "Add Support for (most) 1.8 maps", "pr_createdAt": "2020-09-12T08:13:20Z", "pr_url": "https://github.com/triplea-game/triplea/pull/7631", "timeline": [{"oid": "cca040640d161365d93d309026a0950e617ddda3", "url": "https://github.com/triplea-game/triplea/commit/cca040640d161365d93d309026a0950e617ddda3", "message": "Add: Support XML tag aliases, support \"attatchment\" mispelling\n\nThis initial round of updates allows for basic support of 1.8 maps,\nthey will load after this update.", "committedDate": "2020-09-12T06:12:05Z", "type": "commit"}, {"oid": "56e0ce48ebcecb83ceea4ce2fc0daa53d0400b4b", "url": "https://github.com/triplea-game/triplea/commit/56e0ce48ebcecb83ceea4ce2fc0daa53d0400b4b", "message": "Add support to load (most) 1.8 maps\n\n- Add conversion code to match attachments spelled either as 'attatchment' or as 'attachment\n\n- Add annotation @RenameOnNextMajorRelease to help us know which items we can rename\n and to what when save game compatibility can be broken.\n\n- Add ignore for properties: \"takeUnitControl\" and \"giveUnitControl\"\n\nAdd conversion logic for:\n- isParatroop -> isAirTransportable\n- isInfantry & isMechanized -> isLandTransportable\n- Battleship|Units repair at beginning|end of round -> Units Repair at beginning|end of round\n- 'occupiedTerrOf' -> 'originalOwner'\n- 'victoryCity=false' -> 'victoryCity=0'\n- 'isImpassible' -> 'isImpassable'\n- 'turns' -> 'rounds'", "committedDate": "2020-09-12T08:10:41Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzM4NDMyMg==", "url": "https://github.com/triplea-game/triplea/pull/7631#discussion_r487384322", "bodyText": "Method mapXmlToObject has 68 lines of code (exceeds 50 allowed). Consider refactoring.", "author": "codeclimate", "createdAt": "2020-09-12T08:15:54Z", "path": "xml-reader/src/main/java/org/triplea/generic/xml/reader/XmlMapper.java", "diffHunk": "@@ -28,6 +33,11 @@ public XmlMapper(final InputStream inputStream) throws XmlParsingException {\n   }\n \n   public <T> T mapXmlToObject(final Class<T> pojo) throws XmlParsingException {\n+    return mapXmlToObject(pojo, pojo.getSimpleName());\n+  }\n+\n+  public <T> T mapXmlToObject(final Class<T> pojo, final String tagName)", "originalCommit": "56e0ce48ebcecb83ceea4ce2fc0daa53d0400b4b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzM4NDMyMw==", "url": "https://github.com/triplea-game/triplea/pull/7631#discussion_r487384323", "bodyText": "Avoid too many return statements within this method.", "author": "codeclimate", "createdAt": "2020-09-12T08:15:54Z", "path": "game-core/src/main/java/games/strategy/engine/data/gameparser/LegacyPropertyMapper.java", "diffHunk": "@@ -0,0 +1,58 @@\n+package games.strategy.engine.data.gameparser;\n+\n+import games.strategy.triplea.Constants;\n+import lombok.experimental.UtilityClass;\n+\n+/**\n+ * This converts property names and values that were used in older map XMLs and updates those values\n+ * to their newer versions. This is useful to allow the game code to only use the newer names and\n+ * values while still being able to load older maps.\n+ */\n+@UtilityClass\n+class LegacyPropertyMapper {\n+\n+  static String mapLegacyOptionName(final String optionName) {\n+    if (optionName.equalsIgnoreCase(\"isParatroop\")) {\n+      return \"isAirTransportable\";", "originalCommit": "56e0ce48ebcecb83ceea4ce2fc0daa53d0400b4b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzM4NDMyNA==", "url": "https://github.com/triplea-game/triplea/pull/7631#discussion_r487384324", "bodyText": "Avoid too many return statements within this method.", "author": "codeclimate", "createdAt": "2020-09-12T08:15:54Z", "path": "game-core/src/main/java/games/strategy/engine/data/gameparser/LegacyPropertyMapper.java", "diffHunk": "@@ -0,0 +1,58 @@\n+package games.strategy.engine.data.gameparser;\n+\n+import games.strategy.triplea.Constants;\n+import lombok.experimental.UtilityClass;\n+\n+/**\n+ * This converts property names and values that were used in older map XMLs and updates those values\n+ * to their newer versions. This is useful to allow the game code to only use the newer names and\n+ * values while still being able to load older maps.\n+ */\n+@UtilityClass\n+class LegacyPropertyMapper {\n+\n+  static String mapLegacyOptionName(final String optionName) {\n+    if (optionName.equalsIgnoreCase(\"isParatroop\")) {\n+      return \"isAirTransportable\";\n+    } else if (optionName.equalsIgnoreCase(\"isInfantry\")\n+        || optionName.equalsIgnoreCase(\"isMechanized\")) {\n+      return \"isLandTransportable\";\n+    } else if (optionName.equalsIgnoreCase(\"occupiedTerrOf\")) {\n+      return Constants.ORIGINAL_OWNER;\n+    } else if (optionName.equalsIgnoreCase(\"isImpassible\")) {\n+      return \"isImpassable\";\n+    } else if (optionName.equalsIgnoreCase(\"turns\")) {\n+      return \"rounds\";\n+    }\n+    return optionName;", "originalCommit": "56e0ce48ebcecb83ceea4ce2fc0daa53d0400b4b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzM4NDUxOA==", "url": "https://github.com/triplea-game/triplea/pull/7631#discussion_r487384518", "bodyText": "Codacy found an issue: Avoid really long methods.", "author": "DanVanAtta", "createdAt": "2020-09-12T08:18:17Z", "path": "xml-reader/src/main/java/org/triplea/generic/xml/reader/XmlMapper.java", "diffHunk": "@@ -28,6 +33,11 @@ public XmlMapper(final InputStream inputStream) throws XmlParsingException {\n   }\n \n   public <T> T mapXmlToObject(final Class<T> pojo) throws XmlParsingException {\n+    return mapXmlToObject(pojo, pojo.getSimpleName());\n+  }\n+\n+  public <T> T mapXmlToObject(final Class<T> pojo, final String tagName)", "originalCommit": "56e0ce48ebcecb83ceea4ce2fc0daa53d0400b4b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzM4NDUxOQ==", "url": "https://github.com/triplea-game/triplea/pull/7631#discussion_r487384519", "bodyText": "Codacy found an issue: Assigning an Object to null is a code smell.  Consider refactoring.", "author": "DanVanAtta", "createdAt": "2020-09-12T08:18:18Z", "path": "game-core/src/main/java/games/strategy/triplea/attachments/TriggerAttachment.java", "diffHunk": "@@ -908,11 +908,13 @@ private void resetPlayers() {\n     players = new ArrayList<>();\n   }\n \n-  private void setPlayerAttachmentName(final String name) throws GameParseException {\n-    if (name == null) {\n-      playerAttachmentName = null;\n+  private void setPlayerAttachmentName(final String playerAttachmentName)\n+      throws GameParseException {\n+    if (playerAttachmentName == null) {\n+      this.playerAttachmentName = null;", "originalCommit": "56e0ce48ebcecb83ceea4ce2fc0daa53d0400b4b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODAxNTM1Ng==", "url": "https://github.com/triplea-game/triplea/pull/7631#discussion_r488015356", "bodyText": "I mean we all know why this exists, but it would be nice documenting it here in the code nevertheless", "author": "RoiEXLab", "createdAt": "2020-09-14T15:18:29Z", "path": "game-core/src/main/java/games/strategy/engine/data/ChangeAttachmentChange.java", "diffHunk": "@@ -59,13 +58,16 @@ public ChangeAttachmentChange(\n       final Object newValue,\n       final Object oldValue,\n       final String property,\n-      final boolean resetFirst) {\n-    this.attachmentName = attachmentName;\n+      final boolean clearFirst) {\n+    this.attachmentName =\n+        Optional.ofNullable(attachmentName)\n+            .map(name -> name.replaceAll(\"ttatch\", \"ttach\"))", "originalCommit": "56e0ce48ebcecb83ceea4ce2fc0daa53d0400b4b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODAxNTc5Mw==", "url": "https://github.com/triplea-game/triplea/pull/7631#discussion_r488015793", "bodyText": "Same on other places", "author": "RoiEXLab", "createdAt": "2020-09-14T15:19:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODAxNTM1Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODM0MzE3Ng==", "url": "https://github.com/triplea-game/triplea/pull/7631#discussion_r488343176", "bodyText": "Added in: #7661", "author": "DanVanAtta", "createdAt": "2020-09-15T02:22:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODAxNTM1Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODAxOTYwNg==", "url": "https://github.com/triplea-game/triplea/pull/7631#discussion_r488019606", "bodyText": "Not sure if this change is working as intended.\nThe reason why the code was like this in the first place is because there is some ambiguity regarding the naming of attachments. \"twoIfBySea\" has a different namespace unfortunately.\nSee https://forums.triplea-game.org/topic/595/short-attachment-names for more information", "author": "RoiEXLab", "createdAt": "2020-09-14T15:24:14Z", "path": "game-core/src/main/java/games/strategy/engine/data/gameparser/XmlGameElementMapper.java", "diffHunk": "@@ -175,8 +175,7 @@ private static void handleMissingObject(final String objectTypeName, final Strin\n       final GameData gameData) {\n     checkNotNull(typeName);\n \n-    final String normalizedTypeName =\n-        typeName.replaceAll(\"^games\\\\.strategy\\\\.triplea\\\\.attachments\\\\.\", \"\");\n+    final String normalizedTypeName = typeName.replaceAll(\"^.*\\\\.\", \"\");", "originalCommit": "56e0ce48ebcecb83ceea4ce2fc0daa53d0400b4b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODMwODg4Mw==", "url": "https://github.com/triplea-game/triplea/pull/7631#discussion_r488308883", "bodyText": "We'll need to test and fix that if needed.  Having an 'or' regex is not really ideal, but we could do it. IMO the java-class designation ideally would be completely removed, but we'll need to support it going forward. Perhaps we could do just straight up hardcoded mappings. We still have reflection going on to create classes by name, an explicit mapping with explicit construction code is I think where I'd like to go (and then couple that with updating the XML so that java classes are inferred on the backend and no longer needed in the XML).", "author": "DanVanAtta", "createdAt": "2020-09-15T00:21:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODAxOTYwNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODAyMzY5Mg==", "url": "https://github.com/triplea-game/triplea/pull/7631#discussion_r488023692", "bodyText": "Off-Topic: I don't think we have a nice error message for \"too few default colors\" yet, so that might be something to consider here", "author": "RoiEXLab", "createdAt": "2020-09-14T15:28:35Z", "path": "game-core/src/main/java/games/strategy/triplea/ui/mapdata/MapData.java", "diffHunk": "@@ -500,8 +500,10 @@ public Color getPlayerColor(final String playerName) {\n \n   /** returns the color for impassable territories. */\n   public Color impassableColor() {\n-    // just use getPlayerColor, since it parses the properties\n-    return getPlayerColor(Constants.PLAYER_NAME_IMPASSABLE);\n+    return Optional.ofNullable(\n+            getColorProperty(PROPERTY_COLOR_PREFIX + Constants.PLAYER_NAME_IMPASSABLE))\n+        .or(() -> Optional.ofNullable(getColorProperty(PROPERTY_COLOR_PREFIX + \"Impassible\")))\n+        .orElseGet(defaultColors::nextColor);", "originalCommit": "56e0ce48ebcecb83ceea4ce2fc0daa53d0400b4b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODAyODI2Mw==", "url": "https://github.com/triplea-game/triplea/pull/7631#discussion_r488028263", "bodyText": "Nevermind, just saw #7637", "author": "RoiEXLab", "createdAt": "2020-09-14T15:33:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODAyMzY5Mg=="}], "type": "inlineReview"}]}