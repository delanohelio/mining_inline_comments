{"pr_number": 6086, "pr_title": "Make findNearbyEnemyCapitalsAndFactories() ~30x faster.", "pr_createdAt": "2020-03-24T22:40:24Z", "pr_url": "https://github.com/triplea-game/triplea/pull/6086", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzUwNTQwNg==", "url": "https://github.com/triplea-game/triplea/pull/6086#discussion_r397505406", "bodyText": "Avoid deeply nested control flow statements.", "author": "codeclimate", "createdAt": "2020-03-24T22:41:56Z", "path": "game-core/src/main/java/games/strategy/triplea/ai/pro/util/ProTerritoryValueUtils.java", "diffHunk": "@@ -429,18 +431,41 @@ private static double findWaterValue(\n     return capitalOrFactoryValue / 100 + nearbyLandValue / 10;\n   }\n \n+  // 1700 oldT=4906 newT=227 newT2=166 newT3=152\n+  @SuppressWarnings(\"ReferenceEquality\")\n   private static Set<Territory> findNearbyEnemyCapitalsAndFactories(\n-      final Territory t, final Map<Territory, Double> enemyCapitalsAndFactoriesMap) {\n-\n-    Set<Territory> nearbyEnemyCapitalsAndFactories = new HashSet<>();\n-    for (int i = MIN_FACTORY_CHECK_DISTANCE; i <= MAX_FACTORY_CHECK_DISTANCE; i++) {\n-      nearbyEnemyCapitalsAndFactories = t.getData().getMap().getNeighbors(t, i);\n-      nearbyEnemyCapitalsAndFactories.retainAll(enemyCapitalsAndFactoriesMap.keySet());\n-      if (!nearbyEnemyCapitalsAndFactories.isEmpty()) {\n-        break;\n+      final Territory t, final Set<Territory> enemyCapitalsAndFactories) {\n+    final GameMap map = t.getData().getMap();\n+\n+    int distance = 0;\n+    Territory nextDistanceAfter = t;\n+\n+    final var found = new HashSet<Territory>();\n+    final var visited = new HashSet<Territory>(List.of(t));\n+    final var queue = new ArrayDeque<Territory>(List.of(t));\n+    while (!queue.isEmpty()) {\n+      final Territory node = queue.removeFirst();\n+      for (final Territory t2 : map.getNeighbors(node)) {\n+        if (visited.add(t2)) {\n+          queue.add(t2);\n+          if (enemyCapitalsAndFactories.contains(t2)) {\n+            found.add(t2);\n+            if (found.size() == enemyCapitalsAndFactories.size()) {", "originalCommit": "7279d0c01208ebe33b67b033c8d281e225081a4d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzUwNTQwNw==", "url": "https://github.com/triplea-game/triplea/pull/6086#discussion_r397505407", "bodyText": "Method findNearbyEnemyCapitalsAndFactories has 29 lines of code (exceeds 25 allowed). Consider refactoring.", "author": "codeclimate", "createdAt": "2020-03-24T22:41:56Z", "path": "game-core/src/main/java/games/strategy/triplea/ai/pro/util/ProTerritoryValueUtils.java", "diffHunk": "@@ -429,18 +431,41 @@ private static double findWaterValue(\n     return capitalOrFactoryValue / 100 + nearbyLandValue / 10;\n   }\n \n+  // 1700 oldT=4906 newT=227 newT2=166 newT3=152\n+  @SuppressWarnings(\"ReferenceEquality\")", "originalCommit": "7279d0c01208ebe33b67b033c8d281e225081a4d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzUwNTQxMA==", "url": "https://github.com/triplea-game/triplea/pull/6086#discussion_r397505410", "bodyText": "Method findNearbyEnemyCapitalsAndFactories has a Cognitive Complexity of 22 (exceeds 5 allowed). Consider refactoring.", "author": "codeclimate", "createdAt": "2020-03-24T22:41:57Z", "path": "game-core/src/main/java/games/strategy/triplea/ai/pro/util/ProTerritoryValueUtils.java", "diffHunk": "@@ -429,18 +431,41 @@ private static double findWaterValue(\n     return capitalOrFactoryValue / 100 + nearbyLandValue / 10;\n   }\n \n+  // 1700 oldT=4906 newT=227 newT2=166 newT3=152\n+  @SuppressWarnings(\"ReferenceEquality\")", "originalCommit": "7279d0c01208ebe33b67b033c8d281e225081a4d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzU0NDM4OQ==", "url": "https://github.com/triplea-game/triplea/pull/6086#discussion_r397544389", "bodyText": "Even if it saves some redundant overhead, it is good practice to use equals over reference equality.\nHave a look at the errorprone explanation for this \"warning\"/error: https://github.com/google/error-prone/blob/master/docs/bugpattern/ReferenceEquality.md", "author": "RoiEXLab", "createdAt": "2020-03-25T00:37:13Z", "path": "game-core/src/main/java/games/strategy/triplea/ai/pro/util/ProTerritoryValueUtils.java", "diffHunk": "@@ -429,18 +431,41 @@ private static double findWaterValue(\n     return capitalOrFactoryValue / 100 + nearbyLandValue / 10;\n   }\n \n+  // 1700 oldT=4906 newT=227 newT2=166 newT3=152\n+  @SuppressWarnings(\"ReferenceEquality\")\n   private static Set<Territory> findNearbyEnemyCapitalsAndFactories(\n-      final Territory t, final Map<Territory, Double> enemyCapitalsAndFactoriesMap) {\n-\n-    Set<Territory> nearbyEnemyCapitalsAndFactories = new HashSet<>();\n-    for (int i = MIN_FACTORY_CHECK_DISTANCE; i <= MAX_FACTORY_CHECK_DISTANCE; i++) {\n-      nearbyEnemyCapitalsAndFactories = t.getData().getMap().getNeighbors(t, i);\n-      nearbyEnemyCapitalsAndFactories.retainAll(enemyCapitalsAndFactoriesMap.keySet());\n-      if (!nearbyEnemyCapitalsAndFactories.isEmpty()) {\n-        break;\n+      final Territory t, final Set<Territory> enemyCapitalsAndFactories) {\n+    final GameMap map = t.getData().getMap();\n+\n+    int distance = 0;\n+    Territory nextDistanceAfter = t;\n+\n+    final var found = new HashSet<Territory>();\n+    final var visited = new HashSet<Territory>(List.of(t));\n+    final var queue = new ArrayDeque<Territory>(List.of(t));\n+    while (!queue.isEmpty()) {\n+      final Territory node = queue.removeFirst();\n+      for (final Territory t2 : map.getNeighbors(node)) {\n+        if (visited.add(t2)) {\n+          queue.add(t2);\n+          if (enemyCapitalsAndFactories.contains(t2)) {\n+            found.add(t2);\n+            if (found.size() == enemyCapitalsAndFactories.size()) {\n+              break;\n+            }\n+          }\n+        }\n       }\n-    }\n \n-    return nearbyEnemyCapitalsAndFactories;\n+      if (node == nextDistanceAfter) {", "originalCommit": "7279d0c01208ebe33b67b033c8d281e225081a4d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODE5Mjk4MA==", "url": "https://github.com/triplea-game/triplea/pull/6086#discussion_r398192980", "bodyText": "The logic here is intended to compute distance without significant extra overhead. I'd have to check how much equals() adds. If it's non-trivial, might be better to just track distance explicitly (by having a Node type that includes a Territory and a distance member).", "author": "asvitkine", "createdAt": "2020-03-25T21:52:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzU0NDM4OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODIxNTQ2Ng==", "url": "https://github.com/triplea-game/triplea/pull/6086#discussion_r398215466", "bodyText": "I checked with .equals() and the result is a 20% slowdown. :(", "author": "asvitkine", "createdAt": "2020-03-25T22:43:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzU0NDM4OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODIzMTcxNw==", "url": "https://github.com/triplea-game/triplea/pull/6086#discussion_r398231717", "bodyText": "We added ObjectUtils#referenceEquals() some time ago to act as documentation for the case when one really wants to use reference equality.  The Javadocs for this method state:\n* <p>Use this method only when you really need to compare object references for equality. In\n* almost all cases you should be using {@link Object#equals(Object)}. <strong>Using this method\n* documents your intention that a reference equality check is required.</strong>\nIts usage should prevent ErrorProne from triggering on this line.", "author": "ssoloff", "createdAt": "2020-03-25T23:28:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzU0NDM4OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODMxMzQwMw==", "url": "https://github.com/triplea-game/triplea/pull/6086#discussion_r398313403", "bodyText": "Thanks, used that now.", "author": "asvitkine", "createdAt": "2020-03-26T04:37:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzU0NDM4OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzU0NTkxMA==", "url": "https://github.com/triplea-game/triplea/pull/6086#discussion_r397545910", "bodyText": "I undertand how this distance is counted, pretty clever way to do it efficiently, however a comment explaining it would be nice in case we ever look at this code again (which will likely happen)", "author": "RoiEXLab", "createdAt": "2020-03-25T00:42:45Z", "path": "game-core/src/main/java/games/strategy/triplea/ai/pro/util/ProTerritoryValueUtils.java", "diffHunk": "@@ -429,18 +431,41 @@ private static double findWaterValue(\n     return capitalOrFactoryValue / 100 + nearbyLandValue / 10;\n   }\n \n+  // 1700 oldT=4906 newT=227 newT2=166 newT3=152\n+  @SuppressWarnings(\"ReferenceEquality\")\n   private static Set<Territory> findNearbyEnemyCapitalsAndFactories(\n-      final Territory t, final Map<Territory, Double> enemyCapitalsAndFactoriesMap) {\n-\n-    Set<Territory> nearbyEnemyCapitalsAndFactories = new HashSet<>();\n-    for (int i = MIN_FACTORY_CHECK_DISTANCE; i <= MAX_FACTORY_CHECK_DISTANCE; i++) {\n-      nearbyEnemyCapitalsAndFactories = t.getData().getMap().getNeighbors(t, i);\n-      nearbyEnemyCapitalsAndFactories.retainAll(enemyCapitalsAndFactoriesMap.keySet());\n-      if (!nearbyEnemyCapitalsAndFactories.isEmpty()) {\n-        break;\n+      final Territory t, final Set<Territory> enemyCapitalsAndFactories) {\n+    final GameMap map = t.getData().getMap();\n+\n+    int distance = 0;\n+    Territory nextDistanceAfter = t;\n+\n+    final var found = new HashSet<Territory>();\n+    final var visited = new HashSet<Territory>(List.of(t));\n+    final var queue = new ArrayDeque<Territory>(List.of(t));\n+    while (!queue.isEmpty()) {\n+      final Territory node = queue.removeFirst();\n+      for (final Territory t2 : map.getNeighbors(node)) {\n+        if (visited.add(t2)) {\n+          queue.add(t2);\n+          if (enemyCapitalsAndFactories.contains(t2)) {\n+            found.add(t2);\n+            if (found.size() == enemyCapitalsAndFactories.size()) {\n+              break;\n+            }\n+          }\n+        }\n       }\n-    }\n \n-    return nearbyEnemyCapitalsAndFactories;\n+      if (node == nextDistanceAfter) {\n+        distance++;", "originalCommit": "7279d0c01208ebe33b67b033c8d281e225081a4d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODE5MjQ3Mg==", "url": "https://github.com/triplea-game/triplea/pull/6086#discussion_r398192472", "bodyText": "Added a comment, thanks!", "author": "asvitkine", "createdAt": "2020-03-25T21:51:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzU0NTkxMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzU0NzcxNg==", "url": "https://github.com/triplea-game/triplea/pull/6086#discussion_r397547716", "bodyText": "I just had a look at the implementation of the getNeighbours method with a distance and it is bad but still used.\nI'd really appreciate if you could have a look at that one as well in the near future.", "author": "RoiEXLab", "createdAt": "2020-03-25T00:49:06Z", "path": "game-core/src/main/java/games/strategy/triplea/ai/pro/util/ProTerritoryValueUtils.java", "diffHunk": "@@ -429,18 +431,41 @@ private static double findWaterValue(\n     return capitalOrFactoryValue / 100 + nearbyLandValue / 10;\n   }\n \n+  // 1700 oldT=4906 newT=227 newT2=166 newT3=152\n+  @SuppressWarnings(\"ReferenceEquality\")\n   private static Set<Territory> findNearbyEnemyCapitalsAndFactories(\n-      final Territory t, final Map<Territory, Double> enemyCapitalsAndFactoriesMap) {\n-\n-    Set<Territory> nearbyEnemyCapitalsAndFactories = new HashSet<>();\n-    for (int i = MIN_FACTORY_CHECK_DISTANCE; i <= MAX_FACTORY_CHECK_DISTANCE; i++) {\n-      nearbyEnemyCapitalsAndFactories = t.getData().getMap().getNeighbors(t, i);", "originalCommit": "7279d0c01208ebe33b67b033c8d281e225081a4d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzU5ODA4OA==", "url": "https://github.com/triplea-game/triplea/pull/6086#discussion_r397598088", "bodyText": "IDK, I'd tend to agree with code climate on the length and complexity warning. The trick is not just to break up a method but to create the right abstractions. EG:\nwhile (!queue.isEmpty()) {\n   found.addAll(findAtDistance(distance, .... ));\n   distance ++;\n   if (distance > MAX_FACTORY_CHECK_DISTANCE\n        || (distance >= MIN_FACTORY_CHECK_DISTANCE && !found.isEmpty())) {\n       break;\n    }\n    nextDistanceAfter = queue.getLast();\n}\nreturn found;\n\nI don't know if that quite does it, it's an art to find something that works right and does not just create indirection.", "author": "DanVanAtta", "createdAt": "2020-03-25T04:03:55Z", "path": "game-core/src/main/java/games/strategy/triplea/ai/pro/util/ProTerritoryValueUtils.java", "diffHunk": "@@ -429,18 +431,41 @@ private static double findWaterValue(\n     return capitalOrFactoryValue / 100 + nearbyLandValue / 10;\n   }\n \n+  // 1700 oldT=4906 newT=227 newT2=166 newT3=152\n+  @SuppressWarnings(\"ReferenceEquality\")\n   private static Set<Territory> findNearbyEnemyCapitalsAndFactories(\n-      final Territory t, final Map<Territory, Double> enemyCapitalsAndFactoriesMap) {\n-\n-    Set<Territory> nearbyEnemyCapitalsAndFactories = new HashSet<>();\n-    for (int i = MIN_FACTORY_CHECK_DISTANCE; i <= MAX_FACTORY_CHECK_DISTANCE; i++) {\n-      nearbyEnemyCapitalsAndFactories = t.getData().getMap().getNeighbors(t, i);\n-      nearbyEnemyCapitalsAndFactories.retainAll(enemyCapitalsAndFactoriesMap.keySet());\n-      if (!nearbyEnemyCapitalsAndFactories.isEmpty()) {\n-        break;\n+      final Territory t, final Set<Territory> enemyCapitalsAndFactories) {\n+    final GameMap map = t.getData().getMap();\n+\n+    int distance = 0;\n+    Territory nextDistanceAfter = t;\n+\n+    final var found = new HashSet<Territory>();", "originalCommit": "7279d0c01208ebe33b67b033c8d281e225081a4d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODE5NzQwOA==", "url": "https://github.com/triplea-game/triplea/pull/6086#discussion_r398197408", "bodyText": "I don't think that helps, findAtDistance() would require too many params which codeclimate will complain about.\nThe only way I see of \"working around it\" is to make a helper class and move all these variables to be members. Then, helper methods don't need to take these params because they'd be explicitly taking them as part of being on the object, so codeclimate would not complain.\nI'm not sure this is something we should be optimizing for. The result would be instead of a 30-line method we'd have a 50-75 line class. Is that really a net win?", "author": "asvitkine", "createdAt": "2020-03-25T22:01:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzU5ODA4OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODE5ODA2OQ==", "url": "https://github.com/triplea-game/triplea/pull/6086#discussion_r398198069", "bodyText": "Put another way, would we be happy if every 30+ line method instead becomes its own class with a constructor and 2-5 other methods? Do we think that would be a better state?", "author": "asvitkine", "createdAt": "2020-03-25T22:03:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzU5ODA4OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODI1OTc4NQ==", "url": "https://github.com/triplea-game/triplea/pull/6086#discussion_r398259785", "bodyText": "I'd say the complexity is ok here given this is a performance sensitive method. If anything I'd rather focus on adding some comments describing how it works as no matter how you chop it up it is going to be a bit complex.", "author": "ron-murhammer", "createdAt": "2020-03-26T01:03:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzU5ODA4OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODI4MjQ2Mg==", "url": "https://github.com/triplea-game/triplea/pull/6086#discussion_r398282462", "bodyText": "I don't think that is necessarily the trade-off or decision. There are other ways..", "author": "DanVanAtta", "createdAt": "2020-03-26T02:29:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzU5ODA4OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODI4NTYzMw==", "url": "https://github.com/triplea-game/triplea/pull/6086#discussion_r398285633", "bodyText": "I don't think that helps, findAtDistance() would require too many params which codeclimate will complain about.\n\nIntroduce Parameter Object refactoring would solve that.\nThe big point is it's not necessarily about creating indirection, but abstractions and information hiding.", "author": "DanVanAtta", "createdAt": "2020-03-26T02:40:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzU5ODA4OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODI4NjY4MA==", "url": "https://github.com/triplea-game/triplea/pull/6086#discussion_r398286680", "bodyText": "To expound slightly,  a data object with @Builder makes for a natural parameter object.", "author": "DanVanAtta", "createdAt": "2020-03-26T02:44:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzU5ODA4OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODMxNDE1OA==", "url": "https://github.com/triplea-game/triplea/pull/6086#discussion_r398314158", "bodyText": "One simplification I made is removing MAX_FACTORY_CHECK_DISTANCE.\nThis is technically a change from the previous implementation, but in practice I think the only reason the previous implementation had it is because such a condition was needed to make sure it terminated (the old algo just expanded distance and kept trying to find things).\nIt's not needed in this implementation and just adds extra complexity. In practice, 30 away is very far. A small map like revised seems to have every territory less than 9 territories away from any other. A larger map like Big World still is well within the 30 limit.", "author": "asvitkine", "createdAt": "2020-03-26T04:40:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzU5ODA4OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzU5ODI0MQ==", "url": "https://github.com/triplea-game/triplea/pull/6086#discussion_r397598241", "bodyText": "Is t equivalent to the startTerritory, the 'basis' for the search? I'm wondering if the algorithm perhaps would be a bit clearer if 't' and 't2' were spelled out a bit more.", "author": "DanVanAtta", "createdAt": "2020-03-25T04:04:41Z", "path": "game-core/src/main/java/games/strategy/triplea/ai/pro/util/ProTerritoryValueUtils.java", "diffHunk": "@@ -429,18 +431,41 @@ private static double findWaterValue(\n     return capitalOrFactoryValue / 100 + nearbyLandValue / 10;\n   }\n \n+  // 1700 oldT=4906 newT=227 newT2=166 newT3=152\n+  @SuppressWarnings(\"ReferenceEquality\")\n   private static Set<Territory> findNearbyEnemyCapitalsAndFactories(\n-      final Territory t, final Map<Territory, Double> enemyCapitalsAndFactoriesMap) {\n-\n-    Set<Territory> nearbyEnemyCapitalsAndFactories = new HashSet<>();\n-    for (int i = MIN_FACTORY_CHECK_DISTANCE; i <= MAX_FACTORY_CHECK_DISTANCE; i++) {\n-      nearbyEnemyCapitalsAndFactories = t.getData().getMap().getNeighbors(t, i);\n-      nearbyEnemyCapitalsAndFactories.retainAll(enemyCapitalsAndFactoriesMap.keySet());\n-      if (!nearbyEnemyCapitalsAndFactories.isEmpty()) {\n-        break;\n+      final Territory t, final Set<Territory> enemyCapitalsAndFactories) {", "originalCommit": "7279d0c01208ebe33b67b033c8d281e225081a4d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODE5MjI1Mw==", "url": "https://github.com/triplea-game/triplea/pull/6086#discussion_r398192253", "bodyText": "Done.", "author": "asvitkine", "createdAt": "2020-03-25T21:50:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzU5ODI0MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzU5ODM1Nw==", "url": "https://github.com/triplea-game/triplea/pull/6086#discussion_r397598357", "bodyText": "Is this comment intended to be included?", "author": "DanVanAtta", "createdAt": "2020-03-25T04:05:25Z", "path": "game-core/src/main/java/games/strategy/triplea/ai/pro/util/ProTerritoryValueUtils.java", "diffHunk": "@@ -429,18 +431,41 @@ private static double findWaterValue(\n     return capitalOrFactoryValue / 100 + nearbyLandValue / 10;\n   }\n \n+  // 1700 oldT=4906 newT=227 newT2=166 newT3=152", "originalCommit": "7279d0c01208ebe33b67b033c8d281e225081a4d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODE5MjMzMA==", "url": "https://github.com/triplea-game/triplea/pull/6086#discussion_r398192330", "bodyText": "No, removed. Thanks!", "author": "asvitkine", "createdAt": "2020-03-25T21:50:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzU5ODM1Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODE5Mjg4NA==", "url": "https://github.com/triplea-game/triplea/pull/6086#discussion_r398192884", "bodyText": "Method findNearbyEnemyCapitalsAndFactories has a Cognitive Complexity of 17 (exceeds 5 allowed). Consider refactoring.", "author": "codeclimate", "createdAt": "2020-03-25T21:52:06Z", "path": "game-core/src/main/java/games/strategy/triplea/ai/pro/util/ProTerritoryValueUtils.java", "diffHunk": "@@ -429,18 +431,39 @@ private static double findWaterValue(\n     return capitalOrFactoryValue / 100 + nearbyLandValue / 10;\n   }\n \n+  @SuppressWarnings(\"ReferenceEquality\")", "originalCommit": "db4120e75c92262dd1568d9b578e2d98c8681466", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODE5Mjg4Ng==", "url": "https://github.com/triplea-game/triplea/pull/6086#discussion_r398192886", "bodyText": "Method findNearbyEnemyCapitalsAndFactories has 26 lines of code (exceeds 25 allowed). Consider refactoring.", "author": "codeclimate", "createdAt": "2020-03-25T21:52:06Z", "path": "game-core/src/main/java/games/strategy/triplea/ai/pro/util/ProTerritoryValueUtils.java", "diffHunk": "@@ -429,18 +431,39 @@ private static double findWaterValue(\n     return capitalOrFactoryValue / 100 + nearbyLandValue / 10;\n   }\n \n+  @SuppressWarnings(\"ReferenceEquality\")", "originalCommit": "db4120e75c92262dd1568d9b578e2d98c8681466", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODI4ODg1MQ==", "url": "https://github.com/triplea-game/triplea/pull/6086#discussion_r398288851", "bodyText": "Sorry to pile on, nextDistanceAfter is not very clear to me. I would almost expect the value to be a scalar, similar to distance.  Can we brainstorm some potential better variable names?\n\nterritoryAtNextDistanceToCheck?", "author": "DanVanAtta", "createdAt": "2020-03-26T02:53:04Z", "path": "game-core/src/main/java/games/strategy/triplea/ai/pro/util/ProTerritoryValueUtils.java", "diffHunk": "@@ -429,18 +431,41 @@ private static double findWaterValue(\n     return capitalOrFactoryValue / 100 + nearbyLandValue / 10;\n   }\n \n+  // 1700 oldT=4906 newT=227 newT2=166 newT3=152\n+  @SuppressWarnings(\"ReferenceEquality\")\n   private static Set<Territory> findNearbyEnemyCapitalsAndFactories(\n-      final Territory t, final Map<Territory, Double> enemyCapitalsAndFactoriesMap) {\n-\n-    Set<Territory> nearbyEnemyCapitalsAndFactories = new HashSet<>();\n-    for (int i = MIN_FACTORY_CHECK_DISTANCE; i <= MAX_FACTORY_CHECK_DISTANCE; i++) {\n-      nearbyEnemyCapitalsAndFactories = t.getData().getMap().getNeighbors(t, i);\n-      nearbyEnemyCapitalsAndFactories.retainAll(enemyCapitalsAndFactoriesMap.keySet());\n-      if (!nearbyEnemyCapitalsAndFactories.isEmpty()) {\n-        break;\n+      final Territory t, final Set<Territory> enemyCapitalsAndFactories) {\n+    final GameMap map = t.getData().getMap();\n+\n+    int distance = 0;\n+    Territory nextDistanceAfter = t;", "originalCommit": "7279d0c01208ebe33b67b033c8d281e225081a4d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODMxMzI5Mw==", "url": "https://github.com/triplea-game/triplea/pull/6086#discussion_r398313293", "bodyText": "Went with lastTerritoryAtCurrentDistance.", "author": "asvitkine", "createdAt": "2020-03-26T04:36:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODI4ODg1MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODMxNTg2OA==", "url": "https://github.com/triplea-game/triplea/pull/6086#discussion_r398315868", "bodyText": "Awesome, that is easier, thank you", "author": "DanVanAtta", "createdAt": "2020-03-26T04:48:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODI4ODg1MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODI4OTA3MQ==", "url": "https://github.com/triplea-game/triplea/pull/6086#discussion_r398289071", "bodyText": "nit, queue could perhaps be more descriptive as well. Is this the queue of territories to check? territoriesToCheck perhaps as a better name? It would make this boolean conditional perhaps a bit more clear.", "author": "DanVanAtta", "createdAt": "2020-03-26T02:53:53Z", "path": "game-core/src/main/java/games/strategy/triplea/ai/pro/util/ProTerritoryValueUtils.java", "diffHunk": "@@ -429,18 +431,41 @@ private static double findWaterValue(\n     return capitalOrFactoryValue / 100 + nearbyLandValue / 10;\n   }\n \n+  // 1700 oldT=4906 newT=227 newT2=166 newT3=152\n+  @SuppressWarnings(\"ReferenceEquality\")\n   private static Set<Territory> findNearbyEnemyCapitalsAndFactories(\n-      final Territory t, final Map<Territory, Double> enemyCapitalsAndFactoriesMap) {\n-\n-    Set<Territory> nearbyEnemyCapitalsAndFactories = new HashSet<>();\n-    for (int i = MIN_FACTORY_CHECK_DISTANCE; i <= MAX_FACTORY_CHECK_DISTANCE; i++) {\n-      nearbyEnemyCapitalsAndFactories = t.getData().getMap().getNeighbors(t, i);\n-      nearbyEnemyCapitalsAndFactories.retainAll(enemyCapitalsAndFactoriesMap.keySet());\n-      if (!nearbyEnemyCapitalsAndFactories.isEmpty()) {\n-        break;\n+      final Territory t, final Set<Territory> enemyCapitalsAndFactories) {\n+    final GameMap map = t.getData().getMap();\n+\n+    int distance = 0;\n+    Territory nextDistanceAfter = t;\n+\n+    final var found = new HashSet<Territory>();\n+    final var visited = new HashSet<Territory>(List.of(t));\n+    final var queue = new ArrayDeque<Territory>(List.of(t));\n+    while (!queue.isEmpty()) {", "originalCommit": "7279d0c01208ebe33b67b033c8d281e225081a4d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODMxMzI3MQ==", "url": "https://github.com/triplea-game/triplea/pull/6086#discussion_r398313271", "bodyText": "Done.", "author": "asvitkine", "createdAt": "2020-03-26T04:36:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODI4OTA3MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODMxMzc1NQ==", "url": "https://github.com/triplea-game/triplea/pull/6086#discussion_r398313755", "bodyText": "Method findNearbyEnemyCapitalsAndFactories has a Cognitive Complexity of 16 (exceeds 5 allowed). Consider refactoring.", "author": "codeclimate", "createdAt": "2020-03-26T04:38:55Z", "path": "game-core/src/main/java/games/strategy/triplea/ai/pro/util/ProTerritoryValueUtils.java", "diffHunk": "@@ -429,18 +432,55 @@ private static double findWaterValue(\n     return capitalOrFactoryValue / 100 + nearbyLandValue / 10;\n   }\n \n-  private static Set<Territory> findNearbyEnemyCapitalsAndFactories(\n-      final Territory t, final Map<Territory, Double> enemyCapitalsAndFactoriesMap) {\n+  /**\n+   * Finds enemy capitals / factors from a list that are \"nearby\" a given territory.\n+   *\n+   * <p>If any of the target territories exist within a distance of 9, returns the subset that do.\n+   * Otherwise, proceeds to check the territories at each subsequent distance until at least one\n+   * capital is found.\n+   *\n+   * <p>Note: This is an optimized version of a previous, much slower algorithm that has been\n+   * designed to keep the original behavior, but tuned for speed.\n+   *\n+   * @param startTerritory The territory from where to start the search.\n+   * @param enemyCapitalsAndFactories The territories to search for.\n+   * @return Subset of enemyCapitalsAndFactories that were found.\n+   */\n+  protected static Collection<Territory> findNearbyEnemyCapitalsAndFactories(", "originalCommit": "35679d61940329e8a2a01f5918f03b61d3b46474", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "0f6d1f042da5eaa20f5ea26e5882c3ca2ce4800e", "url": "https://github.com/triplea-game/triplea/commit/0f6d1f042da5eaa20f5ea26e5882c3ca2ce4800e", "message": "Make findNearbyEnemyCapitalsAndFactories() ~30x faster.\n\nOn great war map with all AIs, after 1700 executions, the new\nversion takes ~150ms in aggregate while the previous\nimplementation takes 4900ms.\n\nThe algorithm's functionality is kept the same with the exception\nof removing the max distance constant, which was only there as a\nperformance optimization. It's not needed with the new algorithm.", "committedDate": "2020-03-26T23:03:30Z", "type": "commit"}, {"oid": "0f6d1f042da5eaa20f5ea26e5882c3ca2ce4800e", "url": "https://github.com/triplea-game/triplea/commit/0f6d1f042da5eaa20f5ea26e5882c3ca2ce4800e", "message": "Make findNearbyEnemyCapitalsAndFactories() ~30x faster.\n\nOn great war map with all AIs, after 1700 executions, the new\nversion takes ~150ms in aggregate while the previous\nimplementation takes 4900ms.\n\nThe algorithm's functionality is kept the same with the exception\nof removing the max distance constant, which was only there as a\nperformance optimization. It's not needed with the new algorithm.", "committedDate": "2020-03-26T23:03:30Z", "type": "forcePushed"}]}