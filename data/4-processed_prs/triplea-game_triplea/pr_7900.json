{"pr_number": 7900, "pr_title": "Add tests for FiringGroup", "pr_createdAt": "2020-10-14T05:19:31Z", "pr_url": "https://github.com/triplea-game/triplea/pull/7900", "timeline": [{"oid": "ceb800c40653844d34e7167c29b88fb0b7d3e810", "url": "https://github.com/triplea-game/triplea/commit/ceb800c40653844d34e7167c29b88fb0b7d3e810", "message": "Add tests for FiringGroup", "committedDate": "2020-10-14T05:17:42Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjk4OTc1Mg==", "url": "https://github.com/triplea-game/triplea/pull/7900#discussion_r506989752", "bodyText": "nit, the assertion hasSize(1) already says there should be one group, what is not said though is why?", "author": "DanVanAtta", "createdAt": "2020-10-17T22:18:15Z", "path": "game-core/src/test/java/games/strategy/triplea/delegate/battle/steps/fire/FiringGroupTest.java", "diffHunk": "@@ -0,0 +1,187 @@\n+package games.strategy.triplea.delegate.battle.steps.fire;\n+\n+import static games.strategy.triplea.Constants.UNIT_ATTACHMENT_NAME;\n+import static org.hamcrest.MatcherAssert.assertThat;\n+import static org.hamcrest.Matchers.hasSize;\n+import static org.hamcrest.Matchers.is;\n+import static org.mockito.Mockito.mock;\n+\n+import games.strategy.engine.data.GameData;\n+import games.strategy.engine.data.GamePlayer;\n+import games.strategy.engine.data.Unit;\n+import games.strategy.engine.data.UnitType;\n+import games.strategy.triplea.attachments.UnitAttachment;\n+import java.util.Comparator;\n+import java.util.List;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.extension.ExtendWith;\n+import org.mockito.Mock;\n+import org.mockito.junit.jupiter.MockitoExtension;\n+\n+@ExtendWith(MockitoExtension.class)\n+class FiringGroupTest {\n+\n+  @Mock GameData gameData;\n+  @Mock GamePlayer player;\n+\n+  @Test\n+  public void onlyOneGroupIfNoSuicideOnHit() {\n+    final List<Unit> units =\n+        List.of(\n+            givenUnitWithSuicideOnHit(\"type1\", false), givenUnitWithSuicideOnHit(\"type2\", false));\n+    final List<FiringGroup> groups =\n+        FiringGroup.groupBySuicideOnHit(\"test\", units, List.of(mock(Unit.class)));\n+    assertThat(\"There should only be one group\", groups, hasSize(1));", "originalCommit": "ceb800c40653844d34e7167c29b88fb0b7d3e810", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjk5MTIxOQ==", "url": "https://github.com/triplea-game/triplea/pull/7900#discussion_r506991219", "bodyText": "Nit, the method name \" givenUnitWithSuicideOnHit(\"type1\", false)\" is a bit akward with those parameters. I would have expected it to always return a unit with suicide on hit. Boolean parameters are generally evil, so one thing we can do is to create two methods for both cases and that would help with the naming problem. Then it would be:\ngivenUnitWithTypeNameAndSuicideOnHit(\"type1\")\ngivenUnitWithTypeNameWithoutSuicideOnHit(\"type2\")\n\nThough, TBH we would do well if we could create a value object out of this and avoid mocks. That makes me think that the API we are testing should accept the property values rather than the actual unit type object.\nIf we keep the boolean parameter, then perhaps a more descriptive method name would be:\ngivenUnitWithTypeAndHasSuicideOnHit(...)", "author": "DanVanAtta", "createdAt": "2020-10-17T22:37:16Z", "path": "game-core/src/test/java/games/strategy/triplea/delegate/battle/steps/fire/FiringGroupTest.java", "diffHunk": "@@ -0,0 +1,187 @@\n+package games.strategy.triplea.delegate.battle.steps.fire;\n+\n+import static games.strategy.triplea.Constants.UNIT_ATTACHMENT_NAME;\n+import static org.hamcrest.MatcherAssert.assertThat;\n+import static org.hamcrest.Matchers.hasSize;\n+import static org.hamcrest.Matchers.is;\n+import static org.mockito.Mockito.mock;\n+\n+import games.strategy.engine.data.GameData;\n+import games.strategy.engine.data.GamePlayer;\n+import games.strategy.engine.data.Unit;\n+import games.strategy.engine.data.UnitType;\n+import games.strategy.triplea.attachments.UnitAttachment;\n+import java.util.Comparator;\n+import java.util.List;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.extension.ExtendWith;\n+import org.mockito.Mock;\n+import org.mockito.junit.jupiter.MockitoExtension;\n+\n+@ExtendWith(MockitoExtension.class)\n+class FiringGroupTest {\n+\n+  @Mock GameData gameData;\n+  @Mock GamePlayer player;\n+\n+  @Test\n+  public void onlyOneGroupIfNoSuicideOnHit() {\n+    final List<Unit> units =\n+        List.of(\n+            givenUnitWithSuicideOnHit(\"type1\", false), givenUnitWithSuicideOnHit(\"type2\", false));", "originalCommit": "ceb800c40653844d34e7167c29b88fb0b7d3e810", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzQxMTA5MA==", "url": "https://github.com/triplea-game/triplea/pull/7900#discussion_r507411090", "bodyText": "The givenUnit() methods aren't returning mocks.  They are returning an actual Unit and/or UnitType object.  I've changed them to just return a default UnitType and/or Unit and then set the isSuicideOnHit in the test method itself.", "author": "trevan", "createdAt": "2020-10-19T03:32:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjk5MTIxOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjk5MTM2MQ==", "url": "https://github.com/triplea-game/triplea/pull/7900#discussion_r506991361", "bodyText": "These two lines are pretty overwhelming to read, lots of \"givenUnitWithSuicideOnHit\", IMO the method names blur together and it becomes hard to tell exactly which API overload is being invoked where.\nAn intermediate variable could help, eg:\nfinal var unitType = givenUnitTypeWithSuicideOnHit(typeName, suicideOnHit);\nreturn givenUnitWithSuicideOnHit(unitType);", "author": "DanVanAtta", "createdAt": "2020-10-17T22:39:17Z", "path": "game-core/src/test/java/games/strategy/triplea/delegate/battle/steps/fire/FiringGroupTest.java", "diffHunk": "@@ -0,0 +1,187 @@\n+package games.strategy.triplea.delegate.battle.steps.fire;\n+\n+import static games.strategy.triplea.Constants.UNIT_ATTACHMENT_NAME;\n+import static org.hamcrest.MatcherAssert.assertThat;\n+import static org.hamcrest.Matchers.hasSize;\n+import static org.hamcrest.Matchers.is;\n+import static org.mockito.Mockito.mock;\n+\n+import games.strategy.engine.data.GameData;\n+import games.strategy.engine.data.GamePlayer;\n+import games.strategy.engine.data.Unit;\n+import games.strategy.engine.data.UnitType;\n+import games.strategy.triplea.attachments.UnitAttachment;\n+import java.util.Comparator;\n+import java.util.List;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.extension.ExtendWith;\n+import org.mockito.Mock;\n+import org.mockito.junit.jupiter.MockitoExtension;\n+\n+@ExtendWith(MockitoExtension.class)\n+class FiringGroupTest {\n+\n+  @Mock GameData gameData;\n+  @Mock GamePlayer player;\n+\n+  @Test\n+  public void onlyOneGroupIfNoSuicideOnHit() {\n+    final List<Unit> units =\n+        List.of(\n+            givenUnitWithSuicideOnHit(\"type1\", false), givenUnitWithSuicideOnHit(\"type2\", false));\n+    final List<FiringGroup> groups =\n+        FiringGroup.groupBySuicideOnHit(\"test\", units, List.of(mock(Unit.class)));\n+    assertThat(\"There should only be one group\", groups, hasSize(1));\n+    assertThat(\"The group name should have no prefix\", groups.get(0).getDisplayName(), is(\"test\"));\n+    assertThat(\n+        \"The group should have all of the units\",\n+        groups.get(0).getFiringUnits().toArray(),\n+        is(units.toArray()));\n+    assertThat(\"The group should not be suicide on hit\", groups.get(0).isSuicideOnHit(), is(false));\n+  }\n+\n+  private Unit givenUnitWithSuicideOnHit(final String typeName, final boolean suicideOnHit) {", "originalCommit": "ceb800c40653844d34e7167c29b88fb0b7d3e810", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjk5MTU1MQ==", "url": "https://github.com/triplea-game/triplea/pull/7900#discussion_r506991551", "bodyText": "Where does the \"test\" value come from? Can we add that as a parameter to the data setup within this method so that it can be easily correlated when someone is looking at this test? If not, a reference to the value rather than hardcoding would be another way to lead a reader to where the value is coming from.", "author": "DanVanAtta", "createdAt": "2020-10-17T22:41:42Z", "path": "game-core/src/test/java/games/strategy/triplea/delegate/battle/steps/fire/FiringGroupTest.java", "diffHunk": "@@ -0,0 +1,187 @@\n+package games.strategy.triplea.delegate.battle.steps.fire;\n+\n+import static games.strategy.triplea.Constants.UNIT_ATTACHMENT_NAME;\n+import static org.hamcrest.MatcherAssert.assertThat;\n+import static org.hamcrest.Matchers.hasSize;\n+import static org.hamcrest.Matchers.is;\n+import static org.mockito.Mockito.mock;\n+\n+import games.strategy.engine.data.GameData;\n+import games.strategy.engine.data.GamePlayer;\n+import games.strategy.engine.data.Unit;\n+import games.strategy.engine.data.UnitType;\n+import games.strategy.triplea.attachments.UnitAttachment;\n+import java.util.Comparator;\n+import java.util.List;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.extension.ExtendWith;\n+import org.mockito.Mock;\n+import org.mockito.junit.jupiter.MockitoExtension;\n+\n+@ExtendWith(MockitoExtension.class)\n+class FiringGroupTest {\n+\n+  @Mock GameData gameData;\n+  @Mock GamePlayer player;\n+\n+  @Test\n+  public void onlyOneGroupIfNoSuicideOnHit() {\n+    final List<Unit> units =\n+        List.of(\n+            givenUnitWithSuicideOnHit(\"type1\", false), givenUnitWithSuicideOnHit(\"type2\", false));\n+    final List<FiringGroup> groups =\n+        FiringGroup.groupBySuicideOnHit(\"test\", units, List.of(mock(Unit.class)));\n+    assertThat(\"There should only be one group\", groups, hasSize(1));\n+    assertThat(\"The group name should have no prefix\", groups.get(0).getDisplayName(), is(\"test\"));\n+    assertThat(\n+        \"The group should have all of the units\",\n+        groups.get(0).getFiringUnits().toArray(),\n+        is(units.toArray()));\n+    assertThat(\"The group should not be suicide on hit\", groups.get(0).isSuicideOnHit(), is(false));\n+  }\n+\n+  private Unit givenUnitWithSuicideOnHit(final String typeName, final boolean suicideOnHit) {\n+    return givenUnitWithSuicideOnHit(givenUnitTypeWithSuicideOnHit(typeName, suicideOnHit));\n+  }\n+\n+  private Unit givenUnitWithSuicideOnHit(final UnitType unitType) {\n+    return unitType.create(1, player, true).get(0);\n+  }\n+\n+  private UnitType givenUnitTypeWithSuicideOnHit(\n+      final String typeName, final boolean suicideOnHit) {\n+    final UnitType unitType = new UnitType(typeName, gameData);\n+    final UnitAttachment unitAttachment = new UnitAttachment(\"attachment\", unitType, gameData);\n+    unitType.addAttachment(UNIT_ATTACHMENT_NAME, unitAttachment);\n+    unitAttachment.setIsSuicideOnHit(suicideOnHit);\n+    return unitType;\n+  }\n+\n+  @Test\n+  public void onlyOneGroupIfSameTypeAndSuicide() {\n+    final UnitType unitType = givenUnitTypeWithSuicideOnHit(\"type\", true);\n+    final List<Unit> units =\n+        List.of(givenUnitWithSuicideOnHit(unitType), givenUnitWithSuicideOnHit(unitType));\n+    final List<FiringGroup> groups =\n+        FiringGroup.groupBySuicideOnHit(\"test\", units, List.of(mock(Unit.class)));\n+    assertThat(\"There should only be one group\", groups, hasSize(1));\n+    assertThat(\"The group name should have no prefix\", groups.get(0).getDisplayName(), is(\"test\"));", "originalCommit": "ceb800c40653844d34e7167c29b88fb0b7d3e810", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzQxMDAwNw==", "url": "https://github.com/triplea-game/triplea/pull/7900#discussion_r507410007", "bodyText": "I made \"test\" as a static constant in the class.", "author": "trevan", "createdAt": "2020-10-19T03:30:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjk5MTU1MQ=="}], "type": "inlineReview"}, {"oid": "be3c56f8584c5c79278a301b8799e305020a42b3", "url": "https://github.com/triplea-game/triplea/commit/be3c56f8584c5c79278a301b8799e305020a42b3", "message": "Create a default unit type in the test helper and set suicide individually", "committedDate": "2020-10-19T03:28:46Z", "type": "commit"}]}