{"pr_number": 7645, "pr_title": "Battle step cleanups", "pr_createdAt": "2020-09-14T01:40:46Z", "pr_url": "https://github.com/triplea-game/triplea/pull/7645", "timeline": [{"oid": "45435df0271eb7808d6d206e4ecd28b086cbf670", "url": "https://github.com/triplea-game/triplea/commit/45435df0271eb7808d6d206e4ecd28b086cbf670", "message": "Remove tests duplicated by step tests", "committedDate": "2020-09-13T22:36:50Z", "type": "commit"}, {"oid": "175efd9d8a68258e7c95e8ec240ba84c991390e4", "url": "https://github.com/triplea-game/triplea/commit/175efd9d8a68258e7c95e8ec240ba84c991390e4", "message": "Simplify battle step generation", "committedDate": "2020-09-14T00:19:56Z", "type": "commit"}, {"oid": "5357e71af342b010b0cea626c8a805e63d432ff1", "url": "https://github.com/triplea-game/triplea/commit/5357e71af342b010b0cea626c8a805e63d432ff1", "message": "Replace getAttacking/DefendingUnits with getUnits(...Side)", "committedDate": "2020-09-14T00:19:56Z", "type": "commit"}, {"oid": "89f84a013feae7d574ef17cbc15a863c473b93c0", "url": "https://github.com/triplea-game/triplea/commit/89f84a013feae7d574ef17cbc15a863c473b93c0", "message": "Replace getAttacking/DefendingWaitingToDie with getWaitingToDie(...Side)", "committedDate": "2020-09-14T00:19:56Z", "type": "commit"}, {"oid": "8ac77a65ddd38ba2d2f54d33cbbe616992959e4c", "url": "https://github.com/triplea-game/triplea/commit/8ac77a65ddd38ba2d2f54d33cbbe616992959e4c", "message": "Replace getOffensive/DefendingAa with getAa(...Side)", "committedDate": "2020-09-14T00:19:56Z", "type": "commit"}, {"oid": "d8b4ad0f9aa5ba293ad2d7d3ada8e5aaccf20384", "url": "https://github.com/triplea-game/triplea/commit/d8b4ad0f9aa5ba293ad2d7d3ada8e5aaccf20384", "message": "BattleSteps no longer implements BattleState", "committedDate": "2020-09-14T01:16:04Z", "type": "commit"}, {"oid": "44f1dce8f7ef266d47fd1e783c9086347edb426b", "url": "https://github.com/triplea-game/triplea/commit/44f1dce8f7ef266d47fd1e783c9086347edb426b", "message": "Add static method to get list of all battle steps", "committedDate": "2020-09-14T01:27:33Z", "type": "commit"}, {"oid": "d6c7b8000bb273875adcdc91bfdac2acdbc80c93", "url": "https://github.com/triplea-game/triplea/commit/d6c7b8000bb273875adcdc91bfdac2acdbc80c93", "message": "Codacy Collection.toArray issue", "committedDate": "2020-09-14T01:50:27Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzYzNjIxMg==", "url": "https://github.com/triplea-game/triplea/pull/7645#discussion_r487636212", "bodyText": "The significance of this comment is not obvious to me. Should this comment be clarified to explain why it's important, or perhaps removed?", "author": "DanVanAtta", "createdAt": "2020-09-14T03:46:51Z", "path": "game-core/src/main/java/games/strategy/triplea/delegate/battle/MustFightBattle.java", "diffHunk": "@@ -1039,49 +1035,60 @@ private void pushFightLoopOnStack() {\n    * It is allowed for an IExecutable to add other IExecutables to the stack. If you read the code\n    * in linear order, ignore wrapping stuff in anonymous IExecutables, then the code can be read as\n    * it will execute. The steps are added to the stack and then reversed at the end.\n-   *\n-   * <p>Save Game Compatibility Note:\n-   *\n-   * <p>Because of saved game compatibility issues, the original steps are left behind as inner\n-   * anonymous classes. The reason for this is that their class name is defined by the order in\n-   * which they are defined. As an example, the first inner anonymous class is MustFightBattle$0 and\n-   * the next one is MustFightBattle$1 and so on. When a saved game is deserialized, it will match\n-   * the step by the class name and so if the order of inner anonymous classes change, it will not\n-   * deserialize. So even though these old steps aren't being added to the steps array, they are\n-   * still needed. They can be safely removed once save compatibility can be broken.\n    */\n   @VisibleForTesting\n   public List<IExecutable> getBattleExecutables() {\n-    final List<IExecutable> steps = new ArrayList<>();\n-    addFightStartSteps(steps);\n-    addFightSteps(steps);\n-    addCheckEndBattleAndRetreatingSteps(steps);\n-    return steps;\n-  }\n-\n-  private void addFightStartSteps(final List<IExecutable> steps) {\n     if (offensiveAa == null) {\n       updateOffensiveAaUnits();\n     }\n     if (defendingAa == null) {\n       updateDefendingAaUnits();\n     }\n-    final List<BattleStep> startSteps =\n+    final List<BattleStep> battleSteps =\n         List.of(\n             new OffensiveAaFire(this, this),\n             new DefensiveAaFire(this, this),\n             new ClearAaCasualties(this, this),\n             new NavalBombardment(this, this),\n             new RemoveNonCombatants(this),\n             new LandParatroopers(this, this),\n-            new MarkNoMovementLeft(this, this));\n-    steps.addAll(\n-        startSteps.stream()\n+            new MarkNoMovementLeft(this, this),\n+            new OffensiveSubsRetreat(this, this),\n+            new DefensiveSubsRetreat(this, this),\n+            new OffensiveFirstStrike(this, this),\n+            new DefensiveFirstStrike(this, this),\n+            new ClearFirstStrikeCasualties(this, this),\n+            new OffensiveGeneral(this, this),\n+            new DefensiveGeneral(this, this),\n+            new RemoveUnprotectedUnits(this, this),\n+            new RemoveFirstStrikeSuicide(this, this),\n+            new SubmergeSubsVsOnlyAirStep(this, this));\n+    final List<IExecutable> steps =\n+        battleSteps.stream()\n             .sorted(Comparator.comparing(BattleStep::getOrder))\n-            .collect(Collectors.toList()));\n+            // *_AFTER_BATTLE order occurs in addCheckEndBattleAndRetreatingSteps()", "originalCommit": "175efd9d8a68258e7c95e8ec240ba84c991390e4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzYzNjYyMw==", "url": "https://github.com/triplea-game/triplea/pull/7645#discussion_r487636623", "bodyText": "There is now an annotation: @RemoveOnNextMajorRelease, perhaps that annotation can take the place of this comment?\nIMO it might make sense to add a \"default\" string to that annotation that we can use as a comment. Hence you could do something like:\n@RemoveOnNextMajorRelease(\"Anonymous inner class can be inlined\")", "author": "DanVanAtta", "createdAt": "2020-09-14T03:48:58Z", "path": "game-core/src/main/java/games/strategy/triplea/delegate/battle/MustFightBattle.java", "diffHunk": "@@ -1039,49 +1035,60 @@ private void pushFightLoopOnStack() {\n    * It is allowed for an IExecutable to add other IExecutables to the stack. If you read the code\n    * in linear order, ignore wrapping stuff in anonymous IExecutables, then the code can be read as\n    * it will execute. The steps are added to the stack and then reversed at the end.\n-   *\n-   * <p>Save Game Compatibility Note:\n-   *\n-   * <p>Because of saved game compatibility issues, the original steps are left behind as inner\n-   * anonymous classes. The reason for this is that their class name is defined by the order in\n-   * which they are defined. As an example, the first inner anonymous class is MustFightBattle$0 and\n-   * the next one is MustFightBattle$1 and so on. When a saved game is deserialized, it will match\n-   * the step by the class name and so if the order of inner anonymous classes change, it will not\n-   * deserialize. So even though these old steps aren't being added to the steps array, they are\n-   * still needed. They can be safely removed once save compatibility can be broken.\n    */\n   @VisibleForTesting\n   public List<IExecutable> getBattleExecutables() {\n-    final List<IExecutable> steps = new ArrayList<>();\n-    addFightStartSteps(steps);\n-    addFightSteps(steps);\n-    addCheckEndBattleAndRetreatingSteps(steps);\n-    return steps;\n-  }\n-\n-  private void addFightStartSteps(final List<IExecutable> steps) {\n     if (offensiveAa == null) {\n       updateOffensiveAaUnits();\n     }\n     if (defendingAa == null) {\n       updateDefendingAaUnits();\n     }\n-    final List<BattleStep> startSteps =\n+    final List<BattleStep> battleSteps =\n         List.of(\n             new OffensiveAaFire(this, this),\n             new DefensiveAaFire(this, this),\n             new ClearAaCasualties(this, this),\n             new NavalBombardment(this, this),\n             new RemoveNonCombatants(this),\n             new LandParatroopers(this, this),\n-            new MarkNoMovementLeft(this, this));\n-    steps.addAll(\n-        startSteps.stream()\n+            new MarkNoMovementLeft(this, this),\n+            new OffensiveSubsRetreat(this, this),\n+            new DefensiveSubsRetreat(this, this),\n+            new OffensiveFirstStrike(this, this),\n+            new DefensiveFirstStrike(this, this),\n+            new ClearFirstStrikeCasualties(this, this),\n+            new OffensiveGeneral(this, this),\n+            new DefensiveGeneral(this, this),\n+            new RemoveUnprotectedUnits(this, this),\n+            new RemoveFirstStrikeSuicide(this, this),\n+            new SubmergeSubsVsOnlyAirStep(this, this));\n+    final List<IExecutable> steps =\n+        battleSteps.stream()\n             .sorted(Comparator.comparing(BattleStep::getOrder))\n-            .collect(Collectors.toList()));\n+            // *_AFTER_BATTLE order occurs in addCheckEndBattleAndRetreatingSteps()\n+            .filter(\n+                step ->\n+                    step.getOrder() != SUB_OFFENSIVE_RETREAT_AFTER_BATTLE\n+                        && step.getOrder() != SUB_DEFENSIVE_RETREAT_AFTER_BATTLE)\n+            .collect(Collectors.toList());\n+\n+    addCheckEndBattleAndRetreatingSteps(steps);\n+    return steps;\n   }\n \n-  // the IExecutables in this block can be deleted when save compatibility can be broken\n+  /*\n+   *\n+   * <p> Save Game Compatibility Note:", "originalCommit": "175efd9d8a68258e7c95e8ec240ba84c991390e4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzYzNjg1Ng==", "url": "https://github.com/triplea-game/triplea/pull/7645#discussion_r487636856", "bodyText": "Ditto on perhaps use @RemoveOnNextMajorRelease with a comment that the value is not used.", "author": "DanVanAtta", "createdAt": "2020-09-14T03:50:04Z", "path": "game-core/src/main/java/games/strategy/triplea/delegate/battle/MustFightBattle.java", "diffHunk": "@@ -1169,6 +1176,125 @@ public void execute(final ExecutionStack stack, final IDelegateBridge bridge) {\n         markNoMovementLeft.execute(stack, bridge);\n       }\n     };\n+    new IExecutable() {\n+      private static final long serialVersionUID = 6775880082912594489L;\n+\n+      @Override\n+      public void execute(final ExecutionStack stack, final IDelegateBridge bridge) {\n+        final BattleStep offensiveSubsRetreat =\n+            new OffensiveSubsRetreat(MustFightBattle.this, MustFightBattle.this);\n+        if (offensiveSubsRetreat.getOrder() == SUB_OFFENSIVE_RETREAT_BEFORE_BATTLE) {\n+          offensiveSubsRetreat.execute(stack, bridge);\n+        }\n+      }\n+    };\n+    new IExecutable() {\n+      private static final long serialVersionUID = 7056448091800764539L;\n+\n+      @Override\n+      public void execute(final ExecutionStack stack, final IDelegateBridge bridge) {\n+        final BattleStep defensiveSubsRetreat =\n+            new DefensiveSubsRetreat(MustFightBattle.this, MustFightBattle.this);\n+        if (defensiveSubsRetreat.getOrder() == SUB_DEFENSIVE_RETREAT_BEFORE_BATTLE) {\n+          defensiveSubsRetreat.execute(stack, bridge);\n+        }\n+      }\n+    };\n+    new IExecutable() {\n+      private static final long serialVersionUID = 99989L;\n+\n+      @Override\n+      public void execute(final ExecutionStack stack, final IDelegateBridge bridge) {\n+        new RemoveUnprotectedUnits(MustFightBattle.this, MustFightBattle.this)\n+            .execute(stack, bridge);\n+      }\n+    };\n+    new IExecutable() {\n+      private static final long serialVersionUID = 99990L;\n+\n+      @Override\n+      public void execute(final ExecutionStack stack, final IDelegateBridge bridge) {\n+        final BattleStep submergeSubsVsOnlyAir =\n+            new SubmergeSubsVsOnlyAirStep(MustFightBattle.this, MustFightBattle.this);\n+        submergeSubsVsOnlyAir.execute(stack, bridge);\n+      }\n+    };\n+    new IExecutable() {\n+      private static final long serialVersionUID = 99992L;\n+\n+      @Override\n+      public void execute(final ExecutionStack stack, final IDelegateBridge bridge) {\n+        new DefensiveFirstStrike(MustFightBattle.this, MustFightBattle.this, ReturnFire.NONE)\n+            .execute(stack, bridge);\n+      }\n+    };\n+    // these two variables are needed for save compatibility\n+    // the value of the variables aren't important now, but they must\n+    // be defined in the same scope as the IExecutables so that when\n+    // the save is loaded, it will correctly populate the saved value\n+    // of these variables.\n+    final ReturnFire returnFireAgainstAttackingSubs = ReturnFire.ALL;", "originalCommit": "175efd9d8a68258e7c95e8ec240ba84c991390e4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzYzNzAwNA==", "url": "https://github.com/triplea-game/triplea/pull/7645#discussion_r487637004", "bodyText": "\ud83d\udc4d", "author": "DanVanAtta", "createdAt": "2020-09-14T03:50:46Z", "path": "game-core/src/main/java/games/strategy/triplea/delegate/battle/BattleState.java", "diffHunk": "@@ -28,13 +27,9 @@ public Side getOpposite() {\n \n   Collection<Unit> getUnits(Side... sides);\n \n-  Collection<Unit> getAttackingWaitingToDie();\n+  Collection<Unit> getWaitingToDie(Side... sides);", "originalCommit": "89f84a013feae7d574ef17cbc15a863c473b93c0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzYzNzM0Nw==", "url": "https://github.com/triplea-game/triplea/pull/7645#discussion_r487637347", "bodyText": "One would hope that battle state would take care of its own state, notably it would know when units should be cleared. This kind of API hints that this is more of a value object (or even a parameter) object, in which case having an interface at all is a bit overkill. No recommendation here, just noting the code smell here, that perhaps more logic needs to be moved into the class or it needs to have a pivot such that it's broken up and functionality injected into an imperative shell type of class.", "author": "DanVanAtta", "createdAt": "2020-09-14T03:52:33Z", "path": "game-core/src/main/java/games/strategy/triplea/delegate/battle/BattleState.java", "diffHunk": "@@ -28,13 +27,9 @@ public Side getOpposite() {\n \n   Collection<Unit> getUnits(Side... sides);\n \n-  Collection<Unit> getAttackingWaitingToDie();\n+  Collection<Unit> getWaitingToDie(Side... sides);\n \n-  Collection<Unit> getDefendingWaitingToDie();\n-\n-  Collection<Unit> getWaitingToDie(EnumSet<Side> sides);\n-\n-  void clearWaitingToDie(EnumSet<Side> sides);\n+  void clearWaitingToDie(Side... sides);", "originalCommit": "89f84a013feae7d574ef17cbc15a863c473b93c0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Nzk1MTQ2NA==", "url": "https://github.com/triplea-game/triplea/pull/7645#discussion_r487951464", "bodyText": "I'm leaning more towards battle state being a value object.  The battle steps will know the logic of how to manage the battle state.  The interface is just there to help define what the BattleState needs separately from MustFightBattle.\nBut, that might change once I've started breaking up the battleActions.", "author": "trevan", "createdAt": "2020-09-14T14:06:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzYzNzM0Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzYzNzY0Mg==", "url": "https://github.com/triplea-game/triplea/pull/7645#discussion_r487637642", "bodyText": "nice \ud83d\ude01", "author": "DanVanAtta", "createdAt": "2020-09-14T03:54:02Z", "path": "game-core/src/main/java/games/strategy/triplea/delegate/battle/steps/BattleStep.java", "diffHunk": "@@ -50,4 +71,27 @@\n \n   /** @return The order in which this step should be called */\n   Order getOrder();\n+\n+  static List<BattleStep> getAll(final BattleState battleState, final BattleActions battleActions) {", "originalCommit": "44f1dce8f7ef266d47fd1e783c9086347edb426b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}