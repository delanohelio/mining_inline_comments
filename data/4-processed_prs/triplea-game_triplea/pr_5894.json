{"pr_number": 5894, "pr_title": "Infra auto cert", "pr_createdAt": "2020-02-01T08:19:58Z", "pr_url": "https://github.com/triplea-game/triplea/pull/5894", "timeline": [{"oid": "ff42b6298bd260ae0dc2f26704470b1fd332df84", "url": "https://github.com/triplea-game/triplea/commit/ff42b6298bd260ae0dc2f26704470b1fd332df84", "message": "Ansible: Automate letsencrypt cert generation", "committedDate": "2020-02-01T08:11:05Z", "type": "commit"}, {"oid": "7972db8b0fea8ef09526ecc641484f063d702595", "url": "https://github.com/triplea-game/triplea/commit/7972db8b0fea8ef09526ecc641484f063d702595", "message": "Ansible: restart nginx only if config changed", "committedDate": "2020-02-01T08:11:09Z", "type": "commit"}, {"oid": "d096c78fea931a362011cb758059f8b8e2bb030a", "url": "https://github.com/triplea-game/triplea/commit/d096c78fea931a362011cb758059f8b8e2bb030a", "message": "Ansible: add certbot certificate renewal cronjob", "committedDate": "2020-02-01T08:11:09Z", "type": "commit"}, {"oid": "ed972c8ac6b618d134dd2275c7e19057b2c0eb8b", "url": "https://github.com/triplea-game/triplea/commit/ed972c8ac6b618d134dd2275c7e19057b2c0eb8b", "message": "Update infrastructure/README notes\n\n- fix up example commands\n- simplify and update https cert installation notes", "committedDate": "2020-02-01T08:11:09Z", "type": "commit"}, {"oid": "ee441ffa825e109b1eee96ca95051291c9003e85", "url": "https://github.com/triplea-game/triplea/commit/ee441ffa825e109b1eee96ca95051291c9003e85", "message": "Ansible: Update site.yml deployment playbook to deploy certbot to only prod and prerelease", "committedDate": "2020-02-01T08:11:09Z", "type": "commit"}, {"oid": "7113b2978be63786e3bd24b8d6655d49998cf42f", "url": "https://github.com/triplea-game/triplea/commit/7113b2978be63786e3bd24b8d6655d49998cf42f", "message": "Ansible: Run certbot only when needed and fix nginx configuration drift problem", "committedDate": "2020-02-01T08:11:09Z", "type": "commit"}, {"oid": "78d30e0991ac2b2233c5b41063a2f68cf475323a", "url": "https://github.com/triplea-game/triplea/commit/78d30e0991ac2b2233c5b41063a2f68cf475323a", "message": "Ansible: Fix http_server port variable defined in that role but used in a different role", "committedDate": "2020-02-01T08:11:09Z", "type": "commit"}, {"oid": "316c4206a042ab903c8afee00e832e5ee39aa368", "url": "https://github.com/triplea-game/triplea/commit/316c4206a042ab903c8afee00e832e5ee39aa368", "message": "Ansible: Restart nginx if new cert keys are deployed", "committedDate": "2020-02-01T08:11:09Z", "type": "commit"}, {"oid": "e07d510b7b78fcd637c7a28be64565579b829c9d", "url": "https://github.com/triplea-game/triplea/commit/e07d510b7b78fcd637c7a28be64565579b829c9d", "message": "Ansible: Remove commented out properties", "committedDate": "2020-02-01T08:13:31Z", "type": "commit"}, {"oid": "6795b0daac398019e2e1705258b8c1e3b3f3adf5", "url": "https://github.com/triplea-game/triplea/commit/6795b0daac398019e2e1705258b8c1e3b3f3adf5", "message": "Simplify letsEncrypt hostgroup config", "committedDate": "2020-02-01T08:16:08Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mzc2NjMyOQ==", "url": "https://github.com/triplea-game/triplea/pull/5894#discussion_r373766329", "bodyText": "Headers should be surrounded by blank lines", "author": "codeclimate", "createdAt": "2020-02-01T08:21:30Z", "path": "infrastructure/README.md", "diffHunk": "@@ -80,19 +80,22 @@ examples\n \n # To see 'diff' output, which shows how each file on server is being updated\n #  (caution!! this can expose secret values to stdout)\n-./run_deployment 2.0.1000 -d -i ansible/inventory/prerelease\n+./run_deployment 2.0.1000 --diff -i ansible/inventory/prerelease\n \n # To see SSL debug output:\n+./run_deployment 2.0.1000 -vvvv -i ansible/inventory/prerelease\n+\n+# To see debug output from each command:", "originalCommit": "6795b0daac398019e2e1705258b8c1e3b3f3adf5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mzc2NjMzMA==", "url": "https://github.com/triplea-game/triplea/pull/5894#discussion_r373766330", "bodyText": "Multiple top level headers in the same document", "author": "codeclimate", "createdAt": "2020-02-01T08:21:30Z", "path": "infrastructure/README.md", "diffHunk": "@@ -80,19 +80,22 @@ examples\n \n # To see 'diff' output, which shows how each file on server is being updated\n #  (caution!! this can expose secret values to stdout)\n-./run_deployment 2.0.1000 -d -i ansible/inventory/prerelease\n+./run_deployment 2.0.1000 --diff -i ansible/inventory/prerelease\n \n # To see SSL debug output:\n+./run_deployment 2.0.1000 -vvvv -i ansible/inventory/prerelease\n+\n+# To see debug output from each command:", "originalCommit": "6795b0daac398019e2e1705258b8c1e3b3f3adf5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mzc2NjMzMQ==", "url": "https://github.com/triplea-game/triplea/pull/5894#discussion_r373766331", "bodyText": "Trailing punctuation in header", "author": "codeclimate", "createdAt": "2020-02-01T08:21:30Z", "path": "infrastructure/README.md", "diffHunk": "@@ -80,19 +80,22 @@ examples\n \n # To see 'diff' output, which shows how each file on server is being updated\n #  (caution!! this can expose secret values to stdout)\n-./run_deployment 2.0.1000 -d -i ansible/inventory/prerelease\n+./run_deployment 2.0.1000 --diff -i ansible/inventory/prerelease\n \n # To see SSL debug output:\n+./run_deployment 2.0.1000 -vvvv -i ansible/inventory/prerelease\n+\n+# To see debug output from each command:", "originalCommit": "6795b0daac398019e2e1705258b8c1e3b3f3adf5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "651f04a9a496c701b317f7808a435a5534dcdf87", "url": "https://github.com/triplea-game/triplea/commit/651f04a9a496c701b317f7808a435a5534dcdf87", "message": "Restructure examples in MD file", "committedDate": "2020-02-01T19:27:44Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mzc5NzUzNA==", "url": "https://github.com/triplea-game/triplea/pull/5894#discussion_r373797534", "bodyText": "Inconsistent indentation for list items at the same level", "author": "codeclimate", "createdAt": "2020-02-01T19:29:59Z", "path": "infrastructure/README.md", "diffHunk": "@@ -67,32 +67,46 @@ defined in the prerelease inventory file.\n Assuming a vault password file named 'vault_password' is created in the same\n folder and contains the ansible vault password, run: \n \n-``bash\n+```bash\n ./run_deployment [version_to_install] [ansible_args]\n ```\n \n examples\n+\n+\n+### Typical Deployment Command\n ```bash\n ./run_deployment 2.0.1000 -i ansible/inventory/prerelease\n+```\n+\n+### Useful flags\n+  * -v: Verbose output", "originalCommit": "651f04a9a496c701b317f7808a435a5534dcdf87", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mzc5NzUzNQ==", "url": "https://github.com/triplea-game/triplea/pull/5894#discussion_r373797535", "bodyText": "Inconsistent indentation for list items at the same level", "author": "codeclimate", "createdAt": "2020-02-01T19:29:59Z", "path": "infrastructure/README.md", "diffHunk": "@@ -67,32 +67,46 @@ defined in the prerelease inventory file.\n Assuming a vault password file named 'vault_password' is created in the same\n folder and contains the ansible vault password, run: \n \n-``bash\n+```bash\n ./run_deployment [version_to_install] [ansible_args]\n ```\n \n examples\n+\n+\n+### Typical Deployment Command\n ```bash\n ./run_deployment 2.0.1000 -i ansible/inventory/prerelease\n+```\n+\n+### Useful flags\n+  * -v: Verbose output\n+  * -vvv: Debug output", "originalCommit": "651f04a9a496c701b317f7808a435a5534dcdf87", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mzc5NzUzNg==", "url": "https://github.com/triplea-game/triplea/pull/5894#discussion_r373797536", "bodyText": "Inconsistent indentation for list items at the same level", "author": "codeclimate", "createdAt": "2020-02-01T19:29:59Z", "path": "infrastructure/README.md", "diffHunk": "@@ -67,32 +67,46 @@ defined in the prerelease inventory file.\n Assuming a vault password file named 'vault_password' is created in the same\n folder and contains the ansible vault password, run: \n \n-``bash\n+```bash\n ./run_deployment [version_to_install] [ansible_args]\n ```\n \n examples\n+\n+\n+### Typical Deployment Command\n ```bash\n ./run_deployment 2.0.1000 -i ansible/inventory/prerelease\n+```\n+\n+### Useful flags\n+  * -v: Verbose output\n+  * -vvv: Debug output\n+  * -vvvv: SSL Debug output", "originalCommit": "651f04a9a496c701b317f7808a435a5534dcdf87", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mzc5NzUzOA==", "url": "https://github.com/triplea-game/triplea/pull/5894#discussion_r373797538", "bodyText": "Inconsistent indentation for list items at the same level", "author": "codeclimate", "createdAt": "2020-02-01T19:30:00Z", "path": "infrastructure/README.md", "diffHunk": "@@ -67,32 +67,46 @@ defined in the prerelease inventory file.\n Assuming a vault password file named 'vault_password' is created in the same\n folder and contains the ansible vault password, run: \n \n-``bash\n+```bash\n ./run_deployment [version_to_install] [ansible_args]\n ```\n \n examples\n+\n+\n+### Typical Deployment Command\n ```bash\n ./run_deployment 2.0.1000 -i ansible/inventory/prerelease\n+```\n+\n+### Useful flags\n+  * -v: Verbose output\n+  * -vvv: Debug output\n+  * -vvvv: SSL Debug output\n+  * --diff: Shows differences in updated templates and files", "originalCommit": "651f04a9a496c701b317f7808a435a5534dcdf87", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mzc5NzUzOQ==", "url": "https://github.com/triplea-game/triplea/pull/5894#discussion_r373797539", "bodyText": "Inconsistent indentation for list items at the same level", "author": "codeclimate", "createdAt": "2020-02-01T19:30:00Z", "path": "infrastructure/README.md", "diffHunk": "@@ -67,32 +67,46 @@ defined in the prerelease inventory file.\n Assuming a vault password file named 'vault_password' is created in the same\n folder and contains the ansible vault password, run: \n \n-``bash\n+```bash\n ./run_deployment [version_to_install] [ansible_args]\n ```\n \n examples\n+\n+\n+### Typical Deployment Command\n ```bash\n ./run_deployment 2.0.1000 -i ansible/inventory/prerelease\n+```\n+\n+### Useful flags\n+  * -v: Verbose output\n+  * -vvv: Debug output\n+  * -vvvv: SSL Debug output\n+  * --diff: Shows differences in updated templates and files\n+  * -t : Tags", "originalCommit": "651f04a9a496c701b317f7808a435a5534dcdf87", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mzc5NzU0MA==", "url": "https://github.com/triplea-game/triplea/pull/5894#discussion_r373797540", "bodyText": "Consider starting bulleted lists at the beginning of the line", "author": "codeclimate", "createdAt": "2020-02-01T19:30:00Z", "path": "infrastructure/README.md", "diffHunk": "@@ -67,32 +67,46 @@ defined in the prerelease inventory file.\n Assuming a vault password file named 'vault_password' is created in the same\n folder and contains the ansible vault password, run: \n \n-``bash\n+```bash\n ./run_deployment [version_to_install] [ansible_args]\n ```\n \n examples\n+\n+\n+### Typical Deployment Command\n ```bash\n ./run_deployment 2.0.1000 -i ansible/inventory/prerelease\n+```\n+\n+### Useful flags\n+  * -v: Verbose output", "originalCommit": "651f04a9a496c701b317f7808a435a5534dcdf87", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mzc5NzU0MQ==", "url": "https://github.com/triplea-game/triplea/pull/5894#discussion_r373797541", "bodyText": "Trailing spaces", "author": "codeclimate", "createdAt": "2020-02-01T19:30:00Z", "path": "infrastructure/README.md", "diffHunk": "@@ -67,32 +67,46 @@ defined in the prerelease inventory file.\n Assuming a vault password file named 'vault_password' is created in the same\n folder and contains the ansible vault password, run: \n \n-``bash\n+```bash\n ./run_deployment [version_to_install] [ansible_args]\n ```\n \n examples\n+\n+\n+### Typical Deployment Command\n ```bash\n ./run_deployment 2.0.1000 -i ansible/inventory/prerelease\n+```\n+\n+### Useful flags\n+  * -v: Verbose output\n+  * -vvv: Debug output\n+  * -vvvv: SSL Debug output\n+  * --diff: Shows differences in updated templates and files\n+  * -t : Tags\n \n-# To see verbose output\n-./run_deployment 2.0.1000 -v -i ansible/inventory/prerelease\n+### Examples with Tags\n \n-# To see 'diff' output, which shows how each file on server is being updated\n-#  (caution!! this can expose secret values to stdout)\n-./run_deployment 2.0.1000 -d -i ansible/inventory/prerelease\n \n-# To see SSL debug output:\n-./run_deployment 2.0.1000 -vvv -i ansible/inventory/prerelease\n+#### Deploy just bots\n \n-# To deploy to just bots, use tags, '-t' (see playbook for tag names)\n-./run_deployment 2.0.1000 -vvv -t bots -i ansible/inventory/prerelease\n+```bash\n+./run_deployment 2.0.1000 -t bots -i ansible/inventory/prerelease\n+```\n+\n+#### Deploy NGINX and CertBot\n+```bash\n+./run_deployment 2.0.1000 -t nginx,certbot -i ansible/inventory/prerelease\n ```\n \n+\n+## Example Prod Deployment\n+ ", "originalCommit": "651f04a9a496c701b317f7808a435a5534dcdf87", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mzc5NzU0Mg==", "url": "https://github.com/triplea-game/triplea/pull/5894#discussion_r373797542", "bodyText": "Headers should be surrounded by blank lines", "author": "codeclimate", "createdAt": "2020-02-01T19:30:00Z", "path": "infrastructure/README.md", "diffHunk": "@@ -67,32 +67,46 @@ defined in the prerelease inventory file.\n Assuming a vault password file named 'vault_password' is created in the same\n folder and contains the ansible vault password, run: \n \n-``bash\n+```bash\n ./run_deployment [version_to_install] [ansible_args]\n ```\n \n examples\n+\n+\n+### Typical Deployment Command", "originalCommit": "651f04a9a496c701b317f7808a435a5534dcdf87", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mzc5NzU0Mw==", "url": "https://github.com/triplea-game/triplea/pull/5894#discussion_r373797543", "bodyText": "Headers should be surrounded by blank lines", "author": "codeclimate", "createdAt": "2020-02-01T19:30:01Z", "path": "infrastructure/README.md", "diffHunk": "@@ -67,32 +67,46 @@ defined in the prerelease inventory file.\n Assuming a vault password file named 'vault_password' is created in the same\n folder and contains the ansible vault password, run: \n \n-``bash\n+```bash\n ./run_deployment [version_to_install] [ansible_args]\n ```\n \n examples\n+\n+\n+### Typical Deployment Command\n ```bash\n ./run_deployment 2.0.1000 -i ansible/inventory/prerelease\n+```\n+\n+### Useful flags", "originalCommit": "651f04a9a496c701b317f7808a435a5534dcdf87", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mzc5NzU0NA==", "url": "https://github.com/triplea-game/triplea/pull/5894#discussion_r373797544", "bodyText": "Headers should be surrounded by blank lines", "author": "codeclimate", "createdAt": "2020-02-01T19:30:01Z", "path": "infrastructure/README.md", "diffHunk": "@@ -67,32 +67,46 @@ defined in the prerelease inventory file.\n Assuming a vault password file named 'vault_password' is created in the same\n folder and contains the ansible vault password, run: \n \n-``bash\n+```bash\n ./run_deployment [version_to_install] [ansible_args]\n ```\n \n examples\n+\n+\n+### Typical Deployment Command\n ```bash\n ./run_deployment 2.0.1000 -i ansible/inventory/prerelease\n+```\n+\n+### Useful flags\n+  * -v: Verbose output\n+  * -vvv: Debug output\n+  * -vvvv: SSL Debug output\n+  * --diff: Shows differences in updated templates and files\n+  * -t : Tags\n \n-# To see verbose output\n-./run_deployment 2.0.1000 -v -i ansible/inventory/prerelease\n+### Examples with Tags\n \n-# To see 'diff' output, which shows how each file on server is being updated\n-#  (caution!! this can expose secret values to stdout)\n-./run_deployment 2.0.1000 -d -i ansible/inventory/prerelease\n \n-# To see SSL debug output:\n-./run_deployment 2.0.1000 -vvv -i ansible/inventory/prerelease\n+#### Deploy just bots\n \n-# To deploy to just bots, use tags, '-t' (see playbook for tag names)\n-./run_deployment 2.0.1000 -vvv -t bots -i ansible/inventory/prerelease\n+```bash\n+./run_deployment 2.0.1000 -t bots -i ansible/inventory/prerelease\n+```\n+\n+#### Deploy NGINX and CertBot", "originalCommit": "651f04a9a496c701b317f7808a435a5534dcdf87", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mzc5NzU0NQ==", "url": "https://github.com/triplea-game/triplea/pull/5894#discussion_r373797545", "bodyText": "Headers should be surrounded by blank lines", "author": "codeclimate", "createdAt": "2020-02-01T19:30:01Z", "path": "infrastructure/README.md", "diffHunk": "@@ -67,32 +67,46 @@ defined in the prerelease inventory file.\n Assuming a vault password file named 'vault_password' is created in the same\n folder and contains the ansible vault password, run: \n \n-``bash\n+```bash\n ./run_deployment [version_to_install] [ansible_args]\n ```\n \n examples\n+\n+\n+### Typical Deployment Command\n ```bash\n ./run_deployment 2.0.1000 -i ansible/inventory/prerelease\n+```\n+\n+### Useful flags\n+  * -v: Verbose output\n+  * -vvv: Debug output\n+  * -vvvv: SSL Debug output\n+  * --diff: Shows differences in updated templates and files\n+  * -t : Tags\n \n-# To see verbose output\n-./run_deployment 2.0.1000 -v -i ansible/inventory/prerelease\n+### Examples with Tags\n \n-# To see 'diff' output, which shows how each file on server is being updated\n-#  (caution!! this can expose secret values to stdout)\n-./run_deployment 2.0.1000 -d -i ansible/inventory/prerelease\n \n-# To see SSL debug output:\n-./run_deployment 2.0.1000 -vvv -i ansible/inventory/prerelease\n+#### Deploy just bots\n \n-# To deploy to just bots, use tags, '-t' (see playbook for tag names)\n-./run_deployment 2.0.1000 -vvv -t bots -i ansible/inventory/prerelease\n+```bash\n+./run_deployment 2.0.1000 -t bots -i ansible/inventory/prerelease\n+```\n+\n+#### Deploy NGINX and CertBot\n+```bash\n+./run_deployment 2.0.1000 -t nginx,certbot -i ansible/inventory/prerelease\n ```\n \n+\n+## Example Prod Deployment", "originalCommit": "651f04a9a496c701b317f7808a435a5534dcdf87", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mzc5NzU0Ng==", "url": "https://github.com/triplea-game/triplea/pull/5894#discussion_r373797546", "bodyText": "Lists should be surrounded by blank lines", "author": "codeclimate", "createdAt": "2020-02-01T19:30:01Z", "path": "infrastructure/README.md", "diffHunk": "@@ -67,32 +67,46 @@ defined in the prerelease inventory file.\n Assuming a vault password file named 'vault_password' is created in the same\n folder and contains the ansible vault password, run: \n \n-``bash\n+```bash\n ./run_deployment [version_to_install] [ansible_args]\n ```\n \n examples\n+\n+\n+### Typical Deployment Command\n ```bash\n ./run_deployment 2.0.1000 -i ansible/inventory/prerelease\n+```\n+\n+### Useful flags\n+  * -v: Verbose output", "originalCommit": "651f04a9a496c701b317f7808a435a5534dcdf87", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mzc5NzU0Nw==", "url": "https://github.com/triplea-game/triplea/pull/5894#discussion_r373797547", "bodyText": "Lists should be surrounded by blank lines", "author": "codeclimate", "createdAt": "2020-02-01T19:30:02Z", "path": "infrastructure/README.md", "diffHunk": "@@ -165,47 +179,13 @@ ansible-vault encrypt --vault-password-file=vault_password ansible_ssh_key.ed255\n \n # Https Certificate Installation\n \n-Currently done manually.\n-\n-## certbot from letsencrypt\n+The 'certbot' role will:\n+  - run lets-encrypt and create a publicly signed SSL cert.", "originalCommit": "651f04a9a496c701b317f7808a435a5534dcdf87", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mzc5MDM3Mg==", "url": "https://github.com/triplea-game/triplea/pull/5894#discussion_r373790372", "bodyText": "Technically that's not 100% required, but it definitely should be created", "author": "RoiEXLab", "createdAt": "2020-02-01T17:08:27Z", "path": "infrastructure/README.md", "diffHunk": "@@ -165,47 +168,13 @@ ansible-vault encrypt --vault-password-file=vault_password ansible_ssh_key.ed255\n \n # Https Certificate Installation\n \n-Currently done manually.\n-\n-## certbot from letsencrypt\n-\n-```bash\n-sudo apt-get update\n-sudo apt-get install software-properties-common\n-sudo add-apt-repository universe\n-sudo add-apt-repository ppa:certbot/certbot\n-sudo apt-get update\n-sudo apt-get install certbot python-certbot-nginx \n-\n-sudo certbot --nginx -m tripleabuilderbot@gmail.com --agree-tos\n-```\n+The 'certbot' role will:\n+  - run lets-encrypt and create a publicly signed SSL cert.\n+  - sets up a weekly renewal cronjob that will renew the SSL cert if it\n+    is within 30 days of expiry\n \n-Create CAA DNS records\n+For each domain running SSH, a CAA DNS record needs to be created (one time):", "originalCommit": "6795b0daac398019e2e1705258b8c1e3b3f3adf5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzgwNzU2MQ==", "url": "https://github.com/triplea-game/triplea/pull/5894#discussion_r373807561", "bodyText": "Thoughts about the wording here?", "author": "RoiEXLab", "createdAt": "2020-02-01T23:08:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mzc5MDM3Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzgwNzg5Ng==", "url": "https://github.com/triplea-game/triplea/pull/5894#discussion_r373807896", "bodyText": "Certainly getting into semantics \ud83d\ude01\nI think explaining that we should but don't have to create such an entry will be too much. Terse, concise instructions that do not require decision making are valuable. We could add a link for background information potentially.\nHence for 'semantics', the 'need' is untrue as it's not required, but if we consider our security requirements to \"need\" such a cert for the improved security, then \"need\" is correct from that perspective.\nSo while not strictly needed, per the security standards we would expect, it is needed and should be done.", "author": "DanVanAtta", "createdAt": "2020-02-01T23:16:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mzc5MDM3Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mzc5MDUzMg==", "url": "https://github.com/triplea-game/triplea/pull/5894#discussion_r373790532", "bodyText": "Please correct me if I'm missing something obvious here, but the certbot utility should create a cronjob automatically, so there's no need to define that ourselves", "author": "RoiEXLab", "createdAt": "2020-02-01T17:11:02Z", "path": "infrastructure/ansible/roles/certbot/tasks/main.yml", "diffHunk": "@@ -0,0 +1,43 @@\n+- name: install software properties common\n+  become: true\n+  apt:\n+    state: present\n+    name: software-properties-common\n+  \n+- name: install certbot apt-repositories\n+  become: true\n+  apt_repository:\n+    state: present\n+    repo: \"{{ item }}\"\n+  loop:\n+    - \"deb http://archive.ubuntu.com/ubuntu/ bionic universe\"\n+    - \"deb http://archive.ubuntu.com/ubuntu/ bionic-updates universe\"\n+    - \"deb http://security.ubuntu.com/ubuntu/ bionic-security universe\"\n+    - \"ppa:certbot/certbot\"\n+\n+- name: install certbot and python for certbot on nginx\n+  become: true\n+  apt:\n+    update_cache: yes\n+    name:\n+      - certbot\n+      - python-certbot-nginx\n+\n+- name: look for certbot generated key file\n+  become: true\n+  stat:\n+    path: /etc/letsencrypt/live/prerelease.triplea-game.org/cert.pem\n+  register: has_certbot_pem\n+\n+- name: run certbot\n+  become: true\n+  command: \"certbot --nginx -n -m tripleabuilderbot@gmail.com --agree-tos -d {{ inventory_hostname }}\"\n+  when: has_certbot_pem.stat.exists == false\n+\n+- name: Add letsencrypt cronjob for cert renewal\n+  become: true\n+  cron:\n+    name: letsencrypt_renewal\n+    special_time: weekly\n+    job: certbot renew", "originalCommit": "6795b0daac398019e2e1705258b8c1e3b3f3adf5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzgwMDQwNA==", "url": "https://github.com/triplea-game/triplea/pull/5894#discussion_r373800404", "bodyText": "It raises a lot of questions if does:\n\nhow does it know what kind of cron to use\nhow does it know you actually want to auto-renew\nif the job does renew, why does the cert creation not mention it and also give instructions on how to renew\n\nI'll see if I can verify if it does.", "author": "DanVanAtta", "createdAt": "2020-02-01T20:24:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mzc5MDUzMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzgwMTQxNw==", "url": "https://github.com/triplea-game/triplea/pull/5894#discussion_r373801417", "bodyText": "how does it know what kind of cron to use\n\nGood question, can't answer that but there probably are some checks in place to get the correct one.", "author": "RoiEXLab", "createdAt": "2020-02-01T20:44:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mzc5MDUzMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzgwMTYyNA==", "url": "https://github.com/triplea-game/triplea/pull/5894#discussion_r373801624", "bodyText": "how does it know you actually want to auto-renew\n\nThis is the default behaviour (the certificates are only valid for 90 days, so unless you only need TLS for less than 90 days you probably want to renew it eventually), but I think there's an option to disable it\n\nif the job does renew, why does the cert creation not mention\n\nHard to answer. I assume that the \"bot\" in certbot somewhat implies thae automation. Note that cerbot is not directly linked to letsencrypt. It's a separate utility that \"just happens\" to be created at the same time as letsencrypt and the ACME protocol and uses letsencrypt as its default CA, but it works with any other CA that supports the ACME protocol as well. So you can get a letsencrypt certificate without this utility.\n\nand also give instructions on how to renew\n\nWell I mean renewing just applies the initial configuration again, that's what certbot renew does, just within a cronjob", "author": "RoiEXLab", "createdAt": "2020-02-01T20:49:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mzc5MDUzMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mzc5NjE1NQ==", "url": "https://github.com/triplea-game/triplea/pull/5894#discussion_r373796155", "bodyText": "Doesn't the statement above already ensure the service is restarted? So IIRC this also verifies that the service is started if it wasn't before.", "author": "RoiEXLab", "createdAt": "2020-02-01T19:01:22Z", "path": "infrastructure/ansible/roles/nginx/tasks/main.yml", "diffHunk": "@@ -4,52 +4,108 @@\n     name: nginx\n     state: present\n \n+\n - name: generate dhparam.pem\n   become: true\n   shell:\n-    cmd: openssl dhparam -out {{ nginx_ssl_dhparams }} 4096\n-    creates: \"{{ nginx_ssl_dhparams }}\"\n+    cmd: openssl dhparam -out {{ dhparams_pem_file }} 4096\n+    creates: \"{{ dhparams_pem_file }}\"\n \n - name: set permissions of dhparam.pem\n   become: true\n   file:\n-    dest: \"{{ nginx_ssl_dhparams }}\"\n+    dest: \"{{ dhparams_pem_file }}\"\n     mode: 600\n \n-- name: check for nginx cert key\n+\n+- name: check for SSL cert key\n   stat:\n-    path: \"{{ nginx_ssl_certificate_key }}\"\n-  register: cert_key\n+    path: \"{{ ssl_cert_key }}\"\n+  register: has_cert_key\n   changed_when: false\n-\n-- name: check for nginx certificate\n+ \n+- name: check for SSL cert\n   stat:\n-    path: \"{{ nginx_ssl_certificate }}\"\n-  register: cert\n+    path: \"{{ ssl_cert }}\"\n+  register: has_cert\n   changed_when: false\n \n - name: create SSL keys if needed\n   become: true\n-  when: (cert_key.stat.exists == false) or (cert.stat.exists == false)\n-  command: openssl req -x509 -nodes -days 365 -newkey rsa:4096 -keyout {{ nginx_ssl_certificate_key }} -out {{ nginx_ssl_certificate }} -batch -subj '/CN=localhost' -sha256 -addext \"subjectAltName = IP:127.0.0.1, IP:::1\"\n+  when: (has_cert_key.stat.exists == false) or (has_cert.stat.exists == false)\n+  command: |\n+       openssl req -x509 -nodes -days 365 \\\n+          -newkey rsa:4096 -keyout {{ ssl_cert_key }} -out {{ ssl_cert }} \\\n+          -batch -subj '/CN=localhost' -sha256 -addext \"subjectAltName = IP:127.0.0.1, IP:::1\"\n+\n+\n+- name: check for letsencrypt cert key\n+  stat:\n+    path: \"{{ lets_encrypt_cert_key }}\"\n+  register: has_lets_encrypt_cert_key\n+  changed_when: false\n+\n+- name: set cert-key variable to generated cert if letsencrypt cert key DNE\n+  when: has_lets_encrypt_cert_key.stat.exists == false\n+  set_fact:\n+    cert_key: \"{{ ssl_cert_key }};\"\n+  changed_when: false\n+\n+- name: set cert-key variable to lets_encrypt cert-key if exists\n+  when: has_lets_encrypt_cert_key.stat.exists\n+  set_fact:\n+    cert_key: \"{{ lets_encrypt_cert_key }}; # managed by Certbot;\"\n+  changed_when: false\n+\n+\n+- name: check for lets_encrypt cert\n+  stat:\n+    path: \"{{ lets_encrypt_cert }}\"\n+  register: has_lets_encrypt_cert\n+  changed_when: false\n+  \n+- name: set cert variable to generated cert if lets_encrypt cert DNE\n+  when: has_lets_encrypt_cert.stat.exists == false\n+  set_fact:\n+    cert: \"{{ ssl_cert }};\"\n+  changed_when: false\n+\n+- name: set cert variable to lets_encrypt cert if exists\n+  when: has_lets_encrypt_cert.stat.exists\n+  set_fact:\n+    cert: \"{{ lets_encrypt_cert }}; # managed by Certbot;\"\n+  changed_when: false\n+\n \n - name: deploy nginx sites_enabled configuation\n   become: true\n   template:\n     src: etc_nginx_sites_enabled_default.j2\n     dest: /etc/nginx/sites-enabled/default\n+  register: nginx_config_changed\n \n - name: allow ports\n   become: true\n+  tags: firewall\n   ufw:\n     rule: allow\n     port: \"{{ item }}\"\n     proto: tcp\n   with_items: \"{{ nginx_allowed_ports }}\"\n \n-- name: relaunch nginx\n+- name: restart nginx if config changed\n+  when: |\n+    (nginx_config_changed.changed) \n+      or (has_cert_key.stat.exists == false) \n+      or (has_cert.stat.exists == false)\n   become: true\n   systemd:\n     name: nginx\n     state: restarted\n \n+- name: ensure nginx is started\n+  become: true\n+  systemd:\n+    name: nginx\n+    state: started", "originalCommit": "6795b0daac398019e2e1705258b8c1e3b3f3adf5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzgwMDUwNA==", "url": "https://github.com/triplea-game/triplea/pull/5894#discussion_r373800504", "bodyText": "Note that the 'restart' now has a when clause on it for only when something has changed in configuration. That was extremely important otherwise on every build we would have disconnected all users when nginx restarted.\nThis 'started' command has no when clause. This will ensure the service is in a started state. This is really here to 'ensure' an expected state that nginx is running. Namely it is to repair the case where we by hand turn nginx off, or if it somehow terminates in some other manner. The restart should take effect on any initial install, so we would expect this 'started' to virtually never have an effect.", "author": "DanVanAtta", "createdAt": "2020-02-01T20:26:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mzc5NjE1NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mzc5NjI0Mw==", "url": "https://github.com/triplea-game/triplea/pull/5894#discussion_r373796243", "bodyText": "I assume this path shouldn't be hardcoded?", "author": "RoiEXLab", "createdAt": "2020-02-01T19:03:13Z", "path": "infrastructure/ansible/roles/certbot/tasks/main.yml", "diffHunk": "@@ -0,0 +1,43 @@\n+- name: install software properties common\n+  become: true\n+  apt:\n+    state: present\n+    name: software-properties-common\n+  \n+- name: install certbot apt-repositories\n+  become: true\n+  apt_repository:\n+    state: present\n+    repo: \"{{ item }}\"\n+  loop:\n+    - \"deb http://archive.ubuntu.com/ubuntu/ bionic universe\"\n+    - \"deb http://archive.ubuntu.com/ubuntu/ bionic-updates universe\"\n+    - \"deb http://security.ubuntu.com/ubuntu/ bionic-security universe\"\n+    - \"ppa:certbot/certbot\"\n+\n+- name: install certbot and python for certbot on nginx\n+  become: true\n+  apt:\n+    update_cache: yes\n+    name:\n+      - certbot\n+      - python-certbot-nginx\n+\n+- name: look for certbot generated key file\n+  become: true\n+  stat:\n+    path: /etc/letsencrypt/live/prerelease.triplea-game.org/cert.pem", "originalCommit": "6795b0daac398019e2e1705258b8c1e3b3f3adf5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzgwMDMyMQ==", "url": "https://github.com/triplea-game/triplea/pull/5894#discussion_r373800321", "bodyText": "Indeed, good catch, updated: 828cce1", "author": "DanVanAtta", "createdAt": "2020-02-01T20:23:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mzc5NjI0Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mzc5NjUwNA==", "url": "https://github.com/triplea-game/triplea/pull/5894#discussion_r373796504", "bodyText": "We don't have any mail forwarding for this email don't we?\nI just got (2 days ago) an email from the certbot utility telling me that it failed to renew the MARTI HTTP certificates.\nTurns out that there was (and still is, but I found a workaround) a DNSSEC issue with namecheap that fails for a nonexistent subdomain, which ultimately caused the check to fail.\nWithout this email we wouldn't have noticed until it's too late, so I'm convinced there's definitely some value in using an actual email here.", "author": "RoiEXLab", "createdAt": "2020-02-01T19:08:59Z", "path": "infrastructure/ansible/roles/certbot/tasks/main.yml", "diffHunk": "@@ -0,0 +1,43 @@\n+- name: install software properties common\n+  become: true\n+  apt:\n+    state: present\n+    name: software-properties-common\n+  \n+- name: install certbot apt-repositories\n+  become: true\n+  apt_repository:\n+    state: present\n+    repo: \"{{ item }}\"\n+  loop:\n+    - \"deb http://archive.ubuntu.com/ubuntu/ bionic universe\"\n+    - \"deb http://archive.ubuntu.com/ubuntu/ bionic-updates universe\"\n+    - \"deb http://security.ubuntu.com/ubuntu/ bionic-security universe\"\n+    - \"ppa:certbot/certbot\"\n+\n+- name: install certbot and python for certbot on nginx\n+  become: true\n+  apt:\n+    update_cache: yes\n+    name:\n+      - certbot\n+      - python-certbot-nginx\n+\n+- name: look for certbot generated key file\n+  become: true\n+  stat:\n+    path: /etc/letsencrypt/live/prerelease.triplea-game.org/cert.pem\n+  register: has_certbot_pem\n+\n+- name: run certbot\n+  become: true\n+  command: \"certbot --nginx -n -m tripleabuilderbot@gmail.com --agree-tos -d {{ inventory_hostname }}\"", "originalCommit": "6795b0daac398019e2e1705258b8c1e3b3f3adf5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mzc5NzgwNw==", "url": "https://github.com/triplea-game/triplea/pull/5894#discussion_r373797807", "bodyText": "Oh and another thing: By adding --rsa-key-size 4096 we get a stronger RSA key.\nI use this for every other server we use certbot on.", "author": "RoiEXLab", "createdAt": "2020-02-01T19:36:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mzc5NjUwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzgwMDMwOQ==", "url": "https://github.com/triplea-game/triplea/pull/5894#discussion_r373800309", "bodyText": "tripleabuilderbot@gmail.com  is a real email. If we have a dev-forwaring list, that would be good to use. I just sent a test email to: tripleadevelopers@gmail.com and got nothing - is that a working distro? Arguably we should also encode the email as well so that it does not get scraped and yield spam.\nAdded the key-size flag: 69a240e; The command here is based on what we previously had in the README", "author": "DanVanAtta", "createdAt": "2020-02-01T20:22:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mzc5NjUwNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mzc5NzM3Nw==", "url": "https://github.com/triplea-game/triplea/pull/5894#discussion_r373797377", "bodyText": "How often is this file run?\nCould it happen that the certificate runs out in-between runs?\nFor Marti and the forum I solved this problem by adding a post-hook that runs sudo systemctl reload nginx to ensure that nginx picks up the certificate correctly after refreshing it. It could be the case that certbot does this automatically using the nginx plugin (which is used), but when I initially configured everything there such a plugin didn't exist yer.", "author": "RoiEXLab", "createdAt": "2020-02-01T19:26:26Z", "path": "infrastructure/ansible/roles/nginx/tasks/main.yml", "diffHunk": "@@ -4,52 +4,108 @@\n     name: nginx\n     state: present\n \n+\n - name: generate dhparam.pem\n   become: true\n   shell:\n-    cmd: openssl dhparam -out {{ nginx_ssl_dhparams }} 4096\n-    creates: \"{{ nginx_ssl_dhparams }}\"\n+    cmd: openssl dhparam -out {{ dhparams_pem_file }} 4096\n+    creates: \"{{ dhparams_pem_file }}\"\n \n - name: set permissions of dhparam.pem\n   become: true\n   file:\n-    dest: \"{{ nginx_ssl_dhparams }}\"\n+    dest: \"{{ dhparams_pem_file }}\"\n     mode: 600\n \n-- name: check for nginx cert key\n+\n+- name: check for SSL cert key\n   stat:\n-    path: \"{{ nginx_ssl_certificate_key }}\"\n-  register: cert_key\n+    path: \"{{ ssl_cert_key }}\"\n+  register: has_cert_key\n   changed_when: false\n-\n-- name: check for nginx certificate\n+ \n+- name: check for SSL cert\n   stat:\n-    path: \"{{ nginx_ssl_certificate }}\"\n-  register: cert\n+    path: \"{{ ssl_cert }}\"\n+  register: has_cert\n   changed_when: false\n \n - name: create SSL keys if needed\n   become: true\n-  when: (cert_key.stat.exists == false) or (cert.stat.exists == false)\n-  command: openssl req -x509 -nodes -days 365 -newkey rsa:4096 -keyout {{ nginx_ssl_certificate_key }} -out {{ nginx_ssl_certificate }} -batch -subj '/CN=localhost' -sha256 -addext \"subjectAltName = IP:127.0.0.1, IP:::1\"\n+  when: (has_cert_key.stat.exists == false) or (has_cert.stat.exists == false)\n+  command: |\n+       openssl req -x509 -nodes -days 365 \\\n+          -newkey rsa:4096 -keyout {{ ssl_cert_key }} -out {{ ssl_cert }} \\\n+          -batch -subj '/CN=localhost' -sha256 -addext \"subjectAltName = IP:127.0.0.1, IP:::1\"\n+\n+\n+- name: check for letsencrypt cert key\n+  stat:\n+    path: \"{{ lets_encrypt_cert_key }}\"\n+  register: has_lets_encrypt_cert_key\n+  changed_when: false\n+\n+- name: set cert-key variable to generated cert if letsencrypt cert key DNE\n+  when: has_lets_encrypt_cert_key.stat.exists == false\n+  set_fact:\n+    cert_key: \"{{ ssl_cert_key }};\"\n+  changed_when: false\n+\n+- name: set cert-key variable to lets_encrypt cert-key if exists\n+  when: has_lets_encrypt_cert_key.stat.exists\n+  set_fact:\n+    cert_key: \"{{ lets_encrypt_cert_key }}; # managed by Certbot;\"\n+  changed_when: false\n+\n+\n+- name: check for lets_encrypt cert\n+  stat:\n+    path: \"{{ lets_encrypt_cert }}\"\n+  register: has_lets_encrypt_cert\n+  changed_when: false\n+  \n+- name: set cert variable to generated cert if lets_encrypt cert DNE\n+  when: has_lets_encrypt_cert.stat.exists == false\n+  set_fact:\n+    cert: \"{{ ssl_cert }};\"\n+  changed_when: false\n+\n+- name: set cert variable to lets_encrypt cert if exists\n+  when: has_lets_encrypt_cert.stat.exists\n+  set_fact:\n+    cert: \"{{ lets_encrypt_cert }}; # managed by Certbot;\"\n+  changed_when: false\n+\n \n - name: deploy nginx sites_enabled configuation\n   become: true\n   template:\n     src: etc_nginx_sites_enabled_default.j2\n     dest: /etc/nginx/sites-enabled/default\n+  register: nginx_config_changed\n \n - name: allow ports\n   become: true\n+  tags: firewall\n   ufw:\n     rule: allow\n     port: \"{{ item }}\"\n     proto: tcp\n   with_items: \"{{ nginx_allowed_ports }}\"\n \n-- name: relaunch nginx\n+- name: restart nginx if config changed\n+  when: |\n+    (nginx_config_changed.changed) \n+      or (has_cert_key.stat.exists == false) \n+      or (has_cert.stat.exists == false)", "originalCommit": "6795b0daac398019e2e1705258b8c1e3b3f3adf5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mzc5ODExMQ==", "url": "https://github.com/triplea-game/triplea/pull/5894#discussion_r373798111", "bodyText": "I just double checked my assumption.\nLooks like the nginx plugin takes care of automatically restarting the service, so no need to restart nginx \"manually\".\nSee https://community.letsencrypt.org/t/doest-certbot-automaticly-reload-nginx-on-successful-renew/40361/5", "author": "RoiEXLab", "createdAt": "2020-02-01T19:42:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mzc5NzM3Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzgwMDgwMw==", "url": "https://github.com/triplea-game/triplea/pull/5894#discussion_r373800803", "bodyText": "Is this file tasks/main.yml? If so, on every build. If 'this file' is the cert, if you scroll up in the same tasks/main.yml there is a stat command to check for /etc/nginx/cert.crt and key and generates if does not exist, so that is one-time.\nTo explain this when clause, if someone deletes the 'crt' files and we recreate them, and even if 'sites-enabled/default' is not updated, we'll restart nginx. Otherwise, if 'sites-enabled/default' is modified, we'll restart nginx.\n\nCould it happen that the certificate runs out in-between runs?\n\nThis role/task is independent of the certbot certificates, it is for a 'base' nginx only and is unaware of certbot. AFAIK the generated certs /etc/nginx/cert.crt, do not expire as those are just keys.\n\nLooks like the nginx plugin takes care of automatically restarting the service, so no need to restart nginx \"manually\"\n\nI think perhaps there is a disconnect. We are restarting here on configuration change or a change in the nginx keys, there is no certbot involved here yet.", "author": "DanVanAtta", "createdAt": "2020-02-01T20:31:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mzc5NzM3Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzgwMTY0NQ==", "url": "https://github.com/triplea-game/triplea/pull/5894#discussion_r373801645", "bodyText": "Ah, ok makes sense.\nThanks for clarifying", "author": "RoiEXLab", "createdAt": "2020-02-01T20:50:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mzc5NzM3Nw=="}], "type": "inlineReview"}, {"oid": "01ebf211ba0d1a9a70f83bbb1b5884443f2295e1", "url": "https://github.com/triplea-game/triplea/commit/01ebf211ba0d1a9a70f83bbb1b5884443f2295e1", "message": "More formatting updates", "committedDate": "2020-02-01T19:32:52Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mzc5NzgyNA==", "url": "https://github.com/triplea-game/triplea/pull/5894#discussion_r373797824", "bodyText": "Inconsistent indentation for list items at the same level", "author": "codeclimate", "createdAt": "2020-02-01T19:36:23Z", "path": "infrastructure/README.md", "diffHunk": "@@ -67,32 +67,47 @@ defined in the prerelease inventory file.\n Assuming a vault password file named 'vault_password' is created in the same\n folder and contains the ansible vault password, run: \n \n-``bash\n+```bash\n ./run_deployment [version_to_install] [ansible_args]\n ```\n \n examples\n+\n+\n+### Typical Deployment Command\n ```bash\n ./run_deployment 2.0.1000 -i ansible/inventory/prerelease\n+```\n+\n+### Useful flags\n \n-# To see verbose output\n-./run_deployment 2.0.1000 -v -i ansible/inventory/prerelease\n+  * `-v`: Verbose output", "originalCommit": "01ebf211ba0d1a9a70f83bbb1b5884443f2295e1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mzc5NzgyNQ==", "url": "https://github.com/triplea-game/triplea/pull/5894#discussion_r373797825", "bodyText": "Inconsistent indentation for list items at the same level", "author": "codeclimate", "createdAt": "2020-02-01T19:36:23Z", "path": "infrastructure/README.md", "diffHunk": "@@ -67,32 +67,47 @@ defined in the prerelease inventory file.\n Assuming a vault password file named 'vault_password' is created in the same\n folder and contains the ansible vault password, run: \n \n-``bash\n+```bash\n ./run_deployment [version_to_install] [ansible_args]\n ```\n \n examples\n+\n+\n+### Typical Deployment Command\n ```bash\n ./run_deployment 2.0.1000 -i ansible/inventory/prerelease\n+```\n+\n+### Useful flags\n \n-# To see verbose output\n-./run_deployment 2.0.1000 -v -i ansible/inventory/prerelease\n+  * `-v`: Verbose output\n+  * `-vvv`: Debug output", "originalCommit": "01ebf211ba0d1a9a70f83bbb1b5884443f2295e1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mzc5NzgyNg==", "url": "https://github.com/triplea-game/triplea/pull/5894#discussion_r373797826", "bodyText": "Inconsistent indentation for list items at the same level", "author": "codeclimate", "createdAt": "2020-02-01T19:36:23Z", "path": "infrastructure/README.md", "diffHunk": "@@ -67,32 +67,47 @@ defined in the prerelease inventory file.\n Assuming a vault password file named 'vault_password' is created in the same\n folder and contains the ansible vault password, run: \n \n-``bash\n+```bash\n ./run_deployment [version_to_install] [ansible_args]\n ```\n \n examples\n+\n+\n+### Typical Deployment Command\n ```bash\n ./run_deployment 2.0.1000 -i ansible/inventory/prerelease\n+```\n+\n+### Useful flags\n \n-# To see verbose output\n-./run_deployment 2.0.1000 -v -i ansible/inventory/prerelease\n+  * `-v`: Verbose output\n+  * `-vvv`: Debug output\n+  * `-vvvv`: SSL Debug output", "originalCommit": "01ebf211ba0d1a9a70f83bbb1b5884443f2295e1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mzc5NzgyNw==", "url": "https://github.com/triplea-game/triplea/pull/5894#discussion_r373797827", "bodyText": "Inconsistent indentation for list items at the same level", "author": "codeclimate", "createdAt": "2020-02-01T19:36:23Z", "path": "infrastructure/README.md", "diffHunk": "@@ -67,32 +67,47 @@ defined in the prerelease inventory file.\n Assuming a vault password file named 'vault_password' is created in the same\n folder and contains the ansible vault password, run: \n \n-``bash\n+```bash\n ./run_deployment [version_to_install] [ansible_args]\n ```\n \n examples\n+\n+\n+### Typical Deployment Command\n ```bash\n ./run_deployment 2.0.1000 -i ansible/inventory/prerelease\n+```\n+\n+### Useful flags\n \n-# To see verbose output\n-./run_deployment 2.0.1000 -v -i ansible/inventory/prerelease\n+  * `-v`: Verbose output\n+  * `-vvv`: Debug output\n+  * `-vvvv`: SSL Debug output\n+  * `--diff`: Shows differences in updated templates and files", "originalCommit": "01ebf211ba0d1a9a70f83bbb1b5884443f2295e1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mzc5NzgyOA==", "url": "https://github.com/triplea-game/triplea/pull/5894#discussion_r373797828", "bodyText": "Inconsistent indentation for list items at the same level", "author": "codeclimate", "createdAt": "2020-02-01T19:36:23Z", "path": "infrastructure/README.md", "diffHunk": "@@ -67,32 +67,47 @@ defined in the prerelease inventory file.\n Assuming a vault password file named 'vault_password' is created in the same\n folder and contains the ansible vault password, run: \n \n-``bash\n+```bash\n ./run_deployment [version_to_install] [ansible_args]\n ```\n \n examples\n+\n+\n+### Typical Deployment Command\n ```bash\n ./run_deployment 2.0.1000 -i ansible/inventory/prerelease\n+```\n+\n+### Useful flags\n \n-# To see verbose output\n-./run_deployment 2.0.1000 -v -i ansible/inventory/prerelease\n+  * `-v`: Verbose output\n+  * `-vvv`: Debug output\n+  * `-vvvv`: SSL Debug output\n+  * `--diff`: Shows differences in updated templates and files\n+  * `-t`: Tags", "originalCommit": "01ebf211ba0d1a9a70f83bbb1b5884443f2295e1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mzc5NzgyOQ==", "url": "https://github.com/triplea-game/triplea/pull/5894#discussion_r373797829", "bodyText": "Consider starting bulleted lists at the beginning of the line", "author": "codeclimate", "createdAt": "2020-02-01T19:36:24Z", "path": "infrastructure/README.md", "diffHunk": "@@ -67,32 +67,47 @@ defined in the prerelease inventory file.\n Assuming a vault password file named 'vault_password' is created in the same\n folder and contains the ansible vault password, run: \n \n-``bash\n+```bash\n ./run_deployment [version_to_install] [ansible_args]\n ```\n \n examples\n+\n+\n+### Typical Deployment Command\n ```bash\n ./run_deployment 2.0.1000 -i ansible/inventory/prerelease\n+```\n+\n+### Useful flags\n \n-# To see verbose output\n-./run_deployment 2.0.1000 -v -i ansible/inventory/prerelease\n+  * `-v`: Verbose output", "originalCommit": "01ebf211ba0d1a9a70f83bbb1b5884443f2295e1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "625a5ac48eab21763c02d74dd3f25fa175575856", "url": "https://github.com/triplea-game/triplea/commit/625a5ac48eab21763c02d74dd3f25fa175575856", "message": "More MD formatting", "committedDate": "2020-02-01T20:06:58Z", "type": "commit"}, {"oid": "13758f225e41b933c108218b403eb7f3e420b13c", "url": "https://github.com/triplea-game/triplea/commit/13758f225e41b933c108218b403eb7f3e420b13c", "message": "Yet more MD formatting", "committedDate": "2020-02-01T20:08:25Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mzc5OTUzOQ==", "url": "https://github.com/triplea-game/triplea/pull/5894#discussion_r373799539", "bodyText": "Unordered list style", "author": "codeclimate", "createdAt": "2020-02-01T20:09:49Z", "path": "infrastructure/README.md", "diffHunk": "@@ -165,47 +181,14 @@ ansible-vault encrypt --vault-password-file=vault_password ansible_ssh_key.ed255\n \n # Https Certificate Installation\n \n-Currently done manually.\n+The 'certbot' role will:\n \n-## certbot from letsencrypt\n+- run lets-encrypt and create a publicly signed SSL cert.", "originalCommit": "13758f225e41b933c108218b403eb7f3e420b13c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mzc5OTU0MA==", "url": "https://github.com/triplea-game/triplea/pull/5894#discussion_r373799540", "bodyText": "Unordered list style", "author": "codeclimate", "createdAt": "2020-02-01T20:09:50Z", "path": "infrastructure/README.md", "diffHunk": "@@ -165,47 +181,14 @@ ansible-vault encrypt --vault-password-file=vault_password ansible_ssh_key.ed255\n \n # Https Certificate Installation\n \n-Currently done manually.\n+The 'certbot' role will:\n \n-## certbot from letsencrypt\n+- run lets-encrypt and create a publicly signed SSL cert.\n+- sets up a weekly renewal cronjob that will renew the SSL cert if it", "originalCommit": "13758f225e41b933c108218b403eb7f3e420b13c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "828cce12439e6814b28fd6f7d24e474101345e72", "url": "https://github.com/triplea-game/triplea/commit/828cce12439e6814b28fd6f7d24e474101345e72", "message": "Fix inventory-hostname hardcoding", "committedDate": "2020-02-01T20:12:07Z", "type": "commit"}, {"oid": "69a240eedeb17feccf82b66dc4e633c7eba7de71", "url": "https://github.com/triplea-game/triplea/commit/69a240eedeb17feccf82b66dc4e633c7eba7de71", "message": "Add --rsa-key-size 4096 to certbot command and update command formatting", "committedDate": "2020-02-01T20:21:14Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzgwMDM3OA==", "url": "https://github.com/triplea-game/triplea/pull/5894#discussion_r373800378", "bodyText": "Unordered list style", "author": "codeclimate", "createdAt": "2020-02-01T20:24:03Z", "path": "infrastructure/README.md", "diffHunk": "@@ -165,47 +181,14 @@ ansible-vault encrypt --vault-password-file=vault_password ansible_ssh_key.ed255\n \n # Https Certificate Installation\n \n-Currently done manually.\n+The 'certbot' role will:\n \n-## certbot from letsencrypt\n+- run lets-encrypt and create a publicly signed SSL cert.", "originalCommit": "69a240eedeb17feccf82b66dc4e633c7eba7de71", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzgwMDM3OQ==", "url": "https://github.com/triplea-game/triplea/pull/5894#discussion_r373800379", "bodyText": "Unordered list style", "author": "codeclimate", "createdAt": "2020-02-01T20:24:03Z", "path": "infrastructure/README.md", "diffHunk": "@@ -165,47 +181,14 @@ ansible-vault encrypt --vault-password-file=vault_password ansible_ssh_key.ed255\n \n # Https Certificate Installation\n \n-Currently done manually.\n+The 'certbot' role will:\n \n-## certbot from letsencrypt\n+- run lets-encrypt and create a publicly signed SSL cert.\n+- sets up a weekly renewal cronjob that will renew the SSL cert if it", "originalCommit": "69a240eedeb17feccf82b66dc4e633c7eba7de71", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "05ff791652f048ee23926be5b2d9398a6b560ff7", "url": "https://github.com/triplea-game/triplea/commit/05ff791652f048ee23926be5b2d9398a6b560ff7", "message": "More README formatting", "committedDate": "2020-02-01T20:32:33Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzgwMDk0NA==", "url": "https://github.com/triplea-game/triplea/pull/5894#discussion_r373800944", "bodyText": "Line length", "author": "codeclimate", "createdAt": "2020-02-01T20:34:41Z", "path": "infrastructure/README.md", "diffHunk": "@@ -150,10 +166,11 @@ by ansible when ansible is run. To encrypt a variable:\n [Ansible-Vault Docs](https://docs.ansible.com/ansible/latest/user_guide/vault.html)\n \n Warnings:\n- - use files to store passwords/secrets so that the password is not in your shell history\n- - take care to not commit into git any passwords or secrets, files containing secrets should\n+\n+* use files to store passwords/secrets so that the password is not in your shell history", "originalCommit": "05ff791652f048ee23926be5b2d9398a6b560ff7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzgwMDk0NQ==", "url": "https://github.com/triplea-game/triplea/pull/5894#discussion_r373800945", "bodyText": "Line length", "author": "codeclimate", "createdAt": "2020-02-01T20:34:41Z", "path": "infrastructure/README.md", "diffHunk": "@@ -150,10 +166,11 @@ by ansible when ansible is run. To encrypt a variable:\n [Ansible-Vault Docs](https://docs.ansible.com/ansible/latest/user_guide/vault.html)\n \n Warnings:\n- - use files to store passwords/secrets so that the password is not in your shell history\n- - take care to not commit into git any passwords or secrets, files containing secrets should\n+\n+* use files to store passwords/secrets so that the password is not in your shell history\n+* take care to not commit into git any passwords or secrets, files containing secrets should", "originalCommit": "05ff791652f048ee23926be5b2d9398a6b560ff7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "85f89bc74ac5e9183ad1399c9ddbb8e5f6c54217", "url": "https://github.com/triplea-game/triplea/commit/85f89bc74ac5e9183ad1399c9ddbb8e5f6c54217", "message": "Formatting, fix long lines", "committedDate": "2020-02-01T20:36:42Z", "type": "commit"}, {"oid": "2fbc544c5b10028ff5917b25ad2643d9afeec13c", "url": "https://github.com/triplea-game/triplea/commit/2fbc544c5b10028ff5917b25ad2643d9afeec13c", "message": "Comment out cronjob renewal (for now) pending verification if it is already automatic", "committedDate": "2020-02-01T21:28:35Z", "type": "commit"}, {"oid": "541befa26ccb416faa33cb185b71d01123828996", "url": "https://github.com/triplea-game/triplea/commit/541befa26ccb416faa33cb185b71d01123828996", "message": "Switch prerelease URL to prerelease2 and simplify inventory file for prerelease", "committedDate": "2020-02-01T22:03:02Z", "type": "commit"}, {"oid": "7946c91fc50feb07d46a65bddda3621e437c8cfc", "url": "https://github.com/triplea-game/triplea/commit/7946c91fc50feb07d46a65bddda3621e437c8cfc", "message": "Update (temporarily until cert rate limit expires ina week) prerelease server URI to prerelease2", "committedDate": "2020-02-01T22:03:34Z", "type": "commit"}, {"oid": "0af29364ee0fe591e272a8ae3b3cec3d105a86cb", "url": "https://github.com/triplea-game/triplea/commit/0af29364ee0fe591e272a8ae3b3cec3d105a86cb", "message": "Remove certbot cronjob renewal, it is automatically added in /etc/cron.d/certbot for us", "committedDate": "2020-02-01T22:57:14Z", "type": "commit"}]}