{"pr_number": 5992, "pr_title": "Hardcode network opcodes", "pr_createdAt": "2020-03-02T14:24:27Z", "pr_url": "https://github.com/triplea-game/triplea/pull/5992", "timeline": [{"oid": "46fb4a583c666957e8393ac426af876528036ec5", "url": "https://github.com/triplea-game/triplea/commit/46fb4a583c666957e8393ac426af876528036ec5", "message": "Add annotations usiing script", "committedDate": "2020-03-02T13:26:55Z", "type": "commit"}, {"oid": "c7bac2b60877332a088bbaca0711f4492f89e312", "url": "https://github.com/triplea-game/triplea/commit/c7bac2b60877332a088bbaca0711f4492f89e312", "message": "Auto-Format and fix compile errors", "committedDate": "2020-03-02T13:54:49Z", "type": "commit"}, {"oid": "2ab30b7597a128c49fe77a8f148f8683f021d3a9", "url": "https://github.com/triplea-game/triplea/commit/2ab30b7597a128c49fe77a8f148f8683f021d3a9", "message": "Avoid weird comparator logic", "committedDate": "2020-03-02T14:11:08Z", "type": "commit"}, {"oid": "f5d941be8f43db1c651d407feff0c66903d75c65", "url": "https://github.com/triplea-game/triplea/commit/f5d941be8f43db1c651d407feff0c66903d75c65", "message": "Fix compilation error", "committedDate": "2020-03-02T14:31:35Z", "type": "commit"}, {"oid": "2cc85e26ecc3f4c0841651c55db2253addee2619", "url": "https://github.com/triplea-game/triplea/commit/2cc85e26ecc3f4c0841651c55db2253addee2619", "message": "Fix typo", "committedDate": "2020-03-02T14:32:01Z", "type": "commit"}, {"oid": "f8f3128cdbfe92d9255ed455aaa69350b1f0479a", "url": "https://github.com/triplea-game/triplea/commit/f8f3128cdbfe92d9255ed455aaa69350b1f0479a", "message": "Fix double annotation", "committedDate": "2020-03-02T14:38:56Z", "type": "commit"}, {"oid": "dccab88f686b0e9a1d8e92077433c9664c8b44e9", "url": "https://github.com/triplea-game/triplea/commit/dccab88f686b0e9a1d8e92077433c9664c8b44e9", "message": "Add missing annotations", "committedDate": "2020-03-02T14:57:54Z", "type": "commit"}, {"oid": "ac1e2d875653d4c93b7653aa2afa97069bfcd3ca", "url": "https://github.com/triplea-game/triplea/commit/ac1e2d875653d4c93b7653aa2afa97069bfcd3ca", "message": "Remove redundant field", "committedDate": "2020-03-02T14:58:07Z", "type": "commit"}, {"oid": "8622d3f5f2b4117323ba019c04c1db5dccccd3d9", "url": "https://github.com/triplea-game/triplea/commit/8622d3f5f2b4117323ba019c04c1db5dccccd3d9", "message": "Remove unused method", "committedDate": "2020-03-02T15:01:40Z", "type": "commit"}, {"oid": "cb63ed63907b4c3241dcc5d33730daa9e87e8b72", "url": "https://github.com/triplea-game/triplea/commit/cb63ed63907b4c3241dcc5d33730daa9e87e8b72", "message": "Fix test cases", "committedDate": "2020-03-02T15:04:47Z", "type": "commit"}, {"oid": "a3a2130f304baa31da71695cec0e14f4fde75fac", "url": "https://github.com/triplea-game/triplea/commit/a3a2130f304baa31da71695cec0e14f4fde75fac", "message": "Add documentation", "committedDate": "2020-03-02T15:07:57Z", "type": "commit"}, {"oid": "71f74e1bbb6097f4b8445ad20b1b9293b90b797e", "url": "https://github.com/triplea-game/triplea/commit/71f74e1bbb6097f4b8445ad20b1b9293b90b797e", "message": "Fix EndPointTest", "committedDate": "2020-03-02T15:18:06Z", "type": "commit"}, {"oid": "2dda8afea786316479fdbef3c19c38a8f9aa2762", "url": "https://github.com/triplea-game/triplea/commit/2dda8afea786316479fdbef3c19c38a8f9aa2762", "message": "Remove now redundant documentation", "committedDate": "2020-03-02T16:26:18Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjUwMjcyNw==", "url": "https://github.com/triplea-game/triplea/pull/5992#discussion_r386502727", "bodyText": "Now with those changes this unused method can safely be removed", "author": "RoiEXLab", "createdAt": "2020-03-02T16:29:58Z", "path": "game-core/src/main/java/games/strategy/triplea/delegate/remote/IEditDelegate.java", "diffHunk": "@@ -6,37 +6,48 @@\n import games.strategy.engine.data.Unit;\n import games.strategy.engine.delegate.IPersistentDelegate;\n import games.strategy.engine.message.IRemote;\n+import games.strategy.engine.message.RemoteActionCode;\n import games.strategy.triplea.delegate.TechAdvance;\n import java.util.Collection;\n import org.triplea.java.collections.IntegerMap;\n import org.triplea.util.Triple;\n \n /** Remote interface for EditDelegate. */\n public interface IEditDelegate extends IRemote, IPersistentDelegate {\n+  @RemoteActionCode(9)\n   boolean getEditMode();\n \n+  @RemoteActionCode(12)\n   void setEditMode(boolean editMode);\n \n+  @RemoteActionCode(11)\n   String removeUnits(Territory t, Collection<Unit> units);\n \n+  @RemoteActionCode(2)\n   String addUnits(Territory t, Collection<Unit> units);\n \n+  @RemoteActionCode(6)\n   String changeTerritoryOwner(Territory t, GamePlayer player);\n \n+  @RemoteActionCode(3)\n   String changePUs(GamePlayer player, int pus);\n \n-  String changeTechTokens(GamePlayer player, int tokens);\n-", "originalCommit": "2dda8afea786316479fdbef3c19c38a8f9aa2762", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Njc2OTU4Nw==", "url": "https://github.com/triplea-game/triplea/pull/5992#discussion_r386769587", "bodyText": "Should we re-order the methods so that the numbers would be ascending? I think that might help make it clear there are no gaps and just be nicer when reading the methods.", "author": "DanVanAtta", "createdAt": "2020-03-03T02:40:19Z", "path": "game-core/src/main/java/games/strategy/engine/chat/IChatChannel.java", "diffHunk": "@@ -1,29 +1,31 @@\n package games.strategy.engine.chat;\n \n import games.strategy.engine.message.IChannelSubscriber;\n+import games.strategy.engine.message.RemoteActionCode;\n import org.triplea.domain.data.UserName;\n import org.triplea.http.client.lobby.chat.ChatParticipant;\n \n-/**\n- * Chat messages occur on this channel.\n- *\n- * <p>RMI warning: the ordering of methods cannot be changed, these methods will be invoked by\n- * method order number\n- */\n+/** Chat messages occur on this channel. */\n public interface IChatChannel extends IChannelSubscriber {\n   // we get the sender from MessageContext\n+  @RemoteActionCode(0)\n   void chatOccurred(String message);\n \n+  @RemoteActionCode(2)", "originalCommit": "2dda8afea786316479fdbef3c19c38a8f9aa2762", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjkzOTgyMw==", "url": "https://github.com/triplea-game/triplea/pull/5992#discussion_r386939823", "bodyText": "We could, but it would be a tedious process + some classes skip a couple of numbers and if we ever plan to overload a method checkstyle would force us to keep the overloadoverloaded versions together.\nWe could add this as a \"nice to have\" task, but this is not something I'd like to address as part of this PR.", "author": "RoiEXLab", "createdAt": "2020-03-03T10:51:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Njc2OTU4Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Njc3MDM5OA==", "url": "https://github.com/triplea-game/triplea/pull/5992#discussion_r386770398", "bodyText": "Looks like we are still bound by method name (and ordering must be preserved, but at least that is in annotation now). Is there a way we could put the method name in the annotation as well?", "author": "DanVanAtta", "createdAt": "2020-03-03T02:43:32Z", "path": "game-core/src/test/java/games/strategy/engine/message/unifiedmessenger/EndPointTest.java", "diffHunk": "@@ -2,25 +2,26 @@\n \n import static org.junit.jupiter.api.Assertions.assertEquals;\n \n+import games.strategy.engine.message.RemoteActionCode;\n import games.strategy.engine.message.RemoteMethodCall;\n import games.strategy.engine.message.RemoteMethodCallResults;\n-import java.util.Comparator;\n import java.util.List;\n import org.junit.jupiter.api.Test;\n \n class EndPointTest {\n \n+  interface TestInterface {\n+    @RemoteActionCode(0)\n+    @SuppressWarnings(\"unused\")\n+    int dummy();\n+  }\n+\n   @Test\n-  void testEndPoint() {\n-    final EndPoint endPoint = new EndPoint(\"\", Comparator.class, false);\n-    endPoint.addImplementor((Comparator<Object>) (o1, o2) -> 2);\n+  void testEndPoint() throws Exception {\n+    final EndPoint endPoint = new EndPoint(\"\", TestInterface.class, false);\n+    endPoint.addImplementor((TestInterface) () -> 2);\n     final RemoteMethodCall call =\n-        new RemoteMethodCall(\n-            \"\",\n-            \"compare\",\n-            new Object[] {\"\", \"\"},\n-            new Class<?>[] {Object.class, Object.class},\n-            Comparator.class);\n+        new RemoteMethodCall(\"\", TestInterface.class.getMethod(\"dummy\"), new Object[] {});", "originalCommit": "2dda8afea786316479fdbef3c19c38a8f9aa2762", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Njk0MjczOA==", "url": "https://github.com/triplea-game/triplea/pull/5992#discussion_r386942738", "bodyText": "We are only bound in this particular test-case.\nThe RemoteMethodCall class works via reflection after all, so we need to pass the method object to the constructor somehow.\nIn non-test code this conversion is done by the JVM:\nWe create a \"proxy\" object that implements a particular interface. Whenever we call a method on this proxy object, the invocationhandler we registered is called with the corresponding method object, so the non-test code doesn't have any references to the method names whatsoever", "author": "RoiEXLab", "createdAt": "2020-03-03T10:56:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Njc3MDM5OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Njc3MTE3NQ==", "url": "https://github.com/triplea-game/triplea/pull/5992#discussion_r386771175", "bodyText": "I'd perhaps rephrase this slightly.\n\nopcode does not have a well defined meaning, perhaps better to say something along the lines of: \"Annotation that defines a method number, methods are called by method number using the {@link RemoteMethodCall} mechanism}\". In order to stay compatible over the network, annotated methods should be altered (including: renaming, changes in signature, or changes in the method ordering number).\"", "author": "DanVanAtta", "createdAt": "2020-03-03T02:46:26Z", "path": "game-core/src/main/java/games/strategy/engine/message/RemoteActionCode.java", "diffHunk": "@@ -0,0 +1,19 @@\n+package games.strategy.engine.message;\n+\n+import java.lang.annotation.ElementType;\n+import java.lang.annotation.Retention;\n+import java.lang.annotation.RetentionPolicy;\n+import java.lang.annotation.Target;\n+\n+/**\n+ * Annotation that sets the \"opcode\" for any particular method that may be used over the network", "originalCommit": "2dda8afea786316479fdbef3c19c38a8f9aa2762", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "78a0aa735bdcff94c369ce3c98a2371be7467a2b", "url": "https://github.com/triplea-game/triplea/commit/78a0aa735bdcff94c369ce3c98a2371be7467a2b", "message": "Enhance javadoc", "committedDate": "2020-03-03T11:50:14Z", "type": "commit"}]}