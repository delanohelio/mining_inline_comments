{"pr_number": 7008, "pr_title": "Convert LandParatroopers, MarkNoMovementLeft, and RemoveNonCombatants", "pr_createdAt": "2020-07-02T05:45:34Z", "pr_url": "https://github.com/triplea-game/triplea/pull/7008", "timeline": [{"oid": "d17fb44a642529da1ee239ba8f5fbda5568efde4", "url": "https://github.com/triplea-game/triplea/commit/d17fb44a642529da1ee239ba8f5fbda5568efde4", "message": "Convert LandParatroopers, MarkNoMovementLeft, and RemoveNonCombatants", "committedDate": "2020-07-02T04:48:14Z", "type": "commit"}, {"oid": "963f9a4e4195e2f9957fb60bb16cd992c5de8468", "url": "https://github.com/triplea-game/triplea/commit/963f9a4e4195e2f9957fb60bb16cd992c5de8468", "message": "Add tests and refactor LandParatroopers", "committedDate": "2020-07-02T04:48:14Z", "type": "commit"}, {"oid": "9867c7565ad962840cb22cdbbc2fd68a5913051b", "url": "https://github.com/triplea-game/triplea/commit/9867c7565ad962840cb22cdbbc2fd68a5913051b", "message": "Remove unused parameter firstRun and duplicate tests", "committedDate": "2020-07-02T04:48:14Z", "type": "commit"}, {"oid": "58723832e617fed9877443e3a4864a2face4ca60", "url": "https://github.com/triplea-game/triplea/commit/58723832e617fed9877443e3a4864a2face4ca60", "message": "Re-add battlRound check to landparatroopers", "committedDate": "2020-07-02T06:08:55Z", "type": "commit"}, {"oid": "fb8c23dfbaefd5ce48a2c7f5bd31749e9c0712a5", "url": "https://github.com/triplea-game/triplea/commit/fb8c23dfbaefd5ce48a2c7f5bd31749e9c0712a5", "message": "Convert ClearAaCasualties and isolate the old steps", "committedDate": "2020-07-02T19:41:35Z", "type": "commit"}, {"oid": "96eb94d7fb6216dd6f4a8abaed71195a07f8bafa", "url": "https://github.com/triplea-game/triplea/commit/96eb94d7fb6216dd6f4a8abaed71195a07f8bafa", "message": "Sort the steps using getOrder", "committedDate": "2020-07-02T20:49:05Z", "type": "commit"}, {"oid": "be0258b40ed2caaeedc881ff7a08913614b8bbdf", "url": "https://github.com/triplea-game/triplea/commit/be0258b40ed2caaeedc881ff7a08913614b8bbdf", "message": "Auto-Formatting", "committedDate": "2020-07-02T20:51:31Z", "type": "commit"}, {"oid": "be0258b40ed2caaeedc881ff7a08913614b8bbdf", "url": "https://github.com/triplea-game/triplea/commit/be0258b40ed2caaeedc881ff7a08913614b8bbdf", "message": "Auto-Formatting", "committedDate": "2020-07-02T20:51:31Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTI1MzM3Mw==", "url": "https://github.com/triplea-game/triplea/pull/7008#discussion_r451253373", "bodyText": "This interface is certainly becoming quite the list  \ud83d\ude01\nWould you agree that a javadoc could help clarify these methods? For example, when is markNoMovementLeft called, what does it mean to invoke that? I'm not sure if this method is invoked to indicate there is no movement left, or invoked to flag that there is no movement left. (Are we responding to the event, or are we triggering the event?)", "author": "DanVanAtta", "createdAt": "2020-07-08T02:56:28Z", "path": "game-core/src/main/java/games/strategy/triplea/delegate/battle/BattleActions.java", "diffHunk": "@@ -23,6 +23,15 @@ void queryRetreat(\n \n   void fireNavalBombardment(IDelegateBridge bridge);\n \n+  void landParatroopers(\n+      IDelegateBridge bridge, Collection<Unit> airTransports, Collection<Unit> dependents);\n+\n+  void removeNonCombatants(IDelegateBridge bridge);\n+\n+  void markNoMovementLeft(IDelegateBridge bridge);", "originalCommit": "be0258b40ed2caaeedc881ff7a08913614b8bbdf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTI2NzQxNw==", "url": "https://github.com/triplea-game/triplea/pull/7008#discussion_r451267417", "bodyText": "At this point, I'm not trying to understand what each of these methods do.  My goal is that once all of the steps have been converted, I'd like to go through these methods and try to \"shrink\" their focus by splitting them, breaking them up, etc and adding tests to them.  Some of them do a lot of things (queryRetreat has >120 lines).\nAt that point, I think I'll understand the methods well enough to be able to write javadocs for each of them.", "author": "trevan", "createdAt": "2020-07-08T03:53:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTI1MzM3Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTI3MTc1MA==", "url": "https://github.com/triplea-game/triplea/pull/7008#discussion_r451271750", "bodyText": "Another part of my goal is to have all of the code that interacts with the battle state to be limited to the methods in BattleState.  Some of the methods in BattleActions interact with the battle state and so I'll need to separate them.  Once that is done, it is possible that BattleActions won't even be needed anymore since the IDelegateBridge can be interacted with in the steps just as well as it can be interacted in BattleActions.  But at this moment, I'm just trying to move things around to make it easier to see how the logic should be split up.", "author": "trevan", "createdAt": "2020-07-08T04:12:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTI1MzM3Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTI1MzgzNA==", "url": "https://github.com/triplea-game/triplea/pull/7008#discussion_r451253834", "bodyText": "While this is an existing method, perhaps it's a good time to clarify it?\nIt's not clear here if we are clearing the \"damagedChangesInto\" units or are applying that.\nPerhaps this would be better called clearWaitingToDieAndApplyDamagedUnitConversions.\nEven better, could we break this up into two steps? That would be a much better SRP.", "author": "DanVanAtta", "createdAt": "2020-07-08T02:58:12Z", "path": "game-core/src/main/java/games/strategy/triplea/delegate/battle/BattleActions.java", "diffHunk": "@@ -23,6 +23,15 @@ void queryRetreat(\n \n   void fireNavalBombardment(IDelegateBridge bridge);\n \n+  void landParatroopers(\n+      IDelegateBridge bridge, Collection<Unit> airTransports, Collection<Unit> dependents);\n+\n+  void removeNonCombatants(IDelegateBridge bridge);\n+\n+  void markNoMovementLeft(IDelegateBridge bridge);\n+\n+  void clearWaitingToDieAndDamagedChangesInto(IDelegateBridge bridge);", "originalCommit": "be0258b40ed2caaeedc881ff7a08913614b8bbdf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTI2OTAzOA==", "url": "https://github.com/triplea-game/triplea/pull/7008#discussion_r451269038", "bodyText": "See my comment above about my goals.\nBut yeah, the method name is hard to understand.  It also isn't the only place where \"damagedChangesInto\" units are affected or where units are removed from the \"waitingToDie\" list.\nIt also makes me wonder about the \"atomic step\" comment that I moved to be over BattleStep.  I'm not sure how this method can be considered atomic.  But I'm not sure what would happen if I split it up into two separate steps vs just splitting the method into two methods but still calling it from the same step.", "author": "trevan", "createdAt": "2020-07-08T04:00:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTI1MzgzNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTI1NDA5NQ==", "url": "https://github.com/triplea-game/triplea/pull/7008#discussion_r451254095", "bodyText": "This list is looking good, it is making the control flow certainly more explicit and adding a layer of useful abstraction that informs you at a high level what the game sequence will be. I think this kind of change does make it easier to understand and maintain the code \ud83d\udc4d", "author": "DanVanAtta", "createdAt": "2020-07-08T02:59:19Z", "path": "game-core/src/main/java/games/strategy/triplea/delegate/battle/MustFightBattle.java", "diffHunk": "@@ -1067,27 +1038,39 @@ private void pushFightLoopOnStack(final boolean firstRun) {\n    * still needed. They can be safely removed once save compatibility can be broken.\n    */\n   @VisibleForTesting\n-  public List<IExecutable> getBattleExecutables(final boolean firstRun) {\n+  public List<IExecutable> getBattleExecutables() {\n     final List<IExecutable> steps = new ArrayList<>();\n-    addFightStartSteps(firstRun, steps);\n+    addFightStartSteps(steps);\n     addFightSteps(steps);\n     addCheckEndBattleAndRetreatingSteps(steps);\n     return steps;\n   }\n \n-  private void addFightStartSteps(final boolean firstRun, final List<IExecutable> steps) {\n+  private void addFightStartSteps(final List<IExecutable> steps) {\n     if (offensiveAa == null) {\n       updateOffensiveAaUnits();\n     }\n     if (defendingAa == null) {\n       updateDefendingAaUnits();\n     }\n-    final BattleStep navalBombardment = new NavalBombardment(this, this);\n-    final boolean offensiveAa = canFireOffensiveAa();\n-    final boolean defendingAa = canFireDefendingAa();\n-    final BattleStep offensiveAaStep = new OffensiveAaFire(this, this);\n-    final BattleStep defensiveAaStep = new DefensiveAaFire(this, this);\n-    steps.add(offensiveAaStep);\n+    final List<BattleStep> startSteps =\n+        List.of(", "originalCommit": "be0258b40ed2caaeedc881ff7a08913614b8bbdf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTI1NDUxMg==", "url": "https://github.com/triplea-game/triplea/pull/7008#discussion_r451254512", "bodyText": "(no-action-needed)   Nit, I suppose a more functional style would inline this list. From that perspective, I think it's a bit more clear the \"update*AAUnits\" calls are side-effects that probably should not be part of this method.", "author": "DanVanAtta", "createdAt": "2020-07-08T03:01:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTI1NDA5NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTI1NTAyNg==", "url": "https://github.com/triplea-game/triplea/pull/7008#discussion_r451255026", "bodyText": "style-nit, the intermediate variable is not really needed here.\nEG:\n new LandParatroopers(MustFightBattle.this, MustFightBattle.this)\n        .execute(stack, bridge);\n\nDo you have a strong preference for the intermediate variable?", "author": "DanVanAtta", "createdAt": "2020-07-08T03:03:03Z", "path": "game-core/src/main/java/games/strategy/triplea/delegate/battle/MustFightBattle.java", "diffHunk": "@@ -1142,35 +1124,38 @@ public void execute(final ExecutionStack stack, final IDelegateBridge bridge) {\n         navalBombardment.execute(stack, bridge);\n       }\n     };\n-    if (firstRun) {\n-      steps.add(\n-          new IExecutable() {\n-            private static final long serialVersionUID = 3389635558184415797L;\n+    // Removed in 2.1\n+    new IExecutable() {\n+      private static final long serialVersionUID = 3389635558184415797L;\n \n-            @Override\n-            public void execute(final ExecutionStack stack, final IDelegateBridge bridge) {\n-              removeNonCombatants(bridge);\n-            }\n-          });\n-      steps.add(\n-          new LandParatroopers() {\n-            private static final long serialVersionUID = 7193353768857658286L;\n+      @Override\n+      public void execute(final ExecutionStack stack, final IDelegateBridge bridge) {\n+        final BattleStep removeNonCombatants = new RemoveNonCombatants(MustFightBattle.this);\n+        removeNonCombatants.execute(stack, bridge);\n+      }\n+    };\n+    // Removed in 2.1\n+    new IExecutable() {\n+      private static final long serialVersionUID = 7193353768857658286L;\n \n-            @Override\n-            public void execute(final ExecutionStack stack, final IDelegateBridge bridge) {\n-              landParatroops(bridge);\n-            }\n-          });\n-      steps.add(\n-          new IExecutable() {\n-            private static final long serialVersionUID = -6676316363537467594L;\n+      @Override\n+      public void execute(final ExecutionStack stack, final IDelegateBridge bridge) {\n+        final BattleStep landParatroopers =", "originalCommit": "be0258b40ed2caaeedc881ff7a08913614b8bbdf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTI2OTMyOA==", "url": "https://github.com/triplea-game/triplea/pull/7008#discussion_r451269328", "bodyText": "No.  I just did it that way the first time and have kept all the other ones similar.  I can switch the style easily.", "author": "trevan", "createdAt": "2020-07-08T04:01:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTI1NTAyNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTI1NTc2MA==", "url": "https://github.com/triplea-game/triplea/pull/7008#discussion_r451255760", "bodyText": "I wonder if this would be more conventional as a constructor.\nIs there any reason to not make this a constructor?", "author": "DanVanAtta", "createdAt": "2020-07-08T03:06:13Z", "path": "game-core/src/main/java/games/strategy/triplea/delegate/battle/steps/change/LandParatroopers.java", "diffHunk": "@@ -0,0 +1,77 @@\n+package games.strategy.triplea.delegate.battle.steps.change;\n+\n+import static games.strategy.triplea.delegate.battle.BattleStepStrings.LAND_PARATROOPS;\n+\n+import games.strategy.engine.data.Unit;\n+import games.strategy.engine.delegate.IDelegateBridge;\n+import games.strategy.triplea.attachments.TechAttachment;\n+import games.strategy.triplea.delegate.ExecutionStack;\n+import games.strategy.triplea.delegate.Matches;\n+import games.strategy.triplea.delegate.battle.BattleActions;\n+import games.strategy.triplea.delegate.battle.BattleState;\n+import games.strategy.triplea.delegate.battle.steps.BattleStep;\n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.List;\n+import lombok.AllArgsConstructor;\n+import org.triplea.java.collections.CollectionUtils;\n+\n+@AllArgsConstructor\n+public class LandParatroopers implements BattleStep {\n+\n+  private static final long serialVersionUID = 3500647439487948115L;\n+\n+  protected final BattleState battleState;\n+\n+  protected final BattleActions battleActions;\n+\n+  @Override\n+  public List<String> getNames() {\n+    final TransportsAndParatroopers transportsAndParatroopers = getTransportsAndParatroopers();\n+\n+    return transportsAndParatroopers.hasParatroopers() ? List.of(LAND_PARATROOPS) : List.of();\n+  }\n+\n+  @Override\n+  public Order getOrder() {\n+    return Order.LAND_PARATROOPERS;\n+  }\n+\n+  @Override\n+  public void execute(final ExecutionStack stack, final IDelegateBridge bridge) {\n+    final TransportsAndParatroopers transportsAndParatroopers = getTransportsAndParatroopers();\n+\n+    if (transportsAndParatroopers.hasParatroopers()) {\n+      battleActions.landParatroopers(\n+          bridge, transportsAndParatroopers.airTransports, transportsAndParatroopers.paratroopers);\n+    }\n+  }\n+\n+  private static class TransportsAndParatroopers {\n+    private Collection<Unit> airTransports = new ArrayList<>();\n+    private Collection<Unit> paratroopers = new ArrayList<>();\n+\n+    private boolean hasParatroopers() {\n+      return !airTransports.isEmpty() && !paratroopers.isEmpty();\n+    }\n+  }\n+\n+  private TransportsAndParatroopers getTransportsAndParatroopers() {", "originalCommit": "be0258b40ed2caaeedc881ff7a08913614b8bbdf", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTI1NzE3Mg==", "url": "https://github.com/triplea-game/triplea/pull/7008#discussion_r451257172", "bodyText": "Is there a plan to move this method to the step logic, or will it be here long-term?\nIt seems like if we are adding a step from MustFightBattle that then does all its work by invoking a method on MustFightBattle that we are not really benefiting a lot and have a lot of indirection. Hence I wonder if this is a temporary situation or perhaps there is a reason this can't be moved?", "author": "DanVanAtta", "createdAt": "2020-07-08T03:12:06Z", "path": "game-core/src/main/java/games/strategy/triplea/delegate/battle/MustFightBattle.java", "diffHunk": "@@ -1394,29 +1380,25 @@ private void removeNonCombatants(final IDelegateBridge bridge) {\n     return unitList;\n   }\n \n-  private void landParatroops(final IDelegateBridge bridge) {\n-    if (TechAttachment.isAirTransportable(attacker)) {\n-      final Collection<Unit> airTransports =\n-          CollectionUtils.getMatches(battleSite.getUnits(), Matches.unitIsAirTransport());\n-      if (!airTransports.isEmpty()) {\n-        final Collection<Unit> dependents = getDependentUnits(airTransports);\n-        if (!dependents.isEmpty()) {\n-          final CompositeChange change = new CompositeChange();\n-          // remove dependency from paratroopers by unloading the air transports\n-          for (final Unit unit : dependents) {\n-            change.add(TransportTracker.unloadAirTransportChange(unit, battleSite, false));\n-          }\n-          bridge.addChange(change);\n-          // remove bombers from dependentUnits\n-          for (final Unit unit : airTransports) {\n-            dependentUnits.remove(unit);\n-          }\n-        }\n-      }\n+  @Override\n+  public void landParatroopers(\n+      final IDelegateBridge bridge,\n+      final Collection<Unit> airTransports,\n+      final Collection<Unit> dependents) {\n+    final CompositeChange change = new CompositeChange();\n+    // remove dependency from paratroopers by unloading the air transports\n+    for (final Unit unit : dependents) {\n+      change.add(TransportTracker.unloadAirTransportChange(unit, battleSite, false));\n+    }\n+    bridge.addChange(change);\n+    // remove bombers from dependentUnits\n+    for (final Unit unit : airTransports) {\n+      dependentUnits.remove(unit);\n     }\n   }\n \n-  private void markNoMovementLeft(final IDelegateBridge bridge) {\n+  @Override\n+  public void markNoMovementLeft(final IDelegateBridge bridge) {", "originalCommit": "be0258b40ed2caaeedc881ff7a08913614b8bbdf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTI3MDAxMA==", "url": "https://github.com/triplea-game/triplea/pull/7008#discussion_r451270010", "bodyText": "Temporary situation.  See my comment above about my goals.", "author": "trevan", "createdAt": "2020-07-08T04:04:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTI1NzE3Mg=="}], "type": "inlineReview"}, {"oid": "b2bdf248354d041f10834313ed4a24402ea2e5c4", "url": "https://github.com/triplea-game/triplea/commit/b2bdf248354d041f10834313ed4a24402ea2e5c4", "message": "Move logic to build TransportsAndParatroopers into its own constructor", "committedDate": "2020-07-08T04:20:09Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTI3NTI1MQ==", "url": "https://github.com/triplea-game/triplea/pull/7008#discussion_r451275251", "bodyText": "Codacy found an issue: Non-static initializers are confusing", "author": "DanVanAtta", "createdAt": "2020-07-08T04:26:40Z", "path": "game-core/src/main/java/games/strategy/triplea/delegate/battle/MustFightBattle.java", "diffHunk": "@@ -1067,27 +1038,39 @@ private void pushFightLoopOnStack(final boolean firstRun) {\n    * still needed. They can be safely removed once save compatibility can be broken.\n    */\n   @VisibleForTesting\n-  public List<IExecutable> getBattleExecutables(final boolean firstRun) {\n+  public List<IExecutable> getBattleExecutables() {\n     final List<IExecutable> steps = new ArrayList<>();\n-    addFightStartSteps(firstRun, steps);\n+    addFightStartSteps(steps);\n     addFightSteps(steps);\n     addCheckEndBattleAndRetreatingSteps(steps);\n     return steps;\n   }\n \n-  private void addFightStartSteps(final boolean firstRun, final List<IExecutable> steps) {\n+  private void addFightStartSteps(final List<IExecutable> steps) {\n     if (offensiveAa == null) {\n       updateOffensiveAaUnits();\n     }\n     if (defendingAa == null) {\n       updateDefendingAaUnits();\n     }\n-    final BattleStep navalBombardment = new NavalBombardment(this, this);\n-    final boolean offensiveAa = canFireOffensiveAa();\n-    final boolean defendingAa = canFireDefendingAa();\n-    final BattleStep offensiveAaStep = new OffensiveAaFire(this, this);\n-    final BattleStep defensiveAaStep = new DefensiveAaFire(this, this);\n-    steps.add(offensiveAaStep);\n+    final List<BattleStep> startSteps =\n+        List.of(\n+            new OffensiveAaFire(this, this),\n+            new DefensiveAaFire(this, this),\n+            new ClearAaCasualties(this, this),\n+            new NavalBombardment(this, this),\n+            new RemoveNonCombatants(this),\n+            new LandParatroopers(this, this),\n+            new MarkNoMovementLeft(this, this));\n+    steps.addAll(\n+        startSteps.stream()\n+            .sorted(Comparator.comparing(BattleStep::getOrder))\n+            .collect(Collectors.toList()));\n+  }\n+\n+  // the IExecutables in this block can be deleted when save compatibility can be broken\n+  {", "originalCommit": "b2bdf248354d041f10834313ed4a24402ea2e5c4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}