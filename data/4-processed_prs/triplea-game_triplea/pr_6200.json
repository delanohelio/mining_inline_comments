{"pr_number": 6200, "pr_title": "Make Territory.getUnits() return an unmodifiable list. (Reland)", "pr_createdAt": "2020-04-12T00:01:44Z", "pr_url": "https://github.com/triplea-game/triplea/pull/6200", "timeline": [{"oid": "dacff1cf0985f878db7c75c6144dd1e9b5ac4ea3", "url": "https://github.com/triplea-game/triplea/commit/dacff1cf0985f878db7c75c6144dd1e9b5ac4ea3", "message": "Make Territory.getUnits() return an unmodifiable list.", "committedDate": "2020-04-11T18:08:48Z", "type": "commit"}, {"oid": "1379a2d68f2892a0250c903a85f7856607a9cd2d", "url": "https://github.com/triplea-game/triplea/commit/1379a2d68f2892a0250c903a85f7856607a9cd2d", "message": "Fix error from making getUnits() unmodifiable.", "committedDate": "2020-04-11T23:46:08Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzEzMjM4NA==", "url": "https://github.com/triplea-game/triplea/pull/6200#discussion_r407132384", "bodyText": "Would it be simpler to have the copy be done once and consistently in the source method?\nIE: UnitCollection.java\n  default Collection<Unit> getUnits() {\n    return getUnitCollection().getUnits();\n  }", "author": "DanVanAtta", "createdAt": "2020-04-12T01:42:45Z", "path": "game-core/src/main/java/games/strategy/triplea/delegate/AbstractPlaceDelegate.java", "diffHunk": "@@ -1652,14 +1652,13 @@ private boolean getCanAllUnitsWithRequiresUnitsBePlacedCorrectly(\n     if (to == null) {\n       return new ArrayList<>();\n     }\n-    final Collection<Unit> unitsInTo = to.getUnits();\n     final Collection<Unit> unitsPlacedAlready = getAlreadyProduced(to);\n     if (Matches.territoryIsWater().test(to)) {\n       for (final Territory current : getAllProducers(to, player, null, true)) {\n         unitsPlacedAlready.addAll(getAlreadyProduced(current));\n       }\n     }\n-    final Collection<Unit> unitsAtStartOfTurnInTo = new ArrayList<>(unitsInTo);\n+    final Collection<Unit> unitsAtStartOfTurnInTo = new ArrayList<>(to.getUnits());", "originalCommit": "1379a2d68f2892a0250c903a85f7856607a9cd2d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzIwNTYzOA==", "url": "https://github.com/triplea-game/triplea/pull/6200#discussion_r407205638", "bodyText": "The whole point is to not copy.\nThe places that are changing are the few places that still need to copy, but those are the ones we don't care about. The point is all the other places are now not copying - and those are the ones that were contributing to the run time.", "author": "asvitkine", "createdAt": "2020-04-12T14:25:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzEzMjM4NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzIyMzI2MQ==", "url": "https://github.com/triplea-game/triplea/pull/6200#discussion_r407223261", "bodyText": "Sorry, mistyped, meant to suggest we do the unmodifiable list copy here.\nIt's not super surprising we see some issues when copying, the usages of this method all seem to assume a constant time operation and invoke the method all over the place, even if the list is not expected to change.", "author": "DanVanAtta", "createdAt": "2020-04-12T16:44:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzEzMjM4NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzQ2OTc0Mg==", "url": "https://github.com/triplea-game/triplea/pull/6200#discussion_r407469742", "bodyText": "I'm still not following your suggestions.\n\"meant to suggest we do the unmodifiable list copy here\"\nThe next line modifies the list copy, so here it needs be modifiable.", "author": "asvitkine", "createdAt": "2020-04-13T13:09:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzEzMjM4NA=="}], "type": "inlineReview"}]}