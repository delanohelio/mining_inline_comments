{"pr_number": 5811, "pr_title": "Use abstract object for retreat", "pr_createdAt": "2020-01-01T18:01:24Z", "pr_url": "https://github.com/triplea-game/triplea/pull/5811", "timeline": [{"oid": "6807595cb25412a9642514f9f08aa105f881f136", "url": "https://github.com/triplea-game/triplea/commit/6807595cb25412a9642514f9f08aa105f881f136", "message": "Use abstract object for retreat", "committedDate": "2020-01-01T17:57:29Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MjMzNTcyMg==", "url": "https://github.com/triplea-game/triplea/pull/5811#discussion_r362335722", "bodyText": "Avoid too many return statements within this method.", "author": "codeclimate", "createdAt": "2020-01-01T18:02:44Z", "path": "game-core/src/main/java/games/strategy/triplea/ui/BattleDisplay.java", "diffHunk": "@@ -478,12 +480,11 @@ private boolean showRetreatDialog(\n             null);\n     if (option == JOptionPane.OK_OPTION) {\n       if (comp.getSelection() != null) {\n-        retreatTo.set(comp.getSelection());\n-        return true;\n+        return RetreatResult.retreatTo(comp.getSelection());\n       }\n     }\n \n-    return false;\n+    return RetreatResult.noResult();", "originalCommit": "6807595cb25412a9642514f9f08aa105f881f136", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "241bd545ef52f01f47bc36d225ea77a4d22e8caa", "url": "https://github.com/triplea-game/triplea/commit/241bd545ef52f01f47bc36d225ea77a4d22e8caa", "message": "Extract action to method", "committedDate": "2020-01-02T10:13:51Z", "type": "commit"}, {"oid": "70bbccc5cb5845c0bc32468c16b941027b9217e8", "url": "https://github.com/triplea-game/triplea/commit/70bbccc5cb5845c0bc32468c16b941027b9217e8", "message": "Unify 2 methods", "committedDate": "2020-01-02T10:21:19Z", "type": "commit"}, {"oid": "e9e7f2cf974ef8466df5f51fcacfb8062a8747aa", "url": "https://github.com/triplea-game/triplea/commit/e9e7f2cf974ef8466df5f51fcacfb8062a8747aa", "message": "Extract to method", "committedDate": "2020-01-02T10:23:02Z", "type": "commit"}, {"oid": "4376e1f735085e4d2356a9ce505af339e24b1363", "url": "https://github.com/triplea-game/triplea/commit/4376e1f735085e4d2356a9ce505af339e24b1363", "message": "Extract common logic", "committedDate": "2020-01-02T10:34:56Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzE2MTAzNA==", "url": "https://github.com/triplea-game/triplea/pull/5811#discussion_r363161034", "bodyText": "This still feels a bit clunky - since it's not just some random player action, but something that returns a RetreatResult.\nHow about just not having this method and inlining it into getRetreat() instead?\ne.g.\nfinal String title;\nfinal Suppler<RetreatResult> showDialog;\nif (!submerge || possible.size() > 1) {\n  title = \"Retreat?\";\n  showDialog = () -> showRetreatDialog(message);\n} else {\n  title = \"Submerge Subs?\";\n  showDialog = () -> showSubmergeDialog(message, possible);\n}\n\nAnd then the inlined SwingAction.of() call.\nOtherwise it's hard to follow what's going on especially since there is a lot of stuff happening in this class already - so adding all these new methods just introduces more complexity.\nAnother option is to move the code into separate classes for the logic, but not sure of the best set up there...\n... If we step back a bit, even with this refactoring, I feel that this class suffers a lot from mixing game logic with Swing UI code. Ultimately we'd probably want to recode things such that low level concepts - like use of JOptionPane - are abstracted away, but the business logic remains. But that's probably too big of a change for what you were after here.\nAnother though - I wonder if the Java Future interface would be better suited here than the combination of CountDownLatch and AtomicReference. Doesn't Future provide exactly what we need?", "author": "asvitkine", "createdAt": "2020-01-06T05:16:23Z", "path": "game-core/src/main/java/games/strategy/triplea/ui/BattleDisplay.java", "diffHunk": "@@ -375,8 +367,33 @@ private Territory getSubmerge(final String message) {\n     return retreatTo.get();\n   }\n \n-  private boolean showSubmergeDialog(\n-      final String message, final AtomicReference<Territory> retreatTo) {\n+  private Action getPlayerAction(", "originalCommit": "4376e1f735085e4d2356a9ce505af339e24b1363", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzI5MTU1Ng==", "url": "https://github.com/triplea-game/triplea/pull/5811#discussion_r363291556", "bodyText": "Using future is an excellent idea, I'll try that.", "author": "RoiEXLab", "createdAt": "2020-01-06T13:26:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzE2MTAzNA=="}], "type": "inlineReview"}, {"oid": "02153221c3aa7fc19b1687f0df8e885a74e6c23b", "url": "https://github.com/triplea-game/triplea/commit/02153221c3aa7fc19b1687f0df8e885a74e6c23b", "message": "Use future instead of latch + atomic reference", "committedDate": "2020-01-06T14:12:47Z", "type": "commit"}, {"oid": "71dd4cd04df181447d798d462477deb2deacd733", "url": "https://github.com/triplea-game/triplea/commit/71dd4cd04df181447d798d462477deb2deacd733", "message": "Inline methods", "committedDate": "2020-01-06T14:22:48Z", "type": "forcePushed"}, {"oid": "71dd4cd04df181447d798d462477deb2deacd733", "url": "https://github.com/triplea-game/triplea/commit/71dd4cd04df181447d798d462477deb2deacd733", "message": "Inline methods", "committedDate": "2020-01-06T14:22:48Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzUzNjA2Mg==", "url": "https://github.com/triplea-game/triplea/pull/5811#discussion_r363536062", "bodyText": "I think you missed the other part of my comment where I suggested not having this getPlayerAction() method and just inlining it here with the changes above, since it's only called once now.", "author": "asvitkine", "createdAt": "2020-01-06T23:48:28Z", "path": "game-core/src/main/java/games/strategy/triplea/ui/BattleDisplay.java", "diffHunk": "@@ -340,43 +349,66 @@ void notifyRetreat(final Collection<Unit> retreating) {\n     attackerModel.notifyRetreat(retreating);\n   }\n \n+  @Nullable\n   Territory getRetreat(\n       final String message, final Collection<Territory> possible, final boolean submerge) {\n-    return (!submerge || possible.size() > 1)\n-        ? getRetreatInternal(message, possible)\n-        : getSubmerge(message);\n-  }\n-\n-  private Territory getSubmerge(final String message) {\n     if (SwingUtilities.isEventDispatchThread()) {\n       throw new IllegalStateException(\"Should not be called from dispatch thread\");\n     }\n-    final AtomicReference<Territory> retreatTo = new AtomicReference<>();\n-    final CountDownLatch latch = new CountDownLatch(1);\n-    final Action action =\n-        SwingAction.of(\n-            \"Submerge Subs?\",\n-            e -> {\n-              actionButton.setEnabled(false);\n-              if (showSubmergeDialog(message, retreatTo)) {\n-                actionButton.setAction(nullAction);\n-                latch.countDown();\n-              }\n-              actionButton.setEnabled(true);\n-            });\n+    final CompletableFuture<Territory> future = new CompletableFuture<>();\n+    final String title;\n+    final Supplier<RetreatResult> supplier;\n+    if (!submerge || possible.size() > 1) {\n+      title = \"Retreat?\";\n+      supplier = () -> showRetreatDialog(message, possible);\n+    } else {\n+      title = \"Submerge Subs?\";\n+      supplier = () -> showSubmergeDialog(message);\n+    }\n+    final Action action = getPlayerAction(title, supplier, future);", "originalCommit": "71dd4cd04df181447d798d462477deb2deacd733", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzUzNzMwMQ==", "url": "https://github.com/triplea-game/triplea/pull/5811#discussion_r363537301", "bodyText": "True, but if the method gets much longer code climate will complain.\nThat's why the method exists.", "author": "RoiEXLab", "createdAt": "2020-01-06T23:53:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzUzNjA2Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzUzNjMzMA==", "url": "https://github.com/triplea-game/triplea/pull/5811#discussion_r363536330", "bodyText": "Nit: Move future to be right above the \"final Action action =\" line.", "author": "asvitkine", "createdAt": "2020-01-06T23:49:38Z", "path": "game-core/src/main/java/games/strategy/triplea/ui/BattleDisplay.java", "diffHunk": "@@ -340,43 +349,66 @@ void notifyRetreat(final Collection<Unit> retreating) {\n     attackerModel.notifyRetreat(retreating);\n   }\n \n+  @Nullable\n   Territory getRetreat(\n       final String message, final Collection<Territory> possible, final boolean submerge) {\n-    return (!submerge || possible.size() > 1)\n-        ? getRetreatInternal(message, possible)\n-        : getSubmerge(message);\n-  }\n-\n-  private Territory getSubmerge(final String message) {\n     if (SwingUtilities.isEventDispatchThread()) {\n       throw new IllegalStateException(\"Should not be called from dispatch thread\");\n     }\n-    final AtomicReference<Territory> retreatTo = new AtomicReference<>();\n-    final CountDownLatch latch = new CountDownLatch(1);\n-    final Action action =\n-        SwingAction.of(\n-            \"Submerge Subs?\",\n-            e -> {\n-              actionButton.setEnabled(false);\n-              if (showSubmergeDialog(message, retreatTo)) {\n-                actionButton.setAction(nullAction);\n-                latch.countDown();\n-              }\n-              actionButton.setEnabled(true);\n-            });\n+    final CompletableFuture<Territory> future = new CompletableFuture<>();", "originalCommit": "71dd4cd04df181447d798d462477deb2deacd733", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzUzNjc1OA==", "url": "https://github.com/triplea-game/triplea/pull/5811#discussion_r363536758", "bodyText": "Seems like this should live somewhere else and be generic to the return type. Since it's using UiContext, perhaps we can add the method on UiContext instead?", "author": "asvitkine", "createdAt": "2020-01-06T23:51:09Z", "path": "game-core/src/main/java/games/strategy/triplea/ui/BattleDisplay.java", "diffHunk": "@@ -340,43 +349,66 @@ void notifyRetreat(final Collection<Unit> retreating) {\n     attackerModel.notifyRetreat(retreating);\n   }\n \n+  @Nullable\n   Territory getRetreat(\n       final String message, final Collection<Territory> possible, final boolean submerge) {\n-    return (!submerge || possible.size() > 1)\n-        ? getRetreatInternal(message, possible)\n-        : getSubmerge(message);\n-  }\n-\n-  private Territory getSubmerge(final String message) {\n     if (SwingUtilities.isEventDispatchThread()) {\n       throw new IllegalStateException(\"Should not be called from dispatch thread\");\n     }\n-    final AtomicReference<Territory> retreatTo = new AtomicReference<>();\n-    final CountDownLatch latch = new CountDownLatch(1);\n-    final Action action =\n-        SwingAction.of(\n-            \"Submerge Subs?\",\n-            e -> {\n-              actionButton.setEnabled(false);\n-              if (showSubmergeDialog(message, retreatTo)) {\n-                actionButton.setAction(nullAction);\n-                latch.countDown();\n-              }\n-              actionButton.setEnabled(true);\n-            });\n+    final CompletableFuture<Territory> future = new CompletableFuture<>();\n+    final String title;\n+    final Supplier<RetreatResult> supplier;\n+    if (!submerge || possible.size() > 1) {\n+      title = \"Retreat?\";\n+      supplier = () -> showRetreatDialog(message, possible);\n+    } else {\n+      title = \"Submerge Subs?\";\n+      supplier = () -> showSubmergeDialog(message);\n+    }\n+    final Action action = getPlayerAction(title, supplier, future);\n     SwingUtilities.invokeLater(\n         () -> {\n           actionButton.setAction(action);\n           action.actionPerformed(null);\n         });\n-    mapPanel.getUiContext().addShutdownLatch(latch);\n-    Interruptibles.await(latch);\n-    mapPanel.getUiContext().removeShutdownLatch(latch);\n-    return retreatTo.get();\n+\n+    return awaitUserInput(future);\n+  }\n+\n+  private Territory awaitUserInput(final CompletableFuture<Territory> future) {\n+    final Active rejectionCallback =\n+        () -> future.completeExceptionally(new RuntimeException(\"Shutting down\"));\n+    try {\n+      mapPanel.getUiContext().addActive(rejectionCallback);\n+      return future.get();\n+    } catch (final InterruptedException e) {\n+      Thread.currentThread().interrupt();\n+    } catch (final ExecutionException e) {\n+      log.log(Level.INFO, \"UiContext shut down before supplying result\", e);\n+    } finally {\n+      mapPanel.getUiContext().removeActive(rejectionCallback);\n+    }\n+    return null;\n+  }", "originalCommit": "71dd4cd04df181447d798d462477deb2deacd733", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzUzOTA1MA==", "url": "https://github.com/triplea-game/triplea/pull/5811#discussion_r363539050", "bodyText": "Valid point, but I saw this kind of pattern in a lot of places, so that would be a larger cleanup.\nI plan renaming removeActive and addActive to addShutdownHook and removeShutdownHook and replace the Active interface with runnable in a follow-up PR.\nI think the current status is definitely an improvement for now, but I agree that it can be improved further.\nI'd move this method as part of this incoming PR then.\nAny further refactoring is not on my priority list though, so it would be up to you in case you want to apply this pattern elsewhere.", "author": "RoiEXLab", "createdAt": "2020-01-07T00:00:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzUzNjc1OA=="}], "type": "inlineReview"}, {"oid": "92d8fa266e2cf9e9f0f2040ef766f0a41e5d8282", "url": "https://github.com/triplea-game/triplea/commit/92d8fa266e2cf9e9f0f2040ef766f0a41e5d8282", "message": "Move line", "committedDate": "2020-01-07T15:17:56Z", "type": "commit"}]}