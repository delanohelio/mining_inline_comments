{"pr_number": 7125, "pr_title": "Add log aggregation to servers", "pr_createdAt": "2020-07-12T04:16:58Z", "pr_url": "https://github.com/triplea-game/triplea/pull/7125", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzI2NTA4Ng==", "url": "https://github.com/triplea-game/triplea/pull/7125#discussion_r453265086", "bodyText": "Argument mixes string and array. Use * or separate argument.", "author": "codeclimate", "createdAt": "2020-07-12T04:20:33Z", "path": "infrastructure/ansible/roles/support/log_aggregation_sender/files/send_logs", "diffHunk": "@@ -0,0 +1,48 @@\n+#!/bin/bash\n+###\n+### Sends the last hours worth of logs to a log aggregation server.\n+### \n+### Usage:\n+###    send_logs [journalctl_name] [log_server]\n+### Example:\n+###    send_logs bot@01 .ssh/logs_key_ed25519 logs@support01.triplea-game.org\n+###      \n+\n+app_name=\"$1\"\n+key_file=\"$2\"\n+log_server=\"$3\"\n+\n+function usage() {\n+  sed -rn 's/^### ?//;T;p' \"$0\"\n+}\n+\n+if [ -z \"$log_server\" ]; then\n+  echo \"Error: Missing arguments, received: '$@'\"", "originalCommit": "1ad517e7edbea4d5acb523d63cf4c891ee3f304a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzI2NTA4OQ==", "url": "https://github.com/triplea-game/triplea/pull/7125#discussion_r453265089", "bodyText": "Double quote to prevent globbing and word splitting.", "author": "codeclimate", "createdAt": "2020-07-12T04:20:34Z", "path": "infrastructure/ansible/roles/support/log_aggregation_sender/files/send_logs", "diffHunk": "@@ -0,0 +1,48 @@\n+#!/bin/bash\n+###\n+### Sends the last hours worth of logs to a log aggregation server.\n+### \n+### Usage:\n+###    send_logs [journalctl_name] [log_server]\n+### Example:\n+###    send_logs bot@01 .ssh/logs_key_ed25519 logs@support01.triplea-game.org\n+###      \n+\n+app_name=\"$1\"\n+key_file=\"$2\"\n+log_server=\"$3\"\n+\n+function usage() {\n+  sed -rn 's/^### ?//;T;p' \"$0\"\n+}\n+\n+if [ -z \"$log_server\" ]; then\n+  echo \"Error: Missing arguments, received: '$@'\"\n+  usage\n+  exit 1\n+fi\n+\n+\n+# This is the file where we will dump the last hours worth of logs\n+log_file=\"$(date -d '-1 hour ago' -u \"+%Y-%m-%d--%H\").$(hostname).$app_name.log\"\n+\n+# Touch the log file so that we have something to send always\n+touch /tmp/$log_file", "originalCommit": "1ad517e7edbea4d5acb523d63cf4c891ee3f304a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzI2NTA5MA==", "url": "https://github.com/triplea-game/triplea/pull/7125#discussion_r453265090", "bodyText": "sudo doesn't affect redirects. Use ..| sudo tee file", "author": "codeclimate", "createdAt": "2020-07-12T04:20:34Z", "path": "infrastructure/ansible/roles/support/log_aggregation_sender/files/send_logs", "diffHunk": "@@ -0,0 +1,48 @@\n+#!/bin/bash\n+###\n+### Sends the last hours worth of logs to a log aggregation server.\n+### \n+### Usage:\n+###    send_logs [journalctl_name] [log_server]\n+### Example:\n+###    send_logs bot@01 .ssh/logs_key_ed25519 logs@support01.triplea-game.org\n+###      \n+\n+app_name=\"$1\"\n+key_file=\"$2\"\n+log_server=\"$3\"\n+\n+function usage() {\n+  sed -rn 's/^### ?//;T;p' \"$0\"\n+}\n+\n+if [ -z \"$log_server\" ]; then\n+  echo \"Error: Missing arguments, received: '$@'\"\n+  usage\n+  exit 1\n+fi\n+\n+\n+# This is the file where we will dump the last hours worth of logs\n+log_file=\"$(date -d '-1 hour ago' -u \"+%Y-%m-%d--%H\").$(hostname).$app_name.log\"\n+\n+# Touch the log file so that we have something to send always\n+touch /tmp/$log_file\n+\n+# Grab the last hours worth of logs from journalctl and dump to file\n+sudo journalctl \\\n+  --since \"$(date -d '1 hour ago' -u \"+%Y-%m-%d %H:00:00 UTC\")\" \\\n+  --until \"$(date -d '1 hour ago' -u \"+%Y-%m-%d %H:59:59 UTC\")\" \\\n+  -u \"$app_name\" > /tmp/$log_file", "originalCommit": "1ad517e7edbea4d5acb523d63cf4c891ee3f304a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzI2NTA5Mg==", "url": "https://github.com/triplea-game/triplea/pull/7125#discussion_r453265092", "bodyText": "Double quote to prevent globbing and word splitting.", "author": "codeclimate", "createdAt": "2020-07-12T04:20:34Z", "path": "infrastructure/ansible/roles/support/log_aggregation_sender/files/send_logs", "diffHunk": "@@ -0,0 +1,48 @@\n+#!/bin/bash\n+###\n+### Sends the last hours worth of logs to a log aggregation server.\n+### \n+### Usage:\n+###    send_logs [journalctl_name] [log_server]\n+### Example:\n+###    send_logs bot@01 .ssh/logs_key_ed25519 logs@support01.triplea-game.org\n+###      \n+\n+app_name=\"$1\"\n+key_file=\"$2\"\n+log_server=\"$3\"\n+\n+function usage() {\n+  sed -rn 's/^### ?//;T;p' \"$0\"\n+}\n+\n+if [ -z \"$log_server\" ]; then\n+  echo \"Error: Missing arguments, received: '$@'\"\n+  usage\n+  exit 1\n+fi\n+\n+\n+# This is the file where we will dump the last hours worth of logs\n+log_file=\"$(date -d '-1 hour ago' -u \"+%Y-%m-%d--%H\").$(hostname).$app_name.log\"\n+\n+# Touch the log file so that we have something to send always\n+touch /tmp/$log_file\n+\n+# Grab the last hours worth of logs from journalctl and dump to file\n+sudo journalctl \\\n+  --since \"$(date -d '1 hour ago' -u \"+%Y-%m-%d %H:00:00 UTC\")\" \\\n+  --until \"$(date -d '1 hour ago' -u \"+%Y-%m-%d %H:59:59 UTC\")\" \\\n+  -u \"$app_name\" > /tmp/$log_file", "originalCommit": "1ad517e7edbea4d5acb523d63cf4c891ee3f304a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzI2NTA5NA==", "url": "https://github.com/triplea-game/triplea/pull/7125#discussion_r453265094", "bodyText": "Note that, unescaped, this expands on the client side.", "author": "codeclimate", "createdAt": "2020-07-12T04:20:34Z", "path": "infrastructure/ansible/roles/support/log_aggregation_sender/files/send_logs", "diffHunk": "@@ -0,0 +1,48 @@\n+#!/bin/bash\n+###\n+### Sends the last hours worth of logs to a log aggregation server.\n+### \n+### Usage:\n+###    send_logs [journalctl_name] [log_server]\n+### Example:\n+###    send_logs bot@01 .ssh/logs_key_ed25519 logs@support01.triplea-game.org\n+###      \n+\n+app_name=\"$1\"\n+key_file=\"$2\"\n+log_server=\"$3\"\n+\n+function usage() {\n+  sed -rn 's/^### ?//;T;p' \"$0\"\n+}\n+\n+if [ -z \"$log_server\" ]; then\n+  echo \"Error: Missing arguments, received: '$@'\"\n+  usage\n+  exit 1\n+fi\n+\n+\n+# This is the file where we will dump the last hours worth of logs\n+log_file=\"$(date -d '-1 hour ago' -u \"+%Y-%m-%d--%H\").$(hostname).$app_name.log\"\n+\n+# Touch the log file so that we have something to send always\n+touch /tmp/$log_file\n+\n+# Grab the last hours worth of logs from journalctl and dump to file\n+sudo journalctl \\\n+  --since \"$(date -d '1 hour ago' -u \"+%Y-%m-%d %H:00:00 UTC\")\" \\\n+  --until \"$(date -d '1 hour ago' -u \"+%Y-%m-%d %H:59:59 UTC\")\" \\\n+  -u \"$app_name\" > /tmp/$log_file\n+\n+\n+# Create the folder on the remote server where we will send the log file\n+log_folder_path=\"/home/admin/logs/$(date +%Y)/$(date +%m)/$(date +%d)\"\n+ssh -i \"$key_file\" \"$log_server\" \"mkdir -p $log_folder_path\"", "originalCommit": "1ad517e7edbea4d5acb523d63cf4c891ee3f304a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzI2NTA5NQ==", "url": "https://github.com/triplea-game/triplea/pull/7125#discussion_r453265095", "bodyText": "Double quote to prevent globbing and word splitting.", "author": "codeclimate", "createdAt": "2020-07-12T04:20:34Z", "path": "infrastructure/ansible/roles/support/log_aggregation_sender/files/send_logs", "diffHunk": "@@ -0,0 +1,48 @@\n+#!/bin/bash\n+###\n+### Sends the last hours worth of logs to a log aggregation server.\n+### \n+### Usage:\n+###    send_logs [journalctl_name] [log_server]\n+### Example:\n+###    send_logs bot@01 .ssh/logs_key_ed25519 logs@support01.triplea-game.org\n+###      \n+\n+app_name=\"$1\"\n+key_file=\"$2\"\n+log_server=\"$3\"\n+\n+function usage() {\n+  sed -rn 's/^### ?//;T;p' \"$0\"\n+}\n+\n+if [ -z \"$log_server\" ]; then\n+  echo \"Error: Missing arguments, received: '$@'\"\n+  usage\n+  exit 1\n+fi\n+\n+\n+# This is the file where we will dump the last hours worth of logs\n+log_file=\"$(date -d '-1 hour ago' -u \"+%Y-%m-%d--%H\").$(hostname).$app_name.log\"\n+\n+# Touch the log file so that we have something to send always\n+touch /tmp/$log_file\n+\n+# Grab the last hours worth of logs from journalctl and dump to file\n+sudo journalctl \\\n+  --since \"$(date -d '1 hour ago' -u \"+%Y-%m-%d %H:00:00 UTC\")\" \\\n+  --until \"$(date -d '1 hour ago' -u \"+%Y-%m-%d %H:59:59 UTC\")\" \\\n+  -u \"$app_name\" > /tmp/$log_file\n+\n+\n+# Create the folder on the remote server where we will send the log file\n+log_folder_path=\"/home/admin/logs/$(date +%Y)/$(date +%m)/$(date +%d)\"\n+ssh -i \"$key_file\" \"$log_server\" \"mkdir -p $log_folder_path\"\n+\n+# Copy the log file to the remote server\n+scp -i \"$key_file\" \"/tmp/$log_file\" \"$log_server:$log_folder_path/$log_file\"\n+\n+# Clean up locally\n+rm /tmp/$log_file", "originalCommit": "1ad517e7edbea4d5acb523d63cf4c891ee3f304a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzI5MTc0NQ==", "url": "https://github.com/triplea-game/triplea/pull/7125#discussion_r453291745", "bodyText": "adm?", "author": "RoiEXLab", "createdAt": "2020-07-12T09:23:10Z", "path": "infrastructure/ansible/roles/system/admin_user/tasks/main.yml", "diffHunk": "@@ -11,7 +11,7 @@\n     shell: /bin/bash\n     create_home: yes\n     append: yes\n-    groups: admin\n+    groups: admin,adm", "originalCommit": "e59eae9a62e4486115d1bae9a4b688774c0262fc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzM0OTQ3NQ==", "url": "https://github.com/triplea-game/triplea/pull/7125#discussion_r453349475", "bodyText": "Of some note, in this update we add 'admin' user to the 'adm' group on\napplication servers to allow 'admin' user sudo-less journalctl. Without\nthat you need to run 'sudo' to be able to view logs for arbitrary systemctl\nservices.", "author": "DanVanAtta", "createdAt": "2020-07-12T18:40:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzI5MTc0NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzM1NzU5Ng==", "url": "https://github.com/triplea-game/triplea/pull/7125#discussion_r453357596", "bodyText": "Ah, missed that part. I was searching for this in the rest of the diff but couldn't find it.\nThanks for clarifying", "author": "RoiEXLab", "createdAt": "2020-07-12T20:04:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzI5MTc0NQ=="}], "type": "inlineReview"}, {"oid": "733ed92ee1c1c1896e500d49c2ab6ab038c143db", "url": "https://github.com/triplea-game/triplea/commit/733ed92ee1c1c1896e500d49c2ab6ab038c143db", "message": "Add log aggregation to servers\n\nSets up log aggregation from the application servers to a support server.\nAn hours worth of logs are dumped from each application using journalctl\nand then SCP'd to the support server.\n\nSummary of log aggregation flow:\n  - cronjob executes on app server each hour, for each application\n    - this creates a log file using journalctl containing the last hours worth of logs\n    - the app server uses \"logs user\" to SCP the log file to aggregration server\n    - app server cleans up the log file\n  - the log server each hour will zip up log files older than 2 hours\n  - the log server each hour will delete log files older than 3 months\n  - the log server each hour will delete empty log folders\n\nOf some note, in this update we add 'admin' user to the 'adm' group on\napplication servers to allow 'admin' user sudo-less journalctl. Without\nthat you need to run 'sudo' to be able to view logs for arbitrary systemctl\nservices.\n\nAs part of this we update inventory and add a 'support01' server that has\nthe aggregration server role\n\nIn sum, two new roles are added:\n- New role: log_aggregation_server\n  - sets up a server to receive log files\n  - adds a 'logs' user with a public key that other hosts will use when performing\n    SCP to copy log files to the host.\n  - log files will land in '/home/admin/logs/2020/...'\n- New role: log_aggregation_sender:\n  - adds the logs user private ssh key to admin user to enable SCP and SSH to the\n    log aggregation server\n  - adds an hourly cronjob to send last hours logs to the aggregation server\n  - adds a 'send_logs' scripts that is invoked by cron that actually sends the log files\n\nThe log files that are sent are controlled by a 'group_var' variable: 'journalctl_applications'. Each\nentry in the application list will be one item where we will query journalctl (ie: journalctl -u 'app01'),\nthereby grabbing the last hours worth of logs and dumping that to a file.", "committedDate": "2020-07-12T18:58:38Z", "type": "commit"}, {"oid": "fe50fe06ead5ebf659114a8a7dd74106bd04f5c6", "url": "https://github.com/triplea-game/triplea/commit/fe50fe06ead5ebf659114a8a7dd74106bd04f5c6", "message": "Fix various shellchecks in 'send_logs' script", "committedDate": "2020-07-12T18:58:38Z", "type": "commit"}, {"oid": "4899b33dbf3f1d0b8c5d82297ca09c849a0fac73", "url": "https://github.com/triplea-game/triplea/commit/4899b33dbf3f1d0b8c5d82297ca09c849a0fac73", "message": "Fix date offset, uses a different syntax compared to journalctl", "committedDate": "2020-07-12T19:07:41Z", "type": "commit"}, {"oid": "4899b33dbf3f1d0b8c5d82297ca09c849a0fac73", "url": "https://github.com/triplea-game/triplea/commit/4899b33dbf3f1d0b8c5d82297ca09c849a0fac73", "message": "Fix date offset, uses a different syntax compared to journalctl", "committedDate": "2020-07-12T19:07:41Z", "type": "forcePushed"}, {"oid": "de970700c63af8ee14bd75b252b8b7d274e34759", "url": "https://github.com/triplea-game/triplea/commit/de970700c63af8ee14bd75b252b8b7d274e34759", "message": "Fix ssh_config file, should be deployed as .ssh/config\n\n- With the config file fixed, place the SSH key to use in that\n  file and simplify the 'send_logs' script to no longer require\n  the SSH key location parameter", "committedDate": "2020-07-12T20:37:40Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzM2MTM0NA==", "url": "https://github.com/triplea-game/triplea/pull/7125#discussion_r453361344", "bodyText": "Note that, unescaped, this expands on the client side.", "author": "codeclimate", "createdAt": "2020-07-12T20:42:59Z", "path": "infrastructure/ansible/roles/support/log_aggregation_sender/files/send_logs", "diffHunk": "@@ -0,0 +1,48 @@\n+#!/bin/bash\n+###\n+### Sends the last hours worth of logs to a log aggregation server.\n+### Key file and user are controlled by .ssh/config\n+### \n+### Usage:\n+###    send_logs [journalctl_name] [log_server]\n+### Example:\n+###    send_logs bot@01 support01.triplea-game.org\n+###      \n+\n+app_name=\"$1\"\n+log_server=\"$2\"\n+\n+function usage() {\n+  sed -rn 's/^### ?//;T;p' \"$0\"\n+}\n+\n+if [ -z \"$log_server\" ]; then\n+  echo \"Error: Missing arguments, received: '$*'\"\n+  usage\n+  exit 1\n+fi\n+\n+\n+# This is the file where we will dump the last hours worth of logs\n+log_file=\"$(date -d '-1 hour' -u \"+%Y-%m-%d--%H\").$(hostname).$app_name.log\"\n+\n+# Touch the log file so that we have something to send always\n+touch \"/tmp/$log_file\"\n+\n+# Grab the last hours worth of logs from journalctl and dump to file\n+journalctl \\\n+  --since \"$(date -d '1 hour ago' -u \"+%Y-%m-%d %H:00:00 UTC\")\" \\\n+  --until \"$(date -d '1 hour ago' -u \"+%Y-%m-%d %H:59:59 UTC\")\" \\\n+  -u \"$app_name\" > \"/tmp/$log_file\"\n+\n+\n+# Create the folder on the remote server where we will send the log file\n+log_folder_path=\"/home/admin/logs/$(date +%Y)/$(date +%m)/$(date +%d)\"\n+ssh \"$log_server\" \"mkdir -p $log_folder_path\"", "originalCommit": "de970700c63af8ee14bd75b252b8b7d274e34759", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}