{"pr_number": 6449, "pr_title": "Make displayed dice rolls span multiple lines and other combat UI improvements", "pr_createdAt": "2020-05-09T13:45:18Z", "pr_url": "https://github.com/triplea-game/triplea/pull/6449", "timeline": [{"oid": "9b66e8fd27573eb1b446c81585c2f835ee4e2f8a", "url": "https://github.com/triplea-game/triplea/commit/9b66e8fd27573eb1b446c81585c2f835ee4e2f8a", "message": "Make displayed dice rolls span multiple lines via a WrapLayout.\n\nThis change improves the display of dice rolls when there's a lot\nof them, by wrapping the dice as opposed to showing them all in\none scrollable line. To accomodate the change, which can increase\nthe height of the containing components, some UI elements are\nrestructured to use an outer scrollpane - particularly the combat\nand history views.", "committedDate": "2020-05-09T13:36:00Z", "type": "commit"}, {"oid": "4a91a276e09e65f08f83aa3d3c9d7b1f78e72e50", "url": "https://github.com/triplea-game/triplea/commit/4a91a276e09e65f08f83aa3d3c9d7b1f78e72e50", "message": "Add missing gridx settings. I accidentally removed these but they are significant.", "committedDate": "2020-05-09T13:56:24Z", "type": "commit"}, {"oid": "225e8697d14ff94f98b9fe70719e82faf81f2189", "url": "https://github.com/triplea-game/triplea/commit/225e8697d14ff94f98b9fe70719e82faf81f2189", "message": "small clean up", "committedDate": "2020-05-09T14:03:05Z", "type": "commit"}, {"oid": "147a2cc87f86e8a7b73bf288e2f4a6173f3157d1", "url": "https://github.com/triplea-game/triplea/commit/147a2cc87f86e8a7b73bf288e2f4a6173f3157d1", "message": "Some improvements based on the code review:\n  - Show total hits on top\n  - Make casualties not part of the scroll pane.\n  - Show number of hits for each dice value", "committedDate": "2020-05-16T13:42:51Z", "type": "commit"}, {"oid": "cf39808141cafb34a82a998fdf6e2d28a55d907f", "url": "https://github.com/triplea-game/triplea/commit/cf39808141cafb34a82a998fdf6e2d28a55d907f", "message": "Make battle window 1024 x 768 if the screen resolution is higher.\nAlso fix a warning.", "committedDate": "2020-05-16T13:56:36Z", "type": "commit"}, {"oid": "a00d5ccefe22271d5c28b6658ace4eba3454f6b6", "url": "https://github.com/triplea-game/triplea/commit/a00d5ccefe22271d5c28b6658ace4eba3454f6b6", "message": "Make hits string singular on one hit", "committedDate": "2020-05-16T14:03:13Z", "type": "commit"}, {"oid": "d237b4669f10f522245b837f4ea1f1591a62393a", "url": "https://github.com/triplea-game/triplea/commit/d237b4669f10f522245b837f4ea1f1591a62393a", "message": "restore missing invalidate/validate/repaint calls", "committedDate": "2020-05-16T14:12:49Z", "type": "commit"}, {"oid": "1e88186860bc4b6e236babbada9990e3991246ab", "url": "https://github.com/triplea-game/triplea/commit/1e88186860bc4b6e236babbada9990e3991246ab", "message": "fix location of bottom label", "committedDate": "2020-05-16T14:23:52Z", "type": "commit"}, {"oid": "04ae31a9d65c2eb24c7080ee1717ac091f27f0db", "url": "https://github.com/triplea-game/triplea/commit/04ae31a9d65c2eb24c7080ee1717ac091f27f0db", "message": "colorize hits; increase text size for total; use correct screen for size check", "committedDate": "2020-05-20T04:02:40Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzgyMzIyNA==", "url": "https://github.com/triplea-game/triplea/pull/6449#discussion_r427823224", "bodyText": "If you want to go for streams\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                int hits = 0;\n          \n          \n            \n                for (final Die die : dice) {\n          \n          \n            \n                  if (die.getType() == Die.DieType.HIT) {\n          \n          \n            \n                    hits++;\n          \n          \n            \n                  }\n          \n          \n            \n                }\n          \n          \n            \n                final long hits = dice.stream().map(Die::getType).filter(Die.DieType.HIT::equals).count();", "author": "RoiEXLab", "createdAt": "2020-05-20T08:15:30Z", "path": "game-core/src/main/java/games/strategy/triplea/ui/DicePanel.java", "diffHunk": "@@ -27,59 +26,82 @@\n   public DicePanel(final UiContext uiContext, final GameData data) {\n     this.uiContext = uiContext;\n     this.data = data;\n-    setLayout(new BoxLayout(this, BoxLayout.Y_AXIS));\n+    setLayout(new GridBagLayout());\n+    setBorder(BorderFactory.createEmptyBorder(8, 16, 0, 0));\n   }\n \n   void setDiceRollForBombing(final List<Die> dice, final int cost) {\n     removeAll();\n+    add(new JLabel(\"Cost: \" + cost, SwingConstants.LEFT));\n     add(create(dice));\n-    add(Box.createVerticalGlue());\n-    add(new JLabel(\"Cost:\" + cost));\n-    invalidate();\n+    addBottomLabel(new JLabel());\n   }\n \n   /** Sets the dice roll to display. */\n   public void setDiceRoll(final DiceRoll diceRoll) {\n-    SwingAction.invokeNowOrLater(\n-        () -> {\n-          removeAll();\n-          for (int i = 1; i <= data.getDiceSides(); i++) {\n-            final List<Die> dice = diceRoll.getRolls(i);\n-            if (dice.isEmpty()) {\n-              continue;\n-            }\n-            add(new JLabel(\"Rolled at \" + i + \":\"));\n-            add(create(diceRoll.getRolls(i)));\n-          }\n-          add(Box.createVerticalGlue());\n-          add(new JLabel(\"Total hits:\" + diceRoll.getHits()));\n-          validate();\n-          invalidate();\n-          repaint();\n-        });\n+    removeAll();\n+    add(\n+        new JLabel(\n+            \"<html><b><font style='font-size:120%'>Total hits: <font color='#8B0000'>\"\n+                + diceRoll.getHits(),\n+            SwingConstants.LEFT));\n+    add(new JSeparator());\n+\n+    for (int i = 1; i <= data.getDiceSides(); i++) {\n+      final List<Die> dice = diceRoll.getRolls(i);\n+      if (dice.isEmpty()) {\n+        continue;\n+      }\n+      add(makeDiceRolledLabel(dice, i));\n+      add(create(dice));\n+    }\n+    addBottomLabel(new JLabel());\n+    invalidate();\n+    validate();\n+    repaint();\n+  }\n+\n+  private JLabel makeDiceRolledLabel(final List<Die> dice, final int value) {\n+    int hits = 0;\n+    for (final Die die : dice) {\n+      if (die.getType() == Die.DieType.HIT) {\n+        hits++;\n+      }\n+    }", "originalCommit": "04ae31a9d65c2eb24c7080ee1717ac091f27f0db", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODAyMTQ4OQ==", "url": "https://github.com/triplea-game/triplea/pull/6449#discussion_r428021489", "bodyText": "Done. Thanks!", "author": "asvitkine", "createdAt": "2020-05-20T13:43:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzgyMzIyNA=="}], "type": "inlineReview"}, {"oid": "76663c0d5a91d1d47351885eedea35b0005e4b22", "url": "https://github.com/triplea-game/triplea/commit/76663c0d5a91d1d47351885eedea35b0005e4b22", "message": "use stream & make a helper for coloring hits", "committedDate": "2020-05-20T13:34:40Z", "type": "commit"}, {"oid": "4caea7ebf6413e62055cbf2df249d4a8344267d5", "url": "https://github.com/triplea-game/triplea/commit/4caea7ebf6413e62055cbf2df249d4a8344267d5", "message": "fix typo", "committedDate": "2020-05-20T13:35:54Z", "type": "commit"}, {"oid": "be1278a75e9d82406a7b41e123e7cdb75244d970", "url": "https://github.com/triplea-game/triplea/commit/be1278a75e9d82406a7b41e123e7cdb75244d970", "message": "Use red with a dark theme instead of dark red.", "committedDate": "2020-05-20T23:25:03Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODM3NTMwOA==", "url": "https://github.com/triplea-game/triplea/pull/6449#discussion_r428375308", "bodyText": "Would you mind adding some unit testing for this function?", "author": "DanVanAtta", "createdAt": "2020-05-21T00:06:25Z", "path": "game-core/src/main/java/games/strategy/engine/framework/lookandfeel/LookAndFeel.java", "diffHunk": "@@ -78,6 +79,18 @@ public static String getDefaultLookAndFeelClassName() {\n             .orElseGet(UIManager::getSystemLookAndFeelClassName);\n   }\n \n+  public static boolean isCurrentLookAndFeelDark() {\n+    final Color background = UIManager.getColor(\"Panel.background\");\n+    return background != null && isColorDark(background);\n+  }\n+\n+  public static boolean isColorDark(final Color color) {", "originalCommit": "be1278a75e9d82406a7b41e123e7cdb75244d970", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTIxNTczMg==", "url": "https://github.com/triplea-game/triplea/pull/6449#discussion_r429215732", "bodyText": "Done.", "author": "asvitkine", "createdAt": "2020-05-22T12:25:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODM3NTMwOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODM3NTkwMA==", "url": "https://github.com/triplea-game/triplea/pull/6449#discussion_r428375900", "bodyText": "minor, any objections to extracting \"#8B0000\" to a named constant? EG: \"DARKER_RED\"", "author": "DanVanAtta", "createdAt": "2020-05-21T00:08:35Z", "path": "game-core/src/main/java/games/strategy/triplea/ui/DicePanel.java", "diffHunk": "@@ -69,7 +70,9 @@ private JLabel makeDiceRolledLabel(final List<Die> dice, final int value) {\n   }\n \n   private static String colorizeHitString(final Object hitsString) {\n-    return \"<font color='#8B0000'>\" + hitsString + \"</font>\";\n+    // On a dark theme, use red. Use a darker red with a light theme.\n+    final String color = LookAndFeel.isCurrentLookAndFeelDark() ? \"red\" : \"#8B0000\";", "originalCommit": "be1278a75e9d82406a7b41e123e7cdb75244d970", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODY1MjQwNg==", "url": "https://github.com/triplea-game/triplea/pull/6449#discussion_r428652406", "bodyText": "Done.", "author": "asvitkine", "createdAt": "2020-05-21T13:31:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODM3NTkwMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODM3Njc1NA==", "url": "https://github.com/triplea-game/triplea/pull/6449#discussion_r428376754", "bodyText": "FWIW, there is a type-safe builder for GridBagConstraints that can be used.\nIs gridy default to 0, if so, do we need to set gridx to 0 as well on line 91?", "author": "DanVanAtta", "createdAt": "2020-05-21T00:11:36Z", "path": "game-core/src/main/java/games/strategy/triplea/ui/DicePanel.java", "diffHunk": "@@ -27,59 +27,80 @@\n   public DicePanel(final UiContext uiContext, final GameData data) {\n     this.uiContext = uiContext;\n     this.data = data;\n-    setLayout(new BoxLayout(this, BoxLayout.Y_AXIS));\n+    setLayout(new GridBagLayout());\n+    setBorder(BorderFactory.createEmptyBorder(8, 16, 0, 0));\n   }\n \n   void setDiceRollForBombing(final List<Die> dice, final int cost) {\n     removeAll();\n+    add(new JLabel(\"Cost: \" + cost, SwingConstants.LEFT));\n     add(create(dice));\n-    add(Box.createVerticalGlue());\n-    add(new JLabel(\"Cost:\" + cost));\n-    invalidate();\n+    addBottomLabel(new JLabel());\n   }\n \n   /** Sets the dice roll to display. */\n   public void setDiceRoll(final DiceRoll diceRoll) {\n-    SwingAction.invokeNowOrLater(\n-        () -> {\n-          removeAll();\n-          for (int i = 1; i <= data.getDiceSides(); i++) {\n-            final List<Die> dice = diceRoll.getRolls(i);\n-            if (dice.isEmpty()) {\n-              continue;\n-            }\n-            add(new JLabel(\"Rolled at \" + i + \":\"));\n-            add(create(diceRoll.getRolls(i)));\n-          }\n-          add(Box.createVerticalGlue());\n-          add(new JLabel(\"Total hits:\" + diceRoll.getHits()));\n-          validate();\n-          invalidate();\n-          repaint();\n-        });\n+    removeAll();\n+    final String hitsString = colorizeHitString(diceRoll.getHits());\n+    add(\n+        new JLabel(\n+            \"<html><b><font style='font-size:120%'>Total hits: \" + hitsString,\n+            SwingConstants.LEFT));\n+    add(new JSeparator());\n+\n+    for (int i = 1; i <= data.getDiceSides(); i++) {\n+      final List<Die> dice = diceRoll.getRolls(i);\n+      if (dice.isEmpty()) {\n+        continue;\n+      }\n+      add(makeDiceRolledLabel(dice, i));\n+      add(create(dice));\n+    }\n+    addBottomLabel(new JLabel());\n+    invalidate();\n+    validate();\n+    repaint();\n+  }\n+\n+  private JLabel makeDiceRolledLabel(final List<Die> dice, final int value) {\n+    final long hits = dice.stream().map(Die::getType).filter(Die.DieType.HIT::equals).count();\n+    final String countString = dice.size() == 1 ? \"1 die\" : dice.size() + \" dice\";\n+    final String hitsString = colorizeHitString(hits == 1 ? \"1 hit\" : hits + \" hits\");\n+    return new JLabel(\"<html><b>Rolled \" + countString + \" at \" + value + \" (\" + hitsString + \"):\");\n+  }\n+\n+  private static String colorizeHitString(final Object hitsString) {\n+    // On a dark theme, use red. Use a darker red with a light theme.\n+    final String color = LookAndFeel.isCurrentLookAndFeelDark() ? \"red\" : \"#8B0000\";\n+    return \"<font color='\" + color + \"'>\" + hitsString + \"</font>\";\n+  }\n+\n+  private void add(final JComponent component) {\n+    final GridBagConstraints constraints = new GridBagConstraints();\n+    constraints.fill = GridBagConstraints.HORIZONTAL;\n+    constraints.weightx = 1;\n+    constraints.gridx = 0;\n+    add(component, constraints);\n+  }\n+\n+  private void addBottomLabel(final JLabel label) {\n+    final GridBagConstraints constraints = new GridBagConstraints();", "originalCommit": "be1278a75e9d82406a7b41e123e7cdb75244d970", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODY1MDE1OA==", "url": "https://github.com/triplea-game/triplea/pull/6449#discussion_r428650158", "bodyText": "No, the default value is \"RELATIVE\", not 0.", "author": "asvitkine", "createdAt": "2020-05-21T13:27:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODM3Njc1NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTIxNzAwOA==", "url": "https://github.com/triplea-game/triplea/pull/6449#discussion_r429217008", "bodyText": "Looks like GridBagConstraintsBuilder doesn't support setting gridy to GridBagConstraints.RELATIVE. So let's stick with this. A future PR can always expand the functionality of GridBagConstraintsBuilder to support this use case and refactor this code, if someone wants to contribute (from my perspective, I'm not sure it would add much since the current code isn't very convoluted - and might be more confusing with the extra abstraction).", "author": "asvitkine", "createdAt": "2020-05-22T12:28:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODM3Njc1NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTU3MzE5OQ==", "url": "https://github.com/triplea-game/triplea/pull/6449#discussion_r429573199", "bodyText": "Ah, wasn't aware of the limitation. I'm not sure I'd call the type-safe builders necessarily abstraction; regardless, I do agree the current code is pretty straight forward.", "author": "DanVanAtta", "createdAt": "2020-05-23T19:47:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODM3Njc1NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODM3NzIyOQ==", "url": "https://github.com/triplea-game/triplea/pull/6449#discussion_r428377229", "bodyText": "Any objection to having the bottom label be returned from the function? As is, the method addBottomLabel relies on side effects. To understand what is happening, you have to dive into the method, which lacks abstraction. We also have some inconsistency from the other methods that add returned values compared to this last one that adds a component as a side-effect.", "author": "DanVanAtta", "createdAt": "2020-05-21T00:13:18Z", "path": "game-core/src/main/java/games/strategy/triplea/ui/DicePanel.java", "diffHunk": "@@ -27,59 +27,80 @@\n   public DicePanel(final UiContext uiContext, final GameData data) {\n     this.uiContext = uiContext;\n     this.data = data;\n-    setLayout(new BoxLayout(this, BoxLayout.Y_AXIS));\n+    setLayout(new GridBagLayout());\n+    setBorder(BorderFactory.createEmptyBorder(8, 16, 0, 0));\n   }\n \n   void setDiceRollForBombing(final List<Die> dice, final int cost) {\n     removeAll();\n+    add(new JLabel(\"Cost: \" + cost, SwingConstants.LEFT));\n     add(create(dice));\n-    add(Box.createVerticalGlue());\n-    add(new JLabel(\"Cost:\" + cost));\n-    invalidate();\n+    addBottomLabel(new JLabel());", "originalCommit": "be1278a75e9d82406a7b41e123e7cdb75244d970", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODY1MDY4NA==", "url": "https://github.com/triplea-game/triplea/pull/6449#discussion_r428650684", "bodyText": "Uhm, it's not a side effect, it's the main purpose of the function?", "author": "asvitkine", "createdAt": "2020-05-21T13:28:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODM3NzIyOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODY1NTAzNQ==", "url": "https://github.com/triplea-game/triplea/pull/6449#discussion_r428655035", "bodyText": "Oh, do you mean the setVerticalAlignment() call?\nGiven that we no longer use a label with content (before, we used to for total hits) and this is just for taking up the remaining vertical space, we can simplify it. Done.", "author": "asvitkine", "createdAt": "2020-05-21T13:36:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODM3NzIyOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODM3Nzk1NA==", "url": "https://github.com/triplea-game/triplea/pull/6449#discussion_r428377954", "bodyText": "nit: changing serialVersionUID strings of swing components should not be necessary. I'm not sure there is consensus whether we should default serialVersoinId to a simple 1L. In essence, I'd recommend to not go out of your way to change them unless it's intentional/necessary.", "author": "DanVanAtta", "createdAt": "2020-05-21T00:15:47Z", "path": "game-core/src/main/java/games/strategy/triplea/ui/history/HistoryDetailsPanel.java", "diffHunk": "@@ -35,32 +38,39 @@\n  * </ul>\n  */\n public class HistoryDetailsPanel extends JPanel {\n-  private static final long serialVersionUID = 5092004144144006960L;", "originalCommit": "be1278a75e9d82406a7b41e123e7cdb75244d970", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODY1MjI3NA==", "url": "https://github.com/triplea-game/triplea/pull/6449#discussion_r428652274", "bodyText": "Reverted. I wonder if there's some project setting we could set to disable warnings about these missing members for swing classes? The only reason we have these useless things is to silence the warnings AFAIK.", "author": "asvitkine", "createdAt": "2020-05-21T13:31:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODM3Nzk1NA=="}], "type": "inlineReview"}, {"oid": "0419f0f373b17b6abfed562381adb9b2445994de", "url": "https://github.com/triplea-game/triplea/commit/0419f0f373b17b6abfed562381adb9b2445994de", "message": "Address some comments. More later.", "committedDate": "2020-05-21T13:40:25Z", "type": "commit"}, {"oid": "78465d46cb5c9b75ef3a301da53365153705da17", "url": "https://github.com/triplea-game/triplea/commit/78465d46cb5c9b75ef3a301da53365153705da17", "message": "Add new unit test.", "committedDate": "2020-05-22T12:24:27Z", "type": "commit"}, {"oid": "ac0bca8846d420051529ba35cf70b4f42692679e", "url": "https://github.com/triplea-game/triplea/commit/ac0bca8846d420051529ba35cf70b4f42692679e", "message": "small clean ups", "committedDate": "2020-05-22T12:45:45Z", "type": "commit"}]}