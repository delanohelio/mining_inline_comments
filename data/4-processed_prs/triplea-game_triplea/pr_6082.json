{"pr_number": 6082, "pr_title": "Group backend services", "pr_createdAt": "2020-03-24T04:58:13Z", "pr_url": "https://github.com/triplea-game/triplea/pull/6082", "timeline": [{"oid": "e82189e0e272f2a40045e6aa2b28fa9c3b343f68", "url": "https://github.com/triplea-game/triplea/commit/e82189e0e272f2a40045e6aa2b28fa9c3b343f68", "message": "Re-group spitfire server packages\n\nFixes a few package organization issues that have been lingering\nand preps for design changes to server action handling.\n\n- group moderation package together\n- create a concept of 'modules', meant to represent the business domains.\n  We still will have strongly cohesive modules that contain all necessary\n  components to accomplish a functionality (controller+service)\n- move web.socket connection components to a new package", "committedDate": "2020-03-24T02:31:15Z", "type": "commit"}, {"oid": "36e712c8ec7ac5f063ceb678ce2c3101bdf1e212", "url": "https://github.com/triplea-game/triplea/commit/36e712c8ec7ac5f063ceb678ce2c3101bdf1e212", "message": "Combine moderator ban controllers\n\nThe first moderator ban controller was built to enable the moderator toolbox.\nWe had a second one come about to support the moderator right-click-ban menu\noption. This update combines the two.\n\nA bit forward looking, this update adds factory methods directly on the classes\nbeing instantiated. A follow-up update is planned to make this pattern of\nfactory insantiation to be consistent.", "committedDate": "2020-03-24T04:53:10Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjkwMjk5Mg==", "url": "https://github.com/triplea-game/triplea/pull/6082#discussion_r396902992", "bodyText": "Similar blocks of code found in 2 locations. Consider refactoring.", "author": "codeclimate", "createdAt": "2020-03-24T04:59:39Z", "path": "http-server/src/main/java/org/triplea/db/dao/username/ban/UsernameBanRecord.java", "diffHunk": "@@ -1,12 +1,12 @@\n-package org.triplea.lobby.server.db.dao.username.ban;\n+package org.triplea.db.dao.username.ban;", "originalCommit": "36e712c8ec7ac5f063ceb678ce2c3101bdf1e212", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjkwMjk5NQ==", "url": "https://github.com/triplea-game/triplea/pull/6082#discussion_r396902995", "bodyText": "Similar blocks of code found in 2 locations. Consider refactoring.", "author": "codeclimate", "createdAt": "2020-03-24T04:59:39Z", "path": "http-server/src/main/java/org/triplea/db/data/ModeratorUserDaoData.java", "diffHunk": "@@ -1,12 +1,12 @@\n-package org.triplea.lobby.server.db.data;\n+package org.triplea.db.data;", "originalCommit": "36e712c8ec7ac5f063ceb678ce2c3101bdf1e212", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjkwMjk5Ng==", "url": "https://github.com/triplea-game/triplea/pull/6082#discussion_r396902996", "bodyText": "Method banUser has 28 lines of code (exceeds 25 allowed). Consider refactoring.", "author": "codeclimate", "createdAt": "2020-03-24T04:59:39Z", "path": "http-server/src/main/java/org/triplea/modules/moderation/ban/user/UserBanService.java", "diffHunk": "@@ -0,0 +1,164 @@\n+package org.triplea.modules.moderation.ban.user;\n+\n+import java.util.Collection;\n+import java.util.List;\n+import java.util.UUID;\n+import java.util.function.BiConsumer;\n+import java.util.function.Supplier;\n+import java.util.stream.Collectors;\n+import javax.annotation.Nonnull;\n+import javax.websocket.Session;\n+import lombok.Builder;\n+import org.jdbi.v3.core.Jdbi;\n+import org.triplea.db.dao.ModeratorAuditHistoryDao;\n+import org.triplea.db.dao.api.key.ApiKeyDaoWrapper;\n+import org.triplea.db.dao.api.key.GamePlayerLookup;\n+import org.triplea.db.dao.user.ban.UserBanDao;\n+import org.triplea.domain.data.PlayerChatId;\n+import org.triplea.domain.data.UserName;\n+import org.triplea.http.client.IpAddressParser;\n+import org.triplea.http.client.lobby.chat.messages.server.ChatServerEnvelopeFactory;\n+import org.triplea.http.client.lobby.moderator.BanDurationFormatter;\n+import org.triplea.http.client.lobby.moderator.BanPlayerRequest;\n+import org.triplea.http.client.lobby.moderator.toolbox.banned.user.UserBanData;\n+import org.triplea.http.client.lobby.moderator.toolbox.banned.user.UserBanParams;\n+import org.triplea.http.client.web.socket.messages.ServerMessageEnvelope;\n+import org.triplea.modules.chat.event.processing.Chatters;\n+import org.triplea.modules.moderation.remote.actions.RemoteActionsEventQueue;\n+import org.triplea.web.socket.MessageBroadcaster;\n+\n+/**\n+ * Service layer for managing user bans, get bans, add and remove. User bans are done by MAC and IP\n+ * address, they are removed by the 'public ban id' that is assigned when a ban is issued.\n+ */\n+@Builder\n+public class UserBanService {\n+\n+  @Nonnull private final ModeratorAuditHistoryDao moderatorAuditHistoryDao;\n+  @Nonnull private final UserBanDao userBanDao;\n+  @Nonnull private final Supplier<String> publicIdSupplier;\n+  @Nonnull private final Chatters chatters;\n+  @Nonnull private final RemoteActionsEventQueue remoteActionsEventQueue;\n+  @Nonnull private final ApiKeyDaoWrapper apiKeyDaoWrapper;\n+  @Nonnull private final BiConsumer<Collection<Session>, ServerMessageEnvelope> messageBroadcaster;\n+\n+  public static UserBanService build(\n+      final Jdbi jdbi,\n+      final Chatters chatters,\n+      final RemoteActionsEventQueue remoteActionsEventQueue) {\n+\n+    return UserBanService.builder()\n+        .moderatorAuditHistoryDao(jdbi.onDemand(ModeratorAuditHistoryDao.class))\n+        .userBanDao(jdbi.onDemand(UserBanDao.class))\n+        .publicIdSupplier(() -> UUID.randomUUID().toString())\n+        .chatters(chatters)\n+        .remoteActionsEventQueue(remoteActionsEventQueue)\n+        .apiKeyDaoWrapper(ApiKeyDaoWrapper.build(jdbi))\n+        .messageBroadcaster(MessageBroadcaster.build())\n+        .build();\n+  }\n+\n+  List<UserBanData> getBannedUsers() {\n+    return userBanDao.lookupBans().stream()\n+        .map(\n+            daoData ->\n+                UserBanData.builder()\n+                    .banId(daoData.getPublicBanId())\n+                    .username(daoData.getUsername())\n+                    .hashedMac(daoData.getSystemId())\n+                    .ip(daoData.getIp())\n+                    .banDate(daoData.getDateCreated())\n+                    .banExpiry(daoData.getBanExpiry())\n+                    .build())\n+        .collect(Collectors.toList());\n+  }\n+\n+  boolean removeUserBan(final int moderatorId, final String banId) {\n+    final String unbanName = userBanDao.lookupUsernameByBanId(banId).orElse(null);\n+    if (userBanDao.removeBan(banId) != 1) {\n+      return false;\n+    }\n+    if (unbanName == null) {\n+      throw new IllegalStateException(\n+          \"Consistency error, unbanned \"\n+              + banId\n+              + \", but \"\n+              + \"there was no matching name for that ban.\");\n+    }\n+\n+    moderatorAuditHistoryDao.addAuditRecord(\n+        ModeratorAuditHistoryDao.AuditArgs.builder()\n+            .actionName(ModeratorAuditHistoryDao.AuditAction.REMOVE_USER_BAN)\n+            .actionTarget(unbanName)\n+            .moderatorUserId(moderatorId)\n+            .build());\n+    return true;\n+  }\n+\n+  boolean banUser(final int moderatorId, final BanPlayerRequest banPlayerRequest) {\n+    return apiKeyDaoWrapper\n+        .lookupPlayerByChatId(PlayerChatId.of(banPlayerRequest.getPlayerChatId()))\n+        .map(\n+            gamePlayerLookup -> toUserBanParams(gamePlayerLookup, banPlayerRequest.getBanMinutes()))\n+        .map(banUserParams -> banUser(moderatorId, banUserParams))\n+        .orElse(false);\n+  }\n+\n+  boolean banUser(final int moderatorId, final UserBanParams banUserParams) {", "originalCommit": "36e712c8ec7ac5f063ceb678ce2c3101bdf1e212", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjkwMjk5Nw==", "url": "https://github.com/triplea-game/triplea/pull/6082#discussion_r396902997", "bodyText": "Similar blocks of code found in 2 locations. Consider refactoring.", "author": "codeclimate", "createdAt": "2020-03-24T04:59:40Z", "path": "http-server/src/main/java/org/triplea/modules/moderation/ban/user/UserBanService.java", "diffHunk": "@@ -0,0 +1,164 @@\n+package org.triplea.modules.moderation.ban.user;\n+\n+import java.util.Collection;\n+import java.util.List;\n+import java.util.UUID;\n+import java.util.function.BiConsumer;\n+import java.util.function.Supplier;\n+import java.util.stream.Collectors;\n+import javax.annotation.Nonnull;\n+import javax.websocket.Session;\n+import lombok.Builder;\n+import org.jdbi.v3.core.Jdbi;\n+import org.triplea.db.dao.ModeratorAuditHistoryDao;\n+import org.triplea.db.dao.api.key.ApiKeyDaoWrapper;\n+import org.triplea.db.dao.api.key.GamePlayerLookup;\n+import org.triplea.db.dao.user.ban.UserBanDao;\n+import org.triplea.domain.data.PlayerChatId;\n+import org.triplea.domain.data.UserName;\n+import org.triplea.http.client.IpAddressParser;\n+import org.triplea.http.client.lobby.chat.messages.server.ChatServerEnvelopeFactory;\n+import org.triplea.http.client.lobby.moderator.BanDurationFormatter;\n+import org.triplea.http.client.lobby.moderator.BanPlayerRequest;\n+import org.triplea.http.client.lobby.moderator.toolbox.banned.user.UserBanData;\n+import org.triplea.http.client.lobby.moderator.toolbox.banned.user.UserBanParams;\n+import org.triplea.http.client.web.socket.messages.ServerMessageEnvelope;\n+import org.triplea.modules.chat.event.processing.Chatters;\n+import org.triplea.modules.moderation.remote.actions.RemoteActionsEventQueue;\n+import org.triplea.web.socket.MessageBroadcaster;\n+\n+/**\n+ * Service layer for managing user bans, get bans, add and remove. User bans are done by MAC and IP\n+ * address, they are removed by the 'public ban id' that is assigned when a ban is issued.\n+ */\n+@Builder\n+public class UserBanService {\n+\n+  @Nonnull private final ModeratorAuditHistoryDao moderatorAuditHistoryDao;\n+  @Nonnull private final UserBanDao userBanDao;\n+  @Nonnull private final Supplier<String> publicIdSupplier;\n+  @Nonnull private final Chatters chatters;\n+  @Nonnull private final RemoteActionsEventQueue remoteActionsEventQueue;\n+  @Nonnull private final ApiKeyDaoWrapper apiKeyDaoWrapper;\n+  @Nonnull private final BiConsumer<Collection<Session>, ServerMessageEnvelope> messageBroadcaster;\n+\n+  public static UserBanService build(\n+      final Jdbi jdbi,\n+      final Chatters chatters,\n+      final RemoteActionsEventQueue remoteActionsEventQueue) {\n+\n+    return UserBanService.builder()\n+        .moderatorAuditHistoryDao(jdbi.onDemand(ModeratorAuditHistoryDao.class))\n+        .userBanDao(jdbi.onDemand(UserBanDao.class))\n+        .publicIdSupplier(() -> UUID.randomUUID().toString())\n+        .chatters(chatters)\n+        .remoteActionsEventQueue(remoteActionsEventQueue)\n+        .apiKeyDaoWrapper(ApiKeyDaoWrapper.build(jdbi))\n+        .messageBroadcaster(MessageBroadcaster.build())\n+        .build();\n+  }\n+\n+  List<UserBanData> getBannedUsers() {\n+    return userBanDao.lookupBans().stream()\n+        .map(\n+            daoData ->\n+                UserBanData.builder()", "originalCommit": "36e712c8ec7ac5f063ceb678ce2c3101bdf1e212", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "9f708e55495be8229f6c5a6c79f11b5199732ca9", "url": "https://github.com/triplea-game/triplea/commit/9f708e55495be8229f6c5a6c79f11b5199732ca9", "message": "Update jar path to main class \"ServerApplication\"", "committedDate": "2020-03-24T05:34:21Z", "type": "commit"}]}