{"pr_number": 6354, "pr_title": "Add lobby right-click menu for moderators: \"Show Player Information\"", "pr_createdAt": "2020-04-30T05:34:09Z", "pr_url": "https://github.com/triplea-game/triplea/pull/6354", "timeline": [{"oid": "8511cb9772885e507778dcb5e0bc748b386ee896", "url": "https://github.com/triplea-game/triplea/commit/8511cb9772885e507778dcb5e0bc748b386ee896", "message": "Add lobby right-click menu for moderators: \"Show Player Information\"\n\nThis update adds an equivalent right-click menu feature that was in 1.9\nwhere moderators can click chatter names in lobby and select 'show player\ninformation'.\n\nThe player information panel shows a copy-pastable summary of the\nplayers name, IP and system-id and currently two tabs: aliases & bans.\n\nThe aliases are obtained from a lobby query and database fetch where we\nsearch the 'access log' table for the player IPs or system-ids matching\nthe current user and return matching records.\n\nWe fetch player aliases limited to the last 'n' days, bans we will\nfetch all that we have on record.\n\nChange listing:\n- add UI component to show player information\n- add two tab UI components to show player ban and alias information in a table\n- add a client query to ModeratorChatClient to fetch player information\n- add a controller endpoint to service this query, restriced to moderator access\n- add a player information module on server side to aggregate and fetch\n  player information from database.\n- add a player information DAO with JDBI return data types to query database\n  for bans and aliases.", "committedDate": "2020-04-30T05:33:16Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzc2MzQ5Mg==", "url": "https://github.com/triplea-game/triplea/pull/6354#discussion_r417763492", "bodyText": "Similar blocks of code found in 2 locations. Consider refactoring.", "author": "codeclimate", "createdAt": "2020-04-30T05:36:00Z", "path": "http-server/src/test/java/org/triplea/db/dao/moderator/player/info/PlayerInfoForModeratorDaoTest.java", "diffHunk": "@@ -0,0 +1,154 @@\n+package org.triplea.db.dao.moderator.player.info;\n+\n+import static org.hamcrest.MatcherAssert.assertThat;\n+import static org.hamcrest.collection.IsCollectionWithSize.hasSize;\n+import static org.hamcrest.collection.IsEmptyCollection.empty;\n+import static org.hamcrest.core.Is.is;\n+import static org.triplea.test.common.IsInstant.isInstant;\n+\n+import com.github.database.rider.core.api.dataset.DataSet;\n+import java.util.List;\n+import org.junit.jupiter.api.Nested;\n+import org.junit.jupiter.api.Test;\n+import org.triplea.db.dao.DaoTest;\n+\n+class PlayerInfoForModeratorDaoTest extends DaoTest {\n+\n+  private final PlayerInfoForModeratorDao playerInfoForModeratorDao =\n+      DaoTest.newDao(PlayerInfoForModeratorDao.class);\n+\n+  @Nested\n+  @DataSet(\n+      cleanBefore = true,\n+      value = \"moderator_player_lookup/lookup_player_aliases_select_data.yml\")\n+  class LookupPlayerAliases {\n+    @Test\n+    void lookupEmptyCase() {\n+      final List<PlayerAliasRecord> results =\n+          playerInfoForModeratorDao.lookupPlayerAliasRecords(\"system-id-dne\", \"9.9.9.9\");\n+\n+      assertThat(results, is(empty()));\n+    }\n+\n+    @Test\n+    void lookupByBothSystemIdAndIp() {\n+      final List<PlayerAliasRecord> results =\n+          playerInfoForModeratorDao.lookupPlayerAliasRecords(\"system-id\", \"1.1.1.1\");\n+\n+      assertThat(\n+          \"There are 6 records in the dataset, \"\n+              + \"we expect 4 to match, and 2 of them to be de-duped by name\"\n+              + \"with only the most recent de-duped record returned\",\n+          results,\n+          hasSize(3));\n+\n+      assertThat(results.get(0).getUsername(), is(\"name3\"));\n+      assertThat(results.get(0).getIp(), is(\"2.2.2.2\"));\n+      assertThat(results.get(0).getSystemId(), is(\"system-id\"));\n+      assertThat(results.get(0).getDate(), isInstant(2154, 1, 1, 23, 59, 20));\n+\n+      assertThat(results.get(1).getUsername(), is(\"name2\"));\n+      assertThat(results.get(1).getIp(), is(\"1.1.1.1\"));\n+      assertThat(results.get(1).getSystemId(), is(\"system-id2\"));\n+      assertThat(results.get(1).getDate(), isInstant(2152, 1, 1, 23, 59, 20));\n+\n+      assertThat(results.get(2).getUsername(), is(\"name1\"));\n+      assertThat(results.get(2).getIp(), is(\"1.1.1.1\"));\n+      assertThat(results.get(2).getSystemId(), is(\"system-id\"));\n+      assertThat(results.get(2).getDate(), isInstant(2151, 1, 1, 23, 59, 20));\n+    }\n+\n+    @Test", "originalCommit": "8511cb9772885e507778dcb5e0bc748b386ee896", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzc2MzQ5NQ==", "url": "https://github.com/triplea-game/triplea/pull/6354#discussion_r417763495", "bodyText": "Similar blocks of code found in 2 locations. Consider refactoring.", "author": "codeclimate", "createdAt": "2020-04-30T05:36:00Z", "path": "http-server/src/test/java/org/triplea/db/dao/moderator/player/info/PlayerInfoForModeratorDaoTest.java", "diffHunk": "@@ -0,0 +1,154 @@\n+package org.triplea.db.dao.moderator.player.info;\n+\n+import static org.hamcrest.MatcherAssert.assertThat;\n+import static org.hamcrest.collection.IsCollectionWithSize.hasSize;\n+import static org.hamcrest.collection.IsEmptyCollection.empty;\n+import static org.hamcrest.core.Is.is;\n+import static org.triplea.test.common.IsInstant.isInstant;\n+\n+import com.github.database.rider.core.api.dataset.DataSet;\n+import java.util.List;\n+import org.junit.jupiter.api.Nested;\n+import org.junit.jupiter.api.Test;\n+import org.triplea.db.dao.DaoTest;\n+\n+class PlayerInfoForModeratorDaoTest extends DaoTest {\n+\n+  private final PlayerInfoForModeratorDao playerInfoForModeratorDao =\n+      DaoTest.newDao(PlayerInfoForModeratorDao.class);\n+\n+  @Nested\n+  @DataSet(\n+      cleanBefore = true,\n+      value = \"moderator_player_lookup/lookup_player_aliases_select_data.yml\")\n+  class LookupPlayerAliases {\n+    @Test\n+    void lookupEmptyCase() {\n+      final List<PlayerAliasRecord> results =\n+          playerInfoForModeratorDao.lookupPlayerAliasRecords(\"system-id-dne\", \"9.9.9.9\");\n+\n+      assertThat(results, is(empty()));\n+    }\n+\n+    @Test\n+    void lookupByBothSystemIdAndIp() {\n+      final List<PlayerAliasRecord> results =\n+          playerInfoForModeratorDao.lookupPlayerAliasRecords(\"system-id\", \"1.1.1.1\");\n+\n+      assertThat(\n+          \"There are 6 records in the dataset, \"\n+              + \"we expect 4 to match, and 2 of them to be de-duped by name\"\n+              + \"with only the most recent de-duped record returned\",\n+          results,\n+          hasSize(3));\n+\n+      assertThat(results.get(0).getUsername(), is(\"name3\"));\n+      assertThat(results.get(0).getIp(), is(\"2.2.2.2\"));\n+      assertThat(results.get(0).getSystemId(), is(\"system-id\"));\n+      assertThat(results.get(0).getDate(), isInstant(2154, 1, 1, 23, 59, 20));\n+\n+      assertThat(results.get(1).getUsername(), is(\"name2\"));\n+      assertThat(results.get(1).getIp(), is(\"1.1.1.1\"));\n+      assertThat(results.get(1).getSystemId(), is(\"system-id2\"));\n+      assertThat(results.get(1).getDate(), isInstant(2152, 1, 1, 23, 59, 20));\n+\n+      assertThat(results.get(2).getUsername(), is(\"name1\"));\n+      assertThat(results.get(2).getIp(), is(\"1.1.1.1\"));\n+      assertThat(results.get(2).getSystemId(), is(\"system-id\"));\n+      assertThat(results.get(2).getDate(), isInstant(2151, 1, 1, 23, 59, 20));\n+    }\n+\n+    @Test\n+    void lookupWithOnlyIpMatching() {\n+      final List<PlayerAliasRecord> results =\n+          playerInfoForModeratorDao.lookupPlayerAliasRecords(\"system-id-dne\", \"2.2.2.2\");\n+\n+      assertThat(\"We expect to only match the one record with IP 2.2.2.2\", results, hasSize(1));\n+\n+      assertThat(results.get(0).getUsername(), is(\"name3\"));\n+      assertThat(results.get(0).getIp(), is(\"2.2.2.2\"));\n+      assertThat(results.get(0).getSystemId(), is(\"system-id\"));\n+      assertThat(results.get(0).getDate(), isInstant(2154, 1, 1, 23, 59, 20));\n+    }\n+\n+    @Test\n+    void lookupWithOnlySystemIdMatching() {\n+      final List<PlayerAliasRecord> results =\n+          playerInfoForModeratorDao.lookupPlayerAliasRecords(\"system-id2\", \"9.9.9.9\");\n+\n+      assertThat(\n+          \"We expect to only match the 1 record with system 'system-id2'\", results, hasSize(1));\n+\n+      assertThat(results.get(0).getUsername(), is(\"name2\"));\n+      assertThat(results.get(0).getIp(), is(\"1.1.1.1\"));\n+      assertThat(results.get(0).getSystemId(), is(\"system-id2\"));\n+      assertThat(results.get(0).getDate(), isInstant(2152, 1, 1, 23, 59, 20));\n+    }\n+  }\n+\n+  @Nested\n+  @DataSet(cleanBefore = true, value = \"moderator_player_lookup/lookup_player_bans_select_data.yml\")\n+  class LookupPlayerBans {\n+    @Test\n+    void emptyLookupCase() {\n+      final List<PlayerBanRecord> results =\n+          playerInfoForModeratorDao.lookupPlayerBanRecords(\"system-id-dne\", \"9.9.9.9\");\n+\n+      assertThat(results, is(empty()));\n+    }\n+\n+    @Test\n+    void lookupByBothSystemIdAndIp() {\n+      final List<PlayerBanRecord> results =\n+          playerInfoForModeratorDao.lookupPlayerBanRecords(\"system-id\", \"1.1.1.1\");\n+\n+      assertThat(results, hasSize(3));\n+\n+      assertThat(results.get(0).getUsername(), is(\"name1\"));\n+      assertThat(results.get(0).getIp(), is(\"1.1.1.1\"));\n+      assertThat(results.get(0).getSystemId(), is(\"system-id\"));\n+      assertThat(results.get(0).getBanStart(), isInstant(2010, 1, 1, 23, 59, 20));\n+      assertThat(results.get(0).getBanEnd(), isInstant(2100, 1, 1, 23, 59, 20));\n+\n+      assertThat(results.get(1).getUsername(), is(\"name2\"));\n+      assertThat(results.get(1).getIp(), is(\"1.1.1.1\"));\n+      assertThat(results.get(1).getSystemId(), is(\"system-id2\"));\n+      assertThat(results.get(1).getBanStart(), isInstant(2000, 1, 1, 23, 59, 20));\n+      assertThat(results.get(1).getBanEnd(), isInstant(2050, 1, 1, 23, 59, 20));\n+\n+      assertThat(results.get(2).getUsername(), is(\"name2\"));\n+      assertThat(results.get(2).getIp(), is(\"2.2.2.2\"));\n+      assertThat(results.get(2).getSystemId(), is(\"system-id\"));\n+      assertThat(results.get(2).getBanStart(), isInstant(2000, 1, 1, 23, 59, 20));\n+      assertThat(results.get(2).getBanEnd(), isInstant(2010, 1, 1, 23, 59, 20));\n+    }\n+\n+    @Test", "originalCommit": "8511cb9772885e507778dcb5e0bc748b386ee896", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzc2MzQ5Ng==", "url": "https://github.com/triplea-game/triplea/pull/6354#discussion_r417763496", "bodyText": "Similar blocks of code found in 2 locations. Consider refactoring.", "author": "codeclimate", "createdAt": "2020-04-30T05:36:00Z", "path": "http-server/src/test/java/org/triplea/db/dao/moderator/player/info/PlayerInfoForModeratorDaoTest.java", "diffHunk": "@@ -0,0 +1,154 @@\n+package org.triplea.db.dao.moderator.player.info;\n+\n+import static org.hamcrest.MatcherAssert.assertThat;\n+import static org.hamcrest.collection.IsCollectionWithSize.hasSize;\n+import static org.hamcrest.collection.IsEmptyCollection.empty;\n+import static org.hamcrest.core.Is.is;\n+import static org.triplea.test.common.IsInstant.isInstant;\n+\n+import com.github.database.rider.core.api.dataset.DataSet;\n+import java.util.List;\n+import org.junit.jupiter.api.Nested;\n+import org.junit.jupiter.api.Test;\n+import org.triplea.db.dao.DaoTest;\n+\n+class PlayerInfoForModeratorDaoTest extends DaoTest {\n+\n+  private final PlayerInfoForModeratorDao playerInfoForModeratorDao =\n+      DaoTest.newDao(PlayerInfoForModeratorDao.class);\n+\n+  @Nested\n+  @DataSet(\n+      cleanBefore = true,\n+      value = \"moderator_player_lookup/lookup_player_aliases_select_data.yml\")\n+  class LookupPlayerAliases {\n+    @Test\n+    void lookupEmptyCase() {\n+      final List<PlayerAliasRecord> results =\n+          playerInfoForModeratorDao.lookupPlayerAliasRecords(\"system-id-dne\", \"9.9.9.9\");\n+\n+      assertThat(results, is(empty()));\n+    }\n+\n+    @Test\n+    void lookupByBothSystemIdAndIp() {\n+      final List<PlayerAliasRecord> results =\n+          playerInfoForModeratorDao.lookupPlayerAliasRecords(\"system-id\", \"1.1.1.1\");\n+\n+      assertThat(\n+          \"There are 6 records in the dataset, \"\n+              + \"we expect 4 to match, and 2 of them to be de-duped by name\"\n+              + \"with only the most recent de-duped record returned\",\n+          results,\n+          hasSize(3));\n+\n+      assertThat(results.get(0).getUsername(), is(\"name3\"));\n+      assertThat(results.get(0).getIp(), is(\"2.2.2.2\"));\n+      assertThat(results.get(0).getSystemId(), is(\"system-id\"));\n+      assertThat(results.get(0).getDate(), isInstant(2154, 1, 1, 23, 59, 20));\n+\n+      assertThat(results.get(1).getUsername(), is(\"name2\"));\n+      assertThat(results.get(1).getIp(), is(\"1.1.1.1\"));\n+      assertThat(results.get(1).getSystemId(), is(\"system-id2\"));\n+      assertThat(results.get(1).getDate(), isInstant(2152, 1, 1, 23, 59, 20));\n+\n+      assertThat(results.get(2).getUsername(), is(\"name1\"));\n+      assertThat(results.get(2).getIp(), is(\"1.1.1.1\"));\n+      assertThat(results.get(2).getSystemId(), is(\"system-id\"));\n+      assertThat(results.get(2).getDate(), isInstant(2151, 1, 1, 23, 59, 20));\n+    }\n+\n+    @Test\n+    void lookupWithOnlyIpMatching() {\n+      final List<PlayerAliasRecord> results =\n+          playerInfoForModeratorDao.lookupPlayerAliasRecords(\"system-id-dne\", \"2.2.2.2\");\n+\n+      assertThat(\"We expect to only match the one record with IP 2.2.2.2\", results, hasSize(1));\n+\n+      assertThat(results.get(0).getUsername(), is(\"name3\"));\n+      assertThat(results.get(0).getIp(), is(\"2.2.2.2\"));\n+      assertThat(results.get(0).getSystemId(), is(\"system-id\"));\n+      assertThat(results.get(0).getDate(), isInstant(2154, 1, 1, 23, 59, 20));\n+    }\n+\n+    @Test\n+    void lookupWithOnlySystemIdMatching() {\n+      final List<PlayerAliasRecord> results =\n+          playerInfoForModeratorDao.lookupPlayerAliasRecords(\"system-id2\", \"9.9.9.9\");\n+\n+      assertThat(\n+          \"We expect to only match the 1 record with system 'system-id2'\", results, hasSize(1));\n+\n+      assertThat(results.get(0).getUsername(), is(\"name2\"));\n+      assertThat(results.get(0).getIp(), is(\"1.1.1.1\"));\n+      assertThat(results.get(0).getSystemId(), is(\"system-id2\"));\n+      assertThat(results.get(0).getDate(), isInstant(2152, 1, 1, 23, 59, 20));\n+    }\n+  }\n+\n+  @Nested\n+  @DataSet(cleanBefore = true, value = \"moderator_player_lookup/lookup_player_bans_select_data.yml\")\n+  class LookupPlayerBans {\n+    @Test\n+    void emptyLookupCase() {\n+      final List<PlayerBanRecord> results =\n+          playerInfoForModeratorDao.lookupPlayerBanRecords(\"system-id-dne\", \"9.9.9.9\");\n+\n+      assertThat(results, is(empty()));\n+    }\n+\n+    @Test\n+    void lookupByBothSystemIdAndIp() {\n+      final List<PlayerBanRecord> results =\n+          playerInfoForModeratorDao.lookupPlayerBanRecords(\"system-id\", \"1.1.1.1\");\n+\n+      assertThat(results, hasSize(3));\n+\n+      assertThat(results.get(0).getUsername(), is(\"name1\"));\n+      assertThat(results.get(0).getIp(), is(\"1.1.1.1\"));\n+      assertThat(results.get(0).getSystemId(), is(\"system-id\"));\n+      assertThat(results.get(0).getBanStart(), isInstant(2010, 1, 1, 23, 59, 20));\n+      assertThat(results.get(0).getBanEnd(), isInstant(2100, 1, 1, 23, 59, 20));\n+\n+      assertThat(results.get(1).getUsername(), is(\"name2\"));\n+      assertThat(results.get(1).getIp(), is(\"1.1.1.1\"));\n+      assertThat(results.get(1).getSystemId(), is(\"system-id2\"));\n+      assertThat(results.get(1).getBanStart(), isInstant(2000, 1, 1, 23, 59, 20));\n+      assertThat(results.get(1).getBanEnd(), isInstant(2050, 1, 1, 23, 59, 20));\n+\n+      assertThat(results.get(2).getUsername(), is(\"name2\"));\n+      assertThat(results.get(2).getIp(), is(\"2.2.2.2\"));\n+      assertThat(results.get(2).getSystemId(), is(\"system-id\"));\n+      assertThat(results.get(2).getBanStart(), isInstant(2000, 1, 1, 23, 59, 20));\n+      assertThat(results.get(2).getBanEnd(), isInstant(2010, 1, 1, 23, 59, 20));\n+    }\n+\n+    @Test\n+    void lookupWithMatchByIpOnly() {\n+      final List<PlayerBanRecord> results =\n+          playerInfoForModeratorDao.lookupPlayerBanRecords(\"system-id-dne\", \"2.2.2.2\");\n+\n+      assertThat(results, hasSize(1));\n+\n+      assertThat(results.get(0).getUsername(), is(\"name2\"));\n+      assertThat(results.get(0).getIp(), is(\"2.2.2.2\"));\n+      assertThat(results.get(0).getSystemId(), is(\"system-id\"));\n+      assertThat(results.get(0).getBanStart(), isInstant(2000, 1, 1, 23, 59, 20));\n+      assertThat(results.get(0).getBanEnd(), isInstant(2010, 1, 1, 23, 59, 20));\n+    }\n+\n+    @Test", "originalCommit": "8511cb9772885e507778dcb5e0bc748b386ee896", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzc2MzQ5OQ==", "url": "https://github.com/triplea-game/triplea/pull/6354#discussion_r417763499", "bodyText": "Similar blocks of code found in 2 locations. Consider refactoring.", "author": "codeclimate", "createdAt": "2020-04-30T05:36:00Z", "path": "http-server/src/test/java/org/triplea/db/dao/moderator/player/info/PlayerInfoForModeratorDaoTest.java", "diffHunk": "@@ -0,0 +1,154 @@\n+package org.triplea.db.dao.moderator.player.info;\n+\n+import static org.hamcrest.MatcherAssert.assertThat;\n+import static org.hamcrest.collection.IsCollectionWithSize.hasSize;\n+import static org.hamcrest.collection.IsEmptyCollection.empty;\n+import static org.hamcrest.core.Is.is;\n+import static org.triplea.test.common.IsInstant.isInstant;\n+\n+import com.github.database.rider.core.api.dataset.DataSet;\n+import java.util.List;\n+import org.junit.jupiter.api.Nested;\n+import org.junit.jupiter.api.Test;\n+import org.triplea.db.dao.DaoTest;\n+\n+class PlayerInfoForModeratorDaoTest extends DaoTest {\n+\n+  private final PlayerInfoForModeratorDao playerInfoForModeratorDao =\n+      DaoTest.newDao(PlayerInfoForModeratorDao.class);\n+\n+  @Nested\n+  @DataSet(\n+      cleanBefore = true,\n+      value = \"moderator_player_lookup/lookup_player_aliases_select_data.yml\")\n+  class LookupPlayerAliases {\n+    @Test\n+    void lookupEmptyCase() {\n+      final List<PlayerAliasRecord> results =\n+          playerInfoForModeratorDao.lookupPlayerAliasRecords(\"system-id-dne\", \"9.9.9.9\");\n+\n+      assertThat(results, is(empty()));\n+    }\n+\n+    @Test\n+    void lookupByBothSystemIdAndIp() {\n+      final List<PlayerAliasRecord> results =\n+          playerInfoForModeratorDao.lookupPlayerAliasRecords(\"system-id\", \"1.1.1.1\");\n+\n+      assertThat(\n+          \"There are 6 records in the dataset, \"\n+              + \"we expect 4 to match, and 2 of them to be de-duped by name\"\n+              + \"with only the most recent de-duped record returned\",\n+          results,\n+          hasSize(3));\n+\n+      assertThat(results.get(0).getUsername(), is(\"name3\"));\n+      assertThat(results.get(0).getIp(), is(\"2.2.2.2\"));\n+      assertThat(results.get(0).getSystemId(), is(\"system-id\"));\n+      assertThat(results.get(0).getDate(), isInstant(2154, 1, 1, 23, 59, 20));\n+\n+      assertThat(results.get(1).getUsername(), is(\"name2\"));\n+      assertThat(results.get(1).getIp(), is(\"1.1.1.1\"));\n+      assertThat(results.get(1).getSystemId(), is(\"system-id2\"));\n+      assertThat(results.get(1).getDate(), isInstant(2152, 1, 1, 23, 59, 20));\n+\n+      assertThat(results.get(2).getUsername(), is(\"name1\"));\n+      assertThat(results.get(2).getIp(), is(\"1.1.1.1\"));\n+      assertThat(results.get(2).getSystemId(), is(\"system-id\"));\n+      assertThat(results.get(2).getDate(), isInstant(2151, 1, 1, 23, 59, 20));\n+    }\n+\n+    @Test\n+    void lookupWithOnlyIpMatching() {\n+      final List<PlayerAliasRecord> results =\n+          playerInfoForModeratorDao.lookupPlayerAliasRecords(\"system-id-dne\", \"2.2.2.2\");\n+\n+      assertThat(\"We expect to only match the one record with IP 2.2.2.2\", results, hasSize(1));\n+\n+      assertThat(results.get(0).getUsername(), is(\"name3\"));\n+      assertThat(results.get(0).getIp(), is(\"2.2.2.2\"));\n+      assertThat(results.get(0).getSystemId(), is(\"system-id\"));\n+      assertThat(results.get(0).getDate(), isInstant(2154, 1, 1, 23, 59, 20));\n+    }\n+\n+    @Test", "originalCommit": "8511cb9772885e507778dcb5e0bc748b386ee896", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzc2MzUwMA==", "url": "https://github.com/triplea-game/triplea/pull/6354#discussion_r417763500", "bodyText": "Method playerLookup has 35 lines of code (exceeds 30 allowed). Consider refactoring.", "author": "codeclimate", "createdAt": "2020-04-30T05:36:01Z", "path": "http-server/src/test/java/org/triplea/modules/moderation/player/info/FetchPlayerInfoModuleTest.java", "diffHunk": "@@ -0,0 +1,111 @@\n+package org.triplea.modules.moderation.player.info;\n+\n+import static org.hamcrest.MatcherAssert.assertThat;\n+import static org.hamcrest.collection.IsCollectionWithSize.hasSize;\n+import static org.hamcrest.core.Is.is;\n+import static org.junit.jupiter.api.Assertions.assertThrows;\n+import static org.mockito.Mockito.when;\n+\n+import java.time.LocalDateTime;\n+import java.time.ZoneOffset;\n+import java.util.List;\n+import java.util.Optional;\n+import org.junit.jupiter.api.DisplayName;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.extension.ExtendWith;\n+import org.mockito.InjectMocks;\n+import org.mockito.Mock;\n+import org.mockito.junit.jupiter.MockitoExtension;\n+import org.triplea.db.dao.api.key.ApiKeyDaoWrapper;\n+import org.triplea.db.dao.api.key.GamePlayerLookup;\n+import org.triplea.db.dao.moderator.player.info.PlayerAliasRecord;\n+import org.triplea.db.dao.moderator.player.info.PlayerBanRecord;\n+import org.triplea.db.dao.moderator.player.info.PlayerInfoForModeratorDao;\n+import org.triplea.domain.data.PlayerChatId;\n+import org.triplea.domain.data.SystemId;\n+import org.triplea.domain.data.UserName;\n+import org.triplea.http.client.lobby.moderator.PlayerSummaryForModerator.Alias;\n+import org.triplea.http.client.lobby.moderator.PlayerSummaryForModerator.BanInformation;\n+\n+@ExtendWith(MockitoExtension.class)\n+class FetchPlayerInfoModuleTest {\n+\n+  private static final GamePlayerLookup GAME_PLAYER_LOOKUP =\n+      GamePlayerLookup.builder()\n+          .ip(\"1.1.1.1\")\n+          .systemId(SystemId.of(\"system-id\"))\n+          .userName(UserName.of(\"user-name\"))\n+          .build();\n+\n+  private static final PlayerAliasRecord PLAYER_ALIAS_RECORD =\n+      PlayerAliasRecord.builder()\n+          .username(\"alias-user-name\")\n+          .systemId(\"system-id2\")\n+          .ip(\"2.3.2.3\")\n+          .date(LocalDateTime.of(2000, 1, 1, 1, 1, 1).toInstant(ZoneOffset.UTC))\n+          .build();\n+\n+  private static final PlayerBanRecord PLAYER_BAN_RECORD =\n+      PlayerBanRecord.builder()\n+          .username(\"banned-name\")\n+          .systemId(\"id-at-time-of-ban\")\n+          .ip(\"5.5.5.6\")\n+          .banStart(LocalDateTime.of(2001, 1, 1, 1, 1, 1).toInstant(ZoneOffset.UTC))\n+          .banEnd(LocalDateTime.of(2100, 1, 1, 1, 1, 1).toInstant(ZoneOffset.UTC))\n+          .build();\n+\n+  @Mock private ApiKeyDaoWrapper apiKeyDaoWrapper;\n+  @Mock private PlayerInfoForModeratorDao playerInfoForModeratorDao;\n+\n+  @InjectMocks private FetchPlayerInfoModule fetchPlayerInfoModule;\n+\n+  @Test\n+  void unableToFindPlayerChatIdThrows() {\n+    when(apiKeyDaoWrapper.lookupPlayerByChatId(PlayerChatId.of(\"id\"))).thenReturn(Optional.empty());\n+    assertThrows(\n+        IllegalArgumentException.class, () -> fetchPlayerInfoModule.apply(PlayerChatId.of(\"id\")));\n+  }\n+\n+  @Test", "originalCommit": "8511cb9772885e507778dcb5e0bc748b386ee896", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzc2MzUwMw==", "url": "https://github.com/triplea-game/triplea/pull/6354#discussion_r417763503", "bodyText": "Similar blocks of code found in 2 locations. Consider refactoring.", "author": "codeclimate", "createdAt": "2020-04-30T05:36:01Z", "path": "http-server/src/test/java/org/triplea/modules/moderation/player/info/FetchPlayerInfoModuleTest.java", "diffHunk": "@@ -0,0 +1,111 @@\n+package org.triplea.modules.moderation.player.info;\n+\n+import static org.hamcrest.MatcherAssert.assertThat;\n+import static org.hamcrest.collection.IsCollectionWithSize.hasSize;\n+import static org.hamcrest.core.Is.is;\n+import static org.junit.jupiter.api.Assertions.assertThrows;\n+import static org.mockito.Mockito.when;\n+\n+import java.time.LocalDateTime;\n+import java.time.ZoneOffset;\n+import java.util.List;\n+import java.util.Optional;\n+import org.junit.jupiter.api.DisplayName;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.extension.ExtendWith;\n+import org.mockito.InjectMocks;\n+import org.mockito.Mock;\n+import org.mockito.junit.jupiter.MockitoExtension;\n+import org.triplea.db.dao.api.key.ApiKeyDaoWrapper;\n+import org.triplea.db.dao.api.key.GamePlayerLookup;\n+import org.triplea.db.dao.moderator.player.info.PlayerAliasRecord;\n+import org.triplea.db.dao.moderator.player.info.PlayerBanRecord;\n+import org.triplea.db.dao.moderator.player.info.PlayerInfoForModeratorDao;\n+import org.triplea.domain.data.PlayerChatId;\n+import org.triplea.domain.data.SystemId;\n+import org.triplea.domain.data.UserName;\n+import org.triplea.http.client.lobby.moderator.PlayerSummaryForModerator.Alias;\n+import org.triplea.http.client.lobby.moderator.PlayerSummaryForModerator.BanInformation;\n+\n+@ExtendWith(MockitoExtension.class)\n+class FetchPlayerInfoModuleTest {\n+\n+  private static final GamePlayerLookup GAME_PLAYER_LOOKUP =\n+      GamePlayerLookup.builder()\n+          .ip(\"1.1.1.1\")\n+          .systemId(SystemId.of(\"system-id\"))\n+          .userName(UserName.of(\"user-name\"))\n+          .build();\n+\n+  private static final PlayerAliasRecord PLAYER_ALIAS_RECORD =\n+      PlayerAliasRecord.builder()", "originalCommit": "8511cb9772885e507778dcb5e0bc748b386ee896", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzc2MzUwNA==", "url": "https://github.com/triplea-game/triplea/pull/6354#discussion_r417763504", "bodyText": "Similar blocks of code found in 2 locations. Consider refactoring.", "author": "codeclimate", "createdAt": "2020-04-30T05:36:01Z", "path": "http-server/src/test/java/org/triplea/modules/moderation/player/info/FetchPlayerInfoModuleTest.java", "diffHunk": "@@ -0,0 +1,111 @@\n+package org.triplea.modules.moderation.player.info;\n+\n+import static org.hamcrest.MatcherAssert.assertThat;\n+import static org.hamcrest.collection.IsCollectionWithSize.hasSize;\n+import static org.hamcrest.core.Is.is;\n+import static org.junit.jupiter.api.Assertions.assertThrows;\n+import static org.mockito.Mockito.when;\n+\n+import java.time.LocalDateTime;\n+import java.time.ZoneOffset;\n+import java.util.List;\n+import java.util.Optional;\n+import org.junit.jupiter.api.DisplayName;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.extension.ExtendWith;\n+import org.mockito.InjectMocks;\n+import org.mockito.Mock;\n+import org.mockito.junit.jupiter.MockitoExtension;\n+import org.triplea.db.dao.api.key.ApiKeyDaoWrapper;\n+import org.triplea.db.dao.api.key.GamePlayerLookup;\n+import org.triplea.db.dao.moderator.player.info.PlayerAliasRecord;\n+import org.triplea.db.dao.moderator.player.info.PlayerBanRecord;\n+import org.triplea.db.dao.moderator.player.info.PlayerInfoForModeratorDao;\n+import org.triplea.domain.data.PlayerChatId;\n+import org.triplea.domain.data.SystemId;\n+import org.triplea.domain.data.UserName;\n+import org.triplea.http.client.lobby.moderator.PlayerSummaryForModerator.Alias;\n+import org.triplea.http.client.lobby.moderator.PlayerSummaryForModerator.BanInformation;\n+\n+@ExtendWith(MockitoExtension.class)\n+class FetchPlayerInfoModuleTest {\n+\n+  private static final GamePlayerLookup GAME_PLAYER_LOOKUP =\n+      GamePlayerLookup.builder()\n+          .ip(\"1.1.1.1\")\n+          .systemId(SystemId.of(\"system-id\"))\n+          .userName(UserName.of(\"user-name\"))\n+          .build();\n+\n+  private static final PlayerAliasRecord PLAYER_ALIAS_RECORD =\n+      PlayerAliasRecord.builder()\n+          .username(\"alias-user-name\")\n+          .systemId(\"system-id2\")\n+          .ip(\"2.3.2.3\")\n+          .date(LocalDateTime.of(2000, 1, 1, 1, 1, 1).toInstant(ZoneOffset.UTC))\n+          .build();\n+\n+  private static final PlayerBanRecord PLAYER_BAN_RECORD =\n+      PlayerBanRecord.builder()", "originalCommit": "8511cb9772885e507778dcb5e0bc748b386ee896", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzk3NzcxMg==", "url": "https://github.com/triplea-game/triplea/pull/6354#discussion_r417977712", "bodyText": "I don't think this dependency is used in this PR", "author": "RoiEXLab", "createdAt": "2020-04-30T12:38:17Z", "path": "test-common/build.gradle", "diffHunk": "@@ -3,4 +3,5 @@ description = 'Test utility library, generic test utilities useful for TripleA p\n dependencies {\n     implementation \"org.hamcrest:java-hamcrest:$hamcrestVersion\"\n     implementation \"org.junit.jupiter:junit-jupiter-api:$junitJupiterVersion\"\n+    implementation \"org.apache.commons:commons-lang3:$apacheCommonsLangVersion\"", "originalCommit": "8511cb9772885e507778dcb5e0bc748b386ee896", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODk5NzI1MA==", "url": "https://github.com/triplea-game/triplea/pull/6354#discussion_r418997250", "bodyText": "Thanks - removed in: 7bb93e7", "author": "DanVanAtta", "createdAt": "2020-05-02T19:22:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzk3NzcxMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzk3OTQwMg==", "url": "https://github.com/triplea-game/triplea/pull/6354#discussion_r417979402", "bodyText": "We already have TimeManager.java which has similar functionality.\nDoes it make sense to merge those 2 classes?", "author": "RoiEXLab", "createdAt": "2020-04-30T12:41:19Z", "path": "java-extras/src/main/java/org/triplea/java/DateTimeFormatterUtil.java", "diffHunk": "@@ -0,0 +1,29 @@\n+package org.triplea.java;\n+\n+import com.google.common.annotations.VisibleForTesting;\n+import java.time.Instant;\n+import java.time.ZoneId;\n+import java.time.format.DateTimeFormatter;\n+import java.util.Locale;\n+import lombok.experimental.UtilityClass;\n+\n+/** Utility class for date-time formatting operations. */\n+@UtilityClass\n+public class DateTimeFormatterUtil {", "originalCommit": "8511cb9772885e507778dcb5e0bc748b386ee896", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODk5NzM5MQ==", "url": "https://github.com/triplea-game/triplea/pull/6354#discussion_r418997391", "bodyText": "Makes sense to combine them, yes.\nTimeManager has a naming issue IMO. Manager is a bit of a smell in general, kingdom of nouns type deal and is generally not very meaningful. In this context it's not really managing state of any type. A final strike to TimeManager is I would not have thought to look for formatting tools in that class.\nDateTimeUtils perhaps could be a better unified class name. Thoughts?", "author": "DanVanAtta", "createdAt": "2020-05-02T19:23:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzk3OTQwMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODk5NzkzNQ==", "url": "https://github.com/triplea-game/triplea/pull/6354#discussion_r418997935", "bodyText": "Go with DateTimeUtils \ud83e\udd37", "author": "RoiEXLab", "createdAt": "2020-05-02T19:29:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzk3OTQwMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzk4MDI4OQ==", "url": "https://github.com/triplea-game/triplea/pull/6354#discussion_r417980289", "bodyText": "Side-Note: One day we'll have Text Blocks and the world will be a better place ^^", "author": "RoiEXLab", "createdAt": "2020-04-30T12:42:51Z", "path": "http-server/src/main/java/org/triplea/db/dao/moderator/player/info/PlayerInfoForModeratorDao.java", "diffHunk": "@@ -0,0 +1,48 @@\n+package org.triplea.db.dao.moderator.player.info;\n+\n+import java.util.List;\n+import org.jdbi.v3.sqlobject.customizer.Bind;\n+import org.jdbi.v3.sqlobject.statement.SqlQuery;\n+\n+/**\n+ * DAO used to lookup player correlation information for moderators. Answers questions such as\n+ *\n+ * <ul>\n+ *   <li>\"how many times and was this player banned?\"\n+ *   <li>\"which other names were used by this same IP and system-id? (presumably the same player)\"\n+ * </ul>\n+ */\n+public interface PlayerInfoForModeratorDao {\n+  @SqlQuery(\n+      \"select distinct\"\n+          + \"    username as name,\"\n+          + \"    ip as ip,\"\n+          + \"    system_id as systemId,\"\n+          + \"    max(access_time) as accessTime\"\n+          + \"  from access_log\"\n+          + \"  where \"\n+          + \"    access_time > (now() - '14 day'::interval)\"\n+          + \"    and (\"\n+          + \"      ip = :ip::inet\"\n+          + \"      or system_id = :systemId\"\n+          + \"    )\"\n+          + \"  group by name, ip, systemId\"\n+          + \"  order by accessTime desc\")", "originalCommit": "8511cb9772885e507778dcb5e0bc748b386ee896", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODk5NzQ4NA==", "url": "https://github.com/triplea-game/triplea/pull/6354#discussion_r418997484", "bodyText": "\ud83d\udc4d\nThough TBH, I'm not sure when. We need the next LTS to come out and for us to be willing to migrate to it. I do think avoiding the constants between queries and the JDBI types was an improvement; that is something I think we should do going forward and see about retrofitting.", "author": "DanVanAtta", "createdAt": "2020-05-02T19:24:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzk4MDI4OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzk4MTgwNw==", "url": "https://github.com/triplea-game/triplea/pull/6354#discussion_r417981807", "bodyText": "Side-Note: This is potentially something we could establish instead of creating \"real threads\" left and right, we could try to use CompletableFutures instead.\nIt'll probably decrease the footprint of TripleA a little bit", "author": "RoiEXLab", "createdAt": "2020-04-30T12:45:33Z", "path": "game-core/src/main/java/games/strategy/engine/lobby/client/ui/action/player/info/ShowPlayerInformationAction.java", "diffHunk": "@@ -0,0 +1,46 @@\n+package games.strategy.engine.lobby.client.ui.action.player.info;\n+\n+import java.util.concurrent.CompletableFuture;\n+import java.util.function.Function;\n+import java.util.logging.Level;\n+import javax.annotation.Nonnull;\n+import javax.swing.Action;\n+import javax.swing.JFrame;\n+import lombok.Builder;\n+import lombok.extern.java.Log;\n+import org.triplea.domain.data.PlayerChatId;\n+import org.triplea.http.client.lobby.moderator.PlayerSummaryForModerator;\n+import org.triplea.http.client.web.socket.client.connections.PlayerToLobbyConnection;\n+import org.triplea.swing.SwingAction;\n+\n+/**\n+ * When this action is taken (by a moderator), we will fetch from server information about the\n+ * clicked on player and display it in a tabbed dialog.\n+ */\n+@Builder\n+@Log\n+public class ShowPlayerInformationAction {\n+  @Nonnull private final JFrame parent;\n+  @Nonnull private final PlayerToLobbyConnection playerToLobbyConnection;\n+  @Nonnull private final PlayerChatId playerChatId;\n+  private Function<PlayerSummaryForModerator, String> dataFormatter;\n+\n+  public Action toSwingAction() {\n+    return SwingAction.of(\n+        \"Show Player Information\",\n+        () ->\n+            CompletableFuture.runAsync(this::fetchPlayerInfoAndShowDisplay)\n+                .exceptionally(this::logFetchError));", "originalCommit": "8511cb9772885e507778dcb5e0bc748b386ee896", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODk5NzU2OQ==", "url": "https://github.com/triplea-game/triplea/pull/6354#discussion_r418997569", "bodyText": "Agree, it is a nice API as well.", "author": "DanVanAtta", "createdAt": "2020-05-02T19:25:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzk4MTgwNw=="}], "type": "inlineReview"}, {"oid": "7bb93e7ba1ab9917ea66c8ad5d13a242744f5ba2", "url": "https://github.com/triplea-game/triplea/commit/7bb93e7ba1ab9917ea66c8ad5d13a242744f5ba2", "message": "Remove unused apache common dependency", "committedDate": "2020-05-02T19:21:54Z", "type": "commit"}, {"oid": "c7971f48c58d9d30b7c6df5fa6cc9ad54371868d", "url": "https://github.com/triplea-game/triplea/commit/c7971f48c58d9d30b7c6df5fa6cc9ad54371868d", "message": "Formatting", "committedDate": "2020-05-02T19:32:44Z", "type": "commit"}]}