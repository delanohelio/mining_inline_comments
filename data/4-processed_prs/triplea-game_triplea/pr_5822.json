{"pr_number": 5822, "pr_title": "Change bcrypt dependency", "pr_createdAt": "2020-01-04T15:59:58Z", "pr_url": "https://github.com/triplea-game/triplea/pull/5822", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzA0Nzg3Mw==", "url": "https://github.com/triplea-game/triplea/pull/5822#discussion_r363047873", "bodyText": "Looks like someone went to the trouble to sort this list lexicographically; might want to move this entry up.", "author": "ssoloff", "createdAt": "2020-01-04T18:15:14Z", "path": "build.gradle", "diffHunk": "@@ -95,7 +95,7 @@ subprojects {\n         jaxbApiVersion = '2.3.1'\n         jaxbCoreVersion = '2.3.0.1'\n         jaxbImplVersion = '2.3.2'\n-        jbcryptVersion = '0.4'\n+        bcryptVersion = '0.9.0'", "originalCommit": "374c121f17070a87b51d3b29210ef2c23ab6d48e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzA0ODM0NA==", "url": "https://github.com/triplea-game/triplea/pull/5822#discussion_r363048344", "bodyText": "I don't see any other changes in the game-core project.  Is this dependency still needed?", "author": "ssoloff", "createdAt": "2020-01-04T18:26:37Z", "path": "game-core/build.gradle", "diffHunk": "@@ -16,7 +14,7 @@ dependencies {\n     implementation \"org.apache.commons:commons-math3:$commonsMathVersion\"\n     implementation \"org.apache.httpcomponents:httpclient:$apacheHttpComponentsVersion\"\n     implementation \"org.apache.httpcomponents:httpmime:$apacheHttpComponentsVersion\"\n-    implementation \"org.mindrot:jbcrypt:$jbcryptVersion\"\n+    implementation \"at.favre.lib:bcrypt:$bcryptVersion\"", "originalCommit": "374c121f17070a87b51d3b29210ef2c23ab6d48e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzA4NjczNw==", "url": "https://github.com/triplea-game/triplea/pull/5822#discussion_r363086737", "bodyText": "Apparently not.\nGood catch", "author": "RoiEXLab", "createdAt": "2020-01-05T11:32:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzA0ODM0NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzExOTM4Mw==", "url": "https://github.com/triplea-game/triplea/pull/5822#discussion_r363119383", "bodyText": "The level of abstraction is perhaps inconsistent here, would you agree @RoiEXLab ?\nNotably, we have a high level call PasswordBCrypter.hashPasswordWithSalt, which abstracts away parameters and configuration, then we have a more low level call to verify.\nSecond, the params to verifyer seem to be chosen for specific reasons, but it's not immediately clear (missing context) what those reasons were.\nI think you could resolve both concerns by moving the verifyer call to a similar static method. That method could then be documented to note why the parameters are chosen as they are, and we'd have a consistent abstraction in this method. For example:\nfinal String hashedPassword = PasswordBCrypter.hashPasswordWithSalt(password);\nreturn BcryptedPasswordVerifyer.verify(hashedPassword);\n\nWDYT @RoiEXLab ?\n(A third benefit, we would not need to repeat the verifyer parameters in test, DRY)", "author": "DanVanAtta", "createdAt": "2020-01-05T21:50:02Z", "path": "http-server/src/main/java/org/triplea/server/user/account/login/authorizer/BCryptHashVerifier.java", "diffHunk": "@@ -1,14 +1,17 @@\n package org.triplea.server.user.account.login.authorizer;\n \n+import at.favre.lib.crypto.bcrypt.BCrypt;\n+import at.favre.lib.crypto.bcrypt.LongPasswordStrategies;\n import java.util.function.BiPredicate;\n-import org.mindrot.jbcrypt.BCrypt;\n import org.triplea.server.user.account.PasswordBCrypter;\n \n public class BCryptHashVerifier implements BiPredicate<String, String> {\n   @Override\n   public boolean test(final String password, final String databaseBcrypted) {\n     // TODO: Md5-Deprecation Move SHA512 hashing to client side\n     final String hashedPassword = PasswordBCrypter.hashPasswordWithSalt(password);\n-    return BCrypt.checkpw(hashedPassword, databaseBcrypted);\n+    return BCrypt.verifyer(null, LongPasswordStrategies.none())", "originalCommit": "9329544f4ee318020fd712379e412d0e595bedd8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzExOTY2NA==", "url": "https://github.com/triplea-game/triplea/pull/5822#discussion_r363119664", "bodyText": "Really similar to my other comment, I think we may benefit to create a utility method around this hasing method:\n\nprovides a good place to document decisions/parameters:\n\nwhy '10'?\nwhy 'LongPasswordStrategies.none()'?\n\n\nAvoids repetition between source code and test (DRY)", "author": "DanVanAtta", "createdAt": "2020-01-05T21:54:46Z", "path": "http-server/src/main/java/org/triplea/server/user/account/PasswordBCrypter.java", "diffHunk": "@@ -18,7 +19,7 @@\n   public String apply(final String password) {\n     // TODO: Md5-Deprecation remove hashing here, move to client-side\n     final String hashed = hashPasswordWithSalt(password);\n-    return BCrypt.hashpw(hashed, BCrypt.gensalt());\n+    return BCrypt.with(LongPasswordStrategies.none()).hashToString(10, hashed.toCharArray());", "originalCommit": "9329544f4ee318020fd712379e412d0e595bedd8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzExOTc4MA==", "url": "https://github.com/triplea-game/triplea/pull/5822#discussion_r363119780", "bodyText": "Are we still using a bcrypt salt anywhere?\nIf not, for this PR or a fast-follow, we can clean up the configuration that was intended to inject a salt:\n\nhttps://github.com/triplea-game/triplea/blob/master/http-server/src/main/java/org/triplea/server/http/AppConfig.java#L57\nhttps://github.com/triplea-game/triplea/blob/master/http-server/configuration.yml#L12\nhttps://github.com/triplea-game/triplea/blob/master/infrastructure/ansible/roles/http_server/templates/configuration.yml.j2#L8\nhttps://github.com/triplea-game/triplea/blob/master/infrastructure/ansible/roles/http_server/defaults/main.yml#L20", "author": "DanVanAtta", "createdAt": "2020-01-05T21:56:46Z", "path": "http-server/src/main/java/org/triplea/server/user/account/PasswordBCrypter.java", "diffHunk": "@@ -18,7 +19,7 @@\n   public String apply(final String password) {\n     // TODO: Md5-Deprecation remove hashing here, move to client-side\n     final String hashed = hashPasswordWithSalt(password);\n-    return BCrypt.hashpw(hashed, BCrypt.gensalt());", "originalCommit": "9329544f4ee318020fd712379e412d0e595bedd8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzMyOTQwNw==", "url": "https://github.com/triplea-game/triplea/pull/5822#discussion_r363329407", "bodyText": "I'm not sure what you mean by that.\nObviously a salt is still generated for the individual passwords, you just don't have to manually supply them any longer.", "author": "RoiEXLab", "createdAt": "2020-01-06T15:00:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzExOTc4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTEyNzExNg==", "url": "https://github.com/triplea-game/triplea/pull/5822#discussion_r365127116", "bodyText": "Good news - That means the AppConfig scaffolding added for it, and never wired fully to be used, can be removed as it'll never be used.", "author": "DanVanAtta", "createdAt": "2020-01-10T08:52:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzExOTc4MA=="}], "type": "inlineReview"}, {"oid": "4db9fc711df759e191c34a36a6b2bf2b9e2f6fdf", "url": "https://github.com/triplea-game/triplea/commit/4db9fc711df759e191c34a36a6b2bf2b9e2f6fdf", "message": "Remove unused import", "committedDate": "2020-01-06T15:27:40Z", "type": "commit"}, {"oid": "606c74552422cab95008c9c088f25fbcdabb8d3a", "url": "https://github.com/triplea-game/triplea/commit/606c74552422cab95008c9c088f25fbcdabb8d3a", "message": "Migrate to modern implementation of jBcrypt", "committedDate": "2020-01-06T15:27:40Z", "type": "commit"}, {"oid": "6d49af03e31faff67c0caac905b8a028f01fc8d2", "url": "https://github.com/triplea-game/triplea/commit/6d49af03e31faff67c0caac905b8a028f01fc8d2", "message": "Fix password overflow", "committedDate": "2020-01-06T15:27:40Z", "type": "commit"}, {"oid": "48eb23aaeb1b33fcd93371461ef7f2fd355b5cff", "url": "https://github.com/triplea-game/triplea/commit/48eb23aaeb1b33fcd93371461ef7f2fd355b5cff", "message": "Rely on default version", "committedDate": "2020-01-06T15:27:40Z", "type": "commit"}, {"oid": "e2be919bc1787545692b51d252fdd84c67034d03", "url": "https://github.com/triplea-game/triplea/commit/e2be919bc1787545692b51d252fdd84c67034d03", "message": "Remove bcrypt dependency from game-core", "committedDate": "2020-01-06T15:27:40Z", "type": "commit"}, {"oid": "a4631bfb1ecea67b747fba6b98cec1236c800f0b", "url": "https://github.com/triplea-game/triplea/commit/a4631bfb1ecea67b747fba6b98cec1236c800f0b", "message": "Restore lexicographical ordering", "committedDate": "2020-01-06T15:28:24Z", "type": "commit"}, {"oid": "bb6e192250ff4fc103dc4a6aeae6cca30a3812db", "url": "https://github.com/triplea-game/triplea/commit/bb6e192250ff4fc103dc4a6aeae6cca30a3812db", "message": "Extract bcrypt methods to class and add documentation", "committedDate": "2020-01-06T15:28:24Z", "type": "commit"}, {"oid": "bb6e192250ff4fc103dc4a6aeae6cca30a3812db", "url": "https://github.com/triplea-game/triplea/commit/bb6e192250ff4fc103dc4a6aeae6cca30a3812db", "message": "Extract bcrypt methods to class and add documentation", "committedDate": "2020-01-06T15:28:24Z", "type": "forcePushed"}]}