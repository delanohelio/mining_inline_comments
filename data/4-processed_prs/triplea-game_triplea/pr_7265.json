{"pr_number": 7265, "pr_title": "Add an initial schema for maps-db", "pr_createdAt": "2020-07-27T05:29:03Z", "pr_url": "https://github.com/triplea-game/triplea/pull/7265", "timeline": [{"oid": "16d148b1363198440df7913e476f71665c6a73e2", "url": "https://github.com/triplea-game/triplea/commit/16d148b1363198440df7913e476f71665c6a73e2", "message": "Add an initial schema for maps-db\n\n- Contains enough of a schema that we can model the triplea_maps.yaml file", "committedDate": "2020-07-27T05:26:10Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjI3NDkxMA==", "url": "https://github.com/triplea-game/triplea/pull/7265#discussion_r462274910", "bodyText": "I think sooner or later we'll have to revisit those tags/categories, but for now it's good.", "author": "RoiEXLab", "createdAt": "2020-07-29T12:54:21Z", "path": "maps-db/src/main/resources/db/migration/V1.00.01__create_map_index_table.sql", "diffHunk": "@@ -0,0 +1,33 @@\n+comment on database maps_db is 'Database used to store, track and serve map information';\n+\n+create table map (\n+  id serial primary key,\n+  name varchar(256) not null unique check(length(name) > 3),\n+  date_created timestamptz not null default now(),\n+  date_updated timestamptz not null default now()\n+);\n+\n+create table category (\n+  id serial primary key,\n+  name varchar(32) unique not null check (length(name) > 2),\n+  date_created timestamptz not null default now()\n+);\n+\n+insert into category (name) values\n+  ('BEST'),\n+  ('GOOD'),\n+  ('EXPERIMENTAL');", "originalCommit": "16d148b1363198440df7913e476f71665c6a73e2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjI3ODA2Mw==", "url": "https://github.com/triplea-game/triplea/pull/7265#discussion_r462278063", "bodyText": "I mean a length check is nice, but I don't think it's necessary here tbh", "author": "RoiEXLab", "createdAt": "2020-07-29T12:59:14Z", "path": "maps-db/src/main/resources/db/migration/V1.00.01__create_map_index_table.sql", "diffHunk": "@@ -0,0 +1,33 @@\n+comment on database maps_db is 'Database used to store, track and serve map information';\n+\n+create table map (\n+  id serial primary key,\n+  name varchar(256) not null unique check(length(name) > 3),\n+  date_created timestamptz not null default now(),\n+  date_updated timestamptz not null default now()\n+);\n+\n+create table category (\n+  id serial primary key,\n+  name varchar(32) unique not null check (length(name) > 2),", "originalCommit": "16d148b1363198440df7913e476f71665c6a73e2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjU5NDIzNw==", "url": "https://github.com/triplea-game/triplea/pull/7265#discussion_r462594237", "bodyText": "Adding as many constraints as you legitimately can is a good thing when it comes to the DB. A category with an empty or 1 character name is not going to be correct.\nThe principle at play here is \"database as fortress\", and trying to assert that all data in database is as valid as possible:\nhttps://www.oreilly.com/library/view/97-things-every/9780596800611/ch23.html", "author": "DanVanAtta", "createdAt": "2020-07-29T21:16:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjI3ODA2Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjI4NzQ1Ng==", "url": "https://github.com/triplea-game/triplea/pull/7265#discussion_r462287456", "bodyText": "Not sure we need a creation date, but I guess it doesn't hurt", "author": "RoiEXLab", "createdAt": "2020-07-29T13:13:44Z", "path": "maps-db/src/main/resources/db/migration/V1.00.01__create_map_index_table.sql", "diffHunk": "@@ -0,0 +1,33 @@\n+comment on database maps_db is 'Database used to store, track and serve map information';\n+\n+create table map (\n+  id serial primary key,\n+  name varchar(256) not null unique check(length(name) > 3),\n+  date_created timestamptz not null default now(),", "originalCommit": "16d148b1363198440df7913e476f71665c6a73e2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjU5NDc4MA==", "url": "https://github.com/triplea-game/triplea/pull/7265#discussion_r462594780", "bodyText": "Generally all rows should have both date_created and date_updated. Missing date_updated implies immutability. TBD how we handle deleted or removed maps. The value here is if a version were to go away when we could see when the map was originally uploaded.", "author": "DanVanAtta", "createdAt": "2020-07-29T21:17:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjI4NzQ1Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjI4Nzk0MA==", "url": "https://github.com/triplea-game/triplea/pull/7265#discussion_r462287940", "bodyText": "I don't think Map Thumbnails are a requirement right now.\nSo the not null constraint might be wrong, I could be wrong though", "author": "RoiEXLab", "createdAt": "2020-07-29T13:14:31Z", "path": "maps-db/src/main/resources/db/migration/V1.00.01__create_map_index_table.sql", "diffHunk": "@@ -0,0 +1,33 @@\n+comment on database maps_db is 'Database used to store, track and serve map information';\n+\n+create table map (\n+  id serial primary key,\n+  name varchar(256) not null unique check(length(name) > 3),\n+  date_created timestamptz not null default now(),\n+  date_updated timestamptz not null default now()\n+);\n+\n+create table category (\n+  id serial primary key,\n+  name varchar(32) unique not null check (length(name) > 2),\n+  date_created timestamptz not null default now()\n+);\n+\n+insert into category (name) values\n+  ('BEST'),\n+  ('GOOD'),\n+  ('EXPERIMENTAL');\n+\n+\n+create table map_version (\n+  id serial primary key,\n+  map_id integer not null references map(id),\n+  version integer not null check (version > 0),\n+  url varchar(256) not null check (url like 'http%'),\n+  thumbnail varchar(256) not null check (thumbnail like 'http%'),", "originalCommit": "16d148b1363198440df7913e476f71665c6a73e2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjU5NTMxMw==", "url": "https://github.com/triplea-game/triplea/pull/7265#discussion_r462595313", "bodyText": "This will be a good thing to check, you could be right.\nI wonder if there should be room to update the map thumbnail. Immutable DB rows is a good thing, perhaps a lookup table would be in order.", "author": "DanVanAtta", "createdAt": "2020-07-29T21:18:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjI4Nzk0MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjYzNzc2MQ==", "url": "https://github.com/triplea-game/triplea/pull/7265#discussion_r462637761", "bodyText": "I think I found one:\nhttps://triplea-game.org/map/big-world/\nThe way the websites handles a missing image is by using a fallback image.\nI assume by 'room to update the map thumbnail' you mean within the same version, i.e. in order to update the thumbnail a new version needs to be pushed right?\nIn this case I'm not quite sure, both approaches have their pros and cons.\nIf you mean in general I wouldn't agree.", "author": "RoiEXLab", "createdAt": "2020-07-29T22:59:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjI4Nzk0MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjY2MjkyMw==", "url": "https://github.com/triplea-game/triplea/pull/7265#discussion_r462662923", "bodyText": "If the thumbnail only is updated, I was thinking we'd have a mutable row and it would be an update statement.\nIf we want immutable rows, then we need a second table that has the listing of thumbnails. Thinking about it a bit more, IMO mutable rows here is fine.", "author": "DanVanAtta", "createdAt": "2020-07-30T00:22:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjI4Nzk0MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjY2Mzc0MQ==", "url": "https://github.com/triplea-game/triplea/pull/7265#discussion_r462663741", "bodyText": "The way the websites handles a missing image is by using a fallback image.\n\nI'm curious what kind of traffic and usage the 'maps' section is getting (?)\nI'm not sure if we should continue maintaining it.. The download link is extra functionality, the browsing of maps is totally redundant to what we have in-game. I'd like to see evidence that 'maps' on the website is having an impact (I could see that being a good and proper thing if this were a web-app, in which case that is how you would look through maps to play them perhaps, but for us...)", "author": "DanVanAtta", "createdAt": "2020-07-30T00:25:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjI4Nzk0MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDAwODk0Mg==", "url": "https://github.com/triplea-game/triplea/pull/7265#discussion_r464008942", "bodyText": "Removed the thumbnail non-null constraint and added some additional UK constraints:  16d148b", "author": "DanVanAtta", "createdAt": "2020-08-01T23:04:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjI4Nzk0MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjI5MTA2Nw==", "url": "https://github.com/triplea-game/triplea/pull/7265#discussion_r462291067", "bodyText": "Ok, I don't quite get what those timestamps are supposed to represent.\nDoesn't the map table store the \"last updated\" date already?", "author": "RoiEXLab", "createdAt": "2020-07-29T13:18:57Z", "path": "maps-db/src/main/resources/db/migration/V1.00.01__create_map_index_table.sql", "diffHunk": "@@ -0,0 +1,33 @@\n+comment on database maps_db is 'Database used to store, track and serve map information';\n+\n+create table map (\n+  id serial primary key,\n+  name varchar(256) not null unique check(length(name) > 3),\n+  date_created timestamptz not null default now(),\n+  date_updated timestamptz not null default now()\n+);\n+\n+create table category (\n+  id serial primary key,\n+  name varchar(32) unique not null check (length(name) > 2),\n+  date_created timestamptz not null default now()\n+);\n+\n+insert into category (name) values\n+  ('BEST'),\n+  ('GOOD'),\n+  ('EXPERIMENTAL');\n+\n+\n+create table map_version (\n+  id serial primary key,\n+  map_id integer not null references map(id),\n+  version integer not null check (version > 0),\n+  url varchar(256) not null check (url like 'http%'),\n+  thumbnail varchar(256) not null check (thumbnail like 'http%'),\n+  category_id integer not null references category(id),\n+  description varchar(4096),\n+  date_created timestamptz not null default now(),\n+  date_updated timestamptz not null default now()", "originalCommit": "16d148b1363198440df7913e476f71665c6a73e2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjU5NTk3MQ==", "url": "https://github.com/triplea-game/triplea/pull/7265#discussion_r462595971", "bodyText": "The first version of a map and the map date_created likely are going to always match. The map table is the umbrella for all of the different map versions that can be uploaded.\nA new map version being uploaded gets a new row and hence a date_created. If we change the category, then date_updated would change.", "author": "DanVanAtta", "createdAt": "2020-07-29T21:19:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjI5MTA2Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjYzNjE3MA==", "url": "https://github.com/triplea-game/triplea/pull/7265#discussion_r462636170", "bodyText": "Ok, but wouldn't map.date_created and map.date_updated always be the \"oldest\"/newest entry of the corresponsing values in map_version?\nI'm just thinking that there's some redundancy involved here", "author": "RoiEXLab", "createdAt": "2020-07-29T22:54:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjI5MTA2Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjY2MDcwMw==", "url": "https://github.com/triplea-game/triplea/pull/7265#discussion_r462660703", "bodyText": "map.date_updated would be updated if the name of a map is changed. It would not be updated if the map_version table is touched. map.date_created might very well correspond to the 'oldest' entry of date_created in map_version. I think at that point if you want to answer a query like \"get me the list of maps by order of creation date\", doing a window query on map_version is something of a pain. One would also want a created & updated date on map so that you can know if the name has been modified since creation.", "author": "DanVanAtta", "createdAt": "2020-07-30T00:14:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjI5MTA2Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjI5MzI2NQ==", "url": "https://github.com/triplea-game/triplea/pull/7265#discussion_r462293265", "bodyText": "Sooner or later we might want to revisit this too", "author": "RoiEXLab", "createdAt": "2020-07-29T13:22:11Z", "path": "maps-db/src/main/resources/db/migration/V1.00.01__create_map_index_table.sql", "diffHunk": "@@ -0,0 +1,33 @@\n+comment on database maps_db is 'Database used to store, track and serve map information';\n+\n+create table map (\n+  id serial primary key,\n+  name varchar(256) not null unique check(length(name) > 3),\n+  date_created timestamptz not null default now(),\n+  date_updated timestamptz not null default now()\n+);\n+\n+create table category (\n+  id serial primary key,\n+  name varchar(32) unique not null check (length(name) > 2),\n+  date_created timestamptz not null default now()\n+);\n+\n+insert into category (name) values\n+  ('BEST'),\n+  ('GOOD'),\n+  ('EXPERIMENTAL');\n+\n+\n+create table map_version (\n+  id serial primary key,\n+  map_id integer not null references map(id),\n+  version integer not null check (version > 0),", "originalCommit": "16d148b1363198440df7913e476f71665c6a73e2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjU5NjUwMg==", "url": "https://github.com/triplea-game/triplea/pull/7265#discussion_r462596502", "bodyText": "I'm pretty sure we do not want semver. Checksumming the map and then making map versions immutable would solve all semver problems. Simply then if a game client is missing the map that is uniquely identified, it can download it and you then have a new map version on your system.", "author": "DanVanAtta", "createdAt": "2020-07-29T21:20:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjI5MzI2NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjU5NzYyOQ==", "url": "https://github.com/triplea-game/triplea/pull/7265#discussion_r462597629", "bodyText": "w.r.t map semver, how is a map maker to know what is a compatible map change and what is not? We do not want map makers to have to have to continue to be 'mini-developers' knowing implementation details of how the code works. Currently they must know far too much about the internals that it just creates a really high barrier to entry. If I change for example a unit stat and upload a new version, the game engine should just do the right thing without me having to ask a dev if that is semver version increase, and to which number. WE then get into further issues with how the engine should handle such semver version numbers, it just is overly complex I think", "author": "DanVanAtta", "createdAt": "2020-07-29T21:23:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjI5MzI2NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjYzNTA2OA==", "url": "https://github.com/triplea-game/triplea/pull/7265#discussion_r462635068", "bodyText": "I just read your post on the forum where you explained a couple of things.\nI was more thinking about making use of SQL to determine the latest version.\nThere's no need to increment a version id if we could just look at the \"creation date\" and/or the compatible engine versions to determine a suited version to download.", "author": "RoiEXLab", "createdAt": "2020-07-29T22:52:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjI5MzI2NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjY2MjU0Mw==", "url": "https://github.com/triplea-game/triplea/pull/7265#discussion_r462662543", "bodyText": "I'm not convinced that the game engine semver is appropriate when it comes to map compatibility. For example, if we add a new property to maps and deprecate an old one, are we then making a major version update?\nI'm pretty sure we will likely be moving map parsing logic into a sub-project that is below game-headed. At that point the map parsing engine is no longer aware of the 'product.version' at all.\nLast, game engine version does not capture the range of compatibility for a map. We essentially could have a case where  map is compatible with 2.3, 2.4, 3.0, but not 3.1.\nWe should also consider that there can be multiple versions of a map suitable for a game engine, but perhaps we don't want the latest. The map itself could be updated to use latest properties (for example a map that does work with 2.0 by using legacy properties but is then updated to use 2.0 specific properties).\nI'm suspecting that we'll eventually create a \"map version\", IE: a specification value, similar to \"HTML 4.0\" that specifies the valid properties that can be defined in the map. Today we re-use version like crazy, which I think is over-use of that concept.\nThe version number here is in part needed just so we can transition from triplea_maps.yaml and have similar functionality. The game clients should be able to read data from either the server or the triplea_maps.yaml while we transition.", "author": "DanVanAtta", "createdAt": "2020-07-30T00:21:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjI5MzI2NQ=="}], "type": "inlineReview"}, {"oid": "8e7811d8fecc23e553963ab6e6421f20d715f02f", "url": "https://github.com/triplea-game/triplea/commit/8e7811d8fecc23e553963ab6e6421f20d715f02f", "message": "Drop non-null constraint on map-thumbnail and add uniqueness constraints\n\n- map-version 'map-id' and 'version' should be unique, we expect only one version\n  of a given map version.\n- each map-version URL should be unique as well so that only one map-version\n  points to a specific location.", "committedDate": "2020-08-01T05:36:28Z", "type": "commit"}]}