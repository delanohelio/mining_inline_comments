{"pr_number": 6487, "pr_title": "Store forum token instead of password", "pr_createdAt": "2020-05-17T23:00:57Z", "pr_url": "https://github.com/triplea-game/triplea/pull/6487", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjMxNDc1Nw==", "url": "https://github.com/triplea-game/triplea/pull/6487#discussion_r426314757", "bodyText": "TODO found", "author": "codeclimate", "createdAt": "2020-05-17T23:02:25Z", "path": "game-core/src/main/java/games/strategy/triplea/settings/SelectionComponentFactory.java", "diffHunk": "@@ -749,27 +768,67 @@ public JComponent getUiComponent() {\n \n       @Override\n       public void save(final SaveContext context) {\n-        final String username = usernameField.getText();\n-        context.setValue(usernameSetting, username.isEmpty() ? null : username.toCharArray());\n+        // Only save when value changed\n+        if (usernameField\n+            .getText()\n+            .equals(usernameSetting.getValue().map(String::new).orElse(\"\"))) {\n+          return;\n+        }\n+        try {\n+          BackgroundTaskRunner.runInBackground(\n+              \"Fetching Login Token...\",\n+              () -> {\n+                final NodeBbTokenGenerator tokenGenerator = new NodeBbTokenGenerator(forumUrl);\n+                final Optional<Integer> oldUserId = uidSetting.getValue();\n+                final Optional<char[]> oldToken = tokenSetting.getValue();\n+                if (!usernameField.getText().isEmpty()) {\n+                  final TokenInfo tokenInfo =\n+                      tokenGenerator.generateToken(\n+                          usernameField.getText(),\n+                          new String(passwordField.getPassword()),\n+                          Strings.emptyToNull(otpField.getText()));\n+                  context.setValue(uidSetting, tokenInfo.getUserId());\n+\n+                  context.setValue(tokenSetting, tokenInfo.getToken().toCharArray());\n+\n+                  context.setValue(usernameSetting, usernameField.getText().toCharArray());\n+                  // TODO error reporting", "originalCommit": "ab9c619722afdf840cb943a271451a4e26799170", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjMxNTIxNg==", "url": "https://github.com/triplea-game/triplea/pull/6487#discussion_r426315216", "bodyText": "This class is just band-aided so I could use the \"Test PbF\" button and everything compiles properly.\nThis will obviously change in the final verison of this PR, but I haven't had them time for everything today.", "author": "RoiEXLab", "createdAt": "2020-05-17T23:08:26Z", "path": "game-core/src/main/java/games/strategy/engine/framework/startup/ui/posted/game/pbf/ForumPosterEditorViewModel.java", "diffHunk": "@@ -120,7 +120,10 @@ synchronized void setTopicId(final String topicId) {\n   }\n \n   synchronized boolean areFieldsValid() {\n-    return isTopicIdValid() && isForumUsernameValid() && isForumPasswordValid();\n+    return isTopicIdValid()\n+        && ((isForumUsernameValid() && isForumPasswordValid())\n+            || ClientSetting.aaForumToken.isSet()\n+            || ClientSetting.tripleaForumToken.isSet());", "originalCommit": "ab9c619722afdf840cb943a271451a4e26799170", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjMxNTM5Ng==", "url": "https://github.com/triplea-game/triplea/pull/6487#discussion_r426315396", "bodyText": "I will properly clear any char arrays in the final form as well, even though I'm not sure if actually encrypting everything is that important now", "author": "RoiEXLab", "createdAt": "2020-05-17T23:10:50Z", "path": "game-core/src/main/java/games/strategy/triplea/settings/SelectionComponentFactory.java", "diffHunk": "@@ -724,14 +727,28 @@ public void reset() {\n     };\n   }\n \n+  /**\n+   * Creates UI Controls to fetch a login token and safely store it in the ClientSettings.\n+   *\n+   * @param uidSetting The uid setting used to potentially revoke old tokens\n+   * @param usernameSetting The setting that stores the username being displayed to the user\n+   * @param tokenSetting The setting that stores the actual token.\n+   * @return A SelectionComponent that allows users to easily store their token.\n+   */\n   static SelectionComponent<JComponent> forumPosterSettings(\n-      final ClientSetting<char[]> usernameSetting, final ClientSetting<char[]> passwordSetting) {\n+      final String forumUrl,\n+      final ClientSetting<Integer> uidSetting,\n+      final ClientSetting<char[]> usernameSetting,\n+      final ClientSetting<char[]> tokenSetting) {\n     return new SelectionComponent<>() {\n \n       private final JTextField usernameField =\n-          new JTextField(credentialToString(usernameSetting::getValue), 20);\n-      private final JPasswordField passwordField =\n-          new JPasswordField(credentialToString(passwordSetting::getValue), 20);\n+          new JTextFieldBuilder()\n+              .columns(20)\n+              .text(usernameSetting.getValue().map(String::new).orElse(\"\"))", "originalCommit": "ab9c619722afdf840cb943a271451a4e26799170", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjMyNDMxMA==", "url": "https://github.com/triplea-game/triplea/pull/6487#discussion_r426324310", "bodyText": "If I understand correctly, we'll use 'username' + 'password' to create a token via API, then store that token but not the password (correct?).\nIf so, I think we probably want this field to check if the token is set. If the token is set, then we can fill in the password field with a dummy value to make it look like there is something filled in (that should be essentially what we have now - the reason for that is so we don't have to read the password from settings and set the actual value to the text field. Instead we use a dummy string to show that the field is set).", "author": "DanVanAtta", "createdAt": "2020-05-18T00:38:41Z", "path": "game-core/src/main/java/games/strategy/engine/framework/startup/ui/posted/game/pbf/ForumPosterEditorViewModel.java", "diffHunk": "@@ -88,10 +88,10 @@ synchronized void setForumSelection(final String forumSelection) {\n         this.forumSelection.equals(NodeBbForumPoster.TRIPLEA_FORUM_DISPLAY_NAME)\n             ? ClientSetting.tripleaForumUsername.getValue().map(String::valueOf).orElse(\"\")\n             : ClientSetting.aaForumUsername.getValue().map(String::valueOf).orElse(\"\");\n-    forumPasswordIsSet =\n+    forumPasswordIsSet = false; /*", "originalCommit": "ab9c619722afdf840cb943a271451a4e26799170", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjMyNDU3Nw==", "url": "https://github.com/triplea-game/triplea/pull/6487#discussion_r426324577", "bodyText": "Any thoughts to first, or as part of this PR, to convert the http client to Feign?\nI mention that for a few reasons:\n\nthe different styles/technologies for http communication is inconsistent. It's one of the technology consistencies that a project really should try to keep so you limit how many technologies you need to learn and how many different patterns there are for doing something.\nthe test infrastructure for http communication with feign client is pretty straight forward. At this point with wiremock, we should be testing this client, going to a consistent pattern and using the same technological infrastructure would make that easy.", "author": "DanVanAtta", "createdAt": "2020-05-18T00:40:43Z", "path": "game-core/src/main/java/games/strategy/engine/posted/game/pbf/NodeBbTokenGenerator.java", "diffHunk": "@@ -0,0 +1,129 @@\n+package games.strategy.engine.posted.game.pbf;\n+\n+import com.google.common.base.Preconditions;\n+import games.strategy.engine.framework.system.HttpProxy;\n+import java.io.IOException;\n+import java.nio.charset.StandardCharsets;\n+import java.util.List;\n+import java.util.Map;\n+import javax.annotation.Nonnull;\n+import javax.annotation.Nullable;\n+import lombok.AccessLevel;\n+import lombok.AllArgsConstructor;\n+import lombok.Getter;\n+import org.apache.http.client.entity.UrlEncodedFormEntity;\n+import org.apache.http.client.methods.CloseableHttpResponse;\n+import org.apache.http.client.methods.HttpDelete;\n+import org.apache.http.client.methods.HttpGet;\n+import org.apache.http.client.methods.HttpPost;\n+import org.apache.http.impl.client.CloseableHttpClient;\n+import org.apache.http.impl.client.HttpClients;\n+import org.apache.http.message.BasicNameValuePair;\n+import org.apache.http.util.EntityUtils;\n+import org.snakeyaml.engine.v2.api.Load;\n+import org.snakeyaml.engine.v2.api.LoadSettings;\n+\n+@AllArgsConstructor\n+public class NodeBbTokenGenerator {\n+  private final String forumUrl;\n+  private final Load load = new Load(LoadSettings.builder().build());\n+\n+  @AllArgsConstructor(access = AccessLevel.PRIVATE)\n+  @Getter\n+  public static class TokenInfo {\n+    @Nonnull private final String token;\n+    private final int userId;\n+  }\n+\n+  public TokenInfo generateToken(\n+      final String username, final String password, @Nullable final String otp) {\n+    Preconditions.checkNotNull(username);\n+    Preconditions.checkNotNull(password);\n+\n+    try (CloseableHttpClient client = HttpClients.custom().disableCookieManagement().build()) {\n+      final int userId = getUserId(client, username);\n+      return new TokenInfo(getToken(client, userId, password, otp), userId);\n+    } catch (final IOException e) {\n+      throw new RuntimeException(\"Failed to retrieve login token\", e);\n+    }\n+  }\n+\n+  public void revokeToken(final String token, final int userId) {\n+    try (CloseableHttpClient client = HttpClients.custom().disableCookieManagement().build()) {\n+      deleteToken(client, userId, token);\n+    } catch (final IOException e) {\n+      throw new RuntimeException(\"Failed to revoke login token\", e);\n+    }\n+  }\n+\n+  private void deleteToken(final CloseableHttpClient client, final int userId, final String token)\n+      throws IOException {\n+    final HttpDelete httpDelete =\n+        new HttpDelete(forumUrl + \"/api/v2/users/\" + userId + \"/tokens/\" + token);", "originalCommit": "ab9c619722afdf840cb943a271451a4e26799170", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjUxMjQ2Mg==", "url": "https://github.com/triplea-game/triplea/pull/6487#discussion_r426512462", "bodyText": "I was thinking about migrating away from http component to either use the built-in java API that's pretty neat or feign, but not as part of this PR", "author": "RoiEXLab", "createdAt": "2020-05-18T10:03:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjMyNDU3Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjMyNDkzNA==", "url": "https://github.com/triplea-game/triplea/pull/6487#discussion_r426324934", "bodyText": "ignore error is a bit scary \ud83d\ude01\nShould we at least info log them? Have you seen this throw errors?", "author": "DanVanAtta", "createdAt": "2020-05-18T00:43:52Z", "path": "game-core/src/main/java/games/strategy/engine/posted/game/pbf/NodeBbTokenGenerator.java", "diffHunk": "@@ -0,0 +1,129 @@\n+package games.strategy.engine.posted.game.pbf;\n+\n+import com.google.common.base.Preconditions;\n+import games.strategy.engine.framework.system.HttpProxy;\n+import java.io.IOException;\n+import java.nio.charset.StandardCharsets;\n+import java.util.List;\n+import java.util.Map;\n+import javax.annotation.Nonnull;\n+import javax.annotation.Nullable;\n+import lombok.AccessLevel;\n+import lombok.AllArgsConstructor;\n+import lombok.Getter;\n+import org.apache.http.client.entity.UrlEncodedFormEntity;\n+import org.apache.http.client.methods.CloseableHttpResponse;\n+import org.apache.http.client.methods.HttpDelete;\n+import org.apache.http.client.methods.HttpGet;\n+import org.apache.http.client.methods.HttpPost;\n+import org.apache.http.impl.client.CloseableHttpClient;\n+import org.apache.http.impl.client.HttpClients;\n+import org.apache.http.message.BasicNameValuePair;\n+import org.apache.http.util.EntityUtils;\n+import org.snakeyaml.engine.v2.api.Load;\n+import org.snakeyaml.engine.v2.api.LoadSettings;\n+\n+@AllArgsConstructor\n+public class NodeBbTokenGenerator {\n+  private final String forumUrl;\n+  private final Load load = new Load(LoadSettings.builder().build());\n+\n+  @AllArgsConstructor(access = AccessLevel.PRIVATE)\n+  @Getter\n+  public static class TokenInfo {\n+    @Nonnull private final String token;\n+    private final int userId;\n+  }\n+\n+  public TokenInfo generateToken(\n+      final String username, final String password, @Nullable final String otp) {\n+    Preconditions.checkNotNull(username);\n+    Preconditions.checkNotNull(password);\n+\n+    try (CloseableHttpClient client = HttpClients.custom().disableCookieManagement().build()) {\n+      final int userId = getUserId(client, username);\n+      return new TokenInfo(getToken(client, userId, password, otp), userId);\n+    } catch (final IOException e) {\n+      throw new RuntimeException(\"Failed to retrieve login token\", e);\n+    }\n+  }\n+\n+  public void revokeToken(final String token, final int userId) {\n+    try (CloseableHttpClient client = HttpClients.custom().disableCookieManagement().build()) {\n+      deleteToken(client, userId, token);\n+    } catch (final IOException e) {\n+      throw new RuntimeException(\"Failed to revoke login token\", e);\n+    }\n+  }\n+\n+  private void deleteToken(final CloseableHttpClient client, final int userId, final String token)\n+      throws IOException {\n+    final HttpDelete httpDelete =\n+        new HttpDelete(forumUrl + \"/api/v2/users/\" + userId + \"/tokens/\" + token);\n+    HttpProxy.addProxy(httpDelete);\n+    httpDelete.addHeader(\"Authorization\", \"Bearer \" + token);\n+    client.execute(httpDelete).close(); // ignore errors, execute and then close", "originalCommit": "ab9c619722afdf840cb943a271451a4e26799170", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjUxMTk1NA==", "url": "https://github.com/triplea-game/triplea/pull/6487#discussion_r426511954", "bodyText": "This is super funny, because you introduced this change in the first place ^^\nTook me a while to find the commit though: https://github.com/triplea-game/triplea/pull/3715/files#diff-317b30fefdd065ba13162cb51844ab22L93-R96", "author": "RoiEXLab", "createdAt": "2020-05-18T10:02:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjMyNDkzNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjMyNTE2Nw==", "url": "https://github.com/triplea-game/triplea/pull/6487#discussion_r426325167", "bodyText": "Bit nitpicky, I think we should try to avoid jsonObject. The debian variant of TripleA ripped these out, the lack of type-safety is not great. Going to Feign makes this mapping to Java object automatic. If migrating to Feign, this would be moot, otherwise have you considered using GSON?", "author": "DanVanAtta", "createdAt": "2020-05-18T00:45:49Z", "path": "game-core/src/main/java/games/strategy/engine/posted/game/pbf/NodeBbTokenGenerator.java", "diffHunk": "@@ -0,0 +1,129 @@\n+package games.strategy.engine.posted.game.pbf;\n+\n+import com.google.common.base.Preconditions;\n+import games.strategy.engine.framework.system.HttpProxy;\n+import java.io.IOException;\n+import java.nio.charset.StandardCharsets;\n+import java.util.List;\n+import java.util.Map;\n+import javax.annotation.Nonnull;\n+import javax.annotation.Nullable;\n+import lombok.AccessLevel;\n+import lombok.AllArgsConstructor;\n+import lombok.Getter;\n+import org.apache.http.client.entity.UrlEncodedFormEntity;\n+import org.apache.http.client.methods.CloseableHttpResponse;\n+import org.apache.http.client.methods.HttpDelete;\n+import org.apache.http.client.methods.HttpGet;\n+import org.apache.http.client.methods.HttpPost;\n+import org.apache.http.impl.client.CloseableHttpClient;\n+import org.apache.http.impl.client.HttpClients;\n+import org.apache.http.message.BasicNameValuePair;\n+import org.apache.http.util.EntityUtils;\n+import org.snakeyaml.engine.v2.api.Load;\n+import org.snakeyaml.engine.v2.api.LoadSettings;\n+\n+@AllArgsConstructor\n+public class NodeBbTokenGenerator {\n+  private final String forumUrl;\n+  private final Load load = new Load(LoadSettings.builder().build());\n+\n+  @AllArgsConstructor(access = AccessLevel.PRIVATE)\n+  @Getter\n+  public static class TokenInfo {\n+    @Nonnull private final String token;\n+    private final int userId;\n+  }\n+\n+  public TokenInfo generateToken(\n+      final String username, final String password, @Nullable final String otp) {\n+    Preconditions.checkNotNull(username);\n+    Preconditions.checkNotNull(password);\n+\n+    try (CloseableHttpClient client = HttpClients.custom().disableCookieManagement().build()) {\n+      final int userId = getUserId(client, username);\n+      return new TokenInfo(getToken(client, userId, password, otp), userId);\n+    } catch (final IOException e) {\n+      throw new RuntimeException(\"Failed to retrieve login token\", e);\n+    }\n+  }\n+\n+  public void revokeToken(final String token, final int userId) {\n+    try (CloseableHttpClient client = HttpClients.custom().disableCookieManagement().build()) {\n+      deleteToken(client, userId, token);\n+    } catch (final IOException e) {\n+      throw new RuntimeException(\"Failed to revoke login token\", e);\n+    }\n+  }\n+\n+  private void deleteToken(final CloseableHttpClient client, final int userId, final String token)\n+      throws IOException {\n+    final HttpDelete httpDelete =\n+        new HttpDelete(forumUrl + \"/api/v2/users/\" + userId + \"/tokens/\" + token);\n+    HttpProxy.addProxy(httpDelete);\n+    httpDelete.addHeader(\"Authorization\", \"Bearer \" + token);\n+    client.execute(httpDelete).close(); // ignore errors, execute and then close\n+  }\n+\n+  private int getUserId(final CloseableHttpClient client, final String username)\n+      throws IOException {\n+    final Map<?, ?> jsonObject = queryUserInfo(client, username);", "originalCommit": "ab9c619722afdf840cb943a271451a4e26799170", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjUwNTYyNA==", "url": "https://github.com/triplea-game/triplea/pull/6487#discussion_r426505624", "bodyText": "This used to be a json dependency, but it is currently just using the snakeyaml-engine dependency wich supports the yaml 1.2 standard -> json support.\nFeign would be an option for a follow-up PR, but out of scope for this one", "author": "RoiEXLab", "createdAt": "2020-05-18T09:52:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjMyNTE2Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjMyNTM1OA==", "url": "https://github.com/triplea-game/triplea/pull/6487#discussion_r426325358", "bodyText": "nit, we probably want to take care about exception types. Exceptions that we may show to users we would want to be probably first-class exceptions. Maybe even more ideally not exceptions at all. For example this checkUser method could return a status flag, that would eliminate control-flow-by-exception. What do you think?", "author": "DanVanAtta", "createdAt": "2020-05-18T00:47:06Z", "path": "game-core/src/main/java/games/strategy/engine/posted/game/pbf/NodeBbTokenGenerator.java", "diffHunk": "@@ -0,0 +1,129 @@\n+package games.strategy.engine.posted.game.pbf;\n+\n+import com.google.common.base.Preconditions;\n+import games.strategy.engine.framework.system.HttpProxy;\n+import java.io.IOException;\n+import java.nio.charset.StandardCharsets;\n+import java.util.List;\n+import java.util.Map;\n+import javax.annotation.Nonnull;\n+import javax.annotation.Nullable;\n+import lombok.AccessLevel;\n+import lombok.AllArgsConstructor;\n+import lombok.Getter;\n+import org.apache.http.client.entity.UrlEncodedFormEntity;\n+import org.apache.http.client.methods.CloseableHttpResponse;\n+import org.apache.http.client.methods.HttpDelete;\n+import org.apache.http.client.methods.HttpGet;\n+import org.apache.http.client.methods.HttpPost;\n+import org.apache.http.impl.client.CloseableHttpClient;\n+import org.apache.http.impl.client.HttpClients;\n+import org.apache.http.message.BasicNameValuePair;\n+import org.apache.http.util.EntityUtils;\n+import org.snakeyaml.engine.v2.api.Load;\n+import org.snakeyaml.engine.v2.api.LoadSettings;\n+\n+@AllArgsConstructor\n+public class NodeBbTokenGenerator {\n+  private final String forumUrl;\n+  private final Load load = new Load(LoadSettings.builder().build());\n+\n+  @AllArgsConstructor(access = AccessLevel.PRIVATE)\n+  @Getter\n+  public static class TokenInfo {\n+    @Nonnull private final String token;\n+    private final int userId;\n+  }\n+\n+  public TokenInfo generateToken(\n+      final String username, final String password, @Nullable final String otp) {\n+    Preconditions.checkNotNull(username);\n+    Preconditions.checkNotNull(password);\n+\n+    try (CloseableHttpClient client = HttpClients.custom().disableCookieManagement().build()) {\n+      final int userId = getUserId(client, username);\n+      return new TokenInfo(getToken(client, userId, password, otp), userId);\n+    } catch (final IOException e) {\n+      throw new RuntimeException(\"Failed to retrieve login token\", e);\n+    }\n+  }\n+\n+  public void revokeToken(final String token, final int userId) {\n+    try (CloseableHttpClient client = HttpClients.custom().disableCookieManagement().build()) {\n+      deleteToken(client, userId, token);\n+    } catch (final IOException e) {\n+      throw new RuntimeException(\"Failed to revoke login token\", e);\n+    }\n+  }\n+\n+  private void deleteToken(final CloseableHttpClient client, final int userId, final String token)\n+      throws IOException {\n+    final HttpDelete httpDelete =\n+        new HttpDelete(forumUrl + \"/api/v2/users/\" + userId + \"/tokens/\" + token);\n+    HttpProxy.addProxy(httpDelete);\n+    httpDelete.addHeader(\"Authorization\", \"Bearer \" + token);\n+    client.execute(httpDelete).close(); // ignore errors, execute and then close\n+  }\n+\n+  private int getUserId(final CloseableHttpClient client, final String username)\n+      throws IOException {\n+    final Map<?, ?> jsonObject = queryUserInfo(client, username);\n+    checkUser(jsonObject, username);\n+    return (Integer) jsonObject.get(\"uid\");\n+  }\n+\n+  private void checkUser(final Map<?, ?> jsonObject, final String username) {\n+    if (!jsonObject.containsKey(\"uid\")) {\n+      throw new IllegalStateException(String.format(\"User %s doesn't exist.\", username));\n+    }\n+    if (1 == (Integer) jsonObject.get(\"banned\")) {\n+      throw new IllegalStateException(\"Your account is banned from the forum.\");", "originalCommit": "ab9c619722afdf840cb943a271451a4e26799170", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjUwNDA1MQ==", "url": "https://github.com/triplea-game/triplea/pull/6487#discussion_r426504051", "bodyText": "I agree the Exceptions are not ideal, but to get this done I just copied the implementation from the forum poster class, so I didn't really change anything here", "author": "RoiEXLab", "createdAt": "2020-05-18T09:49:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjMyNTM1OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjMyNTU5OA==", "url": "https://github.com/triplea-game/triplea/pull/6487#discussion_r426325598", "bodyText": "I know we had the discussion about passwords as String being security theater. IMO if we can keep passwords as char[] without too much trouble, it's not a bad thing. Said another way, if we don't have to go too far out of our way to use char[] for password, we probably should.", "author": "DanVanAtta", "createdAt": "2020-05-18T00:49:04Z", "path": "game-core/src/main/java/games/strategy/triplea/settings/SelectionComponentFactory.java", "diffHunk": "@@ -749,27 +768,67 @@ public JComponent getUiComponent() {\n \n       @Override\n       public void save(final SaveContext context) {\n-        final String username = usernameField.getText();\n-        context.setValue(usernameSetting, username.isEmpty() ? null : username.toCharArray());\n+        // Only save when value changed\n+        if (usernameField\n+            .getText()\n+            .equals(usernameSetting.getValue().map(String::new).orElse(\"\"))) {\n+          return;\n+        }\n+        try {\n+          BackgroundTaskRunner.runInBackground(\n+              \"Fetching Login Token...\",\n+              () -> {\n+                final NodeBbTokenGenerator tokenGenerator = new NodeBbTokenGenerator(forumUrl);\n+                final Optional<Integer> oldUserId = uidSetting.getValue();\n+                final Optional<char[]> oldToken = tokenSetting.getValue();\n+                if (!usernameField.getText().isEmpty()) {\n+                  final TokenInfo tokenInfo =\n+                      tokenGenerator.generateToken(\n+                          usernameField.getText(),\n+                          new String(passwordField.getPassword()),", "originalCommit": "ab9c619722afdf840cb943a271451a4e26799170", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjMyNTgzMQ==", "url": "https://github.com/triplea-game/triplea/pull/6487#discussion_r426325831", "bodyText": "Side-note, we really need to update BackTasRunner to be closeable. If anything crashes  while this is running we can run into problems. Notably if any exception is uncaught, then is handled and shows the error dialog, the background task will not complete until the dialog is closed and the dialog cannot be closed because the background task runner is modal and does not give up UI focus.\nWe'll probably want to test this out and/or fix the background task runner. We could see problems if the lobby were not responding or is being restarted, in such a case we'd want a graceful failure.", "author": "DanVanAtta", "createdAt": "2020-05-18T00:50:53Z", "path": "game-core/src/main/java/games/strategy/triplea/settings/SelectionComponentFactory.java", "diffHunk": "@@ -749,27 +768,67 @@ public JComponent getUiComponent() {\n \n       @Override\n       public void save(final SaveContext context) {\n-        final String username = usernameField.getText();\n-        context.setValue(usernameSetting, username.isEmpty() ? null : username.toCharArray());\n+        // Only save when value changed\n+        if (usernameField\n+            .getText()\n+            .equals(usernameSetting.getValue().map(String::new).orElse(\"\"))) {\n+          return;\n+        }\n+        try {\n+          BackgroundTaskRunner.runInBackground(", "originalCommit": "ab9c619722afdf840cb943a271451a4e26799170", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjMyNjExNg==", "url": "https://github.com/triplea-game/triplea/pull/6487#discussion_r426326116", "bodyText": "Perhaps we want to use isBlank() instead of isEmpty().\nDo we currently already enforce a minimum length check on usename before the 'save' button is enabled? It might be the case that we've already guaranteed that there is a non-empty value that is of a minimum length before we hit this code which would make this validation redundant.\nSide-comment, redundant client-side validation can generally be removed. If someone hacks it up so a button is enabled without validation, they can hack this. Server validation needs to be redundant in case a client hacks out the validation (or is just using straight-up curl or something similar).", "author": "DanVanAtta", "createdAt": "2020-05-18T00:53:07Z", "path": "game-core/src/main/java/games/strategy/triplea/settings/SelectionComponentFactory.java", "diffHunk": "@@ -749,27 +768,67 @@ public JComponent getUiComponent() {\n \n       @Override\n       public void save(final SaveContext context) {\n-        final String username = usernameField.getText();\n-        context.setValue(usernameSetting, username.isEmpty() ? null : username.toCharArray());\n+        // Only save when value changed\n+        if (usernameField\n+            .getText()\n+            .equals(usernameSetting.getValue().map(String::new).orElse(\"\"))) {\n+          return;\n+        }\n+        try {\n+          BackgroundTaskRunner.runInBackground(\n+              \"Fetching Login Token...\",\n+              () -> {\n+                final NodeBbTokenGenerator tokenGenerator = new NodeBbTokenGenerator(forumUrl);\n+                final Optional<Integer> oldUserId = uidSetting.getValue();\n+                final Optional<char[]> oldToken = tokenSetting.getValue();\n+                if (!usernameField.getText().isEmpty()) {", "originalCommit": "ab9c619722afdf840cb943a271451a4e26799170", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjMyNjQzNg==", "url": "https://github.com/triplea-game/triplea/pull/6487#discussion_r426326436", "bodyText": "I don't think username should be a char[], IMO it's just not sensitive enough. Does it make sense changing username to be a String value before, after or in this PR?", "author": "DanVanAtta", "createdAt": "2020-05-18T00:55:38Z", "path": "game-core/src/main/java/games/strategy/triplea/settings/SelectionComponentFactory.java", "diffHunk": "@@ -749,27 +768,67 @@ public JComponent getUiComponent() {\n \n       @Override\n       public void save(final SaveContext context) {\n-        final String username = usernameField.getText();\n-        context.setValue(usernameSetting, username.isEmpty() ? null : username.toCharArray());\n+        // Only save when value changed\n+        if (usernameField\n+            .getText()\n+            .equals(usernameSetting.getValue().map(String::new).orElse(\"\"))) {\n+          return;\n+        }\n+        try {\n+          BackgroundTaskRunner.runInBackground(\n+              \"Fetching Login Token...\",\n+              () -> {\n+                final NodeBbTokenGenerator tokenGenerator = new NodeBbTokenGenerator(forumUrl);\n+                final Optional<Integer> oldUserId = uidSetting.getValue();\n+                final Optional<char[]> oldToken = tokenSetting.getValue();\n+                if (!usernameField.getText().isEmpty()) {\n+                  final TokenInfo tokenInfo =\n+                      tokenGenerator.generateToken(\n+                          usernameField.getText(),\n+                          new String(passwordField.getPassword()),\n+                          Strings.emptyToNull(otpField.getText()));\n+                  context.setValue(uidSetting, tokenInfo.getUserId());\n+\n+                  context.setValue(tokenSetting, tokenInfo.getToken().toCharArray());\n+\n+                  context.setValue(usernameSetting, usernameField.getText().toCharArray());\n+                  // TODO error reporting\n+                } else {\n+                  context.setValue(usernameSetting, null);\n+                  context.setValue(uidSetting, null);\n+                  context.setValue(tokenSetting, null);\n+                }\n+\n+                oldUserId.ifPresent(\n+                    userId ->\n+                        oldToken.ifPresent(\n+                            token -> tokenGenerator.revokeToken(new String(token), userId)));\n+              });\n+        } catch (final InterruptedException e) {\n+          Thread.currentThread().interrupt();\n+        }\n+\n+        /*final String username = usernameField.getText();\n+        context.setValue(uidSetting, username.isEmpty() ? null : username.toCharArray());\n         withSensitiveArray(\n             passwordField::getPassword,\n             password ->\n                 context.setValue(\n                     passwordSetting,\n                     (password.length == 0) ? null : password,\n-                    SaveContext.ValueSensitivity.SENSITIVE));\n+                    SaveContext.ValueSensitivity.SENSITIVE));*/\n       }\n \n       @Override\n       public void resetToDefault() {\n-        usernameField.setText(credentialToString(usernameSetting::getDefaultValue));\n-        passwordField.setText(credentialToString(passwordSetting::getDefaultValue));\n+        usernameField.setText(\"\");\n+        passwordField.setText(\"\");\n       }\n \n       @Override\n       public void reset() {\n-        usernameField.setText(credentialToString(usernameSetting::getValue));\n-        passwordField.setText(credentialToString(passwordSetting::getValue));\n+        usernameField.setText(usernameSetting.getValue().map(String::new).orElse(\"\"));", "originalCommit": "ab9c619722afdf840cb943a271451a4e26799170", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjQ5OTQyNw==", "url": "https://github.com/triplea-game/triplea/pull/6487#discussion_r426499427", "bodyText": "Yes and no.\nIt would make sense changing it to a normal string, but for usernames that are actually stored already it would fill the username field with a cryptic string for the first time, so we'd have to change the name of the setting to something different.\nRegardless I think we should offer a button that performs a \"factory reset\" on the preferences store so users have a way to clear out settings that might no longer be there at all.", "author": "RoiEXLab", "createdAt": "2020-05-18T09:42:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjMyNjQzNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDU2ODMyMw==", "url": "https://github.com/triplea-game/triplea/pull/6487#discussion_r440568323", "bodyText": "IF we change datatype of a client setting, we only need to change the name of the setting. Having something clear out old settings would be nice, but I think certainly nice and not required.", "author": "DanVanAtta", "createdAt": "2020-06-16T03:40:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjMyNjQzNg=="}], "type": "inlineReview"}, {"oid": "eb093cc5c57d43530e33fb1898648cc9ae4d16fc", "url": "https://github.com/triplea-game/triplea/commit/eb093cc5c57d43530e33fb1898648cc9ae4d16fc", "message": "Store Token instead of password", "committedDate": "2020-06-26T12:28:40Z", "type": "commit"}, {"oid": "95687b7a231694113d69eb5df5237af2f015e561", "url": "https://github.com/triplea-game/triplea/commit/95687b7a231694113d69eb5df5237af2f015e561", "message": "Auto-Formatting", "committedDate": "2020-06-26T12:30:11Z", "type": "commit"}, {"oid": "5b4d5b174317f461d90053e32142b3dfd480c748", "url": "https://github.com/triplea-game/triplea/commit/5b4d5b174317f461d90053e32142b3dfd480c748", "message": "Properly reset value", "committedDate": "2020-06-26T12:30:11Z", "type": "commit"}, {"oid": "5b4d5b174317f461d90053e32142b3dfd480c748", "url": "https://github.com/triplea-game/triplea/commit/5b4d5b174317f461d90053e32142b3dfd480c748", "message": "Properly reset value", "committedDate": "2020-06-26T12:30:11Z", "type": "forcePushed"}, {"oid": "203ff3bdcbe708f72c09311df3a743aa7d02f157", "url": "https://github.com/triplea-game/triplea/commit/203ff3bdcbe708f72c09311df3a743aa7d02f157", "message": "Correctly encode username\n\nFixes #6737", "committedDate": "2020-06-26T12:39:17Z", "type": "commit"}, {"oid": "234872820434c4e7e40d7533c9f34ab67b7b1da0", "url": "https://github.com/triplea-game/triplea/commit/234872820434c4e7e40d7533c9f34ab67b7b1da0", "message": "Fix band-aided code", "committedDate": "2020-06-26T13:18:43Z", "type": "commit"}, {"oid": "2091b68f4fda1b947e271b9970ef1156c920304b", "url": "https://github.com/triplea-game/triplea/commit/2091b68f4fda1b947e271b9970ef1156c920304b", "message": "Request Token when actually requiring it", "committedDate": "2020-06-26T13:39:24Z", "type": "commit"}, {"oid": "b109b6a1bd45a3eddb5a9a9a18e974b7e562eec2", "url": "https://github.com/triplea-game/triplea/commit/b109b6a1bd45a3eddb5a9a9a18e974b7e562eec2", "message": "Add 2FA support", "committedDate": "2020-06-26T13:48:53Z", "type": "commit"}, {"oid": "2135f08ec5098de8d253f89eb9e5281efd43b763", "url": "https://github.com/triplea-game/triplea/commit/2135f08ec5098de8d253f89eb9e5281efd43b763", "message": "Pre-Fill remember password checkbox if already remembered", "committedDate": "2020-06-26T13:55:31Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjIwMDY3MQ==", "url": "https://github.com/triplea-game/triplea/pull/6487#discussion_r446200671", "bodyText": "We no longer store passwords, so we have to go for something. Thoughts regarding the recent events? @DanVanAtta", "author": "RoiEXLab", "createdAt": "2020-06-26T13:57:41Z", "path": "game-core/src/main/java/games/strategy/engine/framework/startup/ui/posted/game/pbf/ForumPosterEditorViewModel.java", "diffHunk": "@@ -7,19 +7,27 @@\n import games.strategy.engine.framework.startup.ui.posted.game.HelpTexts;\n import games.strategy.engine.framework.startup.ui.posted.game.pbf.test.post.SwingTestPostProgressDisplayFactory;\n import games.strategy.engine.framework.startup.ui.posted.game.pbf.test.post.TestPostAction;\n+import games.strategy.engine.framework.ui.background.BackgroundTaskRunner;\n import games.strategy.engine.posted.game.pbf.IForumPoster;\n import games.strategy.engine.posted.game.pbf.NodeBbForumPoster;\n+import games.strategy.engine.posted.game.pbf.NodeBbTokenGenerator;\n+import games.strategy.triplea.UrlConstants;\n import games.strategy.triplea.settings.ClientSetting;\n+import java.nio.CharBuffer;\n+import java.util.Arrays;\n import java.util.Optional;\n import java.util.function.BiConsumer;\n import java.util.function.Predicate;\n import lombok.Getter;\n import lombok.Setter;\n+import org.triplea.java.Interruptibles;\n import org.triplea.java.Postconditions;\n import org.triplea.java.StringUtils;\n import org.triplea.java.ViewModelListener;\n \n class ForumPosterEditorViewModel {\n+  private static final int DUMMY_PASSWORD_LENGTH = 4;", "originalCommit": "2135f08ec5098de8d253f89eb9e5281efd43b763", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzMzODIwOA==", "url": "https://github.com/triplea-game/triplea/pull/6487#discussion_r447338208", "bodyText": "Oh.. the UX should be changed then probably. Perhaps a button to log in to the forum, clicking that asks for username and password, and once done then the user sees a \"credentials saved\" label somewhere and are given a button to clear their credentials. When entering in their credentials, that would be a good place to have a checkbox for \"clear credentials when the application closes\".\nThis way we never need to enter in a dummy password at all, we don't have to worry about a remember password checkbox, and if the credentials are already entered we don't show needless text fields on the UI.", "author": "DanVanAtta", "createdAt": "2020-06-30T00:35:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjIwMDY3MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjIwNjY5Ng==", "url": "https://github.com/triplea-game/triplea/pull/6487#discussion_r446206696", "bodyText": "Note this fix for #6737 I added", "author": "RoiEXLab", "createdAt": "2020-06-26T14:07:51Z", "path": "game-core/src/main/java/games/strategy/engine/posted/game/pbf/NodeBbTokenGenerator.java", "diffHunk": "@@ -0,0 +1,131 @@\n+package games.strategy.engine.posted.game.pbf;\n+\n+import com.google.common.base.Preconditions;\n+import games.strategy.engine.framework.system.HttpProxy;\n+import java.io.IOException;\n+import java.net.URLEncoder;\n+import java.nio.charset.StandardCharsets;\n+import java.util.List;\n+import java.util.Map;\n+import javax.annotation.Nonnull;\n+import javax.annotation.Nullable;\n+import lombok.AccessLevel;\n+import lombok.AllArgsConstructor;\n+import lombok.Getter;\n+import org.apache.http.client.entity.UrlEncodedFormEntity;\n+import org.apache.http.client.methods.CloseableHttpResponse;\n+import org.apache.http.client.methods.HttpDelete;\n+import org.apache.http.client.methods.HttpGet;\n+import org.apache.http.client.methods.HttpPost;\n+import org.apache.http.impl.client.CloseableHttpClient;\n+import org.apache.http.impl.client.HttpClients;\n+import org.apache.http.message.BasicNameValuePair;\n+import org.apache.http.util.EntityUtils;\n+import org.snakeyaml.engine.v2.api.Load;\n+import org.snakeyaml.engine.v2.api.LoadSettings;\n+\n+@AllArgsConstructor\n+public class NodeBbTokenGenerator {\n+  private final String forumUrl;\n+  private final Load load = new Load(LoadSettings.builder().build());\n+\n+  @AllArgsConstructor(access = AccessLevel.PRIVATE)\n+  @Getter\n+  public static class TokenInfo {\n+    @Nonnull private final String token;\n+    private final int userId;\n+  }\n+\n+  public TokenInfo generateToken(\n+      final String username, final String password, @Nullable final String otp) {\n+    Preconditions.checkNotNull(username);\n+    Preconditions.checkNotNull(password);\n+\n+    try (CloseableHttpClient client = HttpClients.custom().disableCookieManagement().build()) {\n+      final int userId = getUserId(client, username);\n+      return new TokenInfo(getToken(client, userId, password, otp), userId);\n+    } catch (final IOException e) {\n+      throw new RuntimeException(\"Failed to retrieve login token\", e);\n+    }\n+  }\n+\n+  public void revokeToken(final String token, final int userId) {\n+    try (CloseableHttpClient client = HttpClients.custom().disableCookieManagement().build()) {\n+      deleteToken(client, userId, token);\n+    } catch (final IOException e) {\n+      throw new RuntimeException(\"Failed to revoke login token\", e);\n+    }\n+  }\n+\n+  private void deleteToken(final CloseableHttpClient client, final int userId, final String token)\n+      throws IOException {\n+    final HttpDelete httpDelete =\n+        new HttpDelete(forumUrl + \"/api/v2/users/\" + userId + \"/tokens/\" + token);\n+    HttpProxy.addProxy(httpDelete);\n+    httpDelete.addHeader(\"Authorization\", \"Bearer \" + token);\n+    client.execute(httpDelete).close(); // ignore errors, execute and then close\n+  }\n+\n+  private int getUserId(final CloseableHttpClient client, final String username)\n+      throws IOException {\n+    final Map<?, ?> jsonObject = queryUserInfo(client, username);\n+    checkUser(jsonObject, username);\n+    return (Integer) jsonObject.get(\"uid\");\n+  }\n+\n+  private void checkUser(final Map<?, ?> jsonObject, final String username) {\n+    if (!jsonObject.containsKey(\"uid\")) {\n+      throw new IllegalStateException(String.format(\"User %s doesn't exist.\", username));\n+    }\n+    if (1 == (Integer) jsonObject.get(\"banned\")) {\n+      throw new IllegalStateException(\"Your account is banned from the forum.\");\n+    }\n+    if (1 != (Integer) jsonObject.get(\"email:confirmed\")) {\n+      throw new IllegalStateException(\"Your email isn't confirmed yet!\");\n+    }\n+  }\n+\n+  private Map<?, ?> queryUserInfo(final CloseableHttpClient client, final String username)\n+      throws IOException {\n+    final String encodedUsername = URLEncoder.encode(username, StandardCharsets.UTF_8);", "originalCommit": "2135f08ec5098de8d253f89eb9e5281efd43b763", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjcxOTM5Mg==", "url": "https://github.com/triplea-game/triplea/pull/6487#discussion_r446719392", "bodyText": "@RoiEXLab we should probably put the bug fix to its own PR:\n\nwhen this gets squashed, a bug fix being mixed in with a feature update will be somewhat confusing\nthe bugfix needs to go out with the next release, which could be as soon as tonight or tomorrow.", "author": "DanVanAtta", "createdAt": "2020-06-29T00:32:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjIwNjY5Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjcxOTY3OQ==", "url": "https://github.com/triplea-game/triplea/pull/6487#discussion_r446719679", "bodyText": "Would be nice to see a test case for this as well considering it was a bug. Tests are good for preventing future regressions, ensuring bugs are fixed well, and for giving feedback if the code is designed well, which should drive generally better code design (or at least prevent completely ad-hoc and  chaotic design).", "author": "DanVanAtta", "createdAt": "2020-06-29T00:35:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjIwNjY5Ng=="}], "type": "inlineReview"}, {"oid": "0648341b727a9f6e7a3e002d4563498d070ea108", "url": "https://github.com/triplea-game/triplea/commit/0648341b727a9f6e7a3e002d4563498d070ea108", "message": "Fix test compilation errors", "committedDate": "2020-06-26T14:12:03Z", "type": "commit"}, {"oid": "a904cc66bffb94b4174d07caa72206d41c42e17c", "url": "https://github.com/triplea-game/triplea/commit/a904cc66bffb94b4174d07caa72206d41c42e17c", "message": "Fix test cases", "committedDate": "2020-06-26T14:36:48Z", "type": "commit"}, {"oid": "61057e7eb37e0fe4d2b6767aaa651429de9b6df7", "url": "https://github.com/triplea-game/triplea/commit/61057e7eb37e0fe4d2b6767aaa651429de9b6df7", "message": "Make tests headless friendly", "committedDate": "2020-06-26T14:49:37Z", "type": "commit"}, {"oid": "73faf150fe74965ee5176e114f31438b97d53e4f", "url": "https://github.com/triplea-game/triplea/commit/73faf150fe74965ee5176e114f31438b97d53e4f", "message": "Make var final", "committedDate": "2020-06-26T15:13:50Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjcxOTk2Ng==", "url": "https://github.com/triplea-game/triplea/pull/6487#discussion_r446719966", "bodyText": "otp is not that well known of an acronym. What is it spelled out?\nCan we add a help text or box next to this as well to explain what this is for a user? We do want people to use this after all. If we look at the 1.9 PBF menu, we can see that the game explained pretty much all the options quite well. This meant any user could learn how to use PBF, even if it was kinda clunky.\n2FA OTP-code is a bit cryptic to even me. I think we'll need to help users a bit more, and/or explain when/why they'd want to use this. I'm a bit curious myself when we would want to use OTP code and not just use passwords.", "author": "DanVanAtta", "createdAt": "2020-06-29T00:37:38Z", "path": "game-core/src/main/java/games/strategy/engine/framework/startup/ui/posted/game/pbf/ForumPosterEditor.java", "diffHunk": "@@ -41,13 +41,15 @@\n   private final JTextField usernameField = new JTextField();\n   private final JLabel passwordLabel = new JLabel(\"Forum Password\");\n   private final JPasswordField passwordField = new JPasswordField();\n+  private final JLabel otpLabel = new JLabel(\"2FA OTP-Code (optional)\");", "originalCommit": "73faf150fe74965ee5176e114f31438b97d53e4f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njk1ODk5Nw==", "url": "https://github.com/triplea-game/triplea/pull/6487#discussion_r446958997", "bodyText": "OTP is short for \"One-Time-Password\".\nThis Field is only required for people that have 2FA enabled in the Forum. Up until recently the \"write-api\" for NodeBB didn't check if 2FA was enabled and just ignored it. Because @panther2 pointed this out I created an issue which lead to a fix. Currently people with 2FA enabled can't use PbF at all and this extra field should fix this", "author": "RoiEXLab", "createdAt": "2020-06-29T13:11:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjcxOTk2Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njk1OTM1OA==", "url": "https://github.com/triplea-game/triplea/pull/6487#discussion_r446959358", "bodyText": "Also perhaps worth mentioning: The OTP isn't a replacement for the password, it is a necessary addition", "author": "RoiEXLab", "createdAt": "2020-06-29T13:11:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjcxOTk2Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzA0NTI3Ng==", "url": "https://github.com/triplea-game/triplea/pull/6487#discussion_r447045276", "bodyText": "Cool, that is good context. Do you have a plan for how to convey that information to users? Specifically, what the field is, when it is needed, and if then not already clear - perhaps where to get their OTP when it is needed.", "author": "DanVanAtta", "createdAt": "2020-06-29T15:10:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjcxOTk2Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzMxNzk0Mw==", "url": "https://github.com/triplea-game/triplea/pull/6487#discussion_r447317943", "bodyText": "Not really, but I think this is a problem that isn't limited to TripleA. How can we explain or even advertise 2FA for users?\nFor most people this just adds another inconvenient step to the login process, and I'd assume most people already using 2FA know what to look out for, they don't need any extra explanation, they just want a field to enter their newly generated code.\nIf you have any good explanation, please let me know. I'd also like to know how to explain such an \"abstract\" concept in such a limited screen space \ud83e\udd14", "author": "RoiEXLab", "createdAt": "2020-06-29T23:34:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjcxOTk2Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzMxODMwNA==", "url": "https://github.com/triplea-game/triplea/pull/6487#discussion_r447318304", "bodyText": "To clarify: Obviously we could implement a wall of text, but I bet most people aren't going to read it if it's more than a couple of lines", "author": "RoiEXLab", "createdAt": "2020-06-29T23:35:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjcxOTk2Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzMzNjQ0NQ==", "url": "https://github.com/triplea-game/triplea/pull/6487#discussion_r447336445", "bodyText": "A help button that says this field is used if \"2FA is enabled. That this value can be found in forum settings. Doesn't have to be anything to complicated. Leaving it as 'OTP' though is going to be cryptic.", "author": "DanVanAtta", "createdAt": "2020-06-30T00:29:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjcxOTk2Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjcyMDE3OQ==", "url": "https://github.com/triplea-game/triplea/pull/6487#discussion_r446720179", "bodyText": "nit, view should not be doing logic if it has a view model. The view model should be the one that owns the full logic of when 'rememberPassword' is selected.\nWould recommend to fix by moving the logic to view model, EG:\nrememberPassword.setSelected(viewModel.isRememberPasswordSelected());", "author": "DanVanAtta", "createdAt": "2020-06-29T00:39:00Z", "path": "game-core/src/main/java/games/strategy/engine/framework/startup/ui/posted/game/pbf/ForumPosterEditor.java", "diffHunk": "@@ -63,6 +65,10 @@\n     super(new GridBagLayout());\n     this.viewModel = viewModel;\n     viewModel.setView(this);\n+    // If password is already stored we already remember\n+    if (viewModel.isForumPasswordValid()) {", "originalCommit": "73faf150fe74965ee5176e114f31438b97d53e4f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzMyMDQ1Mw==", "url": "https://github.com/triplea-game/triplea/pull/6487#discussion_r447320453", "bodyText": "To be honest this is more like a hack.\nIf the user already has a token stored, it makes no sense to have \"Remember Password\" unchecked, which would cause the credentials to be removed on close by default.\nOn the other hand if no token is stored it \"defaults\" to the ClientSetting that stores the last state. That's why the code is the way it is.\nI think \"Remember Password\" shouldn't be a client setting at all. The checkbox should be selected by default if and only if the token is already stored and leave it up to the user to alter this behaviour.", "author": "RoiEXLab", "createdAt": "2020-06-29T23:41:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjcyMDE3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzMzNzM5OQ==", "url": "https://github.com/triplea-game/triplea/pull/6487#discussion_r447337399", "bodyText": "The 'remember password' is a setting as we are currently supporting passwords, and if you select the box then you want it checked, and if you unselect it then it'll be annoying to have to unselect it every time. Those users are probably very worried about their password and if they forget to unselect the value then they'll be unhappy with the software for allowing the error.\nIt sounds like if 'remember password' does not apply with tokens then it should be hidden.\nEither way, any if statements should be removed from the view and moved to the model. The view should not know how to compute the UI state, it should ask the model what its appropriate state should be and render that.", "author": "DanVanAtta", "createdAt": "2020-06-30T00:32:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjcyMDE3OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjcyMDM1MA==", "url": "https://github.com/triplea-game/triplea/pull/6487#discussion_r446720350", "bodyText": "Could use a javadoc on this class IMO to explain it's general usage and how it works.", "author": "DanVanAtta", "createdAt": "2020-06-29T00:40:09Z", "path": "game-core/src/main/java/games/strategy/engine/posted/game/pbf/NodeBbTokenGenerator.java", "diffHunk": "@@ -0,0 +1,131 @@\n+package games.strategy.engine.posted.game.pbf;\n+\n+import com.google.common.base.Preconditions;\n+import games.strategy.engine.framework.system.HttpProxy;\n+import java.io.IOException;\n+import java.net.URLEncoder;\n+import java.nio.charset.StandardCharsets;\n+import java.util.List;\n+import java.util.Map;\n+import javax.annotation.Nonnull;\n+import javax.annotation.Nullable;\n+import lombok.AccessLevel;\n+import lombok.AllArgsConstructor;\n+import lombok.Getter;\n+import org.apache.http.client.entity.UrlEncodedFormEntity;\n+import org.apache.http.client.methods.CloseableHttpResponse;\n+import org.apache.http.client.methods.HttpDelete;\n+import org.apache.http.client.methods.HttpGet;\n+import org.apache.http.client.methods.HttpPost;\n+import org.apache.http.impl.client.CloseableHttpClient;\n+import org.apache.http.impl.client.HttpClients;\n+import org.apache.http.message.BasicNameValuePair;\n+import org.apache.http.util.EntityUtils;\n+import org.snakeyaml.engine.v2.api.Load;\n+import org.snakeyaml.engine.v2.api.LoadSettings;\n+\n+@AllArgsConstructor\n+public class NodeBbTokenGenerator {", "originalCommit": "73faf150fe74965ee5176e114f31438b97d53e4f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "5890bdeaab62d61cc37b6204ac580f62ea8dc43d", "url": "https://github.com/triplea-game/triplea/commit/5890bdeaab62d61cc37b6204ac580f62ea8dc43d", "message": "Use isBlank() instead of isEmpty()", "committedDate": "2020-06-29T23:49:28Z", "type": "commit"}, {"oid": "2619e0b8611b1c851c39388bc7214d91d4dec48f", "url": "https://github.com/triplea-game/triplea/commit/2619e0b8611b1c851c39388bc7214d91d4dec48f", "message": "Add javadoc", "committedDate": "2020-06-29T23:49:41Z", "type": "commit"}, {"oid": "3e21fdaccdfc3712e3262af06f8f47244ac68322", "url": "https://github.com/triplea-game/triplea/commit/3e21fdaccdfc3712e3262af06f8f47244ac68322", "message": "Merge branch 'master' into store-forum-token", "committedDate": "2020-07-10T13:45:51Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mjg1NzQ2NQ==", "url": "https://github.com/triplea-game/triplea/pull/6487#discussion_r452857465", "bodyText": "Codacy found an issue: Avoid throwing raw exception types.", "author": "DanVanAtta", "createdAt": "2020-07-10T13:52:34Z", "path": "game-core/src/main/java/games/strategy/engine/posted/game/pbf/NodeBbTokenGenerator.java", "diffHunk": "@@ -0,0 +1,155 @@\n+package games.strategy.engine.posted.game.pbf;\n+\n+import com.google.common.base.Preconditions;\n+import games.strategy.engine.framework.system.HttpProxy;\n+import java.io.IOException;\n+import java.net.URLEncoder;\n+import java.nio.charset.StandardCharsets;\n+import java.util.List;\n+import java.util.Map;\n+import javax.annotation.Nonnull;\n+import javax.annotation.Nullable;\n+import lombok.AccessLevel;\n+import lombok.AllArgsConstructor;\n+import lombok.Getter;\n+import org.apache.http.client.entity.UrlEncodedFormEntity;\n+import org.apache.http.client.methods.CloseableHttpResponse;\n+import org.apache.http.client.methods.HttpDelete;\n+import org.apache.http.client.methods.HttpGet;\n+import org.apache.http.client.methods.HttpPost;\n+import org.apache.http.impl.client.CloseableHttpClient;\n+import org.apache.http.impl.client.HttpClients;\n+import org.apache.http.message.BasicNameValuePair;\n+import org.apache.http.util.EntityUtils;\n+import org.snakeyaml.engine.v2.api.Load;\n+import org.snakeyaml.engine.v2.api.LoadSettings;\n+\n+/**\n+ * Helper class containing the necessary logic to fetch and revoke login tokens for NodeBB forum\n+ * software.\n+ */\n+@AllArgsConstructor\n+public class NodeBbTokenGenerator {\n+  private final String forumUrl;\n+  private final Load load = new Load(LoadSettings.builder().build());\n+\n+  /**\n+   * Data class used to wrap a newly generated token and the {@link #userId} the token was created\n+   * for in a single object.\n+   */\n+  @AllArgsConstructor(access = AccessLevel.PRIVATE)\n+  @Getter\n+  public static class TokenInfo {\n+    @Nonnull private final String token;\n+    private final int userId;\n+  }\n+\n+  /**\n+   * Generates a NodeBB login token.\n+   *\n+   * @param username The username to create the token for.\n+   * @param password The password used by the user to login.\n+   * @param otp (optional, can be null) The One-Time-Password in case the User has 2FA enabled for\n+   *     their account.\n+   * @return The {@link TokenInfo} object containing the newly generated token and the associated\n+   *     userId of the provided username.\n+   */\n+  public TokenInfo generateToken(\n+      final String username, final String password, @Nullable final String otp) {\n+    Preconditions.checkNotNull(username);\n+    Preconditions.checkNotNull(password);\n+\n+    try (CloseableHttpClient client = HttpClients.custom().disableCookieManagement().build()) {\n+      final int userId = getUserId(client, username);\n+      return new TokenInfo(getToken(client, userId, password, otp), userId);\n+    } catch (final IOException e) {\n+      throw new RuntimeException(\"Failed to retrieve login token\", e);", "originalCommit": "3e21fdaccdfc3712e3262af06f8f47244ac68322", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mjg1NzQ3MQ==", "url": "https://github.com/triplea-game/triplea/pull/6487#discussion_r452857471", "bodyText": "Codacy found an issue: Avoid throwing raw exception types.", "author": "DanVanAtta", "createdAt": "2020-07-10T13:52:35Z", "path": "game-core/src/main/java/games/strategy/engine/posted/game/pbf/NodeBbTokenGenerator.java", "diffHunk": "@@ -0,0 +1,155 @@\n+package games.strategy.engine.posted.game.pbf;\n+\n+import com.google.common.base.Preconditions;\n+import games.strategy.engine.framework.system.HttpProxy;\n+import java.io.IOException;\n+import java.net.URLEncoder;\n+import java.nio.charset.StandardCharsets;\n+import java.util.List;\n+import java.util.Map;\n+import javax.annotation.Nonnull;\n+import javax.annotation.Nullable;\n+import lombok.AccessLevel;\n+import lombok.AllArgsConstructor;\n+import lombok.Getter;\n+import org.apache.http.client.entity.UrlEncodedFormEntity;\n+import org.apache.http.client.methods.CloseableHttpResponse;\n+import org.apache.http.client.methods.HttpDelete;\n+import org.apache.http.client.methods.HttpGet;\n+import org.apache.http.client.methods.HttpPost;\n+import org.apache.http.impl.client.CloseableHttpClient;\n+import org.apache.http.impl.client.HttpClients;\n+import org.apache.http.message.BasicNameValuePair;\n+import org.apache.http.util.EntityUtils;\n+import org.snakeyaml.engine.v2.api.Load;\n+import org.snakeyaml.engine.v2.api.LoadSettings;\n+\n+/**\n+ * Helper class containing the necessary logic to fetch and revoke login tokens for NodeBB forum\n+ * software.\n+ */\n+@AllArgsConstructor\n+public class NodeBbTokenGenerator {\n+  private final String forumUrl;\n+  private final Load load = new Load(LoadSettings.builder().build());\n+\n+  /**\n+   * Data class used to wrap a newly generated token and the {@link #userId} the token was created\n+   * for in a single object.\n+   */\n+  @AllArgsConstructor(access = AccessLevel.PRIVATE)\n+  @Getter\n+  public static class TokenInfo {\n+    @Nonnull private final String token;\n+    private final int userId;\n+  }\n+\n+  /**\n+   * Generates a NodeBB login token.\n+   *\n+   * @param username The username to create the token for.\n+   * @param password The password used by the user to login.\n+   * @param otp (optional, can be null) The One-Time-Password in case the User has 2FA enabled for\n+   *     their account.\n+   * @return The {@link TokenInfo} object containing the newly generated token and the associated\n+   *     userId of the provided username.\n+   */\n+  public TokenInfo generateToken(\n+      final String username, final String password, @Nullable final String otp) {\n+    Preconditions.checkNotNull(username);\n+    Preconditions.checkNotNull(password);\n+\n+    try (CloseableHttpClient client = HttpClients.custom().disableCookieManagement().build()) {\n+      final int userId = getUserId(client, username);\n+      return new TokenInfo(getToken(client, userId, password, otp), userId);\n+    } catch (final IOException e) {\n+      throw new RuntimeException(\"Failed to retrieve login token\", e);\n+    }\n+  }\n+\n+  /**\n+   * Revokes a NodeBB login token.\n+   *\n+   * @param token The login token to revoke.\n+   * @param userId The userId that the token was issued for.\n+   */\n+  public void revokeToken(final String token, final int userId) {\n+    try (CloseableHttpClient client = HttpClients.custom().disableCookieManagement().build()) {\n+      deleteToken(client, userId, token);\n+    } catch (final IOException e) {\n+      throw new RuntimeException(\"Failed to revoke login token\", e);", "originalCommit": "3e21fdaccdfc3712e3262af06f8f47244ac68322", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mjg1NzQ4Ng==", "url": "https://github.com/triplea-game/triplea/pull/6487#discussion_r452857486", "bodyText": "Codacy found an issue: Avoid instantiating String objects; this is usually unnecessary.", "author": "DanVanAtta", "createdAt": "2020-07-10T13:52:36Z", "path": "game-core/src/main/java/games/strategy/engine/posted/game/pbf/NodeBbForumPoster.java", "diffHunk": "@@ -67,10 +59,7 @@\n   private NodeBbForumPoster(final ForumPostingParameters forumPostingParameters) {\n     this.topicId = forumPostingParameters.topicId;\n     this.forumUrl = forumPostingParameters.forumUrl;\n-    this.username =\n-        Arrays.withSensitiveArrayAndReturn(() -> forumPostingParameters.username, String::new);\n-    this.password =\n-        Arrays.withSensitiveArrayAndReturn(() -> forumPostingParameters.password, String::new);\n+    this.token = new String(forumPostingParameters.token);", "originalCommit": "3e21fdaccdfc3712e3262af06f8f47244ac68322", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}