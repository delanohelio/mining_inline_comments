{"pr_number": 6641, "pr_title": "Improve deploy prerelease script", "pr_createdAt": "2020-06-08T04:28:30Z", "pr_url": "https://github.com/triplea-game/triplea/pull/6641", "timeline": [{"oid": "db44ae69312f0b828783f6686941beac912c9786", "url": "https://github.com/triplea-game/triplea/commit/db44ae69312f0b828783f6686941beac912c9786", "message": "Combine build_deployment_artifacts script with run_ansible_prerelease", "committedDate": "2020-06-08T04:22:24Z", "type": "commit"}, {"oid": "3df516da72a2ccd18366d96ce70569acd0a484ef", "url": "https://github.com/triplea-game/triplea/commit/3df516da72a2ccd18366d96ce70569acd0a484ef", "message": "Group run_ansible_prerelease script tasks into functions", "committedDate": "2020-06-08T04:26:11Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjQ1MTk1Ng==", "url": "https://github.com/triplea-game/triplea/pull/6641#discussion_r436451956", "bodyText": "Use runDeployment \"$@\" if function's $1 should mean script's $1.", "author": "codeclimate", "createdAt": "2020-06-08T04:30:52Z", "path": "infrastructure/run_ansible_prerelease", "diffHunk": "@@ -28,28 +28,45 @@ if [ ! -f \"$VAULT_PASSWORD_FILE\" ]; then\n   exit 1\n fi\n \n-HTTP_SERVER_JAR=\"ansible/roles/http_server/files/triplea-http-server-$VERSION.jar\"\n-if [ ! -f \"$HTTP_SERVER_JAR\" ]; then\n-  echo \"Error: File does not exist: $HTTP_SERVER_JAR\"\n-  exit 1\n-fi\n \n-BOT_JAR=\"ansible/roles/bot/files/triplea-game-headless-$VERSION.jar\"\n-if [ ! -f \"$BOT_JAR\" ]; then\n-  echo \"Error: File does not exist: $BOT_JAR\"\n-  exit 1\n-fi\n+function main() {\n+  buildArtifacts\n+  addPrivateSshKeyToAgent\n+  runDeployment", "originalCommit": "3df516da72a2ccd18366d96ce70569acd0a484ef", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjQ1MTk1OA==", "url": "https://github.com/triplea-game/triplea/pull/6641#discussion_r436451958", "bodyText": "runDeployment references arguments, but none are ever passed.", "author": "codeclimate", "createdAt": "2020-06-08T04:30:53Z", "path": "infrastructure/run_ansible_prerelease", "diffHunk": "@@ -28,28 +28,45 @@ if [ ! -f \"$VAULT_PASSWORD_FILE\" ]; then\n   exit 1\n fi\n \n-HTTP_SERVER_JAR=\"ansible/roles/http_server/files/triplea-http-server-$VERSION.jar\"\n-if [ ! -f \"$HTTP_SERVER_JAR\" ]; then\n-  echo \"Error: File does not exist: $HTTP_SERVER_JAR\"\n-  exit 1\n-fi\n \n-BOT_JAR=\"ansible/roles/bot/files/triplea-game-headless-$VERSION.jar\"\n-if [ ! -f \"$BOT_JAR\" ]; then\n-  echo \"Error: File does not exist: $BOT_JAR\"\n-  exit 1\n-fi\n+function main() {\n+  buildArtifacts\n+  addPrivateSshKeyToAgent\n+  runDeployment\n+}\n \n-MIGRATIONS_ZIP=\"ansible/roles/flyway/files/migrations.zip\"\n-if [ ! -f \"$MIGRATIONS_ZIP\" ]; then\n-  echo \"Error: File does not exist: $MIGRATIONS_ZIP\"\n-  exit 1\n-fi\n+function buildArtifacts() {\n+  ../gradlew :http-server:shadowJar :game-headless:shadowJar :lobby-db:release\n+  copyBuildArtifact \"../lobby-db/build/artifacts/migrations.zip\" \"ansible/roles/database/flyway/files/\"\n+  copyBuildArtifact \"../http-server/build/artifacts/triplea-http-server-$VERSION.jar\" \"ansible/roles/http_server/files/\"\n+  copyBuildArtifact \"../game-headless/build/artifacts/triplea-game-headless-$VERSION.jar\" \"ansible/roles/bot/files/\"\n+}\n+\n+function copyBuildArtifact() {\n+  local -r artifactSource=\"$1\"\n+  local -r artifactDestinationPath=\"$2\"\n+\n+  if [ ! -f \"$artifactSource\" ]; then\n+    echo \"Error: File does not exist: $artifactSource\"\n+    exit 1\n+  fi\n+\n+  mkdir -p \"$artifactDestinationPath\"\n+  cp \"$artifactSource\" \"$artifactDestinationPath\"\n+}\n+\n+\n+function addPrivateSshKeyToAgent() {\n+  ansible-vault view --vault-password-file=\"$VAULT_PASSWORD_FILE\" ansible_ssh_key.ed25519 | ssh-add -\n+}\n+\n+function runDeployment() {", "originalCommit": "3df516da72a2ccd18366d96ce70569acd0a484ef", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "8dfef50e1b42acfe6596607479cf54b756346bcc", "url": "https://github.com/triplea-game/triplea/commit/8dfef50e1b42acfe6596607479cf54b756346bcc", "message": "Pass script args to 'main'", "committedDate": "2020-06-08T04:37:30Z", "type": "commit"}]}