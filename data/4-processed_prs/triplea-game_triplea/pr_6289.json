{"pr_number": 6289, "pr_title": "Speed up code in UnitsHitChange.", "pr_createdAt": "2020-04-18T13:32:23Z", "pr_url": "https://github.com/triplea-game/triplea/pull/6289", "timeline": [{"oid": "0dc31a1f1cba2accd269510d79987b3a7cabf722", "url": "https://github.com/triplea-game/triplea/commit/0dc31a1f1cba2accd269510d79987b3a7cabf722", "message": "Speed up codein UnitsHitChange.\n\nPreviously, this code would need to look at all units in all\nterritories to figure out which territories were affected, so\nthat they can be notified. This was quite slow, taking 254 sec\nover one round of all-AI Domination 1914.\n\nThis change explicitly passes the list of affected territories\nto the change object, eliminating that extra work. On the same\nDomination 1914 all-AI round, UnitsHitsChange.perform() now only\ntakes 200 ms (instead of 254 sec).", "committedDate": "2020-04-18T13:25:54Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDczNDAzOA==", "url": "https://github.com/triplea-game/triplea/pull/6289#discussion_r410734038", "bodyText": "Is this disjoint check just not needed in the end?", "author": "DanVanAtta", "createdAt": "2020-04-18T18:36:22Z", "path": "game-core/src/main/java/games/strategy/engine/data/UnitHitsChange.java", "diffHunk": "@@ -10,35 +9,42 @@\n \n   private final IntegerMap<Unit> hits;\n   private final IntegerMap<Unit> undoHits;\n+  private final Collection<Territory> territoriesToNotify;\n \n-  private UnitHitsChange(final IntegerMap<Unit> hits, final IntegerMap<Unit> undoHits) {\n+  private UnitHitsChange(\n+      final IntegerMap<Unit> hits,\n+      final IntegerMap<Unit> undoHits,\n+      final Collection<Territory> territoriesToNotify) {\n     this.hits = hits;\n     this.undoHits = undoHits;\n+    this.territoriesToNotify = territoriesToNotify;\n   }\n \n-  public UnitHitsChange(final IntegerMap<Unit> hits) {\n-    this.hits = new IntegerMap<>(hits);\n-    undoHits = new IntegerMap<>();\n-    for (final Unit item : this.hits.keySet()) {\n+  public UnitHitsChange(\n+      final IntegerMap<Unit> hits, final Collection<Territory> territoriesToNotify) {\n+    this(new IntegerMap<>(hits), undoHits(hits), territoriesToNotify);\n+  }\n+\n+  private static IntegerMap<Unit> undoHits(final IntegerMap<Unit> hits) {\n+    final var undoHits = new IntegerMap<Unit>();\n+    for (final Unit item : hits.keySet()) {\n       undoHits.put(item, item.getHits());\n     }\n+    return undoHits;\n   }\n \n   @Override\n   protected void perform(final GameData data) {\n     for (final Unit item : hits.keySet()) {\n       item.setHits(hits.getInt(item));\n     }\n-    final Set<Unit> units = hits.keySet();\n-    for (final Territory element : data.getMap().getTerritories()) {\n-      if (!Collections.disjoint(element.getUnits(), units)) {", "originalCommit": "0dc31a1f1cba2accd269510d79987b3a7cabf722", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDc0NjE1OQ==", "url": "https://github.com/triplea-game/triplea/pull/6289#discussion_r410746159", "bodyText": "That's right. The old code was using it to determine if the affected units are in the territory in question. Now, we track that directly, so this is removed. (This call was what was so slow in the first place.)", "author": "asvitkine", "createdAt": "2020-04-18T20:25:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDczNDAzOA=="}], "type": "inlineReview"}]}