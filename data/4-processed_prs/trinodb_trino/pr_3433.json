{"pr_number": 3433, "pr_title": "Add fixed, cert, jwt and kerberos UI authentication", "pr_createdAt": "2020-04-14T22:52:42Z", "pr_url": "https://github.com/trinodb/trino/pull/3433", "timeline": [{"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODczMzU2MA==", "url": "https://github.com/trinodb/trino/pull/3433#discussion_r418733560", "bodyText": "Consider making this non-static with delegation to isSecure, as that keeps the method invocations simpler.", "author": "electrum", "createdAt": "2020-05-01T20:54:03Z", "path": "presto-main/src/main/java/io/prestosql/server/ui/FormWebUiAuthenticationManager.java", "diffHunk": "@@ -328,14 +336,9 @@ static String getRedirectLocation(HttpServletRequest request, String path, Strin\n         return builder.toString();\n     }\n \n-    private static boolean isHttps(HttpServletRequest request)", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODczNjI5Ng==", "url": "https://github.com/trinodb/trino/pull/3433#discussion_r418736296", "bodyText": "Why take the first one? What if none of them match a web UI authenticator type?", "author": "electrum", "createdAt": "2020-05-01T21:01:36Z", "path": "presto-main/src/main/java/io/prestosql/server/ui/WebUiAuthenticationModule.java", "diffHunk": "@@ -0,0 +1,87 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.server.ui;\n+\n+import com.google.inject.Binder;\n+import com.google.inject.Module;\n+import io.airlift.configuration.AbstractConfigurationAwareModule;\n+import io.prestosql.server.security.SecurityConfig;\n+\n+import java.util.List;\n+\n+import static com.google.common.collect.ImmutableList.toImmutableList;\n+import static io.airlift.configuration.ConfigBinder.configBinder;\n+import static java.util.Locale.ENGLISH;\n+import static java.util.Objects.requireNonNull;\n+\n+public class WebUiAuthenticationModule\n+        extends AbstractConfigurationAwareModule\n+{\n+    @Override\n+    protected void setup(Binder binder)\n+    {\n+        configBinder(binder).bindConfig(WebUiAuthenticationConfig.class);\n+\n+        installWebUiAuthenticator(\"form\", new FormUiAuthenticatorModule());\n+    }\n+\n+    private void installWebUiAuthenticator(String type, Module module)\n+    {\n+        install(webUiAuthenticator(type, module));\n+    }\n+\n+    public static Module webUiAuthenticator(String type, Module module)\n+    {\n+        return new ConditionalWebUiAuthenticationModule(type, module);\n+    }\n+\n+    private static class ConditionalWebUiAuthenticationModule\n+            extends AbstractConfigurationAwareModule\n+    {\n+        private final String type;\n+        private final Module module;\n+\n+        public ConditionalWebUiAuthenticationModule(String type, Module module)\n+        {\n+            this.type = requireNonNull(type, \"type is null\");\n+            this.module = requireNonNull(module, \"module is null\");\n+        }\n+\n+        @Override\n+        protected void setup(Binder binder)\n+        {\n+            if (type.equals(getAuthenticationType())) {\n+                install(module);\n+            }\n+        }\n+\n+        private String getAuthenticationType()\n+        {\n+            String authentication = buildConfigObject(WebUiAuthenticationConfig.class).getAuthentication();\n+            if (authentication != null) {\n+                return authentication;\n+            }\n+\n+            List<String> authenticationTypes = buildConfigObject(SecurityConfig.class).getAuthenticationTypes().stream()\n+                    .map(type -> type.toLowerCase(ENGLISH))\n+                    .collect(toImmutableList());\n+            if (authenticationTypes.contains(\"password\")) {\n+                return \"form\";\n+            }\n+            return authenticationTypes.stream()", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTc1OTUzNw==", "url": "https://github.com/trinodb/trino/pull/3433#discussion_r421759537", "bodyText": "The web ui only supports a single authenticator, so we choose the first on in the list, or if there are no authenticators, we use form since it handles that case.", "author": "dain", "createdAt": "2020-05-07T20:00:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODczNjI5Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODczNjkyNw==", "url": "https://github.com/trinodb/trino/pull/3433#discussion_r418736927", "bodyText": "Nit: normally \"username\" is one word", "author": "electrum", "createdAt": "2020-05-01T21:03:25Z", "path": "presto-main/src/main/java/io/prestosql/server/ui/FixedUserWebUIConfig.java", "diffHunk": "@@ -0,0 +1,36 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.server.ui;\n+\n+import io.airlift.configuration.Config;\n+\n+import javax.validation.constraints.NotNull;\n+\n+public class FixedUserWebUIConfig\n+{\n+    private String userName;", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODczNzIzMA==", "url": "https://github.com/trinodb/trino/pull/3433#discussion_r418737230", "bodyText": "Fix case of Ui -> FixedUserWebUiConfig", "author": "electrum", "createdAt": "2020-05-01T21:04:11Z", "path": "presto-main/src/main/java/io/prestosql/server/ui/FixedUserWebUIConfig.java", "diffHunk": "@@ -0,0 +1,36 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.server.ui;\n+\n+import io.airlift.configuration.Config;\n+\n+import javax.validation.constraints.NotNull;\n+\n+public class FixedUserWebUIConfig", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODczNzQyNw==", "url": "https://github.com/trinodb/trino/pull/3433#discussion_r418737427", "bodyText": "Check for null", "author": "electrum", "createdAt": "2020-05-01T21:04:41Z", "path": "presto-main/src/main/java/io/prestosql/server/ui/FixedUserWebUiAuthenticationManager.java", "diffHunk": "@@ -0,0 +1,65 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.server.ui;\n+\n+import io.prestosql.spi.security.BasicPrincipal;\n+import io.prestosql.spi.security.Identity;\n+\n+import javax.inject.Inject;\n+import javax.servlet.FilterChain;\n+import javax.servlet.ServletException;\n+import javax.servlet.http.HttpServletRequest;\n+import javax.servlet.http.HttpServletResponse;\n+\n+import java.io.IOException;\n+\n+import static io.prestosql.server.ServletSecurityUtils.withAuthenticatedIdentity;\n+import static io.prestosql.server.ui.FormWebUiAuthenticationManager.redirectAllFormLoginToUi;\n+import static java.util.Objects.requireNonNull;\n+\n+public class FixedUserWebUiAuthenticationManager\n+        implements WebUiAuthenticationManager\n+{\n+    private final Identity webUiIdentity;\n+\n+    @Inject\n+    public FixedUserWebUiAuthenticationManager(FixedUserWebUIConfig config)\n+    {\n+        this(basicIdentity(requireNonNull(config, \"config is null\").getUserName()));\n+    }\n+\n+    public FixedUserWebUiAuthenticationManager(Identity webUiIdentity)\n+    {\n+        this.webUiIdentity = webUiIdentity;", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODczNzU5Ng==", "url": "https://github.com/trinodb/trino/pull/3433#discussion_r418737596", "bodyText": "TestFixedUserWebUIConfig -> TestFixedUserWebUiConfig", "author": "electrum", "createdAt": "2020-05-01T21:05:11Z", "path": "presto-main/src/test/java/io/prestosql/server/ui/TestFixedUserWebUIConfig.java", "diffHunk": "@@ -0,0 +1,46 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.server.ui;\n+\n+import com.google.common.collect.ImmutableMap;\n+import org.testng.annotations.Test;\n+\n+import java.util.Map;\n+\n+import static io.airlift.configuration.testing.ConfigAssertions.assertFullMapping;\n+import static io.airlift.configuration.testing.ConfigAssertions.assertRecordedDefaults;\n+import static io.airlift.configuration.testing.ConfigAssertions.recordDefaults;\n+\n+public class TestFixedUserWebUIConfig", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODczODUwMw==", "url": "https://github.com/trinodb/trino/pull/3433#discussion_r418738503", "bodyText": "If you pass authenticator to this method, then you can call authenticator.get() above, inside the if (authenticator.isPresent()) guard.", "author": "electrum", "createdAt": "2020-05-01T21:07:46Z", "path": "presto-main/src/main/java/io/prestosql/server/ui/FormWebUiAuthenticationManager.java", "diffHunk": "@@ -179,7 +192,48 @@ private static String encodeCurrentLocationForLoginRedirect(HttpServletRequest r\n         return path;\n     }\n \n-    private void handleLoginRequest(HttpServletRequest request, HttpServletResponse response)\n+    private void handleProtocolLoginRequest(HttpServletRequest request, HttpServletResponse response, FilterChain nextFilter)\n+            throws IOException, ServletException\n+    {\n+        Authenticator authenticator = this.authenticator.orElseThrow(() -> new IllegalStateException(\"Authenticator is not present\"));", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODczODc5NQ==", "url": "https://github.com/trinodb/trino/pull/3433#discussion_r418738795", "bodyText": "String message = firstNonNull(e.getMessage(), \"Unauthorized\");", "author": "electrum", "createdAt": "2020-05-01T21:08:40Z", "path": "presto-main/src/main/java/io/prestosql/server/ui/FormWebUiAuthenticationManager.java", "diffHunk": "@@ -179,7 +192,48 @@ private static String encodeCurrentLocationForLoginRedirect(HttpServletRequest r\n         return path;\n     }\n \n-    private void handleLoginRequest(HttpServletRequest request, HttpServletResponse response)\n+    private void handleProtocolLoginRequest(HttpServletRequest request, HttpServletResponse response, FilterChain nextFilter)\n+            throws IOException, ServletException\n+    {\n+        Authenticator authenticator = this.authenticator.orElseThrow(() -> new IllegalStateException(\"Authenticator is not present\"));\n+\n+        Identity authenticatedIdentity;\n+        try {\n+            authenticatedIdentity = authenticator.authenticate(request);\n+        }\n+        catch (AuthenticationException e) {\n+            // authentication failed\n+            ServletSecurityUtils.skipRequestBody(request);\n+\n+            e.getAuthenticateHeader().ifPresent(value -> response.addHeader(WWW_AUTHENTICATE, value));\n+\n+            String message = e.getMessage();", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODczOTEyMQ==", "url": "https://github.com/trinodb/trino/pull/3433#discussion_r418739121", "bodyText": "typo \"ot\" -> \"to\"", "author": "electrum", "createdAt": "2020-05-01T21:09:32Z", "path": "presto-main/src/main/java/io/prestosql/server/ui/FormWebUiAuthenticationManager.java", "diffHunk": "@@ -179,7 +192,48 @@ private static String encodeCurrentLocationForLoginRedirect(HttpServletRequest r\n         return path;\n     }\n \n-    private void handleLoginRequest(HttpServletRequest request, HttpServletResponse response)\n+    private void handleProtocolLoginRequest(HttpServletRequest request, HttpServletResponse response, FilterChain nextFilter)\n+            throws IOException, ServletException\n+    {\n+        Authenticator authenticator = this.authenticator.orElseThrow(() -> new IllegalStateException(\"Authenticator is not present\"));\n+\n+        Identity authenticatedIdentity;\n+        try {\n+            authenticatedIdentity = authenticator.authenticate(request);\n+        }\n+        catch (AuthenticationException e) {\n+            // authentication failed\n+            ServletSecurityUtils.skipRequestBody(request);\n+\n+            e.getAuthenticateHeader().ifPresent(value -> response.addHeader(WWW_AUTHENTICATE, value));\n+\n+            String message = e.getMessage();\n+            if (message == null) {\n+                message = \"Unauthorized\";\n+            }\n+\n+            ServletSecurityUtils.sendErrorMessage(response, SC_UNAUTHORIZED, message);\n+            return;\n+        }\n+\n+        if (redirectFormLoginToUi(request, response)) {\n+            return;\n+        }\n+\n+        ServletSecurityUtils.withAuthenticatedIdentity(nextFilter, request, response, authenticatedIdentity);\n+    }\n+\n+    public static boolean redirectFormLoginToUi(HttpServletRequest request, HttpServletResponse response)\n+    {\n+        // these paths should never be used with a protocol login, but the user might have this cached or linked, so redirect back ot the main UI page.", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODczOTk0OQ==", "url": "https://github.com/trinodb/trino/pull/3433#discussion_r418739949", "bodyText": "Why is the first one !isSecure()?", "author": "electrum", "createdAt": "2020-05-01T21:11:55Z", "path": "presto-main/src/main/java/io/prestosql/server/ui/FormWebUiAuthenticationManager.java", "diffHunk": "@@ -338,7 +392,7 @@ static String getRedirectLocation(HttpServletRequest request, String path, Strin\n \n     private boolean isAuthenticationEnabled(HttpServletRequest request)\n     {\n-        return !isSecure(request, httpsForwardingEnabled) || passwordAuthenticatorManager.isLoaded();\n+        return !isSecure(request, httpsForwardingEnabled) || passwordAuthenticatorManager.isLoaded() || authenticator.isPresent();", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTc2MjgzNA==", "url": "https://github.com/trinodb/trino/pull/3433#discussion_r421762834", "bodyText": "unsecured requests support username-only authentication (no password).  I added some comments", "author": "dain", "createdAt": "2020-05-07T20:06:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODczOTk0OQ=="}], "type": "inlineReview"}, {"oid": "4a03cb01ac93300b2977e12cc90040a030dcd1a0", "url": "https://github.com/trinodb/trino/commit/4a03cb01ac93300b2977e12cc90040a030dcd1a0", "message": "MoveWebUiModule to UI package", "committedDate": "2020-05-07T18:08:00Z", "type": "commit"}, {"oid": "5ed105f2645889c4b4d21925d299f476a4f5bf36", "url": "https://github.com/trinodb/trino/commit/5ed105f2645889c4b4d21925d299f476a4f5bf36", "message": "Add utility for servlet security handling", "committedDate": "2020-05-07T18:08:00Z", "type": "commit"}, {"oid": "5ba0cfe3bc732014cbacbf5e215e997bf299b741", "url": "https://github.com/trinodb/trino/commit/5ba0cfe3bc732014cbacbf5e215e997bf299b741", "message": "Support forwarded https in web ui authentication", "committedDate": "2020-05-07T18:08:00Z", "type": "commit"}, {"oid": "e98265d369af83f6bd5b1f2a9fe9412892abd3a4", "url": "https://github.com/trinodb/trino/commit/e98265d369af83f6bd5b1f2a9fe9412892abd3a4", "message": "Add extensible web ui authentication bindings", "committedDate": "2020-05-07T20:00:56Z", "type": "commit"}, {"oid": "bed715e924244d886e5c522eece66f766f3067fe", "url": "https://github.com/trinodb/trino/commit/bed715e924244d886e5c522eece66f766f3067fe", "message": "Add fixed user web ui authenticator", "committedDate": "2020-05-07T20:00:57Z", "type": "commit"}, {"oid": "c5255c326f48ce0ea2457b98d18bbcfeaae5fffa", "url": "https://github.com/trinodb/trino/commit/c5255c326f48ce0ea2457b98d18bbcfeaae5fffa", "message": "Add HTTP protocol based authenticators to web ui\n\nAdd support for certificate, JWT and Kerberos authentication", "committedDate": "2020-05-07T20:07:29Z", "type": "commit"}, {"oid": "c5255c326f48ce0ea2457b98d18bbcfeaae5fffa", "url": "https://github.com/trinodb/trino/commit/c5255c326f48ce0ea2457b98d18bbcfeaae5fffa", "message": "Add HTTP protocol based authenticators to web ui\n\nAdd support for certificate, JWT and Kerberos authentication", "committedDate": "2020-05-07T20:07:29Z", "type": "forcePushed"}]}