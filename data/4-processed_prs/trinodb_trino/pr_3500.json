{"pr_number": 3500, "pr_title": "Support LDAP without TLS", "pr_createdAt": "2020-04-21T15:31:39Z", "pr_url": "https://github.com/trinodb/trino/pull/3500", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjM4MzU2Nw==", "url": "https://github.com/trinodb/trino/pull/3500#discussion_r412383567", "bodyText": "Add this as an @AssertTrue validation the config class (search code base for examples)\nThis should be checkArgument since it's validating an argument. IllegalStateException means the class is in an inappropriate state for the current method invocation.", "author": "electrum", "createdAt": "2020-04-21T18:14:44Z", "path": "presto-password-authenticators/src/main/java/io/prestosql/plugin/password/ldap/LdapAuthenticator.java", "diffHunk": "@@ -290,6 +291,14 @@ private DirContext createUserDirContext(String userDistinguishedName, String pas\n                 .build();\n     }\n \n+    private static void validateLdapUrl(String ldapUrl, boolean allowInsecure)\n+    {\n+        if (ldapUrl.matches(\"ldap://.*\")) {\n+            checkState(allowInsecure, \"Connecting to the LDAP server without SSL enabled requires `ldap.allow-insecure=true`\");", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjM4NzIxMw==", "url": "https://github.com/trinodb/trino/pull/3500#discussion_r412387213", "bodyText": "It's better to tell users about the specific threat rather than a vague \"improved security\". How about\n\nPasswords will be sent in the clear to the LDAP server. Please consider using SSL to connect.", "author": "electrum", "createdAt": "2020-04-21T18:20:02Z", "path": "presto-password-authenticators/src/main/java/io/prestosql/plugin/password/ldap/LdapAuthenticator.java", "diffHunk": "@@ -290,6 +291,14 @@ private DirContext createUserDirContext(String userDistinguishedName, String pas\n                 .build();\n     }\n \n+    private static void validateLdapUrl(String ldapUrl, boolean allowInsecure)\n+    {\n+        if (ldapUrl.matches(\"ldap://.*\")) {\n+            checkState(allowInsecure, \"Connecting to the LDAP server without SSL enabled requires `ldap.allow-insecure=true`\");\n+            log.warn(\"Presto will use non-secure connection to the LDAP server. Please consider using an SSL connection for improved security.\");", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjM4ODM2MA==", "url": "https://github.com/trinodb/trino/pull/3500#discussion_r412388360", "bodyText": "Move this and the getter/setter to be directly after the URL, since they are related.", "author": "electrum", "createdAt": "2020-04-21T18:21:43Z", "path": "presto-password-authenticators/src/main/java/io/prestosql/plugin/password/ldap/LdapConfig.java", "diffHunk": "@@ -33,9 +33,10 @@\n     private String bindPassword;\n     private boolean ignoreReferrals;\n     private Duration ldapCacheTtl = new Duration(1, TimeUnit.HOURS);\n+    private boolean allowInsecure;", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjM5MTU4OQ==", "url": "https://github.com/trinodb/trino/pull/3500#discussion_r412391589", "bodyText": "This can be simplified to ldapUrl.startsWith(\"ldap://\")", "author": "electrum", "createdAt": "2020-04-21T18:26:33Z", "path": "presto-password-authenticators/src/main/java/io/prestosql/plugin/password/ldap/LdapAuthenticator.java", "diffHunk": "@@ -290,6 +291,14 @@ private DirContext createUserDirContext(String userDistinguishedName, String pas\n                 .build();\n     }\n \n+    private static void validateLdapUrl(String ldapUrl, boolean allowInsecure)\n+    {\n+        if (ldapUrl.matches(\"ldap://.*\")) {", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzQyMDU5Ng==", "url": "https://github.com/trinodb/trino/pull/3500#discussion_r413420596", "bodyText": "Sorry for the confusion. The logging should be done in  LdapAuthenticator, as config classes should be pure configuration data. Also, from a conceptual standpoint, the LDAP authentication is where this matters. Simply creating/validating a config shouldn't cause a warning.", "author": "electrum", "createdAt": "2020-04-23T00:21:06Z", "path": "presto-password-authenticators/src/main/java/io/prestosql/plugin/password/ldap/LdapConfig.java", "diffHunk": "@@ -49,6 +54,31 @@ public LdapConfig setLdapUrl(String url)\n         return this;\n     }\n \n+    public boolean isAllowInsecure()\n+    {\n+        return allowInsecure;\n+    }\n+\n+    @Config(\"ldap.allow-insecure\")\n+    @ConfigDescription(\"Allow insecure connection to the LDAP server\")\n+    public LdapConfig setAllowInsecure(boolean allowInsecure)\n+    {\n+        this.allowInsecure = allowInsecure;\n+        return this;\n+    }\n+\n+    @AssertTrue(message = \"Connecting to the LDAP server without SSL enabled requires `ldap.allow-insecure=true`\")\n+    public boolean isUrlConfigurationValid()\n+    {\n+        if (ldapUrl != null && ldapUrl.startsWith(\"ldap://\")) {\n+            if (!allowInsecure) {\n+                return false;\n+            }\n+            log.warn(\"Passwords will be sent in the clear to the LDAP server. Please consider using SSL to connect.\");", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzQyMTEzOQ==", "url": "https://github.com/trinodb/trino/pull/3500#discussion_r413421139", "bodyText": "So this can be simplified to\nreturn !nullToEmpty(ldapUrl).startsWith(\"ldap://\") || allowInsecure;", "author": "electrum", "createdAt": "2020-04-23T00:22:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzQyMDU5Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzQyMTMyNg==", "url": "https://github.com/trinodb/trino/pull/3500#discussion_r413421326", "bodyText": "Nit: move directly after setLdapUrl", "author": "electrum", "createdAt": "2020-04-23T00:23:16Z", "path": "presto-password-authenticators/src/test/java/io/prestosql/plugin/password/ldap/TestLdapConfig.java", "diffHunk": "@@ -43,7 +44,8 @@ public void testDefault()\n                 .setBindDistingushedName(null)\n                 .setBindPassword(null)\n                 .setIgnoreReferrals(false)\n-                .setLdapCacheTtl(new Duration(1, TimeUnit.HOURS)));\n+                .setLdapCacheTtl(new Duration(1, TimeUnit.HOURS))\n+                .setAllowInsecure(false));", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzQyMTQ4MQ==", "url": "https://github.com/trinodb/trino/pull/3500#discussion_r413421481", "bodyText": "Same, move above, so the order is consistent", "author": "electrum", "createdAt": "2020-04-23T00:23:46Z", "path": "presto-password-authenticators/src/test/java/io/prestosql/plugin/password/ldap/TestLdapConfig.java", "diffHunk": "@@ -58,6 +60,7 @@ public void testExplicitConfig()\n                 .put(\"ldap.bind-password\", \"password1234\")\n                 .put(\"ldap.ignore-referrals\", \"true\")\n                 .put(\"ldap.cache-ttl\", \"2m\")\n+                .put(\"ldap.allow-insecure\", \"true\")", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzQyMTUxMw==", "url": "https://github.com/trinodb/trino/pull/3500#discussion_r413421513", "bodyText": "Here, too", "author": "electrum", "createdAt": "2020-04-23T00:23:51Z", "path": "presto-password-authenticators/src/test/java/io/prestosql/plugin/password/ldap/TestLdapConfig.java", "diffHunk": "@@ -68,7 +71,8 @@ public void testExplicitConfig()\n                 .setBindDistingushedName(\"CN=User Name,OU=CITY_OU,OU=STATE_OU,DC=domain,DC=domain_root\")\n                 .setBindPassword(\"password1234\")\n                 .setIgnoreReferrals(true)\n-                .setLdapCacheTtl(new Duration(2, TimeUnit.MINUTES));\n+                .setLdapCacheTtl(new Duration(2, TimeUnit.MINUTES))\n+                .setAllowInsecure(true);", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzQyMTYxNQ==", "url": "https://github.com/trinodb/trino/pull/3500#discussion_r413421615", "bodyText": "Move after setLdapUrl", "author": "electrum", "createdAt": "2020-04-23T00:24:10Z", "path": "presto-password-authenticators/src/test/java/io/prestosql/plugin/password/ldap/TestLdapConfig.java", "diffHunk": "@@ -82,9 +86,23 @@ public void testValidation()\n                 .setUserBaseDistinguishedName(\"dc=test,dc=com\")\n                 .setGroupAuthorizationSearchPattern(\"&(objectClass=user)(memberOf=cn=group)(user=username)\"));\n \n-        assertFailsValidation(new LdapConfig().setLdapUrl(\"ldap://\"), \"ldapUrl\", \"LDAP without SSL/TLS unsupported. Expected ldaps://\", Pattern.class);\n-        assertFailsValidation(new LdapConfig().setLdapUrl(\"localhost\"), \"ldapUrl\", \"LDAP without SSL/TLS unsupported. Expected ldaps://\", Pattern.class);\n-        assertFailsValidation(new LdapConfig().setLdapUrl(\"ldaps:/localhost\"), \"ldapUrl\", \"LDAP without SSL/TLS unsupported. Expected ldaps://\", Pattern.class);\n+        assertValidates(new LdapConfig()\n+                .setLdapUrl(\"ldap://localhost\")\n+                .setUserBindSearchPattern(\"uid=${USER},ou=org,dc=test,dc=com\")\n+                .setUserBaseDistinguishedName(\"dc=test,dc=com\")\n+                .setGroupAuthorizationSearchPattern(\"&(objectClass=user)(memberOf=cn=group)(user=username)\")\n+                .setAllowInsecure(true));", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "7b24fdcaf10b0f054b33480759b8429eeab2498d", "url": "https://github.com/trinodb/trino/commit/7b24fdcaf10b0f054b33480759b8429eeab2498d", "message": "Support LDAP without TLS", "committedDate": "2020-04-23T08:20:37Z", "type": "commit"}, {"oid": "7b24fdcaf10b0f054b33480759b8429eeab2498d", "url": "https://github.com/trinodb/trino/commit/7b24fdcaf10b0f054b33480759b8429eeab2498d", "message": "Support LDAP without TLS", "committedDate": "2020-04-23T08:20:37Z", "type": "forcePushed"}]}