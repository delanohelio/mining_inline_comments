{"pr_number": 5965, "pr_title": "Add version check in file metastore", "pr_createdAt": "2020-11-14T22:39:00Z", "pr_url": "https://github.com/trinodb/trino/pull/5965", "timeline": [{"oid": "dab83e14d786ddd864caa85b501a6453d98d22a5", "url": "https://github.com/trinodb/trino/commit/dab83e14d786ddd864caa85b501a6453d98d22a5", "message": "Remove unnecessary use of map builder\n\nIt's the called class responsibility to make an immutable defensive\ncopy.", "committedDate": "2020-11-14T22:15:04Z", "type": "commit"}, {"oid": "25309e23bcc8d360d6d17e173e638124d12e71c4", "url": "https://github.com/trinodb/trino/commit/25309e23bcc8d360d6d17e173e638124d12e71c4", "message": "Remove redundant constructor", "committedDate": "2020-11-14T22:15:40Z", "type": "commit"}, {"oid": "42adf048c22a9b7812e3aa8a4aa3a1af429a0f95", "url": "https://github.com/trinodb/trino/commit/42adf048c22a9b7812e3aa8a4aa3a1af429a0f95", "message": "Pass Presto version to FileHiveMetastore", "committedDate": "2020-11-14T22:16:04Z", "type": "commit"}, {"oid": "167932a2268155ca629b24e14ef47da0f49ffe4c", "url": "https://github.com/trinodb/trino/commit/167932a2268155ca629b24e14ef47da0f49ffe4c", "message": "Add writing Presto version to database metadata\n\nRecord which Presto version database metadata was written with in the\nfile metastore.", "committedDate": "2020-11-14T22:16:04Z", "type": "commit"}, {"oid": "ebdd3c8d4bce3608bef8f7d6fbf65b1ddbddcf34", "url": "https://github.com/trinodb/trino/commit/ebdd3c8d4bce3608bef8f7d6fbf65b1ddbddcf34", "message": "Add writing Presto version to table metadata\n\nRecord which Presto version table metadata was written with in the\nfile metastore.", "committedDate": "2020-11-14T22:18:34Z", "type": "commit"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDI3MDUyNA==", "url": "https://github.com/trinodb/trino/pull/5965#discussion_r524270524", "bodyText": "maybe extract readSechema+checkVersion as helper method.", "author": "losipiuk", "createdAt": "2020-11-16T13:34:33Z", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/metastore/file/FileHiveMetastore.java", "diffHunk": "@@ -679,6 +693,8 @@ private void alterTable(String databaseName, String tableName, Function<TableMet\n \n         TableMetadata oldTableSchema = readSchemaFile(\"table\", tableMetadataDirectory, tableCodec)\n                 .orElseThrow(() -> new TableNotFoundException(new SchemaTableName(databaseName, tableName)));\n+        checkVersion(oldTableSchema.getWriterVersion());", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDI3MTc4MQ==", "url": "https://github.com/trinodb/trino/pull/5965#discussion_r524271781", "bodyText": "i thought about that. I did not, because\n\nto avoid internal API inconcistency, i would need to create 5 writer and 5 reader methods, which would be a lot of boilerplate code\none could still go directly to the existing method and would be still hard to catch this in review\n\nthus i decided not to", "author": "findepi", "createdAt": "2020-11-16T13:36:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDI3MDUyNA=="}], "type": "inlineReview"}, {"oid": "a4d7f2d6647136547202118f6a87f331fce1d364", "url": "https://github.com/trinodb/trino/commit/a4d7f2d6647136547202118f6a87f331fce1d364", "message": "Add version check in file metastore\n\nFile metastore implementation is tailored for testing purposes and we\nmake no backward compatibility guarantees for the internal structures\nused by it. However, this is not reflected in code behavior, as we make\nthe implementation available and selectable by the users. Prevent\naccidental usage of metadata persisted with one file metastore version\nand being read with a different version to avoid potential incorrect results.\nUsers can still opt in into previous unsafe behavior with a\nconfiguration property.", "committedDate": "2020-11-16T13:38:40Z", "type": "commit"}, {"oid": "a4d7f2d6647136547202118f6a87f331fce1d364", "url": "https://github.com/trinodb/trino/commit/a4d7f2d6647136547202118f6a87f331fce1d364", "message": "Add version check in file metastore\n\nFile metastore implementation is tailored for testing purposes and we\nmake no backward compatibility guarantees for the internal structures\nused by it. However, this is not reflected in code behavior, as we make\nthe implementation available and selectable by the users. Prevent\naccidental usage of metadata persisted with one file metastore version\nand being read with a different version to avoid potential incorrect results.\nUsers can still opt in into previous unsafe behavior with a\nconfiguration property.", "committedDate": "2020-11-16T13:38:40Z", "type": "forcePushed"}]}