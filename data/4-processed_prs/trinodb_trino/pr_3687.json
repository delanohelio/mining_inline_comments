{"pr_number": 3687, "pr_title": "Add support for showing view definition in BigQuery", "pr_createdAt": "2020-05-10T08:15:54Z", "pr_url": "https://github.com/trinodb/trino/pull/3687", "timeline": [{"oid": "b5bb8c8a83bd0a3b3be4f9d4f430880e920fc3cc", "url": "https://github.com/trinodb/trino/commit/b5bb8c8a83bd0a3b3be4f9d4f430880e920fc3cc", "message": "Add support for showing view definition in BigQuery", "committedDate": "2020-05-11T02:32:25Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzE3OTA0MQ==", "url": "https://github.com/trinodb/trino/pull/3687#discussion_r423179041", "bodyText": "Is the second call to viewDefinition.getQuery() needed?", "author": "davidrabinowitz", "createdAt": "2020-05-11T16:52:02Z", "path": "presto-bigquery/src/main/java/io/prestosql/plugin/bigquery/BigQueryMetadata.java", "diffHunk": "@@ -118,6 +123,30 @@ public BigQueryMetadata(BigQueryClient bigQueryClient, BigQueryConfig config)\n         return tableNames.build();\n     }\n \n+    @Override\n+    public Optional<ConnectorViewDefinition> getView(ConnectorSession session, SchemaTableName viewName)\n+    {\n+        TableInfo tableInfo = getBigQueryTable(viewName);\n+\n+        if (tableInfo.getDefinition() instanceof ViewDefinition) {\n+            List<BigQueryColumnHandle> columns = getTableColumns(tableInfo);\n+            ViewDefinition viewDefinition = tableInfo.getDefinition();\n+            ConnectorViewDefinition definition = new ConnectorViewDefinition(\n+                    viewDefinition.getQuery(),\n+                    Optional.of(catalogName.toString()),\n+                    Optional.of(viewName.getSchemaName()),\n+                    columns.stream()\n+                            .map(column -> new ConnectorViewDefinition.ViewColumn(column.getName(), column.getPrestoType().getTypeId()))\n+                            .collect(toImmutableList()),\n+                    Optional.ofNullable(tableInfo.getDescription()),\n+                    Optional.empty(),\n+                    false);\n+            viewDefinition.getQuery();", "originalCommit": "b5bb8c8a83bd0a3b3be4f9d4f430880e920fc3cc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzM4MDM4Nw==", "url": "https://github.com/trinodb/trino/pull/3687#discussion_r423380387", "bodyText": "It's my mistake. Let me remove.", "author": "ebyhr", "createdAt": "2020-05-11T23:40:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzE3OTA0MQ=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjMwOTI2OA==", "url": "https://github.com/trinodb/trino/pull/3687#discussion_r552309268", "bodyText": "How about customer_view$view_definition, instead?", "author": "martint", "createdAt": "2021-01-06T01:15:42Z", "path": "docs/src/main/sphinx/connector/bigquery.rst", "diffHunk": "@@ -161,6 +161,12 @@ BigQuery       Trino                        Notes\n ``TIMESTAMP``  ``TIMESTAMP_WITH_TIME_ZONE`` Time zone is UTC\n =============  ============================ =============================================================================================================\n \n+System Tables\n+-------------\n+\n+The connector supports queries of the view definition. Given a view ``customer_view``,\n+``SELECT * customer_view$big_query_views`` shows the view definition.", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjMyMzgzNw==", "url": "https://github.com/trinodb/trino/pull/3687#discussion_r552323837", "bodyText": "Looks good. Changed to the new name. Let me remove syntax-needs-review now.", "author": "ebyhr", "createdAt": "2021-01-06T02:07:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjMwOTI2OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjMxMDQxOQ==", "url": "https://github.com/trinodb/trino/pull/3687#discussion_r552310419", "bodyText": "This abstraction seems unnecessary. There's only one type of handler, and it's not clear that future ones would use the same suffix matching logic. If and when we need to add others, we can refactor the code to use a generic enum if appropriate.", "author": "martint", "createdAt": "2021-01-06T01:19:55Z", "path": "plugin/trino-bigquery/src/main/java/io/trino/plugin/bigquery/BigQueryMetadata.java", "diffHunk": "@@ -311,4 +344,29 @@ private static boolean containSameElements(Iterable<? extends ColumnHandle> firs\n     {\n         return ImmutableSet.copyOf(first).equals(ImmutableSet.copyOf(second));\n     }\n+\n+    private enum SystemTableHandler", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjMxMzAzOA==", "url": "https://github.com/trinodb/trino/pull/3687#discussion_r552313038", "bodyText": "Is the name viewName accurate? That represents something like customer_view$big_query_views, no? In that case, it would be the \"view definition table name\", not the actual view name.", "author": "martint", "createdAt": "2021-01-06T01:29:32Z", "path": "plugin/trino-bigquery/src/main/java/io/trino/plugin/bigquery/BigQueryMetadata.java", "diffHunk": "@@ -160,6 +167,32 @@ public ConnectorTableMetadata getTableMetadata(ConnectorSession session, Connect\n         return new ConnectorTableMetadata(schemaTableName, columns);\n     }\n \n+    @Override\n+    public Optional<SystemTable> getSystemTable(ConnectorSession session, SchemaTableName tableName)\n+    {\n+        if (SystemTableHandler.BIG_QUERY_VIEWS.matches(tableName)) {\n+            return getBigQueryViewsSystemTable(tableName, SystemTableHandler.BIG_QUERY_VIEWS.getSourceTableName(tableName));\n+        }\n+        return Optional.empty();\n+    }\n+\n+    private Optional<SystemTable> getBigQueryViewsSystemTable(SchemaTableName viewName, SchemaTableName sourceTableName)", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2Njg1NjI1MQ==", "url": "https://github.com/trinodb/trino/pull/3687#discussion_r566856251", "bodyText": "nit: move as private method to BigQueryMetadata.java?", "author": "losipiuk", "createdAt": "2021-01-29T14:24:57Z", "path": "plugin/trino-bigquery/src/main/java/io/trino/plugin/bigquery/util/SystemTables.java", "diffHunk": "@@ -0,0 +1,53 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package io.trino.plugin.bigquery.util;\n+\n+import io.trino.spi.connector.ConnectorSession;\n+import io.trino.spi.connector.ConnectorTableMetadata;\n+import io.trino.spi.connector.ConnectorTransactionHandle;\n+import io.trino.spi.connector.RecordCursor;\n+import io.trino.spi.connector.SystemTable;\n+import io.trino.spi.predicate.TupleDomain;\n+\n+import java.util.function.Function;\n+\n+public class SystemTables\n+{\n+    private SystemTables() {}\n+\n+    public static SystemTable createSystemTable(ConnectorTableMetadata metadata, Function<TupleDomain<Integer>, RecordCursor> cursor)", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2Njg2MjA2MA==", "url": "https://github.com/trinodb/trino/pull/3687#discussion_r566862060", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            The connector supports queries of the view definition. Given a view ``customer_view``,\n          \n          \n            \n            ``SELECT * customer_view$view_definition`` shows the view definition.\n          \n          \n            \n            For each Trino table which maps to BigQuery view there exists a system table which exposes BigQuery view definition.\n          \n          \n            \n            Given a BigQuery view ``customer_view`` you can send query\n          \n          \n            \n            ``SELECT * customer_view$view_definition`` to see the SQL which defines view in BigQuery.", "author": "losipiuk", "createdAt": "2021-01-29T14:33:26Z", "path": "docs/src/main/sphinx/connector/bigquery.rst", "diffHunk": "@@ -161,6 +161,12 @@ BigQuery       Trino                        Notes\n ``TIMESTAMP``  ``TIMESTAMP_WITH_TIME_ZONE`` Time zone is UTC\n =============  ============================ =============================================================================================================\n \n+System tables\n+-------------\n+\n+The connector supports queries of the view definition. Given a view ``customer_view``,\n+``SELECT * customer_view$view_definition`` shows the view definition.", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "5630b2af6ec952381f4153b94b52b7e768c21893", "url": "https://github.com/trinodb/trino/commit/5630b2af6ec952381f4153b94b52b7e768c21893", "message": "Add view_definition system table for BigQuery view", "committedDate": "2021-02-07T05:56:42Z", "type": "commit"}, {"oid": "5630b2af6ec952381f4153b94b52b7e768c21893", "url": "https://github.com/trinodb/trino/commit/5630b2af6ec952381f4153b94b52b7e768c21893", "message": "Add view_definition system table for BigQuery view", "committedDate": "2021-02-07T05:56:42Z", "type": "forcePushed"}]}