{"pr_number": 5054, "pr_title": "Add murmur3_hash function", "pr_createdAt": "2020-09-02T10:29:32Z", "pr_url": "https://github.com/trinodb/trino/pull/5054", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTk2ODAyNg==", "url": "https://github.com/trinodb/trino/pull/5054#discussion_r481968026", "bodyText": "Can we use Murmur3Hash32 which is available in Slice ?", "author": "Praveen2112", "createdAt": "2020-09-02T10:32:41Z", "path": "presto-main/src/main/java/io/prestosql/metadata/FunctionRegistry.java", "diffHunk": "@@ -127,6 +127,7 @@\n import io.prestosql.operator.scalar.MapValues;\n import io.prestosql.operator.scalar.MathFunctions;\n import io.prestosql.operator.scalar.MultimapFromEntriesFunction;\n+import io.prestosql.operator.scalar.MurmurHashFunction;", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjQ1MDYwOA==", "url": "https://github.com/trinodb/trino/pull/5054#discussion_r482450608", "bodyText": "@martint should these return varbinary like the other hash functions?", "author": "electrum", "createdAt": "2020-09-02T20:51:57Z", "path": "presto-main/src/test/java/io/prestosql/operator/scalar/TestMurmurHashFunction.java", "diffHunk": "@@ -0,0 +1,62 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.prestosql.operator.scalar;\n+\n+import io.prestosql.spi.type.BigintType;\n+import io.prestosql.spi.type.DoubleType;\n+import io.prestosql.spi.type.IntegerType;\n+import io.prestosql.spi.type.RealType;\n+import io.prestosql.spi.type.SmallintType;\n+import io.prestosql.spi.type.TinyintType;\n+import io.prestosql.spi.type.VarbinaryType;\n+import io.prestosql.spi.type.VarcharType;\n+import io.prestosql.type.JsonType;\n+import org.testng.annotations.Test;\n+\n+import static io.prestosql.testing.SqlVarbinaryTestingUtil.sqlVarbinaryFromHex;\n+\n+public class TestMurmurHashFunction\n+        extends AbstractTestFunctions\n+{\n+    @Test\n+    public void testMurmur3Hash()\n+    {\n+        assertFunction(\"murmur3_hash(1)\", IntegerType.INTEGER, 1392991556);", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzA0MzM3OA==", "url": "https://github.com/trinodb/trino/pull/5054#discussion_r483043378", "bodyText": "Yes, the result of murmur3 is a binary value (32 or 128 hits, depending on which version is used), so the result should be a binary type. If the result needs to be converted to a number, the user can do so with one of the functions dedicated to that. There are many ways to do so, so the murmur3 function should not dictate any particular way.", "author": "martint", "createdAt": "2020-09-03T14:56:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjQ1MDYwOA=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjAwNTA3NA==", "url": "https://github.com/trinodb/trino/pull/5054#discussion_r486005074", "bodyText": "Why seed = 1? Let's use the version with default seed:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    return Murmur3Hash128.hash(1, slice, 0, slice.length());\n          \n          \n            \n                    return Murmur3Hash128.hash(slice, 0, slice.length());", "author": "martint", "createdAt": "2020-09-10T01:12:57Z", "path": "presto-main/src/main/java/io/prestosql/operator/scalar/VarbinaryFunctions.java", "diffHunk": "@@ -279,6 +280,14 @@ public static Slice sha512(@SqlType(StandardTypes.VARBINARY) Slice slice)\n         return computeHash(Hashing.sha512(), slice);\n     }\n \n+    @Description(\"Compute murmur3 hash\")\n+    @ScalarFunction\n+    @SqlType(StandardTypes.VARBINARY)\n+    public static Slice murmur3(@SqlType(StandardTypes.VARBINARY) Slice slice)\n+    {\n+        return Murmur3Hash128.hash(1, slice, 0, slice.length());", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjExMDQ3Nw==", "url": "https://github.com/trinodb/trino/pull/5054#discussion_r486110477", "bodyText": "With default seed, this method returns all zero bytes for empty string, thats why i added a seed.", "author": "yashaswaj", "createdAt": "2020-09-10T07:02:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjAwNTA3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTI5OTI1Ng==", "url": "https://github.com/trinodb/trino/pull/5054#discussion_r495299256", "bodyText": "That's the expected hash for an empty string. For example,\nIn python:\n>>> import mmh3\n>>> mmh3.hash('')\n0\n\nIn Java:\nSystem.out.println(Hashing.murmur3_32().hashBytes(new byte[0]).asInt());\n-> 0", "author": "martint", "createdAt": "2020-09-25T22:56:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjAwNTA3NA=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": "85b9878a911283a9f10149cd15c0b675e37b07aa", "url": "https://github.com/trinodb/trino/commit/85b9878a911283a9f10149cd15c0b675e37b07aa", "message": "Add murmur3_hash function", "committedDate": "2020-09-27T21:30:20Z", "type": "commit"}, {"oid": "85b9878a911283a9f10149cd15c0b675e37b07aa", "url": "https://github.com/trinodb/trino/commit/85b9878a911283a9f10149cd15c0b675e37b07aa", "message": "Add murmur3_hash function", "committedDate": "2020-09-27T21:30:20Z", "type": "forcePushed"}]}