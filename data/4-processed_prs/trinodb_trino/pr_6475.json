{"pr_number": 6475, "pr_title": "Allow JDBC connectors to control aggregation pushdown for individual tables", "pr_createdAt": "2020-12-30T09:11:57Z", "pr_url": "https://github.com/trinodb/trino/pull/6475", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDExNDM3OA==", "url": "https://github.com/trinodb/trino/pull/6475#discussion_r550114378", "bodyText": "nit\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    ConnectorTableHandle baseTableHandle = metadata.getTableHandle(session, new SchemaTableName(\"example\", \"numbers\"));\n          \n          \n            \n                    Optional<AggregationApplicationResult<ConnectorTableHandle>> aggResult = metadata.applyAggregation(\n          \n          \n            \n                            session,\n          \n          \n            \n                            baseTableHandle,\n          \n          \n            \n                            ImmutableList.of(new AggregateFunction(\"count\", BIGINT, List.of(), List.of(), false, Optional.empty())),\n          \n          \n            \n                            ImmutableMap.of(),\n          \n          \n            \n                            ImmutableList.of(ImmutableList.of(groupByColumn)));\n          \n          \n            \n                    assertThat(aggResult).isPresent();\n          \n          \n            \n            \n          \n          \n            \n                    SchemaTableName noAggregationPushdownTable = new SchemaTableName(\"example\", \"no_aggregation_pushdown\");\n          \n          \n            \n                    metadata.createTable(SESSION, new ConnectorTableMetadata(noAggregationPushdownTable, ImmutableList.of(new ColumnMetadata(\"text\", VARCHAR))), false);\n          \n          \n            \n                    ConnectorTableHandle noAggregationPushdownTableHandle = metadata.getTableHandle(session, noAggregationPushdownTable);\n          \n          \n            \n                    aggResult = metadata.applyAggregation(\n          \n          \n            \n                            session,\n          \n          \n            \n                            noAggregationPushdownTableHandle,\n          \n          \n            \n                            ImmutableList.of(new AggregateFunction(\"count\", BIGINT, List.of(), List.of(), false, Optional.empty())),\n          \n          \n            \n                            ImmutableMap.of(),\n          \n          \n            \n                            ImmutableList.of(ImmutableList.of(groupByColumn)));\n          \n          \n            \n                    assertThat(aggResult).isEmpty();\n          \n          \n            \n                    Function<ConnectorTableHandle, Optional<AggregationApplicationResult<ConnectorTableHandle>>> applyAggregation = handle -> metadata.applyAggregation(\n          \n          \n            \n                            session,\n          \n          \n            \n                            handle,\n          \n          \n            \n                            ImmutableList.of(new AggregateFunction(\"count\", BIGINT, List.of(), List.of(), false, Optional.empty())),\n          \n          \n            \n                            ImmutableMap.of(),\n          \n          \n            \n                            ImmutableList.of(ImmutableList.of(groupByColumn)))\n          \n          \n            \n            \n          \n          \n            \n                    ConnectorTableHandle baseTableHandle = metadata.getTableHandle(session, new SchemaTableName(\"example\", \"numbers\"));\n          \n          \n            \n                    Optional<AggregationApplicationResult<ConnectorTableHandle>> aggResult = applyAggregation.apply(baseTableHandle);\n          \n          \n            \n                    assertThat(aggResult).isPresent();\n          \n          \n            \n            \n          \n          \n            \n                    SchemaTableName noAggregationPushdownTable = new SchemaTableName(\"example\", \"no_aggregation_pushdown\");\n          \n          \n            \n                    metadata.createTable(SESSION, new ConnectorTableMetadata(noAggregationPushdownTable, ImmutableList.of(new ColumnMetadata(\"text\", VARCHAR))), false);\n          \n          \n            \n                    ConnectorTableHandle noAggregationPushdownTableHandle = metadata.getTableHandle(session, noAggregationPushdownTable);\n          \n          \n            \n                    aggResult = applyAggregation.apply(noAggregationPushdownTableHandle);\n          \n          \n            \n                    assertThat(aggResult).isEmpty();", "author": "losipiuk", "createdAt": "2020-12-30T10:17:55Z", "path": "presto-base-jdbc/src/test/java/io/prestosql/plugin/jdbc/TestJdbcMetadata.java", "diffHunk": "@@ -247,6 +247,35 @@ public void testDropTableTable()\n         }\n     }\n \n+    @Test\n+    public void testAggregationPushdownForTableHandle()\n+    {\n+        ConnectorSession session = TestingConnectorSession.builder()\n+                .setPropertyMetadata(new JdbcMetadataSessionProperties(new JdbcMetadataConfig().setAggregationPushdownEnabled(true), Optional.empty()).getSessionProperties())\n+                .build();\n+        ColumnHandle groupByColumn = metadata.getColumnHandles(session, tableHandle).get(\"text\");\n+\n+        ConnectorTableHandle baseTableHandle = metadata.getTableHandle(session, new SchemaTableName(\"example\", \"numbers\"));\n+        Optional<AggregationApplicationResult<ConnectorTableHandle>> aggResult = metadata.applyAggregation(\n+                session,\n+                baseTableHandle,\n+                ImmutableList.of(new AggregateFunction(\"count\", BIGINT, List.of(), List.of(), false, Optional.empty())),\n+                ImmutableMap.of(),\n+                ImmutableList.of(ImmutableList.of(groupByColumn)));\n+        assertThat(aggResult).isPresent();\n+\n+        SchemaTableName noAggregationPushdownTable = new SchemaTableName(\"example\", \"no_aggregation_pushdown\");\n+        metadata.createTable(SESSION, new ConnectorTableMetadata(noAggregationPushdownTable, ImmutableList.of(new ColumnMetadata(\"text\", VARCHAR))), false);\n+        ConnectorTableHandle noAggregationPushdownTableHandle = metadata.getTableHandle(session, noAggregationPushdownTable);\n+        aggResult = metadata.applyAggregation(\n+                session,\n+                noAggregationPushdownTableHandle,\n+                ImmutableList.of(new AggregateFunction(\"count\", BIGINT, List.of(), List.of(), false, Optional.empty())),\n+                ImmutableMap.of(),\n+                ImmutableList.of(ImmutableList.of(groupByColumn)));\n+        assertThat(aggResult).isEmpty();", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDE5Nzk5MA==", "url": "https://github.com/trinodb/trino/pull/6475#discussion_r550197990", "bodyText": "We can also add those additional parameters later, when needed.", "author": "findepi", "createdAt": "2020-12-30T13:38:29Z", "path": "presto-base-jdbc/src/main/java/io/prestosql/plugin/jdbc/JdbcClient.java", "diffHunk": "@@ -66,7 +66,7 @@ default boolean supportsGroupingSets()\n         return true;\n     }\n \n-    default boolean supportsAggregationPushdown(ConnectorSession session, JdbcTableHandle table)\n+    default boolean supportsAggregationPushdown(ConnectorSession session, JdbcTableHandle table, List<AggregateFunction> aggregates, Map<String, ColumnHandle> assignments, List<List<ColumnHandle>> groupingSets)", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDE5ODQzNg==", "url": "https://github.com/trinodb/trino/pull/6475#discussion_r550198436", "bodyText": "You can put this after hard limits (after if (handle.getGroupingSets().isPresent()) { condition)", "author": "findepi", "createdAt": "2020-12-30T13:40:05Z", "path": "presto-base-jdbc/src/main/java/io/prestosql/plugin/jdbc/JdbcMetadata.java", "diffHunk": "@@ -224,6 +224,11 @@ public JdbcTableHandle getTableHandle(ConnectorSession session, SchemaTableName\n \n         JdbcTableHandle handle = (JdbcTableHandle) table;\n \n+        if (!jdbcClient.supportsAggregationPushdown(session, handle, aggregates, assignments, groupingSets)) {", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDE5ODczMg==", "url": "https://github.com/trinodb/trino/pull/6475#discussion_r550198732", "bodyText": "avoid agg abbrev\naggResult -> result or aggregationResult", "author": "findepi", "createdAt": "2020-12-30T13:41:11Z", "path": "presto-base-jdbc/src/test/java/io/prestosql/plugin/jdbc/TestJdbcMetadata.java", "diffHunk": "@@ -247,6 +248,31 @@ public void testDropTableTable()\n         }\n     }\n \n+    @Test\n+    public void testAggregationPushdownForTableHandle()\n+    {\n+        ConnectorSession session = TestingConnectorSession.builder()\n+                .setPropertyMetadata(new JdbcMetadataSessionProperties(new JdbcMetadataConfig().setAggregationPushdownEnabled(true), Optional.empty()).getSessionProperties())\n+                .build();\n+        ColumnHandle groupByColumn = metadata.getColumnHandles(session, tableHandle).get(\"text\");\n+        Function<ConnectorTableHandle, Optional<AggregationApplicationResult<ConnectorTableHandle>>> applyAggregation = handle -> metadata.applyAggregation(\n+                session,\n+                handle,\n+                ImmutableList.of(new AggregateFunction(\"count\", BIGINT, List.of(), List.of(), false, Optional.empty())),\n+                ImmutableMap.of(),\n+                ImmutableList.of(ImmutableList.of(groupByColumn)));\n+\n+        ConnectorTableHandle baseTableHandle = metadata.getTableHandle(session, new SchemaTableName(\"example\", \"numbers\"));\n+        Optional<AggregationApplicationResult<ConnectorTableHandle>> aggResult = applyAggregation.apply(baseTableHandle);", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": "45681c9b7461c4cda766fc243cbd50bb169b0dae", "url": "https://github.com/trinodb/trino/commit/45681c9b7461c4cda766fc243cbd50bb169b0dae", "message": "Allow JDBC connector to control aggregation pushdown for tables", "committedDate": "2021-01-04T14:08:53Z", "type": "commit"}, {"oid": "45681c9b7461c4cda766fc243cbd50bb169b0dae", "url": "https://github.com/trinodb/trino/commit/45681c9b7461c4cda766fc243cbd50bb169b0dae", "message": "Allow JDBC connector to control aggregation pushdown for tables", "committedDate": "2021-01-04T14:08:53Z", "type": "forcePushed"}]}